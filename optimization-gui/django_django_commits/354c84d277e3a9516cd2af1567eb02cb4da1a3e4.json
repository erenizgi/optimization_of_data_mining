{
    "author": "carljm",
    "message": "Fixed #17678 -- Corrected setup of _meta.proxy_for_model and added _meta.concrete_model. Thanks Anssi Kääriäinen.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17573 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
    "files": [
        {
            "sha": "d588ff4d233098758eb1136807dd854e8fe39567",
            "filename": "django/contrib/contenttypes/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fcontrib%2Fcontenttypes%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fcontrib%2Fcontenttypes%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fmodels.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -17,11 +17,7 @@ def get_by_natural_key(self, app_label, model):\n         return ct\n \n     def _get_opts(self, model):\n-        opts = model._meta\n-        while opts.proxy:\n-            model = opts.proxy_for_model\n-            opts = model._meta\n-        return opts\n+        return model._meta.concrete_model._meta\n \n     def _get_from_cache(self, opts):\n         key = (opts.app_label, opts.object_name.lower())"
        },
        {
            "sha": "07eea32b6920d057d80971571bb2e86dfc845850",
            "filename": "django/contrib/gis/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -2,7 +2,6 @@\n from django.db.backends.util import truncate_name, typecast_timestamp\n from django.db.models.sql import compiler\n from django.db.models.sql.constants import TABLE_NAME, MULTI\n-from django.db.models.sql.query import get_proxied_model\n \n SQLCompiler = compiler.SQLCompiler\n \n@@ -116,7 +115,7 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n         aliases = set()\n         only_load = self.deferred_to_columns()\n         # Skip all proxy to the root proxied model\n-        proxied_model = get_proxied_model(opts)\n+        proxied_model = opts.concrete_model\n \n         if start_alias:\n             seen = {None: start_alias}"
        },
        {
            "sha": "fc38224345f0c79c17dc7610d4705cb00574c1ee",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -122,9 +122,10 @@ def __new__(cls, name, bases, attrs):\n             if (new_class._meta.local_fields or\n                     new_class._meta.local_many_to_many):\n                 raise FieldError(\"Proxy model '%s' contains model fields.\" % name)\n-            while base._meta.proxy:\n-                base = base._meta.proxy_for_model\n             new_class._meta.setup_proxy(base)\n+            new_class._meta.concrete_model = base._meta.concrete_model\n+        else:\n+            new_class._meta.concrete_model = new_class\n \n         # Do the appropriate setup for any model parents.\n         o2o_map = dict([(f.rel.to, f) for f in new_class._meta.local_fields\n@@ -149,9 +150,7 @@ def __new__(cls, name, bases, attrs):\n                                         (field.name, name, base.__name__))\n             if not base._meta.abstract:\n                 # Concrete classes...\n-                while base._meta.proxy:\n-                    # Skip over a proxy class to the \"real\" base it proxies.\n-                    base = base._meta.proxy_for_model\n+                base = base._meta.concrete_model\n                 if base in o2o_map:\n                     field = o2o_map[base]\n                 elif not is_proxy:"
        },
        {
            "sha": "f68473de9438d9a4f17a8021446a053876484159",
            "filename": "django/db/models/options.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Foptions.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -40,7 +40,16 @@ def __init__(self, meta, app_label=None):\n         self.abstract = False\n         self.managed = True\n         self.proxy = False\n+        # For any class which is a proxy (including automatically created\n+        # classes for deferred object loading) the proxy_for_model tells\n+        # which class this model is proxying. Note that proxy_for_model\n+        # can create a chain of proxy models. For non-proxy models the\n+        # variable is always None.\n         self.proxy_for_model = None\n+        # For any non-abstract class the concrete class is the model\n+        # in the end of the proxy_for_model chain. In particular, for\n+        # concrete models the concrete_model is always the class itself.\n+        self.concrete_model = None\n         self.parents = SortedDict()\n         self.duplicate_targets = {}\n         self.auto_created = False"
        },
        {
            "sha": "6c516e2b21de6bdcc7ae55e0a4f7069aa45a35d2",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -7,7 +7,7 @@\n from django.db.models.sql.constants import *\n from django.db.models.sql.datastructures import EmptyResultSet\n from django.db.models.sql.expressions import SQLEvaluator\n-from django.db.models.sql.query import get_proxied_model, get_order_dir, Query\n+from django.db.models.sql.query import get_order_dir, Query\n from django.db.utils import DatabaseError\n \n \n@@ -266,7 +266,7 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n         aliases = set()\n         only_load = self.deferred_to_columns()\n         # Skip all proxy to the root proxied model\n-        proxied_model = get_proxied_model(opts)\n+        proxied_model = opts.concrete_model\n \n         if start_alias:\n             seen = {None: start_alias}"
        },
        {
            "sha": "693dde3b400df2bbd53f4be15b2437a2df47424a",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 4,
            "deletions": 15,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -575,18 +575,15 @@ def deferred_to_data(self, target, callback):\n             return\n         orig_opts = self.model._meta\n         seen = {}\n-        if orig_opts.proxy:\n-            must_include = {orig_opts.proxy_for_model: set([orig_opts.pk])}\n-        else:\n-            must_include = {self.model: set([orig_opts.pk])}\n+        must_include = {orig_opts.concrete_model: set([orig_opts.pk])}\n         for field_name in field_names:\n             parts = field_name.split(LOOKUP_SEP)\n             cur_model = self.model\n             opts = orig_opts\n             for name in parts[:-1]:\n                 old_model = cur_model\n                 source = opts.get_field_by_name(name)[0]\n-                cur_model = opts.get_field_by_name(name)[0].rel.to\n+                cur_model = source.rel.to\n                 opts = cur_model._meta\n                 # Even if we're \"just passing through\" this model, we must add\n                 # both the current model's pk and the related reference field\n@@ -946,7 +943,7 @@ def setup_inherited_models(self):\n         seen = {None: root_alias}\n \n         # Skip all proxy to the root proxied model\n-        proxied_model = get_proxied_model(opts)\n+        proxied_model = opts.concrete_model\n \n         for field, model in opts.get_fields_with_model():\n             if model not in seen:\n@@ -1325,7 +1322,7 @@ def setup_joins(self, names, opts, alias, dupe_multis, allow_many=True,\n             if model:\n                 # The field lives on a base class of the current model.\n                 # Skip the chain of proxy to the concrete proxied model\n-                proxied_model = get_proxied_model(opts)\n+                proxied_model = opts.concrete_model\n \n                 for int_model in opts.get_base_chain(model):\n                     if int_model is proxied_model:\n@@ -1990,11 +1987,3 @@ def add_to_dict(data, key, value):\n         data[key].add(value)\n     else:\n         data[key] = set([value])\n-\n-def get_proxied_model(opts):\n-    int_opts = opts\n-    proxied_model = None\n-    while int_opts.proxy:\n-        proxied_model = int_opts.proxy_for_model\n-        int_opts = proxied_model._meta\n-    return proxied_model"
        },
        {
            "sha": "b3321038db33f5228c93e15efe5b63538d099847",
            "filename": "tests/modeltests/proxy_models/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/tests%2Fmodeltests%2Fproxy_models%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/354c84d277e3a9516cd2af1567eb02cb4da1a3e4/tests%2Fmodeltests%2Fproxy_models%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fproxy_models%2Ftests.py?ref=354c84d277e3a9516cd2af1567eb02cb4da1a3e4",
            "patch": "@@ -232,6 +232,12 @@ def test_user_userproxy_userproxyproxy(self):\n         resp = [u.name for u in UserProxyProxy.objects.all()]\n         self.assertEqual(resp, ['Bruce'])\n \n+    def test_proxy_for_model(self):\n+        self.assertEqual(UserProxy, UserProxyProxy._meta.proxy_for_model)\n+\n+    def test_concrete_model(self):\n+        self.assertEqual(User, UserProxyProxy._meta.concrete_model)\n+\n     def test_proxy_delete(self):\n         \"\"\"\n         Proxy objects can be deleted"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 27,
        "deletions": 29
    }
}