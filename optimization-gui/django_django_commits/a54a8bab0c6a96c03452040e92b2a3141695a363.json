{
    "author": "spookylukey",
    "message": "Fixed #17776 - DoesNotExist is not picklable\n\nThanks to ambv for the report",
    "sha": "a54a8bab0c6a96c03452040e92b2a3141695a363",
    "files": [
        {
            "sha": "b2d92a2aee50aa9387b5e213fd8860aebf7959e0",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 33,
            "deletions": 6,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/a54a8bab0c6a96c03452040e92b2a3141695a363/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/a54a8bab0c6a96c03452040e92b2a3141695a363/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=a54a8bab0c6a96c03452040e92b2a3141695a363",
            "patch": "@@ -61,12 +61,14 @@ def __new__(cls, name, bases, attrs):\n         if not abstract:\n             new_class.add_to_class('DoesNotExist', subclass_exception(b'DoesNotExist',\n                     tuple(x.DoesNotExist\n-                            for x in parents if hasattr(x, '_meta') and not x._meta.abstract)\n-                                    or (ObjectDoesNotExist,), module))\n+                          for x in parents if hasattr(x, '_meta') and not x._meta.abstract)\n+                    or (ObjectDoesNotExist,),\n+                    module, attached_to=new_class))\n             new_class.add_to_class('MultipleObjectsReturned', subclass_exception(b'MultipleObjectsReturned',\n                     tuple(x.MultipleObjectsReturned\n-                            for x in parents if hasattr(x, '_meta') and not x._meta.abstract)\n-                                    or (MultipleObjectsReturned,), module))\n+                          for x in parents if hasattr(x, '_meta') and not x._meta.abstract)\n+                    or (MultipleObjectsReturned,),\n+                    module, attached_to=new_class))\n             if base_meta and not base_meta.abstract:\n                 # Non-abstract child classes inherit some attributes from their\n                 # non-abstract parent (unless an ABC comes before it in the\n@@ -934,5 +936,30 @@ def model_unpickle(model, attrs, factory):\n     return cls.__new__(cls)\n model_unpickle.__safe_for_unpickle__ = True\n \n-def subclass_exception(name, parents, module):\n-    return type(name, parents, {'__module__': module})\n+def subclass_exception(name, parents, module, attached_to=None):\n+    \"\"\"\n+    Create exception subclass.\n+\n+    If 'attached_to' is supplied, the exception will be created in a way that\n+    allows it to be pickled, assuming the returned exception class will be added\n+    as an attribute to the 'attached_to' class.\n+    \"\"\"\n+    class_dict = {'__module__': module}\n+    if attached_to is not None:\n+        def __reduce__(self):\n+            # Exceptions are special - they've got state that isn't\n+            # in self.__dict__. We assume it is all in self.args.\n+            return (unpickle_inner_exception, (attached_to, name), self.args)\n+\n+        def __setstate__(self, args):\n+            self.args = args\n+\n+        class_dict['__reduce__'] = __reduce__\n+        class_dict['__setstate__'] = __setstate__\n+\n+    return type(name, parents, class_dict)\n+\n+def unpickle_inner_exception(klass, exception_name):\n+    # Get the exception class from the class it is attached to:\n+    exception = getattr(klass, exception_name)\n+    return exception.__new__(exception)"
        },
        {
            "sha": "ab32e8f64797c53537a391fb7d5f121bb03f5c6b",
            "filename": "tests/regressiontests/queryset_pickle/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/a54a8bab0c6a96c03452040e92b2a3141695a363/tests%2Fregressiontests%2Fqueryset_pickle%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a54a8bab0c6a96c03452040e92b2a3141695a363/tests%2Fregressiontests%2Fqueryset_pickle%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueryset_pickle%2Ftests.py?ref=a54a8bab0c6a96c03452040e92b2a3141695a363",
            "patch": "@@ -36,3 +36,13 @@ def test_classmethod_as_default(self):\n \n     def test_membermethod_as_default(self):\n         self.assert_pickles(Happening.objects.filter(number4=1))\n+\n+    def test_doesnotexist_exception(self):\n+        # Ticket #17776\n+        original = Event.DoesNotExist(\"Doesn't exist\")\n+        unpickled = pickle.loads(pickle.dumps(original))\n+\n+        # Exceptions are not equal to equivalent instances of themselves, so\n+        # can't just use assertEqual(original, unpickled)\n+        self.assertEqual(original.__class__, unpickled.__class__)\n+        self.assertEqual(original.args, unpickled.args)"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 43,
        "deletions": 6
    }
}