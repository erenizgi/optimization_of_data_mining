{
    "author": "aaugustin",
    "message": "Fixed #10890: added prev/next_week in the context\n\nof per-week date-based generic views. Thanks ee_lars for the report.",
    "sha": "fcb09b5746192fea1b672346c915ee11e4120d7e",
    "files": [
        {
            "sha": "6964624516dc97b80f350ed8ee60f39411c1056b",
            "filename": "django/views/generic/dates.py",
            "status": "modified",
            "additions": 43,
            "deletions": 10,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/fcb09b5746192fea1b672346c915ee11e4120d7e/django%2Fviews%2Fgeneric%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/fcb09b5746192fea1b672346c915ee11e4120d7e/django%2Fviews%2Fgeneric%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Fdates.py?ref=fcb09b5746192fea1b672346c915ee11e4120d7e",
            "patch": "@@ -69,15 +69,15 @@ def get_next_month(self, date):\n             next = date.replace(year=date.year + 1, month=1, day=1)\n         else:\n             next = date.replace(month=date.month + 1, day=1)\n-        return _get_next_prev_month(self, next, is_previous=False, use_first_day=True)\n+        return _get_next_prev(self, next, is_previous=False, period='month')\n \n     def get_previous_month(self, date):\n         \"\"\"\n         Get the previous valid month.\n         \"\"\"\n         # prev must be the last day of the previous month.\n         prev = date.replace(day=1) - datetime.timedelta(days=1)\n-        return _get_next_prev_month(self, prev, is_previous=True, use_first_day=True)\n+        return _get_next_prev(self, prev, is_previous=True, period='month')\n \n \n class DayMixin(object):\n@@ -109,14 +109,14 @@ def get_next_day(self, date):\n         Get the next valid day.\n         \"\"\"\n         next = date + datetime.timedelta(days=1)\n-        return _get_next_prev_month(self, next, is_previous=False, use_first_day=False)\n+        return _get_next_prev(self, next, is_previous=False, period='day')\n \n     def get_previous_day(self, date):\n         \"\"\"\n         Get the previous valid day.\n         \"\"\"\n         prev = date - datetime.timedelta(days=1)\n-        return _get_next_prev_month(self, prev, is_previous=True, use_first_day=False)\n+        return _get_next_prev(self, prev, is_previous=True, period='day')\n \n \n class WeekMixin(object):\n@@ -143,6 +143,30 @@ def get_week(self):\n                     raise Http404(_(u\"No week specified\"))\n         return week\n \n+    def get_next_week(self, date):\n+        \"\"\"\n+        Get the next valid week.\n+        \"\"\"\n+        # next must be the first day of the next week.\n+        next = date + datetime.timedelta(days=7 - self._get_weekday(date))\n+        return _get_next_prev(self, next, is_previous=False, period='week')\n+\n+    def get_previous_week(self, date):\n+        \"\"\"\n+        Get the previous valid week.\n+        \"\"\"\n+        # prev must be the last day of the previous week.\n+        prev = date - datetime.timedelta(days=self._get_weekday(date) + 1)\n+        return _get_next_prev(self, prev, is_previous=True, period='week')\n+\n+    def _get_weekday(self, date):\n+        week_format = self.get_week_format()\n+        if week_format == '%W':                 # week starts on Monday\n+            return date.weekday()\n+        elif week_format == '%U':               # week starts on Sunday\n+            return (date.weekday() + 1) % 7\n+        else:\n+            raise ValueError(\"unknown week format: %s\" % week_format)\n \n class DateMixin(object):\n     \"\"\"\n@@ -428,7 +452,11 @@ def get_dated_items(self):\n \n         qs = self.get_dated_queryset(**lookup_kwargs)\n \n-        return (None, qs, {'week': date})\n+        return (None, qs, {\n+            'week': date,\n+            'next_week': self.get_next_week(date),\n+            'previous_week': self.get_previous_week(date),\n+        })\n \n \n class WeekArchiveView(MultipleObjectTemplateResponseMixin, BaseWeekArchiveView):\n@@ -557,7 +585,7 @@ def _date_from_string(year, year_format, month='', month_format='', day='', day_\n         })\n \n \n-def _get_next_prev_month(generic_view, naive_result, is_previous, use_first_day):\n+def _get_next_prev(generic_view, naive_result, is_previous, period):\n     \"\"\"\n     Helper: Get the next or the previous valid date. The idea is to allow\n     links on month/day views to never be 404s by never providing a date\n@@ -620,10 +648,15 @@ def _get_next_prev_month(generic_view, naive_result, is_previous, use_first_day)\n             result = timezone.localtime(result)\n         result = result.date()\n \n-    # For month views, we always want to have a date that's the first of the\n-    # month for consistency's sake.\n-    if result and use_first_day:\n-        result = result.replace(day=1)\n+    if result:\n+        if period == 'month':\n+            # first day of the month\n+            result = result.replace(day=1)\n+        elif period == 'week':\n+            # monday of the week\n+            result = result - datetime.timedelta(days=generic_view._get_weekday(result))\n+        elif period != 'day':\n+            raise ValueError('invalid period: %s' % period)\n \n     # Check against future dates.\n     if result and (allow_future or result < datetime.date.today()):"
        },
        {
            "sha": "98c089f2b43bdbcec60b118eb105c3958b9fb799",
            "filename": "tests/regressiontests/generic_views/dates.py",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/fcb09b5746192fea1b672346c915ee11e4120d7e/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/fcb09b5746192fea1b672346c915ee11e4120d7e/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py?ref=fcb09b5746192fea1b672346c915ee11e4120d7e",
            "patch": "@@ -196,7 +196,7 @@ def test_month_view_allow_empty(self):\n         self.assertEqual(list(res.context['book_list']), [])\n         self.assertEqual(res.context['month'], datetime.date(2000, 1, 1))\n \n-        # Since it's allow empty, next/prev are allowed to be empty months (#7164)\n+        # Since allow_empty=True, next/prev are allowed to be empty months (#7164)\n         self.assertEqual(res.context['next_month'], datetime.date(2000, 2, 1))\n         self.assertEqual(res.context['previous_month'], datetime.date(1999, 12, 1))\n \n@@ -222,7 +222,7 @@ def test_month_view_allow_future(self):\n         self.assertEqual(list(res.context['book_list']), [b])\n         self.assertEqual(res.context['month'], future)\n \n-        # Since it's allow_future but not allow_empty, next/prev are not\n+        # Since allow_future = True but not allow_empty, next/prev are not\n         # allowed to be empty months (#7164)\n         self.assertEqual(res.context['next_month'], None)\n         self.assertEqual(res.context['previous_month'], datetime.date(2008, 10, 1))\n@@ -298,17 +298,35 @@ def test_week_view(self):\n         self.assertEqual(res.context['book_list'][0], Book.objects.get(pubdate=datetime.date(2008, 10, 1)))\n         self.assertEqual(res.context['week'], datetime.date(2008, 9, 28))\n \n+        # Since allow_empty=False, next/prev weeks must be valid\n+        self.assertEqual(res.context['next_week'], None)\n+        self.assertEqual(res.context['previous_week'], datetime.date(2006, 4, 30))\n+\n     def test_week_view_allow_empty(self):\n+        # allow_empty = False, empty week\n         res = self.client.get('/dates/books/2008/week/12/')\n         self.assertEqual(res.status_code, 404)\n \n+        # allow_empty = True, empty month\n         res = self.client.get('/dates/books/2008/week/12/allow_empty/')\n         self.assertEqual(res.status_code, 200)\n         self.assertEqual(list(res.context['book_list']), [])\n+        self.assertEqual(res.context['week'], datetime.date(2008, 3, 23))\n+\n+        # Since allow_empty=True, next/prev are allowed to be empty weeks\n+        self.assertEqual(res.context['next_week'], datetime.date(2008, 3, 30))\n+        self.assertEqual(res.context['previous_week'], datetime.date(2008, 3, 16))\n+\n+        # allow_empty but not allow_future: next_week should be empty\n+        url = datetime.date.today().strftime('/dates/books/%Y/week/%U/allow_empty/').lower()\n+        res = self.client.get(url)\n+        self.assertEqual(res.status_code, 200)\n+        self.assertEqual(res.context['next_week'], None)\n \n     def test_week_view_allow_future(self):\n         # January 7th always falls in week 1, given Python's definition of week numbers\n         future = datetime.date(datetime.date.today().year + 1, 1, 7)\n+        future_sunday = future - datetime.timedelta(days=(future.weekday() + 1) % 7)\n         b = Book.objects.create(name=\"The New New Testement\", pages=600, pubdate=future)\n \n         res = self.client.get('/dates/books/%s/week/1/' % future.year)\n@@ -317,6 +335,19 @@ def test_week_view_allow_future(self):\n         res = self.client.get('/dates/books/%s/week/1/allow_future/' % future.year)\n         self.assertEqual(res.status_code, 200)\n         self.assertEqual(list(res.context['book_list']), [b])\n+        self.assertEqual(res.context['week'], future_sunday)\n+\n+        # Since allow_future = True but not allow_empty, next/prev are not\n+        # allowed to be empty weeks\n+        self.assertEqual(res.context['next_week'], None)\n+        self.assertEqual(res.context['previous_week'], datetime.date(2008, 9, 28))\n+\n+        # allow_future, but not allow_empty, with a current week. So next\n+        # should be in the future\n+        res = self.client.get('/dates/books/2008/week/39/allow_future/')\n+        self.assertEqual(res.status_code, 200)\n+        self.assertEqual(res.context['next_week'], future_sunday)\n+        self.assertEqual(res.context['previous_week'], datetime.date(2006, 4, 30))\n \n     def test_week_view_paginated(self):\n         week_start = datetime.date(2008, 9, 28)"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 76,
        "deletions": 12
    }
}