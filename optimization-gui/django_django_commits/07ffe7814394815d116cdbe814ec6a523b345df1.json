{
    "author": "claudep",
    "message": "Used get_current_site in comments feed class",
    "sha": "07ffe7814394815d116cdbe814ec6a523b345df1",
    "files": [
        {
            "sha": "2e0d4c3dc56d6af1db0030c18dae3ebec5576a79",
            "filename": "django/contrib/comments/feeds.py",
            "status": "modified",
            "additions": 9,
            "deletions": 12,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/07ffe7814394815d116cdbe814ec6a523b345df1/django%2Fcontrib%2Fcomments%2Ffeeds.py",
            "raw_url": "https://github.com/django/django/raw/07ffe7814394815d116cdbe814ec6a523b345df1/django%2Fcontrib%2Fcomments%2Ffeeds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Ffeeds.py?ref=07ffe7814394815d116cdbe814ec6a523b345df1",
            "patch": "@@ -1,30 +1,27 @@\n-from django.conf import settings\n from django.contrib.syndication.views import Feed\n-from django.contrib.sites.models import Site\n+from django.contrib.sites.models import get_current_site\n from django.contrib import comments\n from django.utils.translation import ugettext as _\n \n class LatestCommentFeed(Feed):\n     \"\"\"Feed of latest comments on the current site.\"\"\"\n \n+    def __call__(self, request, *args, **kwargs):\n+        self.site = get_current_site(request)\n+        return super(LatestCommentFeed, self).__call__(request, *args, **kwargs)\n+\n     def title(self):\n-        if not hasattr(self, '_site'):\n-            self._site = Site.objects.get_current()\n-        return _(\"%(site_name)s comments\") % dict(site_name=self._site.name)\n+        return _(\"%(site_name)s comments\") % dict(site_name=self.site.name)\n \n     def link(self):\n-        if not hasattr(self, '_site'):\n-            self._site = Site.objects.get_current()\n-        return \"http://%s/\" % (self._site.domain)\n+        return \"http://%s/\" % (self.site.domain)\n \n     def description(self):\n-        if not hasattr(self, '_site'):\n-            self._site = Site.objects.get_current()\n-        return _(\"Latest comments on %(site_name)s\") % dict(site_name=self._site.name)\n+        return _(\"Latest comments on %(site_name)s\") % dict(site_name=self.site.name)\n \n     def items(self):\n         qs = comments.get_model().objects.filter(\n-            site__pk = settings.SITE_ID,\n+            site__pk = self.site.pk,\n             is_public = True,\n             is_removed = False,\n         )"
        },
        {
            "sha": "1ec316eab80b217e9bc463b932ef1e3cbad760fc",
            "filename": "tests/regressiontests/comment_tests/tests/feed_tests.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/07ffe7814394815d116cdbe814ec6a523b345df1/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ffeed_tests.py",
            "raw_url": "https://github.com/django/django/raw/07ffe7814394815d116cdbe814ec6a523b345df1/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ffeed_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ffeed_tests.py?ref=07ffe7814394815d116cdbe814ec6a523b345df1",
            "patch": "@@ -1,12 +1,32 @@\n from __future__ import absolute_import\n \n+from django.conf import settings\n+from django.contrib.comments.models import Comment\n+from django.contrib.contenttypes.models import ContentType\n+from django.contrib.sites.models import Site\n+\n from . import CommentTestCase\n+from ..models import Article\n \n \n class CommentFeedTests(CommentTestCase):\n     urls = 'regressiontests.comment_tests.urls'\n     feed_url = '/rss/comments/'\n \n+    def setUp(self):\n+        site_2 = Site.objects.create(id=settings.SITE_ID+1,\n+            domain=\"example2.com\", name=\"example2.com\")\n+        # A comment for another site\n+        c5 = Comment.objects.create(\n+            content_type = ContentType.objects.get_for_model(Article),\n+            object_pk = \"1\",\n+            user_name = \"Joe Somebody\",\n+            user_email = \"jsomebody@example.com\",\n+            user_url = \"http://example.com/~joe/\",\n+            comment = \"A comment for the second site.\",\n+            site = site_2,\n+        )\n+\n     def test_feed(self):\n         response = self.client.get(self.feed_url)\n         self.assertEqual(response.status_code, 200)\n@@ -15,3 +35,4 @@ def test_feed(self):\n         self.assertContains(response, '<title>example.com comments</title>')\n         self.assertContains(response, '<link>http://example.com/</link>')\n         self.assertContains(response, '</rss>')\n+        self.assertNotContains(response, \"A comment for the second site.\")"
        },
        {
            "sha": "0a7e8b5fdf6b58fc78a3a0ff7a0d8b7437b8223e",
            "filename": "tests/regressiontests/comment_tests/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/07ffe7814394815d116cdbe814ec6a523b345df1/tests%2Fregressiontests%2Fcomment_tests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/07ffe7814394815d116cdbe814ec6a523b345df1/tests%2Fregressiontests%2Fcomment_tests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Furls.py?ref=07ffe7814394815d116cdbe814ec6a523b345df1",
            "patch": "@@ -15,6 +15,7 @@\n     url(r'^flag/(\\d+)/$', views.custom_flag_comment),\n     url(r'^delete/(\\d+)/$', views.custom_delete_comment),\n     url(r'^approve/(\\d+)/$', views.custom_approve_comment),\n+    url(r'^cr/(\\d+)/(.+)/$', 'django.contrib.contenttypes.views.shortcut', name='comments-url-redirect'),\n )\n \n urlpatterns += patterns('',"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 31,
        "deletions": 12
    }
}