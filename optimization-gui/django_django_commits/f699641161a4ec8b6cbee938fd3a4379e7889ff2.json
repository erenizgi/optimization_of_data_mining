{
    "author": "jphalip",
    "message": "Fixed #17138 -- Made the sensitive_variables decorator work with object methods.",
    "sha": "f699641161a4ec8b6cbee938fd3a4379e7889ff2",
    "files": [
        {
            "sha": "d95cd62017541de030af87941972a2d7403ebc46",
            "filename": "django/views/debug.py",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/f699641161a4ec8b6cbee938fd3a4379e7889ff2/django%2Fviews%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/f699641161a4ec8b6cbee938fd3a4379e7889ff2/django%2Fviews%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdebug.py?ref=f699641161a4ec8b6cbee938fd3a4379e7889ff2",
            "patch": "@@ -155,9 +155,20 @@ def get_traceback_frame_variables(self, request, tb_frame):\n         Replaces the values of variables marked as sensitive with\n         stars (*********).\n         \"\"\"\n-        func_name = tb_frame.f_code.co_name\n-        func = tb_frame.f_globals.get(func_name)\n-        sensitive_variables = getattr(func, 'sensitive_variables', [])\n+        # Loop through the frame's callers to see if the sensitive_variables\n+        # decorator was used.\n+        current_frame = tb_frame.f_back\n+        sensitive_variables = None\n+        while current_frame is not None:\n+            if (current_frame.f_code.co_name == 'sensitive_variables_wrapper'\n+                and 'sensitive_variables_wrapper' in current_frame.f_locals):\n+                # The sensitive_variables decorator was used, so we take note\n+                # of the sensitive variables' names.\n+                wrapper = current_frame.f_locals['sensitive_variables_wrapper']\n+                sensitive_variables = getattr(wrapper, 'sensitive_variables', None)\n+                break\n+            current_frame = current_frame.f_back\n+\n         cleansed = []\n         if self.is_active(request) and sensitive_variables:\n             if sensitive_variables == '__ALL__':"
        },
        {
            "sha": "5c222963d379ea2583843dcab953ef8d38e478df",
            "filename": "django/views/decorators/debug.py",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/f699641161a4ec8b6cbee938fd3a4379e7889ff2/django%2Fviews%2Fdecorators%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/f699641161a4ec8b6cbee938fd3a4379e7889ff2/django%2Fviews%2Fdecorators%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdecorators%2Fdebug.py?ref=f699641161a4ec8b6cbee938fd3a4379e7889ff2",
            "patch": "@@ -26,13 +26,13 @@ def my_function()\n     \"\"\"\n     def decorator(func):\n         @functools.wraps(func)\n-        def wrapper(*args, **kwargs):\n+        def sensitive_variables_wrapper(*args, **kwargs):\n             if variables:\n-                wrapper.sensitive_variables = variables\n+                sensitive_variables_wrapper.sensitive_variables = variables\n             else:\n-                wrapper.sensitive_variables = '__ALL__'\n+                sensitive_variables_wrapper.sensitive_variables = '__ALL__'\n             return func(*args, **kwargs)\n-        return wrapper\n+        return sensitive_variables_wrapper\n     return decorator\n \n \n@@ -61,11 +61,11 @@ def my_view(request)\n     \"\"\"\n     def decorator(view):\n         @functools.wraps(view)\n-        def wrapper(request, *args, **kwargs):\n+        def sensitive_post_parameters_wrapper(request, *args, **kwargs):\n             if parameters:\n                 request.sensitive_post_parameters = parameters\n             else:\n                 request.sensitive_post_parameters = '__ALL__'\n             return view(request, *args, **kwargs)\n-        return wrapper\n+        return sensitive_post_parameters_wrapper\n     return decorator"
        },
        {
            "sha": "e8a7d49e79b831e5357e08ce8b000e105bab3ef7",
            "filename": "tests/regressiontests/views/tests/debug.py",
            "status": "modified",
            "additions": 63,
            "deletions": 41,
            "changes": 104,
            "blob_url": "https://github.com/django/django/blob/f699641161a4ec8b6cbee938fd3a4379e7889ff2/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/f699641161a4ec8b6cbee938fd3a4379e7889ff2/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py?ref=f699641161a4ec8b6cbee938fd3a4379e7889ff2",
            "patch": "@@ -10,13 +10,12 @@\n from django.test.utils import (setup_test_template_loader,\n                                restore_template_loaders)\n from django.core.urlresolvers import reverse\n-from django.template import TemplateSyntaxError\n from django.views.debug import ExceptionReporter\n from django.core import mail\n \n from .. import BrokenException, except_args\n from ..views import (sensitive_view, non_sensitive_view, paranoid_view,\n-    custom_exception_reporter_filter_view)\n+    custom_exception_reporter_filter_view, sensitive_method_view)\n \n \n class DebugViewTests(TestCase):\n@@ -238,7 +237,8 @@ class ExceptionReportTestMixin(object):\n                       'hash-brown-key': 'hash-brown-value',\n                       'bacon-key': 'bacon-value',}\n \n-    def verify_unsafe_response(self, view, check_for_vars=True):\n+    def verify_unsafe_response(self, view, check_for_vars=True,\n+                               check_for_POST_params=True):\n         \"\"\"\n         Asserts that potentially sensitive info are displayed in the response.\n         \"\"\"\n@@ -250,13 +250,14 @@ def verify_unsafe_response(self, view, check_for_vars=True):\n             self.assertContains(response, 'scrambled', status_code=500)\n             self.assertContains(response, 'sauce', status_code=500)\n             self.assertContains(response, 'worcestershire', status_code=500)\n+        if check_for_POST_params:\n+            for k, v in self.breakfast_data.items():\n+                # All POST parameters are shown.\n+                self.assertContains(response, k, status_code=500)\n+                self.assertContains(response, v, status_code=500)\n \n-        for k, v in self.breakfast_data.items():\n-            # All POST parameters are shown.\n-            self.assertContains(response, k, status_code=500)\n-            self.assertContains(response, v, status_code=500)\n-\n-    def verify_safe_response(self, view, check_for_vars=True):\n+    def verify_safe_response(self, view, check_for_vars=True,\n+                             check_for_POST_params=True):\n         \"\"\"\n         Asserts that certain sensitive info are not displayed in the response.\n         \"\"\"\n@@ -269,18 +270,19 @@ def verify_safe_response(self, view, check_for_vars=True):\n             # Sensitive variable's name is shown but not its value.\n             self.assertContains(response, 'sauce', status_code=500)\n             self.assertNotContains(response, 'worcestershire', status_code=500)\n+        if check_for_POST_params:\n+            for k, v in self.breakfast_data.items():\n+                # All POST parameters' names are shown.\n+                self.assertContains(response, k, status_code=500)\n+            # Non-sensitive POST parameters' values are shown.\n+            self.assertContains(response, 'baked-beans-value', status_code=500)\n+            self.assertContains(response, 'hash-brown-value', status_code=500)\n+            # Sensitive POST parameters' values are not shown.\n+            self.assertNotContains(response, 'sausage-value', status_code=500)\n+            self.assertNotContains(response, 'bacon-value', status_code=500)\n \n-        for k, v in self.breakfast_data.items():\n-            # All POST parameters' names are shown.\n-            self.assertContains(response, k, status_code=500)\n-        # Non-sensitive POST parameters' values are shown.\n-        self.assertContains(response, 'baked-beans-value', status_code=500)\n-        self.assertContains(response, 'hash-brown-value', status_code=500)\n-        # Sensitive POST parameters' values are not shown.\n-        self.assertNotContains(response, 'sausage-value', status_code=500)\n-        self.assertNotContains(response, 'bacon-value', status_code=500)\n-\n-    def verify_paranoid_response(self, view, check_for_vars=True):\n+    def verify_paranoid_response(self, view, check_for_vars=True,\n+                                 check_for_POST_params=True):\n         \"\"\"\n         Asserts that no variables or POST parameters are displayed in the response.\n         \"\"\"\n@@ -292,14 +294,14 @@ def verify_paranoid_response(self, view, check_for_vars=True):\n             self.assertNotContains(response, 'scrambled', status_code=500)\n             self.assertContains(response, 'sauce', status_code=500)\n             self.assertNotContains(response, 'worcestershire', status_code=500)\n+        if check_for_POST_params:\n+            for k, v in self.breakfast_data.items():\n+                # All POST parameters' names are shown.\n+                self.assertContains(response, k, status_code=500)\n+                # No POST parameters' values are shown.\n+                self.assertNotContains(response, v, status_code=500)\n \n-        for k, v in self.breakfast_data.items():\n-            # All POST parameters' names are shown.\n-            self.assertContains(response, k, status_code=500)\n-            # No POST parameters' values are shown.\n-            self.assertNotContains(response, v, status_code=500)\n-\n-    def verify_unsafe_email(self, view):\n+    def verify_unsafe_email(self, view, check_for_POST_params=True):\n         \"\"\"\n         Asserts that potentially sensitive info are displayed in the email report.\n         \"\"\"\n@@ -314,12 +316,13 @@ def verify_unsafe_email(self, view):\n             self.assertNotIn('scrambled', email.body)\n             self.assertNotIn('sauce', email.body)\n             self.assertNotIn('worcestershire', email.body)\n-            for k, v in self.breakfast_data.items():\n-                # All POST parameters are shown.\n-                self.assertIn(k, email.body)\n-                self.assertIn(v, email.body)\n+            if check_for_POST_params:\n+                for k, v in self.breakfast_data.items():\n+                    # All POST parameters are shown.\n+                    self.assertIn(k, email.body)\n+                    self.assertIn(v, email.body)\n \n-    def verify_safe_email(self, view):\n+    def verify_safe_email(self, view, check_for_POST_params=True):\n         \"\"\"\n         Asserts that certain sensitive info are not displayed in the email report.\n         \"\"\"\n@@ -334,15 +337,16 @@ def verify_safe_email(self, view):\n             self.assertNotIn('scrambled', email.body)\n             self.assertNotIn('sauce', email.body)\n             self.assertNotIn('worcestershire', email.body)\n-            for k, v in self.breakfast_data.items():\n-                # All POST parameters' names are shown.\n-                self.assertIn(k, email.body)\n-            # Non-sensitive POST parameters' values are shown.\n-            self.assertIn('baked-beans-value', email.body)\n-            self.assertIn('hash-brown-value', email.body)\n-            # Sensitive POST parameters' values are not shown.\n-            self.assertNotIn('sausage-value', email.body)\n-            self.assertNotIn('bacon-value', email.body)\n+            if check_for_POST_params:\n+                for k, v in self.breakfast_data.items():\n+                    # All POST parameters' names are shown.\n+                    self.assertIn(k, email.body)\n+                # Non-sensitive POST parameters' values are shown.\n+                self.assertIn('baked-beans-value', email.body)\n+                self.assertIn('hash-brown-value', email.body)\n+                # Sensitive POST parameters' values are not shown.\n+                self.assertNotIn('sausage-value', email.body)\n+                self.assertNotIn('bacon-value', email.body)\n \n     def verify_paranoid_email(self, view):\n         \"\"\"\n@@ -425,6 +429,24 @@ def test_custom_exception_reporter_filter(self):\n             self.verify_unsafe_response(custom_exception_reporter_filter_view)\n             self.verify_unsafe_email(custom_exception_reporter_filter_view)\n \n+    def test_sensitive_method(self):\n+        \"\"\"\n+        Ensure that the sensitive_variables decorator works with object\n+        methods.\n+        Refs #18379.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(sensitive_method_view,\n+                                        check_for_POST_params=False)\n+            self.verify_unsafe_email(sensitive_method_view,\n+                                     check_for_POST_params=False)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_safe_response(sensitive_method_view,\n+                                      check_for_POST_params=False)\n+            self.verify_safe_email(sensitive_method_view,\n+                                   check_for_POST_params=False)\n+\n \n class AjaxResponseExceptionReporterFilter(TestCase, ExceptionReportTestMixin):\n     \"\"\""
        },
        {
            "sha": "2836d1bdde64c86cc699525e170227f1e42edd18",
            "filename": "tests/regressiontests/views/views.py",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/f699641161a4ec8b6cbee938fd3a4379e7889ff2/tests%2Fregressiontests%2Fviews%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/f699641161a4ec8b6cbee938fd3a4379e7889ff2/tests%2Fregressiontests%2Fviews%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Fviews.py?ref=f699641161a4ec8b6cbee938fd3a4379e7889ff2",
            "patch": "@@ -2,7 +2,6 @@\n \n import sys\n \n-from django import forms\n from django.core.exceptions import PermissionDenied\n from django.core.urlresolvers import get_resolver\n from django.http import HttpResponse, HttpResponseRedirect\n@@ -14,7 +13,7 @@\n from django.utils.log import getLogger\n \n from . import BrokenException, except_args\n-from .models import Article\n+\n \n \n def index_page(request):\n@@ -209,3 +208,23 @@ def custom_exception_reporter_filter_view(request):\n         exc_info = sys.exc_info()\n         send_log(request, exc_info)\n         return technical_500_response(request, *exc_info)\n+\n+\n+class Klass(object):\n+\n+    @sensitive_variables('sauce')\n+    def method(self, request):\n+        # Do not just use plain strings for the variables' values in the code\n+        # so that the tests don't return false positives when the function's\n+        # source is displayed in the exception report.\n+        cooked_eggs = ''.join(['s', 'c', 'r', 'a', 'm', 'b', 'l', 'e', 'd'])\n+        sauce = ''.join(['w', 'o', 'r', 'c', 'e', 's', 't', 'e', 'r', 's', 'h', 'i', 'r', 'e'])\n+        try:\n+            raise Exception\n+        except Exception:\n+            exc_info = sys.exc_info()\n+            send_log(request, exc_info)\n+            return technical_500_response(request, *exc_info)\n+\n+def sensitive_method_view(request):\n+    return Klass().method(request)\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 156,
        "additions": 104,
        "deletions": 52
    }
}