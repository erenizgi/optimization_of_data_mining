{
    "author": "aaugustin",
    "message": "Fixed #16040 -- Preserved scheme, host and port in the test client when following a redirect.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17157 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "33a52cde08ef7ab8ba8990d40646d0dc2a8482df",
    "files": [
        {
            "sha": "94fabcf91aab8fc7af20d6dd775cf80351cceb66",
            "filename": "django/test/client.py",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/33a52cde08ef7ab8ba8990d40646d0dc2a8482df/django%2Ftest%2Fclient.py",
            "raw_url": "https://github.com/django/django/raw/33a52cde08ef7ab8ba8990d40646d0dc2a8482df/django%2Ftest%2Fclient.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fclient.py?ref=33a52cde08ef7ab8ba8990d40646d0dc2a8482df",
            "patch": "@@ -546,19 +546,18 @@ def _handle_redirects(self, response, **extra):\n         response.redirect_chain = []\n         while response.status_code in (301, 302, 303, 307):\n             url = response['Location']\n-            scheme, netloc, path, query, fragment = urlsplit(url)\n-\n             redirect_chain = response.redirect_chain\n             redirect_chain.append((url, response.status_code))\n \n-            if scheme:\n-                extra['wsgi.url_scheme'] = scheme\n+            url = urlsplit(url)\n+            if url.scheme:\n+                extra['wsgi.url_scheme'] = url.scheme\n+            if url.hostname:\n+                extra['SERVER_NAME'] = url.hostname\n+            if url.port:\n+                extra['SERVER_PORT'] = str(url.port)\n \n-            # The test client doesn't handle external links,\n-            # but since the situation is simulated in test_client,\n-            # we fake things here by ignoring the netloc portion of the\n-            # redirected URL.\n-            response = self.get(path, QueryDict(query), follow=False, **extra)\n+            response = self.get(url.path, QueryDict(url.query), follow=False, **extra)\n             response.redirect_chain = redirect_chain\n \n             # Prevent loops"
        },
        {
            "sha": "7d0b0e412f8775bc2ed5e71a54f257b54735c391",
            "filename": "tests/regressiontests/test_client_regress/models.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/33a52cde08ef7ab8ba8990d40646d0dc2a8482df/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/33a52cde08ef7ab8ba8990d40646d0dc2a8482df/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py?ref=33a52cde08ef7ab8ba8990d40646d0dc2a8482df",
            "patch": "@@ -368,6 +368,18 @@ def test_redirect_chain_delete(self):\n             '/test_client_regress/no_template_view/', 301, 200)\n         self.assertEqual(len(response.redirect_chain), 3)\n \n+    def test_redirect_to_different_host(self):\n+        \"The test client will preserve scheme, host and port changes\"\n+        response = self.client.get('/test_client_regress/redirect_other_host/', follow=True)\n+        self.assertRedirects(response,\n+            'https://otherserver:8443/test_client_regress/no_template_view/',\n+            status_code=301, target_status_code=200)\n+        # We can't use is_secure() or get_host()\n+        # because response.request is a dictionary, not an HttpRequest\n+        self.assertEqual(response.request.get('wsgi.url_scheme'), 'https')\n+        self.assertEqual(response.request.get('SERVER_NAME'), 'otherserver')\n+        self.assertEqual(response.request.get('SERVER_PORT'), '8443')\n+\n     def test_redirect_chain_on_non_redirect_page(self):\n         \"An assertion is raised if the original page couldn't be retrieved as expected\"\n         # This page will redirect with code 301, not 302"
        },
        {
            "sha": "93f7a2e2f269aede73dcd902eaad6703c5b9f57b",
            "filename": "tests/regressiontests/test_client_regress/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/33a52cde08ef7ab8ba8990d40646d0dc2a8482df/tests%2Fregressiontests%2Ftest_client_regress%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/33a52cde08ef7ab8ba8990d40646d0dc2a8482df/tests%2Fregressiontests%2Ftest_client_regress%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Furls.py?ref=33a52cde08ef7ab8ba8990d40646d0dc2a8482df",
            "patch": "@@ -23,6 +23,7 @@\n     (r'^circular_redirect_1/$', RedirectView.as_view(url='/test_client_regress/circular_redirect_2/')),\n     (r'^circular_redirect_2/$', RedirectView.as_view(url='/test_client_regress/circular_redirect_3/')),\n     (r'^circular_redirect_3/$', RedirectView.as_view(url='/test_client_regress/circular_redirect_1/')),\n+    (r'^redirect_other_host/$', RedirectView.as_view(url='https://otherserver:8443/test_client_regress/no_template_view/')),\n     (r'^set_session/$', views.set_session_view),\n     (r'^check_session/$', views.check_session_view),\n     (r'^request_methods/$', views.request_methods_view),"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 21,
        "deletions": 9
    }
}