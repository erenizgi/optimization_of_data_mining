{
    "author": "jezdez",
    "message": "Set the post process cache when finished instead of one by one.\n\nThis should prevent a race condition if running collectstatic is\ncanceled or its cache is accessed from other processes, leaving the\ncache in a corrupt state.",
    "sha": "1c1a22963236c6015724bfbf43dd56dbe40a6cf9",
    "files": [
        {
            "sha": "7b5866a699ba1b64df574e939b2294a560cc01ce",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/1c1a22963236c6015724bfbf43dd56dbe40a6cf9/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/1c1a22963236c6015724bfbf43dd56dbe40a6cf9/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=1c1a22963236c6015724bfbf43dd56dbe40a6cf9",
            "patch": "@@ -189,8 +189,8 @@ def post_process(self, paths, dry_run=False, **options):\n         if dry_run:\n             return\n \n-        # delete cache of all handled paths\n-        self.cache.delete_many([self.cache_key(path) for path in paths])\n+        # where to store the new paths\n+        hashed_paths = {}\n \n         # build a list of adjustable files\n         matches = lambda path: matches_patterns(path, self._patterns.keys())\n@@ -239,9 +239,12 @@ def post_process(self, paths, dry_run=False, **options):\n                         hashed_name = force_unicode(saved_name.replace('\\\\', '/'))\n \n                 # and then set the cache accordingly\n-                self.cache.set(self.cache_key(name), hashed_name)\n+                hashed_paths[self.cache_key(name)] = hashed_name\n                 yield name, hashed_name, processed\n \n+        # Finally set the cache\n+        self.cache.set_many(hashed_paths)\n+\n \n class CachedStaticFilesStorage(CachedFilesMixin, StaticFilesStorage):\n     \"\"\""
        }
    ],
    "stats": {
        "total": 9,
        "additions": 6,
        "deletions": 3
    }
}