{
    "author": "akaariai",
    "message": "Fixed #19058 -- Fixed Oracle GIS crash\n\nThe problem is the same as in #10888 which was reintroduced when\nbulk_insert was added. Thanks to Jani Tiainen for report, patch and\nalso testing the final patch on Oracle GIS.",
    "sha": "92d7f541da8b59520c833b19fbba52d3ecef2428",
    "files": [
        {
            "sha": "98da0163ba06d7d5fb6a91e64431253f51e116f1",
            "filename": "django/contrib/gis/db/backends/oracle/compiler.py",
            "status": "modified",
            "additions": 1,
            "deletions": 23,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Fcompiler.py?ref=92d7f541da8b59520c833b19fbba52d3ecef2428",
            "patch": "@@ -7,29 +7,7 @@ class GeoSQLCompiler(BaseGeoSQLCompiler, SQLCompiler):\n     pass\n \n class SQLInsertCompiler(compiler.SQLInsertCompiler, GeoSQLCompiler):\n-    def placeholder(self, field, val):\n-        if field is None:\n-            # A field value of None means the value is raw.\n-            return val\n-        elif hasattr(field, 'get_placeholder'):\n-            # Some fields (e.g. geo fields) need special munging before\n-            # they can be inserted.\n-            ph = field.get_placeholder(val, self.connection)\n-            if ph == 'NULL':\n-                # If the placeholder returned is 'NULL', then we need to\n-                # to remove None from the Query parameters. Specifically,\n-                # cx_Oracle will assume a CHAR type when a placeholder ('%s')\n-                # is used for columns of MDSYS.SDO_GEOMETRY.  Thus, we use\n-                # 'NULL' for the value, and remove None from the query params.\n-                # See also #10888.\n-                param_idx = self.query.columns.index(field.column)\n-                params = list(self.query.params)\n-                params.pop(param_idx)\n-                self.query.params = tuple(params)\n-            return ph\n-        else:\n-            # Return the common case for the placeholder\n-            return '%s'\n+    pass\n \n class SQLDeleteCompiler(compiler.SQLDeleteCompiler, GeoSQLCompiler):\n     pass"
        },
        {
            "sha": "4e42b4cf0001deb6effcfbd71c4ff12b0e6d53bb",
            "filename": "django/contrib/gis/db/backends/oracle/operations.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py?ref=92d7f541da8b59520c833b19fbba52d3ecef2428",
            "patch": "@@ -288,3 +288,12 @@ def geometry_columns(self):\n     def spatial_ref_sys(self):\n         from django.contrib.gis.db.backends.oracle.models import SpatialRefSys\n         return SpatialRefSys\n+    \n+    def modify_insert_params(self, placeholders, params):\n+        \"\"\"Drop out insert parameters for NULL placeholder. Needed for Oracle Spatial\n+        backend due to #10888\n+        \"\"\"\n+        # This code doesn't work for bulk insert cases.\n+        assert len(placeholders) == 1\n+        return [[param for pholder,param\n+                 in six.moves.zip(placeholders[0], params[0]) if pholder != 'NULL'], ]"
        },
        {
            "sha": "8dd0212dbbb960181647b98582bf88f9eb6e842f",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=92d7f541da8b59520c833b19fbba52d3ecef2428",
            "patch": "@@ -916,6 +916,11 @@ def combine_expression(self, connector, sub_expressions):\n         conn = ' %s ' % connector\n         return conn.join(sub_expressions)\n \n+    def modify_insert_params(self, placeholders, params):\n+        \"\"\"Allow modification of insert parameters. Needed for Oracle Spatial\n+        backend due to #10888.\n+        \"\"\"\n+        return params\n \n class BaseDatabaseIntrospection(object):\n     \"\"\""
        },
        {
            "sha": "2ad45423415c3a1f5051503a4e2499f60080977b",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/92d7f541da8b59520c833b19fbba52d3ecef2428/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=92d7f541da8b59520c833b19fbba52d3ecef2428",
            "patch": "@@ -856,6 +856,8 @@ def as_sql(self):\n                 [self.placeholder(field, v) for field, v in zip(fields, val)]\n                 for val in values\n             ]\n+            # Oracle Spatial needs to remove some values due to #10888\n+            params = self.connection.ops.modify_insert_params(placeholders, params)\n         if self.return_id and self.connection.features.can_return_id_from_insert:\n             params = params[0]\n             col = \"%s.%s\" % (qn(opts.db_table), qn(opts.pk.column))"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 17,
        "deletions": 23
    }
}