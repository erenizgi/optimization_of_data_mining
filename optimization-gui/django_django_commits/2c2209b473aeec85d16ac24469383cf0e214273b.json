{
    "author": "jezdez",
    "message": "Fixed #13607 -- Auto-initialize admin's date hierarchy links intelligently. Thanks, Simon Meers.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14879 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2c2209b473aeec85d16ac24469383cf0e214273b",
    "files": [
        {
            "sha": "220b60e1dc67488316dafb81918862172bf9a7bb",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/2c2209b473aeec85d16ac24469383cf0e214273b/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/2c2209b473aeec85d16ac24469383cf0e214273b/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=2c2209b473aeec85d16ac24469383cf0e214273b",
            "patch": "@@ -231,6 +231,16 @@ def date_hierarchy(cl):\n \n         link = lambda d: cl.get_query_string(d, [field_generic])\n \n+        if not (year_lookup or month_lookup or day_lookup):\n+            # select appropriate start level\n+            date_range = cl.query_set.aggregate(first=models.Min(field_name),\n+                                                last=models.Max(field_name))\n+            if date_range['first'] and date_range['last']:\n+                if date_range['first'].year == date_range['last'].year:\n+                    year_lookup = date_range['first'].year\n+                    if date_range['first'].month == date_range['last'].month:\n+                        month_lookup = date_range['first'].month\n+\n         if year_lookup and month_lookup and day_lookup:\n             day = datetime.date(int(year_lookup), int(month_lookup), int(day_lookup))\n             return {"
        },
        {
            "sha": "7d650f52baac7e6c4671c660db17dd047e281905",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/2c2209b473aeec85d16ac24469383cf0e214273b/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/2c2209b473aeec85d16ac24469383cf0e214273b/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=2c2209b473aeec85d16ac24469383cf0e214273b",
            "patch": "@@ -107,6 +107,12 @@ subclass::\n \n         date_hierarchy = 'pub_date'\n \n+    .. versionadded:: 1.3\n+\n+        This will intelligently populate itself based on available data,\n+        e.g. if all the dates are in one month, it'll show the day-level\n+        drill-down only.\n+\n .. attribute:: ModelAdmin.form\n \n     By default a ``ModelForm`` is dynamically created for your model. It is"
        },
        {
            "sha": "12b92d80a45ba236b238ef8d7774564827e97808",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/2c2209b473aeec85d16ac24469383cf0e214273b/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/2c2209b473aeec85d16ac24469383cf0e214273b/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=2c2209b473aeec85d16ac24469383cf0e214273b",
            "patch": "@@ -320,7 +320,7 @@ class Podcast(Media):\n class PodcastAdmin(admin.ModelAdmin):\n     list_display = ('name', 'release_date')\n     list_editable = ('release_date',)\n-\n+    date_hierarchy = 'release_date'\n     ordering = ('name',)\n \n class Vodcast(Media):"
        },
        {
            "sha": "0c9f03b93346d6c6c42f1b88454bea7be1bb5a39",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/django/django/blob/2c2209b473aeec85d16ac24469383cf0e214273b/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2c2209b473aeec85d16ac24469383cf0e214273b/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=2c2209b473aeec85d16ac24469383cf0e214273b",
            "patch": "@@ -6,6 +6,7 @@\n from django.conf import settings\n from django.core import mail\n from django.core.files import temp as tempfile\n+from django.core.urlresolvers import reverse\n # Register auth models with the admin.\n from django.contrib.auth import REDIRECT_FIELD_NAME, admin\n from django.contrib.auth.models import User, Permission, UNUSABLE_PASSWORD\n@@ -2395,3 +2396,105 @@ def testLangNamePresent(self):\n         response = self.client.get('/test_admin/%s/admin_views/' % self.urlbit)\n         self.assertFalse(' lang=\"\"' in response.content)\n         self.assertFalse(' xml:lang=\"\"' in response.content)\n+\n+\n+class DateHierarchyTests(TestCase):\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def assert_contains_year_link(self, response, date):\n+        self.assertContains(response, '?release_date__year=%d\"' % (date.year,))\n+\n+    def assert_contains_month_link(self, response, date):\n+        self.assertContains(\n+            response, '?release_date__year=%d&amp;release_date__month=%d\"' % (\n+                date.year, date.month))\n+\n+    def assert_contains_day_link(self, response, date):\n+        self.assertContains(\n+            response, '?release_date__year=%d&amp;'\n+            'release_date__month=%d&amp;release_date__day=%d\"' % (\n+                date.year, date.month, date.day))\n+\n+    def test_empty(self):\n+        \"\"\"\n+        Ensure that no date hierarchy links display with empty changelist.\n+        \"\"\"\n+        response = self.client.get(\n+            reverse('admin:admin_views_podcast_changelist'))\n+        self.assertNotContains(response, 'release_date__year=')\n+        self.assertNotContains(response, 'release_date__month=')\n+        self.assertNotContains(response, 'release_date__day=')\n+\n+    def test_single(self):\n+        \"\"\"\n+        Ensure that single day-level date hierarchy appears for single object.\n+        \"\"\"\n+        DATE = datetime.date(2000, 6, 30)\n+        Podcast.objects.create(release_date=DATE)\n+        response = self.client.get(\n+            reverse('admin:admin_views_podcast_changelist'))\n+        self.assert_contains_day_link(response, DATE)\n+\n+    def test_within_month(self):\n+        \"\"\"\n+        Ensure that day-level links appear for changelist within single month.\n+        \"\"\"\n+        DATES = (datetime.date(2000, 6, 30),\n+                 datetime.date(2000, 6, 15),\n+                 datetime.date(2000, 6, 3))\n+        for date in DATES:\n+            Podcast.objects.create(release_date=date)\n+        response = self.client.get(\n+            reverse('admin:admin_views_podcast_changelist'))\n+        for date in DATES:\n+            self.assert_contains_day_link(response, date)\n+\n+    def test_within_year(self):\n+        \"\"\"\n+        Ensure that month-level links appear for changelist within single year.\n+        \"\"\"\n+        DATES = (datetime.date(2000, 1, 30),\n+                 datetime.date(2000, 3, 15),\n+                 datetime.date(2000, 5, 3))\n+        for date in DATES:\n+            Podcast.objects.create(release_date=date)\n+        response = self.client.get(\n+            reverse('admin:admin_views_podcast_changelist'))\n+        # no day-level links\n+        self.assertNotContains(response, 'release_date__day=')\n+        for date in DATES:\n+            self.assert_contains_month_link(response, date)\n+\n+    def test_multiple_years(self):\n+        \"\"\"\n+        Ensure that year-level links appear for year-spanning changelist.\n+        \"\"\"\n+        DATES = (datetime.date(2001, 1, 30),\n+                 datetime.date(2003, 3, 15),\n+                 datetime.date(2005, 5, 3))\n+        for date in DATES:\n+            Podcast.objects.create(release_date=date)\n+        response = self.client.get(\n+            reverse('admin:admin_views_podcast_changelist'))\n+        # no day/month-level links\n+        self.assertNotContains(response, 'release_date__day=')\n+        self.assertNotContains(response, 'release_date__month=')\n+        for date in DATES:\n+            self.assert_contains_year_link(response, date)\n+\n+        # and make sure GET parameters still behave correctly\n+        for date in DATES:\n+            response = self.client.get(\n+                '%s?release_date__year=%d' % (\n+                    reverse('admin:admin_views_podcast_changelist'),\n+                    date.year))\n+            self.assert_contains_month_link(response, date)\n+\n+            response = self.client.get(\n+                '%s?release_date__year=%d&release_date__month=%d' % (\n+                    reverse('admin:admin_views_podcast_changelist'),\n+                    date.year, date.month))\n+            self.assert_contains_day_link(response, date)"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 120,
        "deletions": 1
    }
}