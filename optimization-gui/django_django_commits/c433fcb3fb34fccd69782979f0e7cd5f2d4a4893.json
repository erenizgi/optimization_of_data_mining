{
    "author": "freakboy3742",
    "message": "Fixed #19077, #19079 -- Made USERNAME_FIELD a required field, and modified UserAdmin to match.",
    "sha": "c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
    "files": [
        {
            "sha": "7bbd73a4644f18dbe3ee909e566084a18f40c222",
            "filename": "django/contrib/admin/templates/admin/base.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fbase.html",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fbase.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fbase.html?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -26,7 +26,7 @@\n         {% if user.is_active and user.is_staff %}\n         <div id=\"user-tools\">\n             {% trans 'Welcome,' %}\n-            <strong>{% filter force_escape %}{% firstof user.get_short_name user.username %}{% endfilter %}</strong>.\n+            <strong>{% filter force_escape %}{% firstof user.get_short_name user.get_username %}{% endfilter %}</strong>.\n             {% block userlinks %}\n                 {% url 'django-admindocs-docroot' as docsroot %}\n                 {% if docsroot %}"
        },
        {
            "sha": "870c4648a60af068ee8043a6df5f8fb52c85479a",
            "filename": "django/contrib/admin/templates/admin/object_history.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fobject_history.html",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fobject_history.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fobject_history.html?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -29,7 +29,7 @@\n         {% for action in action_list %}\n         <tr>\n             <th scope=\"row\">{{ action.action_time|date:\"DATETIME_FORMAT\" }}</th>\n-            <td>{{ action.user.username }}{% if action.user.get_full_name %} ({{ action.user.get_full_name }}){% endif %}</td>\n+            <td>{{ action.user.get_username }}{% if action.user.get_full_name %} ({{ action.user.get_full_name }}){% endif %}</td>\n             <td>{{ action.change_message }}</td>\n         </tr>\n         {% endfor %}"
        },
        {
            "sha": "a220f12033596b378a6bbaaecbcb1f3ff64f3875",
            "filename": "django/contrib/admin/templates/registration/password_reset_email.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fadmin%2Ftemplates%2Fregistration%2Fpassword_reset_email.html",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fadmin%2Ftemplates%2Fregistration%2Fpassword_reset_email.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fregistration%2Fpassword_reset_email.html?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -5,7 +5,7 @@\n {% block reset_link %}\n {{ protocol }}://{{ domain }}{% url 'django.contrib.auth.views.password_reset_confirm' uidb36=uid token=token %}\n {% endblock %}\n-{% trans \"Your username, in case you've forgotten:\" %} {{ user.username }}\n+{% trans \"Your username, in case you've forgotten:\" %} {{ user.get_username }}\n \n {% trans \"Thanks for using our site!\" %}\n "
        },
        {
            "sha": "7fc723f475d48b0c4c497f49daeff85f7f977737",
            "filename": "django/contrib/auth/admin.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fadmin.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -11,14 +11,13 @@\n from django.template.response import TemplateResponse\n from django.utils.html import escape\n from django.utils.decorators import method_decorator\n-from django.utils.safestring import mark_safe\n-from django.utils import six\n from django.utils.translation import ugettext, ugettext_lazy as _\n from django.views.decorators.csrf import csrf_protect\n from django.views.decorators.debug import sensitive_post_parameters\n \n csrf_protect_m = method_decorator(csrf_protect)\n \n+\n class GroupAdmin(admin.ModelAdmin):\n     search_fields = ('name',)\n     ordering = ('name',)\n@@ -106,9 +105,10 @@ def add_view(self, request, form_url='', extra_context=None):\n             raise PermissionDenied\n         if extra_context is None:\n             extra_context = {}\n+        username_field = self.model._meta.get_field(self.model.USERNAME_FIELD)\n         defaults = {\n             'auto_populated_fields': (),\n-            'username_help_text': self.model._meta.get_field('username').help_text,\n+            'username_help_text': username_field.help_text,\n         }\n         extra_context.update(defaults)\n         return super(UserAdmin, self).add_view(request, form_url,\n@@ -171,4 +171,3 @@ def response_add(self, request, obj, post_url_continue='../%s/'):\n \n admin.site.register(Group, GroupAdmin)\n admin.site.register(User, UserAdmin)\n-"
        },
        {
            "sha": "db99c948385be260fcbee182b9d1044392ee9f6e",
            "filename": "django/contrib/auth/backends.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fbackends.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fbackends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fbackends.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -105,7 +105,7 @@ def authenticate(self, remote_user):\n         # built-in safeguards for multiple threads.\n         if self.create_unknown_user:\n             user, created = UserModel.objects.get_or_create(**{\n-                getattr(UserModel, 'USERNAME_FIELD', 'username'): username\n+                UserModel.USERNAME_FIELD: username\n             })\n             if created:\n                 user = self.configure_user(user)"
        },
        {
            "sha": "fbd8d0482eaf98030ac7f96548e9f01e239bede9",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -52,6 +52,9 @@ def __init__(self, *args, **kwargs):\n         kwargs.setdefault(\"required\", False)\n         super(ReadOnlyPasswordHashField, self).__init__(*args, **kwargs)\n \n+    def clean_password(self):\n+        return self.initial\n+\n \n class UserCreationForm(forms.ModelForm):\n     \"\"\"\n@@ -118,9 +121,6 @@ class UserChangeForm(forms.ModelForm):\n                     \"this user's password, but you can change the password \"\n                     \"using <a href=\\\"password/\\\">this form</a>.\"))\n \n-    def clean_password(self):\n-        return self.initial[\"password\"]\n-\n     class Meta:\n         model = User\n \n@@ -160,7 +160,7 @@ def __init__(self, request=None, *args, **kwargs):\n \n         # Set the label for the \"username\" field.\n         UserModel = get_user_model()\n-        username_field = UserModel._meta.get_field(getattr(UserModel, 'USERNAME_FIELD', 'username'))\n+        username_field = UserModel._meta.get_field(UserModel.USERNAME_FIELD)\n         self.fields['username'].label = capfirst(username_field.verbose_name)\n \n     def clean(self):"
        },
        {
            "sha": "ff38836a95f3360e0983ad39a8f81d63c4dab4f6",
            "filename": "django/contrib/auth/management/commands/changepassword.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -34,7 +34,7 @@ def handle(self, *args, **options):\n \n         try:\n             u = UserModel.objects.using(options.get('database')).get(**{\n-                    getattr(UserModel, 'USERNAME_FIELD', 'username'): username\n+                    UserModel.USERNAME_FIELD: username\n                 })\n         except UserModel.DoesNotExist:\n             raise CommandError(\"user '%s' does not exist\" % username)"
        },
        {
            "sha": "cb5d906342d3cb4a72aa96cb46487b8725494861",
            "filename": "django/contrib/auth/management/commands/createsuperuser.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -42,7 +42,7 @@ def handle(self, *args, **options):\n \n         UserModel = get_user_model()\n \n-        username_field = UserModel._meta.get_field(getattr(UserModel, 'USERNAME_FIELD', 'username'))\n+        username_field = UserModel._meta.get_field(UserModel.USERNAME_FIELD)\n         other_fields = UserModel.REQUIRED_FIELDS\n \n         # If not provided, create the user with an unusable password\n@@ -74,7 +74,7 @@ def handle(self, *args, **options):\n \n                 # Get a username\n                 while username is None:\n-                    username_field = UserModel._meta.get_field(getattr(UserModel, 'USERNAME_FIELD', 'username'))\n+                    username_field = UserModel._meta.get_field(UserModel.USERNAME_FIELD)\n                     if not username:\n                         input_msg = capfirst(username_field.verbose_name)\n                         if default_username:\n@@ -91,7 +91,7 @@ def handle(self, *args, **options):\n                         continue\n                     try:\n                         UserModel.objects.using(database).get(**{\n-                                getattr(UserModel, 'USERNAME_FIELD', 'username'): username\n+                                UserModel.USERNAME_FIELD: username\n                             })\n                     except UserModel.DoesNotExist:\n                         pass"
        },
        {
            "sha": "0398cfaf1e403975f22b92d3bf0b80ba1406a9ba",
            "filename": "django/contrib/auth/middleware.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmiddleware.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -55,7 +55,7 @@ def process_request(self, request):\n         # getting passed in the headers, then the correct user is already\n         # persisted in the session and we don't need to continue.\n         if request.user.is_authenticated():\n-            if request.user.username == self.clean_username(username, request):\n+            if request.user.get_username() == self.clean_username(username, request):\n                 return\n         # We are seeing this user for the first time in this session, attempt\n         # to authenticate the user.\n@@ -75,6 +75,6 @@ def clean_username(self, username, request):\n         backend = auth.load_backend(backend_str)\n         try:\n             username = backend.clean_username(username)\n-        except AttributeError: # Backend has no clean_username method.\n+        except AttributeError:  # Backend has no clean_username method.\n             pass\n         return username"
        },
        {
            "sha": "bd7bf4a162a7857b3560cccd948b777a7302f4fd",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 13,
            "deletions": 8,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -165,7 +165,7 @@ def make_random_password(self, length=10,\n         return get_random_string(length, allowed_chars)\n \n     def get_by_natural_key(self, username):\n-        return self.get(**{getattr(self.model, 'USERNAME_FIELD', 'username'): username})\n+        return self.get(**{self.model.USERNAME_FIELD: username})\n \n \n class UserManager(BaseUserManager):\n@@ -227,6 +227,7 @@ def _user_has_module_perms(user, app_label):\n     return False\n \n \n+@python_2_unicode_compatible\n class AbstractBaseUser(models.Model):\n     password = models.CharField(_('password'), max_length=128)\n     last_login = models.DateTimeField(_('last login'), default=timezone.now)\n@@ -236,6 +237,16 @@ class AbstractBaseUser(models.Model):\n     class Meta:\n         abstract = True\n \n+    def get_username(self):\n+        \"Return the identifying username for this User\"\n+        return getattr(self, self.USERNAME_FIELD)\n+\n+    def __str__(self):\n+        return self.get_username()\n+\n+    def natural_key(self):\n+        return (self.get_username(),)\n+\n     def is_anonymous(self):\n         \"\"\"\n         Always returns False. This is a way of comparing User objects to\n@@ -277,7 +288,6 @@ def get_short_name(self):\n         raise NotImplementedError()\n \n \n-@python_2_unicode_compatible\n class AbstractUser(AbstractBaseUser):\n     \"\"\"\n     An abstract base class implementing a fully featured User model with\n@@ -314,19 +324,14 @@ class AbstractUser(AbstractBaseUser):\n \n     objects = UserManager()\n \n+    USERNAME_FIELD = 'username'\n     REQUIRED_FIELDS = ['email']\n \n     class Meta:\n         verbose_name = _('user')\n         verbose_name_plural = _('users')\n         abstract = True\n \n-    def __str__(self):\n-        return self.username\n-\n-    def natural_key(self):\n-        return (self.username,)\n-\n     def get_absolute_url(self):\n         return \"/users/%s/\" % urlquote(self.username)\n "
        },
        {
            "sha": "a651baaadf2b3e3bf92c08094478a6ea99ca2cc4",
            "filename": "django/contrib/comments/admin.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fcomments%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fcomments%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fadmin.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -1,11 +1,22 @@\n from __future__ import unicode_literals\n \n from django.contrib import admin\n+from django.contrib.auth import get_user_model\n from django.contrib.comments.models import Comment\n from django.utils.translation import ugettext_lazy as _, ungettext\n from django.contrib.comments import get_model\n from django.contrib.comments.views.moderation import perform_flag, perform_approve, perform_delete\n \n+\n+class UsernameSearch(object):\n+    \"\"\"The User object may not be auth.User, so we need to provide\n+    a mechanism for issuing the equivalent of a .filter(user__username=...)\n+    search in CommentAdmin.\n+    \"\"\"\n+    def __str__(self):\n+        return 'user__%s' % get_user_model().USERNAME_FIELD\n+\n+\n class CommentsAdmin(admin.ModelAdmin):\n     fieldsets = (\n         (None,\n@@ -24,7 +35,7 @@ class CommentsAdmin(admin.ModelAdmin):\n     date_hierarchy = 'submit_date'\n     ordering = ('-submit_date',)\n     raw_id_fields = ('user',)\n-    search_fields = ('comment', 'user__username', 'user_name', 'user_email', 'user_url', 'ip_address')\n+    search_fields = ('comment', UsernameSearch(), 'user_name', 'user_email', 'user_url', 'ip_address')\n     actions = [\"flag_comments\", \"approve_comments\", \"remove_comments\"]\n \n     def get_actions(self, request):"
        },
        {
            "sha": "c263ea7d10cd36427233ccafe70e5e6da2fc752c",
            "filename": "django/contrib/comments/models.py",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fcomments%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fcomments%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fmodels.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -19,14 +19,14 @@ class BaseCommentAbstractModel(models.Model):\n     \"\"\"\n \n     # Content-object field\n-    content_type   = models.ForeignKey(ContentType,\n+    content_type = models.ForeignKey(ContentType,\n             verbose_name=_('content type'),\n             related_name=\"content_type_set_for_%(class)s\")\n-    object_pk      = models.TextField(_('object ID'))\n+    object_pk = models.TextField(_('object ID'))\n     content_object = generic.GenericForeignKey(ct_field=\"content_type\", fk_field=\"object_pk\")\n \n     # Metadata about the comment\n-    site        = models.ForeignKey(Site)\n+    site = models.ForeignKey(Site)\n \n     class Meta:\n         abstract = True\n@@ -50,21 +50,21 @@ class Comment(BaseCommentAbstractModel):\n     # Who posted this comment? If ``user`` is set then it was an authenticated\n     # user; otherwise at least user_name should have been set and the comment\n     # was posted by a non-authenticated user.\n-    user        = models.ForeignKey(settings.AUTH_USER_MODEL, verbose_name=_('user'),\n+    user = models.ForeignKey(settings.AUTH_USER_MODEL, verbose_name=_('user'),\n                     blank=True, null=True, related_name=\"%(class)s_comments\")\n-    user_name   = models.CharField(_(\"user's name\"), max_length=50, blank=True)\n-    user_email  = models.EmailField(_(\"user's email address\"), blank=True)\n-    user_url    = models.URLField(_(\"user's URL\"), blank=True)\n+    user_name = models.CharField(_(\"user's name\"), max_length=50, blank=True)\n+    user_email = models.EmailField(_(\"user's email address\"), blank=True)\n+    user_url = models.URLField(_(\"user's URL\"), blank=True)\n \n     comment = models.TextField(_('comment'), max_length=COMMENT_MAX_LENGTH)\n \n     # Metadata about the comment\n     submit_date = models.DateTimeField(_('date/time submitted'), default=None)\n-    ip_address  = models.IPAddressField(_('IP address'), blank=True, null=True)\n-    is_public   = models.BooleanField(_('is public'), default=True,\n+    ip_address = models.IPAddressField(_('IP address'), blank=True, null=True)\n+    is_public = models.BooleanField(_('is public'), default=True,\n                     help_text=_('Uncheck this box to make the comment effectively ' \\\n                                 'disappear from the site.'))\n-    is_removed  = models.BooleanField(_('is removed'), default=False,\n+    is_removed = models.BooleanField(_('is removed'), default=False,\n                     help_text=_('Check this box if the comment is inappropriate. ' \\\n                                 'A \"This comment has been removed\" message will ' \\\n                                 'be displayed instead.'))\n@@ -96,9 +96,9 @@ def _get_userinfo(self):\n         \"\"\"\n         if not hasattr(self, \"_userinfo\"):\n             userinfo = {\n-                \"name\"  : self.user_name,\n-                \"email\" : self.user_email,\n-                \"url\"   : self.user_url\n+                \"name\": self.user_name,\n+                \"email\": self.user_email,\n+                \"url\": self.user_url\n             }\n             if self.user_id:\n                 u = self.user\n@@ -111,7 +111,7 @@ def _get_userinfo(self):\n                 if u.get_full_name():\n                     userinfo[\"name\"] = self.user.get_full_name()\n                 elif not self.user_name:\n-                    userinfo[\"name\"] = u.username\n+                    userinfo[\"name\"] = u.get_username()\n             self._userinfo = userinfo\n         return self._userinfo\n     userinfo = property(_get_userinfo, doc=_get_userinfo.__doc__)\n@@ -174,9 +174,9 @@ class CommentFlag(models.Model):\n     design users are only allowed to flag a comment with a given flag once;\n     if you want rating look elsewhere.\n     \"\"\"\n-    user      = models.ForeignKey(settings.AUTH_USER_MODEL, verbose_name=_('user'), related_name=\"comment_flags\")\n-    comment   = models.ForeignKey(Comment, verbose_name=_('comment'), related_name=\"flags\")\n-    flag      = models.CharField(_('flag'), max_length=30, db_index=True)\n+    user = models.ForeignKey(settings.AUTH_USER_MODEL, verbose_name=_('user'), related_name=\"comment_flags\")\n+    comment = models.ForeignKey(Comment, verbose_name=_('comment'), related_name=\"flags\")\n+    flag = models.CharField(_('flag'), max_length=30, db_index=True)\n     flag_date = models.DateTimeField(_('date'), default=None)\n \n     # Constants for flag types\n@@ -192,7 +192,7 @@ class Meta:\n \n     def __str__(self):\n         return \"%s flag of comment ID %s by %s\" % \\\n-            (self.flag, self.comment_id, self.user.username)\n+            (self.flag, self.comment_id, self.user.get_username())\n \n     def save(self, *args, **kwargs):\n         if self.flag_date is None:"
        },
        {
            "sha": "27d5a48ac6016df353a247f3429a56118f3af4a6",
            "filename": "django/contrib/comments/views/comments.py",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fcomments%2Fviews%2Fcomments.py",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/django%2Fcontrib%2Fcomments%2Fviews%2Fcomments.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fviews%2Fcomments.py?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -15,7 +15,6 @@\n from django.views.decorators.http import require_POST\n \n \n-\n class CommentPostBadRequest(http.HttpResponseBadRequest):\n     \"\"\"\n     Response returned when a comment post is invalid. If ``DEBUG`` is on a\n@@ -27,6 +26,7 @@ def __init__(self, why):\n         if settings.DEBUG:\n             self.content = render_to_string(\"comments/400-debug.html\", {\"why\": why})\n \n+\n @csrf_protect\n @require_POST\n def post_comment(request, next=None, using=None):\n@@ -40,7 +40,7 @@ def post_comment(request, next=None, using=None):\n     data = request.POST.copy()\n     if request.user.is_authenticated():\n         if not data.get('name', ''):\n-            data[\"name\"] = request.user.get_full_name() or request.user.username\n+            data[\"name\"] = request.user.get_full_name() or request.user.get_username()\n         if not data.get('email', ''):\n             data[\"email\"] = request.user.email\n \n@@ -98,8 +98,8 @@ def post_comment(request, next=None, using=None):\n         ]\n         return render_to_response(\n             template_list, {\n-                \"comment\" : form.data.get(\"comment\", \"\"),\n-                \"form\" : form,\n+                \"comment\": form.data.get(\"comment\", \"\"),\n+                \"form\": form,\n                 \"next\": next,\n             },\n             RequestContext(request, {})\n@@ -113,9 +113,9 @@ def post_comment(request, next=None, using=None):\n \n     # Signal that the comment is about to be saved\n     responses = signals.comment_will_be_posted.send(\n-        sender  = comment.__class__,\n-        comment = comment,\n-        request = request\n+        sender=comment.__class__,\n+        comment=comment,\n+        request=request\n     )\n \n     for (receiver, response) in responses:\n@@ -126,15 +126,14 @@ def post_comment(request, next=None, using=None):\n     # Save the comment and signal that it was saved\n     comment.save()\n     signals.comment_was_posted.send(\n-        sender  = comment.__class__,\n-        comment = comment,\n-        request = request\n+        sender=comment.__class__,\n+        comment=comment,\n+        request=request\n     )\n \n     return next_redirect(data, next, comment_done, c=comment._get_pk_val())\n \n comment_done = confirmation_view(\n-    template = \"comments/posted.html\",\n-    doc = \"\"\"Display a \"comment was posted\" success page.\"\"\"\n+    template=\"comments/posted.html\",\n+    doc=\"\"\"Display a \"comment was posted\" success page.\"\"\"\n )\n-"
        },
        {
            "sha": "fd2e56ebebdb67dd161351e4ebb1ad6a8249ee6f",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 188,
            "deletions": 9,
            "changes": 197,
            "blob_url": "https://github.com/django/django/blob/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/c433fcb3fb34fccd69782979f0e7cd5f2d4a4893/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=c433fcb3fb34fccd69782979f0e7cd5f2d4a4893",
            "patch": "@@ -149,6 +149,12 @@ Methods\n     :class:`~django.contrib.auth.models.User` objects have the following custom\n     methods:\n \n+    .. method:: models.User.get_username()\n+\n+        Returns the username for the user. Since the User model can be swapped\n+        out, you should use  this method instead of referencing the username\n+        attribute directly.\n+\n     .. method:: models.User.is_anonymous()\n \n         Always returns ``False``. This is a way of differentiating\n@@ -1826,11 +1832,12 @@ different User model.\n Instead of referring to :class:`~django.contrib.auth.models.User` directly,\n you should reference the user model using\n :func:`django.contrib.auth.get_user_model()`. This method will return the\n-currently  active User model -- the custom User model if one is specified, or\n+currently active User model -- the custom User model if one is specified, or\n :class:`~django.contrib.auth.User` otherwise.\n \n-In relations to the User model, you should specify the custom model using\n-the :setting:`AUTH_USER_MODEL` setting. For example::\n+When you define a foreign key or many-to-many relations to the User model,\n+you should specify the custom model using the :setting:`AUTH_USER_MODEL`\n+setting. For example::\n \n     from django.conf import settings\n     from django.db import models\n@@ -1910,6 +1917,60 @@ password resets. You must then provide some key implementation details:\n     identifies the user in an informal way. It may also return the same\n     value as :meth:`django.contrib.auth.User.get_full_name()`.\n \n+The following methods are available on any subclass of\n+:class:`~django.contrib.auth.models.AbstractBaseUser`::\n+\n+.. class:: models.AbstractBaseUser\n+\n+    .. method:: models.AbstractBaseUser.get_username()\n+\n+        Returns the value of the field nominated by ``USERNAME_FIELD``.\n+\n+    .. method:: models.AbstractBaseUser.is_anonymous()\n+\n+        Always returns ``False``. This is a way of differentiating\n+        from  :class:`~django.contrib.auth.models.AnonymousUser` objects.\n+        Generally, you should prefer using\n+        :meth:`~django.contrib.auth.models.AbstractBaseUser.is_authenticated()` to this\n+        method.\n+\n+    .. method:: models.AbstractBaseUser.is_authenticated()\n+\n+        Always returns ``True``. This is a way to tell if the user has been\n+        authenticated. This does not imply any permissions, and doesn't check\n+        if the user is active - it only indicates that the user has provided a\n+        valid username and password.\n+\n+    .. method:: models.AbstractBaseUser.set_password(raw_password)\n+\n+        Sets the user's password to the given raw string, taking care of the\n+        password hashing. Doesn't save the\n+        :class:`~django.contrib.auth.models.AbstractBaseUser` object.\n+\n+    .. method:: models.AbstractBaseUser.check_password(raw_password)\n+\n+        Returns ``True`` if the given raw string is the correct password for\n+        the user. (This takes care of the password hashing in making the\n+        comparison.)\n+\n+    .. method:: models.AbstractBaseUser.set_unusable_password()\n+\n+        Marks the user as having no password set.  This isn't the same as\n+        having a blank string for a password.\n+        :meth:`~django.contrib.auth.models.AbstractBaseUser.check_password()` for this user\n+        will never return ``True``. Doesn't save the\n+        :class:`~django.contrib.auth.models.AbstractBaseUser` object.\n+\n+        You may need this if authentication for your application takes place\n+        against an existing external source such as an LDAP directory.\n+\n+    .. method:: models.AbstractBaseUser.has_usable_password()\n+\n+        Returns ``False`` if\n+        :meth:`~django.contrib.auth.models.AbstractBaseUser.set_unusable_password()` has\n+        been called for this user.\n+\n+\n You should also define a custom manager for your User model. If your User\n model defines `username` and `email` fields the same as Django's default User,\n you can just install Django's\n@@ -1941,6 +2002,31 @@ additional methods:\n     Unlike `create_user()`, `create_superuser()` *must* require the caller\n     to provider a password.\n \n+:class:`~django.contrib.auth.models.BaseUserManager` provides the following\n+utility methods:\n+\n+.. class:: models.BaseUserManager\n+    .. method:: models.BaseUserManager.normalize_email(email)\n+\n+        A classmethod that normalizes email addresses by lowercasing\n+        the domain portion of the email address.\n+\n+    .. method:: models.BaseUserManager.get_by_natural_key(username)\n+\n+        Retrieves a user instance using the contents of the field\n+        nominated by ``USERNAME_FIELD``.\n+\n+    .. method:: models.BaseUserManager.make_random_password(length=10, allowed_chars='abcdefghjkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789')\n+\n+        Returns a random password with the given length and given string of\n+        allowed characters. (Note that the default value of ``allowed_chars``\n+        doesn't contain letters that can cause user confusion, including:\n+\n+        * ``i``, ``l``, ``I``, and ``1`` (lowercase letter i, lowercase\n+          letter L, uppercase letter i, and the number one)\n+        * ``o``, ``O``, and ``0`` (uppercase letter o, lowercase letter o,\n+          and zero)\n+\n Extending Django's default User\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -2020,6 +2106,16 @@ control access of the User to admin content:\n     Returns True if the user has permission to access models in\n     the given app.\n \n+You will also need to register your custom User model with the admin. If\n+your custom User model extends :class:`~django.contrib.auth.models.AbstractUser`,\n+you can use Django's existing :class:`~django.contrib.auth.admin.UserAdmin`\n+class. However, if your User model extends\n+:class:`~django.contrib.auth.models.AbstractBaseUser`, you'll need to define\n+a custom ModelAdmin class. It may be possible to subclass the default\n+:class:`~django.contrib.auth.admin.UserAdmin`; however, you'll need to\n+override any of the definitions that refer to fields on\n+:class:`~django.contrib.auth.models.AbstractUser` that aren't on your\n+custom User class.\n \n Custom users and Proxy models\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n@@ -2036,11 +2132,11 @@ behavior into your User subclass.\n A full example\n --------------\n \n-Here is an example of a full models.py for an admin-compliant custom\n-user app. This user model uses an email address as the username, and has a\n-required date of birth; it provides no permission checking, beyond a simple\n-`admin` flag on the user account. This model would be compatible with all\n-the built-in auth forms and views, except for the User creation forms.\n+Here is an example of an admin-compliant custom user app. This user model uses\n+an email address as the username, and has a required date of birth; it\n+provides no permission checking, beyond a simple `admin` flag on the user\n+account. This model would be compatible with all the built-in auth forms and\n+views, except for the User creation forms.\n \n This code would all live in a ``models.py`` file for a custom\n authentication app::\n@@ -2086,7 +2182,9 @@ authentication app::\n     class MyUser(AbstractBaseUser):\n         email = models.EmailField(\n             verbose_name='email address',\n-            max_length=255\n+            max_length=255,\n+            unique=True,\n+            db_index=True,\n         )\n         date_of_birth = models.DateField()\n         is_active = models.BooleanField(default=True)\n@@ -2124,6 +2222,87 @@ authentication app::\n             # Simplest possible answer: All admins are staff\n             return self.is_admin\n \n+Then, to register this custom User model with Django's admin, the following\n+code would be required in ``admin.py``::\n+\n+    from django import forms\n+    from django.contrib import admin\n+    from django.contrib.auth.models import Group\n+    from django.contrib.auth.admin import UserAdmin\n+    from django.contrib.auth.forms import ReadOnlyPasswordHashField\n+\n+    from customauth.models import MyUser\n+\n+\n+    class UserCreationForm(forms.ModelForm):\n+        \"\"\"A form for creating new users. Includes all the required\n+        fields, plus a repeated password.\"\"\"\n+        password1 = forms.CharField(label='Password', widget=forms.PasswordInput)\n+        password2 = forms.CharField(label='Password confirmation', widget=forms.PasswordInput)\n+\n+        class Meta:\n+            model = MyUser\n+            fields = ('email', 'date_of_birth')\n+\n+        def clean_password2(self):\n+            # Check that the two password entries match\n+            password1 = self.cleaned_data.get(\"password1\")\n+            password2 = self.cleaned_data.get(\"password2\")\n+            if password1 and password2 and password1 != password2:\n+                raise forms.ValidationError('Passwords don't match')\n+            return password2\n+\n+        def save(self, commit=True):\n+            # Save the provided password in hashed format\n+            user = super(UserCreationForm, self).save(commit=False)\n+            user.set_password(self.cleaned_data[\"password1\"])\n+            if commit:\n+                user.save()\n+            return user\n+\n+\n+    class UserChangeForm(forms.ModelForm):\n+        \"\"\"A form for updateing users. Includes all the fields on\n+        the user, but replaces the password field with admin's\n+        pasword hash display field.\n+        \"\"\"\n+        password = ReadOnlyPasswordHashField()\n+\n+        class Meta:\n+            model = MyUser\n+\n+\n+    class MyUserAdmin(UserAdmin):\n+        # The forms to add and change user instances\n+        form = UserChangeForm\n+        add_form = UserCreationForm\n+\n+        # The fields to be used in displaying the User model.\n+        # These override the definitions on the base UserAdmin\n+        # that reference specific fields on auth.User.\n+        list_display = ('email', 'date_of_birth', 'is_admin')\n+        list_filter = ('is_admin',)\n+        fieldsets = (\n+            (None, {'fields': ('email', 'password')}),\n+            ('Personal info', {'fields': ('date_of_birth',)}),\n+            ('Permissions', {'fields': ('is_admin',)}),\n+            ('Important dates', {'fields': ('last_login',)}),\n+        )\n+        add_fieldsets = (\n+            (None, {\n+                'classes': ('wide',),\n+                'fields': ('email', 'date_of_birth', 'password1', 'password2')}\n+            ),\n+        )\n+        search_fields = ('email',)\n+        ordering = ('email',)\n+        filter_horizontal = ()\n+\n+    # Now register the new UserAdmin...\n+    admin.site.register(MyUser, MyUserAdmin)\n+    # ... and, since we're not using Django's builtin permissions,\n+    # unregister the Group model from admin.\n+    admin.site.unregister(Group)\n \n .. _authentication-backends:\n "
        }
    ],
    "stats": {
        "total": 327,
        "additions": 260,
        "deletions": 67
    }
}