{
    "author": "akaariai",
    "message": "Avoided storing ExpressionNodes in dicts",
    "sha": "ddd7d1af203d6d260c970d8ee8749fedbce6bba1",
    "files": [
        {
            "sha": "374509914d86be9cede9be69b278b4d475481d69",
            "filename": "django/db/models/sql/expressions.py",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/ddd7d1af203d6d260c970d8ee8749fedbce6bba1/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py",
            "raw_url": "https://github.com/django/django/raw/ddd7d1af203d6d260c970d8ee8749fedbce6bba1/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py?ref=ddd7d1af203d6d260c970d8ee8749fedbce6bba1",
            "patch": "@@ -6,7 +6,7 @@ class SQLEvaluator(object):\n     def __init__(self, expression, query, allow_joins=True):\n         self.expression = expression\n         self.opts = query.get_meta()\n-        self.cols = {}\n+        self.cols = []\n \n         self.contains_aggregate = False\n         self.expression.prepare(self, query, allow_joins)\n@@ -18,11 +18,15 @@ def as_sql(self, qn, connection):\n         return self.expression.evaluate(self, qn, connection)\n \n     def relabel_aliases(self, change_map):\n-        for node, col in self.cols.items():\n+        new_cols = []\n+        for node, col in self.cols:\n             if hasattr(col, \"relabel_aliases\"):\n                 col.relabel_aliases(change_map)\n+                new_cols.append((node, col))\n             else:\n-                self.cols[node] = (change_map.get(col[0], col[0]), col[1])\n+                new_cols.append((node,\n+                                (change_map.get(col[0], col[0]), col[1])))\n+        self.cols = new_cols\n \n     #####################################################\n     # Vistor methods for initial expression preparation #\n@@ -41,15 +45,15 @@ def prepare_leaf(self, node, query, allow_joins):\n         if (len(field_list) == 1 and\n             node.name in query.aggregate_select.keys()):\n             self.contains_aggregate = True\n-            self.cols[node] = query.aggregate_select[node.name]\n+            self.cols.append((node, query.aggregate_select[node.name]))\n         else:\n             try:\n                 field, source, opts, join_list, last, _ = query.setup_joins(\n                     field_list, query.get_meta(),\n                     query.get_initial_alias(), False)\n                 col, _, join_list = query.trim_joins(source, join_list, last, False)\n \n-                self.cols[node] = (join_list[-1], col)\n+                self.cols.append((node, (join_list[-1], col)))\n             except FieldDoesNotExist:\n                 raise FieldError(\"Cannot resolve keyword %r into field. \"\n                                  \"Choices are: %s\" % (self.name,\n@@ -80,7 +84,13 @@ def evaluate_node(self, node, qn, connection):\n         return connection.ops.combine_expression(node.connector, expressions), expression_params\n \n     def evaluate_leaf(self, node, qn, connection):\n-        col = self.cols[node]\n+        col = None\n+        for n, c in self.cols:\n+            if n is node:\n+                col = c\n+                break\n+        if col is None:\n+            raise ValueError(\"Given node not found\")\n         if hasattr(col, 'as_sql'):\n             return col.as_sql(qn, connection), ()\n         else:"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 16,
        "deletions": 6
    }
}