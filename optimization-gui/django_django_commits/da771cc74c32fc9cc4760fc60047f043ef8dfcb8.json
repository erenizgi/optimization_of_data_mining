{
    "author": "carljm",
    "message": "Fixed #14938 - Fixed save-as-new on inline formset with new forms.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15306 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "da771cc74c32fc9cc4760fc60047f043ef8dfcb8",
    "files": [
        {
            "sha": "f2b73340f642682c72d45899886de3096cf44fad",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/da771cc74c32fc9cc4760fc60047f043ef8dfcb8/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/da771cc74c32fc9cc4760fc60047f043ef8dfcb8/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=da771cc74c32fc9cc4760fc60047f043ef8dfcb8",
            "patch": "@@ -690,10 +690,6 @@ def initial_form_count(self):\n             return 0\n         return super(BaseInlineFormSet, self).initial_form_count()\n \n-    def total_form_count(self):\n-        if self.save_as_new:\n-            return super(BaseInlineFormSet, self).initial_form_count()\n-        return super(BaseInlineFormSet, self).total_form_count()\n \n     def _construct_form(self, i, **kwargs):\n         form = super(BaseInlineFormSet, self)._construct_form(i, **kwargs)"
        },
        {
            "sha": "937c78950478d02e54f9e835e5bc5892d26f1b45",
            "filename": "tests/regressiontests/model_formsets_regress/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/da771cc74c32fc9cc4760fc60047f043ef8dfcb8/tests%2Fregressiontests%2Fmodel_formsets_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/da771cc74c32fc9cc4760fc60047f043ef8dfcb8/tests%2Fregressiontests%2Fmodel_formsets_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_formsets_regress%2Fmodels.py?ref=da771cc74c32fc9cc4760fc60047f043ef8dfcb8",
            "patch": "@@ -17,3 +17,13 @@ class Restaurant(Place):\n class Manager(models.Model):\n     retaurant = models.ForeignKey(Restaurant)\n     name = models.CharField(max_length=50)\n+\n+class Network(models.Model):\n+    name = models.CharField(max_length=15)\n+\n+class Host(models.Model):\n+    network = models.ForeignKey(Network)\n+    hostname = models.CharField(max_length=25)\n+\n+    def __unicode__(self):\n+        return self.hostname"
        },
        {
            "sha": "308bccebf1874a5f1bc21646ab574256fa30911a",
            "filename": "tests/regressiontests/model_formsets_regress/tests.py",
            "status": "modified",
            "additions": 34,
            "deletions": 1,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/da771cc74c32fc9cc4760fc60047f043ef8dfcb8/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/da771cc74c32fc9cc4760fc60047f043ef8dfcb8/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_formsets_regress%2Ftests.py?ref=da771cc74c32fc9cc4760fc60047f043ef8dfcb8",
            "patch": "@@ -2,7 +2,7 @@\n from django.forms.models import modelform_factory, inlineformset_factory, modelformset_factory\n from django.test import TestCase\n \n-from models import User, UserSite, Restaurant, Manager\n+from models import User, UserSite, Restaurant, Manager, Network, Host\n \n \n class InlineFormsetTests(TestCase):\n@@ -167,6 +167,39 @@ def test_empty_fields_on_modelformset(self):\n             self.assertTrue('id' in form.fields)\n             self.assertEqual(len(form.fields), 1)\n \n+    def test_save_as_new_with_new_inlines(self):\n+        \"\"\"\n+        Existing and new inlines are saved with save_as_new.\n+\n+        Regression for #14938.\n+\n+        \"\"\"\n+        efnet = Network.objects.create(name=\"EFNet\")\n+        host1 = Host.objects.create(hostname=\"irc.he.net\", network=efnet)\n+\n+        HostFormSet = inlineformset_factory(Network, Host)\n+\n+        # Add a new host, modify previous host, and save-as-new\n+        data = {\n+            'host_set-TOTAL_FORMS': u'2',\n+            'host_set-INITIAL_FORMS': u'1',\n+            'host_set-MAX_NUM_FORMS': u'0',\n+            'host_set-0-id': unicode(host1.id),\n+            'host_set-0-hostname': u'tranquility.hub.dal.net',\n+            'host_set-1-hostname': u'matrix.de.eu.dal.net'\n+        }\n+\n+        # To save a formset as new, it needs a new hub instance\n+        dalnet = Network.objects.create(name=\"DALnet\")\n+        formset = HostFormSet(data, instance=dalnet, save_as_new=True)\n+\n+        self.assertTrue(formset.is_valid())\n+        formset.save()\n+        self.assertQuerysetEqual(\n+            dalnet.host_set.order_by(\"hostname\"),\n+            [\"<Host: matrix.de.eu.dal.net>\", \"<Host: tranquility.hub.dal.net>\"]\n+            )\n+\n \n class CustomWidget(forms.CharField):\n     pass"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 44,
        "deletions": 5
    }
}