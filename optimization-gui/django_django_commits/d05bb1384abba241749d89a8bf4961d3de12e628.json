{
    "author": "freakboy3742",
    "message": "Fixed #15545 -- Corrected the admin filterspecs tests to be non-dependent on PK allocation or model ordering. Thanks to ≈Åukasz Rekucki for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15741 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d05bb1384abba241749d89a8bf4961d3de12e628",
    "files": [
        {
            "sha": "698a4eb8ccbb29b8f5d90403f39424a24efb73d4",
            "filename": "tests/regressiontests/admin_filterspecs/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 21,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/d05bb1384abba241749d89a8bf4961d3de12e628/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d05bb1384abba241749d89a8bf4961d3de12e628/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py?ref=d05bb1384abba241749d89a8bf4961d3de12e628",
            "patch": "@@ -8,19 +8,22 @@\n \n from models import Book\n \n+def select_by(dictlist, key, value):\n+    return [x for x in dictlist if x[key] == value][0]\n+\n class FilterSpecsTests(TestCase):\n \n     def setUp(self):\n         # Users\n-        alfred = User.objects.create_user('alfred', 'alfred@example.com')\n-        bob = User.objects.create_user('bob', 'alfred@example.com')\n+        self.alfred = User.objects.create_user('alfred', 'alfred@example.com')\n+        self.bob = User.objects.create_user('bob', 'bob@example.com')\n         lisa = User.objects.create_user('lisa', 'lisa@example.com')\n \n         #Books\n-        bio_book = Book.objects.create(title='Django: a biography', year=1999, author=alfred)\n-        django_book = Book.objects.create(title='The Django Book', year=None, author=bob)\n+        self.bio_book = Book.objects.create(title='Django: a biography', year=1999, author=self.alfred)\n+        self.django_book = Book.objects.create(title='The Django Book', year=None, author=self.bob)\n         gipsy_book = Book.objects.create(title='Gipsy guitar for dummies', year=2002)\n-        gipsy_book.contributors = [bob, lisa]\n+        gipsy_book.contributors = [self.bob, lisa]\n         gipsy_book.save()\n \n         self.request_factory = RequestFactory()\n@@ -75,15 +78,16 @@ def test_RelatedFilterSpec_ForeignKey(self):\n         self.assertEqual(choices[-1]['selected'], True)\n         self.assertEqual(choices[-1]['query_string'], '?author__isnull=True')\n \n-        request = self.request_factory.get('/', {'author__id__exact': '1'})\n+        request = self.request_factory.get('/', {'author__id__exact': self.alfred.pk})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct choice is selected\n         filterspec = changelist.get_filters(request)[0][1]\n         self.assertEqual(force_unicode(filterspec.title()), u'author')\n-        choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[1]['selected'], True)\n-        self.assertEqual(choices[1]['query_string'], '?author__id__exact=1')\n+        # order of choices depends on User model, which has no order\n+        choice = select_by(filterspec.choices(changelist), \"display\", \"alfred\")\n+        self.assertEqual(choice['selected'], True)\n+        self.assertEqual(choice['query_string'], '?author__id__exact=%d' % self.alfred.pk)\n \n     def test_RelatedFilterSpec_ManyToMany(self):\n         modeladmin = BookAdmin(Book, admin.site)\n@@ -101,15 +105,15 @@ def test_RelatedFilterSpec_ManyToMany(self):\n         self.assertEqual(choices[-1]['selected'], True)\n         self.assertEqual(choices[-1]['query_string'], '?contributors__isnull=True')\n \n-        request = self.request_factory.get('/', {'contributors__id__exact': '2'})\n+        request = self.request_factory.get('/', {'contributors__id__exact': self.bob.pk})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct choice is selected\n         filterspec = changelist.get_filters(request)[0][2]\n         self.assertEqual(force_unicode(filterspec.title()), u'user')\n-        choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[2]['selected'], True)\n-        self.assertEqual(choices[2]['query_string'], '?contributors__id__exact=2')\n+        choice = select_by(filterspec.choices(changelist), \"display\", \"bob\")\n+        self.assertEqual(choice['selected'], True)\n+        self.assertEqual(choice['query_string'], '?contributors__id__exact=%d' % self.bob.pk)\n \n \n     def test_RelatedFilterSpec_reverse_relationships(self):\n@@ -129,15 +133,15 @@ def test_RelatedFilterSpec_reverse_relationships(self):\n         self.assertEqual(choices[-1]['selected'], True)\n         self.assertEqual(choices[-1]['query_string'], '?books_authored__isnull=True')\n \n-        request = self.request_factory.get('/', {'books_authored__id__exact': '1'})\n+        request = self.request_factory.get('/', {'books_authored__id__exact': self.bio_book.pk})\n         changelist = self.get_changelist(request, User, modeladmin)\n \n         # Make sure the correct choice is selected\n         filterspec = changelist.get_filters(request)[0][0]\n         self.assertEqual(force_unicode(filterspec.title()), u'book')\n-        choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[1]['selected'], True)\n-        self.assertEqual(choices[1]['query_string'], '?books_authored__id__exact=1')\n+        choice = select_by(filterspec.choices(changelist), \"display\", self.bio_book.title)\n+        self.assertEqual(choice['selected'], True)\n+        self.assertEqual(choice['query_string'], '?books_authored__id__exact=%d' % self.bio_book.pk)\n \n         # M2M relationship -----\n         request = self.request_factory.get('/', {'books_contributed__isnull': 'True'})\n@@ -153,15 +157,15 @@ def test_RelatedFilterSpec_reverse_relationships(self):\n         self.assertEqual(choices[-1]['selected'], True)\n         self.assertEqual(choices[-1]['query_string'], '?books_contributed__isnull=True')\n \n-        request = self.request_factory.get('/', {'books_contributed__id__exact': '2'})\n+        request = self.request_factory.get('/', {'books_contributed__id__exact': self.django_book.pk})\n         changelist = self.get_changelist(request, User, modeladmin)\n \n         # Make sure the correct choice is selected\n         filterspec = changelist.get_filters(request)[0][1]\n         self.assertEqual(force_unicode(filterspec.title()), u'book')\n-        choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[2]['selected'], True)\n-        self.assertEqual(choices[2]['query_string'], '?books_contributed__id__exact=2')\n+        choice = select_by(filterspec.choices(changelist), \"display\", self.django_book.title)\n+        self.assertEqual(choice['selected'], True)\n+        self.assertEqual(choice['query_string'], '?books_contributed__id__exact=%d' % self.django_book.pk)\n \n class CustomUserAdmin(UserAdmin):\n     list_filter = ('books_authored', 'books_contributed')"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 25,
        "deletions": 21
    }
}