{
    "author": "spookylukey",
    "message": "Fixed various bugs related to having multiple columns in admin list_display with the same sort field\n\nThanks to julien for the report\n\nRefs #11868\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16319 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "cb996cce059ec6f384d7ee9b67df6208c92eb719",
    "files": [
        {
            "sha": "fb7d24769ea4e716c382fc32e873626872886588",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 16,
            "deletions": 38,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/cb996cce059ec6f384d7ee9b67df6208c92eb719/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/cb996cce059ec6f384d7ee9b67df6208c92eb719/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=cb996cce059ec6f384d7ee9b67df6208c92eb719",
            "patch": "@@ -85,44 +85,28 @@ def result_headers(cl):\n     # We need to know the 'ordering field' that corresponds to each\n     # item in list_display, and we need other info, so do a pre-pass\n     # on list_display\n-    list_display_info = SortedDict()\n+    ordering_field_columns = cl.get_ordering_field_columns()\n     for i, field_name in enumerate(cl.list_display):\n         admin_order_field = None\n         text, attr = label_for_field(field_name, cl.model,\n             model_admin = cl.model_admin,\n             return_attr = True\n         )\n         if attr:\n-            admin_order_field = getattr(attr, \"admin_order_field\", None)\n-        if admin_order_field is None:\n-            ordering_field_name = field_name\n-        else:\n-            ordering_field_name = admin_order_field\n-        list_display_info[ordering_field_name] = dict(text=text,\n-                                                      attr=attr,\n-                                                      index=i,\n-                                                      admin_order_field=admin_order_field,\n-                                                      field_name=field_name)\n-\n-    del admin_order_field, text, attr\n-\n-    ordering_fields = cl.get_ordering_fields()\n-\n-    for ordering_field_name, info in list_display_info.items():\n-        if info['attr']:\n             # Potentially not sortable\n \n             # if the field is the action checkbox: no sorting and special class\n-            if info['field_name'] == 'action_checkbox':\n+            if field_name == 'action_checkbox':\n                 yield {\n-                    \"text\": info['text'],\n+                    \"text\": text,\n                     \"class_attrib\": mark_safe(' class=\"action-checkbox-column\"')\n                 }\n                 continue\n \n-            if not info['admin_order_field']:\n+            admin_order_field = getattr(attr, \"admin_order_field\", None)\n+            if not admin_order_field:\n                 # Not sortable\n-                yield {\"text\": info['text']}\n+                yield {\"text\": text}\n                 continue\n \n         # OK, it is sortable if we got this far\n@@ -131,37 +115,31 @@ def result_headers(cl):\n         new_order_type = 'asc'\n         sort_pos = 0\n         # Is it currently being sorted on?\n-        if ordering_field_name in ordering_fields:\n-            order_type = ordering_fields.get(ordering_field_name).lower()\n-            sort_pos = ordering_fields.keys().index(ordering_field_name) + 1\n+        if i in ordering_field_columns:\n+            order_type = ordering_field_columns.get(i).lower()\n+            sort_pos = ordering_field_columns.keys().index(i) + 1\n             th_classes.append('sorted %sending' % order_type)\n             new_order_type = {'asc': 'desc', 'desc': 'asc'}[order_type]\n \n         # build new ordering param\n         o_list = []\n         make_qs_param = lambda t, n: ('-' if t == 'desc' else '') + str(n)\n \n-        for f, ot in ordering_fields.items():\n-            try:\n-                colnum = list_display_info[f]['index']\n-            except KeyError:\n-                continue\n-\n-            if f == ordering_field_name:\n+        for j, ot in ordering_field_columns.items():\n+            if j == i: # Same column\n                 # We want clicking on this header to bring the ordering to the\n                 # front\n-                o_list.insert(0, make_qs_param(new_order_type, colnum))\n+                o_list.insert(0, make_qs_param(new_order_type, j))\n             else:\n-                o_list.append(make_qs_param(ot, colnum))\n+                o_list.append(make_qs_param(ot, j))\n \n-        if ordering_field_name not in ordering_fields:\n-            colnum = list_display_info[ordering_field_name]['index']\n-            o_list.insert(0, make_qs_param(new_order_type, colnum))\n+        if i not in ordering_field_columns:\n+            o_list.insert(0, make_qs_param(new_order_type, i))\n \n         o_list = '.'.join(o_list)\n \n         yield {\n-            \"text\": info['text'],\n+            \"text\": text,\n             \"sortable\": True,\n             \"ascending\": order_type == \"asc\",\n             \"sort_pos\": sort_pos,"
        },
        {
            "sha": "85b85626591f191917e768e6ea0f9294eef3039b",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 48,
            "deletions": 12,
            "changes": 60,
            "blob_url": "https://github.com/django/django/blob/cb996cce059ec6f384d7ee9b67df6208c92eb719/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/cb996cce059ec6f384d7ee9b67df6208c92eb719/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=cb996cce059ec6f384d7ee9b67df6208c92eb719",
            "patch": "@@ -164,16 +164,20 @@ def get_results(self, request):\n         self.multi_page = multi_page\n         self.paginator = paginator\n \n+    def _get_default_ordering(self):\n+        ordering = []\n+        if self.model_admin.ordering:\n+            ordering = self.model_admin.ordering\n+        elif self.lookup_opts.ordering:\n+            ordering = self.lookup_opts.ordering\n+        return ordering\n+\n     def get_ordering(self):\n-        lookup_opts, params = self.lookup_opts, self.params\n+        params = self.params\n         # For ordering, first check the \"ordering\" parameter in the admin\n         # options, then check the object's default ordering. Finally, a\n         # manually-specified ordering from the query string overrides anything.\n-        ordering = []\n-        if self.model_admin.ordering:\n-            ordering = self.model_admin.ordering\n-        elif lookup_opts.ordering:\n-            ordering = lookup_opts.ordering\n+        ordering = self._get_default_ordering()\n \n         if ORDER_VAR in params:\n             # Clear ordering and used params\n@@ -184,7 +188,7 @@ def get_ordering(self):\n                     none, pfx, idx = p.rpartition('-')\n                     field_name = self.list_display[int(idx)]\n                     try:\n-                        f = lookup_opts.get_field(field_name)\n+                        f = self.lookup_opts.get_field(field_name)\n                     except models.FieldDoesNotExist:\n                         # See whether field_name is a name of a non-field\n                         # that allows sorting.\n@@ -208,12 +212,44 @@ def get_ordering(self):\n \n         return ordering\n \n-    def get_ordering_fields(self):\n-        # Returns a SortedDict of ordering fields and asc/desc\n+    def get_ordering_field_columns(self):\n+        # Returns a SortedDict of ordering field column numbers and asc/desc\n+\n+        # We must cope with more than one column having the same underlying sort\n+        # field, so we base things on column numbers.\n+        ordering = self._get_default_ordering()\n         ordering_fields = SortedDict()\n-        for o in self.ordering:\n-            none, t, f = o.rpartition('-')\n-            ordering_fields[f] = 'desc' if t == '-' else 'asc'\n+        if ORDER_VAR not in self.params:\n+            # for ordering specified on ModelAdmin or model Meta, we don't know\n+            # the right column numbers absolutely, because there might be more\n+            # than one column associated with that ordering, so we guess.\n+            for f in ordering:\n+                if f.startswith('-'):\n+                    f = f[1:]\n+                    order_type = 'desc'\n+                else:\n+                    order_type = 'asc'\n+                i = None\n+                try:\n+                    # Search for simply field name first\n+                    i = self.list_display.index(f)\n+                except ValueError:\n+                    # No match, but their might be a match if we take into account\n+                    # 'admin_order_field'\n+                    for j, attr in enumerate(self.list_display):\n+                        if getattr(attr, 'admin_order_field', '') == f:\n+                            i = j\n+                            break\n+                if i is not None:\n+                    ordering_fields[i] = order_type\n+        else:\n+            for p in self.params[ORDER_VAR].split('.'):\n+                none, pfx, idx = p.rpartition('-')\n+                try:\n+                    idx = int(idx)\n+                except ValueError:\n+                    continue # skip it\n+                ordering_fields[idx] = 'desc' if pfx == '-' else 'asc'\n         return ordering_fields\n \n     def get_lookup_params(self, use_distinct=False):"
        },
        {
            "sha": "52d96a93f6440efb960ee87609aff83ab4f2395e",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/cb996cce059ec6f384d7ee9b67df6208c92eb719/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/cb996cce059ec6f384d7ee9b67df6208c92eb719/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=cb996cce059ec6f384d7ee9b67df6208c92eb719",
            "patch": "@@ -811,6 +811,20 @@ class OtherStoryAdmin(admin.ModelAdmin):\n     list_editable = ('content', )\n     ordering = [\"-pk\"]\n \n+class ComplexSortedPerson(models.Model):\n+    name = models.CharField(max_length=100)\n+    age = models.PositiveIntegerField()\n+    is_employee = models.NullBooleanField()\n+\n+class ComplexSortedPersonAdmin(admin.ModelAdmin):\n+    list_display = ('name', 'age', 'is_employee', 'colored_name')\n+    ordering = ('name',)\n+\n+    def colored_name(self, obj):\n+        return '<span style=\"color: #%s;\">%s</span>' % ('ff00ff', obj.name)\n+    colored_name.allow_tags = True\n+    colored_name.admin_order_field = 'name'\n+\n admin.site.register(Article, ArticleAdmin)\n admin.site.register(CustomArticle, CustomArticleAdmin)\n admin.site.register(Section, save_as=True, inlines=[ArticleInline])\n@@ -872,3 +886,4 @@ class OtherStoryAdmin(admin.ModelAdmin):\n admin.site.register(Question)\n admin.site.register(Answer)\n admin.site.register(PrePopulatedPost, PrePopulatedPostAdmin)\n+admin.site.register(ComplexSortedPerson, ComplexSortedPersonAdmin)"
        },
        {
            "sha": "25056b5e04aea6a08bc30037f2d6b8af0070563f",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 38,
            "deletions": 1,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/cb996cce059ec6f384d7ee9b67df6208c92eb719/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cb996cce059ec6f384d7ee9b67df6208c92eb719/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=cb996cce059ec6f384d7ee9b67df6208c92eb719",
            "patch": "@@ -37,7 +37,8 @@\n     Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit,\n     Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee,\n     Question, Answer, Inquisition, Actor, FoodDelivery,\n-    RowLevelChangePermissionModel, Paper, CoverLetter, Story, OtherStory)\n+    RowLevelChangePermissionModel, Paper, CoverLetter, Story, OtherStory,\n+    ComplexSortedPerson)\n \n \n class AdminViewBasicTest(TestCase):\n@@ -313,6 +314,42 @@ def testChangeListSortingModelAdmin(self):\n             response.content.index(link % p1.pk) < response.content.index(link % p2.pk)\n         )\n \n+    def testMultipleSortSameField(self):\n+        # Check that we get the columns we expect if we have two columns\n+        # that correspond to the same ordering field\n+        dt = datetime.datetime.now()\n+        p1 = Podcast.objects.create(name=\"A\", release_date=dt)\n+        p2 = Podcast.objects.create(name=\"B\", release_date=dt - datetime.timedelta(10))\n+\n+        link = '<a href=\"%s/'\n+        response = self.client.get('/test_admin/admin/admin_views/podcast/', {})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % p1.pk) < response.content.index(link % p2.pk)\n+        )\n+\n+        p1 = ComplexSortedPerson.objects.create(name=\"Bob\", age=10)\n+        p2 = ComplexSortedPerson.objects.create(name=\"Amy\", age=20)\n+        link = '<a href=\"%s/'\n+\n+        response = self.client.get('/test_admin/admin/admin_views/complexsortedperson/', {})\n+        self.assertEqual(response.status_code, 200)\n+        # Should have 5 columns (including action checkbox col)\n+        self.assertContains(response, '<th scope=\"col\"', count=5)\n+\n+        self.assertContains(response, 'Name')\n+        self.assertContains(response, 'Colored name')\n+\n+        # Check order\n+        self.assertTrue(\n+            response.content.index('Name') < response.content.index('Colored name')\n+        )\n+\n+        # Check sorting - should be by name\n+        self.assertTrue(\n+            response.content.index(link % p2.id) < response.content.index(link % p1.id)\n+        )\n+\n     def testLimitedFilter(self):\n         \"\"\"Ensure admin changelist filters do not contain objects excluded via limit_choices_to.\n         This also tests relation-spanning filters (e.g. 'color__value')."
        }
    ],
    "stats": {
        "total": 168,
        "additions": 117,
        "deletions": 51
    }
}