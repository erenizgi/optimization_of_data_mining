{
    "author": "jbronn",
    "message": "Fixed #15277 -- Cleaned up `ogrinspect` command, added tests and extended support beyond file-based OGR data sources.  Thanks, willinoed for bug report and jpaulett for initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16845 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3ac877840a42144174e7ffde1721c9ed40a13b22",
    "files": [
        {
            "sha": "c998063af8a7d03d900e712f16d3b2a15529ea2a",
            "filename": "django/contrib/gis/management/base.py",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/f97a574196102ef2479da4e519d7cffc7a5fdf6c/django%2Fcontrib%2Fgis%2Fmanagement%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f97a574196102ef2479da4e519d7cffc7a5fdf6c/django%2Fcontrib%2Fgis%2Fmanagement%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fmanagement%2Fbase.py?ref=f97a574196102ef2479da4e519d7cffc7a5fdf6c",
            "patch": "@@ -1,15 +0,0 @@\n-from django.core.management.base import BaseCommand, CommandError\n-\n-class ArgsCommand(BaseCommand):\n-    \"\"\"\n-    Command class for commands that take multiple arguments.\n-    \"\"\"\n-    args = '<arg arg ...>'\n-\n-    def handle(self, *args, **options):\n-        if not args:\n-            raise CommandError('Must provide the following arguments: %s' % self.args)\n-        return self.handle_args(*args, **options)\n-\n-    def handle_args(self, *args, **options):\n-        raise NotImplementedError()"
        },
        {
            "sha": "fbc6f53c0c623fdcaf8be3501881dc488d0d162b",
            "filename": "django/contrib/gis/management/commands/ogrinspect.py",
            "status": "modified",
            "additions": 14,
            "deletions": 17,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Fmanagement%2Fcommands%2Fogrinspect.py",
            "raw_url": "https://github.com/django/django/raw/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Fmanagement%2Fcommands%2Fogrinspect.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fmanagement%2Fcommands%2Fogrinspect.py?ref=3ac877840a42144174e7ffde1721c9ed40a13b22",
            "patch": "@@ -1,7 +1,7 @@\n import os\n from optparse import make_option\n from django.contrib.gis import gdal\n-from django.contrib.gis.management.base import ArgsCommand, CommandError\n+from django.core.management.base import LabelCommand, CommandError\n \n def layer_option(option, opt, value, parser):\n     \"\"\"\n@@ -17,36 +17,36 @@ def layer_option(option, opt, value, parser):\n def list_option(option, opt, value, parser):\n     \"\"\"\n     Callback for `make_option` for `ogrinspect` keywords that require\n-    a string list.  If the string is 'True'/'true' then the option \n+    a string list.  If the string is 'True'/'true' then the option\n     value will be a boolean instead.\n     \"\"\"\n     if value.lower() == 'true':\n         dest = True\n     else:\n         dest = [s for s in value.split(',')]\n     setattr(parser.values, option.dest, dest)\n-    \n-class Command(ArgsCommand):\n+\n+class Command(LabelCommand):\n     help = ('Inspects the given OGR-compatible data source (e.g., a shapefile) and outputs\\n'\n             'a GeoDjango model with the given model name. For example:\\n'\n             ' ./manage.py ogrinspect zipcode.shp Zipcode')\n     args = '[data_source] [model_name]'\n \n-    option_list = ArgsCommand.option_list + (\n-        make_option('--blank', dest='blank', type='string', action='callback',  \n+    option_list = LabelCommand.option_list + (\n+        make_option('--blank', dest='blank', type='string', action='callback',\n                     callback=list_option, default=False,\n                     help='Use a comma separated list of OGR field names to add '\n                     'the `blank=True` option to the field definition.  Set with'\n                     '`true` to apply to all applicable fields.'),\n-        make_option('--decimal', dest='decimal', type='string', action='callback', \n+        make_option('--decimal', dest='decimal', type='string', action='callback',\n                     callback=list_option, default=False,\n                     help='Use a comma separated list of OGR float fields to '\n                     'generate `DecimalField` instead of the default '\n                     '`FloatField`. Set to `true` to apply to all OGR float fields.'),\n         make_option('--geom-name', dest='geom_name', type='string', default='geom',\n                     help='Specifies the model name for the Geometry Field '\n                     '(defaults to `geom`)'),\n-        make_option('--layer', dest='layer_key', type='string', action='callback', \n+        make_option('--layer', dest='layer_key', type='string', action='callback',\n                     callback=layer_option, default=0,\n                     help='The key for specifying which layer in the OGR data '\n                     'source to use. Defaults to 0 (the first layer). May be '\n@@ -58,7 +58,7 @@ class Command(ArgsCommand):\n         make_option('--no-imports', action='store_false', dest='imports', default=True,\n                     help='Do not include `from django.contrib.gis.db import models` '\n                     'statement.'),\n-        make_option('--null', dest='null', type='string', action='callback',  \n+        make_option('--null', dest='null', type='string', action='callback',\n                     callback=list_option, default=False,\n                     help='Use a comma separated list of OGR field names to add '\n                     'the `null=True` option to the field definition.  Set with'\n@@ -72,7 +72,7 @@ class Command(ArgsCommand):\n \n     requires_model_validation = False\n \n-    def handle_args(self, *args, **options):\n+    def handle(self, *args, **options):\n         try:\n             data_source, model_name = args\n         except ValueError:\n@@ -81,10 +81,6 @@ def handle_args(self, *args, **options):\n         if not gdal.HAS_GDAL:\n             raise CommandError('GDAL is required to inspect geospatial data sources.')\n \n-        # TODO: Support non file-based OGR datasources.\n-        if not os.path.isfile(data_source):\n-            raise CommandError('The given data source cannot be found: \"%s\"' % data_source)\n-        \n         # Removing options with `None` values.\n         options = dict([(k, v) for k, v in options.items() if not v is None])\n \n@@ -97,8 +93,9 @@ def handle_args(self, *args, **options):\n         # Whether the user wants to generate the LayerMapping dictionary as well.\n         show_mapping = options.pop('mapping', False)\n \n-        # Popping the verbosity global option, as it's not accepted by `_ogrinspect`.\n+        # Getting rid of settings that `_ogrinspect` doesn't like.\n         verbosity = options.pop('verbosity', False)\n+        settings = options.pop('settings', False)\n \n         # Returning the output of ogrinspect with the given arguments\n         # and options.\n@@ -115,8 +112,8 @@ def handle_args(self, *args, **options):\n             # This extra legwork is so that the dictionary definition comes\n             # out in the same order as the fields in the model definition.\n             rev_mapping = dict([(v, k) for k, v in mapping_dict.items()])\n-            output.extend(['', '# Auto-generated `LayerMapping` dictionary for %s model' % model_name, \n+            output.extend(['', '# Auto-generated `LayerMapping` dictionary for %s model' % model_name,\n                            '%s_mapping = {' % model_name.lower()])\n             output.extend([\"    '%s' : '%s',\" % (rev_mapping[ogr_fld], ogr_fld) for ogr_fld in ds[options['layer_key']].fields])\n             output.extend([\"    '%s' : '%s',\" % (options['geom_name'], mapping_dict[options['geom_name']]), '}'])\n-        return '\\n'.join(output)\n+        return '\\n'.join(output) + '\\n'"
        },
        {
            "sha": "535909ff0d75c7e6e1484e2ddf12278bb4e26b7f",
            "filename": "django/contrib/gis/tests/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2F__init__.py?ref=3ac877840a42144174e7ffde1721c9ed40a13b22",
            "patch": "@@ -29,15 +29,13 @@ def geo_apps(namespace=True, runtests=False):\n \n     # The following GeoDjango test apps depend on GDAL support.\n     if HAS_GDAL:\n-        # Geographic admin requires GDAL\n-        apps.append('geoadmin')\n+        # Geographic admin, LayerMapping, and ogrinspect test apps\n+        # all require GDAL.\n+        apps.extend(['geoadmin', 'layermap', 'inspectapp'])\n \n-        # 3D apps use LayerMapping, which uses GDAL.\n+        # 3D apps use LayerMapping, which uses GDAL and require GEOS 3.1+.\n         if connection.ops.postgis and GEOS_PREPARE:\n             apps.append('geo3d')\n-\n-        apps.append('layermap')\n-\n     if runtests:\n         return [('django.contrib.gis.tests', app) for app in apps]\n     elif namespace:"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "django/contrib/gis/tests/inspectapp/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2F__init__.py?ref=3ac877840a42144174e7ffde1721c9ed40a13b22"
        },
        {
            "sha": "0f1b0d4e61b0254983bd176fbf4a6d646c7ae7f7",
            "filename": "django/contrib/gis/tests/inspectapp/models.py",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2Fmodels.py?ref=3ac877840a42144174e7ffde1721c9ed40a13b22",
            "patch": "@@ -0,0 +1,13 @@\n+from django.contrib.gis.db import models\n+\n+class AllOGRFields(models.Model):\n+    f_decimal = models.FloatField()\n+    f_float = models.FloatField()\n+    f_int = models.IntegerField()\n+    f_char = models.CharField(max_length=10)\n+    f_date = models.DateField()\n+    f_datetime = models.DateTimeField()\n+    f_time = models.TimeField()\n+    geom = models.PolygonField()\n+\n+    objects = models.GeoManager()"
        },
        {
            "sha": "1ca37263516fea5c73864ce01632ef4b3a3be1bc",
            "filename": "django/contrib/gis/tests/inspectapp/tests.py",
            "status": "added",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/django/django/blob/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Finspectapp%2Ftests.py?ref=3ac877840a42144174e7ffde1721c9ed40a13b22",
            "patch": "@@ -0,0 +1,122 @@\n+import os\n+from django.db import connections\n+from django.test import TestCase\n+from django.contrib.gis.gdal import Driver\n+from django.contrib.gis.geometry.test_data import TEST_DATA\n+from django.contrib.gis.utils.ogrinspect import ogrinspect\n+from models import AllOGRFields\n+\n+\n+class OGRInspectTest(TestCase):\n+    def test_poly(self):\n+        shp_file = os.path.join(TEST_DATA, 'test_poly', 'test_poly.shp')\n+        model_def = ogrinspect(shp_file, 'MyModel')\n+\n+        expected = [\n+            '# This is an auto-generated Django model module created by ogrinspect.',\n+            'from django.contrib.gis.db import models',\n+            '',\n+            'class MyModel(models.Model):',\n+            '    float = models.FloatField()',\n+            '    int = models.FloatField()',\n+            '    str = models.CharField(max_length=80)',\n+            '    geom = models.PolygonField(srid=-1)',\n+            '    objects = models.GeoManager()',\n+        ]\n+\n+        self.assertEqual(model_def, '\\n'.join(expected))\n+\n+    def test_date_field(self):\n+        shp_file = os.path.join(TEST_DATA, 'cities', 'cities.shp')\n+        model_def = ogrinspect(shp_file, 'City')\n+\n+        expected = [\n+            '# This is an auto-generated Django model module created by ogrinspect.',\n+            'from django.contrib.gis.db import models',\n+            '',\n+            'class City(models.Model):',\n+            '    name = models.CharField(max_length=80)',\n+            '    population = models.FloatField()',\n+            '    density = models.FloatField()',\n+            '    created = models.DateField()',\n+            '    geom = models.PointField(srid=-1)',\n+            '    objects = models.GeoManager()',\n+        ]\n+\n+        self.assertEqual(model_def, '\\n'.join(expected))\n+\n+    def test_time_field(self):\n+        # Only possible to test this on PostGIS at the momemnt.  MySQL\n+        # complains about permissions, and SpatiaLite/Oracle are\n+        # insanely difficult to get support compiled in for in GDAL.\n+        if not connections['default'].ops.postgis:\n+            return\n+\n+        # Getting the database identifier used by OGR, if None returned\n+        # GDAL does not have the support compiled in.\n+        ogr_db = get_ogr_db_string()\n+        if not ogr_db:\n+            return\n+\n+        # writing shapefules via GDAL currently does not support writing OGRTime\n+        # fields, so we need to actually use a database\n+        model_def = ogrinspect(ogr_db, 'Measurement',\n+                               layer_key=AllOGRFields._meta.db_table,\n+                               decimal=['f_decimal'])\n+\n+        expected = [\n+            '# This is an auto-generated Django model module created by ogrinspect.',\n+            'from django.contrib.gis.db import models',\n+            '',\n+            'class Measurement(models.Model):',\n+            '    f_decimal = models.DecimalField(max_digits=0, decimal_places=0)',\n+            '    f_int = models.IntegerField()',\n+            '    f_datetime = models.DateTimeField()',\n+            '    f_time = models.TimeField()',\n+            '    f_float = models.FloatField()',\n+            '    f_char = models.CharField(max_length=10)',\n+            '    f_date = models.DateField()',\n+            '    geom = models.PolygonField()',\n+            '    objects = models.GeoManager()',\n+        ]\n+\n+        self.assertEqual(model_def, '\\n'.join(expected))\n+\n+def get_ogr_db_string():\n+    # Construct the DB string that GDAL will use to inspect the database.\n+    # GDAL will create its own connection to the database, so we re-use the\n+    # connection settings from the Django test.  This approach is a bit fragile\n+    # and cannot work on any other database other than PostgreSQL at the moment.\n+    db = connections.databases['default']\n+\n+    # Map from the django backend into the OGR driver name and database identifier\n+    # http://www.gdal.org/ogr/ogr_formats.html\n+    #\n+    # TODO: Support Oracle (OCI), MySQL, and SpatiaLite.\n+    drivers = {\n+        'django.contrib.gis.db.backends.postgis': ('PostgreSQL', 'PG'),\n+    }\n+\n+    drv_name, db_str = drivers[db['ENGINE']]\n+\n+    # Ensure that GDAL library has driver support for the database.\n+    try:\n+        Driver(drv_name)\n+    except:\n+        return None\n+\n+    # Build the params of the OGR database connection string\n+    # TODO: connection strings are database-dependent, thus if\n+    #       we ever test other backends, this will need to change.\n+    params = [\"dbname='%s'\" % db['NAME']]\n+    def add(key, template):\n+        value = db.get(key, None)\n+        # Don't add the parameter if it is not in django's settings\n+        if value:\n+            params.append(template % value)\n+    add('HOST', \"host='%s'\")\n+    add('PORT', \"port='%s'\")\n+    add('USER', \"user='%s'\")\n+    add('PASSWORD', \"password='%s'\")\n+\n+    return '%s:%s' % (db_str, ' '.join(params))"
        },
        {
            "sha": "aa4e2098776aff948b19df88f9099c4c6d10a305",
            "filename": "django/contrib/gis/utils/ogrinspect.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Futils%2Fogrinspect.py",
            "raw_url": "https://github.com/django/django/raw/3ac877840a42144174e7ffde1721c9ed40a13b22/django%2Fcontrib%2Fgis%2Futils%2Fogrinspect.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Futils%2Fogrinspect.py?ref=3ac877840a42144174e7ffde1721c9ed40a13b22",
            "patch": "@@ -8,7 +8,7 @@\n from itertools import izip\n # Requires GDAL to use.\n from django.contrib.gis.gdal import DataSource\n-from django.contrib.gis.gdal.field import OFTDate, OFTDateTime, OFTInteger, OFTReal, OFTString\n+from django.contrib.gis.gdal.field import OFTDate, OFTDateTime, OFTInteger, OFTReal, OFTString, OFTTime\n \n def mapping(data_source, geom_name='geom', layer_key=0, multi_geom=False):\n     \"\"\"\n@@ -189,7 +189,7 @@ def get_kwargs_str(field_name):\n             yield '    %s = models.DateField(%s)' % (mfield, kwargs_str[2:])\n         elif field_type is OFTDateTime:\n             yield '    %s = models.DateTimeField(%s)' % (mfield, kwargs_str[2:])\n-        elif field_type is OFTDate:\n+        elif field_type is OFTTime:\n             yield '    %s = models.TimeField(%s)' % (mfield, kwargs_str[2:])\n         else:\n             raise TypeError('Unknown field type %s in %s' % (field_type, mfield))"
        }
    ],
    "stats": {
        "total": 195,
        "additions": 155,
        "deletions": 40
    }
}