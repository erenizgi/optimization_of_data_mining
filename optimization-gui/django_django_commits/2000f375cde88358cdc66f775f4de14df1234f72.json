{
    "author": "aaugustin",
    "message": "Fixed #17675 -- Changed the implementation of the {% regroup %} template tag to use the context properly when resolving expressions.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17522 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2000f375cde88358cdc66f775f4de14df1234f72",
    "files": [
        {
            "sha": "954c5d6d1917cf920f3530ab8be12fd59ae7bb55",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/2000f375cde88358cdc66f775f4de14df1234f72/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/2000f375cde88358cdc66f775f4de14df1234f72/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=2000f375cde88358cdc66f775f4de14df1234f72",
            "patch": "@@ -10,7 +10,7 @@\n     TemplateSyntaxError, VariableDoesNotExist, InvalidTemplateLibrary,\n     BLOCK_TAG_START, BLOCK_TAG_END, VARIABLE_TAG_START, VARIABLE_TAG_END,\n     SINGLE_BRACE_START, SINGLE_BRACE_END, COMMENT_TAG_START, COMMENT_TAG_END,\n-    get_library, token_kwargs, kwarg_re)\n+    VARIABLE_ATTRIBUTE_SEPARATOR, get_library, token_kwargs, kwarg_re)\n from django.template.smartif import IfParser, Literal\n from django.template.defaultfilters import date\n from django.utils.encoding import smart_str, smart_unicode\n@@ -287,6 +287,12 @@ def __init__(self, target, expression, var_name):\n         self.target, self.expression = target, expression\n         self.var_name = var_name\n \n+    def resolve_expression(self, obj, context):\n+        # This method is called for each object in self.target. See regroup()\n+        # for the reason why we temporarily put the object in the context.\n+        context[self.var_name] = obj\n+        return self.expression.resolve(context, True)\n+\n     def render(self, context):\n         obj_list = self.target.resolve(context, True)\n         if obj_list == None:\n@@ -298,7 +304,7 @@ def render(self, context):\n         context[self.var_name] = [\n             {'grouper': key, 'list': list(val)}\n             for key, val in\n-            groupby(obj_list, lambda v, f=self.expression.resolve: f(v, True))\n+            groupby(obj_list, lambda obj: self.resolve_expression(obj, context))\n         ]\n         return ''\n \n@@ -1112,10 +1118,16 @@ def regroup(parser, token):\n     if lastbits_reversed[1][::-1] != 'as':\n         raise TemplateSyntaxError(\"next-to-last argument to 'regroup' tag must\"\n                                   \" be 'as'\")\n-\n-    expression = parser.compile_filter(lastbits_reversed[2][::-1])\n-\n     var_name = lastbits_reversed[0][::-1]\n+    # RegroupNode will take each item in 'target', put it in the context under\n+    # 'var_name', evaluate 'var_name'.'expression' in the current context, and\n+    # group by the resulting value. After all items are processed, it will\n+    # save the final result in the context under 'var_name', thus clearing the\n+    # temporary values. This hack is necessary because the template engine\n+    # doesn't provide a context-aware equivalent of Python's getattr.\n+    expression = parser.compile_filter(var_name +\n+                                       VARIABLE_ATTRIBUTE_SEPARATOR +\n+                                       lastbits_reversed[2][::-1])\n     return RegroupNode(target, expression, var_name)\n \n @register.tag"
        },
        {
            "sha": "631c58c3a3dde379f82aba8dd147b8df0df56695",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/2000f375cde88358cdc66f775f4de14df1234f72/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2000f375cde88358cdc66f775f4de14df1234f72/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=2000f375cde88358cdc66f775f4de14df1234f72",
            "patch": "@@ -8,7 +8,7 @@\n     # before importing 'template'.\n     settings.configure()\n \n-from datetime import datetime, timedelta\n+from datetime import date, datetime, timedelta\n import time\n import os\n import sys\n@@ -1376,6 +1376,33 @@ def get_template_tests(self):\n                           '{% endfor %},'\n                           '{% endfor %}',\n                           {}, ''),\n+\n+            # Regression tests for #17675\n+            # The date template filter has expects_localtime = True\n+            'regroup03': ('{% regroup data by at|date:\"m\" as grouped %}'\n+                          '{% for group in grouped %}'\n+                          '{{ group.grouper }}:'\n+                          '{% for item in group.list %}'\n+                          '{{ item.at|date:\"d\" }}'\n+                          '{% endfor %},'\n+                          '{% endfor %}',\n+                          {'data': [{'at': date(2012, 2, 14)},\n+                                    {'at': date(2012, 2, 28)},\n+                                    {'at': date(2012, 7, 4)}]},\n+                          '02:1428,07:04,'),\n+            # The join template filter has needs_autoescape = True\n+            'regroup04': ('{% regroup data by bar|join:\"\" as grouped %}'\n+                          '{% for group in grouped %}'\n+                          '{{ group.grouper }}:'\n+                          '{% for item in group.list %}'\n+                          '{{ item.foo|first }}'\n+                          '{% endfor %},'\n+                          '{% endfor %}',\n+                          {'data': [{'foo': 'x', 'bar': ['ab', 'c']},\n+                                    {'foo': 'y', 'bar': ['a', 'bc']},\n+                                    {'foo': 'z', 'bar': ['a', 'd']}]},\n+                          'abc:xy,ad:z,'),\n+\n             ### SSI TAG ########################################################\n \n             # Test normal behavior"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 45,
        "deletions": 6
    }
}