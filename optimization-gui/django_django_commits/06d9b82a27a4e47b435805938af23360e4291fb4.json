{
    "author": "aaugustin",
    "message": "Fixed #16906 -- Format datetimes with str/unicode instead of strftime where possible: it's faster and it works for all dates.\n\nAlso ensured that datetime_safe is used wherever strftime is called on dates/datetimes that may be before 1900.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16978 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "06d9b82a27a4e47b435805938af23360e4291fb4",
    "files": [
        {
            "sha": "261ba7a02a275d129d1b54f2c778d2d506f91711",
            "filename": "django/contrib/admin/filters.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilters.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -281,9 +281,9 @@ def __init__(self, field, request, params, model, model_admin, field_path):\n \n         today = datetime.date.today()\n         one_week_ago = today - datetime.timedelta(days=7)\n-        today_str = (isinstance(self.field, models.DateTimeField)\n-                        and today.strftime('%Y-%m-%d 23:59:59')\n-                        or today.strftime('%Y-%m-%d'))\n+        today_str = str(today)\n+        if isinstance(self.field, models.DateTimeField):\n+            today_str += ' 23:59:59'\n \n         self.lookup_kwarg_year = '%s__year' % self.field_path\n         self.lookup_kwarg_month = '%s__month' % self.field_path\n@@ -299,7 +299,7 @@ def __init__(self, field, request, params, model, model_admin, field_path):\n                 self.lookup_kwarg_day: str(today.day),\n             }),\n             (_('Past 7 days'), {\n-                self.lookup_kwarg_past_7_days_gte: one_week_ago.strftime('%Y-%m-%d'),\n+                self.lookup_kwarg_past_7_days_gte: str(one_week_ago),\n                 self.lookup_kwarg_past_7_days_lte: today_str,\n             }),\n             (_('This month'), {"
        },
        {
            "sha": "a75ef61e51efef62a121b42ed403378bd49adc0c",
            "filename": "django/contrib/auth/tokens.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fcontrib%2Fauth%2Ftokens.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fcontrib%2Fauth%2Ftokens.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftokens.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -52,14 +52,13 @@ def _make_token_with_timestamp(self, user, timestamp):\n         # invalid as soon as it is used.\n         # We limit the hash to 20 chars to keep URL short\n         key_salt = \"django.contrib.auth.tokens.PasswordResetTokenGenerator\"\n-        value = unicode(user.id) + \\\n-            user.password + user.last_login.strftime('%Y-%m-%d %H:%M:%S') + \\\n-            unicode(timestamp)\n+        value = (unicode(user.id) + user.password +\n+                unicode(user.last_login) + unicode(timestamp))\n         hash = salted_hmac(key_salt, value).hexdigest()[::2]\n         return \"%s-%s\" % (ts_b36, hash)\n \n     def _num_days(self, dt):\n-        return (dt - date(2001,1,1)).days\n+        return (dt - date(2001, 1, 1)).days\n \n     def _today(self):\n         # Used for mocking in tests"
        },
        {
            "sha": "775e0d9736283add7dece89a1d3bb36426b83544",
            "filename": "django/contrib/sitemaps/tests/basic.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -67,7 +67,7 @@ def test_simple_sitemap(self):\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n <url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n </urlset>\n-\"\"\" % (self.base_url, date.today().strftime('%Y-%m-%d')))\n+\"\"\" % (self.base_url, date.today()))\n \n     def test_simple_custom_sitemap(self):\n         \"A simple sitemap can be rendered with a custom template\"\n@@ -79,7 +79,7 @@ def test_simple_custom_sitemap(self):\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n <url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n </urlset>\n-\"\"\" % (self.base_url, date.today().strftime('%Y-%m-%d')))\n+\"\"\" % (self.base_url, date.today()))\n \n     @skipUnless(settings.USE_I18N, \"Internationalization is not enabled\")\n     def test_localized_priority(self):\n@@ -93,7 +93,7 @@ def test_localized_priority(self):\n         # haven't been rendered in localized format\n         response = self.client.get('/simple/sitemap.xml')\n         self.assertContains(response, '<priority>0.5</priority>')\n-        self.assertContains(response, '<lastmod>%s</lastmod>' % date.today().strftime('%Y-%m-%d'))\n+        self.assertContains(response, '<lastmod>%s</lastmod>' % date.today())\n         deactivate()\n \n     def test_generic_sitemap(self):\n@@ -152,7 +152,7 @@ def test_requestsite_sitemap(self):\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n <url><loc>http://testserver/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n </urlset>\n-\"\"\" % date.today().strftime('%Y-%m-%d'))\n+\"\"\" % date.today())\n \n     @skipUnless(\"django.contrib.sites\" in settings.INSTALLED_APPS, \"django.contrib.sites app not installed.\")\n     def test_sitemap_get_urls_no_site_1(self):"
        },
        {
            "sha": "5e96fefd051f3d873b681022f99f3fcef6f5ca4b",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -9,7 +9,6 @@\n from django.db import DEFAULT_DB_ALIAS\n from django.db.backends import util\n from django.db.transaction import TransactionManagementError\n-from django.utils import datetime_safe\n from django.utils.importlib import import_module\n \n \n@@ -718,7 +717,7 @@ def value_to_db_date(self, value):\n         \"\"\"\n         if value is None:\n             return None\n-        return datetime_safe.new_date(value).strftime('%Y-%m-%d')\n+        return unicode(value)\n \n     def value_to_db_datetime(self, value):\n         \"\"\"\n@@ -731,7 +730,7 @@ def value_to_db_datetime(self, value):\n \n     def value_to_db_time(self, value):\n         \"\"\"\n-        Transform a datetime value to an object compatible with what is expected\n+        Transform a time value to an object compatible with what is expected\n         by the backend driver for time columns.\n         \"\"\"\n         if value is None:"
        },
        {
            "sha": "c437f1517e380c9736eed2d8c6402658ddf41b6b",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -320,14 +320,9 @@ def _sqlite_format_dtdelta(dt, conn, days, secs, usecs):\n             dt = dt - delta\n     except (ValueError, TypeError):\n         return None\n-\n-    if isinstance(dt, datetime.datetime):\n-        rv = dt.strftime(\"%Y-%m-%d %H:%M:%S\")\n-        if dt.microsecond:\n-            rv = \"%s.%0.6d\" % (rv, dt.microsecond)\n-    else:\n-        rv = dt.strftime(\"%Y-%m-%d\")\n-    return rv\n+    # typecast_timestamp returns a date or a datetime without timezone.\n+    # It will be formatted as \"%Y-%m-%d\" or \"%Y-%m-%d %H:%M:%S[.%f]\"\n+    return str(dt)\n \n def _sqlite_regexp(re_pattern, re_string):\n     try:"
        },
        {
            "sha": "55b993af028dcb3b2a48da0e49498bd798e77205",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -16,7 +16,6 @@\n from django.utils.text import capfirst\n from django.utils.translation import ugettext_lazy as _\n from django.utils.encoding import smart_unicode, force_unicode, smart_str\n-from django.utils import datetime_safe\n from django.utils.ipv6 import clean_ipv6_address\n \n class NOT_PROVIDED:\n@@ -725,7 +724,7 @@ def value_to_string(self, obj):\n         if val is None:\n             data = ''\n         else:\n-            data = datetime_safe.new_date(val).strftime(\"%Y-%m-%d\")\n+            data = str(val)\n         return data\n \n     def formfield(self, **kwargs):\n@@ -803,8 +802,7 @@ def value_to_string(self, obj):\n         if val is None:\n             data = ''\n         else:\n-            d = datetime_safe.new_datetime(val)\n-            data = d.strftime('%Y-%m-%d %H:%M:%S')\n+            data = str(val.replace(microsecond=0, tzinfo=None))\n         return data\n \n     def formfield(self, **kwargs):\n@@ -1234,7 +1232,7 @@ def value_to_string(self, obj):\n         if val is None:\n             data = ''\n         else:\n-            data = val.strftime(\"%H:%M:%S\")\n+            data = str(val.replace(microsecond=0))\n         return data\n \n     def formfield(self, **kwargs):"
        },
        {
            "sha": "e276e55a35b8259e36b7d5d63652bad4c0783975",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/06d9b82a27a4e47b435805938af23360e4291fb4/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/06d9b82a27a4e47b435805938af23360e4291fb4/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=06d9b82a27a4e47b435805938af23360e4291fb4",
            "patch": "@@ -188,8 +188,8 @@ def test_datefieldlistfilter(self):\n         self.assertEqual(choice['query_string'], '?date_registered__year=%s'\n                                                 % (self.today.year))\n \n-        request = self.request_factory.get('/', {'date_registered__gte': self.one_week_ago.strftime('%Y-%m-%d'),\n-                                                 'date_registered__lte': self.today.strftime('%Y-%m-%d')})\n+        request = self.request_factory.get('/', {'date_registered__gte': str(self.one_week_ago),\n+                                                 'date_registered__lte': str(self.today)})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct queryset is returned\n@@ -203,7 +203,7 @@ def test_datefieldlistfilter(self):\n         self.assertEqual(choice['selected'], True)\n         self.assertEqual(choice['query_string'], '?date_registered__gte=%s'\n                                                  '&date_registered__lte=%s'\n-                                                % (self.one_week_ago.strftime('%Y-%m-%d'), self.today.strftime('%Y-%m-%d')))\n+                                                % (str(self.one_week_ago), str(self.today)))\n \n     def test_allvaluesfieldlistfilter(self):\n         modeladmin = BookAdmin(Book, site)"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 22,
        "deletions": 31
    }
}