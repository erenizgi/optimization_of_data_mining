{
    "author": "aaugustin",
    "message": "Fixed #9655 -- Prevented the urlize template filter from double-quoting URLs. Thanks Claude Paroz for writing the tests.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17347 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e3a7bfccbb83712caf0645e4e33f5c03d9dc462b",
    "files": [
        {
            "sha": "4f74a7492c8e3bf45011e9158fb87b111bdad51e",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/e3a7bfccbb83712caf0645e4e33f5c03d9dc462b/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/e3a7bfccbb83712caf0645e4e33f5c03d9dc462b/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=e3a7bfccbb83712caf0645e4e33f5c03d9dc462b",
            "patch": "@@ -17,6 +17,7 @@\n DOTS = [u'&middot;', u'*', u'\\u2022', u'&#149;', u'&bull;', u'&#8226;']\n \n unencoded_ampersands_re = re.compile(r'&(?!(\\w+|#\\d+);)')\n+unquoted_percents_re = re.compile(r'%(?![0-9A-Fa-f]{2})')\n word_split_re = re.compile(r'(\\s+)')\n punctuation_re = re.compile('^(?P<lead>(?:%s)*)(?P<middle>.*?)(?P<trail>(?:%s)*)$' % \\\n     ('|'.join([re.escape(x) for x in LEADING_PUNCTUATION]),\n@@ -100,6 +101,15 @@ def fix_ampersands(value):\n     return unencoded_ampersands_re.sub('&amp;', force_unicode(value))\n fix_ampersands = allow_lazy(fix_ampersands, unicode)\n \n+def smart_urlquote(url):\n+    \"\"\"Quotes an URL if it isn't already quoted.\"\"\"\n+    # An URL is considered unquoted if it contains no % character, or if it\n+    # contains a % not followed by two hexadecimal digits. See #9655.\n+    if '%' not in url or unquoted_percents_re.search(url):\n+        # See http://bugs.python.org/issue2637\n+        return urlquote(url, safe='!*\\'();:@&=+$,/?#[]~')\n+    return url\n+\n def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n     \"\"\"\n     Converts any URLs in text into clickable links.\n@@ -130,11 +140,11 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             # Make URL we want to point to.\n             url = None\n             if middle.startswith('http://') or middle.startswith('https://'):\n-                url = urlquote(middle, safe='/&=:;#?+*')\n+                url = smart_urlquote(middle)\n             elif middle.startswith('www.') or ('@' not in middle and \\\n                     middle and middle[0] in string.ascii_letters + string.digits and \\\n                     (middle.endswith('.org') or middle.endswith('.net') or middle.endswith('.com'))):\n-                url = urlquote('http://%s' % middle, safe='/&=:;#?+*')\n+                url = smart_urlquote('http://%s' % middle)\n             elif '@' in middle and not ':' in middle and simple_email_re.match(middle):\n                 url = 'mailto:%s' % middle\n                 nofollow_attr = ''"
        },
        {
            "sha": "9f9ce7fb59b50c6b74baf8124f07a8723159b8e4",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/e3a7bfccbb83712caf0645e4e33f5c03d9dc462b/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/e3a7bfccbb83712caf0645e4e33f5c03d9dc462b/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=e3a7bfccbb83712caf0645e4e33f5c03d9dc462b",
            "patch": "@@ -1044,6 +1044,15 @@ Now, the flags are keyword arguments of :meth:`@register.filter\n \n See :ref:`filters and auto-escaping <filters-auto-escaping>` for more information.\n \n+The :tfilter:`urlize` filter no longer escapes every URL\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+When an URL contains a ``%xx`` sequence, where ``xx`` are two hexadecimal\n+digits, :tfilter:`urlize` assumes that the URL is already escaped, and doesn't\n+apply URL escaping again. This is wrong for URLs whose unquoted form contains\n+a ``%xx`` sequence, but such URLs are very unlikely to happen in the wild,\n+since they would confuse browsers too.\n+\n Session cookies now have the ``httponly`` flag by default\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "00518344a39560fa9b66a05dd22b7d41102c5757",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/e3a7bfccbb83712caf0645e4e33f5c03d9dc462b/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e3a7bfccbb83712caf0645e4e33f5c03d9dc462b/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=e3a7bfccbb83712caf0645e4e33f5c03d9dc462b",
            "patch": "@@ -238,6 +238,19 @@ def test_urlize(self):\n         # Check urlize with https addresses\n         self.assertEqual(urlize('https://google.com'),\n             u'<a href=\"https://google.com\" rel=\"nofollow\">https://google.com</a>')\n+        # Check urlize doesn't overquote already quoted urls - see #9655\n+        self.assertEqual(urlize('http://hi.baidu.com/%D6%D8%D0%C2%BF'),\n+            u'<a href=\"http://hi.baidu.com/%D6%D8%D0%C2%BF\" rel=\"nofollow\">'\n+            u'http://hi.baidu.com/%D6%D8%D0%C2%BF</a>')\n+        self.assertEqual(urlize('www.mystore.com/30%OffCoupons!'),\n+            u'<a href=\"http://www.mystore.com/30%25OffCoupons!\" rel=\"nofollow\">'\n+            u'www.mystore.com/30%OffCoupons!</a>')\n+        self.assertEqual(urlize('http://en.wikipedia.org/wiki/Caf%C3%A9'),\n+            u'<a href=\"http://en.wikipedia.org/wiki/Caf%C3%A9\" rel=\"nofollow\">'\n+            u'http://en.wikipedia.org/wiki/Caf%C3%A9</a>')\n+        self.assertEqual(urlize('http://en.wikipedia.org/wiki/Café'),\n+            u'<a href=\"http://en.wikipedia.org/wiki/Caf%C3%A9\" rel=\"nofollow\">'\n+            u'http://en.wikipedia.org/wiki/Café</a>')\n \n     def test_wordcount(self):\n         self.assertEqual(wordcount(''), 0)"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 34,
        "deletions": 2
    }
}