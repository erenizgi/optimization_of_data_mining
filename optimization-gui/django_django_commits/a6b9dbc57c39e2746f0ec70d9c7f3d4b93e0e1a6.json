{
    "author": "spookylukey",
    "message": "Fixed #15075 - No longer possible to alter the form_list in FormWizard.process_step\n\nThanks to niels, stas for the report, and stas for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15196 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6",
    "files": [
        {
            "sha": "1ec71d3e338e9013117fcc508b91ca8bd65f6367",
            "filename": "django/contrib/formtools/tests/__init__.py",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py?ref=a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6",
            "patch": "@@ -233,6 +233,8 @@ class WizardPageOneForm(forms.Form):\n class WizardPageTwoForm(forms.Form):\n     field = forms.CharField()\n \n+class WizardPageTwoAlternativeForm(forms.Form):\n+    field = forms.CharField()\n \n class WizardPageThreeForm(forms.Form):\n     field = forms.CharField()\n@@ -351,7 +353,8 @@ def test_good_hash_current(self):\n \n     def test_14498(self):\n         \"\"\"\n-        Regression test for ticket #14498.\n+        Regression test for ticket #14498.  All previous steps' forms should be\n+        validated.\n         \"\"\"\n         that = self\n \n@@ -391,3 +394,26 @@ def done(self, request, form_list):\n                 \"wizard_step\": \"1\"}\n         wizard(DummyRequest(POST=data))\n         self.assertTrue(reached[0])\n+\n+    def test_15075(self):\n+        \"\"\"\n+        Regression test for ticket #15075.  Allow modifying wizard's form_list\n+        in process_step.\n+        \"\"\"\n+        that = self\n+\n+        class WizardWithProcessStep(WizardClass):\n+            def process_step(self, request, form, step):\n+                if step == 0:\n+                    self.form_list[1] = WizardPageTwoAlternativeForm\n+                if step == 1:\n+                    that.assertTrue(isinstance(form, WizardPageTwoAlternativeForm))\n+\n+        wizard = WizardWithProcessStep([WizardPageOneForm,\n+                                        WizardPageTwoForm,\n+                                        WizardPageThreeForm])\n+        data = {\"0-field\": \"test\",\n+                \"1-field\": \"test2\",\n+                \"hash_0\": \"7e9cea465f6a10a6fb47fcea65cb9a76350c9a5c\",\n+                \"wizard_step\": \"1\"}\n+        wizard(DummyRequest(POST=data))"
        },
        {
            "sha": "6f3660dd996cc1d90f0927855f91c133530bf5ea",
            "filename": "django/contrib/formtools/wizard.py",
            "status": "modified",
            "additions": 34,
            "deletions": 30,
            "changes": 64,
            "blob_url": "https://github.com/django/django/blob/a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6/django%2Fcontrib%2Fformtools%2Fwizard.py",
            "raw_url": "https://github.com/django/django/raw/a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6/django%2Fcontrib%2Fformtools%2Fwizard.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Fwizard.py?ref=a6b9dbc57c39e2746f0ec70d9c7f3d4b93e0e1a6",
            "patch": "@@ -90,6 +90,40 @@ def __call__(self, request, *args, **kwargs):\n         if current_step >= self.num_steps():\n             raise Http404('Step %s does not exist' % current_step)\n \n+        # Validate and process all the previous forms before instantiating the\n+        # current step's form in case self.process_step makes changes to\n+        # self.form_list.\n+\n+        # If any of them fails validation, that must mean the validator relied\n+        # on some other input, such as an external Web site.\n+\n+        # It is also possible that alidation might fail under certain attack\n+        # situations: an attacker might be able to bypass previous stages, and\n+        # generate correct security hashes for all the skipped stages by virtue\n+        # of:\n+        #  1) having filled out an identical form which doesn't have the\n+        #     validation (and does something different at the end),\n+        #  2) or having filled out a previous version of the same form which\n+        #     had some validation missing,\n+        #  3) or previously having filled out the form when they had more\n+        #     privileges than they do now.\n+        #\n+        # Since the hashes only take into account values, and not other other\n+        # validation the form might do, we must re-do validation now for\n+        # security reasons.\n+        previous_form_list = []\n+        for i in range(current_step):\n+            f = self.get_form(i, request.POST)\n+            if not self._check_security_hash(request.POST.get(\"hash_%d\" % i, ''),\n+                                             request, f):\n+                return self.render_hash_failure(request, i)\n+\n+            if not f.is_valid():\n+                return self.render_revalidation_failure(request, i, f)\n+            else:\n+                self.process_step(request, f, i)\n+                previous_form_list.append(f)\n+\n         # Process the current step. If it's valid, go to the next step or call\n         # done(), depending on whether any steps remain.\n         if request.method == 'POST':\n@@ -98,36 +132,6 @@ def __call__(self, request, *args, **kwargs):\n             form = self.get_form(current_step)\n \n         if form.is_valid():\n-            # Validate all the forms. If any of them fail validation, that\n-            # must mean the validator relied on some other input, such as\n-            # an external Web site.\n-\n-            # It is also possible that validation might fail under certain\n-            # attack situations: an attacker might be able to bypass previous\n-            # stages, and generate correct security hashes for all the\n-            # skipped stages by virtue of:\n-            #  1) having filled out an identical form which doesn't have the\n-            #     validation (and does something different at the end),\n-            #  2) or having filled out a previous version of the same form\n-            #     which had some validation missing,\n-            #  3) or previously having filled out the form when they had\n-            #     more privileges than they do now.\n-            #\n-            # Since the hashes only take into account values, and not other\n-            # other validation the form might do, we must re-do validation\n-            # now for security reasons.\n-            previous_form_list = [self.get_form(i, request.POST) for i in range(current_step)]\n-\n-            for i, f in enumerate(previous_form_list):\n-                if not self._check_security_hash(request.POST.get(\"hash_%d\" % i, ''), request, f):\n-                    return self.render_hash_failure(request, i)\n-\n-                if not f.is_valid():\n-                    return self.render_revalidation_failure(request, i, f)\n-                else:\n-                    self.process_step(request, f, i)\n-\n-            # Now progress to processing this step:\n             self.process_step(request, form, current_step)\n             next_step = current_step + 1\n "
        }
    ],
    "stats": {
        "total": 92,
        "additions": 61,
        "deletions": 31
    }
}