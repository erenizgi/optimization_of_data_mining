{
    "author": "aaugustin",
    "message": "Abused atomic for transaction handling in TestCase.\n\nIt isn't necessary to disable set_autocommit since its use is prohibited\ninside an atomic block. It's still necessary to disable the legacy\ntransaction management methods for backwards compatibility, until\nthey're removed.",
    "sha": "f32100939e8ea8a2714e45e22467af5df55c8f33",
    "files": [
        {
            "sha": "83762ddee45cd2f5a257ef419493dbd795ad13b6",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/f32100939e8ea8a2714e45e22467af5df55c8f33/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/f32100939e8ea8a2714e45e22467af5df55c8f33/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=f32100939e8ea8a2714e45e22467af5df55c8f33",
            "patch": "@@ -63,7 +63,6 @@ def to_list(value):\n         value = [value]\n     return value\n \n-real_set_autocommit = transaction.set_autocommit\n real_commit = transaction.commit\n real_rollback = transaction.rollback\n real_enter_transaction_management = transaction.enter_transaction_management\n@@ -74,15 +73,13 @@ def nop(*args, **kwargs):\n     return\n \n def disable_transaction_methods():\n-    transaction.set_autocommit = nop\n     transaction.commit = nop\n     transaction.rollback = nop\n     transaction.enter_transaction_management = nop\n     transaction.leave_transaction_management = nop\n     transaction.abort = nop\n \n def restore_transaction_methods():\n-    transaction.set_autocommit = real_set_autocommit\n     transaction.commit = real_commit\n     transaction.rollback = real_rollback\n     transaction.enter_transaction_management = real_enter_transaction_management\n@@ -814,8 +811,11 @@ def _fixture_setup(self):\n \n         assert not self.reset_sequences, 'reset_sequences cannot be used on TestCase instances'\n \n+        self.atomics = {}\n         for db_name in self._databases_names():\n-            transaction.enter_transaction_management(using=db_name)\n+            self.atomics[db_name] = transaction.atomic(using=db_name)\n+            self.atomics[db_name].__enter__()\n+        # Remove this when the legacy transaction management goes away.\n         disable_transaction_methods()\n \n         from django.contrib.sites.models import Site\n@@ -835,10 +835,12 @@ def _fixture_teardown(self):\n         if not connections_support_transactions():\n             return super(TestCase, self)._fixture_teardown()\n \n+        # Remove this when the legacy transaction management goes away.\n         restore_transaction_methods()\n-        for db in self._databases_names():\n-            transaction.rollback(using=db)\n-            transaction.leave_transaction_management(using=db)\n+        for db_name in reversed(self._databases_names()):\n+            # Hack to force a rollback\n+            connections[db_name].needs_rollback = True\n+            self.atomics[db_name].__exit__(None, None, None)\n \n \n def _deferredSkip(condition, reason):"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 9,
        "deletions": 7
    }
}