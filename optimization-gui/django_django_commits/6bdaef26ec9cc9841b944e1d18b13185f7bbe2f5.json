{
    "author": "carljm",
    "message": "Fixed #15866, #15850 -- Prevented get_model() and get_models() from returning not-installed models (by default). Thanks adsva for report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16053 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
    "files": [
        {
            "sha": "06e06bcc4e1f46d9293be3d2a6b43e4a6bf50178",
            "filename": "django/contrib/contenttypes/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fcontrib%2Fcontenttypes%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fcontrib%2Fcontenttypes%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fmodels.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -90,7 +90,8 @@ def __unicode__(self):\n     def model_class(self):\n         \"Returns the Python model class for this type of content.\"\n         from django.db import models\n-        return models.get_model(self.app_label, self.model)\n+        return models.get_model(self.app_label, self.model,\n+                                only_installed=False)\n \n     def get_object_for_this_type(self, **kwargs):\n         \"\"\""
        },
        {
            "sha": "9cf083416cf9cf58b68512cdb4009563394bff76",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -88,7 +88,8 @@ def __new__(cls, name, bases, attrs):\n                 new_class._base_manager = new_class._base_manager._copy_to_model(new_class)\n \n         # Bail out early if we have already created this class.\n-        m = get_model(new_class._meta.app_label, name, False)\n+        m = get_model(new_class._meta.app_label, name,\n+                      seed_cache=False, only_installed=False)\n         if m is not None:\n             return m\n \n@@ -201,7 +202,8 @@ def __new__(cls, name, bases, attrs):\n         # the first time this model tries to register with the framework. There\n         # should only be one class for each model, so we always return the\n         # registered version.\n-        return get_model(new_class._meta.app_label, name, False)\n+        return get_model(new_class._meta.app_label, name,\n+                         seed_cache=False, only_installed=False)\n \n     def copy_managers(cls, base_managers):\n         # This is in-place sorting of an Options attribute, but that's fine."
        },
        {
            "sha": "ffa56926460c426b734497524a14cef875226b9a",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -67,7 +67,8 @@ class MyModel(Model):\n     # string right away. If get_model returns None, it means that the related\n     # model isn't loaded yet, so we need to pend the relation until the class\n     # is prepared.\n-    model = get_model(app_label, model_name, False)\n+    model = get_model(app_label, model_name,\n+                      seed_cache=False, only_installed=False)\n     if model:\n         operation(field, model, cls)\n     else:"
        },
        {
            "sha": "6fab4a931b1f89588635db29b8baa72dfbf48baf",
            "filename": "django/db/models/loading.py",
            "status": "modified",
            "additions": 27,
            "deletions": 6,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fdb%2Fmodels%2Floading.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/django%2Fdb%2Fmodels%2Floading.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Floading.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -25,7 +25,11 @@ class AppCache(object):\n         # Keys of app_store are the model modules for each application.\n         app_store = SortedDict(),\n \n+        # Mapping of installed app_labels to model modules for that app.\n+        app_labels = {},\n+\n         # Mapping of app_labels to a dictionary of model names to model code.\n+        # May contain apps that are not installed.\n         app_models = SortedDict(),\n \n         # Mapping of app_labels to errors raised when trying to import the app.\n@@ -66,6 +70,13 @@ def _populate(self):\n         finally:\n             self.write_lock.release()\n \n+    def _label_for(self, app_mod):\n+        \"\"\"\n+        Return app_label for given models module.\n+\n+        \"\"\"\n+        return app_mod.__name__.split('.')[-2]\n+\n     def load_app(self, app_name, can_postpone=False):\n         \"\"\"\n         Loads the app with the provided fully qualified name, and returns the\n@@ -99,6 +110,7 @@ def load_app(self, app_name, can_postpone=False):\n         self.nesting_level -= 1\n         if models not in self.app_store:\n             self.app_store[models] = len(self.app_store)\n+            self.app_labels[self._label_for(models)] = models\n         return models\n \n     def app_cache_ready(self):\n@@ -146,7 +158,8 @@ def get_app_errors(self):\n         self._populate()\n         return self.app_errors\n \n-    def get_models(self, app_mod=None, include_auto_created=False, include_deferred=False):\n+    def get_models(self, app_mod=None,\n+                   include_auto_created=False, include_deferred=False):\n         \"\"\"\n         Given a module containing models, returns a list of the models.\n         Otherwise returns a list of all installed models.\n@@ -166,20 +179,26 @@ def get_models(self, app_mod=None, include_auto_created=False, include_deferred=\n             pass\n         self._populate()\n         if app_mod:\n-            app_list = [self.app_models.get(app_mod.__name__.split('.')[-2], SortedDict())]\n+            if app_mod in self.app_store:\n+                app_list = [self.app_models.get(self._label_for(app_mod),\n+                                                SortedDict())]\n+            else:\n+                app_list = []\n         else:\n-            app_list = self.app_models.itervalues()\n+            app_list = [self.app_models.get(app_label, SortedDict())\n+                        for app_label in self.app_labels.iterkeys()]\n         model_list = []\n         for app in app_list:\n             model_list.extend(\n                 model for model in app.values()\n-                if ((not model._deferred or include_deferred)\n-                    and (not model._meta.auto_created or include_auto_created))\n+                if ((not model._deferred or include_deferred) and\n+                    (not model._meta.auto_created or include_auto_created))\n             )\n         self._get_models_cache[cache_key] = model_list\n         return model_list\n \n-    def get_model(self, app_label, model_name, seed_cache=True):\n+    def get_model(self, app_label, model_name,\n+                  seed_cache=True, only_installed=True):\n         \"\"\"\n         Returns the model matching the given app_label and case-insensitive\n         model_name.\n@@ -188,6 +207,8 @@ def get_model(self, app_label, model_name, seed_cache=True):\n         \"\"\"\n         if seed_cache:\n             self._populate()\n+        if only_installed and app_label not in self.app_labels:\n+            return None\n         return self.app_models.get(app_label, SortedDict()).get(model_name.lower())\n \n     def register_models(self, app_label, *models):"
        },
        {
            "sha": "a8c5e882f190722b768fd02d2fc342ce1d62c950",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -1023,7 +1023,11 @@ def test_complex_app(self):\n     def test_app_with_import(self):\n         \"manage.py validate does not raise errors when an app imports a base class that itself has an abstract base\"\n         self.write_settings('settings.py',\n-            apps=['admin_scripts.app_with_import', 'django.contrib.comments'],\n+            apps=['admin_scripts.app_with_import',\n+                  'django.contrib.comments',\n+                  'django.contrib.auth',\n+                  'django.contrib.contenttypes',\n+                  'django.contrib.sites'],\n             sdict={'DEBUG': True})\n         args = ['validate']\n         out, err = self.run_manage(args)"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/app_loading/not_installed/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fapp_loading%2Fnot_installed%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fapp_loading%2Fnot_installed%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fapp_loading%2Fnot_installed%2F__init__.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5"
        },
        {
            "sha": "615feefddbbf1ff92c1fa7db283e16c76ad2291f",
            "filename": "tests/regressiontests/app_loading/not_installed/models.py",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fapp_loading%2Fnot_installed%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fapp_loading%2Fnot_installed%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fapp_loading%2Fnot_installed%2Fmodels.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -0,0 +1,5 @@\n+from django.db import models\n+\n+\n+class NotInstalledModel(models.Model):\n+    pass"
        },
        {
            "sha": "6ee06c50c94d43339313b1674707934d09f9ed3f",
            "filename": "tests/regressiontests/app_loading/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fapp_loading%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5/tests%2Fregressiontests%2Fapp_loading%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fapp_loading%2Ftests.py?ref=6bdaef26ec9cc9841b944e1d18b13185f7bbe2f5",
            "patch": "@@ -4,7 +4,7 @@\n import time\n \n from django.conf import Settings\n-from django.db.models.loading import cache, load_app\n+from django.db.models.loading import cache, load_app, get_model, get_models\n from django.utils.unittest import TestCase\n \n \n@@ -81,3 +81,24 @@ def test_egg5(self):\n             # Make sure the message is indicating the actual\n             # problem in the broken app.\n             self.assertTrue(\"modelz\" in e.args[0])\n+\n+\n+class GetModelsTest(TestCase):\n+    def setUp(self):\n+        import not_installed.models\n+        self.not_installed_module = not_installed.models\n+\n+\n+    def test_get_model_only_returns_installed_models(self):\n+        self.assertEqual(\n+            get_model(\"not_installed\", \"NotInstalledModel\"), None)\n+\n+\n+    def test_get_models_only_returns_installed_models(self):\n+        self.assertFalse(\n+            \"NotInstalledModel\" in\n+            [m.__name__ for m in get_models()])\n+\n+\n+    def test_get_models_with_app_label_only_returns_installed_models(self):\n+        self.assertEqual(get_models(self.not_installed_module), [])"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 67,
        "deletions": 12
    }
}