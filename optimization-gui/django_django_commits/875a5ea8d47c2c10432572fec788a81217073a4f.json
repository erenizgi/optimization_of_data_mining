{
    "author": "jezdez",
    "message": "Fixed #17504 -- Fixed normalization of email addresses that have '@' in the name when calling `User.objects.create_user`. Thanks, marw85.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17482 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "875a5ea8d47c2c10432572fec788a81217073a4f",
    "files": [
        {
            "sha": "eb39868ca96c7bbe4103db9892e54210e19ddc96",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/875a5ea8d47c2c10432572fec788a81217073a4f/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/875a5ea8d47c2c10432572fec788a81217073a4f/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=875a5ea8d47c2c10432572fec788a81217073a4f",
            "patch": "@@ -128,25 +128,31 @@ def natural_key(self):\n \n \n class UserManager(models.Manager):\n-    def create_user(self, username, email=None, password=None):\n+\n+    @classmethod\n+    def normalize_email(cls, email):\n         \"\"\"\n-        Creates and saves a User with the given username, email and password.\n+        Normalize the address by lowercasing the domain part of the email\n+        address.\n         \"\"\"\n-        now = timezone.now()\n-\n-        # Normalize the address by lowercasing the domain part of the email\n-        # address.\n         email = email or ''\n         try:\n-            email_name, domain_part = email.strip().split('@', 1)\n+            email_name, domain_part = email.strip().rsplit('@', 1)\n         except ValueError:\n             pass\n         else:\n             email = '@'.join([email_name, domain_part.lower()])\n+        return email\n \n-        user = self.model(username=username, email=email, is_staff=False,\n-                         is_active=True, is_superuser=False, last_login=now,\n-                         date_joined=now)\n+    def create_user(self, username, email=None, password=None):\n+        \"\"\"\n+        Creates and saves a User with the given username, email and password.\n+        \"\"\"\n+        now = timezone.now()\n+        email = UserManager.normalize_email(email)\n+        user = self.model(username=username, email=email,\n+                          is_staff=False, is_active=True, is_superuser=False,\n+                          last_login=now, date_joined=now)\n \n         user.set_password(password)\n         user.save(using=self._db)"
        },
        {
            "sha": "0c650d7237c0323c574b66807543d2142c5b4c01",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/875a5ea8d47c2c10432572fec788a81217073a4f/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/875a5ea8d47c2c10432572fec788a81217073a4f/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=875a5ea8d47c2c10432572fec788a81217073a4f",
            "patch": "@@ -11,7 +11,8 @@\n     RemoteUserNoCreateTest, RemoteUserCustomTest)\n from django.contrib.auth.tests.management import GetDefaultUsernameTestCase\n from django.contrib.auth.tests.models import (ProfileTestCase, NaturalKeysTestCase,\n-    LoadDataWithoutNaturalKeysTestCase, LoadDataWithNaturalKeysTestCase)\n+    LoadDataWithoutNaturalKeysTestCase, LoadDataWithNaturalKeysTestCase,\n+    UserManagerTestCase)\n from django.contrib.auth.tests.hashers import TestUtilsHashPass\n from django.contrib.auth.tests.signals import SignalTestCase\n from django.contrib.auth.tests.tokens import TokenGeneratorTest"
        },
        {
            "sha": "2d570aee15279f00b5504e7b4886c8e55fedfbbf",
            "filename": "django/contrib/auth/tests/models.py",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/875a5ea8d47c2c10432572fec788a81217073a4f/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/875a5ea8d47c2c10432572fec788a81217073a4f/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py?ref=875a5ea8d47c2c10432572fec788a81217073a4f",
            "patch": "@@ -1,9 +1,12 @@\n from django.conf import settings\n from django.test import TestCase\n-from django.contrib.auth.models import Group, User, SiteProfileNotAvailable\n+from django.contrib.auth.models import (Group, User,\n+    SiteProfileNotAvailable, UserManager)\n+\n \n class ProfileTestCase(TestCase):\n     fixtures = ['authtestdata.json']\n+\n     def setUp(self):\n         \"\"\"Backs up the AUTH_PROFILE_MODULE\"\"\"\n         self.old_AUTH_PROFILE_MODULE = getattr(settings,\n@@ -59,8 +62,32 @@ def test_user_is_created_and_added_to_group(self):\n \n class LoadDataWithNaturalKeysTestCase(TestCase):\n     fixtures = ['natural.json']\n+\n     def test_user_is_created_and_added_to_group(self):\n         user = User.objects.get(username='my_username')\n         group = Group.objects.get(name='my_group')\n         self.assertEquals(group, user.groups.get())\n \n+\n+class UserManagerTestCase(TestCase):\n+\n+    def test_create_user(self):\n+        email_lowercase = 'normal@normal.com'\n+        user = User.objects.create_user('user', email_lowercase)\n+        self.assertEquals(user.email, email_lowercase)\n+        self.assertEquals(user.username, 'user')\n+        self.assertEquals(user.password, '!')\n+\n+    def test_create_user_email_domain_normalize_rfc3696(self):\n+        # According to  http://tools.ietf.org/html/rfc3696#section-3\n+        # the \"@\" symbol can be part of the local part of an email address\n+        returned = UserManager.normalize_email(r'Abc\\@DEF@EXAMPLE.com')\n+        self.assertEquals(returned, r'Abc\\@DEF@example.com')\n+\n+    def test_create_user_email_domain_normalize(self):\n+        returned = UserManager.normalize_email('normal@DOMAIN.COM')\n+        self.assertEquals(returned, 'normal@domain.com')\n+\n+    def test_create_user_email_domain_normalize_with_whitespace(self):\n+        returned = UserManager.normalize_email('email\\ with_whitespace@D.COM')\n+        self.assertEquals(returned, 'email\\ with_whitespace@d.com')"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 46,
        "deletions": 12
    }
}