{
    "author": "jphalip",
    "message": "Ensured that thread-shareability gets validated when closing a PostgreSQL or SQLite connection. Refs #17258.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17206 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a1d2f1f7b76d434072c35b55678ce8a3bbfb4649",
    "files": [
        {
            "sha": "8002a70f8bc45bafc349830b663c6219ee622883",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=a1d2f1f7b76d434072c35b55678ce8a3bbfb4649",
            "patch": "@@ -130,7 +130,7 @@ def validate_thread_sharing(self):\n         if (not self.allow_thread_sharing\n             and self._thread_ident != thread.get_ident()):\n                 raise DatabaseError(\"DatabaseWrapper objects created in a \"\n-                    \"thread can only be used in that same thread. The object\"\n+                    \"thread can only be used in that same thread. The object \"\n                     \"with alias '%s' was created in thread id %s and this is \"\n                     \"thread id %s.\"\n                     % (self.alias, self._thread_ident, thread.get_ident()))"
        },
        {
            "sha": "9b25737ea00f1059e5ad82d799dfb66b598f9a6f",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=a1d2f1f7b76d434072c35b55678ce8a3bbfb4649",
            "patch": "@@ -129,6 +129,7 @@ def check_constraints(self, table_names=None):\n         self.cursor().execute('SET CONSTRAINTS ALL DEFERRED')\n \n     def close(self):\n+        self.validate_thread_sharing()\n         if self.connection is None:\n             return\n "
        },
        {
            "sha": "b5d38bb367d33bdb6d5bb0b241f64ca6c4b5de7b",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=a1d2f1f7b76d434072c35b55678ce8a3bbfb4649",
            "patch": "@@ -300,6 +300,7 @@ def check_constraints(self, table_names=None):\n                         referenced_table_name, referenced_column_name))\n \n     def close(self):\n+        self.validate_thread_sharing()\n         # If database is in memory, closing the connection destroys the\n         # database. To prevent accidental data loss, ignore close requests on\n         # an in-memory db."
        },
        {
            "sha": "bda604e00ba6eb8296fbabc813edb44fd238c81e",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a1d2f1f7b76d434072c35b55678ce8a3bbfb4649/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=a1d2f1f7b76d434072c35b55678ce8a3bbfb4649",
            "patch": "@@ -487,6 +487,9 @@ def test_connections_thread_local(self):\n         def runner():\n             from django.db import connections\n             for conn in connections.all():\n+                # Allow thread sharing so the connection can be closed by the\n+                # main thread.\n+                conn.allow_thread_sharing = True\n                 connections_set.add(conn)\n         for x in xrange(2):\n             t = threading.Thread(target=runner)\n@@ -537,4 +540,46 @@ def runner(main_thread_connection):\n         exceptions = []\n         do_thread()\n         # All good\n+        self.assertEqual(len(exceptions), 0)\n+\n+    def test_closing_non_shared_connections(self):\n+        \"\"\"\n+        Ensure that a connection that is not explicitly shareable cannot be\n+        closed by another thread.\n+        Refs #17258.\n+        \"\"\"\n+        # First, without explicitly enabling the connection for sharing.\n+        exceptions = set()\n+        def runner1():\n+            def runner2(other_thread_connection):\n+                try:\n+                    other_thread_connection.close()\n+                except DatabaseError, e:\n+                    exceptions.add(e)\n+            t2 = threading.Thread(target=runner2, args=[connections['default']])\n+            t2.start()\n+            t2.join()\n+        t1 = threading.Thread(target=runner1)\n+        t1.start()\n+        t1.join()\n+        # The exception was raised\n+        self.assertEqual(len(exceptions), 1)\n+\n+        # Then, with explicitly enabling the connection for sharing.\n+        exceptions = set()\n+        def runner1():\n+            def runner2(other_thread_connection):\n+                try:\n+                    other_thread_connection.close()\n+                except DatabaseError, e:\n+                    exceptions.add(e)\n+            # Enable thread sharing\n+            connections['default'].allow_thread_sharing = True\n+            t2 = threading.Thread(target=runner2, args=[connections['default']])\n+            t2.start()\n+            t2.join()\n+        t1 = threading.Thread(target=runner1)\n+        t1.start()\n+        t1.join()\n+        # No exception was raised\n         self.assertEqual(len(exceptions), 0)\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 48,
        "deletions": 1
    }
}