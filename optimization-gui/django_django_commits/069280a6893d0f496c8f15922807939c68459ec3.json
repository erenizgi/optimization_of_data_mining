{
    "author": "bmispelon",
    "message": "Used token.split_contents() for tokenisation in template tags accepting variables.\n\nFixed #6271, #18260.",
    "sha": "069280a6893d0f496c8f15922807939c68459ec3",
    "files": [
        {
            "sha": "d45bd4b74a6d93c5c2cc5e943c5e1422422e100a",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 13,
            "deletions": 10,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -489,6 +489,7 @@ def autoescape(parser, token):\n     \"\"\"\n     Force autoescape behavior for this block.\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     args = token.contents.split()\n     if len(args) != 2:\n         raise TemplateSyntaxError(\"'autoescape' tag requires exactly one argument.\")\n@@ -633,6 +634,7 @@ def do_filter(parser, token):\n     Instead, use the ``autoescape`` tag to manage autoescaping for blocks of\n     template code.\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     _, rest = token.contents.split(None, 1)\n     filter_expr = parser.compile_filter(\"var|%s\" % (rest))\n     for func, unused in filter_expr.filters:\n@@ -954,7 +956,7 @@ def ifchanged(parser, token):\n                 {% endifchanged %}\n             {% endfor %}\n     \"\"\"\n-    bits = token.contents.split()\n+    bits = token.split_contents()\n     nodelist_true = parser.parse(('else', 'endifchanged'))\n     token = parser.next_token()\n     if token.contents == 'else':\n@@ -1011,6 +1013,7 @@ def load(parser, token):\n         {% load byline from news %}\n \n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     bits = token.contents.split()\n     if len(bits) >= 4 and bits[-2] == \"from\":\n         try:\n@@ -1109,17 +1112,16 @@ def regroup(parser, token):\n         {% regroup people|dictsort:\"gender\" by gender as grouped %}\n \n     \"\"\"\n-    firstbits = token.contents.split(None, 3)\n-    if len(firstbits) != 4:\n+    bits = token.split_contents()\n+    if len(bits) != 6:\n         raise TemplateSyntaxError(\"'regroup' tag takes five arguments\")\n-    target = parser.compile_filter(firstbits[1])\n-    if firstbits[2] != 'by':\n+    target = parser.compile_filter(bits[1])\n+    if bits[2] != 'by':\n         raise TemplateSyntaxError(\"second argument to 'regroup' tag must be 'by'\")\n-    lastbits_reversed = firstbits[3][::-1].split(None, 2)\n-    if lastbits_reversed[1][::-1] != 'as':\n+    if bits[4] != 'as':\n         raise TemplateSyntaxError(\"next-to-last argument to 'regroup' tag must\"\n                                   \" be 'as'\")\n-    var_name = lastbits_reversed[0][::-1]\n+    var_name = bits[5]\n     # RegroupNode will take each item in 'target', put it in the context under\n     # 'var_name', evaluate 'var_name'.'expression' in the current context, and\n     # group by the resulting value. After all items are processed, it will\n@@ -1128,7 +1130,7 @@ def regroup(parser, token):\n     # doesn't provide a context-aware equivalent of Python's getattr.\n     expression = parser.compile_filter(var_name +\n                                        VARIABLE_ATTRIBUTE_SEPARATOR +\n-                                       lastbits_reversed[2][::-1])\n+                                       bits[3])\n     return RegroupNode(target, expression, var_name)\n \n @register.tag\n@@ -1184,6 +1186,7 @@ def templatetag(parser, token):\n         ``closecomment``    ``#}``\n         ==================  =======\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     bits = token.contents.split()\n     if len(bits) != 2:\n         raise TemplateSyntaxError(\"'templatetag' statement takes one argument\")\n@@ -1325,7 +1328,7 @@ def widthratio(parser, token):\n     the image in the above example will be 88 pixels wide\n     (because 175/200 = .875; .875 * 100 = 87.5 which is rounded up to 88).\n     \"\"\"\n-    bits = token.contents.split()\n+    bits = token.split_contents()\n     if len(bits) != 4:\n         raise TemplateSyntaxError(\"widthratio takes three arguments\")\n     tag, this_value_expr, max_value_expr, max_width = bits"
        },
        {
            "sha": "767f0e5ff822221e6d618390e45b70bb420e41db",
            "filename": "django/template/loader_tags.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplate%2Floader_tags.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplate%2Floader_tags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Floader_tags.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -174,6 +174,7 @@ def do_block(parser, token):\n     \"\"\"\n     Define a block that can be overridden by child templates.\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     bits = token.contents.split()\n     if len(bits) != 2:\n         raise TemplateSyntaxError(\"'%s' tag takes only one argument\" % bits[0])"
        },
        {
            "sha": "bb21b91c6afa106901063ac5a7544cc9029ca1b9",
            "filename": "django/templatetags/cache.py",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fcache.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -1,8 +1,7 @@\n from __future__ import unicode_literals\n \n import hashlib\n-from django.template import Library, Node, TemplateSyntaxError, Variable, VariableDoesNotExist\n-from django.template import resolve_variable\n+from django.template import Library, Node, TemplateSyntaxError, VariableDoesNotExist\n from django.core.cache import cache\n from django.utils.encoding import force_bytes\n from django.utils.http import urlquote\n@@ -12,7 +11,7 @@\n class CacheNode(Node):\n     def __init__(self, nodelist, expire_time_var, fragment_name, vary_on):\n         self.nodelist = nodelist\n-        self.expire_time_var = Variable(expire_time_var)\n+        self.expire_time_var = expire_time_var\n         self.fragment_name = fragment_name\n         self.vary_on = vary_on\n \n@@ -26,7 +25,7 @@ def render(self, context):\n         except (ValueError, TypeError):\n             raise TemplateSyntaxError('\"cache\" tag got a non-integer timeout value: %r' % expire_time)\n         # Build a key for this fragment and all vary-on's.\n-        key = ':'.join([urlquote(resolve_variable(var, context)) for var in self.vary_on])\n+        key = ':'.join([urlquote(var.resolve(context)) for var in self.vary_on])\n         args = hashlib.md5(force_bytes(key))\n         cache_key = 'template.cache.%s.%s' % (self.fragment_name, args.hexdigest())\n         value = cache.get(cache_key)\n@@ -59,7 +58,10 @@ def do_cache(parser, token):\n     \"\"\"\n     nodelist = parser.parse(('endcache',))\n     parser.delete_first_token()\n-    tokens = token.contents.split()\n+    tokens = token.split_contents()\n     if len(tokens) < 3:\n         raise TemplateSyntaxError(\"'%r' tag requires at least 2 arguments.\" % tokens[0])\n-    return CacheNode(nodelist, tokens[1], tokens[2], tokens[3:])\n+    return CacheNode(nodelist,\n+        parser.compile_filter(tokens[1]),\n+        parser.compile_filter(tokens[2]),\n+        [parser.compile_filter(token) for token in tokens[3:]])"
        },
        {
            "sha": "abb30f0e8cd4433b8208131f94a5c8d9605c966a",
            "filename": "django/templatetags/i18n.py",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fi18n.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -24,7 +24,7 @@ def render(self, context):\n \n class GetLanguageInfoNode(Node):\n     def __init__(self, lang_code, variable):\n-        self.lang_code = Variable(lang_code)\n+        self.lang_code = lang_code\n         self.variable = variable\n \n     def render(self, context):\n@@ -35,7 +35,7 @@ def render(self, context):\n \n class GetLanguageInfoListNode(Node):\n     def __init__(self, languages, variable):\n-        self.languages = Variable(languages)\n+        self.languages = languages\n         self.variable = variable\n \n     def get_language_info(self, language):\n@@ -185,6 +185,7 @@ def do_get_available_languages(parser, token):\n     your setting file (or the default settings) and\n     put it into the named variable.\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     args = token.contents.split()\n     if len(args) != 3 or args[1] != 'as':\n         raise TemplateSyntaxError(\"'get_available_languages' requires 'as variable' (got %r)\" % args)\n@@ -204,10 +205,10 @@ def do_get_language_info(parser, token):\n         {{ l.name_local }}\n         {{ l.bidi|yesno:\"bi-directional,uni-directional\" }}\n     \"\"\"\n-    args = token.contents.split()\n+    args = token.split_contents()\n     if len(args) != 5 or args[1] != 'for' or args[3] != 'as':\n         raise TemplateSyntaxError(\"'%s' requires 'for string as variable' (got %r)\" % (args[0], args[1:]))\n-    return GetLanguageInfoNode(args[2], args[4])\n+    return GetLanguageInfoNode(parser.compile_filter(args[2]), args[4])\n \n @register.tag(\"get_language_info_list\")\n def do_get_language_info_list(parser, token):\n@@ -227,10 +228,10 @@ def do_get_language_info_list(parser, token):\n           {{ l.bidi|yesno:\"bi-directional,uni-directional\" }}\n         {% endfor %}\n     \"\"\"\n-    args = token.contents.split()\n+    args = token.split_contents()\n     if len(args) != 5 or args[1] != 'for' or args[3] != 'as':\n         raise TemplateSyntaxError(\"'%s' requires 'for sequence as variable' (got %r)\" % (args[0], args[1:]))\n-    return GetLanguageInfoListNode(args[2], args[4])\n+    return GetLanguageInfoListNode(parser.compile_filter(args[2]), args[4])\n \n @register.filter\n def language_name(lang_code):\n@@ -257,6 +258,7 @@ def do_get_current_language(parser, token):\n     put it's value into the ``language`` context\n     variable.\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     args = token.contents.split()\n     if len(args) != 3 or args[1] != 'as':\n         raise TemplateSyntaxError(\"'get_current_language' requires 'as variable' (got %r)\" % args)\n@@ -275,6 +277,7 @@ def do_get_current_language_bidi(parser, token):\n     put it's value into the ``bidi`` context variable.\n     True indicates right-to-left layout, otherwise left-to-right\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     args = token.contents.split()\n     if len(args) != 3 or args[1] != 'as':\n         raise TemplateSyntaxError(\"'get_current_language_bidi' requires 'as variable' (got %r)\" % args)"
        },
        {
            "sha": "68437e7e601a67cf071bc7e14dbdd572f8f6c95d",
            "filename": "django/templatetags/static.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fstatic.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -27,6 +27,7 @@ def handle_token(cls, parser, token, name):\n         \"\"\"\n         Class method to parse prefix node and return a Node.\n         \"\"\"\n+        # token.split_contents() isn't useful here because tags using this method don't accept variable as arguments\n         tokens = token.contents.split()\n         if len(tokens) > 1 and tokens[1] != 'as':\n             raise template.TemplateSyntaxError("
        },
        {
            "sha": "05088e1a898a586963aa6b902285096e0c304bc7",
            "filename": "django/templatetags/tz.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Ftz.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/django%2Ftemplatetags%2Ftz.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Ftz.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -190,6 +190,7 @@ def get_current_timezone_tag(parser, token):\n     This will fetch the currently active time zone and put its name\n     into the ``TIME_ZONE`` context variable.\n     \"\"\"\n+    # token.split_contents() isn't useful here because this tag doesn't accept variable as arguments\n     args = token.contents.split()\n     if len(args) != 3 or args[1] != 'as':\n         raise TemplateSyntaxError(\"'get_current_timezone' requires \""
        },
        {
            "sha": "32035ab59e0dbe28637af214fba929f4716f654e",
            "filename": "tests/regressiontests/templates/templatetags/custom.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -12,6 +12,13 @@\n def trim(value, num):\n     return value[:num]\n \n+@register.filter\n+def noop(value, param=None):\n+    \"\"\"A noop filter that always return its first argument and does nothing with\n+    its second (optional) one.\n+    Useful for testing out whitespace in filter arguments (see #19882).\"\"\"\n+    return value\n+\n @register.simple_tag\n def no_params():\n     \"\"\"Expected no_params __doc__\"\"\""
        },
        {
            "sha": "ad5f0abe02948009255ed0f2b2d4aa2780139bf8",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/069280a6893d0f496c8f15922807939c68459ec3/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/069280a6893d0f496c8f15922807939c68459ec3/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=069280a6893d0f496c8f15922807939c68459ec3",
            "patch": "@@ -834,7 +834,7 @@ def get_template_tests(self):\n             'for-tag-empty02': (\"{% for val in values %}{{ val }}{% empty %}values array empty{% endfor %}\", {\"values\": []}, \"values array empty\"),\n             'for-tag-empty03': (\"{% for val in values %}{{ val }}{% empty %}values array not found{% endfor %}\", {}, \"values array not found\"),\n             # Ticket 19882\n-            'for-tag-filter-ws': (\"{% for x in ''|add:'a b c' %}{{ x }}{% endfor %}\", {}, 'a b c'),\n+            'for-tag-filter-ws': (\"{% load custom %}{% for x in s|noop:'x y' %}{{ x }}{% endfor %}\", {'s': 'abc'}, 'abc'),\n \n             ### IF TAG ################################################################\n             'if-tag01': (\"{% if foo %}yes{% else %}no{% endif %}\", {\"foo\": True}, \"yes\"),\n@@ -1003,6 +1003,9 @@ def get_template_tests(self):\n \n             'ifchanged-else04': ('{% for id in ids %}{% ifchanged %}***{{ id }}*{% else %}...{% endifchanged %}{{ forloop.counter }}{% endfor %}', {'ids': [1,1,2,2,2,3,4]}, '***1*1...2***2*3...4...5***3*6***4*7'),\n \n+            # Test whitespace in filter arguments\n+            'ifchanged-filter-ws': ('{% load custom %}{% for n in num %}{% ifchanged n|noop:\"x y\" %}..{% endifchanged %}{{ n }}{% endfor %}', {'num': (1,2,3)}, '..1..2..3'),\n+\n             ### IFEQUAL TAG ###########################################################\n             'ifequal01': (\"{% ifequal a b %}yes{% endifequal %}\", {\"a\": 1, \"b\": 2}, \"\"),\n             'ifequal02': (\"{% ifequal a b %}yes{% endifequal %}\", {\"a\": 1, \"b\": 1}, \"yes\"),\n@@ -1343,6 +1346,10 @@ def get_template_tests(self):\n             'i18n36': ('{% load i18n %}{% trans \"Page not found\" as page_not_found noop %}{{ page_not_found }}', {'LANGUAGE_CODE': 'de'}, \"Page not found\"),\n             'i18n37': ('{% load i18n %}{% trans \"Page not found\" as page_not_found %}{% blocktrans %}Error: {{ page_not_found }}{% endblocktrans %}', {'LANGUAGE_CODE': 'de'}, \"Error: Seite nicht gefunden\"),\n \n+            # Test whitespace in filter arguments\n+            'i18n38': ('{% load i18n custom %}{% get_language_info for \"de\"|noop:\"x y\" as l %}{{ l.code }}: {{ l.name }}/{{ l.name_local }} bidi={{ l.bidi }}', {}, 'de: German/Deutsch bidi=False'),\n+            'i18n38_2': ('{% load i18n custom %}{% get_language_info_list for langcodes|noop:\"x y\" as langs %}{% for l in langs %}{{ l.code }}: {{ l.name }}/{{ l.name_local }} bidi={{ l.bidi }}; {% endfor %}', {'langcodes': ['it', 'no']}, 'it: Italian/italiano bidi=False; no: Norwegian/norsk bidi=False; '),\n+\n             ### HANDLING OF TEMPLATE_STRING_IF_INVALID ###################################\n \n             'invalidstr01': ('{{ var|default:\"Foo\" }}', {}, ('Foo','INVALID')),\n@@ -1424,6 +1431,16 @@ def get_template_tests(self):\n                                     {'foo': 'z', 'bar': ['a', 'd']}]},\n                           'abc:xy,ad:z,'),\n \n+            # Test syntax\n+            'regroup05': ('{% regroup data by bar as %}', {},\n+                           template.TemplateSyntaxError),\n+            'regroup06': ('{% regroup data by bar thisaintright grouped %}', {},\n+                           template.TemplateSyntaxError),\n+            'regroup07': ('{% regroup data thisaintright bar as grouped %}', {},\n+                           template.TemplateSyntaxError),\n+            'regroup08': ('{% regroup data by bar as grouped toomanyargs %}', {},\n+                           template.TemplateSyntaxError),\n+\n             ### SSI TAG ########################################################\n \n             # Test normal behavior\n@@ -1492,6 +1509,9 @@ def get_template_tests(self):\n             'widthratio14a': ('{% widthratio a b c %}', {'a':0,'b':100,'c':'c'}, template.TemplateSyntaxError),\n             'widthratio14b': ('{% widthratio a b c %}', {'a':0,'b':100,'c':None}, template.TemplateSyntaxError),\n \n+            # Test whitespace in filter argument\n+            'widthratio15': ('{% load custom %}{% widthratio a|noop:\"x y\" b 0 %}', {'a':50,'b':100}, '0'),\n+\n             ### WITH TAG ########################################################\n             'with01': ('{% with key=dict.key %}{{ key }}{% endwith %}', {'dict': {'key': 50}}, '50'),\n             'legacywith01': ('{% with dict.key as key %}{{ key }}{% endwith %}', {'dict': {'key': 50}}, '50'),\n@@ -1593,6 +1613,9 @@ def get_template_tests(self):\n             # Regression test for #11270.\n             'cache17': ('{% load cache %}{% cache 10 long_cache_key poem %}Some Content{% endcache %}', {'poem': 'Oh freddled gruntbuggly/Thy micturations are to me/As plurdled gabbleblotchits/On a lurgid bee/That mordiously hath bitled out/Its earted jurtles/Into a rancid festering/Or else I shall rend thee in the gobberwarts with my blurglecruncheon/See if I dont.'}, 'Some Content'),\n \n+            # Test whitespace in filter arguments\n+            'cache18': ('{% load cache custom %}{% cache 2|noop:\"x y\" cache18 %}cache18{% endcache %}', {}, 'cache18'),\n+\n \n             ### AUTOESCAPE TAG ##############################################\n             'autoescape-tag01': (\"{% autoescape off %}hello{% endautoescape %}\", {}, \"hello\"),"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 64,
        "deletions": 23
    }
}