{
    "author": "claudep",
    "message": "Fixed #20039 -- Fixed has_changed form detection for required TypedChoiceFields\n\nThanks Florian Apolloner for the report and the review.\nAlso fixes #19643.",
    "sha": "9883551d50e105b324d8071232bf420935844e43",
    "files": [
        {
            "sha": "4a07dc3542da2133bff5c9f7738dce275e2733a6",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/9883551d50e105b324d8071232bf420935844e43/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/9883551d50e105b324d8071232bf420935844e43/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=9883551d50e105b324d8071232bf420935844e43",
            "patch": "@@ -778,14 +778,15 @@ def validate(self, value):\n \n     def valid_value(self, value):\n         \"Check to see if the provided value is a valid choice\"\n+        text_value = force_text(value)\n         for k, v in self.choices:\n             if isinstance(v, (list, tuple)):\n                 # This is an optgroup, so look inside the group for options\n                 for k2, v2 in v:\n-                    if value == smart_text(k2):\n+                    if value == k2 or text_value == force_text(k2):\n                         return True\n             else:\n-                if value == smart_text(k):\n+                if value == k or text_value == force_text(k):\n                     return True\n         return False\n \n@@ -801,7 +802,6 @@ def to_python(self, value):\n         right type.\n         \"\"\"\n         value = super(TypedChoiceField, self).to_python(value)\n-        super(TypedChoiceField, self).validate(value)\n         if value == self.empty_value or value in self.empty_values:\n             return self.empty_value\n         try:\n@@ -810,9 +810,6 @@ def to_python(self, value):\n             raise ValidationError(self.error_messages['invalid_choice'] % {'value': value})\n         return value\n \n-    def validate(self, value):\n-        pass\n-\n \n class MultipleChoiceField(ChoiceField):\n     hidden_widget = MultipleHiddenInput\n@@ -864,7 +861,6 @@ def to_python(self, value):\n         right type.\n         \"\"\"\n         value = super(TypedMultipleChoiceField, self).to_python(value)\n-        super(TypedMultipleChoiceField, self).validate(value)\n         if value == self.empty_value or value in self.empty_values:\n             return self.empty_value\n         new_value = []\n@@ -876,7 +872,11 @@ def to_python(self, value):\n         return new_value\n \n     def validate(self, value):\n-        pass\n+        if value != self.empty_value:\n+            super(TypedMultipleChoiceField, self).validate(value)\n+        elif self.required:\n+            raise ValidationError(self.error_messages['required'])\n+\n \n class ComboField(Field):\n     \"\"\""
        },
        {
            "sha": "95e14c44349ca47e0e1737be6a2cb192a4e5a420",
            "filename": "tests/forms_tests/tests/fields.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9883551d50e105b324d8071232bf420935844e43/tests%2Fforms_tests%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/9883551d50e105b324d8071232bf420935844e43/tests%2Fforms_tests%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fforms_tests%2Ftests%2Ffields.py?ref=9883551d50e105b324d8071232bf420935844e43",
            "patch": "@@ -911,6 +911,11 @@ def test_typedchoicefield_6(self):\n         f = TypedChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int, required=False, empty_value=None)\n         self.assertEqual(None, f.clean(''))\n \n+    def test_typedchoicefield_has_changed(self):\n+        # has_changed should not trigger required validation\n+        f = TypedChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int, required=True)\n+        self.assertFalse(f._has_changed(None, ''))\n+\n     # NullBooleanField ############################################################\n \n     def test_nullbooleanfield_1(self):\n@@ -1060,6 +1065,11 @@ def test_typedmultiplechoicefield_7(self):\n         f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int, required=False, empty_value=None)\n         self.assertEqual(None, f.clean([]))\n \n+    def test_typedmultiplechoicefield_has_changed(self):\n+        # has_changed should not trigger required validation\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int, required=True)\n+        self.assertFalse(f._has_changed(None, ''))\n+\n    # ComboField ##################################################################\n \n     def test_combofield_1(self):"
        },
        {
            "sha": "ba741bc16b054617cfa17825d7740c1ef198a585",
            "filename": "tests/forms_tests/tests/regressions.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9883551d50e105b324d8071232bf420935844e43/tests%2Fforms_tests%2Ftests%2Fregressions.py",
            "raw_url": "https://github.com/django/django/raw/9883551d50e105b324d8071232bf420935844e43/tests%2Fforms_tests%2Ftests%2Fregressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fforms_tests%2Ftests%2Fregressions.py?ref=9883551d50e105b324d8071232bf420935844e43",
            "patch": "@@ -61,10 +61,10 @@ class SomeForm(Form):\n         UNITS = ((b'\\xd0\\xbc\\xd0\\xb5\\xd1\\x81.', b'\\xd0\\xbc\\xd0\\xb5\\xd1\\x81.'),\n                  (b'\\xd1\\x88\\xd1\\x82.', b'\\xd1\\x88\\xd1\\x82.'))\n         f = ChoiceField(choices=UNITS)\n-        self.assertEqual(f.clean('\\u0448\\u0442.'), '\\u0448\\u0442.')\n         with warnings.catch_warnings():\n             # Ignore UnicodeWarning\n             warnings.simplefilter(\"ignore\")\n+            self.assertEqual(f.clean('\\u0448\\u0442.'), '\\u0448\\u0442.')\n             self.assertEqual(f.clean(b'\\xd1\\x88\\xd1\\x82.'), '\\u0448\\u0442.')\n \n         # Translated error messages used to be buggy."
        }
    ],
    "stats": {
        "total": 28,
        "additions": 19,
        "deletions": 9
    }
}