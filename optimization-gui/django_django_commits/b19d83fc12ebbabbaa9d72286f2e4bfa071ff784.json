{
    "author": "claudep",
    "message": "Improved input sanitizing with thousand separators\n\nFor languages with non-breaking space as thousand separator,\nstandard space input should also be allowed, as few people know\nhow to enter non-breaking space on keyboards. Refs #17217.\nThanks Alexey Boriskin for the report and initial patch.",
    "sha": "b19d83fc12ebbabbaa9d72286f2e4bfa071ff784",
    "files": [
        {
            "sha": "f0abdc2f7b558ee46bc7315d88eacf42f9217beb",
            "filename": "django/utils/formats.py",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/b19d83fc12ebbabbaa9d72286f2e4bfa071ff784/django%2Futils%2Fformats.py",
            "raw_url": "https://github.com/django/django/raw/b19d83fc12ebbabbaa9d72286f2e4bfa071ff784/django%2Futils%2Fformats.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fformats.py?ref=b19d83fc12ebbabbaa9d72286f2e4bfa071ff784",
            "patch": "@@ -1,5 +1,6 @@\n import decimal\n import datetime\n+import unicodedata\n \n from django.conf import settings\n from django.utils import dateformat, numberformat, datetime_safe\n@@ -192,16 +193,17 @@ def sanitize_separators(value):\n     Sanitizes a value according to the current decimal and\n     thousand separator setting. Used with form field input.\n     \"\"\"\n-    if settings.USE_L10N:\n+    if settings.USE_L10N and isinstance(value, six.string_types):\n+        parts = []\n         decimal_separator = get_format('DECIMAL_SEPARATOR')\n-        if isinstance(value, six.string_types):\n-            parts = []\n-            if decimal_separator in value:\n-                value, decimals = value.split(decimal_separator, 1)\n-                parts.append(decimals)\n-            if settings.USE_THOUSAND_SEPARATOR:\n-                parts.append(value.replace(get_format('THOUSAND_SEPARATOR'), ''))\n-            else:\n-                parts.append(value)\n-            value = '.'.join(reversed(parts))\n+        if decimal_separator in value:\n+            value, decimals = value.split(decimal_separator, 1)\n+            parts.append(decimals)\n+        if settings.USE_THOUSAND_SEPARATOR:\n+            thousand_sep = get_format('THOUSAND_SEPARATOR')\n+            for replacement in set([\n+                    thousand_sep, unicodedata.normalize('NFKD', thousand_sep)]):\n+                value = value.replace(replacement, '')\n+        parts.append(value)\n+        value = '.'.join(reversed(parts))\n     return value"
        },
        {
            "sha": "45d49d57661f124829af322fdffa4df2758ff20a",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/b19d83fc12ebbabbaa9d72286f2e4bfa071ff784/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b19d83fc12ebbabbaa9d72286f2e4bfa071ff784/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=b19d83fc12ebbabbaa9d72286f2e4bfa071ff784",
            "patch": "@@ -15,7 +15,7 @@\n from django.utils import translation\n from django.utils.formats import (get_format, date_format, time_format,\n     localize, localize_input, iter_format_modules, get_format_modules,\n-    number_format)\n+    number_format, sanitize_separators)\n from django.utils.importlib import import_module\n from django.utils.numberformat import format as nformat\n from django.utils._os import upath\n@@ -669,6 +669,24 @@ def test_localized_input(self):\n                 # Checking for the localized \"products_delivered\" field\n                 self.assertInHTML('<input type=\"text\" name=\"products_delivered\" value=\"12.000\" id=\"id_products_delivered\" />', form6.as_ul())\n \n+    def test_sanitize_separators(self):\n+        \"\"\"\n+        Tests django.utils.formats.sanitize_separators.\n+        \"\"\"\n+        # Non-strings are untouched\n+        self.assertEqual(sanitize_separators(123), 123)\n+\n+        with translation.override('ru', deactivate=True):\n+            # Russian locale has non-breaking space (\\xa0) as thousand separator\n+            # Check that usual space is accepted too when sanitizing inputs\n+            with self.settings(USE_THOUSAND_SEPARATOR=True):\n+                self.assertEqual(sanitize_separators('1\\xa0234\\xa0567'), '1234567')\n+                self.assertEqual(sanitize_separators('77\\xa0777,777'), '77777.777')\n+                self.assertEqual(sanitize_separators('12 345'), '12345')\n+                self.assertEqual(sanitize_separators('77 777,777'), '77777.777')\n+            with self.settings(USE_THOUSAND_SEPARATOR=True, USE_L10N=False):\n+                self.assertEqual(sanitize_separators('12\\xa0345'), '12\\xa0345')\n+\n     def test_iter_format_modules(self):\n         \"\"\"\n         Tests the iter_format_modules function."
        }
    ],
    "stats": {
        "total": 44,
        "additions": 32,
        "deletions": 12
    }
}