{
    "author": "carljm",
    "message": "Fixed #17604 - Added context-manager capability to assertTemplateUsed and assertTemplateNotUsed. Thanks Greg MÃ¼llegger.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17412 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a678e9ea6589bd95d9d30e86a50d3694ebf60908",
    "files": [
        {
            "sha": "2e011e4ceae6ba0958db95929bfd8f20a1aab96d",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 75,
            "deletions": 5,
            "changes": 80,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908",
            "patch": "@@ -3,6 +3,7 @@\n import os\n import re\n import sys\n+from copy import copy\n from functools import wraps\n from urlparse import urlsplit, urlunsplit\n from xml.dom.minidom import parseString, Node\n@@ -28,8 +29,10 @@\n from django.http import QueryDict\n from django.test import _doctest as doctest\n from django.test.client import Client\n+from django.test.signals import template_rendered\n from django.test.utils import (get_warnings_state, restore_warnings_state,\n     override_settings)\n+from django.test.utils import ContextList\n from django.utils import simplejson, unittest as ut2\n from django.utils.encoding import smart_str, force_unicode\n from django.views.static import serve\n@@ -260,8 +263,53 @@ def __exit__(self, exc_type, exc_value, traceback):\n         )\n \n \n-class SimpleTestCase(ut2.TestCase):\n+class _AssertTemplateUsedContext(object):\n+    def __init__(self, test_case, template_name):\n+        self.test_case = test_case\n+        self.template_name = template_name\n+        self.rendered_templates = []\n+        self.rendered_template_names = []\n+        self.context = ContextList()\n+\n+    def on_template_render(self, sender, signal, template, context, **kwargs):\n+        self.rendered_templates.append(template)\n+        self.rendered_template_names.append(template.name)\n+        self.context.append(copy(context))\n+\n+    def test(self):\n+        return self.template_name in self.rendered_template_names\n+\n+    def message(self):\n+        return u'%s was not rendered.' % self.template_name\n+\n+    def __enter__(self):\n+        template_rendered.connect(self.on_template_render)\n+        return self\n+\n+    def __exit__(self, exc_type, exc_value, traceback):\n+        template_rendered.disconnect(self.on_template_render)\n+        if exc_type is not None:\n+            return\n \n+        if not self.test():\n+            message = self.message()\n+            if len(self.rendered_templates) == 0:\n+                message += u' No template was rendered.'\n+            else:\n+                message += u' Following templates were rendered: %s' % (\n+                    ', '.join(self.rendered_template_names))\n+            self.test_case.fail(message)\n+\n+\n+class _AssertTemplateNotUsedContext(_AssertTemplateUsedContext):\n+    def test(self):\n+        return self.template_name not in self.rendered_template_names\n+\n+    def message(self):\n+        return u'%s was rendered.' % self.template_name\n+\n+\n+class SimpleTestCase(ut2.TestCase):\n     def save_warnings_state(self):\n         \"\"\"\n         Saves the state of the warnings module\n@@ -612,14 +660,25 @@ def assertFormError(self, response, form, field, errors, msg_prefix=''):\n             self.fail(msg_prefix + \"The form '%s' was not used to render the\"\n                       \" response\" % form)\n \n-    def assertTemplateUsed(self, response, template_name, msg_prefix=''):\n+    def assertTemplateUsed(self, response=None, template_name=None, msg_prefix=''):\n         \"\"\"\n         Asserts that the template with the provided name was used in rendering\n-        the response.\n+        the response. Also useable as context manager.\n         \"\"\"\n+        if response is None and template_name is None:\n+            raise TypeError(u'response and/or template_name argument must be provided')\n+\n         if msg_prefix:\n             msg_prefix += \": \"\n \n+        # use assertTemplateUsed as context manager\n+        if not hasattr(response, 'templates') or (response is None and template_name):\n+            if response:\n+                template_name = response\n+                response = None\n+            context = _AssertTemplateUsedContext(self, template_name)\n+            return context\n+\n         template_names = [t.name for t in response.templates]\n         if not template_names:\n             self.fail(msg_prefix + \"No templates used to render the response\")\n@@ -628,14 +687,25 @@ def assertTemplateUsed(self, response, template_name, msg_prefix=''):\n             \" the response. Actual template(s) used: %s\" %\n                 (template_name, u', '.join(template_names)))\n \n-    def assertTemplateNotUsed(self, response, template_name, msg_prefix=''):\n+    def assertTemplateNotUsed(self, response=None, template_name=None, msg_prefix=''):\n         \"\"\"\n         Asserts that the template with the provided name was NOT used in\n-        rendering the response.\n+        rendering the response. Also useable as context manager.\n         \"\"\"\n+        if response is None and template_name is None:\n+            raise TypeError(u'response and/or template_name argument must be provided')\n+\n         if msg_prefix:\n             msg_prefix += \": \"\n \n+        # use assertTemplateUsed as context manager\n+        if not hasattr(response, 'templates') or (response is None and template_name):\n+            if response:\n+                template_name = response\n+                response = None\n+            context = _AssertTemplateNotUsedContext(self, template_name)\n+            return context\n+\n         template_names = [t.name for t in response.templates]\n         self.assertFalse(template_name in template_names,\n             msg_prefix + \"Template '%s' was used unexpectedly in rendering\""
        },
        {
            "sha": "f2c97f603a76bea22082a730340b3364ba5a1f27",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908",
            "patch": "@@ -946,6 +946,21 @@ apply URL escaping again. This is wrong for URLs whose unquoted form contains\n a ``%xx`` sequence, but such URLs are very unlikely to happen in the wild,\n since they would confuse browsers too.\n \n+``assertTemplateUsed`` and ``assertTemplateNotUsed`` as context manager\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+It is now possible to check whether a template was used or not in a block of\n+code with the :meth:`~django.test.testcase.TestCase.assertTemplateUsed` and\n+:meth:`~django.test.testcase.TestCase.assertTemplateNotUsed` assertions. They\n+can be used as a context manager::\n+\n+    with self.assertTemplateUsed('index.html'):\n+        render_to_string('index.html')\n+    with self.assertTemplateNotUsed('base.html'):\n+        render_to_string('index.html')\n+\n+See the :ref:`assertion documentation<assertions>` for more information.\n+\n Database connections after running the test suite\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "f0f0b445f9a9aa5268bc2860ff1ca0755d9f43b0",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908",
            "patch": "@@ -1575,11 +1575,30 @@ your test suite.\n \n     The name is a string such as ``'admin/index.html'``.\n \n+    .. versionadded:: 1.4\n+\n+    You can also use this as a context manager. The code that is executed\n+    under the with statement is then observed instead of a response::\n+\n+        # This is necessary in Python 2.5 to enable the with statement, in 2.6\n+        # and up it is no longer necessary.\n+        from __future__ import with_statement\n+\n+        with self.assertTemplateUsed('index.html'):\n+            render_to_string('index.html')\n+        with self.assertTemplateUsed(template_name='index.html'):\n+            render_to_string('index.html')\n+\n .. method:: TestCase.assertTemplateNotUsed(response, template_name, msg_prefix='')\n \n     Asserts that the template with the given name was *not* used in rendering\n     the response.\n \n+    .. versionadded:: 1.4\n+\n+    You can use this as a context manager in the same way as\n+    :func:`~TestCase.assertTemplateUsed`.\n+\n .. method:: TestCase.assertRedirects(response, expected_url, status_code=302, target_status_code=200, msg_prefix='')\n \n     Asserts that the response return a ``status_code`` redirect status, it"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/test_utils/templates/template_used/alternative.html",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Falternative.html",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Falternative.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Falternative.html?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/test_utils/templates/template_used/base.html",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Fbase.html",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Fbase.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Fbase.html?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908"
        },
        {
            "sha": "d14bfa27790e5683c18c054bf28d47c0247119cc",
            "filename": "tests/regressiontests/test_utils/templates/template_used/extends.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Fextends.html",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Fextends.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Fextends.html?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908",
            "patch": "@@ -0,0 +1 @@\n+{% extends \"template_used/base.html\" %}"
        },
        {
            "sha": "2d6c954f3843fa189de12cbeb520c6c582917723",
            "filename": "tests/regressiontests/test_utils/templates/template_used/include.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Finclude.html",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Finclude.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftemplates%2Ftemplate_used%2Finclude.html?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908",
            "patch": "@@ -0,0 +1 @@\n+{% include \"template_used/base.html\" %}"
        },
        {
            "sha": "b578bffc1a30118eeb1c37bfb977e77d8ffbf223",
            "filename": "tests/regressiontests/test_utils/tests.py",
            "status": "modified",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/django/django/blob/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a678e9ea6589bd95d9d30e86a50d3694ebf60908/tests%2Fregressiontests%2Ftest_utils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftests.py?ref=a678e9ea6589bd95d9d30e86a50d3694ebf60908",
            "patch": "@@ -1,6 +1,7 @@\n from __future__ import with_statement, absolute_import\n \n from django.forms import EmailField, IntegerField\n+from django.template.loader import render_to_string\n from django.test import SimpleTestCase, TestCase, skipUnlessDBFeature\n from django.utils.unittest import skip\n \n@@ -88,6 +89,92 @@ def test_with_client(self):\n             self.client.get(\"/test_utils/get_person/%s/\" % person.pk)\n \n \n+class AssertTemplateUsedContextManagerTests(TestCase):\n+    def test_usage(self):\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            render_to_string('template_used/base.html')\n+\n+        with self.assertTemplateUsed(template_name='template_used/base.html'):\n+            render_to_string('template_used/base.html')\n+\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            render_to_string('template_used/include.html')\n+\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            render_to_string('template_used/extends.html')\n+\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            render_to_string('template_used/base.html')\n+            render_to_string('template_used/base.html')\n+\n+    def test_nested_usage(self):\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            with self.assertTemplateUsed('template_used/include.html'):\n+                render_to_string('template_used/include.html')\n+\n+        with self.assertTemplateUsed('template_used/extends.html'):\n+            with self.assertTemplateUsed('template_used/base.html'):\n+                render_to_string('template_used/extends.html')\n+\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            with self.assertTemplateUsed('template_used/alternative.html'):\n+                render_to_string('template_used/alternative.html')\n+            render_to_string('template_used/base.html')\n+\n+        with self.assertTemplateUsed('template_used/base.html'):\n+            render_to_string('template_used/extends.html')\n+            with self.assertTemplateNotUsed('template_used/base.html'):\n+                render_to_string('template_used/alternative.html')\n+            render_to_string('template_used/base.html')\n+\n+    def test_not_used(self):\n+        with self.assertTemplateNotUsed('template_used/base.html'):\n+            pass\n+        with self.assertTemplateNotUsed('template_used/alternative.html'):\n+            pass\n+\n+    def test_error_message(self):\n+        try:\n+            with self.assertTemplateUsed('template_used/base.html'):\n+                pass\n+        except AssertionError, e:\n+            self.assertTrue('template_used/base.html' in e.message)\n+\n+        try:\n+            with self.assertTemplateUsed(template_name='template_used/base.html'):\n+                pass\n+        except AssertionError, e:\n+            self.assertTrue('template_used/base.html' in e.message)\n+\n+        try:\n+            with self.assertTemplateUsed('template_used/base.html'):\n+                render_to_string('template_used/alternative.html')\n+        except AssertionError, e:\n+            self.assertTrue('template_used/base.html' in e.message, e.message)\n+            self.assertTrue('template_used/alternative.html' in e.message, e.message)\n+\n+    def test_failure(self):\n+        with self.assertRaises(TypeError):\n+            with self.assertTemplateUsed():\n+                pass\n+\n+        with self.assertRaises(AssertionError):\n+            with self.assertTemplateUsed(''):\n+                pass\n+\n+        with self.assertRaises(AssertionError):\n+            with self.assertTemplateUsed(''):\n+                render_to_string('template_used/base.html')\n+\n+        with self.assertRaises(AssertionError):\n+            with self.assertTemplateUsed(template_name=''):\n+                pass\n+\n+        with self.assertRaises(AssertionError):\n+            with self.assertTemplateUsed('template_used/base.html'):\n+                render_to_string('template_used/alternative.html')\n+\n+\n class SaveRestoreWarningState(TestCase):\n     def test_save_restore_warnings_state(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 203,
        "additions": 198,
        "deletions": 5
    }
}