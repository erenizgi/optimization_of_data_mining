{
    "author": "jezdez",
    "message": "Fixed #15960 -- Extended list filer API added in r16144 slightly to pass the current model admin to the SimpleListFilter.lookups method to support finer grained control over what is filtered over. Many thanks to Carl Meyer and Julien Phalip for the suggestion and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16152 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "95dc7c74868a2c829e8589f28fe292af062b8c68",
    "files": [
        {
            "sha": "c1fc9790c0c8b58c20552cb793df15750dd835ce",
            "filename": "django/contrib/admin/filters.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/95dc7c74868a2c829e8589f28fe292af062b8c68/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "raw_url": "https://github.com/django/django/raw/95dc7c74868a2c829e8589f28fe292af062b8c68/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilters.py?ref=95dc7c74868a2c829e8589f28fe292af062b8c68",
            "patch": "@@ -63,10 +63,10 @@ def __init__(self, request, params, model, model_admin):\n             raise ImproperlyConfigured(\n                 \"The list filter '%s' does not specify \"\n                 \"a 'parameter_name'.\" % self.__class__.__name__)\n-        lookup_choices = self.lookups(request)\n+        lookup_choices = self.lookups(request, model_admin)\n         if lookup_choices is None:\n             lookup_choices = ()\n-        self.lookup_choices = lookup_choices\n+        self.lookup_choices = list(lookup_choices)\n \n     def has_output(self):\n         return len(self.lookup_choices) > 0\n@@ -78,7 +78,7 @@ def value(self):\n         \"\"\"\n         return self.params.get(self.parameter_name, None)\n \n-    def lookups(self, request):\n+    def lookups(self, request, model_admin):\n         \"\"\"\n         Must be overriden to return a list of tuples (value, verbose value)\n         \"\"\""
        },
        {
            "sha": "fb48ba8119d69f2ebe3ea6efdf56e03eafe44e1b",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 32,
            "deletions": 13,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/95dc7c74868a2c829e8589f28fe292af062b8c68/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/95dc7c74868a2c829e8589f28fe292af062b8c68/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=95dc7c74868a2c829e8589f28fe292af062b8c68",
            "patch": "@@ -555,9 +555,7 @@ subclass::\n           attributes to and override the ``lookups`` and ``queryset`` methods,\n           e.g.::\n \n-               from django.db.models import Q\n                from django.utils.translation import ugettext_lazy as _\n-\n                from django.contrib.admin import SimpleListFilter\n \n                class DecadeBornListFilter(SimpleListFilter):\n@@ -568,7 +566,7 @@ subclass::\n                    # Parameter for the filter that will be used in the URL query.\n                    parameter_name = 'decade'\n \n-                   def lookups(self, request):\n+                   def lookups(self, request, model_admin):\n                        \"\"\"\n                        Returns a list of tuples. The first element in each\n                        tuple is the coded value for the option that will\n@@ -577,42 +575,63 @@ subclass::\n                        in the right sidebar.\n                        \"\"\"\n                        return (\n-                           ('80s', 'in the eighties'),\n-                           ('other', 'other'),\n+                           ('80s', _('in the eighties')),\n+                           ('90s', _('in the nineties')),\n                        )\n \n                    def queryset(self, request, queryset):\n                        \"\"\"\n                        Returns the filtered queryset based on the value\n                        provided in the query string and retrievable via\n-                       ``value()``.\n+                       `self.value()`.\n                        \"\"\"\n                        # Compare the requested value (either '80s' or 'other')\n                        # to decide how to filter the queryset.\n                        if self.value() == '80s':\n                            return queryset.filter(birthday__year__gte=1980,\n                                                    birthday__year__lte=1989)\n-                       if self.value() == 'other':\n-                           return queryset.filter(Q(year__lte=1979) |\n-                                                   Q(year__gte=1990))\n+                       if self.value() == '90s':\n+                           return queryset.filter(birthday__year__gte=1990,\n+                                                  birthday__year__lte=1999)\n \n                class PersonAdmin(ModelAdmin):\n                    list_filter = (DecadeBornListFilter,)\n \n           .. note::\n \n               As a convenience, the ``HttpRequest`` object is passed to the\n-              filter's methods, for example::\n+              ``lookups`` and ``queryset`` methods, for example::\n \n                   class AuthDecadeBornListFilter(DecadeBornListFilter):\n \n-                      def lookups(self, request):\n+                      def lookups(self, request, model_admin):\n                           if request.user.is_superuser:\n-                              return super(AuthDecadeBornListFilter, self).lookups(request)\n+                              return super(AuthDecadeBornListFilter,\n+                                  self).lookups(request, model_admin)\n \n                       def queryset(self, request, queryset):\n                           if request.user.is_superuser:\n-                              return super(AuthDecadeBornListFilter, self).queryset(request, queryset)\n+                              return super(AuthDecadeBornListFilter,\n+                                  self).queryset(request, queryset)\n+\n+              Also as a convenience, the ``ModelAdmin`` object is passed to\n+              the ``lookups`` method, for example if you want to base the\n+              lookups on the available data::\n+\n+                  class AdvancedDecadeBornListFilter(DecadeBornListFilter):\n+\n+                      def lookups(self, request, model_admin):\n+                          \"\"\"\n+                          Only show the lookups if there actually is\n+                          anyone born in the corresponding decades.\n+                          \"\"\"\n+                          qs = model_admin.queryset(request)\n+                          if qs.filter(birthday__year__gte=1980,\n+                                        birthday__year__lte=1989).exists():\n+                              yield ('80s', _('in the eighties'))\n+                          if qs.filter(birthday__year__gte=1990,\n+                                        birthday__year__lte=1999).exists():\n+                              yield ('90s', _('in the nineties'))\n \n         * a tuple, where the first element is a field name and the second\n           element is a class inheriting from"
        },
        {
            "sha": "7717984014d21289e945e0bda5629a45ffde3cf1",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 67,
            "deletions": 11,
            "changes": 78,
            "blob_url": "https://github.com/django/django/blob/95dc7c74868a2c829e8589f28fe292af062b8c68/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/95dc7c74868a2c829e8589f28fe292af062b8c68/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=95dc7c74868a2c829e8589f28fe292af062b8c68",
            "patch": "@@ -19,15 +19,18 @@ def select_by(dictlist, key, value):\n \n class DecadeListFilter(SimpleListFilter):\n \n-    def lookups(self, request):\n+    def lookups(self, request, model_admin):\n         return (\n+            ('the 80s', \"the 1980's\"),\n             ('the 90s', \"the 1990's\"),\n             ('the 00s', \"the 2000's\"),\n             ('other', \"other decades\"),\n         )\n \n     def queryset(self, request, queryset):\n         decade = self.value()\n+        if decade == 'the 80s':\n+            return queryset.filter(year__gte=1980, year__lte=1989)\n         if decade == 'the 90s':\n             return queryset.filter(year__gte=1990, year__lte=1999)\n         if decade == 'the 00s':\n@@ -45,9 +48,20 @@ class DecadeListFilterWithoutParameter(DecadeListFilter):\n \n class DecadeListFilterWithNoneReturningLookups(DecadeListFilterWithTitleAndParameter):\n \n-    def lookups(self, request):\n+    def lookups(self, request, model_admin):\n         pass\n \n+class DecadeListFilterWithQuerysetBasedLookups(DecadeListFilterWithTitleAndParameter):\n+\n+    def lookups(self, request, model_admin):\n+        qs = model_admin.queryset(request)\n+        if qs.filter(year__gte=1980, year__lte=1989).exists():\n+            yield ('the 80s', \"the 1980's\")\n+        if qs.filter(year__gte=1990, year__lte=1999).exists():\n+            yield ('the 90s', \"the 1990's\")\n+        if qs.filter(year__gte=2000, year__lte=2009).exists():\n+            yield ('the 00s', \"the 2000's\")\n+\n class CustomUserAdmin(UserAdmin):\n     list_filter = ('books_authored', 'books_contributed')\n \n@@ -68,6 +82,9 @@ class DecadeFilterBookAdminWithoutParameter(ModelAdmin):\n class DecadeFilterBookAdminWithNoneReturningLookups(ModelAdmin):\n     list_filter = (DecadeListFilterWithNoneReturningLookups,)\n \n+class DecadeFilterBookAdminWithQuerysetBasedLookups(ModelAdmin):\n+    list_filter = (DecadeListFilterWithQuerysetBasedLookups,)\n+\n class ListFiltersTests(TestCase):\n \n     def setUp(self):\n@@ -385,6 +402,23 @@ def test_simplelistfilter(self):\n         self.assertEqual(choices[0]['selected'], True)\n         self.assertEqual(choices[0]['query_string'], '?')\n \n+        # Look for books in the 1980s ----------------------------------------\n+\n+        request = self.request_factory.get('/', {'publication-decade': 'the 80s'})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        # Make sure the correct queryset is returned\n+        queryset = changelist.get_query_set(request)\n+        self.assertEqual(list(queryset), [])\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][1]\n+        self.assertEqual(force_unicode(filterspec.title), u'publication decade')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEqual(choices[1]['display'], u'the 1980\\'s')\n+        self.assertEqual(choices[1]['selected'], True)\n+        self.assertEqual(choices[1]['query_string'], '?publication-decade=the+80s')\n+\n         # Look for books in the 1990s ----------------------------------------\n \n         request = self.request_factory.get('/', {'publication-decade': 'the 90s'})\n@@ -398,9 +432,9 @@ def test_simplelistfilter(self):\n         filterspec = changelist.get_filters(request)[0][1]\n         self.assertEqual(force_unicode(filterspec.title), u'publication decade')\n         choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[1]['display'], u'the 1990\\'s')\n-        self.assertEqual(choices[1]['selected'], True)\n-        self.assertEqual(choices[1]['query_string'], '?publication-decade=the+90s')\n+        self.assertEqual(choices[2]['display'], u'the 1990\\'s')\n+        self.assertEqual(choices[2]['selected'], True)\n+        self.assertEqual(choices[2]['query_string'], '?publication-decade=the+90s')\n \n         # Look for books in the 2000s ----------------------------------------\n \n@@ -415,9 +449,9 @@ def test_simplelistfilter(self):\n         filterspec = changelist.get_filters(request)[0][1]\n         self.assertEqual(force_unicode(filterspec.title), u'publication decade')\n         choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[2]['display'], u'the 2000\\'s')\n-        self.assertEqual(choices[2]['selected'], True)\n-        self.assertEqual(choices[2]['query_string'], '?publication-decade=the+00s')\n+        self.assertEqual(choices[3]['display'], u'the 2000\\'s')\n+        self.assertEqual(choices[3]['selected'], True)\n+        self.assertEqual(choices[3]['query_string'], '?publication-decade=the+00s')\n \n         # Combine multiple filters -------------------------------------------\n \n@@ -432,9 +466,9 @@ def test_simplelistfilter(self):\n         filterspec = changelist.get_filters(request)[0][1]\n         self.assertEqual(force_unicode(filterspec.title), u'publication decade')\n         choices = list(filterspec.choices(changelist))\n-        self.assertEqual(choices[2]['display'], u'the 2000\\'s')\n-        self.assertEqual(choices[2]['selected'], True)\n-        self.assertEqual(choices[2]['query_string'], '?publication-decade=the+00s&author__id__exact=%s' % self.alfred.pk)\n+        self.assertEqual(choices[3]['display'], u'the 2000\\'s')\n+        self.assertEqual(choices[3]['selected'], True)\n+        self.assertEqual(choices[3]['query_string'], '?publication-decade=the+00s&author__id__exact=%s' % self.alfred.pk)\n \n         filterspec = changelist.get_filters(request)[0][0]\n         self.assertEqual(force_unicode(filterspec.title), u'author')\n@@ -472,3 +506,25 @@ def test_simplelistfilter_with_none_returning_lookups(self):\n         changelist = self.get_changelist(request, Book, modeladmin)\n         filterspec = changelist.get_filters(request)[0]\n         self.assertEqual(len(filterspec), 0)\n+\n+    def test_simplelistfilter_with_queryset_based_lookups(self):\n+        modeladmin = DecadeFilterBookAdminWithQuerysetBasedLookups(Book, site)\n+        request = self.request_factory.get('/', {})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEqual(force_unicode(filterspec.title), u'publication decade')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEqual(len(choices), 3)\n+\n+        self.assertEqual(choices[0]['display'], u'All')\n+        self.assertEqual(choices[0]['selected'], True)\n+        self.assertEqual(choices[0]['query_string'], '?')\n+\n+        self.assertEqual(choices[1]['display'], u'the 1990\\'s')\n+        self.assertEqual(choices[1]['selected'], False)\n+        self.assertEqual(choices[1]['query_string'], '?publication-decade=the+90s')\n+\n+        self.assertEqual(choices[2]['display'], u'the 2000\\'s')\n+        self.assertEqual(choices[2]['selected'], False)\n+        self.assertEqual(choices[2]['query_string'], '?publication-decade=the+00s')"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 102,
        "deletions": 27
    }
}