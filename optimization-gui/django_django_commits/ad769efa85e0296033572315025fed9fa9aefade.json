{
    "author": "ramiro",
    "message": "Expanded tests added when fixing #14529.\n\nTo make sure changes in 35d1cd0 don't break anything. Refs #19505.",
    "sha": "ad769efa85e0296033572315025fed9fa9aefade",
    "files": [
        {
            "sha": "435883e637a07496a44f36a5cfec6964105da5e0",
            "filename": "tests/regressiontests/admin_views/admin.py",
            "status": "modified",
            "additions": 38,
            "deletions": 6,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/ad769efa85e0296033572315025fed9fa9aefade/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/ad769efa85e0296033572315025fed9fa9aefade/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py?ref=ad769efa85e0296033572315025fed9fa9aefade",
            "patch": "@@ -27,7 +27,8 @@\n     Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug,\n     AdminOrderedField, AdminOrderedModelMethod, AdminOrderedAdminMethod,\n     AdminOrderedCallable, Report, Color2, UnorderedObject, MainPrepopulated,\n-    RelatedPrepopulated, UndeletableObject, UserMessenger, Simple, Choice)\n+    RelatedPrepopulated, UndeletableObject, UserMessenger, Simple, Choice,\n+    ShortMessage, Telegram)\n \n \n def callable_year(dt_value):\n@@ -439,25 +440,54 @@ class FoodDeliveryAdmin(admin.ModelAdmin):\n     list_editable = ('driver', 'restaurant')\n \n \n+class CoverLetterAdmin(admin.ModelAdmin):\n+    \"\"\"\n+    A ModelAdmin with a custom queryset() method that uses defer(), to test\n+    verbose_name display in messages shown after adding/editing CoverLetter\n+    instances.\n+    Note that the CoverLetter model defines a __unicode__ method.\n+    For testing fix for ticket #14529.\n+    \"\"\"\n+\n+    def queryset(self, request):\n+        return super(CoverLetterAdmin, self).queryset(request).defer('date_written')\n+\n+\n class PaperAdmin(admin.ModelAdmin):\n     \"\"\"\n     A ModelAdmin with a custom queryset() method that uses only(), to test\n-    verbose_name display in messages shown after adding Paper instances.\n+    verbose_name display in messages shown after adding/editing Paper\n+    instances.\n+    For testing fix for ticket #14529.\n     \"\"\"\n \n     def queryset(self, request):\n         return super(PaperAdmin, self).queryset(request).only('title')\n \n \n-class CoverLetterAdmin(admin.ModelAdmin):\n+class ShortMessageAdmin(admin.ModelAdmin):\n+    \"\"\"\n+    A ModelAdmin with a custom queryset() method that uses defer(), to test\n+    verbose_name display in messages shown after adding/editing ShortMessage\n+    instances.\n+    For testing fix for ticket #14529.\n+    \"\"\"\n+\n+    def queryset(self, request):\n+        return super(ShortMessageAdmin, self).queryset(request).defer('timestamp')\n+\n+\n+class TelegramAdmin(admin.ModelAdmin):\n     \"\"\"\n     A ModelAdmin with a custom queryset() method that uses only(), to test\n-    verbose_name display in messages shown after adding CoverLetter instances.\n-    Note that the CoverLetter model defines a __unicode__ method.\n+    verbose_name display in messages shown after adding/editing Telegram\n+    instances.\n+    Note that the Telegram model defines a __unicode__ method.\n+    For testing fix for ticket #14529.\n     \"\"\"\n \n     def queryset(self, request):\n-        return super(CoverLetterAdmin, self).queryset(request).defer('date_written')\n+        return super(TelegramAdmin, self).queryset(request).only('title')\n \n \n class StoryForm(forms.ModelForm):\n@@ -665,6 +695,8 @@ class ChoiceList(admin.ModelAdmin):\n site.register(RowLevelChangePermissionModel, RowLevelChangePermissionModelAdmin)\n site.register(Paper, PaperAdmin)\n site.register(CoverLetter, CoverLetterAdmin)\n+site.register(ShortMessage, ShortMessageAdmin)\n+site.register(Telegram, TelegramAdmin)\n site.register(Story, StoryAdmin)\n site.register(OtherStory, OtherStoryAdmin)\n site.register(Report, ReportAdmin)"
        },
        {
            "sha": "5e25f0d54274220bf1a987446424d682c2bbd03f",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/ad769efa85e0296033572315025fed9fa9aefade/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/ad769efa85e0296033572315025fed9fa9aefade/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=ad769efa85e0296033572315025fed9fa9aefade",
            "patch": "@@ -548,18 +548,32 @@ class Meta:\n         unique_together = ((\"driver\", \"restaurant\"),)\n \n \n+@python_2_unicode_compatible\n+class CoverLetter(models.Model):\n+    author = models.CharField(max_length=30)\n+    date_written = models.DateField(null=True, blank=True)\n+\n+    def __str__(self):\n+        return self.author\n+\n+\n class Paper(models.Model):\n     title = models.CharField(max_length=30)\n     author = models.CharField(max_length=30, blank=True, null=True)\n \n \n+class ShortMessage(models.Model):\n+    content = models.CharField(max_length=140)\n+    timestamp = models.DateTimeField(null=True, blank=True)\n+\n+\n @python_2_unicode_compatible\n-class CoverLetter(models.Model):\n-    author = models.CharField(max_length=30)\n-    date_written = models.DateField(null=True, blank=True)\n+class Telegram(models.Model):\n+    title = models.CharField(max_length=30)\n+    date_sent = models.DateField(null=True, blank=True)\n \n     def __str__(self):\n-        return self.author\n+        return self.title\n \n \n class Story(models.Model):"
        },
        {
            "sha": "e886078ae5965eac12f0661023c414e042de095a",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 152,
            "deletions": 11,
            "changes": 163,
            "blob_url": "https://github.com/django/django/blob/ad769efa85e0296033572315025fed9fa9aefade/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ad769efa85e0296033572315025fed9fa9aefade/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=ad769efa85e0296033572315025fed9fa9aefade",
            "patch": "@@ -47,7 +47,7 @@\n     OtherStory, ComplexSortedPerson, Parent, Child, AdminOrderedField,\n     AdminOrderedModelMethod, AdminOrderedAdminMethod, AdminOrderedCallable,\n     Report, MainPrepopulated, RelatedPrepopulated, UnorderedObject,\n-    Simple, UndeletableObject, Choice)\n+    Simple, UndeletableObject, Choice, ShortMessage, Telegram)\n \n \n ERROR_MESSAGE = \"Please enter the correct username and password \\\n@@ -2505,36 +2505,177 @@ def test_change_view(self):\n             else:\n                 self.assertEqual(response.status_code, 404)\n \n+    def test_add_model_modeladmin_defer_qs(self):\n+        # Test for #14529. defer() is used in ModelAdmin.queryset()\n+\n+        # model has __unicode__ method\n+        self.assertEqual(CoverLetter.objects.count(), 0)\n+        # Emulate model instance creation via the admin\n+        post_data = {\n+            \"author\": \"Candidate, Best\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/coverletter/add/',\n+                                    post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(CoverLetter.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The cover letter &quot;Candidate, Best&quot; was added successfully.</li>',\n+            html=True\n+        )\n+\n+        # model has no __unicode__ method\n+        self.assertEqual(ShortMessage.objects.count(), 0)\n+        # Emulate model instance creation via the admin\n+        post_data = {\n+            \"content\": \"What's this SMS thing?\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/shortmessage/add/',\n+                post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(ShortMessage.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The short message &quot;ShortMessage object&quot; was added successfully.</li>',\n+            html=True\n+        )\n+\n     def test_add_model_modeladmin_only_qs(self):\n-        # only() is used in ModelAdmin.queryset()\n-        p = Paper.objects.create(title=\"My Paper Title\")\n-        self.assertEqual(Paper.objects.count(), 1)\n-        response = self.client.get('/test_admin/admin/admin_views/paper/%s/' % p.pk)\n+        # Test for #14529. only() is used in ModelAdmin.queryset()\n+\n+        # model has __unicode__ method\n+        self.assertEqual(Telegram.objects.count(), 0)\n+        # Emulate model instance creation via the admin\n+        post_data = {\n+            \"title\": \"Urgent telegram\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/telegram/add/',\n+                post_data, follow=True)\n         self.assertEqual(response.status_code, 200)\n+        self.assertEqual(Telegram.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The telegram &quot;Urgent telegram&quot; was added successfully.</li>',\n+            html=True\n+        )\n+\n+        # model has no __unicode__ method\n+        self.assertEqual(Paper.objects.count(), 0)\n+        # Emulate model instance creation via the admin\n         post_data = {\n             \"title\": \"My Modified Paper Title\",\n             \"_save\": \"Save\",\n         }\n-        response = self.client.post('/test_admin/admin/admin_views/paper/%s/' % p.pk,\n+        response = self.client.post('/test_admin/admin/admin_views/paper/add/',\n                 post_data, follow=True)\n         self.assertEqual(response.status_code, 200)\n-        # Message should contain non-ugly model name. Instance representation is set by six.text_type() (ugly)\n-        self.assertContains(response, '<li class=\"info\">The paper &quot;Paper_Deferred_author object&quot; was changed successfully.</li>', html=True)\n+        self.assertEqual(Paper.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The paper &quot;Paper object&quot; was added successfully.</li>',\n+            html=True\n+        )\n+\n+    def test_edit_model_modeladmin_defer_qs(self):\n+        # Test for #14529. defer() is used in ModelAdmin.queryset()\n \n-        # defer() is used in ModelAdmin.queryset()\n+        # model has __unicode__ method\n         cl = CoverLetter.objects.create(author=\"John Doe\")\n         self.assertEqual(CoverLetter.objects.count(), 1)\n         response = self.client.get('/test_admin/admin/admin_views/coverletter/%s/' % cl.pk)\n         self.assertEqual(response.status_code, 200)\n+        # Emulate model instance edit via the admin\n         post_data = {\n             \"author\": \"John Doe II\",\n             \"_save\": \"Save\",\n         }\n         response = self.client.post('/test_admin/admin/admin_views/coverletter/%s/' % cl.pk,\n                 post_data, follow=True)\n         self.assertEqual(response.status_code, 200)\n-        # Message should contain non-ugly model name. Instance representation is set by model's __unicode__()\n-        self.assertContains(response, '<li class=\"info\">The cover letter &quot;John Doe II&quot; was changed successfully.</li>', html=True)\n+        self.assertEqual(CoverLetter.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name. Instance\n+        # representation is set by model's __unicode__()\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The cover letter &quot;John Doe II&quot; was changed successfully.</li>',\n+            html=True\n+        )\n+\n+        # model has no __unicode__ method\n+        sm = ShortMessage.objects.create(content=\"This is expensive\")\n+        self.assertEqual(ShortMessage.objects.count(), 1)\n+        response = self.client.get('/test_admin/admin/admin_views/shortmessage/%s/' % sm.pk)\n+        self.assertEqual(response.status_code, 200)\n+        # Emulate model instance edit via the admin\n+        post_data = {\n+            \"content\": \"Too expensive\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/shortmessage/%s/' % sm.pk,\n+                post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(ShortMessage.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name. The ugly(!)\n+        # instance representation is set by six.text_type()\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The short message &quot;ShortMessage_Deferred_timestamp object&quot; was changed successfully.</li>',\n+            html=True\n+        )\n+\n+    def test_edit_model_modeladmin_only_qs(self):\n+        # Test for #14529. only() is used in ModelAdmin.queryset()\n+\n+        # model has __unicode__ method\n+        t = Telegram.objects.create(title=\"Frist Telegram\")\n+        self.assertEqual(Telegram.objects.count(), 1)\n+        response = self.client.get('/test_admin/admin/admin_views/telegram/%s/' % t.pk)\n+        self.assertEqual(response.status_code, 200)\n+        # Emulate model instance edit via the admin\n+        post_data = {\n+            \"title\": \"Telegram without typo\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/telegram/%s/' % t.pk,\n+                post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(Telegram.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name. The instance\n+        # representation is set by model's __unicode__()\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The telegram &quot;Telegram without typo&quot; was changed successfully.</li>',\n+            html=True\n+        )\n+\n+        # model has no __unicode__ method\n+        p = Paper.objects.create(title=\"My Paper Title\")\n+        self.assertEqual(Paper.objects.count(), 1)\n+        response = self.client.get('/test_admin/admin/admin_views/paper/%s/' % p.pk)\n+        self.assertEqual(response.status_code, 200)\n+        # Emulate model instance edit via the admin\n+        post_data = {\n+            \"title\": \"My Modified Paper Title\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/paper/%s/' % p.pk,\n+                post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(Paper.objects.count(), 1)\n+        # Message should contain non-ugly model verbose name. The ugly(!)\n+        # instance representation is set by six.text_type()\n+        self.assertContains(\n+            response,\n+            '<li class=\"info\">The paper &quot;Paper_Deferred_author object&quot; was changed successfully.</li>',\n+            html=True\n+        )\n \n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))"
        }
    ],
    "stats": {
        "total": 229,
        "additions": 208,
        "deletions": 21
    }
}