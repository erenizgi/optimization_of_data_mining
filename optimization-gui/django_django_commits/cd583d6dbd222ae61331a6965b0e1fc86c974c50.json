{
    "author": "andrewgodwin",
    "message": "Implement primary key changing",
    "sha": "cd583d6dbd222ae61331a6965b0e1fc86c974c50",
    "files": [
        {
            "sha": "310f270a0b6d9d89bcf02ffd1770a721171e46ca",
            "filename": "django/db/backends/mysql/introspection.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/cd583d6dbd222ae61331a6965b0e1fc86c974c50/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py",
            "raw_url": "https://github.com/django/django/raw/cd583d6dbd222ae61331a6965b0e1fc86c974c50/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py?ref=cd583d6dbd222ae61331a6965b0e1fc86c974c50",
            "patch": "@@ -99,7 +99,12 @@ def get_indexes(self, cursor, table_name):\n         for row in rows:\n             if row[2] in multicol_indexes:\n                 continue\n-            indexes[row[4]] = {'primary_key': (row[2] == 'PRIMARY'), 'unique': not bool(row[1])}\n+            if row[4] not in indexes:\n+                indexes[row[4]] = {'primary_key': False, 'unique': False}\n+            if row[2] == 'PRIMARY':\n+                indexes[row[4]]['primary_key'] = True\n+            if not bool(row[1]):\n+                indexes[row[4]]['unique'] = True\n         return indexes\n \n     def get_constraints(self, cursor, table_name):"
        },
        {
            "sha": "08e883d80c470d778b2e7e21d44b7a50d1465fce",
            "filename": "django/db/backends/mysql/schema.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/cd583d6dbd222ae61331a6965b0e1fc86c974c50/django%2Fdb%2Fbackends%2Fmysql%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/cd583d6dbd222ae61331a6965b0e1fc86c974c50/django%2Fdb%2Fbackends%2Fmysql%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fschema.py?ref=cd583d6dbd222ae61331a6965b0e1fc86c974c50",
            "patch": "@@ -21,3 +21,6 @@ class DatabaseSchemaEditor(BaseDatabaseSchemaEditor):\n \n     alter_string_set_null = 'MODIFY %(column)s %(type)s NULL;'\n     alter_string_drop_null = 'MODIFY %(column)s %(type)s NOT NULL;'\n+\n+    sql_create_pk = \"ALTER TABLE %(table)s ADD CONSTRAINT %(name)s PRIMARY KEY (%(columns)s)\"\n+    sql_delete_pk = \"ALTER TABLE %(table)s DROP PRIMARY KEY\""
        },
        {
            "sha": "ae80f60c30087152ab847c98d8ed567470623c58",
            "filename": "django/db/backends/schema.py",
            "status": "modified",
            "additions": 35,
            "deletions": 10,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/cd583d6dbd222ae61331a6965b0e1fc86c974c50/django%2Fdb%2Fbackends%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/cd583d6dbd222ae61331a6965b0e1fc86c974c50/django%2Fdb%2Fbackends%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fschema.py?ref=cd583d6dbd222ae61331a6965b0e1fc86c974c50",
            "patch": "@@ -24,8 +24,6 @@ class BaseDatabaseSchemaEditor(object):\n         - Repointing of FKs\n         - Repointing of M2Ms\n         - Check constraints (PosIntField)\n-        - PK changing\n-        - db_index on alter field\n     \"\"\"\n \n     # Overrideable SQL templates\n@@ -57,8 +55,8 @@ class BaseDatabaseSchemaEditor(object):\n     sql_create_index = \"CREATE INDEX %(name)s ON %(table)s (%(columns)s)%(extra)s;\"\n     sql_delete_index = \"DROP INDEX %(name)s\"\n \n-    sql_create_pk = \"ALTER TABLE %(table)s ADD CONSTRAINT %(constraint)s PRIMARY KEY (%(columns)s)\"\n-    sql_delete_pk = \"ALTER TABLE %(table)s DROP CONSTRAINT %(constraint)s\"\n+    sql_create_pk = \"ALTER TABLE %(table)s ADD CONSTRAINT %(name)s PRIMARY KEY (%(columns)s)\"\n+    sql_delete_pk = \"ALTER TABLE %(table)s DROP CONSTRAINT %(name)s\"\n \n     def __init__(self, connection):\n         self.connection = connection\n@@ -135,9 +133,10 @@ def column_sql(self, model, field, include_default=False):\n         elif field.unique:\n             sql += \" UNIQUE\"\n         # If we were told to include a default value, do so\n-        if include_default:\n+        default_value = self.effective_default(field)\n+        if include_default and default_value is not None:\n             sql += \" DEFAULT %s\"\n-            params += [self.effective_default(field)]\n+            params += [default_value]\n         # Return the sql\n         return sql, params\n \n@@ -491,6 +490,32 @@ def alter_field(self, model, old_field, new_field, strict=False):\n                     \"extra\": \"\",\n                 }\n             )\n+        # Changed to become primary key?\n+        # Note that we don't detect unsetting of a PK, as we assume another field\n+        # will always come along and replace it.\n+        if not old_field.primary_key and new_field.primary_key:\n+            # First, drop the old PK\n+            constraint_names = self._constraint_names(model, primary_key=True)\n+            if strict and len(constraint_names) != 1:\n+                raise ValueError(\"Found wrong number (%s) of PK constraints for %s\" % (\n+                    len(constraint_names),\n+                    model._meta.db_table,\n+                ))\n+            for constraint_name in constraint_names:\n+                self.execute(\n+                    self.sql_delete_pk % {\n+                        \"table\": self.quote_name(model._meta.db_table),\n+                        \"name\": constraint_name,\n+                    },\n+                )\n+            # Make the new one\n+            self.execute(\n+                self.sql_create_pk % {\n+                    \"table\": self.quote_name(model._meta.db_table),\n+                    \"name\": self._create_index_name(model, [new_field.column], suffix=\"_pk\"),\n+                    \"columns\": self.quote_name(new_field.column),\n+                }\n+            )\n \n     def _type_for_alter(self, field):\n         \"\"\"\n@@ -518,16 +543,16 @@ def _create_index_name(self, model, column_names, suffix=\"\"):\n             index_name = '%s%s' % (table_name[:(self.connection.features.max_index_name_length - len(part))], part)\n         return index_name\n \n-    def _constraint_names(self, model, column_names, unique=None, primary_key=None, index=None):\n+    def _constraint_names(self, model, column_names=None, unique=None, primary_key=None, index=None):\n         \"Returns all constraint names matching the columns and conditions\"\n-        column_names = set(column_names)\n+        column_names = set(column_names) if column_names else None\n         constraints = self.connection.introspection.get_constraints(self.connection.cursor(), model._meta.db_table)\n         result = []\n         for name, infodict in constraints.items():\n-            if column_names == infodict['columns']:\n+            if column_names is None or column_names == infodict['columns']:\n                 if unique is not None and infodict['unique'] != unique:\n                     continue\n-                if primary_key is not None and infodict['primary_key'] != unique:\n+                if primary_key is not None and infodict['primary_key'] != primary_key:\n                     continue\n                 if index is not None and infodict['index'] != index:\n                     continue"
        },
        {
            "sha": "db374dc7adde01cf4ac7f974328a820692334eca",
            "filename": "tests/modeltests/schema/tests.py",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/cd583d6dbd222ae61331a6965b0e1fc86c974c50/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cd583d6dbd222ae61331a6965b0e1fc86c974c50/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Ftests.py?ref=cd583d6dbd222ae61331a6965b0e1fc86c974c50",
            "patch": "@@ -478,3 +478,37 @@ def test_indexes(self):\n             \"slug\",\n             connection.introspection.get_indexes(connection.cursor(), Book._meta.db_table),\n         )\n+\n+    def test_primary_key(self):\n+        \"\"\"\n+        Tests altering of the primary key\n+        \"\"\"\n+        # Create the table\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.create_model(Tag)\n+        editor.commit()\n+        # Ensure the table is there and has the right PK\n+        self.assertTrue(\n+            connection.introspection.get_indexes(connection.cursor(), Tag._meta.db_table)['id']['primary_key'],\n+        )\n+        # Alter to change the PK\n+        new_field = SlugField(primary_key=True)\n+        new_field.set_attributes_from_name(\"slug\")\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.delete_field(Tag, Tag._meta.get_field_by_name(\"id\")[0])\n+        editor.alter_field(\n+            Tag,\n+            Tag._meta.get_field_by_name(\"slug\")[0],\n+            new_field,\n+        )\n+        editor.commit()\n+        # Ensure the PK changed\n+        self.assertNotIn(\n+            'id',\n+            connection.introspection.get_indexes(connection.cursor(), Tag._meta.db_table),\n+        )\n+        self.assertTrue(\n+            connection.introspection.get_indexes(connection.cursor(), Tag._meta.db_table)['slug']['primary_key'],\n+        )"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 78,
        "deletions": 11
    }
}