{
    "author": "ramiro",
    "message": "Made (make|compile)messages check for availability of gettext commands.\n\nRefs #19584.",
    "sha": "7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
    "files": [
        {
            "sha": "845ad159a903d891a83b5bce975fd74afb125566",
            "filename": "django/core/management/commands/compilemessages.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py",
            "raw_url": "https://github.com/django/django/raw/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py?ref=7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
            "patch": "@@ -5,7 +5,7 @@\n from optparse import make_option\n \n from django.core.management.base import BaseCommand, CommandError\n-from django.core.management.utils import popen_wrapper\n+from django.core.management.utils import find_command, popen_wrapper\n from django.utils._os import npath\n \n def has_bom(fn):\n@@ -16,6 +16,10 @@ def has_bom(fn):\n             sample.startswith(codecs.BOM_UTF16_BE)\n \n def compile_messages(stderr, locale=None):\n+    program = 'msgfmt'\n+    if find_command(program) is None:\n+        raise CommandError(\"Can't find %s. Make sure you have GNU gettext tools 0.15 or newer installed.\" % program)\n+\n     basedirs = [os.path.join('conf', 'locale'), 'locale']\n     if os.environ.get('DJANGO_SETTINGS_MODULE'):\n         from django.conf import settings\n@@ -42,7 +46,6 @@ def compile_messages(stderr, locale=None):\n                     if has_bom(fn):\n                         raise CommandError(\"The %s file has a BOM (Byte Order Mark). Django only supports .po files encoded in UTF-8 and without any BOM.\" % fn)\n                     pf = os.path.splitext(fn)[0]\n-                    program = 'msgfmt'\n                     args = [program, '--check-format', '-o', npath(pf + '.mo'), npath(pf + '.po')]\n                     output, errors, status = popen_wrapper(args)\n                     if status:"
        },
        {
            "sha": "a7e98173ac6922fc244ab39a4c7cbeae6c7f2091",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 77,
            "deletions": 35,
            "changes": 112,
            "blob_url": "https://github.com/django/django/blob/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
            "patch": "@@ -5,11 +5,11 @@\n import sys\n from itertools import dropwhile\n from optparse import make_option\n-from subprocess import PIPE, Popen\n \n import django\n from django.core.management.base import CommandError, NoArgsCommand\n-from django.core.management.utils import handle_extensions\n+from django.core.management.utils import (handle_extensions, find_command,\n+    popen_wrapper)\n from django.utils.functional import total_ordering\n from django.utils.text import get_text_list\n from django.utils.jslex import prepare_js_for_gettext\n@@ -18,6 +18,13 @@\n STATUS_OK = 0\n \n \n+def check_programs(*programs):\n+    for program in programs:\n+        if find_command(program) is None:\n+            raise CommandError(\"Can't find %s. Make sure you have GNU \"\n+                    \"gettext tools 0.15 or newer installed.\" % program)\n+\n+\n @total_ordering\n class TranslatableFile(object):\n     def __init__(self, dirpath, file_name):\n@@ -58,12 +65,24 @@ def process(self, command, potfile, domain, keep_pot=False):\n             work_file = os.path.join(self.dirpath, thefile)\n             with open(work_file, \"w\") as fp:\n                 fp.write(src_data)\n-            cmd = (\n-                'xgettext -d %s -L C %s %s --keyword=gettext_noop '\n-                '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n-                '--keyword=pgettext:1c,2 --keyword=npgettext:1c,2,3 '\n-                '--from-code UTF-8 --add-comments=Translators -o - \"%s\"' %\n-                (domain, command.wrap, command.location, work_file))\n+            args = [\n+                'xgettext',\n+                '-d', domain,\n+                '--language=C',\n+                '--keyword=gettext_noop',\n+                '--keyword=gettext_lazy',\n+                '--keyword=ngettext_lazy:1,2',\n+                '--keyword=pgettext:1c,2',\n+                '--keyword=npgettext:1c,2,3',\n+                '--from-code=UTF-8',\n+                '--add-comments=Translators',\n+                '--output=-'\n+            ]\n+            if command.wrap:\n+                args.append(command.wrap)\n+            if command.location:\n+                args.append(command.location)\n+            args.append(work_file)\n         elif domain == 'django' and (file_ext == '.py' or file_ext in command.extensions):\n             thefile = self.file\n             orig_file = os.path.join(self.dirpath, self.file)\n@@ -76,18 +95,32 @@ def process(self, command, potfile, domain, keep_pot=False):\n                 with open(os.path.join(self.dirpath, thefile), \"w\") as fp:\n                     fp.write(content)\n             work_file = os.path.join(self.dirpath, thefile)\n-            cmd = (\n-                'xgettext -d %s -L Python %s %s --keyword=gettext_noop '\n-                '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n-                '--keyword=ugettext_noop --keyword=ugettext_lazy '\n-                '--keyword=ungettext_lazy:1,2 --keyword=pgettext:1c,2 '\n-                '--keyword=npgettext:1c,2,3 --keyword=pgettext_lazy:1c,2 '\n-                '--keyword=npgettext_lazy:1c,2,3 --from-code UTF-8 '\n-                '--add-comments=Translators -o - \"%s\"' %\n-                (domain, command.wrap, command.location, work_file))\n+            args = [\n+                'xgettext',\n+                '-d', domain,\n+                '--language=Python',\n+                '--keyword=gettext_noop',\n+                '--keyword=gettext_lazy',\n+                '--keyword=ngettext_lazy:1,2',\n+                '--keyword=ugettext_noop',\n+                '--keyword=ugettext_lazy',\n+                '--keyword=ungettext_lazy:1,2',\n+                '--keyword=pgettext:1c,2',\n+                '--keyword=npgettext:1c,2,3',\n+                '--keyword=pgettext_lazy:1c,2',\n+                '--keyword=npgettext_lazy:1c,2,3',\n+                '--from-code=UTF-8',\n+                '--add-comments=Translators',\n+                '--output=-'\n+            ]\n+            if command.wrap:\n+                args.append(command.wrap)\n+            if command.location:\n+                args.append(command.location)\n+            args.append(work_file)\n         else:\n             return\n-        msgs, errors, status = _popen(cmd)\n+        msgs, errors, status = popen_wrapper(args)\n         if errors:\n             if status != STATUS_OK:\n                 if is_templatized:\n@@ -109,15 +142,6 @@ def process(self, command, potfile, domain, keep_pot=False):\n         if is_templatized:\n             os.unlink(work_file)\n \n-\n-def _popen(cmd):\n-    \"\"\"\n-    Friendly wrapper around Popen for Windows\n-    \"\"\"\n-    p = Popen(cmd, shell=True, stdout=PIPE, stderr=PIPE, close_fds=os.name != 'nt', universal_newlines=True)\n-    output, errors = p.communicate()\n-    return output, errors, p.returncode\n-\n def write_pot_file(potfile, msgs):\n     \"\"\"\n     Write the :param potfile: POT file with the :param msgs: contents,\n@@ -225,8 +249,9 @@ def handle_noargs(self, *args, **options):\n                     \"is not created automatically, you have to create it by hand \"\n                     \"if you want to enable i18n for your project or application.\")\n \n+        check_programs('xgettext')\n         # We require gettext version 0.15 or newer.\n-        output, errors, status = _popen('xgettext --version')\n+        output, errors, status = popen_wrapper(['xgettext', '--version'])\n         if status != STATUS_OK:\n             raise CommandError(\"Error running xgettext. Note that Django \"\n                         \"internationalization requires GNU gettext 0.15 or newer.\")\n@@ -248,6 +273,9 @@ def handle_noargs(self, *args, **options):\n             locale_dirs = filter(os.path.isdir, glob.glob('%s/*' % localedir))\n             locales = [os.path.basename(l) for l in locale_dirs]\n \n+        if locales:\n+            check_programs('msguniq', 'msgmerge', 'msgattrib')\n+\n         try:\n             for locale in locales:\n                 if self.verbosity > 0:\n@@ -307,8 +335,13 @@ def write_po_file(self, potfile, locale):\n \n         Uses mguniq, msgmerge, and msgattrib GNU gettext utilities.\n         \"\"\"\n-        msgs, errors, status = _popen('msguniq %s %s --to-code=utf-8 \"%s\"' %\n-                                        (self.wrap, self.location, potfile))\n+        args = ['msguniq', '--to-code=utf-8']\n+        if self.wrap:\n+            args.append(self.wrap)\n+        if self.location:\n+            args.append(self.location)\n+        args.append(potfile)\n+        msgs, errors, status = popen_wrapper(args)\n         if errors:\n             if status != STATUS_OK:\n                 raise CommandError(\n@@ -324,8 +357,13 @@ def write_po_file(self, potfile, locale):\n         if os.path.exists(pofile):\n             with open(potfile, 'w') as fp:\n                 fp.write(msgs)\n-            msgs, errors, status = _popen('msgmerge %s %s -q \"%s\" \"%s\"' %\n-                                            (self.wrap, self.location, pofile, potfile))\n+            args = ['msgmerge', '-q']\n+            if self.wrap:\n+                args.append(self.wrap)\n+            if self.location:\n+                args.append(self.location)\n+            args.extend([pofile, potfile])\n+            msgs, errors, status = popen_wrapper(args)\n             if errors:\n                 if status != STATUS_OK:\n                     raise CommandError(\n@@ -340,9 +378,13 @@ def write_po_file(self, potfile, locale):\n             fp.write(msgs)\n \n         if self.no_obsolete:\n-            msgs, errors, status = _popen(\n-                'msgattrib %s %s -o \"%s\" --no-obsolete \"%s\"' %\n-                (self.wrap, self.location, pofile, pofile))\n+            args = ['msgattrib', '-o', pofile, '--no-obsolete']\n+            if self.wrap:\n+                args.append(self.wrap)\n+            if self.location:\n+                args.append(self.location)\n+            args.append(pofile)\n+            msgs, errors, status = popen_wrapper(args)\n             if errors:\n                 if status != STATUS_OK:\n                     raise CommandError("
        },
        {
            "sha": "7159d1123f5a613b128749884d43b683e2580dae",
            "filename": "django/core/management/utils.py",
            "status": "modified",
            "additions": 37,
            "deletions": 3,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/django%2Fcore%2Fmanagement%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/django%2Fcore%2Fmanagement%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Futils.py?ref=7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
            "patch": "@@ -1,17 +1,27 @@\n+from __future__ import absolute_import\n+\n import os\n from subprocess import PIPE, Popen\n+import sys\n \n from django.utils.encoding import force_text, DEFAULT_LOCALE_ENCODING\n+from django.utils import six\n+\n+from .base import CommandError\n \n \n-def popen_wrapper(args):\n+def popen_wrapper(args, os_err_exc_type=CommandError):\n     \"\"\"\n     Friendly wrapper around Popen.\n \n     Returns stdout output, stderr output and OS status code.\n     \"\"\"\n-    p = Popen(args, shell=False, stdout=PIPE, stderr=PIPE,\n-              close_fds=os.name != 'nt', universal_newlines=True)\n+    try:\n+        p = Popen(args, shell=False, stdout=PIPE, stderr=PIPE,\n+                close_fds=os.name != 'nt', universal_newlines=True)\n+    except OSError as e:\n+        six.reraise(os_err_exc_type, os_err_exc_type('Error executing %s: %s' %\n+                    (args[0], e.strerror)), sys.exc_info()[2])\n     output, errors = p.communicate()\n     return (\n         output,\n@@ -43,3 +53,27 @@ def handle_extensions(extensions=('html',), ignored=('py',)):\n         if not ext.startswith('.'):\n             ext_list[i] = '.%s' % ext_list[i]\n     return set([x for x in ext_list if x.strip('.') not in ignored])\n+\n+def find_command(cmd, path=None, pathext=None):\n+    if path is None:\n+        path = os.environ.get('PATH', []).split(os.pathsep)\n+    if isinstance(path, six.string_types):\n+        path = [path]\n+    # check if there are funny path extensions for executables, e.g. Windows\n+    if pathext is None:\n+        pathext = os.environ.get('PATHEXT', '.COM;.EXE;.BAT;.CMD').split(os.pathsep)\n+    # don't use extensions if the command ends with one of them\n+    for ext in pathext:\n+        if cmd.endswith(ext):\n+            pathext = ['']\n+            break\n+    # check if we find the command on PATH\n+    for p in path:\n+        f = os.path.join(p, cmd)\n+        if os.path.isfile(f):\n+            return f\n+        for ext in pathext:\n+            fext = f + ext\n+            if os.path.isfile(fext):\n+                return fext\n+    return None"
        },
        {
            "sha": "80e4ee0110533e83bb95385443665d30bc37a4b4",
            "filename": "tests/i18n/commands/extraction.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/tests%2Fi18n%2Fcommands%2Fextraction.py",
            "raw_url": "https://github.com/django/django/raw/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/tests%2Fi18n%2Fcommands%2Fextraction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fi18n%2Fcommands%2Fextraction.py?ref=7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
            "patch": "@@ -131,8 +131,13 @@ def test_extraction_warning(self):\n         os.chdir(self.test_dir)\n         shutil.copyfile('./code.sample', './code_sample.py')\n         stdout = StringIO()\n-        management.call_command('makemessages', locale=LOCALE, stdout=stdout)\n-        os.remove('./code_sample.py')\n+        try:\n+            management.call_command('makemessages', locale=LOCALE, stdout=stdout)\n+        finally:\n+            try:\n+                os.remove('./code_sample.py')\n+            except OSError:\n+                pass\n         self.assertIn(\"code_sample.py:4\", force_text(stdout.getvalue()))\n \n     def test_template_message_context_extractor(self):"
        },
        {
            "sha": "f9e3c20fff1a2114724f0c599ffc19c54197a155",
            "filename": "tests/i18n/commands/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 25,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/tests%2Fi18n%2Fcommands%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/tests%2Fi18n%2Fcommands%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fi18n%2Fcommands%2Ftests.py?ref=7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
            "patch": "@@ -2,35 +2,11 @@\n import re\n from subprocess import Popen, PIPE\n \n-from django.utils import six\n+from django.core.management.utils import find_command\n \n can_run_extraction_tests = False\n can_run_compilation_tests = False\n \n-def find_command(cmd, path=None, pathext=None):\n-    if path is None:\n-        path = os.environ.get('PATH', []).split(os.pathsep)\n-    if isinstance(path, six.string_types):\n-        path = [path]\n-    # check if there are funny path extensions for executables, e.g. Windows\n-    if pathext is None:\n-        pathext = os.environ.get('PATHEXT', '.COM;.EXE;.BAT;.CMD').split(os.pathsep)\n-    # don't use extensions if the command ends with one of them\n-    for ext in pathext:\n-        if cmd.endswith(ext):\n-            pathext = ['']\n-            break\n-    # check if we find the command on PATH\n-    for p in path:\n-        f = os.path.join(p, cmd)\n-        if os.path.isfile(f):\n-            return f\n-        for ext in pathext:\n-            fext = f + ext\n-            if os.path.isfile(fext):\n-                return fext\n-    return None\n-\n # checks if it can find xgettext on the PATH and\n # imports the extraction tests if yes\n xgettext_cmd = find_command('xgettext')"
        },
        {
            "sha": "bf555e66b93a48f5d917a5d7b0bc64e41d104ead",
            "filename": "tests/user_commands/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/tests%2Fuser_commands%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7fca4416c7f7ce66d528f0d1ad829cf3b8290b89/tests%2Fuser_commands%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fuser_commands%2Ftests.py?ref=7fca4416c7f7ce66d528f0d1ad829cf3b8290b89",
            "patch": "@@ -1,13 +1,14 @@\n import sys\n \n from django.core import management\n-from django.core.management.base import CommandError\n-from django.test import TestCase\n+from django.core.management import CommandError\n+from django.core.management.utils import popen_wrapper\n+from django.test import SimpleTestCase\n from django.utils import translation\n from django.utils.six import StringIO\n \n \n-class CommandTests(TestCase):\n+class CommandTests(SimpleTestCase):\n     def test_command(self):\n         out = StringIO()\n         management.call_command('dance', stdout=out)\n@@ -58,3 +59,9 @@ def test_configured_locale_preserved(self):\n         with translation.override('pl'):\n             management.call_command('leave_locale_alone_true', stdout=out)\n             self.assertEqual(out.getvalue(), \"pl\\n\")\n+\n+\n+class UtilsTests(SimpleTestCase):\n+\n+    def test_no_existent_external_program(self):\n+        self.assertRaises(CommandError, popen_wrapper, ['a_42_command_that_doesnt_exist_42'])"
        }
    ],
    "stats": {
        "total": 207,
        "additions": 137,
        "deletions": 70
    }
}