{
    "author": "claudep",
    "message": "[py3] Fixed GEOS/GDAL tests",
    "sha": "5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
    "files": [
        {
            "sha": "f477f05982fa62c895f1cfaca2010160948e4686",
            "filename": "django/contrib/gis/gdal/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2F__init__.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -41,7 +41,7 @@\n     from django.contrib.gis.gdal.srs import SpatialReference, CoordTransform\n     from django.contrib.gis.gdal.geometries import OGRGeometry\n     HAS_GDAL = True\n-except:\n+except ImportError:\n     HAS_GDAL = False\n \n try:"
        },
        {
            "sha": "fa3d86afbae77bfdcc533c385a14bf5a7e584a28",
            "filename": "django/contrib/gis/gdal/datasource.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fdatasource.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fdatasource.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fdatasource.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -45,6 +45,7 @@\n # Getting the ctypes prototypes for the DataSource.\n from django.contrib.gis.gdal.prototypes import ds as capi\n \n+from django.utils.encoding import force_bytes\n from django.utils import six\n from django.utils.six.moves import xrange\n \n@@ -73,7 +74,7 @@ def __init__(self, ds_input, ds_driver=False, write=False):\n             ds_driver = Driver.ptr_type()\n             try:\n                 # OGROpen will auto-detect the data source type.\n-                ds = capi.open_ds(ds_input, self._write, byref(ds_driver))\n+                ds = capi.open_ds(force_bytes(ds_input), self._write, byref(ds_driver))\n             except OGRException:\n                 # Making the error message more clear rather than something\n                 # like \"Invalid pointer returned from OGROpen\".\n@@ -102,7 +103,7 @@ def __iter__(self):\n     def __getitem__(self, index):\n         \"Allows use of the index [] operator to get a layer at the index.\"\n         if isinstance(index, six.string_types):\n-            l = capi.get_layer_by_name(self.ptr, index)\n+            l = capi.get_layer_by_name(self.ptr, force_bytes(index))\n             if not l: raise OGRIndexError('invalid OGR Layer name given: \"%s\"' % index)\n         elif isinstance(index, int):\n             if index < 0 or index >= self.layer_count:"
        },
        {
            "sha": "55a5d77d661f642bccf3285dcb8280b4dcbf7818",
            "filename": "django/contrib/gis/gdal/driver.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fdriver.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fdriver.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fdriver.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -5,6 +5,7 @@\n from django.contrib.gis.gdal.prototypes import ds as capi\n \n from django.utils import six\n+from django.utils.encoding import force_bytes\n \n # For more information, see the OGR C API source code:\n #  http://www.gdal.org/ogr/ogr__api_8h.html\n@@ -36,7 +37,7 @@ def __init__(self, dr_input):\n                 name = dr_input\n \n             # Attempting to get the OGR driver by the string name.\n-            dr = capi.get_driver_by_name(name)\n+            dr = capi.get_driver_by_name(force_bytes(name))\n         elif isinstance(dr_input, int):\n             self._register()\n             dr = capi.get_driver(dr_input)"
        },
        {
            "sha": "f145526af0f9dbba9bd762447c34dbcd9f1ea8f9",
            "filename": "django/contrib/gis/gdal/envelope.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fenvelope.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fenvelope.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fenvelope.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -52,7 +52,7 @@ def __init__(self, *args):\n         elif len(args) == 4:\n             # Individual parameters passed in.\n             #  Thanks to ww for the help\n-            self._from_sequence(map(float, args))\n+            self._from_sequence([float(a) for a in args])\n         else:\n             raise OGRException('Incorrect number (%d) of arguments.' % len(args))\n "
        },
        {
            "sha": "b8737cd1a057e0ce107a6179662c095c6faeb010",
            "filename": "django/contrib/gis/gdal/feature.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -7,6 +7,7 @@\n # ctypes function prototypes\n from django.contrib.gis.gdal.prototypes import ds as capi, geom as geom_api\n \n+from django.utils.encoding import force_bytes\n from django.utils import six\n from django.utils.six.moves import xrange\n \n@@ -107,6 +108,7 @@ def get(self, field):\n \n     def index(self, field_name):\n         \"Returns the index of the given field name.\"\n-        i = capi.get_field_index(self.ptr, field_name)\n-        if i < 0: raise OGRIndexError('invalid OFT field name given: \"%s\"' % field_name)\n+        i = capi.get_field_index(self.ptr, force_bytes(field_name))\n+        if i < 0:\n+            raise OGRIndexError('invalid OFT field name given: \"%s\"' % field_name)\n         return i"
        },
        {
            "sha": "eb670592458aa05e30f4049dea688ab02faae8d1",
            "filename": "django/contrib/gis/gdal/geometries.py",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fgeometries.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fgeometries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fgeometries.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -78,16 +78,11 @@ def __init__(self, geom_input, srs=None):\n \n         # If HEX, unpack input to to a binary buffer.\n         if str_instance and hex_regex.match(geom_input):\n-            geom_input = memoryview(a2b_hex(geom_input.upper()))\n+            geom_input = memoryview(a2b_hex(geom_input.upper().encode()))\n             str_instance = False\n \n         # Constructing the geometry,\n         if str_instance:\n-            # Checking if unicode\n-            if isinstance(geom_input, six.text_type):\n-                # Encoding to ASCII, WKT or HEX doesn't need any more.\n-                geom_input = geom_input.encode('ascii')\n-\n             wkt_m = wkt_regex.match(geom_input)\n             json_m = json_regex.match(geom_input)\n             if wkt_m:\n@@ -98,19 +93,19 @@ def __init__(self, geom_input, srs=None):\n                     # OGR_G_CreateFromWkt doesn't work with LINEARRING WKT.\n                     #  See http://trac.osgeo.org/gdal/ticket/1992.\n                     g = capi.create_geom(OGRGeomType(wkt_m.group('type')).num)\n-                    capi.import_wkt(g, byref(c_char_p(wkt_m.group('wkt'))))\n+                    capi.import_wkt(g, byref(c_char_p(wkt_m.group('wkt').encode())))\n                 else:\n-                    g = capi.from_wkt(byref(c_char_p(wkt_m.group('wkt'))), None, byref(c_void_p()))\n+                    g = capi.from_wkt(byref(c_char_p(wkt_m.group('wkt').encode())), None, byref(c_void_p()))\n             elif json_m:\n-                g = capi.from_json(geom_input)\n+                g = capi.from_json(geom_input.encode())\n             else:\n                 # Seeing if the input is a valid short-hand string\n                 # (e.g., 'Point', 'POLYGON').\n                 ogr_t = OGRGeomType(geom_input)\n                 g = capi.create_geom(OGRGeomType(geom_input).num)\n         elif isinstance(geom_input, memoryview):\n             # WKB was passed in\n-            g = capi.from_wkb(str(geom_input), None, byref(c_void_p()), len(geom_input))\n+            g = capi.from_wkb(bytes(geom_input), None, byref(c_void_p()), len(geom_input))\n         elif isinstance(geom_input, OGRGeomType):\n             # OGRGeomType was passed in, an empty geometry will be created.\n             g = capi.create_geom(geom_input.num)\n@@ -143,7 +138,7 @@ def __getstate__(self):\n             srs = srs.wkt\n         else:\n             srs = None\n-        return str(self.wkb), srs\n+        return bytes(self.wkb), srs\n \n     def __setstate__(self, state):\n         wkb, srs = state"
        },
        {
            "sha": "d7bf6969cad1f4109cc37afda012bd23fc5c5ed7",
            "filename": "django/contrib/gis/gdal/layer.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -14,6 +14,7 @@\n # GDAL ctypes function prototypes.\n from django.contrib.gis.gdal.prototypes import ds as capi, geom as geom_api, srs as srs_api\n \n+from django.utils.encoding import force_bytes\n from django.utils import six\n from django.utils.six.moves import xrange\n \n@@ -38,7 +39,7 @@ def __init__(self, layer_ptr, ds):\n         self._ds = ds\n         self._ldefn = capi.get_layer_defn(self._ptr)\n         # Does the Layer support random reading?\n-        self._random_read = self.test_capability('RandomRead')\n+        self._random_read = self.test_capability(b'RandomRead')\n \n     def __getitem__(self, index):\n         \"Gets the Feature at the specified index.\"\n@@ -212,4 +213,4 @@ def test_capability(self, capability):\n           'FastFeatureCount', 'FastGetExtent', 'CreateField', 'Transactions',\n           'DeleteFeature', and 'FastSetNextByIndex'.\n         \"\"\"\n-        return bool(capi.test_capability(self.ptr, capability))\n+        return bool(capi.test_capability(self.ptr, force_bytes(capability)))"
        },
        {
            "sha": "0d2889d704da197da6b1db48f04113bd3b7e6c72",
            "filename": "django/contrib/gis/gdal/libgdal.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Flibgdal.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Flibgdal.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Flibgdal.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -1,3 +1,5 @@\n+from __future__ import unicode_literals\n+\n import os\n import re\n from ctypes import c_char_p, CDLL\n@@ -65,7 +67,7 @@ def std_call(func):\n \n def gdal_version():\n     \"Returns only the GDAL version number information.\"\n-    return _version_info('RELEASE_NAME')\n+    return _version_info(b'RELEASE_NAME')\n \n def gdal_full_version():\n     \"Returns the full GDAL version information.\"\n@@ -86,7 +88,7 @@ def gdal_release_date(date=False):\n \n version_regex = re.compile(r'^(?P<major>\\d+)\\.(?P<minor>\\d+)(\\.(?P<subminor>\\d+))?')\n def gdal_version_info():\n-    ver = gdal_version()\n+    ver = gdal_version().decode()\n     m = version_regex.match(ver)\n     if not m: raise OGRException('Could not parse GDAL version string \"%s\"' % ver)\n     return dict([(key, m.group(key)) for key in ('major', 'minor', 'subminor')])"
        },
        {
            "sha": "9103022896efd503eee074413ffb42b7d64edcee",
            "filename": "django/contrib/gis/gdal/prototypes/errcheck.py",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Ferrcheck.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Ferrcheck.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Ferrcheck.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -30,9 +30,10 @@ def check_const_string(result, func, cargs, offset=None):\n     if offset:\n         check_err(result)\n         ptr = ptr_byref(cargs, offset)\n-        return ptr.value\n+        return ptr.value.decode()\n     else:\n-        return result\n+        if result is not None:\n+            return result.decode()\n \n def check_string(result, func, cargs, offset=-1, str_result=False):\n     \"\"\"\n@@ -47,13 +48,13 @@ def check_string(result, func, cargs, offset=-1, str_result=False):\n         # For routines that return a string.\n         ptr = result\n         if not ptr: s = None\n-        else: s = string_at(result)\n+        else: s = string_at(result).decode()\n     else:\n         # Error-code return specified.\n         check_err(result)\n         ptr = ptr_byref(cargs, offset)\n         # Getting the string value\n-        s = ptr.value\n+        s = ptr.value.decode()\n     # Correctly freeing the allocated memory beind GDAL pointer\n     # w/the VSIFree routine.\n     if ptr: lgdal.VSIFree(ptr)\n@@ -125,4 +126,4 @@ def check_str_arg(result, func, cargs):\n     \"\"\"\n     dbl = result\n     ptr = cargs[-1]._obj\n-    return dbl, ptr.value\n+    return dbl, ptr.value.decode()"
        },
        {
            "sha": "1a110b011466d1d43ce4d5ccea3412f6def5dd2f",
            "filename": "django/contrib/gis/gdal/srs.py",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fsrs.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Fsrs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fsrs.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -34,6 +34,8 @@\n from django.contrib.gis.gdal.prototypes import srs as capi\n \n from django.utils import six\n+from django.utils.encoding import force_bytes, force_text\n+\n \n #### Spatial Reference class. ####\n class SpatialReference(GDALBase):\n@@ -51,7 +53,6 @@ def __init__(self, srs_input=''):\n         EPSG code, a PROJ.4 string, and/or a projection \"well known\" shorthand\n         string (one of 'WGS84', 'WGS72', 'NAD27', 'NAD83').\n         \"\"\"\n-        buf = c_char_p('')\n         srs_type = 'user'\n \n         if isinstance(srs_input, six.string_types):\n@@ -79,6 +80,7 @@ def __init__(self, srs_input=''):\n             srs = srs_input\n         else:\n             # Creating a new SRS pointer, using the string buffer.\n+            buf = c_char_p(b'')\n             srs = capi.new_srs(buf)\n \n         # If the pointer is NULL, throw an exception.\n@@ -137,15 +139,16 @@ def attr_value(self, target, index=0):\n         \"\"\"\n         if not isinstance(target, six.string_types) or not isinstance(index, int):\n             raise TypeError\n-        return capi.get_attr_value(self.ptr, target, index)\n+        value = capi.get_attr_value(self.ptr, force_bytes(target), index)\n+        return force_text(value, 'ascii', strings_only=True)\n \n     def auth_name(self, target):\n         \"Returns the authority name for the given string target node.\"\n-        return capi.get_auth_name(self.ptr, target)\n+        return capi.get_auth_name(self.ptr, force_bytes(target))\n \n     def auth_code(self, target):\n         \"Returns the authority code for the given string target node.\"\n-        return capi.get_auth_code(self.ptr, target)\n+        return capi.get_auth_code(self.ptr, force_bytes(target))\n \n     def clone(self):\n         \"Returns a clone of this SpatialReference object.\"\n@@ -219,12 +222,14 @@ def units(self):\n         and will automatically determines whether to return the linear\n         or angular units.\n         \"\"\"\n+        units, name = None, None\n         if self.projected or self.local:\n-            return capi.linear_units(self.ptr, byref(c_char_p()))\n+            units, name = capi.linear_units(self.ptr, byref(c_char_p()))\n         elif self.geographic:\n-            return capi.angular_units(self.ptr, byref(c_char_p()))\n-        else:\n-            return (None, None)\n+            units, name = capi.angular_units(self.ptr, byref(c_char_p()))\n+        if name is not None:\n+            name.decode()\n+        return (units, name)\n \n     #### Spheroid/Ellipsoid Properties ####\n     @property\n@@ -283,7 +288,7 @@ def import_proj(self, proj):\n \n     def import_user_input(self, user_input):\n         \"Imports the Spatial Reference from the given user input string.\"\n-        capi.from_user_input(self.ptr, user_input)\n+        capi.from_user_input(self.ptr, force_bytes(user_input))\n \n     def import_wkt(self, wkt):\n         \"Imports the Spatial Reference from OGC WKT (string)\""
        },
        {
            "sha": "094f65b46898e3b70a6933b3f9ef8189b3d6a236",
            "filename": "django/contrib/gis/gdal/tests/test_ds.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -9,7 +9,7 @@\n                   fields={'dbl' : OFTReal, 'int' : OFTInteger, 'str' : OFTString,},\n                   extent=(-1.35011,0.166623,-0.524093,0.824508), # Got extent from QGIS\n                   srs_wkt='GEOGCS[\"GCS_WGS_1984\",DATUM[\"WGS_1984\",SPHEROID[\"WGS_1984\",6378137,298.257223563]],PRIMEM[\"Greenwich\",0],UNIT[\"Degree\",0.017453292519943295]]',\n-                  field_values={'dbl' : [float(i) for i in range(1, 6)], 'int' : range(1, 6), 'str' : [str(i) for i in range(1, 6)]},\n+                  field_values={'dbl' : [float(i) for i in range(1, 6)], 'int' : list(range(1, 6)), 'str' : [str(i) for i in range(1, 6)]},\n                   fids=range(5)),\n            TestDS('test_vrt', ext='vrt', nfeat=3, nfld=3, geom='POINT', gtype='Point25D', driver='VRT',\n                   fields={'POINT_X' : OFTString, 'POINT_Y' : OFTString, 'NUM' : OFTString}, # VRT uses CSV, which all types are OFTString.\n@@ -200,7 +200,7 @@ def test06_spatial_filter(self):\n \n         # Setting the spatial filter with a tuple/list with the extent of\n         # a buffer centering around Pueblo.\n-        self.assertRaises(ValueError, lyr._set_spatial_filter, range(5))\n+        self.assertRaises(ValueError, lyr._set_spatial_filter, list(range(5)))\n         filter_extent = (-105.609252, 37.255001, -103.609252, 39.255001)\n         lyr.spatial_filter = (-105.609252, 37.255001, -103.609252, 39.255001)\n         self.assertEqual(OGRGeometry.from_bbox(filter_extent), lyr.spatial_filter)"
        },
        {
            "sha": "b22bb621095497b5a36e206215f3878b7bf2966c",
            "filename": "django/contrib/gis/gdal/tests/test_geom.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -92,7 +92,7 @@ def test01c_hex(self):\n         \"Testing HEX input/output.\"\n         for g in self.geometries.hex_wkt:\n             geom1 = OGRGeometry(g.wkt)\n-            self.assertEqual(g.hex, geom1.hex)\n+            self.assertEqual(g.hex.encode(), geom1.hex)\n             # Constructing w/HEX\n             geom2 = OGRGeometry(g.hex)\n             self.assertEqual(geom1, geom2)\n@@ -102,7 +102,7 @@ def test01d_wkb(self):\n         for g in self.geometries.hex_wkt:\n             geom1 = OGRGeometry(g.wkt)\n             wkb = geom1.wkb\n-            self.assertEqual(b2a_hex(wkb).upper(), g.hex)\n+            self.assertEqual(b2a_hex(wkb).upper(), g.hex.encode())\n             # Constructing w/WKB.\n             geom2 = OGRGeometry(wkb)\n             self.assertEqual(geom1, geom2)"
        },
        {
            "sha": "833e62f2246a61b10d5b764ed220763dd753ab3d",
            "filename": "django/contrib/gis/geometry/test_data.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeometry%2Ftest_data.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeometry%2Ftest_data.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeometry%2Ftest_data.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -101,6 +101,6 @@ def geometries(self):\n         if GEOMETRIES is None:\n             # Load up the test geometry data from fixture into global.\n             gzf = gzip.GzipFile(os.path.join(TEST_DATA, 'geometries.json.gz'))\n-            geometries = json.loads(gzf.read())\n+            geometries = json.loads(gzf.read().decode())\n             GEOMETRIES = TestGeomSet(**strconvert(geometries))\n         return GEOMETRIES"
        },
        {
            "sha": "2e5fa4f331adc27dc94a46392f08c6a7f6ab2001",
            "filename": "django/contrib/gis/geos/factory.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Ffactory.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Ffactory.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ffactory.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -3,6 +3,7 @@\n \n from django.utils import six\n \n+\n def fromfile(file_h):\n     \"\"\"\n     Given a string file name, returns a GEOSGeometry. The file may contain WKB,\n@@ -15,11 +16,19 @@ def fromfile(file_h):\n     else:\n         buf = file_h.read()\n \n-    # If we get WKB need to wrap in buffer(), so run through regexes.\n-    if wkt_regex.match(buf) or hex_regex.match(buf):\n-        return GEOSGeometry(buf)\n+    # If we get WKB need to wrap in memoryview(), so run through regexes.\n+    if isinstance(buf, bytes):\n+        try:\n+            decoded = buf.decode()\n+            if wkt_regex.match(decoded) or hex_regex.match(decoded):\n+                return GEOSGeometry(decoded)\n+        except UnicodeDecodeError:\n+            pass\n     else:\n-        return GEOSGeometry(memoryview(buf))\n+        return GEOSGeometry(buf)\n+\n+    return GEOSGeometry(memoryview(buf))\n+\n \n def fromstr(string, **kwargs):\n     \"Given a string value, returns a GEOSGeometry object.\""
        },
        {
            "sha": "6dbb6b2cb3ba43c24b181dc91134285e9f4ccf7c",
            "filename": "django/contrib/gis/geos/geometry.py",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -2,6 +2,8 @@\n  This module contains the 'base' GEOSGeometry object -- all GEOS Geometries\n  inherit from this object.\n \"\"\"\n+from __future__ import unicode_literals\n+\n # Python, ctypes and types dependencies.\n from ctypes import addressof, byref, c_double\n \n@@ -29,6 +31,8 @@\n from django.contrib.gis.geometry.regex import hex_regex, wkt_regex, json_regex\n \n from django.utils import six\n+from django.utils.encoding import force_bytes, force_text\n+\n \n class GEOSGeometry(GEOSBase, ListMixin):\n     \"A class that, generally, encapsulates a GEOS geometry.\"\n@@ -55,19 +59,17 @@ def __init__(self, geo_input, srid=None):\n         The `srid` keyword is used to specify the Source Reference Identifier\n         (SRID) number for this Geometry.  If not set, the SRID will be None.\n         \"\"\"\n+        if isinstance(geo_input, bytes):\n+            geo_input = force_text(geo_input)\n         if isinstance(geo_input, six.string_types):\n-            if isinstance(geo_input, six.text_type):\n-                # Encoding to ASCII, WKT or HEXEWKB doesn't need any more.\n-                geo_input = geo_input.encode('ascii')\n-\n             wkt_m = wkt_regex.match(geo_input)\n             if wkt_m:\n                 # Handling WKT input.\n                 if wkt_m.group('srid'): srid = int(wkt_m.group('srid'))\n-                g = wkt_r().read(wkt_m.group('wkt'))\n+                g = wkt_r().read(force_bytes(wkt_m.group('wkt')))\n             elif hex_regex.match(geo_input):\n                 # Handling HEXEWKB input.\n-                g = wkb_r().read(geo_input)\n+                g = wkb_r().read(force_bytes(geo_input))\n             elif gdal.HAS_GDAL and json_regex.match(geo_input):\n                 # Handling GeoJSON input.\n                 g = wkb_r().read(gdal.OGRGeometry(geo_input).wkb)\n@@ -217,7 +219,7 @@ def coord_seq(self):\n     @property\n     def geom_type(self):\n         \"Returns a string representing the Geometry type, e.g. 'Polygon'\"\n-        return capi.geos_type(self.ptr)\n+        return capi.geos_type(self.ptr).decode()\n \n     @property\n     def geom_typeid(self):\n@@ -284,7 +286,7 @@ def valid_reason(self):\n         \"\"\"\n         if not GEOS_PREPARE:\n             raise GEOSException('Upgrade GEOS to 3.1 to get validity reason.')\n-        return capi.geos_isvalidreason(self.ptr)\n+        return capi.geos_isvalidreason(self.ptr).decode()\n \n     #### Binary predicates. ####\n     def contains(self, other):\n@@ -338,7 +340,7 @@ def relate_pattern(self, other, pattern):\n         \"\"\"\n         if not isinstance(pattern, six.string_types) or len(pattern) > 9:\n             raise GEOSException('invalid intersection matrix pattern')\n-        return capi.geos_relatepattern(self.ptr, other.ptr, pattern)\n+        return capi.geos_relatepattern(self.ptr, other.ptr, force_bytes(pattern))\n \n     def touches(self, other):\n         \"\"\"\n@@ -380,7 +382,7 @@ def ewkt(self):\n     @property\n     def wkt(self):\n         \"Returns the WKT (Well-Known Text) representation of this Geometry.\"\n-        return wkt_w().write(self)\n+        return wkt_w().write(self).decode()\n \n     @property\n     def hex(self):\n@@ -590,7 +592,7 @@ def point_on_surface(self):\n \n     def relate(self, other):\n         \"Returns the DE-9IM intersection matrix for this Geometry and the other.\"\n-        return capi.geos_relate(self.ptr, other.ptr)\n+        return capi.geos_relate(self.ptr, other.ptr).decode()\n \n     def simplify(self, tolerance=0.0, preserve_topology=False):\n         \"\"\""
        },
        {
            "sha": "b31a7955a2b603d4cfed4b386f5cb61ce45bf61a",
            "filename": "django/contrib/gis/geos/libgeos.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Flibgeos.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Flibgeos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Flibgeos.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -57,6 +57,7 @@\n #  typedef void (*GEOSMessageHandler)(const char *fmt, ...);\n NOTICEFUNC = CFUNCTYPE(None, c_char_p, c_char_p)\n def notice_h(fmt, lst, output_h=sys.stdout):\n+    fmt, lst = fmt.decode(), lst.decode()\n     try:\n         warn_msg = fmt % lst\n     except:\n@@ -66,6 +67,7 @@ def notice_h(fmt, lst, output_h=sys.stdout):\n \n ERRORFUNC = CFUNCTYPE(None, c_char_p, c_char_p)\n def error_h(fmt, lst, output_h=sys.stderr):\n+    fmt, lst = fmt.decode(), lst.decode()\n     try:\n         err_msg = fmt % lst\n     except:"
        },
        {
            "sha": "1eeab60a4b35c38c269771d0db6da97d4c221862",
            "filename": "django/contrib/gis/geos/prototypes/io.py",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -8,6 +8,7 @@\n from django.contrib.gis.geos.prototypes.threadsafe import GEOSFunc\n \n from django.utils import six\n+from django.utils.encoding import force_bytes\n \n ### The WKB/WKT Reader/Writer structures and pointers ###\n class WKTReader_st(Structure): pass\n@@ -121,8 +122,9 @@ class _WKTReader(IOBase):\n     ptr_type = WKT_READ_PTR\n \n     def read(self, wkt):\n-        if not isinstance(wkt, six.string_types): raise TypeError\n-        return wkt_reader_read(self.ptr, wkt)\n+        if not isinstance(wkt, (bytes, six.string_types)):\n+            raise TypeError\n+        return wkt_reader_read(self.ptr, force_bytes(wkt))\n \n class _WKBReader(IOBase):\n     _constructor = wkb_reader_create\n@@ -134,7 +136,7 @@ def read(self, wkb):\n         if isinstance(wkb, memoryview):\n             wkb_s = bytes(wkb)\n             return wkb_reader_read(self.ptr, wkb_s, len(wkb_s))\n-        elif isinstance(wkb, six.string_types):\n+        elif isinstance(wkb, (bytes, six.string_types)):\n             return wkb_reader_read_hex(self.ptr, wkb, len(wkb))\n         else:\n             raise TypeError\n@@ -189,8 +191,8 @@ def _get_include_srid(self):\n         return bool(ord(wkb_writer_get_include_srid(self.ptr)))\n \n     def _set_include_srid(self, include):\n-        if bool(include): flag = chr(1)\n-        else: flag = chr(0)\n+        if bool(include): flag = b'\\x01'\n+        else: flag = b'\\x00'\n         wkb_writer_set_include_srid(self.ptr, flag)\n \n     srid = property(_get_include_srid, _set_include_srid)"
        },
        {
            "sha": "c8d3e43a0ebe7674c5a410629ed748d70154ba01",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -1,6 +1,10 @@\n+from __future__ import unicode_literals\n+\n import ctypes\n import json\n import random\n+from binascii import a2b_hex, b2a_hex\n+from io import BytesIO\n \n from django.contrib.gis import memoryview\n from django.contrib.gis.geos import (GEOSException, GEOSIndexError, GEOSGeometry,\n@@ -10,6 +14,7 @@\n from django.contrib.gis.geos.libgeos import GEOS_PREPARE\n from django.contrib.gis.geometry.test_data import TestDataMixin\n \n+from django.utils.encoding import force_bytes\n from django.utils import six\n from django.utils.six.moves import xrange\n from django.utils import unittest\n@@ -65,7 +70,7 @@ class FakeGeom2(GEOSBase):\n         # result in a TypeError when trying to assign it to the `ptr` property.\n         # Thus, memmory addresses (integers) and pointers of the incorrect type\n         # (in `bad_ptrs`) will not be allowed.\n-        bad_ptrs = (5, ctypes.c_char_p('foobar'))\n+        bad_ptrs = (5, ctypes.c_char_p(b'foobar'))\n         for bad_ptr in bad_ptrs:\n             # Equivalent to `fg.ptr = bad_ptr`\n             self.assertRaises(TypeError, fg1._set_ptr, bad_ptr)\n@@ -81,18 +86,16 @@ def test_hex(self):\n         \"Testing HEX output.\"\n         for g in self.geometries.hex_wkt:\n             geom = fromstr(g.wkt)\n-            self.assertEqual(g.hex, geom.hex)\n+            self.assertEqual(g.hex, geom.hex.decode())\n \n     def test_hexewkb(self):\n         \"Testing (HEX)EWKB output.\"\n-        from binascii import a2b_hex\n-\n         # For testing HEX(EWKB).\n-        ogc_hex = '01010000000000000000000000000000000000F03F'\n+        ogc_hex = b'01010000000000000000000000000000000000F03F'\n         # `SELECT ST_AsHEXEWKB(ST_GeomFromText('POINT(0 1)', 4326));`\n-        hexewkb_2d = '0101000020E61000000000000000000000000000000000F03F'\n+        hexewkb_2d = b'0101000020E61000000000000000000000000000000000F03F'\n         # `SELECT ST_AsHEXEWKB(ST_GeomFromEWKT('SRID=4326;POINT(0 1 2)'));`\n-        hexewkb_3d = '01010000A0E61000000000000000000000000000000000F03F0000000000000040'\n+        hexewkb_3d = b'01010000A0E61000000000000000000000000000000000F03F0000000000000040'\n \n         pnt_2d = Point(0, 1, srid=4326)\n         pnt_3d = Point(0, 1, 2, srid=4326)\n@@ -165,11 +168,10 @@ class NotAGeometry(object):\n \n     def test_wkb(self):\n         \"Testing WKB output.\"\n-        from binascii import b2a_hex\n         for g in self.geometries.hex_wkt:\n             geom = fromstr(g.wkt)\n             wkb = geom.wkb\n-            self.assertEqual(b2a_hex(wkb).upper(), g.hex)\n+            self.assertEqual(b2a_hex(wkb).decode().upper(), g.hex)\n \n     def test_create_hex(self):\n         \"Testing creation from HEX.\"\n@@ -181,9 +183,8 @@ def test_create_hex(self):\n \n     def test_create_wkb(self):\n         \"Testing creation from WKB.\"\n-        from binascii import a2b_hex\n         for g in self.geometries.hex_wkt:\n-            wkb = memoryview(a2b_hex(g.hex))\n+            wkb = memoryview(a2b_hex(g.hex.encode()))\n             geom_h = GEOSGeometry(wkb)\n             # we need to do this so decimal places get normalised\n             geom_t = fromstr(g.wkt)\n@@ -213,13 +214,12 @@ def test_json(self):\n \n     def test_fromfile(self):\n         \"Testing the fromfile() factory.\"\n-        from io import BytesIO\n         ref_pnt = GEOSGeometry('POINT(5 23)')\n \n         wkt_f = BytesIO()\n-        wkt_f.write(ref_pnt.wkt)\n+        wkt_f.write(force_bytes(ref_pnt.wkt))\n         wkb_f = BytesIO()\n-        wkb_f.write(str(ref_pnt.wkb))\n+        wkb_f.write(bytes(ref_pnt.wkb))\n \n         # Other tests use `fromfile()` on string filenames so those\n         # aren't tested here.\n@@ -440,8 +440,8 @@ def test_polygons(self):\n                 self.assertEqual(r.geom_typeid, 2)\n \n             # Testing polygon construction.\n-            self.assertRaises(TypeError, Polygon.__init__, 0, [1, 2, 3])\n-            self.assertRaises(TypeError, Polygon.__init__, 'foo')\n+            self.assertRaises(TypeError, Polygon, 0, [1, 2, 3])\n+            self.assertRaises(TypeError, Polygon, 'foo')\n \n             # Polygon(shell, (hole1, ... holeN))\n             rings = tuple(r for r in poly)"
        },
        {
            "sha": "45a9a220b1f399375e18b58df7196848583287f5",
            "filename": "django/contrib/gis/geos/tests/test_io.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_io.py",
            "raw_url": "https://github.com/django/django/raw/5330cd50cdb0674cd08cbfb40af9ac51267fbbec/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_io.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_io.py?ref=5330cd50cdb0674cd08cbfb40af9ac51267fbbec",
            "patch": "@@ -1,10 +1,13 @@\n+from __future__ import unicode_literals\n+\n import binascii\n import unittest\n \n from django.contrib.gis import memoryview\n from django.contrib.gis.geos import GEOSGeometry, WKTReader, WKTWriter, WKBReader, WKBWriter, geos_version_info\n from django.utils import six\n \n+\n class GEOSIOTest(unittest.TestCase):\n \n     def test01_wktreader(self):\n@@ -14,8 +17,8 @@ def test01_wktreader(self):\n \n         # read() should return a GEOSGeometry\n         ref = GEOSGeometry(wkt)\n-        g1 = wkt_r.read(wkt)\n-        g2 = wkt_r.read(six.text_type(wkt))\n+        g1 = wkt_r.read(wkt.encode())\n+        g2 = wkt_r.read(wkt)\n \n         for geom in (g1, g2):\n             self.assertEqual(ref, geom)\n@@ -102,7 +105,7 @@ def test04_wkbwriter(self):\n             self.assertEqual(hex3d, wkb_w.write_hex(g))\n             self.assertEqual(wkb3d, wkb_w.write(g))\n \n-            # Telling the WKBWriter to inlcude the srid in the representation.\n+            # Telling the WKBWriter to include the srid in the representation.\n             wkb_w.srid = True\n             self.assertEqual(hex3d_srid, wkb_w.write_hex(g))\n             self.assertEqual(wkb3d_srid, wkb_w.write(g))"
        }
    ],
    "stats": {
        "total": 186,
        "additions": 106,
        "deletions": 80
    }
}