{
    "author": "aaugustin",
    "message": "Fixed #17992 -- Added a public API for localtime.\n\nThanks Bradley Ayers for the report.",
    "sha": "3e8b40f479a02e0f8c40ef3c7dae740082478b89",
    "files": [
        {
            "sha": "538bf54df9697c6885d5fe29a66ce060372d0b9e",
            "filename": "django/contrib/admin/filters.py",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilters.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -290,19 +290,15 @@ def __init__(self, field, request, params, model, model_admin, field_path):\n         now = timezone.now()\n         # When time zone support is enabled, convert \"now\" to the user's time\n         # zone so Django's definition of \"Today\" matches what the user expects.\n-        if now.tzinfo is not None:\n-            current_tz = timezone.get_current_timezone()\n-            now = now.astimezone(current_tz)\n-            if hasattr(current_tz, 'normalize'):\n-                # available for pytz time zones\n-                now = current_tz.normalize(now)\n+        if timezone.is_aware(now):\n+            now = timezone.localtime(now)\n \n         if isinstance(field, models.DateTimeField):\n             today = now.replace(hour=0, minute=0, second=0, microsecond=0)\n         else:       # field is a models.DateField\n             today = now.date()\n         tomorrow = today + datetime.timedelta(days=1)\n-    \n+\n         self.lookup_kwarg_since = '%s__gte' % field_path\n         self.lookup_kwarg_until = '%s__lt' % field_path\n         self.links = ("
        },
        {
            "sha": "0eb67914855b3c3a291ed1d99a98733765032694",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -325,7 +325,7 @@ def display_for_field(value, field):\n     elif value is None:\n         return EMPTY_CHANGELIST_VALUE\n     elif isinstance(field, models.DateTimeField):\n-        return formats.localize(timezone.localtime(value))\n+        return formats.localize(timezone.template_localtime(value))\n     elif isinstance(field, (models.DateField, models.TimeField)):\n         return formats.localize(value)\n     elif isinstance(field, models.DecimalField):\n@@ -345,7 +345,7 @@ def display_for_value(value, boolean=False):\n     elif value is None:\n         return EMPTY_CHANGELIST_VALUE\n     elif isinstance(value, datetime.datetime):\n-        return formats.localize(timezone.localtime(value))\n+        return formats.localize(timezone.template_localtime(value))\n     elif isinstance(value, (datetime.date, datetime.time)):\n         return formats.localize(value)\n     elif isinstance(value, (decimal.Decimal, float, int, long)):"
        },
        {
            "sha": "f6f0027f69d95abeb9ced8a66e1a9ab844b8fd5c",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -18,7 +18,7 @@\n from django.utils.formats import localize\n from django.utils.html import escape\n from django.utils.module_loading import module_has_submodule\n-from django.utils.timezone import localtime\n+from django.utils.timezone import template_localtime\n \n \n TOKEN_TEXT = 0\n@@ -592,7 +592,7 @@ def resolve(self, context, ignore_failures=False):\n                 else:\n                     arg_vals.append(arg.resolve(context))\n             if getattr(func, 'expects_localtime', False):\n-                obj = localtime(obj, context.use_tz)\n+                obj = template_localtime(obj, context.use_tz)\n             if getattr(func, 'needs_autoescape', False):\n                 new_obj = func(obj, autoescape=context.autoescape, *arg_vals)\n             else:\n@@ -853,7 +853,7 @@ def _render_value_in_context(value, context):\n     means escaping, if required, and conversion to a unicode object. If value\n     is a string, it is expected to have already been translated.\n     \"\"\"\n-    value = localtime(value, use_tz=context.use_tz)\n+    value = template_localtime(value, use_tz=context.use_tz)\n     value = localize(value, use_l10n=context.use_l10n)\n     value = force_unicode(value)\n     if ((context.autoescape and not isinstance(value, SafeData)) or"
        },
        {
            "sha": "ba4f23dc9422aa237d5bb818bb1b47c02a1f8b44",
            "filename": "django/template/debug.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Ftemplate%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Ftemplate%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdebug.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -3,7 +3,7 @@\n from django.utils.html import escape\n from django.utils.safestring import SafeData, EscapeData\n from django.utils.formats import localize\n-from django.utils.timezone import localtime\n+from django.utils.timezone import template_localtime\n \n \n class DebugLexer(Lexer):\n@@ -82,7 +82,7 @@ class DebugVariableNode(VariableNode):\n     def render(self, context):\n         try:\n             output = self.filter_expression.resolve(context)\n-            output = localtime(output, use_tz=context.use_tz)\n+            output = template_localtime(output, use_tz=context.use_tz)\n             output = localize(output, use_l10n=context.use_l10n)\n             output = force_unicode(output)\n         except UnicodeDecodeError:"
        },
        {
            "sha": "ca72ca5ec859e3b6823b9aa6b105f61243b60c3e",
            "filename": "django/templatetags/tz.py",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Ftemplatetags%2Ftz.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Ftemplatetags%2Ftz.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Ftz.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -72,11 +72,7 @@ def do_timezone(value, arg):\n     else:\n         return ''\n \n-    # Convert and prevent further conversion\n-    result = value.astimezone(tz)\n-    if hasattr(tz, 'normalize'):\n-        # available for pytz time zones\n-        result = tz.normalize(result)\n+    result = timezone.localtime(value, tz)\n \n     # HACK: the convert_to_local_time flag will prevent\n     #       automatic conversion of the value to local time."
        },
        {
            "sha": "0bba97e7368aa2b282d79eed7a00197cafaa995a",
            "filename": "django/utils/timezone.py",
            "status": "modified",
            "additions": 19,
            "deletions": 9,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/django%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftimezone.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -206,7 +206,7 @@ def __exit__(self, exc_type, exc_value, traceback):\n \n # Templates\n \n-def localtime(value, use_tz=None):\n+def template_localtime(value, use_tz=None):\n     \"\"\"\n     Checks if value is a datetime and converts it to local time if necessary.\n \n@@ -215,20 +215,30 @@ def localtime(value, use_tz=None):\n \n     This function is designed for use by the template engine.\n     \"\"\"\n-    if (isinstance(value, datetime)\n+    should_convert = (isinstance(value, datetime)\n         and (settings.USE_TZ if use_tz is None else use_tz)\n         and not is_naive(value)\n-        and getattr(value, 'convert_to_local_time', True)):\n-        timezone = get_current_timezone()\n-        value = value.astimezone(timezone)\n-        if hasattr(timezone, 'normalize'):\n-            # available for pytz time zones\n-            value = timezone.normalize(value)\n-    return value\n+        and getattr(value, 'convert_to_local_time', True))\n+    return localtime(value) if should_convert else value\n \n \n # Utilities\n \n+def localtime(value, timezone=None):\n+    \"\"\"\n+    Converts an aware datetime.datetime to local time.\n+\n+    Local time is defined by the current time zone, unless another time zone\n+    is specified.\n+    \"\"\"\n+    if timezone is None:\n+        timezone = get_current_timezone()\n+    value = value.astimezone(timezone)\n+    if hasattr(timezone, 'normalize'):\n+        # available for pytz time zones\n+        value = timezone.normalize(value)\n+    return value\n+\n def now():\n     \"\"\"\n     Returns an aware or naive datetime.datetime, depending on settings.USE_TZ."
        },
        {
            "sha": "2525690869a98a7ec413323e63f353d8ac932f5b",
            "filename": "docs/ref/utils.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/docs%2Fref%2Futils.txt",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/docs%2Fref%2Futils.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Futils.txt?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -666,6 +666,16 @@ For a complete discussion on the usage of the following see the\n     ``None``, the :ref:`current time zone <default-current-time-zone>` is unset\n     on entry with :func:`deactivate()` instead.\n \n+.. versionadded:: 1.5\n+\n+.. function:: localtime(value, timezone=None)\n+\n+    Converts an aware :class:`~datetime.datetime` to a different time zone,\n+    by default the :ref:`current time zone <default-current-time-zone>`.\n+\n+    This function doesn't work on naive datetimes; use :func:`make_aware`\n+    instead.\n+\n .. function:: now()\n \n     Returns an aware or naive :class:`~datetime.datetime` that represents the"
        },
        {
            "sha": "dcf050f2ae132d9af33b716721d98004014280ab",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -41,6 +41,9 @@ Django 1.5 also includes several smaller improvements worth noting:\n * The template engine now interprets ``True``, ``False`` and ``None`` as the\n   corresponding Python objects.\n \n+* :mod:`django.utils.timezone` provides a helper for converting aware\n+  datetimes between time zones, see :func:`~django.utils.timezone.localtime`.\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        },
        {
            "sha": "991600c8b912e58816991dc15cb22d15f287b3a0",
            "filename": "tests/regressiontests/utils/timezone.py",
            "status": "modified",
            "additions": 22,
            "deletions": 7,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/3e8b40f479a02e0f8c40ef3c7dae740082478b89/tests%2Fregressiontests%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/3e8b40f479a02e0f8c40ef3c7dae740082478b89/tests%2Fregressiontests%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftimezone.py?ref=3e8b40f479a02e0f8c40ef3c7dae740082478b89",
            "patch": "@@ -1,18 +1,33 @@\n import copy\n+import datetime\n import pickle\n-from django.utils.timezone import UTC, LocalTimezone\n+from django.test.utils import override_settings\n+from django.utils import timezone\n from django.utils import unittest\n \n+\n class TimezoneTests(unittest.TestCase):\n \n+    def test_localtime(self):\n+        now = datetime.datetime.utcnow().replace(tzinfo=timezone.utc)\n+        local_tz = timezone.LocalTimezone()\n+        local_now = timezone.localtime(now, local_tz)\n+        self.assertEqual(local_now.tzinfo, local_tz)\n+\n+    def test_now(self):\n+        with override_settings(USE_TZ=True):\n+            self.assertTrue(timezone.is_aware(timezone.now()))\n+        with override_settings(USE_TZ=False):\n+            self.assertTrue(timezone.is_naive(timezone.now()))\n+\n     def test_copy(self):\n-        self.assertIsInstance(copy.copy(UTC()), UTC)\n-        self.assertIsInstance(copy.copy(LocalTimezone()), LocalTimezone)\n+        self.assertIsInstance(copy.copy(timezone.UTC()), timezone.UTC)\n+        self.assertIsInstance(copy.copy(timezone.LocalTimezone()), timezone.LocalTimezone)\n \n     def test_deepcopy(self):\n-        self.assertIsInstance(copy.deepcopy(UTC()), UTC)\n-        self.assertIsInstance(copy.deepcopy(LocalTimezone()), LocalTimezone)\n+        self.assertIsInstance(copy.deepcopy(timezone.UTC()), timezone.UTC)\n+        self.assertIsInstance(copy.deepcopy(timezone.LocalTimezone()), timezone.LocalTimezone)\n \n     def test_pickling_unpickling(self):\n-        self.assertIsInstance(pickle.loads(pickle.dumps(UTC())), UTC)\n-        self.assertIsInstance(pickle.loads(pickle.dumps(LocalTimezone())), LocalTimezone)\n+        self.assertIsInstance(pickle.loads(pickle.dumps(timezone.UTC())), timezone.UTC)\n+        self.assertIsInstance(pickle.loads(pickle.dumps(timezone.LocalTimezone())), timezone.LocalTimezone)"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 65,
        "deletions": 35
    }
}