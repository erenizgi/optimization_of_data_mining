{
    "author": "aaugustin",
    "message": "Fixed #17135 -- Made it possible to use decorators (like stringfilter) on template filter functions in combination with auto-escaping. Refs #16726.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17056 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d17bc72880caea967ee1f4332941269837b68a2a",
    "files": [
        {
            "sha": "4ed07125c0e2ec74258209828d6f37ef393da436",
            "filename": "django/contrib/humanize/templatetags/humanize.py",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -11,7 +11,7 @@\n \n register = template.Library()\n \n-@register.filter\n+@register.filter(is_safe=True)\n def ordinal(value):\n     \"\"\"\n     Converts an integer to its ordinal as a string. 1 is '1st', 2 is '2nd',\n@@ -25,9 +25,8 @@ def ordinal(value):\n     if value % 100 in (11, 12, 13): # special case\n         return u\"%d%s\" % (value, suffixes[0])\n     return u\"%d%s\" % (value, suffixes[value % 10])\n-ordinal.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def intcomma(value, use_l10n=True):\n     \"\"\"\n     Converts an integer to a string containing commas every three digits.\n@@ -47,7 +46,6 @@ def intcomma(value, use_l10n=True):\n         return new\n     else:\n         return intcomma(new, use_l10n)\n-intcomma.is_safe = True\n \n # A tuple of standard large number to their converters\n intword_converters = (\n@@ -97,7 +95,7 @@ def intcomma(value, use_l10n=True):\n     )),\n )\n \n-@register.filter\n+@register.filter(is_safe=False)\n def intword(value):\n     \"\"\"\n     Converts a large integer to a friendly text representation. Works best\n@@ -129,9 +127,8 @@ def _check_for_i18n(value, float_formatted, string_formatted):\n             new_value = value / float(large_number)\n             return _check_for_i18n(new_value, *converters(new_value))\n     return value\n-intword.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=True)\n def apnumber(value):\n     \"\"\"\n     For numbers 1-9, returns the number spelled out. Otherwise, returns the\n@@ -144,7 +141,6 @@ def apnumber(value):\n     if not 0 < value < 10:\n         return value\n     return (_('one'), _('two'), _('three'), _('four'), _('five'), _('six'), _('seven'), _('eight'), _('nine'))[value-1]\n-apnumber.is_safe = True\n \n @register.filter\n def naturalday(value, arg=None):"
        },
        {
            "sha": "968277284a919d57b554c21e3d698e6ba96622b4",
            "filename": "django/contrib/markup/templatetags/markup.py",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/django%2Fcontrib%2Fmarkup%2Ftemplatetags%2Fmarkup.py",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/django%2Fcontrib%2Fmarkup%2Ftemplatetags%2Fmarkup.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmarkup%2Ftemplatetags%2Fmarkup.py?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -18,7 +18,7 @@\n \n register = template.Library()\n \n-@register.filter\n+@register.filter(is_safe=True)\n def textile(value):\n     try:\n         import textile\n@@ -28,9 +28,8 @@ def textile(value):\n         return force_unicode(value)\n     else:\n         return mark_safe(force_unicode(textile.textile(smart_str(value), encoding='utf-8', output='utf-8')))\n-textile.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def markdown(value, arg=''):\n     \"\"\"\n     Runs Markdown over a given value, optionally using various\n@@ -73,9 +72,8 @@ def markdown(value, arg=''):\n                 return mark_safe(markdown.markdown(force_unicode(value), extensions, safe_mode=safe_mode))\n         else:\n             return mark_safe(force_unicode(markdown.markdown(smart_str(value))))\n-markdown.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def restructuredtext(value):\n     try:\n         from docutils.core import publish_parts\n@@ -87,5 +85,3 @@ def restructuredtext(value):\n         docutils_settings = getattr(settings, \"RESTRUCTUREDTEXT_FILTER_SETTINGS\", {})\n         parts = publish_parts(source=smart_str(value), writer_name=\"html4css1\", settings_overrides=docutils_settings)\n         return mark_safe(force_unicode(parts[\"fragment\"]))\n-restructuredtext.is_safe = True\n-"
        },
        {
            "sha": "238e2db9efaa2672436882ade22c60fa08fa600a",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -1057,30 +1057,43 @@ def tag_function(self, func):\n         self.tags[getattr(func, \"_decorated_function\", func).__name__] = func\n         return func\n \n-    def filter(self, name=None, filter_func=None):\n+    def filter(self, name=None, filter_func=None, **flags):\n         if name is None and filter_func is None:\n             # @register.filter()\n-            return self.filter_function\n-        elif filter_func is None:\n+            def dec(func):\n+                return self.filter_function(func, **flags)\n+            return dec\n+\n+        elif name is not None and filter_func is None:\n             if callable(name):\n                 # @register.filter\n-                return self.filter_function(name)\n+                return self.filter_function(name, **flags)\n             else:\n                 # @register.filter('somename') or @register.filter(name='somename')\n                 def dec(func):\n-                    return self.filter(name, func)\n+                    return self.filter(name, func, **flags)\n                 return dec\n+\n         elif name is not None and filter_func is not None:\n             # register.filter('somename', somefunc)\n             self.filters[name] = filter_func\n+            for attr in ('is_safe', 'needs_autoescape'):\n+                if attr in flags:\n+                    value = flags[attr]\n+                    # set the flag on the filter for FilterExpression.resolve\n+                    setattr(filter_func, attr, value)\n+                    # set the flag on the innermost decorated function\n+                    # for decorators that need it e.g. stringfilter\n+                    if hasattr(filter_func, \"_decorated_function\"):\n+                        setattr(filter_func._decorated_function, attr, value)\n             return filter_func\n         else:\n             raise InvalidTemplateLibrary(\"Unsupported arguments to \"\n                 \"Library.filter: (%r, %r)\", (name, filter_func))\n \n-    def filter_function(self, func):\n-        self.filters[getattr(func, \"_decorated_function\", func).__name__] = func\n-        return func\n+    def filter_function(self, func, **flags):\n+        name = getattr(func, \"_decorated_function\", func).__name__\n+        return self.filter(name, func, **flags)\n \n     def simple_tag(self, func=None, takes_context=None, name=None):\n         def dec(func):"
        },
        {
            "sha": "7484c7bf2854bdcd5af676089006b52ee52d56cd",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 67,
            "deletions": 119,
            "changes": 186,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -37,23 +37,33 @@ def _dec(*args, **kwargs):\n         if args:\n             args = list(args)\n             args[0] = force_unicode(args[0])\n-            if isinstance(args[0], SafeData) and getattr(func, 'is_safe', False):\n+            if (isinstance(args[0], SafeData) and\n+                getattr(_dec._decorated_function, 'is_safe', False)):\n                 return mark_safe(func(*args, **kwargs))\n         return func(*args, **kwargs)\n \n     # Include a reference to the real function (used to check original\n-    # arguments by the template parser).\n+    # arguments by the template parser, and to bear the 'is_safe' attribute\n+    # when multiple decorators are applied).\n     _dec._decorated_function = getattr(func, '_decorated_function', func)\n+\n     for attr in ('is_safe', 'needs_autoescape'):\n         if hasattr(func, attr):\n+            import warnings\n+            warnings.warn(\"Setting the %s attribute of a template filter \"\n+                          \"function is deprecated; use @register.filter(%s=%s) \"\n+                          \"instead\" % (attr, attr, getattr(func, attr)),\n+                          PendingDeprecationWarning)\n             setattr(_dec, attr, getattr(func, attr))\n+\n     return wraps(func)(_dec)\n \n+\n ###################\n # STRINGS         #\n ###################\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def addslashes(value):\n     \"\"\"\n@@ -62,27 +72,24 @@ def addslashes(value):\n     filter instead.\n     \"\"\"\n     return value.replace('\\\\', '\\\\\\\\').replace('\"', '\\\\\"').replace(\"'\", \"\\\\'\")\n-addslashes.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def capfirst(value):\n     \"\"\"Capitalizes the first character of the value.\"\"\"\n     return value and value[0].upper() + value[1:]\n-capfirst.is_safe = True\n \n @register.filter(\"escapejs\")\n @stringfilter\n def escapejs_filter(value):\n     \"\"\"Hex encodes characters for use in JavaScript strings.\"\"\"\n     return escapejs(value)\n \n-@register.filter(\"fix_ampersands\")\n+@register.filter(\"fix_ampersands\", is_safe=True)\n @stringfilter\n def fix_ampersands_filter(value):\n     \"\"\"Replaces ampersands with ``&amp;`` entities.\"\"\"\n     return fix_ampersands(value)\n-fix_ampersands_filter.is_safe = True\n \n # Values for testing floatformat input against infinity and NaN representations,\n # which differ across platforms and Python versions.  Some (i.e. old Windows\n@@ -96,7 +103,7 @@ def fix_ampersands_filter(value):\n nan = (1e200 * 1e200) // (1e200 * 1e200)\n special_floats = [str(pos_inf), str(neg_inf), str(nan)]\n \n-@register.filter\n+@register.filter(is_safe=True)\n def floatformat(text, arg=-1):\n     \"\"\"\n     Displays a float to a specified number of decimal places.\n@@ -172,16 +179,14 @@ def floatformat(text, arg=-1):\n         return mark_safe(formats.number_format(number, abs(p)))\n     except InvalidOperation:\n         return input_val\n-floatformat.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def iriencode(value):\n     \"\"\"Escapes an IRI value for use in a URL.\"\"\"\n     return force_unicode(iri_to_uri(value))\n-iriencode.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True, needs_autoescape=True)\n @stringfilter\n def linenumbers(value, autoescape=None):\n     \"\"\"Displays text with line numbers.\"\"\"\n@@ -196,17 +201,14 @@ def linenumbers(value, autoescape=None):\n         for i, line in enumerate(lines):\n             lines[i] = (u\"%0\" + width  + u\"d. %s\") % (i + 1, escape(line))\n     return mark_safe(u'\\n'.join(lines))\n-linenumbers.is_safe = True\n-linenumbers.needs_autoescape = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def lower(value):\n     \"\"\"Converts a string into all lowercase.\"\"\"\n     return value.lower()\n-lower.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=False)\n @stringfilter\n def make_list(value):\n     \"\"\"\n@@ -216,9 +218,8 @@ def make_list(value):\n     For a string, it's a list of characters.\n     \"\"\"\n     return list(value)\n-make_list.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def slugify(value):\n     \"\"\"\n@@ -228,9 +229,8 @@ def slugify(value):\n     value = unicodedata.normalize('NFKD', value).encode('ascii', 'ignore')\n     value = unicode(re.sub('[^\\w\\s-]', '', value).strip().lower())\n     return mark_safe(re.sub('[-\\s]+', '-', value))\n-slugify.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def stringformat(value, arg):\n     \"\"\"\n     Formats the variable according to the arg, a string formatting specifier.\n@@ -245,17 +245,15 @@ def stringformat(value, arg):\n         return (u\"%\" + unicode(arg)) % value\n     except (ValueError, TypeError):\n         return u\"\"\n-stringformat.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def title(value):\n     \"\"\"Converts a string into titlecase.\"\"\"\n     t = re.sub(\"([a-z])'([A-Z])\", lambda m: m.group(0).lower(), value.title())\n     return re.sub(\"\\d([A-Z])\", lambda m: m.group(0).lower(), t)\n-title.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def truncatechars(value, arg):\n     \"\"\"\n@@ -268,9 +266,8 @@ def truncatechars(value, arg):\n     except ValueError: # Invalid literal for int().\n         return value # Fail silently.\n     return Truncator(value).chars(length)\n-truncatechars.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def truncatewords(value, arg):\n     \"\"\"\n@@ -285,9 +282,8 @@ def truncatewords(value, arg):\n     except ValueError: # Invalid literal for int().\n         return value # Fail silently.\n     return Truncator(value).words(length, truncate=' ...')\n-truncatewords.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def truncatewords_html(value, arg):\n     \"\"\"\n@@ -302,16 +298,14 @@ def truncatewords_html(value, arg):\n     except ValueError: # invalid literal for int()\n         return value # Fail silently.\n     return Truncator(value).words(length, html=True, truncate=' ...')\n-truncatewords_html.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=False)\n @stringfilter\n def upper(value):\n     \"\"\"Converts a string into all uppercase.\"\"\"\n     return value.upper()\n-upper.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n @stringfilter\n def urlencode(value, safe=None):\n     \"\"\"\n@@ -326,17 +320,14 @@ def urlencode(value, safe=None):\n     if safe is not None:\n         kwargs['safe'] = safe\n     return urlquote(value, **kwargs)\n-urlencode.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=True, needs_autoescape=True)\n @stringfilter\n def urlize(value, autoescape=None):\n     \"\"\"Converts URLs in plain text into clickable links.\"\"\"\n     return mark_safe(urlize_impl(value, nofollow=True, autoescape=autoescape))\n-urlize.is_safe = True\n-urlize.needs_autoescape = True\n \n-@register.filter\n+@register.filter(is_safe=True, needs_autoescape=True)\n @stringfilter\n def urlizetrunc(value, limit, autoescape=None):\n     \"\"\"\n@@ -347,17 +338,14 @@ def urlizetrunc(value, limit, autoescape=None):\n     \"\"\"\n     return mark_safe(urlize_impl(value, trim_url_limit=int(limit), nofollow=True,\n                             autoescape=autoescape))\n-urlizetrunc.is_safe = True\n-urlizetrunc.needs_autoescape = True\n \n-@register.filter\n+@register.filter(is_safe=False)\n @stringfilter\n def wordcount(value):\n     \"\"\"Returns the number of words.\"\"\"\n     return len(value.split())\n-wordcount.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def wordwrap(value, arg):\n     \"\"\"\n@@ -366,9 +354,8 @@ def wordwrap(value, arg):\n     Argument: number of characters to wrap the text at.\n     \"\"\"\n     return wrap(value, int(arg))\n-wordwrap.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def ljust(value, arg):\n     \"\"\"\n@@ -377,9 +364,8 @@ def ljust(value, arg):\n     Argument: field size.\n     \"\"\"\n     return value.ljust(int(arg))\n-ljust.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def rjust(value, arg):\n     \"\"\"\n@@ -388,14 +374,12 @@ def rjust(value, arg):\n     Argument: field size.\n     \"\"\"\n     return value.rjust(int(arg))\n-rjust.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def center(value, arg):\n     \"\"\"Centers the value in a field of a given width.\"\"\"\n     return value.center(int(arg))\n-center.is_safe = True\n \n @register.filter\n @stringfilter\n@@ -413,16 +397,15 @@ def cut(value, arg):\n # HTML STRINGS    #\n ###################\n \n-@register.filter(\"escape\")\n+@register.filter(\"escape\", is_safe=True)\n @stringfilter\n def escape_filter(value):\n     \"\"\"\n     Marks the value as a string that should not be auto-escaped.\n     \"\"\"\n     return mark_for_escaping(value)\n-escape_filter.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def force_escape(value):\n     \"\"\"\n@@ -431,9 +414,8 @@ def force_escape(value):\n     possible escaping).\n     \"\"\"\n     return mark_safe(escape(value))\n-force_escape.is_safe = True\n \n-@register.filter(\"linebreaks\")\n+@register.filter(\"linebreaks\", is_safe=True, needs_autoescape=True)\n @stringfilter\n def linebreaks_filter(value, autoescape=None):\n     \"\"\"\n@@ -443,10 +425,8 @@ def linebreaks_filter(value, autoescape=None):\n     \"\"\"\n     autoescape = autoescape and not isinstance(value, SafeData)\n     return mark_safe(linebreaks(value, autoescape))\n-linebreaks_filter.is_safe = True\n-linebreaks_filter.needs_autoescape = True\n \n-@register.filter\n+@register.filter(is_safe=True, needs_autoescape=True)\n @stringfilter\n def linebreaksbr(value, autoescape=None):\n     \"\"\"\n@@ -458,29 +438,25 @@ def linebreaksbr(value, autoescape=None):\n     if autoescape:\n         value = escape(value)\n     return mark_safe(value.replace('\\n', '<br />'))\n-linebreaksbr.is_safe = True\n-linebreaksbr.needs_autoescape = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def safe(value):\n     \"\"\"\n     Marks the value as a string that should not be auto-escaped.\n     \"\"\"\n     return mark_safe(value)\n-safe.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def safeseq(value):\n     \"\"\"\n     A \"safe\" filter for sequences. Marks each element in the sequence,\n     individually, as safe, after converting them to unicode. Returns a list\n     with the results.\n     \"\"\"\n     return [mark_safe(force_unicode(obj)) for obj in value]\n-safeseq.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def removetags(value, tags):\n     \"\"\"Removes a space separated list of [X]HTML tags from the output.\"\"\"\n@@ -491,47 +467,42 @@ def removetags(value, tags):\n     value = starttag_re.sub(u'', value)\n     value = endtag_re.sub(u'', value)\n     return value\n-removetags.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n @stringfilter\n def striptags(value):\n     \"\"\"Strips all [X]HTML tags.\"\"\"\n     return strip_tags(value)\n-striptags.is_safe = True\n \n ###################\n # LISTS           #\n ###################\n \n-@register.filter\n+@register.filter(is_safe=False)\n def dictsort(value, arg):\n     \"\"\"\n     Takes a list of dicts, returns that list sorted by the property given in\n     the argument.\n     \"\"\"\n     return sorted(value, key=Variable(arg).resolve)\n-dictsort.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def dictsortreversed(value, arg):\n     \"\"\"\n     Takes a list of dicts, returns that list sorted in reverse order by the\n     property given in the argument.\n     \"\"\"\n     return sorted(value, key=Variable(arg).resolve, reverse=True)\n-dictsortreversed.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def first(value):\n     \"\"\"Returns the first item in a list.\"\"\"\n     try:\n         return value[0]\n     except IndexError:\n         return u''\n-first.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=True, needs_autoescape=True)\n def join(value, arg, autoescape=None):\n     \"\"\"\n     Joins a list with a string, like Python's ``str.join(list)``.\n@@ -544,43 +515,37 @@ def join(value, arg, autoescape=None):\n     except AttributeError: # fail silently but nicely\n         return value\n     return mark_safe(data)\n-join.is_safe = True\n-join.needs_autoescape = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def last(value):\n     \"Returns the last item in a list\"\n     try:\n         return value[-1]\n     except IndexError:\n         return u''\n-last.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def length(value):\n     \"\"\"Returns the length of the value - useful for lists.\"\"\"\n     try:\n         return len(value)\n     except (ValueError, TypeError):\n         return ''\n-length.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=False)\n def length_is(value, arg):\n     \"\"\"Returns a boolean of whether the value's length is the argument.\"\"\"\n     try:\n         return len(value) == int(arg)\n     except (ValueError, TypeError):\n         return ''\n-length_is.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=True)\n def random(value):\n     \"\"\"Returns a random item from the list.\"\"\"\n     return random_module.choice(value)\n-random.is_safe = True\n \n-@register.filter(\"slice\")\n+@register.filter(\"slice\", is_safe=True)\n def slice_filter(value, arg):\n     \"\"\"\n     Returns a slice of the list.\n@@ -600,9 +565,8 @@ def slice_filter(value, arg):\n \n     except (ValueError, TypeError):\n         return value # Fail silently.\n-slice_filter.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True, needs_autoescape=True)\n def unordered_list(value, autoescape=None):\n     \"\"\"\n     Recursively takes a self-nested list and returns an HTML unordered list --\n@@ -688,14 +652,12 @@ def _helper(list_, tabs=1):\n         return '\\n'.join(output)\n     value, converted = convert_old_style_list(value)\n     return mark_safe(_helper(value))\n-unordered_list.is_safe = True\n-unordered_list.needs_autoescape = True\n \n ###################\n # INTEGERS        #\n ###################\n \n-@register.filter\n+@register.filter(is_safe=False)\n def add(value, arg):\n     \"\"\"Adds the arg to the value.\"\"\"\n     try:\n@@ -705,9 +667,8 @@ def add(value, arg):\n             return value + arg\n         except Exception:\n             return ''\n-add.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def get_digit(value, arg):\n     \"\"\"\n     Given a whole number, returns the requested digit of it, where 1 is the\n@@ -726,13 +687,12 @@ def get_digit(value, arg):\n         return int(str(value)[-arg])\n     except IndexError:\n         return 0\n-get_digit.is_safe = False\n \n ###################\n # DATES           #\n ###################\n \n-@register.filter\n+@register.filter(is_safe=False)\n def date(value, arg=None):\n     \"\"\"Formats a date according to the given format.\"\"\"\n     if not value:\n@@ -746,9 +706,8 @@ def date(value, arg=None):\n             return format(value, arg)\n         except AttributeError:\n             return ''\n-date.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def time(value, arg=None):\n     \"\"\"Formats a time according to the given format.\"\"\"\n     if value in (None, u''):\n@@ -762,9 +721,8 @@ def time(value, arg=None):\n             return time_format(value, arg)\n         except AttributeError:\n             return ''\n-time.is_safe = False\n \n-@register.filter(\"timesince\")\n+@register.filter(\"timesince\", is_safe=False)\n def timesince_filter(value, arg=None):\n     \"\"\"Formats a date as the time since that date (i.e. \"4 days, 6 hours\").\"\"\"\n     if not value:\n@@ -775,9 +733,8 @@ def timesince_filter(value, arg=None):\n         return timesince(value)\n     except (ValueError, TypeError):\n         return u''\n-timesince_filter.is_safe = False\n \n-@register.filter(\"timeuntil\")\n+@register.filter(\"timeuntil\", is_safe=False)\n def timeuntil_filter(value, arg=None):\n     \"\"\"Formats a date as the time until that date (i.e. \"4 days, 6 hours\").\"\"\"\n     if not value:\n@@ -786,33 +743,29 @@ def timeuntil_filter(value, arg=None):\n         return timeuntil(value, arg)\n     except (ValueError, TypeError):\n         return u''\n-timeuntil_filter.is_safe = False\n \n ###################\n # LOGIC           #\n ###################\n \n-@register.filter\n+@register.filter(is_safe=False)\n def default(value, arg):\n     \"\"\"If value is unavailable, use given default.\"\"\"\n     return value or arg\n-default.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def default_if_none(value, arg):\n     \"\"\"If value is None, use given default.\"\"\"\n     if value is None:\n         return arg\n     return value\n-default_if_none.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def divisibleby(value, arg):\n     \"\"\"Returns True if the value is devisible by the argument.\"\"\"\n     return int(value) % int(arg) == 0\n-divisibleby.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def yesno(value, arg=None):\n     \"\"\"\n     Given a string mapping values for true, false and (optionally) None,\n@@ -843,13 +796,12 @@ def yesno(value, arg=None):\n     if value:\n         return yes\n     return no\n-yesno.is_safe = False\n \n ###################\n # MISC            #\n ###################\n \n-@register.filter\n+@register.filter(is_safe=True)\n def filesizeformat(bytes):\n     \"\"\"\n     Formats the value like a 'human-readable' file size (i.e. 13 KB, 4.1 MB,\n@@ -873,9 +825,8 @@ def filesizeformat(bytes):\n     if bytes < 1024 * 1024 * 1024 * 1024 * 1024:\n         return ugettext(\"%s TB\") % filesize_number_format(bytes / (1024 * 1024 * 1024 * 1024))\n     return ugettext(\"%s PB\") % filesize_number_format(bytes / (1024 * 1024 * 1024 * 1024 * 1024))\n-filesizeformat.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=False)\n def pluralize(value, arg=u's'):\n     \"\"\"\n     Returns a plural suffix if the value is not 1. By default, 's' is used as\n@@ -918,19 +869,16 @@ def pluralize(value, arg=u's'):\n         except TypeError: # len() of unsized object.\n             pass\n     return singular_suffix\n-pluralize.is_safe = False\n \n-@register.filter(\"phone2numeric\")\n+@register.filter(\"phone2numeric\", is_safe=True)\n def phone2numeric_filter(value):\n     \"\"\"Takes a phone number and converts it in to its numerical equivalent.\"\"\"\n     return phone2numeric(value)\n-phone2numeric_filter.is_safe = True\n \n-@register.filter\n+@register.filter(is_safe=True)\n def pprint(value):\n     \"\"\"A wrapper around pprint.pprint -- for debugging, really.\"\"\"\n     try:\n         return pformat(value)\n     except Exception, e:\n         return u\"Error in formatting: %s\" % force_unicode(e, errors=\"replace\")\n-pprint.is_safe = True"
        },
        {
            "sha": "1eac1de0712b6cdd5be1a7d333d43285661d9463",
            "filename": "django/templatetags/l10n.py",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/django%2Ftemplatetags%2Fl10n.py",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/django%2Ftemplatetags%2Fl10n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fl10n.py?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -5,23 +5,21 @@\n \n register = Library()\n \n-@register.filter\n+@register.filter(is_safe=False)\n def localize(value):\n     \"\"\"\n     Forces a value to be rendered as a localized value,\n     regardless of the value of ``settings.USE_L10N``.\n     \"\"\"\n     return force_unicode(formats.localize(value, use_l10n=True))\n-localize.is_safe = False\n \n-@register.filter\n+@register.filter(is_safe=False)\n def unlocalize(value):\n     \"\"\"\n     Forces a value to be rendered as a non-localized value,\n     regardless of the value of ``settings.USE_L10N``.\n     \"\"\"\n     return force_unicode(value)\n-unlocalize.is_safe = False\n \n class LocalizeNode(Node):\n     def __init__(self, nodelist, use_l10n):"
        },
        {
            "sha": "6b2355e8d0e50c23414283b4fe219f9c552a93f5",
            "filename": "docs/howto/custom-template-tags.txt",
            "status": "modified",
            "additions": 52,
            "deletions": 29,
            "changes": 81,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/docs%2Fhowto%2Fcustom-template-tags.txt",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/docs%2Fhowto%2Fcustom-template-tags.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fcustom-template-tags.txt?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -143,6 +143,10 @@ You can use ``register.filter()`` as a decorator instead:\n If you leave off the ``name`` argument, as in the second example above, Django\n will use the function's name as the filter name.\n \n+Finally, ``register.filter()`` also accepts two keyword arguments, ``is_safe``\n+and ``needs_autoescape``, described in :ref:`filters and auto-escaping\n+<filters-auto-escaping>` below.\n+\n Template filters that expect strings\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -166,6 +170,8 @@ This way, you'll be able to pass, say, an integer to this filter, and it\n won't cause an ``AttributeError`` (because integers don't have ``lower()``\n methods).\n \n+.. _filters-auto-escaping:\n+\n Filters and auto-escaping\n ~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -206,17 +212,16 @@ Template filter code falls into one of two situations:\n 1. Your filter does not introduce any HTML-unsafe characters (``<``, ``>``,\n    ``'``, ``\"`` or ``&``) into the result that were not already present. In\n    this case, you can let Django take care of all the auto-escaping\n-   handling for you. All you need to do is put the ``is_safe`` attribute on\n-   your filter function and set it to ``True``, like so:\n+   handling for you. All you need to do is set the ``is_safe`` flag to ``True``\n+   when you register your filter function, like so:\n \n    .. code-block:: python\n \n-       @register.filter\n+       @register.filter(is_safe=True)\n        def myfilter(value):\n            return value\n-       myfilter.is_safe = True\n \n-   This attribute tells Django that if a \"safe\" string is passed into your\n+   This flag tells Django that if a \"safe\" string is passed into your\n    filter, the result will still be \"safe\" and if a non-safe string is\n    passed in, Django will automatically escape it, if necessary.\n \n@@ -236,17 +241,16 @@ Template filter code falls into one of two situations:\n \n    .. code-block:: python\n \n-       @register.filter\n+       @register.filter(is_safe=True)\n        def add_xx(value):\n            return '%sxx' % value\n-       add_xx.is_safe = True\n \n    When this filter is used in a template where auto-escaping is enabled,\n    Django will escape the output whenever the input is not already marked\n    as \"safe\".\n \n-   By default, ``is_safe`` defaults to ``False``, and you can omit it from\n-   any filters where it isn't required.\n+   By default, ``is_safe`` is ``False``, and you can omit it from any filters\n+   where it isn't required.\n \n    Be careful when deciding if your filter really does leave safe strings\n    as safe. If you're *removing* characters, you might inadvertently leave\n@@ -279,12 +283,12 @@ Template filter code falls into one of two situations:\n    can operate in templates where auto-escaping is either on or off in\n    order to make things easier for your template authors.\n \n-   In order for your filter to know the current auto-escaping state, set\n-   the ``needs_autoescape`` attribute to ``True`` on your function. (If you\n-   don't specify this attribute, it defaults to ``False``). This attribute\n-   tells Django that your filter function wants to be passed an extra\n-   keyword argument, called ``autoescape``, that is ``True`` if\n-   auto-escaping is in effect and ``False`` otherwise.\n+   In order for your filter to know the current auto-escaping state, set the\n+   ``needs_autoescape`` flag to ``True`` when you register your filter function.\n+   (If you don't specify this flag, it defaults to ``False``). This flag tells\n+   Django that your filter function wants to be passed an extra keyword\n+   argument, called ``autoescape``, that is ``True`` if auto-escaping is in\n+   effect and ``False`` otherwise.\n \n    For example, let's write a filter that emphasizes the first character of\n    a string:\n@@ -294,6 +298,7 @@ Template filter code falls into one of two situations:\n        from django.utils.html import conditional_escape\n        from django.utils.safestring import mark_safe\n \n+       @register.filter(needs_autoescape=True)\n        def initial_letter_filter(text, autoescape=None):\n            first, other = text[0], text[1:]\n            if autoescape:\n@@ -302,27 +307,45 @@ Template filter code falls into one of two situations:\n                esc = lambda x: x\n            result = '<strong>%s</strong>%s' % (esc(first), esc(other))\n            return mark_safe(result)\n-       initial_letter_filter.needs_autoescape = True\n-\n-   The ``needs_autoescape`` attribute on the filter function and the\n-   ``autoescape`` keyword argument mean that our function will know whether\n-   automatic escaping is in effect when the filter is called. We use\n-   ``autoescape`` to decide whether the input data needs to be passed\n-   through ``django.utils.html.conditional_escape`` or not. (In the latter\n-   case, we just use the identity function as the \"escape\" function.) The\n-   ``conditional_escape()`` function is like ``escape()`` except it only\n-   escapes input that is **not** a ``SafeData`` instance. If a ``SafeData``\n-   instance is passed to ``conditional_escape()``, the data is returned\n-   unchanged.\n+\n+   The ``needs_autoescape`` flag and the ``autoescape`` keyword argument mean\n+   that our function will know whether automatic escaping is in effect when the\n+   filter is called. We use ``autoescape`` to decide whether the input data\n+   needs to be passed through ``django.utils.html.conditional_escape`` or not.\n+   (In the latter case, we just use the identity function as the \"escape\"\n+   function.) The ``conditional_escape()`` function is like ``escape()`` except\n+   it only escapes input that is **not** a ``SafeData`` instance. If a\n+   ``SafeData`` instance is passed to ``conditional_escape()``, the data is\n+   returned unchanged.\n \n    Finally, in the above example, we remember to mark the result as safe\n    so that our HTML is inserted directly into the template without further\n    escaping.\n \n-   There's no need to worry about the ``is_safe`` attribute in this case\n+   There's no need to worry about the ``is_safe`` flag in this case\n    (although including it wouldn't hurt anything). Whenever you manually\n    handle the auto-escaping issues and return a safe string, the\n-   ``is_safe`` attribute won't change anything either way.\n+   ``is_safe`` flag won't change anything either way.\n+\n+.. versionchanged:: 1.4\n+\n+``is_safe`` and ``needs_autoescape`` used to be attributes of the filter\n+function; this syntax is deprecated.\n+\n+.. code-block:: python\n+\n+    @register.filter\n+    def myfilter(value):\n+        return value\n+    myfilter.is_safe = True\n+\n+.. code-block:: python\n+\n+    @register.filter\n+    def initial_letter_filter(text, autoescape=None):\n+        # ...\n+        return mark_safe(result)\n+    initial_letter_filter.needs_autoescape = True\n \n Writing custom template tags\n ----------------------------"
        },
        {
            "sha": "603f20dbab758153e37e2c95437e8b94a066e95c",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -251,6 +251,9 @@ these changes.\n   :mod:`django.core.management`. This also means that the old (pre-1.4)\n   style of :file:`manage.py` file will no longer work.\n \n+* Setting the ``is_safe`` and ``needs_autoescape`` flags as attributes of\n+  template filter functions will no longer be supported.\n+\n 2.0\n ---\n "
        },
        {
            "sha": "7f788311c65146d6462343f1c1ec31ae75b0a7d0",
            "filename": "tests/regressiontests/templates/templatetags/custom.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/d17bc72880caea967ee1f4332941269837b68a2a/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "raw_url": "https://github.com/django/django/raw/d17bc72880caea967ee1f4332941269837b68a2a/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py?ref=d17bc72880caea967ee1f4332941269837b68a2a",
            "patch": "@@ -6,11 +6,10 @@\n \n register = template.Library()\n \n+@register.filter\n+@stringfilter\n def trim(value, num):\n     return value[:num]\n-trim = stringfilter(trim)\n-\n-register.filter(trim)\n \n @register.simple_tag\n def no_params():\n@@ -303,4 +302,4 @@ def assignment_unlimited_args_kwargs(one, two='hi', *args, **kwargs):\n def assignment_tag_without_context_parameter(arg):\n     \"\"\"Expected assignment_tag_without_context_parameter __doc__\"\"\"\n     return \"Expected result\"\n-assignment_tag_without_context_parameter.anything = \"Expected assignment_tag_without_context_parameter __dict__\"\n\\ No newline at end of file\n+assignment_tag_without_context_parameter.anything = \"Expected assignment_tag_without_context_parameter __dict__\""
        }
    ],
    "stats": {
        "total": 334,
        "additions": 155,
        "deletions": 179
    }
}