{
    "author": "ptone",
    "message": "Fixed a security issue related to password resets\n\nFull disclosure and new release are forthcoming",
    "sha": "9305c0e12d43c4df999c3301a1f0c742264a657e",
    "files": [
        {
            "sha": "4b498ceaf0a778845607e301c0ace5753568fe3f",
            "filename": "django/contrib/auth/tests/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fcontrib%2Fauth%2Ftests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fcontrib%2Fauth%2Ftests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Furls.py?ref=9305c0e12d43c4df999c3301a1f0c742264a657e",
            "patch": "@@ -55,6 +55,7 @@ def userpage(request):\n     (r'^logout/next_page/$', 'django.contrib.auth.views.logout', dict(next_page='/somewhere/')),\n     (r'^remote_user/$', remote_user_auth_view),\n     (r'^password_reset_from_email/$', 'django.contrib.auth.views.password_reset', dict(from_email='staffmember@example.com')),\n+    (r'^admin_password_reset/$', 'django.contrib.auth.views.password_reset', dict(is_admin_site=True)),\n     (r'^login_required/$', login_required(password_reset)),\n     (r'^login_required_login_url/$', login_required(password_reset, login_url='/somewhere/')),\n "
        },
        {
            "sha": "bb17576d3146e56f898190986cf07d05bab14abd",
            "filename": "django/contrib/auth/tests/views.py",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py?ref=9305c0e12d43c4df999c3301a1f0c742264a657e",
            "patch": "@@ -5,6 +5,7 @@\n from django.contrib.sites.models import Site, RequestSite\n from django.contrib.auth.models import User\n from django.core import mail\n+from django.core.exceptions import SuspiciousOperation\n from django.core.urlresolvers import reverse, NoReverseMatch\n from django.http import QueryDict\n from django.utils.encoding import force_text\n@@ -103,6 +104,42 @@ def test_email_found_custom_from(self):\n         self.assertEqual(len(mail.outbox), 1)\n         self.assertEqual(\"staffmember@example.com\", mail.outbox[0].from_email)\n \n+    def test_admin_reset(self):\n+        \"If the reset view is marked as being for admin, the HTTP_HOST header is used for a domain override.\"\n+        response = self.client.post('/admin_password_reset/',\n+            {'email': 'staffmember@example.com'},\n+            HTTP_HOST='adminsite.com'\n+        )\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(len(mail.outbox), 1)\n+        self.assertTrue(\"http://adminsite.com\" in mail.outbox[0].body)\n+        self.assertEqual(settings.DEFAULT_FROM_EMAIL, mail.outbox[0].from_email)\n+\n+    def test_poisoned_http_host(self):\n+        \"Poisoned HTTP_HOST headers can't be used for reset emails\"\n+        # This attack is based on the way browsers handle URLs. The colon\n+        # should be used to separate the port, but if the URL contains an @,\n+        # the colon is interpreted as part of a username for login purposes,\n+        # making 'evil.com' the request domain. Since HTTP_HOST is used to\n+        # produce a meaningful reset URL, we need to be certain that the\n+        # HTTP_HOST header isn't poisoned. This is done as a check when get_host()\n+        # is invoked, but we check here as a practical consequence.\n+        with self.assertRaises(SuspiciousOperation):\n+            self.client.post('/password_reset/',\n+                {'email': 'staffmember@example.com'},\n+                HTTP_HOST='www.example:dr.frankenstein@evil.tld'\n+            )\n+        self.assertEqual(len(mail.outbox), 0)\n+\n+    def test_poisoned_http_host_admin_site(self):\n+        \"Poisoned HTTP_HOST headers can't be used for reset emails on admin views\"\n+        with self.assertRaises(SuspiciousOperation):\n+            self.client.post('/admin_password_reset/',\n+                {'email': 'staffmember@example.com'},\n+                HTTP_HOST='www.example:dr.frankenstein@evil.tld'\n+            )\n+        self.assertEqual(len(mail.outbox), 0)\n+\n     def _test_confirm_start(self):\n         # Start by creating the email\n         response = self.client.post('/password_reset/', {'email': 'staffmember@example.com'})"
        },
        {
            "sha": "d27e2f5aba51e46e3567b7f71f101163e417db8d",
            "filename": "django/contrib/auth/views.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fcontrib%2Fauth%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fcontrib%2Fauth%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fviews.py?ref=9305c0e12d43c4df999c3301a1f0c742264a657e",
            "patch": "@@ -163,7 +163,7 @@ def password_reset(request, is_admin_site=False,\n                 'request': request,\n             }\n             if is_admin_site:\n-                opts = dict(opts, domain_override=request.META['HTTP_HOST'])\n+                opts = dict(opts, domain_override=request.get_host())\n             form.save(**opts)\n             return HttpResponseRedirect(post_reset_redirect)\n     else:"
        },
        {
            "sha": "b385b450eeede3ee4c3e7524797121a7cdcf08a6",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/9305c0e12d43c4df999c3301a1f0c742264a657e/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=9305c0e12d43c4df999c3301a1f0c742264a657e",
            "patch": "@@ -180,6 +180,11 @@ def get_host(self):\n             server_port = str(self.META['SERVER_PORT'])\n             if server_port != ('443' if self.is_secure() else '80'):\n                 host = '%s:%s' % (host, server_port)\n+\n+        # Disallow potentially poisoned hostnames.\n+        if set(';/?@&=+$,').intersection(host):\n+            raise SuspiciousOperation('Invalid HTTP_HOST header: %s' % host)\n+\n         return host\n \n     def get_full_path(self):"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 44,
        "deletions": 1
    }
}