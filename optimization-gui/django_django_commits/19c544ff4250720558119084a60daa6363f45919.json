{
    "author": "aaugustin",
    "message": "Fixed #17300 -- Prevented createcachetable from crashing when the cache table already exists. Thanks Claude Paroz.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17363 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "19c544ff4250720558119084a60daa6363f45919",
    "files": [
        {
            "sha": "08fa5f2c3dc5b826dcedbe313b8523bb720b8317",
            "filename": "django/core/management/commands/createcachetable.py",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/19c544ff4250720558119084a60daa6363f45919/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "raw_url": "https://github.com/django/django/raw/19c544ff4250720558119084a60daa6363f45919/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py?ref=19c544ff4250720558119084a60daa6363f45919",
            "patch": "@@ -3,6 +3,7 @@\n from django.core.cache.backends.db import BaseDatabaseCache\n from django.core.management.base import LabelCommand\n from django.db import connections, router, transaction, models, DEFAULT_DB_ALIAS\n+from django.db.utils import DatabaseError\n \n class Command(LabelCommand):\n     help = \"Creates the table needed to use the SQL cache backend.\"\n@@ -51,7 +52,14 @@ def handle_label(self, tablename, **options):\n             full_statement.append('    %s%s' % (line, i < len(table_output)-1 and ',' or ''))\n         full_statement.append(');')\n         curs = connection.cursor()\n-        curs.execute(\"\\n\".join(full_statement))\n-        for statement in index_output:\n-            curs.execute(statement)\n-        transaction.commit_unless_managed(using=db)\n+        try:\n+            curs.execute(\"\\n\".join(full_statement))\n+        except DatabaseError, e:\n+            self.stderr.write(\n+                self.style.ERROR(\"Cache table '%s' could not be created.\\nThe error was: %s.\\n\" %\n+                    (tablename, e)))\n+            transaction.rollback_unless_managed(using=db)\n+        else:\n+            for statement in index_output:\n+                curs.execute(statement)\n+            transaction.commit_unless_managed(using=db)"
        },
        {
            "sha": "0e28f66ae82a762acb52f4d2a2e99581b245daaa",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/19c544ff4250720558119084a60daa6363f45919/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/19c544ff4250720558119084a60daa6363f45919/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=19c544ff4250720558119084a60daa6363f45919",
            "patch": "@@ -7,6 +7,7 @@\n import hashlib\n import os\n import re\n+import StringIO\n import tempfile\n import time\n import warnings\n@@ -817,6 +818,11 @@ def test_old_initialization(self):\n         self.cache = get_cache('db://%s?max_entries=30&cull_frequency=0' % self._table_name)\n         self.perform_cull_test(50, 18)\n \n+    def test_second_call_doesnt_crash(self):\n+        err = StringIO.StringIO()\n+        management.call_command('createcachetable', self._table_name, verbosity=0, interactive=False, stderr=err)\n+        self.assertTrue(\"Cache table 'test cache table' could not be created\" in err.getvalue())\n+\n \n DBCacheWithTimeZoneTests = override_settings(USE_TZ=True)(DBCacheTests)\n "
        }
    ],
    "stats": {
        "total": 22,
        "additions": 18,
        "deletions": 4
    }
}