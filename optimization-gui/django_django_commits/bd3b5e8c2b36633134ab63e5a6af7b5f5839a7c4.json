{
    "author": "ramiro",
    "message": "Fixed #15517 -- Fixed regression in admin search_fields option introduced in r15526. Thanks Fabian Buechler for the report and fix and Julien Phalip for adding tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15677 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4",
    "files": [
        {
            "sha": "4b56348318b5063819d1efb6f61debdf3448376a",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4",
            "patch": "@@ -254,12 +254,15 @@ def construct_search(field_name):\n                 return \"%s__icontains\" % field_name\n \n         if self.search_fields and self.query:\n+            orm_lookups = [construct_search(str(search_field))\n+                           for search_field in self.search_fields]\n             for bit in self.query.split():\n-                or_queries = [models.Q(**{construct_search(str(field_name)): bit}) for field_name in self.search_fields]\n+                or_queries = [models.Q(**{orm_lookup: bit})\n+                              for orm_lookup in orm_lookups]\n                 qs = qs.filter(reduce(operator.or_, or_queries))\n             if not use_distinct:\n-                for search_field in self.search_fields:\n-                    field_name = search_field.split('__', 1)[0]\n+                for search_spec in orm_lookups:\n+                    field_name = search_spec.split('__', 1)[0]\n                     f = self.lookup_opts.get_field_by_name(field_name)[0]\n                     if hasattr(f, 'rel') and isinstance(f.rel, models.ManyToManyRel):\n                         use_distinct = True"
        },
        {
            "sha": "3b44f94d8b414743c04830ddbcb00fb314271a81",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4",
            "patch": "@@ -258,7 +258,7 @@ class PersonAdmin(admin.ModelAdmin):\n     list_display = ('name', 'gender', 'alive')\n     list_editable = ('gender', 'alive')\n     list_filter = ('gender',)\n-    search_fields = (u'name',)\n+    search_fields = ('^name',)\n     ordering = [\"id\"]\n     save_as = True\n \n@@ -445,7 +445,7 @@ class Recommendation(Title):\n     recommender = models.ForeignKey(Recommender)\n \n class RecommendationAdmin(admin.ModelAdmin):\n-    search_fields = ('titletranslation__text', 'recommender__titletranslation__text',)\n+    search_fields = ('=titletranslation__text', '=recommender__titletranslation__text',)\n \n class Collector(models.Model):\n     name = models.CharField(max_length=100)"
        },
        {
            "sha": "ff97acd878615a1d5d246b1973f3011f2549a71b",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 4,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=bd3b5e8c2b36633134ab63e5a6af7b5f5839a7c4",
            "patch": "@@ -1288,11 +1288,11 @@ def test_shortcut_view_only_available_to_staff(self):\n         user_ctype = ContentType.objects.get_for_model(User)\n         user = User.objects.get(username='super')\n         shortcut_url = \"/test_admin/admin/r/%s/%s/\" % (user_ctype.pk, user.pk)\n-        \n+\n         # Not logged in: we should see the login page.\n         response = self.client.get(shortcut_url, follow=False)\n         self.assertTemplateUsed(response, 'admin/login.html')\n-        \n+\n         # Logged in? Redirect.\n         self.client.login(username='super', password='secret')\n         response = self.client.get(shortcut_url, follow=False)\n@@ -1470,7 +1470,7 @@ def test_post_submission(self):\n \n             \"_save\": \"Save\",\n         }\n-        self.client.post('/test_admin/admin/admin_views/person/?q=mauchly', data)\n+        self.client.post('/test_admin/admin/admin_views/person/?q=john', data)\n \n         self.assertEqual(Person.objects.get(name=\"John Mauchly\").alive, False)\n \n@@ -1680,7 +1680,8 @@ def test_list_editable_popup(self):\n \n \n class AdminSearchTest(TestCase):\n-    fixtures = ['admin-views-users','multiple-child-classes']\n+    fixtures = ['admin-views-users', 'multiple-child-classes',\n+                'admin-views-person']\n \n     def setUp(self):\n         self.client.login(username='super', password='secret')\n@@ -1703,6 +1704,26 @@ def test_with_fk_to_field(self):\n         self.assertContains(response, \"\\n1 user\\n\")\n         self.assertContains(response, '<input type=\"hidden\" name=\"t\" value=\"username\"/>')\n \n+    def test_exact_matches(self):\n+        response = self.client.get('/test_admin/admin/admin_views/recommendation/?q=bar')\n+        # confirm the search returned one object\n+        self.assertContains(response, \"\\n1 recommendation\\n\")\n+\n+        response = self.client.get('/test_admin/admin/admin_views/recommendation/?q=ba')\n+        # confirm the search returned zero objects\n+        self.assertContains(response, \"\\n0 recommendations\\n\")\n+\n+    def test_beginning_matches(self):\n+        response = self.client.get('/test_admin/admin/admin_views/person/?q=Gui')\n+        # confirm the search returned one object\n+        self.assertContains(response, \"\\n1 person\\n\")\n+        self.assertContains(response, \"Guido\")\n+\n+        response = self.client.get('/test_admin/admin/admin_views/person/?q=uido')\n+        # confirm the search returned zero objects\n+        self.assertContains(response, \"\\n0 persons\\n\")\n+        self.assertNotContains(response, \"Guido\")\n+\n \n class AdminInheritedInlinesTest(TestCase):\n     fixtures = ['admin-views-users.xml',]"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 33,
        "deletions": 9
    }
}