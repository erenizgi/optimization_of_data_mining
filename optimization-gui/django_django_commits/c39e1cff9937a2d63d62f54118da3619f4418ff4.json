{
    "author": "jphalip",
    "message": "Fixed #17972 -- Ensured that admin filters on a foreign key respect the `to_field` attribute. This fixes a regression introduced in [14674] and Django 1.3. Thanks to graveyboat and Karen Tracey for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17854 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c39e1cff9937a2d63d62f54118da3619f4418ff4",
    "files": [
        {
            "sha": "76b8d30c0d3815579660696e933566b09c29a76f",
            "filename": "django/contrib/admin/filters.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/c39e1cff9937a2d63d62f54118da3619f4418ff4/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "raw_url": "https://github.com/django/django/raw/c39e1cff9937a2d63d62f54118da3619f4418ff4/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilters.py?ref=c39e1cff9937a2d63d62f54118da3619f4418ff4",
            "patch": "@@ -155,7 +155,10 @@ def create(cls, field, request, params, model, model_admin, field_path):\n class RelatedFieldListFilter(FieldListFilter):\n     def __init__(self, field, request, params, model, model_admin, field_path):\n         other_model = get_model_from_relation(field)\n-        rel_name = other_model._meta.pk.name\n+        if hasattr(field, 'rel'):\n+            rel_name = field.rel.get_related_field().name\n+        else:\n+            rel_name = other_model._meta.pk.name\n         self.lookup_kwarg = '%s__%s__exact' % (field_path, rel_name)\n         self.lookup_kwarg_isnull = '%s__isnull' % field_path\n         self.lookup_val = request.GET.get(self.lookup_kwarg, None)"
        },
        {
            "sha": "2071792bdbf1344f91ec3291a3e421d6ea18f44d",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/c39e1cff9937a2d63d62f54118da3619f4418ff4/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/c39e1cff9937a2d63d62f54118da3619f4418ff4/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=c39e1cff9937a2d63d62f54118da3619f4418ff4",
            "patch": "@@ -245,7 +245,7 @@ def lookup_allowed(self, lookup, value):\n         # if foo has been specificially included in the lookup list; so\n         # drop __id if it is the last part. However, first we need to find\n         # the pk attribute name.\n-        pk_attr_name = None\n+        rel_name = None\n         for part in parts[:-1]:\n             try:\n                 field, _, _, _ = model._meta.get_field_by_name(part)\n@@ -255,13 +255,13 @@ def lookup_allowed(self, lookup, value):\n                 return True\n             if hasattr(field, 'rel'):\n                 model = field.rel.to\n-                pk_attr_name = model._meta.pk.name\n+                rel_name = field.rel.get_related_field().name\n             elif isinstance(field, RelatedObject):\n                 model = field.model\n-                pk_attr_name = model._meta.pk.name\n+                rel_name = model._meta.pk.name\n             else:\n-                pk_attr_name = None\n-        if pk_attr_name and len(parts) > 1 and parts[-1] == pk_attr_name:\n+                rel_name = None\n+        if rel_name and len(parts) > 1 and parts[-1] == rel_name:\n             parts.pop()\n \n         if len(parts) == 1:"
        },
        {
            "sha": "deb8ee88c359889aec5ffb4abd7ed22de2efd7c1",
            "filename": "tests/regressiontests/admin_filters/models.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/c39e1cff9937a2d63d62f54118da3619f4418ff4/tests%2Fregressiontests%2Fadmin_filters%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/c39e1cff9937a2d63d62f54118da3619f4418ff4/tests%2Fregressiontests%2Fadmin_filters%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Fmodels.py?ref=c39e1cff9937a2d63d62f54118da3619f4418ff4",
            "patch": "@@ -13,3 +13,18 @@ class Book(models.Model):\n \n     def __unicode__(self):\n         return self.title\n+\n+\n+class Department(models.Model):\n+    code = models.CharField(max_length=4, unique=True)\n+    description = models.CharField(max_length=50, blank=True, null=True)\n+\n+    def __unicode__(self):\n+        return self.description\n+\n+class Employee(models.Model):\n+    department = models.ForeignKey(Department, to_field=\"code\")\n+    name = models.CharField(max_length=100)\n+\n+    def __unicode__(self):\n+        return self.name\n\\ No newline at end of file"
        },
        {
            "sha": "d87c447e302072472239130539f2230406bfdf74",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 65,
            "deletions": 3,
            "changes": 68,
            "blob_url": "https://github.com/django/django/blob/c39e1cff9937a2d63d62f54118da3619f4418ff4/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c39e1cff9937a2d63d62f54118da3619f4418ff4/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=c39e1cff9937a2d63d62f54118da3619f4418ff4",
            "patch": "@@ -4,7 +4,6 @@\n \n from django.contrib.admin import (site, ModelAdmin, SimpleListFilter,\n     BooleanFieldListFilter)\n-from django.contrib.admin.options import IncorrectLookupParameters\n from django.contrib.admin.views.main import ChangeList\n from django.contrib.auth.admin import UserAdmin\n from django.contrib.auth.models import User\n@@ -13,7 +12,7 @@\n from django.test.utils import override_settings\n from django.utils.encoding import force_unicode\n \n-from .models import Book\n+from .models import Book, Department, Employee\n \n \n def select_by(dictlist, key, value):\n@@ -113,6 +112,9 @@ class DecadeFilterBookAdminParameterEndsWith__In(ModelAdmin):\n class DecadeFilterBookAdminParameterEndsWith__Isnull(ModelAdmin):\n     list_filter = (DecadeListFilterParameterEndsWith__Isnull,)\n \n+class EmployeeAdmin(ModelAdmin):\n+    list_display = ['name', 'department']\n+    list_filter = ['department']\n \n \n class ListFiltersTests(TestCase):\n@@ -633,4 +635,64 @@ def test_parameter_ends_with__in__or__isnull(self):\n         choices = list(filterspec.choices(changelist))\n         self.assertEqual(choices[2]['display'], u'the 1990\\'s')\n         self.assertEqual(choices[2]['selected'], True)\n-        self.assertEqual(choices[2]['query_string'], '?decade__isnull=the+90s')\n\\ No newline at end of file\n+        self.assertEqual(choices[2]['query_string'], '?decade__isnull=the+90s')\n+\n+    def test_fk_with_to_field(self):\n+        \"\"\"\n+        Ensure that a filter on a FK respects the FK's to_field attribute.\n+        Refs #17972.\n+        \"\"\"\n+        modeladmin = EmployeeAdmin(Employee, site)\n+\n+        dev = Department.objects.create(code='DEV', description='Development')\n+        design = Department.objects.create(code='DSN', description='Design')\n+        john = Employee.objects.create(name='John Blue', department=dev)\n+        jack = Employee.objects.create(name='Jack Red', department=design)\n+\n+        request = self.request_factory.get('/', {})\n+        changelist = self.get_changelist(request, Employee, modeladmin)\n+\n+        # Make sure the correct queryset is returned\n+        queryset = changelist.get_query_set(request)\n+        self.assertEqual(list(queryset), [john, jack])\n+\n+        filterspec = changelist.get_filters(request)[0][-1]\n+        self.assertEqual(force_unicode(filterspec.title), u'department')\n+        choices = list(filterspec.choices(changelist))\n+\n+        self.assertEqual(choices[0]['display'], u'All')\n+        self.assertEqual(choices[0]['selected'], True)\n+        self.assertEqual(choices[0]['query_string'], '?')\n+\n+        self.assertEqual(choices[1]['display'], u'Development')\n+        self.assertEqual(choices[1]['selected'], False)\n+        self.assertEqual(choices[1]['query_string'], '?department__code__exact=DEV')\n+\n+        self.assertEqual(choices[2]['display'], u'Design')\n+        self.assertEqual(choices[2]['selected'], False)\n+        self.assertEqual(choices[2]['query_string'], '?department__code__exact=DSN')\n+\n+        # Filter by Department=='Development' --------------------------------\n+\n+        request = self.request_factory.get('/', {'department__code__exact': 'DEV'})\n+        changelist = self.get_changelist(request, Employee, modeladmin)\n+\n+        # Make sure the correct queryset is returned\n+        queryset = changelist.get_query_set(request)\n+        self.assertEqual(list(queryset), [john])\n+\n+        filterspec = changelist.get_filters(request)[0][-1]\n+        self.assertEqual(force_unicode(filterspec.title), u'department')\n+        choices = list(filterspec.choices(changelist))\n+\n+        self.assertEqual(choices[0]['display'], u'All')\n+        self.assertEqual(choices[0]['selected'], False)\n+        self.assertEqual(choices[0]['query_string'], '?')\n+\n+        self.assertEqual(choices[1]['display'], u'Development')\n+        self.assertEqual(choices[1]['selected'], True)\n+        self.assertEqual(choices[1]['query_string'], '?department__code__exact=DEV')\n+\n+        self.assertEqual(choices[2]['display'], u'Design')\n+        self.assertEqual(choices[2]['selected'], False)\n+        self.assertEqual(choices[2]['query_string'], '?department__code__exact=DSN')"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 89,
        "deletions": 9
    }
}