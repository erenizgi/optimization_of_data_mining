{
    "author": "ramiro",
    "message": "Added, documented support for SpatiaLite 3.0 to GeoDjango.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17496 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c406b554c76ec57bbeddea090a7ca1a4f1f6daa9",
    "files": [
        {
            "sha": "ce46d5b7a3465e41b4780f6e12507fbee87b6eea",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 23,
            "deletions": 14,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/c406b554c76ec57bbeddea090a7ca1a4f1f6daa9/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/c406b554c76ec57bbeddea090a7ca1a4f1f6daa9/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=c406b554c76ec57bbeddea090a7ca1a4f1f6daa9",
            "patch": "@@ -102,21 +102,30 @@ def load_spatialite_sql(self):\n         \"\"\"\n         This routine loads up the SpatiaLite SQL file.\n         \"\"\"\n-        # Getting the location of the SpatiaLite SQL file, and confirming\n-        # it exists.\n-        spatialite_sql = self.spatialite_init_file()\n-        if not os.path.isfile(spatialite_sql):\n-            raise ImproperlyConfigured('Could not find the required SpatiaLite initialization '\n-                                       'SQL file (necessary for testing): %s' % spatialite_sql)\n-\n-        # Opening up the SpatiaLite SQL initialization file and executing\n-        # as a script.\n-        sql_fh = open(spatialite_sql, 'r')\n-        try:\n+        if self.connection.ops.spatial_version[:2] >= (3, 0):\n+            # Spatialite >= 3.0.x -- No ned to load any SQL file, calling\n+            # InitSpatialMetaData() transparently creates the spatial metadata\n+            # tables\n             cur = self.connection._cursor()\n-            cur.executescript(sql_fh.read())\n-        finally:\n-            sql_fh.close()\n+            cur.execute(\"SELECT InitSpatialMetaData()\")\n+        else:\n+            # Spatialite < 3.0.x -- Load the initial SQL\n+\n+            # Getting the location of the SpatiaLite SQL file, and confirming\n+            # it exists.\n+            spatialite_sql = self.spatialite_init_file()\n+            if not os.path.isfile(spatialite_sql):\n+                raise ImproperlyConfigured('Could not find the required SpatiaLite initialization '\n+                                        'SQL file (necessary for testing): %s' % spatialite_sql)\n+\n+            # Opening up the SpatiaLite SQL initialization file and executing\n+            # as a script.\n+            sql_fh = open(spatialite_sql, 'r')\n+            try:\n+                cur = self.connection._cursor()\n+                cur.executescript(sql_fh.read())\n+            finally:\n+                sql_fh.close()\n \n     def spatialite_init_file(self):\n         # SPATIALITE_SQL may be placed in settings to tell GeoDjango"
        },
        {
            "sha": "209bce5b3e9b275a5b2534d880b5b4b2340ebba3",
            "filename": "docs/ref/contrib/gis/install.txt",
            "status": "modified",
            "additions": 31,
            "deletions": 8,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/c406b554c76ec57bbeddea090a7ca1a4f1f6daa9/docs%2Fref%2Fcontrib%2Fgis%2Finstall.txt",
            "raw_url": "https://github.com/django/django/raw/c406b554c76ec57bbeddea090a7ca1a4f1f6daa9/docs%2Fref%2Fcontrib%2Fgis%2Finstall.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Finstall.txt?ref=c406b554c76ec57bbeddea090a7ca1a4f1f6daa9",
            "patch": "@@ -80,7 +80,7 @@ Program                   Description                           Required\n :ref:`GDAL <ref-gdal>`    Geospatial Data Abstraction Library   No (but, required for SQLite)     1.8, 1.7, 1.6, 1.5, 1.4\n :ref:`GeoIP <ref-geoip>`  IP-based geolocation library          No                                1.4\n `PostGIS`__               Spatial extensions for PostgreSQL     Yes (PostgreSQL only)             1.5, 1.4, 1.3\n-`SpatiaLite`__            Spatial extensions for SQLite         Yes (SQLite only)                 2.4, 2.3\n+`SpatiaLite`__            Spatial extensions for SQLite         Yes (SQLite only)                 3.0, 2.4, 2.3\n ========================  ====================================  ================================  ==========================\n \n .. admonition::  Install GDAL\n@@ -560,26 +560,49 @@ Creating a Spatial Database for SpatiaLite\n -------------------------------------------\n \n After the SpatiaLite library and tools have been installed, it is now possible\n-to create spatial database for use with GeoDjango.  In order to do this, download\n-the spatial database initialization SQL from the `SpatiaLite Resources`__ page::\n+to create a spatial database for use with GeoDjango.\n+\n+For this, a number of spatial metadata tables must be created in the database\n+before any spatial query is performed against it.\n+\n+If you are using SpatiaLite 3.0 or newer then use the ``spatialite`` utility to\n+call the ``InitSpatiaMetaData()`` function whch will take care of that (you can\n+safely ignore the error messages shown) then you can skip the rest of this\n+section::\n+\n+   $ spatialite geodjango.db \"SELECT InitSpatialMetaData();\"\n+   the SPATIAL_REF_SYS table already contains some row(s)\n+    InitSpatiaMetaData ()error:\"table spatial_ref_sys already exists\"\n+   0\n+\n+If you re using a version of Spatialite older than 3.0 then to achieve the same\n+result you need to download a database initialization file and execute the SQL\n+queries it contains against your database.\n+\n+First, get it from the appropiate SpatiaLite Resources page (i.e.\n+http://www.gaia-gis.it/spatialite-2.3.1/resources.html for 2.3 or\n+http://www.gaia-gis.it/spatialite-2.4.0/ for 2.4)::\n \n    $ wget http://www.gaia-gis.it/spatialite-2.3.1/init_spatialite-2.3.sql.gz\n    $ gunzip init_spatialite-2.3.sql.gz\n \n+(Or, if you are using SpatiaLite 2.4 then do::\n+\n+   $ wget http://www.gaia-gis.it/spatialite-2.4.0/init_spatialite-2.4.sql.gz\n+   $ gunzip init_spatialite-2.4.sql.gz\n+\n+)\n+\n Now, the ``spatialite`` command can be used to initialize a spatial database::\n \n-   $ spatialite geodjango.db < init_spatialite-2.3.sql\n+   $ spatialite geodjango.db < init_spatialite-2.X.sql\n \n .. note::\n \n     The parameter ``geodjango.db`` is the *filename* of the SQLite database\n     you want to use.  Use the same in the :setting:`DATABASES` ``\"name\"`` key\n     inside your ``settings.py``.\n \n-\n-__ http://www.gaia-gis.it/spatialite-2.3.1/resources.html\n-\n-\n Add ``django.contrib.gis`` to :setting:`INSTALLED_APPS`\n -------------------------------------------------------\n "
        }
    ],
    "stats": {
        "total": 76,
        "additions": 54,
        "deletions": 22
    }
}