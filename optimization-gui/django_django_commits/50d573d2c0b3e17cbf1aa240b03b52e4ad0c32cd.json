{
    "author": "akaariai",
    "message": "Fixed #18979 -- Avoid endless loop caused by \"val in PermLookupDict\"\n\nFixed by defining __iter__ which raises TypeError. This was done to\nPermWrapper earlier.",
    "sha": "50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd",
    "files": [
        {
            "sha": "77face01a70964dd96057aea31de1308dfabee50",
            "filename": "django/contrib/auth/context_processors.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd/django%2Fcontrib%2Fauth%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd/django%2Fcontrib%2Fauth%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fcontext_processors.py?ref=50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd",
            "patch": "@@ -11,6 +11,11 @@ def __repr__(self):\n     def __getitem__(self, perm_name):\n         return self.user.has_perm(\"%s.%s\" % (self.module_name, perm_name))\n \n+    def __iter__(self):\n+        # To fix 'item in perms.someapp' and __getitem__ iteraction we need to\n+        # define __iter__. See #18979 for details.\n+        raise TypeError(\"PermLookupDict is not iterable.\")\n+\n     def __bool__(self):\n         return self.user.has_module_perms(self.module_name)\n     __nonzero__ = __bool__ # Python 2"
        },
        {
            "sha": "8d87e0ae1554e16dcebe81941b57e621d98d6c26",
            "filename": "django/contrib/auth/tests/context_processors.py",
            "status": "modified",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py?ref=50d573d2c0b3e17cbf1aa240b03b52e4ad0c32cd",
            "patch": "@@ -3,11 +3,55 @@\n from django.conf import global_settings\n from django.contrib.auth import authenticate\n from django.contrib.auth.tests.utils import skipIfCustomUser\n+from django.contrib.auth.context_processors import PermWrapper, PermLookupDict\n from django.db.models import Q\n from django.test import TestCase\n from django.test.utils import override_settings\n \n \n+class MockUser(object):\n+    def has_module_perm(self, perm):\n+        if perm == 'mockapp.someapp':\n+            return True\n+        return False\n+\n+    def has_perm(self, perm):\n+        if perm == 'someperm':\n+            return True\n+        return False\n+\n+\n+class PermWrapperTests(TestCase):\n+    \"\"\"\n+    Test some details of the PermWrapper implementation.\n+    \"\"\"\n+    class EQLimiterObject(object):\n+        \"\"\"\n+        This object makes sure __eq__ will not be called endlessly.\n+        \"\"\"\n+        def __init__(self):\n+            self.eq_calls = 0\n+\n+        def __eq__(self, other):\n+            if self.eq_calls > 0:\n+                return True\n+            self.eq_calls += 1\n+            return False\n+\n+    def test_permwrapper_in(self):\n+        \"\"\"\n+        Test that 'something' in PermWrapper doesn't end up in endless loop.\n+        \"\"\"\n+        perms = PermWrapper(MockUser())\n+        with self.assertRaises(TypeError):\n+            self.EQLimiterObject() in perms\n+\n+    def test_permlookupdict_in(self):\n+        pldict = PermLookupDict(MockUser(), 'mockapp')\n+        with self.assertRaises(TypeError):\n+            self.EQLimiterObject() in pldict\n+\n+\n @skipIfCustomUser\n @override_settings(\n     TEMPLATE_DIRS=("
        }
    ],
    "stats": {
        "total": 49,
        "additions": 49,
        "deletions": 0
    }
}