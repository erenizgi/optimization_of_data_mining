{
    "author": "claudep",
    "message": "Fixed #7936 -- Added Last-Modified header to feeds\n\nThanks julianb for the report and the initial patch, and Roman\nGladkov for working on tests.",
    "sha": "08d675a98f1ae1d27f7e1946125ed5316c576802",
    "files": [
        {
            "sha": "996b7dfb40d528effec42cf4a7961970dfe0de0a",
            "filename": "django/contrib/syndication/views.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/08d675a98f1ae1d27f7e1946125ed5316c576802/django%2Fcontrib%2Fsyndication%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/08d675a98f1ae1d27f7e1946125ed5316c576802/django%2Fcontrib%2Fsyndication%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsyndication%2Fviews.py?ref=08d675a98f1ae1d27f7e1946125ed5316c576802",
            "patch": "@@ -1,5 +1,7 @@\n from __future__ import unicode_literals\n \n+from calendar import timegm\n+\n from django.conf import settings\n from django.contrib.sites.models import get_current_site\n from django.core.exceptions import ImproperlyConfigured, ObjectDoesNotExist\n@@ -8,6 +10,7 @@\n from django.utils import feedgenerator, tzinfo\n from django.utils.encoding import force_text, iri_to_uri, smart_text\n from django.utils.html import escape\n+from django.utils.http import http_date\n from django.utils.timezone import is_naive\n \n \n@@ -22,6 +25,7 @@ def add_domain(domain, url, secure=False):\n         url = iri_to_uri('%s://%s%s' % (protocol, domain, url))\n     return url\n \n+\n class FeedDoesNotExist(ObjectDoesNotExist):\n     pass\n \n@@ -38,6 +42,11 @@ def __call__(self, request, *args, **kwargs):\n             raise Http404('Feed object does not exist.')\n         feedgen = self.get_feed(obj, request)\n         response = HttpResponse(content_type=feedgen.mime_type)\n+        if hasattr(self, 'item_pubdate'):\n+            # if item_pubdate is defined for the feed, set header so as\n+            # ConditionalGetMiddleware is able to send 304 NOT MODIFIED\n+            response['Last-Modified'] = http_date(\n+                timegm(feedgen.latest_post_date().utctimetuple()))\n         feedgen.write(response, 'utf-8')\n         return response\n "
        },
        {
            "sha": "04a67f4bdb5053c2ecbce3be8d41f9f4fa8da1a2",
            "filename": "tests/regressiontests/syndication/feeds.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/08d675a98f1ae1d27f7e1946125ed5316c576802/tests%2Fregressiontests%2Fsyndication%2Ffeeds.py",
            "raw_url": "https://github.com/django/django/raw/08d675a98f1ae1d27f7e1946125ed5316c576802/tests%2Fregressiontests%2Fsyndication%2Ffeeds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsyndication%2Ffeeds.py?ref=08d675a98f1ae1d27f7e1946125ed5316c576802",
            "patch": "@@ -46,6 +46,14 @@ class TestRss091Feed(TestRss2Feed):\n     feed_type = feedgenerator.RssUserland091Feed\n \n \n+class TestNoPubdateFeed(views.Feed):\n+    title = 'Test feed'\n+    link = '/feed/'\n+\n+    def items(self):\n+        return Entry.objects.all()\n+\n+\n class TestAtomFeed(TestRss2Feed):\n     feed_type = feedgenerator.Atom1Feed\n     subtitle = TestRss2Feed.description"
        },
        {
            "sha": "10413b4ddda957612b3538094f14c9599e88cb55",
            "filename": "tests/regressiontests/syndication/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/08d675a98f1ae1d27f7e1946125ed5316c576802/tests%2Fregressiontests%2Fsyndication%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/08d675a98f1ae1d27f7e1946125ed5316c576802/tests%2Fregressiontests%2Fsyndication%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsyndication%2Ftests.py?ref=08d675a98f1ae1d27f7e1946125ed5316c576802",
            "patch": "@@ -226,6 +226,14 @@ def test_aware_datetime_conversion(self):\n         updated = doc.getElementsByTagName('updated')[0].firstChild.wholeText\n         self.assertEqual(updated[-6:], '+00:42')\n \n+    def test_feed_last_modified_time(self):\n+        response = self.client.get('/syndication/naive-dates/')\n+        self.assertEqual(response['Last-Modified'], 'Thu, 03 Jan 2008 19:30:00 GMT')\n+\n+        # No last-modified when feed has no item_pubdate\n+        response = self.client.get('/syndication/no_pubdate/')\n+        self.assertFalse(response.has_header('Last-Modified'))\n+\n     def test_feed_url(self):\n         \"\"\"\n         Test that the feed_url can be overridden."
        },
        {
            "sha": "57f9d81a732b0b5d5350c61b11a4b9a2b9abe2a4",
            "filename": "tests/regressiontests/syndication/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/08d675a98f1ae1d27f7e1946125ed5316c576802/tests%2Fregressiontests%2Fsyndication%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/08d675a98f1ae1d27f7e1946125ed5316c576802/tests%2Fregressiontests%2Fsyndication%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsyndication%2Furls.py?ref=08d675a98f1ae1d27f7e1946125ed5316c576802",
            "patch": "@@ -9,6 +9,7 @@\n     (r'^syndication/complex/(?P<foo>.*)/$', feeds.ComplexFeed()),\n     (r'^syndication/rss2/$', feeds.TestRss2Feed()),\n     (r'^syndication/rss091/$', feeds.TestRss091Feed()),\n+    (r'^syndication/no_pubdate/$', feeds.TestNoPubdateFeed()),\n     (r'^syndication/atom/$', feeds.TestAtomFeed()),\n     (r'^syndication/custom/$', feeds.TestCustomFeed()),\n     (r'^syndication/naive-dates/$', feeds.NaiveDatesFeed()),"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 26,
        "deletions": 0
    }
}