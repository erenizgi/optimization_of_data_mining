{
    "author": "jbronn",
    "message": "Fixed #16537 -- Fixed multi-db issues with GeoDjango utilities.  Thanks, Shane Shifflett for the bug report and aaugustin for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16779 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "36120f41a900cae27377d247ec482bc427811f51",
    "files": [
        {
            "sha": "154617f0b91795ed53a7f631f6fa7bf93c8bc725",
            "filename": "django/contrib/gis/utils/layermapping.py",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/36120f41a900cae27377d247ec482bc427811f51/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "raw_url": "https://github.com/django/django/raw/36120f41a900cae27377d247ec482bc427811f51/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py?ref=36120f41a900cae27377d247ec482bc427811f51",
            "patch": "@@ -132,9 +132,6 @@ def __init__(self, model, data, mapping, layer=0,\n         else:\n             raise LayerMapError('Unrecognized transaction mode: %s' % transaction_mode)\n \n-        if using is None:\n-            pass\n-\n     #### Checking routines used during initialization ####\n     def check_fid_range(self, fid_range):\n         \"This checks the `fid_range` keyword.\"\n@@ -393,7 +390,7 @@ def verify_fk(self, feat, rel_model, rel_mapping):\n \n         # Attempting to retrieve and return the related model.\n         try:\n-            return rel_model.objects.get(**fk_kwargs)\n+            return rel_model.objects.using(self.using).get(**fk_kwargs)\n         except ObjectDoesNotExist:\n             raise MissingForeignKey('No ForeignKey %s model found with keyword arguments: %s' % (rel_model.__name__, fk_kwargs))\n \n@@ -429,7 +426,7 @@ def coord_transform(self):\n         SpatialRefSys = self.spatial_backend.spatial_ref_sys()\n         try:\n             # Getting the target spatial reference system\n-            target_srs = SpatialRefSys.objects.get(srid=self.geo_field.srid).srs\n+            target_srs = SpatialRefSys.objects.using(self.using).get(srid=self.geo_field.srid).srs\n \n             # Creating the CoordTransform object\n             return CoordTransform(self.source_srs, target_srs)"
        },
        {
            "sha": "07a593d90e83ba15ec0d3e346405699c24b468f5",
            "filename": "django/contrib/gis/utils/srs.py",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/36120f41a900cae27377d247ec482bc427811f51/django%2Fcontrib%2Fgis%2Futils%2Fsrs.py",
            "raw_url": "https://github.com/django/django/raw/36120f41a900cae27377d247ec482bc427811f51/django%2Fcontrib%2Fgis%2Futils%2Fsrs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Futils%2Fsrs.py?ref=36120f41a900cae27377d247ec482bc427811f51",
            "patch": "@@ -1,8 +1,7 @@\n from django.contrib.gis.gdal import SpatialReference\n-from django.db import connections, DEFAULT_DB_ALIAS\n \n def add_srs_entry(srs, auth_name='EPSG', auth_srid=None, ref_sys_name=None,\n-                  database=DEFAULT_DB_ALIAS):\n+                  database=None):\n     \"\"\"\n     This function takes a GDAL SpatialReference system and adds its information\n     to the `spatial_ref_sys` table of the spatial backend.  Doing this enables\n@@ -33,7 +32,11 @@ def add_srs_entry(srs, auth_name='EPSG', auth_srid=None, ref_sys_name=None,\n       of `django.db.DEFAULT_DB_ALIAS` (at the time of this writing, it's value\n       is 'default').\n     \"\"\"\n+    from django.db import connections, DEFAULT_DB_ALIAS\n+    if not database:\n+        database = DEFAULT_DB_ALIAS\n     connection = connections[database]\n+\n     if not hasattr(connection.ops, 'spatial_version'):\n         raise Exception('The `add_srs_entry` utility only works '\n                         'with spatial backends.')\n@@ -69,9 +72,9 @@ def add_srs_entry(srs, auth_name='EPSG', auth_srid=None, ref_sys_name=None,\n     try:\n         # Try getting via SRID only, because using all kwargs may\n         # differ from exact wkt/proj in database.\n-        sr = SpatialRefSys.objects.get(srid=srs.srid)\n+        sr = SpatialRefSys.objects.using(database).get(srid=srs.srid)\n     except SpatialRefSys.DoesNotExist:\n-        sr = SpatialRefSys.objects.create(**kwargs)\n+        sr = SpatialRefSys.objects.using(database).create(**kwargs)\n \n # Alias is for backwards-compatibility purposes.\n add_postgis_srs = add_srs_entry"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 9,
        "deletions": 9
    }
}