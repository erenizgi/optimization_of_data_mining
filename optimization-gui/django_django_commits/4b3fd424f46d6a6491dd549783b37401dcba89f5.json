{
    "author": "claudep",
    "message": "Fixed #15782 -- Prevented MySQL backend to crash on runserver when db server is down. Thanks toofishes for the report and patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17868 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4b3fd424f46d6a6491dd549783b37401dcba89f5",
    "files": [
        {
            "sha": "663cc7da4ea358697c78cc24ab5e64e884773102",
            "filename": "django/db/backends/mysql/validation.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/4b3fd424f46d6a6491dd549783b37401dcba89f5/django%2Fdb%2Fbackends%2Fmysql%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/4b3fd424f46d6a6491dd549783b37401dcba89f5/django%2Fdb%2Fbackends%2Fmysql%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fvalidation.py?ref=4b3fd424f46d6a6491dd549783b37401dcba89f5",
            "patch": "@@ -11,16 +11,22 @@ def validate_field(self, errors, opts, f):\n           characters if they have a unique index on them.\n         \"\"\"\n         from django.db import models\n-        db_version = self.connection.get_server_version()\n+        from MySQLdb import OperationalError\n+        try:\n+            db_version = self.connection.get_server_version()\n+            text_version = '.'.join([str(n) for n in db_version[:3]])\n+        except OperationalError:\n+            db_version = None\n+            text_version = ''\n         varchar_fields = (models.CharField, models.CommaSeparatedIntegerField,\n                 models.SlugField)\n         if isinstance(f, varchar_fields) and f.max_length > 255:\n-            if db_version < (5, 0, 3):\n+            if db_version and db_version < (5, 0, 3):\n                 msg = '\"%(name)s\": %(cls)s cannot have a \"max_length\" greater than 255 when you are using a version of MySQL prior to 5.0.3 (you are using %(version)s).'\n             elif f.unique == True:\n                 msg = '\"%(name)s\": %(cls)s cannot have a \"max_length\" greater than 255 when using \"unique=True\".'\n             else:\n                 msg = None\n \n             if msg:\n-                errors.add(opts, msg % {'name': f.name, 'cls': f.__class__.__name__, 'version': '.'.join([str(n) for n in db_version[:3]])})\n+                errors.add(opts, msg % {'name': f.name, 'cls': f.__class__.__name__, 'version': text_version})"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 9,
        "deletions": 3
    }
}