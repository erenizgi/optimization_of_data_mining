{
    "author": "jezdez",
    "message": "Fixed #6213 -- Updated the flatpages app to only append a slash if the flatpage actually exist.\n\nThe FlatpageFallbackMiddleware (and the view) now only add a trailing slash and redirect if the resulting URL refers to an existing flatpage. Previously requesting /notaflatpageoravalidurl would redirect to /notaflatpageoravalidurl/, which would then raise a 404. Requesting /notaflatpageoravalidurl now will immediately raise a 404. Also, Redirects returned by flatpages are now permanent (301 status code) to match the behaviour of the CommonMiddleware.\n\nThanks to Steve Losh for the initial work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16048 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "196ac8f8b31302d026af6d79f764c8f146a8c78e",
    "files": [
        {
            "sha": "01a9b355d7ddb7a9027a85c4aeef8f5cd2637dbf",
            "filename": "django/contrib/flatpages/tests/middleware.py",
            "status": "modified",
            "additions": 95,
            "deletions": 0,
            "changes": 95,
            "blob_url": "https://github.com/django/django/blob/196ac8f8b31302d026af6d79f764c8f146a8c78e/django%2Fcontrib%2Fflatpages%2Ftests%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/196ac8f8b31302d026af6d79f764c8f146a8c78e/django%2Fcontrib%2Fflatpages%2Ftests%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Ftests%2Fmiddleware.py?ref=196ac8f8b31302d026af6d79f764c8f146a8c78e",
            "patch": "@@ -1,6 +1,7 @@\n import os\n from django.conf import settings\n from django.contrib.auth.models import User\n+from django.contrib.flatpages.models import FlatPage\n from django.test import TestCase\n \n class FlatpageMiddlewareTests(TestCase):\n@@ -68,3 +69,97 @@ def test_fallback_authenticated_flatpage(self):\n         response = self.client.get('/sekrit/')\n         self.assertEqual(response.status_code, 200)\n         self.assertContains(response, \"<p>Isn't it sekrit!</p>\")\n+\n+    def test_fallback_flatpage_special_chars(self):\n+        \"A flatpage with special chars in the URL can be served by the fallback middleware\"\n+        fp = FlatPage.objects.create(\n+            url=\"/some.very_special~chars-here/\",\n+            title=\"A very special page\",\n+            content=\"Isn't it special!\",\n+            enable_comments=False,\n+            registration_required=False,\n+        )\n+        fp.sites.add(1)\n+\n+        response = self.client.get('/some.very_special~chars-here/')\n+        self.assertEquals(response.status_code, 200)\n+        self.assertContains(response, \"<p>Isn't it special!</p>\")\n+\n+\n+class FlatpageMiddlewareAppendSlashTests(TestCase):\n+    fixtures = ['sample_flatpages']\n+    urls = 'django.contrib.flatpages.tests.urls'\n+\n+    def setUp(self):\n+        self.old_MIDDLEWARE_CLASSES = settings.MIDDLEWARE_CLASSES\n+        flatpage_middleware_class = 'django.contrib.flatpages.middleware.FlatpageFallbackMiddleware'\n+        if flatpage_middleware_class not in settings.MIDDLEWARE_CLASSES:\n+            settings.MIDDLEWARE_CLASSES += (flatpage_middleware_class,)\n+        self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n+        settings.TEMPLATE_DIRS = (\n+            os.path.join(\n+                os.path.dirname(__file__),\n+                'templates'\n+            ),\n+        )\n+        self.old_LOGIN_URL = settings.LOGIN_URL\n+        settings.LOGIN_URL = '/accounts/login/'\n+        self.old_APPEND_SLASH = settings.APPEND_SLASH\n+        settings.APPEND_SLASH = True\n+\n+    def tearDown(self):\n+        settings.MIDDLEWARE_CLASSES = self.old_MIDDLEWARE_CLASSES\n+        settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n+        settings.LOGIN_URL = self.old_LOGIN_URL\n+        settings.APPEND_SLASH = self.old_APPEND_SLASH\n+\n+    def test_redirect_view_flatpage(self):\n+        \"A flatpage can be served through a view and should add a slash\"\n+        response = self.client.get('/flatpage_root/flatpage')\n+        self.assertRedirects(response, '/flatpage_root/flatpage/', status_code=301)\n+\n+    def test_redirect_view_non_existent_flatpage(self):\n+        \"A non-existent flatpage raises 404 when served through a view and should not add a slash\"\n+        response = self.client.get('/flatpage_root/no_such_flatpage')\n+        self.assertEquals(response.status_code, 404)\n+\n+    def test_redirect_fallback_flatpage(self):\n+        \"A flatpage can be served by the fallback middlware and should add a slash\"\n+        response = self.client.get('/flatpage')\n+        self.assertRedirects(response, '/flatpage/', status_code=301)\n+\n+    def test_redirect_fallback_non_existent_flatpage(self):\n+        \"A non-existent flatpage raises a 404 when served by the fallback middlware and should not add a slash\"\n+        response = self.client.get('/no_such_flatpage')\n+        self.assertEquals(response.status_code, 404)\n+\n+    def test_redirect_fallback_flatpage_special_chars(self):\n+        \"A flatpage with special chars in the URL can be served by the fallback middleware and should add a slash\"\n+        fp = FlatPage.objects.create(\n+            url=\"/some.very_special~chars-here/\",\n+            title=\"A very special page\",\n+            content=\"Isn't it special!\",\n+            enable_comments=False,\n+            registration_required=False,\n+        )\n+        fp.sites.add(1)\n+\n+        response = self.client.get('/some.very_special~chars-here')\n+        self.assertRedirects(response, '/some.very_special~chars-here/', status_code=301)\n+\n+    def test_redirect_fallback_flatpage_root(self):\n+        \"A flatpage at / should not cause a redirect loop when APPEND_SLASH is set\"\n+        fp = FlatPage.objects.create(\n+            url=\"/\",\n+            title=\"Root\",\n+            content=\"Root\",\n+            enable_comments=False,\n+            registration_required=False,\n+        )\n+        fp.sites.add(1)\n+\n+        response = self.client.get('/')\n+        self.assertEquals(response.status_code, 200)\n+        self.assertContains(response, \"<p>Root</p>\")\n+\n+"
        },
        {
            "sha": "54ab52ab7e5d059e8e38bb2ede2f70daac72a865",
            "filename": "django/contrib/flatpages/tests/views.py",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/196ac8f8b31302d026af6d79f764c8f146a8c78e/django%2Fcontrib%2Fflatpages%2Ftests%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/196ac8f8b31302d026af6d79f764c8f146a8c78e/django%2Fcontrib%2Fflatpages%2Ftests%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Ftests%2Fviews.py?ref=196ac8f8b31302d026af6d79f764c8f146a8c78e",
            "patch": "@@ -73,3 +73,65 @@ def test_view_flatpage_special_chars(self):\n         response = self.client.get('/flatpage_root/some.very_special~chars-here/')\n         self.assertEqual(response.status_code, 200)\n         self.assertContains(response, \"<p>Isn't it special!</p>\")\n+\n+\n+class FlatpageViewAppendSlashTests(TestCase):\n+    fixtures = ['sample_flatpages']\n+    urls = 'django.contrib.flatpages.tests.urls'\n+\n+    def setUp(self):\n+        self.old_MIDDLEWARE_CLASSES = settings.MIDDLEWARE_CLASSES\n+        flatpage_middleware_class = 'django.contrib.flatpages.middleware.FlatpageFallbackMiddleware'\n+        if flatpage_middleware_class in settings.MIDDLEWARE_CLASSES:\n+            settings.MIDDLEWARE_CLASSES = tuple(m for m in settings.MIDDLEWARE_CLASSES if m != flatpage_middleware_class)\n+        self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n+        settings.TEMPLATE_DIRS = (\n+            os.path.join(\n+                os.path.dirname(__file__),\n+                'templates'\n+            ),\n+        )\n+        self.old_LOGIN_URL = settings.LOGIN_URL\n+        settings.LOGIN_URL = '/accounts/login/'\n+        self.old_APPEND_SLASH = settings.APPEND_SLASH\n+        settings.APPEND_SLASH = True\n+\n+    def tearDown(self):\n+        settings.MIDDLEWARE_CLASSES = self.old_MIDDLEWARE_CLASSES\n+        settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n+        settings.LOGIN_URL = self.old_LOGIN_URL\n+        settings.APPEND_SLASH = self.old_APPEND_SLASH\n+\n+    def test_redirect_view_flatpage(self):\n+        \"A flatpage can be served through a view and should add a slash\"\n+        response = self.client.get('/flatpage_root/flatpage')\n+        self.assertRedirects(response, '/flatpage_root/flatpage/', status_code=301)\n+\n+    def test_redirect_view_non_existent_flatpage(self):\n+        \"A non-existent flatpage raises 404 when served through a view and should not add a slash\"\n+        response = self.client.get('/flatpage_root/no_such_flatpage')\n+        self.assertEquals(response.status_code, 404)\n+\n+    def test_redirect_fallback_flatpage(self):\n+        \"A fallback flatpage won't be served if the middleware is disabled and should not add a slash\"\n+        response = self.client.get('/flatpage')\n+        self.assertEquals(response.status_code, 404)\n+\n+    def test_redirect_fallback_non_existent_flatpage(self):\n+        \"A non-existent flatpage won't be served if the fallback middlware is disabled and should not add a slash\"\n+        response = self.client.get('/no_such_flatpage')\n+        self.assertEquals(response.status_code, 404)\n+\n+    def test_redirect_view_flatpage_special_chars(self):\n+        \"A flatpage with special chars in the URL can be served through a view and should add a slash\"\n+        fp = FlatPage.objects.create(\n+            url=\"/some.very_special~chars-here/\",\n+            title=\"A very special page\",\n+            content=\"Isn't it special!\",\n+            enable_comments=False,\n+            registration_required=False,\n+        )\n+        fp.sites.add(1)\n+\n+        response = self.client.get('/flatpage_root/some.very_special~chars-here')\n+        self.assertRedirects(response, '/flatpage_root/some.very_special~chars-here/', status_code=301)"
        },
        {
            "sha": "ef7fda5d5c797d58615beb0b4d139662367e0c95",
            "filename": "django/contrib/flatpages/views.py",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/196ac8f8b31302d026af6d79f764c8f146a8c78e/django%2Fcontrib%2Fflatpages%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/196ac8f8b31302d026af6d79f764c8f146a8c78e/django%2Fcontrib%2Fflatpages%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Fviews.py?ref=196ac8f8b31302d026af6d79f764c8f146a8c78e",
            "patch": "@@ -1,7 +1,7 @@\n from django.contrib.flatpages.models import FlatPage\n from django.template import loader, RequestContext\n from django.shortcuts import get_object_or_404\n-from django.http import HttpResponse, HttpResponseRedirect\n+from django.http import Http404, HttpResponse, HttpResponsePermanentRedirect\n from django.conf import settings\n from django.core.xheaders import populate_xheaders\n from django.utils.safestring import mark_safe\n@@ -28,11 +28,19 @@ def flatpage(request, url):\n         flatpage\n             `flatpages.flatpages` object\n     \"\"\"\n-    if not url.endswith('/') and settings.APPEND_SLASH:\n-        return HttpResponseRedirect(\"%s/\" % request.path)\n     if not url.startswith('/'):\n-        url = \"/\" + url\n-    f = get_object_or_404(FlatPage, url__exact=url, sites__id__exact=settings.SITE_ID)\n+        url = '/' + url\n+    try:\n+        f = get_object_or_404(FlatPage,\n+            url__exact=url, sites__id__exact=settings.SITE_ID)\n+    except Http404:\n+        if not url.endswith('/') and settings.APPEND_SLASH:\n+            url += '/'\n+            f = get_object_or_404(FlatPage,\n+                url__exact=url, sites__id__exact=settings.SITE_ID)\n+            return HttpResponsePermanentRedirect('%s/' % request.path)\n+        else:\n+            raise\n     return render_flatpage(request, f)\n \n @csrf_protect"
        },
        {
            "sha": "a99f75eb2d8f0d76bbfa5b0cfed33a1bcb20c97a",
            "filename": "docs/ref/contrib/flatpages.txt",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/196ac8f8b31302d026af6d79f764c8f146a8c78e/docs%2Fref%2Fcontrib%2Fflatpages.txt",
            "raw_url": "https://github.com/django/django/raw/196ac8f8b31302d026af6d79f764c8f146a8c78e/docs%2Fref%2Fcontrib%2Fflatpages.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fflatpages.txt?ref=196ac8f8b31302d026af6d79f764c8f146a8c78e",
            "patch": "@@ -77,6 +77,18 @@ does all of the work.\n           :class:`~django.template.RequestContext` in rendering the\n           template.\n \n+    .. versionchanged:: 1.4\n+       The middleware will only add a trailing slash and redirect (by looking\n+       at the :setting:`APPEND_SLASH` setting) if the resulting URL refers to\n+       a valid flatpage. Previously requesting a non-existent flatpage\n+       would redirect to the same URL with an apppended slash first and\n+       subsequently raise a 404.\n+\n+    .. versionchanged:: 1.4\n+       Redirects by the middlware are permanent (301 status code) instead of\n+       temporary (302) to match behaviour of the\n+       :class:`~django.middleware.common.CommonMiddleware`.\n+\n     If it doesn't find a match, the request continues to be processed as usual.\n \n     The middleware only gets activated for 404s -- not for 500s or responses"
        },
        {
            "sha": "9de896d33d232b8cb9c40267975f2dbde24eb974",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/196ac8f8b31302d026af6d79f764c8f146a8c78e/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/196ac8f8b31302d026af6d79f764c8f146a8c78e/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=196ac8f8b31302d026af6d79f764c8f146a8c78e",
            "patch": "@@ -78,3 +78,16 @@ Django instance, and try to submit it to the upgraded Django instance:\n \n   * time period: the amount of time you expect user to take filling out\n     such forms.\n+\n+django.contrib.flatpages\n+~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Starting in the 1.4 release the\n+:class:`~django.contrib.flatpages.middleware.FlatpageFallbackMiddleware` only\n+adds a trailing slash and redirects if the resulting URL refers to an existing\n+flatpage. For example, requesting ``/notaflatpageoravalidurl`` in a previous\n+version would redirect to ``/notaflatpageoravalidurl/``, which would\n+subsequently raise a 404. Requesting ``/notaflatpageoravalidurl`` now will\n+immediately raise a 404. Additionally redirects returned by flatpages are now\n+permanent (301 status code) to match the behaviour of the\n+:class:`~django.middleware.common.CommonMiddleware`."
        }
    ],
    "stats": {
        "total": 200,
        "additions": 195,
        "deletions": 5
    }
}