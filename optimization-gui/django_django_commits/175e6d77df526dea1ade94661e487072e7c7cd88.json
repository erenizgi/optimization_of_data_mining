{
    "author": "aaugustin",
    "message": "Fixed #11745 -- Grouped commands by application in the output of `manage.py help`. Made 'version' consistent with 'help' while I was in the area, and added tests. Thanks Jannis for the feedback and review.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17462 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "175e6d77df526dea1ade94661e487072e7c7cd88",
    "files": [
        {
            "sha": "6edfc1264cd59197a2a20f293357f90340faa1ec",
            "filename": "django/core/management/__init__.py",
            "status": "modified",
            "additions": 32,
            "deletions": 11,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/175e6d77df526dea1ade94661e487072e7c7cd88/django%2Fcore%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/175e6d77df526dea1ade94661e487072e7c7cd88/django%2Fcore%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2F__init__.py?ref=175e6d77df526dea1ade94661e487072e7c7cd88",
            "patch": "@@ -1,10 +1,12 @@\n+import collections\n import os\n import sys\n from optparse import OptionParser, NO_DEFAULT\n import imp\n import warnings\n \n from django.core.management.base import BaseCommand, CommandError, handle_default_options\n+from django.core.management.color import color_style\n from django.utils.importlib import import_module\n \n # For backwards compatibility: get_version() used to be in this module.\n@@ -209,16 +211,32 @@ def __init__(self, argv=None):\n         self.argv = argv or sys.argv[:]\n         self.prog_name = os.path.basename(self.argv[0])\n \n-    def main_help_text(self):\n+    def main_help_text(self, commands_only=False):\n         \"\"\"\n         Returns the script's main help text, as a string.\n         \"\"\"\n-        usage = ['',\"Type '%s help <subcommand>' for help on a specific subcommand.\" % self.prog_name,'']\n-        usage.append('Available subcommands:')\n-        commands = get_commands().keys()\n-        commands.sort()\n-        for cmd in commands:\n-            usage.append('  %s' % cmd)\n+        if commands_only:\n+            usage = sorted(get_commands().keys())\n+        else:\n+            usage = [\n+                \"\",\n+                \"Type '%s help <subcommand>' for help on a specific subcommand.\" % self.prog_name,\n+                \"\",\n+                \"Available subcommands:\",\n+            ]\n+            commands_dict = collections.defaultdict(lambda: [])\n+            for name, app in get_commands().iteritems():\n+                if app == 'django.core':\n+                    app = 'django'\n+                else:\n+                    app = app.rpartition('.')[-1]\n+                commands_dict[app].append(name)\n+            style = color_style()\n+            for app in sorted(commands_dict.keys()):\n+                usage.append(\"\")\n+                usage.append(style.NOTICE(\"[%s]\" % app))\n+                for name in sorted(commands_dict[app]):\n+                    usage.append(\"    %s\" % name)\n         return '\\n'.join(usage)\n \n     def fetch_command(self, subcommand):\n@@ -340,12 +358,15 @@ def execute(self):\n             subcommand = 'help' # Display help if no arguments were given.\n \n         if subcommand == 'help':\n-            if len(args) > 2:\n-                self.fetch_command(args[2]).print_help(self.prog_name, args[2])\n-            else:\n+            if len(args) <= 2:\n                 parser.print_lax_help()\n                 sys.stdout.write(self.main_help_text() + '\\n')\n-                sys.exit(1)\n+            elif args[2] == '--commands':\n+                sys.stdout.write(self.main_help_text(commands_only=True) + '\\n')\n+            else:\n+                self.fetch_command(args[2]).print_help(self.prog_name, args[2])\n+        elif subcommand == 'version':\n+            sys.stdout.write(parser.get_version() + '\\n')\n         # Special-cases: We want 'django-admin.py --version' and\n         # 'django-admin.py --help' to work, for backwards compatibility.\n         elif self.argv[1:] == ['--version']:"
        },
        {
            "sha": "41f9bf649d49f157dab650afec45bfc8eaa585f0",
            "filename": "docs/ref/django-admin.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/175e6d77df526dea1ade94661e487072e7c7cd88/docs%2Fref%2Fdjango-admin.txt",
            "raw_url": "https://github.com/django/django/raw/175e6d77df526dea1ade94661e487072e7c7cd88/docs%2Fref%2Fdjango-admin.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdjango-admin.txt?ref=175e6d77df526dea1ade94661e487072e7c7cd88",
            "patch": "@@ -47,11 +47,16 @@ for the given command.\n Getting runtime help\n --------------------\n \n-.. django-admin-option:: --help\n+.. django-admin:: help\n \n-Run ``django-admin.py help`` to display a list of all available commands.\n-Run ``django-admin.py help <command>`` to display a description of the\n-given command and a list of its available options.\n+Run ``django-admin.py help`` to display usage information and a list of the\n+commands provided by each application.\n+\n+Run ``django-admin.py help --commands`` to display a list of all available\n+commands.\n+\n+Run ``django-admin.py help <command>`` to display a description of the given\n+command and a list of its available options.\n \n App names\n ---------\n@@ -63,9 +68,9 @@ contains the string ``'mysite.blog'``, the app name is ``blog``.\n Determining the version\n -----------------------\n \n-.. django-admin-option:: --version\n+.. django-admin:: version\n \n-Run ``django-admin.py --version`` to display the current Django version.\n+Run ``django-admin.py version`` to display the current Django version.\n \n Examples of output::\n "
        },
        {
            "sha": "e004aefd604716f379c47223169871fb41b1e937",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/175e6d77df526dea1ade94661e487072e7c7cd88/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/175e6d77df526dea1ade94661e487072e7c7cd88/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=175e6d77df526dea1ade94661e487072e7c7cd88",
            "patch": "@@ -989,6 +989,14 @@ after tests' execution, then you can restore the previous behavior by\n subclassing ``DjangoTestRunner`` and overriding its ``teardown_databases()``\n method.\n \n+Output of :djadmin:`manage.py help <help>`\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+:djadmin:`manage.py help <help>` now groups available commands by application.\n+If you depended on its output, for instance if you parsed it, you must update\n+your scripts. To obtain the list of all available management commands in a\n+script, you can use :djadmin:`manage.py help --commands <help>` instead.\n+\n Features deprecated in 1.4\n ==========================\n "
        },
        {
            "sha": "dd7e4b3d15eb5bd15b7c4df355cd1e0edc95f44d",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 35,
            "deletions": 9,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/175e6d77df526dea1ade94661e487072e7c7cd88/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/175e6d77df526dea1ade94661e487072e7c7cd88/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=175e6d77df526dea1ade94661e487072e7c7cd88",
            "patch": "@@ -173,6 +173,10 @@ def assertOutput(self, stream, msg):\n         \"Utility assertion: assert that the given message exists in the output\"\n         self.assertTrue(msg in stream, \"'%s' does not match actual output text '%s'\" % (msg, stream))\n \n+    def assertNotInOutput(self, stream, msg):\n+        \"Utility assertion: assert that the given message doesn't exist in the output\"\n+        self.assertFalse(msg in stream, \"'%s' matches actual output text '%s'\" % (msg, stream))\n+\n ##########################################################################\n # DJANGO ADMIN TESTS\n # This first series of test classes checks the environment processing\n@@ -1173,25 +1177,47 @@ def tearDown(self):\n         self.remove_settings('settings.py')\n \n     def test_version(self):\n-        \"--version is handled as a special case\"\n-        args = ['--version']\n+        \"version is handled as a special case\"\n+        args = ['version']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(err)\n         self.assertOutput(out, get_version())\n \n+    def test_version_alternative(self):\n+        \"--version is equivalent to version\"\n+        args1, args2 = ['version'], ['--version']\n+        self.assertEqual(self.run_manage(args1), self.run_manage(args2))\n+\n     def test_help(self):\n-        \"--help is handled as a special case\"\n-        args = ['--help']\n+        \"help is handled as a special case\"\n+        args = ['help']\n         out, err = self.run_manage(args)\n         self.assertOutput(out, \"Usage: manage.py subcommand [options] [args]\")\n         self.assertOutput(out, \"Type 'manage.py help <subcommand>' for help on a specific subcommand.\")\n+        self.assertOutput(out, '[django]')\n+        self.assertOutput(out, 'startapp')\n+        self.assertOutput(out, 'startproject')\n \n-    def test_short_help(self):\n-        \"-h is handled as a short form of --help\"\n-        args = ['-h']\n+    def test_help_commands(self):\n+        \"help --commands shows the list of all available commands\"\n+        args = ['help', '--commands']\n         out, err = self.run_manage(args)\n-        self.assertOutput(out, \"Usage: manage.py subcommand [options] [args]\")\n-        self.assertOutput(out, \"Type 'manage.py help <subcommand>' for help on a specific subcommand.\")\n+        self.assertNotInOutput(out, 'Usage:')\n+        self.assertNotInOutput(out, 'Options:')\n+        self.assertNotInOutput(out, '[django]')\n+        self.assertOutput(out, 'startapp')\n+        self.assertOutput(out, 'startproject')\n+        self.assertNotInOutput(out, '\\n\\n')\n+\n+    def test_help_alternative(self):\n+        \"--help is equivalent to help\"\n+        args1, args2 = ['help'], ['--help']\n+        self.assertEqual(self.run_manage(args1), self.run_manage(args2))\n+\n+    def test_help_short_altert(self):\n+        \"-h is handled as a short form of --help\"\n+        args1, args2 = ['--help'], ['-h']\n+        self.assertEqual(self.run_manage(args1), self.run_manage(args2))\n \n     def test_specific_help(self):\n         \"--help can be used on a specific command\""
        }
    ],
    "stats": {
        "total": 112,
        "additions": 86,
        "deletions": 26
    }
}