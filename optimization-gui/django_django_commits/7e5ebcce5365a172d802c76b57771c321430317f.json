{
    "author": "claudep",
    "message": "Fixed #18795 -- Fixed failing GeoDjango tests\n\nProj.4 and SRS strings may slightly vary depending on the installed\nlibraries. Made some tests pass again with recent Proj.4/GDAL lib\nversions.",
    "sha": "7e5ebcce5365a172d802c76b57771c321430317f",
    "files": [
        {
            "sha": "22394a2888fa53e9e470220586b7c422500fc62c",
            "filename": "django/contrib/gis/gdal/tests/test_ds.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "raw_url": "https://github.com/django/django/raw/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py?ref=7e5ebcce5365a172d802c76b57771c321430317f",
            "patch": "@@ -181,7 +181,11 @@ def test05_geometries(self):\n \n                     # Making sure the SpatialReference is as expected.\n                     if hasattr(source, 'srs_wkt'):\n-                        self.assertEqual(source.srs_wkt, g.srs.wkt)\n+                        self.assertEqual(\n+                            source.srs_wkt,\n+                            # Depending on lib versions, WGS_84 might be WGS_1984\n+                            g.srs.wkt.replace('SPHEROID[\"WGS_84\"', 'SPHEROID[\"WGS_1984\"')\n+                        )\n \n     def test06_spatial_filter(self):\n         \"Testing the Layer.spatial_filter property.\""
        },
        {
            "sha": "dda22036e352d265a7050eb4436c1fd55dfbd9db",
            "filename": "django/contrib/gis/gdal/tests/test_geom.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py",
            "raw_url": "https://github.com/django/django/raw/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py?ref=7e5ebcce5365a172d802c76b57771c321430317f",
            "patch": "@@ -1,3 +1,4 @@\n+import json\n from binascii import b2a_hex\n try:\n     from django.utils.six.moves import cPickle as pickle\n@@ -111,8 +112,9 @@ def test01e_json(self):\n         for g in self.geometries.json_geoms:\n             geom = OGRGeometry(g.wkt)\n             if not hasattr(g, 'not_equal'):\n-                self.assertEqual(g.json, geom.json)\n-                self.assertEqual(g.json, geom.geojson)\n+                # Loading jsons to prevent decimal differences\n+                self.assertEqual(json.loads(g.json), json.loads(geom.json))\n+                self.assertEqual(json.loads(g.json), json.loads(geom.geojson))\n             self.assertEqual(OGRGeometry(g.wkt), OGRGeometry(geom.json))\n \n     def test02_points(self):"
        },
        {
            "sha": "7300ab9c639c024d5050a6a2dc1f47ad643881d6",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=7e5ebcce5365a172d802c76b57771c321430317f",
            "patch": "@@ -1,4 +1,5 @@\n import ctypes\n+import json\n import random\n \n from django.contrib.gis.geos import (GEOSException, GEOSIndexError, GEOSGeometry,\n@@ -204,8 +205,9 @@ def test_json(self):\n         for g in self.geometries.json_geoms:\n             geom = GEOSGeometry(g.wkt)\n             if not hasattr(g, 'not_equal'):\n-                self.assertEqual(g.json, geom.json)\n-                self.assertEqual(g.json, geom.geojson)\n+                # Loading jsons to prevent decimal differences\n+                self.assertEqual(json.loads(g.json), json.loads(geom.json))\n+                self.assertEqual(json.loads(g.json), json.loads(geom.geojson))\n             self.assertEqual(GEOSGeometry(g.wkt), GEOSGeometry(geom.json))\n \n     def test_fromfile(self):"
        },
        {
            "sha": "7f7a0111f1e86d6a89683a520a25f077f9a21919",
            "filename": "django/contrib/gis/tests/test_spatialrefsys.py",
            "status": "modified",
            "additions": 12,
            "deletions": 20,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Ftests%2Ftest_spatialrefsys.py",
            "raw_url": "https://github.com/django/django/raw/7e5ebcce5365a172d802c76b57771c321430317f/django%2Fcontrib%2Fgis%2Ftests%2Ftest_spatialrefsys.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Ftest_spatialrefsys.py?ref=7e5ebcce5365a172d802c76b57771c321430317f",
            "patch": "@@ -8,9 +8,11 @@\n test_srs = ({'srid' : 4326,\n              'auth_name' : ('EPSG', True),\n              'auth_srid' : 4326,\n-             'srtext' : 'GEOGCS[\"WGS 84\",DATUM[\"WGS_1984\",SPHEROID[\"WGS 84\",6378137,298.257223563,AUTHORITY[\"EPSG\",\"7030\"]],TOWGS84[0,0,0,0,0,0,0],AUTHORITY[\"EPSG\",\"6326\"]],PRIMEM[\"Greenwich\",0,AUTHORITY[\"EPSG\",\"8901\"]],UNIT[\"degree\",0.01745329251994328,AUTHORITY[\"EPSG\",\"9122\"]],AUTHORITY[\"EPSG\",\"4326\"]]',\n-             'srtext14' : 'GEOGCS[\"WGS 84\",DATUM[\"WGS_1984\",SPHEROID[\"WGS 84\",6378137,298.257223563,AUTHORITY[\"EPSG\",\"7030\"]],AUTHORITY[\"EPSG\",\"6326\"]],PRIMEM[\"Greenwich\",0,AUTHORITY[\"EPSG\",\"8901\"]],UNIT[\"degree\",0.01745329251994328,AUTHORITY[\"EPSG\",\"9122\"]],AUTHORITY[\"EPSG\",\"4326\"]]',\n-             'proj4' : '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ',\n+             # Only the beginning, because there are differences depending on installed libs\n+             'srtext' : 'GEOGCS[\"WGS 84\",DATUM[\"WGS_1984\",SPHEROID[\"WGS 84\"',\n+             'proj4' : ['+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ',\n+                        # +ellps=WGS84 has been removed in the 4326 proj string in proj-4.8\n+                        '+proj=longlat +datum=WGS84 +no_defs '],\n              'spheroid' : 'WGS 84', 'name' : 'WGS 84',\n              'geographic' : True, 'projected' : False, 'spatialite' : True,\n              'ellipsoid' : (6378137.0, 6356752.3, 298.257223563), # From proj's \"cs2cs -le\" and Wikipedia (semi-minor only)\n@@ -19,9 +21,9 @@\n             {'srid' : 32140,\n              'auth_name' : ('EPSG', False),\n              'auth_srid' : 32140,\n-             'srtext' : 'PROJCS[\"NAD83 / Texas South Central\",GEOGCS[\"NAD83\",DATUM[\"North_American_Datum_1983\",SPHEROID[\"GRS 1980\",6378137,298.257222101,AUTHORITY[\"EPSG\",\"7019\"]],AUTHORITY[\"EPSG\",\"6269\"]],PRIMEM[\"Greenwich\",0,AUTHORITY[\"EPSG\",\"8901\"]],UNIT[\"degree\",0.01745329251994328,AUTHORITY[\"EPSG\",\"9122\"]],AUTHORITY[\"EPSG\",\"4269\"]],PROJECTION[\"Lambert_Conformal_Conic_2SP\"],PARAMETER[\"standard_parallel_1\",30.28333333333333],PARAMETER[\"standard_parallel_2\",28.38333333333333],PARAMETER[\"latitude_of_origin\",27.83333333333333],PARAMETER[\"central_meridian\",-99],PARAMETER[\"false_easting\",600000],PARAMETER[\"false_northing\",4000000],UNIT[\"metre\",1,AUTHORITY[\"EPSG\",\"9001\"]],AUTHORITY[\"EPSG\",\"32140\"]]',\n-             'srtext14': 'PROJCS[\"NAD83 / Texas South Central\",GEOGCS[\"NAD83\",DATUM[\"North_American_Datum_1983\",SPHEROID[\"GRS 1980\",6378137,298.257222101,AUTHORITY[\"EPSG\",\"7019\"]],AUTHORITY[\"EPSG\",\"6269\"]],PRIMEM[\"Greenwich\",0,AUTHORITY[\"EPSG\",\"8901\"]],UNIT[\"degree\",0.01745329251994328,AUTHORITY[\"EPSG\",\"9122\"]],AUTHORITY[\"EPSG\",\"4269\"]],UNIT[\"metre\",1,AUTHORITY[\"EPSG\",\"9001\"]],PROJECTION[\"Lambert_Conformal_Conic_2SP\"],PARAMETER[\"standard_parallel_1\",30.28333333333333],PARAMETER[\"standard_parallel_2\",28.38333333333333],PARAMETER[\"latitude_of_origin\",27.83333333333333],PARAMETER[\"central_meridian\",-99],PARAMETER[\"false_easting\",600000],PARAMETER[\"false_northing\",4000000],AUTHORITY[\"EPSG\",\"32140\"],AXIS[\"X\",EAST],AXIS[\"Y\",NORTH]]',\n-             'proj4' : '+proj=lcc +lat_1=30.28333333333333 +lat_2=28.38333333333333 +lat_0=27.83333333333333 +lon_0=-99 +x_0=600000 +y_0=4000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs ',\n+             'srtext' : 'PROJCS[\"NAD83 / Texas South Central\",GEOGCS[\"NAD83\",DATUM[\"North_American_Datum_1983\",SPHEROID[\"GRS 1980\"',\n+             'proj4' : ['+proj=lcc +lat_1=30.28333333333333 +lat_2=28.38333333333333 +lat_0=27.83333333333333 +lon_0=-99 +x_0=600000 +y_0=4000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs ',\n+                        '+proj=lcc +lat_1=30.28333333333333 +lat_2=28.38333333333333 +lat_0=27.83333333333333 +lon_0=-99 +x_0=600000 +y_0=4000000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs '],\n              'spheroid' : 'GRS 1980', 'name' : 'NAD83 / Texas South Central',\n              'geographic' : False, 'projected' : True, 'spatialite' : False,\n              'ellipsoid' : (6378137.0, 6356752.31414, 298.257222101), # From proj's \"cs2cs -le\" and Wikipedia (semi-minor only)\n@@ -51,17 +53,12 @@ def test01_retrieve(self):\n \n             # No proj.4 and different srtext on oracle backends :(\n             if postgis:\n-                if connection.ops.spatial_version >= (1, 4, 0):\n-                    srtext = sd['srtext14']\n-                else:\n-                    srtext = sd['srtext']\n-                self.assertEqual(srtext, srs.wkt)\n-                self.assertEqual(sd['proj4'], srs.proj4text)\n+                self.assertTrue(srs.wkt.startswith(sd['srtext']))\n+                self.assertTrue(srs.proj4text in sd['proj4'])\n \n     @no_mysql\n     def test02_osr(self):\n         \"Testing getting OSR objects from SpatialRefSys model objects.\"\n-        from django.contrib.gis.gdal import GDAL_VERSION\n         for sd in test_srs:\n             sr = SpatialRefSys.objects.get(srid=sd['srid'])\n             self.assertEqual(True, sr.spheroid.startswith(sd['spheroid']))\n@@ -76,15 +73,10 @@ def test02_osr(self):\n             # Testing the SpatialReference object directly.\n             if postgis or spatialite:\n                 srs = sr.srs\n-                if GDAL_VERSION <= (1, 8):\n-                    self.assertEqual(sd['proj4'], srs.proj4)\n+                self.assertTrue(srs.proj4 in sd['proj4'])\n                 # No `srtext` field in the `spatial_ref_sys` table in SpatiaLite\n                 if not spatialite:\n-                    if connection.ops.spatial_version >= (1, 4, 0):\n-                        srtext = sd['srtext14']\n-                    else:\n-                        srtext = sd['srtext']\n-                    self.assertEqual(srtext, srs.wkt)\n+                    self.assertTrue(srs.wkt.startswith(sd['srtext']))\n \n     @no_mysql\n     def test03_ellipsoid(self):"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 25,
        "deletions": 25
    }
}