{
    "author": "aaugustin",
    "message": "Fixed #19200 -- Session expiry with cached_db\n\nAlso did a little bit of cleanup.",
    "sha": "04b00b668d0d56c37460cbed19671f4b1b5916c3",
    "files": [
        {
            "sha": "65bbe059ebe36048982d49c4e53408007981ade5",
            "filename": "django/contrib/sessions/backends/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py?ref=04b00b668d0d56c37460cbed19671f4b1b5916c3",
            "patch": "@@ -170,9 +170,13 @@ def _get_session(self, no_load=False):\n \n     _session = property(_get_session)\n \n-    def get_expiry_age(self):\n-        \"\"\"Get the number of seconds until the session expires.\"\"\"\n-        expiry = self.get('_session_expiry')\n+    def get_expiry_age(self, expiry=None):\n+        \"\"\"Get the number of seconds until the session expires.\n+\n+        expiry is an optional parameter specifying the datetime of expiry.\n+        \"\"\"\n+        if expiry is None:\n+            expiry = self.get('_session_expiry')\n         if not expiry:   # Checks both None and 0 cases\n             return settings.SESSION_COOKIE_AGE\n         if not isinstance(expiry, datetime):"
        },
        {
            "sha": "8e4cf8b7e75a37b1d68c15eb849d20adfd92df96",
            "filename": "django/contrib/sessions/backends/cached_db.py",
            "status": "modified",
            "additions": 21,
            "deletions": 4,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "raw_url": "https://github.com/django/django/raw/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py?ref=04b00b668d0d56c37460cbed19671f4b1b5916c3",
            "patch": "@@ -2,9 +2,10 @@\n Cached, database-backed sessions.\n \"\"\"\n \n-from django.conf import settings\n from django.contrib.sessions.backends.db import SessionStore as DBStore\n from django.core.cache import cache\n+from django.core.exceptions import SuspiciousOperation\n+from django.utils import timezone\n \n KEY_PREFIX = \"django.contrib.sessions.cached_db\"\n \n@@ -28,9 +29,21 @@ def load(self):\n             # Some backends (e.g. memcache) raise an exception on invalid\n             # cache keys. If this happens, reset the session. See #17810.\n             data = None\n+\n         if data is None:\n-            data = super(SessionStore, self).load()\n-            cache.set(self.cache_key, data, settings.SESSION_COOKIE_AGE)\n+            # Duplicate DBStore.load, because we need to keep track\n+            # of the expiry date to set it properly in the cache.\n+            try:\n+                s = Session.objects.get(\n+                    session_key=self.session_key,\n+                    expire_date__gt=timezone.now()\n+                )\n+                data = self.decode(s.session_data)\n+                cache.set(self.cache_key, data,\n+                    self.get_expiry_age(s.expire_date))\n+            except (Session.DoesNotExist, SuspiciousOperation):\n+                self.create()\n+                data = {}\n         return data\n \n     def exists(self, session_key):\n@@ -40,7 +53,7 @@ def exists(self, session_key):\n \n     def save(self, must_create=False):\n         super(SessionStore, self).save(must_create)\n-        cache.set(self.cache_key, self._session, settings.SESSION_COOKIE_AGE)\n+        cache.set(self.cache_key, self._session, self.get_expiry_age())\n \n     def delete(self, session_key=None):\n         super(SessionStore, self).delete(session_key)\n@@ -58,3 +71,7 @@ def flush(self):\n         self.clear()\n         self.delete(self.session_key)\n         self.create()\n+\n+\n+# At bottom to avoid circular import\n+from django.contrib.sessions.models import Session"
        },
        {
            "sha": "4dacc9600037749c57b4abb667ee18139d7ffd3f",
            "filename": "django/contrib/sessions/backends/db.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py?ref=04b00b668d0d56c37460cbed19671f4b1b5916c3",
            "patch": "@@ -14,7 +14,7 @@ def __init__(self, session_key=None):\n     def load(self):\n         try:\n             s = Session.objects.get(\n-                session_key = self.session_key,\n+                session_key=self.session_key,\n                 expire_date__gt=timezone.now()\n             )\n             return self.decode(s.session_data)"
        },
        {
            "sha": "23915cf98c142641a989c3f09e16d51eb63c173d",
            "filename": "django/contrib/sessions/backends/signed_cookies.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fsigned_cookies.py",
            "raw_url": "https://github.com/django/django/raw/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Fbackends%2Fsigned_cookies.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fsigned_cookies.py?ref=04b00b668d0d56c37460cbed19671f4b1b5916c3",
            "patch": "@@ -32,6 +32,7 @@ def load(self):\n         try:\n             return signing.loads(self.session_key,\n                 serializer=PickleSerializer,\n+                # This doesn't handle non-default expiry dates, see #19201\n                 max_age=settings.SESSION_COOKIE_AGE,\n                 salt='django.contrib.sessions.backends.signed_cookies')\n         except (signing.BadSignature, ValueError):"
        },
        {
            "sha": "527e8eb3315da22315cee2b32f6a4113de2de416",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 7,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/04b00b668d0d56c37460cbed19671f4b1b5916c3/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=04b00b668d0d56c37460cbed19671f4b1b5916c3",
            "patch": "@@ -83,7 +83,7 @@ def test_has_key(self):\n         self.session['some key'] = 1\n         self.session.modified = False\n         self.session.accessed = False\n-        self.assertTrue('some key' in self.session)\n+        self.assertIn('some key', self.session)\n         self.assertTrue(self.session.accessed)\n         self.assertFalse(self.session.modified)\n \n@@ -200,28 +200,28 @@ def test_custom_expiry_seconds(self):\n         # Using seconds\n         self.session.set_expiry(10)\n         delta = self.session.get_expiry_date() - timezone.now()\n-        self.assertTrue(delta.seconds in (9, 10))\n+        self.assertIn(delta.seconds, (9, 10))\n \n         age = self.session.get_expiry_age()\n-        self.assertTrue(age in (9, 10))\n+        self.assertIn(age, (9, 10))\n \n     def test_custom_expiry_timedelta(self):\n         # Using timedelta\n         self.session.set_expiry(timedelta(seconds=10))\n         delta = self.session.get_expiry_date() - timezone.now()\n-        self.assertTrue(delta.seconds in (9, 10))\n+        self.assertIn(delta.seconds, (9, 10))\n \n         age = self.session.get_expiry_age()\n-        self.assertTrue(age in (9, 10))\n+        self.assertIn(age, (9, 10))\n \n     def test_custom_expiry_datetime(self):\n         # Using fixed datetime\n         self.session.set_expiry(timezone.now() + timedelta(seconds=10))\n         delta = self.session.get_expiry_date() - timezone.now()\n-        self.assertTrue(delta.seconds in (9, 10))\n+        self.assertIn(delta.seconds, (9, 10))\n \n         age = self.session.get_expiry_age()\n-        self.assertTrue(age in (9, 10))\n+        self.assertIn(age, (9, 10))\n \n     def test_custom_expiry_reset(self):\n         self.session.set_expiry(None)\n@@ -258,6 +258,21 @@ def test_decode(self):\n         encoded = self.session.encode(data)\n         self.assertEqual(self.session.decode(encoded), data)\n \n+    def test_actual_expiry(self):\n+        # Regression test for #19200\n+        old_session_key = None\n+        new_session_key = None\n+        try:\n+            self.session['foo'] = 'bar'\n+            self.session.set_expiry(-timedelta(seconds=10))\n+            self.session.create()\n+            # With an expiry date in the past, the session expires instantly.\n+            new_session = self.backend(self.session.session_key)\n+            self.assertNotIn('foo', new_session)\n+        finally:\n+            self.session.delete(old_session_key)\n+            self.session.delete(new_session_key)\n+\n \n class DatabaseSessionTests(SessionTestsMixin, TestCase):\n "
        }
    ],
    "stats": {
        "total": 67,
        "additions": 52,
        "deletions": 15
    }
}