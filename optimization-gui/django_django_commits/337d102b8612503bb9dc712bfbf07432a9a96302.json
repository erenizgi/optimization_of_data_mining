{
    "author": "ramiro",
    "message": "Fixed #13510 -- Corrected colspan of non-field-specific error messages in admin app tabular inlines so it isn't greater than the actual number of field cells. Thanks KyleMac for the report and Julien Phalip for the patch fixing the issue.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15626 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "337d102b8612503bb9dc712bfbf07432a9a96302",
    "files": [
        {
            "sha": "7f6c34ad36be0f23938992aeca96ad8c97b5af36",
            "filename": "django/contrib/admin/templates/admin/edit_inline/tabular.html",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/337d102b8612503bb9dc712bfbf07432a9a96302/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Ftabular.html",
            "raw_url": "https://github.com/django/django/raw/337d102b8612503bb9dc712bfbf07432a9a96302/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Ftabular.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Ftabular.html?ref=337d102b8612503bb9dc712bfbf07432a9a96302",
            "patch": "@@ -1,4 +1,4 @@\n-{% load i18n adminmedia %}\n+{% load i18n adminmedia admin_modify %}\n <div class=\"inline-group\" id=\"{{ inline_admin_formset.formset.prefix }}-group\">\n   <div class=\"tabular inline-related {% if forloop.last %}last-related{% endif %}\">\n {{ inline_admin_formset.formset.management_form }}\n@@ -18,7 +18,7 @@ <h2>{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>\n      <tbody>\n      {% for inline_admin_form in inline_admin_formset %}\n         {% if inline_admin_form.form.non_field_errors %}\n-        <tr><td colspan=\"{{ inline_admin_form.field_count }}\">{{ inline_admin_form.form.non_field_errors }}</td></tr>\n+        <tr><td colspan=\"{{ inline_admin_form|cell_count }}\">{{ inline_admin_form.form.non_field_errors }}</td></tr>\n         {% endif %}\n         <tr class=\"{% cycle \"row1\" \"row2\" %} {% if inline_admin_form.original or inline_admin_form.show_url %}has_original{% endif %}{% if forloop.last %} empty-form{% endif %}\"\n              id=\"{{ inline_admin_formset.formset.prefix }}-{% if not forloop.last %}{{ forloop.counter0 }}{% else %}empty{% endif %}\">"
        },
        {
            "sha": "8e6f0ab5cedf8ada8243fd77a9c0a6a94f59cd82",
            "filename": "django/contrib/admin/templatetags/admin_modify.py",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/337d102b8612503bb9dc712bfbf07432a9a96302/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py",
            "raw_url": "https://github.com/django/django/raw/337d102b8612503bb9dc712bfbf07432a9a96302/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py?ref=337d102b8612503bb9dc712bfbf07432a9a96302",
            "patch": "@@ -21,7 +21,7 @@ def prepopulated_fields_js(context):\n \n def submit_row(context):\n     \"\"\"\n-    Displays the row of buttons for delete and save. \n+    Displays the row of buttons for delete and save.\n     \"\"\"\n     opts = context['opts']\n     change = context['change']\n@@ -33,10 +33,24 @@ def submit_row(context):\n         'show_delete_link': (not is_popup and context['has_delete_permission']\n                               and (change or context['show_delete'])),\n         'show_save_as_new': not is_popup and change and save_as,\n-        'show_save_and_add_another': context['has_add_permission'] and \n+        'show_save_and_add_another': context['has_add_permission'] and\n                             not is_popup and (not save_as or context['add']),\n         'show_save_and_continue': not is_popup and context['has_change_permission'],\n         'is_popup': is_popup,\n         'show_save': True\n     }\n submit_row = register.inclusion_tag('admin/submit_line.html', takes_context=True)(submit_row)\n+\n+def cell_count(inline_admin_form):\n+    \"\"\"Returns the number of cells used in a tabular inline\"\"\"\n+    count = 1 # Hidden cell with hidden 'id' field\n+    for fieldset in inline_admin_form:\n+        # Loop through all the fields (one per cell)\n+        for line in fieldset:\n+            for field in line:\n+                count += 1\n+    if inline_admin_form.formset.can_delete:\n+        # Delete checkbox\n+        count += 1\n+    return count\n+cell_count = register.filter(cell_count)"
        },
        {
            "sha": "bb299f32b82931244741553b5ca0e269cb1b81d0",
            "filename": "tests/regressiontests/admin_inlines/models.py",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/337d102b8612503bb9dc712bfbf07432a9a96302/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/337d102b8612503bb9dc712bfbf07432a9a96302/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py?ref=337d102b8612503bb9dc712bfbf07432a9a96302",
            "patch": "@@ -6,6 +6,7 @@\n from django.contrib import admin\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.contenttypes import generic\n+from django import forms\n \n class Parent(models.Model):\n     name = models.CharField(max_length=50)\n@@ -123,3 +124,30 @@ class InlineWeakness(admin.TabularInline):\n     extra = 1\n \n admin.site.register(Fashionista, inlines=[InlineWeakness])\n+\n+# Models for #13510\n+\n+class TitleCollection(models.Model):\n+    pass\n+\n+class Title(models.Model):\n+    collection = models.ForeignKey(TitleCollection, blank=True, null=True)\n+    title1 = models.CharField(max_length=100)\n+    title2 = models.CharField(max_length=100)\n+\n+class TitleForm(forms.ModelForm):\n+\n+    def clean(self):\n+        cleaned_data = self.cleaned_data\n+        title1 = cleaned_data.get(\"title1\")\n+        title2 = cleaned_data.get(\"title2\")\n+        if title1 != title2:\n+            raise forms.ValidationError(\"The two titles must be the same\")\n+        return cleaned_data\n+\n+class TitleInline(admin.TabularInline):\n+    model = Title\n+    form = TitleForm\n+    extra = 1\n+\n+admin.site.register(TitleCollection, inlines=[TitleInline])"
        },
        {
            "sha": "915c6fac8d1624cbf972c86129d5041c55b4a1a2",
            "filename": "tests/regressiontests/admin_inlines/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/337d102b8612503bb9dc712bfbf07432a9a96302/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/337d102b8612503bb9dc712bfbf07432a9a96302/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py?ref=337d102b8612503bb9dc712bfbf07432a9a96302",
            "patch": "@@ -67,6 +67,23 @@ def test_inline_primary(self):\n         self.assertEqual(response.status_code, 302)\n         self.assertEqual(len(Fashionista.objects.filter(person__firstname='Imelda')), 1)\n \n+    def test_tabular_non_field_errors(self):\n+        \"\"\"\n+        Ensure that non_field_errors are displayed correctly, including the\n+        right value for colspan. Refs #13510.\n+        \"\"\"\n+        data = {\n+            'title_set-TOTAL_FORMS': 1,\n+            'title_set-INITIAL_FORMS': 0,\n+            'title_set-MAX_NUM_FORMS': 0,\n+            '_save': u'Save',\n+            'title_set-0-title1': 'a title',\n+            'title_set-0-title2': 'a different title',\n+        }\n+        response = self.client.post('/test_admin/admin/admin_inlines/titlecollection/add/', data)\n+        # Here colspan is \"4\": two fields (title1 and title2), one hidden field and the delete checkbock.\n+        self.assertContains(response, '<tr><td colspan=\"4\"><ul class=\"errorlist\"><li>The two titles must be the same</li></ul></td></tr>')\n+\n class TestInlineMedia(TestCase):\n     fixtures = ['admin-views-users.xml']\n "
        }
    ],
    "stats": {
        "total": 67,
        "additions": 63,
        "deletions": 4
    }
}