{
    "author": "aaugustin",
    "message": "[py3] Ported django.test.doctest.\n\nBased on Vinay Sajip's branch.",
    "sha": "67646dc28d6fc7b4032f1f5a18a5347e81755638",
    "files": [
        {
            "sha": "82d4a6d08ef06256f90ac1095f15e99cc365c015",
            "filename": "django/test/_doctest.py",
            "status": "modified",
            "additions": 103,
            "deletions": 16,
            "changes": 119,
            "blob_url": "https://github.com/django/django/blob/67646dc28d6fc7b4032f1f5a18a5347e81755638/django%2Ftest%2F_doctest.py",
            "raw_url": "https://github.com/django/django/raw/67646dc28d6fc7b4032f1f5a18a5347e81755638/django%2Ftest%2F_doctest.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2F_doctest.py?ref=67646dc28d6fc7b4032f1f5a18a5347e81755638",
            "patch": "@@ -105,7 +105,7 @@ def _test():\n import warnings\n \n from django.utils import six\n-from django.utils.six import StringIO\n+from django.utils.six.moves import StringIO, xrange\n \n if sys.platform.startswith('java'):\n     # On Jython, isclass() reports some modules as classes. Patch it.\n@@ -501,11 +501,31 @@ def __repr__(self):\n \n \n     # This lets us sort tests by name:\n+    def _cmpkey(self):\n+        return (self.name, self.filename, self.lineno, id(self))\n     def __cmp__(self, other):\n         if not isinstance(other, DocTest):\n             return -1\n-        return cmp((self.name, self.filename, self.lineno, id(self)),\n-                   (other.name, other.filename, other.lineno, id(other)))\n+        return cmp(self._cmpkey(), other._cmpkey())\n+\n+    def __lt__(self, other):\n+        return self._cmpkey() < other._cmpkey()\n+\n+    def __le__(self, other):\n+        return self._cmpkey() <= other._cmpkey()\n+\n+    def __gt__(self, other):\n+        return self._cmpkey() > other._cmpkey()\n+\n+    def __ge__(self, other):\n+        return self._cmpkey() >= other._cmpkey()\n+\n+    def __eq__(self, other):\n+        return self._cmpkey() == other._cmpkey()\n+\n+    def __ne__(self, other):\n+        return self._cmpkey() != other._cmpkey()\n+\n \n ######################################################################\n ## 3. DocTestParser\n@@ -1229,6 +1249,57 @@ def __run(self, test, compileflags, out):\n             # __patched_linecache_getlines).\n             filename = '<doctest %s[%d]>' % (test.name, examplenum)\n \n+            # Doctest and Py3 issue:\n+            # If the current example that we wish to run is going to fail\n+            # because it expects a leading u\"\", then use an alternate displayhook\n+            original_displayhook = sys.displayhook\n+\n+            if six.PY3:\n+                 # only set alternate displayhook if Python 3.x or after\n+                lines = []\n+                def py3_displayhook(value):\n+                    if value is None:\n+                        # None should not be considered at all\n+                        return original_displayhook(value)\n+\n+                    # Collect the repr output in one variable\n+                    s = repr(value)\n+                    # Strip b\"\" and u\"\" prefixes from the repr and expected output\n+                    # TODO: better way of stripping the prefixes?\n+                    expected = example.want\n+                    expected = expected.strip() # be wary of newlines\n+                    s = s.replace(\"u\", \"\")\n+                    s = s.replace(\"b\", \"\")\n+                    expected = expected.replace(\"u\", \"\")\n+                    expected = expected.replace(\"b\", \"\")\n+                    # single quote vs. double quote should not matter\n+                    # default all quote marks to double quote\n+                    s = s.replace(\"'\", '\"')\n+                    expected = expected.replace(\"'\", '\"')\n+\n+                    # In case of multi-line expected result\n+                    lines.append(s)\n+\n+                    # let them match\n+                    if s == expected: # be wary of false positives here\n+                        # they should be the same, print expected value\n+                        sys.stdout.write(\"%s\\n\" % example.want.strip())\n+\n+                    # multi-line expected output, doctest uses loop\n+                    elif len(expected.split(\"\\n\")) == len(lines):\n+                        if \"\\n\".join(lines) == expected:\n+                            sys.stdout.write(\"%s\\n\" % example.want.strip())\n+                        else:\n+                            sys.stdout.write(\"%s\\n\" % repr(value))\n+                    elif len(expected.split(\"\\n\")) != len(lines):\n+                        # we are not done looping yet, do not print anything!\n+                        pass\n+\n+                    else:\n+                        sys.stdout.write(\"%s\\n\" % repr(value))\n+\n+                sys.displayhook = py3_displayhook\n+\n             # Run the example in the given context (globs), and record\n             # any exception that gets raised.  (But don't intercept\n             # keyboard interrupts.)\n@@ -1243,9 +1314,14 @@ def __run(self, test, compileflags, out):\n             except:\n                 exception = sys.exc_info()\n                 self.debugger.set_continue() # ==== Example Finished ====\n+            finally:\n+                # restore the original displayhook\n+                sys.displayhook = original_displayhook\n \n             got = self._fakeout.getvalue()  # the actual output\n             self._fakeout.truncate(0)\n+            # Python 3.1 requires seek after truncate\n+            self._fakeout.seek(0)\n             outcome = FAILURE   # guilty until proved innocent or insane\n \n             # If the example executed without raising any exceptions,\n@@ -1256,10 +1332,21 @@ def __run(self, test, compileflags, out):\n \n             # The example raised an exception:  check if it was expected.\n             else:\n-                exc_info = sys.exc_info()\n-                exc_msg = traceback.format_exception_only(*exc_info[:2])[-1]\n+                exc_msg = traceback.format_exception_only(*exception[:2])[-1]\n+                if six.PY3:\n+                    # module name will be in group(1) and the expected\n+                    # exception message will be in group(2)\n+                    m = re.match(r'(.*)\\.(\\w+:.+\\s)', exc_msg)\n+                    # make sure there's a match\n+                    if m != None:\n+                        f_name = m.group(1)\n+                        # check to see if m.group(1) contains the module name\n+                        if f_name == exception[0].__module__:\n+                            # strip the module name from exc_msg\n+                            exc_msg = m.group(2)\n+\n                 if not quiet:\n-                    got += _exception_traceback(exc_info)\n+                    got += _exception_traceback(exception)\n \n                 # If `example.exc_msg` is None, then we weren't expecting\n                 # an exception.\n@@ -1289,7 +1376,7 @@ def __run(self, test, compileflags, out):\n             elif outcome is BOOM:\n                 if not quiet:\n                     self.report_unexpected_exception(out, test, example,\n-                                                     exc_info)\n+                                                     exception)\n                 failures += 1\n             else:\n                 assert False, (\"unknown outcome\", outcome)\n@@ -1629,8 +1716,8 @@ class DebugRunner(DocTestRunner):\n          ...                                    {}, 'foo', 'foo.py', 0)\n          >>> try:\n          ...     runner.run(test)\n-         ... except UnexpectedException as failure:\n-         ...     pass\n+         ... except UnexpectedException as e:\n+         ...     failure = e\n \n          >>> failure.test is test\n          True\n@@ -1657,8 +1744,8 @@ class DebugRunner(DocTestRunner):\n \n          >>> try:\n          ...    runner.run(test)\n-         ... except DocTestFailure as failure:\n-         ...    pass\n+         ... except DocTestFailure as e:\n+         ...    failure = e\n \n        DocTestFailure objects provide access to the test:\n \n@@ -2167,8 +2254,8 @@ def debug(self):\n              >>> case = DocTestCase(test)\n              >>> try:\n              ...     case.debug()\n-             ... except UnexpectedException as failure:\n-             ...     pass\n+             ... except UnexpectedException as e:\n+             ...     failure = e\n \n            The UnexpectedException contains the test, the example, and\n            the original exception:\n@@ -2196,8 +2283,8 @@ def debug(self):\n \n              >>> try:\n              ...    case.debug()\n-             ... except DocTestFailure as failure:\n-             ...    pass\n+             ... except DocTestFailure as e:\n+             ...    failure = e\n \n            DocTestFailure objects provide access to the test:\n \n@@ -2646,7 +2733,7 @@ def get(self):\n             \"whitespace normalization\": r\"\"\"\n                 If the whitespace normalization flag is used, then\n                 differences in whitespace are ignored.\n-                    >>> print(range(30)) #doctest: +NORMALIZE_WHITESPACE\n+                    >>> print(list(xrange(30))) #doctest: +NORMALIZE_WHITESPACE\n                     [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14,\n                      15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26,\n                      27, 28, 29]"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 103,
        "deletions": 16
    }
}