{
    "author": "freakboy3742",
    "message": "Fixed #16780 -- Removed a timing sensitive test from the template test suite. Thanks to Alex for the lend of his eyeballs.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16735 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "dc3b2a0fdf2a69864c5508a9c49aca43acac9bb2",
    "files": [
        {
            "sha": "c5c65fd2341c568e2677fda64e84ec65c3479cdf",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 17,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/dc3b2a0fdf2a69864c5508a9c49aca43acac9bb2/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dc3b2a0fdf2a69864c5508a9c49aca43acac9bb2/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=dc3b2a0fdf2a69864c5508a9c49aca43acac9bb2",
            "patch": "@@ -84,6 +84,9 @@ class SomeOtherException(Exception):\n class ContextStackException(Exception):\n     pass\n \n+class ShouldNotExecuteException(Exception):\n+    pass\n+\n class SomeClass:\n     def __init__(self):\n         self.otherclass = OtherClass()\n@@ -127,8 +130,7 @@ def is_false(self):\n         return False\n \n     def is_bad(self):\n-        time.sleep(0.3)\n-        return True\n+        raise ShouldNotExecuteException()\n \n class SilentGetItemClass(object):\n     def __getitem__(self, key):\n@@ -456,24 +458,21 @@ def test_templates(self):\n                 settings.TEMPLATE_DEBUG = template_debug\n                 for is_cached in (False, True):\n                     try:\n-                        start = datetime.now()\n-                        test_template = loader.get_template(name)\n-                        end = datetime.now()\n-                        if end-start > timedelta(seconds=0.2):\n-                            failures.append(\"Template test (Cached='%s', TEMPLATE_STRING_IF_INVALID='%s', TEMPLATE_DEBUG=%s): %s -- FAILED. Took too long to parse test\" % (is_cached, invalid_str, template_debug, name))\n-\n-                        start = datetime.now()\n-                        output = self.render(test_template, vals)\n-                        end = datetime.now()\n-                        if end-start > timedelta(seconds=0.2):\n-                            failures.append(\"Template test (Cached='%s', TEMPLATE_STRING_IF_INVALID='%s', TEMPLATE_DEBUG=%s): %s -- FAILED. Took too long to render test\" % (is_cached, invalid_str, template_debug, name))\n+                        try:\n+                            test_template = loader.get_template(name)\n+                        except ShouldNotExecuteException:\n+                            failures.append(\"Template test (Cached='%s', TEMPLATE_STRING_IF_INVALID='%s', TEMPLATE_DEBUG=%s): %s -- FAILED. Template loading invoked method that shouldn't have been invoked.\" % (is_cached, invalid_str, template_debug, name))\n+\n+                        try:\n+                            output = self.render(test_template, vals)\n+                        except ShouldNotExecuteException:\n+                            failures.append(\"Template test (Cached='%s', TEMPLATE_STRING_IF_INVALID='%s', TEMPLATE_DEBUG=%s): %s -- FAILED. Template rendering invoked method that shouldn't have been invoked.\" % (is_cached, invalid_str, template_debug, name))\n                     except ContextStackException:\n                         failures.append(\"Template test (Cached='%s', TEMPLATE_STRING_IF_INVALID='%s', TEMPLATE_DEBUG=%s): %s -- FAILED. Context stack was left imbalanced\" % (is_cached, invalid_str, template_debug, name))\n                         continue\n                     except Exception:\n                         exc_type, exc_value, exc_tb = sys.exc_info()\n                         if exc_type != result:\n-                            print \"CHECK\", name, exc_type, result\n                             tb = '\\n'.join(traceback.format_exception(exc_type, exc_value, exc_tb))\n                             failures.append(\"Template test (Cached='%s', TEMPLATE_STRING_IF_INVALID='%s', TEMPLATE_DEBUG=%s): %s -- FAILED. Got %s, exception: %s\\n%s\" % (is_cached, invalid_str, template_debug, name, exc_type, exc_value, tb))\n                         continue\n@@ -921,9 +920,7 @@ def get_template_tests(self):\n             'if-tag-error12': (\"{% if a not b %}yes{% endif %}\", {}, template.TemplateSyntaxError),\n \n             # If evaluations are shortcircuited where possible\n-            # These tests will fail by taking too long to run. When the if clause\n-            # is shortcircuiting correctly, the is_bad() function shouldn't be\n-            # evaluated, and the deliberate sleep won't happen.\n+            # If is_bad is invoked, it will raise a ShouldNotExecuteException\n             'if-tag-shortcircuit01': ('{% if x.is_true or x.is_bad %}yes{% else %}no{% endif %}', {'x': TestObj()}, \"yes\"),\n             'if-tag-shortcircuit02': ('{% if x.is_false and x.is_bad %}yes{% else %}no{% endif %}', {'x': TestObj()}, \"no\"),\n "
        }
    ],
    "stats": {
        "total": 31,
        "additions": 14,
        "deletions": 17
    }
}