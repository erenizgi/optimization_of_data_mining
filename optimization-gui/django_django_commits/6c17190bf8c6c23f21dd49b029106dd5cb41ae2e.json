{
    "author": "jezdez",
    "message": "Fixed #11639, #13618 -- Added get_prepopulated_fields method to ModelAdmin and InlineModelAdmin to be able to handle prepopulated fields on a case-by-case basis. Thanks, leanmeandonothingmachine.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16069 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
    "files": [
        {
            "sha": "0c2f287fe543718be5ffed8d5eca68bb781c5ead",
            "filename": "django/contrib/admin/helpers.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "raw_url": "https://github.com/django/django/raw/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fhelpers.py?ref=6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
            "patch": "@@ -193,26 +193,30 @@ class InlineAdminFormSet(object):\n     \"\"\"\n     A wrapper around an inline formset for use in the admin system.\n     \"\"\"\n-    def __init__(self, inline, formset, fieldsets, readonly_fields=None, model_admin=None):\n+    def __init__(self, inline, formset, fieldsets, prepopulated_fields=None,\n+            readonly_fields=None, model_admin=None):\n         self.opts = inline\n         self.formset = formset\n         self.fieldsets = fieldsets\n         self.model_admin = model_admin\n         if readonly_fields is None:\n             readonly_fields = ()\n         self.readonly_fields = readonly_fields\n+        if prepopulated_fields is None:\n+            prepopulated_fields = {}\n+        self.prepopulated_fields = prepopulated_fields\n \n     def __iter__(self):\n         for form, original in zip(self.formset.initial_forms, self.formset.get_queryset()):\n             yield InlineAdminForm(self.formset, form, self.fieldsets,\n-                self.opts.prepopulated_fields, original, self.readonly_fields,\n+                self.prepopulated_fields, original, self.readonly_fields,\n                 model_admin=self.opts)\n         for form in self.formset.extra_forms:\n             yield InlineAdminForm(self.formset, form, self.fieldsets,\n-                self.opts.prepopulated_fields, None, self.readonly_fields,\n+                self.prepopulated_fields, None, self.readonly_fields,\n                 model_admin=self.opts)\n         yield InlineAdminForm(self.formset, self.formset.empty_form,\n-            self.fieldsets, self.opts.prepopulated_fields, None,\n+            self.fieldsets, self.prepopulated_fields, None,\n             self.readonly_fields, model_admin=self.opts)\n \n     def fields(self):"
        },
        {
            "sha": "d08e22b77a522644f94d26973b6c7a78fffd27a0",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
            "patch": "@@ -189,8 +189,17 @@ def _declared_fieldsets(self):\n     declared_fieldsets = property(_declared_fieldsets)\n \n     def get_readonly_fields(self, request, obj=None):\n+        \"\"\"\n+        Hook for specifying custom readonly fields.\n+        \"\"\"\n         return self.readonly_fields\n \n+    def get_prepopulated_fields(self, request, obj=None):\n+        \"\"\"\n+        Hook for specifying custom prepopulated fields.\n+        \"\"\"\n+        return self.prepopulated_fields\n+\n     def queryset(self, request):\n         \"\"\"\n         Returns a QuerySet of all model instances that can be edited by the\n@@ -909,16 +918,18 @@ def add_view(self, request, form_url='', extra_context=None):\n                 formsets.append(formset)\n \n         adminForm = helpers.AdminForm(form, list(self.get_fieldsets(request)),\n-            self.prepopulated_fields, self.get_readonly_fields(request),\n+            self.get_prepopulated_fields(request),\n+            self.get_readonly_fields(request),\n             model_admin=self)\n         media = self.media + adminForm.media\n \n         inline_admin_formsets = []\n         for inline, formset in zip(self.inline_instances, formsets):\n             fieldsets = list(inline.get_fieldsets(request))\n             readonly = list(inline.get_readonly_fields(request))\n+            prepopulated = dict(inline.get_prepopulated_fields(request))\n             inline_admin_formset = helpers.InlineAdminFormSet(inline, formset,\n-                fieldsets, readonly, model_admin=self)\n+                fieldsets, prepopulated, readonly, model_admin=self)\n             inline_admin_formsets.append(inline_admin_formset)\n             media = media + inline_admin_formset.media\n \n@@ -1000,16 +1011,18 @@ def change_view(self, request, object_id, extra_context=None):\n                 formsets.append(formset)\n \n         adminForm = helpers.AdminForm(form, self.get_fieldsets(request, obj),\n-            self.prepopulated_fields, self.get_readonly_fields(request, obj),\n+            self.get_prepopulated_fields(request, obj),\n+            self.get_readonly_fields(request, obj),\n             model_admin=self)\n         media = self.media + adminForm.media\n \n         inline_admin_formsets = []\n         for inline, formset in zip(self.inline_instances, formsets):\n             fieldsets = list(inline.get_fieldsets(request, obj))\n             readonly = list(inline.get_readonly_fields(request, obj))\n+            prepopulated = dict(inline.get_prepopulated_fields(request, obj))\n             inline_admin_formset = helpers.InlineAdminFormSet(inline, formset,\n-                fieldsets, readonly, model_admin=self)\n+                fieldsets, prepopulated, readonly, model_admin=self)\n             inline_admin_formsets.append(inline_admin_formset)\n             media = media + inline_admin_formset.media\n "
        },
        {
            "sha": "f97d4eb260603f936ed40f40dbf0e005dfa9d369",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
            "patch": "@@ -839,6 +839,15 @@ templates used by the :class:`ModelAdmin` views:\n     a ``list`` or ``tuple`` of field names that will be displayed as read-only,\n     as described above in the :attr:`ModelAdmin.readonly_fields` section.\n \n+.. method:: ModelAdmin.get_prepopulated_fields(self, request, obj=None)\n+\n+    .. versionadded:: 1.4\n+\n+    The ``get_prepopulated_fields`` method is given the ``HttpRequest`` and the\n+    ``obj`` being edited (or ``None`` on an add form) and is expected to return\n+    a ``dictionary``, as described above in the :attr:`ModelAdmin.prepopulated_fields`\n+    section.\n+\n .. method:: ModelAdmin.get_urls(self)\n \n     The ``get_urls`` method on a ``ModelAdmin`` returns the URLs to be used for"
        },
        {
            "sha": "1c85e1c9097abdd941c3905947184407448d2264",
            "filename": "tests/regressiontests/admin_views/fixtures/admin-views-users.xml",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/tests%2Fregressiontests%2Fadmin_views%2Ffixtures%2Fadmin-views-users.xml",
            "raw_url": "https://github.com/django/django/raw/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/tests%2Fregressiontests%2Fadmin_views%2Ffixtures%2Fadmin-views-users.xml",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ffixtures%2Fadmin-views-users.xml?ref=6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
            "patch": "@@ -88,6 +88,9 @@\n         <field type=\"DateTimeField\" name=\"date\">2009-03-18 11:54:58</field>\n         <field to=\"admin_views.section\" name=\"section\" rel=\"ManyToOneRel\">1</field>\n     </object>\n-\n-\n-</django-objects>\n\\ No newline at end of file\n+    <object pk=\"1\" model=\"admin_views.prepopulatedpost\">\n+        <field type=\"TextField\" name=\"title\">A Long Title</field>\n+        <field type=\"BooleanField\" name=\"published\">True</field>\n+        <field type=\"SlugField\" name=\"slug\">a-long-title</field>\n+    </object>\n+</django-objects>"
        },
        {
            "sha": "97f6708e4068bb8fc7b6bfb7fba02ec1d8c336a4",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
            "patch": "@@ -529,6 +529,51 @@ class LinkInline(admin.TabularInline):\n     readonly_fields = (\"posted\",)\n \n \n+class PrePopulatedPost(models.Model):\n+    title = models.CharField(max_length=100)\n+    published = models.BooleanField()\n+    slug = models.SlugField()\n+\n+class PrePopulatedSubPost(models.Model):\n+    post = models.ForeignKey(PrePopulatedPost)\n+    subtitle = models.CharField(max_length=100)\n+    subslug = models.SlugField()\n+\n+class SubPostInline(admin.TabularInline):\n+    model = PrePopulatedSubPost\n+\n+    prepopulated_fields = {\n+        'subslug' : ('subtitle',)\n+    }\n+\n+    def get_readonly_fields(self, request, obj=None):\n+        if obj and obj.published:\n+            return ('subslug',)\n+        return self.readonly_fields\n+\n+    def get_prepopulated_fields(self, request, obj=None):\n+        if obj and obj.published:\n+            return {}\n+        return self.prepopulated_fields\n+\n+class PrePopulatedPostAdmin(admin.ModelAdmin):\n+    list_display = ['title', 'slug']\n+    prepopulated_fields = {\n+        'slug' : ('title',)\n+    }\n+\n+    inlines = [SubPostInline]\n+\n+    def get_readonly_fields(self, request, obj=None):\n+        if obj and obj.published:\n+            return ('slug',)\n+        return self.readonly_fields\n+\n+    def get_prepopulated_fields(self, request, obj=None):\n+        if obj and obj.published:\n+            return {}\n+        return self.prepopulated_fields\n+\n class Post(models.Model):\n     title = models.CharField(max_length=100, help_text=\"Some help text for the title (with unicode ŠĐĆŽćžšđ)\")\n     content = models.TextField(help_text=\"Some help text for the content (with unicode ŠĐĆŽćžšđ)\")\n@@ -818,3 +863,4 @@ class OtherStoryAdmin(admin.ModelAdmin):\n admin.site.register(Album, AlbumAdmin)\n admin.site.register(Question)\n admin.site.register(Answer)\n+admin.site.register(PrePopulatedPost, PrePopulatedPostAdmin)"
        },
        {
            "sha": "9b1a73803f505b83151016e45e89d31a7df5cdf5",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6c17190bf8c6c23f21dd49b029106dd5cb41ae2e/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=6c17190bf8c6c23f21dd49b029106dd5cb41ae2e",
            "patch": "@@ -2579,6 +2579,30 @@ def testJsi18n(self):\n         self.assertEqual(get_max_age(response), None)\n \n \n+class PrePopulatedTest(TestCase):\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def tearDown(self):\n+        self.client.logout()\n+\n+    def test_prepopulated_on(self):\n+        response = self.client.get('/test_admin/admin/admin_views/prepopulatedpost/add/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertContains(response, \"id: '#id_slug',\")\n+        self.assertContains(response, \"field['dependency_ids'].push('#id_title');\")\n+        self.assertContains(response, \"id: '#id_prepopulatedsubpost_set-0-subslug',\")\n+\n+    def test_prepopulated_off(self):\n+        response = self.client.get('/test_admin/admin/admin_views/prepopulatedpost/1/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertContains(response, \"A Long Title\")\n+        self.assertNotContains(response, \"id: '#id_slug'\")\n+        self.assertNotContains(response, \"field['dependency_ids'].push('#id_title');\")\n+        self.assertNotContains(response, \"id: '#id_prepopulatedsubpost_set-0-subslug',\")\n+\n class ReadonlyTest(TestCase):\n     fixtures = ['admin-views-users.xml']\n "
        }
    ],
    "stats": {
        "total": 121,
        "additions": 110,
        "deletions": 11
    }
}