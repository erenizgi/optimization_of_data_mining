{
    "author": "akaariai",
    "message": "Fixed #12823 -- Was already fixed in master, tests added\n\nAlso added a little improvement to sql/query.py to get rid of\nnon-necessary IS NOT NULL check.",
    "sha": "06de130dae8b7a6c95143077d7a82fab37da0bc0",
    "files": [
        {
            "sha": "9af7544db39318fbcf3a3dd55dc513e854c3113f",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/06de130dae8b7a6c95143077d7a82fab37da0bc0/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/06de130dae8b7a6c95143077d7a82fab37da0bc0/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=06de130dae8b7a6c95143077d7a82fab37da0bc0",
            "patch": "@@ -1204,7 +1204,8 @@ def add_filter(self, filter_expr, connector=AND, negate=False,\n \n         if negate:\n             self.promote_joins(join_list)\n-            if lookup_type != 'isnull' and (self.is_nullable(target) or len(join_list) > 1):\n+            if (lookup_type != 'isnull' and (\n+                    self.is_nullable(target) or self.alias_map[join_list[-1]].join_type == self.LOUTER)):\n                 # The condition added here will be SQL like this:\n                 # NOT (col IS NOT NULL), where the first NOT is added in\n                 # upper layers of code. The reason for addition is that if col\n@@ -1447,7 +1448,7 @@ def split_exclude(self, filter_expr, prefix, can_reuse, names_with_path):\n         # nothing\n         if self.is_nullable(query.select[0].field):\n             alias, col = query.select[0].col\n-            query.where.add((Constraint(alias, col, None), 'isnull', False), AND)\n+            query.where.add((Constraint(alias, col, query.select[0].field), 'isnull', False), AND)\n \n         # Still make sure that the trimmed parts in the inner query and\n         # trimmed prefix are in sync. So, use the trimmed_joins to make sure"
        },
        {
            "sha": "c8598371a6cfb160dd7fc220f7267cf13129e605",
            "filename": "tests/queries/models.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/06de130dae8b7a6c95143077d7a82fab37da0bc0/tests%2Fqueries%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/06de130dae8b7a6c95143077d7a82fab37da0bc0/tests%2Fqueries%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fqueries%2Fmodels.py?ref=06de130dae8b7a6c95143077d7a82fab37da0bc0",
            "patch": "@@ -454,3 +454,19 @@ class Program(models.Model):\n class Channel(models.Model):\n     programs = models.ManyToManyField(Program)\n     identifier = models.OneToOneField(Identifier)\n+\n+class Book(models.Model):\n+    title = models.TextField()\n+    chapter = models.ForeignKey('Chapter')\n+\n+class Chapter(models.Model):\n+    title = models.TextField()\n+    paragraph = models.ForeignKey('Paragraph')\n+\n+\n+class Paragraph(models.Model):\n+    text = models.TextField()\n+    page = models.ManyToManyField('Page')\n+\n+class Page(models.Model):\n+    text = models.TextField()"
        },
        {
            "sha": "2c17cb5e76a4e44e5c094932e7e7e5c58bb0f429",
            "filename": "tests/queries/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/06de130dae8b7a6c95143077d7a82fab37da0bc0/tests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/06de130dae8b7a6c95143077d7a82fab37da0bc0/tests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fqueries%2Ftests.py?ref=06de130dae8b7a6c95143077d7a82fab37da0bc0",
            "patch": "@@ -24,7 +24,8 @@\n     Node, ObjectA, ObjectB, ObjectC, CategoryItem, SimpleCategory,\n     SpecialCategory, OneToOneCategory, NullableName, ProxyCategory,\n     SingleObject, RelatedObject, ModelA, ModelD, Responsibility, Job,\n-    JobResponsibilities, BaseA, Identifier, Program, Channel)\n+    JobResponsibilities, BaseA, Identifier, Program, Channel, Page, Paragraph,\n+    Chapter, Book)\n \n \n class BaseQuerysetTest(TestCase):\n@@ -2638,3 +2639,25 @@ def test_exclude_many_to_many(self):\n             Identifier.objects.exclude(program__channel=None).order_by('name'),\n             ['<Identifier: program>']\n         )\n+\n+    def test_ticket_12823(self):\n+        pg3 = Page.objects.create(text='pg3')\n+        pg2 = Page.objects.create(text='pg2')\n+        pg1 = Page.objects.create(text='pg1')\n+        pa1 = Paragraph.objects.create(text='pa1')\n+        pa1.page = [pg1, pg2]\n+        pa2 = Paragraph.objects.create(text='pa2')\n+        pa2.page = [pg2, pg3]\n+        pa3 = Paragraph.objects.create(text='pa3')\n+        ch1 = Chapter.objects.create(title='ch1', paragraph=pa1)\n+        ch2 = Chapter.objects.create(title='ch2', paragraph=pa2)\n+        ch3 = Chapter.objects.create(title='ch3', paragraph=pa3)\n+        b1 = Book.objects.create(title='b1', chapter=ch1)\n+        b2 = Book.objects.create(title='b2', chapter=ch2)\n+        b3 = Book.objects.create(title='b3', chapter=ch3)\n+        q = Book.objects.exclude(chapter__paragraph__page__text='pg1')\n+        self.assertNotIn('IS NOT NULL', str(q.query))\n+        self.assertEqual(len(q), 2)\n+        self.assertNotIn(b1, q)\n+        self.assertIn(b2, q)\n+        self.assertIn(b3, q)"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 43,
        "deletions": 3
    }
}