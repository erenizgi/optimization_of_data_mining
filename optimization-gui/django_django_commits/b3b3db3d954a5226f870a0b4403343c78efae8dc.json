{
    "author": "freakboy3742",
    "message": "Fixed #19067 -- Clarified handling of username in createsuperuser.\n\nThanks to clelland for the report, and Preston Holmes for the draft patch.",
    "sha": "b3b3db3d954a5226f870a0b4403343c78efae8dc",
    "files": [
        {
            "sha": "216d56d7305431b050eb499bf1f9514ed5e9fc97",
            "filename": "django/contrib/auth/management/commands/createsuperuser.py",
            "status": "modified",
            "additions": 48,
            "deletions": 42,
            "changes": 90,
            "blob_url": "https://github.com/django/django/blob/b3b3db3d954a5226f870a0b4403343c78efae8dc/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "raw_url": "https://github.com/django/django/raw/b3b3db3d954a5226f870a0b4403343c78efae8dc/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py?ref=b3b3db3d954a5226f870a0b4403343c78efae8dc",
            "patch": "@@ -16,50 +16,56 @@\n \n \n class Command(BaseCommand):\n-    option_list = BaseCommand.option_list + (\n-        make_option('--username', dest='username', default=None,\n-            help='Specifies the username for the superuser.'),\n-        make_option('--noinput', action='store_false', dest='interactive', default=True,\n-            help=('Tells Django to NOT prompt the user for input of any kind. '\n-                  'You must use --username with --noinput, along with an option for '\n-                  'any other required field. Superusers created with --noinput will '\n-                  ' not be able to log in until they\\'re given a valid password.')),\n-        make_option('--database', action='store', dest='database',\n-            default=DEFAULT_DB_ALIAS, help='Specifies the database to use. Default is \"default\".'),\n-    ) + tuple(\n-        make_option('--%s' % field, dest=field, default=None,\n-            help='Specifies the %s for the superuser.' % field)\n-        for field in get_user_model().REQUIRED_FIELDS\n-    )\n \n+    def __init__(self, *args, **kwargs):\n+        # Options are defined in an __init__ method to support swapping out\n+        # custom user models in tests.\n+        super(Command, self).__init__(*args, **kwargs)\n+        self.UserModel = get_user_model()\n+        self.username_field = self.UserModel._meta.get_field(self.UserModel.USERNAME_FIELD)\n+\n+        self.option_list = BaseCommand.option_list + (\n+            make_option('--%s' % self.UserModel.USERNAME_FIELD, dest=self.UserModel.USERNAME_FIELD, default=None,\n+                help='Specifies the login for the superuser.'),\n+            make_option('--noinput', action='store_false', dest='interactive', default=True,\n+                help=('Tells Django to NOT prompt the user for input of any kind. '\n+                    'You must use --%s with --noinput, along with an option for '\n+                    'any other required field. Superusers created with --noinput will '\n+                    ' not be able to log in until they\\'re given a valid password.' %\n+                    self.UserModel.USERNAME_FIELD)),\n+            make_option('--database', action='store', dest='database',\n+                default=DEFAULT_DB_ALIAS, help='Specifies the database to use. Default is \"default\".'),\n+        ) + tuple(\n+            make_option('--%s' % field, dest=field, default=None,\n+                help='Specifies the %s for the superuser.' % field)\n+            for field in self.UserModel.REQUIRED_FIELDS\n+        )\n+\n+    option_list = BaseCommand.option_list\n     help = 'Used to create a superuser.'\n \n     def handle(self, *args, **options):\n-        username = options.get('username', None)\n+        username = options.get(self.UserModel.USERNAME_FIELD, None)\n         interactive = options.get('interactive')\n         verbosity = int(options.get('verbosity', 1))\n         database = options.get('database')\n \n-        UserModel = get_user_model()\n-\n-        username_field = UserModel._meta.get_field(UserModel.USERNAME_FIELD)\n-        other_fields = UserModel.REQUIRED_FIELDS\n-\n         # If not provided, create the user with an unusable password\n         password = None\n-        other_data = {}\n+        user_data = {}\n \n         # Do quick and dirty validation if --noinput\n         if not interactive:\n             try:\n                 if not username:\n-                    raise CommandError(\"You must use --username with --noinput.\")\n-                username = username_field.clean(username, None)\n+                    raise CommandError(\"You must use --%s with --noinput.\" %\n+                            self.UserModel.USERNAME_FIELD)\n+                username = self.username_field.clean(username, None)\n \n-                for field_name in other_fields:\n+                for field_name in self.UserModel.REQUIRED_FIELDS:\n                     if options.get(field_name):\n-                        field = UserModel._meta.get_field(field_name)\n-                        other_data[field_name] = field.clean(options[field_name], None)\n+                        field = self.UserModel._meta.get_field(field_name)\n+                        user_data[field_name] = field.clean(options[field_name], None)\n                     else:\n                         raise CommandError(\"You must use --%s with --noinput.\" % field_name)\n             except exceptions.ValidationError as e:\n@@ -74,41 +80,39 @@ def handle(self, *args, **options):\n \n                 # Get a username\n                 while username is None:\n-                    username_field = UserModel._meta.get_field(UserModel.USERNAME_FIELD)\n                     if not username:\n-                        input_msg = capfirst(username_field.verbose_name)\n+                        input_msg = capfirst(self.username_field.verbose_name)\n                         if default_username:\n                             input_msg += \" (leave blank to use '%s')\" % default_username\n                         raw_value = input(input_msg + ': ')\n \n                     if default_username and raw_value == '':\n                         raw_value = default_username\n                     try:\n-                        username = username_field.clean(raw_value, None)\n+                        username = self.username_field.clean(raw_value, None)\n                     except exceptions.ValidationError as e:\n                         self.stderr.write(\"Error: %s\" % '; '.join(e.messages))\n                         username = None\n                         continue\n                     try:\n-                        UserModel.objects.using(database).get(**{\n-                                UserModel.USERNAME_FIELD: username\n-                            })\n-                    except UserModel.DoesNotExist:\n+                        self.UserModel.objects.db_manager(database).get_by_natural_key(username)\n+                    except self.UserModel.DoesNotExist:\n                         pass\n                     else:\n-                        self.stderr.write(\"Error: That username is already taken.\")\n+                        self.stderr.write(\"Error: That %s is already taken.\" %\n+                                self.username_field.verbose_name)\n                         username = None\n \n-                for field_name in other_fields:\n-                    field = UserModel._meta.get_field(field_name)\n-                    other_data[field_name] = options.get(field_name)\n-                    while other_data[field_name] is None:\n+                for field_name in self.UserModel.REQUIRED_FIELDS:\n+                    field = self.UserModel._meta.get_field(field_name)\n+                    user_data[field_name] = options.get(field_name)\n+                    while user_data[field_name] is None:\n                         raw_value = input(capfirst(field.verbose_name + ': '))\n                         try:\n-                            other_data[field_name] = field.clean(raw_value, None)\n+                            user_data[field_name] = field.clean(raw_value, None)\n                         except exceptions.ValidationError as e:\n                             self.stderr.write(\"Error: %s\" % '; '.join(e.messages))\n-                            other_data[field_name] = None\n+                            user_data[field_name] = None\n \n                 # Get a password\n                 while password is None:\n@@ -128,6 +132,8 @@ def handle(self, *args, **options):\n                 self.stderr.write(\"\\nOperation cancelled.\")\n                 sys.exit(1)\n \n-        UserModel.objects.db_manager(database).create_superuser(username=username, password=password, **other_data)\n+        user_data[self.UserModel.USERNAME_FIELD] = username\n+        user_data['password'] = password\n+        self.UserModel.objects.db_manager(database).create_superuser(**user_data)\n         if verbosity >= 1:\n             self.stdout.write(\"Superuser created successfully.\")"
        },
        {
            "sha": "a29ed6a104f34f1d27d51d54ebce0ff3bc41517c",
            "filename": "django/contrib/auth/tests/custom_user.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/b3b3db3d954a5226f870a0b4403343c78efae8dc/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "raw_url": "https://github.com/django/django/raw/b3b3db3d954a5226f870a0b4403343c78efae8dc/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py?ref=b3b3db3d954a5226f870a0b4403343c78efae8dc",
            "patch": "@@ -23,8 +23,8 @@ def create_user(self, email, date_of_birth, password=None):\n         user.save(using=self._db)\n         return user\n \n-    def create_superuser(self, username, password, date_of_birth):\n-        u = self.create_user(username, password=password, date_of_birth=date_of_birth)\n+    def create_superuser(self, email, password, date_of_birth):\n+        u = self.create_user(email, password=password, date_of_birth=date_of_birth)\n         u.is_admin = True\n         u.save(using=self._db)\n         return u"
        },
        {
            "sha": "976c0c4972122739a4037884ba6b3e9eaf567784",
            "filename": "django/contrib/auth/tests/management.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/b3b3db3d954a5226f870a0b4403343c78efae8dc/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/b3b3db3d954a5226f870a0b4403343c78efae8dc/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py?ref=b3b3db3d954a5226f870a0b4403343c78efae8dc",
            "patch": "@@ -138,7 +138,7 @@ def test_swappable_user(self):\n         new_io = StringIO()\n         call_command(\"createsuperuser\",\n             interactive=False,\n-            username=\"joe@somewhere.org\",\n+            email=\"joe@somewhere.org\",\n             date_of_birth=\"1976-04-01\",\n             stdout=new_io,\n             skip_validation=True"
        },
        {
            "sha": "41159984f65ddb4f6a9cb0ded5322ec663316854",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 60,
            "deletions": 50,
            "changes": 110,
            "blob_url": "https://github.com/django/django/blob/b3b3db3d954a5226f870a0b4403343c78efae8dc/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/b3b3db3d954a5226f870a0b4403343c78efae8dc/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=b3b3db3d954a5226f870a0b4403343c78efae8dc",
            "patch": "@@ -1878,47 +1878,54 @@ The easiest way to construct a compliant custom User model is to inherit from\n implementation of a `User` model, including hashed passwords and tokenized\n password resets. You must then provide some key implementation details:\n \n-.. attribute:: User.USERNAME_FIELD\n+.. class:: models.CustomUser\n \n-    A string describing the name of the field on the User model that is\n-    used as the unique identifier. This will usually be a username of\n-    some kind, but it can also be an email address, or any other unique\n-    identifier. In the following example, the field `identifier` is used\n-    as the identifying field::\n+    .. attribute:: User.USERNAME_FIELD\n \n-        class MyUser(AbstractBaseUser):\n-            identfier = models.CharField(max_length=40, unique=True, db_index=True)\n-            ...\n-            USERNAME_FIELD = 'identifier'\n+        A string describing the name of the field on the User model that is\n+        used as the unique identifier. This will usually be a username of\n+        some kind, but it can also be an email address, or any other unique\n+        identifier. In the following example, the field `identifier` is used\n+        as the identifying field::\n \n-.. attribute:: User.REQUIRED_FIELDS\n+            class MyUser(AbstractBaseUser):\n+                identfier = models.CharField(max_length=40, unique=True, db_index=True)\n+                ...\n+                USERNAME_FIELD = 'identifier'\n \n-    A list of the field names that *must* be provided when creating\n-    a user. For example, here is the partial definition for a User model\n-    that defines two required fields - a date of birth and height::\n+    .. attribute:: User.REQUIRED_FIELDS\n \n-        class MyUser(AbstractBaseUser):\n-            ...\n-            date_of_birth = models.DateField()\n-            height = models.FloatField()\n-            ...\n-            REQUIRED_FIELDS = ['date_of_birth', 'height']\n+        A list of the field names that *must* be provided when creating\n+        a user. For example, here is the partial definition for a User model\n+        that defines two required fields - a date of birth and height::\n+\n+            class MyUser(AbstractBaseUser):\n+                ...\n+                date_of_birth = models.DateField()\n+                height = models.FloatField()\n+                ...\n+                REQUIRED_FIELDS = ['date_of_birth', 'height']\n \n-.. method:: User.get_full_name():\n+        .. note::\n \n-    A longer formal identifier for the user. A common interpretation\n-    would be the full name name of the user, but it can be any string that\n-    identifies the user.\n+            ``REQUIRED_FIELDS`` must contain all required fields on your User\n+            model, but should *not* contain the ``USERNAME_FIELD``.\n \n-.. method:: User.get_short_name():\n+    .. method:: User.get_full_name():\n \n-    A short, informal identifier for the user. A common interpretation\n-    would be the first name of the user, but it can be any string that\n-    identifies the user in an informal way. It may also return the same\n-    value as :meth:`django.contrib.auth.User.get_full_name()`.\n+        A longer formal identifier for the user. A common interpretation\n+        would be the full name name of the user, but it can be any string that\n+        identifies the user.\n+\n+    .. method:: User.get_short_name():\n+\n+        A short, informal identifier for the user. A common interpretation\n+        would be the first name of the user, but it can be any string that\n+        identifies the user in an informal way. It may also return the same\n+        value as :meth:`django.contrib.auth.User.get_full_name()`.\n \n The following methods are available on any subclass of\n-:class:`~django.contrib.auth.models.AbstractBaseUser`::\n+:class:`~django.contrib.auth.models.AbstractBaseUser`:\n \n .. class:: models.AbstractBaseUser\n \n@@ -1979,33 +1986,36 @@ defines different fields, you will need to define a custom manager that\n extends :class:`~django.contrib.auth.models.BaseUserManager` providing two\n additional methods:\n \n-.. method:: UserManager.create_user(username, password=None, **other_fields)\n+.. class:: models.CustomUserManager\n \n-    The prototype of `create_user()` should accept all required fields\n-    as arguments. For example, if your user model defines `username`,\n-    and `date_of_birth` as required fields, then create_user should be\n-    defined as::\n+    .. method:: models.CustomUserManager.create_user(*username_field*, password=None, **other_fields)\n \n-        def create_user(self, username, date_of_birth, password=None):\n-            # create user here\n+        The prototype of `create_user()` should accept the username field,\n+        plus all required fields as arguments. For example, if your user model\n+        uses `email` as the username field, and has `date_of_birth` as a required\n+        fields, then create_user should be defined as::\n \n-.. method:: UserManager.create_superuser(username, password, **other_fields)\n+            def create_user(self, email, date_of_birth, password=None):\n+                # create user here\n \n-    The prototype of `create_superuser()` should accept all required fields\n-    as arguments. For example, if your user model defines `username`,\n-    and `date_of_birth` as required fields, then create_user should be\n-    defined as::\n+    .. method:: models.CustomUserManager.create_superuser(*username_field*, password, **other_fields)\n \n-        def create_superuser(self, username, date_of_birth, password):\n-            # create superuser here\n+        The prototype of `create_user()` should accept the username field,\n+        plus all required fields as arguments. For example, if your user model\n+        uses `email` as the username field, and has `date_of_birth` as a required\n+        fields, then create_superuser should be defined as::\n \n-    Unlike `create_user()`, `create_superuser()` *must* require the caller\n-    to provider a password.\n+            def create_superuser(self, email, date_of_birth, password):\n+                # create superuser here\n+\n+        Unlike `create_user()`, `create_superuser()` *must* require the caller\n+        to provider a password.\n \n :class:`~django.contrib.auth.models.BaseUserManager` provides the following\n utility methods:\n \n .. class:: models.BaseUserManager\n+\n     .. method:: models.BaseUserManager.normalize_email(email)\n \n         A classmethod that normalizes email addresses by lowercasing\n@@ -2165,12 +2175,12 @@ authentication app::\n             user.save(using=self._db)\n             return user\n \n-        def create_superuser(self, username, date_of_birth, password):\n+        def create_superuser(self, email, date_of_birth, password):\n             \"\"\"\n             Creates and saves a superuser with the given email, date of\n             birth and password.\n             \"\"\"\n-            user = self.create_user(username,\n+            user = self.create_user(email,\n                 password=password,\n                 date_of_birth=date_of_birth\n             )\n@@ -2223,7 +2233,7 @@ authentication app::\n             return self.is_admin\n \n Then, to register this custom User model with Django's admin, the following\n-code would be required in ``admin.py``::\n+code would be required in the app's ``admin.py`` file::\n \n     from django import forms\n     from django.contrib import admin\n@@ -2249,7 +2259,7 @@ code would be required in ``admin.py``::\n             password1 = self.cleaned_data.get(\"password1\")\n             password2 = self.cleaned_data.get(\"password2\")\n             if password1 and password2 and password1 != password2:\n-                raise forms.ValidationError('Passwords don't match')\n+                raise forms.ValidationError(\"Passwords don't match\")\n             return password2\n \n         def save(self, commit=True):"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 111,
        "deletions": 95
    }
}