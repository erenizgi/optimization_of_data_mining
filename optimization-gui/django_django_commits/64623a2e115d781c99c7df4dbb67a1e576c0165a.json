{
    "author": "aaugustin",
    "message": "Fixed #19772 -- Handled APPEND_SLASH correctly in the redirects app.",
    "sha": "64623a2e115d781c99c7df4dbb67a1e576c0165a",
    "files": [
        {
            "sha": "f5d35946bcc8d38e9ce32f3182cdc7e3f53280e1",
            "filename": "django/contrib/redirects/middleware.py",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/64623a2e115d781c99c7df4dbb67a1e576c0165a/django%2Fcontrib%2Fredirects%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/64623a2e115d781c99c7df4dbb67a1e576c0165a/django%2Fcontrib%2Fredirects%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fredirects%2Fmiddleware.py?ref=64623a2e115d781c99c7df4dbb67a1e576c0165a",
            "patch": "@@ -1,3 +1,5 @@\n+from __future__ import unicode_literals\n+\n from django.contrib.redirects.models import Redirect\n from django.contrib.sites.models import get_current_site\n from django import http\n@@ -7,17 +9,21 @@ class RedirectFallbackMiddleware(object):\n     def process_response(self, request, response):\n         if response.status_code != 404:\n             return response # No need to check for a redirect for non-404 responses.\n-        path = request.get_full_path()\n+\n+        full_path = request.get_full_path()\n         current_site = get_current_site(request)\n+\n+        r = None\n         try:\n-            r = Redirect.objects.get(site__id__exact=current_site.id, old_path=path)\n+            r = Redirect.objects.get(site=current_site, old_path=full_path)\n         except Redirect.DoesNotExist:\n-            r = None\n-        if r is None and settings.APPEND_SLASH:\n-            # Try removing the trailing slash.\n+            pass\n+        if settings.APPEND_SLASH and not request.path.endswith('/'):\n+            # Try appending a trailing slash.\n+            path_len = len(request.path)\n+            full_path = full_path[:path_len] + '/' + full_path[path_len:]\n             try:\n-                r = Redirect.objects.get(site__id__exact=current_site.id,\n-                    old_path=path[:path.rfind('/')]+path[path.rfind('/')+1:])\n+                r = Redirect.objects.get(site=current_site, old_path=full_path)\n             except Redirect.DoesNotExist:\n                 pass\n         if r is not None:"
        },
        {
            "sha": "4ea85231998b8d661f8e0fd49dc7e3ca5838709e",
            "filename": "django/contrib/redirects/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 8,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/64623a2e115d781c99c7df4dbb67a1e576c0165a/django%2Fcontrib%2Fredirects%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/64623a2e115d781c99c7df4dbb67a1e576c0165a/django%2Fcontrib%2Fredirects%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fredirects%2Ftests.py?ref=64623a2e115d781c99c7df4dbb67a1e576c0165a",
            "patch": "@@ -8,10 +8,10 @@\n \n \n @override_settings(\n-    SITE_ID=1,\n-    APPEND_SLASH=True,\n+    APPEND_SLASH=False,\n     MIDDLEWARE_CLASSES=list(settings.MIDDLEWARE_CLASSES) +\n         ['django.contrib.redirects.middleware.RedirectFallbackMiddleware'],\n+    SITE_ID=1,\n )\n class RedirectTests(TestCase):\n \n@@ -23,20 +23,32 @@ def test_model(self):\n             site=self.site, old_path='/initial', new_path='/new_target')\n         self.assertEqual(six.text_type(r1), \"/initial ---> /new_target\")\n \n-    def test_redirect_middleware(self):\n-        r1 = Redirect.objects.create(\n+    def test_redirect(self):\n+        Redirect.objects.create(\n             site=self.site, old_path='/initial', new_path='/new_target')\n         response = self.client.get('/initial')\n         self.assertRedirects(response,\n             '/new_target', status_code=301, target_status_code=404)\n-        # Works also with trailing slash\n-        response = self.client.get('/initial/')\n+\n+    @override_settings(APPEND_SLASH=True)\n+    def test_redirect_with_append_slash(self):\n+        Redirect.objects.create(\n+            site=self.site, old_path='/initial/', new_path='/new_target/')\n+        response = self.client.get('/initial')\n         self.assertRedirects(response,\n-            '/new_target', status_code=301, target_status_code=404)\n+            '/new_target/', status_code=301, target_status_code=404)\n+\n+    @override_settings(APPEND_SLASH=True)\n+    def test_redirect_with_append_slash_and_query_string(self):\n+        Redirect.objects.create(\n+            site=self.site, old_path='/initial/?foo', new_path='/new_target/')\n+        response = self.client.get('/initial?foo')\n+        self.assertRedirects(response,\n+            '/new_target/', status_code=301, target_status_code=404)\n \n     def test_response_gone(self):\n         \"\"\"When the redirect target is '', return a 410\"\"\"\n-        r1 = Redirect.objects.create(\n+        Redirect.objects.create(\n             site=self.site, old_path='/initial', new_path='')\n         response = self.client.get('/initial')\n         self.assertEqual(response.status_code, 410)"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 33,
        "deletions": 15
    }
}