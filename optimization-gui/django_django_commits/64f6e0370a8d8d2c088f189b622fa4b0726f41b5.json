{
    "author": "akaariai",
    "message": "Made some tests behave nicer re connection handling",
    "sha": "64f6e0370a8d8d2c088f189b622fa4b0726f41b5",
    "files": [
        {
            "sha": "9cfdd739629b13603dae3f5feaceebba1c81dc4c",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/64f6e0370a8d8d2c088f189b622fa4b0726f41b5/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/64f6e0370a8d8d2c088f189b622fa4b0726f41b5/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=64f6e0370a8d8d2c088f189b622fa4b0726f41b5",
            "patch": "@@ -559,21 +559,27 @@ def test_default_connection_thread_local(self):\n         \"\"\"\n         connections_set = set()\n         connection.cursor()\n-        connections_set.add(connection.connection)\n+        connections_set.add(connection)\n         def runner():\n-            from django.db import connection\n+            # Passing django.db.connection between threads doesn't work while\n+            # connections[DEFAULT_DB_ALIAS] does.\n+            from django.db import connections\n+            connection = connections[DEFAULT_DB_ALIAS]\n             connection.cursor()\n-            connections_set.add(connection.connection)\n+            connections_set.add(connection)\n         for x in range(2):\n             t = threading.Thread(target=runner)\n             t.start()\n             t.join()\n-        self.assertEqual(len(connections_set), 3)\n+        # Check that each created connection got different inner connection.\n+        self.assertEqual(\n+            len(set([conn.connection for conn in connections_set])),\n+            3)\n         # Finish by closing the connections opened by the other threads (the\n         # connection opened in the main thread will automatically be closed on\n         # teardown).\n         for conn in connections_set:\n-            if conn != connection.connection:\n+            if conn != connection:\n                 conn.close()\n \n     def test_connections_thread_local(self):"
        },
        {
            "sha": "c3e4a6a0b7e2d2861a0df797bc1b5f2cae4836ad",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 12,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/64f6e0370a8d8d2c088f189b622fa4b0726f41b5/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/64f6e0370a8d8d2c088f189b622fa4b0726f41b5/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=64f6e0370a8d8d2c088f189b622fa4b0726f41b5",
            "patch": "@@ -3,7 +3,8 @@\n import datetime\n \n from django.conf import settings\n-from django.db import backend, transaction, DEFAULT_DB_ALIAS, models\n+from django.db import transaction, DEFAULT_DB_ALIAS, models\n+from django.db.utils import ConnectionHandler\n from django.test import TestCase, TransactionTestCase, skipUnlessDBFeature\n \n from .models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n@@ -17,17 +18,8 @@\n class DeleteLockingTest(TransactionTestCase):\n     def setUp(self):\n         # Create a second connection to the default database\n-        conn_settings = settings.DATABASES[DEFAULT_DB_ALIAS]\n-        self.conn2 = backend.DatabaseWrapper({\n-            'HOST': conn_settings['HOST'],\n-            'NAME': conn_settings['NAME'],\n-            'OPTIONS': conn_settings['OPTIONS'],\n-            'PASSWORD': conn_settings['PASSWORD'],\n-            'PORT': conn_settings['PORT'],\n-            'USER': conn_settings['USER'],\n-            'TIME_ZONE': settings.TIME_ZONE,\n-        })\n-\n+        new_connections = ConnectionHandler(settings.DATABASES)\n+        self.conn2 = new_connections[DEFAULT_DB_ALIAS]\n         # Put both DB connections into managed transaction mode\n         transaction.enter_transaction_management()\n         transaction.managed(True)"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 15,
        "deletions": 17
    }
}