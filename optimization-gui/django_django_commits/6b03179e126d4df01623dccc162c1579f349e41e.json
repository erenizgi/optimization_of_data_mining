{
    "author": "charettes",
    "message": "Fixed #19688 -- Allow model subclassing with a custom metaclass using six.with_metaclass",
    "sha": "6b03179e126d4df01623dccc162c1579f349e41e",
    "files": [
        {
            "sha": "8eb4048365bc93a39e41b2618cf0ee16ccbf247f",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/6b03179e126d4df01623dccc162c1579f349e41e/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/6b03179e126d4df01623dccc162c1579f349e41e/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=6b03179e126d4df01623dccc162c1579f349e41e",
            "patch": "@@ -58,12 +58,21 @@ class ModelBase(type):\n     \"\"\"\n     def __new__(cls, name, bases, attrs):\n         super_new = super(ModelBase, cls).__new__\n+\n         # six.with_metaclass() inserts an extra class called 'NewBase' in the\n-        # inheritance tree: Model -> NewBase -> object. Ignore this class.\n+        # inheritance tree: Model -> NewBase -> object. But the initialization\n+        # should be executed only once for a given model class.\n+\n+        # attrs will never be empty for classes declared in the standard way\n+        # (ie. with the `class` keyword). This is quite robust.\n+        if name == 'NewBase' and attrs == {}:\n+            return super_new(cls, name, bases, attrs)\n+\n+        # Also ensure initialization is only performed for subclasses of Model\n+        # (excluding Model class itself).\n         parents = [b for b in bases if isinstance(b, ModelBase) and\n                 not (b.__name__ == 'NewBase' and b.__mro__ == (b, object))]\n         if not parents:\n-            # If this isn't a subclass of Model, don't do anything special.\n             return super_new(cls, name, bases, attrs)\n \n         # Create the class."
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/modeltests/base/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/6b03179e126d4df01623dccc162c1579f349e41e/tests%2Fmodeltests%2Fbase%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/6b03179e126d4df01623dccc162c1579f349e41e/tests%2Fmodeltests%2Fbase%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fbase%2F__init__.py?ref=6b03179e126d4df01623dccc162c1579f349e41e"
        },
        {
            "sha": "3d39302aba96cdc047114281eb38b23eb2a419bf",
            "filename": "tests/modeltests/base/models.py",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/6b03179e126d4df01623dccc162c1579f349e41e/tests%2Fmodeltests%2Fbase%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/6b03179e126d4df01623dccc162c1579f349e41e/tests%2Fmodeltests%2Fbase%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fbase%2Fmodels.py?ref=6b03179e126d4df01623dccc162c1579f349e41e",
            "patch": "@@ -0,0 +1,5 @@\n+from django.db.models.base import ModelBase\n+\n+\n+class CustomBaseModel(ModelBase):\n+    pass"
        },
        {
            "sha": "6229b7a305d653070e068378c3bfb82e2ebe6e57",
            "filename": "tests/modeltests/base/tests.py",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/6b03179e126d4df01623dccc162c1579f349e41e/tests%2Fmodeltests%2Fbase%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6b03179e126d4df01623dccc162c1579f349e41e/tests%2Fmodeltests%2Fbase%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fbase%2Ftests.py?ref=6b03179e126d4df01623dccc162c1579f349e41e",
            "patch": "@@ -0,0 +1,36 @@\n+from __future__ import unicode_literals\n+\n+from django.db import models\n+from django.test.testcases import SimpleTestCase\n+from django.utils import six\n+from django.utils.unittest import skipIf\n+\n+from .models import CustomBaseModel\n+\n+\n+class CustomBaseTest(SimpleTestCase):\n+\n+    @skipIf(six.PY3, 'test metaclass definition under Python 2')\n+    def test_py2_custom_base(self):\n+        \"\"\"\n+        Make sure models.Model can be subclassed with a valid custom base\n+        using __metaclass__\n+        \"\"\"\n+        try:\n+            class MyModel(models.Model):\n+                __metaclass__ = CustomBaseModel\n+        except Exception:\n+            self.fail(\"models.Model couldn't be subclassed with a valid \"\n+                      \"custom base using __metaclass__.\")\n+\n+    def test_six_custom_base(self):\n+        \"\"\"\n+        Make sure models.Model can be subclassed with a valid custom base\n+        using `six.with_metaclass`.\n+        \"\"\"\n+        try:\n+            class MyModel(six.with_metaclass(CustomBaseModel, models.Model)):\n+                pass\n+        except Exception:\n+            self.fail(\"models.Model couldn't be subclassed with a valid \"\n+                      \"custom base using `six.with_metaclass`.\")"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 52,
        "deletions": 2
    }
}