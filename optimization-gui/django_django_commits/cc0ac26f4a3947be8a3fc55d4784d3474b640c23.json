{
    "author": "akaariai",
    "message": "Fixed #19273 -- Fixed DB cache backend on pg 9.0+ and py3\n\nThere was a problem caused by Postgres 9.0+ having bytea_output default\nvalue of 'hex' and cache backend inserting the content as 'bytes' into\na column of type TEXT. Fixed by converting the bytes value to a string\nbefore insert.",
    "sha": "cc0ac26f4a3947be8a3fc55d4784d3474b640c23",
    "files": [
        {
            "sha": "c93bc90b18c339b8820f0950bba75e46f5688e01",
            "filename": "django/core/cache/backends/db.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/cc0ac26f4a3947be8a3fc55d4784d3474b640c23/django%2Fcore%2Fcache%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/cc0ac26f4a3947be8a3fc55d4784d3474b640c23/django%2Fcore%2Fcache%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcache%2Fbackends%2Fdb.py?ref=cc0ac26f4a3947be8a3fc55d4784d3474b640c23",
            "patch": "@@ -11,7 +11,7 @@\n from django.conf import settings\n from django.core.cache.backends.base import BaseCache\n from django.db import connections, router, transaction, DatabaseError\n-from django.utils import timezone\n+from django.utils import timezone, six\n from django.utils.encoding import force_bytes\n \n \n@@ -104,7 +104,11 @@ def _base_set(self, mode, key, value, timeout=None):\n         if num > self._max_entries:\n             self._cull(db, cursor, now)\n         pickled = pickle.dumps(value, pickle.HIGHEST_PROTOCOL)\n-        encoded = base64.b64encode(pickled).strip()\n+        b64encoded = base64.b64encode(pickled)\n+        # The DB column is expecting a string, so make sure the value is a\n+        # string, not bytes. Refs #19274.\n+        if six.PY3:\n+            b64encoded = b64encoded.decode('latin1')\n         cursor.execute(\"SELECT cache_key, expires FROM %s \"\n                        \"WHERE cache_key = %%s\" % table, [key])\n         try:\n@@ -113,11 +117,11 @@ def _base_set(self, mode, key, value, timeout=None):\n                     (mode == 'add' and result[1] < now)):\n                 cursor.execute(\"UPDATE %s SET value = %%s, expires = %%s \"\n                                \"WHERE cache_key = %%s\" % table,\n-                               [encoded, connections[db].ops.value_to_db_datetime(exp), key])\n+                               [b64encoded, connections[db].ops.value_to_db_datetime(exp), key])\n             else:\n                 cursor.execute(\"INSERT INTO %s (cache_key, value, expires) \"\n                                \"VALUES (%%s, %%s, %%s)\" % table,\n-                               [key, encoded, connections[db].ops.value_to_db_datetime(exp)])\n+                               [key, b64encoded, connections[db].ops.value_to_db_datetime(exp)])\n         except DatabaseError:\n             # To be threadsafe, updates/inserts are allowed to fail silently\n             transaction.rollback_unless_managed(using=db)"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 8,
        "deletions": 4
    }
}