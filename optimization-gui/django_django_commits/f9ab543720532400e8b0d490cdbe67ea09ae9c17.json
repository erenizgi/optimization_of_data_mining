{
    "author": "andrewsg",
    "message": "Fixed #20084 -- Provided option to validate formset max_num on server.\n\nThis is provided as a new \"validate_max\" formset_factory option defaulting to\nFalse, since the non-validating behavior of max_num is longstanding, and there\nis certainly code relying on it. (In fact, even the Django admin relies on it\nfor the case where there are more existing inlines than the given max_num). It\nmay be that at some point we want to deprecate validate_max=False and\neventually remove the option, but this commit takes no steps in that direction.\n\nThis also fixes the DoS-prevention absolute_max enforcement so that it causes a\nform validation error rather than an IndexError, and ensures that absolute_max\nis always 1000 more than max_num, to prevent surprising changes in behavior\nwith max_num close to absolute_max.\n\nLastly, this commit fixes the previous inconsistency between a regular formset\nand a model formset in the precedence of max_num and initial data. Previously\nin a regular formset, if the provided initial data was longer than max_num, it\nwas truncated; in a model formset, all initial forms would be displayed\nregardless of max_num. Now regular formsets are the same as model formsets; all\ninitial forms are displayed, even if more than max_num. (But if validate_max is\nTrue, submitting these forms will result in a \"too many forms\" validation\nerror!) This combination of behaviors was chosen to keep the max_num validation\nsimple and consistent, and avoid silent data loss due to truncation of initial\ndata.\n\nThanks to Preston for discussion of the design choices.",
    "sha": "f9ab543720532400e8b0d490cdbe67ea09ae9c17",
    "files": [
        {
            "sha": "aa232ab1d5020de77263d78f8b6b39e49afadd47",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -435,7 +435,7 @@ def generic_inlineformset_factory(model, form=ModelForm,\n                                   fields=None, exclude=None,\n                                   extra=3, can_order=False, can_delete=True,\n                                   max_num=None,\n-                                  formfield_callback=None):\n+                                  formfield_callback=None, validate_max=False):\n     \"\"\"\n     Returns a ``GenericInlineFormSet`` for the given kwargs.\n \n@@ -457,7 +457,8 @@ def generic_inlineformset_factory(model, form=ModelForm,\n                                    formfield_callback=formfield_callback,\n                                    formset=formset,\n                                    extra=extra, can_delete=can_delete, can_order=can_order,\n-                                   fields=fields, exclude=exclude, max_num=max_num)\n+                                   fields=fields, exclude=exclude, max_num=max_num,\n+                                   validate_max=validate_max)\n     FormSet.ct_field = ct_field\n     FormSet.ct_fk_field = fk_field\n     return FormSet"
        },
        {
            "sha": "98ae3205febdbca8e4c388e95041734318ef54c9",
            "filename": "django/forms/formsets.py",
            "status": "modified",
            "additions": 20,
            "deletions": 10,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/django%2Fforms%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/django%2Fforms%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fformsets.py?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -33,6 +33,9 @@ class ManagementForm(Form):\n     def __init__(self, *args, **kwargs):\n         self.base_fields[TOTAL_FORM_COUNT] = IntegerField(widget=HiddenInput)\n         self.base_fields[INITIAL_FORM_COUNT] = IntegerField(widget=HiddenInput)\n+        # MAX_NUM_FORM_COUNT is output with the rest of the management form,\n+        # but only for the convenience of client-side code. The POST\n+        # value of MAX_NUM_FORM_COUNT returned from the client is not checked.\n         self.base_fields[MAX_NUM_FORM_COUNT] = IntegerField(required=False, widget=HiddenInput)\n         super(ManagementForm, self).__init__(*args, **kwargs)\n \n@@ -94,7 +97,11 @@ def management_form(self):\n     def total_form_count(self):\n         \"\"\"Returns the total number of forms in this FormSet.\"\"\"\n         if self.is_bound:\n-            return self.management_form.cleaned_data[TOTAL_FORM_COUNT]\n+            # return absolute_max if it is lower than the actual total form\n+            # count in the data; this is DoS protection to prevent clients\n+            # from forcing the server to instantiate arbitrary numbers of\n+            # forms\n+            return min(self.management_form.cleaned_data[TOTAL_FORM_COUNT], self.absolute_max)\n         else:\n             initial_forms = self.initial_form_count()\n             total_forms = initial_forms + self.extra\n@@ -113,14 +120,13 @@ def initial_form_count(self):\n         else:\n             # Use the length of the inital data if it's there, 0 otherwise.\n             initial_forms = self.initial and len(self.initial) or 0\n-            if initial_forms > self.max_num >= 0:\n-                initial_forms = self.max_num\n         return initial_forms\n \n     def _construct_forms(self):\n         # instantiate all the forms and put them in self.forms\n         self.forms = []\n-        for i in xrange(min(self.total_form_count(), self.absolute_max)):\n+        # DoS protection is included in total_form_count()\n+        for i in xrange(self.total_form_count()):\n             self.forms.append(self._construct_form(i))\n \n     def _construct_form(self, i, **kwargs):\n@@ -168,7 +174,6 @@ def empty_form(self):\n         self.add_fields(form, None)\n         return form\n \n-    # Maybe this should just go away?\n     @property\n     def cleaned_data(self):\n         \"\"\"\n@@ -294,8 +299,11 @@ def full_clean(self):\n         for i in range(0, self.total_form_count()):\n             form = self.forms[i]\n             self._errors.append(form.errors)\n-        # Give self.clean() a chance to do cross-form validation.\n         try:\n+            if (self.validate_max and self.total_form_count() > self.max_num) or \\\n+                self.management_form.cleaned_data[TOTAL_FORM_COUNT] > self.absolute_max:\n+                raise ValidationError(_(\"Please submit %s or fewer forms.\" % self.max_num))\n+            # Give self.clean() a chance to do cross-form validation.\n             self.clean()\n         except ValidationError as e:\n             self._non_form_errors = self.error_class(e.messages)\n@@ -367,16 +375,18 @@ def as_ul(self):\n         return mark_safe('\\n'.join([six.text_type(self.management_form), forms]))\n \n def formset_factory(form, formset=BaseFormSet, extra=1, can_order=False,\n-                    can_delete=False, max_num=None):\n+                    can_delete=False, max_num=None, validate_max=False):\n     \"\"\"Return a FormSet for the given form class.\"\"\"\n     if max_num is None:\n         max_num = DEFAULT_MAX_NUM\n     # hard limit on forms instantiated, to prevent memory-exhaustion attacks\n-    # limit defaults to DEFAULT_MAX_NUM, but developer can increase it via max_num\n-    absolute_max = max(DEFAULT_MAX_NUM, max_num)\n+    # limit is simply max_num + DEFAULT_MAX_NUM (which is 2*DEFAULT_MAX_NUM\n+    # if max_num is None in the first place)\n+    absolute_max = max_num + DEFAULT_MAX_NUM\n     attrs = {'form': form, 'extra': extra,\n              'can_order': can_order, 'can_delete': can_delete,\n-             'max_num': max_num, 'absolute_max': absolute_max}\n+             'max_num': max_num, 'absolute_max': absolute_max,\n+             'validate_max' : validate_max}\n     return type(form.__name__ + str('FormSet'), (formset,), attrs)\n \n def all_valid(formsets):"
        },
        {
            "sha": "0672bafc478c4db7f50335e39f1488891538a7ae",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -682,15 +682,16 @@ def pk_is_not_editable(pk):\n def modelformset_factory(model, form=ModelForm, formfield_callback=None,\n                          formset=BaseModelFormSet, extra=1, can_delete=False,\n                          can_order=False, max_num=None, fields=None,\n-                         exclude=None, widgets=None):\n+                         exclude=None, widgets=None, validate_max=False):\n     \"\"\"\n     Returns a FormSet class for the given Django model class.\n     \"\"\"\n     form = modelform_factory(model, form=form, fields=fields, exclude=exclude,\n                              formfield_callback=formfield_callback,\n                              widgets=widgets)\n     FormSet = formset_factory(form, formset, extra=extra, max_num=max_num,\n-                              can_order=can_order, can_delete=can_delete)\n+                              can_order=can_order, can_delete=can_delete,\n+                              validate_max=validate_max)\n     FormSet.model = model\n     return FormSet\n \n@@ -826,7 +827,7 @@ def inlineformset_factory(parent_model, model, form=ModelForm,\n                           formset=BaseInlineFormSet, fk_name=None,\n                           fields=None, exclude=None,\n                           extra=3, can_order=False, can_delete=True, max_num=None,\n-                          formfield_callback=None, widgets=None):\n+                          formfield_callback=None, widgets=None, validate_max=False):\n     \"\"\"\n     Returns an ``InlineFormSet`` for the given kwargs.\n \n@@ -848,6 +849,7 @@ def inlineformset_factory(parent_model, model, form=ModelForm,\n         'exclude': exclude,\n         'max_num': max_num,\n         'widgets': widgets,\n+        'validate_max': validate_max,\n     }\n     FormSet = modelformset_factory(model, **kwargs)\n     FormSet.fk = fk"
        },
        {
            "sha": "388172c43ebcbeaf467a531a5f928e445d3248ee",
            "filename": "docs/ref/contrib/contenttypes.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fcontrib%2Fcontenttypes.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fcontrib%2Fcontenttypes.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fcontenttypes.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -492,7 +492,7 @@ information.\n     Subclasses of :class:`GenericInlineModelAdmin` with stacked and tabular\n     layouts, respectively.\n \n-.. function:: generic_inlineformset_factory(model, form=ModelForm, formset=BaseGenericInlineFormSet, ct_field=\"content_type\", fk_field=\"object_id\", fields=None, exclude=None, extra=3, can_order=False, can_delete=True, max_num=None, formfield_callback=None)\n+.. function:: generic_inlineformset_factory(model, form=ModelForm, formset=BaseGenericInlineFormSet, ct_field=\"content_type\", fk_field=\"object_id\", fields=None, exclude=None, extra=3, can_order=False, can_delete=True, max_num=None, formfield_callback=None, validate_max=False)\n \n     Returns a ``GenericInlineFormSet`` using\n     :func:`~django.forms.models.modelformset_factory`."
        },
        {
            "sha": "0ab2590fceab2b37a09adad327902a95e28e9167",
            "filename": "docs/ref/forms/formsets.txt",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fforms%2Fformsets.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fforms%2Fformsets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fforms%2Fformsets.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -0,0 +1,16 @@\n+====================\n+Formset Functions\n+====================\n+\n+.. module:: django.forms.formsets\n+   :synopsis: Django's functions for building formsets.\n+\n+.. function:: formset_factory(form, formset=BaseFormSet, extra=1, can_order=False, can_delete=False, max_num=None, validate_max=False)\n+\n+    Returns a ``FormSet`` class for the given ``form`` class.\n+\n+    See :ref:`formsets` for example usage.\n+\n+    .. versionchanged:: 1.6\n+    \n+    The ``validate_max`` parameter was added."
        },
        {
            "sha": "e6edc88ca17b8821701437af2e72bbff3093ea95",
            "filename": "docs/ref/forms/index.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fforms%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fforms%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fforms%2Findex.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -10,5 +10,6 @@ Detailed form API reference. For introductory material, see :doc:`/topics/forms/\n    api\n    fields\n    models\n+   formsets\n    widgets\n    validation"
        },
        {
            "sha": "dd0a422fd089300a57c3c83a043fafab32587c56",
            "filename": "docs/ref/forms/models.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fforms%2Fmodels.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Fref%2Fforms%2Fmodels.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fforms%2Fmodels.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -25,25 +25,26 @@ Model Form Functions\n \n     See :ref:`modelforms-factory` for example usage.\n \n-.. function:: modelformset_factory(model, form=ModelForm, formfield_callback=None, formset=BaseModelFormSet, extra=1, can_delete=False, can_order=False, max_num=None, fields=None, exclude=None, widgets=None)\n+.. function:: modelformset_factory(model, form=ModelForm, formfield_callback=None, formset=BaseModelFormSet, extra=1, can_delete=False, can_order=False, max_num=None, fields=None, exclude=None, widgets=None, validate_max=False)\n \n     Returns a ``FormSet`` class for the given ``model`` class.\n \n     Arguments ``model``, ``form``, ``fields``, ``exclude``,\n     ``formfield_callback`` and ``widgets`` are all passed through to\n     :func:`~django.forms.models.modelform_factory`.\n \n-    Arguments ``formset``, ``extra``, ``max_num``, ``can_order``, and\n-    ``can_delete`` are passed through to ``formset_factory``. See\n-    :ref:`formsets` for details.\n+    Arguments ``formset``, ``extra``, ``max_num``, ``can_order``,\n+    ``can_delete`` and ``validate_max`` are passed through to\n+    :func:`~django.forms.formsets.formset_factory`. See :ref:`formsets` for\n+    details.\n \n     See :ref:`model-formsets` for example usage.\n \n     .. versionchanged:: 1.6\n \n-    The widgets parameter was added.\n+    The ``widgets`` and the ``validate_max`` parameters were added.\n \n-.. function:: inlineformset_factory(parent_model, model, form=ModelForm, formset=BaseInlineFormSet, fk_name=None, fields=None, exclude=None, extra=3, can_order=False, can_delete=True, max_num=None, formfield_callback=None, widgets=None)\n+.. function:: inlineformset_factory(parent_model, model, form=ModelForm, formset=BaseInlineFormSet, fk_name=None, fields=None, exclude=None, extra=3, can_order=False, can_delete=True, max_num=None, formfield_callback=None, widgets=None, validate_max=False)\n \n     Returns an ``InlineFormSet`` using :func:`modelformset_factory` with\n     defaults of ``formset=BaseInlineFormSet``, ``can_delete=True``, and\n@@ -56,4 +57,4 @@ Model Form Functions\n \n     .. versionchanged:: 1.6\n \n-    The widgets parameter was added.\n+    The ``widgets`` and the ``validate_max`` parameters were added."
        },
        {
            "sha": "16039851c28b35e7da10715d020e39aaee7bc79e",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -167,6 +167,14 @@ Minor features\n   field mixins to implement ``__init__()`` methods that will reliably be\n   called.\n \n+* The ``validate_max`` parameter was added to ``BaseFormSet`` and\n+  :func:`~django.forms.formsets.formset_factory`, and ``ModelForm`` and inline\n+  versions of the same.  The behavior of validation for formsets with\n+  ``max_num`` was clarified.  The previously undocumented behavior that\n+  hardened formsets against memory exhaustion attacks was documented,\n+  and the undocumented limit of the higher of 1000 or ``max_num`` forms\n+  was changed so it is always 1000 more than ``max_num``.\n+\n Backwards incompatible changes in 1.6\n =====================================\n "
        },
        {
            "sha": "f0a7668e0d29dd1c8a66728fae2627b8494a23e4",
            "filename": "docs/topics/forms/formsets.txt",
            "status": "modified",
            "additions": 69,
            "deletions": 9,
            "changes": 78,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Ftopics%2Fforms%2Fformsets.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Ftopics%2Fforms%2Fformsets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fforms%2Fformsets.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -32,8 +32,8 @@ would with a regular form::\n \n As you can see it only displayed one empty form. The number of empty forms\n that is displayed is controlled by the ``extra`` parameter. By default,\n-``formset_factory`` defines one extra form; the following example will\n-display two blank forms::\n+:func:`~django.forms.formsets.formset_factory` defines one extra form; the\n+following example will display two blank forms::\n \n     >>> ArticleFormSet = formset_factory(ArticleForm, extra=2)\n \n@@ -84,8 +84,9 @@ list of dictionaries as the initial data.\n Limiting the maximum number of forms\n ------------------------------------\n \n-The ``max_num`` parameter to ``formset_factory`` gives you the ability to\n-limit the maximum number of empty forms the formset will display::\n+The ``max_num`` parameter to :func:`~django.forms.formsets.formset_factory`\n+gives you the ability to limit the maximum number of empty forms the formset\n+will display::\n \n     >>> ArticleFormSet = formset_factory(ArticleForm, extra=2, max_num=1)\n     >>> formset = ArticleFormSet()\n@@ -101,6 +102,20 @@ so long as the total number of forms does not exceed ``max_num``.\n A ``max_num`` value of ``None`` (the default) puts a high limit on the number\n of forms displayed (1000). In practice this is equivalent to no limit.\n \n+If the number of forms in the initial data exceeds ``max_num``, all initial\n+data forms will be displayed regardless.  (No extra forms will be displayed.)\n+\n+By default, ``max_num`` only affects how many forms are displayed and does not\n+affect validation.  If ``validate_max=True`` is passed to the\n+:func:`~django.forms.formsets.formset_factory`, then ``max_num`` will affect\n+validation.  See :ref:`validate_max`.\n+\n+.. versionchanged:: 1.6\n+   The ``validate_max`` parameter was added to\n+   :func:`~django.forms.formsets.formset_factory`.  Also, the behavior of\n+   ``FormSet`` was brought in line with that of ``ModelFormSet`` so that it\n+   displays initial data regardless of ``max_num``.\n+\n Formset validation\n ------------------\n \n@@ -248,14 +263,59 @@ The formset ``clean`` method is called after all the ``Form.clean`` methods\n have been called. The errors will be found using the ``non_form_errors()``\n method on the formset.\n \n+.. _validate_max:\n+\n+Validating the number of forms in a formset\n+-------------------------------------------\n+\n+If ``validate_max=True`` is passed to\n+:func:`~django.forms.formsets.formset_factory`, validation will also check\n+that the number of forms in the data set is less than or equal to ``max_num``.\n+\n+    >>> ArticleFormSet = formset_factory(ArticleForm, max_num=1, validate_max=True)\n+    >>> data = {\n+    ...     'form-TOTAL_FORMS': u'2',\n+    ...     'form-INITIAL_FORMS': u'0',\n+    ...     'form-MAX_NUM_FORMS': u'',\n+    ...     'form-0-title': u'Test',\n+    ...     'form-0-pub_date': u'1904-06-16',\n+    ...     'form-1-title': u'Test 2',\n+    ...     'form-1-pub_date': u'1912-06-23',\n+    ... }\n+    >>> formset = ArticleFormSet(data)\n+    >>> formset.is_valid()\n+    False\n+    >>> formset.errors\n+    [{}, {}]\n+    >>> formset.non_form_errors()\n+    [u'Please submit 1 or fewer forms.']\n+\n+``validate_max=True`` validates against ``max_num`` strictly even if\n+``max_num`` was exceeded because the amount of initial data supplied was\n+excessive.\n+\n+Applications which need more customizable validation of the number of forms\n+should use custom formset validation.\n+\n+.. note::\n+\n+    Regardless of ``validate_max``, if the number of forms in a data set\n+    exceeds ``max_num`` by more than 1000, then the form will fail to validate\n+    as if ``validate_max`` were set, and additionally only the first 1000\n+    forms above ``max_num`` will be validated.  The remainder will be\n+    truncated entirely.  This is to protect against memory exhaustion attacks\n+    using forged POST requests.\n+\n+.. versionchanged:: 1.6\n+   The ``validate_max`` parameter was added to\n+   :func:`~django.forms.formsets.formset_factory`.\n+\n Dealing with ordering and deletion of forms\n -------------------------------------------\n \n-Common use cases with a formset is dealing with ordering and deletion of the\n-form instances. This has been dealt with for you. The ``formset_factory``\n-provides two optional parameters ``can_order`` and ``can_delete`` that will do\n-the extra work of adding the extra fields and providing simpler ways of\n-getting to that data.\n+The :func:`~django.forms.formsets.formset_factory` provides two optional\n+parameters ``can_order`` and ``can_delete`` to help with ordering of forms in\n+formsets and deletion of forms from a formset.\n \n ``can_order``\n ~~~~~~~~~~~~~"
        },
        {
            "sha": "eaf2bbbaf2afd68d4266f485ce187224731c6e5f",
            "filename": "docs/topics/forms/modelforms.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Ftopics%2Fforms%2Fmodelforms.txt",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/docs%2Ftopics%2Fforms%2Fmodelforms.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fforms%2Fmodelforms.txt?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -597,9 +597,10 @@ with the ``Author`` model. It works just like a regular formset::\n \n .. note::\n \n-    :func:`~django.forms.models.modelformset_factory` uses ``formset_factory``\n-    to generate formsets. This means that a model formset is just an extension\n-    of a basic formset that knows how to interact with a particular model.\n+    :func:`~django.forms.models.modelformset_factory` uses\n+    :func:`~django.forms.formsets.formset_factory` to generate formsets. This\n+    means that a model formset is just an extension of a basic formset that\n+    knows how to interact with a particular model.\n \n Changing the queryset\n ---------------------"
        },
        {
            "sha": "4ac3c5ecf15f5474fcbcc50997dda00259e71ced",
            "filename": "tests/forms_tests/tests/formsets.py",
            "status": "modified",
            "additions": 48,
            "deletions": 12,
            "changes": 60,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/tests%2Fforms_tests%2Ftests%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/tests%2Fforms_tests%2Ftests%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fforms_tests%2Ftests%2Fformsets.py?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -256,6 +256,27 @@ def test_single_form_completed(self):\n         self.assertTrue(formset.is_valid())\n         self.assertEqual([form.cleaned_data for form in formset.forms], [{'votes': 100, 'choice': 'Calexico'}, {}, {}])\n \n+    def test_formset_validate_max_flag(self):\n+        # If validate_max is set and max_num is less than TOTAL_FORMS in the\n+        # data, then throw an exception. MAX_NUM_FORMS in the data is\n+        # irrelevant here (it's output as a hint for the client but its\n+        # value in the returned data is not checked)\n+\n+        data = {\n+            'choices-TOTAL_FORMS': '2', # the number of forms rendered\n+            'choices-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'choices-MAX_NUM_FORMS': '2', # max number of forms - should be ignored\n+            'choices-0-choice': 'Zero',\n+            'choices-0-votes': '0',\n+            'choices-1-choice': 'One',\n+            'choices-1-votes': '1',\n+        }\n+\n+        ChoiceFormSet = formset_factory(Choice, extra=1, max_num=1, validate_max=True)\n+        formset = ChoiceFormSet(data, auto_id=False, prefix='choices')\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset.non_form_errors(), ['Please submit 1 or fewer forms.'])\n+\n     def test_second_form_partially_filled_2(self):\n         # And once again, if we try to partially complete a form, validation will fail.\n \n@@ -720,8 +741,20 @@ def test_max_num_with_initial_data(self):\n <tr><th><label for=\"id_form-1-name\">Name:</label></th><td><input type=\"text\" name=\"form-1-name\" id=\"id_form-1-name\" /></td></tr>\"\"\")\n \n     def test_max_num_zero(self):\n-        # If max_num is 0 then no form is rendered at all, even if extra and initial\n-        # are specified.\n+        # If max_num is 0 then no form is rendered at all, regardless of extra,\n+        # unless initial data is present. (This changed in the patch for bug\n+        # 20084 -- previously max_num=0 trumped initial data)\n+\n+        LimitedFavoriteDrinkFormSet = formset_factory(FavoriteDrinkForm, extra=1, max_num=0)\n+        formset = LimitedFavoriteDrinkFormSet()\n+        form_output = []\n+\n+        for form in formset.forms:\n+            form_output.append(str(form))\n+\n+        self.assertEqual('\\n'.join(form_output), \"\")\n+\n+        # test that initial trumps max_num\n \n         initial = [\n             {'name': 'Fernet and Coke'},\n@@ -733,12 +766,13 @@ def test_max_num_zero(self):\n \n         for form in formset.forms:\n             form_output.append(str(form))\n-\n-        self.assertEqual('\\n'.join(form_output), \"\")\n+        self.assertEqual('\\n'.join(form_output), \"\"\"<tr><th><label for=\"id_form-0-name\">Name:</label></th><td><input id=\"id_form-0-name\" name=\"form-0-name\" type=\"text\" value=\"Fernet and Coke\" /></td></tr>\n+<tr><th><label for=\"id_form-1-name\">Name:</label></th><td><input id=\"id_form-1-name\" name=\"form-1-name\" type=\"text\" value=\"Bloody Mary\" /></td></tr>\"\"\")\n \n     def test_more_initial_than_max_num(self):\n-        # More initial forms than max_num will result in only the first max_num of\n-        # them to be displayed with no extra forms.\n+        # More initial forms than max_num now results in all initial forms\n+        # being displayed (but no extra forms).  This behavior was changed\n+        # from max_num taking precedence in the patch for #20084\n \n         initial = [\n             {'name': 'Gin Tonic'},\n@@ -751,9 +785,9 @@ def test_more_initial_than_max_num(self):\n \n         for form in formset.forms:\n             form_output.append(str(form))\n-\n-        self.assertHTMLEqual('\\n'.join(form_output), \"\"\"<tr><th><label for=\"id_form-0-name\">Name:</label></th><td><input type=\"text\" name=\"form-0-name\" value=\"Gin Tonic\" id=\"id_form-0-name\" /></td></tr>\n-<tr><th><label for=\"id_form-1-name\">Name:</label></th><td><input type=\"text\" name=\"form-1-name\" value=\"Bloody Mary\" id=\"id_form-1-name\" /></td></tr>\"\"\")\n+        self.assertHTMLEqual('\\n'.join(form_output), \"\"\"<tr><th><label for=\"id_form-0-name\">Name:</label></th><td><input id=\"id_form-0-name\" name=\"form-0-name\" type=\"text\" value=\"Gin Tonic\" /></td></tr>\n+<tr><th><label for=\"id_form-1-name\">Name:</label></th><td><input id=\"id_form-1-name\" name=\"form-1-name\" type=\"text\" value=\"Bloody Mary\" /></td></tr>\n+<tr><th><label for=\"id_form-2-name\">Name:</label></th><td><input id=\"id_form-2-name\" name=\"form-2-name\" type=\"text\" value=\"Jack and Coke\" /></td></tr>\"\"\")\n \n         # One form from initial and extra=3 with max_num=2 should result in the one\n         # initial form and one extra.\n@@ -883,8 +917,8 @@ def test_hard_limit_on_instantiated_forms(self):\n         # reduce the default limit of 1000 temporarily for testing\n         _old_DEFAULT_MAX_NUM = formsets.DEFAULT_MAX_NUM\n         try:\n-            formsets.DEFAULT_MAX_NUM = 3\n-            ChoiceFormSet = formset_factory(Choice)\n+            formsets.DEFAULT_MAX_NUM = 2\n+            ChoiceFormSet = formset_factory(Choice, max_num=1)\n             # someone fiddles with the mgmt form data...\n             formset = ChoiceFormSet(\n                 {\n@@ -904,6 +938,8 @@ def test_hard_limit_on_instantiated_forms(self):\n                 )\n             # But we still only instantiate 3 forms\n             self.assertEqual(len(formset.forms), 3)\n+            # and the formset isn't valid\n+            self.assertFalse(formset.is_valid())\n         finally:\n             formsets.DEFAULT_MAX_NUM = _old_DEFAULT_MAX_NUM\n \n@@ -931,7 +967,7 @@ def test_increase_hard_limit(self):\n                     },\n                 prefix='choices',\n                 )\n-            # This time four forms are instantiated\n+            # Four forms are instantiated and no exception is raised\n             self.assertEqual(len(formset.forms), 4)\n         finally:\n             formsets.DEFAULT_MAX_NUM = _old_DEFAULT_MAX_NUM"
        },
        {
            "sha": "8d0c017a617a242f5c23cdc0c918b4ddb5850783",
            "filename": "tests/model_formsets/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/f9ab543720532400e8b0d490cdbe67ea09ae9c17/tests%2Fmodel_formsets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f9ab543720532400e8b0d490cdbe67ea09ae9c17/tests%2Fmodel_formsets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodel_formsets%2Ftests.py?ref=f9ab543720532400e8b0d490cdbe67ea09ae9c17",
            "patch": "@@ -899,6 +899,33 @@ def test_unique_validation(self):\n         self.assertFalse(formset.is_valid())\n         self.assertEqual(formset.errors, [{'slug': ['Product with this Slug already exists.']}])\n \n+    def test_modelformset_validate_max_flag(self):\n+        # If validate_max is set and max_num is less than TOTAL_FORMS in the\n+        # data, then throw an exception. MAX_NUM_FORMS in the data is\n+        # irrelevant here (it's output as a hint for the client but its\n+        # value in the returned data is not checked)\n+\n+        data = {\n+            'form-TOTAL_FORMS': '2',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '2', # should be ignored\n+            'form-0-price': '12.00',\n+            'form-0-quantity': '1',\n+            'form-1-price': '24.00',\n+            'form-1-quantity': '2',\n+        }\n+\n+        FormSet = modelformset_factory(Price, extra=1, max_num=1, validate_max=True)\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset.non_form_errors(), ['Please submit 1 or fewer forms.'])\n+\n+        # Now test the same thing without the validate_max flag to ensure\n+        # default behavior is unchanged\n+        FormSet = modelformset_factory(Price, extra=1, max_num=1)\n+        formset = FormSet(data)\n+        self.assertTrue(formset.is_valid())\n+\n     def test_unique_together_validation(self):\n         FormSet = modelformset_factory(Price, extra=1)\n         data = {"
        }
    ],
    "stats": {
        "total": 257,
        "additions": 210,
        "deletions": 47
    }
}