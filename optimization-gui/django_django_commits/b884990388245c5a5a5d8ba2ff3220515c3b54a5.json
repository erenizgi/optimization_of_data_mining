{
    "author": "jezdez",
    "message": "Made cache table test case multidb capable. Refs #16411. Thanks, Russ.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16513 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b884990388245c5a5a5d8ba2ff3220515c3b54a5",
    "files": [
        {
            "sha": "4303ad73e9649af6c845671f261eccd73a5ac2a8",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 13,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/b884990388245c5a5a5d8ba2ff3220515c3b54a5/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b884990388245c5a5a5d8ba2ff3220515c3b54a5/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=b884990388245c5a5a5d8ba2ff3220515c3b54a5",
            "patch": "@@ -14,10 +14,10 @@\n from django.core import management\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n from django.core.cache.backends.base import CacheKeyWarning, InvalidCacheBackendError\n-from django.db import connections, router\n+from django.db import router\n from django.http import HttpResponse, HttpRequest, QueryDict\n from django.middleware.cache import FetchFromCacheMiddleware, UpdateCacheMiddleware, CacheMiddleware\n-from django.test import RequestFactory\n+from django.test import RequestFactory, TestCase\n from django.test.utils import get_warnings_state, restore_warnings_state, override_settings\n from django.utils import translation\n from django.utils import unittest\n@@ -771,28 +771,31 @@ def db_for_write(self, model, **hints):\n             return 'other'\n \n     def allow_syncdb(self, db, model):\n+        print self, db, model\n         if model._meta.app_label == 'django_cache':\n             return db == 'other'\n \n-class CreateCacheTableForDBCacheTests(unittest.TestCase):\n+\n+class CreateCacheTableForDBCacheTests(TestCase):\n+    multi_db = True\n \n     def test_createcachetable_observes_database_router(self):\n-        with override_settings(DEBUG=True):\n-            old_routers = router.routers\n-            try:\n-                router.routers = [DBCacheRouter()]\n-                # cache table should not be created on 'default'\n+        old_routers = router.routers\n+        try:\n+            router.routers = [DBCacheRouter()]\n+            # cache table should not be created on 'default'\n+            with self.assertNumQueries(0):\n                 management.call_command('createcachetable', 'cache_table',\n                                         database='default',\n                                         verbosity=0, interactive=False)\n-                self.assertEqual(len(connections['default'].queries), 0)\n-                # cache table should be created on 'other'\n+            # cache table should be created on 'other'\n+            with self.assertNumQueries(1):\n                 management.call_command('createcachetable', 'cache_table',\n                                         database='other',\n                                         verbosity=0, interactive=False)\n-                self.assertNotEqual(len(connections['other'].queries), 0)\n-            finally:\n-                router.routers = old_routers\n+        finally:\n+            router.routers = old_routers\n+\n \n class LocMemCacheTests(unittest.TestCase, BaseCacheTests):\n     backend_name = 'django.core.cache.backends.locmem.LocMemCache'"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 16,
        "deletions": 13
    }
}