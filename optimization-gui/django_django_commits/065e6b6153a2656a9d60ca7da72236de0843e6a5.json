{
    "author": "carljm",
    "message": "Fixed #15819 - Fixed 1.3 regression from r15526 causing duplicate search results in admin with search_fields traversing to non-M2M related models. Thanks to Adam Kochanowski for the report and Ryan Kaskel for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16093 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "065e6b6153a2656a9d60ca7da72236de0843e6a5",
    "files": [
        {
            "sha": "0cfc43dd03b95d97e217d5bc65ef3983b073b0c9",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/065e6b6153a2656a9d60ca7da72236de0843e6a5/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/065e6b6153a2656a9d60ca7da72236de0843e6a5/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=065e6b6153a2656a9d60ca7da72236de0843e6a5",
            "patch": "@@ -26,6 +26,15 @@\n # Text to display within change-list table cells if the value is blank.\n EMPTY_CHANGELIST_VALUE = ugettext_lazy('(None)')\n \n+def field_needs_distinct(field):\n+    if ((hasattr(field, 'rel') and\n+         isinstance(field.rel, models.ManyToManyRel)) or\n+        (isinstance(field, models.related.RelatedObject) and\n+         not field.field.unique)):\n+         return True\n+    return False\n+\n+\n class ChangeList(object):\n     def __init__(self, request, model, list_display, list_display_links, list_filter, date_hierarchy, search_fields, list_select_related, list_per_page, list_editable, model_admin):\n         self.model = model\n@@ -189,8 +198,7 @@ def get_query_set(self):\n                     f = self.lookup_opts.get_field_by_name(field_name)[0]\n                 except models.FieldDoesNotExist:\n                     raise IncorrectLookupParameters\n-                if hasattr(f, 'rel') and isinstance(f.rel, models.ManyToManyRel):\n-                    use_distinct = True\n+                use_distinct = field_needs_distinct(f)\n \n             # if key ends with __in, split parameter into separate values\n             if key.endswith('__in'):\n@@ -264,7 +272,7 @@ def construct_search(field_name):\n                 for search_spec in orm_lookups:\n                     field_name = search_spec.split('__', 1)[0]\n                     f = self.lookup_opts.get_field_by_name(field_name)[0]\n-                    if hasattr(f, 'rel') and isinstance(f.rel, models.ManyToManyRel):\n+                    if field_needs_distinct(f):\n                         use_distinct = True\n                         break\n "
        },
        {
            "sha": "5186508dd9c7a5f508625f3999f3143608865bce",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 69,
            "deletions": 15,
            "changes": 84,
            "blob_url": "https://github.com/django/django/blob/065e6b6153a2656a9d60ca7da72236de0843e6a5/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/065e6b6153a2656a9d60ca7da72236de0843e6a5/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=065e6b6153a2656a9d60ca7da72236de0843e6a5",
            "patch": "@@ -1,6 +1,6 @@\n from django.contrib import admin\n from django.contrib.admin.options import IncorrectLookupParameters\n-from django.contrib.admin.views.main import ChangeList\n+from django.contrib.admin.views.main import ChangeList, SEARCH_VAR\n from django.core.paginator import Paginator\n from django.template import Context, Template\n from django.test import TransactionTestCase\n@@ -148,12 +148,14 @@ def test_distinct_for_m2m_in_list_filter(self):\n         band.genres.add(blues)\n \n         m = BandAdmin(Band, admin.site)\n-        cl = ChangeList(MockFilteredRequestA(blues.pk), Band, m.list_display,\n+        request = MockFilterRequest('genres', blues.pk)\n+\n+        cl = ChangeList(request, Band, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n                 m.list_editable, m)\n \n-        cl.get_results(MockFilteredRequestA(blues.pk))\n+        cl.get_results(request)\n \n         # There's only one Group instance\n         self.assertEqual(cl.result_count, 1)\n@@ -169,12 +171,14 @@ def test_distinct_for_through_m2m_in_list_filter(self):\n         Membership.objects.create(group=band, music=lead, role='bass player')\n \n         m = GroupAdmin(Group, admin.site)\n-        cl = ChangeList(MockFilteredRequestB(lead.pk), Group, m.list_display,\n+        request = MockFilterRequest('members', lead.pk)\n+\n+        cl = ChangeList(request, Group, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n                 m.list_editable, m)\n \n-        cl.get_results(MockFilteredRequestB(lead.pk))\n+        cl.get_results(request)\n \n         # There's only one Group instance\n         self.assertEqual(cl.result_count, 1)\n@@ -191,12 +195,14 @@ def test_distinct_for_inherited_m2m_in_list_filter(self):\n         Membership.objects.create(group=four, music=lead, role='guitar player')\n \n         m = QuartetAdmin(Quartet, admin.site)\n-        cl = ChangeList(MockFilteredRequestB(lead.pk), Quartet, m.list_display,\n+        request = MockFilterRequest('members', lead.pk)\n+\n+        cl = ChangeList(request, Quartet, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n                 m.list_editable, m)\n \n-        cl.get_results(MockFilteredRequestB(lead.pk))\n+        cl.get_results(request)\n \n         # There's only one Quartet instance\n         self.assertEqual(cl.result_count, 1)\n@@ -213,16 +219,59 @@ def test_distinct_for_m2m_to_inherited_in_list_filter(self):\n         Invitation.objects.create(band=three, player=lead, instrument='bass')\n \n         m = ChordsBandAdmin(ChordsBand, admin.site)\n-        cl = ChangeList(MockFilteredRequestB(lead.pk), ChordsBand, m.list_display,\n+        request = MockFilterRequest('members', lead.pk)\n+\n+        cl = ChangeList(request, ChordsBand, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n                 m.list_editable, m)\n \n-        cl.get_results(MockFilteredRequestB(lead.pk))\n+        cl.get_results(request)\n \n         # There's only one ChordsBand instance\n         self.assertEqual(cl.result_count, 1)\n \n+    def test_distinct_for_non_unique_related_object_in_list_filter(self):\n+        \"\"\"\n+        Regressions tests for #15819: If a field listed in list_filters\n+        is a non-unique related object, distinct() must be called.\n+        \"\"\"\n+        parent = Parent.objects.create(name='Mary')\n+        # Two children with the same name\n+        Child.objects.create(parent=parent, name='Daniel')\n+        Child.objects.create(parent=parent, name='Daniel')\n+\n+        m = ParentAdmin(Parent, admin.site)\n+        request = MockFilterRequest('child__name', 'Daniel')\n+\n+        cl = ChangeList(request, Parent, m.list_display, m.list_display_links,\n+                        m.list_filter, m.date_hierarchy, m.search_fields,\n+                        m.list_select_related, m.list_per_page,\n+                        m.list_editable, m)\n+\n+        # Make sure distinct() was called\n+        self.assertEqual(cl.query_set.count(), 1)\n+\n+    def test_distinct_for_non_unique_related_object_in_search_fields(self):\n+        \"\"\"\n+        Regressions tests for #15819: If a field listed in search_fields\n+        is a non-unique related object, distinct() must be called.\n+        \"\"\"\n+        parent = Parent.objects.create(name='Mary')\n+        Child.objects.create(parent=parent, name='Danielle')\n+        Child.objects.create(parent=parent, name='Daniel')\n+\n+        m = ParentAdmin(Parent, admin.site)\n+        request = MockSearchRequest('daniel')\n+\n+        cl = ChangeList(request, Parent, m.list_display, m.list_display_links,\n+                        m.list_filter, m.date_hierarchy, m.search_fields,\n+                        m.list_select_related, m.list_per_page,\n+                        m.list_editable, m)\n+\n+        # Make sure distinct() was called\n+        self.assertEqual(cl.query_set.count(), 1)\n+\n     def test_pagination(self):\n         \"\"\"\n         Regression tests for #12893: Pagination in admins changelist doesn't\n@@ -254,6 +303,11 @@ def test_pagination(self):\n         self.assertEqual(cl.paginator.page_range, [1, 2, 3])\n \n \n+class ParentAdmin(admin.ModelAdmin):\n+    list_filter = ['child__name']\n+    search_fields = ['child__name']\n+\n+\n class ChildAdmin(admin.ModelAdmin):\n     list_display = ['name', 'parent']\n     list_per_page = 10\n@@ -288,10 +342,10 @@ class QuartetAdmin(admin.ModelAdmin):\n class ChordsBandAdmin(admin.ModelAdmin):\n     list_filter = ['members']\n \n-class MockFilteredRequestA(object):\n-    def __init__(self, pk):\n-        self.GET = { 'genres' : pk }\n+class MockFilterRequest(object):\n+    def __init__(self, filter, q):\n+        self.GET = {filter: q}\n \n-class MockFilteredRequestB(object):\n-    def __init__(self, pk):\n-        self.GET = { 'members': pk }\n+class MockSearchRequest(object):\n+    def __init__(self, q):\n+        self.GET = {SEARCH_VAR: q}"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 80,
        "deletions": 18
    }
}