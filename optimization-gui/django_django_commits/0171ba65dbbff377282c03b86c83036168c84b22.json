{
    "author": "claudep",
    "message": "Fixed #17574 -- Implemented missing get_key_columns in PostgreSQL backend",
    "sha": "0171ba65dbbff377282c03b86c83036168c84b22",
    "files": [
        {
            "sha": "a71d1073570146633dab4638d2cebbdffa34dd0e",
            "filename": "django/db/backends/postgresql_psycopg2/introspection.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/0171ba65dbbff377282c03b86c83036168c84b22/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py",
            "raw_url": "https://github.com/django/django/raw/0171ba65dbbff377282c03b86c83036168c84b22/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py?ref=0171ba65dbbff377282c03b86c83036168c84b22",
            "patch": "@@ -66,6 +66,23 @@ def get_relations(self, cursor, table_name):\n             relations[row[0][0] - 1] = (row[1][0] - 1, row[2])\n         return relations\n \n+    def get_key_columns(self, cursor, table_name):\n+        key_columns = []\n+        cursor.execute(\"\"\"\n+            SELECT kcu.column_name, ccu.table_name AS referenced_table, ccu.column_name AS referenced_column\n+            FROM information_schema.constraint_column_usage ccu\n+            LEFT JOIN information_schema.key_column_usage kcu\n+                ON ccu.constraint_catalog = kcu.constraint_catalog\n+                    AND ccu.constraint_schema = kcu.constraint_schema\n+                    AND ccu.constraint_name = kcu.constraint_name\n+            LEFT JOIN information_schema.table_constraints tc\n+                ON ccu.constraint_catalog = tc.constraint_catalog\n+                    AND ccu.constraint_schema = tc.constraint_schema\n+                    AND ccu.constraint_name = tc.constraint_name\n+            WHERE kcu.table_name = %s AND tc.constraint_type = 'FOREIGN KEY'\"\"\" , [table_name])\n+        key_columns.extend(cursor.fetchall())\n+        return key_columns\n+\n     def get_indexes(self, cursor, table_name):\n         # This query retrieves each index on the given table, including the\n         # first associated field name"
        },
        {
            "sha": "cd3e1cc8a48e94b682c44f2d6db35ba7ad7b4a7f",
            "filename": "tests/regressiontests/introspection/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 33,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/0171ba65dbbff377282c03b86c83036168c84b22/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0171ba65dbbff377282c03b86c83036168c84b22/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fintrospection%2Ftests.py?ref=0171ba65dbbff377282c03b86c83036168c84b22",
            "patch": "@@ -1,10 +1,8 @@\n from __future__ import absolute_import, unicode_literals\n \n-from functools import update_wrapper\n-\n from django.db import connection\n from django.test import TestCase, skipUnlessDBFeature, skipIfDBFeature\n-from django.utils import six, unittest\n+from django.utils import unittest\n \n from .models import Reporter, Article\n \n@@ -14,36 +12,7 @@\n     expectedFailureOnOracle = lambda f: f\n \n \n-# The introspection module is optional, so methods tested here might raise\n-# NotImplementedError. This is perfectly acceptable behavior for the backend\n-# in question, but the tests need to handle this without failing. Ideally we'd\n-# skip these tests, but until #4788 is done we'll just ignore them.\n-#\n-# The easiest way to accomplish this is to decorate every test case with a\n-# wrapper that ignores the exception.\n-#\n-# The metaclass is just for fun.\n-\n-\n-def ignore_not_implemented(func):\n-    def _inner(*args, **kwargs):\n-        try:\n-            return func(*args, **kwargs)\n-        except NotImplementedError:\n-            return None\n-    update_wrapper(_inner, func)\n-    return _inner\n-\n-\n-class IgnoreNotimplementedError(type):\n-    def __new__(cls, name, bases, attrs):\n-        for k, v in attrs.items():\n-            if k.startswith('test'):\n-                attrs[k] = ignore_not_implemented(v)\n-        return type.__new__(cls, name, bases, attrs)\n-\n-\n-class IntrospectionTests(six.with_metaclass(IgnoreNotimplementedError, TestCase)):\n+class IntrospectionTests(TestCase):\n     def test_table_names(self):\n         tl = connection.introspection.table_names()\n         self.assertEqual(tl, sorted(tl))\n@@ -139,6 +108,7 @@ def test_get_relations(self):\n             # That's {field_index: (field_index_other_table, other_table)}\n             self.assertEqual(relations, {3: (0, Reporter._meta.db_table)})\n \n+    @skipUnlessDBFeature('can_introspect_foreign_keys')\n     def test_get_key_columns(self):\n         cursor = connection.cursor()\n         key_columns = connection.introspection.get_key_columns(cursor, Article._meta.db_table)"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 20,
        "deletions": 33
    }
}