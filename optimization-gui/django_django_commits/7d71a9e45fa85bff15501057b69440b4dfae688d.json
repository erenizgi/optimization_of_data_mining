{
    "author": "carljm",
    "message": "Fixed #9213 - Added check to prevent inactive users from resetting their password. Thanks to John Scott for report and draft patch, and Evgeny Fadeev for final patch with test.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15805 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7d71a9e45fa85bff15501057b69440b4dfae688d",
    "files": [
        {
            "sha": "3dcbd8480c0053aa9697a9ead0e5bef4b51b756c",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/7d71a9e45fa85bff15501057b69440b4dfae688d/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/7d71a9e45fa85bff15501057b69440b4dfae688d/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=7d71a9e45fa85bff15501057b69440b4dfae688d",
            "patch": "@@ -109,10 +109,13 @@ class PasswordResetForm(forms.Form):\n \n     def clean_email(self):\n         \"\"\"\n-        Validates that a user exists with the given e-mail address.\n+        Validates that an active user exists with the given e-mail address.\n         \"\"\"\n         email = self.cleaned_data[\"email\"]\n-        self.users_cache = User.objects.filter(email__iexact=email)\n+        self.users_cache = User.objects.filter(\n+                                email__iexact=email,\n+                                is_active=True\n+                            )\n         if len(self.users_cache) == 0:\n             raise forms.ValidationError(_(\"That e-mail address doesn't have an associated user account. Are you sure you've registered?\"))\n         return email"
        },
        {
            "sha": "6f9e01d127d77e055fcd13181f7bc6e673d4b962",
            "filename": "django/contrib/auth/tests/forms.py",
            "status": "modified",
            "additions": 21,
            "deletions": 3,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/7d71a9e45fa85bff15501057b69440b4dfae688d/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/7d71a9e45fa85bff15501057b69440b4dfae688d/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py?ref=7d71a9e45fa85bff15501057b69440b4dfae688d",
            "patch": "@@ -219,6 +219,15 @@ class PasswordResetFormTest(TestCase):\n \n     fixtures = ['authtestdata.json']\n \n+    def create_dummy_user(self):\n+        \"\"\"creates a user and returns a tuple\n+        (user_object, username, email)\n+        \"\"\"\n+        username = 'jsmith'\n+        email = 'jsmith@example.com'\n+        user = User.objects.create_user(username, email, 'test123')\n+        return (user, username, email)\n+\n     def test_invalid_email(self):\n         data = {'email':'not valid'}\n         form = PasswordResetForm(data)\n@@ -236,11 +245,11 @@ def test_nonexistant_email(self):\n \n     def test_cleaned_data(self):\n         # Regression test\n-        user = User.objects.create_user(\"jsmith3\", \"jsmith3@example.com\", \"test123\")\n-        data = {'email':'jsmith3@example.com'}\n+        (user, username, email) = self.create_dummy_user()\n+        data = {'email': email}\n         form = PasswordResetForm(data)\n         self.assertTrue(form.is_valid())\n-        self.assertEqual(form.cleaned_data['email'], u'jsmith3@example.com')\n+        self.assertEqual(form.cleaned_data['email'], email)\n \n \n     def test_bug_5605(self):\n@@ -250,3 +259,12 @@ def test_bug_5605(self):\n         self.assertEqual(user.email, 'tesT@example.com')\n         user = User.objects.create_user('forms_test3', 'tesT', 'test')\n         self.assertEqual(user.email, 'tesT')\n+\n+    def test_inactive_user(self):\n+        #tests that inactive user cannot\n+        #receive password reset email\n+        (user, username, email) = self.create_dummy_user()\n+        user.is_active = False\n+        user.save()\n+        form = PasswordResetForm({'email': email})\n+        self.assertFalse(form.is_valid())"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 26,
        "deletions": 5
    }
}