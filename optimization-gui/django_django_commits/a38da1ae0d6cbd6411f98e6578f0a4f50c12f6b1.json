{
    "author": "alex",
    "message": "Avoid doing quadratic amounts of work during object deletion.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15243 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a38da1ae0d6cbd6411f98e6578f0a4f50c12f6b1",
    "files": [
        {
            "sha": "fd4d2c83a3723b396d51ccc732c2c2df34cb0a42",
            "filename": "django/db/models/deletion.py",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/a38da1ae0d6cbd6411f98e6578f0a4f50c12f6b1/django%2Fdb%2Fmodels%2Fdeletion.py",
            "raw_url": "https://github.com/django/django/raw/a38da1ae0d6cbd6411f98e6578f0a4f50c12f6b1/django%2Fdb%2Fmodels%2Fdeletion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fdeletion.py?ref=a38da1ae0d6cbd6411f98e6578f0a4f50c12f6b1",
            "patch": "@@ -58,7 +58,8 @@ def decorated(self, *args, **kwargs):\n class Collector(object):\n     def __init__(self, using):\n         self.using = using\n-        self.data = {} # {model: [instances]}\n+        # Initially, {model: set([instances])}, later values become lists.\n+        self.data = {}\n         self.batches = {} # {model: {field: set([instances])}}\n         self.field_updates = {} # {model: {(field, value): set([instances])}}\n         self.dependencies = {} # {model: set([models])}\n@@ -75,11 +76,11 @@ def add(self, objs, source=None, nullable=False):\n             return []\n         new_objs = []\n         model = objs[0].__class__\n-        instances = self.data.setdefault(model, [])\n+        instances = self.data.setdefault(model, set())\n         for obj in objs:\n             if obj not in instances:\n                 new_objs.append(obj)\n-        instances.extend(new_objs)\n+        instances.update(new_objs)\n         # Nullable relationships can be ignored -- they are nulled out before\n         # deleting, and therefore do not affect the order in which objects have\n         # to be deleted.\n@@ -190,8 +191,8 @@ def sort(self):\n     @force_managed\n     def delete(self):\n         # sort instance collections\n-        for instances in self.data.itervalues():\n-            instances.sort(key=attrgetter(\"pk\"))\n+        for model, instances in self.data.items():\n+            self.data[model] = sorted(instances, key=attrgetter(\"pk\"))\n \n         # if possible, bring the models in an order suitable for databases that\n         # don't support transactions or cannot defer contraint checks until the"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 6,
        "deletions": 5
    }
}