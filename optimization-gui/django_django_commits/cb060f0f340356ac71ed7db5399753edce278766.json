{
    "author": "spookylukey",
    "message": "Fixed #15258 - Ajax CSRF protection doesn't apply to PUT or DELETE requests\n\nThanks to brodie for the report, and further input from tow21\n\nThis is a potentially backwards incompatible change - if you were doing\nPUT/DELETE requests and relying on the lack of protection, you will need to\nupdate your code, as noted in the releaste notes.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16201 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "cb060f0f340356ac71ed7db5399753edce278766",
    "files": [
        {
            "sha": "37f92b1d948cedd9bdba9eb3acc7b7765aec7cac",
            "filename": "django/middleware/csrf.py",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/cb060f0f340356ac71ed7db5399753edce278766/django%2Fmiddleware%2Fcsrf.py",
            "raw_url": "https://github.com/django/django/raw/cb060f0f340356ac71ed7db5399753edce278766/django%2Fmiddleware%2Fcsrf.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcsrf.py?ref=cb060f0f340356ac71ed7db5399753edce278766",
            "patch": "@@ -107,7 +107,8 @@ def process_view(self, request, callback, callback_args, callback_kwargs):\n         if getattr(callback, 'csrf_exempt', False):\n             return None\n \n-        if request.method == 'POST':\n+        # Assume that anything not defined as 'safe' by RC2616 needs protection.\n+        if request.method not in ('GET', 'HEAD', 'OPTIONS', 'TRACE'):\n             if getattr(request, '_dont_enforce_csrf_checks', False):\n                 # Mechanism to turn off CSRF checks for test suite.  It comes after\n                 # the creation of CSRF cookies, so that everything else continues to\n@@ -165,10 +166,14 @@ def process_view(self, request, callback, callback_args, callback_kwargs):\n                 )\n                 return self._reject(request, REASON_NO_CSRF_COOKIE)\n \n-            # check incoming token\n-            request_csrf_token = request.POST.get('csrfmiddlewaretoken', '')\n+            # check non-cookie token for match\n+            request_csrf_token = \"\"\n+            if request.method == \"POST\":\n+                request_csrf_token = request.POST.get('csrfmiddlewaretoken', '')\n+\n             if request_csrf_token == \"\":\n-                # Fall back to X-CSRFToken, to make things easier for AJAX\n+                # Fall back to X-CSRFToken, to make things easier for AJAX,\n+                # and possible for PUT/DELETE\n                 request_csrf_token = request.META.get('HTTP_X_CSRFTOKEN', '')\n \n             if not constant_time_compare(request_csrf_token, csrf_token):"
        },
        {
            "sha": "9441393c81f5939408a7d6d17d8feee026dde9d2",
            "filename": "docs/ref/contrib/csrf.txt",
            "status": "modified",
            "additions": 13,
            "deletions": 12,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/cb060f0f340356ac71ed7db5399753edce278766/docs%2Fref%2Fcontrib%2Fcsrf.txt",
            "raw_url": "https://github.com/django/django/raw/cb060f0f340356ac71ed7db5399753edce278766/docs%2Fref%2Fcontrib%2Fcsrf.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fcsrf.txt?ref=cb060f0f340356ac71ed7db5399753edce278766",
            "patch": "@@ -13,11 +13,13 @@ who visits the malicious site in their browser.  A related type of attack,\n 'login CSRF', where an attacking site tricks a user's browser into logging into\n a site with someone else's credentials, is also covered.\n \n-The first defense against CSRF attacks is to ensure that GET requests are\n-side-effect free.  POST requests can then be protected by following the steps\n-below.\n+The first defense against CSRF attacks is to ensure that GET requests (and other\n+'safe' methods, as defined by `9.1.1 Safe Methods, HTTP 1.1, RFC 2616`_) are\n+side-effect free.  Requests via 'unsafe' methods, such as POST, PUT and DELETE,\n+can then be protected by following the steps below.\n \n .. _Cross Site Request Forgeries: http://www.squarefree.com/securitytips/web-developers.html#CSRF\n+.. _9.1.1 Safe Methods, HTTP 1.1, RFC 2616: http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html\n \n How to use it\n =============\n@@ -198,9 +200,9 @@ The CSRF protection is based on the following things:\n \n    This part is done by the template tag.\n \n-3. For all incoming POST requests, a CSRF cookie must be present, and the\n-   'csrfmiddlewaretoken' field must be present and correct. If it isn't, the\n-   user will get a 403 error.\n+3. For all incoming requests that are not using HTTP GET, HEAD, OPTIONS or\n+   TRACE, a CSRF cookie must be present, and the 'csrfmiddlewaretoken' field\n+   must be present and correct. If it isn't, the user will get a 403 error.\n \n    This check is done by ``CsrfViewMiddleware``.\n \n@@ -215,12 +217,11 @@ The CSRF protection is based on the following things:\n This ensures that only forms that have originated from your Web site can be used\n to POST data back.\n \n-It deliberately only targets HTTP POST requests (and the corresponding POST\n-forms). GET requests ought never to have any potentially dangerous side effects\n-(see `9.1.1 Safe Methods, HTTP 1.1, RFC 2616`_), and so a CSRF attack with a GET\n-request ought to be harmless.\n-\n-.. _9.1.1 Safe Methods, HTTP 1.1, RFC 2616: http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html\n+It deliberately ignores GET requests (and other requests that are defined as\n+'safe' by RFC 2616). These requests ought never to have any potentially\n+dangerous side effects , and so a CSRF attack with a GET request ought to be\n+harmless. RFC 2616 defines POST, PUT and DELETE as 'unsafe', and all other\n+methods are assumed to be unsafe, for maximum protection.\n \n Caching\n ======="
        },
        {
            "sha": "be95d2f02b9b7a005bd838e50ede22ab8b698590",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/cb060f0f340356ac71ed7db5399753edce278766/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/cb060f0f340356ac71ed7db5399753edce278766/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=cb060f0f340356ac71ed7db5399753edce278766",
            "patch": "@@ -214,3 +214,15 @@ you should add the following lines in your settings file::\n \n Don't forget to escape characters that have a special meaning in a regular\n expression.\n+\n+CSRF protection extended to PUT and DELETE\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Previously, Django's :doc:`CSRF protection </ref/contrib/csrf/>` provided\n+protection against only POST requests. Since use of PUT and DELETE methods in\n+AJAX applications is becoming more common, we now protect all methods not\n+defined as safe by RFC 2616 i.e. we exempt GET, HEAD, OPTIONS and TRACE, and\n+enforce protection on everything.\n+\n+If you using PUT or DELETE methods in AJAX applications, please see the\n+:ref:`instructions about using AJAX and CSRF <csrf-ajax>`."
        },
        {
            "sha": "3894de2c023736aab12c49367f4ae6e4fd549b36",
            "filename": "tests/regressiontests/csrf_tests/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/cb060f0f340356ac71ed7db5399753edce278766/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cb060f0f340356ac71ed7db5399753edce278766/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py?ref=cb060f0f340356ac71ed7db5399753edce278766",
            "patch": "@@ -164,6 +164,37 @@ def test_csrf_token_in_header(self):\n         req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n         self.assertEqual(None, req2)\n \n+    def test_put_and_delete_rejected(self):\n+        \"\"\"\n+        Tests that HTTP PUT and DELETE methods have protection\n+        \"\"\"\n+        req = TestingHttpRequest()\n+        req.method = 'PUT'\n+        req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n+        self.assertEqual(403, req2.status_code)\n+\n+        req = TestingHttpRequest()\n+        req.method = 'DELETE'\n+        req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n+        self.assertEqual(403, req2.status_code)\n+\n+    def test_put_and_delete_allowed(self):\n+        \"\"\"\n+        Tests that HTTP PUT and DELETE methods can get through with\n+        X-CSRFToken and a cookie\n+        \"\"\"\n+        req = self._get_GET_csrf_cookie_request()\n+        req.method = 'PUT'\n+        req.META['HTTP_X_CSRFTOKEN'] = self._csrf_id\n+        req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n+        self.assertEqual(None, req2)\n+\n+        req = self._get_GET_csrf_cookie_request()\n+        req.method = 'DELETE'\n+        req.META['HTTP_X_CSRFTOKEN'] = self._csrf_id\n+        req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n+        self.assertEqual(None, req2)\n+\n     # Tests for the template tag method\n     def test_token_node_no_csrf_cookie(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 81,
        "additions": 65,
        "deletions": 16
    }
}