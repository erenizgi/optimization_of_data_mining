{
    "author": "jphalip",
    "message": "Merge pull request #824 from ambv/languagecode",
    "sha": "a8449d436210d19d77a6710f44f44e2d8f924214",
    "files": [
        {
            "sha": "c603833f595030a8783920b75cf9e798d61928a1",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a8449d436210d19d77a6710f44f44e2d8f924214/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/a8449d436210d19d77a6710f44f44e2d8f924214/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=a8449d436210d19d77a6710f44f44e2d8f924214",
            "patch": "@@ -328,6 +328,7 @@ answer newbie questions, and generally made Django that much better:\n     Denis Kuzmichyov <kuzmichyov@gmail.com>\n     Panos Laganakos <panos.laganakos@gmail.com>\n     Nick Lane <nick.lane.au@gmail.com>\n+    ≈Åukasz Langa <lukasz@langa.pl>\n     Stuart Langridge <http://www.kryogenix.org/>\n     Paul Lanier <planier@google.com>\n     David Larlet <http://david.larlet.fr>"
        },
        {
            "sha": "10a6cd60fc24cb38e8a93c6627fcf413e8da2427",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/a8449d436210d19d77a6710f44f44e2d8f924214/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a8449d436210d19d77a6710f44f44e2d8f924214/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=a8449d436210d19d77a6710f44f44e2d8f924214",
            "patch": "@@ -187,10 +187,10 @@ def get_language_info(lang_code):\n     try:\n         return LANG_INFO[lang_code]\n     except KeyError:\n-        if '-' in lang_code:\n-            splited_lang_code = lang_code.split('-')[0]\n-            try:\n-                return LANG_INFO[splited_lang_code]\n-            except KeyError:\n-                raise KeyError(\"Unknown language code %s and %s.\" % (lang_code, splited_lang_code))\n-        raise KeyError(\"Unknown language code %s.\" % lang_code)\n+        if '-' not in lang_code:\n+            raise KeyError(\"Unknown language code %s.\" % lang_code)\n+        generic_lang_code = lang_code.split('-')[0]\n+        try:\n+            return LANG_INFO[generic_lang_code]\n+        except KeyError:\n+            raise KeyError(\"Unknown language code %s and %s.\" % (lang_code, generic_lang_code))"
        },
        {
            "sha": "ad172407de15b79fbc877486ac587ae7119635f2",
            "filename": "django/utils/translation/trans_real.py",
            "status": "modified",
            "additions": 22,
            "deletions": 6,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/a8449d436210d19d77a6710f44f44e2d8f924214/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "raw_url": "https://github.com/django/django/raw/a8449d436210d19d77a6710f44f44e2d8f924214/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_real.py?ref=a8449d436210d19d77a6710f44f44e2d8f924214",
            "patch": "@@ -356,6 +356,20 @@ def check_for_language(lang_code):\n             return True\n     return False\n \n+def get_supported_language_variant(lang_code, supported=None):\n+    \"\"\"\n+    Returns the language-code that's listed in supported languages, possibly\n+    selecting a more generic variant. Raises LookupError if nothing found.\n+    \"\"\"\n+    if supported is None:\n+        from django.conf import settings\n+        supported = dict(settings.LANGUAGES)\n+    if lang_code and lang_code not in supported:\n+        lang_code = lang_code.split('-')[0] # e.g. if fr-ca is not supported fallback to fr\n+    if lang_code and lang_code in supported and check_for_language(lang_code):\n+        return lang_code\n+    raise LookupError(lang_code)\n+\n def get_language_from_path(path, supported=None):\n     \"\"\"\n     Returns the language-code if there is a valid language-code\n@@ -396,11 +410,10 @@ def get_language_from_request(request, check_path=False):\n \n     lang_code = request.COOKIES.get(settings.LANGUAGE_COOKIE_NAME)\n \n-    if lang_code and lang_code not in supported:\n-        lang_code = lang_code.split('-')[0] # e.g. if fr-ca is not supported fallback to fr\n-\n-    if lang_code and lang_code in supported and check_for_language(lang_code):\n-        return lang_code\n+    try:\n+        return get_supported_language_variant(lang_code, supported)\n+    except LookupError:\n+        pass\n \n     accept = request.META.get('HTTP_ACCEPT_LANGUAGE', '')\n     for accept_lang, unused in parse_accept_lang_header(accept):\n@@ -434,7 +447,10 @@ def get_language_from_request(request, check_path=False):\n                     _accepted[normalized] = lang\n                     return lang\n \n-    return settings.LANGUAGE_CODE\n+    try:\n+        return get_supported_language_variant(settings.LANGUAGE_CODE, supported)\n+    except LookupError:\n+        return settings.LANGUAGE_CODE\n \n dot_re = re.compile(r'\\S')\n def blankout(src, char):"
        },
        {
            "sha": "3f77136efbf766483424003330b355c52cb7655a",
            "filename": "tests/regressiontests/i18n/patterns/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/a8449d436210d19d77a6710f44f44e2d8f924214/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a8449d436210d19d77a6710f44f44e2d8f924214/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py?ref=a8449d436210d19d77a6710f44f44e2d8f924214",
            "patch": "@@ -19,7 +19,7 @@\n     TEMPLATE_DIRS=(\n         os.path.join(os.path.dirname(upath(__file__)), 'templates'),\n     ),\n-    LANGUAGE_CODE='en',\n+    LANGUAGE_CODE='en-us',\n     LANGUAGES=(\n         ('nl', 'Dutch'),\n         ('en', 'English'),\n@@ -171,6 +171,14 @@ def test_pt_br_redirect(self):\n         response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 200)\n \n+    def test_pl_pl_redirect(self):\n+        # language from outside of the supported LANGUAGES list\n+        response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='pl-pl')\n+        self.assertRedirects(response, '/en/account/register/')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 200)\n+\n \n class URLVaryAcceptLanguageTests(URLTestCaseBase):\n     \"\"\""
        },
        {
            "sha": "520469ca7950baf67dcb7c95e2cae1f23aae2e47",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/a8449d436210d19d77a6710f44f44e2d8f924214/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a8449d436210d19d77a6710f44f44e2d8f924214/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=a8449d436210d19d77a6710f44f44e2d8f924214",
            "patch": "@@ -958,7 +958,7 @@ def test_localized_language_info(self):\n         self.assertEqual(li['bidi'], False)\n \n     def test_unknown_language_code(self):\n-        six.assertRaisesRegex(self, KeyError, \"Unknown language code '?xx'?.\", get_language_info, 'xx-xx')\n+        six.assertRaisesRegex(self, KeyError, r\"Unknown language code xx\\.\", get_language_info, 'xx')\n \n     def test_unknown_only_country_code(self):\n         li = get_language_info('de-xx')\n@@ -968,7 +968,7 @@ def test_unknown_only_country_code(self):\n         self.assertEqual(li['bidi'], False)\n \n     def test_unknown_language_code_and_country_code(self):\n-        six.assertRaisesRegex(self, KeyError, \"Unknown language code '?xx-xx'? and '?xx'?.\", get_language_info, 'xx-xx')\n+        six.assertRaisesRegex(self, KeyError, r\"Unknown language code xx-xx and xx\\.\", get_language_info, 'xx-xx')\n \n \n class MultipleLocaleActivationTests(TestCase):"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 41,
        "deletions": 16
    }
}