{
    "author": "melinath",
    "message": "Fixed #14567 -- Made ModelMultipleChoiceField return EmptyQuerySet as empty value",
    "sha": "218abcc9e550d266a9979e10f562fc21b8f34c6a",
    "files": [
        {
            "sha": "11fe0c09eada2bde44ab7b8703ce24723ea9210b",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/218abcc9e550d266a9979e10f562fc21b8f34c6a/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/218abcc9e550d266a9979e10f562fc21b8f34c6a/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=218abcc9e550d266a9979e10f562fc21b8f34c6a",
            "patch": "@@ -1013,7 +1013,7 @@ def clean(self, value):\n         if self.required and not value:\n             raise ValidationError(self.error_messages['required'])\n         elif not self.required and not value:\n-            return []\n+            return self.queryset.none()\n         if not isinstance(value, (list, tuple)):\n             raise ValidationError(self.error_messages['list'])\n         key = self.to_field_name or 'pk'"
        },
        {
            "sha": "27ca002312b624cbe360990e8c240a4b2528f9b2",
            "filename": "docs/ref/forms/fields.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/218abcc9e550d266a9979e10f562fc21b8f34c6a/docs%2Fref%2Fforms%2Ffields.txt",
            "raw_url": "https://github.com/django/django/raw/218abcc9e550d266a9979e10f562fc21b8f34c6a/docs%2Fref%2Fforms%2Ffields.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fforms%2Ffields.txt?ref=218abcc9e550d266a9979e10f562fc21b8f34c6a",
            "patch": "@@ -997,13 +997,17 @@ objects (in the case of ``ModelMultipleChoiceField``) into the\n .. class:: ModelMultipleChoiceField(**kwargs)\n \n     * Default widget: ``SelectMultiple``\n-    * Empty value: ``[]`` (an empty list)\n-    * Normalizes to: A list of model instances.\n+    * Empty value: An empty ``QuerySet`` (self.queryset.none())\n+    * Normalizes to: A ``QuerySet`` of model instances.\n     * Validates that every id in the given list of values exists in the\n       queryset.\n     * Error message keys: ``required``, ``list``, ``invalid_choice``,\n       ``invalid_pk_value``\n \n+    .. versionchanged:: 1.5\n+        The empty and normalized values were changed to be consistently\n+        ``QuerySets`` instead of ``[]`` and ``QuerySet`` respectively.\n+\n     Allows the selection of one or more model objects, suitable for\n     representing a many-to-many relation. As with :class:`ModelChoiceField`,\n     you can use ``label_from_instance`` to customize the object"
        },
        {
            "sha": "d87ec3620484649e88f1b422ac74aaf89bce0c05",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/218abcc9e550d266a9979e10f562fc21b8f34c6a/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/218abcc9e550d266a9979e10f562fc21b8f34c6a/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=218abcc9e550d266a9979e10f562fc21b8f34c6a",
            "patch": "@@ -422,6 +422,9 @@ on the form.\n Miscellaneous\n ~~~~~~~~~~~~~\n \n+* :class:`django.forms.ModelMultipleChoiceField` now returns an empty\n+  ``QuerySet`` as the empty value instead of an empty list.\n+\n * :func:`~django.utils.http.int_to_base36` properly raises a :exc:`TypeError`\n   instead of :exc:`ValueError` for non-integer inputs.\n "
        },
        {
            "sha": "947d0cf3c3562f647343949026e485ca69dc4bf0",
            "filename": "tests/modeltests/model_forms/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/218abcc9e550d266a9979e10f562fc21b8f34c6a/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/218abcc9e550d266a9979e10f562fc21b8f34c6a/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py?ref=218abcc9e550d266a9979e10f562fc21b8f34c6a",
            "patch": "@@ -8,6 +8,7 @@\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.core.validators import ValidationError\n from django.db import connection\n+from django.db.models.query import EmptyQuerySet\n from django.forms.models import model_to_dict\n from django.utils.unittest import skipUnless\n from django.test import TestCase\n@@ -1035,8 +1036,8 @@ def test_with_data(self):\n             f.clean([c6.id])\n \n         f = forms.ModelMultipleChoiceField(Category.objects.all(), required=False)\n-        self.assertEqual(f.clean([]), [])\n-        self.assertEqual(f.clean(()), [])\n+        self.assertIsInstance(f.clean([]), EmptyQuerySet)\n+        self.assertIsInstance(f.clean(()), EmptyQuerySet)\n         with self.assertRaises(ValidationError):\n             f.clean(['10'])\n         with self.assertRaises(ValidationError):"
        },
        {
            "sha": "6e9c269356efdf8404a3f639037bf9f8cbd91791",
            "filename": "tests/regressiontests/forms/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/218abcc9e550d266a9979e10f562fc21b8f34c6a/tests%2Fregressiontests%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/218abcc9e550d266a9979e10f562fc21b8f34c6a/tests%2Fregressiontests%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Fmodels.py?ref=218abcc9e550d266a9979e10f562fc21b8f34c6a",
            "patch": "@@ -63,6 +63,12 @@ class ChoiceFieldModel(models.Model):\n     multi_choice_int = models.ManyToManyField(ChoiceOptionModel, blank=False, related_name='multi_choice_int',\n                                               default=lambda: [1])\n \n+class OptionalMultiChoiceModel(models.Model):\n+    multi_choice = models.ManyToManyField(ChoiceOptionModel, blank=False, related_name='not_relevant',\n+                                          default=lambda: ChoiceOptionModel.objects.filter(name='default'))\n+    multi_choice_optional = models.ManyToManyField(ChoiceOptionModel, blank=True, null=True,\n+                                                   related_name='not_relevant2')\n+\n \n class FileModel(models.Model):\n     file = models.FileField(storage=temp_storage, upload_to='tests')"
        },
        {
            "sha": "be75643b2809a1100094750bdddb4818d559bc6a",
            "filename": "tests/regressiontests/forms/tests/models.py",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/218abcc9e550d266a9979e10f562fc21b8f34c6a/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/218abcc9e550d266a9979e10f562fc21b8f34c6a/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fmodels.py?ref=218abcc9e550d266a9979e10f562fc21b8f34c6a",
            "patch": "@@ -11,14 +11,19 @@\n from django.utils import six\n \n from ..models import (ChoiceOptionModel, ChoiceFieldModel, FileModel, Group,\n-    BoundaryModel, Defaults)\n+    BoundaryModel, Defaults, OptionalMultiChoiceModel)\n \n \n class ChoiceFieldForm(ModelForm):\n     class Meta:\n         model = ChoiceFieldModel\n \n \n+class OptionalMultiChoiceModelForm(ModelForm):\n+    class Meta:\n+        model = OptionalMultiChoiceModel\n+\n+\n class FileForm(Form):\n     file1 = FileField()\n \n@@ -34,6 +39,21 @@ def test_choices_not_fetched_when_not_rendering(self):\n             field = ModelChoiceField(Group.objects.order_by('-name'))\n             self.assertEqual('a', field.clean(self.groups[0].pk).name)\n \n+\n+class TestTicket14567(TestCase):\n+    \"\"\"\n+    Check that the return values of ModelMultipleChoiceFields are QuerySets\n+    \"\"\"\n+    def test_empty_queryset_return(self):\n+        \"If a model's ManyToManyField has blank=True and is saved with no data, a queryset is returned.\"\n+        form = OptionalMultiChoiceModelForm({'multi_choice_optional': '', 'multi_choice': ['1']})\n+        self.assertTrue(form.is_valid())\n+        # Check that the empty value is a QuerySet\n+        self.assertTrue(isinstance(form.cleaned_data['multi_choice_optional'], models.query.QuerySet))\n+        # While we're at it, test whether a QuerySet is returned if there *is* a value.\n+        self.assertTrue(isinstance(form.cleaned_data['multi_choice'], models.query.QuerySet))\n+\n+\n class ModelFormCallableModelDefault(TestCase):\n     def test_no_empty_option(self):\n         \"If a model's ForeignKey has blank=False and a default, no empty option is created (Refs #10792).\"\n@@ -103,7 +123,6 @@ def test_initial_instance_value(self):\n <input type=\"hidden\" name=\"initial-multi_choice_int\" value=\"3\" id=\"initial-id_multi_choice_int_1\" /> <span class=\"helptext\"> Hold down \"Control\", or \"Command\" on a Mac, to select more than one.</span></p>\"\"\")\n \n \n-\n class FormsModelTestCase(TestCase):\n     def test_unicode_filename(self):\n         # FileModel with unicode filename and data #########################"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 40,
        "deletions": 7
    }
}