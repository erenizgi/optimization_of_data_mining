{
    "author": "dericcrago",
    "message": "Fixed #19327 -- Added handling of double login attempts in admin.\n\nThanks to Krzysztof Jurewicz for initial patch and\nadupin for tests.",
    "sha": "9d6ecc6bc668b5a243905486fa724d53508ad2b5",
    "files": [
        {
            "sha": "eff6e4c602826d686ed5d247acd766d59735aa98",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/9d6ecc6bc668b5a243905486fa724d53508ad2b5/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/9d6ecc6bc668b5a243905486fa724d53508ad2b5/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=9d6ecc6bc668b5a243905486fa724d53508ad2b5",
            "patch": "@@ -606,6 +606,7 @@ answer newbie questions, and generally made Django that much better:\n     Jarek Zgoda <jarek.zgoda@gmail.com>\n     Cheng Zhang\n     Hannes Stru√ü <x@hannesstruss.de>\n+    Deric Crago <deric.crago@gmail.com>\n \n A big THANK YOU goes to:\n "
        },
        {
            "sha": "8345543707ea624b1410d602383b63216b55813d",
            "filename": "django/contrib/admin/sites.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/9d6ecc6bc668b5a243905486fa724d53508ad2b5/django%2Fcontrib%2Fadmin%2Fsites.py",
            "raw_url": "https://github.com/django/django/raw/9d6ecc6bc668b5a243905486fa724d53508ad2b5/django%2Fcontrib%2Fadmin%2Fsites.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fsites.py?ref=9d6ecc6bc668b5a243905486fa724d53508ad2b5",
            "patch": "@@ -2,7 +2,7 @@\n from django.http import Http404, HttpResponseRedirect\n from django.contrib.admin import ModelAdmin, actions\n from django.contrib.admin.forms import AdminAuthenticationForm\n-from django.contrib.auth import REDIRECT_FIELD_NAME\n+from django.contrib.auth import logout as auth_logout, REDIRECT_FIELD_NAME\n from django.contrib.contenttypes import views as contenttype_views\n from django.views.decorators.csrf import csrf_protect\n from django.db.models.base import ModelBase\n@@ -193,6 +193,8 @@ def get_urls(self):\n         cacheable=True.\n         \"\"\"\n         def inner(request, *args, **kwargs):\n+            if LOGIN_FORM_KEY in request.POST and request.user.is_authenticated():\n+                auth_logout(request)\n             if not self.has_permission(request):\n                 if request.path == reverse('admin:logout',\n                                            current_app=self.name):"
        },
        {
            "sha": "203d7d624b006d61af3dfbf9c6b25784c6073da8",
            "filename": "tests/admin_views/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 2,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/9d6ecc6bc668b5a243905486fa724d53508ad2b5/tests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9d6ecc6bc668b5a243905486fa724d53508ad2b5/tests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fadmin_views%2Ftests.py?ref=9d6ecc6bc668b5a243905486fa724d53508ad2b5",
            "patch": "@@ -6,7 +6,7 @@\n import datetime\n try:\n     from urllib.parse import urljoin\n-except ImportError:     # Python 2\n+except ImportError:  # Python 2\n     from urlparse import urljoin\n \n from django.conf import settings, global_settings\n@@ -981,6 +981,32 @@ def testLoginSuccessfullyRedirectsToOriginalUrl(self):\n         login = self.client.post('/test_admin/admin/', dict(self.super_login, **new_next), QUERY_STRING=query_string)\n         self.assertRedirects(login, redirect_url)\n \n+    def testDoubleLoginIsNotAllowed(self):\n+        \"\"\"Regression test for #19327\"\"\"\n+        response = self.client.get('/test_admin/admin/')\n+        self.assertEqual(response.status_code, 200)\n+\n+        # Establish a valid admin session\n+        login = self.client.post('/test_admin/admin/', self.super_login)\n+        self.assertRedirects(login, '/test_admin/admin/')\n+        self.assertFalse(login.context)\n+\n+        # Logging in with non-admin user fails\n+        login = self.client.post('/test_admin/admin/', self.joepublic_login)\n+        self.assertEqual(login.status_code, 200)\n+        self.assertContains(login, ERROR_MESSAGE)\n+\n+        # Establish a valid admin session\n+        login = self.client.post('/test_admin/admin/', self.super_login)\n+        self.assertRedirects(login, '/test_admin/admin/')\n+        self.assertFalse(login.context)\n+\n+        # Logging in with admin user while already logged in\n+        login = self.client.post('/test_admin/admin/', self.super_login)\n+        self.assertRedirects(login, '/test_admin/admin/')\n+        self.assertFalse(login.context)\n+        self.client.get('/test_admin/admin/logout/')\n+\n     def testAddView(self):\n         \"\"\"Test add view restricts access and actually adds items.\"\"\"\n \n@@ -2547,7 +2573,7 @@ def test_changelist_view(self):\n                 self.assertNotContains(response, 'Primary key = %s' % i)\n \n     def test_changelist_view_count_queries(self):\n-        #create 2 Person objects\n+        # create 2 Person objects\n         Person.objects.create(name='person1', gender=1)\n         Person.objects.create(name='person2', gender=2)\n "
        }
    ],
    "stats": {
        "total": 35,
        "additions": 32,
        "deletions": 3
    }
}