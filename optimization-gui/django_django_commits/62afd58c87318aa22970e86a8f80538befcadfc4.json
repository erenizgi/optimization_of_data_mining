{
    "author": "carljm",
    "message": "Fixed #17057 -- Corrected flatpage url uniqueness validation to account for flatpage editing.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17000 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "62afd58c87318aa22970e86a8f80538befcadfc4",
    "files": [
        {
            "sha": "3916c85a8913a4ed0401cb59313792824fe0c639",
            "filename": "django/contrib/flatpages/forms.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/62afd58c87318aa22970e86a8f80538befcadfc4/django%2Fcontrib%2Fflatpages%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/62afd58c87318aa22970e86a8f80538befcadfc4/django%2Fcontrib%2Fflatpages%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Fforms.py?ref=62afd58c87318aa22970e86a8f80538befcadfc4",
            "patch": "@@ -16,11 +16,13 @@ def clean(self):\n         url = self.cleaned_data.get('url', None)\n         sites = self.cleaned_data.get('sites', None)\n \n-        flatpages_with_same_url = FlatPage.objects.filter(url=url)\n+        same_url = FlatPage.objects.filter(url=url)\n+        if self.instance.pk:\n+            same_url = same_url.exclude(pk=self.instance.pk)\n \n-        if flatpages_with_same_url.filter(sites__in=sites).exists():\n+        if same_url.filter(sites__in=sites).exists():\n             for site in sites:\n-                if flatpages_with_same_url.filter(sites=site).exists():\n+                if same_url.filter(sites=site).exists():\n                     raise forms.ValidationError(\n                         _('Flatpage with url %s already exists for site %s'\n                           % (url, site)))"
        },
        {
            "sha": "7f617d52a5872e06a3a1fbf7b47b778cf66614c7",
            "filename": "django/contrib/flatpages/tests/forms.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/62afd58c87318aa22970e86a8f80538befcadfc4/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/62afd58c87318aa22970e86a8f80538befcadfc4/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py?ref=62afd58c87318aa22970e86a8f80538befcadfc4",
            "patch": "@@ -1,5 +1,6 @@\n from django.conf import settings\n from django.contrib.flatpages.forms import FlatpageForm\n+from django.contrib.flatpages.models import FlatPage\n from django.test import TestCase\n \n class FlatpageAdminFormTests(TestCase):\n@@ -35,3 +36,23 @@ def test_flatpage_admin_form_url_uniqueness_validation(self):\n         self.assertEqual(\n             f.errors,\n             {'__all__': [u'Flatpage with url /myflatpage1 already exists for site example.com']})\n+\n+    def test_flatpage_admin_form_edit(self):\n+        \"\"\"\n+        Existing flatpages can be edited in the admin form without triggering\n+        the url-uniqueness validation.\n+\n+        \"\"\"\n+        existing = FlatPage.objects.create(\n+            url=\"/myflatpage1\", title=\"Some page\", content=\"The content\")\n+        existing.sites.add(settings.SITE_ID)\n+\n+        data = dict(url='/myflatpage1', **self.form_data)\n+\n+        f = FlatpageForm(data=data, instance=existing)\n+\n+        self.assertTrue(f.is_valid(), f.errors)\n+\n+        updated = f.save()\n+\n+        self.assertEqual(updated.title, \"A test page\")"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 26,
        "deletions": 3
    }
}