{
    "author": "claudep",
    "message": "Fixed #19509 -- Fixed crypt/bcrypt non-ascii password encoding\n\nAlso systematically added non-ascii passwords in hashers test suite.\nThanks Vaal for the report.",
    "sha": "0dc3fc954f53d5b03b864e63b309acfdbb40dbf9",
    "files": [
        {
            "sha": "b3631a6b8c245a4cee0bf0c0ef76076a29dab2a7",
            "filename": "django/contrib/auth/hashers.py",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/0dc3fc954f53d5b03b864e63b309acfdbb40dbf9/django%2Fcontrib%2Fauth%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/0dc3fc954f53d5b03b864e63b309acfdbb40dbf9/django%2Fcontrib%2Fauth%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhashers.py?ref=0dc3fc954f53d5b03b864e63b309acfdbb40dbf9",
            "patch": "@@ -8,7 +8,7 @@\n from django.test.signals import setting_changed\n from django.utils import importlib\n from django.utils.datastructures import SortedDict\n-from django.utils.encoding import force_bytes\n+from django.utils.encoding import force_bytes, force_str\n from django.core.exceptions import ImproperlyConfigured\n from django.utils.crypto import (\n     pbkdf2, constant_time_compare, get_random_string)\n@@ -275,14 +275,16 @@ def salt(self):\n \n     def encode(self, password, salt):\n         bcrypt = self._load_library()\n-        data = bcrypt.hashpw(password, salt)\n+        # Need to reevaluate the force_bytes call once bcrypt is supported on\n+        # Python 3\n+        data = bcrypt.hashpw(force_bytes(password), salt)\n         return \"%s$%s\" % (self.algorithm, data)\n \n     def verify(self, password, encoded):\n         algorithm, data = encoded.split('$', 1)\n         assert algorithm == self.algorithm\n         bcrypt = self._load_library()\n-        return constant_time_compare(data, bcrypt.hashpw(password, data))\n+        return constant_time_compare(data, bcrypt.hashpw(force_bytes(password), data))\n \n     def safe_summary(self, encoded):\n         algorithm, empty, algostr, work_factor, data = encoded.split('$', 4)\n@@ -395,15 +397,15 @@ def salt(self):\n     def encode(self, password, salt):\n         crypt = self._load_library()\n         assert len(salt) == 2\n-        data = crypt.crypt(password, salt)\n+        data = crypt.crypt(force_str(password), salt)\n         # we don't need to store the salt, but Django used to do this\n         return \"%s$%s$%s\" % (self.algorithm, '', data)\n \n     def verify(self, password, encoded):\n         crypt = self._load_library()\n         algorithm, salt, data = encoded.split('$', 2)\n         assert algorithm == self.algorithm\n-        return constant_time_compare(data, crypt.crypt(password, data))\n+        return constant_time_compare(data, crypt.crypt(force_str(password), data))\n \n     def safe_summary(self, encoded):\n         algorithm, salt, data = encoded.split('$', 2)"
        },
        {
            "sha": "e2a3537695c35d7c147603bd931f3dff4a84c14e",
            "filename": "django/contrib/auth/tests/hashers.py",
            "status": "modified",
            "additions": 45,
            "deletions": 44,
            "changes": 89,
            "blob_url": "https://github.com/django/django/blob/0dc3fc954f53d5b03b864e63b309acfdbb40dbf9/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/0dc3fc954f53d5b03b864e63b309acfdbb40dbf9/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py?ref=0dc3fc954f53d5b03b864e63b309acfdbb40dbf9",
            "patch": "@@ -1,3 +1,4 @@\n+# -*- coding: utf-8 -*-\n from __future__ import unicode_literals\n \n from django.conf.global_settings import PASSWORD_HASHERS as default_hashers\n@@ -25,63 +26,63 @@ def setUp(self):\n         load_hashers(password_hashers=default_hashers)\n \n     def test_simple(self):\n-        encoded = make_password('letmein')\n+        encoded = make_password('lètmein')\n         self.assertTrue(encoded.startswith('pbkdf2_sha256$'))\n         self.assertTrue(is_password_usable(encoded))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n \n     def test_pkbdf2(self):\n-        encoded = make_password('letmein', 'seasalt', 'pbkdf2_sha256')\n-        self.assertEqual(encoded, \n-'pbkdf2_sha256$10000$seasalt$FQCNpiZpTb0zub+HBsH6TOwyRxJ19FwvjbweatNmK/Y=')\n+        encoded = make_password('lètmein', 'seasalt', 'pbkdf2_sha256')\n+        self.assertEqual(encoded,\n+            'pbkdf2_sha256$10000$seasalt$CWWFdHOWwPnki7HvkcqN9iA2T3KLW1cf2uZ5kvArtVY=')\n         self.assertTrue(is_password_usable(encoded))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"pbkdf2_sha256\")\n \n     def test_sha1(self):\n-        encoded = make_password('letmein', 'seasalt', 'sha1')\n-        self.assertEqual(encoded, \n-'sha1$seasalt$fec3530984afba6bade3347b7140d1a7da7da8c7')\n+        encoded = make_password('lètmein', 'seasalt', 'sha1')\n+        self.assertEqual(encoded,\n+            'sha1$seasalt$cff36ea83f5706ce9aa7454e63e431fc726b2dc8')\n         self.assertTrue(is_password_usable(encoded))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"sha1\")\n \n     def test_md5(self):\n-        encoded = make_password('letmein', 'seasalt', 'md5')\n+        encoded = make_password('lètmein', 'seasalt', 'md5')\n         self.assertEqual(encoded, \n-                         'md5$seasalt$f5531bef9f3687d0ccf0f617f0e25573')\n+                         'md5$seasalt$3f86d0d3d465b7b458c231bf3555c0e3')\n         self.assertTrue(is_password_usable(encoded))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"md5\")\n \n     def test_unsalted_md5(self):\n-        encoded = make_password('letmein', 'seasalt', 'unsalted_md5')\n-        self.assertEqual(encoded, '0d107d09f5bbe40cade3de5c71e9e9b7')\n+        encoded = make_password('lètmein', 'seasalt', 'unsalted_md5')\n+        self.assertEqual(encoded, '88a434c88cca4e900f7874cd98123f43')\n         self.assertTrue(is_password_usable(encoded))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"unsalted_md5\")\n \n     @skipUnless(crypt, \"no crypt module to generate password.\")\n     def test_crypt(self):\n-        encoded = make_password('letmein', 'ab', 'crypt')\n-        self.assertEqual(encoded, 'crypt$$abN/qM.L/H8EQ')\n+        encoded = make_password('lètmei', 'ab', 'crypt')\n+        self.assertEqual(encoded, 'crypt$$ab1Hv2Lg7ltQo')\n         self.assertTrue(is_password_usable(encoded))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmei', encoded))\n+        self.assertFalse(check_password('lètmeiz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"crypt\")\n \n     @skipUnless(bcrypt, \"py-bcrypt not installed\")\n     def test_bcrypt(self):\n-        encoded = make_password('letmein', hasher='bcrypt')\n+        encoded = make_password('lètmein', hasher='bcrypt')\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(encoded.startswith('bcrypt$'))\n-        self.assertTrue(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"bcrypt\")\n \n     def test_unusable(self):\n@@ -90,46 +91,46 @@ def test_unusable(self):\n         self.assertFalse(check_password(None, encoded))\n         self.assertFalse(check_password(UNUSABLE_PASSWORD, encoded))\n         self.assertFalse(check_password('', encoded))\n-        self.assertFalse(check_password('letmein', encoded))\n-        self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertFalse(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertRaises(ValueError, identify_hasher, encoded)\n \n     def test_bad_algorithm(self):\n         def doit():\n-            make_password('letmein', hasher='lolcat')\n+            make_password('lètmein', hasher='lolcat')\n         self.assertRaises(ValueError, doit)\n         self.assertRaises(ValueError, identify_hasher, \"lolcat$salt$hash\")\n \n     def test_bad_encoded(self):\n-        self.assertFalse(is_password_usable('letmein_badencoded'))\n+        self.assertFalse(is_password_usable('lètmein_badencoded'))\n         self.assertFalse(is_password_usable(''))\n \n     def test_low_level_pkbdf2(self):\n         hasher = PBKDF2PasswordHasher()\n-        encoded = hasher.encode('letmein', 'seasalt')\n-        self.assertEqual(encoded, \n-'pbkdf2_sha256$10000$seasalt$FQCNpiZpTb0zub+HBsH6TOwyRxJ19FwvjbweatNmK/Y=')\n-        self.assertTrue(hasher.verify('letmein', encoded))\n+        encoded = hasher.encode('lètmein', 'seasalt')\n+        self.assertEqual(encoded,\n+            'pbkdf2_sha256$10000$seasalt$CWWFdHOWwPnki7HvkcqN9iA2T3KLW1cf2uZ5kvArtVY=')\n+        self.assertTrue(hasher.verify('lètmein', encoded))\n \n     def test_low_level_pbkdf2_sha1(self):\n         hasher = PBKDF2SHA1PasswordHasher()\n-        encoded = hasher.encode('letmein', 'seasalt')\n-        self.assertEqual(encoded, \n-'pbkdf2_sha1$10000$seasalt$91JiNKgwADC8j2j86Ije/cc4vfQ=')\n-        self.assertTrue(hasher.verify('letmein', encoded))\n+        encoded = hasher.encode('lètmein', 'seasalt')\n+        self.assertEqual(encoded,\n+            'pbkdf2_sha1$10000$seasalt$oAfF6vgs95ncksAhGXOWf4Okq7o=')\n+        self.assertTrue(hasher.verify('lètmein', encoded))\n \n     def test_upgrade(self):\n         self.assertEqual('pbkdf2_sha256', get_hasher('default').algorithm)\n         for algo in ('sha1', 'md5'):\n-            encoded = make_password('letmein', hasher=algo)\n+            encoded = make_password('lètmein', hasher=algo)\n             state = {'upgraded': False}\n             def setter(password):\n                 state['upgraded'] = True\n-            self.assertTrue(check_password('letmein', encoded, setter))\n+            self.assertTrue(check_password('lètmein', encoded, setter))\n             self.assertTrue(state['upgraded'])\n \n     def test_no_upgrade(self):\n-        encoded = make_password('letmein')\n+        encoded = make_password('lètmein')\n         state = {'upgraded': False}\n         def setter():\n             state['upgraded'] = True\n@@ -139,7 +140,7 @@ def setter():\n     def test_no_upgrade_on_incorrect_pass(self):\n         self.assertEqual('pbkdf2_sha256', get_hasher('default').algorithm)\n         for algo in ('sha1', 'md5'):\n-            encoded = make_password('letmein', hasher=algo)\n+            encoded = make_password('lètmein', hasher=algo)\n             state = {'upgraded': False}\n             def setter():\n                 state['upgraded'] = True"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 52,
        "deletions": 49
    }
}