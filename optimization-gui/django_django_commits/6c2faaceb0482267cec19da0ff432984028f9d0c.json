{
    "author": "claudep",
    "message": "Made more extensive use of get_current_site\n\nRefs #15089",
    "sha": "6c2faaceb0482267cec19da0ff432984028f9d0c",
    "files": [
        {
            "sha": "6c56d7a8a54e07be64c73d6adf02ced6724917a9",
            "filename": "django/contrib/comments/moderation.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fcomments%2Fmoderation.py",
            "raw_url": "https://github.com/django/django/raw/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fcomments%2Fmoderation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fmoderation.py?ref=6c2faaceb0482267cec19da0ff432984028f9d0c",
            "patch": "@@ -62,7 +62,7 @@ class EntryModerator(CommentModerator):\n from django.db.models.base import ModelBase\n from django.template import Context, loader\n from django.contrib import comments\n-from django.contrib.sites.models import Site\n+from django.contrib.sites.models import get_current_site\n from django.utils import timezone\n \n class AlreadyModerated(Exception):\n@@ -240,7 +240,7 @@ def email(self, comment, content_object, request):\n         t = loader.get_template('comments/comment_notification_email.txt')\n         c = Context({ 'comment': comment,\n                       'content_object': content_object })\n-        subject = '[%s] New comment posted on \"%s\"' % (Site.objects.get_current().name,\n+        subject = '[%s] New comment posted on \"%s\"' % (get_current_site(request).name,\n                                                           content_object)\n         message = t.render(c)\n         send_mail(subject, message, settings.DEFAULT_FROM_EMAIL, recipient_list, fail_silently=True)"
        },
        {
            "sha": "10311fae923f640e7b4adac2c61f455b50c8a7d1",
            "filename": "django/contrib/contenttypes/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Ftests.py?ref=6c2faaceb0482267cec19da0ff432984028f9d0c",
            "patch": "@@ -3,7 +3,7 @@\n from django.db import models\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.contenttypes.views import shortcut\n-from django.contrib.sites.models import Site\n+from django.contrib.sites.models import Site, get_current_site\n from django.http import HttpRequest, Http404\n from django.test import TestCase\n from django.utils.http import urlquote\n@@ -219,9 +219,8 @@ def test_shortcut_view(self):\n         obj = FooWithUrl.objects.create(name=\"john\")\n \n         if Site._meta.installed:\n-            current_site = Site.objects.get_current()\n             response = shortcut(request, user_ct.id, obj.id)\n-            self.assertEqual(\"http://%s/users/john/\" % current_site.domain,\n+            self.assertEqual(\"http://%s/users/john/\" % get_current_site(request).domain,\n                              response._headers.get(\"location\")[1])\n \n         Site._meta.installed = False"
        },
        {
            "sha": "a32ac7f4905da8049d6c9f17670f0f89f380efe6",
            "filename": "django/contrib/flatpages/templatetags/flatpages.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fflatpages%2Ftemplatetags%2Fflatpages.py",
            "raw_url": "https://github.com/django/django/raw/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fflatpages%2Ftemplatetags%2Fflatpages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Ftemplatetags%2Fflatpages.py?ref=6c2faaceb0482267cec19da0ff432984028f9d0c",
            "patch": "@@ -1,6 +1,7 @@\n from django import template\n from django.conf import settings\n from django.contrib.flatpages.models import FlatPage\n+from django.contrib.sites.models import get_current_site\n \n \n register = template.Library()\n@@ -19,7 +20,11 @@ def __init__(self, context_name, starts_with=None, user=None):\n             self.user = None\n \n     def render(self, context):\n-        flatpages = FlatPage.objects.filter(sites__id=settings.SITE_ID)\n+        if 'request' in context:\n+            site_pk = get_current_site(context['request']).pk\n+        else:\n+            site_pk = settings.SITE_ID\n+        flatpages = FlatPage.objects.filter(sites__id=site_pk)\n         # If a prefix was specified, add a filter\n         if self.starts_with:\n             flatpages = flatpages.filter("
        },
        {
            "sha": "927220d44d18ad9e98cebdd523b73d65b30d55a6",
            "filename": "django/contrib/redirects/middleware.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fredirects%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fcontrib%2Fredirects%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fredirects%2Fmiddleware.py?ref=6c2faaceb0482267cec19da0ff432984028f9d0c",
            "patch": "@@ -1,4 +1,5 @@\n from django.contrib.redirects.models import Redirect\n+from django.contrib.sites.models import get_current_site\n from django import http\n from django.conf import settings\n \n@@ -7,14 +8,15 @@ def process_response(self, request, response):\n         if response.status_code != 404:\n             return response # No need to check for a redirect for non-404 responses.\n         path = request.get_full_path()\n+        current_site = get_current_site(request)\n         try:\n-            r = Redirect.objects.get(site__id__exact=settings.SITE_ID, old_path=path)\n+            r = Redirect.objects.get(site__id__exact=current_site.id, old_path=path)\n         except Redirect.DoesNotExist:\n             r = None\n         if r is None and settings.APPEND_SLASH:\n             # Try removing the trailing slash.\n             try:\n-                r = Redirect.objects.get(site__id__exact=settings.SITE_ID,\n+                r = Redirect.objects.get(site__id__exact=current_site.id,\n                     old_path=path[:path.rfind('/')]+path[path.rfind('/')+1:])\n             except Redirect.DoesNotExist:\n                 pass"
        },
        {
            "sha": "06925c1f4a2c9ee75c955cc4613e88a62a654119",
            "filename": "django/views/decorators/cache.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fviews%2Fdecorators%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/6c2faaceb0482267cec19da0ff432984028f9d0c/django%2Fviews%2Fdecorators%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdecorators%2Fcache.py?ref=6c2faaceb0482267cec19da0ff432984028f9d0c",
            "patch": "@@ -12,7 +12,7 @@ def cache_page(*args, **kwargs):\n     The cache is keyed by the URL and some data from the headers.\n     Additionally there is the key prefix that is used to distinguish different\n     cache areas in a multi-site setup. You could use the\n-    sites.get_current().domain, for example, as that is unique across a Django\n+    sites.get_current_site().domain, for example, as that is unique across a Django\n     project.\n \n     Additionally, all headers from the response's Vary header will be taken"
        },
        {
            "sha": "790e003453466735f6c503d1da847bf89e1d4166",
            "filename": "docs/ref/contrib/sites.txt",
            "status": "modified",
            "additions": 20,
            "deletions": 33,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/6c2faaceb0482267cec19da0ff432984028f9d0c/docs%2Fref%2Fcontrib%2Fsites.txt",
            "raw_url": "https://github.com/django/django/raw/6c2faaceb0482267cec19da0ff432984028f9d0c/docs%2Fref%2Fcontrib%2Fsites.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fsites.txt?ref=6c2faaceb0482267cec19da0ff432984028f9d0c",
            "patch": "@@ -80,11 +80,11 @@ This accomplishes several things quite nicely:\n   The view code that displays a given story just checks to make sure the\n   requested story is on the current site. It looks something like this::\n \n-      from django.conf import settings\n+      from django.contrib.sites.models import get_current_site\n \n       def article_detail(request, article_id):\n           try:\n-              a = Article.objects.get(id=article_id, sites__id__exact=settings.SITE_ID)\n+              a = Article.objects.get(id=article_id, sites__id__exact=get_current_site(request).id)\n           except Article.DoesNotExist:\n               raise Http404\n           # ...\n@@ -131,49 +131,36 @@ For example::\n             # Do something else.\n \n Of course, it's ugly to hard-code the site IDs like that. This sort of\n-hard-coding is best for hackish fixes that you need done quickly. A slightly\n+hard-coding is best for hackish fixes that you need done quickly. The\n cleaner way of accomplishing the same thing is to check the current site's\n domain::\n \n-    from django.conf import settings\n-    from django.contrib.sites.models import Site\n+    from django.contrib.sites.models import get_current_site\n \n     def my_view(request):\n-        current_site = Site.objects.get(id=settings.SITE_ID)\n+        current_site = get_current_site(request)\n         if current_site.domain == 'foo.com':\n             # Do something\n         else:\n             # Do something else.\n \n-The idiom of retrieving the :class:`~django.contrib.sites.models.Site` object\n-for the value of :setting:`settings.SITE_ID <SITE_ID>` is quite common, so\n-the :class:`~django.contrib.sites.models.Site` model's manager has a\n-``get_current()`` method. This example is equivalent to the previous one::\n+This has also the advantage of checking if the sites framework is installed, and\n+return a :class:`RequestSite` instance if it is not.\n+\n+If you don't have access to the request object, you can use the\n+``get_current()`` method of the :class:`~django.contrib.sites.models.Site`\n+model's manager. You should then ensure that your settings file does contain\n+the :setting:`SITE_ID` setting. This example is equivalent to the previous one::\n \n     from django.contrib.sites.models import Site\n \n-    def my_view(request):\n+    def my_function_without_request():\n         current_site = Site.objects.get_current()\n         if current_site.domain == 'foo.com':\n             # Do something\n         else:\n             # Do something else.\n \n-For code which relies on getting the current domain but cannot be certain\n-that the sites framework will be installed for any given project, there is a\n-utility function :func:`~django.contrib.sites.models.get_current_site` that\n-takes a request object as an argument and returns either a Site instance (if\n-the sites framework is installed) or a RequestSite instance (if it is not).\n-This allows loose coupling with the sites framework and provides a usable\n-fallback for cases where it is not installed.\n-\n-.. function:: get_current_site(request)\n-\n-    Checks if contrib.sites is installed and returns either the current\n-    :class:`~django.contrib.sites.models.Site` object or a\n-    :class:`~django.contrib.sites.models.RequestSite` object based on\n-    the request.\n-\n Getting the current domain for display\n --------------------------------------\n \n@@ -192,14 +179,14 @@ current site's :attr:`~django.contrib.sites.models.Site.name` and\n \n Here's an example of what the form-handling view looks like::\n \n-    from django.contrib.sites.models import Site\n+    from django.contrib.sites.models import get_current_site\n     from django.core.mail import send_mail\n \n     def register_for_newsletter(request):\n         # Check form values, etc., and subscribe the user.\n         # ...\n \n-        current_site = Site.objects.get_current()\n+        current_site = get_current_site(request)\n         send_mail('Thanks for subscribing to %s alerts' % current_site.name,\n             'Thanks for your subscription. We appreciate it.\\n\\n-The %s team.' % current_site.name,\n             'editor@%s' % current_site.domain,\n@@ -370,19 +357,19 @@ Here's how Django uses the sites framework:\n \n * In the :mod:`redirects framework <django.contrib.redirects>`, each\n   redirect object is associated with a particular site. When Django searches\n-  for a redirect, it takes into account the current :setting:`SITE_ID`.\n+  for a redirect, it takes into account the current site.\n \n * In the comments framework, each comment is associated with a particular\n   site. When a comment is posted, its\n-  :class:`~django.contrib.sites.models.Site` is set to the current\n-  :setting:`SITE_ID`, and when comments are listed via the appropriate\n-  template tag, only the comments for the current site are displayed.\n+  :class:`~django.contrib.sites.models.Site` is set to the current site,\n+  and when comments are listed via the appropriate template tag, only the\n+  comments for the current site are displayed.\n \n * In the :mod:`flatpages framework <django.contrib.flatpages>`, each\n   flatpage is associated with a particular site. When a flatpage is created,\n   you specify its :class:`~django.contrib.sites.models.Site`, and the\n   :class:`~django.contrib.flatpages.middleware.FlatpageFallbackMiddleware`\n-  checks the current :setting:`SITE_ID` in retrieving flatpages to display.\n+  checks the current site in retrieving flatpages to display.\n \n * In the :mod:`syndication framework <django.contrib.syndication>`, the\n   templates for ``title`` and ``description`` automatically have access to a"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 35,
        "deletions": 42
    }
}