{
    "author": "aaugustin",
    "message": "Fixed #11555 -- Made SessionBase.session_key read-only. Cleaned up code slightly. Refs #13478.\n\nThis also removes the implicit initialization of the session key on the first access in favor of explicit initialization.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17155 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "bda21e2b9d19f435d841a5ff9f8f636ae843842d",
    "files": [
        {
            "sha": "2d45e71f1c946aad9163198988f69dbb2331e6cc",
            "filename": "django/contrib/sessions/backends/base.py",
            "status": "modified",
            "additions": 14,
            "deletions": 16,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -54,12 +54,6 @@ def __delitem__(self, key):\n         del self._session[key]\n         self.modified = True\n \n-    def keys(self):\n-        return self._session.keys()\n-\n-    def items(self):\n-        return self._session.items()\n-\n     def get(self, key, default=None):\n         return self._session.get(key, default)\n \n@@ -116,9 +110,15 @@ def update(self, dict_):\n     def has_key(self, key):\n         return key in self._session\n \n+    def keys(self):\n+        return self._session.keys()\n+\n     def values(self):\n         return self._session.values()\n \n+    def items(self):\n+        return self._session.items()\n+\n     def iterkeys(self):\n         return self._session.iterkeys()\n \n@@ -145,25 +145,23 @@ def _get_new_session_key(self):\n         except AttributeError:\n             # No getpid() in Jython, for example\n             pid = 1\n-        while 1:\n+        while True:\n             session_key = hashlib.md5(\"%s%s%s%s\"\n                     % (randrange(0, MAX_SESSION_KEY), pid, time.time(),\n                        settings.SECRET_KEY)).hexdigest()\n             if not self.exists(session_key):\n                 break\n         return session_key\n \n-    def _get_session_key(self):\n-        if self._session_key:\n-            return self._session_key\n-        else:\n+    def _get_or_create_session_key(self):\n+        if self._session_key is None:\n             self._session_key = self._get_new_session_key()\n-            return self._session_key\n+        return self._session_key\n \n-    def _set_session_key(self, session_key):\n-        self._session_key = session_key\n+    def _get_session_key(self):\n+        return self._session_key\n \n-    session_key = property(_get_session_key, _set_session_key)\n+    session_key = property(_get_session_key)\n \n     def _get_session(self, no_load=False):\n         \"\"\"\n@@ -174,7 +172,7 @@ def _get_session(self, no_load=False):\n         try:\n             return self._session_cache\n         except AttributeError:\n-            if self._session_key is None or no_load:\n+            if self.session_key is None or no_load:\n                 self._session_cache = {}\n             else:\n                 self._session_cache = self.load()"
        },
        {
            "sha": "ea9e926cfa3e71ab8106ea0781946d257435938f",
            "filename": "django/contrib/sessions/backends/cache.py",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fcache.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -11,8 +11,12 @@ def __init__(self, session_key=None):\n         self._cache = cache\n         super(SessionStore, self).__init__(session_key)\n \n+    @property\n+    def cache_key(self):\n+        return KEY_PREFIX + self._get_or_create_session_key()\n+\n     def load(self):\n-        session_data = self._cache.get(KEY_PREFIX + self.session_key)\n+        session_data = self._cache.get(self.cache_key)\n         if session_data is not None:\n             return session_data\n         self.create()\n@@ -25,7 +29,7 @@ def create(self):\n         # and then raise an exception. That's the risk you shoulder if using\n         # cache backing.\n         for i in xrange(10000):\n-            self.session_key = self._get_new_session_key()\n+            self._session_key = self._get_new_session_key()\n             try:\n                 self.save(must_create=True)\n             except CreateError:\n@@ -39,8 +43,9 @@ def save(self, must_create=False):\n             func = self._cache.add\n         else:\n             func = self._cache.set\n-        result = func(KEY_PREFIX + self.session_key, self._get_session(no_load=must_create),\n-                self.get_expiry_age())\n+        result = func(self.cache_key,\n+                      self._get_session(no_load=must_create),\n+                      self.get_expiry_age())\n         if must_create and not result:\n             raise CreateError\n \n@@ -49,8 +54,7 @@ def exists(self, session_key):\n \n     def delete(self, session_key=None):\n         if session_key is None:\n-            if self._session_key is None:\n+            if self.session_key is None:\n                 return\n-            session_key = self._session_key\n+            session_key = self.session_key\n         self._cache.delete(KEY_PREFIX + session_key)\n-"
        },
        {
            "sha": "580e907c30deb377d578af09c39d6fa143c68834",
            "filename": "django/contrib/sessions/backends/cached_db.py",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -16,25 +16,31 @@ class SessionStore(DBStore):\n     def __init__(self, session_key=None):\n         super(SessionStore, self).__init__(session_key)\n \n+    @property\n+    def cache_key(self):\n+        return KEY_PREFIX + self._get_or_create_session_key()\n+\n     def load(self):\n-        data = cache.get(KEY_PREFIX + self.session_key, None)\n+        data = cache.get(self.cache_key, None)\n         if data is None:\n             data = super(SessionStore, self).load()\n-            cache.set(KEY_PREFIX + self.session_key, data, \n-                      settings.SESSION_COOKIE_AGE)\n+            cache.set(self.cache_key, data, settings.SESSION_COOKIE_AGE)\n         return data\n \n     def exists(self, session_key):\n         return super(SessionStore, self).exists(session_key)\n \n     def save(self, must_create=False):\n         super(SessionStore, self).save(must_create)\n-        cache.set(KEY_PREFIX + self.session_key, self._session, \n-                  settings.SESSION_COOKIE_AGE)\n+        cache.set(self.cache_key, self._session, settings.SESSION_COOKIE_AGE)\n \n     def delete(self, session_key=None):\n         super(SessionStore, self).delete(session_key)\n-        cache.delete(KEY_PREFIX + (session_key or self.session_key))\n+        if session_key is None:\n+            if self.session_key is None:\n+                return\n+            session_key = self.session_key\n+        cache.delete(KEY_PREFIX + session_key)\n \n     def flush(self):\n         \"\"\""
        },
        {
            "sha": "219d97d36841a6ab4a163e80f1d9069a11516f65",
            "filename": "django/contrib/sessions/backends/db.py",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -32,7 +32,7 @@ def exists(self, session_key):\n \n     def create(self):\n         while True:\n-            self.session_key = self._get_new_session_key()\n+            self._session_key = self._get_new_session_key()\n             try:\n                 # Save immediately to ensure we have a unique entry in the\n                 # database.\n@@ -52,9 +52,9 @@ def save(self, must_create=False):\n         entry).\n         \"\"\"\n         obj = Session(\n-            session_key = self.session_key,\n-            session_data = self.encode(self._get_session(no_load=must_create)),\n-            expire_date = self.get_expiry_date()\n+            session_key=self._get_or_create_session_key(),\n+            session_data=self.encode(self._get_session(no_load=must_create)),\n+            expire_date=self.get_expiry_date()\n         )\n         using = router.db_for_write(Session, instance=obj)\n         sid = transaction.savepoint(using=using)\n@@ -68,9 +68,9 @@ def save(self, must_create=False):\n \n     def delete(self, session_key=None):\n         if session_key is None:\n-            if self._session_key is None:\n+            if self.session_key is None:\n                 return\n-            session_key = self._session_key\n+            session_key = self.session_key\n         try:\n             Session.objects.get(session_key=session_key).delete()\n         except Session.DoesNotExist:"
        },
        {
            "sha": "8ffddc4903af78732d51332b16a7c045d9b3523d",
            "filename": "django/contrib/sessions/backends/file.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Ffile.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Ffile.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Ffile.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -33,7 +33,7 @@ def _key_to_file(self, session_key=None):\n         Get the file associated with this session key.\n         \"\"\"\n         if session_key is None:\n-            session_key = self.session_key\n+            session_key = self._get_or_create_session_key()\n \n         # Make sure we're not vulnerable to directory traversal. Session keys\n         # should always be md5s, so they should never contain directory\n@@ -135,9 +135,9 @@ def exists(self, session_key):\n \n     def delete(self, session_key=None):\n         if session_key is None:\n-            if self._session_key is None:\n+            if self.session_key is None:\n                 return\n-            session_key = self._session_key\n+            session_key = self.session_key\n         try:\n             os.unlink(self._key_to_file(session_key))\n         except OSError:"
        },
        {
            "sha": "2a0f261441bb00f9dd8d6f0df15f2da16d183242",
            "filename": "django/contrib/sessions/backends/signed_cookies.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fsigned_cookies.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Fbackends%2Fsigned_cookies.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fsigned_cookies.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -30,7 +30,7 @@ def load(self):\n         raises BadSignature if signature fails.\n         \"\"\"\n         try:\n-            return signing.loads(self._session_key,\n+            return signing.loads(self.session_key,\n                 serializer=PickleSerializer,\n                 max_age=settings.SESSION_COOKIE_AGE,\n                 salt='django.contrib.sessions.backends.signed_cookies')"
        },
        {
            "sha": "f94753cbcfd55de409986567977cb90d470e7934",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -136,6 +136,7 @@ def test_save(self):\n         self.assertTrue(self.session.exists(self.session.session_key))\n \n     def test_delete(self):\n+        self.session.save()\n         self.session.delete(self.session.session_key)\n         self.assertFalse(self.session.exists(self.session.session_key))\n \n@@ -175,6 +176,11 @@ def test_invalid_key(self):\n             # session key; make sure that entry is manually deleted\n             session.delete('1')\n \n+    def test_session_key_is_read_only(self):\n+        def set_session_key(session):\n+            session.session_key = session._get_new_session_key()\n+        self.assertRaises(AttributeError, set_session_key, self.session)\n+\n     # Custom session expiry\n     def test_default_expiry(self):\n         # A normal session has a max age equal to settings\n@@ -360,7 +366,7 @@ def test_httponly_session_cookie(self):\n         response = middleware.process_response(request, response)\n         self.assertTrue(\n             response.cookies[settings.SESSION_COOKIE_NAME]['httponly'])\n-        self.assertIn('httponly', \n+        self.assertIn('httponly',\n             str(response.cookies[settings.SESSION_COOKIE_NAME]))\n \n     @override_settings(SESSION_COOKIE_HTTPONLY=False)\n@@ -375,12 +381,12 @@ def test_no_httponly_session_cookie(self):\n \n         # Handle the response through the middleware\n         response = middleware.process_response(request, response)\n-        #if it isn't in the cookie, that's fine (Python 2.5). \n+        # If it isn't in the cookie, that's fine (Python 2.5)\n         if 'httponly' in settings.SESSION_COOKIE_NAME:\n             self.assertFalse(\n                response.cookies[settings.SESSION_COOKIE_NAME]['httponly'])\n \n-        self.assertNotIn('httponly', \n+        self.assertNotIn('httponly',\n                          str(response.cookies[settings.SESSION_COOKIE_NAME]))\n \n class CookieSessionTests(SessionTestsMixin, TestCase):"
        },
        {
            "sha": "665729cf00eb93200fdc7fd520ea5c0405ca3c4d",
            "filename": "tests/regressiontests/test_client_regress/session.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/bda21e2b9d19f435d841a5ff9f8f636ae843842d/tests%2Fregressiontests%2Ftest_client_regress%2Fsession.py",
            "raw_url": "https://github.com/django/django/raw/bda21e2b9d19f435d841a5ff9f8f636ae843842d/tests%2Fregressiontests%2Ftest_client_regress%2Fsession.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Fsession.py?ref=bda21e2b9d19f435d841a5ff9f8f636ae843842d",
            "patch": "@@ -14,13 +14,13 @@ def exists(self, session_key):\n         return False\n \n     def create(self):\n-        self.session_key = self.encode({})\n+        self._session_key = self.encode({})\n \n     def save(self, must_create=False):\n-        self.session_key = self.encode(self._session)\n+        self._session_key = self.encode(self._session)\n \n     def delete(self, session_key=None):\n-        self.session_key = self.encode({})\n+        self._session_key = self.encode({})\n \n     def load(self):\n         try:"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 59,
        "deletions": 45
    }
}