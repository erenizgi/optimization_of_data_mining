{
    "author": "freakboy3742",
    "message": "Fixed #8528 -- Ensure that null values are displayed as a filtering option in the admin if a field allows nulls. Thanks to StevenPotter for the report, and oyvind, marcob, Simon Meers and Julien Phalip for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15649 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b",
    "files": [
        {
            "sha": "d887af2b124ccd1420af5b34e99eb5638f1735de",
            "filename": "django/contrib/admin/filterspecs.py",
            "status": "modified",
            "additions": 78,
            "deletions": 19,
            "changes": 97,
            "blob_url": "https://github.com/django/django/blob/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/django%2Fcontrib%2Fadmin%2Ffilterspecs.py",
            "raw_url": "https://github.com/django/django/raw/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/django%2Fcontrib%2Fadmin%2Ffilterspecs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilterspecs.py?ref=4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b",
            "patch": "@@ -76,23 +76,46 @@ def __init__(self, f, request, params, model, model_admin,\n             self.lookup_title = f.verbose_name # use field name\n         rel_name = other_model._meta.pk.name\n         self.lookup_kwarg = '%s__%s__exact' % (self.field_path, rel_name)\n+        self.lookup_kwarg_isnull = '%s__isnull' % (self.field_path)\n         self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n+        self.lookup_val_isnull = request.GET.get(\n+                                      self.lookup_kwarg_isnull, None)\n         self.lookup_choices = f.get_choices(include_blank=False)\n \n     def has_output(self):\n-        return len(self.lookup_choices) > 1\n+        if isinstance(self.field, models.related.RelatedObject) \\\n+           and self.field.field.null or hasattr(self.field, 'rel') \\\n+           and self.field.null:\n+            extra = 1\n+        else:\n+            extra = 0\n+        return len(self.lookup_choices) + extra > 1\n \n     def title(self):\n         return self.lookup_title\n \n     def choices(self, cl):\n-        yield {'selected': self.lookup_val is None,\n-               'query_string': cl.get_query_string({}, [self.lookup_kwarg]),\n+        from django.contrib.admin.views.main import EMPTY_CHANGELIST_VALUE\n+        yield {'selected': self.lookup_val is None\n+                           and not self.lookup_val_isnull,\n+               'query_string': cl.get_query_string(\n+                               {},\n+                               [self.lookup_kwarg, self.lookup_kwarg_isnull]),\n                'display': _('All')}\n         for pk_val, val in self.lookup_choices:\n             yield {'selected': self.lookup_val == smart_unicode(pk_val),\n-                   'query_string': cl.get_query_string({self.lookup_kwarg: pk_val}),\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg: pk_val},\n+                                   [self.lookup_kwarg_isnull]),\n                    'display': val}\n+        if isinstance(self.field, models.related.RelatedObject) \\\n+           and self.field.field.null or hasattr(self.field, 'rel') \\\n+           and self.field.null:\n+            yield {'selected': bool(self.lookup_val_isnull),\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg_isnull: 'True'},\n+                                   [self.lookup_kwarg]),\n+                   'display': EMPTY_CHANGELIST_VALUE}\n \n FilterSpec.register(lambda f: (\n         hasattr(f, 'rel') and bool(f.rel) or\n@@ -113,7 +136,8 @@ def choices(self, cl):\n                'display': _('All')}\n         for k, v in self.field.flatchoices:\n             yield {'selected': smart_unicode(k) == self.lookup_val,\n-                    'query_string': cl.get_query_string({self.lookup_kwarg: k}),\n+                    'query_string': cl.get_query_string(\n+                                    {self.lookup_kwarg: k}),\n                     'display': v}\n \n FilterSpec.register(lambda f: bool(f.choices), ChoicesFilterSpec)\n@@ -127,11 +151,14 @@ def __init__(self, f, request, params, model, model_admin,\n \n         self.field_generic = '%s__' % self.field_path\n \n-        self.date_params = dict([(k, v) for k, v in params.items() if k.startswith(self.field_generic)])\n+        self.date_params = dict([(k, v) for k, v in params.items()\n+                                 if k.startswith(self.field_generic)])\n \n         today = datetime.date.today()\n         one_week_ago = today - datetime.timedelta(days=7)\n-        today_str = isinstance(self.field, models.DateTimeField) and today.strftime('%Y-%m-%d 23:59:59') or today.strftime('%Y-%m-%d')\n+        today_str = isinstance(self.field, models.DateTimeField) \\\n+                    and today.strftime('%Y-%m-%d 23:59:59') \\\n+                    or today.strftime('%Y-%m-%d')\n \n         self.links = (\n             (_('Any date'), {}),\n@@ -152,10 +179,13 @@ def title(self):\n     def choices(self, cl):\n         for title, param_dict in self.links:\n             yield {'selected': self.date_params == param_dict,\n-                   'query_string': cl.get_query_string(param_dict, [self.field_generic]),\n+                   'query_string': cl.get_query_string(\n+                                   param_dict,\n+                                   [self.field_generic]),\n                    'display': title}\n \n-FilterSpec.register(lambda f: isinstance(f, models.DateField), DateFieldFilterSpec)\n+FilterSpec.register(lambda f: isinstance(f, models.DateField),\n+                              DateFieldFilterSpec)\n \n class BooleanFieldFilterSpec(FilterSpec):\n     def __init__(self, f, request, params, model, model_admin,\n@@ -174,14 +204,20 @@ def title(self):\n     def choices(self, cl):\n         for k, v in ((_('All'), None), (_('Yes'), '1'), (_('No'), '0')):\n             yield {'selected': self.lookup_val == v and not self.lookup_val2,\n-                   'query_string': cl.get_query_string({self.lookup_kwarg: v}, [self.lookup_kwarg2]),\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg: v},\n+                                   [self.lookup_kwarg2]),\n                    'display': k}\n         if isinstance(self.field, models.NullBooleanField):\n             yield {'selected': self.lookup_val2 == 'True',\n-                   'query_string': cl.get_query_string({self.lookup_kwarg2: 'True'}, [self.lookup_kwarg]),\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg2: 'True'},\n+                                   [self.lookup_kwarg]),\n                    'display': _('Unknown')}\n \n-FilterSpec.register(lambda f: isinstance(f, models.BooleanField) or isinstance(f, models.NullBooleanField), BooleanFieldFilterSpec)\n+FilterSpec.register(lambda f: isinstance(f, models.BooleanField)\n+                              or isinstance(f, models.NullBooleanField),\n+                                 BooleanFieldFilterSpec)\n \n # This should be registered last, because it's a last resort. For example,\n # if a field is eligible to use the BooleanFieldFilterSpec, that'd be much\n@@ -192,8 +228,12 @@ def __init__(self, f, request, params, model, model_admin,\n         super(AllValuesFilterSpec, self).__init__(f, request, params, model,\n                                                   model_admin,\n                                                   field_path=field_path)\n-        self.lookup_val = request.GET.get(self.field_path, None)\n-        parent_model, reverse_path = reverse_field_path(model, field_path)\n+        self.lookup_kwarg = self.field_path\n+        self.lookup_kwarg_isnull = '%s__isnull' % self.field_path\n+        self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n+        self.lookup_val_isnull = request.GET.get(self.lookup_kwarg_isnull,\n+                                                 None)\n+        parent_model, reverse_path = reverse_field_path(model, self.field_path)\n         queryset = parent_model._default_manager.all()\n         # optional feature: limit choices base on existing relationships\n         # queryset = queryset.complex_filter(\n@@ -202,18 +242,37 @@ def __init__(self, f, request, params, model, model_admin,\n         queryset = queryset.filter(limit_choices_to)\n \n         self.lookup_choices = \\\n-            queryset.distinct().order_by(f.name).values(f.name)\n+            queryset.distinct().order_by(f.name).values_list(f.name, flat=True)\n \n     def title(self):\n         return self.field.verbose_name\n \n     def choices(self, cl):\n-        yield {'selected': self.lookup_val is None,\n-               'query_string': cl.get_query_string({}, [self.field_path]),\n+        from django.contrib.admin.views.main import EMPTY_CHANGELIST_VALUE\n+        yield {'selected': self.lookup_val is None\n+                           and self.lookup_val_isnull is None,\n+               'query_string': cl.get_query_string(\n+                               {},\n+                               [self.lookup_kwarg, self.lookup_kwarg_isnull]),\n                'display': _('All')}\n+        include_none = False\n+\n         for val in self.lookup_choices:\n-            val = smart_unicode(val[self.field.name])\n+            if val is None:\n+                include_none = True\n+                continue\n+            val = smart_unicode(val)\n+\n             yield {'selected': self.lookup_val == val,\n-                   'query_string': cl.get_query_string({self.field_path: val}),\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg: val},\n+                                   [self.lookup_kwarg_isnull]),\n                    'display': val}\n+        if include_none:\n+            yield {'selected': bool(self.lookup_val_isnull),\n+                    'query_string': cl.get_query_string(\n+                                    {self.lookup_kwarg_isnull: 'True'},\n+                                    [self.lookup_kwarg]),\n+                    'display': EMPTY_CHANGELIST_VALUE}\n+\n FilterSpec.register(lambda f: True, AllValuesFilterSpec)"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/admin_filterspecs/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/tests%2Fregressiontests%2Fadmin_filterspecs%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/tests%2Fregressiontests%2Fadmin_filterspecs%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filterspecs%2F__init__.py?ref=4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b"
        },
        {
            "sha": "fe9fdfe1bdff99653f7e64f1e4575400d91261fe",
            "filename": "tests/regressiontests/admin_filterspecs/models.py",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/tests%2Fregressiontests%2Fadmin_filterspecs%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/tests%2Fregressiontests%2Fadmin_filterspecs%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filterspecs%2Fmodels.py?ref=4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b",
            "patch": "@@ -0,0 +1,11 @@\n+from django.db import models\n+from django.contrib.auth.models import User\n+\n+class Book(models.Model):\n+    title = models.CharField(max_length=25)\n+    year = models.PositiveIntegerField(null=True, blank=True)\n+    author = models.ForeignKey(User, related_name='books_authored', blank=True, null=True)\n+    contributors = models.ManyToManyField(User, related_name='books_contributed', blank=True, null=True)\n+\n+    def __unicode__(self):\n+        return self.title"
        },
        {
            "sha": "64a6ac700ed90e71e0b3ea2025a1f499c76095da",
            "filename": "tests/regressiontests/admin_filterspecs/tests.py",
            "status": "added",
            "additions": 171,
            "deletions": 0,
            "changes": 171,
            "blob_url": "https://github.com/django/django/blob/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py?ref=4d70d48ecbfe2b972c55c3b4fa1237dfe54f5b6b",
            "patch": "@@ -0,0 +1,171 @@\n+from django.contrib.auth.admin import UserAdmin\n+from django.test import TestCase\n+from django.test.client import RequestFactory\n+from django.contrib.auth.models import User\n+from django.contrib import admin\n+from django.contrib.admin.views.main import ChangeList\n+from django.utils.encoding import force_unicode\n+\n+from models import Book\n+\n+class FilterSpecsTests(TestCase):\n+\n+    def setUp(self):\n+        # Users\n+        alfred = User.objects.create_user('alfred', 'alfred@example.com')\n+        bob = User.objects.create_user('bob', 'alfred@example.com')\n+        lisa = User.objects.create_user('lisa', 'lisa@example.com')\n+\n+        #Books\n+        bio_book = Book.objects.create(title='Django: a biography', year=1999, author=alfred)\n+        django_book = Book.objects.create(title='The Django Book', year=None, author=bob)\n+        gipsy_book = Book.objects.create(title='Gipsy guitar for dummies', year=2002)\n+        gipsy_book.contributors = [bob, lisa]\n+        gipsy_book.save()\n+\n+        self.request_factory = RequestFactory()\n+\n+\n+    def get_changelist(self, request, model, modeladmin):\n+        return ChangeList(request, model, modeladmin.list_display, modeladmin.list_display_links,\n+            modeladmin.list_filter, modeladmin.date_hierarchy, modeladmin.search_fields,\n+            modeladmin.list_select_related, modeladmin.list_per_page, modeladmin.list_editable, modeladmin)\n+\n+    def test_AllValuesFilterSpec(self):\n+        modeladmin = BookAdmin(Book, admin.site)\n+\n+        request = self.request_factory.get('/', {'year__isnull': 'True'})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        # Make sure changelist.get_query_set() does not raise IncorrectLookupParameters\n+        queryset = changelist.get_query_set()\n+\n+        # Make sure the last choice is None and is selected\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEquals(force_unicode(filterspec.title()), u'year')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[-1]['selected'], True)\n+        self.assertEquals(choices[-1]['query_string'], '?year__isnull=True')\n+\n+        request = self.request_factory.get('/', {'year': '2002'})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEquals(force_unicode(filterspec.title()), u'year')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[2]['selected'], True)\n+        self.assertEquals(choices[2]['query_string'], '?year=2002')\n+\n+    def test_RelatedFilterSpec_ForeignKey(self):\n+        modeladmin = BookAdmin(Book, admin.site)\n+\n+        request = self.request_factory.get('/', {'author__isnull': 'True'})\n+        changelist = ChangeList(request, Book, modeladmin.list_display, modeladmin.list_display_links,\n+            modeladmin.list_filter, modeladmin.date_hierarchy, modeladmin.search_fields,\n+            modeladmin.list_select_related, modeladmin.list_per_page, modeladmin.list_editable, modeladmin)\n+\n+        # Make sure changelist.get_query_set() does not raise IncorrectLookupParameters\n+        queryset = changelist.get_query_set()\n+\n+        # Make sure the last choice is None and is selected\n+        filterspec = changelist.get_filters(request)[0][1]\n+        self.assertEquals(force_unicode(filterspec.title()), u'author')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[-1]['selected'], True)\n+        self.assertEquals(choices[-1]['query_string'], '?author__isnull=True')\n+\n+        request = self.request_factory.get('/', {'author__id__exact': '1'})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][1]\n+        self.assertEquals(force_unicode(filterspec.title()), u'author')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[1]['selected'], True)\n+        self.assertEquals(choices[1]['query_string'], '?author__id__exact=1')\n+\n+    def test_RelatedFilterSpec_ManyToMany(self):\n+        modeladmin = BookAdmin(Book, admin.site)\n+\n+        request = self.request_factory.get('/', {'contributors__isnull': 'True'})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        # Make sure changelist.get_query_set() does not raise IncorrectLookupParameters\n+        queryset = changelist.get_query_set()\n+\n+        # Make sure the last choice is None and is selected\n+        filterspec = changelist.get_filters(request)[0][2]\n+        self.assertEquals(force_unicode(filterspec.title()), u'user')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[-1]['selected'], True)\n+        self.assertEquals(choices[-1]['query_string'], '?contributors__isnull=True')\n+\n+        request = self.request_factory.get('/', {'contributors__id__exact': '2'})\n+        changelist = self.get_changelist(request, Book, modeladmin)\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][2]\n+        self.assertEquals(force_unicode(filterspec.title()), u'user')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[2]['selected'], True)\n+        self.assertEquals(choices[2]['query_string'], '?contributors__id__exact=2')\n+\n+\n+    def test_RelatedFilterSpec_reverse_relationships(self):\n+        modeladmin = CustomUserAdmin(User, admin.site)\n+\n+        # FK relationship -----\n+        request = self.request_factory.get('/', {'books_authored__isnull': 'True'})\n+        changelist = self.get_changelist(request, User, modeladmin)\n+\n+        # Make sure changelist.get_query_set() does not raise IncorrectLookupParameters\n+        queryset = changelist.get_query_set()\n+\n+        # Make sure the last choice is None and is selected\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEquals(force_unicode(filterspec.title()), u'book')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[-1]['selected'], True)\n+        self.assertEquals(choices[-1]['query_string'], '?books_authored__isnull=True')\n+\n+        request = self.request_factory.get('/', {'books_authored__id__exact': '1'})\n+        changelist = self.get_changelist(request, User, modeladmin)\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEquals(force_unicode(filterspec.title()), u'book')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[1]['selected'], True)\n+        self.assertEquals(choices[1]['query_string'], '?books_authored__id__exact=1')\n+\n+        # M2M relationship -----\n+        request = self.request_factory.get('/', {'books_contributed__isnull': 'True'})\n+        changelist = self.get_changelist(request, User, modeladmin)\n+\n+        # Make sure changelist.get_query_set() does not raise IncorrectLookupParameters\n+        queryset = changelist.get_query_set()\n+\n+        # Make sure the last choice is None and is selected\n+        filterspec = changelist.get_filters(request)[0][1]\n+        self.assertEquals(force_unicode(filterspec.title()), u'book')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[-1]['selected'], True)\n+        self.assertEquals(choices[-1]['query_string'], '?books_contributed__isnull=True')\n+\n+        request = self.request_factory.get('/', {'books_contributed__id__exact': '2'})\n+        changelist = self.get_changelist(request, User, modeladmin)\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][1]\n+        self.assertEquals(force_unicode(filterspec.title()), u'book')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEquals(choices[2]['selected'], True)\n+        self.assertEquals(choices[2]['query_string'], '?books_contributed__id__exact=2')\n+\n+class CustomUserAdmin(UserAdmin):\n+    list_filter = ('books_authored', 'books_contributed')\n+\n+class BookAdmin(admin.ModelAdmin):\n+    list_filter = ('year', 'author', 'contributors')\n+    order_by = '-id'"
        }
    ],
    "stats": {
        "total": 279,
        "additions": 260,
        "deletions": 19
    }
}