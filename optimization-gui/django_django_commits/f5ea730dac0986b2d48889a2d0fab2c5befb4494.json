{
    "author": "claudep",
    "message": "Fixed #18843 -- Replaced more special chars in column names (inspectdb)\n\nThanks airstrike for the report.",
    "sha": "f5ea730dac0986b2d48889a2d0fab2c5befb4494",
    "files": [
        {
            "sha": "936d5e89abf5582905ea4ab15ecb654d878ff8cc",
            "filename": "django/core/management/commands/inspectdb.py",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/f5ea730dac0986b2d48889a2d0fab2c5befb4494/django%2Fcore%2Fmanagement%2Fcommands%2Finspectdb.py",
            "raw_url": "https://github.com/django/django/raw/f5ea730dac0986b2d48889a2d0fab2c5befb4494/django%2Fcore%2Fmanagement%2Fcommands%2Finspectdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Finspectdb.py?ref=f5ea730dac0986b2d48889a2d0fab2c5befb4494",
            "patch": "@@ -1,6 +1,7 @@\n from __future__ import unicode_literals\n \n import keyword\n+import re\n from optparse import make_option\n \n from django.core.management.base import NoArgsCommand, CommandError\n@@ -142,18 +143,16 @@ def normalize_col_name(self, col_name, used_column_names, is_relation):\n             else:\n                 field_params['db_column'] = col_name\n \n-        if ' ' in new_name:\n-            new_name = new_name.replace(' ', '_')\n-            field_notes.append('Field renamed to remove spaces.')\n-\n-        if '-' in new_name:\n-            new_name = new_name.replace('-', '_')\n-            field_notes.append('Field renamed to remove dashes.')\n+        new_name, num_repl = re.subn(r'\\W', '_', new_name)\n+        if num_repl > 0:\n+            field_notes.append('Field renamed to remove unsuitable characters.')\n \n         if new_name.find('__') >= 0:\n             while new_name.find('__') >= 0:\n                 new_name = new_name.replace('__', '_')\n-            field_notes.append(\"Field renamed because it contained more than one '_' in a row.\")\n+            if col_name.lower().find('__') >= 0:\n+                # Only add the comment if the double underscore was in the original name\n+                field_notes.append(\"Field renamed because it contained more than one '_' in a row.\")\n \n         if new_name.startswith('_'):\n             new_name = 'field%s' % new_name"
        },
        {
            "sha": "4a6621402f234f3fdc7fa1eaa2b3d49d82b761e1",
            "filename": "tests/regressiontests/inspectdb/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/f5ea730dac0986b2d48889a2d0fab2c5befb4494/tests%2Fregressiontests%2Finspectdb%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f5ea730dac0986b2d48889a2d0fab2c5befb4494/tests%2Fregressiontests%2Finspectdb%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finspectdb%2Fmodels.py?ref=f5ea730dac0986b2d48889a2d0fab2c5befb4494",
            "patch": "@@ -20,8 +20,11 @@ class DigitsInColumnName(models.Model):\n     leading_digit = models.CharField(max_length=11, db_column='4extra')\n     leading_digits = models.CharField(max_length=11, db_column='45extra')\n \n-class UnderscoresInColumnName(models.Model):\n+class SpecialColumnName(models.Model):\n     field = models.IntegerField(db_column='field')\n+    # Underscores\n     field_field_0 = models.IntegerField(db_column='Field_')\n     field_field_1 = models.IntegerField(db_column='Field__')\n     field_field_2 = models.IntegerField(db_column='__field')\n+    # Other chars\n+    prc_x = models.IntegerField(db_column='prc(%) x')"
        },
        {
            "sha": "484e7f40603bd9223b7315e217da063fb5b729b4",
            "filename": "tests/regressiontests/inspectdb/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f5ea730dac0986b2d48889a2d0fab2c5befb4494/tests%2Fregressiontests%2Finspectdb%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f5ea730dac0986b2d48889a2d0fab2c5befb4494/tests%2Fregressiontests%2Finspectdb%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finspectdb%2Ftests.py?ref=f5ea730dac0986b2d48889a2d0fab2c5befb4494",
            "patch": "@@ -59,12 +59,15 @@ def test_digits_column_name_introspection(self):\n         self.assertNotIn(\"    45extra = models.CharField\", output, msg=error_message)\n         self.assertIn(\"number_45extra = models.CharField\", output)\n \n-    def test_underscores_column_name_introspection(self):\n-        \"\"\"Introspection of column names containing underscores (#12460)\"\"\"\n+    def test_special_column_name_introspection(self):\n+        \"\"\"Introspection of column names containing special characters,\n+           unsuitable for Python identifiers\n+        \"\"\"\n         out = StringIO()\n         call_command('inspectdb', stdout=out)\n         output = out.getvalue()\n         self.assertIn(\"field = models.IntegerField()\", output)\n         self.assertIn(\"field_field = models.IntegerField(db_column='Field_')\", output)\n         self.assertIn(\"field_field_0 = models.IntegerField(db_column='Field__')\", output)\n         self.assertIn(\"field_field_1 = models.IntegerField(db_column='__field')\", output)\n+        self.assertIn(\"prc_x = models.IntegerField(db_column='prc(%) x')\", output)"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 16,
        "deletions": 11
    }
}