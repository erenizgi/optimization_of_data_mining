{
    "author": "hannesstruss",
    "message": "Fixed #19325 - Made email backend of AdminEmailHandler configurable",
    "sha": "f9891f20872e2a468c4910a968c5e2fae75d0e51",
    "files": [
        {
            "sha": "43406da7d7e8f8979bcff56c9e267c861f65f9b2",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/f9891f20872e2a468c4910a968c5e2fae75d0e51/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/f9891f20872e2a468c4910a968c5e2fae75d0e51/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=f9891f20872e2a468c4910a968c5e2fae75d0e51",
            "patch": "@@ -588,6 +588,7 @@ answer newbie questions, and generally made Django that much better:\n     Gasper Zejn <zejn@kiberpipa.org>\n     Jarek Zgoda <jarek.zgoda@gmail.com>\n     Cheng Zhang\n+    Hannes Stru√ü <x@hannesstruss.de>\n \n A big THANK YOU goes to:\n "
        },
        {
            "sha": "736154a178308dcadc022ad524cc72f8263eed1c",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/f9891f20872e2a468c4910a968c5e2fae75d0e51/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/f9891f20872e2a468c4910a968c5e2fae75d0e51/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=f9891f20872e2a468c4910a968c5e2fae75d0e51",
            "patch": "@@ -3,6 +3,7 @@\n \n from django.conf import settings\n from django.core import mail\n+from django.core.mail import get_connection\n from django.views.debug import ExceptionReporter, get_exception_reporter_filter\n \n \n@@ -76,9 +77,10 @@ class AdminEmailHandler(logging.Handler):\n     request data will be provided in the email report.\n     \"\"\"\n \n-    def __init__(self, include_html=False):\n+    def __init__(self, include_html=False, email_backend=None):\n         logging.Handler.__init__(self)\n         self.include_html = include_html\n+        self.email_backend = email_backend\n \n     def emit(self, record):\n         try:\n@@ -110,7 +112,12 @@ def emit(self, record):\n         message = \"%s\\n\\n%s\" % (stack_trace, request_repr)\n         reporter = ExceptionReporter(request, is_email=True, *exc_info)\n         html_message = self.include_html and reporter.get_traceback_html() or None\n-        mail.mail_admins(subject, message, fail_silently=True, html_message=html_message)\n+        mail.mail_admins(subject, message, fail_silently=True,\n+                         html_message=html_message,\n+                         connection=self.connection())\n+\n+    def connection(self):\n+        return get_connection(backend=self.email_backend)\n \n     def format_subject(self, subject):\n         \"\"\""
        },
        {
            "sha": "c2503bbde4ab1438f2c1d34520d1ec56134c7ae0",
            "filename": "docs/topics/logging.txt",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/f9891f20872e2a468c4910a968c5e2fae75d0e51/docs%2Ftopics%2Flogging.txt",
            "raw_url": "https://github.com/django/django/raw/f9891f20872e2a468c4910a968c5e2fae75d0e51/docs%2Ftopics%2Flogging.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Flogging.txt?ref=f9891f20872e2a468c4910a968c5e2fae75d0e51",
            "patch": "@@ -440,7 +440,7 @@ Handlers\n Django provides one log handler in addition to those provided by the\n Python logging module.\n \n-.. class:: AdminEmailHandler([include_html=False])\n+.. class:: AdminEmailHandler(include_html=False, email_backend=None)\n \n     This handler sends an email to the site admins for each log\n     message it receives.\n@@ -476,6 +476,23 @@ Python logging module.\n     sensitive information to be filtered out of error reports -- learn more on\n     :ref:`Filtering error reports<filtering-error-reports>`.\n \n+    .. versionadded:: 1.5\n+\n+    By setting the ``email_backend`` argument of ``AdminEmailHandler``, the\n+    :ref:`email backend <topic-email-backends>` that is being used by the\n+    handler can be overridden, like this::\n+\n+        'handlers': {\n+            'mail_admins': {\n+                'level': 'ERROR',\n+                'class': 'django.utils.log.AdminEmailHandler',\n+                'email_backend': 'django.core.mail.backends.filebased.EmailBackend',\n+            }\n+        },\n+\n+    By default, an instance of the email backend specified in\n+    :setting:`EMAIL_BACKEND` will be used.\n+\n .. _Sentry: http://pypi.python.org/pypi/sentry\n \n "
        },
        {
            "sha": "b068103eb9ac75d3928eb7b0be0965027f6523ab",
            "filename": "tests/regressiontests/logging_tests/logconfig.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f9891f20872e2a468c4910a968c5e2fae75d0e51/tests%2Fregressiontests%2Flogging_tests%2Flogconfig.py",
            "raw_url": "https://github.com/django/django/raw/f9891f20872e2a468c4910a968c5e2fae75d0e51/tests%2Fregressiontests%2Flogging_tests%2Flogconfig.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Flogconfig.py?ref=f9891f20872e2a468c4910a968c5e2fae75d0e51",
            "patch": "@@ -1,8 +1,15 @@\n import logging\n \n from django.conf import settings\n+from django.core.mail.backends.base import BaseEmailBackend\n+\n \n class MyHandler(logging.Handler):\n     def __init__(self):\n         logging.Handler.__init__(self)\n         self.config = settings.LOGGING\n+\n+\n+class MyEmailBackend(BaseEmailBackend):\n+    def send_messages(self, email_messages):\n+        pass"
        },
        {
            "sha": "19ee06eccc370748e6da086d2b267cf7524d30e2",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/f9891f20872e2a468c4910a968c5e2fae75d0e51/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f9891f20872e2a468c4910a968c5e2fae75d0e51/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=f9891f20872e2a468c4910a968c5e2fae75d0e51",
            "patch": "@@ -15,6 +15,8 @@\n \n from ..admin_scripts.tests import AdminScriptTestCase\n \n+from .logconfig import MyEmailBackend\n+\n PYVERS = sys.version_info[:2]\n \n # logging config prior to using filter with mail_admins\n@@ -305,6 +307,38 @@ def test_truncate_subject(self):\n         self.assertEqual(len(mail.outbox), 1)\n         self.assertEqual(mail.outbox[0].subject, expected_subject)\n \n+    @override_settings(\n+            ADMINS=(('admin', 'admin@example.com'),),\n+            DEBUG=False,\n+        )\n+    def test_uses_custom_email_backend(self):\n+        \"\"\"\n+        Refs #19325\n+        \"\"\"\n+        message = 'All work and no play makes Jack a dull boy'\n+        admin_email_handler = self.get_admin_email_handler(self.logger)\n+        mail_admins_called = {'called': False}\n+\n+        def my_mail_admins(*args, **kwargs):\n+            connection = kwargs['connection']\n+            self.assertTrue(isinstance(connection, MyEmailBackend))\n+            mail_admins_called['called'] = True\n+\n+        # Monkeypatches\n+        orig_mail_admins = mail.mail_admins\n+        orig_email_backend = admin_email_handler.email_backend\n+        mail.mail_admins = my_mail_admins\n+        admin_email_handler.email_backend = (\n+            'regressiontests.logging_tests.logconfig.MyEmailBackend')\n+\n+        try:\n+            self.logger.error(message)\n+            self.assertTrue(mail_admins_called['called'])\n+        finally:\n+            # Revert Monkeypatches\n+            mail.mail_admins = orig_mail_admins\n+            admin_email_handler.email_backend = orig_email_backend\n+\n \n class SettingsConfigTest(AdminScriptTestCase):\n     \"\"\""
        }
    ],
    "stats": {
        "total": 72,
        "additions": 69,
        "deletions": 3
    }
}