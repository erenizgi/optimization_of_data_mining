{
    "author": "claudep",
    "message": "Fixed #18417 -- Raised exception when unittest.TestCase is decorated with override_settings",
    "sha": "9f7cefd5059e78d75f1e1a852b51a6286ecec728",
    "files": [
        {
            "sha": "99ef6b9fa2ed43cfa6b8dc69d11606646c72d4b1",
            "filename": "django/test/utils.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/9f7cefd5059e78d75f1e1a852b51a6286ecec728/django%2Ftest%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/9f7cefd5059e78d75f1e1a852b51a6286ecec728/django%2Ftest%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Futils.py?ref=9f7cefd5059e78d75f1e1a852b51a6286ecec728",
            "patch": "@@ -188,7 +188,11 @@ def __exit__(self, exc_type, exc_value, traceback):\n \n     def __call__(self, test_func):\n         from django.test import TransactionTestCase\n-        if isinstance(test_func, type) and issubclass(test_func, TransactionTestCase):\n+        if isinstance(test_func, type):\n+            if not issubclass(test_func, TransactionTestCase):\n+                raise Exception(\n+                    \"Only subclasses of Django TransactionTestCase can be decorated \"\n+                    \"with override_settings\")\n             original_pre_setup = test_func._pre_setup\n             original_post_teardown = test_func._post_teardown\n "
        },
        {
            "sha": "45190daa2306de44925aa10b97fe8d1ff56af64a",
            "filename": "tests/regressiontests/settings_tests/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/9f7cefd5059e78d75f1e1a852b51a6286ecec728/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9f7cefd5059e78d75f1e1a852b51a6286ecec728/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py?ref=9f7cefd5059e78d75f1e1a852b51a6286ecec728",
            "patch": "@@ -6,6 +6,7 @@\n from django.http import HttpRequest\n from django.test import TransactionTestCase, TestCase, signals\n from django.test.utils import override_settings\n+from django.utils import unittest, six\n \n \n @override_settings(TEST='override')\n@@ -67,11 +68,6 @@ def test_max_recursion_error(self):\n             self.fail()\n \n \n-class SettingGetter(object):\n-    def __init__(self):\n-        self.test = getattr(settings, 'TEST', 'undefined')\n-\n-\n class SettingsTests(TestCase):\n     def setUp(self):\n         self.testvalue = None\n@@ -122,10 +118,20 @@ def test_context_manager(self):\n         self.assertRaises(AttributeError, getattr, settings, 'TEST')\n \n     def test_class_decorator(self):\n-        self.assertEqual(SettingGetter().test, 'undefined')\n-        DecoratedSettingGetter = override_settings(TEST='override')(SettingGetter)\n-        self.assertEqual(DecoratedSettingGetter().test, 'override')\n-        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+        # TransactionTestCase can be decorated by override_settings, but not ut.TestCase\n+        class TransactionTestCaseSubclass(TransactionTestCase):\n+            pass\n+\n+        class UnittestTestCaseSubclass(unittest.TestCase):\n+            pass\n+\n+        decorated = override_settings(TEST='override')(TransactionTestCaseSubclass)\n+        self.assertIsInstance(decorated, type)\n+        self.assertTrue(issubclass(decorated, TransactionTestCase))\n+\n+        with six.assertRaisesRegex(self, Exception,\n+                \"Only subclasses of Django TransactionTestCase*\"):\n+            decorated = override_settings(TEST='override')(UnittestTestCaseSubclass)\n \n     def test_signal_callback_context_manager(self):\n         self.assertRaises(AttributeError, getattr, settings, 'TEST')"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 20,
        "deletions": 10
    }
}