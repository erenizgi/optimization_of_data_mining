{
    "author": "jezdez",
    "message": "Fixed #14674 -- Prevent user accounts with an unusable password from resetting passwords. Thanks, summerisgone, thejaswi_puthraya and lrekucki.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16455 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2619dc828510cf36791fcf87705d2f9ce3176c86",
    "files": [
        {
            "sha": "763983c978ab2a6afd41bfd4208c13f51122ea14",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/2619dc828510cf36791fcf87705d2f9ce3176c86/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/2619dc828510cf36791fcf87705d2f9ce3176c86/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=2619dc828510cf36791fcf87705d2f9ce3176c86",
            "patch": "@@ -1,11 +1,14 @@\n-from django.contrib.auth.models import User\n+from django import forms\n+from django.template import Context, loader\n+from django.utils.http import int_to_base36\n+from django.utils.itercompat import any\n+from django.utils.translation import ugettext_lazy as _\n+\n+from django.contrib.auth.models import User, UNUSABLE_PASSWORD\n from django.contrib.auth import authenticate\n from django.contrib.auth.tokens import default_token_generator\n from django.contrib.sites.models import get_current_site\n-from django.template import Context, loader\n-from django import forms\n-from django.utils.translation import ugettext_lazy as _\n-from django.utils.http import int_to_base36\n+\n \n class UserCreationForm(forms.ModelForm):\n     \"\"\"\n@@ -114,10 +117,11 @@ def clean_email(self):\n         email = self.cleaned_data[\"email\"]\n         self.users_cache = User.objects.filter(\n                                 email__iexact=email,\n-                                is_active=True\n-                            )\n-        if len(self.users_cache) == 0:\n+                                is_active=True)\n+        if not len(self.users_cache):\n             raise forms.ValidationError(_(\"That e-mail address doesn't have an associated user account. Are you sure you've registered?\"))\n+        if any((user.password == UNUSABLE_PASSWORD) for user in self.users_cache):\n+            raise forms.ValidationError(_(\"The user account associated with this e-mail address cannot reset the password.\"))\n         return email\n \n     def save(self, domain_override=None,"
        },
        {
            "sha": "1bee6bd5ab5bb4a466016cfe0c9ee8d81b29b424",
            "filename": "django/contrib/auth/locale/en/LC_MESSAGES/django.po",
            "status": "modified",
            "additions": 50,
            "deletions": 44,
            "changes": 94,
            "blob_url": "https://github.com/django/django/blob/2619dc828510cf36791fcf87705d2f9ce3176c86/django%2Fcontrib%2Fauth%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/2619dc828510cf36791fcf87705d2f9ce3176c86/django%2Fcontrib%2Fauth%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po?ref=2619dc828510cf36791fcf87705d2f9ce3176c86",
            "patch": "@@ -4,7 +4,7 @@ msgid \"\"\n msgstr \"\"\n \"Project-Id-Version: Django\\n\"\n \"Report-Msgid-Bugs-To: \\n\"\n-\"POT-Creation-Date: 2011-06-19 13:08+0200\\n\"\n+\"POT-Creation-Date: 2011-06-25 20:39+0200\\n\"\n \"PO-Revision-Date: 2010-05-13 15:35+0200\\n\"\n \"Last-Translator: Django team\\n\"\n \"Language-Team: English <en@li.org>\\n\"\n@@ -37,190 +37,196 @@ msgstr \"\"\n msgid \"Change password: %s\"\n msgstr \"\"\n \n-#: forms.py:14 forms.py:48 forms.py:66\n+#: forms.py:17 forms.py:51 forms.py:69\n msgid \"Username\"\n msgstr \"\"\n \n-#: forms.py:15 forms.py:49\n+#: forms.py:18 forms.py:52\n msgid \"Required. 30 characters or fewer. Letters, digits and @/./+/-/_ only.\"\n msgstr \"\"\n \n-#: forms.py:16 forms.py:50\n+#: forms.py:19 forms.py:53\n msgid \"This value may contain only letters, numbers and @/./+/-/_ characters.\"\n msgstr \"\"\n \n-#: forms.py:17 forms.py:67 forms.py:201\n+#: forms.py:20 forms.py:70 forms.py:205\n msgid \"Password\"\n msgstr \"\"\n \n-#: forms.py:18\n+#: forms.py:21\n msgid \"Password confirmation\"\n msgstr \"\"\n \n-#: forms.py:19\n+#: forms.py:22\n msgid \"Enter the same password as above, for verification.\"\n msgstr \"\"\n \n-#: forms.py:31\n+#: forms.py:34\n msgid \"A user with that username already exists.\"\n msgstr \"\"\n \n-#: forms.py:37 forms.py:171 forms.py:213\n+#: forms.py:40 forms.py:175 forms.py:217\n msgid \"The two password fields didn't match.\"\n msgstr \"\"\n \n-#: forms.py:87\n+#: forms.py:90\n msgid \"\"\n \"Please enter a correct username and password. Note that both fields are case-\"\n \"sensitive.\"\n msgstr \"\"\n \n-#: forms.py:89\n+#: forms.py:92\n msgid \"This account is inactive.\"\n msgstr \"\"\n \n-#: forms.py:96\n+#: forms.py:99\n msgid \"\"\n \"Your Web browser doesn't appear to have cookies enabled. Cookies are \"\n \"required for logging in.\"\n msgstr \"\"\n \n-#: forms.py:108\n+#: forms.py:111\n msgid \"E-mail\"\n msgstr \"\"\n \n-#: forms.py:120\n+#: forms.py:122\n msgid \"\"\n \"That e-mail address doesn't have an associated user account. Are you sure \"\n \"you've registered?\"\n msgstr \"\"\n \n-#: forms.py:159\n+#: forms.py:124\n+msgid \"\"\n+\"The user account associated with this e-mail address cannot reset the \"\n+\"password.\"\n+msgstr \"\"\n+\n+#: forms.py:163\n msgid \"New password\"\n msgstr \"\"\n \n-#: forms.py:160\n+#: forms.py:164\n msgid \"New password confirmation\"\n msgstr \"\"\n \n-#: forms.py:185\n+#: forms.py:189\n msgid \"Old password\"\n msgstr \"\"\n \n-#: forms.py:193\n+#: forms.py:197\n msgid \"Your old password was entered incorrectly. Please enter it again.\"\n msgstr \"\"\n \n-#: forms.py:202\n+#: forms.py:206\n msgid \"Password (again)\"\n msgstr \"\"\n \n-#: models.py:77 models.py:105\n+#: models.py:94 models.py:122\n msgid \"name\"\n msgstr \"\"\n \n-#: models.py:79\n+#: models.py:96\n msgid \"codename\"\n msgstr \"\"\n \n-#: models.py:83\n+#: models.py:100\n msgid \"permission\"\n msgstr \"\"\n \n-#: models.py:84 models.py:106\n+#: models.py:101 models.py:123\n msgid \"permissions\"\n msgstr \"\"\n \n-#: models.py:109\n+#: models.py:126\n msgid \"group\"\n msgstr \"\"\n \n-#: models.py:110 models.py:217\n+#: models.py:127 models.py:236\n msgid \"groups\"\n msgstr \"\"\n \n-#: models.py:207\n+#: models.py:226\n msgid \"username\"\n msgstr \"\"\n \n-#: models.py:207\n+#: models.py:226\n msgid \"\"\n \"Required. 30 characters or fewer. Letters, numbers and @/./+/-/_ characters\"\n msgstr \"\"\n \n-#: models.py:208\n+#: models.py:227\n msgid \"first name\"\n msgstr \"\"\n \n-#: models.py:209\n+#: models.py:228\n msgid \"last name\"\n msgstr \"\"\n \n-#: models.py:210\n+#: models.py:229\n msgid \"e-mail address\"\n msgstr \"\"\n \n-#: models.py:211\n+#: models.py:230\n msgid \"password\"\n msgstr \"\"\n \n-#: models.py:211\n+#: models.py:230\n msgid \"\"\n \"Use '[algo]$[salt]$[hexdigest]' or use the <a href=\\\"password/\\\">change \"\n \"password form</a>.\"\n msgstr \"\"\n \n-#: models.py:212\n+#: models.py:231\n msgid \"staff status\"\n msgstr \"\"\n \n-#: models.py:212\n+#: models.py:231\n msgid \"Designates whether the user can log into this admin site.\"\n msgstr \"\"\n \n-#: models.py:213\n+#: models.py:232\n msgid \"active\"\n msgstr \"\"\n \n-#: models.py:213\n+#: models.py:232\n msgid \"\"\n \"Designates whether this user should be treated as active. Unselect this \"\n \"instead of deleting accounts.\"\n msgstr \"\"\n \n-#: models.py:214\n+#: models.py:233\n msgid \"superuser status\"\n msgstr \"\"\n \n-#: models.py:214\n+#: models.py:233\n msgid \"\"\n \"Designates that this user has all permissions without explicitly assigning \"\n \"them.\"\n msgstr \"\"\n \n-#: models.py:215\n+#: models.py:234\n msgid \"last login\"\n msgstr \"\"\n \n-#: models.py:216\n+#: models.py:235\n msgid \"date joined\"\n msgstr \"\"\n \n-#: models.py:218\n+#: models.py:237\n msgid \"\"\n \"In addition to the permissions manually assigned, this user will also get \"\n \"all permissions granted to each group he/she is in.\"\n msgstr \"\"\n \n-#: models.py:219\n+#: models.py:238\n msgid \"user permissions\"\n msgstr \"\"\n \n-#: models.py:223\n+#: models.py:242\n msgid \"user\"\n msgstr \"\"\n \n-#: models.py:224\n+#: models.py:243\n msgid \"users\"\n msgstr \"\"\n "
        },
        {
            "sha": "489164abdb472a04e8597b1c598974c4aab16ac2",
            "filename": "django/contrib/auth/tests/forms.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/2619dc828510cf36791fcf87705d2f9ce3176c86/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/2619dc828510cf36791fcf87705d2f9ce3176c86/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py?ref=2619dc828510cf36791fcf87705d2f9ce3176c86",
            "patch": "@@ -281,3 +281,16 @@ def test_inactive_user(self):\n         user.save()\n         form = PasswordResetForm({'email': email})\n         self.assertFalse(form.is_valid())\n+\n+\n+    def test_unusable_password(self):\n+        user = User.objects.create_user('testuser', 'test@example.com', 'test')\n+        data = {\"email\": \"test@example.com\"}\n+        form = PasswordResetForm(data)\n+        self.assertTrue(form.is_valid())\n+        user.set_unusable_password()\n+        user.save()\n+        form = PasswordResetForm(data)\n+        self.assertFalse(form.is_valid())\n+        self.assertEqual(form[\"email\"].errors,\n+                         [u\"The user account associated with this e-mail address cannot reset the password.\"])"
        },
        {
            "sha": "e7f606b3d02ea49d9388f2f01686f2549d8fa92f",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/2619dc828510cf36791fcf87705d2f9ce3176c86/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/2619dc828510cf36791fcf87705d2f9ce3176c86/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=2619dc828510cf36791fcf87705d2f9ce3176c86",
            "patch": "@@ -1011,6 +1011,12 @@ includes a few other useful built-in views located in\n \n         * ``form``: The form for resetting the user's password.\n \n+        .. versionchanged:: 1.4\n+            Users flagged with an unusable password (see\n+            :meth:`~django.contrib.auth.models.User.set_unusable_password()`\n+            will not be able to request a password reset to prevent misuse\n+            when using an external authentication source like LDAP.\n+\n .. function:: password_reset_done(request[, template_name])\n \n     The page shown after a user has been emailed a link to reset their"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 81,
        "deletions": 52
    }
}