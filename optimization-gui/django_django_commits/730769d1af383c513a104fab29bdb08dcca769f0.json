{
    "author": "ramiro",
    "message": "Fixed #14951 -- Made the unique_for_{date,month,year} model field constraints to not fail when the related DateField is empty.\n\nExisting modelforms tests were extended to cover this case and an equivalent set of tests was added for the model functionality.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15167 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "730769d1af383c513a104fab29bdb08dcca769f0",
    "files": [
        {
            "sha": "84259f1a6d59546fcc18a4fce479537b218affca",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/730769d1af383c513a104fab29bdb08dcca769f0/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/730769d1af383c513a104fab29bdb08dcca769f0/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=730769d1af383c513a104fab29bdb08dcca769f0",
            "patch": "@@ -648,7 +648,7 @@ def _get_unique_checks(self, exclude=None):\n         called from a ModelForm, some fields may have been excluded; we can't\n         perform a unique check on a model that is missing fields involved\n         in that check.\n-        Fields that did not validate should also be exluded, but they need\n+        Fields that did not validate should also be excluded, but they need\n         to be passed in via the exclude argument.\n         \"\"\"\n         if exclude is None:\n@@ -740,6 +740,8 @@ def _perform_date_checks(self, date_checks):\n             # there's a ticket to add a date lookup, we can remove this special\n             # case if that makes it's way in\n             date = getattr(self, unique_for)\n+            if date is None:\n+                continue\n             if lookup_type == 'date':\n                 lookup_kwargs['%s__day' % unique_for] = date.day\n                 lookup_kwargs['%s__month' % unique_for] = date.month"
        },
        {
            "sha": "140e8073e79716a9827b7dac711b25b50a12bfa3",
            "filename": "tests/modeltests/model_forms/mforms.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fmodel_forms%2Fmforms.py",
            "raw_url": "https://github.com/django/django/raw/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fmodel_forms%2Fmforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Fmforms.py?ref=730769d1af383c513a104fab29bdb08dcca769f0",
            "patch": "@@ -1,7 +1,8 @@\n from django import forms\n from django.forms import ModelForm\n \n-from models import Product, Price, Book, DerivedBook, ExplicitPK, Post, DerivedPost, Writer\n+from models import (Product, Price, Book, DerivedBook, ExplicitPK, Post,\n+        DerivedPost, Writer, FlexibleDatePost)\n \n class ProductForm(ModelForm):\n     class Meta:\n@@ -37,3 +38,7 @@ class CustomWriterForm(ModelForm):\n \n    class Meta:\n        model = Writer\n+\n+class FlexDatePostForm(ModelForm):\n+    class Meta:\n+        model = FlexibleDatePost"
        },
        {
            "sha": "b9b8d16c071beb546c3ae28c3ada62bd6d014c77",
            "filename": "tests/modeltests/model_forms/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Fmodels.py?ref=730769d1af383c513a104fab29bdb08dcca769f0",
            "patch": "@@ -236,6 +236,12 @@ class CustomFieldForExclusionModel(models.Model):\n     name = models.CharField(max_length=10)\n     markup = MarkupField()\n \n+class FlexibleDatePost(models.Model):\n+    title = models.CharField(max_length=50, unique_for_date='posted', blank=True)\n+    slug = models.CharField(max_length=50, unique_for_year='posted', blank=True)\n+    subtitle = models.CharField(max_length=50, unique_for_month='posted', blank=True)\n+    posted = models.DateField(blank=True, null=True)\n+\n __test__ = {'API_TESTS': \"\"\"\n >>> from django import forms\n >>> from django.forms.models import ModelForm, model_to_dict"
        },
        {
            "sha": "33918ee88cd961778289aab99f059773742e08d0",
            "filename": "tests/modeltests/model_forms/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_forms%2Ftests.py?ref=730769d1af383c513a104fab29bdb08dcca769f0",
            "patch": "@@ -1,9 +1,10 @@\n import datetime\n from django.test import TestCase\n from django import forms\n-from models import Category, Writer, Book, DerivedBook, Post\n-from mforms import (ProductForm, PriceForm, BookForm, DerivedBookForm, \n-                   ExplicitPKForm, PostForm, DerivedPostForm, CustomWriterForm)\n+from models import Category, Writer, Book, DerivedBook, Post, FlexibleDatePost\n+from mforms import (ProductForm, PriceForm, BookForm, DerivedBookForm,\n+                   ExplicitPKForm, PostForm, DerivedPostForm, CustomWriterForm,\n+                   FlexDatePostForm)\n \n \n class IncompleteCategoryFormWithFields(forms.ModelForm):\n@@ -183,3 +184,16 @@ def test_inherited_unique_for_date(self):\n             \"slug\": \"Django 1.0\", 'posted': '2008-09-03'}, instance=p)\n         self.assertTrue(form.is_valid())\n \n+    def test_unique_for_date_with_nullable_date(self):\n+        p = FlexibleDatePost.objects.create(title=\"Django 1.0 is released\",\n+            slug=\"Django 1.0\", subtitle=\"Finally\", posted=datetime.date(2008, 9, 3))\n+\n+        form = FlexDatePostForm({'title': \"Django 1.0 is released\"})\n+        self.assertTrue(form.is_valid())\n+        form = FlexDatePostForm({'slug': \"Django 1.0\"})\n+        self.assertTrue(form.is_valid())\n+        form = FlexDatePostForm({'subtitle': \"Finally\"})\n+        self.assertTrue(form.is_valid())\n+        form = FlexDatePostForm({'subtitle': \"Finally\", \"title\": \"Django 1.0 is released\",\n+            \"slug\": \"Django 1.0\"}, instance=p)\n+        self.assertTrue(form.is_valid())"
        },
        {
            "sha": "861d1440fe786ba168761870b7048e4dd2819f55",
            "filename": "tests/modeltests/validation/models.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fvalidation%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fvalidation%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Fmodels.py?ref=730769d1af383c513a104fab29bdb08dcca769f0",
            "patch": "@@ -63,3 +63,18 @@ class Article(models.Model):\n     def clean(self):\n         if self.pub_date is None:\n             self.pub_date = datetime.now()\n+\n+class Post(models.Model):\n+    title = models.CharField(max_length=50, unique_for_date='posted', blank=True)\n+    slug = models.CharField(max_length=50, unique_for_year='posted', blank=True)\n+    subtitle = models.CharField(max_length=50, unique_for_month='posted', blank=True)\n+    posted = models.DateField()\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class FlexibleDatePost(models.Model):\n+    title = models.CharField(max_length=50, unique_for_date='posted', blank=True)\n+    slug = models.CharField(max_length=50, unique_for_year='posted', blank=True)\n+    subtitle = models.CharField(max_length=50, unique_for_month='posted', blank=True)\n+    posted = models.DateField(blank=True, null=True)"
        },
        {
            "sha": "223aa021e4f0ae5d1e0680bc9300d021a706de77",
            "filename": "tests/modeltests/validation/test_unique.py",
            "status": "modified",
            "additions": 74,
            "deletions": 1,
            "changes": 75,
            "blob_url": "https://github.com/django/django/blob/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fvalidation%2Ftest_unique.py",
            "raw_url": "https://github.com/django/django/raw/730769d1af383c513a104fab29bdb08dcca769f0/tests%2Fmodeltests%2Fvalidation%2Ftest_unique.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Ftest_unique.py?ref=730769d1af383c513a104fab29bdb08dcca769f0",
            "patch": "@@ -1,12 +1,13 @@\n import datetime\n \n from django.conf import settings\n+from django.core.exceptions import ValidationError\n from django.db import connection\n from django.test import TestCase\n from django.utils import unittest\n \n from models import (CustomPKModel, UniqueTogetherModel, UniqueFieldsModel,\n-    UniqueForDateModel, ModelToValidate)\n+    UniqueForDateModel, ModelToValidate, Post, FlexibleDatePost)\n \n \n class GetUniqueCheckTests(unittest.TestCase):\n@@ -76,3 +77,75 @@ def test():\n             mtv = ModelToValidate(number=10, name='Some Name')\n             mtv.full_clean()\n         self.assertNumQueries(0, test)\n+\n+    def test_unique_for_date(self):\n+        p1 = Post.objects.create(title=\"Django 1.0 is released\",\n+            slug=\"Django 1.0\", subtitle=\"Finally\", posted=datetime.date(2008, 9, 3))\n+\n+        p = Post(title=\"Django 1.0 is released\", posted=datetime.date(2008, 9, 3))\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.assertEqual(e.message_dict, {'title': [u'Title must be unique for Posted date.']})\n+        else:\n+            self.fail('unique_for_date checks should catch this.')\n+\n+        # Should work without errors\n+        p = Post(title=\"Work on Django 1.1 begins\", posted=datetime.date(2008, 9, 3))\n+        p.full_clean()\n+\n+        # Should work without errors\n+        p = Post(title=\"Django 1.0 is released\", posted=datetime.datetime(2008, 9,4))\n+        p.full_clean()\n+\n+        p = Post(slug=\"Django 1.0\", posted=datetime.datetime(2008, 1, 1))\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.assertEqual(e.message_dict, {'slug': [u'Slug must be unique for Posted year.']})\n+        else:\n+            self.fail('unique_for_year checks should catch this.')\n+\n+        p = Post(subtitle=\"Finally\", posted=datetime.datetime(2008, 9, 30))\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.assertEqual(e.message_dict, {'subtitle': [u'Subtitle must be unique for Posted month.']})\n+        else:\n+            self.fail('unique_for_month checks should catch this.')\n+\n+        p = Post(title=\"Django 1.0 is released\")\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.assertEqual(e.message_dict, {'posted': [u'This field cannot be null.']})\n+        else:\n+            self.fail(\"Model validation shouldn't allow an absent value for a DateField without null=True.\")\n+\n+    def test_unique_for_date_with_nullable_date(self):\n+        p1 = FlexibleDatePost.objects.create(title=\"Django 1.0 is released\",\n+            slug=\"Django 1.0\", subtitle=\"Finally\", posted=datetime.date(2008, 9, 3))\n+\n+        p = FlexibleDatePost(title=\"Django 1.0 is released\")\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.fail(\"unique_for_date checks shouldn't trigger when the associated DateField is None.\")\n+        except:\n+            self.fail(\"unique_for_date checks shouldn't explode when the associated DateField is None.\")\n+\n+        p = FlexibleDatePost(slug=\"Django 1.0\")\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.fail(\"unique_for_year checks shouldn't trigger when the associated DateField is None.\")\n+        except:\n+            self.fail(\"unique_for_year checks shouldn't explode when the associated DateField is None.\")\n+\n+        p = FlexibleDatePost(subtitle=\"Finally\")\n+        try:\n+            p.full_clean()\n+        except ValidationError, e:\n+            self.fail(\"unique_for_month checks shouldn't trigger when the associated DateField is None.\")\n+        except:\n+            self.fail(\"unique_for_month checks shouldn't explode when the associated DateField is None.\")"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 121,
        "deletions": 6
    }
}