{
    "author": "jezdez",
    "message": "Fixed #15255 -- Stopped database cache from ignoring database routers when creating the cache table. Thanks, aaugustin.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16510 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6de65ab76ff7704c90c6de9d5954c7736325c3fb",
    "files": [
        {
            "sha": "d299208d792e6d59714ce5908e8790d662b3b634",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/6de65ab76ff7704c90c6de9d5954c7736325c3fb/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/6de65ab76ff7704c90c6de9d5954c7736325c3fb/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=6de65ab76ff7704c90c6de9d5954c7736325c3fb",
            "patch": "@@ -33,9 +33,7 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n-                from django.db import router\n-                if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n-                    call_command('createcachetable', cache._table, database=self.connection.alias)\n+                call_command('createcachetable', cache._table, database=self.connection.alias)\n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database.\n         cursor = self.connection.cursor()"
        },
        {
            "sha": "e2f17abdc549c49346b67abe7630c5e4c486554b",
            "filename": "django/core/management/commands/createcachetable.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/6de65ab76ff7704c90c6de9d5954c7736325c3fb/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "raw_url": "https://github.com/django/django/raw/6de65ab76ff7704c90c6de9d5954c7736325c3fb/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py?ref=6de65ab76ff7704c90c6de9d5954c7736325c3fb",
            "patch": "@@ -1,7 +1,8 @@\n from optparse import make_option\n \n from django.core.management.base import LabelCommand\n-from django.db import connections, transaction, models, DEFAULT_DB_ALIAS\n+from django.core.cache.backends.db import BaseDatabaseCache\n+from django.db import connections, router, transaction, models, DEFAULT_DB_ALIAS\n \n class Command(LabelCommand):\n     help = \"Creates the table needed to use the SQL cache backend.\"\n@@ -18,8 +19,11 @@ class Command(LabelCommand):\n     requires_model_validation = False\n \n     def handle_label(self, tablename, **options):\n-        alias = options.get('database', DEFAULT_DB_ALIAS)\n-        connection = connections[alias]\n+        db = options.get('database', DEFAULT_DB_ALIAS)\n+        cache = BaseDatabaseCache(tablename, {})\n+        if not router.allow_syncdb(db, cache.cache_model_class):\n+            return\n+        connection = connections[db]\n         fields = (\n             # \"key\" is a reserved word in MySQL, so use \"cache_key\" instead.\n             models.CharField(name='cache_key', max_length=255, unique=True, primary_key=True),\n@@ -50,4 +54,4 @@ def handle_label(self, tablename, **options):\n         curs.execute(\"\\n\".join(full_statement))\n         for statement in index_output:\n             curs.execute(statement)\n-        transaction.commit_unless_managed(using=alias)\n+        transaction.commit_unless_managed(using=db)"
        },
        {
            "sha": "6170bf6b973352367080d29660fbc7737b88dabc",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/6de65ab76ff7704c90c6de9d5954c7736325c3fb/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/6de65ab76ff7704c90c6de9d5954c7736325c3fb/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=6de65ab76ff7704c90c6de9d5954c7736325c3fb",
            "patch": "@@ -261,9 +261,7 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n-                from django.db import router\n-                if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n-                    call_command('createcachetable', cache._table, database=self.connection.alias)\n+                call_command('createcachetable', cache._table, database=self.connection.alias)\n \n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database."
        },
        {
            "sha": "ad7a2f86dc15d8daa8d2500fe2eec474642dbecd",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 37,
            "deletions": 1,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/6de65ab76ff7704c90c6de9d5954c7736325c3fb/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6de65ab76ff7704c90c6de9d5954c7736325c3fb/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=6de65ab76ff7704c90c6de9d5954c7736325c3fb",
            "patch": "@@ -13,10 +13,11 @@\n from django.core import management\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n from django.core.cache.backends.base import CacheKeyWarning\n+from django.db import connections, router\n from django.http import HttpResponse, HttpRequest, QueryDict\n from django.middleware.cache import FetchFromCacheMiddleware, UpdateCacheMiddleware, CacheMiddleware\n from django.test import RequestFactory\n-from django.test.utils import get_warnings_state, restore_warnings_state\n+from django.test.utils import get_warnings_state, restore_warnings_state, override_settings\n from django.utils import translation\n from django.utils import unittest\n from django.utils.cache import patch_vary_headers, get_cache_key, learn_cache_key\n@@ -757,6 +758,41 @@ def test_old_initialization(self):\n         self.cache = get_cache('db://%s?max_entries=30&cull_frequency=0' % self._table_name)\n         self.perform_cull_test(50, 18)\n \n+class DBCacheRouter(object):\n+    \"\"\"A router that puts the cache table on the 'other' database.\"\"\"\n+\n+    def db_for_read(self, model, **hints):\n+        if model._meta.app_label == 'django_cache':\n+            return 'other'\n+\n+    def db_for_write(self, model, **hints):\n+        if model._meta.app_label == 'django_cache':\n+            return 'other'\n+\n+    def allow_syncdb(self, db, model):\n+        if model._meta.app_label == 'django_cache':\n+            return db == 'other'\n+\n+class CreateCacheTableForDBCacheTests(unittest.TestCase):\n+\n+    @override_settings(DEBUG=True)\n+    def test_createcachetable_observes_database_router(self):\n+        old_routers = router.routers\n+        try:\n+            router.routers = [DBCacheRouter()]\n+            # cache table should not be created on 'default'\n+            management.call_command('createcachetable', 'cache_table',\n+                                    database='default',\n+                                    verbosity=0, interactive=False)\n+            self.assertEqual(len(connections['default'].queries), 0)\n+            # cache table should be created on 'other'\n+            management.call_command('createcachetable', 'cache_table',\n+                                    database='other',\n+                                    verbosity=0, interactive=False)\n+            self.assertNotEqual(len(connections['other'].queries), 0)\n+        finally:\n+            router.routers = old_routers\n+\n class LocMemCacheTests(unittest.TestCase, BaseCacheTests):\n     backend_name = 'django.core.cache.backends.locmem.LocMemCache'\n "
        }
    ],
    "stats": {
        "total": 58,
        "additions": 47,
        "deletions": 11
    }
}