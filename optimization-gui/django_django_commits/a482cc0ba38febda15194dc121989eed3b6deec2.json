{
    "author": "spookylukey",
    "message": "Fixed #16004 - csrf_protect does not send cookie if view returns TemplateResponse\n\nThe root bug was in decorator_from_middleware, and the fix also corrects\nbugs with gzip_page and other decorators.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16276 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a482cc0ba38febda15194dc121989eed3b6deec2",
    "files": [
        {
            "sha": "d653860547bbea3f6bc229cdaa9f2292086d15eb",
            "filename": "django/core/handlers/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/a482cc0ba38febda15194dc121989eed3b6deec2/django%2Fcore%2Fhandlers%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/a482cc0ba38febda15194dc121989eed3b6deec2/django%2Fcore%2Fhandlers%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fbase.py?ref=a482cc0ba38febda15194dc121989eed3b6deec2",
            "patch": "@@ -133,7 +133,7 @@ def get_response(self, request):\n                 if hasattr(response, 'render') and callable(response.render):\n                     for middleware_method in self._template_response_middleware:\n                         response = middleware_method(request, response)\n-                    response.render()\n+                    response = response.render()\n \n             except http.Http404, e:\n                 logger.warning('Not Found: %s' % request.path,"
        },
        {
            "sha": "73645a7d726039eec67456f811b298b42f0faaaa",
            "filename": "django/template/response.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/a482cc0ba38febda15194dc121989eed3b6deec2/django%2Ftemplate%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/a482cc0ba38febda15194dc121989eed3b6deec2/django%2Ftemplate%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fresponse.py?ref=a482cc0ba38febda15194dc121989eed3b6deec2",
            "patch": "@@ -92,11 +92,14 @@ def render(self):\n \n         Returns the baked response instance.\n         \"\"\"\n+        retval = self\n         if not self._is_rendered:\n             self._set_content(self.rendered_content)\n             for post_callback in self._post_render_callbacks:\n-                post_callback(self)\n-        return self\n+                newretval = post_callback(retval)\n+                if newretval is not None:\n+                    retval = newretval\n+        return retval\n \n     is_rendered = property(lambda self: self._is_rendered)\n "
        },
        {
            "sha": "22f33a76a4cb43ae52ed5cc0c8e7de008f661c74",
            "filename": "django/utils/decorators.py",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/a482cc0ba38febda15194dc121989eed3b6deec2/django%2Futils%2Fdecorators.py",
            "raw_url": "https://github.com/django/django/raw/a482cc0ba38febda15194dc121989eed3b6deec2/django%2Futils%2Fdecorators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fdecorators.py?ref=a482cc0ba38febda15194dc121989eed3b6deec2",
            "patch": "@@ -95,10 +95,17 @@ def _wrapped_view(request, *args, **kwargs):\n                         if result is not None:\n                             return result\n                     raise\n-                if hasattr(middleware, 'process_response'):\n-                    result = middleware.process_response(request, response)\n-                    if result is not None:\n-                        return result\n+                if hasattr(response, 'render') and callable(response.render):\n+                    if hasattr(middleware, 'process_template_response'):\n+                        response = middleware.process_template_response(request, response)\n+                    # Defer running of process_response until after the template\n+                    # has been rendered:\n+                    if hasattr(middleware, 'process_response'):\n+                        callback = lambda response: middleware.process_response(request, response)\n+                        response.add_post_render_callback(callback)\n+                else:\n+                    if hasattr(middleware, 'process_response'):\n+                        return middleware.process_response(request, response)\n                 return response\n             return _wrapped_view\n         return _decorator"
        },
        {
            "sha": "0064290d4ecf81652e8639d243e114df9367ffa2",
            "filename": "docs/ref/template-response.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/a482cc0ba38febda15194dc121989eed3b6deec2/docs%2Fref%2Ftemplate-response.txt",
            "raw_url": "https://github.com/django/django/raw/a482cc0ba38febda15194dc121989eed3b6deec2/docs%2Fref%2Ftemplate-response.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Ftemplate-response.txt?ref=a482cc0ba38febda15194dc121989eed3b6deec2",
            "patch": "@@ -119,6 +119,10 @@ Methods\n     rendered :class:`~django.template.response.SimpleTemplateResponse`\n     instance.\n \n+    If the callback returns a value that is not `None`, this will be\n+    used as the response instead of the original response object (and\n+    will be passed to the next post rendering callback etc.)\n+\n .. method:: SimpleTemplateResponse.render():\n \n     Sets :attr:`response.content` to the result obtained by"
        },
        {
            "sha": "837cc7d39e0723c9f8e97cb6b8ed10fb1a8ac673",
            "filename": "tests/regressiontests/utils/decorators.py",
            "status": "modified",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/django/django/blob/a482cc0ba38febda15194dc121989eed3b6deec2/tests%2Fregressiontests%2Futils%2Fdecorators.py",
            "raw_url": "https://github.com/django/django/raw/a482cc0ba38febda15194dc121989eed3b6deec2/tests%2Fregressiontests%2Futils%2Fdecorators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fdecorators.py?ref=a482cc0ba38febda15194dc121989eed3b6deec2",
            "patch": "@@ -1,5 +1,7 @@\n from django.http import HttpResponse\n from django.middleware.doc import XViewMiddleware\n+from django.template import Template, Context\n+from django.template.response import TemplateResponse\n from django.test import TestCase, RequestFactory\n from django.utils.decorators import decorator_from_middleware\n \n@@ -19,6 +21,26 @@ def __call__(self, request):\n class_xview = xview_dec(ClassXView())\n \n \n+class FullMiddleware(object):\n+    def process_request(self, request):\n+        request.process_request_reached = True\n+\n+    def process_view(sef, request, view_func, view_args, view_kwargs):\n+        request.process_view_reached = True\n+\n+    def process_template_response(self, request, response):\n+        request.process_template_response_reached = True\n+        return response\n+\n+    def process_response(self, request, response):\n+        # This should never receive unrendered content.\n+        request.process_response_content = response.content\n+        request.process_response_reached = True\n+        return response\n+\n+full_dec = decorator_from_middleware(FullMiddleware)\n+\n+\n class DecoratorFromMiddlewareTests(TestCase):\n     \"\"\"\n     Tests for view decorators created using\n@@ -37,3 +59,48 @@ def test_callable_process_view_middleware(self):\n         Test a middleware that implements process_view, operating on a callable class.\n         \"\"\"\n         class_xview(self.rf.get('/'))\n+\n+    def test_full_dec_normal(self):\n+        \"\"\"\n+        Test that all methods of middleware are called for normal HttpResponses\n+        \"\"\"\n+\n+        @full_dec\n+        def normal_view(request):\n+            t = Template(\"Hello world\")\n+            return HttpResponse(t.render(Context({})))\n+\n+        request = self.rf.get('/')\n+        response = normal_view(request)\n+        self.assertTrue(getattr(request, 'process_request_reached', False))\n+        self.assertTrue(getattr(request, 'process_view_reached', False))\n+        # process_template_response must not be called for HttpResponse\n+        self.assertFalse(getattr(request, 'process_template_response_reached', False))\n+        self.assertTrue(getattr(request, 'process_response_reached', False))\n+\n+    def test_full_dec_templateresponse(self):\n+        \"\"\"\n+        Test that all methods of middleware are called for TemplateResponses in\n+        the right sequence.\n+        \"\"\"\n+\n+        @full_dec\n+        def template_response_view(request):\n+            t = Template(\"Hello world\")\n+            return TemplateResponse(request, t, {})\n+\n+        request = self.rf.get('/')\n+        response = template_response_view(request)\n+        self.assertTrue(getattr(request, 'process_request_reached', False))\n+        self.assertTrue(getattr(request, 'process_view_reached', False))\n+        self.assertTrue(getattr(request, 'process_template_response_reached', False))\n+        # response must not be rendered yet.\n+        self.assertFalse(response._is_rendered)\n+        # process_response must not be called until after response is rendered,\n+        # otherwise some decorators like csrf_protect and gzip_page will not\n+        # work correctly. See #16004\n+        self.assertFalse(getattr(request, 'process_response_reached', False))\n+        response.render()\n+        self.assertTrue(getattr(request, 'process_response_reached', False))\n+        # Check that process_response saw the rendered content\n+        self.assertEqual(request.process_response_content, \"Hello world\")"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 88,
        "deletions": 7
    }
}