{
    "author": "akaariai",
    "message": "Removed try-except in django.db.close_connection()\n\nThe reason was that the except clause needed to remove a connection\nfrom the django.db.connections dict, but other parts of Django do not\nexpect this to happen. In addition the except clause was silently\nswallowing the exception messages.\n\nRefs #19707, special thanks to Carl Meyer for pointing out that this\napproach should be taken.",
    "sha": "fafee74306e869c23edcef864f9d816565a5c4a2",
    "files": [
        {
            "sha": "32e42bbfe9d0417d2358374a46033b0acc693070",
            "filename": "django/db/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/fafee74306e869c23edcef864f9d816565a5c4a2/django%2Fdb%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/fafee74306e869c23edcef864f9d816565a5c4a2/django%2Fdb%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2F__init__.py?ref=fafee74306e869c23edcef864f9d816565a5c4a2",
            "patch": "@@ -45,14 +45,11 @@ def close_connection(**kwargs):\n     # Avoid circular imports\n     from django.db import transaction\n     for conn in connections:\n-        try:\n-            transaction.abort(conn)\n-            connections[conn].close()\n-        except Exception:\n-            # The connection's state is unknown, so it has to be\n-            # abandoned. This could happen for example if the network\n-            # connection has a failure.\n-            del connections[conn]\n+        # If an error happens here the connection will be left in broken\n+        # state. Once a good db connection is again available, the\n+        # connection state will be cleaned up.\n+        transaction.abort(conn)\n+        connections[conn].close()\n signals.request_finished.connect(close_connection)\n \n # Register an event that resets connection.queries"
        },
        {
            "sha": "91fa774ed44ec97bcceebbfc48b813e3121bf5bd",
            "filename": "django/db/utils.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/fafee74306e869c23edcef864f9d816565a5c4a2/django%2Fdb%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/fafee74306e869c23edcef864f9d816565a5c4a2/django%2Fdb%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Futils.py?ref=fafee74306e869c23edcef864f9d816565a5c4a2",
            "patch": "@@ -99,9 +99,6 @@ def __getitem__(self, alias):\n     def __setitem__(self, key, value):\n         setattr(self._connections, key, value)\n \n-    def __delitem__(self, key):\n-        delattr(self._connections, key)\n-\n     def __iter__(self):\n         return iter(self.databases)\n "
        },
        {
            "sha": "84928f39ba8716059d34f35bd510bebe7377d570",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/fafee74306e869c23edcef864f9d816565a5c4a2/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fafee74306e869c23edcef864f9d816565a5c4a2/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=fafee74306e869c23edcef864f9d816565a5c4a2",
            "patch": "@@ -548,9 +548,6 @@ def test_request_finished_db_state(self):\n                      'This test will close the connection, in-memory '\n                      'sqlite connections must not be closed.')\n     def test_request_finished_failed_connection(self):\n-        # See comments in test_request_finished_db_state() for the self.client\n-        # usage.\n-        response = self.client.get('/')\n         conn = connections[DEFAULT_DB_ALIAS]\n         conn.enter_transaction_management()\n         conn.managed(True)\n@@ -560,9 +557,14 @@ def test_request_finished_failed_connection(self):\n         def fail_horribly():\n             raise Exception(\"Horrible failure!\")\n         conn._rollback = fail_horribly\n-        signals.request_finished.send(sender=response._handler_class)\n-        # As even rollback wasn't possible the connection wrapper itself was\n-        # abandoned. Accessing the connections[alias] will create a new\n-        # connection wrapper, whch must be different than the original one.\n-        self.assertIsNot(conn, connections[DEFAULT_DB_ALIAS])\n+        try:\n+            with self.assertRaises(Exception):\n+                signals.request_finished.send(sender=self.__class__)\n+            # The connection's state wasn't cleaned up\n+            self.assertTrue(len(connection.transaction_state), 1)\n+        finally:\n+            del conn._rollback\n+        # The connection will be cleaned on next request where the conn\n+        # works again.\n+        signals.request_finished.send(sender=self.__class__)\n         self.assertEqual(len(connection.transaction_state), 0)"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 15,
        "deletions": 19
    }
}