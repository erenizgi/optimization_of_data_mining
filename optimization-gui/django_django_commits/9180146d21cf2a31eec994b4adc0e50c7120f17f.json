{
    "author": "jphalip",
    "message": "Fixed #19453 -- Ensured that the decorated function's arguments are obfuscated in the @sensitive_variables decorator's frame, in case the variables associated with those arguments were meant to be obfuscated from the decorated function's frame.\nThanks to vzima for the report.",
    "sha": "9180146d21cf2a31eec994b4adc0e50c7120f17f",
    "files": [
        {
            "sha": "e5f4c70191945076bfab46a9f9df5aabc3455cf5",
            "filename": "django/views/debug.py",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/9180146d21cf2a31eec994b4adc0e50c7120f17f/django%2Fviews%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/9180146d21cf2a31eec994b4adc0e50c7120f17f/django%2Fviews%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdebug.py?ref=9180146d21cf2a31eec994b4adc0e50c7120f17f",
            "patch": "@@ -172,13 +172,12 @@ def get_traceback_frame_variables(self, request, tb_frame):\n                 break\n             current_frame = current_frame.f_back\n \n-        cleansed = []\n+        cleansed = {}\n         if self.is_active(request) and sensitive_variables:\n             if sensitive_variables == '__ALL__':\n                 # Cleanse all variables\n                 for name, value in tb_frame.f_locals.items():\n-                    cleansed.append((name, CLEANSED_SUBSTITUTE))\n-                return cleansed\n+                    cleansed[name] = CLEANSED_SUBSTITUTE\n             else:\n                 # Cleanse specified variables\n                 for name, value in tb_frame.f_locals.items():\n@@ -187,16 +186,25 @@ def get_traceback_frame_variables(self, request, tb_frame):\n                     elif isinstance(value, HttpRequest):\n                         # Cleanse the request's POST parameters.\n                         value = self.get_request_repr(value)\n-                    cleansed.append((name, value))\n-                return cleansed\n+                    cleansed[name] = value\n         else:\n             # Potentially cleanse only the request if it's one of the frame variables.\n             for name, value in tb_frame.f_locals.items():\n                 if isinstance(value, HttpRequest):\n                     # Cleanse the request's POST parameters.\n                     value = self.get_request_repr(value)\n-                cleansed.append((name, value))\n-            return cleansed\n+                cleansed[name] = value\n+\n+        if (tb_frame.f_code.co_name == 'sensitive_variables_wrapper'\n+            and 'sensitive_variables_wrapper' in tb_frame.f_locals):\n+            # For good measure, obfuscate the decorated function's arguments in\n+            # the sensitive_variables decorator's frame, in case the variables\n+            # associated with those arguments were meant to be obfuscated from\n+            # the decorated function's frame.\n+            cleansed['func_args'] = CLEANSED_SUBSTITUTE\n+            cleansed['func_kwargs'] = CLEANSED_SUBSTITUTE\n+\n+        return cleansed.items()\n \n class ExceptionReporter(object):\n     \"\"\""
        },
        {
            "sha": "78ae6b144255bcfada1983388046a2a49b0d8ba3",
            "filename": "django/views/decorators/debug.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/9180146d21cf2a31eec994b4adc0e50c7120f17f/django%2Fviews%2Fdecorators%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/9180146d21cf2a31eec994b4adc0e50c7120f17f/django%2Fviews%2Fdecorators%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdecorators%2Fdebug.py?ref=9180146d21cf2a31eec994b4adc0e50c7120f17f",
            "patch": "@@ -26,12 +26,12 @@ def my_function()\n     \"\"\"\n     def decorator(func):\n         @functools.wraps(func)\n-        def sensitive_variables_wrapper(*args, **kwargs):\n+        def sensitive_variables_wrapper(*func_args, **func_kwargs):\n             if variables:\n                 sensitive_variables_wrapper.sensitive_variables = variables\n             else:\n                 sensitive_variables_wrapper.sensitive_variables = '__ALL__'\n-            return func(*args, **kwargs)\n+            return func(*func_args, **func_kwargs)\n         return sensitive_variables_wrapper\n     return decorator\n "
        },
        {
            "sha": "98b3b4e4d8ddf8cebeade5146bbee509067b12fb",
            "filename": "docs/howto/error-reporting.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/9180146d21cf2a31eec994b4adc0e50c7120f17f/docs%2Fhowto%2Ferror-reporting.txt",
            "raw_url": "https://github.com/django/django/raw/9180146d21cf2a31eec994b4adc0e50c7120f17f/docs%2Fhowto%2Ferror-reporting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Ferror-reporting.txt?ref=9180146d21cf2a31eec994b4adc0e50c7120f17f",
            "patch": "@@ -153,6 +153,20 @@ production environment (that is, where :setting:`DEBUG` is set to ``False``):\n         def my_function():\n             ...\n \n+    .. admonition:: When using mutiple decorators\n+\n+        If the variable you want to hide is also a function argument (e.g.\n+        '``user``' in the following example), and if the decorated function has\n+        mutiple decorators, then make sure to place ``@sensible_variables`` at\n+        the top of the decorator chain. This way it will also hide the function\n+        argument as it gets passed through the other decorators::\n+\n+            @sensitive_variables('user', 'pw', 'cc')\n+            @some_decorator\n+            @another_decorator\n+            def process_info(user):\n+                ...\n+\n .. function:: sensitive_post_parameters(*parameters)\n \n     If one of your views receives an :class:`~django.http.HttpRequest` object"
        },
        {
            "sha": "0e36948b98a7650595c33bb32676daf56b9d25d4",
            "filename": "tests/regressiontests/views/tests/debug.py",
            "status": "modified",
            "additions": 73,
            "deletions": 19,
            "changes": 92,
            "blob_url": "https://github.com/django/django/blob/9180146d21cf2a31eec994b4adc0e50c7120f17f/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/9180146d21cf2a31eec994b4adc0e50c7120f17f/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py?ref=9180146d21cf2a31eec994b4adc0e50c7120f17f",
            "patch": "@@ -7,7 +7,6 @@\n import os\n import sys\n \n-from django.conf import settings\n from django.core import mail\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.core.urlresolvers import reverse\n@@ -19,7 +18,8 @@\n \n from .. import BrokenException, except_args\n from ..views import (sensitive_view, non_sensitive_view, paranoid_view,\n-    custom_exception_reporter_filter_view, sensitive_method_view)\n+    custom_exception_reporter_filter_view, sensitive_method_view,\n+    sensitive_args_function_caller, sensitive_kwargs_function_caller)\n \n \n @override_settings(DEBUG=True, TEMPLATE_DEBUG=True)\n@@ -306,17 +306,28 @@ def verify_unsafe_email(self, view, check_for_POST_params=True):\n             response = view(request)\n             self.assertEqual(len(mail.outbox), 1)\n             email = mail.outbox[0]\n+\n             # Frames vars are never shown in plain text email reports.\n-            body = force_text(email.body)\n-            self.assertNotIn('cooked_eggs', body)\n-            self.assertNotIn('scrambled', body)\n-            self.assertNotIn('sauce', body)\n-            self.assertNotIn('worcestershire', body)\n+            body_plain = force_text(email.body)\n+            self.assertNotIn('cooked_eggs', body_plain)\n+            self.assertNotIn('scrambled', body_plain)\n+            self.assertNotIn('sauce', body_plain)\n+            self.assertNotIn('worcestershire', body_plain)\n+\n+            # Frames vars are shown in html email reports.\n+            body_html = force_text(email.alternatives[0][0])\n+            self.assertIn('cooked_eggs', body_html)\n+            self.assertIn('scrambled', body_html)\n+            self.assertIn('sauce', body_html)\n+            self.assertIn('worcestershire', body_html)\n+\n             if check_for_POST_params:\n                 for k, v in self.breakfast_data.items():\n                     # All POST parameters are shown.\n-                    self.assertIn(k, body)\n-                    self.assertIn(v, body)\n+                    self.assertIn(k, body_plain)\n+                    self.assertIn(v, body_plain)\n+                    self.assertIn(k, body_html)\n+                    self.assertIn(v, body_html)\n \n     def verify_safe_email(self, view, check_for_POST_params=True):\n         \"\"\"\n@@ -328,22 +339,35 @@ def verify_safe_email(self, view, check_for_POST_params=True):\n             response = view(request)\n             self.assertEqual(len(mail.outbox), 1)\n             email = mail.outbox[0]\n+\n             # Frames vars are never shown in plain text email reports.\n-            body = force_text(email.body)\n-            self.assertNotIn('cooked_eggs', body)\n-            self.assertNotIn('scrambled', body)\n-            self.assertNotIn('sauce', body)\n-            self.assertNotIn('worcestershire', body)\n+            body_plain = force_text(email.body)\n+            self.assertNotIn('cooked_eggs', body_plain)\n+            self.assertNotIn('scrambled', body_plain)\n+            self.assertNotIn('sauce', body_plain)\n+            self.assertNotIn('worcestershire', body_plain)\n+\n+            # Frames vars are shown in html email reports.\n+            body_html = force_text(email.alternatives[0][0])\n+            self.assertIn('cooked_eggs', body_html)\n+            self.assertIn('scrambled', body_html)\n+            self.assertIn('sauce', body_html)\n+            self.assertNotIn('worcestershire', body_html)\n+\n             if check_for_POST_params:\n                 for k, v in self.breakfast_data.items():\n                     # All POST parameters' names are shown.\n-                    self.assertIn(k, body)\n+                    self.assertIn(k, body_plain)\n                 # Non-sensitive POST parameters' values are shown.\n-                self.assertIn('baked-beans-value', body)\n-                self.assertIn('hash-brown-value', body)\n+                self.assertIn('baked-beans-value', body_plain)\n+                self.assertIn('hash-brown-value', body_plain)\n+                self.assertIn('baked-beans-value', body_html)\n+                self.assertIn('hash-brown-value', body_html)\n                 # Sensitive POST parameters' values are not shown.\n-                self.assertNotIn('sausage-value', body)\n-                self.assertNotIn('bacon-value', body)\n+                self.assertNotIn('sausage-value', body_plain)\n+                self.assertNotIn('bacon-value', body_plain)\n+                self.assertNotIn('sausage-value', body_html)\n+                self.assertNotIn('bacon-value', body_html)\n \n     def verify_paranoid_email(self, view):\n         \"\"\"\n@@ -445,6 +469,36 @@ def test_sensitive_method(self):\n             self.verify_safe_email(sensitive_method_view,\n                                    check_for_POST_params=False)\n \n+    def test_sensitive_function_arguments(self):\n+        \"\"\"\n+        Ensure that sensitive variables don't leak in the sensitive_variables\n+        decorator's frame, when those variables are passed as arguments to the\n+        decorated function.\n+        Refs #19453.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(sensitive_args_function_caller)\n+            self.verify_unsafe_email(sensitive_args_function_caller)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_safe_response(sensitive_args_function_caller, check_for_POST_params=False)\n+            self.verify_safe_email(sensitive_args_function_caller, check_for_POST_params=False)\n+\n+    def test_sensitive_function_keyword_arguments(self):\n+        \"\"\"\n+        Ensure that sensitive variables don't leak in the sensitive_variables\n+        decorator's frame, when those variables are passed as keyword arguments\n+        to the decorated function.\n+        Refs #19453.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(sensitive_kwargs_function_caller)\n+            self.verify_unsafe_email(sensitive_kwargs_function_caller)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_safe_response(sensitive_kwargs_function_caller, check_for_POST_params=False)\n+            self.verify_safe_email(sensitive_kwargs_function_caller, check_for_POST_params=False)\n+\n \n class AjaxResponseExceptionReporterFilter(TestCase, ExceptionReportTestMixin):\n     \"\"\""
        },
        {
            "sha": "748f07637ffe6abd2ea8e7da4085848ff0a99127",
            "filename": "tests/regressiontests/views/views.py",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/9180146d21cf2a31eec994b4adc0e50c7120f17f/tests%2Fregressiontests%2Fviews%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/9180146d21cf2a31eec994b4adc0e50c7120f17f/tests%2Fregressiontests%2Fviews%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Fviews.py?ref=9180146d21cf2a31eec994b4adc0e50c7120f17f",
            "patch": "@@ -132,6 +132,7 @@ def send_log(request, exc_info):\n         ][0]\n     orig_filters = admin_email_handler.filters\n     admin_email_handler.filters = []\n+    admin_email_handler.include_html = True\n     logger.error('Internal Server Error: %s', request.path,\n         exc_info=exc_info,\n         extra={\n@@ -184,6 +185,38 @@ def paranoid_view(request):\n         send_log(request, exc_info)\n         return technical_500_response(request, *exc_info)\n \n+def sensitive_args_function_caller(request):\n+    try:\n+        sensitive_args_function(''.join(['w', 'o', 'r', 'c', 'e', 's', 't', 'e', 'r', 's', 'h', 'i', 'r', 'e']))\n+    except Exception:\n+        exc_info = sys.exc_info()\n+        send_log(request, exc_info)\n+        return technical_500_response(request, *exc_info)\n+\n+@sensitive_variables('sauce')\n+def sensitive_args_function(sauce):\n+    # Do not just use plain strings for the variables' values in the code\n+    # so that the tests don't return false positives when the function's source\n+    # is displayed in the exception report.\n+    cooked_eggs = ''.join(['s', 'c', 'r', 'a', 'm', 'b', 'l', 'e', 'd'])\n+    raise Exception\n+\n+def sensitive_kwargs_function_caller(request):\n+    try:\n+        sensitive_kwargs_function(''.join(['w', 'o', 'r', 'c', 'e', 's', 't', 'e', 'r', 's', 'h', 'i', 'r', 'e']))\n+    except Exception:\n+        exc_info = sys.exc_info()\n+        send_log(request, exc_info)\n+        return technical_500_response(request, *exc_info)\n+\n+@sensitive_variables('sauce')\n+def sensitive_kwargs_function(sauce=None):\n+    # Do not just use plain strings for the variables' values in the code\n+    # so that the tests don't return false positives when the function's source\n+    # is displayed in the exception report.\n+    cooked_eggs = ''.join(['s', 'c', 'r', 'a', 'm', 'b', 'l', 'e', 'd'])\n+    raise Exception\n+\n class UnsafeExceptionReporterFilter(SafeExceptionReporterFilter):\n     \"\"\"\n     Ignores all the filtering done by its parent class."
        }
    ],
    "stats": {
        "total": 165,
        "additions": 137,
        "deletions": 28
    }
}