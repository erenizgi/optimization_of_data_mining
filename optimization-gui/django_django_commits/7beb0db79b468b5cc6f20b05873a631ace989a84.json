{
    "author": "aaugustin",
    "message": "Fixed #10320 -- Made it possible to use executemany with iterators. Thanks MockSoul for the report.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17387 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7beb0db79b468b5cc6f20b05873a631ace989a84",
    "files": [
        {
            "sha": "f1ee987ba8d65ad23a9efbe5c4e85ce2c585f1f4",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/7beb0db79b468b5cc6f20b05873a631ace989a84/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/7beb0db79b468b5cc6f20b05873a631ace989a84/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=7beb0db79b468b5cc6f20b05873a631ace989a84",
            "patch": "@@ -670,6 +670,9 @@ def execute(self, query, params=None):\n             raise utils.DatabaseError, utils.DatabaseError(*tuple(e)), sys.exc_info()[2]\n \n     def executemany(self, query, params=None):\n+        # cx_Oracle doesn't support iterators, convert them to lists\n+        if params is not None and not isinstance(params, (list, tuple)):\n+            params = list(params)\n         try:\n             args = [(':arg%d' % i) for i in range(len(params[0]))]\n         except (IndexError, TypeError):"
        },
        {
            "sha": "32e0f4f7023d2b900f219be1764c65f9f9157c88",
            "filename": "django/db/backends/util.py",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/7beb0db79b468b5cc6f20b05873a631ace989a84/django%2Fdb%2Fbackends%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/7beb0db79b468b5cc6f20b05873a631ace989a84/django%2Fdb%2Fbackends%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Futil.py?ref=7beb0db79b468b5cc6f20b05873a631ace989a84",
            "patch": "@@ -47,7 +47,7 @@ def execute(self, sql, params=()):\n                 'time': \"%.3f\" % duration,\n             })\n             logger.debug('(%.3f) %s; args=%s' % (duration, sql, params),\n-                extra={'duration':duration, 'sql':sql, 'params':params}\n+                extra={'duration': duration, 'sql': sql, 'params': params}\n             )\n \n     def executemany(self, sql, param_list):\n@@ -58,12 +58,16 @@ def executemany(self, sql, param_list):\n         finally:\n             stop = time()\n             duration = stop - start\n+            try:\n+                times = len(param_list)\n+            except TypeError:           # param_list could be an iterator\n+                times = '?'\n             self.db.queries.append({\n-                'sql': '%s times: %s' % (len(param_list), sql),\n+                'sql': '%s times: %s' % (times, sql),\n                 'time': \"%.3f\" % duration,\n             })\n             logger.debug('(%.3f) %s; args=%s' % (duration, sql, param_list),\n-                extra={'duration':duration, 'sql':sql, 'params':param_list}\n+                extra={'duration': duration, 'sql': sql, 'params': param_list}\n             )\n \n "
        },
        {
            "sha": "cfb662ee804a15cde1e739e3ef66461c79391ec2",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 30,
            "deletions": 9,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/7beb0db79b468b5cc6f20b05873a631ace989a84/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7beb0db79b468b5cc6f20b05873a631ace989a84/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=7beb0db79b468b5cc6f20b05873a631ace989a84",
            "patch": "@@ -14,6 +14,7 @@\n from django.db.backends.postgresql_psycopg2 import version as pg_version\n from django.db.utils import ConnectionHandler, DatabaseError, load_backend\n from django.test import TestCase, skipUnlessDBFeature, TransactionTestCase\n+from django.test.utils import override_settings\n from django.utils import unittest\n \n from . import models\n@@ -308,23 +309,43 @@ def test_parameter_escaping(self):\n \n \n class BackendTestCase(TestCase):\n-    def test_cursor_executemany(self):\n-        #4896: Test cursor.executemany\n+\n+    def create_squares_with_executemany(self, args):\n         cursor = connection.cursor()\n-        qn = connection.ops.quote_name\n         opts = models.Square._meta\n-        f1, f2 = opts.get_field('root'), opts.get_field('square')\n-        query = ('INSERT INTO %s (%s, %s) VALUES (%%s, %%s)'\n-                 % (connection.introspection.table_name_converter(opts.db_table), qn(f1.column), qn(f2.column)))\n-        cursor.executemany(query, [(i, i**2) for i in range(-5, 6)])\n+        tbl = connection.introspection.table_name_converter(opts.db_table)\n+        f1 = connection.ops.quote_name(opts.get_field('root').column)\n+        f2 = connection.ops.quote_name(opts.get_field('square').column)\n+        query = 'INSERT INTO %s (%s, %s) VALUES (%%s, %%s)' % (tbl, f1, f2)\n+        cursor.executemany(query, args)\n+\n+    def test_cursor_executemany(self):\n+        #4896: Test cursor.executemany\n+        args = [(i, i**2) for i in range(-5, 6)]\n+        self.create_squares_with_executemany(args)\n         self.assertEqual(models.Square.objects.count(), 11)\n         for i in range(-5, 6):\n             square = models.Square.objects.get(root=i)\n             self.assertEqual(square.square, i**2)\n \n+    def test_cursor_executemany_with_empty_params_list(self):\n         #4765: executemany with params=[] does nothing\n-        cursor.executemany(query, [])\n-        self.assertEqual(models.Square.objects.count(), 11)\n+        args = []\n+        self.create_squares_with_executemany(args)\n+        self.assertEqual(models.Square.objects.count(), 0)\n+\n+    def test_cursor_executemany_with_iterator(self):\n+        #10320: executemany accepts iterators\n+        args = iter((i, i**2) for i in range(-3, 2))\n+        self.create_squares_with_executemany(args)\n+        self.assertEqual(models.Square.objects.count(), 5)\n+\n+        args = iter((i, i**2) for i in range(3, 7))\n+        with override_settings(DEBUG=True):\n+            # same test for DebugCursorWrapper\n+            self.create_squares_with_executemany(args)\n+        self.assertEqual(models.Square.objects.count(), 9)\n+\n \n     def test_unicode_fetches(self):\n         #6254: fetchone, fetchmany, fetchall return strings as unicode objects"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 40,
        "deletions": 12
    }
}