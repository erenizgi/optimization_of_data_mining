{
    "author": "freakboy3742",
    "message": "Refs #14661 -- Clarified the handling of initial data injected via custom SQL.\n\nThis is BACKWARDS INCOMPATIBLE CHANGE for anyone relying on SQL-injected initial data in a test case.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15239 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
    "files": [
        {
            "sha": "a5228a1ab75cd534639bd858a402cc0af7cddd35",
            "filename": "django/core/management/commands/syncdb.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/django%2Fcore%2Fmanagement%2Fcommands%2Fsyncdb.py",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/django%2Fcore%2Fmanagement%2Fcommands%2Fsyncdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fsyncdb.py?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -26,6 +26,10 @@ def handle_noargs(self, **options):\n         interactive = options.get('interactive')\n         show_traceback = options.get('traceback', False)\n \n+        # Stealth option -- 'load_initial_data' is used by the testing setup\n+        # process to disable initial fixture loading.\n+        load_initial_data = options.get('load_initial_data', True)\n+\n         self.style = no_style()\n \n         # Import the 'management' module within each installed app, to register\n@@ -154,5 +158,7 @@ def model_installed(model):\n                         else:\n                             transaction.commit_unless_managed(using=db)\n \n-        from django.core.management import call_command\n-        call_command('loaddata', 'initial_data', verbosity=verbosity, database=db)\n+        # Load initial_data fixtures (unless that has been disabled)\n+        if load_initial_data:\n+            from django.core.management import call_command\n+            call_command('loaddata', 'initial_data', verbosity=verbosity, database=db)"
        },
        {
            "sha": "b92412abe499f27e5d36116f41ad98d2cd1cbe1d",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -359,7 +359,21 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         # Report syncdb messages at one level lower than that requested.\n         # This ensures we don't get flooded with messages during testing\n         # (unless you really ask to be flooded)\n-        call_command('syncdb', verbosity=max(verbosity - 1, 0), interactive=False, database=self.connection.alias)\n+        call_command('syncdb',\n+            verbosity=max(verbosity - 1, 0),\n+            interactive=False,\n+            database=self.connection.alias,\n+            load_initial_data=False)\n+\n+        # We need to then do a flush to ensure that any data installed by\n+        # custom SQL has been removed. The only test data should come from\n+        # test fixtures, or autogenerated from post_syncdb triggers.\n+        # This has the side effect of loading initial data (which was\n+        # intentionally skipped in the syncdb).\n+        call_command('flush',\n+            verbosity=max(verbosity - 1, 0),\n+            interactive=False,\n+            database=self.connection.alias)\n \n         from django.core.cache import get_cache\n         from django.core.cache.backends.db import BaseDatabaseCache"
        },
        {
            "sha": "dd6a099b9d7ff081b3129ea921a32e52587b75ce",
            "filename": "docs/howto/initial-data.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/docs%2Fhowto%2Finitial-data.txt",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/docs%2Fhowto%2Finitial-data.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Finitial-data.txt?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -121,6 +121,17 @@ the order in which they're executed. The only thing you can assume is\n that, by the time your custom data files are executed, all the\n database tables already will have been created.\n \n+.. admonition:: Initial SQL data and testing\n+\n+    This technique *cannot* be used to provide initial data for\n+    testing purposes. Django's test framework flushes the contents of\n+    the test database after each test; as a result, any data added\n+    using the custom SQL hook will be lost.\n+\n+    If you require data for a test case, you should add it using\n+    either a :ref:`test fixture <topics-testing-fixtures>`, or\n+    programatically add it during the ``setUp()`` of your test case.\n+\n Database-backend-specific SQL data\n ----------------------------------\n "
        },
        {
            "sha": "1904e9526da9d92f7c7d41fd67f851055c0ea87b",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -410,6 +410,36 @@ Bloggs'``. Although the previous behaviour was not useful for a template languag\n designed for web designers, and was never deliberately supported, it is possible\n that some templates may be broken by this change.\n \n+Use of custom SQL to load initial data in tests\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django provides a custom SQL hooks as a way to inject hand-crafted SQL\n+into the database synchronization process. One of the possible uses\n+for this custom SQL is to insert data into your database. If your\n+custom SQL contains ``INSERT`` statements, those insertions will be\n+performed every time your database is synchronized. This includes the\n+synchronization of any test databases that are created when you run a\n+test suite.\n+\n+However, in the process of testing the Django 1.3, it was discovered\n+that this feature has never completely worked as advertised. When\n+using database backends that don't support transactions, or when using\n+a TransactionTestCase, data that has been inserted using custom SQL\n+will not be visible during the testing process.\n+\n+Unfortunately, there was no way to rectify this problem without\n+introducing a backwards incompatibility. Rather than leave\n+SQL-inserted initial data in an uncertain state, Django now enforces\n+the policy that data inserted by custom SQL will *not* be visible\n+during testing.\n+\n+This change only affects the testing process. You can still use custom\n+SQL to load data into your production database as part of the syncdb\n+process. If you require data to exist during test conditions, you\n+should either insert it using :ref:`test fixtures\n+<topics-testing-fixtures>`, or using the ``setUp()`` method of your\n+test case.\n+\n .. _deprecated-features-1.3:\n \n Features deprecated in 1.3"
        },
        {
            "sha": "795f041fb9ed6599b425c57ca25b6165d0c133a6",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -1237,6 +1237,15 @@ documentation<dumpdata>` for more details.\n     Fixtures with other names can always be installed manually using\n     the :djadmin:`manage.py loaddata<loaddata>` command.\n \n+.. admonition:: Initial SQL data and testing\n+\n+    Django provides a second way to insert initial data into models --\n+    the :ref:`custom SQL hook <initial-sql>`. However, this technique\n+    *cannot* be used to provide initial data for testing purposes.\n+    Django's test framework flushes the contents of the test database\n+    after each test; as a result, any data added using the custom SQL\n+    hook will be lost.\n+\n Once you've created a fixture and placed it in a ``fixtures`` directory in one\n of your :setting:`INSTALLED_APPS`, you can use it in your unit tests by\n specifying a ``fixtures`` class attribute on your :class:`django.test.TestCase`"
        },
        {
            "sha": "6c7db2f362f1d1db4ce2382b0af7af80b24ee6e6",
            "filename": "tests/regressiontests/initial_sql_regress/models.py",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/tests%2Fregressiontests%2Finitial_sql_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/tests%2Fregressiontests%2Finitial_sql_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finitial_sql_regress%2Fmodels.py?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -7,5 +7,3 @@\n class Simple(models.Model):\n     name = models.CharField(max_length = 50)\n \n-# NOTE: The format of the included SQL file for this test suite is important.\n-# It must end with a trailing newline in order to test the fix for #2161."
        },
        {
            "sha": "1e6710be9e29ef2f80867c7ecba61cb5bb634e93",
            "filename": "tests/regressiontests/initial_sql_regress/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/tests%2Fregressiontests%2Finitial_sql_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b31a1b99261d05bf8a34495ee9faf4d6592b8b36/tests%2Fregressiontests%2Finitial_sql_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finitial_sql_regress%2Ftests.py?ref=b31a1b99261d05bf8a34495ee9faf4d6592b8b36",
            "patch": "@@ -5,4 +5,11 @@\n \n class InitialSQLTests(TestCase):\n     def test_initial_sql(self):\n-        self.assertEqual(Simple.objects.count(), 7)\n+        # The format of the included SQL file for this test suite is important.\n+        # It must end with a trailing newline in order to test the fix for #2161.\n+\n+        # However, as pointed out by #14661, test data loaded by custom SQL\n+        # can't be relied upon; as a result, the test framework flushes the\n+        # data contents before every test. This test validates that this has\n+        # occurred.\n+        self.assertEqual(Simple.objects.count(), 0)"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 81,
        "deletions": 6
    }
}