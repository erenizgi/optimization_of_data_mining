{
    "author": "micolous",
    "message": "Fixed #18616 -- added user_login_fail signal to contrib.auth\n\nThanks to Brad Pitcher for documentation",
    "sha": "7cc4068c4470876c526830778cbdac2fdfd6dc26",
    "files": [
        {
            "sha": "dd4a8484f56820707544520bfd0b685fa9f0463c",
            "filename": "django/contrib/auth/__init__.py",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/7cc4068c4470876c526830778cbdac2fdfd6dc26/django%2Fcontrib%2Fauth%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/7cc4068c4470876c526830778cbdac2fdfd6dc26/django%2Fcontrib%2Fauth%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2F__init__.py?ref=7cc4068c4470876c526830778cbdac2fdfd6dc26",
            "patch": "@@ -1,6 +1,8 @@\n+import re\n+\n from django.core.exceptions import ImproperlyConfigured\n from django.utils.importlib import import_module\n-from django.contrib.auth.signals import user_logged_in, user_logged_out\n+from django.contrib.auth.signals import user_logged_in, user_logged_out, user_login_failed\n \n SESSION_KEY = '_auth_user_id'\n BACKEND_SESSION_KEY = '_auth_user_backend'\n@@ -33,6 +35,21 @@ def get_backends():\n     return backends\n \n \n+def _clean_credentials(credentials):\n+    \"\"\"\n+    Cleans a dictionary of credentials of potentially sensitive info before\n+    sending to less secure functions.\n+\n+    Not comprehensive - intended for user_login_failed signal\n+    \"\"\"\n+    SENSITIVE_CREDENTIALS = re.compile('api|token|key|secret|password|signature', re.I)\n+    CLEANSED_SUBSTITUTE = '********************'\n+    for key in credentials:\n+        if SENSITIVE_CREDENTIALS.search(key):\n+            credentials[key] = CLEANSED_SUBSTITUTE\n+    return credentials\n+\n+\n def authenticate(**credentials):\n     \"\"\"\n     If the given credentials are valid, return a User object.\n@@ -49,6 +66,10 @@ def authenticate(**credentials):\n         user.backend = \"%s.%s\" % (backend.__module__, backend.__class__.__name__)\n         return user\n \n+    # The credentials supplied are invalid to all backends, fire signal\n+    user_login_failed.send(sender=__name__,\n+            credentials=_clean_credentials(credentials))\n+\n \n def login(request, user):\n     \"\"\""
        },
        {
            "sha": "71ab6a11d184b7a0230b3d472603d654508a34a3",
            "filename": "django/contrib/auth/signals.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/7cc4068c4470876c526830778cbdac2fdfd6dc26/django%2Fcontrib%2Fauth%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/7cc4068c4470876c526830778cbdac2fdfd6dc26/django%2Fcontrib%2Fauth%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fsignals.py?ref=7cc4068c4470876c526830778cbdac2fdfd6dc26",
            "patch": "@@ -1,4 +1,5 @@\n from django.dispatch import Signal\n \n user_logged_in = Signal(providing_args=['request', 'user'])\n+user_login_failed = Signal(providing_args=['credentials'])\n user_logged_out = Signal(providing_args=['request', 'user'])"
        },
        {
            "sha": "024f44f547d5ea478cb2ff70434dc27af8998733",
            "filename": "django/contrib/auth/tests/signals.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/7cc4068c4470876c526830778cbdac2fdfd6dc26/django%2Fcontrib%2Fauth%2Ftests%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/7cc4068c4470876c526830778cbdac2fdfd6dc26/django%2Fcontrib%2Fauth%2Ftests%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fsignals.py?ref=7cc4068c4470876c526830778cbdac2fdfd6dc26",
            "patch": "@@ -18,27 +18,41 @@ def listener_login(self, user, **kwargs):\n     def listener_logout(self, user, **kwargs):\n         self.logged_out.append(user)\n \n+    def listener_login_failed(self, sender, credentials, **kwargs):\n+        self.login_failed.append(credentials)\n+\n     def setUp(self):\n         \"\"\"Set up the listeners and reset the logged in/logged out counters\"\"\"\n         self.logged_in = []\n         self.logged_out = []\n+        self.login_failed = []\n         signals.user_logged_in.connect(self.listener_login)\n         signals.user_logged_out.connect(self.listener_logout)\n+        signals.user_login_failed.connect(self.listener_login_failed)\n \n     def tearDown(self):\n         \"\"\"Disconnect the listeners\"\"\"\n         signals.user_logged_in.disconnect(self.listener_login)\n         signals.user_logged_out.disconnect(self.listener_logout)\n+        signals.user_login_failed.disconnect(self.listener_login_failed)\n \n     def test_login(self):\n-        # Only a successful login will trigger the signal.\n+        # Only a successful login will trigger the success signal.\n         self.client.login(username='testclient', password='bad')\n         self.assertEqual(len(self.logged_in), 0)\n+        self.assertEqual(len(self.login_failed), 1)\n+        self.assertEqual(self.login_failed[0]['username'], 'testclient')\n+        # verify the password is cleansed\n+        self.assertTrue('***' in self.login_failed[0]['password'])\n+\n         # Like this:\n         self.client.login(username='testclient', password='password')\n         self.assertEqual(len(self.logged_in), 1)\n         self.assertEqual(self.logged_in[0].username, 'testclient')\n \n+        # Ensure there were no more failures.\n+        self.assertEqual(len(self.login_failed), 1)\n+\n     def test_logout_anonymous(self):\n         # The log_out function will still trigger the signal for anonymous\n         # users."
        },
        {
            "sha": "546170b2a8856fd803ac393a66188b2469582347",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/7cc4068c4470876c526830778cbdac2fdfd6dc26/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/7cc4068c4470876c526830778cbdac2fdfd6dc26/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=7cc4068c4470876c526830778cbdac2fdfd6dc26",
            "patch": "@@ -191,6 +191,10 @@ Django 1.5 also includes several smaller improvements worth noting:\n   recommended as good practice to provide those templates in order to present\n   pretty error pages to the user.\n \n+* :mod:`django.contrib.auth` provides a new signal that is emitted\n+  whenever a user fails to login successfully. See\n+  :data:`~django.contrib.auth.signals.user_login_failed`\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        },
        {
            "sha": "421c371cc96c350e07a1206e59424aad99d2f16e",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/7cc4068c4470876c526830778cbdac2fdfd6dc26/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/7cc4068c4470876c526830778cbdac2fdfd6dc26/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=7cc4068c4470876c526830778cbdac2fdfd6dc26",
            "patch": "@@ -876,13 +876,15 @@ The auth framework uses two :doc:`signals </topics/signals>` that can be used\n for notification when a user logs in or out.\n \n .. data:: django.contrib.auth.signals.user_logged_in\n+   :module:\n+.. versionadded:: 1.3\n \n Sent when a user logs in successfully.\n \n Arguments sent with this signal:\n \n ``sender``\n-    As above: the class of the user that just logged in.\n+    The class of the user that just logged in.\n \n ``request``\n     The current :class:`~django.http.HttpRequest` instance.\n@@ -891,6 +893,8 @@ Arguments sent with this signal:\n     The user instance that just logged in.\n \n .. data:: django.contrib.auth.signals.user_logged_out\n+   :module:\n+.. versionadded:: 1.3\n \n Sent when the logout method is called.\n \n@@ -905,6 +909,21 @@ Sent when the logout method is called.\n     The user instance that just logged out or ``None`` if the\n     user was not authenticated.\n \n+.. data:: django.contrib.auth.signals.user_login_failed\n+   :module:\n+.. versionadded:: 1.5\n+\n+Sent when the user failed to login successfully\n+\n+``sender``\n+    The name of the module used for authentication.\n+\n+``credentials``\n+    A dictonary of keyword arguments containing the user credentials that were\n+    passed to :func:`~django.contrib.auth.authenticate()` or your own custom\n+    authentication backend. Credentials matching a set of 'sensitive' patterns,\n+    (including password) will not be sent in the clear as part of the signal.\n+\n Limiting access to logged-in users\n ----------------------------------\n "
        }
    ],
    "stats": {
        "total": 65,
        "additions": 62,
        "deletions": 3
    }
}