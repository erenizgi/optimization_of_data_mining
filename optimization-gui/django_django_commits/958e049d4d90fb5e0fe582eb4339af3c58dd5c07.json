{
    "author": "jezdez",
    "message": "Fixed #5831 -- Made sure the ForNode reports the correct source of an exception happening in one of the loops. Thanks, Charmless and vladmos.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16605 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "958e049d4d90fb5e0fe582eb4339af3c58dd5c07",
    "files": [
        {
            "sha": "b0f48a844e10079df6cc55373442e4473f308fc2",
            "filename": "django/template/debug.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/django%2Ftemplate%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/django%2Ftemplate%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdebug.py?ref=958e049d4d90fb5e0fe582eb4339af3c58dd5c07",
            "patch": "@@ -78,7 +78,7 @@ def render_node(self, node, context):\n             from sys import exc_info\n             wrapped = TemplateSyntaxError(u'Caught %s while rendering: %s' %\n                 (e.__class__.__name__, force_unicode(e, errors='replace')))\n-            wrapped.source = node.source\n+            wrapped.source = getattr(e, 'template_node_source', node.source)\n             wrapped.exc_info = exc_info()\n             raise wrapped, None, wrapped.exc_info[2]\n         return result"
        },
        {
            "sha": "e7cfae430e3acdc0783181c82e3dafe3413fdd09",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=958e049d4d90fb5e0fe582eb4339af3c58dd5c07",
            "patch": "@@ -227,8 +227,21 @@ def render(self, context):\n                     context.update(unpacked_vars)\n             else:\n                 context[self.loopvars[0]] = item\n-            for node in self.nodelist_loop:\n-                nodelist.append(node.render(context))\n+            # In TEMPLATE_DEBUG mode providing source of the node which\n+            # actually raised an exception to DefaultNodeList.render_node\n+            if settings.TEMPLATE_DEBUG:\n+                for node in self.nodelist_loop:\n+                    try:\n+                        nodelist.append(node.render(context))\n+                    except Exception, e:\n+                        if not hasattr(e, 'template_node_source'):\n+                            from sys import exc_info\n+                            e.template_node_source = node.source\n+                            raise e, None, exc_info()[2]\n+                        raise\n+            else:\n+                for node in self.nodelist_loop:\n+                    nodelist.append(node.render(context))\n             if pop_context:\n                 # The loop variables were pushed on to the context so pop them\n                 # off again. This is necessary because the tag lets the length"
        },
        {
            "sha": "35684242224cc312d5c48f73c6bf1200a2c2072b",
            "filename": "tests/regressiontests/templates/nodelist.py",
            "status": "modified",
            "additions": 36,
            "deletions": 2,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/tests%2Fregressiontests%2Ftemplates%2Fnodelist.py",
            "raw_url": "https://github.com/django/django/raw/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/tests%2Fregressiontests%2Ftemplates%2Fnodelist.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fnodelist.py?ref=958e049d4d90fb5e0fe582eb4339af3c58dd5c07",
            "patch": "@@ -1,8 +1,8 @@\n+from django.conf import settings\n+from django.template import VariableNode, Context, TemplateSyntaxError\n from django.template.loader import get_template_from_string\n-from django.template import VariableNode\n from django.utils.unittest import TestCase\n \n-\n class NodelistTest(TestCase):\n \n     def test_for(self):\n@@ -28,3 +28,37 @@ def test_ifchanged(self):\n         template = get_template_from_string(source)\n         vars = template.nodelist.get_nodes_by_type(VariableNode)\n         self.assertEqual(len(vars), 1)\n+\n+\n+class ErrorIndexTest(TestCase):\n+    \"\"\"\n+    Checks whether index of error is calculated correctly in\n+    template debugger in for loops. Refs ticket #5831\n+    \"\"\"\n+    def setUp(self):\n+        self.old_template_debug = settings.TEMPLATE_DEBUG\n+        settings.TEMPLATE_DEBUG = True\n+\n+    def tearDown(self):\n+        settings.TEMPLATE_DEBUG = self.old_template_debug\n+\n+    def test_correct_exception_index(self):\n+        tests = [\n+            ('{% load bad_tag %}{% for i in range %}{% badsimpletag %}{% endfor %}', (38, 56)),\n+            ('{% load bad_tag %}{% for i in range %}{% for j in range %}{% badsimpletag %}{% endfor %}{% endfor %}', (58, 76)),\n+            ('{% load bad_tag %}{% for i in range %}{% badsimpletag %}{% for j in range %}Hello{% endfor %}{% endfor %}', (38, 56)),\n+            ('{% load bad_tag %}{% for i in range %}{% for j in five %}{% badsimpletag %}{% endfor %}{% endfor %}', (38, 57)),\n+            ('{% load bad_tag %}{% for j in five %}{% badsimpletag %}{% endfor %}', (18, 37)),\n+        ]\n+        context = Context({\n+            'range': range(5),\n+            'five': 5,\n+        })\n+        for source, expected_error_source_index in tests:\n+            template = get_template_from_string(source)\n+            try:\n+                template.render(context)\n+            except TemplateSyntaxError, e:\n+                error_source_index = e.source[1]\n+                self.assertEqual(error_source_index,\n+                                 expected_error_source_index)"
        },
        {
            "sha": "2274395a11a5237585134c3fba81cae66637ecd1",
            "filename": "tests/regressiontests/templates/templatetags/bad_tag.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fbad_tag.py",
            "raw_url": "https://github.com/django/django/raw/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fbad_tag.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fbad_tag.py?ref=958e049d4d90fb5e0fe582eb4339af3c58dd5c07",
            "patch": "@@ -5,3 +5,7 @@\n @register.tag\n def badtag(parser, token):\n     raise RuntimeError(\"I am a bad tag\")\n+\n+@register.simple_tag\n+def badsimpletag():\n+    raise RuntimeError(\"I am a bad simpletag\")"
        },
        {
            "sha": "1d1efe52c7c7cb2b32eeac07a85c892002b92e8f",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/958e049d4d90fb5e0fe582eb4339af3c58dd5c07/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=958e049d4d90fb5e0fe582eb4339af3c58dd5c07",
            "patch": "@@ -32,7 +32,7 @@\n from custom import CustomTagTests, CustomFilterTests\n from parser import ParserTests\n from unicode import UnicodeTests\n-from nodelist import NodelistTest\n+from nodelist import NodelistTest, ErrorIndexTest\n from smartif import *\n from response import *\n "
        }
    ],
    "stats": {
        "total": 63,
        "additions": 57,
        "deletions": 6
    }
}