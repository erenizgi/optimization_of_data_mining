{
    "author": "PaulMcMillan",
    "message": "Fixed #17810. Catch session key errors.\n\nCatches memcached session key errors related to overly long session keys.\nThis is a long-standing bug, but severity was exacerbated by the addition\nof cookie-backed session storage, which generates long session values. If\nan installation switched from cookie-backed session store to memcached,\nusers would not be able to log in because of the server error from overly\nlong memcached keys.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17795 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2ca980195653a754a1c4726f5bb253147c6cb329",
    "files": [
        {
            "sha": "ac6647e110881a386159f2a0f905c0dfffd1f55a",
            "filename": "django/contrib/sessions/backends/cache.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/2ca980195653a754a1c4726f5bb253147c6cb329/django%2Fcontrib%2Fsessions%2Fbackends%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/2ca980195653a754a1c4726f5bb253147c6cb329/django%2Fcontrib%2Fsessions%2Fbackends%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fcache.py?ref=2ca980195653a754a1c4726f5bb253147c6cb329",
            "patch": "@@ -16,7 +16,13 @@ def cache_key(self):\n         return KEY_PREFIX + self._get_or_create_session_key()\n \n     def load(self):\n-        session_data = self._cache.get(self.cache_key)\n+        try:\n+            session_data = self._cache.get(self.cache_key, None)\n+        except Exception as e:\n+            e_type = str(type(e))\n+            if e_type != \"<class 'memcache.MemcachedKeyLengthError'>\":\n+                raise e\n+            session_data = None\n         if session_data is not None:\n             return session_data\n         self.create()"
        },
        {
            "sha": "20804c85f634c14c82e74b26937a6e0f9cf7fa3b",
            "filename": "django/contrib/sessions/backends/cached_db.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/2ca980195653a754a1c4726f5bb253147c6cb329/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "raw_url": "https://github.com/django/django/raw/2ca980195653a754a1c4726f5bb253147c6cb329/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py?ref=2ca980195653a754a1c4726f5bb253147c6cb329",
            "patch": "@@ -21,7 +21,13 @@ def cache_key(self):\n         return KEY_PREFIX + self._get_or_create_session_key()\n \n     def load(self):\n-        data = cache.get(self.cache_key, None)\n+        try:\n+            data = cache.get(self.cache_key, None)\n+        except Exception as e:\n+            e_type = str(type(e))\n+            if e_type != \"<class 'memcache.MemcachedKeyLengthError'>\":\n+                raise e\n+            data = None\n         if data is None:\n             data = super(SessionStore, self).load()\n             cache.set(self.cache_key, data, settings.SESSION_COOKIE_AGE)"
        },
        {
            "sha": "7686bd254eeb2085987d408f6d2cca6be1c8ab80",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 5,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/2ca980195653a754a1c4726f5bb253147c6cb329/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2ca980195653a754a1c4726f5bb253147c6cb329/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=2ca980195653a754a1c4726f5bb253147c6cb329",
            "patch": "@@ -2,7 +2,9 @@\n \n from datetime import datetime, timedelta\n import shutil\n+import string\n import tempfile\n+import warnings\n \n from django.conf import settings\n from django.contrib.sessions.backends.db import SessionStore as DatabaseSession\n@@ -12,10 +14,11 @@\n from django.contrib.sessions.backends.signed_cookies import SessionStore as CookieSession\n from django.contrib.sessions.models import Session\n from django.contrib.sessions.middleware import SessionMiddleware\n+from django.core.cache.backends.base import CacheKeyWarning\n from django.core.exceptions import ImproperlyConfigured, SuspiciousOperation\n from django.http import HttpResponse\n from django.test import TestCase, RequestFactory\n-from django.test.utils import override_settings\n+from django.test.utils import override_settings, get_warnings_state, restore_warnings_state\n from django.utils import timezone\n from django.utils import unittest\n \n@@ -25,7 +28,7 @@ class SessionTestsMixin(object):\n     # class, which wouldn't work, and to allow different TestCase subclasses to\n     # be used.\n \n-    backend = None # subclasses must specify\n+    backend = None  # subclasses must specify\n \n     def setUp(self):\n         self.session = self.backend()\n@@ -119,13 +122,13 @@ def test_iteritems(self):\n         self.assertTrue(hasattr(i, '__iter__'))\n         self.assertTrue(self.session.accessed)\n         self.assertFalse(self.session.modified)\n-        self.assertEqual(list(i), [('x',1)])\n+        self.assertEqual(list(i), [('x', 1)])\n \n     def test_clear(self):\n         self.session['x'] = 1\n         self.session.modified = False\n         self.session.accessed = False\n-        self.assertEqual(self.session.items(), [('x',1)])\n+        self.assertEqual(self.session.items(), [('x', 1)])\n         self.session.clear()\n         self.assertEqual(self.session.items(), [])\n         self.assertTrue(self.session.accessed)\n@@ -280,7 +283,7 @@ def test_sessionmanager_save(self):\n \n         s = Session.objects.get(session_key=self.session.session_key)\n         # Change it\n-        Session.objects.save(s.session_key, {'y':2}, s.expire_date)\n+        Session.objects.save(s.session_key, {'y': 2}, s.expire_date)\n         # Clear cache, so that it will be retrieved from DB\n         del self.session._session_cache\n         self.assertEqual(self.session['y'], 2)\n@@ -298,6 +301,14 @@ def test_exists_searches_cache_first(self):\n         with self.assertNumQueries(0):\n             self.assertTrue(self.session.exists(self.session.session_key))\n \n+    def test_load_overlong_key(self):\n+        warnings_state = get_warnings_state()\n+        warnings.filterwarnings('ignore',\n+                                category=CacheKeyWarning)\n+        self.session._session_key = (string.ascii_letters + string.digits) * 20\n+        self.assertEqual(self.session.load(), {})\n+        restore_warnings_state(warnings_state)\n+\n \n CacheDBSessionWithTimeZoneTests = override_settings(USE_TZ=True)(CacheDBSessionTests)\n \n@@ -339,6 +350,14 @@ class CacheSessionTests(SessionTestsMixin, unittest.TestCase):\n \n     backend = CacheSession\n \n+    def test_load_overlong_key(self):\n+        warnings_state = get_warnings_state()\n+        warnings.filterwarnings('ignore',\n+                                category=CacheKeyWarning)\n+        self.session._session_key = (string.ascii_letters + string.digits) * 20\n+        self.assertEqual(self.session.load(), {})\n+        restore_warnings_state(warnings_state)\n+\n \n class SessionMiddlewareTests(unittest.TestCase):\n \n@@ -394,6 +413,7 @@ def test_no_httponly_session_cookie(self):\n         self.assertNotIn('httponly',\n                          str(response.cookies[settings.SESSION_COOKIE_NAME]))\n \n+\n class CookieSessionTests(SessionTestsMixin, TestCase):\n \n     backend = CookieSession"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 39,
        "deletions": 7
    }
}