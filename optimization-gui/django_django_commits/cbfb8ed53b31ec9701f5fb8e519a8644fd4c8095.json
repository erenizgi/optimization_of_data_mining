{
    "author": "claudep",
    "message": "Fixed a regression in forms changed_data\n\nThanks Loic Bistuer for spotting the regression and the initial\npatch. Refs #16612.",
    "sha": "cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095",
    "files": [
        {
            "sha": "5bc9b2d500069f0fb1dc223b6f3cffe367017442",
            "filename": "django/forms/forms.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095/django%2Fforms%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095/django%2Fforms%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fforms.py?ref=cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095",
            "patch": "@@ -345,8 +345,13 @@ def changed_data(self):\n                 else:\n                     initial_prefixed_name = self.add_initial_prefix(name)\n                     hidden_widget = field.hidden_widget()\n-                    initial_value = field.to_python(hidden_widget.value_from_datadict(\n-                        self.data, self.files, initial_prefixed_name))\n+                    try:\n+                        initial_value = field.to_python(hidden_widget.value_from_datadict(\n+                            self.data, self.files, initial_prefixed_name))\n+                    except ValidationError:\n+                        # Always assume data has changed if validation fails.\n+                        self._changed_data.append(name)\n+                        continue\n                 if hasattr(field.widget, '_has_changed'):\n                     warnings.warn(\"The _has_changed method on widgets is deprecated,\"\n                         \" define it at field level instead.\","
        },
        {
            "sha": "ff4630b7d626d5313fe62c158a0c8219232dd216",
            "filename": "tests/forms_tests/tests/forms.py",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095/tests%2Fforms_tests%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095/tests%2Fforms_tests%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fforms_tests%2Ftests%2Fforms.py?ref=cbfb8ed53b31ec9701f5fb8e519a8644fd4c8095",
            "patch": "@@ -1201,6 +1201,32 @@ class UserRegistration(Form):\n <option value=\"w\">whiz</option>\n </select></li>\"\"\")\n \n+    def test_changed_data(self):\n+        class Person(Form):\n+            first_name = CharField(initial='Hans')\n+            last_name = CharField(initial='Greatel')\n+            birthday = DateField(initial=datetime.date(1974, 8, 16))\n+\n+        p = Person(data={'first_name': 'Hans', 'last_name': 'Scrmbl',\n+                         'birthday': '1974-08-16'})\n+        self.assertTrue(p.is_valid())\n+        self.assertNotIn('first_name', p.changed_data)\n+        self.assertIn('last_name', p.changed_data)\n+        self.assertNotIn('birthday', p.changed_data)\n+\n+        # Test that field raising ValidationError is always in changed_data\n+        class PedanticField(forms.Field):\n+            def to_python(self, value):\n+                raise ValidationError('Whatever')\n+\n+        class Person2(Person):\n+            pedantic = PedanticField(initial='whatever', show_hidden_initial=True)\n+\n+        p = Person2(data={'first_name': 'Hans', 'last_name': 'Scrmbl',\n+                         'birthday': '1974-08-16', 'initial-pedantic': 'whatever'})\n+        self.assertFalse(p.is_valid())\n+        self.assertIn('pedantic', p.changed_data)\n+\n     def test_boundfield_values(self):\n         # It's possible to get to the value which would be used for rendering\n         # the widget for a field by using the BoundField's value method."
        }
    ],
    "stats": {
        "total": 35,
        "additions": 33,
        "deletions": 2
    }
}