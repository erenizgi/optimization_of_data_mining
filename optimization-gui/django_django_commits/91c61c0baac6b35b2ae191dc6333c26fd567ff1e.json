{
    "author": "unknown",
    "message": "Fixed #14149: Initialize the Oracle connection.operators at connection time since some systems don't seem to like the \"TRANSLATE\" trick.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15299 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "91c61c0baac6b35b2ae191dc6333c26fd567ff1e",
    "files": [
        {
            "sha": "442378cd28abb94723a2b7e5284239fe921ff11d",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 42,
            "deletions": 1,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/91c61c0baac6b35b2ae191dc6333c26fd567ff1e/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/91c61c0baac6b35b2ae191dc6333c26fd567ff1e/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=91c61c0baac6b35b2ae191dc6333c26fd567ff1e",
            "patch": "@@ -365,9 +365,24 @@ def combine_expression(self, connector, sub_expressions):\n         return super(DatabaseOperations, self).combine_expression(connector, sub_expressions)\n \n \n+class _UninitializedOperatorsDescriptor(object):\n+\n+    def __get__(self, instance, owner):\n+        # If connection.operators is looked up before a connection has been\n+        # created, transparently initialize connection.operators to avert an\n+        # AttributeError.\n+        if instance is None:\n+            raise AttributeError(\"operators not available as class attribute\")\n+        # Creating a cursor will initialize the operators.\n+        instance.cursor().close()\n+        return instance.__dict__['operators']\n+\n+\n class DatabaseWrapper(BaseDatabaseWrapper):\n     vendor = 'oracle'\n-    operators = {\n+    operators = _UninitializedOperatorsDescriptor()\n+\n+    _standard_operators = {\n         'exact': '= %s',\n         'iexact': '= UPPER(%s)',\n         'contains': \"LIKE TRANSLATE(%s USING NCHAR_CS) ESCAPE TRANSLATE('\\\\' USING NCHAR_CS)\",\n@@ -382,6 +397,16 @@ class DatabaseWrapper(BaseDatabaseWrapper):\n         'iendswith': \"LIKE UPPER(TRANSLATE(%s USING NCHAR_CS)) ESCAPE TRANSLATE('\\\\' USING NCHAR_CS)\",\n     }\n \n+    _likec_operators = _standard_operators.copy()\n+    _likec_operators.update({\n+        'contains': \"LIKEC %s ESCAPE '\\\\'\",\n+        'icontains': \"LIKEC UPPER(%s) ESCAPE '\\\\'\",\n+        'startswith': \"LIKEC %s ESCAPE '\\\\'\",\n+        'endswith': \"LIKEC %s ESCAPE '\\\\'\",\n+        'istartswith': \"LIKEC UPPER(%s) ESCAPE '\\\\'\",\n+        'iendswith': \"LIKEC UPPER(%s) ESCAPE '\\\\'\",\n+    })\n+\n     def __init__(self, *args, **kwargs):\n         super(DatabaseWrapper, self).__init__(*args, **kwargs)\n \n@@ -426,6 +451,22 @@ def _cursor(self):\n             cursor.execute(\"ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD HH24:MI:SS' \"\n                            \"NLS_TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS.FF' \"\n                            \"NLS_TERRITORY = 'AMERICA'\")\n+\n+            if 'operators' not in self.__dict__:\n+                # Ticket #14149: Check whether our LIKE implementation will\n+                # work for this connection or we need to fall back on LIKEC.\n+                # This check is performed only once per DatabaseWrapper\n+                # instance per thread, since subsequent connections will use\n+                # the same settings.\n+                try:\n+                    cursor.execute(\"SELECT 1 FROM DUAL WHERE DUMMY %s\"\n+                                   % self._standard_operators['contains'],\n+                                   ['X'])\n+                except utils.DatabaseError:\n+                    self.operators = self._likec_operators\n+                else:\n+                    self.operators = self._standard_operators\n+\n             try:\n                 self.oracle_version = int(self.connection.version.split('.')[0])\n                 # There's no way for the DatabaseOperations class to know the"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 42,
        "deletions": 1
    }
}