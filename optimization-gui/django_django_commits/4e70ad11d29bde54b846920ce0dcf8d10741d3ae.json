{
    "author": "claudep",
    "message": "Made FileSystemStorage accept both text and byte streams\n\nThanks Alexey Boriskin for his help on the patch.",
    "sha": "4e70ad11d29bde54b846920ce0dcf8d10741d3ae",
    "files": [
        {
            "sha": "0b300cd31e462157b2da4aa63328a519fff8e6a4",
            "filename": "django/core/files/storage.py",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/4e70ad11d29bde54b846920ce0dcf8d10741d3ae/django%2Fcore%2Ffiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/4e70ad11d29bde54b846920ce0dcf8d10741d3ae/django%2Fcore%2Ffiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fstorage.py?ref=4e70ad11d29bde54b846920ce0dcf8d10741d3ae",
            "patch": "@@ -195,11 +195,18 @@ def _save(self, name, content):\n                     fd = os.open(full_path, os.O_WRONLY | os.O_CREAT | os.O_EXCL | getattr(os, 'O_BINARY', 0))\n                     try:\n                         locks.lock(fd, locks.LOCK_EX)\n+                        _file = None\n                         for chunk in content.chunks():\n-                            os.write(fd, chunk)\n+                            if _file is None:\n+                                mode = 'wb' if isinstance(chunk, bytes) else 'wt'\n+                                _file = os.fdopen(fd, mode)\n+                            _file.write(chunk)\n                     finally:\n                         locks.unlock(fd)\n-                        os.close(fd)\n+                        if _file is not None:\n+                            _file.close()\n+                        else:\n+                            os.close(fd)\n             except OSError as e:\n                 if e.errno == errno.EEXIST:\n                     # Ooops, the file exists. We need a new file name."
        },
        {
            "sha": "87b509e320e06f48212f1b55f8be1d0c1f06ac39",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/4e70ad11d29bde54b846920ce0dcf8d10741d3ae/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4e70ad11d29bde54b846920ce0dcf8d10741d3ae/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=4e70ad11d29bde54b846920ce0dcf8d10741d3ae",
            "patch": "@@ -356,6 +356,17 @@ def fake_remove(path):\n         finally:\n             os.remove = real_remove\n \n+    def test_file_chunks_error(self):\n+        \"\"\"\n+        Test behaviour when file.chunks() is raising an error\n+        \"\"\"\n+        f1 = ContentFile('chunks fails')\n+        def failing_chunks():\n+            raise IOError\n+        f1.chunks = failing_chunks\n+        with self.assertRaises(IOError):\n+            self.storage.save('error.file', f1)\n+\n \n class CustomStorage(FileSystemStorage):\n     def get_available_name(self, name):"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 20,
        "deletions": 2
    }
}