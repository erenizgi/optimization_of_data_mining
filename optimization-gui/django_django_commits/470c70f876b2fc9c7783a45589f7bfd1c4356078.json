{
    "author": "SmileyChris",
    "message": "Fixes #16664 -- URLField's to_python method fails with ValueError on some urls on python 2.7. Based on patch by zigzag.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16752 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "470c70f876b2fc9c7783a45589f7bfd1c4356078",
    "files": [
        {
            "sha": "ab83b8b411de8d4cd5f2d8313258fbcc8cc57f65",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/470c70f876b2fc9c7783a45589f7bfd1c4356078/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/470c70f876b2fc9c7783a45589f7bfd1c4356078/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=470c70f876b2fc9c7783a45589f7bfd1c4356078",
            "patch": "@@ -583,9 +583,22 @@ def __init__(self, max_length=None, min_length=None, verify_exists=False,\n         self.validators.append(validators.URLValidator(verify_exists=verify_exists, validator_user_agent=validator_user_agent))\n \n     def to_python(self, value):\n+\n+        def split_url(url):\n+            \"\"\"\n+            Returns a list of url parts via ``urlparse.urlsplit`` (or raises a\n+            ``ValidationError`` exception for certain).\n+            \"\"\"\n+            try:\n+                return list(urlparse.urlsplit(url))\n+            except ValueError:\n+                # urlparse.urlsplit can raise a ValueError with some\n+                # misformatted URLs.\n+                raise ValidationError(self.error_messages['invalid'])\n+\n         value = super(URLField, self).to_python(value)\n         if value:\n-            url_fields = list(urlparse.urlsplit(value))\n+            url_fields = split_url(value)\n             if not url_fields[0]:\n                 # If no URL scheme given, assume http://\n                 url_fields[0] = 'http'\n@@ -596,8 +609,7 @@ def to_python(self, value):\n                 url_fields[2] = ''\n                 # Rebuild the url_fields list, since the domain segment may now\n                 # contain the path too.\n-                value = urlparse.urlunsplit(url_fields)\n-                url_fields = list(urlparse.urlsplit(value))\n+                url_fields = split_url(urlparse.urlunsplit(url_fields))\n             if not url_fields[2]:\n                 # the path portion may need to be added before query params\n                 url_fields[2] = '/'"
        },
        {
            "sha": "5755501e8956c402e7e2efb718f612d9e912e1f5",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/470c70f876b2fc9c7783a45589f7bfd1c4356078/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/470c70f876b2fc9c7783a45589f7bfd1c4356078/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=470c70f876b2fc9c7783a45589f7bfd1c4356078",
            "patch": "@@ -587,6 +587,8 @@ def test_urlfield_1(self):\n         self.assertEqual(u'http://valid-----hyphens.com/', f.clean('http://valid-----hyphens.com'))\n         self.assertEqual(u'http://some.idn.xyz\\xe4\\xf6\\xfc\\xdfabc.domain.com:123/blah', f.clean('http://some.idn.xyzäöüßabc.domain.com:123/blah'))\n         self.assertEqual(u'http://www.example.com/s/http://code.djangoproject.com/ticket/13804', f.clean('www.example.com/s/http://code.djangoproject.com/ticket/13804'))\n+        self.assertRaisesMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, '[a')\n+        self.assertRaisesMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, 'http://[a')\n \n     def test_url_regex_ticket11198(self):\n         f = URLField()"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 17,
        "deletions": 3
    }
}