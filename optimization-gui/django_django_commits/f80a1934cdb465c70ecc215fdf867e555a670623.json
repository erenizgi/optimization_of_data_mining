{
    "author": "akaariai",
    "message": "Fixed GIS regression in get_default_columns()\n\nI changed the normal compiler's get_default_columns() but didn't change\nthe copy-pasted code in GIS compiler's get_default_columns().\n\nRefs #19385",
    "sha": "f80a1934cdb465c70ecc215fdf867e555a670623",
    "files": [
        {
            "sha": "fc53d08ffd394fca31222e645e5c32e049873530",
            "filename": "django/contrib/gis/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 4,
            "deletions": 17,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/f80a1934cdb465c70ecc215fdf867e555a670623/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/f80a1934cdb465c70ecc215fdf867e555a670623/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=f80a1934cdb465c70ecc215fdf867e555a670623",
            "patch": "@@ -119,29 +119,16 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n         result = []\n         if opts is None:\n             opts = self.query.model._meta\n-        # Skip all proxy to the root proxied model\n-        opts = opts.concrete_model._meta\n         aliases = set()\n         only_load = self.deferred_to_columns()\n-\n+        seen = self.query.included_inherited_models.copy()\n         if start_alias:\n-            seen = {None: start_alias}\n+            seen[None] = start_alias\n         for field, model in opts.get_fields_with_model():\n             if from_parent and model is not None and issubclass(from_parent, model):\n+                # Avoid loading data for already loaded parents.\n                 continue\n-            if start_alias:\n-                try:\n-                    alias = seen[model]\n-                except KeyError:\n-                    link_field = opts.get_ancestor_link(model)\n-                    alias = self.query.join((start_alias, model._meta.db_table,\n-                            link_field.column, model._meta.pk.column))\n-                    seen[model] = alias\n-            else:\n-                # If we're starting from the base model of the queryset, the\n-                # aliases will have already been set up in pre_sql_setup(), so\n-                # we can save time here.\n-                alias = self.query.included_inherited_models[model]\n+            alias = self.query.join_parent_model(opts, model, start_alias, seen)\n             table = self.query.alias_map[alias].table_name\n             if table in only_load and field.column not in only_load[table]:\n                 continue"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 4,
        "deletions": 17
    }
}