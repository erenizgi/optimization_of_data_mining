{
    "author": "akaariai",
    "message": "Fix proxy model Query.remove_inherited_models()\n\nFixed #18248 -- proxy models were added to included_inherited_models\nin sql.query.Query. The variable is meant to be used for multitable\ninheritance only. This mistake caused problems in situations where\nproxy model's query was reused.",
    "sha": "c2e1ecb4b136016ab2996712aa0583fd91657bc9",
    "files": [
        {
            "sha": "33949f5a7166cdb18f68e13033d8c098a82093e5",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/c2e1ecb4b136016ab2996712aa0583fd91657bc9/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/c2e1ecb4b136016ab2996712aa0583fd91657bc9/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=c2e1ecb4b136016ab2996712aa0583fd91657bc9",
            "patch": "@@ -261,12 +261,12 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n         result = []\n         if opts is None:\n             opts = self.query.model._meta\n+        # Skip all proxy to the root proxied model\n+        opts = opts.concrete_model._meta\n         qn = self.quote_name_unless_alias\n         qn2 = self.connection.ops.quote_name\n         aliases = set()\n         only_load = self.deferred_to_columns()\n-        # Skip all proxy to the root proxied model\n-        proxied_model = opts.concrete_model\n \n         if start_alias:\n             seen = {None: start_alias}\n@@ -277,12 +277,9 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n                 try:\n                     alias = seen[model]\n                 except KeyError:\n-                    if model is proxied_model:\n-                        alias = start_alias\n-                    else:\n-                        link_field = opts.get_ancestor_link(model)\n-                        alias = self.query.join((start_alias, model._meta.db_table,\n-                                link_field.column, model._meta.pk.column))\n+                    link_field = opts.get_ancestor_link(model)\n+                    alias = self.query.join((start_alias, model._meta.db_table,\n+                            link_field.column, model._meta.pk.column))\n                     seen[model] = alias\n             else:\n                 # If we're starting from the base model of the queryset, the"
        },
        {
            "sha": "c91215fa9eed91513cb955a5ad8430d2989b839c",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/c2e1ecb4b136016ab2996712aa0583fd91657bc9/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/c2e1ecb4b136016ab2996712aa0583fd91657bc9/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=c2e1ecb4b136016ab2996712aa0583fd91657bc9",
            "patch": "@@ -933,21 +933,16 @@ def setup_inherited_models(self):\n         whereas column determination is a later part, and side-effect, of\n         as_sql()).\n         \"\"\"\n-        opts = self.model._meta\n+        # Skip all proxy models\n+        opts = self.model._meta.concrete_model._meta\n         root_alias = self.tables[0]\n         seen = {None: root_alias}\n \n-        # Skip all proxy to the root proxied model\n-        proxied_model = opts.concrete_model\n-\n         for field, model in opts.get_fields_with_model():\n             if model not in seen:\n-                if model is proxied_model:\n-                    seen[model] = root_alias\n-                else:\n-                    link_field = opts.get_ancestor_link(model)\n-                    seen[model] = self.join((root_alias, model._meta.db_table,\n-                            link_field.column, model._meta.pk.column))\n+                link_field = opts.get_ancestor_link(model)\n+                seen[model] = self.join((root_alias, model._meta.db_table,\n+                        link_field.column, model._meta.pk.column))\n         self.included_inherited_models = seen\n \n     def remove_inherited_models(self):"
        },
        {
            "sha": "07aa6db67b032cd73cf3f2903e449be5a5a315b2",
            "filename": "tests/regressiontests/queries/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/c2e1ecb4b136016ab2996712aa0583fd91657bc9/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/c2e1ecb4b136016ab2996712aa0583fd91657bc9/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Fmodels.py?ref=c2e1ecb4b136016ab2996712aa0583fd91657bc9",
            "patch": "@@ -10,6 +10,10 @@\n class DumbCategory(models.Model):\n     pass\n \n+class ProxyCategory(DumbCategory):\n+    class Meta:\n+        proxy = True\n+\n class NamedCategory(DumbCategory):\n     name = models.CharField(max_length=10)\n "
        },
        {
            "sha": "8e86903724bf58d5f2d5f15c6d120e5131585fbf",
            "filename": "tests/regressiontests/queries/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/c2e1ecb4b136016ab2996712aa0583fd91657bc9/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c2e1ecb4b136016ab2996712aa0583fd91657bc9/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Ftests.py?ref=c2e1ecb4b136016ab2996712aa0583fd91657bc9",
            "patch": "@@ -19,7 +19,7 @@\n     ManagedModel, Member, NamedCategory, Note, Number, Plaything, PointerA,\n     Ranking, Related, Report, ReservedName, Tag, TvChef, Valid, X, Food, Eaten,\n     Node, ObjectA, ObjectB, ObjectC, CategoryItem, SimpleCategory,\n-    SpecialCategory, OneToOneCategory, NullableName)\n+    SpecialCategory, OneToOneCategory, NullableName, ProxyCategory)\n \n \n class BaseQuerysetTest(TestCase):\n@@ -1952,3 +1952,15 @@ def test_joined_exclude(self):\n             DumbCategory.objects.exclude(namedcategory__name__in=['nonexisting']),\n             [self.nc.pk], attrgetter('pk')\n         )\n+\n+class ProxyQueryCleanupTest(TestCase):\n+    def test_evaluated_proxy_count(self):\n+        \"\"\"\n+        Test that generating the query string doesn't alter the query's state\n+        in irreversible ways. Refs #18248.\n+        \"\"\"\n+        ProxyCategory.objects.create()\n+        qs = ProxyCategory.objects.all()\n+        self.assertEqual(qs.count(), 1)\n+        str(qs.query)\n+        self.assertEqual(qs.count(), 1)"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 27,
        "deletions": 19
    }
}