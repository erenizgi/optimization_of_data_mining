{
    "author": "claudep",
    "message": "Fixed #17760 -- Implemented callable database features as cached properties\n\nThis does remove the requirement to call features.confirm() method\nbefore checking the properties.\nThanks cdestiger and Ramiro Morales for their work on the patch.",
    "sha": "aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
    "files": [
        {
            "sha": "31f2fca1bd691c4d29cc14911f3c2b8de4e180c4",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -31,9 +31,6 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         self.connection.close()\n         self.connection.settings_dict[\"NAME\"] = test_database_name\n \n-        # Confirm the feature set of the test database\n-        self.connection.features.confirm()\n-\n         # Need to load the SpatiaLite initialization SQL before running `syncdb`.\n         self.load_spatialite_sql()\n "
        },
        {
            "sha": "d70fe54bdb3fe8d62af76e090c26a8be9e1280d5",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 9,
            "deletions": 22,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -10,6 +10,7 @@\n from django.db import DEFAULT_DB_ALIAS\n from django.db.backends import util\n from django.db.transaction import TransactionManagementError\n+from django.utils.functional import cached_property\n from django.utils.importlib import import_module\n from django.utils.timezone import is_aware\n \n@@ -402,28 +403,19 @@ class BaseDatabaseFeatures(object):\n     # Does the backend reset sequences between tests?\n     supports_sequence_reset = True\n \n-    # Features that need to be confirmed at runtime\n-    # Cache whether the confirmation has been performed.\n-    _confirmed = False\n-    supports_transactions = None\n-    supports_stddev = None\n-    can_introspect_foreign_keys = None\n+    # Confirm support for introspected foreign keys\n+    # Every database can do this reliably, except MySQL,\n+    # which can't do it for MyISAM tables\n+    can_introspect_foreign_keys = True\n \n     # Support for the DISTINCT ON clause\n     can_distinct_on_fields = False\n \n     def __init__(self, connection):\n         self.connection = connection\n \n-    def confirm(self):\n-        \"Perform manual checks of any database features that might vary between installs\"\n-        if not self._confirmed:\n-            self._confirmed = True\n-            self.supports_transactions = self._supports_transactions()\n-            self.supports_stddev = self._supports_stddev()\n-            self.can_introspect_foreign_keys = self._can_introspect_foreign_keys()\n-\n-    def _supports_transactions(self):\n+    @cached_property\n+    def supports_transactions(self):\n         \"Confirm support for transactions\"\n         cursor = self.connection.cursor()\n         cursor.execute('CREATE TABLE ROLLBACK_TEST (X INT)')\n@@ -436,7 +428,8 @@ def _supports_transactions(self):\n         self.connection._commit()\n         return count == 0\n \n-    def _supports_stddev(self):\n+    @cached_property\n+    def supports_stddev(self):\n         \"Confirm support for STDDEV and related stats functions\"\n         class StdDevPop(object):\n             sql_function = 'STDDEV_POP'\n@@ -447,12 +440,6 @@ class StdDevPop(object):\n         except NotImplementedError:\n             return False\n \n-    def _can_introspect_foreign_keys(self):\n-        \"Confirm support for introspected foreign keys\"\n-        # Every database can do this reliably, except MySQL,\n-        # which can't do it for MyISAM tables\n-        return True\n-\n \n class BaseDatabaseOperations(object):\n     \"\"\""
        },
        {
            "sha": "0f06131bc4c889108b24cce8b1f120d4a70da39e",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -264,9 +264,6 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         self.connection.close()\n         self.connection.settings_dict[\"NAME\"] = test_database_name\n \n-        # Confirm the feature set of the test database\n-        self.connection.features.confirm()\n-\n         # Report syncdb messages at one level lower than that requested.\n         # This ensures we don't get flooded with messages during testing\n         # (unless you really ask to be flooded)"
        },
        {
            "sha": "9de32876083c555ff333b2f0cd3b710c176c3fd9",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -37,6 +37,7 @@\n from django.db.backends.mysql.creation import DatabaseCreation\n from django.db.backends.mysql.introspection import DatabaseIntrospection\n from django.db.backends.mysql.validation import DatabaseValidation\n+from django.utils.functional import cached_property\n from django.utils.safestring import SafeString, SafeUnicode\n from django.utils import timezone\n \n@@ -170,26 +171,25 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n \n     def __init__(self, connection):\n         super(DatabaseFeatures, self).__init__(connection)\n-        self._storage_engine = None\n \n+    @cached_property\n     def _mysql_storage_engine(self):\n         \"Internal method used in Django tests. Don't rely on this from your code\"\n-        if self._storage_engine is None:\n-            cursor = self.connection.cursor()\n-            cursor.execute('CREATE TABLE INTROSPECT_TEST (X INT)')\n-            # This command is MySQL specific; the second column\n-            # will tell you the default table type of the created\n-            # table. Since all Django's test tables will have the same\n-            # table type, that's enough to evaluate the feature.\n-            cursor.execute(\"SHOW TABLE STATUS WHERE Name='INTROSPECT_TEST'\")\n-            result = cursor.fetchone()\n-            cursor.execute('DROP TABLE INTROSPECT_TEST')\n-            self._storage_engine = result[1]\n-        return self._storage_engine\n-\n-    def _can_introspect_foreign_keys(self):\n+        cursor = self.connection.cursor()\n+        cursor.execute('CREATE TABLE INTROSPECT_TEST (X INT)')\n+        # This command is MySQL specific; the second column\n+        # will tell you the default table type of the created\n+        # table. Since all Django's test tables will have the same\n+        # table type, that's enough to evaluate the feature.\n+        cursor.execute(\"SHOW TABLE STATUS WHERE Name='INTROSPECT_TEST'\")\n+        result = cursor.fetchone()\n+        cursor.execute('DROP TABLE INTROSPECT_TEST')\n+        return result[1]\n+\n+    @cached_property\n+    def can_introspect_foreign_keys(self):\n         \"Confirm support for introspected foreign keys\"\n-        return self._mysql_storage_engine() != 'MyISAM'\n+        return self._mysql_storage_engine != 'MyISAM'\n \n class DatabaseOperations(BaseDatabaseOperations):\n     compiler_module = \"django.db.backends.mysql.compiler\""
        },
        {
            "sha": "c59905b29ae166acfb7afd89e93df6d07d13d14f",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -19,6 +19,7 @@\n from django.db.backends.sqlite3.creation import DatabaseCreation\n from django.db.backends.sqlite3.introspection import DatabaseIntrospection\n from django.utils.dateparse import parse_date, parse_datetime, parse_time\n+from django.utils.functional import cached_property\n from django.utils.safestring import SafeString\n from django.utils import timezone\n \n@@ -86,7 +87,8 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     has_bulk_insert = True\n     can_combine_inserts_with_and_without_auto_increment_pk = True\n \n-    def _supports_stddev(self):\n+    @cached_property\n+    def supports_stddev(self):\n         \"\"\"Confirm support for STDDEV and related stats functions\n \n         SQLite supports STDDEV as an extension package; so"
        },
        {
            "sha": "53551fa54de00effc31cf31d29f6419000052fcc",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -403,8 +403,7 @@ def test_database_operations_helper_class(self):\n         self.assertTrue(hasattr(connection.ops, 'connection'))\n         self.assertEqual(connection, connection.ops.connection)\n \n-    def test_supports_needed_confirm(self):\n-        connection.features.confirm()\n+    def test_cached_db_features(self):\n         self.assertIn(connection.features.supports_transactions, (True, False))\n         self.assertIn(connection.features.supports_stddev, (True, False))\n         self.assertIn(connection.features.can_introspect_foreign_keys, (True, False))"
        },
        {
            "sha": "abd7a4ceaa17358d57afb048d2ed0c49db30f503",
            "filename": "tests/regressiontests/transactions_regress/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/aa423575e7b464433fcfc4bf4b8e1d7627b17ce6/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py?ref=aa423575e7b464433fcfc4bf4b8e1d7627b17ce6",
            "patch": "@@ -208,7 +208,7 @@ def work():\n         work()\n \n     @skipIf(connection.vendor == 'mysql' and \\\n-            connection.features._mysql_storage_engine() == 'MyISAM',\n+            connection.features._mysql_storage_engine == 'MyISAM',\n             \"MyISAM MySQL storage engine doesn't support savepoints\")\n     @skipUnlessDBFeature('uses_savepoints')\n     def test_savepoint_rollback(self):"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 30,
        "deletions": 48
    }
}