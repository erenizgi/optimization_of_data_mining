{
    "author": "jezdez",
    "message": "Fixed #8536 -- Made sure the makemessages management command cleans up after throwing an error. Thanks to Ramiro for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15506 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "204e83e3318dff37bb9dc1d4e9019782188e0466",
    "files": [
        {
            "sha": "a244a60de502c1e0667bd6da30f903724f57dcfe",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 43,
            "deletions": 28,
            "changes": 71,
            "blob_url": "https://github.com/django/django/blob/204e83e3318dff37bb9dc1d4e9019782188e0466/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/204e83e3318dff37bb9dc1d4e9019782188e0466/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=204e83e3318dff37bb9dc1d4e9019782188e0466",
            "patch": "@@ -201,16 +201,21 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n                 )\n                 msgs, errors = _popen(cmd)\n                 if errors:\n-                    raise CommandError(\"errors happened while running xgettext on %s\\n%s\" % (file, errors))\n-                old = '#: '+os.path.join(dirpath, thefile)[2:]\n-                new = '#: '+os.path.join(dirpath, file)[2:]\n-                msgs = msgs.replace(old, new)\n-                if os.path.exists(potfile):\n-                    # Strip the header\n-                    msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n-                else:\n-                    msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n+                    os.unlink(os.path.join(dirpath, thefile))\n+                    if os.path.exists(potfile):\n+                        os.unlink(potfile)\n+                    raise CommandError(\n+                        \"errors happened while running xgettext on %s\\n%s\" %\n+                        (file, errors))\n                 if msgs:\n+                    old = '#: ' + os.path.join(dirpath, thefile)[2:]\n+                    new = '#: ' + os.path.join(dirpath, file)[2:]\n+                    msgs = msgs.replace(old, new)\n+                    if os.path.exists(potfile):\n+                        # Strip the header\n+                        msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n+                    else:\n+                        msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n                     f = open(potfile, 'ab')\n                     try:\n                         f.write(msgs)\n@@ -242,18 +247,23 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n                 )\n                 msgs, errors = _popen(cmd)\n                 if errors:\n-                    raise CommandError(\"errors happened while running xgettext on %s\\n%s\" % (file, errors))\n-\n-                if thefile != file:\n-                    old = '#: '+os.path.join(dirpath, thefile)[2:]\n-                    new = '#: '+orig_file[2:]\n-                    msgs = msgs.replace(old, new)\n-                if os.path.exists(potfile):\n-                    # Strip the header\n-                    msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n-                else:\n-                    msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n+                    if thefile != file:\n+                        os.unlink(os.path.join(dirpath, thefile))\n+                    if os.path.exists(potfile):\n+                        os.unlink(potfile)\n+                    raise CommandError(\n+                        \"errors happened while running xgettext on %s\\n%s\" %\n+                        (file, errors))\n                 if msgs:\n+                    if thefile != file:\n+                        old = '#: ' + os.path.join(dirpath, thefile)[2:]\n+                        new = '#: ' + orig_file[2:]\n+                        msgs = msgs.replace(old, new)\n+                    if os.path.exists(potfile):\n+                        # Strip the header\n+                        msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n+                    else:\n+                        msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n                     f = open(potfile, 'ab')\n                     try:\n                         f.write(msgs)\n@@ -266,17 +276,21 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n             msgs, errors = _popen('msguniq %s --to-code=utf-8 \"%s\"' %\n                                   (wrap, potfile))\n             if errors:\n-                raise CommandError(\"errors happened while running msguniq\\n%s\" % errors)\n-            f = open(potfile, 'w')\n-            try:\n-                f.write(msgs)\n-            finally:\n-                f.close()\n+                os.unlink(potfile)\n+                raise CommandError(\n+                    \"errors happened while running msguniq\\n%s\" % errors)\n             if os.path.exists(pofile):\n+                f = open(potfile, 'w')\n+                try:\n+                    f.write(msgs)\n+                finally:\n+                    f.close()\n                 msgs, errors = _popen('msgmerge %s -q \"%s\" \"%s\"' %\n                                       (wrap, pofile, potfile))\n                 if errors:\n-                    raise CommandError(\"errors happened while running msgmerge\\n%s\" % errors)\n+                    os.unlink(potfile)\n+                    raise CommandError(\n+                        \"errors happened while running msgmerge\\n%s\" % errors)\n             elif not invoked_for_django:\n                 msgs = copy_plural_forms(msgs, locale, domain, verbosity)\n             msgs = msgs.replace(\n@@ -291,7 +305,8 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n                 msgs, errors = _popen('msgattrib %s -o \"%s\" --no-obsolete \"%s\"' %\n                                       (wrap, pofile, pofile))\n                 if errors:\n-                    raise CommandError(\"errors happened while running msgattrib\\n%s\" % errors)\n+                    raise CommandError(\n+                        \"errors happened while running msgattrib\\n%s\" % errors)\n \n \n class Command(NoArgsCommand):"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 43,
        "deletions": 28
    }
}