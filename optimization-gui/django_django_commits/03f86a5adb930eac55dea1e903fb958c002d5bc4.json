{
    "author": "aaugustin",
    "message": "Fixed #18354 -- Performance issue in CBV.\n\nPrevented repeating a query twice when the model isn't ordered by\n-date_field (in Meta), allow_empty is False and pagination isn't\nenabled.",
    "sha": "03f86a5adb930eac55dea1e903fb958c002d5bc4",
    "files": [
        {
            "sha": "804e03dd20ac405643822af083a3dfccfaae0ed3",
            "filename": "django/views/generic/dates.py",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/03f86a5adb930eac55dea1e903fb958c002d5bc4/django%2Fviews%2Fgeneric%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/03f86a5adb930eac55dea1e903fb958c002d5bc4/django%2Fviews%2Fgeneric%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Fdates.py?ref=03f86a5adb930eac55dea1e903fb958c002d5bc4",
            "patch": "@@ -315,7 +315,7 @@ def get_dated_items(self):\n         \"\"\"\n         raise NotImplementedError('A DateView must provide an implementation of get_dated_items()')\n \n-    def get_dated_queryset(self, **lookup):\n+    def get_dated_queryset(self, ordering=None, **lookup):\n         \"\"\"\n         Get a queryset properly filtered according to `allow_future` and any\n         extra lookup kwargs.\n@@ -326,6 +326,9 @@ def get_dated_queryset(self, **lookup):\n         allow_empty = self.get_allow_empty()\n         paginate_by = self.get_paginate_by(qs)\n \n+        if ordering is not None:\n+            qs = qs.order_by(ordering)\n+\n         if not allow_future:\n             now = timezone.now() if self.uses_datetime_field else timezone_today()\n             qs = qs.filter(**{'%s__lte' % date_field: now})\n@@ -370,15 +373,13 @@ def get_dated_items(self):\n         \"\"\"\n         Return (date_list, items, extra_context) for this request.\n         \"\"\"\n-        qs = self.get_dated_queryset()\n+        qs = self.get_dated_queryset(ordering='-%s' % self.get_date_field())\n         date_list = self.get_date_list(qs, 'year')\n \n-        if date_list:\n-            object_list = qs.order_by('-' + self.get_date_field())\n-        else:\n-            object_list = qs.none()\n+        if not date_list:\n+            qs = qs.none()\n \n-        return (date_list, object_list, {})\n+        return (date_list, qs, {})\n \n \n class ArchiveIndexView(MultipleObjectTemplateResponseMixin, BaseArchiveIndexView):\n@@ -410,17 +411,15 @@ def get_dated_items(self):\n             '%s__lt' % date_field: until,\n         }\n \n-        qs = self.get_dated_queryset(**lookup_kwargs)\n+        qs = self.get_dated_queryset(ordering='-%s' % date_field, **lookup_kwargs)\n         date_list = self.get_date_list(qs, 'month')\n \n-        if self.get_make_object_list():\n-            object_list = qs.order_by('-' + date_field)\n-        else:\n+        if not self.get_make_object_list():\n             # We need this to be a queryset since parent classes introspect it\n             # to find information about the model.\n-            object_list = qs.none()\n+            qs = qs.none()\n \n-        return (date_list, object_list, {'year': year})\n+        return (date_list, qs, {'year': year})\n \n     def get_make_object_list(self):\n         \"\"\""
        },
        {
            "sha": "8f82dddbcf123697d2956b58ed0ec69de5cf7abf",
            "filename": "tests/regressiontests/generic_views/dates.py",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py?ref=03f86a5adb930eac55dea1e903fb958c002d5bc4",
            "patch": "@@ -86,10 +86,15 @@ def test_paginated_archive_view_does_not_load_entire_table(self):\n         # 1 query for years list + 1 query for books\n         with self.assertNumQueries(2):\n             self.client.get('/dates/books/')\n-        # same as above + 1 query to test if books exist\n-        with self.assertNumQueries(3):\n+        # same as above + 1 query to test if books exist + 1 query to count them\n+        with self.assertNumQueries(4):\n             self.client.get('/dates/books/paginated/')\n \n+    def test_no_duplicate_query(self):\n+        # Regression test for #18354\n+        with self.assertNumQueries(2):\n+            self.client.get('/dates/books/reverse/')\n+\n     def test_datetime_archive_view(self):\n         BookSigning.objects.create(event_date=datetime.datetime(2008, 4, 2, 12, 0))\n         res = self.client.get('/dates/booksignings/')\n@@ -155,6 +160,11 @@ def test_year_view_invalid_pattern(self):\n         res = self.client.get('/dates/books/no_year/')\n         self.assertEqual(res.status_code, 404)\n \n+    def test_no_duplicate_query(self):\n+        # Regression test for #18354\n+        with self.assertNumQueries(2):\n+            self.client.get('/dates/books/2008/reverse/')\n+\n     def test_datetime_year_view(self):\n         BookSigning.objects.create(event_date=datetime.datetime(2008, 4, 2, 12, 0))\n         res = self.client.get('/dates/booksignings/2008/')"
        },
        {
            "sha": "03f45a38c23c7c3c4858c3377adfc2fbc1aa1cb3",
            "filename": "tests/regressiontests/generic_views/templates/generic_views/book_archive.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Ftemplates%2Fgeneric_views%2Fbook_archive.html",
            "raw_url": "https://github.com/django/django/raw/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Ftemplates%2Fgeneric_views%2Fbook_archive.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Ftemplates%2Fgeneric_views%2Fbook_archive.html?ref=03f86a5adb930eac55dea1e903fb958c002d5bc4",
            "patch": "@@ -1 +1 @@\n-Archive of books from {{ date_list }}.\n\\ No newline at end of file\n+Archive of books from {{ date_list }}. {{ object_list|length }} books found."
        },
        {
            "sha": "fde198dcaffd5fbf342c5e62ce0a58abce45b4d8",
            "filename": "tests/regressiontests/generic_views/templates/generic_views/book_archive_year.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Ftemplates%2Fgeneric_views%2Fbook_archive_year.html",
            "raw_url": "https://github.com/django/django/raw/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Ftemplates%2Fgeneric_views%2Fbook_archive_year.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Ftemplates%2Fgeneric_views%2Fbook_archive_year.html?ref=03f86a5adb930eac55dea1e903fb958c002d5bc4",
            "patch": "@@ -1 +1 @@\n-Archive of books from {{ year }}.\n\\ No newline at end of file\n+Archive of books from {{ year }}. {{ object_list|length }} books found."
        },
        {
            "sha": "14d4f685a6be3e2fa8f3e1c3e84232e3125d71e4",
            "filename": "tests/regressiontests/generic_views/urls.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/03f86a5adb930eac55dea1e903fb958c002d5bc4/tests%2Fregressiontests%2Fgeneric_views%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Furls.py?ref=03f86a5adb930eac55dea1e903fb958c002d5bc4",
            "patch": "@@ -4,6 +4,7 @@\n from django.views.decorators.cache import cache_page\n from django.views.generic import TemplateView\n \n+from . import models\n from . import views\n \n \n@@ -108,6 +109,8 @@\n         views.BookArchive.as_view(queryset=None)),\n     (r'^dates/books/paginated/$',\n         views.BookArchive.as_view(paginate_by=10)),\n+    (r'^dates/books/reverse/$',\n+        views.BookArchive.as_view(queryset=models.Book.objects.order_by('pubdate'))),\n     (r'^dates/booksignings/$',\n         views.BookSigningArchive.as_view()),\n \n@@ -160,6 +163,8 @@\n         views.BookYearArchive.as_view(make_object_list=True, paginate_by=30)),\n     (r'^dates/books/no_year/$',\n         views.BookYearArchive.as_view()),\n+    (r'^dates/books/(?P<year>\\d{4})/reverse/$',\n+        views.BookYearArchive.as_view(queryset=models.Book.objects.order_by('pubdate'))),\n     (r'^dates/booksignings/(?P<year>\\d{4})/$',\n         views.BookSigningYearArchive.as_view()),\n "
        }
    ],
    "stats": {
        "total": 48,
        "additions": 31,
        "deletions": 17
    }
}