{
    "author": "aaugustin",
    "message": "Fixed #17266 -- Skipped the \"SET TIME ZONE\" query for PostgreSQL when it isn't necessary.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17194 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "219b41cc155a216fc912cd37f215fb44acee317b",
    "files": [
        {
            "sha": "2f020f46cf167a383ecf0ec1f7bb0dca34fa25df",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/219b41cc155a216fc912cd37f215fb44acee317b/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/219b41cc155a216fc912cd37f215fb44acee317b/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=219b41cc155a216fc912cd37f215fb44acee317b",
            "patch": "@@ -174,12 +174,21 @@ def _cursor(self):\n                 conn_params['port'] = settings_dict['PORT']\n             self.connection = Database.connect(**conn_params)\n             self.connection.set_client_encoding('UTF8')\n-            # Set the time zone in autocommit mode (see #17062)\n             tz = 'UTC' if settings.USE_TZ else settings_dict.get('TIME_ZONE')\n             if tz:\n-                self.connection.set_isolation_level(\n-                        psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)\n-                self.connection.cursor().execute(\"SET TIME ZONE %s\", [tz])\n+                try:\n+                    get_parameter_status = self.connection.get_parameter_status\n+                except AttributeError:\n+                    # psycopg2 < 2.0.12 doesn't have get_parameter_status\n+                    conn_tz = None\n+                else:\n+                    conn_tz = get_parameter_status('TimeZone')\n+\n+                if conn_tz != tz:\n+                    # Set the time zone in autocommit mode (see #17062)\n+                    self.connection.set_isolation_level(\n+                            psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)\n+                    self.connection.cursor().execute(\"SET TIME ZONE %s\", [tz])\n             self.connection.set_isolation_level(self.isolation_level)\n             self._get_pg_version()\n             connection_created.send(sender=self.__class__, connection=self)"
        },
        {
            "sha": "85631a73455e5ea9cda175f82b91dc485400d9de",
            "filename": "docs/ref/databases.txt",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/219b41cc155a216fc912cd37f215fb44acee317b/docs%2Fref%2Fdatabases.txt",
            "raw_url": "https://github.com/django/django/raw/219b41cc155a216fc912cd37f215fb44acee317b/docs%2Fref%2Fdatabases.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdatabases.txt?ref=219b41cc155a216fc912cd37f215fb44acee317b",
            "patch": "@@ -33,6 +33,26 @@ aggregate with a database backend that falls within the affected release range.\n .. _known to be faulty: http://archives.postgresql.org/pgsql-bugs/2007-07/msg00046.php\n .. _Release 8.2.5: http://developer.postgresql.org/pgdocs/postgres/release-8-2-5.html\n \n+Optimizing PostgreSQL's configuration\n+-------------------------------------\n+\n+Django needs the following parameters for its database connections:\n+\n+- ``client_encoding``: ``'UTF8'``,\n+- ``default_transaction_isolation``: ``'read committed'``,\n+- ``timezone``: ``'UTC'`` when :setting:`USE_TZ` is ``True``, value of\n+  :setting:`TIME_ZONE` otherwise.\n+\n+If these parameters already have the correct values, Django won't set them for\n+every new connection, which improves performance slightly. You can configure\n+them directly in :file:`postgresql.conf` or more conveniently per database\n+user with `ALTER ROLE`_.\n+\n+Django will work just fine without this optimization, but each new connection\n+will do some additional queries to set these parameters.\n+\n+.. _ALTER ROLE: http://www.postgresql.org/docs/current/interactive/sql-alterrole.html\n+\n Transaction handling\n ---------------------\n \n@@ -48,9 +68,8 @@ Autocommit mode\n \n If your application is particularly read-heavy and doesn't make many\n database writes, the overhead of a constantly open transaction can\n-sometimes be noticeable. For those situations, if you're using the\n-``postgresql_psycopg2`` backend, you can configure Django to use\n-*\"autocommit\"* behavior for the connection, meaning that each database\n+sometimes be noticeable. For those situations, you can configure Django\n+to use *\"autocommit\"* behavior for the connection, meaning that each database\n operation will normally be in its own transaction, rather than having\n the transaction extend over multiple operations. In this case, you can\n still manually start a transaction if you're doing something that"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 35,
        "deletions": 7
    }
}