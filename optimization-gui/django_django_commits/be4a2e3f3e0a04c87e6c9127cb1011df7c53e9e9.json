{
    "author": "jezdez",
    "message": "Fixed #15281 -- Made the static view use an iterator when serving a file, effectively making this less of a memory hog. Also use the appropriate attributes of the stat object instead of indexes. Thanks for the initial patch, FunkyBob and aaugustin.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15701 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9",
    "files": [
        {
            "sha": "9e236883077da8ea54c4529a1a31b20d89277305",
            "filename": "django/core/servers/basehttp.py",
            "status": "modified",
            "additions": 1,
            "deletions": 24,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9/django%2Fcore%2Fservers%2Fbasehttp.py",
            "raw_url": "https://github.com/django/django/raw/be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9/django%2Fcore%2Fservers%2Fbasehttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fservers%2Fbasehttp.py?ref=be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9",
            "patch": "@@ -19,6 +19,7 @@\n from django.utils.http import http_date\n from django.utils._os import safe_join\n from django.views import static\n+from django.views.static import FileWrapper # for backwards compatibility, #15281\n \n from django.contrib.staticfiles import handlers\n \n@@ -32,30 +33,6 @@\n class WSGIServerException(Exception):\n     pass\n \n-class FileWrapper(object):\n-    \"\"\"Wrapper to convert file-like objects to iterables\"\"\"\n-\n-    def __init__(self, filelike, blksize=8192):\n-        self.filelike = filelike\n-        self.blksize = blksize\n-        if hasattr(filelike,'close'):\n-            self.close = filelike.close\n-\n-    def __getitem__(self,key):\n-        data = self.filelike.read(self.blksize)\n-        if data:\n-            return data\n-        raise IndexError\n-\n-    def __iter__(self):\n-        return self\n-\n-    def next(self):\n-        data = self.filelike.read(self.blksize)\n-        if data:\n-            return data\n-        raise StopIteration\n-\n # Regular expression that matches `special' characters in parameters, the\n # existence of which force quoting of the parameter value.\n tspecials = re.compile(r'[ \\(\\)<>@,;:\\\\\"/\\[\\]\\?=]')"
        },
        {
            "sha": "96acc859f1a126839e94fe2919856f6e898d38a8",
            "filename": "django/views/static.py",
            "status": "modified",
            "additions": 32,
            "deletions": 6,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9/django%2Fviews%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9/django%2Fviews%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fstatic.py?ref=be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9",
            "patch": "@@ -7,14 +7,41 @@\n import os\n import posixpath\n import re\n-import stat\n import urllib\n \n from django.template import loader\n from django.http import Http404, HttpResponse, HttpResponseRedirect, HttpResponseNotModified\n+\n from django.template import Template, Context, TemplateDoesNotExist\n from django.utils.http import http_date, parse_http_date\n \n+\n+class FileWrapper(object):\n+    \"\"\"\n+    Wrapper to convert file-like objects to iterables\n+    \"\"\"\n+    def __init__(self, filelike, blksize=8192):\n+        self.filelike = filelike\n+        self.blksize = blksize\n+        if hasattr(filelike,'close'):\n+            self.close = filelike.close\n+\n+    def __getitem__(self,key):\n+        data = self.filelike.read(self.blksize)\n+        if data:\n+            return data\n+        raise IndexError\n+\n+    def __iter__(self):\n+        return self\n+\n+    def next(self):\n+        data = self.filelike.read(self.blksize)\n+        if data:\n+            return data\n+        raise StopIteration\n+\n+\n def serve(request, path, document_root=None, show_indexes=False):\n     \"\"\"\n     Serve static files below a given point in the directory structure.\n@@ -56,12 +83,11 @@ def serve(request, path, document_root=None, show_indexes=False):\n     mimetype, encoding = mimetypes.guess_type(fullpath)\n     mimetype = mimetype or 'application/octet-stream'\n     if not was_modified_since(request.META.get('HTTP_IF_MODIFIED_SINCE'),\n-                              statobj[stat.ST_MTIME], statobj[stat.ST_SIZE]):\n+                              statobj.st_mtime, statobj.st_size):\n         return HttpResponseNotModified(mimetype=mimetype)\n-    contents = open(fullpath, 'rb').read()\n-    response = HttpResponse(contents, mimetype=mimetype)\n-    response[\"Last-Modified\"] = http_date(statobj[stat.ST_MTIME])\n-    response[\"Content-Length\"] = len(contents)\n+    response = HttpResponse(FileWrapper(open(fullpath, 'rb')), mimetype=mimetype)\n+    response[\"Last-Modified\"] = http_date(statobj.st_mtime)\n+    response[\"Content-Length\"] = statobj.st_size\n     if encoding:\n         response[\"Content-Encoding\"] = encoding\n     return response"
        },
        {
            "sha": "1c4f9ce85b2af43d02f15e2ccaf7eb43f900d2cd",
            "filename": "tests/regressiontests/views/tests/static.py",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py?ref=be4a2e3f3e0a04c87e6c9127cb1011df7c53e9e9",
            "patch": "@@ -26,10 +26,18 @@ def test_serve(self):\n         for filename in media_files:\n             response = self.client.get('/views/%s/%s' % (self.prefix, filename))\n             file_path = path.join(media_dir, filename)\n-            self.assertEquals(open(file_path).read(), response.content)\n-            self.assertEquals(len(response.content), int(response['Content-Length']))\n+            content = str(response.content)\n+            self.assertEquals(open(file_path).read(), content)\n+            self.assertEquals(len(content), int(response['Content-Length']))\n             self.assertEquals(mimetypes.guess_type(file_path)[1], response.get('Content-Encoding', None))\n \n+    def test_serve_does_not_buffer_files(self):\n+        \"The static view uses an iterator - see #15281\"\n+        response = self.client.get('/views/%s/file.txt' % self.prefix)\n+        # response objects can't be used as file-like objects when they are\n+        # initialized with an iterator\n+        self.assertRaises(Exception, response.write, 'more text')\n+\n     def test_unknown_mime_type(self):\n         response = self.client.get('/views/%s/file.unknown' % self.prefix)\n         self.assertEquals('application/octet-stream', response['Content-Type'])\n@@ -68,9 +76,9 @@ def test_invalid_if_modified_since(self):\n         response = self.client.get('/views/%s/%s' % (self.prefix, file_name),\n                                    HTTP_IF_MODIFIED_SINCE=invalid_date)\n         file = open(path.join(media_dir, file_name))\n-        self.assertEquals(file.read(), response.content)\n-        self.assertEquals(len(response.content),\n-                          int(response['Content-Length']))\n+        content = str(response.content)\n+        self.assertEquals(file.read(), content)\n+        self.assertEquals(len(content), int(response['Content-Length']))\n \n     def test_invalid_if_modified_since2(self):\n         \"\"\"Handle even more bogus If-Modified-Since values gracefully\n@@ -82,10 +90,10 @@ def test_invalid_if_modified_since2(self):\n         invalid_date = ': 1291108438, Wed, 20 Oct 2010 14:05:00 GMT'\n         response = self.client.get('/views/%s/%s' % (self.prefix, file_name),\n                                    HTTP_IF_MODIFIED_SINCE=invalid_date)\n+        content = str(response.content)\n         file = open(path.join(media_dir, file_name))\n-        self.assertEquals(file.read(), response.content)\n-        self.assertEquals(len(response.content),\n-                          int(response['Content-Length']))\n+        self.assertEquals(file.read(), content)\n+        self.assertEquals(len(content), int(response['Content-Length']))\n \n \n class StaticHelperTest(StaticTests):"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 49,
        "deletions": 38
    }
}