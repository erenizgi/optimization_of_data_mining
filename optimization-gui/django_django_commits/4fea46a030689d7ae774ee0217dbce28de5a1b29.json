{
    "author": "spookylukey",
    "message": "Fixed #18309 - Prefetch related does not work for fkey to multitable inherited model\n\nThanks to milosu for the report, tests and initial patch.",
    "sha": "4fea46a030689d7ae774ee0217dbce28de5a1b29",
    "files": [
        {
            "sha": "312a3822f633cdb99b0f9240c01c591945cd401f",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/4fea46a030689d7ae774ee0217dbce28de5a1b29/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/4fea46a030689d7ae774ee0217dbce28de5a1b29/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=4fea46a030689d7ae774ee0217dbce28de5a1b29",
            "patch": "@@ -329,10 +329,10 @@ def get_query_set(self, **db_hints):\n             return QuerySet(self.field.rel.to).using(db)\n \n     def get_prefetch_query_set(self, instances):\n-        rel_obj_attr = attrgetter(self.field.rel.field_name)\n+        other_field = self.field.rel.get_related_field()\n+        rel_obj_attr = attrgetter(other_field.attname)\n         instance_attr = attrgetter(self.field.attname)\n         instances_dict = dict((instance_attr(inst), inst) for inst in instances)\n-        other_field = self.field.rel.get_related_field()\n         if other_field.rel:\n             params = {'%s__pk__in' % self.field.rel.field_name: instances_dict.keys()}\n         else:"
        },
        {
            "sha": "589f78c7d32cd8e216a533cc35926b2cc68fbd8c",
            "filename": "tests/modeltests/prefetch_related/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/4fea46a030689d7ae774ee0217dbce28de5a1b29/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/4fea46a030689d7ae774ee0217dbce28de5a1b29/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py?ref=4fea46a030689d7ae774ee0217dbce28de5a1b29",
            "patch": "@@ -68,6 +68,9 @@ def __unicode__(self):\n     class Meta:\n         ordering = ['id']\n \n+class BookReview(models.Model):\n+    book = models.ForeignKey(BookWithYear)\n+    notes = models.TextField(null=True, blank=True)\n \n ## Models for default manager tests\n "
        },
        {
            "sha": "b21244b6d92a7fc6f0f50781d46a302424fa1d5f",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/4fea46a030689d7ae774ee0217dbce28de5a1b29/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4fea46a030689d7ae774ee0217dbce28de5a1b29/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=4fea46a030689d7ae774ee0217dbce28de5a1b29",
            "patch": "@@ -7,7 +7,7 @@\n \n from .models import (Author, Book, Reader, Qualification, Teacher, Department,\n     TaggedItem, Bookmark, AuthorAddress, FavoriteAuthors, AuthorWithAge,\n-    BookWithYear, Person, House, Room, Employee, Comment)\n+    BookWithYear, BookReview, Person, House, Room, Employee, Comment)\n \n \n class PrefetchRelatedTests(TestCase):\n@@ -335,6 +335,10 @@ def setUp(self):\n         self.authorAddress = AuthorAddress.objects.create(\n             author=self.author1, address='SomeStreet 1')\n         self.book2.aged_authors.add(self.author2, self.author3)\n+        self.br1 = BookReview.objects.create(\n+            book=self.book1, notes=\"review book1\")\n+        self.br2 = BookReview.objects.create(\n+            book=self.book2, notes=\"review book2\")\n \n     def test_foreignkey(self):\n         with self.assertNumQueries(2):\n@@ -343,6 +347,12 @@ def test_foreignkey(self):\n                          for obj in qs]\n         self.assertEqual(addresses, [[unicode(self.authorAddress)], [], []])\n \n+    def test_foreignkey_to_inherited(self):\n+        with self.assertNumQueries(2):\n+            qs = BookReview.objects.prefetch_related('book')\n+            titles = [obj.book.title for obj in qs]\n+        self.assertEquals(titles, [\"Poems\", \"More poems\"])\n+\n     def test_m2m_to_inheriting_model(self):\n         qs = AuthorWithAge.objects.prefetch_related('books_with_year')\n         with self.assertNumQueries(2):"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 16,
        "deletions": 3
    }
}