{
    "author": "aaugustin",
    "message": "Fixed #17931 -- Accepted aware datetimes to set cookies expiry dates. Thanks jaddison for the report.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17766 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546",
    "files": [
        {
            "sha": "94478ae5aeb511669d59079342ad4b866276eb4b",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546",
            "patch": "@@ -121,6 +121,7 @@ def __init__(self, *args, **kwargs):\n from django.utils.datastructures import MultiValueDict, ImmutableList\n from django.utils.encoding import smart_str, iri_to_uri, force_unicode\n from django.utils.http import cookie_date\n+from django.utils import timezone\n \n RESERVED_CHARS=\"!*'();:@&=+$,/?%#[]\"\n \n@@ -641,13 +642,18 @@ def set_cookie(self, key, value='', max_age=None, expires=None, path='/',\n         \"\"\"\n         Sets a cookie.\n \n-        ``expires`` can be a string in the correct format or a\n-        ``datetime.datetime`` object in UTC. If ``expires`` is a datetime\n-        object then ``max_age`` will be calculated.\n+        ``expires`` can be:\n+        - a string in the correct format,\n+        - a naive ``datetime.datetime`` object in UTC,\n+        - an aware ``datetime.datetime`` object in any time zone.\n+        If it is a ``datetime.datetime`` object then ``max_age`` will be calculated.\n+\n         \"\"\"\n         self.cookies[key] = value\n         if expires is not None:\n             if isinstance(expires, datetime.datetime):\n+                if timezone.is_aware(expires):\n+                    expires = timezone.make_naive(expires, timezone.utc)\n                 delta = expires - expires.utcnow()\n                 # Add one second so the date matches exactly (a fraction of\n                 # time gets lost between converting to a timedelta and"
        },
        {
            "sha": "b7a4788ec5b7427c736e26286185141fbc171410",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=c8e2f7591d6ea3545aeb32fa4c92cbeb9a622546",
            "patch": "@@ -12,6 +12,7 @@\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import unittest\n from django.utils.http import cookie_date\n+from django.utils.timezone import utc\n \n \n class RequestsTests(unittest.TestCase):\n@@ -207,6 +208,15 @@ def test_near_expiration(self):\n         datetime_cookie = response.cookies['datetime']\n         self.assertEqual(datetime_cookie['max-age'], 10)\n \n+    def test_aware_expiration(self):\n+        \"Cookie accepts an aware datetime as expiration time\"\n+        response = HttpResponse()\n+        expires = (datetime.utcnow() + timedelta(seconds=10)).replace(tzinfo=utc)\n+        time.sleep(0.001)\n+        response.set_cookie('datetime', expires=expires)\n+        datetime_cookie = response.cookies['datetime']\n+        self.assertEqual(datetime_cookie['max-age'], 10)\n+\n     def test_far_expiration(self):\n         \"Cookie will expire when an distant expiration time is provided\"\n         response = HttpResponse()"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 19,
        "deletions": 3
    }
}