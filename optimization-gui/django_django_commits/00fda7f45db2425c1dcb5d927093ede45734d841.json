{
    "author": "carljm",
    "message": "Fixed #13283 -- Corrected CACHE_MIDDLEWARE_ANONYMOUS_ONLY's bad habit of setting Vary: Cookie on all responses and destroying cache efficiency. Thanks to natrius for the fix.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15381 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "00fda7f45db2425c1dcb5d927093ede45734d841",
    "files": [
        {
            "sha": "7789c3492c657e4d3bae732a12a525df839fb3ee",
            "filename": "django/middleware/cache.py",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/00fda7f45db2425c1dcb5d927093ede45734d841/django%2Fmiddleware%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/00fda7f45db2425c1dcb5d927093ede45734d841/django%2Fmiddleware%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcache.py?ref=00fda7f45db2425c1dcb5d927093ede45734d841",
            "patch": "@@ -50,7 +50,7 @@\n \n from django.conf import settings\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n-from django.utils.cache import get_cache_key, learn_cache_key, patch_response_headers, get_max_age\n+from django.utils.cache import get_cache_key, learn_cache_key, patch_response_headers, get_max_age, has_vary_header\n \n \n class UpdateCacheMiddleware(object):\n@@ -69,9 +69,19 @@ def __init__(self):\n         self.cache_alias = settings.CACHE_MIDDLEWARE_ALIAS\n         self.cache = get_cache(self.cache_alias)\n \n+    def _should_update_cache(self, request, response):\n+        if not hasattr(request, '_cache_update_cache') or not request._cache_update_cache:\n+            return False\n+        if self.cache_anonymous_only and has_vary_header(response, 'Cookie'):\n+            assert hasattr(request, 'user'), \"The Django cache middleware with CACHE_MIDDLEWARE_ANONYMOUS_ONLY=True requires authentication middleware to be installed. Edit your MIDDLEWARE_CLASSES setting to insert 'django.contrib.auth.middleware.AuthenticationMiddleware' before the CacheMiddleware.\"\n+            if request.user.is_authenticated():\n+                # Don't cache user-variable requests from authenticated users.\n+                return False\n+        return True\n+\n     def process_response(self, request, response):\n         \"\"\"Sets the cache, if needed.\"\"\"\n-        if not hasattr(request, '_cache_update_cache') or not request._cache_update_cache:\n+        if not self._should_update_cache(request, response):\n             # We don't need to update the cache, just return.\n             return response\n         if not response.status_code == 200:\n@@ -116,17 +126,10 @@ def process_request(self, request):\n         Checks whether the page is already cached and returns the cached\n         version if available.\n         \"\"\"\n-        if self.cache_anonymous_only:\n-            assert hasattr(request, 'user'), \"The Django cache middleware with CACHE_MIDDLEWARE_ANONYMOUS_ONLY=True requires authentication middleware to be installed. Edit your MIDDLEWARE_CLASSES setting to insert 'django.contrib.auth.middleware.AuthenticationMiddleware' before the CacheMiddleware.\"\n-\n         if not request.method in ('GET', 'HEAD') or request.GET:\n             request._cache_update_cache = False\n             return None # Don't bother checking the cache.\n \n-        if self.cache_anonymous_only and request.user.is_authenticated():\n-            request._cache_update_cache = False\n-            return None # Don't cache requests from authenticated users.\n-\n         # try and get the cached GET response\n         cache_key = get_cache_key(request, self.key_prefix, 'GET', cache=self.cache)\n         if cache_key is None:"
        },
        {
            "sha": "4b3b5af04ca1d46cbc747298aa55f54e0947489c",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/00fda7f45db2425c1dcb5d927093ede45734d841/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/00fda7f45db2425c1dcb5d927093ede45734d841/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=00fda7f45db2425c1dcb5d927093ede45734d841",
            "patch": "@@ -134,6 +134,16 @@ def patch_vary_headers(response, newheaders):\n                           if newheader.lower() not in existing_headers]\n     response['Vary'] = ', '.join(vary_headers + additional_headers)\n \n+def has_vary_header(response, header_query):\n+    \"\"\"\n+    Checks to see if the response has a given header name in its Vary header.\n+    \"\"\"\n+    if not response.has_header('Vary'):\n+        return False\n+    vary_headers = cc_delim_re.split(response['Vary'])\n+    existing_headers = set([header.lower() for header in vary_headers])\n+    return header_query.lower() in existing_headers\n+\n def _i18n_cache_key_suffix(request, cache_key):\n     \"\"\"If enabled, returns the cache key ending with a locale.\"\"\"\n     if settings.USE_I18N:"
        },
        {
            "sha": "7d520c0ed24eb547c6a35214f5fb3f957389b9fe",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 23,
            "deletions": 3,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/00fda7f45db2425c1dcb5d927093ede45734d841/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/00fda7f45db2425c1dcb5d927093ede45734d841/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=00fda7f45db2425c1dcb5d927093ede45734d841",
            "patch": "@@ -4,18 +4,17 @@\n # Uses whatever cache backend is set in the test settings file.\n \n import os\n-import shutil\n import tempfile\n import time\n import warnings\n \n from django.conf import settings\n from django.core import management\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n-from django.core.cache.backends.base import InvalidCacheBackendError, CacheKeyWarning\n+from django.core.cache.backends.base import CacheKeyWarning\n from django.http import HttpResponse, HttpRequest\n from django.middleware.cache import FetchFromCacheMiddleware, UpdateCacheMiddleware, CacheMiddleware\n-from django.test import RequestFactory\n+from django.test import RequestFactory, TestCase\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import translation\n from django.utils import unittest\n@@ -1323,5 +1322,26 @@ def view(request, value):\n         response = other_with_timeout_view(request, '18')\n         self.assertEquals(response.content, 'Hello World 18')\n \n+class CacheMiddlewareAnonymousOnlyTests(TestCase):\n+    urls = 'regressiontests.cache.urls'\n+\n+    def setUp(self):\n+        self._orig_cache_middleware_anonymous_only = \\\n+            getattr(settings, 'CACHE_MIDDLEWARE_ANONYMOUS_ONLY', False)\n+        self._orig_middleware_classes = settings.MIDDLEWARE_CLASSES\n+\n+        settings.MIDDLEWARE_CLASSES = list(settings.MIDDLEWARE_CLASSES)\n+        settings.MIDDLEWARE_CLASSES.insert(0, 'django.middleware.cache.UpdateCacheMiddleware')\n+        settings.MIDDLEWARE_CLASSES += ['django.middleware.cache.FetchFromCacheMiddleware']\n+\n+    def tearDown(self):\n+        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = self._orig_cache_middleware_anonymous_only\n+        settings.MIDDLEWARE_CLASSES = self._orig_middleware_classes\n+\n+    def test_cache_middleware_anonymous_only_does_not_cause_vary_cookie(self):\n+        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = True\n+        response = self.client.get('/')\n+        self.failIf('Cookie' in response.get('Vary', ''))\n+\n if __name__ == '__main__':\n     unittest.main()"
        },
        {
            "sha": "b98447bfa3dd11897b86b6bd40d8af2bf82751b4",
            "filename": "tests/regressiontests/cache/urls.py",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/00fda7f45db2425c1dcb5d927093ede45734d841/tests%2Fregressiontests%2Fcache%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/00fda7f45db2425c1dcb5d927093ede45734d841/tests%2Fregressiontests%2Fcache%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Furls.py?ref=00fda7f45db2425c1dcb5d927093ede45734d841",
            "patch": "@@ -0,0 +1,5 @@\n+from django.conf.urls.defaults import patterns\n+\n+urlpatterns = patterns('regressiontests.cache.views',\n+    (r'^$', 'home'),\n+)"
        },
        {
            "sha": "9b72f03f5633ca72f2d91260830b35c7f1affbfc",
            "filename": "tests/regressiontests/cache/views.py",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/00fda7f45db2425c1dcb5d927093ede45734d841/tests%2Fregressiontests%2Fcache%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/00fda7f45db2425c1dcb5d927093ede45734d841/tests%2Fregressiontests%2Fcache%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Fviews.py?ref=00fda7f45db2425c1dcb5d927093ede45734d841",
            "patch": "@@ -0,0 +1,4 @@\n+from django.http import HttpResponse\n+\n+def home(request):\n+    return HttpResponse('Hello World!')"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 54,
        "deletions": 12
    }
}