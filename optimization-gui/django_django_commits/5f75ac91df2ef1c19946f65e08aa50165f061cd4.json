{
    "author": "jezdez",
    "message": "Fixed #17896 -- Added file_hash method to CachedStaticFilesStorage to be able to customize the way the hashed name of a file is created. Thanks to mkai for the initial patch.",
    "sha": "5f75ac91df2ef1c19946f65e08aa50165f061cd4",
    "files": [
        {
            "sha": "fd8f9efb027bb6841043bc4c6efa9862c2363f87",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/5f75ac91df2ef1c19946f65e08aa50165f061cd4/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/5f75ac91df2ef1c19946f65e08aa50165f061cd4/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=5f75ac91df2ef1c19946f65e08aa50165f061cd4",
            "patch": "@@ -64,6 +64,17 @@ def __init__(self, *args, **kwargs):\n                 compiled = re.compile(pattern)\n                 self._patterns.setdefault(extension, []).append(compiled)\n \n+    def file_hash(self, name, content=None):\n+        \"\"\"\n+        Retuns a hash of the file with the given name and optional content.\n+        \"\"\"\n+        if content is None:\n+            return None\n+        md5 = hashlib.md5()\n+        for chunk in content.chunks():\n+            md5.update(chunk)\n+        return md5.hexdigest()[:12]\n+\n     def hashed_name(self, name, content=None):\n         parsed_name = urlsplit(unquote(name))\n         clean_name = parsed_name.path.strip()\n@@ -78,13 +89,11 @@ def hashed_name(self, name, content=None):\n                 return name\n         path, filename = os.path.split(clean_name)\n         root, ext = os.path.splitext(filename)\n-        # Get the MD5 hash of the file\n-        md5 = hashlib.md5()\n-        for chunk in content.chunks():\n-            md5.update(chunk)\n-        md5sum = md5.hexdigest()[:12]\n-        hashed_name = os.path.join(path, u\"%s.%s%s\" %\n-                                   (root, md5sum, ext))\n+        file_hash = self.file_hash(clean_name, content)\n+        if file_hash is not None:\n+            file_hash = u\".%s\" % file_hash\n+        hashed_name = os.path.join(path, u\"%s%s%s\" %\n+                                   (root, file_hash, ext))\n         unparsed_name = list(parsed_name)\n         unparsed_name[2] = hashed_name\n         # Special casing for a @font-face hack, like url(myfont.eot?#iefix\")"
        },
        {
            "sha": "2bdf8253163494bd079e6d9185aa417a373cf6cf",
            "filename": "docs/ref/contrib/staticfiles.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/5f75ac91df2ef1c19946f65e08aa50165f061cd4/docs%2Fref%2Fcontrib%2Fstaticfiles.txt",
            "raw_url": "https://github.com/django/django/raw/5f75ac91df2ef1c19946f65e08aa50165f061cd4/docs%2Fref%2Fcontrib%2Fstaticfiles.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fstaticfiles.txt?ref=5f75ac91df2ef1c19946f65e08aa50165f061cd4",
            "patch": "@@ -348,6 +348,15 @@ CachedStaticFilesStorage\n     :setting:`CACHES` setting named ``'staticfiles'``. It falls back to using\n     the ``'default'`` cache backend.\n \n+    .. method:: file_hash(name, content=None)\n+\n+    .. versionadded:: 1.5\n+\n+    The method that is used when creating the hashed name of a file.\n+    Needs to return a hash for the given file name and content.\n+    By default it calculates a MD5 hash from the content's chunks as\n+    mentioned above.\n+\n .. _`far future Expires headers`: http://developer.yahoo.com/performance/rules.html#expires\n .. _`@import`: http://www.w3.org/TR/CSS2/cascade.html#at-import\n .. _`url()`: http://www.w3.org/TR/CSS2/syndata.html#uri"
        },
        {
            "sha": "4d49e6fbb27ee11fde0f710e45e03f5dd342e687",
            "filename": "tests/regressiontests/staticfiles_tests/storage.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/5f75ac91df2ef1c19946f65e08aa50165f061cd4/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/5f75ac91df2ef1c19946f65e08aa50165f061cd4/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py?ref=5f75ac91df2ef1c19946f65e08aa50165f061cd4",
            "patch": "@@ -1,5 +1,6 @@\n from datetime import datetime\n from django.core.files import storage\n+from django.contrib.staticfiles.storage import CachedStaticFilesStorage\n \n class DummyStorage(storage.Storage):\n     \"\"\"\n@@ -17,3 +18,9 @@ def exists(self, name):\n \n     def modified_time(self, name):\n         return datetime.date(1970, 1, 1)\n+\n+\n+class SimpleCachedStaticFilesStorage(CachedStaticFilesStorage):\n+\n+    def file_hash(self, name, content=None):\n+        return 'deploy12345'"
        },
        {
            "sha": "0c247e4a17a47472beb959919300dce28236cdb0",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/5f75ac91df2ef1c19946f65e08aa50165f061cd4/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5f75ac91df2ef1c19946f65e08aa50165f061cd4/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=5f75ac91df2ef1c19946f65e08aa50165f061cd4",
            "patch": "@@ -10,7 +10,7 @@\n \n from django.template import loader, Context\n from django.conf import settings\n-from django.core.cache.backends.base import BaseCache, CacheKeyWarning\n+from django.core.cache.backends.base import BaseCache\n from django.core.exceptions import ImproperlyConfigured\n from django.core.files.storage import default_storage\n from django.core.management import call_command\n@@ -515,6 +515,44 @@ def test_cache_key_memcache_validation(self):\n         self.assertEqual(cache_key, 'staticfiles:e95bbc36387084582df2a70750d7b351')\n \n \n+# we set DEBUG to False here since the template tag wouldn't work otherwise\n+@override_settings(**dict(TEST_SETTINGS,\n+    STATICFILES_STORAGE='regressiontests.staticfiles_tests.storage.SimpleCachedStaticFilesStorage',\n+    DEBUG=False,\n+))\n+class TestCollectionSimpleCachedStorage(BaseCollectionTestCase,\n+        BaseStaticFilesTestCase, TestCase):\n+    \"\"\"\n+    Tests for the Cache busting storage\n+    \"\"\"\n+    def cached_file_path(self, path):\n+        fullpath = self.render_template(self.static_template_snippet(path))\n+        return fullpath.replace(settings.STATIC_URL, '')\n+\n+    def test_template_tag_return(self):\n+        \"\"\"\n+        Test the CachedStaticFilesStorage backend.\n+        \"\"\"\n+        self.assertStaticRaises(ValueError,\n+                                \"does/not/exist.png\",\n+                                \"/static/does/not/exist.png\")\n+        self.assertStaticRenders(\"test/file.txt\",\n+                                 \"/static/test/file.deploy12345.txt\")\n+        self.assertStaticRenders(\"cached/styles.css\",\n+                                 \"/static/cached/styles.deploy12345.css\")\n+        self.assertStaticRenders(\"path/\",\n+                                 \"/static/path/\")\n+        self.assertStaticRenders(\"path/?query\",\n+                                 \"/static/path/?query\")\n+\n+    def test_template_tag_simple_content(self):\n+        relpath = self.cached_file_path(\"cached/styles.css\")\n+        self.assertEqual(relpath, \"cached/styles.deploy12345.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertNotIn(\"cached/other.css\", content)\n+            self.assertIn(\"other.deploy12345.css\", content)\n+\n if sys.platform != 'win32':\n \n     class TestCollectionLinks(CollectionTestCase, TestDefaults):"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 71,
        "deletions": 8
    }
}