{
    "author": "adrianholovaty",
    "message": "Fixed #16845 -- Admin 'Change user' page no longer shows the password hash. Thanks, dstufft\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17185 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "718a5ba1a1a77374c26b134ded46dab13776d1a1",
    "files": [
        {
            "sha": "6fcf323216627c3317847e4668109eaf9c4a6b9a",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/718a5ba1a1a77374c26b134ded46dab13776d1a1/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/718a5ba1a1a77374c26b134ded46dab13776d1a1/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=718a5ba1a1a77374c26b134ded46dab13776d1a1",
            "patch": "@@ -1,6 +1,8 @@\n from django import forms\n+from django.forms.util import flatatt\n from django.template import loader\n from django.utils.http import int_to_base36\n+from django.utils.safestring import mark_safe\n from django.utils.translation import ugettext_lazy as _\n \n from django.contrib.auth.models import User\n@@ -9,6 +11,40 @@\n from django.contrib.auth.tokens import default_token_generator\n from django.contrib.sites.models import get_current_site\n \n+UNMASKED_DIGITS_TO_SHOW = 6\n+\n+mask_password = lambda p: \"%s%s\" % (p[:UNMASKED_DIGITS_TO_SHOW], \"*\" * max(len(p) - UNMASKED_DIGITS_TO_SHOW, 0))\n+\n+class ReadOnlyPasswordHashWidget(forms.Widget):\n+    def render(self, name, value, attrs):\n+        if not value:\n+            return \"None\"\n+        final_attrs = self.build_attrs(attrs)\n+        parts = value.split(\"$\")\n+        if len(parts) != 3:\n+            # Legacy passwords didn't specify a hash type and were md5.\n+            hash_type = \"md5\"\n+            masked = mask_password(value)\n+        else:\n+            hash_type = parts[0]\n+            masked = mask_password(parts[2])\n+        return mark_safe(\"\"\"<div%(attrs)s>\n+                    <strong>%(hash_type_label)s</strong>: %(hash_type)s\n+                    <strong>%(masked_label)s</strong>: %(masked)s\n+                </div>\"\"\" % {\n+                    \"attrs\": flatatt(final_attrs),\n+                    \"hash_type_label\": _(\"Hash type\"),\n+                    \"hash_type\": hash_type,\n+                    \"masked_label\": _(\"Masked hash\"),\n+                    \"masked\": masked,\n+                })\n+\n+class ReadOnlyPasswordHashField(forms.Field):\n+    widget = ReadOnlyPasswordHashWidget\n+\n+    def __init__(self, *args, **kwargs):\n+        kwargs.setdefault(\"required\", False)\n+        super(ReadOnlyPasswordHashField, self).__init__(*args, **kwargs)\n \n class UserCreationForm(forms.ModelForm):\n     \"\"\"\n@@ -51,6 +87,10 @@ class UserChangeForm(forms.ModelForm):\n     username = forms.RegexField(label=_(\"Username\"), max_length=30, regex=r'^[\\w.@+-]+$',\n         help_text = _(\"Required. 30 characters or fewer. Letters, digits and @/./+/-/_ only.\"),\n         error_messages = {'invalid': _(\"This value may contain only letters, numbers and @/./+/-/_ characters.\")})\n+    password = ReadOnlyPasswordHashField(label=_(\"Password\"), help_text=_(\"We don't store raw passwords, so there's no way to see this user's password, but you can change the password using <a href=\\\"password/\\\">this form</a>.\"))\n+\n+    def clean_password(self):\n+        return self.initial[\"password\"]\n \n     class Meta:\n         model = User"
        },
        {
            "sha": "8ac94c1e8a59cdcaa6aad384088bfc5da2e12b39",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/718a5ba1a1a77374c26b134ded46dab13776d1a1/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/718a5ba1a1a77374c26b134ded46dab13776d1a1/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=718a5ba1a1a77374c26b134ded46dab13776d1a1",
            "patch": "@@ -177,7 +177,7 @@ class User(models.Model):\n     first_name = models.CharField(_('first name'), max_length=30, blank=True)\n     last_name = models.CharField(_('last name'), max_length=30, blank=True)\n     email = models.EmailField(_('e-mail address'), blank=True)\n-    password = models.CharField(_('password'), max_length=128, help_text=_(\"Use '[algo]$[salt]$[hexdigest]' or use the <a href=\\\"password/\\\">change password form</a>.\"))\n+    password = models.CharField(_('password'), max_length=128)\n     is_staff = models.BooleanField(_('staff status'), default=False, help_text=_(\"Designates whether the user can log into this admin site.\"))\n     is_active = models.BooleanField(_('active'), default=True, help_text=_(\"Designates whether this user should be treated as active. Unselect this instead of deleting accounts.\"))\n     is_superuser = models.BooleanField(_('superuser status'), default=False, help_text=_(\"Designates that this user has all permissions without explicitly assigning them.\"))"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 41,
        "deletions": 1
    }
}