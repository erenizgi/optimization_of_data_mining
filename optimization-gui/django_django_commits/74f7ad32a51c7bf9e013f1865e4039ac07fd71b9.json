{
    "author": "freakboy3742",
    "message": "Fixed #15717 -- Updated databrowse to use class-based generic date views. Thanks to aaugustin for the report and draft patch\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16002 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "74f7ad32a51c7bf9e013f1865e4039ac07fd71b9",
    "files": [
        {
            "sha": "4a9468e3960092b2b7e5b958214cfb697cdd8aaa",
            "filename": "django/contrib/databrowse/plugins/calendars.py",
            "status": "modified",
            "additions": 74,
            "deletions": 16,
            "changes": 90,
            "blob_url": "https://github.com/django/django/blob/74f7ad32a51c7bf9e013f1865e4039ac07fd71b9/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Fcalendars.py",
            "raw_url": "https://github.com/django/django/raw/74f7ad32a51c7bf9e013f1865e4039ac07fd71b9/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Fcalendars.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Fcalendars.py?ref=74f7ad32a51c7bf9e013f1865e4039ac07fd71b9",
            "patch": "@@ -6,9 +6,43 @@\n from django.utils.text import capfirst\n from django.utils.encoding import force_unicode\n from django.utils.safestring import mark_safe\n-from django.views.generic import date_based\n+from django.views.generic import dates\n from django.utils import datetime_safe\n \n+\n+class DateViewMixin(object):\n+    allow_empty = False\n+    allow_future = True\n+    root_url = None\n+    model = None\n+    field = None\n+\n+    def get_context_data(self, **kwargs):\n+        context = super(DateViewMixin, self).get_context_data(**kwargs)\n+        context.update({\n+            'root_url': self.root_url,\n+            'model': self.model,\n+            'field': self.field\n+        })\n+        return context\n+\n+\n+class DayView(DateViewMixin, dates.DayArchiveView):\n+    template_name = 'databrowse/calendar_day.html'\n+\n+\n+class MonthView(DateViewMixin, dates.MonthArchiveView):\n+    template_name = 'databrowse/calendar_month.html'\n+\n+\n+class YearView(DateViewMixin, dates.YearArchiveView):\n+    template_name = 'databrowse/calendar_year.html'\n+\n+\n+class IndexView(DateViewMixin, dates.ArchiveIndexView):\n+    template_name = 'databrowse/calendar_main.html'\n+\n+\n class CalendarPlugin(DatabrowsePlugin):\n     def __init__(self, field_names=None):\n         self.field_names = field_names\n@@ -61,26 +95,50 @@ def homepage_view(self, request):\n         easy_model = EasyModel(self.site, self.model)\n         field_list = self.fields.values()\n         field_list.sort(key=lambda k:k.verbose_name)\n-        return render_to_response('databrowse/calendar_homepage.html', {'root_url': self.site.root_url, 'model': easy_model, 'field_list': field_list})\n+        return render_to_response('databrowse/calendar_homepage.html', {\n+                'root_url': self.site.root_url,\n+                'model': easy_model,\n+                'field_list': field_list\n+            })\n \n     def calendar_view(self, request, field, year=None, month=None, day=None):\n         easy_model = EasyModel(self.site, self.model)\n-        queryset = easy_model.get_query_set()\n-        extra_context = {'root_url': self.site.root_url, 'model': easy_model, 'field': field}\n+        root_url = self.site.root_url\n+\n         if day is not None:\n-            return date_based.archive_day(request, year, month, day, queryset, field.name,\n-                template_name='databrowse/calendar_day.html', allow_empty=False, allow_future=True,\n-                extra_context=extra_context)\n+            return DayView.as_view(\n+                                year=year, month=month, day=day,\n+                                date_field=field.name,\n+                                queryset=easy_model.get_query_set(),\n+                                root_url=root_url,\n+                                model=easy_model,\n+                                field=field\n+                            )(request)\n         elif month is not None:\n-            return date_based.archive_month(request, year, month, queryset, field.name,\n-                template_name='databrowse/calendar_month.html', allow_empty=False, allow_future=True,\n-                extra_context=extra_context)\n+            return MonthView.as_view(\n+                                year=year, month=month,\n+                                date_field=field.name,\n+                                queryset=easy_model.get_query_set(),\n+                                root_url=root_url,\n+                                model=easy_model,\n+                                field=field\n+                            )(request)\n         elif year is not None:\n-            return date_based.archive_year(request, year, queryset, field.name,\n-                template_name='databrowse/calendar_year.html', allow_empty=False, allow_future=True,\n-                extra_context=extra_context)\n+            return YearView.as_view(\n+                                year=year,\n+                                date_field=field.name,\n+                                queryset=easy_model.get_query_set(),\n+                                root_url=root_url,\n+                                model=easy_model,\n+                                field=field\n+                            )(request)\n         else:\n-            return date_based.archive_index(request, queryset, field.name,\n-                template_name='databrowse/calendar_main.html', allow_empty=True, allow_future=True,\n-                extra_context=extra_context)\n+            return IndexView.as_view(\n+                                date_field=field.name,\n+                                queryset=easy_model.get_query_set(),\n+                                root_url=root_url,\n+                                model=easy_model,\n+                                field=field\n+                            )(request)\n+\n         assert False, ('%s, %s, %s, %s' % (field, year, month, day))"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 74,
        "deletions": 16
    }
}