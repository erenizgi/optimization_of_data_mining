{
    "author": "jbronn",
    "message": "Fixed #10420 -- GeoDjango tests are run as part of Django tests when using spatial database backends with `runtests.py`.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15013 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d66ab474f33a0f2455583c96940a78bd06bd2218",
    "files": [
        {
            "sha": "612382c460eedb195780122381e8a0a4f91bed4c",
            "filename": "django/contrib/gis/tests/__init__.py",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/d66ab474f33a0f2455583c96940a78bd06bd2218/django%2Fcontrib%2Fgis%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/d66ab474f33a0f2455583c96940a78bd06bd2218/django%2Fcontrib%2Fgis%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2F__init__.py?ref=d66ab474f33a0f2455583c96940a78bd06bd2218",
            "patch": "@@ -17,7 +17,7 @@ def run_gis_tests(test_labels, verbosity=1, interactive=True, failfast=False, ex\n     return test_runner.run_tests(test_labels, extra_tests=extra_tests)\n \n \n-def geo_apps(namespace=True):\n+def geo_apps(namespace=True, runtests=False):\n     \"\"\"\n     Returns a list of GeoDjango test applications that reside in\n     `django.contrib.gis.tests` that can be used with the current\n@@ -45,14 +45,16 @@ def geo_apps(namespace=True):\n \n         apps.append('layermap')\n \n-    if namespace:\n+    if runtests:\n+        return [('django.contrib.gis.tests', app) for app in apps]\n+    elif namespace:\n         return ['django.contrib.gis.tests.%s' % app\n                 for app in apps]\n     else:\n         return apps\n \n \n-def geodjango_suite():\n+def geodjango_suite(apps=True):\n     \"\"\"\n     Returns a TestSuite consisting only of GeoDjango tests that can be run.\n     \"\"\"\n@@ -89,8 +91,9 @@ def geodjango_suite():\n         suite.addTest(test_geoip.suite())\n \n     # Finally, adding the suites for each of the GeoDjango test apps.\n-    for app_name in geo_apps(namespace=False):\n-        suite.addTest(build_suite(get_app(app_name)))\n+    if apps:\n+        for app_name in geo_apps(namespace=False):\n+            suite.addTest(build_suite(get_app(app_name)))\n \n     return suite\n "
        },
        {
            "sha": "5893841f743cc24c20cacf60be3c202602d8c600",
            "filename": "tests/runtests.py",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/d66ab474f33a0f2455583c96940a78bd06bd2218/tests%2Fruntests.py",
            "raw_url": "https://github.com/django/django/raw/d66ab474f33a0f2455583c96940a78bd06bd2218/tests%2Fruntests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fruntests.py?ref=d66ab474f33a0f2455583c96940a78bd06bd2218",
            "patch": "@@ -30,6 +30,12 @@\n     'django.contrib.staticfiles',\n ]\n \n+def geodjango(settings):\n+    # All databases must have spatial backends to run GeoDjango tests.\n+    spatial_dbs = [name for name, db_dict in settings.DATABASES.items()\n+                   if db_dict['ENGINE'].startswith('django.contrib.gis')]\n+    return len(spatial_dbs) == len(settings.DATABASES)\n+\n def get_test_models():\n     models = []\n     for loc, dirpath in (MODEL_TESTS_DIR_NAME, MODEL_TEST_DIR), (REGRESSION_TESTS_DIR_NAME, REGRESSION_TEST_DIR), (CONTRIB_DIR_NAME, CONTRIB_DIR):\n@@ -124,7 +130,15 @@ def setup(verbosity, test_labels):\n \n     # Load all the test model apps.\n     test_labels_set = set([label.split('.')[0] for label in test_labels])\n-    for model_dir, model_name in get_test_models():\n+    test_models = get_test_models()\n+\n+    # If GeoDjango, then we'll want to add in the test applications\n+    # that are a part of its test suite.\n+    if geodjango(settings):\n+        from django.contrib.gis.tests import geo_apps\n+        test_models.extend(geo_apps(runtests=True))\n+\n+    for model_dir, model_name in test_models:\n         model_label = '.'.join([model_dir, model_name])\n         # if the model was named on the command line, or\n         # no models were named (i.e., run all), import\n@@ -162,6 +176,12 @@ def django_tests(verbosity, interactive, failfast, test_labels):\n             except ValueError:\n                 pass\n \n+    # If GeoDjango is used, add it's tests that aren't a part of\n+    # an application (e.g., GEOS, GDAL, Distance objects).\n+    if geodjango(settings):\n+        from django.contrib.gis.tests import geodjango_suite\n+        extra_tests.append(geodjango_suite(apps=False))\n+\n     # Run the test suite, including the extra validation tests.\n     from django.test.utils import get_runner\n     if not hasattr(settings, 'TEST_RUNNER'):"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 29,
        "deletions": 6
    }
}