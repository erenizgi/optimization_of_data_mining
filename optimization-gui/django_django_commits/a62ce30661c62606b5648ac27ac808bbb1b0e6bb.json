{
    "author": "aaugustin",
    "message": "Fixed #17463 -- Conditionally skipped tests that Windows isn't able to run.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17278 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a62ce30661c62606b5648ac27ac808bbb1b0e6bb",
    "files": [
        {
            "sha": "cbfa0d8e74e8c2a7012eac78c012e33155a6827c",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/a62ce30661c62606b5648ac27ac808bbb1b0e6bb/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a62ce30661c62606b5648ac27ac808bbb1b0e6bb/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=a62ce30661c62606b5648ac27ac808bbb1b0e6bb",
            "patch": "@@ -22,7 +22,7 @@\n from django.test.utils import override_settings\n from django.utils import timezone\n from django.utils.tzinfo import FixedOffset\n-from django.utils.unittest import skipIf\n+from django.utils.unittest import skipIf, skipUnless\n \n from .forms import EventForm, EventSplitForm, EventModelForm\n from .models import Event, MaybeEvent, Timestamp\n@@ -42,6 +42,15 @@\n \n TZ_SUPPORT = hasattr(time, 'tzset')\n \n+# On OSes that don't provide tzset (Windows), we can't set the timezone\n+# in which the program runs. As a consequence, we must skip tests that\n+# don't enforce a specific timezone (with timezone.override or equivalent),\n+# or attempt to interpret naive datetimes in the default timezone.\n+\n+requires_tz_support = skipUnless(TZ_SUPPORT,\n+        \"This test relies on the ability to run a program in an arbitrary \"\n+        \"time zone, but your operating system isn't able to do that.\")\n+\n \n class BaseDateTimeTests(TestCase):\n \n@@ -238,6 +247,7 @@ def test_query_dates(self):\n #@override_settings(USE_TZ=True)\n class NewDatabaseTests(BaseDateTimeTests):\n \n+    @requires_tz_support\n     @skipIf(sys.version_info < (2, 6), \"this test requires Python >= 2.6\")\n     def test_naive_datetime(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n@@ -251,6 +261,7 @@ def test_naive_datetime(self):\n         # naive datetimes are interpreted in local time\n         self.assertEqual(event.dt, dt.replace(tzinfo=EAT))\n \n+    @requires_tz_support\n     @skipIf(sys.version_info < (2, 6), \"this test requires Python >= 2.6\")\n     @skipUnlessDBFeature('supports_microsecond_precision')\n     def test_naive_datetime_with_microsecond(self):\n@@ -265,6 +276,7 @@ def test_naive_datetime_with_microsecond(self):\n         # naive datetimes are interpreted in local time\n         self.assertEqual(event.dt, dt.replace(tzinfo=EAT))\n \n+    @requires_tz_support\n     @skipIf(sys.version_info < (2, 6), \"this test requires Python >= 2.6\")\n     @skipIfDBFeature('supports_microsecond_precision')\n     def test_naive_datetime_with_microsecond_unsupported(self):\n@@ -347,6 +359,7 @@ def test_query_filter_with_pytz_timezones(self):\n         self.assertEqual(Event.objects.filter(dt__in=(prev, dt, next)).count(), 1)\n         self.assertEqual(Event.objects.filter(dt__range=(prev, next)).count(), 1)\n \n+    @requires_tz_support\n     @skipIf(sys.version_info < (2, 6), \"this test requires Python >= 2.6\")\n     def test_query_filter_with_naive_datetime(self):\n         dt = datetime.datetime(2011, 9, 1, 12, 20, 30, tzinfo=EAT)\n@@ -567,6 +580,7 @@ def test_aware_datetime_in_other_timezone(self):\n #@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n class TemplateTests(BaseDateTimeTests):\n \n+    @requires_tz_support\n     def test_localtime_templatetag_and_filters(self):\n         \"\"\"\n         Test the {% localtime %} templatetag and related filters.\n@@ -686,6 +700,7 @@ def test_localtime_filters_do_not_raise_exceptions(self):\n             ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30), 'tz': 'not a tz'})\n             self.assertEqual(tpl.render(ctx), \"\")\n \n+    @requires_tz_support\n     def test_timezone_templatetag(self):\n         \"\"\"\n         Test the {% timezone %} templatetag.\n@@ -725,6 +740,7 @@ def test_timezone_templatetag_invalid_argument(self):\n         with self.assertRaises(ValueError if pytz is None else pytz.UnknownTimeZoneError):\n             Template(\"{% load tz %}{% timezone tz %}{% endtimezone %}\").render(Context({'tz': 'foobar'}))\n \n+    @skipIf(sys.platform.startswith('win'), \"Windows uses non-standard time zone names\")\n     def test_get_current_timezone_templatetag(self):\n         \"\"\"\n         Test the {% get_current_timezone %} templatetag.\n@@ -757,6 +773,7 @@ def test_get_current_timezone_templatetag_invalid_argument(self):\n         with self.assertRaises(TemplateSyntaxError):\n             Template(\"{% load tz %}{% get_current_timezone %}\").render()\n \n+    @skipIf(sys.platform.startswith('win'), \"Windows uses non-standard time zone names\")\n     def test_tz_template_context_processor(self):\n         \"\"\"\n         Test the django.core.context_processors.tz template context processor.\n@@ -765,6 +782,7 @@ def test_tz_template_context_processor(self):\n         self.assertEqual(tpl.render(Context()), \"\")\n         self.assertEqual(tpl.render(RequestContext(HttpRequest())), \"Africa/Nairobi\" if pytz else \"EAT\")\n \n+    @requires_tz_support\n     def test_date_and_time_template_filters(self):\n         tpl = Template(\"{{ dt|date:'Y-m-d' }} at {{ dt|time:'H:i:s' }}\")\n         ctx = Context({'dt': datetime.datetime(2011, 9, 1, 20, 20, 20, tzinfo=UTC)})\n@@ -790,6 +808,7 @@ def test_localtime_with_time_zone_setting_set_to_none(self):\n             self.assertTrue(tpl.render(ctx).startswith(\"2011\"))\n         timezone._localtime = None\n \n+    @requires_tz_support\n     def test_now_template_tag_uses_current_time_zone(self):\n         # Regression for #17343\n         tpl = Template(\"{% now \\\"O\\\" %}\")\n@@ -838,6 +857,7 @@ def test_model_form(self):\n #@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n class NewFormsTests(BaseDateTimeTests):\n \n+    @requires_tz_support\n     def test_form(self):\n         form = EventForm({'dt': u'2011-09-01 13:20:30'})\n         self.assertTrue(form.is_valid())\n@@ -867,11 +887,13 @@ def test_form_with_ambiguous_time(self):\n                 [u\"2011-10-30 02:30:00 couldn't be interpreted in time zone \"\n                  u\"Europe/Paris; it may be ambiguous or it may not exist.\"])\n \n+    @requires_tz_support\n     def test_split_form(self):\n         form = EventSplitForm({'dt_0': u'2011-09-01', 'dt_1': u'13:20:30'})\n         self.assertTrue(form.is_valid())\n         self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n \n+    @requires_tz_support\n     def test_model_form(self):\n         EventModelForm({'dt': u'2011-09-01 13:20:30'}).save()\n         e = Event.objects.get()\n@@ -888,6 +910,7 @@ class AdminTests(BaseDateTimeTests):\n     def setUp(self):\n         self.client.login(username='super', password='secret')\n \n+    @requires_tz_support\n     def test_changelist(self):\n         e = Event.objects.create(dt=datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n         response = self.client.get(reverse('admin:timezones_event_changelist'))\n@@ -899,6 +922,7 @@ def test_changelist_in_other_timezone(self):\n             response = self.client.get(reverse('admin:timezones_event_changelist'))\n         self.assertContains(response, e.dt.astimezone(ICT).isoformat())\n \n+    @requires_tz_support\n     def test_change_editable(self):\n         e = Event.objects.create(dt=datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n         response = self.client.get(reverse('admin:timezones_event_change', args=(e.pk,)))\n@@ -912,6 +936,7 @@ def test_change_editable_in_other_timezone(self):\n         self.assertContains(response, e.dt.astimezone(ICT).date().isoformat())\n         self.assertContains(response, e.dt.astimezone(ICT).time().isoformat())\n \n+    @requires_tz_support\n     def test_change_readonly(self):\n         Timestamp.objects.create()\n         # re-fetch the object for backends that lose microseconds (MySQL)"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 26,
        "deletions": 1
    }
}