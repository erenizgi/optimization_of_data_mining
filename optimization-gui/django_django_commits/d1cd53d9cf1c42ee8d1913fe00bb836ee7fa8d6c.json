{
    "author": "freakboy3742",
    "message": "Changeset r15232 refactored transactions so that all transaction state is maintained on the connection. This changeset continues that work, moving all transaction control to the connection, too. The transaction control functions in django.db.transaction are left as a generic way to easily apply a transaction control function based on a DB alias. Refs #9964.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15492 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c",
    "files": [
        {
            "sha": "890249a77df668651ab349dbf89b40b7c4a885a4",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 166,
            "deletions": 1,
            "changes": 167,
            "blob_url": "https://github.com/django/django/blob/d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c",
            "patch": "@@ -1,9 +1,14 @@\n import decimal\n+try:\n+    import thread\n+except ImportError:\n+    import dummy_thread as thread\n from threading import local\n \n from django.conf import settings\n from django.db import DEFAULT_DB_ALIAS\n from django.db.backends import util\n+from django.db.transaction import TransactionManagementError\n from django.utils import datetime_safe\n from django.utils.importlib import import_module\n \n@@ -28,7 +33,7 @@ def __init__(self, settings_dict, alias=DEFAULT_DB_ALIAS):\n         # Transaction related attributes\n         self.transaction_state = []\n         self.savepoint_state = 0\n-        self.dirty = None\n+        self._dirty = None\n \n     def __eq__(self, other):\n         return self.alias == other.alias\n@@ -74,6 +79,166 @@ def _savepoint_commit(self, sid):\n             return\n         self.cursor().execute(self.ops.savepoint_commit_sql(sid))\n \n+    def enter_transaction_management(self, managed=True):\n+        \"\"\"\n+        Enters transaction management for a running thread. It must be balanced with\n+        the appropriate leave_transaction_management call, since the actual state is\n+        managed as a stack.\n+\n+        The state and dirty flag are carried over from the surrounding block or\n+        from the settings, if there is no surrounding block (dirty is always false\n+        when no current block is running).\n+        \"\"\"\n+        if self.transaction_state:\n+            self.transaction_state.append(self.transaction_state[-1])\n+        else:\n+            self.transaction_state.append(settings.TRANSACTIONS_MANAGED)\n+\n+        if self._dirty is None:\n+            self._dirty = False\n+        self._enter_transaction_management(managed)\n+\n+    def leave_transaction_management(self):\n+        \"\"\"\n+        Leaves transaction management for a running thread. A dirty flag is carried\n+        over to the surrounding block, as a commit will commit all changes, even\n+        those from outside. (Commits are on connection level.)\n+        \"\"\"\n+        self._leave_transaction_management(self.is_managed())\n+        if self.transaction_state:\n+            del self.transaction_state[-1]\n+        else:\n+            raise TransactionManagementError(\"This code isn't under transaction \"\n+                \"management\")\n+        if self._dirty:\n+            self.rollback()\n+            raise TransactionManagementError(\"Transaction managed block ended with \"\n+                \"pending COMMIT/ROLLBACK\")\n+        self._dirty = False\n+\n+    def is_dirty(self):\n+        \"\"\"\n+        Returns True if the current transaction requires a commit for changes to\n+        happen.\n+        \"\"\"\n+        return self._dirty\n+\n+    def set_dirty(self):\n+        \"\"\"\n+        Sets a dirty flag for the current thread and code streak. This can be used\n+        to decide in a managed block of code to decide whether there are open\n+        changes waiting for commit.\n+        \"\"\"\n+        if self._dirty is not None:\n+            self._dirty = True\n+        else:\n+            raise TransactionManagementError(\"This code isn't under transaction \"\n+                \"management\")\n+\n+    def set_clean(self):\n+        \"\"\"\n+        Resets a dirty flag for the current thread and code streak. This can be used\n+        to decide in a managed block of code to decide whether a commit or rollback\n+        should happen.\n+        \"\"\"\n+        if self._dirty is not None:\n+            self._dirty = False\n+        else:\n+            raise TransactionManagementError(\"This code isn't under transaction management\")\n+        self.clean_savepoints()\n+\n+    def clean_savepoints(self):\n+        self.savepoint_state = 0\n+\n+    def is_managed(self):\n+        \"\"\"\n+        Checks whether the transaction manager is in manual or in auto state.\n+        \"\"\"\n+        if self.transaction_state:\n+            return self.transaction_state[-1]\n+        return settings.TRANSACTIONS_MANAGED\n+\n+    def managed(self, flag=True):\n+        \"\"\"\n+        Puts the transaction manager into a manual state: managed transactions have\n+        to be committed explicitly by the user. If you switch off transaction\n+        management and there is a pending commit/rollback, the data will be\n+        commited.\n+        \"\"\"\n+        top = self.transaction_state\n+        if top:\n+            top[-1] = flag\n+            if not flag and self.is_dirty():\n+                self._commit()\n+                self.set_clean()\n+        else:\n+            raise TransactionManagementError(\"This code isn't under transaction \"\n+                \"management\")\n+\n+    def commit_unless_managed(self):\n+        \"\"\"\n+        Commits changes if the system is not in managed transaction mode.\n+        \"\"\"\n+        if not self.is_managed():\n+            self._commit()\n+            self.clean_savepoints()\n+        else:\n+            self.set_dirty()\n+\n+    def rollback_unless_managed(self):\n+        \"\"\"\n+        Rolls back changes if the system is not in managed transaction mode.\n+        \"\"\"\n+        if not self.is_managed():\n+            self._rollback()\n+        else:\n+            self.set_dirty()\n+\n+    def commit(self):\n+        \"\"\"\n+        Does the commit itself and resets the dirty flag.\n+        \"\"\"\n+        self._commit()\n+        self.set_clean()\n+\n+    def rollback(self):\n+        \"\"\"\n+        This function does the rollback itself and resets the dirty flag.\n+        \"\"\"\n+        self._rollback()\n+        self.set_clean()\n+\n+    def savepoint(self):\n+        \"\"\"\n+        Creates a savepoint (if supported and required by the backend) inside the\n+        current transaction. Returns an identifier for the savepoint that will be\n+        used for the subsequent rollback or commit.\n+        \"\"\"\n+        thread_ident = thread.get_ident()\n+\n+        self.savepoint_state += 1\n+\n+        tid = str(thread_ident).replace('-', '')\n+        sid = \"s%s_x%d\" % (tid, self.savepoint_state)\n+        self._savepoint(sid)\n+        return sid\n+\n+    def savepoint_rollback(self, sid):\n+        \"\"\"\n+        Rolls back the most recent savepoint (if one exists). Does nothing if\n+        savepoints are not supported.\n+        \"\"\"\n+        if self.savepoint_state:\n+            self._savepoint_rollback(sid)\n+\n+    def savepoint_commit(self, sid):\n+        \"\"\"\n+        Commits the most recent savepoint (if one exists). Does nothing if\n+        savepoints are not supported.\n+        \"\"\"\n+        if self.savepoint_state:\n+            self._savepoint_commit(sid)\n+\n     def close(self):\n         if self.connection is not None:\n             self.connection.close()"
        },
        {
            "sha": "b5584dd8b99e2a25da96bcf5e9afb6ecddd74f3d",
            "filename": "django/db/transaction.py",
            "status": "modified",
            "additions": 15,
            "deletions": 80,
            "changes": 95,
            "blob_url": "https://github.com/django/django/blob/d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c/django%2Fdb%2Ftransaction.py",
            "raw_url": "https://github.com/django/django/raw/d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c/django%2Fdb%2Ftransaction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Ftransaction.py?ref=d1cd53d9cf1c42ee8d1913fe00bb836ee7fa8d6c",
            "patch": "@@ -13,10 +13,6 @@\n \"\"\"\n import sys\n \n-try:\n-    import thread\n-except ImportError:\n-    import dummy_thread as thread\n try:\n     from functools import wraps\n except ImportError:\n@@ -46,15 +42,7 @@ def enter_transaction_management(managed=True, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    if connection.transaction_state:\n-        connection.transaction_state.append(connection.transaction_state[-1])\n-    else:\n-        connection.transaction_state.append(settings.TRANSACTIONS_MANAGED)\n-\n-    if connection.dirty is None:\n-        connection.dirty = False\n-    connection._enter_transaction_management(managed)\n+    connection.enter_transaction_management(managed)\n \n def leave_transaction_management(using=None):\n     \"\"\"\n@@ -65,18 +53,7 @@ def leave_transaction_management(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    connection._leave_transaction_management(is_managed(using=using))\n-    if connection.transaction_state:\n-        del connection.transaction_state[-1]\n-    else:\n-        raise TransactionManagementError(\"This code isn't under transaction \"\n-            \"management\")\n-    if connection.dirty:\n-        rollback(using=using)\n-        raise TransactionManagementError(\"Transaction managed block ended with \"\n-            \"pending COMMIT/ROLLBACK\")\n-    connection.dirty = False\n+    connection.leave_transaction_management()\n \n def is_dirty(using=None):\n     \"\"\"\n@@ -86,8 +63,7 @@ def is_dirty(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    return connection.dirty\n+    return connection.is_dirty()\n \n def set_dirty(using=None):\n     \"\"\"\n@@ -98,12 +74,7 @@ def set_dirty(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    if connection.dirty is not None:\n-        connection.dirty = True\n-    else:\n-        raise TransactionManagementError(\"This code isn't under transaction \"\n-            \"management\")\n+    connection.set_dirty()\n \n def set_clean(using=None):\n     \"\"\"\n@@ -114,18 +85,13 @@ def set_clean(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    if connection.dirty is not None:\n-        connection.dirty = False\n-    else:\n-        raise TransactionManagementError(\"This code isn't under transaction management\")\n-    clean_savepoints(using=using)\n+    connection.set_clean()\n \n def clean_savepoints(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    connection.savepoint_state = 0\n+    connection.clean_savepoints()\n \n def is_managed(using=None):\n     \"\"\"\n@@ -134,9 +100,7 @@ def is_managed(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    if connection.transaction_state:\n-        return connection.transaction_state[-1]\n-    return settings.TRANSACTIONS_MANAGED\n+    return connection.is_managed()\n \n def managed(flag=True, using=None):\n     \"\"\"\n@@ -148,16 +112,7 @@ def managed(flag=True, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    top = connection.transaction_state\n-    if top:\n-        top[-1] = flag\n-        if not flag and is_dirty(using=using):\n-            connection._commit()\n-            set_clean(using=using)\n-    else:\n-        raise TransactionManagementError(\"This code isn't under transaction \"\n-            \"management\")\n+    connection.managed(flag)\n \n def commit_unless_managed(using=None):\n     \"\"\"\n@@ -166,11 +121,7 @@ def commit_unless_managed(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    if not is_managed(using=using):\n-        connection._commit()\n-        clean_savepoints(using=using)\n-    else:\n-        set_dirty(using=using)\n+    connection.commit_unless_managed()\n \n def rollback_unless_managed(using=None):\n     \"\"\"\n@@ -179,10 +130,7 @@ def rollback_unless_managed(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    if not is_managed(using=using):\n-        connection._rollback()\n-    else:\n-        set_dirty(using=using)\n+    connection.rollback_unless_managed()\n \n def commit(using=None):\n     \"\"\"\n@@ -191,8 +139,7 @@ def commit(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    connection._commit()\n-    set_clean(using=using)\n+    connection.commit()\n \n def rollback(using=None):\n     \"\"\"\n@@ -201,8 +148,7 @@ def rollback(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    connection._rollback()\n-    set_clean(using=using)\n+    connection.rollback()\n \n def savepoint(using=None):\n     \"\"\"\n@@ -213,14 +159,7 @@ def savepoint(using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-    thread_ident = thread.get_ident()\n-\n-    connection.savepoint_state += 1\n-\n-    tid = str(thread_ident).replace('-', '')\n-    sid = \"s%s_x%d\" % (tid, connection.savepoint_state)\n-    connection._savepoint(sid)\n-    return sid\n+    return connection.savepoint()\n \n def savepoint_rollback(sid, using=None):\n     \"\"\"\n@@ -230,9 +169,7 @@ def savepoint_rollback(sid, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    if connection.savepoint_state:\n-        connection._savepoint_rollback(sid)\n+    connection.savepoint_rollback(sid)\n \n def savepoint_commit(sid, using=None):\n     \"\"\"\n@@ -242,9 +179,7 @@ def savepoint_commit(sid, using=None):\n     if using is None:\n         using = DEFAULT_DB_ALIAS\n     connection = connections[using]\n-\n-    if connection.savepoint_state:\n-        connection._savepoint_commit(sid)\n+    connection.savepoint_commit(sid)\n \n ##############\n # DECORATORS #"
        }
    ],
    "stats": {
        "total": 262,
        "additions": 181,
        "deletions": 81
    }
}