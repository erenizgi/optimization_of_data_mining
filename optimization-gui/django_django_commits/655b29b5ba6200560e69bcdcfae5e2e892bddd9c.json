{
    "author": "spookylukey",
    "message": "Fixed #16563 - Error pickling request.user\n\nThanks to zero.fuxor for the report\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17202 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "655b29b5ba6200560e69bcdcfae5e2e892bddd9c",
    "files": [
        {
            "sha": "183c24ced35b7be6b75c38156878ffda64462add",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/655b29b5ba6200560e69bcdcfae5e2e892bddd9c/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/655b29b5ba6200560e69bcdcfae5e2e892bddd9c/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=655b29b5ba6200560e69bcdcfae5e2e892bddd9c",
            "patch": "@@ -261,6 +261,16 @@ def __deepcopy__(self, memo):\n         else:\n             return copy.deepcopy(self._wrapped, memo)\n \n+    # Because we have messed with __class__ below, we confuse pickle as to what\n+    # class we are pickling. It also appears to stop __reduce__ from being\n+    # called. So, we define __getstate__ in a way that cooperates with the way\n+    # that pickle interprets this class.  This fails when the wrapped class is a\n+    # builtin, but it is better than nothing.\n+    def __getstate__(self):\n+        if self._wrapped is empty:\n+            self._setup()\n+        return self._wrapped.__dict__\n+\n     # Need to pretend to be the wrapped class, for the sake of objects that care\n     # about this (especially in equality tests)\n     __class__ = property(new_method_proxy(operator.attrgetter(\"__class__\")))"
        },
        {
            "sha": "4ee822563e9f0f8493bcd0185db469f03d7781a7",
            "filename": "tests/regressiontests/utils/simplelazyobject.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/655b29b5ba6200560e69bcdcfae5e2e892bddd9c/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py",
            "raw_url": "https://github.com/django/django/raw/655b29b5ba6200560e69bcdcfae5e2e892bddd9c/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py?ref=655b29b5ba6200560e69bcdcfae5e2e892bddd9c",
            "patch": "@@ -1,4 +1,5 @@\n import copy\n+import pickle\n \n from django.utils.unittest import TestCase\n from django.utils.functional import SimpleLazyObject, empty\n@@ -96,3 +97,12 @@ def test_bool(self):\n         self.assertTrue(x)\n         x = SimpleLazyObject(lambda: 0)\n         self.assertFalse(x)\n+\n+    def test_pickle_complex(self):\n+        # See ticket #16563\n+        x = SimpleLazyObject(complex_object)\n+        pickled = pickle.dumps(x)\n+        unpickled = pickle.loads(pickled)\n+        self.assertEqual(unpickled, x)\n+        self.assertEqual(unicode(unpickled), unicode(x))\n+        self.assertEqual(unpickled.name, x.name)"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 20,
        "deletions": 0
    }
}