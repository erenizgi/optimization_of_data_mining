{
    "author": "freakboy3742",
    "message": "Fixed #14823 -- Corrected bootstrapping problems with register_serializers. Thanks to miker985@uw.edu for the report and draft patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15336 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4a3ea263ef964a7fb7840544870834889f56f7e4",
    "files": [
        {
            "sha": "7afc94c1d057fbfa76403d69c69170d8f3f35e28",
            "filename": "django/core/serializers/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/4a3ea263ef964a7fb7840544870834889f56f7e4/django%2Fcore%2Fserializers%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/4a3ea263ef964a7fb7840544870834889f56f7e4/django%2Fcore%2Fserializers%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fserializers%2F__init__.py?ref=4a3ea263ef964a7fb7840544870834889f56f7e4",
            "patch": "@@ -48,6 +48,8 @@ def register_serializer(format, serializer_module, serializers=None):\n     directly into the global register of serializers. Adding serializers\n     directly is not a thread-safe operation.\n     \"\"\"\n+    if serializers is None and not _serializers:\n+        _load_serializers()\n     module = importlib.import_module(serializer_module)\n     if serializers is None:\n         _serializers[format] = module\n@@ -56,6 +58,8 @@ def register_serializer(format, serializer_module, serializers=None):\n \n def unregister_serializer(format):\n     \"Unregister a given serializer. This is not a thread-safe operation.\"\n+    if not _serializers:\n+        _load_serializers()\n     del _serializers[format]\n \n def get_serializer(format):"
        },
        {
            "sha": "01b4b68ac236187fdfea8f31a8b73d50d41f31d5",
            "filename": "tests/modeltests/serializers/tests.py",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/4a3ea263ef964a7fb7840544870834889f56f7e4/tests%2Fmodeltests%2Fserializers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4a3ea263ef964a7fb7840544870834889f56f7e4/tests%2Fmodeltests%2Fserializers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fserializers%2Ftests.py?ref=4a3ea263ef964a7fb7840544870834889f56f7e4",
            "patch": "@@ -3,14 +3,65 @@\n from StringIO import StringIO\n from xml.dom import minidom\n \n+from django.conf import settings\n from django.core import serializers\n from django.db import transaction\n from django.test import TestCase, TransactionTestCase, Approximate\n-from django.utils import simplejson\n+from django.utils import simplejson, unittest\n \n from models import Category, Author, Article, AuthorProfile, Actor, \\\n                                     Movie, Score, Player, Team\n \n+class SerializerRegistrationTests(unittest.TestCase):\n+    def setUp(self):\n+        self.old_SERIALIZATION_MODULES = getattr(settings, 'SERIALIZATION_MODULES', None)\n+        self.old_serializers = serializers._serializers\n+\n+        serializers._serializers = {}\n+        settings.SERIALIZATION_MODULES = {\n+            \"json2\" : \"django.core.serializers.json\",\n+        }\n+\n+    def tearDown(self):\n+        serializers._serializers = self.old_serializers\n+        if self.old_SERIALIZATION_MODULES:\n+            settings.SERIALIZATION_MODULES = self.old_SERIALIZATION_MODULES\n+        else:\n+            delattr(settings, 'SERIALIZATION_MODULES')\n+\n+    def test_register(self):\n+        \"Registering a new serializer populates the full registry. Refs #14823\"\n+        serializers.register_serializer('json3', 'django.core.serializers.json')\n+\n+        public_formats = serializers.get_public_serializer_formats()\n+        self.assertIn('json3', public_formats)\n+        self.assertIn('json2', public_formats)\n+        self.assertIn('xml', public_formats)\n+\n+    def test_unregister(self):\n+        \"Unregistering a serializer doesn't cause the registry to be repopulated. Refs #14823\"\n+        serializers.unregister_serializer('xml')\n+        serializers.register_serializer('json3', 'django.core.serializers.json')\n+\n+        public_formats = serializers.get_public_serializer_formats()\n+\n+        self.assertNotIn('xml', public_formats)\n+        self.assertIn('json3', public_formats)\n+\n+    def test_builtin_serializers(self):\n+        \"Requesting a list of serializer formats popuates the registry\"\n+        all_formats = set(serializers.get_serializer_formats())\n+        public_formats = set(serializers.get_public_serializer_formats())\n+\n+        self.assertIn('xml', all_formats),\n+        self.assertIn('xml', public_formats)\n+\n+        self.assertIn('json2', all_formats)\n+        self.assertIn('json2', public_formats)\n+\n+        self.assertIn('python', all_formats)\n+        self.assertNotIn('python', public_formats)\n+\n class SerializersTestBase(object):\n     @staticmethod\n     def _comparison_value(value):"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 56,
        "deletions": 1
    }
}