{
    "author": "gabrielhurley",
    "message": "Fixed #18210 -- Escaped special characters in reverse prefixes.\n\nEnsured that special characters passed in to reverse via the\nprefix argument are properly escaped so that calls to\ndjango.utils.regex_helpers.normalize and/or string formatting\noperations don't result in exceptions.\n\nThanks to toofishes for the error report.",
    "sha": "90e530978d590a5bdcf75525aa03f844766018b8",
    "files": [
        {
            "sha": "9c0b7b70fdb636f3b0422d9837e4afc75bb55664",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/90e530978d590a5bdcf75525aa03f844766018b8/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/90e530978d590a5bdcf75525aa03f844766018b8/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=90e530978d590a5bdcf75525aa03f844766018b8",
            "patch": "@@ -16,6 +16,7 @@\n from django.utils.datastructures import MultiValueDict\n from django.utils.encoding import force_str, force_text, iri_to_uri\n from django.utils.functional import memoize, lazy\n+from django.utils.http import urlquote\n from django.utils.importlib import import_module\n from django.utils.module_loading import module_has_submodule\n from django.utils.regex_helper import normalize\n@@ -379,14 +380,15 @@ def _reverse_with_prefix(self, lookup_view, _prefix, *args, **kwargs):\n         except (ImportError, AttributeError) as e:\n             raise NoReverseMatch(\"Error importing '%s': %s.\" % (lookup_view, e))\n         possibilities = self.reverse_dict.getlist(lookup_view)\n-        prefix_norm, prefix_args = normalize(_prefix)[0]\n+\n+        prefix_norm, prefix_args = normalize(urlquote(_prefix))[0]\n         for possibility, pattern, defaults in possibilities:\n             for result, params in possibility:\n                 if args:\n                     if len(args) != len(params) + len(prefix_args):\n                         continue\n                     unicode_args = [force_text(val) for val in args]\n-                    candidate =  (prefix_norm + result) % dict(zip(prefix_args + params, unicode_args))\n+                    candidate = (prefix_norm + result) % dict(zip(prefix_args + params, unicode_args))\n                 else:\n                     if set(kwargs.keys()) | set(defaults.keys()) != set(params) | set(defaults.keys()) | set(prefix_args):\n                         continue\n@@ -398,8 +400,8 @@ def _reverse_with_prefix(self, lookup_view, _prefix, *args, **kwargs):\n                     if not matches:\n                         continue\n                     unicode_kwargs = dict([(k, force_text(v)) for (k, v) in kwargs.items()])\n-                    candidate = (prefix_norm + result) % unicode_kwargs\n-                if re.search('^%s%s' % (_prefix, pattern), candidate, re.UNICODE):\n+                    candidate = (prefix_norm.replace('%', '%%') + result) % unicode_kwargs\n+                if re.search('^%s%s' % (prefix_norm, pattern), candidate, re.UNICODE):\n                     return candidate\n         # lookup_view can be URL label, or dotted path, or callable, Any of\n         # these can be passed in at the top, but callables are not friendly in"
        },
        {
            "sha": "85f18db4c5949d7440fcc000a5e60ada384c4c44",
            "filename": "tests/regressiontests/urlpatterns_reverse/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/90e530978d590a5bdcf75525aa03f844766018b8/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/90e530978d590a5bdcf75525aa03f844766018b8/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py?ref=90e530978d590a5bdcf75525aa03f844766018b8",
            "patch": "@@ -171,6 +171,18 @@ def test_reverse_none(self):\n         # Reversing None should raise an error, not return the last un-named view.\n         self.assertRaises(NoReverseMatch, reverse, None)\n \n+    def test_prefix_braces(self):\n+        self.assertEqual('/%7B%7Binvalid%7D%7D/includes/non_path_include/',\n+               reverse('non_path_include', prefix='/{{invalid}}/'))\n+\n+    def test_prefix_parenthesis(self):\n+        self.assertEqual('/bogus%29/includes/non_path_include/',\n+               reverse('non_path_include', prefix='/bogus)/'))\n+\n+    def test_prefix_format_char(self):\n+        self.assertEqual('/bump%2520map/includes/non_path_include/',\n+               reverse('non_path_include', prefix='/bump%20map/'))\n+\n class ResolverTests(unittest.TestCase):\n     def test_resolver_repr(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 22,
        "additions": 18,
        "deletions": 4
    }
}