{
    "author": "spookylukey",
    "message": "Fixed #15776 - delete regression in Django 1.3 involving nullable foreign keys\n\nMany thanks to aaron.l.madison for the detailed report and to emulbreh for\nthe fix.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16295 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "de3b58d6267a01edefb36c22f80c3399c819d465",
    "files": [
        {
            "sha": "310e3af948348457d3ad5bfb3aa0b1d9fb875921",
            "filename": "django/db/models/deletion.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/de3b58d6267a01edefb36c22f80c3399c819d465/django%2Fdb%2Fmodels%2Fdeletion.py",
            "raw_url": "https://github.com/django/django/raw/de3b58d6267a01edefb36c22f80c3399c819d465/django%2Fdb%2Fmodels%2Fdeletion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fdeletion.py?ref=de3b58d6267a01edefb36c22f80c3399c819d465",
            "patch": "@@ -82,8 +82,8 @@ def __init__(self, using):\n     def add(self, objs, source=None, nullable=False, reverse_dependency=False):\n         \"\"\"\n         Adds 'objs' to the collection of objects to be deleted.  If the call is\n-        the result of a cascade, 'source' should be the model that caused it\n-        and 'nullable' should be set to True, if the relation can be null.\n+        the result of a cascade, 'source' should be the model that caused it,\n+        and 'nullable' should be set to True if the relation can be null.\n \n         Returns a list of all objects that were not already collected.\n         \"\"\"\n@@ -99,7 +99,7 @@ def add(self, objs, source=None, nullable=False, reverse_dependency=False):\n         # Nullable relationships can be ignored -- they are nulled out before\n         # deleting, and therefore do not affect the order in which objects have\n         # to be deleted.\n-        if new_objs and source is not None and not nullable:\n+        if source is not None and not nullable:\n             if reverse_dependency:\n                 source, model = model, source\n             self.dependencies.setdefault(source, set()).add(model)"
        },
        {
            "sha": "8e3d0d55b155d224e9d1f8aeed72708fbca09918",
            "filename": "tests/regressiontests/delete_regress/models.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/de3b58d6267a01edefb36c22f80c3399c819d465/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/de3b58d6267a01edefb36c22f80c3399c819d465/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py?ref=de3b58d6267a01edefb36c22f80c3399c819d465",
            "patch": "@@ -51,3 +51,19 @@ class Food(models.Model):\n class Eaten(models.Model):\n     food = models.ForeignKey(Food, to_field=\"name\")\n     meal = models.CharField(max_length=20)\n+\n+\n+# Models for #15776\n+\n+class Policy(models.Model):\n+    policy_number = models.CharField(max_length=10)\n+\n+class Version(models.Model):\n+    policy = models.ForeignKey(Policy)\n+\n+class Location(models.Model):\n+    version = models.ForeignKey(Version, blank=True, null=True)\n+\n+class Item(models.Model):\n+    version = models.ForeignKey(Version)\n+    location = models.ForeignKey(Location, blank=True, null=True)"
        },
        {
            "sha": "2027780329e0a5d19a5df8f76fcd15430b44e824",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/de3b58d6267a01edefb36c22f80c3399c819d465/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/de3b58d6267a01edefb36c22f80c3399c819d465/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=de3b58d6267a01edefb36c22f80c3399c819d465",
            "patch": "@@ -5,7 +5,8 @@\n from django.test import TestCase, TransactionTestCase, skipUnlessDBFeature\n \n from models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n-    PlayedWithNote, Contact, Email, Researcher, Food, Eaten)\n+    PlayedWithNote, Contact, Email, Researcher, Food, Eaten,\n+    Policy, Version, Location, Item)\n \n \n # Can't run this test under SQLite, because you can't\n@@ -102,6 +103,13 @@ def test_fk_to_m2m_through(self):\n         # first two asserts just sanity checks, this is the kicker:\n         self.assertEqual(PlayedWithNote.objects.count(), 0)\n \n+    def test_15776(self):\n+        policy = Policy.objects.create(pk=1, policy_number=\"1234\")\n+        version = Version.objects.create(policy=policy)\n+        location = Location.objects.create(version=version)\n+        item = Item.objects.create(version=version, location=location)\n+        policy.delete()\n+\n \n class DeleteCascadeTransactionTests(TransactionTestCase):\n     def test_inheritance(self):"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 28,
        "deletions": 4
    }
}