{
    "author": "claudep",
    "message": "Fixed #15271 -- Defined a to_python method for GeometryField\n\nThanks volrath and copelco for their work on the patch.",
    "sha": "41eb70f7620dbae43bb72f265489fa3ac19c5c66",
    "files": [
        {
            "sha": "cefb6830ba881ee2ac8303df6cf2374fbf6ab2b1",
            "filename": "django/contrib/gis/forms/fields.py",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/41eb70f7620dbae43bb72f265489fa3ac19c5c66/django%2Fcontrib%2Fgis%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/41eb70f7620dbae43bb72f265489fa3ac19c5c66/django%2Fcontrib%2Fgis%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fforms%2Ffields.py?ref=41eb70f7620dbae43bb72f265489fa3ac19c5c66",
            "patch": "@@ -5,7 +5,7 @@\n \n # While this couples the geographic forms to the GEOS library,\n # it decouples from database (by not importing SpatialBackend).\n-from django.contrib.gis.geos import GEOSGeometry\n+from django.contrib.gis.geos import GEOSException, GEOSGeometry\n \n class GeometryField(forms.Field):\n     \"\"\"\n@@ -31,6 +31,15 @@ def __init__(self, **kwargs):\n         self.null = kwargs.pop('null', True)\n         super(GeometryField, self).__init__(**kwargs)\n \n+    def to_python(self, value):\n+        \"\"\"\n+        Transforms the value to a Geometry object.\n+        \"\"\"\n+        try:\n+            return GEOSGeometry(value)\n+        except (GEOSException, ValueError, TypeError):\n+            raise forms.ValidationError(self.error_messages['invalid_geom'])\n+\n     def clean(self, value):\n         \"\"\"\n         Validates that the input value can be converted to a Geometry\n@@ -44,11 +53,8 @@ def clean(self, value):\n             else:\n                 raise forms.ValidationError(self.error_messages['no_geom'])\n \n-        # Trying to create a Geometry object from the form value.\n-        try:\n-            geom = GEOSGeometry(value)\n-        except:\n-            raise forms.ValidationError(self.error_messages['invalid_geom'])\n+        # Transform the value to a python object first\n+        geom = self.to_python(value)\n \n         # Ensuring that the geometry is of the correct type (indicated\n         # using the OGC string label)."
        },
        {
            "sha": "ed851df0d2a5de01984e9910970b82640f274c9f",
            "filename": "django/contrib/gis/tests/test_geoforms.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/41eb70f7620dbae43bb72f265489fa3ac19c5c66/django%2Fcontrib%2Fgis%2Ftests%2Ftest_geoforms.py",
            "raw_url": "https://github.com/django/django/raw/41eb70f7620dbae43bb72f265489fa3ac19c5c66/django%2Fcontrib%2Fgis%2Ftests%2Ftest_geoforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Ftest_geoforms.py?ref=41eb70f7620dbae43bb72f265489fa3ac19c5c66",
            "patch": "@@ -56,8 +56,25 @@ def test03_geom_type(self):\n \n         pnt_fld = forms.GeometryField(geom_type='POINT')\n         self.assertEqual(GEOSGeometry('POINT(5 23)'), pnt_fld.clean('POINT(5 23)'))\n+        # a WKT for any other geom_type will be properly transformed by `to_python`\n+        self.assertEqual(GEOSGeometry('LINESTRING(0 0, 1 1)'), pnt_fld.to_python('LINESTRING(0 0, 1 1)'))\n+        # but rejected by `clean`\n         self.assertRaises(forms.ValidationError, pnt_fld.clean, 'LINESTRING(0 0, 1 1)')\n \n+    def test04_to_python(self):\n+        \"\"\"\n+        Testing to_python returns a correct GEOSGeometry object or\n+        a ValidationError\n+        \"\"\"\n+        fld = forms.GeometryField()\n+        # to_python returns the same GEOSGeometry for a WKT\n+        for wkt in ('POINT(5 23)', 'MULTIPOLYGON(((0 0, 0 1, 1 1, 1 0, 0 0)))', 'LINESTRING(0 0, 1 1)'):\n+            self.assertEqual(GEOSGeometry(wkt), fld.to_python(wkt))\n+        # but raises a ValidationError for any other string\n+        for wkt in ('POINT(5)', 'MULTI   POLYGON(((0 0, 0 1, 1 1, 1 0, 0 0)))', 'BLAH(0 0, 1 1)'):\n+            self.assertRaises(forms.ValidationError, fld.to_python, wkt)\n+\n+\n def suite():\n     s = unittest.TestSuite()\n     s.addTest(unittest.makeSuite(GeometryFieldTest))"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 29,
        "deletions": 6
    }
}