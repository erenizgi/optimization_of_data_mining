{
    "author": "akaariai",
    "message": "Fixed #19198 -- merged 4 different Oracle fixes",
    "sha": "908efca81723af7a3f4fb5b586e530ed7cd3952b",
    "files": [
        {
            "sha": "8355b27fd7351484f64e625cc12be37f474e2205",
            "filename": "django/contrib/gis/tests/utils.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/908efca81723af7a3f4fb5b586e530ed7cd3952b/django%2Fcontrib%2Fgis%2Ftests%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/908efca81723af7a3f4fb5b586e530ed7cd3952b/django%2Fcontrib%2Fgis%2Ftests%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Futils.py?ref=908efca81723af7a3f4fb5b586e530ed7cd3952b",
            "patch": "@@ -26,7 +26,7 @@ def no_spatialite(func): return no_backend(func, 'spatialite')\n spatialite = _default_db == 'spatialite'\n \n HAS_SPATIALREFSYS = True\n-if oracle:\n+if oracle and 'gis' in settings.DATABASES[DEFAULT_DB_ALIAS]['ENGINE']:\n     from django.contrib.gis.db.backends.oracle.models import SpatialRefSys\n elif postgis:\n     from django.contrib.gis.db.backends.postgis.models import SpatialRefSys"
        },
        {
            "sha": "aad52992ddf2bfc09a3986238437fcaea673aca8",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/908efca81723af7a3f4fb5b586e530ed7cd3952b/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/908efca81723af7a3f4fb5b586e530ed7cd3952b/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=908efca81723af7a3f4fb5b586e530ed7cd3952b",
            "patch": "@@ -256,6 +256,10 @@ def quote_name(self, name):\n         if not name.startswith('\"') and not name.endswith('\"'):\n             name = '\"%s\"' % util.truncate_name(name.upper(),\n                                                self.max_name_length())\n+        # Oracle puts the query text into a (query % args) construct, so % signs\n+        # in names need to be escaped. The '%%' will be collapsed back to '%' at\n+        # that stage so we aren't really making the name longer here.\n+        name = name.replace('%','%%')\n         return name.upper()\n \n     def random_function_sql(self):"
        },
        {
            "sha": "da4c69f362137a3f6ca9b8fce34e4060ee9806f9",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/908efca81723af7a3f4fb5b586e530ed7cd3952b/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/908efca81723af7a3f4fb5b586e530ed7cd3952b/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=908efca81723af7a3f4fb5b586e530ed7cd3952b",
            "patch": "@@ -1418,8 +1418,15 @@ def get_cached_row(row, index_start, using,  klass_info, offset=0):\n     fields = row[index_start : index_start + field_count]\n     # If all the select_related columns are None, then the related\n     # object must be non-existent - set the relation to None.\n-    # Otherwise, construct the related object.\n-    if fields == (None,) * field_count:\n+    # Otherwise, construct the related object. Also, some backends treat ''\n+    # and None equivalently for char fields, so we have to be prepared for\n+    # '' values.\n+    if connections[using].features.interprets_empty_strings_as_nulls:\n+        vals = tuple([None if f == '' else f for f in fields])\n+    else:\n+        vals = fields\n+\n+    if vals == (None,) * field_count:\n         obj = None\n     else:\n         if field_names:"
        },
        {
            "sha": "4766dcf44e31864171bbc0feab2a58e552e7bbee",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/908efca81723af7a3f4fb5b586e530ed7cd3952b/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/908efca81723af7a3f4fb5b586e530ed7cd3952b/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=908efca81723af7a3f4fb5b586e530ed7cd3952b",
            "patch": "@@ -25,6 +25,14 @@\n \n class OracleChecks(unittest.TestCase):\n \n+    @unittest.skipUnless(connection.vendor == 'oracle',\n+                         \"No need to check Oracle quote_name semantics\")\n+    def test_quote_name(self):\n+        # Check that '%' chars are escaped for query execution.\n+        name = '\"SOME%NAME\"'\n+        quoted_name = connection.ops.quote_name(name)\n+        self.assertEquals(quoted_name % (), name)\n+\n     @unittest.skipUnless(connection.vendor == 'oracle',\n                          \"No need to check Oracle cursor semantics\")\n     def test_dbms_session(self):"
        },
        {
            "sha": "028d2633371c289bdabe9fd61f038db823ec6e28",
            "filename": "tests/regressiontests/inspectdb/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/908efca81723af7a3f4fb5b586e530ed7cd3952b/tests%2Fregressiontests%2Finspectdb%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/908efca81723af7a3f4fb5b586e530ed7cd3952b/tests%2Fregressiontests%2Finspectdb%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finspectdb%2Ftests.py?ref=908efca81723af7a3f4fb5b586e530ed7cd3952b",
            "patch": "@@ -1,6 +1,7 @@\n from __future__ import unicode_literals\n \n from django.core.management import call_command\n+from django.db import connection\n from django.test import TestCase, skipUnlessDBFeature\n from django.utils.six import StringIO\n \n@@ -60,14 +61,16 @@ def test_digits_column_name_introspection(self):\n         self.assertIn(\"number_45extra = models.CharField\", output)\n \n     def test_special_column_name_introspection(self):\n-        \"\"\"Introspection of column names containing special characters,\n-           unsuitable for Python identifiers\n+        \"\"\"\n+        Introspection of column names containing special characters,\n+        unsuitable for Python identifiers\n         \"\"\"\n         out = StringIO()\n         call_command('inspectdb', stdout=out)\n         output = out.getvalue()\n+        base_name = 'Field' if connection.vendor != 'oracle' else 'field'\n         self.assertIn(\"field = models.IntegerField()\", output)\n-        self.assertIn(\"field_field = models.IntegerField(db_column='Field_')\", output)\n-        self.assertIn(\"field_field_0 = models.IntegerField(db_column='Field__')\", output)\n+        self.assertIn(\"field_field = models.IntegerField(db_column='%s_')\" % base_name, output)\n+        self.assertIn(\"field_field_0 = models.IntegerField(db_column='%s__')\" % base_name, output)\n         self.assertIn(\"field_field_1 = models.IntegerField(db_column='__field')\", output)\n         self.assertIn(\"prc_x = models.IntegerField(db_column='prc(%) x')\", output)"
        },
        {
            "sha": "4b8a3277e2a783b5e443ef0fa7177e945da188b5",
            "filename": "tests/regressiontests/introspection/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/908efca81723af7a3f4fb5b586e530ed7cd3952b/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/908efca81723af7a3f4fb5b586e530ed7cd3952b/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fintrospection%2Ftests.py?ref=908efca81723af7a3f4fb5b586e530ed7cd3952b",
            "patch": "@@ -4,10 +4,15 @@\n \n from django.db import connection\n from django.test import TestCase, skipUnlessDBFeature, skipIfDBFeature\n-from django.utils import six\n+from django.utils import six, unittest\n \n from .models import Reporter, Article\n \n+if connection.vendor == 'oracle':\n+    expectedFailureOnOracle = unittest.expectedFailure\n+else:\n+    expectedFailureOnOracle = lambda f: f\n+\n #\n # The introspection module is optional, so methods tested here might raise\n # NotImplementedError. This is perfectly acceptable behavior for the backend\n@@ -89,7 +94,13 @@ def test_get_table_description_types(self):\n             [datatype(r[1], r) for r in desc],\n             ['IntegerField', 'CharField', 'CharField', 'CharField', 'BigIntegerField']\n         )\n-        # Check also length of CharFields\n+\n+    # The following test fails on Oracle due to #17202 (can't correctly\n+    # inspect the length of character columns).\n+    @expectedFailureOnOracle\n+    def test_get_table_description_col_lengths(self):\n+        cursor = connection.cursor()\n+        desc = connection.introspection.get_table_description(cursor, Reporter._meta.db_table)\n         self.assertEqual(\n             [r[3] for r in desc if datatype(r[1], r) == 'CharField'],\n             [30, 30, 75]"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 42,
        "deletions": 9
    }
}