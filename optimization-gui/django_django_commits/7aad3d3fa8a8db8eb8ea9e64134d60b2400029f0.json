{
    "author": "carljm",
    "message": "Fixed #15094 - Added check for forgetting trailing comma in STATICFILES_DIRS tuple. Also reorganized staticfiles settings-checks for better consistency.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15386 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0",
    "files": [
        {
            "sha": "c3b0eb6f07fdcdd6d9fd43bafcb7866d8675dd8a",
            "filename": "django/contrib/staticfiles/finders.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "raw_url": "https://github.com/django/django/raw/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Ffinders.py?ref=7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0",
            "patch": "@@ -46,11 +46,19 @@ def __init__(self, apps=None, *args, **kwargs):\n         self.storages = SortedDict()\n         # Set of locations with static files\n         self.locations = set()\n+        if not isinstance(settings.STATICFILES_DIRS, (list, tuple)):\n+            raise ImproperlyConfigured(\n+                \"Your STATICFILES_DIRS setting is not a tuple or list; \"\n+                \"perhaps you forgot a trailing comma?\")\n         for root in settings.STATICFILES_DIRS:\n             if isinstance(root, (list, tuple)):\n                 prefix, root = root\n             else:\n                 prefix = ''\n+            if os.path.abspath(settings.STATIC_ROOT) == os.path.abspath(root):\n+                raise ImproperlyConfigured(\n+                    \"The STATICFILES_DIRS setting should \"\n+                    \"not contain the STATIC_ROOT setting\")\n             self.locations.add((prefix, root))\n         # Don't initialize multiple storages for the same location\n         for prefix, root in self.locations:"
        },
        {
            "sha": "669ffaeabc19a7a63300db26481bae7f6f4dc01d",
            "filename": "django/contrib/staticfiles/handlers.py",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Fhandlers.py",
            "raw_url": "https://github.com/django/django/raw/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Fhandlers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fhandlers.py?ref=7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0",
            "patch": "@@ -26,12 +26,7 @@ def get_base_dir(self):\n         return settings.STATIC_ROOT\n \n     def get_base_url(self):\n-        if not settings.STATIC_URL:\n-            raise ImproperlyConfigured(\"You're using the staticfiles app \"\n-                \"without having set the STATIC_URL setting. Set it to \"\n-                \"URL that handles the files served from STATIC_ROOT.\")\n-        if settings.DEBUG:\n-            utils.check_settings()\n+        utils.check_settings()\n         return settings.STATIC_URL\n \n     def _should_handle(self, path):"
        },
        {
            "sha": "ab4a364f9bf439b6f80ecbbd55a8cf0d4f042484",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0",
            "patch": "@@ -10,7 +10,7 @@\n class StaticFilesStorage(FileSystemStorage):\n     \"\"\"\n     Standard file system storage for static files.\n-    \n+\n     The defaults for ``location`` and ``base_url`` are\n     ``STATIC_ROOT`` and ``STATIC_URL``.\n     \"\"\"\n@@ -28,8 +28,7 @@ def __init__(self, location=None, base_url=None, *args, **kwargs):\n             raise ImproperlyConfigured(\"You're using the staticfiles app \"\n                 \"without having set the STATIC_URL setting. Set it to \"\n                 \"URL that handles the files served from STATIC_ROOT.\")\n-        if settings.DEBUG:\n-            utils.check_settings()\n+        utils.check_settings()\n         super(StaticFilesStorage, self).__init__(location, base_url, *args, **kwargs)\n \n "
        },
        {
            "sha": "9ff4bc4321b4abb13ae6950dd62ef68157e61f85",
            "filename": "django/contrib/staticfiles/utils.py",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/django%2Fcontrib%2Fstaticfiles%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Futils.py?ref=7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0",
            "patch": "@@ -35,20 +35,17 @@ def get_files(storage, ignore_patterns=[], location=''):\n \n def check_settings():\n     \"\"\"\n-    Checks if the MEDIA_(ROOT|URL) and STATIC_(ROOT|URL)\n-    settings have the same value.\n+    Checks if the staticfiles settings have sane values.\n+\n     \"\"\"\n+    if not settings.STATIC_URL:\n+        raise ImproperlyConfigured(\n+            \"You're using the staticfiles app \"\n+            \"without having set the required STATIC_URL setting.\")\n     if settings.MEDIA_URL == settings.STATIC_URL:\n         raise ImproperlyConfigured(\"The MEDIA_URL and STATIC_URL \"\n                                    \"settings must have different values\")\n     if ((settings.MEDIA_ROOT and settings.STATIC_ROOT) and\n             (settings.MEDIA_ROOT == settings.STATIC_ROOT)):\n         raise ImproperlyConfigured(\"The MEDIA_ROOT and STATIC_ROOT \"\n                                    \"settings must have different values\")\n-    for path in settings.STATICFILES_DIRS:\n-        # in case the item contains a prefix\n-        if isinstance(path, (list, tuple)):\n-            path = path[1]\n-        if os.path.abspath(settings.STATIC_ROOT) == os.path.abspath(path):\n-            raise ImproperlyConfigured(\"The STATICFILES_DIRS setting should \"\n-                                       \"not contain the STATIC_ROOT setting\")"
        },
        {
            "sha": "1fb043c715f1021e7c957866c5737fdf03a44036",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=7aad3d3fa8a8db8eb8ea9e64134d60b2400029f0",
            "patch": "@@ -10,8 +10,6 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.core.files.storage import default_storage\n from django.core.management import call_command\n-from django.db.models.loading import load_app\n-from django.template import Template, Context\n from django.test import TestCase\n from django.utils._os import rmtree_errorhandler\n \n@@ -383,7 +381,27 @@ def test_get_finder(self):\n         self.assertTrue(isinstance(finders.get_finder(\n             'django.contrib.staticfiles.finders.FileSystemFinder'),\n             finders.FileSystemFinder))\n+\n+    def test_get_finder_bad_classname(self):\n         self.assertRaises(ImproperlyConfigured,\n             finders.get_finder, 'django.contrib.staticfiles.finders.FooBarFinder')\n+\n+    def test_get_finder_bad_module(self):\n         self.assertRaises(ImproperlyConfigured,\n             finders.get_finder, 'foo.bar.FooBarFinder')\n+\n+\n+class TestStaticfilesDirsType(TestCase):\n+    \"\"\"\n+    We can't determine if STATICFILES_DIRS is set correctly just by looking at\n+    the type, but we can determine if it's definitely wrong.\n+    \"\"\"\n+    def setUp(self):\n+        self.old_settings_dir = settings.STATICFILES_DIRS\n+        settings.STATICFILES_DIRS = 'a string'\n+\n+    def tearDown(self):\n+        settings.STATICFILES_DIRS = self.old_settings_dir\n+\n+    def test_non_tuple_raises_exception(self):\n+        self.assertRaises(ImproperlyConfigured, finders.FileSystemFinder)"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 37,
        "deletions": 20
    }
}