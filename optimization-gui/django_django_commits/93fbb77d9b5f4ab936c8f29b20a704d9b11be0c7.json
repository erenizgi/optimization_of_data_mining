{
    "author": "jphalip",
    "message": "Fixed #16716 -- Fixed two small regressions in the development version introduced in r16144 where the changelist crashed with a 500 error instead of nicely operating a 302 redirection back to the changelist.\n\nThe two specific cases were:\n\n* a lookup through a non-existing field and apparently spanning multiple relationships (e.g. \"?nonexistant__whatever=xxxx\").\n* a proper list_filter's queryset failing with an exception. In Django 1.3 the queryset was only directly manipulated by the changelist, whereas in 1.4 the list_filters may manipulate the queryset themselves. The fix here implies catching potential failures from the list_filters too.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16705 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7",
    "files": [
        {
            "sha": "f741fd07643f6d508f3671feed82079805780da3",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 23,
            "deletions": 20,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7",
            "patch": "@@ -267,6 +267,7 @@ def get_lookup_params(self, use_distinct=False):\n                 del lookup_params[key]\n                 lookup_params[smart_str(key)] = value\n \n+            field = None\n             if not use_distinct:\n                 # Check if it's a relationship that might return more than one\n                 # instance\n@@ -291,7 +292,7 @@ def get_lookup_params(self, use_distinct=False):\n                     value = True\n                 lookup_params[key] = value\n \n-            if not self.model_admin.lookup_allowed(key, value):\n+            if field and not self.model_admin.lookup_allowed(key, value):\n                 raise SuspiciousOperation(\"Filtering by %s not allowed\" % key)\n \n         return lookup_params, use_distinct\n@@ -300,28 +301,30 @@ def get_query_set(self, request):\n         lookup_params, use_distinct = self.get_lookup_params(use_distinct=False)\n         self.filter_specs, self.has_filters = self.get_filters(request, use_distinct)\n \n-        # Let every list filter modify the qs and params to its liking\n-        qs = self.root_query_set\n-        for filter_spec in self.filter_specs:\n-            new_qs = filter_spec.queryset(request, qs)\n-            if new_qs is not None:\n-                qs = new_qs\n-                for param in filter_spec.used_params():\n-                    try:\n-                        del lookup_params[param]\n-                    except KeyError:\n-                        pass\n-\n-        # Apply the remaining lookup parameters from the query string (i.e.\n-        # those that haven't already been processed by the filters).\n         try:\n+            # First, let every list filter modify the qs and params to its\n+            # liking.\n+            qs = self.root_query_set\n+            for filter_spec in self.filter_specs:\n+                new_qs = filter_spec.queryset(request, qs)\n+                if new_qs is not None:\n+                    qs = new_qs\n+                    for param in filter_spec.used_params():\n+                        try:\n+                            del lookup_params[param]\n+                        except KeyError:\n+                            pass\n+\n+            # Then, apply the remaining lookup parameters from the query string\n+            # (i.e. those that haven't already been processed by the filters).\n             qs = qs.filter(**lookup_params)\n-        # Naked except! Because we don't have any other way of validating \"params\".\n-        # They might be invalid if the keyword arguments are incorrect, or if the\n-        # values are not in the correct type, so we might get FieldError, ValueError,\n-        # ValicationError, or ? from a custom field that raises yet something else\n-        # when handed impossible data.\n         except Exception, e:\n+            # Naked except! Because we don't have any other way of validating\n+            # \"lookup_params\". They might be invalid if the keyword arguments\n+            # are incorrect, or if the values are not in the correct type, so\n+            # we might get FieldError, ValueError, ValicationError, or ? from a\n+            # custom field that raises yet something else when handed\n+            # impossible data.\n             raise IncorrectLookupParameters(e)\n \n         # Use select_related() if one of the list_display options is a field"
        },
        {
            "sha": "e089ce24fb9e2c78b3c1cf42ebd486f53ce0b519",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7",
            "patch": "@@ -1,9 +1,9 @@\n import datetime\n \n+from django.contrib.admin.options import IncorrectLookupParameters\n from django.core.exceptions import ImproperlyConfigured\n from django.test import TestCase, RequestFactory\n from django.utils.encoding import force_unicode\n-\n from django.contrib.auth.admin import UserAdmin\n from django.contrib.auth.models import User\n from django.contrib.admin.views.main import ChangeList\n@@ -50,6 +50,11 @@ class DecadeListFilterWithNoneReturningLookups(DecadeListFilterWithTitleAndParam\n     def lookups(self, request, model_admin):\n         pass\n \n+class DecadeListFilterWithFailingQueryset(DecadeListFilterWithTitleAndParameter):\n+\n+    def queryset(self, request, queryset):\n+        raise Exception\n+\n class DecadeListFilterWithQuerysetBasedLookups(DecadeListFilterWithTitleAndParameter):\n \n     def lookups(self, request, model_admin):\n@@ -84,6 +89,9 @@ class DecadeFilterBookAdminWithoutParameter(ModelAdmin):\n class DecadeFilterBookAdminWithNoneReturningLookups(ModelAdmin):\n     list_filter = (DecadeListFilterWithNoneReturningLookups,)\n \n+class DecadeFilterBookAdminWithFailingQueryset(ModelAdmin):\n+    list_filter = (DecadeListFilterWithFailingQueryset,)\n+\n class DecadeFilterBookAdminWithQuerysetBasedLookups(ModelAdmin):\n     list_filter = (DecadeListFilterWithQuerysetBasedLookups,)\n \n@@ -509,6 +517,17 @@ def test_simplelistfilter_with_none_returning_lookups(self):\n         filterspec = changelist.get_filters(request)[0]\n         self.assertEqual(len(filterspec), 0)\n \n+    def test_filter_with_failing_queryset(self):\n+        \"\"\"\n+        Ensure that a filter's failing queryset is interpreted as if incorrect\n+        lookup parameters were passed (therefore causing a 302 redirection to\n+        the changelist).\n+        Refs #16716, #16714.\n+        \"\"\"\n+        modeladmin = DecadeFilterBookAdminWithFailingQueryset(Book, site)\n+        request = self.request_factory.get('/', {})\n+        self.assertRaises(IncorrectLookupParameters, self.get_changelist, request, Book, modeladmin)\n+\n     def test_simplelistfilter_with_queryset_based_lookups(self):\n         modeladmin = DecadeFilterBookAdminWithQuerysetBasedLookups(Book, site)\n         request = self.request_factory.get('/', {})"
        },
        {
            "sha": "22b65a6cb812c5a735043d5a0aa7ddde20e89eb3",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=93fbb77d9b5f4ab936c8f29b20a704d9b11be0c7",
            "patch": "@@ -410,6 +410,11 @@ def testIncorrectLookupParameters(self):\n         \"\"\"Ensure incorrect lookup parameters are handled gracefully.\"\"\"\n         response = self.client.get('/test_admin/%s/admin_views/thing/' % self.urlbit, {'notarealfield': '5'})\n         self.assertRedirects(response, '/test_admin/%s/admin_views/thing/?e=1' % self.urlbit)\n+\n+        # Spanning relationships through an inexistant related object (Refs #16716)\n+        response = self.client.get('/test_admin/%s/admin_views/thing/' % self.urlbit, {'notarealfield__whatever': '5'})\n+        self.assertRedirects(response, '/test_admin/%s/admin_views/thing/?e=1' % self.urlbit)\n+\n         response = self.client.get('/test_admin/%s/admin_views/thing/' % self.urlbit, {'color__id__exact': 'StringNotInteger!'})\n         self.assertRedirects(response, '/test_admin/%s/admin_views/thing/?e=1' % self.urlbit)\n "
        }
    ],
    "stats": {
        "total": 69,
        "additions": 48,
        "deletions": 21
    }
}