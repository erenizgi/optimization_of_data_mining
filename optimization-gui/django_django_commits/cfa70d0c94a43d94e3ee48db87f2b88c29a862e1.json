{
    "author": "ptone",
    "message": "Fixed #19546 - ensure that deprecation warnings are shown during tests\n\nrefs #18985",
    "sha": "cfa70d0c94a43d94e3ee48db87f2b88c29a862e1",
    "files": [
        {
            "sha": "8faf1e4f933dcab9908e2ac7574ccb506be4bc97",
            "filename": "django/test/simple.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/django%2Ftest%2Fsimple.py",
            "raw_url": "https://github.com/django/django/raw/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/django%2Ftest%2Fsimple.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsimple.py?ref=cfa70d0c94a43d94e3ee48db87f2b88c29a862e1",
            "patch": "@@ -1,3 +1,4 @@\n+import logging\n import unittest as real_unittest\n \n from django.conf import settings\n@@ -365,7 +366,19 @@ def run_tests(self, test_labels, extra_tests=None, **kwargs):\n         self.setup_test_environment()\n         suite = self.build_suite(test_labels, extra_tests)\n         old_config = self.setup_databases()\n+        if self.verbosity > 0:\n+            # ensure that deprecation warnings are displayed during testing\n+            # the following state is assumed:\n+            # logging.capturewarnings is true\n+            # a \"default\" level warnings filter has been added for\n+            # DeprecationWarning. See django.conf.LazySettings._configure_logging\n+            logger = logging.getLogger('py.warnings')\n+            handler = logging.StreamHandler()\n+            logger.addHandler(handler)\n         result = self.run_suite(suite)\n+        if self.verbosity > 0:\n+            # remove the testing-specific handler\n+            logger.removeHandler(handler)\n         self.teardown_databases(old_config)\n         self.teardown_test_environment()\n         return self.suite_result(suite, result)"
        },
        {
            "sha": "b3d9f3b352ff8d44d823e095bd2bb6d371172bb6",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=cfa70d0c94a43d94e3ee48db87f2b88c29a862e1",
            "patch": "@@ -93,24 +93,31 @@ class WarningLoggerTests(TestCase):\n     and captured to the logging system\n     \"\"\"\n     def setUp(self):\n+        # this convoluted setup is to avoid printing this deprecation to\n+        # stderr during test running - as the test runner forces deprecations\n+        # to be displayed at the global py.warnings level\n         self.logger = logging.getLogger('py.warnings')\n-        self.old_stream = self.logger.handlers[0].stream\n+        self.outputs = []\n+        self.old_streams = []\n+        for handler in self.logger.handlers:\n+            self.old_streams.append(handler.stream)\n+            self.outputs.append(StringIO())\n+            handler.stream = self.outputs[-1]\n \n     def tearDown(self):\n-        self.logger.handlers[0].stream = self.old_stream\n+        for i, handler in enumerate(self.logger.handlers):\n+            self.logger.handlers[i].stream = self.old_streams[i]\n \n     @override_settings(DEBUG=True)\n     def test_warnings_capture(self):\n-        output = StringIO()\n-        self.logger.handlers[0].stream = output\n         warnings.warn('Foo Deprecated', DeprecationWarning)\n-        self.assertTrue('Foo Deprecated' in force_text(output.getvalue()))\n+        output = force_text(self.outputs[0].getvalue())\n+        self.assertTrue('Foo Deprecated' in output)\n \n     def test_warnings_capture_debug_false(self):\n-        output = StringIO()\n-        self.logger.handlers[0].stream = output\n         warnings.warn('Foo Deprecated', DeprecationWarning)\n-        self.assertFalse('Foo Deprecated' in force_text(output.getvalue()))\n+        output = force_text(self.outputs[0].getvalue())\n+        self.assertFalse('Foo Deprecated' in output)\n \n \n class CallbackFilterTest(TestCase):"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/test_runner/deprecation_app/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2F__init__.py?ref=cfa70d0c94a43d94e3ee48db87f2b88c29a862e1"
        },
        {
            "sha": "71a836239075aa6e6e4ecb700e9c42c95c022d91",
            "filename": "tests/regressiontests/test_runner/deprecation_app/models.py",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2Fmodels.py?ref=cfa70d0c94a43d94e3ee48db87f2b88c29a862e1",
            "patch": "@@ -0,0 +1,3 @@\n+from django.db import models\n+\n+# Create your models here."
        },
        {
            "sha": "e676c3e3d5761d5a385e71a9bfa7a829d1e1cf5c",
            "filename": "tests/regressiontests/test_runner/deprecation_app/tests.py",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fdeprecation_app%2Ftests.py?ref=cfa70d0c94a43d94e3ee48db87f2b88c29a862e1",
            "patch": "@@ -0,0 +1,9 @@\n+import warnings\n+\n+from django.test import TestCase\n+\n+class DummyTest(TestCase):\n+    def test_warn(self):\n+        warnings.warn(\"warning from test\", DeprecationWarning)\n+\n+"
        },
        {
            "sha": "685e88d6ee8fb78d903a456453777087ffc88d98",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cfa70d0c94a43d94e3ee48db87f2b88c29a862e1/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=cfa70d0c94a43d94e3ee48db87f2b88c29a862e1",
            "patch": "@@ -279,6 +279,25 @@ def test_setup_databases(self):\n             db.connections = old_db_connections\n \n \n+class DeprecationDisplayTest(AdminScriptTestCase):\n+    # tests for 19546\n+    def setUp(self):\n+        settings = {'INSTALLED_APPS': '(\"regressiontests.test_runner.deprecation_app\",)' }\n+        self.write_settings('settings.py', sdict=settings)\n+\n+    def tearDown(self):\n+        self.remove_settings('settings.py')\n+\n+    def test_runner_deprecation_verbosity_default(self):\n+        args = ['test', '--settings=regressiontests.settings']\n+        out, err = self.run_django_admin(args)\n+        self.assertTrue(\"DeprecationWarning: warning from test\" in err)\n+\n+    def test_runner_deprecation_verbosity_zero(self):\n+        args = ['test', '--settings=regressiontests.settings', '--verbosity=0']\n+        out, err = self.run_django_admin(args)\n+        self.assertFalse(\"DeprecationWarning: warning from test\" in err)\n+\n class AutoIncrementResetTest(TransactionTestCase):\n     \"\"\"\n     Here we test creating the same model two times in different test methods,"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 59,
        "deletions": 8
    }
}