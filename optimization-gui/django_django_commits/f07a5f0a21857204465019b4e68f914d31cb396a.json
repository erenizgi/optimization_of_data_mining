{
    "author": "viciu",
    "message": "Fixed #11295: If ModelAdmin.queryset returns a filtered QS don't require a 2nd count call\n\nOriginal patch rewritten, added tests and get_filters_params method for ChangeList class.\nThanks Alex for the report.",
    "sha": "f07a5f0a21857204465019b4e68f914d31cb396a",
    "files": [
        {
            "sha": "8bda323d83d07de46f2d1b3fe8296887f1fc5ed0",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 18,
            "deletions": 11,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/f07a5f0a21857204465019b4e68f914d31cb396a/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/f07a5f0a21857204465019b4e68f914d31cb396a/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=f07a5f0a21857204465019b4e68f914d31cb396a",
            "patch": "@@ -79,15 +79,23 @@ def __init__(self, request, model, list_display, list_display_links,\n         self.title = title % force_text(self.opts.verbose_name)\n         self.pk_attname = self.lookup_opts.pk.attname\n \n-    def get_filters(self, request):\n-        lookup_params = self.params.copy() # a dictionary of the query string\n-        use_distinct = False\n-\n+    def get_filters_params(self, params=None):\n+        \"\"\"\n+        Returns all params except IGNORED_PARAMS\n+        \"\"\"\n+        if not params:\n+            params = self.params\n+        lookup_params = params.copy() # a dictionary of the query string\n         # Remove all the parameters that are globally and systematically\n         # ignored.\n         for ignored in IGNORED_PARAMS:\n             if ignored in lookup_params:\n                 del lookup_params[ignored]\n+        return lookup_params\n+\n+    def get_filters(self, request):\n+        lookup_params = self.get_filters_params()\n+        use_distinct = False\n \n         # Normalize the types of keys\n         for key, value in lookup_params.items():\n@@ -166,14 +174,13 @@ def get_results(self, request):\n         result_count = paginator.count\n \n         # Get the total number of objects, with no admin filters applied.\n-        # Perform a slight optimization: Check to see whether any filters were\n-        # given. If not, use paginator.hits to calculate the number of objects,\n-        # because we've already done paginator.hits and the value is cached.\n-        if not self.query_set.query.where:\n-            full_result_count = result_count\n-        else:\n+        # Perform a slight optimization:\n+        # full_result_count is equal to paginator.count if no filters\n+        # were applied\n+        if self.get_filters_params():\n             full_result_count = self.root_query_set.count()\n-\n+        else:\n+            full_result_count = result_count\n         can_show_all = result_count <= self.list_max_show_all\n         multi_page = result_count > self.list_per_page\n "
        },
        {
            "sha": "d3cfaa3e246a299bb8deb00580908a79ca2be9da",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/f07a5f0a21857204465019b4e68f914d31cb396a/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f07a5f0a21857204465019b4e68f914d31cb396a/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=f07a5f0a21857204465019b4e68f914d31cb396a",
            "patch": "@@ -2537,6 +2537,34 @@ def test_changelist_view(self):\n             else:\n                 self.assertNotContains(response, 'Primary key = %s' % i)\n \n+    def test_changelist_view_count_queries(self):\n+        #create 2 Person objects\n+        Person.objects.create(name='person1', gender=1)\n+        Person.objects.create(name='person2', gender=2)\n+\n+        # 4 queries are expected: 1 for the session, 1 for the user,\n+        # 1 for the count and 1 for the objects on the page\n+        with self.assertNumQueries(4):\n+            resp = self.client.get('/test_admin/admin/admin_views/person/')\n+            self.assertEqual(resp.context['selection_note'], '0 of 2 selected')\n+            self.assertEqual(resp.context['selection_note_all'], 'All 2 selected')\n+        with self.assertNumQueries(4):\n+            extra = {'q': 'not_in_name'}\n+            resp = self.client.get('/test_admin/admin/admin_views/person/', extra)\n+            self.assertEqual(resp.context['selection_note'], '0 of 0 selected')\n+            self.assertEqual(resp.context['selection_note_all'], 'All 0 selected')\n+        with self.assertNumQueries(4):\n+            extra = {'q': 'person'}\n+            resp = self.client.get('/test_admin/admin/admin_views/person/', extra)\n+            self.assertEqual(resp.context['selection_note'], '0 of 2 selected')\n+            self.assertEqual(resp.context['selection_note_all'], 'All 2 selected')\n+        # here one more count(*) query will run, because filters were applied\n+        with self.assertNumQueries(5):\n+            extra = {'gender__exact': '1'}\n+            resp = self.client.get('/test_admin/admin/admin_views/person/', extra)\n+            self.assertEqual(resp.context['selection_note'], '0 of 1 selected')\n+            self.assertEqual(resp.context['selection_note_all'], '1 selected')\n+\n     def test_change_view(self):\n         for i in self.pks:\n             response = self.client.get('/test_admin/admin/admin_views/emptymodel/%s/' % i)"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 46,
        "deletions": 11
    }
}