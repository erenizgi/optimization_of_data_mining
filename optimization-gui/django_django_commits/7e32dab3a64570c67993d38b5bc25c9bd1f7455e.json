{
    "author": "claudep",
    "message": "Fixed #17687 -- Made LayerMapping router-aware\n\nThanks nosamanuel@gmail.com for the report and the initial patch.",
    "sha": "7e32dab3a64570c67993d38b5bc25c9bd1f7455e",
    "files": [
        {
            "sha": "4912e645c244f96b210ce908ce866082ff1ebb66",
            "filename": "django/contrib/gis/tests/layermap/tests.py",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/7e32dab3a64570c67993d38b5bc25c9bd1f7455e/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7e32dab3a64570c67993d38b5bc25c9bd1f7455e/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py?ref=7e32dab3a64570c67993d38b5bc25c9bd1f7455e",
            "patch": "@@ -8,6 +8,7 @@\n from django.contrib.gis.tests.utils import mysql\n from django.contrib.gis.utils.layermapping import (LayerMapping, LayerMapError,\n     InvalidDecimal, MissingForeignKey)\n+from django.db import router\n from django.test import TestCase\n \n from .models import (\n@@ -26,6 +27,7 @@\n NUMS   = [1, 2, 1, 19, 1] # Number of polygons for each.\n STATES = ['Texas', 'Texas', 'Texas', 'Hawaii', 'Colorado']\n \n+\n class LayerMapTest(TestCase):\n \n     def test_init(self):\n@@ -281,3 +283,31 @@ def test_textfield(self):\n         lm.save(silent=True, strict=True)\n         self.assertEqual(City.objects.count(), 3)\n         self.assertEqual(City.objects.all().order_by('name_txt')[0].name_txt, \"Houston\")\n+\n+\n+class OtherRouter(object):\n+    def db_for_read(self, model, **hints):\n+        return 'other'\n+\n+    def db_for_write(self, model, **hints):\n+        return self.db_for_read(model, **hints)\n+\n+    def allow_relation(self, obj1, obj2, **hints):\n+        return None\n+\n+    def allow_syncdb(self, db, model):\n+        return True\n+\n+\n+class LayerMapRouterTest(TestCase):\n+\n+    def setUp(self):\n+        self.old_routers = router.routers\n+        router.routers = [OtherRouter()]\n+\n+    def tearDown(self):\n+        router.routers = self.old_routers\n+\n+    def test_layermapping_default_db(self):\n+        lm = LayerMapping(City, city_shp, city_mapping)\n+        self.assertEqual(lm.using, 'other')"
        },
        {
            "sha": "9511815426b289651cdbc97ada9f4c523f7ba5df",
            "filename": "django/contrib/gis/utils/layermapping.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/7e32dab3a64570c67993d38b5bc25c9bd1f7455e/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "raw_url": "https://github.com/django/django/raw/7e32dab3a64570c67993d38b5bc25c9bd1f7455e/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py?ref=7e32dab3a64570c67993d38b5bc25c9bd1f7455e",
            "patch": "@@ -9,7 +9,7 @@\n import sys\n from decimal import Decimal\n from django.core.exceptions import ObjectDoesNotExist\n-from django.db import connections, DEFAULT_DB_ALIAS\n+from django.db import connections, router\n from django.contrib.gis.db.models import GeometryField\n from django.contrib.gis.gdal import (CoordTransform, DataSource,\n     OGRException, OGRGeometry, OGRGeomType, SpatialReference)\n@@ -67,7 +67,7 @@ class LayerMapping(object):\n     def __init__(self, model, data, mapping, layer=0,\n                  source_srs=None, encoding=None,\n                  transaction_mode='commit_on_success',\n-                 transform=True, unique=None, using=DEFAULT_DB_ALIAS):\n+                 transform=True, unique=None, using=None):\n         \"\"\"\n         A LayerMapping object is initialized using the given Model (not an instance),\n         a DataSource (or string path to an OGR-supported data file), and a mapping\n@@ -81,8 +81,8 @@ def __init__(self, model, data, mapping, layer=0,\n             self.ds = data\n         self.layer = self.ds[layer]\n \n-        self.using = using\n-        self.spatial_backend = connections[using].ops\n+        self.using = using if using is not None else router.db_for_write(model)\n+        self.spatial_backend = connections[self.using].ops\n \n         # Setting the mapping & model attributes.\n         self.mapping = mapping"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 34,
        "deletions": 4
    }
}