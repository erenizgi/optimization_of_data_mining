{
    "author": "carljm",
    "message": "Avoid spurious failures in naturaltime tests.\n\nPrevious fix didn't cover timesince module, which naturaltime delegates to\nunder certain conditions. Extended mock of datetime to timesince module, and\nswitched to a fixed datetime rather than now() for testing, for more\nreproducible tests (failures in mock will fail fast, rather than sporadically).\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17038 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5a16b64ed29301fc7eb04405dac6ca4f58f550d2",
    "files": [
        {
            "sha": "c59885a0dcb0d32b4dba064d8c239e9d384b2ca4",
            "filename": "django/contrib/humanize/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/5a16b64ed29301fc7eb04405dac6ca4f58f550d2/django%2Fcontrib%2Fhumanize%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5a16b64ed29301fc7eb04405dac6ca4f58f550d2/django%2Fcontrib%2Fhumanize%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftests.py?ref=5a16b64ed29301fc7eb04405dac6ca4f58f550d2",
            "patch": "@@ -118,7 +118,8 @@ def test_naturalday_tz(self):\n         self.assertNotEqual(naturalday_one, naturalday_two)\n \n     def test_naturaltime(self):\n-        now = datetime.now()\n+        # we're going to mock datetime.datetime, so use a fixed datetime\n+        now = datetime(2011, 8, 15)\n         test_list = [\n             now,\n             now - timedelta(seconds=1),\n@@ -160,18 +161,21 @@ def test_naturaltime(self):\n \n         # mock out datetime so these tests don't fail occasionally when the\n         # test runs too slow\n-        class MockDateTime(object):\n+        class MockDateTime(datetime):\n+            @classmethod\n             def now(self):\n                 return now\n \n-            def __call__(self, *args, **kwargs):\n-                return datetime(*args, **kwargs)\n-\n+        # naturaltime also calls timesince/timeuntil\n         from django.contrib.humanize.templatetags import humanize\n-        orig_datetime = humanize.datetime\n-        humanize.datetime = MockDateTime()\n+        from django.utils import timesince\n+        orig_humanize_datetime = humanize.datetime\n+        orig_timesince_datetime = timesince.datetime.datetime\n+        humanize.datetime = MockDateTime\n+        timesince.datetime.datetime = MockDateTime\n \n         try:\n             self.humanize_tester(test_list, result_list, 'naturaltime')\n         finally:\n-            humanize.datetime = orig_datetime\n+            humanize.datetime = orig_humanize_datetime\n+            timesince.datetime.datetime = orig_timesince_datetime"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 12,
        "deletions": 8
    }
}