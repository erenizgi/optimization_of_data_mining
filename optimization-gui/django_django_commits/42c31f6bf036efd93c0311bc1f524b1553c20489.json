{
    "author": "spookylukey",
    "message": "Rationalised CompatCookie/SimpleCookie into single SimpleCookie class with all fixes.\n\nSince upstream Python has fixed the encoding bug (see\nhttp://bugs.python.org/issue9824), we don't want a separate class for this\nbug fix, or several layers for the different fixes.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15298 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "42c31f6bf036efd93c0311bc1f524b1553c20489",
    "files": [
        {
            "sha": "b4ab98d725bb2e80ab517effeb8fa4ea08e3fe31",
            "filename": "django/contrib/messages/storage/cookie.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/42c31f6bf036efd93c0311bc1f524b1553c20489/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py",
            "raw_url": "https://github.com/django/django/raw/42c31f6bf036efd93c0311bc1f524b1553c20489/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py?ref=42c31f6bf036efd93c0311bc1f524b1553c20489",
            "patch": "@@ -1,7 +1,7 @@\n from django.conf import settings\n from django.contrib.messages import constants\n from django.contrib.messages.storage.base import BaseStorage, Message\n-from django.http import CompatCookie\n+from django.http import SimpleCookie\n from django.utils import simplejson as json\n from django.utils.crypto import salted_hmac, constant_time_compare\n \n@@ -88,9 +88,9 @@ def _store(self, messages, response, remove_oldest=True, *args, **kwargs):\n         unstored_messages = []\n         encoded_data = self._encode(messages)\n         if self.max_cookie_size:\n-            # data is going to be stored eventually by CompatCookie, which\n+            # data is going to be stored eventually by SimpleCookie, which\n             # adds it's own overhead, which we must account for.\n-            cookie = CompatCookie() # create outside the loop\n+            cookie = SimpleCookie() # create outside the loop\n             def stored_length(val):\n                 return len(cookie.value_encode(val)[1])\n "
        },
        {
            "sha": "64b03deb3df7051e7f8afa61e5f526739b2972db",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 65,
            "deletions": 55,
            "changes": 120,
            "blob_url": "https://github.com/django/django/blob/42c31f6bf036efd93c0311bc1f524b1553c20489/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/42c31f6bf036efd93c0311bc1f524b1553c20489/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=42c31f6bf036efd93c0311bc1f524b1553c20489",
            "patch": "@@ -21,38 +21,76 @@\n         # PendingDeprecationWarning\n         from cgi import parse_qsl\n \n+import Cookie\n # httponly support exists in Python 2.6's Cookie library,\n # but not in Python 2.4 or 2.5.\n-import Cookie\n-if Cookie.Morsel._reserved.has_key('httponly'):\n+_morsel_supports_httponly = Cookie.Morsel._reserved.has_key('httponly')\n+# Some versions of Python 2.7 and later won't need this encoding bug fix:\n+_cookie_encodes_correctly = Cookie.SimpleCookie().value_encode(';') == (';', '\"\\\\073\"')\n+\n+if _morsel_supports_httponly and _cookie_encodes_correctly:\n     SimpleCookie = Cookie.SimpleCookie\n else:\n-    class Morsel(Cookie.Morsel):\n-        def __setitem__(self, K, V):\n-            K = K.lower()\n-            if K == \"httponly\":\n-                if V:\n-                    # The superclass rejects httponly as a key,\n-                    # so we jump to the grandparent.\n-                    super(Cookie.Morsel, self).__setitem__(K, V)\n-            else:\n-                super(Morsel, self).__setitem__(K, V)\n-\n-        def OutputString(self, attrs=None):\n-            output = super(Morsel, self).OutputString(attrs)\n-            if \"httponly\" in self:\n-                output += \"; httponly\"\n-            return output\n+    if not _morsel_supports_httponly:\n+        class Morsel(Cookie.Morsel):\n+            def __setitem__(self, K, V):\n+                K = K.lower()\n+                if K == \"httponly\":\n+                    if V:\n+                        # The superclass rejects httponly as a key,\n+                        # so we jump to the grandparent.\n+                        super(Cookie.Morsel, self).__setitem__(K, V)\n+                else:\n+                    super(Morsel, self).__setitem__(K, V)\n+\n+            def OutputString(self, attrs=None):\n+                output = super(Morsel, self).OutputString(attrs)\n+                if \"httponly\" in self:\n+                    output += \"; httponly\"\n+                return output\n \n     class SimpleCookie(Cookie.SimpleCookie):\n-        def __set(self, key, real_value, coded_value):\n-            M = self.get(key, Morsel())\n-            M.set(key, real_value, coded_value)\n-            dict.__setitem__(self, key, M)\n+        if not _morsel_supports_httponly:\n+            def __set(self, key, real_value, coded_value):\n+                M = self.get(key, Morsel())\n+                M.set(key, real_value, coded_value)\n+                dict.__setitem__(self, key, M)\n+\n+            def __setitem__(self, key, value):\n+                rval, cval = self.value_encode(value)\n+                self.__set(key, rval, cval)\n+\n+        if not _cookie_encodes_correctly:\n+            def value_encode(self, val):\n+                # Some browsers do not support quoted-string from RFC 2109,\n+                # including some versions of Safari and Internet Explorer.\n+                # These browsers split on ';', and some versions of Safari\n+                # are known to split on ', '. Therefore, we encode ';' and ','\n+\n+                # SimpleCookie already does the hard work of encoding and decoding.\n+                # It uses octal sequences like '\\\\012' for newline etc.\n+                # and non-ASCII chars.  We just make use of this mechanism, to\n+                # avoid introducing two encoding schemes which would be confusing\n+                # and especially awkward for javascript.\n+\n+                # NB, contrary to Python docs, value_encode returns a tuple containing\n+                # (real val, encoded_val)\n+                val, encoded = super(SimpleCookie, self).value_encode(val)\n+\n+                encoded = encoded.replace(\";\", \"\\\\073\").replace(\",\",\"\\\\054\")\n+                # If encoded now contains any quoted chars, we need double quotes\n+                # around the whole string.\n+                if \"\\\\\" in encoded and not encoded.startswith('\"'):\n+                    encoded = '\"' + encoded + '\"'\n+\n+                return val, encoded\n \n-        def __setitem__(self, key, value):\n-            rval, cval = self.value_encode(value)\n-            self.__set(key, rval, cval)\n+class CompatCookie(SimpleCookie):\n+    def __init__(self, *args, **kwargs):\n+        super(CompatCookie, self).__init__(*args, **kwargs)\n+        import warnings\n+        warnings.warn(\"CompatCookie is deprecated, use django.http.SimpleCookie instead.\",\n+                      PendingDeprecationWarning)\n \n from django.utils.datastructures import MultiValueDict, ImmutableList\n from django.utils.encoding import smart_str, iri_to_uri, force_unicode\n@@ -389,40 +427,12 @@ def urlencode(self, safe=None):\n                            for v in list_])\n         return '&'.join(output)\n \n-class CompatCookie(SimpleCookie):\n-    \"\"\"\n-    Cookie class that handles some issues with browser compatibility.\n-    \"\"\"\n-    def value_encode(self, val):\n-        # Some browsers do not support quoted-string from RFC 2109,\n-        # including some versions of Safari and Internet Explorer.\n-        # These browsers split on ';', and some versions of Safari\n-        # are known to split on ', '. Therefore, we encode ';' and ','\n-\n-        # SimpleCookie already does the hard work of encoding and decoding.\n-        # It uses octal sequences like '\\\\012' for newline etc.\n-        # and non-ASCII chars.  We just make use of this mechanism, to\n-        # avoid introducing two encoding schemes which would be confusing\n-        # and especially awkward for javascript.\n-\n-        # NB, contrary to Python docs, value_encode returns a tuple containing\n-        # (real val, encoded_val)\n-        val, encoded = super(CompatCookie, self).value_encode(val)\n-\n-        encoded = encoded.replace(\";\", \"\\\\073\").replace(\",\",\"\\\\054\")\n-        # If encoded now contains any quoted chars, we need double quotes\n-        # around the whole string.\n-        if \"\\\\\" in encoded and not encoded.startswith('\"'):\n-            encoded = '\"' + encoded + '\"'\n-\n-        return val, encoded\n-\n def parse_cookie(cookie):\n     if cookie == '':\n         return {}\n     if not isinstance(cookie, Cookie.BaseCookie):\n         try:\n-            c = CompatCookie()\n+            c = SimpleCookie()\n             c.load(cookie)\n         except Cookie.CookieError:\n             # Invalid cookie\n@@ -460,7 +470,7 @@ def __init__(self, content='', mimetype=None, status=None,\n         else:\n             self._container = [content]\n             self._is_string = True\n-        self.cookies = CompatCookie()\n+        self.cookies = SimpleCookie()\n         if status:\n             self.status_code = status\n "
        },
        {
            "sha": "9bb0289c683f736daf8d3b5bbf74bc2522708953",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/42c31f6bf036efd93c0311bc1f524b1553c20489/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/42c31f6bf036efd93c0311bc1f524b1553c20489/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=42c31f6bf036efd93c0311bc1f524b1553c20489",
            "patch": "@@ -155,6 +155,9 @@ their deprecation, as per the :ref:`Django deprecation policy\n           a :class:`~django.contrib.gis.geos.GEOSException` when called \n           on a geometry with no SRID value.\n \n+        * :class:`~django.http.CompatCookie` will be removed in favour of\n+          :class:`~django.http.SimpleCookie`.\n+\n     * 2.0\n         * ``django.views.defaults.shortcut()``. This function has been moved\n           to ``django.contrib.contenttypes.views.shortcut()`` as part of the"
        },
        {
            "sha": "89e8b5858560cd002f424022607ef0a3dfdba248",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/42c31f6bf036efd93c0311bc1f524b1553c20489/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/42c31f6bf036efd93c0311bc1f524b1553c20489/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=42c31f6bf036efd93c0311bc1f524b1553c20489",
            "patch": "@@ -609,3 +609,11 @@ Previously this field's ``clean()`` method accepted a second, gender, argument\n which allowed stronger validation checks to be made, however since this\n argument could never actually be passed from the Django form machinery it is\n now pending deprecation.\n+\n+``CompatCookie``\n+~~~~~~~~~~~~~~~~\n+\n+Previously, ``django.http`` exposed an undocumented ``CompatCookie`` class,\n+which was a bug-fix wrapper around the standard library ``SimpleCookie``. As the\n+fixes are moving upstream, this is now deprecated - you should use ``from\n+django.http import SimpleCookie`` instead."
        },
        {
            "sha": "69b052f5cdfb24b4d001377746b0c0f72c86f125",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/42c31f6bf036efd93c0311bc1f524b1553c20489/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/42c31f6bf036efd93c0311bc1f524b1553c20489/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=42c31f6bf036efd93c0311bc1f524b1553c20489",
            "patch": "@@ -1,7 +1,7 @@\n import copy\n import pickle\n \n-from django.http import QueryDict, HttpResponse, CompatCookie, BadHeaderError\n+from django.http import QueryDict, HttpResponse, SimpleCookie, BadHeaderError\n from django.utils import unittest\n \n class QueryDictTests(unittest.TestCase):\n@@ -250,7 +250,7 @@ def test_encode(self):\n         # Python 2.4 compatibility note: Python 2.4's cookie implementation\n         # always returns Set-Cookie headers terminating in semi-colons.\n         # That's not the bug this test is looking for, so ignore it.\n-        c = CompatCookie()\n+        c = SimpleCookie()\n         c['test'] = \"An,awkward;value\"\n         self.assert_(\";\" not in c.output().rstrip(';')) # IE compat\n         self.assert_(\",\" not in c.output().rstrip(';')) # Safari compat\n@@ -259,18 +259,18 @@ def test_decode(self):\n         \"\"\"\n         Test that we can still preserve semi-colons and commas\n         \"\"\"\n-        c = CompatCookie()\n+        c = SimpleCookie()\n         c['test'] = \"An,awkward;value\"\n-        c2 = CompatCookie()\n+        c2 = SimpleCookie()\n         c2.load(c.output())\n         self.assertEqual(c['test'].value, c2['test'].value)\n \n     def test_decode_2(self):\n         \"\"\"\n         Test that we haven't broken normal encoding\n         \"\"\"\n-        c = CompatCookie()\n+        c = SimpleCookie()\n         c['test'] = \"\\xf0\"\n-        c2 = CompatCookie()\n+        c2 = SimpleCookie()\n         c2.load(c.output())\n         self.assertEqual(c['test'].value, c2['test'].value)"
        }
    ],
    "stats": {
        "total": 149,
        "additions": 85,
        "deletions": 64
    }
}