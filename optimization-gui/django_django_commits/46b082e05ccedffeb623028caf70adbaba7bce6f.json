{
    "author": "aaugustin",
    "message": "Fixed #17742 -- Handled aware datetimes in DateField\n\nConverted aware datetimes to the default time zone before using them\nin the context of a DateField.",
    "sha": "46b082e05ccedffeb623028caf70adbaba7bce6f",
    "files": [
        {
            "sha": "79fb373ce1eaf9ec1fd264e98a47cb6a149bf5f4",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/46b082e05ccedffeb623028caf70adbaba7bce6f/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/46b082e05ccedffeb623028caf70adbaba7bce6f/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=46b082e05ccedffeb623028caf70adbaba7bce6f",
            "patch": "@@ -667,6 +667,11 @@ def to_python(self, value):\n         if value is None:\n             return value\n         if isinstance(value, datetime.datetime):\n+            if settings.USE_TZ and timezone.is_aware(value):\n+                # Convert aware datetimes to the current time zone\n+                # before casting them to dates (#17742).\n+                default_timezone = timezone.get_default_timezone()\n+                value = timezone.make_naive(value, default_timezone)\n             return value.date()\n         if isinstance(value, datetime.date):\n             return value"
        },
        {
            "sha": "c49e42f887a5786487a4e9bc36e8697f3100ee67",
            "filename": "tests/modeltests/timezones/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/46b082e05ccedffeb623028caf70adbaba7bce6f/tests%2Fmodeltests%2Ftimezones%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/46b082e05ccedffeb623028caf70adbaba7bce6f/tests%2Fmodeltests%2Ftimezones%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Fmodels.py?ref=46b082e05ccedffeb623028caf70adbaba7bce6f",
            "patch": "@@ -16,3 +16,6 @@ class SessionEvent(models.Model):\n class Timestamp(models.Model):\n     created = models.DateTimeField(auto_now_add=True)\n     updated = models.DateTimeField(auto_now=True)\n+\n+class AllDayEvent(models.Model):\n+    day = models.DateField()"
        },
        {
            "sha": "ddfbc045d9264cb858e64c2556ffd373ceb986c6",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/46b082e05ccedffeb623028caf70adbaba7bce6f/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/46b082e05ccedffeb623028caf70adbaba7bce6f/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=46b082e05ccedffeb623028caf70adbaba7bce6f",
            "patch": "@@ -23,7 +23,7 @@\n from django.utils.unittest import skipIf, skipUnless\n \n from .forms import EventForm, EventSplitForm, EventModelForm\n-from .models import Event, MaybeEvent, Session, SessionEvent, Timestamp\n+from .models import Event, MaybeEvent, Session, SessionEvent, Timestamp, AllDayEvent\n \n \n # These tests use the EAT (Eastern Africa Time) and ICT (Indochina Time)\n@@ -244,6 +244,14 @@ def test_raw_sql(self):\n                 [event],\n                 transform=lambda d: d)\n \n+    def test_filter_date_field_with_aware_datetime(self):\n+        # Regression test for #17742\n+        day = datetime.date(2011, 9, 1)\n+        event = AllDayEvent.objects.create(day=day)\n+        # This is 2011-09-02T01:30:00+03:00 in EAT\n+        dt = datetime.datetime(2011, 9, 1, 22, 30, 0, tzinfo=UTC)\n+        self.assertTrue(AllDayEvent.objects.filter(day__gte=dt).exists())\n+\n \n @override_settings(TIME_ZONE='Africa/Nairobi', USE_TZ=True)\n class NewDatabaseTests(TestCase):\n@@ -456,8 +464,16 @@ def test_raw_sql(self):\n                 [event],\n                 transform=lambda d: d)\n \n+    def test_filter_date_field_with_aware_datetime(self):\n+        # Regression test for #17742\n+        day = datetime.date(2011, 9, 1)\n+        event = AllDayEvent.objects.create(day=day)\n+        # This is 2011-09-02T01:30:00+03:00 in EAT\n+        dt = datetime.datetime(2011, 9, 1, 22, 30, 0, tzinfo=UTC)\n+        self.assertFalse(AllDayEvent.objects.filter(day__gte=dt).exists())\n+\n     def test_null_datetime(self):\n-        # Regression for #17294\n+        # Regression test for #17294\n         e = MaybeEvent.objects.create()\n         self.assertEqual(e.dt, None)\n "
        }
    ],
    "stats": {
        "total": 28,
        "additions": 26,
        "deletions": 2
    }
}