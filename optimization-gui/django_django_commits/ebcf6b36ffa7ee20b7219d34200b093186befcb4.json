{
    "author": "akaariai",
    "message": "Fixed select_related performance regressions\n\nThe regression was caused by select_related fix for Oracle, commit\nc159d9cec0baab7bbd04d5d51a92a51e354a722a.",
    "sha": "ebcf6b36ffa7ee20b7219d34200b093186befcb4",
    "files": [
        {
            "sha": "7ea6e4b744f92187a25cf921411a3936b4671e08",
            "filename": "django/db/models/options.py",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/ebcf6b36ffa7ee20b7219d34200b093186befcb4/django%2Fdb%2Fmodels%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/ebcf6b36ffa7ee20b7219d34200b093186befcb4/django%2Fdb%2Fmodels%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Foptions.py?ref=ebcf6b36ffa7ee20b7219d34200b093186befcb4",
            "patch": "@@ -9,11 +9,10 @@\n from django.db.models.fields import AutoField, FieldDoesNotExist\n from django.db.models.fields.proxy import OrderWrt\n from django.db.models.loading import get_models, app_cache_ready\n-from django.utils.translation import activate, deactivate_all, get_language, string_concat\n-from django.utils.encoding import force_text, smart_text\n-from django.utils.datastructures import SortedDict\n from django.utils import six\n-from django.utils.encoding import python_2_unicode_compatible\n+from django.utils.datastructures import SortedDict\n+from django.utils.encoding import force_text, smart_text, python_2_unicode_compatible\n+from django.utils.translation import activate, deactivate_all, get_language, string_concat\n \n # Calculate the verbose_name by converting from InitialCaps to \"lowercase with spaces\".\n get_verbose_name = lambda class_name: re.sub('(((?<=[a-z])[A-Z])|([A-Z](?![A-Z]|$)))', ' \\\\1', class_name).lower().strip()\n@@ -175,6 +174,10 @@ def setup_pk(self, field):\n             self.pk = field\n             field.serialize = False\n \n+    def pk_index(self):\n+        return [pos for pos, field in enumerate(self.fields)\n+                if field == self.pk][0]\n+\n     def setup_proxy(self, target):\n         \"\"\"\n         Does the internal setup so that the current model is a proxy for"
        },
        {
            "sha": "67fef52f36c2853a1d66b85fdec7296ca238ae40",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 11,
            "deletions": 16,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/ebcf6b36ffa7ee20b7219d34200b093186befcb4/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/ebcf6b36ffa7ee20b7219d34200b093186befcb4/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=ebcf6b36ffa7ee20b7219d34200b093186befcb4",
            "patch": "@@ -1395,8 +1395,12 @@ def get_klass_info(klass, max_depth=0, cur_depth=0, requested=None,\n                 klass_info = get_klass_info(o.model, max_depth=max_depth, cur_depth=cur_depth+1,\n                                             requested=next, only_load=only_load, local_only=True)\n                 reverse_related_fields.append((o.field, klass_info))\n+    if field_names:\n+        pk_idx = field_names.index(klass._meta.pk.attname)\n+    else:\n+        pk_idx = klass._meta.pk_index()\n \n-    return klass, field_names, field_count, related_fields, reverse_related_fields\n+    return klass, field_names, field_count, related_fields, reverse_related_fields, pk_idx\n \n \n def get_cached_row(row, index_start, using,  klass_info, offset=0):\n@@ -1419,26 +1423,17 @@ def get_cached_row(row, index_start, using,  klass_info, offset=0):\n     \"\"\"\n     if klass_info is None:\n         return None\n-    klass, field_names, field_count, related_fields, reverse_related_fields = klass_info\n+    klass, field_names, field_count, related_fields, reverse_related_fields, pk_idx = klass_info\n \n     fields = row[index_start : index_start + field_count]\n-    # If all the select_related columns are None, then the related\n+    # If the pk column is None (or the Oracle equivalent ''), then the related\n     # object must be non-existent - set the relation to None.\n-    # Otherwise, construct the related object. Also, some backends treat ''\n-    # and None equivalently for char fields, so we have to be prepared for\n-    # '' values.\n-    if connections[using].features.interprets_empty_strings_as_nulls:\n-        vals = tuple([None if f == '' else f for f in fields])\n-    else:\n-        vals = fields\n-\n-    if vals == (None,) * field_count:\n+    if fields[pk_idx] == None or fields[pk_idx] == '':\n         obj = None\n+    elif field_names:\n+        obj = klass(**dict(zip(field_names, fields)))\n     else:\n-        if field_names:\n-            obj = klass(**dict(zip(field_names, fields)))\n-        else:\n-            obj = klass(*fields)\n+        obj = klass(*fields)\n \n     # If an object was retrieved, set the database state.\n     if obj:"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 18,
        "deletions": 20
    }
}