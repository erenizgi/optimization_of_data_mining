{
    "author": "aaugustin",
    "message": "Fixed #17415 -- Reset database sequence for Site's pk after creating the default site with an explicit pk. Thanks niko AT neagee net for the report, Russell and Karen for describing the fix, and Anssi for drafting the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17343 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3",
    "files": [
        {
            "sha": "1b76bf54117cba61ee15825dc20f2bf4af6b313c",
            "filename": "django/contrib/sites/management.py",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3/django%2Fcontrib%2Fsites%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3/django%2Fcontrib%2Fsites%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsites%2Fmanagement.py?ref=4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3",
            "patch": "@@ -3,22 +3,34 @@\n \"\"\"\n \n from django.db.models import signals\n+from django.db import connections\n from django.db import router\n from django.contrib.sites.models import Site\n from django.contrib.sites import models as site_app\n+from django.core.management.color import no_style\n \n def create_default_site(app, created_models, verbosity, db, **kwargs):\n     # Only create the default sites in databases where Django created the table\n     if Site in created_models and router.allow_syncdb(db, Site) :\n-        if verbosity >= 2:\n-            print \"Creating example.com Site object\"\n         # The default settings set SITE_ID = 1, and some tests in Django's test\n         # suite rely on this value. However, if database sequences are reused\n         # (e.g. in the test suite after flush/syncdb), it isn't guaranteed that\n         # the next id will be 1, so we coerce it. See #15573 and #16353. This\n         # can also crop up outside of tests - see #15346.\n-        s = Site(pk=1, domain=\"example.com\", name=\"example.com\")\n-        s.save(using=db)\n+        if verbosity >= 2:\n+            print \"Creating example.com Site object\"\n+        Site(pk=1, domain=\"example.com\", name=\"example.com\").save(using=db)\n+\n+        # We set an explicit pk instead of relying on auto-incrementation,\n+        # so we need to reset the database sequence. See #17415.\n+        sequence_sql = connections[db].ops.sequence_reset_sql(no_style(), [Site])\n+        if sequence_sql:\n+            if verbosity >= 2:\n+                print \"Resetting sequence\"\n+            cursor = connections[db].cursor()\n+            for command in sequence_sql:\n+                cursor.execute(command)\n+\n     Site.objects.clear_cache()\n \n signals.post_syncdb.connect(create_default_site, sender=site_app)"
        },
        {
            "sha": "828badb386749edf4335b11c0cc23e57b3017901",
            "filename": "django/contrib/sites/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3/django%2Fcontrib%2Fsites%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3/django%2Fcontrib%2Fsites%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsites%2Ftests.py?ref=4629668ffacddb0b8ddb5d8cc7fb8d01f039a4e3",
            "patch": "@@ -15,6 +15,12 @@ def setUp(self):\n     def tearDown(self):\n         Site._meta.installed = self.old_Site_meta_installed\n \n+    def test_save_another(self):\n+        # Regression for #17415\n+        # On some backends the sequence needs reset after save with explicit ID.\n+        # Test that there is no sequence collisions by saving another site.\n+        Site(domain=\"example2.com\", name=\"example2.com\").save()\n+\n     def test_site_manager(self):\n         # Make sure that get_current() does not return a deleted Site object.\n         s = Site.objects.get_current()"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 22,
        "deletions": 4
    }
}