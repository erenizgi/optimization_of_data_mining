{
    "author": "claudep",
    "message": "[py3] Added buffer/memoryview compatibility\n\nEven if buffer and memoryview are not strictly identical, it should\nbe safe to consider them equivalent for GIS support.\nThanks Aymeric Augustin for the review.",
    "sha": "8cdc84726e13da4c796db614765658835d4786a1",
    "files": [
        {
            "sha": "c996fdfdc21bd717519ff78a92283a1d97d051d9",
            "filename": "django/contrib/gis/__init__.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2F__init__.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -0,0 +1,6 @@\n+from django.utils import six\n+\n+if six.PY3:\n+    memoryview = memoryview\n+else:\n+    memoryview = buffer"
        },
        {
            "sha": "1fdc5036bac404bc6ea666d07229db291add9058",
            "filename": "django/contrib/gis/db/models/proxy.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fproxy.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fproxy.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fproxy.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -5,6 +5,7 @@\n \n Thanks to Robert Coup for providing this functionality (see #4322).\n \"\"\"\n+from django.contrib.gis import memoryview\n from django.utils import six\n \n class GeometryProxy(object):\n@@ -54,7 +55,7 @@ def __set__(self, obj, value):\n         if isinstance(value, self._klass) and (str(value.geom_type).upper() == gtype or gtype == 'GEOMETRY'):\n             # Assigning the SRID to the geometry.\n             if value.srid is None: value.srid = self._field.srid\n-        elif value is None or isinstance(value, six.string_types + (buffer,)):\n+        elif value is None or isinstance(value, six.string_types + (memoryview,)):\n             # Set with None, WKT, HEX, or WKB\n             pass\n         else:"
        },
        {
            "sha": "b994252002240b00ecdea8bb90ac14d9eec6bb52",
            "filename": "django/contrib/gis/db/models/query.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fquery.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -1,6 +1,7 @@\n from django.db import connections\n from django.db.models.query import QuerySet, ValuesQuerySet, ValuesListQuerySet\n \n+from django.contrib.gis import memoryview\n from django.contrib.gis.db.models import aggregates\n from django.contrib.gis.db.models.fields import get_srid_info, PointField, LineStringField\n from django.contrib.gis.db.models.sql import AreaField, DistanceField, GeomField, GeoQuery\n@@ -676,7 +677,7 @@ def _distance_attribute(self, func, geom=None, tolerance=0.05, spheroid=False, *\n                     if not backend.geography:\n                         if not isinstance(geo_field, PointField):\n                             raise ValueError('Spherical distance calculation only supported on PointFields.')\n-                        if not str(Geometry(buffer(params[0].ewkb)).geom_type) == 'Point':\n+                        if not str(Geometry(memoryview(params[0].ewkb)).geom_type) == 'Point':\n                             raise ValueError('Spherical distance calculation only supported with Point Geometry parameters')\n                     # The `function` procedure argument needs to be set differently for\n                     # geodetic distance calculations."
        },
        {
            "sha": "1985062c568c4f53bf48f2a833fccdcc9d239d52",
            "filename": "django/contrib/gis/gdal/geometries.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgdal%2Fgeometries.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgdal%2Fgeometries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fgeometries.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -43,6 +43,8 @@\n from binascii import a2b_hex, b2a_hex\n from ctypes import byref, string_at, c_char_p, c_double, c_ubyte, c_void_p\n \n+from django.contrib.gis import memoryview\n+\n # Getting GDAL prerequisites\n from django.contrib.gis.gdal.base import GDALBase\n from django.contrib.gis.gdal.envelope import Envelope, OGREnvelope\n@@ -76,7 +78,7 @@ def __init__(self, geom_input, srs=None):\n \n         # If HEX, unpack input to to a binary buffer.\n         if str_instance and hex_regex.match(geom_input):\n-            geom_input = buffer(a2b_hex(geom_input.upper()))\n+            geom_input = memoryview(a2b_hex(geom_input.upper()))\n             str_instance = False\n \n         # Constructing the geometry,\n@@ -106,7 +108,7 @@ def __init__(self, geom_input, srs=None):\n                 # (e.g., 'Point', 'POLYGON').\n                 ogr_t = OGRGeomType(geom_input)\n                 g = capi.create_geom(OGRGeomType(geom_input).num)\n-        elif isinstance(geom_input, buffer):\n+        elif isinstance(geom_input, memoryview):\n             # WKB was passed in\n             g = capi.from_wkb(str(geom_input), None, byref(c_void_p()), len(geom_input))\n         elif isinstance(geom_input, OGRGeomType):\n@@ -354,7 +356,7 @@ def wkb(self):\n         buf = (c_ubyte * sz)()\n         wkb = capi.to_wkb(self.ptr, byteorder, byref(buf))\n         # Returning a buffer of the string at the pointer.\n-        return buffer(string_at(buf, sz))\n+        return memoryview(string_at(buf, sz))\n \n     @property\n     def wkt(self):"
        },
        {
            "sha": "42b0310f0a7bab1bea8d88c643a08b526429c678",
            "filename": "django/contrib/gis/geos/factory.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Ffactory.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Ffactory.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ffactory.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -1,3 +1,4 @@\n+from django.contrib.gis import memoryview\n from django.contrib.gis.geos.geometry import GEOSGeometry, wkt_regex, hex_regex\n \n from django.utils import six\n@@ -18,7 +19,7 @@ def fromfile(file_h):\n     if wkt_regex.match(buf) or hex_regex.match(buf):\n         return GEOSGeometry(buf)\n     else:\n-        return GEOSGeometry(buffer(buf))\n+        return GEOSGeometry(memoryview(buf))\n \n def fromstr(string, **kwargs):\n     \"Given a string value, returns a GEOSGeometry object.\""
        },
        {
            "sha": "41bf4dfa1f3f86534c232982c9c72fb74f39f682",
            "filename": "django/contrib/gis/geos/geometry.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -5,6 +5,7 @@\n # Python, ctypes and types dependencies.\n from ctypes import addressof, byref, c_double\n \n+from django.contrib.gis import memoryview\n # super-class for mutable list behavior\n from django.contrib.gis.geos.mutable_list import ListMixin\n \n@@ -75,7 +76,7 @@ def __init__(self, geo_input, srid=None):\n         elif isinstance(geo_input, GEOM_PTR):\n             # When the input is a pointer to a geomtry (GEOM_PTR).\n             g = geo_input\n-        elif isinstance(geo_input, buffer):\n+        elif isinstance(geo_input, memoryview):\n             # When the input is a buffer (WKB).\n             g = wkb_r().read(geo_input)\n         elif isinstance(geo_input, GEOSGeometry):\n@@ -139,12 +140,12 @@ def __repr__(self):\n     def __getstate__(self):\n         # The pickled state is simply a tuple of the WKB (in string form)\n         # and the SRID.\n-        return str(self.wkb), self.srid\n+        return bytes(self.wkb), self.srid\n \n     def __setstate__(self, state):\n         # Instantiating from the tuple state that was pickled.\n         wkb, srid = state\n-        ptr = wkb_r().read(buffer(wkb))\n+        ptr = wkb_r().read(memoryview(wkb))\n         if not ptr: raise GEOSException('Invalid Geometry loaded from pickled state.')\n         self.ptr = ptr\n         self._post_init(srid)"
        },
        {
            "sha": "4a774f9589755f64d95e65c67ebe5198e60c6b9c",
            "filename": "django/contrib/gis/geos/prototypes/io.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -1,5 +1,6 @@\n import threading\n from ctypes import byref, c_char_p, c_int, c_char, c_size_t, Structure, POINTER\n+from django.contrib.gis import memoryview\n from django.contrib.gis.geos.base import GEOSBase\n from django.contrib.gis.geos.libgeos import GEOM_PTR\n from django.contrib.gis.geos.prototypes.errcheck import check_geom, check_string, check_sized_string\n@@ -130,8 +131,8 @@ class _WKBReader(IOBase):\n \n     def read(self, wkb):\n         \"Returns a _pointer_ to C GEOS Geometry object from the given WKB.\"\n-        if isinstance(wkb, buffer):\n-            wkb_s = str(wkb)\n+        if isinstance(wkb, memoryview):\n+            wkb_s = bytes(wkb)\n             return wkb_reader_read(self.ptr, wkb_s, len(wkb_s))\n         elif isinstance(wkb, six.string_types):\n             return wkb_reader_read_hex(self.ptr, wkb, len(wkb))\n@@ -155,7 +156,7 @@ class WKBWriter(IOBase):\n \n     def write(self, geom):\n         \"Returns the WKB representation of the given geometry.\"\n-        return buffer(wkb_writer_write(self.ptr, geom.ptr, byref(c_size_t())))\n+        return memoryview(wkb_writer_write(self.ptr, geom.ptr, byref(c_size_t())))\n \n     def write_hex(self, geom):\n         \"Returns the HEXEWKB representation of the given geometry.\""
        },
        {
            "sha": "2e873b4cd959230448b0319c21723fae4323abfc",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -2,6 +2,7 @@\n import json\n import random\n \n+from django.contrib.gis import memoryview\n from django.contrib.gis.geos import (GEOSException, GEOSIndexError, GEOSGeometry,\n     GeometryCollection, Point, MultiPoint, Polygon, MultiPolygon, LinearRing,\n     LineString, MultiLineString, fromfile, fromstr, geos_version_info)\n@@ -118,9 +119,9 @@ def test_hexewkb(self):\n                 self.fail('Should have raised GEOSException.')\n \n         # Same for EWKB.\n-        self.assertEqual(buffer(a2b_hex(hexewkb_2d)), pnt_2d.ewkb)\n+        self.assertEqual(memoryview(a2b_hex(hexewkb_2d)), pnt_2d.ewkb)\n         if GEOS_PREPARE:\n-            self.assertEqual(buffer(a2b_hex(hexewkb_3d)), pnt_3d.ewkb)\n+            self.assertEqual(memoryview(a2b_hex(hexewkb_3d)), pnt_3d.ewkb)\n         else:\n             try:\n                 ewkb = pnt_3d.ewkb\n@@ -150,7 +151,7 @@ def test_errors(self):\n                 pass\n \n         # Bad WKB\n-        self.assertRaises(GEOSException, GEOSGeometry, buffer('0'))\n+        self.assertRaises(GEOSException, GEOSGeometry, memoryview(b'0'))\n \n         print(\"\\nEND - expecting GEOS_ERROR; safe to ignore.\\n\")\n \n@@ -182,7 +183,7 @@ def test_create_wkb(self):\n         \"Testing creation from WKB.\"\n         from binascii import a2b_hex\n         for g in self.geometries.hex_wkt:\n-            wkb = buffer(a2b_hex(g.hex))\n+            wkb = memoryview(a2b_hex(g.hex))\n             geom_h = GEOSGeometry(wkb)\n             # we need to do this so decimal places get normalised\n             geom_t = fromstr(g.wkt)"
        },
        {
            "sha": "1e604e506b92c3c0a812ee17af9f421bebf972fe",
            "filename": "django/contrib/gis/geos/tests/test_io.py",
            "status": "modified",
            "additions": 14,
            "deletions": 12,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_io.py",
            "raw_url": "https://github.com/django/django/raw/8cdc84726e13da4c796db614765658835d4786a1/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_io.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_io.py?ref=8cdc84726e13da4c796db614765658835d4786a1",
            "patch": "@@ -1,5 +1,7 @@\n import binascii\n import unittest\n+\n+from django.contrib.gis import memoryview\n from django.contrib.gis.geos import GEOSGeometry, WKTReader, WKTWriter, WKBReader, WKBWriter, geos_version_info\n from django.utils import six\n \n@@ -20,7 +22,7 @@ def test01_wktreader(self):\n \n         # Should only accept six.string_types objects.\n         self.assertRaises(TypeError, wkt_r.read, 1)\n-        self.assertRaises(TypeError, wkt_r.read, buffer('foo'))\n+        self.assertRaises(TypeError, wkt_r.read, memoryview(b'foo'))\n \n     def test02_wktwriter(self):\n         # Creating a WKTWriter instance, testing its ptr property.\n@@ -29,14 +31,14 @@ def test02_wktwriter(self):\n \n         ref = GEOSGeometry('POINT (5 23)')\n         ref_wkt = 'POINT (5.0000000000000000 23.0000000000000000)'\n-        self.assertEqual(ref_wkt, wkt_w.write(ref))\n+        self.assertEqual(ref_wkt, wkt_w.write(ref).decode())\n \n     def test03_wkbreader(self):\n         # Creating a WKBReader instance\n         wkb_r = WKBReader()\n \n-        hex = '000000000140140000000000004037000000000000'\n-        wkb = buffer(binascii.a2b_hex(hex))\n+        hex = b'000000000140140000000000004037000000000000'\n+        wkb = memoryview(binascii.a2b_hex(hex))\n         ref = GEOSGeometry(hex)\n \n         # read() should return a GEOSGeometry on either a hex string or\n@@ -56,10 +58,10 @@ def test04_wkbwriter(self):\n         # Representations of 'POINT (5 23)' in hex -- one normal and\n         # the other with the byte order changed.\n         g = GEOSGeometry('POINT (5 23)')\n-        hex1 = '010100000000000000000014400000000000003740'\n-        wkb1 = buffer(binascii.a2b_hex(hex1))\n-        hex2 = '000000000140140000000000004037000000000000'\n-        wkb2 = buffer(binascii.a2b_hex(hex2))\n+        hex1 = b'010100000000000000000014400000000000003740'\n+        wkb1 = memoryview(binascii.a2b_hex(hex1))\n+        hex2 = b'000000000140140000000000004037000000000000'\n+        wkb2 = memoryview(binascii.a2b_hex(hex2))\n \n         self.assertEqual(hex1, wkb_w.write_hex(g))\n         self.assertEqual(wkb1, wkb_w.write(g))\n@@ -81,10 +83,10 @@ def test04_wkbwriter(self):\n         g = GEOSGeometry('POINT (5 23 17)')\n         g.srid = 4326\n \n-        hex3d = '0101000080000000000000144000000000000037400000000000003140'\n-        wkb3d = buffer(binascii.a2b_hex(hex3d))\n-        hex3d_srid = '01010000A0E6100000000000000000144000000000000037400000000000003140'\n-        wkb3d_srid = buffer(binascii.a2b_hex(hex3d_srid))\n+        hex3d = b'0101000080000000000000144000000000000037400000000000003140'\n+        wkb3d = memoryview(binascii.a2b_hex(hex3d))\n+        hex3d_srid = b'01010000A0E6100000000000000000144000000000000037400000000000003140'\n+        wkb3d_srid = memoryview(binascii.a2b_hex(hex3d_srid))\n \n         # Ensuring bad output dimensions are not accepted\n         for bad_outdim in (-1, 0, 1, 4, 423, 'foo', None):"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 44,
        "deletions": 28
    }
}