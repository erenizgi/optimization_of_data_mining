{
    "author": "jezdez",
    "message": "Fixed #15252 -- Added static template tag and CachedStaticFilesStorage to staticfiles contrib app.\n\nMany thanks to Florian Apolloner and Jacob Kaplan-Moss for reviewing and eagle eyeing.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16594 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1d32bdd3c9586ff10d0799264105850fa7e3f512",
    "files": [
        {
            "sha": "04a3492e1cba72e81072790eb5812379379b0d83",
            "filename": "django/contrib/admin/helpers.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fhelpers.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,6 +1,7 @@\n from django import forms\n from django.contrib.admin.util import (flatten_fieldsets, lookup_field,\n     display_for_field, label_for_field, help_text_for_field)\n+from django.contrib.admin.templatetags.admin_static import static\n from django.contrib.contenttypes.models import ContentType\n from django.core.exceptions import ObjectDoesNotExist\n from django.db.models.fields.related import ManyToManyRel\n@@ -75,7 +76,7 @@ def __init__(self, form, name=None, readonly_fields=(), fields=(), classes=(),\n     def _media(self):\n         if 'collapse' in self.classes:\n             js = ['jquery.min.js', 'jquery.init.js', 'collapse.min.js']\n-            return forms.Media(js=['admin/js/%s' % url for url in js])\n+            return forms.Media(js=[static('admin/js/%s' % url) for url in js])\n         return forms.Media()\n     media = property(_media)\n "
        },
        {
            "sha": "81e8ae561448c59b3bdf87e362e767e03a36a7e7",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -6,6 +6,7 @@\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.admin import widgets, helpers\n from django.contrib.admin.util import unquote, flatten_fieldsets, get_deleted_objects, model_format_dict\n+from django.contrib.admin.templatetags.admin_static import static\n from django.contrib import messages\n from django.views.decorators.csrf import csrf_protect\n from django.core.exceptions import PermissionDenied, ValidationError\n@@ -350,7 +351,8 @@ def urls(self):\n         return self.get_urls()\n     urls = property(urls)\n \n-    def _media(self):\n+    @property\n+    def media(self):\n         js = [\n             'core.js',\n             'admin/RelatedObjectLookups.js',\n@@ -363,8 +365,7 @@ def _media(self):\n             js.extend(['urlify.js', 'prepopulate.min.js'])\n         if self.opts.get_ordered_objects():\n             js.extend(['getElementsBySelector.js', 'dom-drag.js' , 'admin/ordering.js'])\n-        return forms.Media(js=['admin/js/%s' % url for url in js])\n-    media = property(_media)\n+        return forms.Media(js=[static('admin/js/%s' % url) for url in js])\n \n     def has_add_permission(self, request):\n         \"\"\"\n@@ -1322,14 +1323,14 @@ def __init__(self, parent_model, admin_site):\n         if self.verbose_name_plural is None:\n             self.verbose_name_plural = self.model._meta.verbose_name_plural\n \n-    def _media(self):\n+    @property\n+    def media(self):\n         js = ['jquery.min.js', 'jquery.init.js', 'inlines.min.js']\n         if self.prepopulated_fields:\n             js.extend(['urlify.js', 'prepopulate.min.js'])\n         if self.filter_vertical or self.filter_horizontal:\n             js.extend(['SelectBox.js', 'SelectFilter2.js'])\n-        return forms.Media(js=['admin/js/%s' % url for url in js])\n-    media = property(_media)\n+        return forms.Media(js=[static('admin/js/%s' % url) for url in js])\n \n     def get_formset(self, request, obj=None, **kwargs):\n         \"\"\"Returns a BaseInlineFormSet class for use in admin add/change views.\"\"\""
        },
        {
            "sha": "b18b0aabf3824621153e4ce3a622156ad24dbb27",
            "filename": "django/contrib/admin/templates/admin/auth/user/change_password.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fauth%2Fuser%2Fchange_password.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fauth%2Fuser%2Fchange_password.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fauth%2Fuser%2Fchange_password.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,5 +1,5 @@\n {% extends \"admin/base_site.html\" %}\n-{% load i18n static admin_modify %}\n+{% load i18n admin_static admin_modify %}\n {% load url from future %}\n {% block extrahead %}{{ block.super }}\n {% url 'admin:jsi18n' as jsi18nurl %}"
        },
        {
            "sha": "4b3c42934f999c67366eb16b94a0a5e2783b4353",
            "filename": "django/contrib/admin/templates/admin/base.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fbase.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fbase.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fbase.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,4 +1,4 @@\n-{% load static %}{% load url from future %}<!DOCTYPE html>\n+{% load admin_static %}{% load url from future %}<!DOCTYPE html>\n <html lang=\"{{ LANGUAGE_CODE|default:\"en-us\" }}\" {% if LANGUAGE_BIDI %}dir=\"rtl\"{% endif %}>\n <head>\n <title>{% block title %}{% endblock %}</title>"
        },
        {
            "sha": "56661e9a8e60e106768ae02c6eec15d650b9fdac",
            "filename": "django/contrib/admin/templates/admin/change_form.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_form.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_form.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_form.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,5 +1,5 @@\n {% extends \"admin/base_site.html\" %}\n-{% load i18n static admin_modify %}\n+{% load i18n admin_static admin_modify %}\n {% load url from future %}\n \n {% block extrahead %}{{ block.super }}"
        },
        {
            "sha": "24c6d8cced864fc12465501e9a2c3a5c9ebcb9a2",
            "filename": "django/contrib/admin/templates/admin/change_list.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,5 +1,5 @@\n {% extends \"admin/base_site.html\" %}\n-{% load i18n static admin_list %}\n+{% load i18n admin_static admin_list %}\n {% load url from future %}\n {% block extrastyle %}\n   {{ block.super }}"
        },
        {
            "sha": "b1db6470c956bd6303141bc605fd05d609f3f8dd",
            "filename": "django/contrib/admin/templates/admin/change_list_results.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,4 +1,4 @@\n-{% load i18n static %}\n+{% load i18n admin_static %}\n {% if result_hidden_fields %}\n <div class=\"hiddenfields\">{# DIV for HTML validation #}\n {% for item in result_hidden_fields %}{{ item }}{% endfor %}"
        },
        {
            "sha": "476e2613c5f43566ba96fc480df9ad7fbb8a1618",
            "filename": "django/contrib/admin/templates/admin/edit_inline/stacked.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Fstacked.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Fstacked.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Fstacked.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,4 +1,4 @@\n-{% load i18n static %}\n+{% load i18n admin_static %}\n <div class=\"inline-group\" id=\"{{ inline_admin_formset.formset.prefix }}-group\">\n   <h2>{{ inline_admin_formset.opts.verbose_name_plural|title }}</h2>\n {{ inline_admin_formset.formset.management_form }}"
        },
        {
            "sha": "29db95a171b5358646554866b12c8692e86ec58f",
            "filename": "django/contrib/admin/templates/admin/edit_inline/tabular.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Ftabular.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Ftabular.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fedit_inline%2Ftabular.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,4 +1,4 @@\n-{% load i18n static admin_modify %}\n+{% load i18n admin_static admin_modify %}\n <div class=\"inline-group\" id=\"{{ inline_admin_formset.formset.prefix }}-group\">\n   <div class=\"tabular inline-related {% if forloop.last %}last-related{% endif %}\">\n {{ inline_admin_formset.formset.management_form }}"
        },
        {
            "sha": "7164220ce890c76e33ce23ddb498c66b3bcfb51c",
            "filename": "django/contrib/admin/templates/admin/index.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Findex.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Findex.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Findex.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,5 +1,5 @@\n {% extends \"admin/base_site.html\" %}\n-{% load i18n static %}\n+{% load i18n admin_static %}\n \n {% block extrastyle %}{{ block.super }}<link rel=\"stylesheet\" type=\"text/css\" href=\"{% static \"admin/css/dashboard.css\" %}\" />{% endblock %}\n "
        },
        {
            "sha": "dbaa1192243e7c4b6c9b48d4434e21711fc8c0c2",
            "filename": "django/contrib/admin/templates/admin/login.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Flogin.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Flogin.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Flogin.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,5 +1,5 @@\n {% extends \"admin/base_site.html\" %}\n-{% load i18n static %}\n+{% load i18n admin_static %}\n \n {% block extrastyle %}{{ block.super }}<link rel=\"stylesheet\" type=\"text/css\" href=\"{% static \"admin/css/login.css\" %}\" />{% endblock %}\n "
        },
        {
            "sha": "162b54addf38d2721b4a5965f33396cc42d850a3",
            "filename": "django/contrib/admin/templates/admin/search_form.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fsearch_form.html",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fsearch_form.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fsearch_form.html?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,4 +1,4 @@\n-{% load i18n static %}\n+{% load i18n admin_static %}\n {% if cl.search_fields %}\n <div id=\"toolbar\"><form id=\"changelist-search\" action=\"\" method=\"get\">\n <div><!-- DIV needed for valid HTML -->"
        },
        {
            "sha": "0f5eafc24dcaaedabbddf65f4728e9ad2b671fc3",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -3,9 +3,9 @@\n from django.contrib.admin.util import lookup_field, display_for_field, label_for_field\n from django.contrib.admin.views.main import (ALL_VAR, EMPTY_CHANGELIST_VALUE,\n     ORDER_VAR, PAGE_VAR, SEARCH_VAR)\n+from django.contrib.admin.templatetags.admin_static import static\n from django.core.exceptions import ObjectDoesNotExist\n from django.db import models\n-from django.templatetags.static import static\n from django.utils import formats\n from django.utils.html import escape, conditional_escape\n from django.utils.safestring import mark_safe"
        },
        {
            "sha": "5ea3ba58381325d5a25cb3c719bf4a2e511678fb",
            "filename": "django/contrib/admin/templatetags/admin_static.py",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_static.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_static.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_static.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1,11 @@\n+from django.conf import settings\n+from django.template import Library\n+\n+register = Library()\n+\n+if 'django.contrib.staticfiles' in settings.INSTALLED_APPS:\n+    from django.contrib.staticfiles.templatetags.staticfiles import static\n+else:\n+    from django.templatetags.static import static\n+\n+static = register.simple_tag(static)"
        },
        {
            "sha": "0d1f2a9ff7c17a9358624740fab91677fc131056",
            "filename": "django/contrib/admin/widgets.py",
            "status": "modified",
            "additions": 22,
            "deletions": 12,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fwidgets.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -4,36 +4,40 @@\n \n import copy\n from django import forms\n+from django.contrib.admin.templatetags.admin_static import static\n from django.core.urlresolvers import reverse\n from django.forms.widgets import RadioFieldRenderer\n from django.forms.util import flatatt\n-from django.templatetags.static import static\n from django.utils.html import escape\n from django.utils.text import Truncator\n from django.utils.translation import ugettext as _\n from django.utils.safestring import mark_safe\n from django.utils.encoding import force_unicode\n \n+\n class FilteredSelectMultiple(forms.SelectMultiple):\n     \"\"\"\n     A SelectMultiple with a JavaScript filter interface.\n \n     Note that the resulting JavaScript assumes that the jsi18n\n     catalog has been loaded in the page\n     \"\"\"\n-    class Media:\n-        js = [\"admin/js/%s\" % path\n-              for path in [\"core.js\", \"SelectBox.js\", \"SelectFilter2.js\"]]\n+    @property\n+    def media(self):\n+        js = [\"core.js\", \"SelectBox.js\", \"SelectFilter2.js\"]\n+        return forms.Media(js=[static(\"admin/js/%s\" % path) for path in js])\n \n     def __init__(self, verbose_name, is_stacked, attrs=None, choices=()):\n         self.verbose_name = verbose_name\n         self.is_stacked = is_stacked\n         super(FilteredSelectMultiple, self).__init__(attrs, choices)\n \n     def render(self, name, value, attrs=None, choices=()):\n-        if attrs is None: attrs = {}\n+        if attrs is None:\n+            attrs = {}\n         attrs['class'] = 'selectfilter'\n-        if self.is_stacked: attrs['class'] += 'stacked'\n+        if self.is_stacked:\n+            attrs['class'] += 'stacked'\n         output = [super(FilteredSelectMultiple, self).render(name, value, attrs, choices)]\n         output.append(u'<script type=\"text/javascript\">addEvent(window, \"load\", function(e) {')\n         # TODO: \"id_\" is hard-coded here. This should instead use the correct\n@@ -43,15 +47,21 @@ def render(self, name, value, attrs=None, choices=()):\n         return mark_safe(u''.join(output))\n \n class AdminDateWidget(forms.DateInput):\n-    class Media:\n-        js = [\"admin/js/calendar.js\", \"admin/js/admin/DateTimeShortcuts.js\"]\n+\n+    @property\n+    def media(self):\n+        js = [\"calendar.js\", \"admin/DateTimeShortcuts.js\"]\n+        return forms.Media(js=[static(\"admin/js/%s\" % path) for path in js])\n \n     def __init__(self, attrs={}, format=None):\n         super(AdminDateWidget, self).__init__(attrs={'class': 'vDateField', 'size': '10'}, format=format)\n \n class AdminTimeWidget(forms.TimeInput):\n-    class Media:\n-        js = [\"admin/js/calendar.js\", \"admin/js/admin/DateTimeShortcuts.js\"]\n+\n+    @property\n+    def media(self):\n+        js = [\"calendar.js\", \"admin/DateTimeShortcuts.js\"]\n+        return forms.Media(js=[static(\"admin/js/%s\" % path) for path in js])\n \n     def __init__(self, attrs={}, format=None):\n         super(AdminTimeWidget, self).__init__(attrs={'class': 'vTimeField', 'size': '8'}, format=format)\n@@ -232,9 +242,9 @@ def __deepcopy__(self, memo):\n         memo[id(self)] = obj\n         return obj\n \n-    def _media(self):\n+    @property\n+    def media(self):\n         return self.widget.media\n-    media = property(_media)\n \n     def render(self, name, value, *args, **kwargs):\n         rel_to = self.rel.to"
        },
        {
            "sha": "45bf4a1023b5d9a326e84816953bd578943b8091",
            "filename": "django/contrib/staticfiles/finders.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Ffinders.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -28,7 +28,7 @@ def find(self, path, all=False):\n         \"\"\"\n         raise NotImplementedError()\n \n-    def list(self, ignore_patterns=[]):\n+    def list(self, ignore_patterns):\n         \"\"\"\n         Given an optional list of paths to ignore, this should return\n         a two item iterable consisting of the relative path and storage"
        },
        {
            "sha": "18f889374bb730cb20b0f00e6544ba460f2dde94",
            "filename": "django/contrib/staticfiles/management/commands/collectstatic.py",
            "status": "modified",
            "additions": 56,
            "deletions": 28,
            "changes": 84,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -4,12 +4,11 @@\n import sys\n from optparse import make_option\n \n-from django.conf import settings\n-from django.core.files.storage import FileSystemStorage, get_storage_class\n+from django.core.files.storage import FileSystemStorage\n from django.core.management.base import CommandError, NoArgsCommand\n from django.utils.encoding import smart_str, smart_unicode\n \n-from django.contrib.staticfiles import finders\n+from django.contrib.staticfiles import finders, storage\n \n \n class Command(NoArgsCommand):\n@@ -18,32 +17,39 @@ class Command(NoArgsCommand):\n     locations to the settings.STATIC_ROOT.\n     \"\"\"\n     option_list = NoArgsCommand.option_list + (\n-        make_option('--noinput', action='store_false', dest='interactive',\n-            default=True, help=\"Do NOT prompt the user for input of any kind.\"),\n+        make_option('--noinput',\n+            action='store_false', dest='interactive', default=True,\n+            help=\"Do NOT prompt the user for input of any kind.\"),\n+        make_option('--no-post-process',\n+            action='store_false', dest='post_process', default=True,\n+            help=\"Do NOT post process collected files.\"),\n         make_option('-i', '--ignore', action='append', default=[],\n             dest='ignore_patterns', metavar='PATTERN',\n             help=\"Ignore files or directories matching this glob-style \"\n                 \"pattern. Use multiple times to ignore more.\"),\n-        make_option('-n', '--dry-run', action='store_true', dest='dry_run',\n-            default=False, help=\"Do everything except modify the filesystem.\"),\n-        make_option('-c', '--clear', action='store_true', dest='clear',\n-            default=False, help=\"Clear the existing files using the storage \"\n-                \"before trying to copy or link the original file.\"),\n-        make_option('-l', '--link', action='store_true', dest='link',\n-            default=False, help=\"Create a symbolic link to each file instead of copying.\"),\n+        make_option('-n', '--dry-run',\n+            action='store_true', dest='dry_run', default=False,\n+            help=\"Do everything except modify the filesystem.\"),\n+        make_option('-c', '--clear',\n+            action='store_true', dest='clear', default=False,\n+            help=\"Clear the existing files using the storage \"\n+                 \"before trying to copy or link the original file.\"),\n+        make_option('-l', '--link',\n+            action='store_true', dest='link', default=False,\n+            help=\"Create a symbolic link to each file instead of copying.\"),\n         make_option('--no-default-ignore', action='store_false',\n             dest='use_default_ignore_patterns', default=True,\n             help=\"Don't ignore the common private glob-style patterns 'CVS', \"\n                 \"'.*' and '*~'.\"),\n     )\n-    help = \"Collect static files from apps and other locations in a single location.\"\n+    help = \"Collect static files in a single location.\"\n \n     def __init__(self, *args, **kwargs):\n         super(NoArgsCommand, self).__init__(*args, **kwargs)\n         self.copied_files = []\n         self.symlinked_files = []\n         self.unmodified_files = []\n-        self.storage = get_storage_class(settings.STATICFILES_STORAGE)()\n+        self.storage = storage.staticfiles_storage\n         try:\n             self.storage.path('')\n         except NotImplementedError:\n@@ -64,6 +70,7 @@ def handle_noargs(self, **options):\n         self.interactive = options['interactive']\n         self.symlink = options['link']\n         self.verbosity = int(options.get('verbosity', 1))\n+        self.post_process = options['post_process']\n \n         if self.symlink:\n             if sys.platform == 'win32':\n@@ -104,29 +111,46 @@ def handle_noargs(self, **options):\n \n         handler = {\n             True: self.link_file,\n-            False: self.copy_file\n+            False: self.copy_file,\n         }[self.symlink]\n \n+        found_files = []\n         for finder in finders.get_finders():\n             for path, storage in finder.list(self.ignore_patterns):\n                 # Prefix the relative path if the source storage contains it\n                 if getattr(storage, 'prefix', None):\n                     prefixed_path = os.path.join(storage.prefix, path)\n                 else:\n                     prefixed_path = path\n+                found_files.append(prefixed_path)\n                 handler(path, prefixed_path, storage)\n \n-        actual_count = len(self.copied_files) + len(self.symlinked_files)\n+        # Here we check if the storage backend has a post_process\n+        # method and pass it the list of modified files.\n+        if self.post_process and hasattr(self.storage, 'post_process'):\n+            post_processed = self.storage.post_process(found_files, **options)\n+            for path in post_processed:\n+                self.log(u\"Post-processed '%s'\" % path, level=1)\n+        else:\n+            post_processed = []\n+\n+        modified_files = self.copied_files + self.symlinked_files\n+        actual_count = len(modified_files)\n         unmodified_count = len(self.unmodified_files)\n+\n         if self.verbosity >= 1:\n-            self.stdout.write(smart_str(u\"\\n%s static file%s %s %s%s.\\n\"\n-                              % (actual_count,\n-                                 actual_count != 1 and 's' or '',\n-                                 self.symlink and 'symlinked' or 'copied',\n-                                 destination_path and \"to '%s'\"\n-                                    % destination_path or '',\n-                                 unmodified_count and ' (%s unmodified)'\n-                                    % unmodified_count or '')))\n+            template = (\"\\n%(actual_count)s %(identifier)s %(action)s\"\n+                        \"%(destination)s%(unmodified)s.\\n\")\n+            summary = template % {\n+                'actual_count': actual_count,\n+                'identifier': 'static file' + (actual_count > 1 and 's' or ''),\n+                'action': self.symlink and 'symlinked' or 'copied',\n+                'destination': (destination_path and \" to '%s'\"\n+                                % destination_path or ''),\n+                'unmodified': (self.unmodified_files and ', %s unmodified'\n+                               % unmodified_count or ''),\n+            }\n+            self.stdout.write(smart_str(summary))\n \n     def log(self, msg, level=2):\n         \"\"\"\n@@ -146,7 +170,8 @@ def clear_dir(self, path):\n         for f in files:\n             fpath = os.path.join(path, f)\n             if self.dry_run:\n-                self.log(u\"Pretending to delete '%s'\" % smart_unicode(fpath), level=1)\n+                self.log(u\"Pretending to delete '%s'\" %\n+                         smart_unicode(fpath), level=1)\n             else:\n                 self.log(u\"Deleting '%s'\" % smart_unicode(fpath), level=1)\n                 self.storage.delete(fpath)\n@@ -159,7 +184,8 @@ def delete_file(self, path, prefixed_path, source_storage):\n         if self.storage.exists(prefixed_path):\n             try:\n                 # When was the target file modified last time?\n-                target_last_modified = self.storage.modified_time(prefixed_path)\n+                target_last_modified = \\\n+                    self.storage.modified_time(prefixed_path)\n             except (OSError, NotImplementedError):\n                 # The storage doesn't support ``modified_time`` or failed\n                 pass\n@@ -177,8 +203,10 @@ def delete_file(self, path, prefixed_path, source_storage):\n                         full_path = None\n                     # Skip the file if the source file is younger\n                     if target_last_modified >= source_last_modified:\n-                        if not ((self.symlink and full_path and not os.path.islink(full_path)) or\n-                                (not self.symlink and full_path and os.path.islink(full_path))):\n+                        if not ((self.symlink and full_path\n+                                 and not os.path.islink(full_path)) or\n+                                (not self.symlink and full_path\n+                                 and os.path.islink(full_path))):\n                             if prefixed_path not in self.unmodified_files:\n                                 self.unmodified_files.append(prefixed_path)\n                             self.log(u\"Skipping '%s' (not modified)\" % path)"
        },
        {
            "sha": "d2f5cdd9d50191aa48a1ffe74d55f0e05c985b57",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 161,
            "deletions": 4,
            "changes": 165,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -1,10 +1,20 @@\n+import hashlib\n import os\n+import posixpath\n+import re\n+\n from django.conf import settings\n+from django.core.cache import (get_cache, InvalidCacheBackendError,\n+                               cache as default_cache)\n from django.core.exceptions import ImproperlyConfigured\n-from django.core.files.storage import FileSystemStorage\n+from django.core.files.base import ContentFile\n+from django.core.files.storage import FileSystemStorage, get_storage_class\n+from django.utils.encoding import force_unicode\n+from django.utils.functional import LazyObject\n from django.utils.importlib import import_module\n+from django.utils.datastructures import SortedDict\n \n-from django.contrib.staticfiles import utils\n+from django.contrib.staticfiles.utils import check_settings, matches_patterns\n \n \n class StaticFilesStorage(FileSystemStorage):\n@@ -26,8 +36,148 @@ def __init__(self, location=None, base_url=None, *args, **kwargs):\n         if base_url is None:\n             raise ImproperlyConfigured(\"You're using the staticfiles app \"\n                 \"without having set the STATIC_URL setting.\")\n-        utils.check_settings()\n-        super(StaticFilesStorage, self).__init__(location, base_url, *args, **kwargs)\n+        check_settings()\n+        super(StaticFilesStorage, self).__init__(location, base_url,\n+                                                 *args, **kwargs)\n+\n+\n+class CachedFilesMixin(object):\n+    patterns = (\n+        (\"*.css\", (\n+            r\"\"\"(url\\(['\"]{0,1}\\s*(.*?)[\"']{0,1}\\))\"\"\",\n+            r\"\"\"(@import\\s*[\"']\\s*(.*?)[\"'])\"\"\",\n+        )),\n+    )\n+\n+    def __init__(self, *args, **kwargs):\n+        super(CachedFilesMixin, self).__init__(*args, **kwargs)\n+        try:\n+            self.cache = get_cache('staticfiles')\n+        except InvalidCacheBackendError:\n+            # Use the default backend\n+            self.cache = default_cache\n+        self._patterns = SortedDict()\n+        for extension, patterns in self.patterns:\n+            for pattern in patterns:\n+                compiled = re.compile(pattern)\n+                self._patterns.setdefault(extension, []).append(compiled)\n+\n+    def hashed_name(self, name, content=None):\n+        if content is None:\n+            if not self.exists(name):\n+                raise ValueError(\"The file '%s' could not be found with %r.\" %\n+                                 (name, self))\n+            try:\n+                content = self.open(name)\n+            except IOError:\n+                # Handle directory paths\n+                return name\n+        path, filename = os.path.split(name)\n+        root, ext = os.path.splitext(filename)\n+        # Get the MD5 hash of the file\n+        md5 = hashlib.md5()\n+        for chunk in content.chunks():\n+            md5.update(chunk)\n+        md5sum = md5.hexdigest()[:12]\n+        return os.path.join(path, u\"%s.%s%s\" % (root, md5sum, ext))\n+\n+    def cache_key(self, name):\n+        return u'staticfiles:cache:%s' % name\n+\n+    def url(self, name, force=False):\n+        \"\"\"\n+        Returns the real URL in DEBUG mode.\n+        \"\"\"\n+        if settings.DEBUG and not force:\n+            return super(CachedFilesMixin, self).url(name)\n+        cache_key = self.cache_key(name)\n+        hashed_name = self.cache.get(cache_key)\n+        if hashed_name is None:\n+            hashed_name = self.hashed_name(name)\n+        return super(CachedFilesMixin, self).url(hashed_name)\n+\n+    def url_converter(self, name):\n+        \"\"\"\n+        Returns the custom URL converter for the given file name.\n+        \"\"\"\n+        def converter(matchobj):\n+            \"\"\"\n+            Converts the matched URL depending on the parent level (`..`)\n+            and returns the normalized and hashed URL using the url method\n+            of the storage.\n+            \"\"\"\n+            matched, url = matchobj.groups()\n+            # Completely ignore http(s) prefixed URLs\n+            if url.startswith(('http', 'https')):\n+                return matched\n+            name_parts = name.split('/')\n+            # Using posix normpath here to remove duplicates\n+            result = url_parts = posixpath.normpath(url).split('/')\n+            level = url.count('..')\n+            if level:\n+                result = name_parts[:-level - 1] + url_parts[level:]\n+            elif name_parts[:-1]:\n+                result = name_parts[:-1] + url_parts[-1:]\n+            joined_result = '/'.join(result)\n+            hashed_url = self.url(joined_result, force=True)\n+            # Return the hashed and normalized version to the file\n+            return 'url(\"%s\")' % hashed_url\n+        return converter\n+\n+    def post_process(self, paths, dry_run=False, **options):\n+        \"\"\"\n+        Post process the given list of files (called from collectstatic).\n+        \"\"\"\n+        processed_files = []\n+        # don't even dare to process the files if we're in dry run mode\n+        if dry_run:\n+            return processed_files\n+\n+        # delete cache of all handled paths\n+        self.cache.delete_many([self.cache_key(path) for path in paths])\n+\n+        # only try processing the files we have patterns for\n+        matches = lambda path: matches_patterns(path, self._patterns.keys())\n+        processing_paths = [path for path in paths if matches(path)]\n+\n+        # then sort the files by the directory level\n+        path_level = lambda name: len(name.split(os.sep))\n+        for name in sorted(paths, key=path_level, reverse=True):\n+\n+            # first get a hashed name for the given file\n+            hashed_name = self.hashed_name(name)\n+\n+            with self.open(name) as original_file:\n+                # then get the original's file content\n+                content = original_file.read()\n+\n+                # to apply each replacement pattern on the content\n+                if name in processing_paths:\n+                    converter = self.url_converter(name)\n+                    for patterns in self._patterns.values():\n+                        for pattern in patterns:\n+                            content = pattern.sub(converter, content)\n+\n+                # then save the processed result\n+                if self.exists(hashed_name):\n+                    self.delete(hashed_name)\n+\n+                saved_name = self._save(hashed_name, ContentFile(content))\n+                hashed_name = force_unicode(saved_name.replace('\\\\', '/'))\n+                processed_files.append(hashed_name)\n+\n+                # and then set the cache accordingly\n+                self.cache.set(self.cache_key(name), hashed_name)\n+\n+        return processed_files\n+\n+\n+class CachedStaticFilesStorage(CachedFilesMixin, StaticFilesStorage):\n+    \"\"\"\n+    A static file system storage backend which also saves\n+    hashed copies of the files it saves.\n+    \"\"\"\n+    pass\n \n \n class AppStaticStorage(FileSystemStorage):\n@@ -47,3 +197,10 @@ def __init__(self, app, *args, **kwargs):\n         mod_path = os.path.dirname(mod.__file__)\n         location = os.path.join(mod_path, self.source_dir)\n         super(AppStaticStorage, self).__init__(location, *args, **kwargs)\n+\n+\n+class ConfiguredStorage(LazyObject):\n+    def _setup(self):\n+        self._wrapped = get_storage_class(settings.STATICFILES_STORAGE)()\n+\n+staticfiles_storage = ConfiguredStorage()"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "django/contrib/staticfiles/templatetags/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Ftemplatetags%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Ftemplatetags%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Ftemplatetags%2F__init__.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512"
        },
        {
            "sha": "788f06ec1670a33b3b72fae72ffef59e6aca7c2b",
            "filename": "django/contrib/staticfiles/templatetags/staticfiles.py",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Ftemplatetags%2Fstaticfiles.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Ftemplatetags%2Fstaticfiles.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Ftemplatetags%2Fstaticfiles.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1,13 @@\n+from django import template\n+from django.contrib.staticfiles.storage import staticfiles_storage\n+\n+register = template.Library()\n+\n+\n+@register.simple_tag\n+def static(path):\n+    \"\"\"\n+    A template tag that returns the URL to a file\n+    using staticfiles' storage backend\n+    \"\"\"\n+    return staticfiles_storage.url(path)"
        },
        {
            "sha": "9aee92806389f0969a7d281c9e8ff02479bf2339",
            "filename": "django/contrib/staticfiles/utils.py",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/django%2Fcontrib%2Fstaticfiles%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Futils.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -3,30 +3,34 @@\n from django.conf import settings\n from django.core.exceptions import ImproperlyConfigured\n \n-def is_ignored(path, ignore_patterns=[]):\n+def matches_patterns(path, patterns=None):\n     \"\"\"\n     Return True or False depending on whether the ``path`` should be\n     ignored (if it matches any pattern in ``ignore_patterns``).\n     \"\"\"\n-    for pattern in ignore_patterns:\n+    if patterns is None:\n+        patterns = []\n+    for pattern in patterns:\n         if fnmatch.fnmatchcase(path, pattern):\n             return True\n     return False\n \n-def get_files(storage, ignore_patterns=[], location=''):\n+def get_files(storage, ignore_patterns=None, location=''):\n     \"\"\"\n     Recursively walk the storage directories yielding the paths\n     of all files that should be copied.\n     \"\"\"\n+    if ignore_patterns is None:\n+        ignore_patterns = []\n     directories, files = storage.listdir(location)\n     for fn in files:\n-        if is_ignored(fn, ignore_patterns):\n+        if matches_patterns(fn, ignore_patterns):\n             continue\n         if location:\n             fn = os.path.join(location, fn)\n         yield fn\n     for dir in directories:\n-        if is_ignored(dir, ignore_patterns):\n+        if matches_patterns(dir, ignore_patterns):\n             continue\n         if location:\n             dir = os.path.join(location, dir)"
        },
        {
            "sha": "465b5baeae493c91af06e120b2300d580a1a33c7",
            "filename": "docs/howto/static-files.txt",
            "status": "modified",
            "additions": 20,
            "deletions": 24,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Fhowto%2Fstatic-files.txt",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Fhowto%2Fstatic-files.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fstatic-files.txt?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -70,7 +70,7 @@ Basic usage\n \n        <img src=\"{{ STATIC_URL }}images/hi.jpg\" />\n \n-   See :ref:`staticfiles-in-templates` for more details, including an\n+   See :ref:`staticfiles-in-templates` for more details, **including** an\n    alternate method using a template tag.\n \n Deploying static files in a nutshell\n@@ -143,7 +143,7 @@ A far better way is to use the value of the :setting:`STATIC_URL` setting\n directly in your templates. This means that a switch of static files servers\n only requires changing that single value. Much better!\n \n-``staticfiles`` includes two built-in ways of getting at this setting in your\n+Django includes multiple built-in ways of using this setting in your\n templates: a context processor and a template tag.\n \n With a context processor\n@@ -180,45 +180,41 @@ but in views written by hand you'll need to explicitly use ``RequestContext``\n To see how that works, and to read more details, check out\n :ref:`subclassing-context-requestcontext`.\n \n+Another option is the :ttag:`get_static_prefix` template tag that is part of\n+Django's core.\n+\n With a template tag\n -------------------\n \n-To easily link to static files Django ships with a :ttag:`static` template tag.\n+The more powerful tool is the :ttag:`static<staticfiles-static>` template\n+tag. It builds the URL for the given relative path by using the configured\n+:setting:`STATICFILES_STORAGE` storage.\n \n .. code-block:: html+django\n \n-    {% load static %}\n+    {% load staticfiles %}\n     <img src=\"{% static \"images/hi.jpg\" %}\" />\n \n It is also able to consume standard context variables, e.g. assuming a\n ``user_stylesheet`` variable is passed to the template:\n \n .. code-block:: html+django\n \n-    {% load static %}\n+    {% load staticfiles %}\n     <link rel=\"stylesheet\" href=\"{% static user_stylesheet %}\" type=\"text/css\" media=\"screen\" />\n \n-Another option is the :ttag:`get_static_prefix` template tag. You can use\n-this if you're not using :class:`~django.template.RequestContext` (and\n-therefore not relying on the ``django.core.context_processors.static``\n-context processor), or if you need more control over exactly where and how\n-:setting:`STATIC_URL` is injected into the template. Here's an example:\n-\n-.. code-block:: html+django\n-\n-    {% load static %}\n-    <img src=\"{% get_static_prefix %}images/hi.jpg\" />\n-\n-There's also a second form you can use to avoid extra processing if you need\n-the value multiple times:\n-\n-.. code-block:: html+django\n+.. note::\n \n-    {% load static %}\n-    {% get_static_prefix as STATIC_PREFIX %}\n+    There is also a template tag named :ttag:`static` in Django's core set\n+    of :ref:`built in template tags<ref-templates-builtins-tags>` which has\n+    the same argument signature but only uses `urlparse.urljoin()`_ with the\n+    :setting:`STATIC_URL` setting and the given path. This has the\n+    disadvantage of not being able to easily switch the storage backend\n+    without changing the templates, so in doubt use the ``staticfiles``\n+    :ttag:`static<staticfiles-static>`\n+    template tag.\n \n-    <img src=\"{{ STATIC_PREFIX }}images/hi.jpg\" />\n-    <img src=\"{{ STATIC_PREFIX }}images/hi2.jpg\" />\n+.. _`urlparse.urljoin()`: http://docs.python.org/library/urlparse.html#urlparse.urljoin\n \n .. _staticfiles-development:\n "
        },
        {
            "sha": "ae9521051e41065a476272e88848a7276bfe5201",
            "filename": "docs/ref/contrib/staticfiles.txt",
            "status": "modified",
            "additions": 140,
            "deletions": 3,
            "changes": 143,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Fref%2Fcontrib%2Fstaticfiles.txt",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Fref%2Fcontrib%2Fstaticfiles.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fstaticfiles.txt?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -68,7 +68,9 @@ in a ``'downloads'`` subdirectory of :setting:`STATIC_ROOT`.\n \n This would allow you to refer to the local file\n ``'/opt/webfiles/stats/polls_20101022.tar.gz'`` with\n-``'/static/downloads/polls_20101022.tar.gz'`` in your templates, e.g.::\n+``'/static/downloads/polls_20101022.tar.gz'`` in your templates, e.g.:\n+\n+.. code-block:: html+django\n \n     <a href=\"{{ STATIC_URL }}downloads/polls_20101022.tar.gz\">\n \n@@ -82,6 +84,11 @@ Default: ``'django.contrib.staticfiles.storage.StaticFilesStorage'``\n The file storage engine to use when collecting static files with the\n :djadmin:`collectstatic` management command.\n \n+.. versionadded:: 1.4\n+\n+A ready-to-use instance of the storage backend defined in this setting\n+can be found at ``django.contrib.staticfiles.storage.staticfiles_storage``.\n+\n For an example, see :ref:`staticfiles-from-cdn`.\n \n .. setting:: STATICFILES_FINDERS\n@@ -141,6 +148,16 @@ Files are searched by using the :setting:`enabled finders\n :setting:`STATICFILES_DIRS` and in the ``'static'`` directory of apps\n specified by the :setting:`INSTALLED_APPS` setting.\n \n+.. versionadded:: 1.4\n+\n+The :djadmin:`collectstatic` management command calls the\n+:meth:`~django.contrib.staticfiles.storage.StaticFilesStorage.post_process`\n+method of the :setting:`STATICFILES_STORAGE` after each run and passes\n+a list of paths that have been found by the management command. It also\n+receives all command line options of :djadmin:`collectstatic`. This is used\n+by the :class:`~django.contrib.staticfiles.storage.CachedStaticFilesStorage`\n+by default.\n+\n Some commonly used options are:\n \n .. django-admin-option:: --noinput\n@@ -169,6 +186,13 @@ Some commonly used options are:\n \n     Create a symbolic link to each file instead of copying.\n \n+.. django-admin-option:: --no-post-process\n+.. versionadded:: 1.4\n+\n+    Don't call the\n+    :meth:`~django.contrib.staticfiles.storage.StaticFilesStorage.post_process`\n+    method of the configured :setting:`STATICFILES_STORAGE` storage backend.\n+\n .. django-admin-option:: --no-default-ignore\n \n     Don't ignore the common private glob-style patterns ``'CVS'``, ``'.*'``\n@@ -237,7 +261,120 @@ Example usage::\n \n     django-admin.py runserver --insecure\n \n-.. currentmodule:: None\n+Storages\n+========\n+\n+StaticFilesStorage\n+------------------\n+\n+.. class:: storage.StaticFilesStorage\n+\n+    A subclass of the :class:`~django.core.files.storage.FileSystemStorage`\n+    storage backend that uses the :setting:`STATIC_ROOT` setting as the base\n+    file system location and the :setting:`STATIC_URL` setting respectively\n+    as the base URL.\n+\n+    .. method:: post_process(paths, **options)\n+\n+    .. versionadded:: 1.4\n+\n+    This method is called by the :djadmin:`collectstatic` management command\n+    after each run and gets passed the paths of found files, as well as the\n+    command line options.\n+\n+    The :class:`~django.contrib.staticfiles.storage.CachedStaticFilesStorage`\n+    uses this behind the scenes to replace the paths with their hashed\n+    counterparts and update the cache appropriately.\n+\n+CachedStaticFilesStorage\n+------------------------\n+\n+.. class:: storage.CachedStaticFilesStorage\n+\n+    .. versionadded:: 1.4\n+\n+    A subclass of the :class:`~django.contrib.staticfiles.storage.StaticFilesStorage`\n+    storage backend which caches the files it saves by appending the MD5 hash\n+    of the file's content to the filename. For example, the file\n+    ``css/styles.css`` would also be saved as ``css/styles.55e7cbb9ba48.css``.\n+\n+    The purpose of this storage is to keep serving the old files in case some\n+    pages still refer to those files, e.g. because they are cached by you or\n+    a 3rd party proxy server. Additionally, it's very helpful if you want to\n+    apply `far future Expires headers`_ to the deployed files to speed up the\n+    load time for subsequent page visits.\n+\n+    The storage backend automatically replaces the paths found in the saved\n+    files matching other saved files with the path of the cached copy (using\n+    the :meth:`~django.contrib.staticfiles.storage.StaticFilesStorage.post_process`\n+    method). The regular expressions used to find those paths\n+    (``django.contrib.staticfiles.storage.CachedStaticFilesStorage.cached_patterns``)\n+    by default cover the `@import`_ rule and `url()`_ statement of `Cascading\n+    Style Sheets`_. For example, the ``'css/styles.css'`` file with the\n+    content\n+\n+    .. code-block:: css+django\n+\n+        @import url(\"../admin/css/base.css\");\n+\n+    would be replaced by calling the\n+    :meth:`~django.core.files.storage.Storage.url`\n+    method of the ``CachedStaticFilesStorage`` storage backend, ultimatively\n+    saving a ``'css/styles.55e7cbb9ba48.css'`` file with the following\n+    content:\n+\n+    .. code-block:: css+django\n+\n+        @import url(\"/static/admin/css/base.27e20196a850.css\");\n+\n+    To enable the ``CachedStaticFilesStorage`` you have to make sure the\n+    following requirements are met:\n+\n+    * the :setting:`STATICFILES_STORAGE` setting is set to\n+      ``'django.contrib.staticfiles.storage.CachedStaticFilesStorage'``\n+    * the :setting:`DEBUG` setting is set to ``False``\n+    * you use the ``staticfiles`` :ttag:`static<staticfiles-static>` template\n+      tag to refer to your static files in your templates\n+    * you've collected all your static files by using the\n+      :djadmin:`collectstatic` management command\n+\n+    Since creating the MD5 hash can be a performance burden to your website\n+    during runtime, ``staticfiles`` will automatically try to cache the\n+    hashed name for each file path using Django's :doc:`caching\n+    framework</topics/cache>`. If you want to override certain options of the\n+    cache backend the storage uses, simply specify a custom entry in the\n+    :setting:`CACHES` setting named ``'staticfiles'``. It falls back to using\n+    the ``'default'`` cache backend.\n+\n+.. _`far future Expires headers`: http://developer.yahoo.com/performance/rules.html#expires\n+.. _`@import`: http://www.w3.org/TR/CSS2/cascade.html#at-import\n+.. _`url()`: http://www.w3.org/TR/CSS2/syndata.html#uri\n+.. _`Cascading Style Sheets`: http://www.w3.org/Style/CSS/\n+\n+.. currentmodule:: django.contrib.staticfiles.templatetags.staticfiles\n+\n+Template tags\n+=============\n+\n+static\n+------\n+\n+.. templatetag:: staticfiles-static\n+\n+.. versionadded:: 1.4\n+\n+Uses the configued :setting:`STATICFILES_STORAGE` storage to create the\n+full URL for the given relative path, e.g.:\n+\n+.. code-block:: html+django\n+\n+    {% load static from staticfiles %}\n+    <img src=\"{% static \"css/base.css\" %}\" />\n+\n+The previous example is equal to calling the ``url`` method of an instance of\n+:setting:`STATICFILES_STORAGE` with ``\"css/base.css\"``. This is especially\n+useful when using a non-local storage backend to deploy files as documented\n+in :ref:`staticfiles-from-cdn`.\n \n Other Helpers\n =============\n@@ -251,7 +388,7 @@ files:\n       with :class:`~django.template.RequestContext` contexts.\n \n     - The builtin template tag :ttag:`static` which takes a path and\n-      joins it with the the static prefix :setting:`STATIC_URL`.\n+      urljoins it with the static prefix :setting:`STATIC_URL`.\n \n     - The builtin template tag :ttag:`get_static_prefix` which populates a\n       template variable with the static prefix :setting:`STATIC_URL` to be"
        },
        {
            "sha": "a7d548a01c7856c6b2457980cc2c5e2884032d5f",
            "filename": "docs/ref/templates/builtins.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Fref%2Ftemplates%2Fbuiltins.txt",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Fref%2Ftemplates%2Fbuiltins.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Ftemplates%2Fbuiltins.txt?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -2353,9 +2353,9 @@ static\n \n .. highlight:: html+django\n \n-To link to static files Django ships with a :ttag:`static` template tag. You\n-can use this regardless if you're using :class:`~django.template.RequestContext`\n-or not.\n+To link to static files that are saved in :setting:`STATIC_ROOT` Django ships\n+with a :ttag:`static` template tag. You can use this regardless if you're\n+using :class:`~django.template.RequestContext` or not.\n \n .. code-block:: html+django\n \n@@ -2370,6 +2370,17 @@ It is also able to consume standard context variables, e.g. assuming a\n     {% load static %}\n     <link rel=\"stylesheet\" href=\"{% static user_stylesheet %}\" type=\"text/css\" media=\"screen\" />\n \n+.. note::\n+\n+    The :mod:`staticfiles<django.contrib.staticfiles>` contrib app also ships\n+    with a :ttag:`static template tag<staticfiles-static>` which uses\n+    ``staticfiles'`` :setting:`STATICFILES_STORAGE` to build the URL of the\n+    given path. Use that instead if you have an advanced use case such as\n+    :ref:`using a cloud service to serve static files<staticfiles-from-cdn>`::\n+\n+        {% load static from staticfiles %}\n+        <img src=\"{% static \"images/hi.jpg\" %}\" />\n+\n .. templatetag:: get_static_prefix\n \n get_static_prefix"
        },
        {
            "sha": "02c4e82693cf9b02b36bf586cc6f55a224319941",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -212,6 +212,29 @@ Additionally, it's now possible to define translatable URL patterns using\n :ref:`url-internationalization` for more information about the language prefix\n and how to internationalize URL patterns.\n \n+``static`` template tag\n+~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The :mod:`staticfiles<django.contrib.staticfiles>` contrib app has now a new\n+:ttag:`static template tag<staticfiles-static>` to refer to files saved with\n+the :setting:`STATICFILES_STORAGE` storage backend. It'll use the storage\n+``url`` method and therefore supports advanced features such as\n+:ref:`serving files from a cloud service<staticfiles-from-cdn>`.\n+\n+``CachedStaticFilesStorage`` storage backend\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Additional to the `static template tag`_ the\n+:mod:`staticfiles<django.contrib.staticfiles>` contrib app now has a\n+:class:`~django.contrib.staticfiles.storage.CachedStaticFilesStorage` which\n+caches the files it saves (when running the :djadmin:`collectstatic`\n+management command) by appending the MD5 hash of the file's content to the\n+filename. For example, the file ``css/styles.css`` would also be saved as\n+``css/styles.55e7cbb9ba48.css``\n+\n+See the :class:`~django.contrib.staticfiles.storage.CachedStaticFilesStorage`\n+docs for more information.\n+\n Minor features\n ~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "e64e7ccca7bea25cddf7c78ac10c71eb9101852d",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/absolute.css",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fabsolute.css",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fabsolute.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fabsolute.css?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1 @@\n+@import url(\"/static/cached/styles.css\");"
        },
        {
            "sha": "27b9a349b04347c2d802e4904510dda872187ef3",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/denorm.css",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fdenorm.css",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fdenorm.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fdenorm.css?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1 @@\n+@import url(\"..//cached///styles.css\");"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/other.css",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fother.css",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fother.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fother.css?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512"
        },
        {
            "sha": "40c4a256aa2474b85870f8fbf329a5f467d2c9e0",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/relative.css",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1,2 @@\n+@import url(\"../cached/styles.css\");\n+@import url(\"absolute.css\");\n\\ No newline at end of file"
        },
        {
            "sha": "84936d1dcb34c78cc805c11a3c6cfb5f297000b5",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/styles.css",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fstyles.css",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fstyles.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fstyles.css?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1 @@\n+@import url(\"cached/other.css\");\n\\ No newline at end of file"
        },
        {
            "sha": "184e2540048e141b35807225829243adbe42b194",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/url.css",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Furl.css",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Furl.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Furl.css?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1 @@\n+@import url(\"https://www.djangoproject.com/m/css/base.css\");\n\\ No newline at end of file"
        },
        {
            "sha": "4d92dbe1adbd164271a00aa96a93dadc9b674aac",
            "filename": "tests/regressiontests/staticfiles_tests/project/site_media/static/testfile.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fsite_media%2Fstatic%2Ftestfile.txt",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fsite_media%2Fstatic%2Ftestfile.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fsite_media%2Fstatic%2Ftestfile.txt?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -0,0 +1 @@\n+Test!\n\\ No newline at end of file"
        },
        {
            "sha": "40569484dfec2429f671547ffc125f1339cd6dd1",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 146,
            "deletions": 47,
            "changes": 193,
            "blob_url": "https://github.com/django/django/blob/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1d32bdd3c9586ff10d0799264105850fa7e3f512/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=1d32bdd3c9586ff10d0799264105850fa7e3f512",
            "patch": "@@ -8,6 +8,7 @@\n import tempfile\n from StringIO import StringIO\n \n+from django.template import loader, Context\n from django.conf import settings\n from django.core.exceptions import ImproperlyConfigured\n from django.core.files.storage import default_storage\n@@ -21,9 +22,25 @@\n from django.contrib.staticfiles import finders, storage\n \n TEST_ROOT = os.path.dirname(__file__)\n+TEST_SETTINGS = {\n+    'DEBUG': True,\n+    'MEDIA_URL': '/media/',\n+    'STATIC_URL': '/static/',\n+    'MEDIA_ROOT': os.path.join(TEST_ROOT, 'project', 'site_media', 'media'),\n+    'STATIC_ROOT': os.path.join(TEST_ROOT, 'project', 'site_media', 'static'),\n+    'STATICFILES_DIRS': (\n+        os.path.join(TEST_ROOT, 'project', 'documents'),\n+        ('prefix', os.path.join(TEST_ROOT, 'project', 'prefixed')),\n+    ),\n+    'STATICFILES_FINDERS': (\n+        'django.contrib.staticfiles.finders.FileSystemFinder',\n+        'django.contrib.staticfiles.finders.AppDirectoriesFinder',\n+        'django.contrib.staticfiles.finders.DefaultStorageFinder',\n+    ),\n+}\n \n \n-class StaticFilesTestCase(TestCase):\n+class BaseStaticFilesTestCase(object):\n     \"\"\"\n     Test case with a couple utility assertions.\n     \"\"\"\n@@ -32,6 +49,7 @@ def setUp(self):\n         # gets accessed (by some other test), it evaluates settings.MEDIA_ROOT,\n         # since we're planning on changing that we need to clear out the cache.\n         default_storage._wrapped = empty\n+        storage.staticfiles_storage._wrapped = empty\n \n         # To make sure SVN doesn't hangs itself with the non-ASCII characters\n         # during checkout, we actually create one file dynamically.\n@@ -48,35 +66,34 @@ def assertFileContains(self, filepath, text):\n     def assertFileNotFound(self, filepath):\n         self.assertRaises(IOError, self._get_file, filepath)\n \n-StaticFilesTestCase = override_settings(\n-    DEBUG = True,\n-    MEDIA_URL = '/media/',\n-    STATIC_URL = '/static/',\n-    MEDIA_ROOT =  os.path.join(TEST_ROOT, 'project', 'site_media', 'media'),\n-    STATIC_ROOT = os.path.join(TEST_ROOT, 'project', 'site_media', 'static'),\n-    STATICFILES_DIRS = (\n-        os.path.join(TEST_ROOT, 'project', 'documents'),\n-        ('prefix', os.path.join(TEST_ROOT, 'project', 'prefixed')),\n-    ),\n-    STATICFILES_FINDERS = (\n-        'django.contrib.staticfiles.finders.FileSystemFinder',\n-        'django.contrib.staticfiles.finders.AppDirectoriesFinder',\n-        'django.contrib.staticfiles.finders.DefaultStorageFinder',\n-    ),\n-)(StaticFilesTestCase)\n+    def render_template(self, template, **kwargs):\n+        if isinstance(template, basestring):\n+            template = loader.get_template_from_string(template)\n+        return template.render(Context(kwargs)).strip()\n+\n+    def assertTemplateRenders(self, template, result, **kwargs):\n+        self.assertEqual(self.render_template(template, **kwargs), result)\n \n+    def assertTemplateRaises(self, exc, template, result, **kwargs):\n+        self.assertRaises(exc, self.assertTemplateRenders, template, result, **kwargs)\n \n-class BuildStaticTestCase(StaticFilesTestCase):\n+\n+class StaticFilesTestCase(BaseStaticFilesTestCase, TestCase):\n+    pass\n+StaticFilesTestCase = override_settings(**TEST_SETTINGS)(StaticFilesTestCase)\n+\n+\n+class BaseCollectionTestCase(BaseStaticFilesTestCase):\n     \"\"\"\n-    Tests shared by all file-resolving features (collectstatic,\n+    Tests shared by all file finding features (collectstatic,\n     findstatic, and static serve view).\n \n     This relies on the asserts defined in UtilityAssertsTestCase, but\n     is separated because some test cases need those asserts without\n     all these tests.\n     \"\"\"\n     def setUp(self):\n-        super(BuildStaticTestCase, self).setUp()\n+        super(BaseCollectionTestCase, self).setUp()\n         self.old_root = settings.STATIC_ROOT\n         settings.STATIC_ROOT = tempfile.mkdtemp()\n         self.run_collectstatic()\n@@ -86,7 +103,7 @@ def setUp(self):\n \n     def tearDown(self):\n         settings.STATIC_ROOT = self.old_root\n-        super(BuildStaticTestCase, self).tearDown()\n+        super(BaseCollectionTestCase, self).tearDown()\n \n     def run_collectstatic(self, **kwargs):\n         call_command('collectstatic', interactive=False, verbosity='0',\n@@ -99,6 +116,10 @@ def _get_file(self, filepath):\n             return f.read()\n \n \n+class CollectionTestCase(BaseCollectionTestCase, StaticFilesTestCase):\n+    pass\n+\n+\n class TestDefaults(object):\n     \"\"\"\n     A few standard test cases.\n@@ -142,7 +163,7 @@ def test_camelcase_filenames(self):\n         self.assertFileContains(u'test/camelCase.txt', u'camelCase')\n \n \n-class TestFindStatic(BuildStaticTestCase, TestDefaults):\n+class TestFindStatic(CollectionTestCase, TestDefaults):\n     \"\"\"\n     Test ``findstatic`` management command.\n     \"\"\"\n@@ -171,12 +192,12 @@ def test_all_files(self):\n             lines = [l.strip() for l in sys.stdout.readlines()]\n         finally:\n             sys.stdout = _stdout\n-        self.assertEqual(len(lines), 3) # three because there is also the \"Found <file> here\" line\n+        self.assertEqual(len(lines), 3)  # three because there is also the \"Found <file> here\" line\n         self.assertTrue('project' in lines[1])\n         self.assertTrue('apps' in lines[2])\n \n \n-class TestBuildStatic(BuildStaticTestCase, TestDefaults):\n+class TestCollection(CollectionTestCase, TestDefaults):\n     \"\"\"\n     Test ``collectstatic`` management command.\n     \"\"\"\n@@ -195,27 +216,27 @@ def test_common_ignore_patterns(self):\n         self.assertFileNotFound('test/CVS')\n \n \n-class TestBuildStaticClear(BuildStaticTestCase):\n+class TestCollectionClear(CollectionTestCase):\n     \"\"\"\n     Test the ``--clear`` option of the ``collectstatic`` managemenet command.\n     \"\"\"\n     def run_collectstatic(self, **kwargs):\n         clear_filepath = os.path.join(settings.STATIC_ROOT, 'cleared.txt')\n         with open(clear_filepath, 'w') as f:\n             f.write('should be cleared')\n-        super(TestBuildStaticClear, self).run_collectstatic(clear=True)\n+        super(TestCollectionClear, self).run_collectstatic(clear=True)\n \n     def test_cleared_not_found(self):\n         self.assertFileNotFound('cleared.txt')\n \n \n-class TestBuildStaticExcludeNoDefaultIgnore(BuildStaticTestCase, TestDefaults):\n+class TestCollectionExcludeNoDefaultIgnore(CollectionTestCase, TestDefaults):\n     \"\"\"\n     Test ``--exclude-dirs`` and ``--no-default-ignore`` options of the\n     ``collectstatic`` management command.\n     \"\"\"\n     def run_collectstatic(self):\n-        super(TestBuildStaticExcludeNoDefaultIgnore, self).run_collectstatic(\n+        super(TestCollectionExcludeNoDefaultIgnore, self).run_collectstatic(\n             use_default_ignore_patterns=False)\n \n     def test_no_common_ignore_patterns(self):\n@@ -238,27 +259,98 @@ def test_no_files_created(self):\n         self.assertEqual(os.listdir(settings.STATIC_ROOT), [])\n \n \n-class TestBuildStaticDryRun(BuildStaticTestCase, TestNoFilesCreated):\n+class TestCollectionDryRun(CollectionTestCase, TestNoFilesCreated):\n     \"\"\"\n     Test ``--dry-run`` option for ``collectstatic`` management command.\n     \"\"\"\n     def run_collectstatic(self):\n-        super(TestBuildStaticDryRun, self).run_collectstatic(dry_run=True)\n+        super(TestCollectionDryRun, self).run_collectstatic(dry_run=True)\n \n \n-class TestBuildStaticNonLocalStorage(BuildStaticTestCase, TestNoFilesCreated):\n+class TestCollectionNonLocalStorage(CollectionTestCase, TestNoFilesCreated):\n     \"\"\"\n     Tests for #15035\n     \"\"\"\n     pass\n \n-TestBuildStaticNonLocalStorage = override_settings(\n+TestCollectionNonLocalStorage = override_settings(\n     STATICFILES_STORAGE='regressiontests.staticfiles_tests.storage.DummyStorage',\n-)(TestBuildStaticNonLocalStorage)\n+)(TestCollectionNonLocalStorage)\n+\n+\n+class TestCollectionCachedStorage(BaseCollectionTestCase,\n+        BaseStaticFilesTestCase, TestCase):\n+    \"\"\"\n+    Tests for the Cache busting storage\n+    \"\"\"\n+    def cached_file_path(self, relpath):\n+        template = \"{%% load static from staticfiles %%}{%% static '%s' %%}\"\n+        fullpath = self.render_template(template % relpath)\n+        return fullpath.replace(settings.STATIC_URL, '')\n+\n+    def test_template_tag_return(self):\n+        \"\"\"\n+        Test the CachedStaticFilesStorage backend.\n+        \"\"\"\n+        self.assertTemplateRaises(ValueError, \"\"\"\n+            {% load static from staticfiles %}{% static \"does/not/exist.png\" %}\n+            \"\"\", \"/static/does/not/exist.png\")\n+        self.assertTemplateRenders(\"\"\"\n+            {% load static from staticfiles %}{% static \"test/file.txt\" %}\n+            \"\"\", \"/static/test/file.dad0999e4f8f.txt\")\n+        self.assertTemplateRenders(\"\"\"\n+            {% load static from staticfiles %}{% static \"cached/styles.css\" %}\n+            \"\"\", \"/static/cached/styles.5653c259030b.css\")\n+\n+    def test_template_tag_simple_content(self):\n+        relpath = self.cached_file_path(\"cached/styles.css\")\n+        self.assertEqual(relpath, \"cached/styles.5653c259030b.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertFalse(\"cached/other.css\" in content, content)\n+            self.assertTrue(\"/static/cached/other.d41d8cd98f00.css\" in content)\n+\n+    def test_template_tag_absolute(self):\n+        relpath = self.cached_file_path(\"cached/absolute.css\")\n+        self.assertEqual(relpath, \"cached/absolute.cc80cb5e2eb1.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertFalse(\"/static/cached/styles.css\" in content)\n+            self.assertTrue(\"/static/cached/styles.5653c259030b.css\" in content)\n+\n+    def test_template_tag_denorm(self):\n+        relpath = self.cached_file_path(\"cached/denorm.css\")\n+        self.assertEqual(relpath, \"cached/denorm.363de96e9b4b.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertFalse(\"..//cached///styles.css\" in content)\n+            self.assertTrue(\"/static/cached/styles.5653c259030b.css\" in content)\n+\n+    def test_template_tag_relative(self):\n+        relpath = self.cached_file_path(\"cached/relative.css\")\n+        self.assertEqual(relpath, \"cached/relative.298ff891a8d4.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertFalse(\"../cached/styles.css\" in content)\n+            self.assertFalse('@import \"styles.css\"' in content)\n+            self.assertTrue(\"/static/cached/styles.5653c259030b.css\" in content)\n+\n+    def test_template_tag_url(self):\n+        relpath = self.cached_file_path(\"cached/url.css\")\n+        self.assertEqual(relpath, \"cached/url.615e21601e4b.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            self.assertTrue(\"https://\" in relfile.read())\n+\n+# we set DEBUG to False here since the template tag wouldn't work otherwise\n+TestCollectionCachedStorage = override_settings(**dict(TEST_SETTINGS,\n+    STATICFILES_STORAGE='django.contrib.staticfiles.storage.CachedStaticFilesStorage',\n+    DEBUG=False,\n+))(TestCollectionCachedStorage)\n \n \n if sys.platform != 'win32':\n-    class TestBuildStaticLinks(BuildStaticTestCase, TestDefaults):\n+\n+    class TestCollectionLinks(CollectionTestCase, TestDefaults):\n         \"\"\"\n         Test ``--link`` option for ``collectstatic`` management command.\n \n@@ -267,7 +359,7 @@ class TestBuildStaticLinks(BuildStaticTestCase, TestDefaults):\n         ``--link`` does not change the file-selection semantics.\n         \"\"\"\n         def run_collectstatic(self):\n-            super(TestBuildStaticLinks, self).run_collectstatic(link=True)\n+            super(TestCollectionLinks, self).run_collectstatic(link=True)\n \n         def test_links_created(self):\n             \"\"\"\n@@ -312,6 +404,7 @@ class TestServeStaticWithDefaultURL(TestServeStatic, TestDefaults):\n     \"\"\"\n     pass\n \n+\n class TestServeStaticWithURLHelper(TestServeStatic, TestDefaults):\n     \"\"\"\n     Test static asset serving view with staticfiles_urlpatterns helper.\n@@ -399,22 +492,28 @@ def test_get_finder(self):\n             finders.FileSystemFinder))\n \n     def test_get_finder_bad_classname(self):\n-        self.assertRaises(ImproperlyConfigured,\n-            finders.get_finder, 'django.contrib.staticfiles.finders.FooBarFinder')\n+        self.assertRaises(ImproperlyConfigured, finders.get_finder,\n+                          'django.contrib.staticfiles.finders.FooBarFinder')\n \n     def test_get_finder_bad_module(self):\n         self.assertRaises(ImproperlyConfigured,\n             finders.get_finder, 'foo.bar.FooBarFinder')\n \n-\n-class TestStaticfilesDirsType(TestCase):\n-    \"\"\"\n-    We can't determine if STATICFILES_DIRS is set correctly just by looking at\n-    the type, but we can determine if it's definitely wrong.\n-    \"\"\"\n     def test_non_tuple_raises_exception(self):\n-        self.assertRaises(ImproperlyConfigured, finders.FileSystemFinder)\n+        \"\"\"\n+        We can't determine if STATICFILES_DIRS is set correctly just by\n+        looking at the type, but we can determine if it's definitely wrong.\n+        \"\"\"\n+        with self.settings(STATICFILES_DIRS='a string'):\n+            self.assertRaises(ImproperlyConfigured, finders.FileSystemFinder)\n+\n+\n+class TestTemplateTag(StaticFilesTestCase):\n \n-TestStaticfilesDirsType = override_settings(\n-    STATICFILES_DIRS = 'a string',\n-)(TestStaticfilesDirsType)\n+    def test_template_tag(self):\n+        self.assertTemplateRenders(\"\"\"\n+            {% load static from staticfiles %}{% static \"does/not/exist.png\" %}\n+            \"\"\", \"/static/does/not/exist.png\")\n+        self.assertTemplateRenders(\"\"\"\n+            {% load static from staticfiles %}{% static \"testfile.txt\" %}\n+            \"\"\", \"/static/testfile.txt\")"
        }
    ],
    "stats": {
        "total": 788,
        "additions": 643,
        "deletions": 145
    }
}