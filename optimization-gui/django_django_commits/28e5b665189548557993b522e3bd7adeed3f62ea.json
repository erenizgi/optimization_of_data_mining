{
    "author": "aaugustin",
    "message": "Fixed #18087 -- Prevented date-based generic views from loading entire tables in memory when pagination is enabled.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17893 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "28e5b665189548557993b522e3bd7adeed3f62ea",
    "files": [
        {
            "sha": "e1daa9f04d0b2a0eb925151fc9633b6ca2de3c93",
            "filename": "django/views/generic/dates.py",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/28e5b665189548557993b522e3bd7adeed3f62ea/django%2Fviews%2Fgeneric%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/28e5b665189548557993b522e3bd7adeed3f62ea/django%2Fviews%2Fgeneric%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Fdates.py?ref=28e5b665189548557993b522e3bd7adeed3f62ea",
            "patch": "@@ -190,14 +190,19 @@ def get_dated_queryset(self, **lookup):\n         date_field = self.get_date_field()\n         allow_future = self.get_allow_future()\n         allow_empty = self.get_allow_empty()\n+        paginate_by = self.get_paginate_by(qs)\n \n         if not allow_future:\n             qs = qs.filter(**{'%s__lte' % date_field: timezone.now()})\n \n-        if not allow_empty and not qs:\n-            raise Http404(_(u\"No %(verbose_name_plural)s available\") % {\n-                    'verbose_name_plural': force_unicode(qs.model._meta.verbose_name_plural)\n-            })\n+        if not allow_empty:\n+            # When pagination is enabled, it's better to do a cheap query\n+            # than to load the unpaginated queryset in memory.\n+            is_empty = not bool(qs) if paginate_by is None else not qs.exists()\n+            if is_empty:\n+                raise Http404(_(u\"No %(verbose_name_plural)s available\") % {\n+                        'verbose_name_plural': force_unicode(qs.model._meta.verbose_name_plural)\n+                })\n \n         return qs\n "
        },
        {
            "sha": "9de817acc2c59a66163086818ea630c0d0d61db4",
            "filename": "tests/regressiontests/generic_views/dates.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/28e5b665189548557993b522e3bd7adeed3f62ea/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/28e5b665189548557993b522e3bd7adeed3f62ea/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py?ref=28e5b665189548557993b522e3bd7adeed3f62ea",
            "patch": "@@ -78,6 +78,15 @@ def test_paginated_archive_view(self):\n         self.assertEqual(res.context['page_obj'].number, 2)\n         self.assertEqual(list(res.context['latest']), list(Book.objects.all()[10:20]))\n \n+    def test_paginated_archive_view_does_not_load_entire_table(self):\n+        # Regression test for #18087\n+        self._make_books(20, base_date=datetime.date.today())\n+        # 1 query for years list + 1 query for books\n+        with self.assertNumQueries(2):\n+            self.client.get('/dates/books/')\n+        # same as above + 1 query to test if books exist\n+        with self.assertNumQueries(3):\n+            self.client.get('/dates/books/paginated/')\n \n class YearArchiveViewTests(TestCase):\n     fixtures = ['generic-views-test-data.json']"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 18,
        "deletions": 4
    }
}