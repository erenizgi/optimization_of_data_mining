{
    "author": "andrewgodwin",
    "message": "Fixed #9029 -- Allow use of fieldname_id with get_or_create. Thanks to aaron and mrmachine.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15156 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "81e05a418dc6f347d9627373288e773c477a9fe0",
    "files": [
        {
            "sha": "5395af233109f38c8227d4f42926ffde85b35011",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/81e05a418dc6f347d9627373288e773c477a9fe0/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/81e05a418dc6f347d9627373288e773c477a9fe0/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=81e05a418dc6f347d9627373288e773c477a9fe0",
            "patch": "@@ -369,9 +369,13 @@ def get_or_create(self, **kwargs):\n         assert kwargs, \\\n                 'get_or_create() must be passed at least one keyword argument'\n         defaults = kwargs.pop('defaults', {})\n+        lookup = kwargs.copy()\n+        for f in self.model._meta.fields:\n+            if f.column in lookup:\n+                lookup[f.name] = lookup.pop(f.column)\n         try:\n             self._for_write = True\n-            return self.get(**kwargs), False\n+            return self.get(**lookup), False\n         except self.model.DoesNotExist:\n             try:\n                 params = dict([(k, v) for k, v in kwargs.items() if '__' not in k])\n@@ -384,7 +388,7 @@ def get_or_create(self, **kwargs):\n             except IntegrityError, e:\n                 transaction.savepoint_rollback(sid, using=self.db)\n                 try:\n-                    return self.get(**kwargs), False\n+                    return self.get(**lookup), False\n                 except self.model.DoesNotExist:\n                     raise e\n "
        },
        {
            "sha": "e825fccc4b619b59f45148d2d1af18a88edb911b",
            "filename": "tests/regressiontests/get_or_create_regress/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/81e05a418dc6f347d9627373288e773c477a9fe0/tests%2Fregressiontests%2Fget_or_create_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/81e05a418dc6f347d9627373288e773c477a9fe0/tests%2Fregressiontests%2Fget_or_create_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fget_or_create_regress%2Ftests.py?ref=81e05a418dc6f347d9627373288e773c477a9fe0",
            "patch": "@@ -21,7 +21,7 @@ def test_related(self):\n         # Add an author to the book.\n         ed, created = book.authors.get_or_create(name=\"Ed\")\n         self.assertTrue(created)\n-        # Book should have one author.\n+        # The book should have one author.\n         self.assertEqual(book.authors.count(), 1)\n \n         # Try get_or_create again, this time nothing should be created.\n@@ -51,3 +51,12 @@ def test_related(self):\n         # Now Ed has two Books, Fred just one.\n         self.assertEqual(ed.books.count(), 2)\n         self.assertEqual(fred.books.count(), 1)\n+\n+        # Use the publisher's primary key value instead of a model instance.\n+        _, created = ed.books.get_or_create(name='The Great Book of Ed', publisher_id=p.id)\n+        self.assertTrue(created)\n+        # Try get_or_create again, this time nothing should be created.\n+        _, created = ed.books.get_or_create(name='The Great Book of Ed', publisher_id=p.id)\n+        self.assertFalse(created)\n+        # The publisher should have three books.\n+        self.assertEqual(p.books.count(), 3)"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 16,
        "deletions": 3
    }
}