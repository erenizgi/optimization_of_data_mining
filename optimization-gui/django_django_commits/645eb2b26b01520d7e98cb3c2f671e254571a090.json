{
    "author": "jezdez",
    "message": "Stopped staticfiles app from requiring a models module when looking for static files. Also removed a bit of code smell in the prefix handling by saving it in the source file storage.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15219 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "645eb2b26b01520d7e98cb3c2f671e254571a090",
    "files": [
        {
            "sha": "ce51b475e9ff3a55b452e22c167c202713e0c594",
            "filename": "django/contrib/staticfiles/finders.py",
            "status": "modified",
            "additions": 33,
            "deletions": 28,
            "changes": 61,
            "blob_url": "https://github.com/django/django/blob/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "raw_url": "https://github.com/django/django/raw/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Ffinders.py?ref=645eb2b26b01520d7e98cb3c2f671e254571a090",
            "patch": "@@ -55,7 +55,9 @@ def __init__(self, apps=None, *args, **kwargs):\n             self.locations.add((prefix, root))\n         # Don't initialize multiple storages for the same location\n         for prefix, root in self.locations:\n-            self.storages[root] = FileSystemStorage(location=root)\n+            filesystem_storage = FileSystemStorage(location=root)\n+            filesystem_storage.prefix = prefix\n+            self.storages[root] = filesystem_storage\n \n         super(FileSystemFinder, self).__init__(*args, **kwargs)\n \n@@ -94,7 +96,7 @@ def list(self, ignore_patterns):\n         for prefix, root in self.locations:\n             storage = self.storages[root]\n             for path in utils.get_files(storage, ignore_patterns):\n-                yield path, prefix, storage\n+                yield path, storage\n \n \n class AppDirectoriesFinder(BaseFinder):\n@@ -105,14 +107,18 @@ class AppDirectoriesFinder(BaseFinder):\n     storage_class = AppStaticStorage\n \n     def __init__(self, apps=None, *args, **kwargs):\n-        # Maps app modules to appropriate storage instances\n+        # The list of apps that are handled\n+        self.apps = []\n+        # Mapping of app module paths to storage instances\n         self.storages = SortedDict()\n-        if apps is not None:\n-            self.apps = apps\n-        else:\n-            self.apps = models.get_apps()\n-        for app in self.apps:\n-            self.storages[app] = self.storage_class(app)\n+        if apps is None:\n+            apps = settings.INSTALLED_APPS\n+        for app in apps:\n+            app_storage = self.storage_class(app)\n+            if os.path.isdir(app_storage.location):\n+                self.storages[app] = app_storage\n+                if app not in self.apps:\n+                    self.apps.append(app)\n         super(AppDirectoriesFinder, self).__init__(*args, **kwargs)\n \n     def list(self, ignore_patterns):\n@@ -121,39 +127,38 @@ def list(self, ignore_patterns):\n         \"\"\"\n         for storage in self.storages.itervalues():\n             if storage.exists(''): # check if storage location exists\n-                prefix = storage.get_prefix()\n                 for path in utils.get_files(storage, ignore_patterns):\n-                    yield path, prefix, storage\n+                    yield path, storage\n \n     def find(self, path, all=False):\n         \"\"\"\n         Looks for files in the app directories.\n         \"\"\"\n         matches = []\n         for app in self.apps:\n-            app_matches = self.find_in_app(app, path)\n-            if app_matches:\n+            match = self.find_in_app(app, path)\n+            if match:\n                 if not all:\n-                    return app_matches\n-                matches.append(app_matches)\n+                    return match\n+                matches.append(match)\n         return matches\n \n     def find_in_app(self, app, path):\n         \"\"\"\n         Find a requested static file in an app's static locations.\n         \"\"\"\n-        storage = self.storages[app]\n-        prefix = storage.get_prefix()\n-        if prefix:\n-            prefix = '%s%s' % (prefix, os.sep)\n-            if not path.startswith(prefix):\n-                return None\n-            path = path[len(prefix):]\n-        # only try to find a file if the source dir actually exists\n-        if storage.exists(path):\n-            matched_path = storage.path(path)\n-            if matched_path:\n-                return matched_path\n+        storage = self.storages.get(app, None)\n+        if storage:\n+            if storage.prefix:\n+                prefix = '%s%s' % (storage.prefix, os.sep)\n+                if not path.startswith(prefix):\n+                    return None\n+                path = path[len(prefix):]\n+            # only try to find a file if the source dir actually exists\n+            if storage.exists(path):\n+                matched_path = storage.path(path)\n+                if matched_path:\n+                    return matched_path\n \n \n class BaseStorageFinder(BaseFinder):\n@@ -196,7 +201,7 @@ def list(self, ignore_patterns):\n         List all files of the storage.\n         \"\"\"\n         for path in utils.get_files(self.storage, ignore_patterns):\n-            yield path, '', self.storage\n+            yield path, self.storage\n \n class DefaultStorageFinder(BaseStorageFinder):\n     \"\"\""
        },
        {
            "sha": "c7c98f6a395cef97f03aea9cdf58c282be535d76",
            "filename": "django/contrib/staticfiles/management/commands/collectstatic.py",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "raw_url": "https://github.com/django/django/raw/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py?ref=645eb2b26b01520d7e98cb3c2f671e254571a090",
            "patch": "@@ -75,8 +75,8 @@ def handle_noargs(self, **options):\n                 raise CommandError(\"Collecting static files cancelled.\")\n \n         for finder in finders.get_finders():\n-            for source, prefix, storage in finder.list(ignore_patterns):\n-                self.copy_file(source, prefix, storage, **options)\n+            for source, storage in finder.list(ignore_patterns):\n+                self.copy_file(source, storage, **options)\n \n         actual_count = len(self.copied_files) + len(self.symlinked_files)\n         unmodified_count = len(self.unmodified_files)\n@@ -97,7 +97,7 @@ def log(self, msg, level=2):\n         if self.verbosity >= level:\n             self.stdout.write(msg)\n \n-    def copy_file(self, source, prefix, source_storage, **options):\n+    def copy_file(self, source, source_storage, **options):\n         \"\"\"\n         Attempt to copy (or symlink) ``source`` to ``destination``,\n         returning True if successful.\n@@ -107,8 +107,8 @@ def copy_file(self, source, prefix, source_storage, **options):\n             source_last_modified = source_storage.modified_time(source)\n         except (OSError, NotImplementedError):\n             source_last_modified = None\n-        if prefix:\n-            destination = os.path.join(prefix, source)\n+        if getattr(source_storage, 'prefix', None):\n+            destination = os.path.join(source_storage.prefix, source)\n         else:\n             destination = source\n         symlink = options['link']"
        },
        {
            "sha": "d93b7e052a943187e914b63362fbe9a06814947c",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 11,
            "deletions": 39,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=645eb2b26b01520d7e98cb3c2f671e254571a090",
            "patch": "@@ -38,50 +38,22 @@ class AppStaticStorage(FileSystemStorage):\n     A file system storage backend that takes an app module and works\n     for the ``static`` directory of it.\n     \"\"\"\n+    prefix = None\n     source_dir = 'static'\n \n     def __init__(self, app, *args, **kwargs):\n         \"\"\"\n         Returns a static file storage if available in the given app.\n         \"\"\"\n-        # app is actually the models module of the app. Remove the '.models'.\n-        bits = app.__name__.split('.')[:-1]\n-        self.app_name = bits[-1]\n-        self.app_module = '.'.join(bits)\n-        # The models module (app) may be a package in which case\n-        # dirname(app.__file__) would be wrong. Import the actual app\n-        # as opposed to the models module.\n-        app = import_module(self.app_module)\n-        location = self.get_location(os.path.dirname(app.__file__))\n-        super(AppStaticStorage, self).__init__(location, *args, **kwargs)\n-\n-    def get_location(self, app_root):\n-        \"\"\"\n-        Given the app root, return the location of the static files of an app,\n-        by default 'static'. We special case the admin app here since it has\n-        its static files in 'media'.\n-        \"\"\"\n+        # app is the actual app module\n+        self.app_module = app\n+        # We special case the admin app here since it has its static files\n+        # in 'media' for historic reasons.\n         if self.app_module == 'django.contrib.admin':\n-            return os.path.join(app_root, 'media')\n-        return os.path.join(app_root, self.source_dir)\n-\n-    def get_prefix(self):\n-        \"\"\"\n-        Return the path name that should be prepended to files for this app.\n-        \"\"\"\n-        if self.app_module == 'django.contrib.admin':\n-            return self.app_name\n-        return None\n+            self.prefix = 'admin'\n+            self.source_dir = 'media'\n+        mod = import_module(self.app_module)\n+        mod_path = os.path.dirname(mod.__file__)\n+        location = os.path.join(mod_path, self.source_dir)\n+        super(AppStaticStorage, self).__init__(location, *args, **kwargs)\n \n-    def get_files(self, ignore_patterns=[]):\n-        \"\"\"\n-        Return a list containing the relative source paths for all files that\n-        should be copied for an app.\n-        \"\"\"\n-        files = []\n-        prefix = self.get_prefix()\n-        for path in utils.get_files(self, ignore_patterns):\n-            if prefix:\n-                path = os.path.join(prefix, path)\n-            files.append(path)\n-        return files"
        },
        {
            "sha": "e7598d4aa5d1468a08945a3ae77ee3205c96b051",
            "filename": "django/contrib/staticfiles/utils.py",
            "status": "modified",
            "additions": 21,
            "deletions": 18,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/645eb2b26b01520d7e98cb3c2f671e254571a090/django%2Fcontrib%2Fstaticfiles%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Futils.py?ref=645eb2b26b01520d7e98cb3c2f671e254571a090",
            "patch": "@@ -3,32 +3,35 @@\n from django.conf import settings\n from django.core.exceptions import ImproperlyConfigured\n \n-def get_files(storage, ignore_patterns=[], location=''):\n+def is_ignored(path, ignore_patterns=[]):\n     \"\"\"\n-    Recursively walk the storage directories gathering a complete\n-    list of files that should be copied, returning this list.\n+    Return True or False depending on whether the ``path`` should be\n+    ignored (if it matches any pattern in ``ignore_patterns``).\n     \"\"\"\n-    def is_ignored(path):\n-        \"\"\"\n-        Return True or False depending on whether the ``path`` should be\n-        ignored (if it matches any pattern in ``ignore_patterns``).\n-        \"\"\"\n-        for pattern in ignore_patterns:\n-            if fnmatch.fnmatchcase(path, pattern):\n-                return True\n-        return False\n+    for pattern in ignore_patterns:\n+        if fnmatch.fnmatchcase(path, pattern):\n+            return True\n+    return False\n \n+def get_files(storage, ignore_patterns=[], location=''):\n+    \"\"\"\n+    Recursively walk the storage directories yielding the paths\n+    of all files that should be copied.\n+    \"\"\"\n     directories, files = storage.listdir(location)\n-    static_files = [location and os.path.join(location, fn) or fn\n-                    for fn in files\n-                    if not is_ignored(fn)]\n+    for fn in files:\n+        if is_ignored(fn, ignore_patterns):\n+            continue\n+        if location:\n+            fn = os.path.join(location, fn)\n+        yield fn\n     for dir in directories:\n-        if is_ignored(dir):\n+        if is_ignored(dir, ignore_patterns):\n             continue\n         if location:\n             dir = os.path.join(location, dir)\n-        static_files.extend(get_files(storage, ignore_patterns, dir))\n-    return static_files\n+        for fn in get_files(storage, ignore_patterns, dir):\n+            yield fn\n \n def check_settings():\n     \"\"\""
        },
        {
            "sha": "3eff2aabb47530ac36d773cea0edac6fb2a5353e",
            "filename": "docs/ref/contrib/staticfiles.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/645eb2b26b01520d7e98cb3c2f671e254571a090/docs%2Fref%2Fcontrib%2Fstaticfiles.txt",
            "raw_url": "https://github.com/django/django/raw/645eb2b26b01520d7e98cb3c2f671e254571a090/docs%2Fref%2Fcontrib%2Fstaticfiles.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fstaticfiles.txt?ref=645eb2b26b01520d7e98cb3c2f671e254571a090",
            "patch": "@@ -103,9 +103,8 @@ setting.\n \n .. note::\n \n-    When using the :class:`AppDirectoriesFinder` finder, make sure your apps can\n-    be found by Django's app loading mechanism. Simply include a ``models``\n-    module (an empty ``models.py`` file suffices) and add the app to the\n+    When using the :class:`AppDirectoriesFinder` finder, make sure your apps\n+    can be found by staticfiles. Simply add the app to the\n     :setting:`INSTALLED_APPS` setting of your site.\n \n Static file finders are currently considered a private interface, and this"
        },
        {
            "sha": "ea1f6d2954c41664abc8fabd758bebde25fbfab3",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/645eb2b26b01520d7e98cb3c2f671e254571a090/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/645eb2b26b01520d7e98cb3c2f671e254571a090/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=645eb2b26b01520d7e98cb3c2f671e254571a090",
            "patch": "@@ -34,9 +34,6 @@ def setUp(self):\n         self.old_debug = settings.DEBUG\n         self.old_installed_apps = settings.INSTALLED_APPS\n \n-        # We have to load these apps to test staticfiles.\n-        load_app('regressiontests.staticfiles_tests.apps.test')\n-        load_app('regressiontests.staticfiles_tests.apps.no_label')\n         site_media = os.path.join(TEST_ROOT, 'project', 'site_media')\n         settings.DEBUG = True\n         settings.MEDIA_ROOT =  os.path.join(site_media, 'media')\n@@ -53,8 +50,11 @@ def setUp(self):\n             'django.contrib.staticfiles.finders.DefaultStorageFinder',\n         )\n         settings.INSTALLED_APPS = [\n+            'django.contrib.admin',\n             'django.contrib.staticfiles',\n             'regressiontests.staticfiles_tests',\n+            'regressiontests.staticfiles_tests.apps.test',\n+            'regressiontests.staticfiles_tests.apps.no_label',\n         ]\n \n         # Clear the cached default_storage out, this is because when it first"
        }
    ],
    "stats": {
        "total": 171,
        "additions": 75,
        "deletions": 96
    }
}