{
    "author": "akaariai",
    "message": "Fixed some locations to work with autocommit=True\n\n - backends: supports_transactions()\n - select_for_update tests",
    "sha": "da573fbb4172fb962c9f021fc0c03cf91b13e746",
    "files": [
        {
            "sha": "dab9b7e213ec5700e201225c9b63aae945dcc217",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 18,
            "deletions": 9,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/da573fbb4172fb962c9f021fc0c03cf91b13e746/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/da573fbb4172fb962c9f021fc0c03cf91b13e746/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=da573fbb4172fb962c9f021fc0c03cf91b13e746",
            "patch": "@@ -417,15 +417,24 @@ def __init__(self, connection):\n     @cached_property\n     def supports_transactions(self):\n         \"Confirm support for transactions\"\n-        cursor = self.connection.cursor()\n-        cursor.execute('CREATE TABLE ROLLBACK_TEST (X INT)')\n-        self.connection._commit()\n-        cursor.execute('INSERT INTO ROLLBACK_TEST (X) VALUES (8)')\n-        self.connection._rollback()\n-        cursor.execute('SELECT COUNT(X) FROM ROLLBACK_TEST')\n-        count, = cursor.fetchone()\n-        cursor.execute('DROP TABLE ROLLBACK_TEST')\n-        self.connection._commit()\n+        try:\n+            # Make sure to run inside a managed transaction block,\n+            # otherwise autocommit will cause the confimation to\n+            # fail.\n+            self.connection.enter_transaction_management()\n+            self.connection.managed(True)\n+            cursor = self.connection.cursor()\n+            cursor.execute('CREATE TABLE ROLLBACK_TEST (X INT)')\n+            self.connection._commit()\n+            cursor.execute('INSERT INTO ROLLBACK_TEST (X) VALUES (8)')\n+            self.connection._rollback()\n+            cursor.execute('SELECT COUNT(X) FROM ROLLBACK_TEST')\n+            count, = cursor.fetchone()\n+            cursor.execute('DROP TABLE ROLLBACK_TEST')\n+            self.connection._commit()\n+            self.connection._dirty = False\n+        finally:\n+            self.connection.leave_transaction_management()\n         return count == 0\n \n     @cached_property"
        },
        {
            "sha": "cb8f19f1e825e343d7c6c11f6fc6164672df3106",
            "filename": "tests/modeltests/select_for_update/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/da573fbb4172fb962c9f021fc0c03cf91b13e746/tests%2Fmodeltests%2Fselect_for_update%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/da573fbb4172fb962c9f021fc0c03cf91b13e746/tests%2Fmodeltests%2Fselect_for_update%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fselect_for_update%2Ftests.py?ref=da573fbb4172fb962c9f021fc0c03cf91b13e746",
            "patch": "@@ -36,6 +36,8 @@ def setUp(self):\n         # issuing a SELECT ... FOR UPDATE will block.\n         new_connections = ConnectionHandler(settings.DATABASES)\n         self.new_connection = new_connections[DEFAULT_DB_ALIAS]\n+        self.new_connection.enter_transaction_management()\n+        self.new_connection.managed(True)\n \n         # We need to set settings.DEBUG to True so we can capture\n         # the output SQL to examine.\n@@ -48,6 +50,7 @@ def tearDown(self):\n             # this in the course of their run.\n             transaction.managed(False)\n             transaction.leave_transaction_management()\n+            self.new_connection.leave_transaction_management()\n         except transaction.TransactionManagementError:\n             pass\n         self.new_connection.close()\n@@ -66,7 +69,7 @@ def start_blocking_transaction(self):\n             'for_update': self.new_connection.ops.for_update_sql(),\n             }\n         self.cursor.execute(sql, ())\n-        result = self.cursor.fetchone()\n+        self.cursor.fetchone()\n \n     def end_blocking_transaction(self):\n         # Roll back the blocking transaction."
        }
    ],
    "stats": {
        "total": 32,
        "additions": 22,
        "deletions": 10
    }
}