{
    "author": "freakboy3742",
    "message": "Altered the behavior of URLField to avoid a potential DOS vector, and to avoid potential leakage of local filesystem data. A security announcement will be made shortly.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16760 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
    "files": [
        {
            "sha": "d51949308f1a4ac38bb520b40fae55ce2a15499d",
            "filename": "django/core/validators.py",
            "status": "modified",
            "additions": 39,
            "deletions": 18,
            "changes": 57,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/django%2Fcore%2Fvalidators.py",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/django%2Fcore%2Fvalidators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fvalidators.py?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -1,3 +1,4 @@\n+import platform\n import re\n import urllib2\n import urlparse\n@@ -41,10 +42,6 @@ def __call__(self, value):\n         if not self.regex.search(smart_unicode(value)):\n             raise ValidationError(self.message, code=self.code)\n \n-class HeadRequest(urllib2.Request):\n-    def get_method(self):\n-        return \"HEAD\"\n-\n class URLValidator(RegexValidator):\n     regex = re.compile(\n         r'^(?:http|ftp)s?://' # http:// or https://\n@@ -54,7 +51,8 @@ class URLValidator(RegexValidator):\n         r'(?::\\d+)?' # optional port\n         r'(?:/?|[/?]\\S+)$', re.IGNORECASE)\n \n-    def __init__(self, verify_exists=False, validator_user_agent=URL_VALIDATOR_USER_AGENT):\n+    def __init__(self, verify_exists=False, \n+                 validator_user_agent=URL_VALIDATOR_USER_AGENT):\n         super(URLValidator, self).__init__()\n         self.verify_exists = verify_exists\n         self.user_agent = validator_user_agent\n@@ -79,6 +77,13 @@ def __call__(self, value):\n             url = value\n \n         if self.verify_exists:\n+            import warnings\n+            warnings.warn(\n+                \"The URLField verify_exists argument has intractable security \"\n+                \"and performance issues. Accordingly, it has been deprecated.\",\n+                DeprecationWarning\n+                )\n+\n             headers = {\n                 \"Accept\": \"text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\",\n                 \"Accept-Language\": \"en-us,en;q=0.5\",\n@@ -90,21 +95,37 @@ def __call__(self, value):\n             broken_error = ValidationError(\n                 _(u'This URL appears to be a broken link.'), code='invalid_link')\n             try:\n-                req = HeadRequest(url, None, headers)\n-                u = urllib2.urlopen(req)\n+                req = urllib2.Request(url, None, headers)\n+                req.get_method = lambda: 'HEAD'\n+                #Create an opener that does not support local file access\n+                opener = urllib2.OpenerDirector()\n+                \n+                #Don't follow redirects, but don't treat them as errors either\n+                error_nop = lambda *args, **kwargs: True\n+                http_error_processor = urllib2.HTTPErrorProcessor()\n+                http_error_processor.http_error_301 = error_nop\n+                http_error_processor.http_error_302 = error_nop\n+                http_error_processor.http_error_307 = error_nop\n+\n+                handlers = [urllib2.UnknownHandler(),\n+                            urllib2.HTTPHandler(),\n+                            urllib2.HTTPDefaultErrorHandler(),\n+                            urllib2.FTPHandler(),\n+                            http_error_processor]\n+                try:\n+                    import ssl\n+                    handlers.append(urllib2.HTTPSHandler())\n+                except:\n+                    #Python isn't compiled with SSL support\n+                    pass\n+                map(opener.add_handler, handlers)\n+                opener.http_error_301 = lambda: True\n+                if platform.python_version_tuple() >= (2, 6):\n+                    opener.open(req, timeout=10)\n+                else:\n+                    opener.open(req)\n             except ValueError:\n                 raise ValidationError(_(u'Enter a valid URL.'), code='invalid')\n-            except urllib2.HTTPError, e:\n-                if e.code in (405, 501):\n-                    # Try a GET request (HEAD refused)\n-                    # See also: http://www.w3.org/Protocols/rfc2616/rfc2616.html\n-                    try:\n-                        req = urllib2.Request(url, None, headers)\n-                        u = urllib2.urlopen(req)\n-                    except:\n-                        raise broken_error\n-                else:\n-                    raise broken_error\n             except: # urllib2.URLError, httplib.InvalidURL, etc.\n                 raise broken_error\n "
        },
        {
            "sha": "0c684285e3e38d9e60f034a5721da9e757486211",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -1178,7 +1178,7 @@ def formfield(self, **kwargs):\n class URLField(CharField):\n     description = _(\"URL\")\n \n-    def __init__(self, verbose_name=None, name=None, verify_exists=True, **kwargs):\n+    def __init__(self, verbose_name=None, name=None, verify_exists=False, **kwargs):\n         kwargs['max_length'] = kwargs.get('max_length', 200)\n         CharField.__init__(self, verbose_name, name, **kwargs)\n         self.validators.append(validators.URLValidator(verify_exists=verify_exists))"
        },
        {
            "sha": "8d5baaf4073ab85baa1c9dc63486b61f694dfb77",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -115,6 +115,11 @@ their deprecation, as per the :ref:`deprecation policy\n       beyond that of a simple ``TextField`` since the removal of oldforms.\n       All uses of ``XMLField`` can be replaced with ``TextField``.\n \n+    * ``django.db.models.fields.URLField.verify_exists`` has been\n+      deprecated due to intractable security and performance\n+      issues. Validation behavior has been removed in 1.4, and the\n+      argument will be removed in 1.5.\n+\n 1.5\n ---\n "
        },
        {
            "sha": "437610384e2b43fb9d2bdaa1a1f4a3e7007af010",
            "filename": "docs/ref/forms/fields.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Fref%2Fforms%2Ffields.txt",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Fref%2Fforms%2Ffields.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fforms%2Ffields.txt?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -799,6 +799,11 @@ Takes the following optional arguments:\n     If ``True``, the validator will attempt to load the given URL, raising\n     ``ValidationError`` if the page gives a 404. Defaults to ``False``.\n \n+.. deprecated:: 1.3.1\n+\n+   ``verify_exists`` was deprecated for security reasons and will be\n+   removed in 1.4. This deprecation also removes ``validator_user_agent``.\n+\n .. attribute:: URLField.validator_user_agent\n \n     String used as the user-agent used when checking for a URL's existence."
        },
        {
            "sha": "8b5c0db7f594628794f709d0b2fb9a9e5a0ba2fa",
            "filename": "docs/ref/models/fields.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Fref%2Fmodels%2Ffields.txt",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Fref%2Fmodels%2Ffields.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Ffields.txt?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -872,14 +872,21 @@ shortcuts.\n ``URLField``\n ------------\n \n-.. class:: URLField([verify_exists=True, max_length=200, **options])\n+.. class:: URLField([verify_exists=False, max_length=200, **options])\n \n A :class:`CharField` for a URL. Has one extra optional argument:\n \n+.. deprecated:: 1.3.1 \n+\n+   ``verify_exists`` is deprecated for security reasons as of 1.3.1\n+   and will be removed in 1.4. Prior to 1.3.1, the default value was\n+   ``True``.\n+\n .. attribute:: URLField.verify_exists\n \n-    If ``True`` (the default), the URL given will be checked for existence\n-    (i.e., the URL actually loads and doesn't give a 404 response).\n+    If ``True``, the URL given will be checked for existence (i.e.,\n+    the URL actually loads and doesn't give a 404 response) using a\n+    ``HEAD`` request. Redirects are allowed, but will not be followed.\n \n     Note that when you're using the single-threaded development server,\n     validating a URL being served by the same server will hang. This should not"
        },
        {
            "sha": "f23a187bf23c2724c20e158536f9e047547dd411",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -2012,8 +2012,10 @@ URL_VALIDATOR_USER_AGENT\n \n Default: ``Django/<version> (http://www.djangoproject.com/)``\n \n-The string to use as the ``User-Agent`` header when checking to see if URLs\n-exist (see the ``verify_exists`` option on :class:`~django.db.models.URLField`).\n+The string to use as the ``User-Agent`` header when checking to see if\n+URLs exist (see the ``verify_exists`` option on\n+:class:`~django.db.models.URLField`). This setting was deprecated in\n+1.3.1 along with ``verify_exists`` and will be removed in 1.4.\n \n .. setting:: USE_ETAGS\n "
        },
        {
            "sha": "f078ee0dfd3f1930a0982c6ea9446f94ba808611",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -519,6 +519,14 @@ This was an alias to ``django.template.loader`` since 2005, it has been removed\n without emitting a warning due to the length of the deprecation. If your code\n still referenced this please use ``django.template.loader`` instead.\n \n+``django.db.models.fields.URLField.verify_exists``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+This functionality has been removed due to intractable performance and\n+security issues. Any existing usage of ``verify_exists`` should be\n+removed.\n+\n+\n .. _deprecated-features-1.4:\n \n Features deprecated in 1.4"
        },
        {
            "sha": "31c5000ba69f6ffe85b1fd59794fbf0c4ea9289d",
            "filename": "tests/modeltests/validation/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fmodeltests%2Fvalidation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fmodeltests%2Fvalidation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2F__init__.py?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -1,8 +1,8 @@\n-from django.utils import unittest\n+from django.test import TestCase\n \n from django.core.exceptions import ValidationError\n \n-class ValidationTestCase(unittest.TestCase):\n+class ValidationTestCase(TestCase):\n     def assertFailsValidation(self, clean, failed_fields):\n         self.assertRaises(ValidationError, clean)\n         try:"
        },
        {
            "sha": "fca2cef261f44e6705085428ac581105ed87cb6f",
            "filename": "tests/modeltests/validation/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fmodeltests%2Fvalidation%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fmodeltests%2Fvalidation%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Fmodels.py?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -14,6 +14,7 @@ class ModelToValidate(models.Model):\n     parent = models.ForeignKey('self', blank=True, null=True, limit_choices_to={'number': 10})\n     email = models.EmailField(blank=True)\n     url = models.URLField(blank=True)\n+    url_verify = models.URLField(blank=True, verify_exists=True)\n     f_with_custom_validator = models.IntegerField(blank=True, null=True, validators=[validate_answer_to_universe])\n \n     def clean(self):"
        },
        {
            "sha": "e6e5d97971e0d852ed544aa9d019b34da065f5e4",
            "filename": "tests/modeltests/validation/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 13,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fmodeltests%2Fvalidation%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fmodeltests%2Fvalidation%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Ftests.py?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -1,3 +1,5 @@\n+import warnings\n+\n from django import forms\n from django.test import TestCase\n from django.core.exceptions import NON_FIELD_ERRORS\n@@ -14,6 +16,14 @@\n \n class BaseModelValidationTests(ValidationTestCase):\n \n+    def setUp(self):\n+        self.save_warnings_state()\n+        warnings.filterwarnings('ignore', category=DeprecationWarning,\n+                                module='django.core.validators')\n+\n+    def tearDown(self):\n+        self.restore_warnings_state()\n+\n     def test_missing_required_field_raises_error(self):\n         mtv = ModelToValidate(f_with_custom_validator=42)\n         self.assertFailsValidation(mtv.full_clean, ['name', 'number'])\n@@ -54,25 +64,22 @@ def test_wrong_url_value_raises_error(self):\n         mtv = ModelToValidate(number=10, name='Some Name', url='not a url')\n         self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url', [u'Enter a valid value.'])\n \n+    #The tests below which use url_verify are deprecated\n     def test_correct_url_but_nonexisting_gives_404(self):\n-        mtv = ModelToValidate(number=10, name='Some Name', url='http://google.com/we-love-microsoft.html')\n-        self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url', [u'This URL appears to be a broken link.'])\n+        mtv = ModelToValidate(number=10, name='Some Name', url_verify='http://qa-dev.w3.org/link-testsuite/http.php?code=404')\n+        self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url_verify', [u'This URL appears to be a broken link.'])\n \n     def test_correct_url_value_passes(self):\n-        mtv = ModelToValidate(number=10, name='Some Name', url='http://www.example.com/')\n+        mtv = ModelToValidate(number=10, name='Some Name', url_verify='http://www.google.com/')\n         self.assertEqual(None, mtv.full_clean()) # This will fail if there's no Internet connection\n \n-    def test_correct_https_url_but_nonexisting(self):\n-        mtv = ModelToValidate(number=10, name='Some Name', url='https://www.example.com/')\n-        self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url', [u'This URL appears to be a broken link.'])\n-\n-    def test_correct_ftp_url_but_nonexisting(self):\n-        mtv = ModelToValidate(number=10, name='Some Name', url='ftp://ftp.google.com/we-love-microsoft.html')\n-        self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url', [u'This URL appears to be a broken link.'])\n+    def test_correct_url_with_redirect(self):\n+        mtv = ModelToValidate(number=10, name='Some Name', url_verify='http://qa-dev.w3.org/link-testsuite/http.php?code=301') #example.com is a redirect to iana.org now\n+        self.assertEqual(None, mtv.full_clean()) # This will fail if there's no Internet connection\n \n-    def test_correct_ftps_url_but_nonexisting(self):\n-        mtv = ModelToValidate(number=10, name='Some Name', url='ftps://ftp.google.com/we-love-microsoft.html')\n-        self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url', [u'This URL appears to be a broken link.'])\n+    def test_correct_https_url_but_nonexisting(self):\n+        mtv = ModelToValidate(number=10, name='Some Name', url_verify='https://www.example.com/')\n+        self.assertFieldFailsValidationWithMessage(mtv.full_clean, 'url_verify', [u'This URL appears to be a broken link.'])\n \n     def test_text_greater_that_charfields_max_length_raises_erros(self):\n         mtv = ModelToValidate(number=10, name='Some Name'*100)"
        },
        {
            "sha": "d37ad5ee58d803b50852e96da9555d2047f6c556",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/5f287f75f2277ba821dcf5c444ab12d8eff6cce3/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=5f287f75f2277ba821dcf5c444ab12d8eff6cce3",
            "patch": "@@ -28,6 +28,7 @@\n import re\n import os\n import urllib2\n+import warnings\n from decimal import Decimal\n from functools import wraps\n \n@@ -71,6 +72,14 @@ def urlopen(req):\n \n class FieldsTests(SimpleTestCase):\n \n+    def setUp(self):\n+        self.save_warnings_state()\n+        warnings.filterwarnings('ignore', category=DeprecationWarning,\n+                                module='django.core.validators')\n+\n+    def tearDown(self):\n+        self.restore_warnings_state()\n+\n     def test_field_sets_widget_is_required(self):\n         self.assertTrue(Field(required=True).widget.is_required)\n         self.assertFalse(Field(required=False).widget.is_required)\n@@ -622,7 +631,7 @@ def test_urlfield_3(self):\n             f.clean('http://www.broken.djangoproject.com') # bad domain\n         except ValidationError, e:\n             self.assertEqual(\"[u'This URL appears to be a broken link.']\", str(e))\n-        self.assertRaises(ValidationError, f.clean, 'http://google.com/we-love-microsoft.html') # good domain, bad page\n+        self.assertRaises(ValidationError, f.clean, 'http://qa-dev.w3.org/link-testsuite/http.php?code=400') # good domain, bad page\n         try:\n             f.clean('http://google.com/we-love-microsoft.html') # good domain, bad page\n         except ValidationError, e:\n@@ -681,11 +690,10 @@ def test_urlfield_9(self):\n         except ValidationError, e:\n             self.assertEqual(\"[u'This URL appears to be a broken link.']\", str(e))\n \n-    @verify_exists_urls(('http://xn--tr-xka.djangoproject.com/',))\n     def test_urlfield_10(self):\n-        # UTF-8 char in path\n+        # UTF-8 in the domain. \n         f = URLField(verify_exists=True)\n-        url = u'http://t\\xfcr.djangoproject.com/'\n+        url = u'http://\\u03b5\\u03bb\\u03bb\\u03b7\\u03bd\\u03b9\\u03ba\\u03ac.idn.icann.org/\\u0391\\u03c1\\u03c7\\u03b9\\u03ba\\u03ae_\\u03c3\\u03b5\\u03bb\\u03af\\u03b4\\u03b1'\n         self.assertEqual(url, f.clean(url))\n \n     def test_urlfield_not_string(self):"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 107,
        "deletions": 43
    }
}