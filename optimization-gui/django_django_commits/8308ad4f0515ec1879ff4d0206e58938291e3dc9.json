{
    "author": "alex",
    "message": "Fixed #14774 -- the test client and assertNumQueries didn't work well together.  Thanks to Jonas Obrist for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15251 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8308ad4f0515ec1879ff4d0206e58938291e3dc9",
    "files": [
        {
            "sha": "02cd00c27f22297ee895f8b08e0f28fdc710bede",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/8308ad4f0515ec1879ff4d0206e58938291e3dc9/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/8308ad4f0515ec1879ff4d0206e58938291e3dc9/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=8308ad4f0515ec1879ff4d0206e58938291e3dc9",
            "patch": "@@ -6,8 +6,10 @@\n from django.conf import settings\n from django.core import mail\n from django.core.management import call_command\n+from django.core.signals import request_started\n from django.core.urlresolvers import clear_url_caches\n-from django.db import transaction, connection, connections, DEFAULT_DB_ALIAS\n+from django.db import (transaction, connection, connections, DEFAULT_DB_ALIAS,\n+    reset_queries)\n from django.http import QueryDict\n from django.test import _doctest as doctest\n from django.test.client import Client\n@@ -220,10 +222,12 @@ def __enter__(self):\n         self.old_debug_cursor = self.connection.use_debug_cursor\n         self.connection.use_debug_cursor = True\n         self.starting_queries = len(self.connection.queries)\n+        request_started.disconnect(reset_queries)\n         return self\n \n     def __exit__(self, exc_type, exc_value, traceback):\n         self.connection.use_debug_cursor = self.old_debug_cursor\n+        request_started.connect(reset_queries)\n         if exc_type is not None:\n             return\n "
        },
        {
            "sha": "d5dd7397826f86f83934d424a7eaf07d0dc1833e",
            "filename": "tests/regressiontests/test_utils/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 9,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftests.py?ref=8308ad4f0515ec1879ff4d0206e58938291e3dc9",
            "patch": "@@ -2,12 +2,24 @@\n \n from django.test import TestCase, skipUnlessDBFeature, skipIfDBFeature\n \n+from models import Person\n \n if sys.version_info >= (2, 5):\n-    from tests_25 import AssertNumQueriesTests\n+    from tests_25 import AssertNumQueriesContextManagerTests\n \n \n class SkippingTestCase(TestCase):\n+    def test_skip_unless_db_feature(self):\n+        \"A test that might be skipped is actually called.\"\n+        # Total hack, but it works, just want an attribute that's always true.\n+        @skipUnlessDBFeature(\"__class__\")\n+        def test_func():\n+            raise ValueError\n+\n+        self.assertRaises(ValueError, test_func)\n+\n+\n+class AssertNumQueriesTests(TestCase):\n     def test_assert_num_queries(self):\n         def test_func():\n             raise ValueError\n@@ -16,18 +28,28 @@ def test_func():\n             self.assertNumQueries, 2, test_func\n         )\n \n-    def test_skip_unless_db_feature(self):\n-        \"A test that might be skipped is actually called.\"\n-        # Total hack, but it works, just want an attribute that's always true.\n-        @skipUnlessDBFeature(\"__class__\")\n-        def test_func():\n-            raise ValueError\n+    def test_assert_num_queries_with_client(self):\n+        person = Person.objects.create(name='test')\n \n-        self.assertRaises(ValueError, test_func)\n+        self.assertNumQueries(\n+            1,\n+            self.client.get,\n+            \"/test_utils/get_person/%s/\" % person.pk\n+        )\n \n+        self.assertNumQueries(\n+            1,\n+            self.client.get,\n+            \"/test_utils/get_person/%s/\" % person.pk\n+        )\n \n-class SaveRestoreWarningState(TestCase):\n+        def test_func():\n+            self.client.get(\"/test_utils/get_person/%s/\" % person.pk)\n+            self.client.get(\"/test_utils/get_person/%s/\" % person.pk)\n+        self.assertNumQueries(2, test_func)\n \n+\n+class SaveRestoreWarningState(TestCase):\n     def test_save_restore_warnings_state(self):\n         \"\"\"\n         Ensure save_warnings_state/restore_warnings_state work correctly."
        },
        {
            "sha": "9fe9c838e5e355821b09f307f5c4faff8cd38cfe",
            "filename": "tests/regressiontests/test_utils/tests_25.py",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Ftests_25.py",
            "raw_url": "https://github.com/django/django/raw/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Ftests_25.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Ftests_25.py?ref=8308ad4f0515ec1879ff4d0206e58938291e3dc9",
            "patch": "@@ -5,7 +5,7 @@\n from models import Person\n \n \n-class AssertNumQueriesTests(TestCase):\n+class AssertNumQueriesContextManagerTests(TestCase):\n     def test_simple(self):\n         with self.assertNumQueries(0):\n             pass\n@@ -26,3 +26,16 @@ def test_failure(self):\n         with self.assertRaises(TypeError):\n             with self.assertNumQueries(4000):\n                 raise TypeError\n+\n+    def test_with_client(self):\n+        person = Person.objects.create(name=\"test\")\n+\n+        with self.assertNumQueries(1):\n+            self.client.get(\"/test_utils/get_person/%s/\" % person.pk)\n+\n+        with self.assertNumQueries(1):\n+            self.client.get(\"/test_utils/get_person/%s/\" % person.pk)\n+\n+        with self.assertNumQueries(2):\n+            self.client.get(\"/test_utils/get_person/%s/\" % person.pk)\n+            self.client.get(\"/test_utils/get_person/%s/\" % person.pk)"
        },
        {
            "sha": "2c5821bc44999526c07d14e6768e6a9a4e46f1a6",
            "filename": "tests/regressiontests/test_utils/urls.py",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Furls.py?ref=8308ad4f0515ec1879ff4d0206e58938291e3dc9",
            "patch": "@@ -0,0 +1,8 @@\n+from django.conf.urls.defaults import patterns\n+\n+import views\n+\n+\n+urlpatterns = patterns('',\n+    (r'^get_person/(\\d+)/$', views.get_person),\n+)"
        },
        {
            "sha": "62af0d9c4794b3964fe4cfeb3250bd4eb9636fd3",
            "filename": "tests/regressiontests/test_utils/views.py",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Fregressiontests%2Ftest_utils%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_utils%2Fviews.py?ref=8308ad4f0515ec1879ff4d0206e58938291e3dc9",
            "patch": "@@ -0,0 +1,7 @@\n+from django.http import HttpResponse\n+from django.shortcuts import get_object_or_404\n+from models import Person\n+\n+def get_person(request, pk):\n+    person = get_object_or_404(Person, pk=pk)\n+    return HttpResponse(person.name)\n\\ No newline at end of file"
        },
        {
            "sha": "d254407cc4769f39c4687391cf847aa723c58204",
            "filename": "tests/urls.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/8308ad4f0515ec1879ff4d0206e58938291e3dc9/tests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Furls.py?ref=8308ad4f0515ec1879ff4d0206e58938291e3dc9",
            "patch": "@@ -1,5 +1,6 @@\n from django.conf.urls.defaults import *\n \n+\n urlpatterns = patterns('',\n     # test_client modeltest urls\n     (r'^test_client/', include('modeltests.test_client.urls')),\n@@ -41,4 +42,7 @@\n \n     # special headers views\n     (r'special_headers/', include('regressiontests.special_headers.urls')),\n+\n+    # test util views\n+    (r'test_utils/', include('regressiontests.test_utils.urls')),\n )"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 69,
        "deletions": 11
    }
}