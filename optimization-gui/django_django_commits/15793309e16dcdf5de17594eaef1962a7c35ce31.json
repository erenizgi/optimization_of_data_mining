{
    "author": "ramiro",
    "message": "Fixed #14476 -- Fixed resolution of automatically generated annotation names so e.g. filtering based on them works. Thanks dirleyls for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16252 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "15793309e16dcdf5de17594eaef1962a7c35ce31",
    "files": [
        {
            "sha": "99663b646bc5fd7a47d56f925af017316e270a27",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/15793309e16dcdf5de17594eaef1962a7c35ce31/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/15793309e16dcdf5de17594eaef1962a7c35ce31/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=15793309e16dcdf5de17594eaef1962a7c35ce31",
            "patch": "@@ -1053,14 +1053,14 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n             value = SQLEvaluator(value, self)\n             having_clause = value.contains_aggregate\n \n-        if parts[0] in self.aggregates:\n-            aggregate = self.aggregates[parts[0]]\n-            entry = self.where_class()\n-            entry.add((aggregate, lookup_type, value), AND)\n-            if negate:\n-                entry.negate()\n-            self.having.add(entry, connector)\n-            return\n+        for alias, aggregate in self.aggregates.items():\n+            if alias in (parts[0], LOOKUP_SEP.join(parts)):\n+                entry = self.where_class()\n+                entry.add((aggregate, lookup_type, value), AND)\n+                if negate:\n+                    entry.negate()\n+                self.having.add(entry, connector)\n+                return\n \n         opts = self.get_meta()\n         alias = self.get_initial_alias()"
        },
        {
            "sha": "15692b6422d52ebd178e63ac31b9734557b41c77",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/15793309e16dcdf5de17594eaef1962a7c35ce31/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/15793309e16dcdf5de17594eaef1962a7c35ce31/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=15793309e16dcdf5de17594eaef1962a7c35ce31",
            "patch": "@@ -827,3 +827,30 @@ def test_stddev(self):\n             Book.objects.aggregate(Variance('price', sample=True)),\n             {'price__variance': Approximate(700.53, 2)}\n         )\n+\n+    def test_filtering_by_annotation_name(self):\n+        # Regression test for #14476\n+\n+        # The name of the explicitly provided annotation name in this case\n+        # poses no problem\n+        qs = Author.objects.annotate(book_cnt=Count('book')).filter(book_cnt=2)\n+        self.assertQuerysetEqual(\n+            qs,\n+            ['Peter Norvig'],\n+            lambda b: b.name\n+        )\n+        # Neither in this case\n+        qs = Author.objects.annotate(book_count=Count('book')).filter(book_count=2)\n+        self.assertQuerysetEqual(\n+            qs,\n+            ['Peter Norvig'],\n+            lambda b: b.name\n+        )\n+        # This case used to fail because the ORM couldn't resolve the\n+        # automatically generated annotation name `book__count`\n+        qs = Author.objects.annotate(Count('book')).filter(book__count=2)\n+        self.assertQuerysetEqual(\n+            qs,\n+            ['Peter Norvig'],\n+            lambda b: b.name\n+        )"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 35,
        "deletions": 8
    }
}