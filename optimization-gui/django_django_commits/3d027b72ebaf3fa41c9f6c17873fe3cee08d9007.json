{
    "author": "jezdez",
    "message": "Fixed #14496 -- Fixed conflict between ModelForm exclude and ModelAdmin readonly values. Thanks, Julien Phalip.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16602 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3d027b72ebaf3fa41c9f6c17873fe3cee08d9007",
    "files": [
        {
            "sha": "cf7ea83c118881fc82058f1f32d05bd0be1e9f26",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/3d027b72ebaf3fa41c9f6c17873fe3cee08d9007/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/3d027b72ebaf3fa41c9f6c17873fe3cee08d9007/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=3d027b72ebaf3fa41c9f6c17873fe3cee08d9007",
            "patch": "@@ -437,6 +437,10 @@ def get_form(self, request, obj=None, **kwargs):\n         else:\n             exclude = list(self.exclude)\n         exclude.extend(self.get_readonly_fields(request, obj))\n+        if self.exclude is None and hasattr(self.form, '_meta') and self.form._meta.exclude:\n+            # Take the custom ModelForm's Meta.exclude into account only if the\n+            # ModelAdmin doesn't define its own.\n+            exclude.extend(self.form._meta.exclude)\n         # if exclude is an empty list we pass None to be consistant with the\n         # default on modelform_factory\n         exclude = exclude or None\n@@ -1343,6 +1347,10 @@ def get_formset(self, request, obj=None, **kwargs):\n         else:\n             exclude = list(self.exclude)\n         exclude.extend(self.get_readonly_fields(request, obj))\n+        if self.exclude is None and hasattr(self.form, '_meta') and self.form._meta.exclude:\n+            # Take the custom ModelForm's Meta.exclude into account only if the\n+            # InlineModelAdmin doesn't define its own.\n+            exclude.extend(self.form._meta.exclude)\n         # if exclude is an empty list we use None, since that's the actual\n         # default\n         exclude = exclude or None"
        },
        {
            "sha": "3cd8279234f65ea0ced31db61e22db66001490a8",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/3d027b72ebaf3fa41c9f6c17873fe3cee08d9007/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/3d027b72ebaf3fa41c9f6c17873fe3cee08d9007/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=3d027b72ebaf3fa41c9f6c17873fe3cee08d9007",
            "patch": "@@ -313,6 +313,24 @@ subclass::\n \n     For an example see the section `Adding custom validation to the admin`_.\n \n+    .. admonition:: Note\n+\n+        If your ``ModelForm`` and ``ModelAdmin`` both define an ``exclude``\n+        option then ``ModelAdmin`` takes precedence::\n+\n+            class PersonForm(forms.ModelForm):\n+\n+                class Meta:\n+                    model = Person\n+                    exclude = ['name']\n+\n+            class PersonAdmin(admin.ModelAdmin):\n+                exclude = ['age']\n+                form = PersonForm\n+\n+        In the above example, the \"age\" field will be excluded but the \"name\"\n+        field will be included in the generated form.\n+\n .. attribute:: ModelAdmin.formfield_overrides\n \n     This provides a quick-and-dirty way to override some of the"
        },
        {
            "sha": "ad86f854a704b57f32cea2741d208a27ff6a592e",
            "filename": "tests/regressiontests/modeladmin/tests.py",
            "status": "modified",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/django/django/blob/3d027b72ebaf3fa41c9f6c17873fe3cee08d9007/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3d027b72ebaf3fa41c9f6c17873fe3cee08d9007/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py?ref=3d027b72ebaf3fa41c9f6c17873fe3cee08d9007",
            "patch": "@@ -120,6 +120,99 @@ class BandAdmin(ModelAdmin):\n         self.assertEqual(ma.get_form(request).base_fields.keys(),\n             ['name'])\n \n+    def test_custom_form_meta_exclude_with_readonly(self):\n+        \"\"\"\n+        Ensure that the custom ModelForm's `Meta.exclude` is respected when\n+        used in conjunction with `ModelAdmin.readonly_fields` and when no\n+        `ModelAdmin.exclude` is defined.\n+        Refs #14496.\n+        \"\"\"\n+        # First, with `ModelAdmin` -----------------------\n+\n+        class AdminBandForm(forms.ModelForm):\n+\n+            class Meta:\n+                model = Band\n+                exclude = ['bio']\n+\n+        class BandAdmin(ModelAdmin):\n+            readonly_fields = ['name']\n+            form = AdminBandForm\n+\n+        ma = BandAdmin(Band, self.site)\n+        self.assertEqual(ma.get_form(request).base_fields.keys(),\n+            ['sign_date',])\n+\n+        # Then, with `InlineModelAdmin`  -----------------\n+\n+        class AdminConcertForm(forms.ModelForm):\n+\n+            class Meta:\n+                model = Concert\n+                exclude = ['day']\n+\n+        class ConcertInline(TabularInline):\n+            readonly_fields = ['transport']\n+            form = AdminConcertForm\n+            fk_name = 'main_band'\n+            model = Concert\n+\n+        class BandAdmin(ModelAdmin):\n+            inlines = [\n+                ConcertInline\n+            ]\n+\n+        ma = BandAdmin(Band, self.site)\n+        self.assertEqual(\n+            list(ma.get_formsets(request))[0]().forms[0].fields.keys(),\n+            ['main_band', 'opening_band', 'id', 'DELETE',])\n+\n+    def test_custom_form_meta_exclude(self):\n+        \"\"\"\n+        Ensure that the custom ModelForm's `Meta.exclude` is overridden if\n+        `ModelAdmin.exclude` or `InlineModelAdmin.exclude` are defined.\n+        Refs #14496.\n+        \"\"\"\n+        # First, with `ModelAdmin` -----------------------\n+\n+        class AdminBandForm(forms.ModelForm):\n+\n+            class Meta:\n+                model = Band\n+                exclude = ['bio']\n+\n+        class BandAdmin(ModelAdmin):\n+            exclude = ['name']\n+            form = AdminBandForm\n+\n+        ma = BandAdmin(Band, self.site)\n+        self.assertEqual(ma.get_form(request).base_fields.keys(),\n+            ['bio', 'sign_date',])\n+\n+        # Then, with `InlineModelAdmin`  -----------------\n+\n+        class AdminConcertForm(forms.ModelForm):\n+\n+            class Meta:\n+                model = Concert\n+                exclude = ['day']\n+\n+        class ConcertInline(TabularInline):\n+            exclude = ['transport']\n+            form = AdminConcertForm\n+            fk_name = 'main_band'\n+            model = Concert\n+\n+        class BandAdmin(ModelAdmin):\n+            inlines = [\n+                ConcertInline\n+            ]\n+\n+        ma = BandAdmin(Band, self.site)\n+        self.assertEqual(\n+            list(ma.get_formsets(request))[0]().forms[0].fields.keys(),\n+            ['main_band', 'opening_band', 'day', 'id', 'DELETE',])\n+\n     def test_custom_form_validation(self):\n         # If we specify a form, it should use it allowing custom validation to work\n         # properly. This won't, however, break any of the admin widgets or media."
        }
    ],
    "stats": {
        "total": 119,
        "additions": 119,
        "deletions": 0
    }
}