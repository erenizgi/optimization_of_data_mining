{
    "author": "akaariai",
    "message": "Fixed #16211 -- Added comparison and negation ops to F() expressions\n\nWork done by Walter Doekes and Trac alias knoeb. Reviewed by Simon\nCharette.",
    "sha": "28abf5f0ebc9d380f25dd278d7ef4642c4504545",
    "files": [
        {
            "sha": "4edde04f42413534628784fe1fb44c9256a7c2f9",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -913,6 +913,9 @@ def combine_expression(self, connector, sub_expressions):\n         can vary between backends (e.g., Oracle with %% and &) and between\n         subexpression types (e.g., date expressions)\n         \"\"\"\n+        if connector == 'NOT':\n+            assert len(sub_expressions) == 1\n+            return 'NOT (%s)' % sub_expressions[0]\n         conn = ' %s ' % connector\n         return conn.join(sub_expressions)\n "
        },
        {
            "sha": "972440b858a76dd9763bae3639677f7cdc983351",
            "filename": "django/db/models/expressions.py",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/django%2Fdb%2Fmodels%2Fexpressions.py",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/django%2Fdb%2Fmodels%2Fexpressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fexpressions.py?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -18,6 +18,17 @@ class ExpressionNode(tree.Node):\n     AND = '&'\n     OR = '|'\n \n+    # Unary operator (needs special attention in combine_expression)\n+    NOT = 'NOT'\n+\n+    # Comparison operators\n+    EQ = '='\n+    GE = '>='\n+    GT = '>'\n+    LE = '<='\n+    LT = '<'\n+    NE = '<>'\n+\n     def __init__(self, children=None, connector=None, negated=False):\n         if children is not None and len(children) > 1 and connector is None:\n             raise TypeError('You have to specify a connector.')\n@@ -93,6 +104,32 @@ def __rand__(self, other):\n     def __ror__(self, other):\n         return self._combine(other, self.OR, True)\n \n+    def __invert__(self):\n+        obj = ExpressionNode([self], connector=self.NOT, negated=True)\n+        return obj\n+\n+    def __eq__(self, other):\n+        return self._combine(other, self.EQ, False)\n+\n+    def __ge__(self, other):\n+        return self._combine(other, self.GE, False)\n+\n+    def __gt__(self, other):\n+        return self._combine(other, self.GT, False)\n+\n+    def __le__(self, other):\n+        return self._combine(other, self.LE, False)\n+\n+    def __lt__(self, other):\n+        return self._combine(other, self.LT, False)\n+\n+    def __ne__(self, other):\n+        return self._combine(other, self.NE, False)\n+\n+    def __bool__(self):\n+        raise TypeError('Boolean operators should be avoided. Use bitwise operators.')\n+    __nonzero__ = __bool__\n+\n     def prepare_database_save(self, unused):\n         return self\n "
        },
        {
            "sha": "6229493544e076c87d0dbbe96c2f6a0e8a4bd067",
            "filename": "django/utils/tree.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/django%2Futils%2Ftree.py",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/django%2Futils%2Ftree.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftree.py?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -88,8 +88,12 @@ def add(self, node, conn_type):\n         Otherwise, the whole tree is pushed down one level and a new root\n         connector is created, connecting the existing tree and the new node.\n         \"\"\"\n-        if node in self.children and conn_type == self.connector:\n-            return\n+        # Using for loop with 'is' instead of 'if node in children' so node\n+        # __eq__ method doesn't get called. The __eq__ method can be overriden\n+        # by subtypes, for example the F-expression.\n+        for child in self.children:\n+            if node is child and conn_type == self.connector:\n+                return\n         if len(self.children) < 2:\n             self.connector = conn_type\n         if self.connector == conn_type:"
        },
        {
            "sha": "b37121499405f7eff158c7782061521d60db5418",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -176,6 +176,10 @@ Django 1.5 also includes several smaller improvements worth noting:\n   :setting:`DEBUG` is `True` are sent to the console (unless you redefine the\n   logger in your :setting:`LOGGING` setting).\n \n+* :ref:`F() expressions <query-expressions>` now support comparison operations\n+  and inversion, expanding the types of expressions that can be passed to the\n+  database.\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        },
        {
            "sha": "c724eabb8e5a93cf6248b3af486b5c3ea37803c8",
            "filename": "docs/topics/db/queries.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/docs%2Ftopics%2Fdb%2Fqueries.txt",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/docs%2Ftopics%2Fdb%2Fqueries.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Fqueries.txt?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -640,6 +640,15 @@ that were modified more than 3 days after they were published::\n     >>> from datetime import timedelta\n     >>> Entry.objects.filter(mod_date__gt=F('pub_date') + timedelta(days=3))\n \n+.. versionadded:: 1.5\n+    Comparisons and negation operators for ``F()`` expressions\n+\n+Django also supports the comparison operators ``==``, ``!=``, ``<=``, ``<``,\n+``>``, ``>=`` and the bitwise negation operator ``~`` (boolean ``not`` operator\n+will raise ``TypeError``)::\n+\n+    >>> Entry.objects.filter(is_heavily_quoted=~(F('n_pingbacks') < 100))\n+\n The pk lookup shortcut\n ----------------------\n "
        },
        {
            "sha": "15f0d24541a4592f056588eb97560828a43289ee",
            "filename": "tests/modeltests/expressions/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/tests%2Fmodeltests%2Fexpressions%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/tests%2Fmodeltests%2Fexpressions%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fexpressions%2Fmodels.py?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -27,6 +27,8 @@ class Company(models.Model):\n         Employee,\n         related_name='company_point_of_contact_set',\n         null=True)\n+    is_large = models.BooleanField(\n+        blank=True)\n \n     def __str__(self):\n         return self.name"
        },
        {
            "sha": "14419ec55bf9e48cafd7e76872a53e9b9177bc48",
            "filename": "tests/modeltests/expressions/tests.py",
            "status": "modified",
            "additions": 89,
            "deletions": 20,
            "changes": 109,
            "blob_url": "https://github.com/django/django/blob/28abf5f0ebc9d380f25dd278d7ef4642c4504545/tests%2Fmodeltests%2Fexpressions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/28abf5f0ebc9d380f25dd278d7ef4642c4504545/tests%2Fmodeltests%2Fexpressions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fexpressions%2Ftests.py?ref=28abf5f0ebc9d380f25dd278d7ef4642c4504545",
            "patch": "@@ -11,22 +11,22 @@\n class ExpressionsTests(TestCase):\n     def test_filter(self):\n         Company.objects.create(\n-            name=\"Example Inc.\", num_employees=2300, num_chairs=5,\n+            name=\"Example Inc.\", num_employees=2300, num_chairs=5, is_large=False,\n             ceo=Employee.objects.create(firstname=\"Joe\", lastname=\"Smith\")\n         )\n         Company.objects.create(\n-            name=\"Foobar Ltd.\", num_employees=3, num_chairs=4,\n+            name=\"Foobar Ltd.\", num_employees=3, num_chairs=4, is_large=False,\n             ceo=Employee.objects.create(firstname=\"Frank\", lastname=\"Meyer\")\n         )\n         Company.objects.create(\n-            name=\"Test GmbH\", num_employees=32, num_chairs=1,\n+            name=\"Test GmbH\", num_employees=32, num_chairs=1, is_large=False,\n             ceo=Employee.objects.create(firstname=\"Max\", lastname=\"Mustermann\")\n         )\n \n         company_query = Company.objects.values(\n-            \"name\", \"num_employees\", \"num_chairs\"\n+            \"name\", \"num_employees\", \"num_chairs\", \"is_large\"\n         ).order_by(\n-            \"name\", \"num_employees\", \"num_chairs\"\n+            \"name\", \"num_employees\", \"num_chairs\", \"is_large\"\n         )\n \n         # We can filter for companies where the number of employees is greater\n@@ -37,11 +37,13 @@ def test_filter(self):\n                     \"num_chairs\": 5,\n                     \"name\": \"Example Inc.\",\n                     \"num_employees\": 2300,\n+                    \"is_large\": False\n                 },\n                 {\n                     \"num_chairs\": 1,\n                     \"name\": \"Test GmbH\",\n-                    \"num_employees\": 32\n+                    \"num_employees\": 32,\n+                    \"is_large\": False\n                 },\n             ],\n             lambda o: o\n@@ -55,17 +57,20 @@ def test_filter(self):\n                 {\n                     \"num_chairs\": 2300,\n                     \"name\": \"Example Inc.\",\n-                    \"num_employees\": 2300\n+                    \"num_employees\": 2300,\n+                    \"is_large\": False\n                 },\n                 {\n                     \"num_chairs\": 3,\n                     \"name\": \"Foobar Ltd.\",\n-                    \"num_employees\": 3\n+                    \"num_employees\": 3,\n+                    \"is_large\": False\n                 },\n                 {\n                     \"num_chairs\": 32,\n                     \"name\": \"Test GmbH\",\n-                    \"num_employees\": 32\n+                    \"num_employees\": 32,\n+                    \"is_large\": False\n                 }\n             ],\n             lambda o: o\n@@ -79,17 +84,20 @@ def test_filter(self):\n                 {\n                     'num_chairs': 2302,\n                     'name': 'Example Inc.',\n-                    'num_employees': 2300\n+                    'num_employees': 2300,\n+                    'is_large': False\n                 },\n                 {\n                     'num_chairs': 5,\n                     'name': 'Foobar Ltd.',\n-                    'num_employees': 3\n+                    'num_employees': 3,\n+                    'is_large': False\n                 },\n                 {\n                     'num_chairs': 34,\n                     'name': 'Test GmbH',\n-                    'num_employees': 32\n+                    'num_employees': 32,\n+                    'is_large': False\n                 }\n             ],\n             lambda o: o,\n@@ -104,17 +112,20 @@ def test_filter(self):\n                 {\n                     'num_chairs': 6900,\n                     'name': 'Example Inc.',\n-                    'num_employees': 2300\n+                    'num_employees': 2300,\n+                    'is_large': False\n                 },\n                 {\n                     'num_chairs': 9,\n                     'name': 'Foobar Ltd.',\n-                    'num_employees': 3\n+                    'num_employees': 3,\n+                    'is_large': False\n                 },\n                 {\n                     'num_chairs': 96,\n                     'name': 'Test GmbH',\n-                    'num_employees': 32\n+                    'num_employees': 32,\n+                    'is_large': False\n                 }\n             ],\n             lambda o: o,\n@@ -129,21 +140,80 @@ def test_filter(self):\n                 {\n                     'num_chairs': 5294600,\n                     'name': 'Example Inc.',\n-                    'num_employees': 2300\n+                    'num_employees': 2300,\n+                    'is_large': False\n                 },\n                 {\n                     'num_chairs': 15,\n                     'name': 'Foobar Ltd.',\n-                    'num_employees': 3\n+                    'num_employees': 3,\n+                    'is_large': False\n                 },\n                 {\n                     'num_chairs': 1088,\n                     'name': 'Test GmbH',\n-                    'num_employees': 32\n+                    'num_employees': 32,\n+                    'is_large': False\n                 }\n             ],\n             lambda o: o,\n         )\n+        # The comparison operators and the bitwise unary not can be used\n+        # to assign to boolean fields\n+        for expression in (\n+            # Check boundaries\n+            ~(F('num_employees') < 33),\n+            ~(F('num_employees') <= 32),\n+            (F('num_employees') > 2299),\n+            (F('num_employees') >= 2300),\n+            (F('num_employees') == 2300),\n+            ((F('num_employees') + 1 != 4) & (32 != F('num_employees'))),\n+            # Inverted argument order works too\n+            (2299 < F('num_employees')),\n+            (2300 <= F('num_employees'))\n+        ):\n+            # Test update by F-expression\n+            company_query.update(\n+                is_large=expression\n+            )\n+            # Compare results\n+            self.assertQuerysetEqual(\n+                company_query, [\n+                    {\n+                        'num_chairs': 5294600,\n+                        'name': 'Example Inc.',\n+                        'num_employees': 2300,\n+                        'is_large': True\n+                    },\n+                    {\n+                        'num_chairs': 15,\n+                        'name': 'Foobar Ltd.',\n+                        'num_employees': 3,\n+                        'is_large': False\n+                    },\n+                    {\n+                        'num_chairs': 1088,\n+                        'name': 'Test GmbH',\n+                        'num_employees': 32,\n+                        'is_large': False\n+                    }\n+                ],\n+                lambda o: o,\n+            )\n+            # Reset values\n+            company_query.update(\n+                is_large=False\n+            )\n+\n+        # The python boolean operators should be avoided as they yield\n+        # unexpected results\n+        test_gmbh = Company.objects.get(name=\"Test GmbH\")\n+        with self.assertRaises(TypeError):\n+            test_gmbh.is_large = not F('is_large')\n+        with self.assertRaises(TypeError):\n+            test_gmbh.is_large = F('is_large') and F('is_large')\n+        with self.assertRaises(TypeError):\n+            test_gmbh.is_large = F('is_large') or F('is_large')\n \n         # The relation of a foreign key can become copied over to an other\n         # foreign key.\n@@ -202,9 +272,8 @@ def test_filter(self):\n         test_gmbh.point_of_contact = None\n         test_gmbh.save()\n         self.assertTrue(test_gmbh.point_of_contact is None)\n-        def test():\n+        with self.assertRaises(ValueError):\n             test_gmbh.point_of_contact = F(\"ceo\")\n-        self.assertRaises(ValueError, test)\n \n         test_gmbh.point_of_contact = test_gmbh.ceo\n         test_gmbh.save()"
        }
    ],
    "stats": {
        "total": 172,
        "additions": 150,
        "deletions": 22
    }
}