{
    "author": "unknown",
    "message": "Fixed #12397 -- allow safe_join to work with the root file system path, which means you can have your root template or file upload path at this location. You almost certainly don't want to do this, except in *very* limited sandboxed situations.",
    "sha": "b865009d414a0f6fd0c0f5ad7434b2c13eb761c7",
    "files": [
        {
            "sha": "1ea12aed8a2cf9ce7af9187aab55dd15f307c404",
            "filename": "django/utils/_os.py",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/b865009d414a0f6fd0c0f5ad7434b2c13eb761c7/django%2Futils%2F_os.py",
            "raw_url": "https://github.com/django/django/raw/b865009d414a0f6fd0c0f5ad7434b2c13eb761c7/django%2Futils%2F_os.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2F_os.py?ref=b865009d414a0f6fd0c0f5ad7434b2c13eb761c7",
            "patch": "@@ -1,6 +1,6 @@\n import os\n import stat\n-from os.path import join, normcase, normpath, abspath, isabs, sep\n+from os.path import join, normcase, normpath, abspath, isabs, sep, dirname\n from django.utils.encoding import force_text\n from django.utils import six\n \n@@ -41,13 +41,16 @@ def safe_join(base, *paths):\n     paths = [force_text(p) for p in paths]\n     final_path = abspathu(join(base, *paths))\n     base_path = abspathu(base)\n-    base_path_len = len(base_path)\n     # Ensure final_path starts with base_path (using normcase to ensure we\n-    # don't false-negative on case insensitive operating systems like Windows)\n-    # and that the next character after the final path is os.sep (or nothing,\n-    # in which case final_path must be equal to base_path).\n-    if not normcase(final_path).startswith(normcase(base_path)) \\\n-       or final_path[base_path_len:base_path_len+1] not in ('', sep):\n+    # don't false-negative on case insensitive operating systems like Windows),\n+    # further, one of the following conditions must be true:\n+    #  a) The next character is the path separator (to prevent conditions like\n+    #     safe_join(\"/dir\", \"/../d\"))\n+    #  b) The final path must be the same as the base path.\n+    #  c) The base path must be the most root path (meaning either \"/\" or \"C:\\\\\")\n+    if (not normcase(final_path).startswith(normcase(base_path + sep)) and\n+        normcase(final_path) != normcase(base_path) and\n+        dirname(normcase(base_path)) != normcase(base_path)):\n         raise ValueError('The joined path (%s) is located outside of the base '\n                          'path component (%s)' % (final_path, base_path))\n     return final_path"
        },
        {
            "sha": "a78f348cf56caeecde6e848749bdedbd4d8f77a9",
            "filename": "tests/regressiontests/utils/os_utils.py",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/b865009d414a0f6fd0c0f5ad7434b2c13eb761c7/tests%2Fregressiontests%2Futils%2Fos_utils.py",
            "raw_url": "https://github.com/django/django/raw/b865009d414a0f6fd0c0f5ad7434b2c13eb761c7/tests%2Fregressiontests%2Futils%2Fos_utils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fos_utils.py?ref=b865009d414a0f6fd0c0f5ad7434b2c13eb761c7",
            "patch": "@@ -0,0 +1,21 @@\n+from django.utils import unittest\n+from django.utils._os import safe_join\n+\n+\n+class SafeJoinTests(unittest.TestCase):\n+    def test_base_path_ends_with_sep(self):\n+        self.assertEqual(\n+            safe_join(\"/abc/\", \"abc\"),\n+            \"/abc/abc\",\n+        )\n+\n+    def test_root_path(self):\n+        self.assertEqual(\n+            safe_join(\"/\", \"path\"),\n+            \"/path\",\n+        )\n+\n+        self.assertEqual(\n+            safe_join(\"/\", \"\"),\n+            \"/\",\n+        )"
        },
        {
            "sha": "061c669eb7a3c475679b624b2ae496533ba437f8",
            "filename": "tests/regressiontests/utils/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/b865009d414a0f6fd0c0f5ad7434b2c13eb761c7/tests%2Fregressiontests%2Futils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b865009d414a0f6fd0c0f5ad7434b2c13eb761c7/tests%2Fregressiontests%2Futils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftests.py?ref=b865009d414a0f6fd0c0f5ad7434b2c13eb761c7",
            "patch": "@@ -21,6 +21,7 @@\n from .ipv6 import TestUtilsIPv6\n from .jslex import JsToCForGettextTest, JsTokensTest\n from .module_loading import CustomLoader, DefaultLoader, EggLoader\n+from .os_utils import SafeJoinTests\n from .regex_helper import NormalizeTests\n from .simplelazyobject import TestUtilsSimpleLazyObject\n from .termcolors import TermColorTests"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 32,
        "deletions": 7
    }
}