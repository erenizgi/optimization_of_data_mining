{
    "author": "claudep",
    "message": "Fixed #16612 -- Improved has_changed detection for localized field values\n\nThanks Simon Charette for the review.",
    "sha": "892bc91cb0036d6868081363628f65094c4790d6",
    "files": [
        {
            "sha": "c7ed085b16ad08ad6a6a03ef422ffb8324819557",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 6,
            "deletions": 16,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/892bc91cb0036d6868081363628f65094c4790d6/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/892bc91cb0036d6868081363628f65094c4790d6/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=892bc91cb0036d6868081363628f65094c4790d6",
            "patch": "@@ -184,17 +184,13 @@ def _has_changed(self, initial, data):\n         # For purposes of seeing whether something has changed, None is\n         # the same as an empty string, if the data or inital value we get\n         # is None, replace it w/ ''.\n-        if data is None:\n-            data_value = ''\n-        else:\n-            data_value = data\n-        if initial is None:\n-            initial_value = ''\n-        else:\n-            initial_value = initial\n-        if force_text(initial_value) != force_text(data_value):\n+        initial_value = initial if initial is not None else ''\n+        try:\n+            data = self.to_python(data)\n+        except ValidationError:\n             return True\n-        return False\n+        data_value = data if data is not None else ''\n+        return initial_value != data_value\n \n     def __deepcopy__(self, memo):\n         result = copy.copy(self)\n@@ -392,12 +388,6 @@ def to_python(self, value):\n     def strptime(self, value, format):\n         raise NotImplementedError('Subclasses must define this method.')\n \n-    def _has_changed(self, initial, data):\n-        try:\n-            data = self.to_python(data)\n-        except ValidationError:\n-            return True\n-        return self.to_python(initial) != data\n \n class DateField(BaseTemporalField):\n     widget = DateInput"
        },
        {
            "sha": "38601432bcbc118ee4538f4f8b5bca1634dc7026",
            "filename": "django/forms/forms.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/892bc91cb0036d6868081363628f65094c4790d6/django%2Fforms%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/892bc91cb0036d6868081363628f65094c4790d6/django%2Fforms%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fforms.py?ref=892bc91cb0036d6868081363628f65094c4790d6",
            "patch": "@@ -345,8 +345,8 @@ def changed_data(self):\n                 else:\n                     initial_prefixed_name = self.add_initial_prefix(name)\n                     hidden_widget = field.hidden_widget()\n-                    initial_value = hidden_widget.value_from_datadict(\n-                        self.data, self.files, initial_prefixed_name)\n+                    initial_value = field.to_python(hidden_widget.value_from_datadict(\n+                        self.data, self.files, initial_prefixed_name))\n                 if hasattr(field.widget, '_has_changed'):\n                     warnings.warn(\"The _has_changed method on widgets is deprecated,\"\n                         \" define it at field level instead.\","
        },
        {
            "sha": "1cea110df43ba75caf8cbe1702e89bbf3e55de4c",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/892bc91cb0036d6868081363628f65094c4790d6/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/892bc91cb0036d6868081363628f65094c4790d6/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=892bc91cb0036d6868081363628f65094c4790d6",
            "patch": "@@ -1012,6 +1012,11 @@ def to_python(self, value):\n     def validate(self, value):\n         return Field.validate(self, value)\n \n+    def _has_changed(self, initial, data):\n+        initial_value = initial if initial is not None else ''\n+        data_value = data if data is not None else ''\n+        return force_text(self.prepare_value(initial_value)) != force_text(data_value)\n+\n class ModelMultipleChoiceField(ModelChoiceField):\n     \"\"\"A MultipleChoiceField whose choices are a model QuerySet.\"\"\"\n     widget = SelectMultiple\n@@ -1059,3 +1064,14 @@ def prepare_value(self, value):\n                 not hasattr(value, '_meta')):\n             return [super(ModelMultipleChoiceField, self).prepare_value(v) for v in value]\n         return super(ModelMultipleChoiceField, self).prepare_value(value)\n+\n+    def _has_changed(self, initial, data):\n+        if initial is None:\n+            initial = []\n+        if data is None:\n+            data = []\n+        if len(initial) != len(data):\n+            return True\n+        initial_set = set([force_text(value) for value in initial])\n+        data_set = set([force_text(value) for value in data])\n+        return data_set != initial_set"
        },
        {
            "sha": "3d3206ef8534163081e038b128d903bc57a4fbce",
            "filename": "tests/forms_tests/tests/fields.py",
            "status": "modified",
            "additions": 27,
            "deletions": 9,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/892bc91cb0036d6868081363628f65094c4790d6/tests%2Fforms_tests%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/892bc91cb0036d6868081363628f65094c4790d6/tests%2Fforms_tests%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fforms_tests%2Ftests%2Ffields.py?ref=892bc91cb0036d6868081363628f65094c4790d6",
            "patch": "@@ -35,7 +35,9 @@\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.forms import *\n from django.test import SimpleTestCase\n+from django.utils import formats\n from django.utils import six\n+from django.utils import translation\n from django.utils._os import upath\n \n \n@@ -256,6 +258,17 @@ def test_floatfield_localized(self):\n         f = FloatField(localize=True)\n         self.assertWidgetRendersTo(f, '<input id=\"id_f\" name=\"f\" type=\"text\" />')\n \n+    def test_floatfield_changed(self):\n+        f = FloatField()\n+        n = 4.35\n+        self.assertFalse(f._has_changed(n, '4.3500'))\n+\n+        with translation.override('fr'):\n+            with self.settings(USE_L10N=True):\n+                f = FloatField(localize=True)\n+                localized_n = formats.localize_input(n)  # -> '4,35' in French\n+                self.assertFalse(f._has_changed(n, localized_n))\n+\n     # DecimalField ################################################################\n \n     def test_decimalfield_1(self):\n@@ -346,6 +359,18 @@ def test_decimalfield_localized(self):\n         f = DecimalField(localize=True)\n         self.assertWidgetRendersTo(f, '<input id=\"id_f\" name=\"f\" type=\"text\" />')\n \n+    def test_decimalfield_changed(self):\n+        f = DecimalField(max_digits=2, decimal_places=2)\n+        d = Decimal(\"0.1\")\n+        self.assertFalse(f._has_changed(d, '0.10'))\n+        self.assertTrue(f._has_changed(d, '0.101'))\n+\n+        with translation.override('fr'):\n+            with self.settings(USE_L10N=True):\n+                f = DecimalField(max_digits=2, decimal_places=2, localize=True)\n+                localized_d = formats.localize_input(d)  # -> '0,1' in French\n+                self.assertFalse(f._has_changed(d, localized_d))\n+\n     # DateField ###################################################################\n \n     def test_datefield_1(self):\n@@ -404,7 +429,6 @@ def test_datefield_changed(self):\n         f = DateField(input_formats=[format])\n         d = datetime.date(2007, 9, 17)\n         self.assertFalse(f._has_changed(d, '17/09/2007'))\n-        self.assertFalse(f._has_changed(d.strftime(format), '17/09/2007'))\n \n     def test_datefield_strptime(self):\n         \"\"\"Test that field.strptime doesn't raise an UnicodeEncodeError (#16123)\"\"\"\n@@ -445,14 +469,10 @@ def test_timefield_3(self):\n     def test_timefield_changed(self):\n         t1 = datetime.time(12, 51, 34, 482548)\n         t2 = datetime.time(12, 51)\n-        format = '%H:%M'\n-        f = TimeField(input_formats=[format])\n+        f = TimeField(input_formats=['%H:%M', '%H:%M %p'])\n         self.assertTrue(f._has_changed(t1, '12:51'))\n         self.assertFalse(f._has_changed(t2, '12:51'))\n-\n-        format = '%I:%M %p'\n-        f = TimeField(input_formats=[format])\n-        self.assertFalse(f._has_changed(t2.strftime(format), '12:51 PM'))\n+        self.assertFalse(f._has_changed(t2, '12:51 PM'))\n \n     # DateTimeField ###############################################################\n \n@@ -518,8 +538,6 @@ def test_datetimefield_changed(self):\n         f = DateTimeField(input_formats=[format])\n         d = datetime.datetime(2006, 9, 17, 14, 30, 0)\n         self.assertFalse(f._has_changed(d, '2006 09 17 2:30 PM'))\n-        # Initial value may be a string from a hidden input\n-        self.assertFalse(f._has_changed(d.strftime(format), '2006 09 17 2:30 PM'))\n \n     # RegexField ##################################################################\n "
        },
        {
            "sha": "d26a201efacaa86d1d6bc3c7f303ace544115f5b",
            "filename": "tests/i18n/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/892bc91cb0036d6868081363628f65094c4790d6/tests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/892bc91cb0036d6868081363628f65094c4790d6/tests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fi18n%2Ftests.py?ref=892bc91cb0036d6868081363628f65094c4790d6",
            "patch": "@@ -15,7 +15,7 @@\n from django.utils import translation\n from django.utils.formats import (get_format, date_format, time_format,\n     localize, localize_input, iter_format_modules, get_format_modules,\n-    number_format, sanitize_separators)\n+    number_format, reset_format_cache, sanitize_separators)\n from django.utils.importlib import import_module\n from django.utils.numberformat import format as nformat\n from django.utils._os import upath\n@@ -463,6 +463,7 @@ def test_false_like_locale_formats(self):\n         fr_formats.THOUSAND_SEPARATOR = ''\n         fr_formats.FIRST_DAY_OF_WEEK = 0\n \n+        reset_format_cache()\n         with translation.override('fr'):\n             with self.settings(USE_THOUSAND_SEPARATOR=True, THOUSAND_SEPARATOR='!'):\n                 self.assertEqual('', get_format('THOUSAND_SEPARATOR'))"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 53,
        "deletions": 28
    }
}