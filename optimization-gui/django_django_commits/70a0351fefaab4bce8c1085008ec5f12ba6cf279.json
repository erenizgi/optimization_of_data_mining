{
    "author": "claudep",
    "message": "Fixed #18184 -- Moved algorithm identification code to hashers module\n\nThanks Eli Collins for the report and the patch.",
    "sha": "70a0351fefaab4bce8c1085008ec5f12ba6cf279",
    "files": [
        {
            "sha": "780b0c015ed210ca2dc4c6e13fa0f926424b29c8",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/70a0351fefaab4bce8c1085008ec5f12ba6cf279/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/70a0351fefaab4bce8c1085008ec5f12ba6cf279/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=70a0351fefaab4bce8c1085008ec5f12ba6cf279",
            "patch": "@@ -7,7 +7,7 @@\n \n from django.contrib.auth import authenticate\n from django.contrib.auth.models import User\n-from django.contrib.auth.hashers import UNUSABLE_PASSWORD, is_password_usable, get_hasher\n+from django.contrib.auth.hashers import UNUSABLE_PASSWORD, is_password_usable, identify_hasher\n from django.contrib.auth.tokens import default_token_generator\n from django.contrib.sites.models import get_current_site\n \n@@ -25,13 +25,8 @@ def render(self, name, value, attrs):\n \n         final_attrs = self.build_attrs(attrs)\n \n-        if len(encoded) == 32 and '$' not in encoded:\n-            algorithm = 'unsalted_md5'\n-        else:\n-            algorithm = encoded.split('$', 1)[0]\n-\n         try:\n-            hasher = get_hasher(algorithm)\n+            hasher = identify_hasher(encoded)\n         except ValueError:\n             summary = \"<strong>Invalid password format or unknown hashing algorithm.</strong>\"\n         else:"
        },
        {
            "sha": "0897de8d84aa9a7d4a2e658a2b13d0c36b7252f4",
            "filename": "django/contrib/auth/hashers.py",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/70a0351fefaab4bce8c1085008ec5f12ba6cf279/django%2Fcontrib%2Fauth%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/70a0351fefaab4bce8c1085008ec5f12ba6cf279/django%2Fcontrib%2Fauth%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhashers.py?ref=70a0351fefaab4bce8c1085008ec5f12ba6cf279",
            "patch": "@@ -40,12 +40,7 @@ def check_password(password, encoded, setter=None, preferred='default'):\n         return False\n \n     preferred = get_hasher(preferred)\n-\n-    if len(encoded) == 32 and '$' not in encoded:\n-        hasher = get_hasher('unsalted_md5')\n-    else:\n-        algorithm = encoded.split('$', 1)[0]\n-        hasher = get_hasher(algorithm)\n+    hasher = identify_hasher(encoded)\n \n     must_update = hasher.algorithm != preferred.algorithm\n     is_correct = hasher.verify(password, encoded)\n@@ -120,6 +115,21 @@ def get_hasher(algorithm='default'):\n         return HASHERS[algorithm]\n \n \n+def identify_hasher(encoded):\n+    \"\"\"\n+    Returns an instance of a loaded password hasher.\n+\n+    Identifies hasher algorithm by examining encoded hash, and calls\n+    get_hasher() to return hasher. Raises ValueError if\n+    algorithm cannot be identified, or if hasher is not loaded.\n+    \"\"\"\n+    if len(encoded) == 32 and '$' not in encoded:\n+        algorithm = 'unsalted_md5'\n+    else:\n+        algorithm = encoded.split('$', 1)[0]\n+    return get_hasher(algorithm)\n+\n+\n def mask_hash(hash, show=6, char=\"*\"):\n     \"\"\"\n     Returns the given hash, with only the first ``show`` number shown. The"
        },
        {
            "sha": "15fc1d1da72d659ff1f81460ebd44c2dd8cca45f",
            "filename": "django/contrib/auth/tests/hashers.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/70a0351fefaab4bce8c1085008ec5f12ba6cf279/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/70a0351fefaab4bce8c1085008ec5f12ba6cf279/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py?ref=70a0351fefaab4bce8c1085008ec5f12ba6cf279",
            "patch": "@@ -1,7 +1,7 @@\n from django.conf.global_settings import PASSWORD_HASHERS as default_hashers\n from django.contrib.auth.hashers import (is_password_usable, \n     check_password, make_password, PBKDF2PasswordHasher, load_hashers,\n-    PBKDF2SHA1PasswordHasher, get_hasher, UNUSABLE_PASSWORD)\n+    PBKDF2SHA1PasswordHasher, get_hasher, identify_hasher, UNUSABLE_PASSWORD)\n from django.utils import unittest\n from django.utils.unittest import skipUnless\n \n@@ -36,6 +36,7 @@ def test_pkbdf2(self):\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"pbkdf2_sha256\")\n \n     def test_sha1(self):\n         encoded = make_password('letmein', 'seasalt', 'sha1')\n@@ -44,6 +45,7 @@ def test_sha1(self):\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"sha1\")\n \n     def test_md5(self):\n         encoded = make_password('letmein', 'seasalt', 'md5')\n@@ -52,13 +54,15 @@ def test_md5(self):\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"md5\")\n \n     def test_unsalted_md5(self):\n         encoded = make_password('letmein', 'seasalt', 'unsalted_md5')\n         self.assertEqual(encoded, '0d107d09f5bbe40cade3de5c71e9e9b7')\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"unsalted_md5\")\n \n     @skipUnless(crypt, \"no crypt module to generate password.\")\n     def test_crypt(self):\n@@ -67,6 +71,7 @@ def test_crypt(self):\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"crypt\")\n \n     @skipUnless(bcrypt, \"py-bcrypt not installed\")\n     def test_bcrypt(self):\n@@ -75,6 +80,7 @@ def test_bcrypt(self):\n         self.assertTrue(encoded.startswith('bcrypt$'))\n         self.assertTrue(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"bcrypt\")\n \n     def test_unusable(self):\n         encoded = make_password(None)\n@@ -84,11 +90,13 @@ def test_unusable(self):\n         self.assertFalse(check_password('', encoded))\n         self.assertFalse(check_password(u'letmein', encoded))\n         self.assertFalse(check_password('letmeinz', encoded))\n+        self.assertRaises(ValueError, identify_hasher, encoded)\n \n     def test_bad_algorithm(self):\n         def doit():\n             make_password('letmein', hasher='lolcat')\n         self.assertRaises(ValueError, doit)\n+        self.assertRaises(ValueError, identify_hasher, \"lolcat$salt$hash\")\n \n     def test_low_level_pkbdf2(self):\n         hasher = PBKDF2PasswordHasher()"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 27,
        "deletions": 14
    }
}