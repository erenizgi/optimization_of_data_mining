{
    "author": "freakboy3742",
    "message": "Fixed #15606 -- Ensured that boolean fields always use the Boolean filterspec. Thanks to Martin Tir≈°el for the report\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15817 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "350a56ad4949762ba02f68cf1ba8bac2968507c0",
    "files": [
        {
            "sha": "965b32bb08a0514f3ad8b7fc78b60ec749aba5f0",
            "filename": "django/contrib/admin/filterspecs.py",
            "status": "modified",
            "additions": 32,
            "deletions": 31,
            "changes": 63,
            "blob_url": "https://github.com/django/django/blob/350a56ad4949762ba02f68cf1ba8bac2968507c0/django%2Fcontrib%2Fadmin%2Ffilterspecs.py",
            "raw_url": "https://github.com/django/django/raw/350a56ad4949762ba02f68cf1ba8bac2968507c0/django%2Fcontrib%2Fadmin%2Ffilterspecs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilterspecs.py?ref=350a56ad4949762ba02f68cf1ba8bac2968507c0",
            "patch": "@@ -121,6 +121,38 @@ def choices(self, cl):\n         hasattr(f, 'rel') and bool(f.rel) or\n         isinstance(f, models.related.RelatedObject)), RelatedFilterSpec)\n \n+class BooleanFieldFilterSpec(FilterSpec):\n+    def __init__(self, f, request, params, model, model_admin,\n+                 field_path=None):\n+        super(BooleanFieldFilterSpec, self).__init__(f, request, params, model,\n+                                                     model_admin,\n+                                                     field_path=field_path)\n+        self.lookup_kwarg = '%s__exact' % self.field_path\n+        self.lookup_kwarg2 = '%s__isnull' % self.field_path\n+        self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n+        self.lookup_val2 = request.GET.get(self.lookup_kwarg2, None)\n+\n+    def title(self):\n+        return self.field.verbose_name\n+\n+    def choices(self, cl):\n+        for k, v in ((_('All'), None), (_('Yes'), '1'), (_('No'), '0')):\n+            yield {'selected': self.lookup_val == v and not self.lookup_val2,\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg: v},\n+                                   [self.lookup_kwarg2]),\n+                   'display': k}\n+        if isinstance(self.field, models.NullBooleanField):\n+            yield {'selected': self.lookup_val2 == 'True',\n+                   'query_string': cl.get_query_string(\n+                                   {self.lookup_kwarg2: 'True'},\n+                                   [self.lookup_kwarg]),\n+                   'display': _('Unknown')}\n+\n+FilterSpec.register(lambda f: isinstance(f, models.BooleanField)\n+                              or isinstance(f, models.NullBooleanField),\n+                                 BooleanFieldFilterSpec)\n+\n class ChoicesFilterSpec(FilterSpec):\n     def __init__(self, f, request, params, model, model_admin,\n                  field_path=None):\n@@ -187,37 +219,6 @@ def choices(self, cl):\n FilterSpec.register(lambda f: isinstance(f, models.DateField),\n                               DateFieldFilterSpec)\n \n-class BooleanFieldFilterSpec(FilterSpec):\n-    def __init__(self, f, request, params, model, model_admin,\n-                 field_path=None):\n-        super(BooleanFieldFilterSpec, self).__init__(f, request, params, model,\n-                                                     model_admin,\n-                                                     field_path=field_path)\n-        self.lookup_kwarg = '%s__exact' % self.field_path\n-        self.lookup_kwarg2 = '%s__isnull' % self.field_path\n-        self.lookup_val = request.GET.get(self.lookup_kwarg, None)\n-        self.lookup_val2 = request.GET.get(self.lookup_kwarg2, None)\n-\n-    def title(self):\n-        return self.field.verbose_name\n-\n-    def choices(self, cl):\n-        for k, v in ((_('All'), None), (_('Yes'), '1'), (_('No'), '0')):\n-            yield {'selected': self.lookup_val == v and not self.lookup_val2,\n-                   'query_string': cl.get_query_string(\n-                                   {self.lookup_kwarg: v},\n-                                   [self.lookup_kwarg2]),\n-                   'display': k}\n-        if isinstance(self.field, models.NullBooleanField):\n-            yield {'selected': self.lookup_val2 == 'True',\n-                   'query_string': cl.get_query_string(\n-                                   {self.lookup_kwarg2: 'True'},\n-                                   [self.lookup_kwarg]),\n-                   'display': _('Unknown')}\n-\n-FilterSpec.register(lambda f: isinstance(f, models.BooleanField)\n-                              or isinstance(f, models.NullBooleanField),\n-                                 BooleanFieldFilterSpec)\n \n # This should be registered last, because it's a last resort. For example,\n # if a field is eligible to use the BooleanFieldFilterSpec, that'd be much"
        },
        {
            "sha": "5b284c77991bbe52ffa7aecc92d0c65d837d5b7d",
            "filename": "tests/regressiontests/admin_filterspecs/models.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/350a56ad4949762ba02f68cf1ba8bac2968507c0/tests%2Fregressiontests%2Fadmin_filterspecs%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/350a56ad4949762ba02f68cf1ba8bac2968507c0/tests%2Fregressiontests%2Fadmin_filterspecs%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filterspecs%2Fmodels.py?ref=350a56ad4949762ba02f68cf1ba8bac2968507c0",
            "patch": "@@ -9,3 +9,15 @@ class Book(models.Model):\n \n     def __unicode__(self):\n         return self.title\n+\n+class BoolTest(models.Model):\n+    NO = False\n+    YES = True\n+    YES_NO_CHOICES = (\n+        (NO, 'no'),\n+        (YES, 'yes')\n+    )\n+    completed = models.BooleanField(\n+        default=NO,\n+        choices=YES_NO_CHOICES\n+    )"
        },
        {
            "sha": "8b9e7343138a91372382825d0ba26dd45a7ff132",
            "filename": "tests/regressiontests/admin_filterspecs/tests.py",
            "status": "modified",
            "additions": 37,
            "deletions": 1,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/350a56ad4949762ba02f68cf1ba8bac2968507c0/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/350a56ad4949762ba02f68cf1ba8bac2968507c0/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filterspecs%2Ftests.py?ref=350a56ad4949762ba02f68cf1ba8bac2968507c0",
            "patch": "@@ -6,7 +6,7 @@\n from django.contrib.admin.views.main import ChangeList\n from django.utils.encoding import force_unicode\n \n-from models import Book\n+from models import Book, BoolTest\n \n def select_by(dictlist, key, value):\n     return [x for x in dictlist if x[key] == value][0]\n@@ -26,6 +26,10 @@ def setUp(self):\n         gipsy_book.contributors = [self.bob, lisa]\n         gipsy_book.save()\n \n+        # BoolTests\n+        self.trueTest = BoolTest.objects.create(completed=True)\n+        self.falseTest = BoolTest.objects.create(completed=False)\n+\n         self.request_factory = RequestFactory()\n \n \n@@ -167,9 +171,41 @@ def test_RelatedFilterSpec_reverse_relationships(self):\n         self.assertEqual(choice['selected'], True)\n         self.assertEqual(choice['query_string'], '?books_contributed__id__exact=%d' % self.django_book.pk)\n \n+    def test_BooleanFilterSpec(self):\n+        modeladmin = BoolTestAdmin(BoolTest, admin.site)\n+\n+        request = self.request_factory.get('/')\n+        changelist = ChangeList(request, BoolTest, modeladmin.list_display, modeladmin.list_display_links,\n+            modeladmin.list_filter, modeladmin.date_hierarchy, modeladmin.search_fields,\n+            modeladmin.list_select_related, modeladmin.list_per_page, modeladmin.list_editable, modeladmin)\n+\n+        # Make sure changelist.get_query_set() does not raise IncorrectLookupParameters\n+        queryset = changelist.get_query_set()\n+\n+        # Make sure the last choice is None and is selected\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEqual(force_unicode(filterspec.title()), u'completed')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEqual(choices[-1]['selected'], False)\n+        self.assertEqual(choices[-1]['query_string'], '?completed__exact=0')\n+\n+        request = self.request_factory.get('/', {'completed__exact': 1})\n+        changelist = self.get_changelist(request, BoolTest, modeladmin)\n+\n+        # Make sure the correct choice is selected\n+        filterspec = changelist.get_filters(request)[0][0]\n+        self.assertEqual(force_unicode(filterspec.title()), u'completed')\n+        # order of choices depends on User model, which has no order\n+        choice = select_by(filterspec.choices(changelist), \"display\", \"Yes\")\n+        self.assertEqual(choice['selected'], True)\n+        self.assertEqual(choice['query_string'], '?completed__exact=1')\n+\n class CustomUserAdmin(UserAdmin):\n     list_filter = ('books_authored', 'books_contributed')\n \n class BookAdmin(admin.ModelAdmin):\n     list_filter = ('year', 'author', 'contributors')\n     order_by = '-id'\n+\n+class BoolTestAdmin(admin.ModelAdmin):\n+    list_filter = ('completed',)"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 81,
        "deletions": 32
    }
}