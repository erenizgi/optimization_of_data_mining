{
    "author": "andrewgodwin",
    "message": "Repoint ForeignKeys when their to= changes.",
    "sha": "a92bae0f0622fb45afb94bf5448b49bc32ebb643",
    "files": [
        {
            "sha": "580d16d1fbdfd858b9dccf2d8cc255dc56a5871d",
            "filename": "django/db/backends/postgresql_psycopg2/introspection.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/a92bae0f0622fb45afb94bf5448b49bc32ebb643/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py",
            "raw_url": "https://github.com/django/django/raw/a92bae0f0622fb45afb94bf5448b49bc32ebb643/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py?ref=a92bae0f0622fb45afb94bf5448b49bc32ebb643",
            "patch": "@@ -118,7 +118,7 @@ def get_constraints(self, cursor, table_name):\n                     \"columns\": set(),\n                     \"primary_key\": kind.lower() == \"primary key\",\n                     \"unique\": kind.lower() in [\"primary key\", \"unique\"],\n-                    \"foreign_key\": set([tuple(x.split(\".\", 1)) for x in used_cols]) if kind.lower() == \"foreign key\" else None,\n+                    \"foreign_key\": tuple(used_cols[0].split(\".\", 1)) if kind.lower() == \"foreign key\" else None,\n                     \"check\": False,\n                     \"index\": False,\n                 }"
        },
        {
            "sha": "55d687a7f678d8db61ca09ed451cb4a9929fe93d",
            "filename": "django/db/backends/schema.py",
            "status": "modified",
            "additions": 30,
            "deletions": 2,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/a92bae0f0622fb45afb94bf5448b49bc32ebb643/django%2Fdb%2Fbackends%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/a92bae0f0622fb45afb94bf5448b49bc32ebb643/django%2Fdb%2Fbackends%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fschema.py?ref=a92bae0f0622fb45afb94bf5448b49bc32ebb643",
            "patch": "@@ -21,7 +21,6 @@ class BaseDatabaseSchemaEditor(object):\n     commit() is called.\n \n     TODO:\n-        - Repointing of FKs\n         - Repointing of M2Ms\n         - Check constraints (PosIntField)\n     \"\"\"\n@@ -401,6 +400,22 @@ def alter_field(self, model, old_field, new_field, strict=False):\n                         \"name\": index_name,\n                     }\n                 )\n+        # Drop any FK constraints, we'll remake them later\n+        if getattr(old_field, \"rel\"):\n+            fk_names = self._constraint_names(model, [old_field.column], foreign_key=True)\n+            if strict and len(fk_names) != 1:\n+                raise ValueError(\"Found wrong number (%s) of foreign key constraints for %s.%s\" % (\n+                    len(fk_names),\n+                    model._meta.db_table,\n+                    old_field.column,\n+                ))\n+            for fk_name in fk_names:\n+                self.execute(\n+                    self.sql_delete_fk % {\n+                        \"table\": self.quote_name(model._meta.db_table),\n+                        \"name\": fk_name,\n+                    }\n+                )\n         # Have they renamed the column?\n         if old_field.column != new_field.column:\n             self.execute(self.sql_rename_column % {\n@@ -516,6 +531,17 @@ def alter_field(self, model, old_field, new_field, strict=False):\n                     \"columns\": self.quote_name(new_field.column),\n                 }\n             )\n+        # Does it have a foreign key?\n+        if getattr(new_field, \"rel\"):\n+            self.execute(\n+                self.sql_create_fk % {\n+                    \"table\": self.quote_name(model._meta.db_table),\n+                    \"name\": self._create_index_name(model, [new_field.column], suffix=\"_fk\"),\n+                    \"column\": self.quote_name(new_field.column),\n+                    \"to_table\": self.quote_name(new_field.rel.to._meta.db_table),\n+                    \"to_column\": self.quote_name(new_field.rel.get_related_field().column),\n+                }\n+            )\n \n     def _type_for_alter(self, field):\n         \"\"\"\n@@ -543,7 +569,7 @@ def _create_index_name(self, model, column_names, suffix=\"\"):\n             index_name = '%s%s' % (table_name[:(self.connection.features.max_index_name_length - len(part))], part)\n         return index_name\n \n-    def _constraint_names(self, model, column_names=None, unique=None, primary_key=None, index=None):\n+    def _constraint_names(self, model, column_names=None, unique=None, primary_key=None, index=None, foreign_key=None):\n         \"Returns all constraint names matching the columns and conditions\"\n         column_names = set(column_names) if column_names else None\n         constraints = self.connection.introspection.get_constraints(self.connection.cursor(), model._meta.db_table)\n@@ -556,5 +582,7 @@ def _constraint_names(self, model, column_names=None, unique=None, primary_key=N\n                     continue\n                 if index is not None and infodict['index'] != index:\n                     continue\n+                if foreign_key is not None and not infodict['foreign_key']:\n+                    continue\n                 result.append(name)\n         return result"
        },
        {
            "sha": "310f74a4e17a78826fab1e06bd7975bad8dc4825",
            "filename": "tests/modeltests/schema/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 4,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/a92bae0f0622fb45afb94bf5448b49bc32ebb643/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a92bae0f0622fb45afb94bf5448b49bc32ebb643/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Ftests.py?ref=a92bae0f0622fb45afb94bf5448b49bc32ebb643",
            "patch": "@@ -5,7 +5,7 @@\n from django.utils.unittest import skipUnless\n from django.db import connection, DatabaseError, IntegrityError\n from django.db.models.fields import IntegerField, TextField, CharField, SlugField\n-from django.db.models.fields.related import ManyToManyField\n+from django.db.models.fields.related import ManyToManyField, ForeignKey\n from django.db.models.loading import cache\n from .models import Author, Book, BookWithSlug, AuthorWithM2M, Tag, TagUniqueRename, UniqueTest\n \n@@ -114,15 +114,16 @@ def test_creation_deletion(self):\n         )\n \n     @skipUnless(connection.features.supports_foreign_keys, \"No FK support\")\n-    def test_creation_fk(self):\n-        \"Tests that creating tables out of FK order works\"\n+    def test_fk(self):\n+        \"Tests that creating tables out of FK order, then repointing, works\"\n         # Create the table\n         editor = connection.schema_editor()\n         editor.start()\n         editor.create_model(Book)\n         editor.create_model(Author)\n+        editor.create_model(Tag)\n         editor.commit()\n-        # Check that both tables are there\n+        # Check that initial tables are there\n         try:\n             list(Author.objects.all())\n         except DatabaseError, e:\n@@ -139,6 +140,26 @@ def test_creation_fk(self):\n                 pub_date = datetime.datetime.now(),\n             )\n             connection.commit()\n+        # Repoint the FK constraint\n+        new_field = ForeignKey(Tag)\n+        new_field.set_attributes_from_name(\"author\")\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.alter_field(\n+            Book,\n+            Book._meta.get_field_by_name(\"author\")[0],\n+            new_field,\n+            strict=True,\n+        )\n+        editor.commit()\n+        # Make sure the new FK constraint is present\n+        constraints = connection.introspection.get_constraints(connection.cursor(), Book._meta.db_table)\n+        for name, details in constraints.items():\n+            if details['columns'] == set([\"author_id\"]) and details['foreign_key']:\n+                self.assertEqual(details['foreign_key'], ('schema_tag', 'id'))\n+                break\n+        else:\n+            self.fail(\"No FK constraint for author_id found\")\n \n     def test_create_field(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 63,
        "additions": 56,
        "deletions": 7
    }
}