{
    "author": "aaugustin",
    "message": "Fixed #2713 -- Made the name of the sitemap view a parameter of the sitemap index view, in order to allow decorators. Also cleaned up code in the area and removed redundant comments from the tests.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17408 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "123f567093eb3bd2f9cb295f4553eb62433c2962",
    "files": [
        {
            "sha": "b675c3d6fb9daba6a45decb1b43b370b5c907181",
            "filename": "django/contrib/sitemaps/tests/basic.py",
            "status": "modified",
            "additions": 11,
            "deletions": 13,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/123f567093eb3bd2f9cb295f4553eb62433c2962/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py",
            "raw_url": "https://github.com/django/django/raw/123f567093eb3bd2f9cb295f4553eb62433c2962/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py?ref=123f567093eb3bd2f9cb295f4553eb62433c2962",
            "patch": "@@ -37,9 +37,7 @@ def tearDown(self):\n \n     def test_simple_sitemap_index(self):\n         \"A simple sitemap index can be rendered\"\n-        # Retrieve the sitemap.\n         response = self.client.get('/simple/index.xml')\n-        # Check for all the important bits:\n         self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n <sitemap><loc>%s/simple/sitemap-simple.xml</loc></sitemap>\n@@ -48,9 +46,7 @@ def test_simple_sitemap_index(self):\n \n     def test_simple_sitemap_custom_index(self):\n         \"A simple sitemap index can be rendered with a custom template\"\n-        # Retrieve the sitemap.\n         response = self.client.get('/simple/custom-index.xml')\n-        # Check for all the important bits:\n         self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <!-- This is a customised template -->\n <sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n@@ -60,9 +56,7 @@ def test_simple_sitemap_custom_index(self):\n \n     def test_simple_sitemap(self):\n         \"A simple sitemap can be rendered\"\n-        # Retrieve the sitemap.\n         response = self.client.get('/simple/sitemap.xml')\n-        # Check for all the important bits:\n         self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n <url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n@@ -71,9 +65,7 @@ def test_simple_sitemap(self):\n \n     def test_simple_custom_sitemap(self):\n         \"A simple sitemap can be rendered with a custom template\"\n-        # Retrieve the sitemap.\n         response = self.client.get('/simple/custom-sitemap.xml')\n-        # Check for all the important bits:\n         self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <!-- This is a customised template -->\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n@@ -98,13 +90,10 @@ def test_localized_priority(self):\n \n     def test_generic_sitemap(self):\n         \"A minimal generic sitemap can be rendered\"\n-        # Retrieve the sitemap.\n         response = self.client.get('/generic/sitemap.xml')\n-\n         expected = ''\n         for username in User.objects.values_list(\"username\", flat=True):\n             expected += \"<url><loc>%s/users/%s/</loc></url>\" % (self.base_url, username)\n-        # Check for all the important bits:\n         self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n %s\n@@ -145,9 +134,7 @@ def test_requestsite_sitemap(self):\n         # Make sure hitting the flatpages sitemap without the sites framework\n         # installed doesn't raise an exception\n         Site._meta.installed = False\n-        # Retrieve the sitemap.\n         response = self.client.get('/simple/sitemap.xml')\n-        # Check for all the important bits:\n         self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n <url><loc>http://testserver/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n@@ -182,3 +169,14 @@ def is_user(url):\n             return isinstance(url['item'], User)\n         item_in_url_info = all(map(is_user, user_sitemap.get_urls()))\n         self.assertTrue(item_in_url_info)\n+\n+    def test_cached_sitemap_index(self):\n+        \"\"\"\n+        Check that a cached sitemap index can be rendered (#2713).\n+        \"\"\"\n+        response = self.client.get('/cached/index.xml')\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+<sitemap><loc>%s/cached/sitemap-simple.xml</loc></sitemap>\n+</sitemapindex>\n+\"\"\" % self.base_url)"
        },
        {
            "sha": "d9ff7200d31cf47d3a51fd263376a69623691655",
            "filename": "django/contrib/sitemaps/tests/urls.py",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/123f567093eb3bd2f9cb295f4553eb62433c2962/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/123f567093eb3bd2f9cb295f4553eb62433c2962/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls.py?ref=123f567093eb3bd2f9cb295f4553eb62433c2962",
            "patch": "@@ -1,7 +1,8 @@\n from datetime import datetime\n-from django.conf.urls import patterns\n-from django.contrib.sitemaps import Sitemap, GenericSitemap, FlatPageSitemap\n+from django.conf.urls import patterns, url\n+from django.contrib.sitemaps import Sitemap, GenericSitemap, FlatPageSitemap, views\n from django.contrib.auth.models import User\n+from django.views.decorators.cache import cache_page\n \n class SimpleSitemap(Sitemap):\n     changefreq = \"never\"\n@@ -28,10 +29,17 @@ def items(self):\n \n urlpatterns = patterns('django.contrib.sitemaps.views',\n     (r'^simple/index\\.xml$', 'index', {'sitemaps': simple_sitemaps}),\n-    (r'^simple/custom-index\\.xml$', 'index', {'sitemaps': simple_sitemaps, 'template_name': 'custom_sitemap_index.xml'}),\n-    (r'^simple/sitemap-(?P<section>.+)\\.xml$', 'sitemap', {'sitemaps': simple_sitemaps}),\n+    (r'^simple/custom-index\\.xml$', 'index',\n+        {'sitemaps': simple_sitemaps, 'template_name': 'custom_sitemap_index.xml'}),\n+    (r'^simple/sitemap-(?P<section>.+)\\.xml$', 'sitemap',\n+        {'sitemaps': simple_sitemaps}),\n     (r'^simple/sitemap\\.xml$', 'sitemap', {'sitemaps': simple_sitemaps}),\n-    (r'^simple/custom-sitemap\\.xml$', 'sitemap', {'sitemaps': simple_sitemaps, 'template_name': 'custom_sitemap.xml'}),\n+    (r'^simple/custom-sitemap\\.xml$', 'sitemap',\n+        {'sitemaps': simple_sitemaps, 'template_name': 'custom_sitemap.xml'}),\n     (r'^generic/sitemap\\.xml$', 'sitemap', {'sitemaps': generic_sitemaps}),\n     (r'^flatpages/sitemap\\.xml$', 'sitemap', {'sitemaps': flatpage_sitemaps}),\n+    url(r'^cached/index\\.xml$', cache_page(1)(views.index),\n+        {'sitemaps': simple_sitemaps, 'sitemap_url_name': 'cached_sitemap'}),\n+    url(r'^cached/sitemap-(?P<section>.+)\\.xml', cache_page(1)(views.sitemap),\n+        {'sitemaps': simple_sitemaps}, name='cached_sitemap')\n )"
        },
        {
            "sha": "2760339f8bc9d780ee9bbbf6a2722c968ddc713d",
            "filename": "django/contrib/sitemaps/views.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/123f567093eb3bd2f9cb295f4553eb62433c2962/django%2Fcontrib%2Fsitemaps%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/123f567093eb3bd2f9cb295f4553eb62433c2962/django%2Fcontrib%2Fsitemaps%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Fviews.py?ref=123f567093eb3bd2f9cb295f4553eb62433c2962",
            "patch": "@@ -4,7 +4,9 @@\n from django.http import Http404\n from django.template.response import TemplateResponse\n \n-def index(request, sitemaps, template_name='sitemap_index.xml', mimetype='application/xml'):\n+def index(request, sitemaps,\n+          template_name='sitemap_index.xml', mimetype='application/xml',\n+          sitemap_url_name='django.contrib.sitemaps.views.sitemap'):\n     current_site = get_current_site(request)\n     sites = []\n     protocol = request.is_secure() and 'https' or 'http'\n@@ -14,14 +16,15 @@ def index(request, sitemaps, template_name='sitemap_index.xml', mimetype='applic\n             pages = site().paginator.num_pages\n         else:\n             pages = site.paginator.num_pages\n-        sitemap_url = urlresolvers.reverse('django.contrib.sitemaps.views.sitemap', kwargs={'section': section})\n+        sitemap_url = urlresolvers.reverse(sitemap_url_name, kwargs={'section': section})\n         sites.append('%s://%s%s' % (protocol, current_site.domain, sitemap_url))\n         if pages > 1:\n             for page in range(2, pages+1):\n                 sites.append('%s://%s%s?p=%s' % (protocol, current_site.domain, sitemap_url, page))\n     return TemplateResponse(request, template_name, {'sitemaps': sites}, content_type=mimetype)\n \n-def sitemap(request, sitemaps, section=None, template_name='sitemap.xml', mimetype='application/xml'):\n+def sitemap(request, sitemaps, section=None,\n+            template_name='sitemap.xml', mimetype='application/xml'):\n     maps, urls = [], []\n     if section is not None:\n         if section not in sitemaps:"
        },
        {
            "sha": "f4ae41766680ac5a8b45d21d0cbf5ff40e6698a0",
            "filename": "docs/ref/contrib/sitemaps.txt",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/123f567093eb3bd2f9cb295f4553eb62433c2962/docs%2Fref%2Fcontrib%2Fsitemaps.txt",
            "raw_url": "https://github.com/django/django/raw/123f567093eb3bd2f9cb295f4553eb62433c2962/docs%2Fref%2Fcontrib%2Fsitemaps.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fsitemaps.txt?ref=123f567093eb3bd2f9cb295f4553eb62433c2962",
            "patch": "@@ -293,11 +293,30 @@ You should create an index file if one of your sitemaps has more than 50,000\n URLs. In this case, Django will automatically paginate the sitemap, and the\n index will reflect that.\n \n-.. versionadded:: 1.3\n+.. versionadded:: 1.4\n+\n+If you are not using the vanilla sitemap view -- for example, if it is wrapped\n+with a caching decorator -- you must name your sitemap view and pass\n+``sitemap_url_name`` to the index view::\n+\n+    from django.contrib.sitemaps import views as sitemaps_views\n+    from django.views.decorators.cache import cache_page\n+\n+    urlpatterns = patterns('',\n+        url(r'^sitemap.xml$',\n+            cache_page(86400)(sitemaps_views.index),\n+            {'sitemaps': sitemaps, 'sitemap_url_name': 'sitemaps'}),\n+        url(r'^sitemap-(?P<section>.+)\\.xml$',\n+            cache_page(86400)(sitemaps_views.sitemap),\n+            {'sitemaps': sitemaps}, name='sitemaps'),\n+    )\n+\n \n Template customization\n ======================\n \n+.. versionadded:: 1.3\n+\n If you wish to use a different template for each sitemap or sitemap index\n available on your site, you may specify it by passing a ``template_name``\n parameter to the ``sitemap`` and ``index`` views via the URLconf::"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 50,
        "deletions": 22
    }
}