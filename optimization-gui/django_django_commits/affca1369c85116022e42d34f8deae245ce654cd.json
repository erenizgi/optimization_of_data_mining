{
    "author": "aaugustin",
    "message": "Fixed #16632 -- Crash on responses without Content-Type with IE. Thanks juan for the report and kenth for the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17196 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "affca1369c85116022e42d34f8deae245ce654cd",
    "files": [
        {
            "sha": "01808648ba41199d6ba6df8516183a40242ab329",
            "filename": "django/http/utils.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/affca1369c85116022e42d34f8deae245ce654cd/django%2Fhttp%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/affca1369c85116022e42d34f8deae245ce654cd/django%2Fhttp%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2Futils.py?ref=affca1369c85116022e42d34f8deae245ce654cd",
            "patch": "@@ -76,7 +76,8 @@ def fix_IE_for_vary(request, response):\n \n     # The first part of the Content-Type field will be the MIME type,\n     # everything after ';', such as character-set, can be ignored.\n-    if response['Content-Type'].split(';')[0] not in safe_mime_types:\n+    mime_type = response.get('Content-Type', '').partition(';')[0]\n+    if mime_type not in safe_mime_types:\n         try:\n             del response['Vary']\n         except KeyError:"
        },
        {
            "sha": "4aed880a7ca15ee652dc60d1ac44da087c3ab332",
            "filename": "tests/regressiontests/utils/http.py",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/affca1369c85116022e42d34f8deae245ce654cd/tests%2Fregressiontests%2Futils%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/affca1369c85116022e42d34f8deae245ce654cd/tests%2Fregressiontests%2Futils%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fhttp.py?ref=affca1369c85116022e42d34f8deae245ce654cd",
            "patch": "@@ -1,6 +1,8 @@\n from django.utils import http\n from django.utils import unittest\n from django.utils.datastructures import MultiValueDict\n+from django.http import HttpResponse, utils\n+from django.test import RequestFactory\n \n class TestUtilsHttp(unittest.TestCase):\n \n@@ -51,3 +53,48 @@ def test_urlencode(self):\n             'position=Developer&name=Adrian&name=Simon'\n         ]\n         self.assertTrue(result in acceptable_results)\n+\n+    def test_fix_IE_for_vary(self):\n+        \"\"\"\n+        Regression for #16632.\n+\n+        `fix_IE_for_vary` shouldn't crash when there's no Content-Type header.\n+        \"\"\"\n+\n+        # functions to generate responses\n+        def response_with_unsafe_content_type():\n+            r = HttpResponse(content_type=\"text/unsafe\")\n+            r['Vary'] = 'Cookie'\n+            return r\n+\n+        def no_content_response_with_unsafe_content_type():\n+            # 'Content-Type' always defaulted, so delete it\n+            r = response_with_unsafe_content_type()\n+            del r['Content-Type']\n+            return r\n+\n+        # request with & without IE user agent\n+        rf = RequestFactory()\n+        request = rf.get('/')\n+        ie_request = rf.get('/', HTTP_USER_AGENT='MSIE')\n+\n+        # not IE, unsafe_content_type\n+        response = response_with_unsafe_content_type()\n+        utils.fix_IE_for_vary(request, response)\n+        self.assertTrue('Vary' in response)\n+\n+        # IE, unsafe_content_type\n+        response = response_with_unsafe_content_type()\n+        utils.fix_IE_for_vary(ie_request, response)\n+        self.assertFalse('Vary' in response)\n+\n+        # not IE, no_content\n+        response = no_content_response_with_unsafe_content_type()\n+        utils.fix_IE_for_vary(request, response)\n+        self.assertTrue('Vary' in response)\n+\n+        # IE, no_content\n+        response = no_content_response_with_unsafe_content_type()\n+        utils.fix_IE_for_vary(ie_request, response)\n+        self.assertFalse('Vary' in response)\n+"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 49,
        "deletions": 1
    }
}