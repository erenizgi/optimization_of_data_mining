{
    "author": "spookylukey",
    "message": "Fixed #17991 - prefetch_related fails with GenericRelation and varchar ID field\n\nThanks to okke@formsma.nl for the report, and carmandrew@gmail.com for the tests.",
    "sha": "4c4d08502cbef6e0ed85470b2a5aade7fafa099f",
    "files": [
        {
            "sha": "726f4aa15099b1b9adaafcf41d679a0385d86074",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/4c4d08502cbef6e0ed85470b2a5aade7fafa099f/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/4c4d08502cbef6e0ed85470b2a5aade7fafa099f/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=4c4d08502cbef6e0ed85470b2a5aade7fafa099f",
            "patch": "@@ -5,7 +5,6 @@\n \n from collections import defaultdict\n from functools import partial\n-from operator import attrgetter\n \n from django.core.exceptions import ObjectDoesNotExist\n from django.db import connection\n@@ -329,8 +328,11 @@ def get_prefetch_query_set(self, instances):\n                     set(obj._get_pk_val() for obj in instances)\n                 }\n             qs = super(GenericRelatedObjectManager, self).get_query_set().using(db).filter(**query)\n+            # We (possibly) need to convert object IDs to the type of the\n+            # instances' PK in order to match up instances:\n+            object_id_converter = instances[0]._meta.pk.to_python\n             return (qs,\n-                    attrgetter(self.object_id_field_name),\n+                    lambda relobj: object_id_converter(getattr(relobj, self.object_id_field_name)),\n                     lambda obj: obj._get_pk_val(),\n                     False,\n                     self.prefetch_cache_name)"
        },
        {
            "sha": "e58997d2000dfebdfb955db471a344c095013703",
            "filename": "tests/modeltests/prefetch_related/models.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/4c4d08502cbef6e0ed85470b2a5aade7fafa099f/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/4c4d08502cbef6e0ed85470b2a5aade7fafa099f/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py?ref=4c4d08502cbef6e0ed85470b2a5aade7fafa099f",
            "patch": "@@ -125,14 +125,22 @@ class TaggedItem(models.Model):\n                                       related_name='taggeditem_set3')\n     created_by_fkey = models.PositiveIntegerField(null=True)\n     created_by = generic.GenericForeignKey('created_by_ct', 'created_by_fkey',)\n+    favorite_ct = models.ForeignKey(ContentType, null=True,\n+                                    related_name='taggeditem_set4')\n+    favorite_fkey = models.CharField(max_length=64, null=True)\n+    favorite = generic.GenericForeignKey('favorite_ct', 'favorite_fkey')\n \n     def __str__(self):\n         return self.tag\n \n \n class Bookmark(models.Model):\n     url = models.URLField()\n-    tags = generic.GenericRelation(TaggedItem)\n+    tags = generic.GenericRelation(TaggedItem, related_name='bookmarks')\n+    favorite_tags = generic.GenericRelation(TaggedItem,\n+                                    content_type_field='favorite_ct',\n+                                    object_id_field='favorite_fkey',\n+                                    related_name='favorite_bookmarks')\n \n \n class Comment(models.Model):"
        },
        {
            "sha": "e81560f01f72265994e5303a55035aec6a7ffcf7",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/4c4d08502cbef6e0ed85470b2a5aade7fafa099f/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4c4d08502cbef6e0ed85470b2a5aade7fafa099f/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=4c4d08502cbef6e0ed85470b2a5aade7fafa099f",
            "patch": "@@ -319,6 +319,16 @@ def test_generic_relation(self):\n                     for t in b.tags.all()]\n             self.assertEqual(sorted(tags), [\"django\", \"python\"])\n \n+    def test_charfield_GFK(self):\n+        b = Bookmark.objects.create(url='http://www.djangoproject.com/')\n+        t1 = TaggedItem.objects.create(content_object=b, tag='django')\n+        t2 = TaggedItem.objects.create(content_object=b, favorite=b, tag='python')\n+\n+        with self.assertNumQueries(3):\n+            bookmark = Bookmark.objects.filter(pk=b.pk).prefetch_related('tags', 'favorite_tags')[0]\n+            self.assertEqual(sorted([i.tag for i in bookmark.tags.all()]), [\"django\", \"python\"])\n+            self.assertEqual([i.tag for i in bookmark.favorite_tags.all()], [\"python\"])\n+\n \n class MultiTableInheritanceTest(TestCase):\n "
        }
    ],
    "stats": {
        "total": 26,
        "additions": 23,
        "deletions": 3
    }
}