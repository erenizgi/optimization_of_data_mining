{
    "author": "akaariai",
    "message": "Fixed #18330 - Made cache culling 3rd party db backend friendly\n\nThis is Ian Kelly's patch from #15580 with minor modifications.",
    "sha": "d3c2eb103f6682c029a850e60dc4cf85896b6aa2",
    "files": [
        {
            "sha": "1ac6ef5d9bffa83a328126574a08d555e084f1cf",
            "filename": "django/core/cache/backends/db.py",
            "status": "modified",
            "additions": 3,
            "deletions": 11,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/d3c2eb103f6682c029a850e60dc4cf85896b6aa2/django%2Fcore%2Fcache%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/d3c2eb103f6682c029a850e60dc4cf85896b6aa2/django%2Fcore%2Fcache%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcache%2Fbackends%2Fdb.py?ref=d3c2eb103f6682c029a850e60dc4cf85896b6aa2",
            "patch": "@@ -167,17 +167,9 @@ def _cull(self, db, cursor, now):\n             num = cursor.fetchone()[0]\n             if num > self._max_entries:\n                 cull_num = num / self._cull_frequency\n-                if connections[db].vendor == 'oracle':\n-                    # Oracle doesn't support LIMIT + OFFSET\n-                    cursor.execute(\"\"\"SELECT cache_key FROM\n-(SELECT ROW_NUMBER() OVER (ORDER BY cache_key) AS counter, cache_key FROM %s)\n-WHERE counter > %%s AND COUNTER <= %%s\"\"\" % table, [cull_num, cull_num + 1])\n-                else:\n-                    # This isn't standard SQL, it's likely to break\n-                    # with some non officially supported databases\n-                    cursor.execute(\"SELECT cache_key FROM %s \"\n-                                   \"ORDER BY cache_key \"\n-                                   \"LIMIT 1 OFFSET %%s\" % table, [cull_num])\n+                cursor.execute(\n+                    connections[db].ops.cache_key_culling_sql() % table,\n+                    [cull_num])\n                 cursor.execute(\"DELETE FROM %s \"\n                                \"WHERE cache_key < %%s\" % table,\n                                [cursor.fetchone()[0]])"
        },
        {
            "sha": "2da1f2be0f4ab4ec8fe8b5621403bb6adf42887f",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/d3c2eb103f6682c029a850e60dc4cf85896b6aa2/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/d3c2eb103f6682c029a850e60dc4cf85896b6aa2/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=d3c2eb103f6682c029a850e60dc4cf85896b6aa2",
            "patch": "@@ -475,6 +475,16 @@ def autoinc_sql(self, table, column):\n         \"\"\"\n         return None\n \n+    def cache_key_culling_sql(self):\n+        \"\"\"\n+        Returns a SQL query that retrieves the first cache key greater than the\n+        n smallest.\n+\n+        This is used by the 'db' cache backend to determine where to start\n+        culling.\n+        \"\"\"\n+        return \"SELECT cache_key FROM %s ORDER BY cache_key LIMIT 1 OFFSET %%s\"\n+\n     def date_extract_sql(self, lookup_type, field_name):\n         \"\"\"\n         Given a lookup_type of 'year', 'month' or 'day', returns the SQL that"
        },
        {
            "sha": "49b628075b8b47984fde08ac1924c409121256c6",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/d3c2eb103f6682c029a850e60dc4cf85896b6aa2/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/d3c2eb103f6682c029a850e60dc4cf85896b6aa2/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=d3c2eb103f6682c029a850e60dc4cf85896b6aa2",
            "patch": "@@ -118,6 +118,13 @@ def autoinc_sql(self, table, column):\n /\"\"\" % locals()\n         return sequence_sql, trigger_sql\n \n+    def cache_key_culling_sql(self):\n+        return \"\"\"\n+            SELECT cache_key\n+              FROM (SELECT cache_key, rank() OVER (ORDER BY cache_key) AS rank FROM %s)\n+             WHERE rank = %%s + 1\n+        \"\"\"\n+\n     def date_extract_sql(self, lookup_type, field_name):\n         # http://download-east.oracle.com/docs/cd/B10501_01/server.920/a96540/functions42a.htm#1017163\n         if lookup_type == 'week_day':"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 20,
        "deletions": 11
    }
}