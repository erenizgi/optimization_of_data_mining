{
    "author": "ramiro",
    "message": "Made createsuperuser more robust when getting current OS username.\n\nUnder some versions of OS X, failure in getting the default system\nlocale during the syncdb operation of the auth app were causing hard to\ndiagnose problems afterwards.\n\nNo solution based on getpreferredencoding() was chosen because it has\nits own problems with certain combinations of Python and OS X versions\n(e.g. http://bugs.python.org/issue6202).\n\nThanks prestonsimmons for the report and prestonsimmons and willhardy\nfor the initial patch.\n\nFixes #16017.",
    "sha": "4c934f3921a59c7b3e088f6472b6f6da40848567",
    "files": [
        {
            "sha": "83e15183877fe5a0ac5dac0e6d234ba6f2e34782",
            "filename": "django/contrib/auth/management/__init__.py",
            "status": "modified",
            "additions": 11,
            "deletions": 8,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/4c934f3921a59c7b3e088f6472b6f6da40848567/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/4c934f3921a59c7b3e088f6472b6f6da40848567/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py?ref=4c934f3921a59c7b3e088f6472b6f6da40848567",
            "patch": "@@ -84,14 +84,17 @@ def get_system_username():\n     :returns: The username as a unicode string, or an empty string if the\n         username could not be determined.\n     \"\"\"\n-    try:\n-        return getpass.getuser().decode(locale.getdefaultlocale()[1])\n-    except (ImportError, KeyError, UnicodeDecodeError):\n-        # KeyError will be raised by os.getpwuid() (called by getuser())\n-        # if there is no corresponding entry in the /etc/passwd file\n-        # (a very restricted chroot environment, for example).\n-        # UnicodeDecodeError - preventive treatment for non-latin Windows.\n-        return ''\n+    default_locale = locale.getdefaultlocale()[1]\n+    if default_locale:\n+        try:\n+            return getpass.getuser().decode(default_locale)\n+        except (ImportError, KeyError, UnicodeDecodeError):\n+            # KeyError will be raised by os.getpwuid() (called by getuser())\n+            # if there is no corresponding entry in the /etc/passwd file\n+            # (a very restricted chroot environment, for example).\n+            # UnicodeDecodeError - preventive treatment for non-latin Windows.\n+            pass\n+    return ''\n \n \n def get_default_username(check_db=True):"
        },
        {
            "sha": "710754b8f1ed5e40a8ab24990f4f7bae5d803ea2",
            "filename": "django/contrib/auth/tests/basic.py",
            "status": "modified",
            "additions": 38,
            "deletions": 6,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/4c934f3921a59c7b3e088f6472b6f6da40848567/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py",
            "raw_url": "https://github.com/django/django/raw/4c934f3921a59c7b3e088f6472b6f6da40848567/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py?ref=4c934f3921a59c7b3e088f6472b6f6da40848567",
            "patch": "@@ -1,13 +1,11 @@\n+import locale\n+import traceback\n+\n+from django.contrib.auth.management.commands import createsuperuser\n from django.contrib.auth.models import User, AnonymousUser\n from django.core.management import call_command\n from django.test import TestCase\n from django.utils.six import StringIO\n-from django.utils.unittest import skipUnless\n-\n-try:\n-    import crypt as crypt_module\n-except ImportError:\n-    crypt_module = None\n \n \n class BasicTestCase(TestCase):\n@@ -111,3 +109,37 @@ def test_createsuperuser_management_command(self):\n         u = User.objects.get(username=\"joe+admin@somewhere.org\")\n         self.assertEqual(u.email, 'joe@somewhere.org')\n         self.assertFalse(u.has_usable_password())\n+\n+    def test_createsuperuser_nolocale(self):\n+        \"\"\"\n+        Check that createsuperuser does not break when no locale is set. See\n+        ticket #16017.\n+        \"\"\"\n+\n+        old_getdefaultlocale = locale.getdefaultlocale\n+        old_getpass = createsuperuser.getpass\n+        try:\n+            # Temporarily remove locale information\n+            locale.getdefaultlocale = lambda: (None, None)\n+\n+            # Temporarily replace getpass to allow interactive code to be used\n+            # non-interactively\n+            class mock_getpass: pass\n+            mock_getpass.getpass = staticmethod(lambda p=None: \"nopasswd\")\n+            createsuperuser.getpass = mock_getpass\n+\n+            # Call the command in this new environment\n+            new_io = StringIO()\n+            call_command(\"createsuperuser\", interactive=True, username=\"nolocale@somewhere.org\", email=\"nolocale@somewhere.org\", stdout=new_io)\n+\n+        except TypeError as e:\n+            self.fail(\"createsuperuser fails if the OS provides no information about the current locale\")\n+\n+        finally:\n+            # Re-apply locale and getpass information\n+            createsuperuser.getpass = old_getpass\n+            locale.getdefaultlocale = old_getdefaultlocale\n+\n+        # If we were successful, a user should have been created\n+        u = User.objects.get(username=\"nolocale@somewhere.org\")\n+        self.assertEqual(u.email, 'nolocale@somewhere.org')"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 49,
        "deletions": 14
    }
}