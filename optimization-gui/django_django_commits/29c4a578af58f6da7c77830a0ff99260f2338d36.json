{
    "author": "freakboy3742",
    "message": "Fixed #10863 -- Added HTML support to mail_managers() and mail_admins(), and used this to provide more and prettier detail in error emails. Thanks to boxed for the suggestion, and to Rob Hudson and Brodie Rao for their work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14844 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "29c4a578af58f6da7c77830a0ff99260f2338d36",
    "files": [
        {
            "sha": "a3ad837bc9ee71ff3f841fbb020abf88b6a70386",
            "filename": "django/core/mail/__init__.py",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/29c4a578af58f6da7c77830a0ff99260f2338d36/django%2Fcore%2Fmail%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/29c4a578af58f6da7c77830a0ff99260f2338d36/django%2Fcore%2Fmail%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2F__init__.py?ref=29c4a578af58f6da7c77830a0ff99260f2338d36",
            "patch": "@@ -83,22 +83,30 @@ def send_mass_mail(datatuple, fail_silently=False, auth_user=None,\n     return connection.send_messages(messages)\n \n \n-def mail_admins(subject, message, fail_silently=False, connection=None):\n+def mail_admins(subject, message, fail_silently=False, connection=None,\n+                html_message=None):\n     \"\"\"Sends a message to the admins, as defined by the ADMINS setting.\"\"\"\n     if not settings.ADMINS:\n         return\n-    EmailMessage(u'%s%s' % (settings.EMAIL_SUBJECT_PREFIX, subject), message,\n-                 settings.SERVER_EMAIL, [a[1] for a in settings.ADMINS],\n-                 connection=connection).send(fail_silently=fail_silently)\n+    mail = EmailMultiAlternatives(u'%s%s' % (settings.EMAIL_SUBJECT_PREFIX, subject),\n+                message, settings.SERVER_EMAIL, [a[1] for a in settings.ADMINS],\n+                connection=connection)\n+    if html_message:\n+        mail.attach_alternative(html_message, 'text/html')\n+    mail.send(fail_silently=fail_silently)\n \n \n-def mail_managers(subject, message, fail_silently=False, connection=None):\n+def mail_managers(subject, message, fail_silently=False, connection=None,\n+                  html_message=None):\n     \"\"\"Sends a message to the managers, as defined by the MANAGERS setting.\"\"\"\n     if not settings.MANAGERS:\n         return\n-    EmailMessage(u'%s%s' % (settings.EMAIL_SUBJECT_PREFIX, subject), message,\n-                 settings.SERVER_EMAIL, [a[1] for a in settings.MANAGERS],\n-                 connection=connection).send(fail_silently=fail_silently)\n+    mail = EmailMultiAlternatives(u'%s%s' % (settings.EMAIL_SUBJECT_PREFIX, subject),\n+                message, settings.SERVER_EMAIL, [a[1] for a in settings.MANAGERS],\n+                connection=connection)\n+    if html_message:\n+        mail.attach_alternative(html_message, 'text/html')\n+    mail.send(fail_silently=fail_silently)\n \n \n class SMTPConnection(_SMTPConnection):"
        },
        {
            "sha": "d3c8e67a30700dc1a85de3f3b6ed7fcb3d3fdd9e",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/29c4a578af58f6da7c77830a0ff99260f2338d36/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/29c4a578af58f6da7c77830a0ff99260f2338d36/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=29c4a578af58f6da7c77830a0ff99260f2338d36",
            "patch": "@@ -56,6 +56,7 @@ class AdminEmailHandler(logging.Handler):\n     def emit(self, record):\n         import traceback\n         from django.conf import settings\n+        from django.views.debug import ExceptionReporter\n \n         try:\n             if sys.version_info < (2,5):\n@@ -75,12 +76,18 @@ def emit(self, record):\n             request_repr = repr(request)\n         except:\n             subject = 'Error: Unknown URL'\n+            request = None\n             request_repr = \"Request repr() unavailable\"\n \n         if record.exc_info:\n+            exc_info = record.exc_info\n             stack_trace = '\\n'.join(traceback.format_exception(*record.exc_info))\n         else:\n+            exc_info = ()\n             stack_trace = 'No stack trace available'\n \n         message = \"%s\\n\\n%s\" % (stack_trace, request_repr)\n-        mail.mail_admins(subject, message, fail_silently=True)\n+        reporter = ExceptionReporter(request, *exc_info, is_email=True)\n+        html_message = reporter.get_traceback_html()\n+        mail.mail_admins(subject, message, fail_silently=True,\n+                         html_message=html_message)"
        },
        {
            "sha": "5c75a49e9acbcc187c143ce3ac04e71fb64e6509",
            "filename": "django/views/debug.py",
            "status": "modified",
            "additions": 34,
            "deletions": 20,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/29c4a578af58f6da7c77830a0ff99260f2338d36/django%2Fviews%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/29c4a578af58f6da7c77830a0ff99260f2338d36/django%2Fviews%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdebug.py?ref=29c4a578af58f6da7c77830a0ff99260f2338d36",
            "patch": "@@ -62,11 +62,12 @@ class ExceptionReporter:\n     \"\"\"\n     A class to organize and coordinate reporting on exceptions.\n     \"\"\"\n-    def __init__(self, request, exc_type, exc_value, tb):\n+    def __init__(self, request, exc_type, exc_value, tb, is_email=False):\n         self.request = request\n         self.exc_type = exc_type\n         self.exc_value = exc_value\n         self.tb = tb\n+        self.is_email = is_email\n \n         self.template_info = None\n         self.template_does_not_exist = False\n@@ -118,6 +119,7 @@ def get_traceback_html(self):\n         from django import get_version\n         t = Template(TECHNICAL_500_TEMPLATE, name='Technical 500 template')\n         c = Context({\n+            'is_email': self.is_email,\n             'exception_type': self.exc_type.__name__,\n             'exception_value': smart_unicode(self.exc_value, errors='replace'),\n             'unicode_hint': unicode_hint,\n@@ -324,7 +326,7 @@ def empty_urlconf(request):\n     table.vars { margin:5px 0 2px 40px; }\n     table.vars td, table.req td { font-family:monospace; }\n     table td.code { width:100%; }\n-    table td.code div { overflow:hidden; }\n+    table td.code pre { overflow:hidden; }\n     table.source th { color:#666; }\n     table.source td { font-family:monospace; white-space:pre; border-bottom:1px solid #eee; }\n     ul.traceback { list-style-type:none; }\n@@ -353,6 +355,7 @@ def empty_urlconf(request):\n     span.commands a:link {color:#5E5694;}\n     pre.exception_value { font-family: sans-serif; color: #666; font-size: 1.5em; margin: 10px 0 10px 0; }\n   </style>\n+  {% if not is_email %}\n   <script type=\"text/javascript\">\n   //<!--\n     function getElementsByClassName(oElm, strTagName, strClassName){\n@@ -408,10 +411,11 @@ def empty_urlconf(request):\n     }\n     //-->\n   </script>\n+  {% endif %}\n </head>\n <body>\n <div id=\"summary\">\n-  <h1>{{ exception_type }} at {{ request.path_info|escape }}</h1>\n+  <h1>{{ exception_type }}{% if request %} at {{ request.path_info|escape }}{% endif %}</h1>\n   <pre class=\"exception_value\">{{ exception_value|force_escape }}</pre>\n   <table class=\"meta\">\n     <tr>\n@@ -448,7 +452,7 @@ def empty_urlconf(request):\n     </tr>\n     <tr>\n       <th>Python Path:</th>\n-      <td>{{ sys_path }}</td>\n+      <td><pre>{{ sys_path|pprint }}</pre></td>\n     </tr>\n     <tr>\n       <th>Server time:</th>\n@@ -498,7 +502,7 @@ def empty_urlconf(request):\n </div>\n {% endif %}\n <div id=\"traceback\">\n-  <h2>Traceback <span class=\"commands\"><a href=\"#\" onclick=\"return switchPastebinFriendly(this);\">Switch to copy-and-paste view</a></span></h2>\n+  <h2>Traceback <span class=\"commands\">{% if not is_email %}<a href=\"#\" onclick=\"return switchPastebinFriendly(this);\">Switch to copy-and-paste view</a></span>{% endif %}</h2>\n   {% autoescape off %}\n   <div id=\"browserTraceback\">\n     <ul class=\"traceback\">\n@@ -508,19 +512,23 @@ def empty_urlconf(request):\n \n           {% if frame.context_line %}\n             <div class=\"context\" id=\"c{{ frame.id }}\">\n-              {% if frame.pre_context %}\n-                <ol start=\"{{ frame.pre_context_lineno }}\" class=\"pre-context\" id=\"pre{{ frame.id }}\">{% for line in frame.pre_context %}<li onclick=\"toggle('pre{{ frame.id }}', 'post{{ frame.id }}')\">{{ line|escape }}</li>{% endfor %}</ol>\n+              {% if frame.pre_context and not is_email %}\n+                <ol start=\"{{ frame.pre_context_lineno }}\" class=\"pre-context\" id=\"pre{{ frame.id }}\">{% for line in frame.pre_context %}<li onclick=\"toggle('pre{{ frame.id }}', 'post{{ frame.id }}')\"><pre>{{ line|escape }}</pre></li>{% endfor %}</ol>\n               {% endif %}\n-              <ol start=\"{{ frame.lineno }}\" class=\"context-line\"><li onclick=\"toggle('pre{{ frame.id }}', 'post{{ frame.id }}')\">{{ frame.context_line|escape }} <span>...</span></li></ol>\n-              {% if frame.post_context %}\n-                <ol start='{{ frame.lineno|add:\"1\" }}' class=\"post-context\" id=\"post{{ frame.id }}\">{% for line in frame.post_context %}<li onclick=\"toggle('pre{{ frame.id }}', 'post{{ frame.id }}')\">{{ line|escape }}</li>{% endfor %}</ol>\n+              <ol start=\"{{ frame.lineno }}\" class=\"context-line\"><li onclick=\"toggle('pre{{ frame.id }}', 'post{{ frame.id }}')\"><pre>{{ frame.context_line|escape }}</pre>{% if not is_email %} <span>...</span>{% endif %}</li></ol>\n+              {% if frame.post_context and not is_email  %}\n+                <ol start='{{ frame.lineno|add:\"1\" }}' class=\"post-context\" id=\"post{{ frame.id }}\">{% for line in frame.post_context %}<li onclick=\"toggle('pre{{ frame.id }}', 'post{{ frame.id }}')\"><pre>{{ line|escape }}</pre></li>{% endfor %}</ol>\n               {% endif %}\n             </div>\n           {% endif %}\n \n           {% if frame.vars %}\n             <div class=\"commands\">\n-                <a href=\"#\" onclick=\"return varToggle(this, '{{ frame.id }}')\"><span>&#x25b6;</span> Local vars</a>\n+                {% if is_email %}\n+                    <h2>Local Vars</h2>\n+                {% else %}\n+                    <a href=\"#\" onclick=\"return varToggle(this, '{{ frame.id }}')\"><span>&#x25b6;</span> Local vars</a>\n+                {% endif %}\n             </div>\n             <table class=\"vars\" id=\"v{{ frame.id }}\">\n               <thead>\n@@ -533,7 +541,7 @@ def empty_urlconf(request):\n                 {% for var in frame.vars|dictsort:\"0\" %}\n                   <tr>\n                     <td>{{ var.0|force_escape }}</td>\n-                    <td class=\"code\"><div>{{ var.1|pprint|force_escape }}</div></td>\n+                    <td class=\"code\"><pre>{{ var.1|pprint|force_escape }}</pre></td>\n                   </tr>\n                 {% endfor %}\n               </tbody>\n@@ -545,16 +553,19 @@ def empty_urlconf(request):\n   </div>\n   {% endautoescape %}\n   <form action=\"http://dpaste.com/\" name=\"pasteform\" id=\"pasteform\" method=\"post\">\n+{% if not is_email %}\n   <div id=\"pastebinTraceback\" class=\"pastebin\">\n     <input type=\"hidden\" name=\"language\" value=\"PythonConsole\">\n-    <input type=\"hidden\" name=\"title\" value=\"{{ exception_type|escape }} at {{ request.path_info|escape }}\">\n+    <input type=\"hidden\" name=\"title\" value=\"{{ exception_type|escape }}{% if request %} at {{ request.path_info|escape }}{% endif %}\">\n     <input type=\"hidden\" name=\"source\" value=\"Django Dpaste Agent\">\n     <input type=\"hidden\" name=\"poster\" value=\"Django\">\n     <textarea name=\"content\" id=\"traceback_area\" cols=\"140\" rows=\"25\">\n Environment:\n \n+{% if request %}\n Request Method: {{ request.META.REQUEST_METHOD }}\n Request URL: {{ request.build_absolute_uri|escape }}\n+{% endif %}\n Django Version: {{ django_version_info }}\n Python Version: {{ sys_version_info }}\n Installed Applications:\n@@ -581,18 +592,20 @@ def empty_urlconf(request):\n {% for frame in frames %}File \"{{ frame.filename|escape }}\" in {{ frame.function|escape }}\n {% if frame.context_line %}  {{ frame.lineno }}. {{ frame.context_line|escape }}{% endif %}\n {% endfor %}\n-Exception Type: {{ exception_type|escape }} at {{ request.path_info|escape }}\n+Exception Type: {{ exception_type|escape }}{% if request %} at {{ request.path_info|escape }}{% endif %}\n Exception Value: {{ exception_value|force_escape }}\n </textarea>\n   <br><br>\n   <input type=\"submit\" value=\"Share this traceback on a public Web site\">\n   </div>\n </form>\n </div>\n+{% endif %}\n \n <div id=\"requestinfo\">\n   <h2>Request information</h2>\n \n+{% if request %}\n   <h3 id=\"get-info\">GET</h3>\n   {% if request.GET %}\n     <table class=\"req\">\n@@ -606,7 +619,7 @@ def empty_urlconf(request):\n         {% for var in request.GET.items %}\n           <tr>\n             <td>{{ var.0 }}</td>\n-            <td class=\"code\"><div>{{ var.1|pprint }}</div></td>\n+            <td class=\"code\"><pre>{{ var.1|pprint }}</pre></td>\n           </tr>\n         {% endfor %}\n       </tbody>\n@@ -628,7 +641,7 @@ def empty_urlconf(request):\n         {% for var in request.POST.items %}\n           <tr>\n             <td>{{ var.0 }}</td>\n-            <td class=\"code\"><div>{{ var.1|pprint }}</div></td>\n+            <td class=\"code\"><pre>{{ var.1|pprint }}</pre></td>\n           </tr>\n         {% endfor %}\n       </tbody>\n@@ -649,7 +662,7 @@ def empty_urlconf(request):\n             {% for var in request.FILES.items %}\n                 <tr>\n                     <td>{{ var.0 }}</td>\n-                    <td class=\"code\"><div>{{ var.1|pprint }}</div></td>\n+                    <td class=\"code\"><pre>{{ var.1|pprint }}</pre></td>\n                 </tr>\n             {% endfor %}\n         </tbody>\n@@ -672,7 +685,7 @@ def empty_urlconf(request):\n         {% for var in request.COOKIES.items %}\n           <tr>\n             <td>{{ var.0 }}</td>\n-            <td class=\"code\"><div>{{ var.1|pprint }}</div></td>\n+            <td class=\"code\"><pre>{{ var.1|pprint }}</pre></td>\n           </tr>\n         {% endfor %}\n       </tbody>\n@@ -693,11 +706,12 @@ def empty_urlconf(request):\n       {% for var in request.META.items|dictsort:\"0\" %}\n         <tr>\n           <td>{{ var.0 }}</td>\n-          <td class=\"code\"><div>{{ var.1|pprint }}</div></td>\n+          <td class=\"code\"><pre>{{ var.1|pprint }}</pre></td>\n         </tr>\n       {% endfor %}\n     </tbody>\n   </table>\n+{% endif %}\n \n   <h3 id=\"settings-info\">Settings</h3>\n   <h4>Using settings module <code>{{ settings.SETTINGS_MODULE }}</code></h4>\n@@ -712,7 +726,7 @@ def empty_urlconf(request):\n       {% for var in settings.items|dictsort:\"0\" %}\n         <tr>\n           <td>{{ var.0 }}</td>\n-          <td class=\"code\"><div>{{ var.1|pprint }}</div></td>\n+          <td class=\"code\"><pre>{{ var.1|pprint }}</pre></td>\n         </tr>\n       {% endfor %}\n     </tbody>"
        },
        {
            "sha": "79ab8b3f16aa531164dde6d5314d1394ba778924",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/29c4a578af58f6da7c77830a0ff99260f2338d36/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/29c4a578af58f6da7c77830a0ff99260f2338d36/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=29c4a578af58f6da7c77830a0ff99260f2338d36",
            "patch": "@@ -163,6 +163,12 @@ requests. These include:\n \n     * Support for _HTTPOnly cookies.\n \n+    * mail_admins() and mail_managers() now support easily attaching\n+      HTML content to messages.\n+\n+    * Error emails now include more of the detail and formatting of\n+      the debug server error page.\n+\n .. _HTTPOnly: http://www.owasp.org/index.php/HTTPOnly\n \n .. _backwards-incompatible-changes-1.3:"
        },
        {
            "sha": "ad148a5a6fce7c2edffdcd56df248c54fcccb1f5",
            "filename": "docs/topics/email.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/29c4a578af58f6da7c77830a0ff99260f2338d36/docs%2Ftopics%2Femail.txt",
            "raw_url": "https://github.com/django/django/raw/29c4a578af58f6da7c77830a0ff99260f2338d36/docs%2Ftopics%2Femail.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Femail.txt?ref=29c4a578af58f6da7c77830a0ff99260f2338d36",
            "patch": "@@ -109,7 +109,7 @@ a single connection for all of its messages. This makes\n mail_admins()\n =============\n \n-.. function:: mail_admins(subject, message, fail_silently=False, connection=None)\n+.. function:: mail_admins(subject, message, fail_silently=False, connection=None, html_message=None)\n \n ``django.core.mail.mail_admins()`` is a shortcut for sending an e-mail to the\n site admins, as defined in the :setting:`ADMINS` setting.\n@@ -122,10 +122,16 @@ The \"From:\" header of the e-mail will be the value of the\n \n This method exists for convenience and readability.\n \n+.. versionchanged:: 1.3\n+\n+If ``html_message`` is provided, the resulting e-mail will be a\n+multipart/alternative e-mail with ``message`` as the \"text/plain\"\n+content type and ``html_message`` as the \"text/html\" content type.\n+\n mail_managers()\n ===============\n \n-.. function:: mail_managers(subject, message, fail_silently=False, connection=None)\n+.. function:: mail_managers(subject, message, fail_silently=False, connection=None, html_message=None)\n \n ``django.core.mail.mail_managers()`` is just like ``mail_admins()``, except it\n sends an e-mail to the site managers, as defined in the :setting:`MANAGERS`"
        },
        {
            "sha": "327159eb7f77d92cb4caa9f18358b0b3f33605af",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/29c4a578af58f6da7c77830a0ff99260f2338d36/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/29c4a578af58f6da7c77830a0ff99260f2338d36/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=29c4a578af58f6da7c77830a0ff99260f2338d36",
            "patch": "@@ -232,7 +232,7 @@ def test_locmem(self):\n         self.assertEqual(len(mail.outbox), 2)\n         self.assertEqual(mail.outbox[0].subject, 'Subject')\n         self.assertEqual(mail.outbox[1].subject, 'Subject 2')\n-        \n+\n         # Make sure that multiple locmem connections share mail.outbox\n         mail.outbox = []\n         connection2 = locmem.EmailBackend()\n@@ -364,6 +364,36 @@ def test_mail_prefix(self):\n         settings.ADMINS = old_admins\n         settings.MANAGERS = old_managers\n \n+    def test_html_mail_admins(self):\n+        \"\"\"Test html_message argument to mail_admins and mail_managers\"\"\"\n+        old_admins = settings.ADMINS\n+        settings.ADMINS = [('nobody','nobody@example.com')]\n+\n+        mail.outbox = []\n+        mail_admins('Subject', 'Content', html_message='HTML Content')\n+        self.assertEqual(len(mail.outbox), 1)\n+        message = mail.outbox[0]\n+        self.assertEqual(message.subject, '[Django] Subject')\n+        self.assertEqual(message.body, 'Content')\n+        self.assertEqual(message.alternatives, [('HTML Content', 'text/html')])\n+\n+        settings.ADMINS = old_admins\n+\n+    def test_html_mail_managers(self):\n+        \"\"\"Test html_message argument to mail_admins and mail_managers\"\"\"\n+        old_managers = settings.MANAGERS\n+        settings.MANAGERS = [('nobody','nobody@example.com')]\n+\n+        mail.outbox = []\n+        mail_managers('Subject', 'Content', html_message='HTML Content')\n+        self.assertEqual(len(mail.outbox), 1)\n+        message = mail.outbox[0]\n+        self.assertEqual(message.subject, '[Django] Subject')\n+        self.assertEqual(message.body, 'Content')\n+        self.assertEqual(message.alternatives, [('HTML Content', 'text/html')])\n+\n+        settings.MANAGERS = old_managers\n+\n     def test_idn_validation(self):\n         \"\"\"Test internationalized email adresses\"\"\"\n         # Regression for #14301."
        }
    ],
    "stats": {
        "total": 135,
        "additions": 103,
        "deletions": 32
    }
}