{
    "author": "aaugustin",
    "message": "Upgraded django.contrib.sessions to be compatible with time zone support.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17121 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4ac594f8a55c94f6192fb33bb8f7b8a8ca671360",
    "files": [
        {
            "sha": "4ddb35a8328923065f1f04108f7cb33ad42d8be0",
            "filename": "django/contrib/sessions/backends/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/4ac594f8a55c94f6192fb33bb8f7b8a8ca671360/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/4ac594f8a55c94f6192fb33bb8f7b8a8ca671360/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py?ref=4ac594f8a55c94f6192fb33bb8f7b8a8ca671360",
            "patch": "@@ -12,6 +12,7 @@\n from django.conf import settings\n from django.core.exceptions import SuspiciousOperation\n from django.utils.crypto import constant_time_compare, salted_hmac\n+from django.utils import timezone\n \n # Use the system (hardware-based) random number generator if it exists.\n if hasattr(random, 'SystemRandom'):\n@@ -188,7 +189,7 @@ def get_expiry_age(self):\n             return settings.SESSION_COOKIE_AGE\n         if not isinstance(expiry, datetime):\n             return expiry\n-        delta = expiry - datetime.now()\n+        delta = expiry - timezone.now()\n         return delta.days * 86400 + delta.seconds\n \n     def get_expiry_date(self):\n@@ -198,7 +199,7 @@ def get_expiry_date(self):\n             return expiry\n         if not expiry:   # Checks both None and 0 cases\n             expiry = settings.SESSION_COOKIE_AGE\n-        return datetime.now() + timedelta(seconds=expiry)\n+        return timezone.now() + timedelta(seconds=expiry)\n \n     def set_expiry(self, value):\n         \"\"\"\n@@ -223,7 +224,7 @@ def set_expiry(self, value):\n                 pass\n             return\n         if isinstance(value, timedelta):\n-            value = datetime.now() + value\n+            value = timezone.now() + value\n         self['_session_expiry'] = value\n \n     def get_expire_at_browser_close(self):"
        },
        {
            "sha": "7d4c535fd4ab11122a915b59decaec289bdc2a5a",
            "filename": "django/contrib/sessions/backends/db.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/4ac594f8a55c94f6192fb33bb8f7b8a8ca671360/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/4ac594f8a55c94f6192fb33bb8f7b8a8ca671360/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py?ref=4ac594f8a55c94f6192fb33bb8f7b8a8ca671360",
            "patch": "@@ -1,8 +1,8 @@\n-import datetime\n from django.contrib.sessions.backends.base import SessionBase, CreateError\n from django.core.exceptions import SuspiciousOperation\n from django.db import IntegrityError, transaction, router\n from django.utils.encoding import force_unicode\n+from django.utils import timezone\n \n \n class SessionStore(SessionBase):\n@@ -16,7 +16,7 @@ def load(self):\n         try:\n             s = Session.objects.get(\n                 session_key = self.session_key,\n-                expire_date__gt=datetime.datetime.now()\n+                expire_date__gt=timezone.now()\n             )\n             return self.decode(force_unicode(s.session_data))\n         except (Session.DoesNotExist, SuspiciousOperation):"
        },
        {
            "sha": "ce39fef0ad4e8e14612c53d350e90b3d41824d2d",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/4ac594f8a55c94f6192fb33bb8f7b8a8ca671360/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4ac594f8a55c94f6192fb33bb8f7b8a8ca671360/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=4ac594f8a55c94f6192fb33bb8f7b8a8ca671360",
            "patch": "@@ -16,6 +16,7 @@\n from django.http import HttpResponse\n from django.test import TestCase, RequestFactory\n from django.test.utils import override_settings\n+from django.utils import timezone\n from django.utils import unittest\n \n \n@@ -187,7 +188,7 @@ def test_default_expiry(self):\n     def test_custom_expiry_seconds(self):\n         # Using seconds\n         self.session.set_expiry(10)\n-        delta = self.session.get_expiry_date() - datetime.now()\n+        delta = self.session.get_expiry_date() - timezone.now()\n         self.assertTrue(delta.seconds in (9, 10))\n \n         age = self.session.get_expiry_age()\n@@ -196,16 +197,16 @@ def test_custom_expiry_seconds(self):\n     def test_custom_expiry_timedelta(self):\n         # Using timedelta\n         self.session.set_expiry(timedelta(seconds=10))\n-        delta = self.session.get_expiry_date() - datetime.now()\n+        delta = self.session.get_expiry_date() - timezone.now()\n         self.assertTrue(delta.seconds in (9, 10))\n \n         age = self.session.get_expiry_age()\n         self.assertTrue(age in (9, 10))\n \n     def test_custom_expiry_datetime(self):\n         # Using fixed datetime\n-        self.session.set_expiry(datetime.now() + timedelta(seconds=10))\n-        delta = self.session.get_expiry_date() - datetime.now()\n+        self.session.set_expiry(timezone.now() + timedelta(seconds=10))\n+        delta = self.session.get_expiry_date() - timezone.now()\n         self.assertTrue(delta.seconds in (9, 10))\n \n         age = self.session.get_expiry_age()\n@@ -279,10 +280,17 @@ def test_sessionmanager_save(self):\n         self.assertEqual(self.session['y'], 2)\n \n \n+DatabaseSessionWithTimeZoneTests = override_settings(USE_TZ=True)(DatabaseSessionTests)\n+\n+\n class CacheDBSessionTests(SessionTestsMixin, TestCase):\n \n     backend = CacheDBSession\n \n+\n+CacheDBSessionWithTimeZoneTests = override_settings(USE_TZ=True)(CacheDBSessionTests)\n+\n+\n # Don't need DB flushing for these tests, so can use unittest.TestCase as base class\n class FileSessionTests(SessionTestsMixin, unittest.TestCase):\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 18,
        "deletions": 9
    }
}