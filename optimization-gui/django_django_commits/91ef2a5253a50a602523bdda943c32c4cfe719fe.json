{
    "author": "jbronn",
    "message": "Use native geometry types on PostGIS 2.0+ instead of `AddGeometryColumn` and don't query database in `PostGISCreation.sql_table_creation_suffix`.",
    "sha": "91ef2a5253a50a602523bdda943c32c4cfe719fe",
    "files": [
        {
            "sha": "171a304439c7a8c3ffb1523f37532adf9324bc65",
            "filename": "django/contrib/gis/db/backends/base.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fbase.py?ref=91ef2a5253a50a602523bdda943c32c4cfe719fe",
            "patch": "@@ -32,8 +32,9 @@ class BaseSpatialOperations(object):\n     # How the geometry column should be selected.\n     select = None\n \n-    # Does the spatial database have a geography type?\n+    # Does the spatial database have a geometry or geography type?\n     geography = False\n+    geometry = False\n \n     area = False\n     centroid = False"
        },
        {
            "sha": "406dc4e487b1fd0b96df58a110e90fa5c6f8cf8c",
            "filename": "django/contrib/gis/db/backends/postgis/creation.py",
            "status": "modified",
            "additions": 12,
            "deletions": 20,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py?ref=91ef2a5253a50a602523bdda943c32c4cfe719fe",
            "patch": "@@ -4,7 +4,8 @@\n \n class PostGISCreation(DatabaseCreation):\n     geom_index_type = 'GIST'\n-    geom_index_opts = 'GIST_GEOMETRY_OPS'\n+    geom_index_ops = 'GIST_GEOMETRY_OPS'\n+    geom_index_ops_nd = 'GIST_GEOMETRY_OPS_ND'\n \n     def sql_indexes_for_field(self, model, f, style):\n         \"Return any spatial index creation SQL for the field.\"\n@@ -17,8 +18,9 @@ def sql_indexes_for_field(self, model, f, style):\n             qn = self.connection.ops.quote_name\n             db_table = model._meta.db_table\n \n-            if f.geography:\n-                # Geogrophy columns are created normally.\n+            if f.geography or self.connection.ops.geometry:\n+                # Geography and Geometry (PostGIS 2.0+) columns are\n+                # created normally.\n                 pass\n             else:\n                 # Geometry columns are created by `AddGeometryColumn`\n@@ -47,33 +49,23 @@ def sql_indexes_for_field(self, model, f, style):\n                 # which are fast on multidimensional cases, or just plain\n                 # gist index for the 2d case.\n                 if f.geography:\n-                    index_opts = ''\n-                elif self.connection.ops.spatial_version >= (2, 0):\n+                    index_ops = ''\n+                elif self.connection.ops.geometry:\n                     if f.dim > 2:\n-                        index_opts = ' ' + style.SQL_KEYWORD('gist_geometry_ops_nd')\n+                        index_ops = ' ' + style.SQL_KEYWORD(self.geom_index_ops_nd)\n                     else:\n-                        index_opts = ''\n+                        index_ops = ''\n                 else:\n-                    index_opts = ' ' + style.SQL_KEYWORD(self.geom_index_opts)\n+                    index_ops = ' ' + style.SQL_KEYWORD(self.geom_index_ops)\n                 output.append(style.SQL_KEYWORD('CREATE INDEX ') +\n                               style.SQL_TABLE(qn('%s_%s_id' % (db_table, f.column))) +\n                               style.SQL_KEYWORD(' ON ') +\n                               style.SQL_TABLE(qn(db_table)) +\n                               style.SQL_KEYWORD(' USING ') +\n                               style.SQL_COLTYPE(self.geom_index_type) + ' ( ' +\n-                              style.SQL_FIELD(qn(f.column)) + index_opts + ' );')\n+                              style.SQL_FIELD(qn(f.column)) + index_ops + ' );')\n         return output\n \n     def sql_table_creation_suffix(self):\n-        cursor = self.connection.cursor()\n-        cursor.execute('SELECT datname FROM pg_database;')\n-        db_names = [row[0] for row in cursor.fetchall()]\n         postgis_template = getattr(settings, 'POSTGIS_TEMPLATE', 'template_postgis')\n-\n-        if postgis_template in db_names:\n-            qn = self.connection.ops.quote_name\n-            return ' TEMPLATE %s' % qn(postgis_template)\n-        elif self.connection.ops.spatial_version < (2, 0):\n-            raise ImproperlyConfigured(\"Template database '%s' does not exist.\" % postgis_template)\n-        else:\n-            return ''\n+        return ' TEMPLATE %s' % self.connection.ops.quote_name(postgis_template)"
        },
        {
            "sha": "aa23b974dbbfc7903bee7feb761d4c8bddade616",
            "filename": "django/contrib/gis/db/backends/postgis/operations.py",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py?ref=91ef2a5253a50a602523bdda943c32c4cfe719fe",
            "patch": "@@ -103,11 +103,12 @@ def __init__(self, connection):\n             self.geom_func_prefix = prefix\n             self.spatial_version = version\n         except DatabaseError:\n-            raise ImproperlyConfigured('Cannot determine PostGIS version for database \"%s\". '\n-                                       'GeoDjango requires at least PostGIS version 1.3. '\n-                                       'Was the database created from a spatial database '\n-                                       'template?' % self.connection.settings_dict['NAME']\n-                                       )\n+            raise ImproperlyConfigured(\n+                'Cannot determine PostGIS version for database \"%s\". '\n+                'GeoDjango requires at least PostGIS version 1.3. '\n+                'Was the database created from a spatial database '\n+                'template?' % self.connection.settings_dict['NAME']\n+                )\n         # TODO: Raise helpful exceptions as they become known.\n \n         # PostGIS-specific operators. The commented descriptions of these\n@@ -215,6 +216,10 @@ def get_dist_ops(operator):\n                 'bboverlaps' : PostGISOperator('&&'),\n                 }\n \n+        # Native geometry type support added in PostGIS 2.0.\n+        if version >= (2, 0, 0):\n+            self.geometry = True\n+\n         # Creating a dictionary lookup of all GIS terms for PostGIS.\n         gis_terms = ['isnull']\n         gis_terms += list(self.geometry_operators)\n@@ -320,6 +325,14 @@ def geo_db_type(self, f):\n                                           'only with an SRID of 4326.')\n \n             return 'geography(%s,%d)'% (f.geom_type, f.srid)\n+        elif self.geometry:\n+            # Postgis 2.0 supports type-based geometries.\n+            # TODO: Support 'M' extension.\n+            if f.dim == 3:\n+                geom_type = f.geom_type + 'Z'\n+            else:\n+                geom_type = f.geom_type\n+            return 'geometry(%s,%d)' % (geom_type, f.srid)\n         else:\n             return None\n "
        },
        {
            "sha": "d90ce309d461280b773128a382048496e17d6b31",
            "filename": "django/contrib/gis/db/models/fields.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/91ef2a5253a50a602523bdda943c32c4cfe719fe/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Ffields.py?ref=91ef2a5253a50a602523bdda943c32c4cfe719fe",
            "patch": "@@ -95,7 +95,7 @@ def __init__(self, verbose_name=None, srid=4326, spatial_index=True, dim=2,\n         # Is this a geography rather than a geometry column?\n         self.geography = geography\n \n-        # Oracle-specific private attributes for creating the entrie in\n+        # Oracle-specific private attributes for creating the entry in\n         # `USER_SDO_GEOM_METADATA`\n         self._extent = kwargs.pop('extent', (-180.0, -90.0, 180.0, 90.0))\n         self._tolerance = kwargs.pop('tolerance', 0.05)"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 33,
        "deletions": 27
    }
}