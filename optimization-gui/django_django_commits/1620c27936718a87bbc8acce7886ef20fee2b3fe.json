{
    "author": "claudep",
    "message": "Fixed #19186 -- Fixed sending mail with unicode content on Python 3\n\nThanks alex_po for the report and Luke Plant for the analysis.",
    "sha": "1620c27936718a87bbc8acce7886ef20fee2b3fe",
    "files": [
        {
            "sha": "b6f7f560ed6273fbf867e9e939966a312f47c444",
            "filename": "django/core/mail/backends/smtp.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/1620c27936718a87bbc8acce7886ef20fee2b3fe/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "raw_url": "https://github.com/django/django/raw/1620c27936718a87bbc8acce7886ef20fee2b3fe/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py?ref=1620c27936718a87bbc8acce7886ef20fee2b3fe",
            "patch": "@@ -7,6 +7,7 @@\n from django.core.mail.backends.base import BaseEmailBackend\n from django.core.mail.utils import DNS_NAME\n from django.core.mail.message import sanitize_address\n+from django.utils.encoding import force_bytes\n \n \n class EmailBackend(BaseEmailBackend):\n@@ -102,9 +103,11 @@ def _send(self, email_message):\n         from_email = sanitize_address(email_message.from_email, email_message.encoding)\n         recipients = [sanitize_address(addr, email_message.encoding)\n                       for addr in email_message.recipients()]\n+        message = email_message.message()\n+        charset = message.get_charset().get_output_charset() if message.get_charset() else 'utf-8'\n         try:\n             self.connection.sendmail(from_email, recipients,\n-                    email_message.message().as_string())\n+                    force_bytes(message.as_string(), charset))\n         except:\n             if not self.fail_silently:\n                 raise"
        },
        {
            "sha": "b798cb21aa196fab9ae9e13ec5024db954a74b09",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/1620c27936718a87bbc8acce7886ef20fee2b3fe/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1620c27936718a87bbc8acce7886ef20fee2b3fe/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=1620c27936718a87bbc8acce7886ef20fee2b3fe",
            "patch": "@@ -17,6 +17,7 @@\n from django.core.mail.message import BadHeaderError\n from django.test import TestCase\n from django.test.utils import override_settings\n+from django.utils.encoding import force_str, force_text\n from django.utils.six import PY3, StringIO\n from django.utils.translation import ugettext_lazy\n \n@@ -357,6 +358,14 @@ def test_send(self):\n         self.assertEqual(message[\"from\"], \"from@example.com\")\n         self.assertEqual(message.get_all(\"to\"), [\"to@example.com\"])\n \n+    def test_send_unicode(self):\n+        email = EmailMessage('Chère maman', 'Je t\\'aime très fort', 'from@example.com', ['to@example.com'])\n+        num_sent = mail.get_connection().send_messages([email])\n+        self.assertEqual(num_sent, 1)\n+        message = self.get_the_message()\n+        self.assertEqual(message[\"subject\"], '=?utf-8?q?Ch=C3=A8re_maman?=')\n+        self.assertEqual(force_text(message.get_payload()), 'Je t\\'aime très fort')\n+\n     def test_send_many(self):\n         email1 = EmailMessage('Subject', 'Content1', 'from@example.com', ['to@example.com'])\n         email2 = EmailMessage('Subject', 'Content2', 'from@example.com', ['to@example.com'])\n@@ -526,8 +535,8 @@ def get_mailbox_content(self):\n         messages = []\n         for filename in os.listdir(self.tmp_dir):\n             with open(os.path.join(self.tmp_dir, filename), 'r') as fp:\n-                session = fp.read().split('\\n' + ('-' * 79) + '\\n')\n-            messages.extend(email.message_from_string(str(m)) for m in session if m)\n+                session = force_text(fp.read()).split('\\n' + ('-' * 79) + '\\n')\n+            messages.extend(email.message_from_string(force_str(m)) for m in session if m)\n         return messages\n \n     def test_file_sessions(self):\n@@ -579,8 +588,8 @@ def flush_mailbox(self):\n         self.stream = sys.stdout = StringIO()\n \n     def get_mailbox_content(self):\n-        messages = self.stream.getvalue().split('\\n' + ('-' * 79) + '\\n')\n-        return [email.message_from_string(str(m)) for m in messages if m]\n+        messages = force_text(self.stream.getvalue()).split('\\n' + ('-' * 79) + '\\n')\n+        return [email.message_from_string(force_str(m)) for m in messages if m]\n \n     def test_console_stream_kwarg(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 22,
        "additions": 17,
        "deletions": 5
    }
}