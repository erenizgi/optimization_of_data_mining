{
    "author": "kmtracey",
    "message": "Fixed #13640: Avoid generating an exception when a model has an attribute named 'evaluate'. Thanks LukaszKorzybski and tobias.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17093 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b8353016b7d6a4046f4c30017987c2e75597285b",
    "files": [
        {
            "sha": "4afe28806d4ae27aa6195e04ceb0df753e3dacf3",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/b8353016b7d6a4046f4c30017987c2e75597285b/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/b8353016b7d6a4046f4c30017987c2e75597285b/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=b8353016b7d6a4046f4c30017987c2e75597285b",
            "patch": "@@ -14,6 +14,7 @@\n from django.utils.tree import Node\n from django.db import connections, DEFAULT_DB_ALIAS\n from django.db.models import signals\n+from django.db.models.expressions import ExpressionNode\n from django.db.models.fields import FieldDoesNotExist\n from django.db.models.query_utils import InvalidQuery\n from django.db.models.sql import aggregates as base_aggregates_module\n@@ -1064,7 +1065,7 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n             value = True\n         elif callable(value):\n             value = value()\n-        elif hasattr(value, 'evaluate'):\n+        elif isinstance(value, ExpressionNode):\n             # If value is a query expression, evaluate it\n             value = SQLEvaluator(value, self)\n             having_clause = value.contains_aggregate"
        },
        {
            "sha": "77bb4f23eb57f4763c1c280134bc7ff70dbb1c86",
            "filename": "tests/regressiontests/model_regress/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/b8353016b7d6a4046f4c30017987c2e75597285b/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b8353016b7d6a4046f4c30017987c2e75597285b/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py?ref=b8353016b7d6a4046f4c30017987c2e75597285b",
            "patch": "@@ -164,8 +164,23 @@ def test_timezones(self):\n             1\n         )\n \n+\n class ModelValidationTest(TestCase):\n     def test_pk_validation(self):\n         one = NonAutoPK.objects.create(name=\"one\")\n         again = NonAutoPK(name=\"one\")\n         self.assertRaises(ValidationError, again.validate_unique)\n+\n+\n+class EvaluateMethodTest(TestCase):\n+    \"\"\"\n+    Regression test for #13640: cannot filter by objects with 'evaluate' attr\n+    \"\"\"\n+\n+    def test_model_with_evaluate_method(self):\n+        \"\"\"\n+        Ensures that you can filter by objects that have an 'evaluate' attr\n+        \"\"\"\n+        dept = Department.objects.create(pk=1, name='abc')\n+        dept.evaluate = 'abc'\n+        Worker.objects.filter(department=dept)"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 17,
        "deletions": 1
    }
}