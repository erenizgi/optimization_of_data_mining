{
    "author": "ramiro",
    "message": "Fixed #15064 -- Made manage.py honor the existence and value of DJANGO_SETTINGS_MODULE env var. Thanks olau for the report and Shawn Milochik for a patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16222 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede",
    "files": [
        {
            "sha": "1345eaf66a4ab309c67c772df341e652c7866347",
            "filename": "django/core/management/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede/django%2Fcore%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede/django%2Fcore%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2F__init__.py?ref=1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede",
            "patch": "@@ -411,7 +411,11 @@ def setup_environ(settings_mod, original_settings_path=None):\n     if original_settings_path:\n         os.environ['DJANGO_SETTINGS_MODULE'] = original_settings_path\n     else:\n-        os.environ['DJANGO_SETTINGS_MODULE'] = '%s.%s' % (project_name, settings_name)\n+        # If DJANGO_SETTINGS_MODULE is already set, use it.\n+        os.environ['DJANGO_SETTINGS_MODULE'] = os.environ.get(\n+            'DJANGO_SETTINGS_MODULE',\n+            '%s.%s' % (project_name, settings_name)\n+        )\n \n     # Import the project module. We add the parent directory to PYTHONPATH to\n     # avoid some of the path errors new users can have."
        },
        {
            "sha": "5fcc9fe4c070800bdc292896a5fa9e77402e3577",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 16,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede",
            "patch": "@@ -37,8 +37,7 @@ def write_settings(self, filename, apps=None, is_dir=False, sdict=None):\n         if apps is None:\n             apps = ['django.contrib.auth', 'django.contrib.contenttypes', 'admin_scripts']\n \n-        if apps:\n-            settings_file.write(\"INSTALLED_APPS = %s\\n\" % apps)\n+        settings_file.write(\"INSTALLED_APPS = %s\\n\" % apps)\n \n         if sdict:\n             for k, v in sdict.items():\n@@ -119,11 +118,12 @@ def run_test(self, script, args, settings_file=None, apps=None):\n         os.chdir(test_dir)\n         try:\n             from subprocess import Popen, PIPE\n+        except ImportError:\n+            stdin, stdout, stderr = os.popen3(cmd)\n+        else:\n             p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n             stdin, stdout, stderr = (p.stdin, p.stdout, p.stderr)\n             p.wait()\n-        except ImportError:\n-            stdin, stdout, stderr = os.popen3(cmd)\n         out, err = stdout.read(), stderr.read()\n \n         # Restore the old environment\n@@ -665,8 +665,8 @@ def test_builtin_with_bad_environment(self):\n         \"default: manage.py builtin commands fail if settings file (from environment) doesn't exist\"\n         args = ['sqlall','admin_scripts']\n         out, err = self.run_manage(args,'bad_settings')\n-        self.assertNoOutput(err)\n-        self.assertOutput(out, 'CREATE TABLE')\n+        self.assertNoOutput(out)\n+        self.assertOutput(err, \"Could not import settings 'bad_settings'\")\n \n     def test_custom_command(self):\n         \"default: manage.py can execute user commands when default settings are appropriate\"\n@@ -732,8 +732,8 @@ def test_builtin_with_bad_environment(self):\n         \"fulldefault: manage.py builtin commands fail if settings file (from environment) doesn't exist\"\n         args = ['sqlall','admin_scripts']\n         out, err = self.run_manage(args,'bad_settings')\n-        self.assertNoOutput(err)\n-        self.assertOutput(out, 'CREATE TABLE')\n+        self.assertNoOutput(out)\n+        self.assertOutput(err, \"Could not import settings 'bad_settings'\")\n \n     def test_custom_command(self):\n         \"fulldefault: manage.py can execute user commands when default settings are appropriate\"\n@@ -799,7 +799,7 @@ def test_builtin_with_bad_environment(self):\n         args = ['sqlall','admin_scripts']\n         out, err = self.run_manage(args,'bad_settings')\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'App with label admin_scripts could not be found')\n+        self.assertOutput(err, \"Could not import settings 'bad_settings'\")\n \n     def test_custom_command(self):\n         \"minimal: manage.py can't execute user commands without appropriate settings\"\n@@ -918,12 +918,11 @@ def test_builtin_with_settings(self):\n         self.assertOutput(out, 'CREATE TABLE')\n \n     def test_builtin_with_environment(self):\n-        \"multiple: manage.py builtin commands fail if settings are provided in the environment\"\n-        # FIXME: This doesn't seem to be the correct output.\n+        \"multiple: manage.py can execute builtin commands if settings are provided in the environment\"\n         args = ['sqlall','admin_scripts']\n         out, err = self.run_manage(args,'alternate_settings')\n-        self.assertNoOutput(out)\n-        self.assertOutput(err, 'App with label admin_scripts could not be found.')\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, 'CREATE TABLE')\n \n     def test_builtin_with_bad_settings(self):\n         \"multiple: manage.py builtin commands fail if settings file (from argument) doesn't exist\"\n@@ -937,7 +936,7 @@ def test_builtin_with_bad_environment(self):\n         args = ['sqlall','admin_scripts']\n         out, err = self.run_manage(args,'bad_settings')\n         self.assertNoOutput(out)\n-        self.assertOutput(err, \"App with label admin_scripts could not be found\")\n+        self.assertOutput(err, \"Could not import settings 'bad_settings'\")\n \n     def test_custom_command(self):\n         \"multiple: manage.py can't execute user commands using default settings\"\n@@ -957,8 +956,8 @@ def test_custom_command_with_environment(self):\n         \"multiple: manage.py can execute user commands if settings are provided in environment\"\n         args = ['noargs_command']\n         out, err = self.run_manage(args,'alternate_settings')\n-        self.assertNoOutput(out)\n-        self.assertOutput(err, \"Unknown command: 'noargs_command'\")\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, \"EXECUTE:NoArgsCommand\")\n \n class ManageSettingsWithImportError(AdminScriptTestCase):\n     \"\"\"Tests for manage.py when using the default settings.py file"
        },
        {
            "sha": "750ccc604e57e1a7940c12975637ea39037fe278",
            "filename": "tests/regressiontests/settings_tests/tests.py",
            "status": "modified",
            "additions": 63,
            "deletions": 1,
            "changes": 64,
            "blob_url": "https://github.com/django/django/blob/1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py?ref=1d7fa75c97f0a00de22c25ddfded1ad3e64b5ede",
            "patch": "@@ -1,5 +1,6 @@\n from __future__ import with_statement\n-from django.conf import settings\n+import os\n+from django.conf import settings, global_settings\n from django.test import TestCase\n \n class SettingsTests(TestCase):\n@@ -100,3 +101,64 @@ def test_double_slash(self):\n         self.settings_module.MEDIA_URL = 'http://media.foo.com/stupid//'\n         self.assertEqual('http://media.foo.com/stupid//',\n                          self.settings_module.MEDIA_URL)\n+\n+\n+class EnvironmentVariableTest(TestCase):\n+    \"\"\"\n+    Ensures proper settings file is used in setup_environ if\n+    DJANGO_SETTINGS_MODULE is set in the environment.\n+    \"\"\"\n+    def setUp(self):\n+        self.original_value = os.environ.get('DJANGO_SETTINGS_MODULE')\n+\n+    def tearDown(self):\n+        if self.original_value:\n+            os.environ['DJANGO_SETTINGS_MODULE'] = self.original_value\n+        elif 'DJANGO_SETTINGS_MODULE' in os.environ:\n+            del(os.environ['DJANGO_SETTINGS_MODULE'])\n+\n+    def test_env_var_used(self):\n+        \"\"\"\n+        If the environment variable is set, do not ignore it. However, the\n+        kwarg original_settings_path takes precedence.\n+\n+        This tests both plus the default (neither set).\n+        \"\"\"\n+        from django.core.management import setup_environ\n+\n+        # whatever was already there\n+        original_module =  os.environ.get(\n+            'DJANGO_SETTINGS_MODULE',\n+            'the default'\n+        )\n+\n+        # environment variable set by user\n+        user_override = 'custom.settings'\n+\n+        # optional argument to setup_environ\n+        orig_path = 'original.path'\n+\n+        # expect default\n+        setup_environ(global_settings)\n+        self.assertEquals(\n+            os.environ.get('DJANGO_SETTINGS_MODULE'),\n+            original_module\n+        )\n+\n+        # override with environment variable\n+        os.environ['DJANGO_SETTINGS_MODULE'] = user_override\n+        setup_environ(global_settings)\n+\n+        self.assertEquals(\n+            os.environ.get('DJANGO_SETTINGS_MODULE'),\n+            user_override\n+        )\n+\n+        # pass in original_settings_path (should take precedence)\n+        os.environ['DJANGO_SETTINGS_MODULE'] = user_override\n+        setup_environ(global_settings, original_settings_path = orig_path)\n+\n+        self.assertEquals(\n+            os.environ.get('DJANGO_SETTINGS_MODULE'),\n+            orig_path\n+        )"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 83,
        "deletions": 18
    }
}