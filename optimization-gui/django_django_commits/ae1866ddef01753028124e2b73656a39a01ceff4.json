{
    "author": "spookylukey",
    "message": "Fixed #15869 - example AJAX code in CSRF docs fails sometimes for IE7 or absolute same origin URLs\n\nThanks to nick for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16183 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ae1866ddef01753028124e2b73656a39a01ceff4",
    "files": [
        {
            "sha": "0be9ebe82d114ec5bd2d22a6d3f2a4da00d93419",
            "filename": "docs/ref/contrib/csrf.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/ae1866ddef01753028124e2b73656a39a01ceff4/docs%2Fref%2Fcontrib%2Fcsrf.txt",
            "raw_url": "https://github.com/django/django/raw/ae1866ddef01753028124e2b73656a39a01ceff4/docs%2Fref%2Fcontrib%2Fcsrf.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fcsrf.txt?ref=ae1866ddef01753028124e2b73656a39a01ceff4",
            "patch": "@@ -86,7 +86,7 @@ that allow headers to be set on every request. In jQuery, you can use the\n \n .. code-block:: javascript\n \n-    $('html').ajaxSend(function(event, xhr, settings) {\n+    $(document).ajaxSend(function(event, xhr, settings) {\n         function getCookie(name) {\n             var cookieValue = null;\n             if (document.cookie && document.cookie != '') {\n@@ -102,8 +102,19 @@ that allow headers to be set on every request. In jQuery, you can use the\n             }\n             return cookieValue;\n         }\n-        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {\n-            // Only send the token to relative URLs i.e. locally.\n+        function sameOrigin(url) {\n+            // url could be relative or scheme relative or absolute\n+            var host = document.location.host; // host + port\n+            var protocol = document.location.protocol;\n+            var sr_origin = '//' + host;\n+            var origin = protocol + sr_origin;\n+            // Allow absolute or scheme relative URLs to same origin\n+            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||\n+                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||\n+                // or any other URL that isn't scheme relative or absolute i.e relative.\n+                !(/^(\\/\\/|http:|https:).*/.test(url));\n+        }\n+        if (sameOrigin(settings.url)) {\n             xhr.setRequestHeader(\"X-CSRFToken\", getCookie('csrftoken'));\n         }\n     });"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 14,
        "deletions": 3
    }
}