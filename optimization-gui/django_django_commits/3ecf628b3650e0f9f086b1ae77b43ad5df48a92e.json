{
    "author": "ramiro",
    "message": "Fixed #11206 -- Ensure that the floatformat template filter doesn't switch to scientific notation when asked to format a zero value with more than six decimal places. Thanks Tai Lee for the report and fix and Facundo Batista for his help when Decimal module expertise was needed.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15736 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3ecf628b3650e0f9f086b1ae77b43ad5df48a92e",
    "files": [
        {
            "sha": "d923d8a0e582494f9947c50c1fdaf93560fefd55",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/3ecf628b3650e0f9f086b1ae77b43ad5df48a92e/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/3ecf628b3650e0f9f086b1ae77b43ad5df48a92e/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=3ecf628b3650e0f9f086b1ae77b43ad5df48a92e",
            "patch": "@@ -149,9 +149,19 @@ def floatformat(text, arg=-1):\n     if p == 0:\n         exp = Decimal(1)\n     else:\n-        exp = Decimal('1.0') / (Decimal(10) ** abs(p))\n+        exp = Decimal(u'1.0') / (Decimal(10) ** abs(p))\n     try:\n-        return mark_safe(formats.number_format(u'%s' % str(d.quantize(exp, ROUND_HALF_UP)), abs(p)))\n+        # Avoid conversion to scientific notation by accessing `sign`, `digits`\n+        # and `exponent` from `Decimal.as_tuple()` directly.\n+        sign, digits, exponent = d.quantize(exp, ROUND_HALF_UP).as_tuple()\n+        digits = [unicode(digit) for digit in reversed(digits)]\n+        while len(digits) <= abs(exponent):\n+            digits.append(u'0')\n+        digits.insert(-exponent, u'.')\n+        if sign:\n+            digits.append(u'-')\n+        number = u''.join(reversed(digits))\n+        return mark_safe(formats.number_format(number, abs(p)))\n     except InvalidOperation:\n         return input_val\n floatformat.is_safe = True"
        },
        {
            "sha": "286c7f8c01f7a5006404825af34e1c43ffad864b",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/3ecf628b3650e0f9f086b1ae77b43ad5df48a92e/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3ecf628b3650e0f9f086b1ae77b43ad5df48a92e/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=3ecf628b3650e0f9f086b1ae77b43ad5df48a92e",
            "patch": "@@ -1,6 +1,6 @@\n # -*- coding: utf-8 -*-\n import datetime\n-import unittest\n+from django.utils import unittest\n \n from django.template.defaultfilters import *\n \n@@ -29,6 +29,13 @@ def test_floatformat(self):\n         self.assertEqual(floatformat(u'¿Cómo esta usted?'), u'')\n         self.assertEqual(floatformat(None), u'')\n \n+        # Check that we're not converting to scientific notation.\n+        self.assertEqual(floatformat(0, 6), u'0.000000')\n+        self.assertEqual(floatformat(0, 7), u'0.0000000')\n+        self.assertEqual(floatformat(0, 10), u'0.0000000000')\n+        self.assertEqual(floatformat(0.000000000000000000015, 20),\n+                                     u'0.00000000000000000002')\n+\n         pos_inf = float(1e30000)\n         self.assertEqual(floatformat(pos_inf), unicode(pos_inf))\n \n@@ -46,6 +53,13 @@ def __float__(self):\n \n         self.assertEqual(floatformat(FloatWrapper(11.000001), -2), u'11.00')\n \n+    # This fails because of Python's float handling. Floats with many zeroes\n+    # after the decimal point should be passed in as another type such as\n+    # unicode or Decimal.\n+    @unittest.expectedFailure\n+    def test_floatformat_fail(self):\n+        self.assertEqual(floatformat(1.00000000000000015, 16), u'1.0000000000000002')\n+\n     def test_addslashes(self):\n         self.assertEqual(addslashes(u'\"double quotes\" and \\'single quotes\\''),\n                           u'\\\\\"double quotes\\\\\" and \\\\\\'single quotes\\\\\\'')"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 27,
        "deletions": 3
    }
}