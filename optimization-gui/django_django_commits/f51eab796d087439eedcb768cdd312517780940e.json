{
    "author": "ramiro",
    "message": "Fixed #18072 -- Made more admin links use reverse() instead of hard-coded relative URLs.\n\nThanks kmike for the report and initial patch for the changelist->edit\nobject view link URL.\n\nOther affected links include the delete object one and object history\none (in this case the change had been implemented in commit 5a9e127, this\ncommit adds admin-quoting of the object PK in a way similar to a222d6e.)\n\nRefs #15294.",
    "sha": "f51eab796d087439eedcb768cdd312517780940e",
    "files": [
        {
            "sha": "4962e732a29c6320371f4c2e581a7f7702e4b24e",
            "filename": "django/contrib/admin/templates/admin/change_form.html",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_form.html",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_form.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_form.html?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -29,7 +29,7 @@\n {% if change %}{% if not is_popup %}\n   <ul class=\"object-tools\">\n     {% block object-tools-items %}\n-    <li><a href=\"{% url opts|admin_urlname:'history' original.pk %}\" class=\"historylink\">{% trans \"History\" %}</a></li>\n+    <li><a href=\"{% url opts|admin_urlname:'history' original.pk|admin_urlquote %}\" class=\"historylink\">{% trans \"History\" %}</a></li>\n     {% if has_absolute_url %}<li><a href=\"{% url 'admin:view_on_site' content_type_id original.pk %}\" class=\"viewsitelink\">{% trans \"View on site\" %}</a></li>{% endif%}\n     {% endblock %}\n   </ul>"
        },
        {
            "sha": "8c9d22752dbf9a82e36848c02970ed67c283eeea",
            "filename": "django/contrib/admin/templates/admin/submit_line.html",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fsubmit_line.html",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fsubmit_line.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fsubmit_line.html?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -1,8 +1,8 @@\n-{% load i18n %}\n+{% load i18n admin_urls %}\n <div class=\"submit-row\">\n {% if show_save %}<input type=\"submit\" value=\"{% trans 'Save' %}\" class=\"default\" name=\"_save\" {{ onclick_attrib }}/>{% endif %}\n-{% if show_delete_link %}<p class=\"deletelink-box\"><a href=\"delete/\" class=\"deletelink\">{% trans \"Delete\" %}</a></p>{% endif %}\n+{% if show_delete_link %}<p class=\"deletelink-box\"><a href=\"{% url opts|admin_urlname:'delete' original.pk|admin_urlquote %}\" class=\"deletelink\">{% trans \"Delete\" %}</a></p>{% endif %}\n {% if show_save_as_new %}<input type=\"submit\" value=\"{% trans 'Save as new' %}\" name=\"_saveasnew\" {{ onclick_attrib }}/>{%endif%}\n-{% if show_save_and_add_another %}<input type=\"submit\" value=\"{% trans 'Save and add another' %}\" name=\"_addanother\" {{ onclick_attrib }} />{% endif %}\n+{% if show_save_and_add_another %}<input type=\"submit\" value=\"{% trans 'Save and add another' %}\" name=\"_addanother\" {{ onclick_attrib }}/>{% endif %}\n {% if show_save_and_continue %}<input type=\"submit\" value=\"{% trans 'Save and continue editing' %}\" name=\"_continue\" {{ onclick_attrib }}/>{% endif %}\n </div>"
        },
        {
            "sha": "f6ac59635a6311d537590e2856940d6f8eb967f3",
            "filename": "django/contrib/admin/templatetags/admin_modify.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -28,7 +28,8 @@ def submit_row(context):\n     change = context['change']\n     is_popup = context['is_popup']\n     save_as = context['save_as']\n-    return {\n+    ctx = {\n+        'opts': opts,\n         'onclick_attrib': (opts.get_ordered_objects() and change\n                             and 'onclick=\"submitOrderForm();\"' or ''),\n         'show_delete_link': (not is_popup and context['has_delete_permission']\n@@ -40,6 +41,9 @@ def submit_row(context):\n         'is_popup': is_popup,\n         'show_save': True\n     }\n+    if context.get('original') is not None:\n+        ctx['original'] = context['original']\n+    return ctx\n \n @register.filter\n def cell_count(inline_admin_form):"
        },
        {
            "sha": "74eef2e7338f9b639dfee08b0d26747222ccd977",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -48,9 +48,9 @@ def prepare_lookup_value(key, value):\n def quote(s):\n     \"\"\"\n     Ensure that primary key values do not confuse the admin URLs by escaping\n-    any '/', '_' and ':' characters. Similar to urllib.quote, except that the\n-    quoting is slightly different so that it doesn't get automatically\n-    unquoted by the Web browser.\n+    any '/', '_' and ':' and similarly problematic characters.\n+    Similar to urllib.quote, except that the quoting is slightly different so\n+    that it doesn't get automatically unquoted by the Web browser.\n     \"\"\"\n     if not isinstance(s, six.string_types):\n         return s"
        },
        {
            "sha": "5033ba98bc8c81922e5665f5ddf14e3aba6f32ee",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -3,6 +3,7 @@\n \n from django.core.exceptions import SuspiciousOperation, ImproperlyConfigured\n from django.core.paginator import InvalidPage\n+from django.core.urlresolvers import reverse\n from django.db import models\n from django.db.models.fields import FieldDoesNotExist\n from django.utils.datastructures import SortedDict\n@@ -376,4 +377,8 @@ def construct_search(field_name):\n             return qs\n \n     def url_for_result(self, result):\n-        return \"%s/\" % quote(getattr(result, self.pk_attname))\n+        pk = getattr(result, self.pk_attname)\n+        return reverse('admin:%s_%s_change' % (self.opts.app_label,\n+                                               self.opts.module_name),\n+                       args=(quote(pk),),\n+                       current_app=self.model_admin.admin_site.name)"
        },
        {
            "sha": "2b1c1a9bcfc0eb5149f530febd69800b96ed8245",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -6,6 +6,7 @@\n from django.contrib.admin.options import IncorrectLookupParameters\n from django.contrib.admin.views.main import ChangeList, SEARCH_VAR, ALL_VAR\n from django.contrib.auth.models import User\n+from django.core.urlresolvers import reverse\n from django.template import Context, Template\n from django.test import TestCase\n from django.test.client import RequestFactory\n@@ -65,7 +66,8 @@ def test_result_list_empty_changelist_value(self):\n         template = Template('{% load admin_list %}{% spaceless %}{% result_list cl %}{% endspaceless %}')\n         context = Context({'cl': cl})\n         table_output = template.render(context)\n-        row_html = '<tbody><tr class=\"row1\"><th><a href=\"%d/\">name</a></th><td class=\"nowrap\">(None)</td></tr></tbody>' % new_child.id\n+        link = reverse('admin:admin_changelist_child_change', args=(new_child.id,))\n+        row_html = '<tbody><tr class=\"row1\"><th><a href=\"%s\">name</a></th><td class=\"nowrap\">(None)</td></tr></tbody>' % link\n         self.assertFalse(table_output.find(row_html) == -1,\n             'Failed to find expected row element: %s' % table_output)\n \n@@ -87,7 +89,8 @@ def test_result_list_html(self):\n         template = Template('{% load admin_list %}{% spaceless %}{% result_list cl %}{% endspaceless %}')\n         context = Context({'cl': cl})\n         table_output = template.render(context)\n-        row_html = '<tbody><tr class=\"row1\"><th><a href=\"%d/\">name</a></th><td class=\"nowrap\">Parent object</td></tr></tbody>' % new_child.id\n+        link = reverse('admin:admin_changelist_child_change', args=(new_child.id,))\n+        row_html = '<tbody><tr class=\"row1\"><th><a href=\"%s\">name</a></th><td class=\"nowrap\">Parent object</td></tr></tbody>' % link\n         self.assertFalse(table_output.find(row_html) == -1,\n             'Failed to find expected row element: %s' % table_output)\n \n@@ -425,7 +428,8 @@ def test_dynamic_list_display_links(self):\n         request = self._mocked_authenticated_request('/child/', superuser)\n         response = m.changelist_view(request)\n         for i in range(1, 10):\n-            self.assertContains(response, '<a href=\"%s/\">%s</a>' % (i, i))\n+            link = reverse('admin:admin_changelist_child_change', args=(i,))\n+            self.assertContains(response, '<a href=\"%s\">%s</a>' % (link, i))\n \n         list_display = m.get_list_display(request)\n         list_display_links = m.get_list_display_links(request, list_display)"
        },
        {
            "sha": "7c6341d71d92e8523e51c573307fa222d8a1ecac",
            "filename": "tests/regressiontests/admin_custom_urls/fixtures/actions.json",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_custom_urls%2Ffixtures%2Factions.json",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_custom_urls%2Ffixtures%2Factions.json",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_custom_urls%2Ffixtures%2Factions.json?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -40,12 +40,5 @@\n     \"fields\": {\n       \"description\": \"An action with a name suspected of being a XSS attempt\"\n     }\n-  },\n-  {\n-    \"pk\": \"The name of an action\", \n-    \"model\": \"admin_custom_urls.action\", \n-    \"fields\": {\n-      \"description\": \"A generic action\"\n-    }\n   }\n ]"
        },
        {
            "sha": "3e9cf2896589097757253fbde901ce0aa6dfdc16",
            "filename": "tests/regressiontests/admin_custom_urls/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_custom_urls%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_custom_urls%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_custom_urls%2Ftests.py?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -1,5 +1,6 @@\n from __future__ import absolute_import, unicode_literals\n \n+from django.contrib.admin.util import quote\n from django.core.urlresolvers import reverse\n from django.template.response import TemplateResponse\n from django.test import TestCase\n@@ -67,27 +68,16 @@ def testAdminUrlsNoClash(self):\n \n         # Ditto, but use reverse() to build the URL\n         url = reverse('admin:%s_action_change' % Action._meta.app_label,\n-                args=('add',))\n+                args=(quote('add'),))\n         response = self.client.get(url)\n         self.assertEqual(response.status_code, 200)\n         self.assertContains(response, 'Change action')\n \n         # Should correctly get the change_view for the model instance with the\n         # funny-looking PK (the one wth a 'path/to/html/document.html' value)\n         url = reverse('admin:%s_action_change' % Action._meta.app_label,\n-                args=(\"path/to/html/document.html\",))\n+                args=(quote(\"path/to/html/document.html\"),))\n         response = self.client.get(url)\n         self.assertEqual(response.status_code, 200)\n         self.assertContains(response, 'Change action')\n         self.assertContains(response, 'value=\"path/to/html/document.html\"')\n-\n-    def testChangeViewHistoryButton(self):\n-        url = reverse('admin:%s_action_change' % Action._meta.app_label,\n-                args=('The name of an action',))\n-        response = self.client.get(url)\n-        self.assertEqual(response.status_code, 200)\n-        expected_link = reverse('admin:%s_action_history' %\n-                                Action._meta.app_label,\n-                                args=('The name of an action',))\n-        self.assertContains(response, '<a href=\"%s\" class=\"historylink\"' %\n-                            expected_link)"
        },
        {
            "sha": "8151c8c8546138094537a38929607c8fd5804e89",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 51,
            "deletions": 24,
            "changes": 75,
            "blob_url": "https://github.com/django/django/blob/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f51eab796d087439eedcb768cdd312517780940e/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=f51eab796d087439eedcb768cdd312517780940e",
            "patch": "@@ -260,19 +260,21 @@ def testChangeListSortingMultiple(self):\n         p1 = Person.objects.create(name=\"Chris\", gender=1, alive=True)\n         p2 = Person.objects.create(name=\"Chris\", gender=2, alive=True)\n         p3 = Person.objects.create(name=\"Bob\", gender=1, alive=True)\n-        link = '<a href=\"%s/'\n+        link1 = reverse('admin:admin_views_person_change', args=(p1.pk,))\n+        link2 = reverse('admin:admin_views_person_change', args=(p2.pk,))\n+        link3 = reverse('admin:admin_views_person_change', args=(p3.pk,))\n \n         # Sort by name, gender\n         # This hard-codes the URL because it'll fail if it runs against the\n         # 'admin2' custom admin (which doesn't have the Person model).\n         response = self.client.get('/test_admin/admin/admin_views/person/', {'o': '1.2'})\n-        self.assertContentBefore(response, link % p3.id, link % p1.id)\n-        self.assertContentBefore(response, link % p1.id, link % p2.id)\n+        self.assertContentBefore(response, link3, link1)\n+        self.assertContentBefore(response, link1, link2)\n \n         # Sort by gender descending, name\n         response = self.client.get('/test_admin/admin/admin_views/person/', {'o': '-2.1'})\n-        self.assertContentBefore(response, link % p2.id, link % p3.id)\n-        self.assertContentBefore(response, link % p3.id, link % p1.id)\n+        self.assertContentBefore(response, link2, link3)\n+        self.assertContentBefore(response, link3, link1)\n \n     def testChangeListSortingPreserveQuerySetOrdering(self):\n         \"\"\"\n@@ -284,52 +286,58 @@ def testChangeListSortingPreserveQuerySetOrdering(self):\n         p1 = Person.objects.create(name=\"Amy\", gender=1, alive=True, age=80)\n         p2 = Person.objects.create(name=\"Bob\", gender=1, alive=True, age=70)\n         p3 = Person.objects.create(name=\"Chris\", gender=2, alive=False, age=60)\n-        link = '<a href=\"%s/'\n+        link1 = reverse('admin:admin_views_person_change', args=(p1.pk,))\n+        link2 = reverse('admin:admin_views_person_change', args=(p2.pk,))\n+        link3 = reverse('admin:admin_views_person_change', args=(p3.pk,))\n \n         # This hard-codes the URL because it'll fail if it runs against the\n         # 'admin2' custom admin (which doesn't have the Person model).\n         response = self.client.get('/test_admin/admin/admin_views/person/', {})\n-        self.assertContentBefore(response, link % p3.id, link % p2.id)\n-        self.assertContentBefore(response, link % p2.id, link % p1.id)\n+        self.assertContentBefore(response, link3, link2)\n+        self.assertContentBefore(response, link2, link1)\n \n     def testChangeListSortingModelMeta(self):\n         # Test ordering on Model Meta is respected\n \n         l1 = Language.objects.create(iso='ur', name='Urdu')\n         l2 = Language.objects.create(iso='ar', name='Arabic')\n-        link = '<a href=\"%s/'\n+        link1 = reverse('admin:admin_views_language_change', args=(quote(l1.pk),))\n+        link2 = reverse('admin:admin_views_language_change', args=(quote(l2.pk),))\n \n         response = self.client.get('/test_admin/admin/admin_views/language/', {})\n-        self.assertContentBefore(response, link % l2.pk, link % l1.pk)\n+        self.assertContentBefore(response, link2, link1)\n \n         # Test we can override with query string\n         response = self.client.get('/test_admin/admin/admin_views/language/', {'o':'-1'})\n-        self.assertContentBefore(response, link % l1.pk, link % l2.pk)\n+        self.assertContentBefore(response, link1, link2)\n \n     def testChangeListSortingOverrideModelAdmin(self):\n         # Test ordering on Model Admin is respected, and overrides Model Meta\n         dt = datetime.datetime.now()\n         p1 = Podcast.objects.create(name=\"A\", release_date=dt)\n         p2 = Podcast.objects.create(name=\"B\", release_date=dt - datetime.timedelta(10))\n+        link1 = reverse('admin:admin_views_podcast_change', args=(p1.pk,))\n+        link2 = reverse('admin:admin_views_podcast_change', args=(p2.pk,))\n \n-        link = '<a href=\"%s/'\n         response = self.client.get('/test_admin/admin/admin_views/podcast/', {})\n-        self.assertContentBefore(response, link % p1.pk, link % p2.pk)\n+        self.assertContentBefore(response, link1, link2)\n \n     def testMultipleSortSameField(self):\n         # Check that we get the columns we expect if we have two columns\n         # that correspond to the same ordering field\n         dt = datetime.datetime.now()\n         p1 = Podcast.objects.create(name=\"A\", release_date=dt)\n         p2 = Podcast.objects.create(name=\"B\", release_date=dt - datetime.timedelta(10))\n+        link1 = reverse('admin:admin_views_podcast_change', args=(quote(p1.pk),))\n+        link2 = reverse('admin:admin_views_podcast_change', args=(quote(p2.pk),))\n \n-        link = '<a href=\"%s/'\n         response = self.client.get('/test_admin/admin/admin_views/podcast/', {})\n-        self.assertContentBefore(response, link % p1.pk, link % p2.pk)\n+        self.assertContentBefore(response, link1, link2)\n \n         p1 = ComplexSortedPerson.objects.create(name=\"Bob\", age=10)\n         p2 = ComplexSortedPerson.objects.create(name=\"Amy\", age=20)\n-        link = '<a href=\"%s/'\n+        link1 = reverse('admin:admin_views_complexsortedperson_change', args=(p1.pk,))\n+        link2 = reverse('admin:admin_views_complexsortedperson_change', args=(p2.pk,))\n \n         response = self.client.get('/test_admin/admin/admin_views/complexsortedperson/', {})\n         # Should have 5 columns (including action checkbox col)\n@@ -342,7 +350,7 @@ def testMultipleSortSameField(self):\n         self.assertContentBefore(response, 'Name', 'Colored name')\n \n         # Check sorting - should be by name\n-        self.assertContentBefore(response, link % p2.id, link % p1.id)\n+        self.assertContentBefore(response, link2, link1)\n \n     def testSortIndicatorsAdminOrder(self):\n         \"\"\"\n@@ -461,10 +469,12 @@ def testNamedGroupFieldChoicesChangeList(self):\n         for rows corresponding to instances of a model in which a named group\n         has been used in the choices option of a field.\n         \"\"\"\n+        link1 = reverse('admin:admin_views_fabric_change', args=(1,), current_app=self.urlbit)\n+        link2 = reverse('admin:admin_views_fabric_change', args=(2,), current_app=self.urlbit)\n         response = self.client.get('/test_admin/%s/admin_views/fabric/' % self.urlbit)\n         fail_msg = \"Changelist table isn't showing the right human-readable values set by a model field 'choices' option named group.\"\n-        self.assertContains(response, '<a href=\"1/\">Horizontal</a>', msg_prefix=fail_msg, html=True)\n-        self.assertContains(response, '<a href=\"2/\">Vertical</a>', msg_prefix=fail_msg, html=True)\n+        self.assertContains(response, '<a href=\"%s\">Horizontal</a>' % link1, msg_prefix=fail_msg, html=True)\n+        self.assertContains(response, '<a href=\"%s\">Vertical</a>' % link2, msg_prefix=fail_msg, html=True)\n \n     def testNamedGroupFieldChoicesFilter(self):\n         \"\"\"\n@@ -1371,9 +1381,12 @@ def test_get_change_view(self):\n         self.assertEqual(response.status_code, 200)\n \n     def test_changelist_to_changeform_link(self):\n-        \"The link from the changelist referring to the changeform of the object should be quoted\"\n-        response = self.client.get('/test_admin/admin/admin_views/modelwithstringprimarykey/')\n-        should_contain = \"\"\"<th><a href=\"%s/\">%s</a></th></tr>\"\"\" % (escape(quote(self.pk)), escape(self.pk))\n+        \"Link to the changeform of the object in changelist should use reverse() and be quoted -- #18072\"\n+        prefix = '/test_admin/admin/admin_views/modelwithstringprimarykey/'\n+        response = self.client.get(prefix)\n+        # this URL now comes through reverse(), thus iri_to_uri encoding\n+        pk_final_url = escape(iri_to_uri(quote(self.pk)))\n+        should_contain = \"\"\"<th><a href=\"%s%s/\">%s</a></th>\"\"\" % (prefix, pk_final_url, escape(self.pk))\n         self.assertContains(response, should_contain)\n \n     def test_recentactions_link(self):\n@@ -1441,6 +1454,18 @@ def test_shortcut_view_with_escaping(self):\n         should_contain = '/%s/\" class=\"viewsitelink\">' % model.pk\n         self.assertContains(response, should_contain)\n \n+    def test_change_view_history_link(self):\n+        \"\"\"Object history button link should work and contain the pk value quoted.\"\"\"\n+        url = reverse('admin:%s_modelwithstringprimarykey_change' %\n+                          ModelWithStringPrimaryKey._meta.app_label,\n+                      args=(quote(self.pk),))\n+        response = self.client.get(url)\n+        self.assertEqual(response.status_code, 200)\n+        expected_link = reverse('admin:%s_modelwithstringprimarykey_history' %\n+                                    ModelWithStringPrimaryKey._meta.app_label,\n+                                args=(quote(self.pk),))\n+        self.assertContains(response, '<a href=\"%s\" class=\"historylink\"' % expected_link)\n+\n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n class SecureViewTests(TestCase):\n@@ -2023,12 +2048,14 @@ def test_pk_hidden_fields_with_list_display_links(self):\n         \"\"\"\n         story1 = OtherStory.objects.create(title='The adventures of Guido', content='Once upon a time in Djangoland...')\n         story2 = OtherStory.objects.create(title='Crouching Tiger, Hidden Python', content='The Python was sneaking into...')\n+        link1 = reverse('admin:admin_views_otherstory_change', args=(story1.pk,))\n+        link2 = reverse('admin:admin_views_otherstory_change', args=(story2.pk,))\n         response = self.client.get('/test_admin/admin/admin_views/otherstory/')\n         self.assertContains(response, 'id=\"id_form-0-id\"', 1) # Only one hidden field, in a separate place than the table.\n         self.assertContains(response, 'id=\"id_form-1-id\"', 1)\n         self.assertContains(response, '<div class=\"hiddenfields\">\\n<input type=\"hidden\" name=\"form-0-id\" value=\"%d\" id=\"id_form-0-id\" /><input type=\"hidden\" name=\"form-1-id\" value=\"%d\" id=\"id_form-1-id\" />\\n</div>' % (story2.id, story1.id), html=True)\n-        self.assertContains(response, '<th><a href=\"%d/\">%d</a></th>' % (story1.id, story1.id), 1)\n-        self.assertContains(response, '<th><a href=\"%d/\">%d</a></th>' % (story2.id, story2.id), 1)\n+        self.assertContains(response, '<th><a href=\"%s\">%d</a></th>' % (link1, story1.id), 1)\n+        self.assertContains(response, '<th><a href=\"%s\">%d</a></th>' % (link2, story2.id), 1)\n \n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 79,
        "deletions": 56
    }
}