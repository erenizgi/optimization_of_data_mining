{
    "author": "claudep",
    "message": "Fixed #17954 -- Fixed dependency checking for test databases. Thanks ≈Åukasz Rekucki for the report and the patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17931 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "03a442c8ad6addf8c223ca0d3864a9d58d409d44",
    "files": [
        {
            "sha": "62e7326295cc8593ffd002919fde0b71f96a919d",
            "filename": "django/test/simple.py",
            "status": "modified",
            "additions": 32,
            "deletions": 34,
            "changes": 66,
            "blob_url": "https://github.com/django/django/blob/03a442c8ad6addf8c223ca0d3864a9d58d409d44/django%2Ftest%2Fsimple.py",
            "raw_url": "https://github.com/django/django/raw/03a442c8ad6addf8c223ca0d3864a9d58d409d44/django%2Ftest%2Fsimple.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsimple.py?ref=03a442c8ad6addf8c223ca0d3864a9d58d409d44",
            "patch": "@@ -193,31 +193,35 @@ def reorder_suite(suite, classes):\n \n \n def dependency_ordered(test_databases, dependencies):\n-    \"\"\"Reorder test_databases into an order that honors the dependencies\n+    \"\"\"\n+    Reorder test_databases into an order that honors the dependencies\n     described in TEST_DEPENDENCIES.\n     \"\"\"\n     ordered_test_databases = []\n     resolved_databases = set()\n+\n+    # Maps db signature to dependencies of all it's aliases\n+    dependencies_map = {}\n+\n+    # sanity check - no DB can depend on it's own alias\n+    for sig, (_, aliases) in test_databases:\n+        all_deps = set()\n+        for alias in aliases:\n+            all_deps.update(dependencies.get(alias, []))\n+        if not all_deps.isdisjoint(aliases):\n+            raise ImproperlyConfigured(\n+                \"Circular dependency: databases %r depend on each other, \"\n+                \"but are aliases.\" % aliases)\n+        dependencies_map[sig] = all_deps\n+\n     while test_databases:\n         changed = False\n         deferred = []\n \n-        while test_databases:\n-            signature, (db_name, aliases) = test_databases.pop()\n-            dependencies_satisfied = True\n-            for alias in aliases:\n-                if alias in dependencies:\n-                    if all(a in resolved_databases\n-                           for a in dependencies[alias]):\n-                        # all dependencies for this alias are satisfied\n-                        dependencies.pop(alias)\n-                        resolved_databases.add(alias)\n-                    else:\n-                        dependencies_satisfied = False\n-                else:\n-                    resolved_databases.add(alias)\n-\n-            if dependencies_satisfied:\n+        # Try to find a DB that has all it's dependencies met\n+        for signature, (db_name, aliases) in test_databases:\n+            if dependencies_map[signature].issubset(resolved_databases):\n+                resolved_databases.update(aliases)\n                 ordered_test_databases.append((signature, (db_name, aliases)))\n                 changed = True\n             else:\n@@ -282,9 +286,9 @@ def setup_databases(self, **kwargs):\n                 # we only need to create the test database once.\n                 item = test_databases.setdefault(\n                     connection.creation.test_db_signature(),\n-                    (connection.settings_dict['NAME'], [])\n+                    (connection.settings_dict['NAME'], set())\n                 )\n-                item[1].append(alias)\n+                item[1].add(alias)\n \n                 if 'TEST_DEPENDENCIES' in connection.settings_dict:\n                     dependencies[alias] = (\n@@ -297,26 +301,20 @@ def setup_databases(self, **kwargs):\n         # Second pass -- actually create the databases.\n         old_names = []\n         mirrors = []\n+\n         for signature, (db_name, aliases) in dependency_ordered(\n             test_databases.items(), dependencies):\n+            test_db_name = None\n             # Actually create the database for the first connection\n-            connection = connections[aliases[0]]\n-            old_names.append((connection, db_name, True))\n-            test_db_name = connection.creation.create_test_db(\n-                self.verbosity, autoclobber=not self.interactive)\n-            for alias in aliases[1:]:\n+\n+            for alias in aliases:\n                 connection = connections[alias]\n-                if db_name:\n-                    old_names.append((connection, db_name, False))\n-                    connection.settings_dict['NAME'] = test_db_name\n+                old_names.append((connection, db_name, True))\n+                if test_db_name is None:\n+                    test_db_name = connection.creation.create_test_db(\n+                            self.verbosity, autoclobber=not self.interactive)\n                 else:\n-                    # If settings_dict['NAME'] isn't defined, we have a backend\n-                    # where the name isn't important -- e.g., SQLite, which\n-                    # uses :memory:. Force create the database instead of\n-                    # assuming it's a duplicate.\n-                    old_names.append((connection, db_name, True))\n-                    connection.creation.create_test_db(\n-                        self.verbosity, autoclobber=not self.interactive)\n+                    connection.settings_dict['NAME'] = test_db_name\n \n         for alias, mirror_alias in mirrored_aliases.items():\n             mirrors.append((alias, connections[alias].settings_dict['NAME']))"
        },
        {
            "sha": "2af4eb9750a01d6c6d1022f95d109af6fab97a1a",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/03a442c8ad6addf8c223ca0d3864a9d58d409d44/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/03a442c8ad6addf8c223ca0d3864a9d58d409d44/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=03a442c8ad6addf8c223ca0d3864a9d58d409d44",
            "patch": "@@ -110,6 +110,25 @@ def test_circular_dependencies(self):\n \n         self.assertRaises(ImproperlyConfigured, simple.dependency_ordered, raw, dependencies=dependencies)\n \n+    def test_own_alias_dependency(self):\n+        raw = [\n+            ('s1', ('s1_db', ['alpha', 'bravo']))\n+        ]\n+        dependencies = {\n+            'alpha': ['bravo']\n+        }\n+\n+        with self.assertRaises(ImproperlyConfigured):\n+            simple.dependency_ordered(raw, dependencies=dependencies)\n+\n+        # reordering aliases shouldn't matter\n+        raw = [\n+            ('s1', ('s1_db', ['bravo', 'alpha']))\n+        ]\n+\n+        with self.assertRaises(ImproperlyConfigured):\n+            simple.dependency_ordered(raw, dependencies=dependencies)\n+\n \n class MockTestRunner(object):\n     invoked = False"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 51,
        "deletions": 34
    }
}