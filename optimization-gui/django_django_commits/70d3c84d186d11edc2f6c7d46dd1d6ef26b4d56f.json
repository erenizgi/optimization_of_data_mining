{
    "author": "ramiro",
    "message": "Fixed #13433 -- Changed default behavior of Django email message wrappers to not mangle lines starting with 'From '. Thanks Leo for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15669 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f",
    "files": [
        {
            "sha": "bed4966ef97926cce335d8b3725da5ac5474e6b0",
            "filename": "django/core/mail/message.py",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f/django%2Fcore%2Fmail%2Fmessage.py",
            "raw_url": "https://github.com/django/django/raw/70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f/django%2Fcore%2Fmail%2Fmessage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fmessage.py?ref=70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f",
            "patch": "@@ -3,16 +3,21 @@\n import random\n import time\n from email import Charset, Encoders\n+from email.generator import Generator\n from email.MIMEText import MIMEText\n from email.MIMEMultipart import MIMEMultipart\n from email.MIMEBase import MIMEBase\n from email.Header import Header\n-from email.Utils import formatdate, getaddresses, formataddr\n+from email.Utils import formatdate, getaddresses, formataddr, parseaddr\n \n from django.conf import settings\n from django.core.mail.utils import DNS_NAME\n from django.utils.encoding import smart_str, force_unicode\n-from email.Utils import parseaddr\n+\n+try:\n+    from cStringIO import StringIO\n+except ImportError:\n+    from StringIO import StringIO\n \n # Don't BASE64-encode UTF-8 messages so that we avoid unwanted attention from\n # some spam filters.\n@@ -119,6 +124,19 @@ def __setitem__(self, name, val):\n         name, val = forbid_multi_line_headers(name, val, self.encoding)\n         MIMEText.__setitem__(self, name, val)\n \n+    def as_string(self, unixfrom=False):\n+        \"\"\"Return the entire formatted message as a string.\n+        Optional `unixfrom' when True, means include the Unix From_ envelope\n+        header.\n+\n+        This overrides the default as_string() implementation to not mangle\n+        lines that begin with 'From '. See bug #13433 for details.\n+        \"\"\"\n+        fp = StringIO()\n+        g = Generator(fp, mangle_from_ = False)\n+        g.flatten(self, unixfrom=unixfrom)\n+        return fp.getvalue()\n+\n \n class SafeMIMEMultipart(MIMEMultipart):\n \n@@ -130,6 +148,19 @@ def __setitem__(self, name, val):\n         name, val = forbid_multi_line_headers(name, val, self.encoding)\n         MIMEMultipart.__setitem__(self, name, val)\n \n+    def as_string(self, unixfrom=False):\n+        \"\"\"Return the entire formatted message as a string.\n+        Optional `unixfrom' when True, means include the Unix From_ envelope\n+        header.\n+\n+        This overrides the default as_string() implementation to not mangle\n+        lines that begin with 'From '. See bug #13433 for details.\n+        \"\"\"\n+        fp = StringIO()\n+        g = Generator(fp, mangle_from_ = False)\n+        g.flatten(self, unixfrom=unixfrom)\n+        return fp.getvalue()\n+\n \n class EmailMessage(object):\n     \"\"\""
        },
        {
            "sha": "224254c0443a0ad6ae436d2a7a860be17e9f771c",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=70d3c84d186d11edc2f6c7d46dd1d6ef26b4d56f",
            "patch": "@@ -11,8 +11,8 @@\n \n from django.conf import settings\n from django.core import mail\n-from django.core.mail import EmailMessage, mail_admins, mail_managers, EmailMultiAlternatives\n-from django.core.mail import send_mail, send_mass_mail\n+from django.core.mail import (EmailMessage, mail_admins, mail_managers,\n+        EmailMultiAlternatives, send_mail, send_mass_mail)\n from django.core.mail.backends import console, dummy, locmem, filebased, smtp\n from django.core.mail.message import BadHeaderError\n from django.test import TestCase\n@@ -282,6 +282,12 @@ def test_connection_arg(self):\n         self.assertEqual(len(connection.test_outbox), 1)\n         self.assertEqual(connection.test_outbox[0].subject, '[Django] Manager message')\n \n+    def test_dont_mangle_from_in_body(self):\n+        # Regression for #13433 - Make sure that EmailMessage doesn't mangle\n+        # 'From ' in message body.\n+        email = EmailMessage('Subject', 'From the future', 'bounce@example.com', ['to@example.com'], headers={'From': 'from@example.com'})\n+        self.assertFalse('>From the future' in email.message().as_string())\n+\n \n class BaseEmailBackendTests(object):\n     email_backend = None"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 41,
        "deletions": 4
    }
}