{
    "author": "claudep",
    "message": "Fixed #19698 -- Cleared sites cache with signals\n\nThanks ddavies at nomensa.com for the report and the patch and\nserdaroncode for reviewing the patch.",
    "sha": "98ab8e8876e130de24e1de9473a4db716d5b002e",
    "files": [
        {
            "sha": "88a7c4115b6a49563a4a0e80d24361866f947a24",
            "filename": "django/contrib/sites/models.py",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/98ab8e8876e130de24e1de9473a4db716d5b002e/django%2Fcontrib%2Fsites%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/98ab8e8876e130de24e1de9473a4db716d5b002e/django%2Fcontrib%2Fsites%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsites%2Fmodels.py?ref=98ab8e8876e130de24e1de9473a4db716d5b002e",
            "patch": "@@ -1,4 +1,5 @@\n from django.db import models\n+from django.db.models.signals import pre_save, pre_delete\n from django.utils.translation import ugettext_lazy as _\n from django.utils.encoding import python_2_unicode_compatible\n \n@@ -49,20 +50,6 @@ class Meta:\n     def __str__(self):\n         return self.domain\n \n-    def save(self, *args, **kwargs):\n-        super(Site, self).save(*args, **kwargs)\n-        # Cached information will likely be incorrect now.\n-        if self.id in SITE_CACHE:\n-            del SITE_CACHE[self.id]\n-\n-    def delete(self):\n-        pk = self.pk\n-        super(Site, self).delete()\n-        try:\n-            del SITE_CACHE[pk]\n-        except KeyError:\n-            pass\n-\n \n @python_2_unicode_compatible\n class RequestSite(object):\n@@ -96,3 +83,16 @@ def get_current_site(request):\n     else:\n         current_site = RequestSite(request)\n     return current_site\n+\n+\n+def clear_site_cache(sender, **kwargs):\n+    \"\"\"\n+    Clears the cache (if primed) each time a site is saved or deleted\n+    \"\"\"\n+    instance = kwargs['instance']\n+    try:\n+        del SITE_CACHE[instance.pk]\n+    except KeyError:\n+        pass\n+pre_save.connect(clear_site_cache, sender=Site)\n+pre_delete.connect(clear_site_cache, sender=Site)"
        },
        {
            "sha": "ee6224bc7af0bfdc6a757932416436f6f5ab592a",
            "filename": "django/contrib/sites/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/98ab8e8876e130de24e1de9473a4db716d5b002e/django%2Fcontrib%2Fsites%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/98ab8e8876e130de24e1de9473a4db716d5b002e/django%2Fcontrib%2Fsites%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsites%2Ftests.py?ref=98ab8e8876e130de24e1de9473a4db716d5b002e",
            "patch": "@@ -42,6 +42,13 @@ def test_site_cache(self):\n         site = Site.objects.get_current()\n         self.assertEqual(\"Example site\", site.name)\n \n+    def test_delete_all_sites_clears_cache(self):\n+        # When all site objects are deleted the cache should also\n+        # be cleared and get_current() should raise a DoesNotExist.\n+        self.assertIsInstance(Site.objects.get_current(), Site)\n+        Site.objects.all().delete()\n+        self.assertRaises(Site.DoesNotExist, Site.objects.get_current)\n+\n     @override_settings(ALLOWED_HOSTS=['example.com'])\n     def test_get_current_site(self):\n         # Test that the correct Site object is returned"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 21,
        "deletions": 14
    }
}