{
    "author": "alex",
    "message": "Moved a bunch of imports in the defaultfilters library out of functions.  On CPython this is actually a big performance win if one of these filters is your bottleneck.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16283 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "69cfee2f167f64c15de6bfcd6b9779534132db2f",
    "files": [
        {
            "sha": "7829327ec3bdb2a354ed00c6ec946572bb664af0",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 39,
            "deletions": 54,
            "changes": 93,
            "blob_url": "https://github.com/django/django/blob/69cfee2f167f64c15de6bfcd6b9779534132db2f/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/69cfee2f167f64c15de6bfcd6b9779534132db2f/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=69cfee2f167f64c15de6bfcd6b9779534132db2f",
            "patch": "@@ -2,15 +2,22 @@\n \n import re\n import random as random_module\n+import unicodedata\n from decimal import Decimal, InvalidOperation, ROUND_HALF_UP\n from functools import wraps\n+from pprint import pformat\n \n from django.template.base import Variable, Library\n from django.conf import settings\n from django.utils import formats\n+from django.utils.dateformat import format\n from django.utils.encoding import force_unicode, iri_to_uri\n-from django.utils.html import conditional_escape\n-from django.utils.safestring import mark_safe, SafeData\n+from django.utils.html import (conditional_escape, escapejs, fix_ampersands,\n+    escape, urlize, linebreaks, strip_tags)\n+from django.utils.http import urlquote\n+from django.utils.text import truncate_words, truncate_html_words, wrap, phone2numeric\n+from django.utils.safestring import mark_safe, SafeData, mark_for_escaping\n+from django.utils.timesince import timesince, timeuntil\n from django.utils.translation import ugettext, ungettext\n \n register = Library()\n@@ -61,18 +68,18 @@ def capfirst(value):\n capfirst.is_safe=True\n capfirst = stringfilter(capfirst)\n \n-def escapejs(value):\n+@register.filter(\"escapejs\")\n+@stringfilter\n+def escapejs_filter(value):\n     \"\"\"Hex encodes characters for use in JavaScript strings.\"\"\"\n-    from django.utils.html import escapejs\n     return escapejs(value)\n-escapejs = stringfilter(escapejs)\n \n-def fix_ampersands(value):\n+@register.filter(\"fix_ampersands\")\n+@stringfilter\n+def fix_ampersands_filter(value):\n     \"\"\"Replaces ampersands with ``&amp;`` entities.\"\"\"\n-    from django.utils.html import fix_ampersands\n     return fix_ampersands(value)\n-fix_ampersands.is_safe=True\n-fix_ampersands = stringfilter(fix_ampersands)\n+fix_ampersands_filter.is_safe=True\n \n # Values for testing floatformat input against infinity and NaN representations,\n # which differ across platforms and Python versions.  Some (i.e. old Windows\n@@ -171,7 +178,6 @@ def iriencode(value):\n \n def linenumbers(value, autoescape=None):\n     \"\"\"Displays text with line numbers.\"\"\"\n-    from django.utils.html import escape\n     lines = value.split(u'\\n')\n     # Find the maximum width of the line count, for use with zero padding\n     # string format command\n@@ -209,7 +215,6 @@ def slugify(value):\n     Normalizes string, converts to lowercase, removes non-alpha characters,\n     and converts spaces to hyphens.\n     \"\"\"\n-    import unicodedata\n     value = unicodedata.normalize('NFKD', value).encode('ascii', 'ignore')\n     value = unicode(re.sub('[^\\w\\s-]', '', value).strip().lower())\n     return mark_safe(re.sub('[-\\s]+', '-', value))\n@@ -247,7 +252,6 @@ def truncatewords(value, arg):\n \n     Newlines within the string are removed.\n     \"\"\"\n-    from django.utils.text import truncate_words\n     try:\n         length = int(arg)\n     except ValueError: # Invalid literal for int().\n@@ -264,7 +268,6 @@ def truncatewords_html(value, arg):\n \n     Newlines in the HTML are preserved.\n     \"\"\"\n-    from django.utils.text import truncate_html_words\n     try:\n         length = int(arg)\n     except ValueError: # invalid literal for int()\n@@ -288,21 +291,20 @@ def urlencode(value, safe=None):\n     default safe characters will be used (but an empty string can be provided\n     when *all* characters should be escaped).\n     \"\"\"\n-    from django.utils.http import urlquote\n     kwargs = {}\n     if safe is not None:\n         kwargs['safe'] = safe\n     return urlquote(value, **kwargs)\n urlencode.is_safe = False\n urlencode = stringfilter(urlencode)\n \n-def urlize(value, autoescape=None):\n+@register.filter(\"urlize\")\n+@stringfilter\n+def urlize_filter(value, autoescape=None):\n     \"\"\"Converts URLs in plain text into clickable links.\"\"\"\n-    from django.utils.html import urlize\n     return mark_safe(urlize(value, nofollow=True, autoescape=autoescape))\n-urlize.is_safe=True\n-urlize.needs_autoescape = True\n-urlize = stringfilter(urlize)\n+urlize_filter.is_safe = True\n+urlize_filter.needs_autoescape = True\n \n def urlizetrunc(value, limit, autoescape=None):\n     \"\"\"\n@@ -311,7 +313,6 @@ def urlizetrunc(value, limit, autoescape=None):\n \n     Argument: Length to truncate URLs to.\n     \"\"\"\n-    from django.utils.html import urlize\n     return mark_safe(urlize(value, trim_url_limit=int(limit), nofollow=True,\n                             autoescape=autoescape))\n urlizetrunc.is_safe = True\n@@ -330,7 +331,6 @@ def wordwrap(value, arg):\n \n     Argument: number of characters to wrap the text at.\n     \"\"\"\n-    from django.utils.text import wrap\n     return wrap(value, int(arg))\n wordwrap.is_safe = True\n wordwrap = stringfilter(wordwrap)\n@@ -376,46 +376,44 @@ def cut(value, arg):\n # HTML STRINGS    #\n ###################\n \n-def escape(value):\n+@register.filter(\"escape\")\n+@stringfilter\n+def escape_filter(value):\n     \"\"\"\n     Marks the value as a string that should not be auto-escaped.\n     \"\"\"\n-    from django.utils.safestring import mark_for_escaping\n     return mark_for_escaping(value)\n-escape.is_safe = True\n-escape = stringfilter(escape)\n+escape_filter.is_safe = True\n \n def force_escape(value):\n     \"\"\"\n     Escapes a string's HTML. This returns a new string containing the escaped\n     characters (as opposed to \"escape\", which marks the content for later\n     possible escaping).\n     \"\"\"\n-    from django.utils.html import escape\n     return mark_safe(escape(value))\n force_escape = stringfilter(force_escape)\n force_escape.is_safe = True\n \n-def linebreaks(value, autoescape=None):\n+@register.filter(\"linebreaks\")\n+@stringfilter\n+def linebreaks_filter(value, autoescape=None):\n     \"\"\"\n     Replaces line breaks in plain text with appropriate HTML; a single\n     newline becomes an HTML line break (``<br />``) and a new line\n     followed by a blank line becomes a paragraph break (``</p>``).\n     \"\"\"\n-    from django.utils.html import linebreaks\n     autoescape = autoescape and not isinstance(value, SafeData)\n     return mark_safe(linebreaks(value, autoescape))\n-linebreaks.is_safe = True\n-linebreaks.needs_autoescape = True\n-linebreaks = stringfilter(linebreaks)\n+linebreaks_filter.is_safe = True\n+linebreaks_filter.needs_autoescape = True\n \n def linebreaksbr(value, autoescape=None):\n     \"\"\"\n     Converts all newlines in a piece of plain text to HTML line breaks\n     (``<br />``).\n     \"\"\"\n     if autoescape and not isinstance(value, SafeData):\n-        from django.utils.html import escape\n         value = escape(value)\n     return mark_safe(value.replace('\\n', '<br />'))\n linebreaksbr.is_safe = True\n@@ -453,7 +451,6 @@ def removetags(value, tags):\n \n def striptags(value):\n     \"\"\"Strips all [X]HTML tags.\"\"\"\n-    from django.utils.html import strip_tags\n     return strip_tags(value)\n striptags.is_safe = True\n striptags = stringfilter(striptags)\n@@ -573,7 +570,6 @@ def unordered_list(value, autoescape=None):\n         </li>\n     \"\"\"\n     if autoescape:\n-        from django.utils.html import conditional_escape\n         escaper = conditional_escape\n     else:\n         escaper = lambda x: x\n@@ -680,7 +676,6 @@ def get_digit(value, arg):\n \n def date(value, arg=None):\n     \"\"\"Formats a date according to the given format.\"\"\"\n-    from django.utils.dateformat import format\n     if not value:\n         return u''\n     if arg is None:\n@@ -696,7 +691,6 @@ def date(value, arg=None):\n \n def time(value, arg=None):\n     \"\"\"Formats a time according to the given format.\"\"\"\n-    from django.utils import dateformat\n     if value in (None, u''):\n         return u''\n     if arg is None:\n@@ -710,9 +704,9 @@ def time(value, arg=None):\n             return ''\n time.is_safe = False\n \n-def timesince(value, arg=None):\n+@register.filter(\"timesince\")\n+def timesince_filter(value, arg=None):\n     \"\"\"Formats a date as the time since that date (i.e. \"4 days, 6 hours\").\"\"\"\n-    from django.utils.timesince import timesince\n     if not value:\n         return u''\n     try:\n@@ -721,18 +715,18 @@ def timesince(value, arg=None):\n         return timesince(value)\n     except (ValueError, TypeError):\n         return u''\n-timesince.is_safe = False\n+timesince_filter.is_safe = False\n \n-def timeuntil(value, arg=None):\n+@register.filter(\"timeuntil\")\n+def timeuntil_filter(value, arg=None):\n     \"\"\"Formats a date as the time until that date (i.e. \"4 days, 6 hours\").\"\"\"\n-    from django.utils.timesince import timeuntil\n     if not value:\n         return u''\n     try:\n         return timeuntil(value, arg)\n     except (ValueError, TypeError):\n         return u''\n-timeuntil.is_safe = False\n+timeuntil_filter.is_safe = False\n \n ###################\n # LOGIC           #\n@@ -860,15 +854,14 @@ def pluralize(value, arg=u's'):\n     return singular_suffix\n pluralize.is_safe = False\n \n-def phone2numeric(value):\n+@register.filter(\"phone2numeric\")\n+def phone2numeric_filter(value):\n     \"\"\"Takes a phone number and converts it in to its numerical equivalent.\"\"\"\n-    from django.utils.text import phone2numeric\n     return phone2numeric(value)\n-phone2numeric.is_safe = True\n+phone2numeric_filter.is_safe = True\n \n def pprint(value):\n     \"\"\"A wrapper around pprint.pprint -- for debugging, really.\"\"\"\n-    from pprint import pformat\n     try:\n         return pformat(value)\n     except Exception, e:\n@@ -887,11 +880,8 @@ def pprint(value):\n register.filter(dictsort)\n register.filter(dictsortreversed)\n register.filter(divisibleby)\n-register.filter(escape)\n-register.filter(escapejs)\n register.filter(filesizeformat)\n register.filter(first)\n-register.filter(fix_ampersands)\n register.filter(floatformat)\n register.filter(force_escape)\n register.filter(get_digit)\n@@ -900,13 +890,11 @@ def pprint(value):\n register.filter(last)\n register.filter(length)\n register.filter(length_is)\n-register.filter(linebreaks)\n register.filter(linebreaksbr)\n register.filter(linenumbers)\n register.filter(ljust)\n register.filter(lower)\n register.filter(make_list)\n-register.filter(phone2numeric)\n register.filter(pluralize)\n register.filter(pprint)\n register.filter(removetags)\n@@ -919,15 +907,12 @@ def pprint(value):\n register.filter(stringformat)\n register.filter(striptags)\n register.filter(time)\n-register.filter(timesince)\n-register.filter(timeuntil)\n register.filter(title)\n register.filter(truncatewords)\n register.filter(truncatewords_html)\n register.filter(unordered_list)\n register.filter(upper)\n register.filter(urlencode)\n-register.filter(urlize)\n register.filter(urlizetrunc)\n register.filter(wordcount)\n register.filter(wordwrap)"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 39,
        "deletions": 54
    }
}