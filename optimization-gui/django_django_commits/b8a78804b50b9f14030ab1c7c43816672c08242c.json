{
    "author": "SmileyChris",
    "message": "Fixes #13804 -- URLField validation failure for a url containing '://' on the path and no scheme\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14657 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b8a78804b50b9f14030ab1c7c43816672c08242c",
    "files": [
        {
            "sha": "16c9218549ee9b680e86cd1b3aeca2fb9131000d",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/b8a78804b50b9f14030ab1c7c43816672c08242c/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/b8a78804b50b9f14030ab1c7c43816672c08242c/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=b8a78804b50b9f14030ab1c7c43816672c08242c",
            "patch": "@@ -581,14 +581,23 @@ def __init__(self, max_length=None, min_length=None, verify_exists=False,\n \n     def to_python(self, value):\n         if value:\n-            if '://' not in value:\n-                # If no URL scheme given, assume http://\n-                value = u'http://%s' % value\n             url_fields = list(urlparse.urlsplit(value))\n+            if not url_fields[0]:\n+                # If no URL scheme given, assume http://\n+                url_fields[0] = 'http'\n+            if not url_fields[1]:\n+                # Assume that if no domain is provided, that the path segment\n+                # contains the domain. \n+                url_fields[1] = url_fields[2]\n+                url_fields[2] = ''\n+                # Rebuild the url_fields list, since the domain segment may now\n+                # contain the path too.\n+                value = urlparse.urlunsplit(url_fields)\n+                url_fields = list(urlparse.urlsplit(value))\n             if not url_fields[2]:\n                 # the path portion may need to be added before query params\n                 url_fields[2] = '/'\n-                value = urlparse.urlunsplit(url_fields)\n+            value = urlparse.urlunsplit(url_fields)\n         return super(URLField, self).to_python(value)\n \n class BooleanField(Field):"
        },
        {
            "sha": "bc549a984828fa4aada047b438dbb6831853a651",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/b8a78804b50b9f14030ab1c7c43816672c08242c/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/b8a78804b50b9f14030ab1c7c43816672c08242c/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=b8a78804b50b9f14030ab1c7c43816672c08242c",
            "patch": "@@ -495,6 +495,7 @@ def test_urlfield_1(self):\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, 'http://inv-.-alid.com')\n         self.assertEqual(u'http://valid-----hyphens.com/', f.clean('http://valid-----hyphens.com'))\n         self.assertEqual(u'http://some.idn.xyz\\xe4\\xf6\\xfc\\xdfabc.domain.com:123/blah', f.clean('http://some.idn.xyzäöüßabc.domain.com:123/blah'))\n+        self.assertEqual(u'http://www.example.com/s/http://code.djangoproject.com/ticket/13804', f.clean('www.example.com/s/http://code.djangoproject.com/ticket/13804'))\n \n     def test_url_regex_ticket11198(self):\n         f = URLField()"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 14,
        "deletions": 4
    }
}