{
    "author": "ramiro",
    "message": "Fixed #7783 -- Made introspection of nullable columns more robust with Postgres.\n\nThanks bthomas AT ncorcle DOT com for the report and initial patch, and\nClaude Paroz for the final, complete patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17508 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ccc0e122d42dad0f645407c469383d85bae92048",
    "files": [
        {
            "sha": "0027ec5eaf10d5e4d4642b7e2f5b7d25ba12e339",
            "filename": "django/db/backends/postgresql_psycopg2/introspection.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/ccc0e122d42dad0f645407c469383d85bae92048/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py",
            "raw_url": "https://github.com/django/django/raw/ccc0e122d42dad0f645407c469383d85bae92048/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fintrospection.py?ref=ccc0e122d42dad0f645407c469383d85bae92048",
            "patch": "@@ -34,8 +34,16 @@ def get_table_list(self, cursor):\n \n     def get_table_description(self, cursor, table_name):\n         \"Returns a description of the table, with the DB-API cursor.description interface.\"\n+        # As cursor.description does not return reliably the nullable property,\n+        # we have to query the information_schema (#7783)\n+        cursor.execute(\"\"\"\n+            SELECT column_name, is_nullable\n+            FROM information_schema.columns\n+            WHERE table_name = %s\"\"\", [table_name])\n+        null_map = dict(cursor.fetchall())\n         cursor.execute(\"SELECT * FROM %s LIMIT 1\" % self.connection.ops.quote_name(table_name))\n-        return cursor.description\n+        return [tuple([item for item in line[:6]] + [null_map[line[0]]==u'YES'])\n+            for line in cursor.description]\n \n     def get_relations(self, cursor, table_name):\n         \"\"\""
        },
        {
            "sha": "3b8383e601c397efd00c2adcae71090384f91d06",
            "filename": "tests/regressiontests/introspection/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/ccc0e122d42dad0f645407c469383d85bae92048/tests%2Fregressiontests%2Fintrospection%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/ccc0e122d42dad0f645407c469383d85bae92048/tests%2Fregressiontests%2Fintrospection%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fintrospection%2Fmodels.py?ref=ccc0e122d42dad0f645407c469383d85bae92048",
            "patch": "@@ -5,7 +5,7 @@ class Reporter(models.Model):\n     first_name = models.CharField(max_length=30)\n     last_name = models.CharField(max_length=30)\n     email = models.EmailField()\n-    facebook_user_id = models.BigIntegerField()\n+    facebook_user_id = models.BigIntegerField(null=True)\n \n     def __unicode__(self):\n         return u\"%s %s\" % (self.first_name, self.last_name)"
        },
        {
            "sha": "fa2b6c5d737ee54f392b49db739c6dcca3ddcbbb",
            "filename": "tests/regressiontests/introspection/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/ccc0e122d42dad0f645407c469383d85bae92048/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ccc0e122d42dad0f645407c469383d85bae92048/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fintrospection%2Ftests.py?ref=ccc0e122d42dad0f645407c469383d85bae92048",
            "patch": "@@ -78,6 +78,14 @@ def test_get_table_description_types(self):\n             ['IntegerField', 'CharField', 'CharField', 'CharField', 'BigIntegerField']\n         )\n \n+    def test_get_table_description_nullable(self):\n+        cursor = connection.cursor()\n+        desc = connection.introspection.get_table_description(cursor, Reporter._meta.db_table)\n+        self.assertEqual(\n+            [r[6] for r in desc],\n+            [False, False, False, False, True]\n+        )\n+\n     # Regression test for #9991 - 'real' types in postgres\n     @skipUnlessDBFeature('has_real_datatype')\n     def test_postgresql_real_type(self):"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 18,
        "deletions": 2
    }
}