{
    "author": "jbronn",
    "message": "Fixed #16778 -- Improved escaping of geometries on PostgreSQL, allowing GeoDjango to work on 9.1.  Thanks, piro for ticket and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16826 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "67e05fcd3982a569d647f4a64f40fe9793d35cbc",
    "files": [
        {
            "sha": "863ee78acd678aa58bc578a8598a88c0ebbcc6dc",
            "filename": "django/contrib/gis/db/backends/postgis/adapter.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/67e05fcd3982a569d647f4a64f40fe9793d35cbc/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fadapter.py",
            "raw_url": "https://github.com/django/django/raw/67e05fcd3982a569d647f4a64f40fe9793d35cbc/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fadapter.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fadapter.py?ref=67e05fcd3982a569d647f4a64f40fe9793d35cbc",
            "patch": "@@ -12,6 +12,7 @@ def __init__(self, geom):\n         # the adaptor) and the SRID from the geometry.\n         self.ewkb = str(geom.ewkb)\n         self.srid = geom.srid\n+        self._adapter = Binary(self.ewkb)\n \n     def __conform__(self, proto):\n         # Does the given protocol conform to what Psycopg2 expects?\n@@ -28,10 +29,17 @@ def __eq__(self, other):\n     def __str__(self):\n         return self.getquoted()\n \n+    def prepare(self, conn):\n+        \"\"\"\n+        This method allows escaping the binary in the style required by the\n+        server's `standard_conforming_string` setting.\n+        \"\"\"\n+        self._adapter.prepare(conn)\n+\n     def getquoted(self):\n         \"Returns a properly quoted string for use in PostgreSQL/PostGIS.\"\n-        # Want to use WKB, so wrap with psycopg2 Binary() to quote properly.\n-        return 'ST_GeomFromEWKB(E%s)' % Binary(self.ewkb)\n+        # psycopg will figure out whether to use E'\\\\000' or '\\000'\n+        return 'ST_GeomFromEWKB(%s)' % self._adapter.getquoted()\n \n     def prepare_database_save(self, unused):\n         return self"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 10,
        "deletions": 2
    }
}