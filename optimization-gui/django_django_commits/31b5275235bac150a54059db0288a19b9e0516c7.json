{
    "author": "aaugustin",
    "message": "Fixed #13260 -- Quoted arguments interpolated in URLs in reverse.",
    "sha": "31b5275235bac150a54059db0288a19b9e0516c7",
    "files": [
        {
            "sha": "c3d93bb24764470d83d1de6a9b7b21f4109534de",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/31b5275235bac150a54059db0288a19b9e0516c7/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/31b5275235bac150a54059db0288a19b9e0516c7/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=31b5275235bac150a54059db0288a19b9e0516c7",
            "patch": "@@ -375,6 +375,9 @@ def reverse(self, lookup_view, *args, **kwargs):\n     def _reverse_with_prefix(self, lookup_view, _prefix, *args, **kwargs):\n         if args and kwargs:\n             raise ValueError(\"Don't mix *args and **kwargs in call to reverse()!\")\n+        text_args = [force_text(v) for v in args]\n+        text_kwargs = dict((k, force_text(v)) for (k, v) in kwargs.items())\n+\n         try:\n             lookup_view = get_callable(lookup_view, True)\n         except (ImportError, AttributeError) as e:\n@@ -387,8 +390,7 @@ def _reverse_with_prefix(self, lookup_view, _prefix, *args, **kwargs):\n                 if args:\n                     if len(args) != len(params) + len(prefix_args):\n                         continue\n-                    unicode_args = [force_text(val) for val in args]\n-                    candidate = (prefix_norm.replace('%', '%%') + result) % dict(zip(prefix_args + params, unicode_args))\n+                    candidate_subs = dict(zip(prefix_args + params, text_args))\n                 else:\n                     if set(kwargs.keys()) | set(defaults.keys()) != set(params) | set(defaults.keys()) | set(prefix_args):\n                         continue\n@@ -399,10 +401,16 @@ def _reverse_with_prefix(self, lookup_view, _prefix, *args, **kwargs):\n                             break\n                     if not matches:\n                         continue\n-                    unicode_kwargs = dict([(k, force_text(v)) for (k, v) in kwargs.items()])\n-                    candidate = (prefix_norm.replace('%', '%%') + result) % unicode_kwargs\n-                if re.search('^%s%s' % (prefix_norm, pattern), candidate, re.UNICODE):\n-                    return candidate\n+                    candidate_subs = text_kwargs\n+                # WSGI provides decoded URLs, without %xx escapes, and the URL\n+                # resolver operates on such URLs. First substitute arguments\n+                # without quoting to build a decoded URL and look for a match.\n+                # Then, if we have a match, redo the substitution with quoted\n+                # arguments in order to return a properly encoded URL.\n+                candidate_pat = prefix_norm.replace('%', '%%') + result\n+                if re.search('^%s%s' % (prefix_norm, pattern), candidate_pat % candidate_subs, re.UNICODE):\n+                    candidate_subs = dict((k, urlquote(v)) for (k, v) in candidate_subs.items())\n+                    return candidate_pat % candidate_subs\n         # lookup_view can be URL label, or dotted path, or callable, Any of\n         # these can be passed in at the top, but callables are not friendly in\n         # error messages."
        },
        {
            "sha": "959a5e3ef0c34b9d35722600cec7c7be9368d58f",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/31b5275235bac150a54059db0288a19b9e0516c7/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/31b5275235bac150a54059db0288a19b9e0516c7/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=31b5275235bac150a54059db0288a19b9e0516c7",
            "patch": "@@ -281,6 +281,16 @@ warning is generated by :djadmin:`makemessages` when it finds them. E.g.:\n     {{ title }}{# Translators: Extracted and associated with 'Welcome' below #}\n     <h1>{% trans \"Welcome\" %}</h1>\n \n+Quoting in :func:`~django.core.urlresolvers.reverse`\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+When reversing URLs, Django didn't apply :func:`~django.utils.http.urlquote`\n+to arguments before interpolating them in URL patterns. This bug is fixed in\n+Django 1.6. If you worked around this bug by applying URL quoting before\n+passing arguments to :func:`~django.core.urlresolvers.reverse`, this may\n+result in double-quoting. If this happens, simply remove the URL quoting from\n+your code.\n+\n Storage of IP addresses in the comments app\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "5c9699792b74439cce45696754b827bcb101d620",
            "filename": "tests/admin_views/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fadmin_views%2Ftests.py?ref=31b5275235bac150a54059db0288a19b9e0516c7",
            "patch": "@@ -32,7 +32,7 @@\n from django.utils.cache import get_max_age\n from django.utils.encoding import iri_to_uri, force_bytes\n from django.utils.html import escape\n-from django.utils.http import urlencode\n+from django.utils.http import urlencode, urlquote\n from django.utils._os import upath\n from django.utils import six\n from django.test.utils import override_settings\n@@ -1450,8 +1450,8 @@ def test_changelist_to_changeform_link(self):\n         \"Link to the changeform of the object in changelist should use reverse() and be quoted -- #18072\"\n         prefix = '/test_admin/admin/admin_views/modelwithstringprimarykey/'\n         response = self.client.get(prefix)\n-        # this URL now comes through reverse(), thus iri_to_uri encoding\n-        pk_final_url = escape(iri_to_uri(quote(self.pk)))\n+        # this URL now comes through reverse(), thus url quoting and iri_to_uri encoding\n+        pk_final_url = escape(iri_to_uri(urlquote(quote(self.pk))))\n         should_contain = \"\"\"<th><a href=\"%s%s/\">%s</a></th>\"\"\" % (prefix, pk_final_url, escape(self.pk))\n         self.assertContains(response, should_contain)\n \n@@ -1484,8 +1484,8 @@ def test_recentactions_without_content_type(self):\n     def test_deleteconfirmation_link(self):\n         \"The link from the delete confirmation page referring back to the changeform of the object should be quoted\"\n         response = self.client.get('/test_admin/admin/admin_views/modelwithstringprimarykey/%s/delete/' % quote(self.pk))\n-        # this URL now comes through reverse(), thus iri_to_uri encoding\n-        should_contain = \"\"\"/%s/\">%s</a>\"\"\" % (escape(iri_to_uri(quote(self.pk))), escape(self.pk))\n+        # this URL now comes through reverse(), thus url quoting and iri_to_uri encoding\n+        should_contain = \"\"\"/%s/\">%s</a>\"\"\" % (escape(iri_to_uri(urlquote(quote(self.pk)))), escape(self.pk))\n         self.assertContains(response, should_contain)\n \n     def test_url_conflicts_with_add(self):"
        },
        {
            "sha": "46d1f921e2833f5ca90206fe08296ec3cc06ac48",
            "filename": "tests/template_tests/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Ftemplate_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Ftemplate_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Ftemplate_tests%2Ftests.py?ref=31b5275235bac150a54059db0288a19b9e0516c7",
            "patch": "@@ -1611,12 +1611,12 @@ def get_template_tests(self):\n             'url08': ('{% url \"метка_оператора\" v %}', {'v': 'Ω'}, '/url_tag/%D0%AE%D0%BD%D0%B8%D0%BA%D0%BE%D0%B4/%CE%A9/'),\n             'url09': ('{% url \"метка_оператора_2\" tag=v %}', {'v': 'Ω'}, '/url_tag/%D0%AE%D0%BD%D0%B8%D0%BA%D0%BE%D0%B4/%CE%A9/'),\n             'url10': ('{% url \"template_tests.views.client_action\" id=client.id action=\"two words\" %}', {'client': {'id': 1}}, '/url_tag/client/1/two%20words/'),\n-            'url11': ('{% url \"template_tests.views.client_action\" id=client.id action=\"==\" %}', {'client': {'id': 1}}, '/url_tag/client/1/==/'),\n-            'url12': ('{% url \"template_tests.views.client_action\" id=client.id action=\",\" %}', {'client': {'id': 1}}, '/url_tag/client/1/,/'),\n+            'url11': ('{% url \"template_tests.views.client_action\" id=client.id action=\"==\" %}', {'client': {'id': 1}}, '/url_tag/client/1/%3D%3D/'),\n+            'url12': ('{% url \"template_tests.views.client_action\" id=client.id action=\",\" %}', {'client': {'id': 1}}, '/url_tag/client/1/%2C/'),\n             'url13': ('{% url \"template_tests.views.client_action\" id=client.id action=arg|join:\"-\" %}', {'client': {'id': 1}, 'arg':['a','b']}, '/url_tag/client/1/a-b/'),\n             'url14': ('{% url \"template_tests.views.client_action\" client.id arg|join:\"-\" %}', {'client': {'id': 1}, 'arg':['a','b']}, '/url_tag/client/1/a-b/'),\n             'url15': ('{% url \"template_tests.views.client_action\" 12 \"test\" %}', {}, '/url_tag/client/12/test/'),\n-            'url18': ('{% url \"template_tests.views.client\" \"1,2\" %}', {}, '/url_tag/client/1,2/'),\n+            'url18': ('{% url \"template_tests.views.client\" \"1,2\" %}', {}, '/url_tag/client/1%2C2/'),\n \n             'url19': ('{% url named_url client.id %}', {'named_url': 'template_tests.views.client', 'client': {'id': 1}}, '/url_tag/client/1/'),\n             'url20': ('{% url url_name_in_var client.id %}', {'url_name_in_var': 'named.client', 'client': {'id': 1}}, '/url_tag/named-client/1/'),"
        },
        {
            "sha": "4a45e63cb0e95c705215f19512db664f7f83d9fe",
            "filename": "tests/urlpatterns_reverse/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Furlpatterns_reverse%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Furlpatterns_reverse%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Furlpatterns_reverse%2Ftests.py?ref=31b5275235bac150a54059db0288a19b9e0516c7",
            "patch": "@@ -97,7 +97,11 @@\n     ('product', '/product/chocolate+($2.00)/', [], {'price': '2.00', 'product': 'chocolate'}),\n     ('headlines', '/headlines/2007.5.21/', [], dict(year=2007, month=5, day=21)),\n     ('windows', r'/windows_path/C:%5CDocuments%20and%20Settings%5Cspam/', [], dict(drive_name='C', path=r'Documents and Settings\\spam')),\n-    ('special', r'/special_chars/+%5C$*/', [r'+\\$*'], {}),\n+    ('special', r'/special_chars/%2B%5C%24%2A/', [r'+\\$*'], {}),\n+    ('special', r'/special_chars/some%20resource/', [r'some resource'], {}),\n+    ('special', r'/special_chars/10%25%20complete/', [r'10% complete'], {}),\n+    ('special', r'/special_chars/some%20resource/', [], {'chars': r'some resource'}),\n+    ('special', r'/special_chars/10%25%20complete/', [], {'chars': r'10% complete'}),\n     ('special', NoReverseMatch, [''], {}),\n     ('mixed', '/john/0/', [], {'name': 'john'}),\n     ('repeats', '/repeats/a/', [], {}),"
        },
        {
            "sha": "1dbc8d889f0ca330ea6f10b1370f7380d354a960",
            "filename": "tests/urlpatterns_reverse/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Furlpatterns_reverse%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/31b5275235bac150a54059db0288a19b9e0516c7/tests%2Furlpatterns_reverse%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Furlpatterns_reverse%2Furls.py?ref=31b5275235bac150a54059db0288a19b9e0516c7",
            "patch": "@@ -40,7 +40,7 @@\n             name=\"headlines\"),\n     url(r'^windows_path/(?P<drive_name>[A-Z]):\\\\(?P<path>.+)/$', empty_view,\n             name=\"windows\"),\n-    url(r'^special_chars/(.+)/$', empty_view, name=\"special\"),\n+    url(r'^special_chars/(?P<chars>.+)/$', empty_view, name=\"special\"),\n     url(r'^(?P<name>.+)/\\d+/$', empty_view, name=\"mixed\"),\n     url(r'^repeats/a{1,2}/$', empty_view, name=\"repeats\"),\n     url(r'^repeats/a{2,4}/$', empty_view, name=\"repeats2\"),"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 38,
        "deletions": 16
    }
}