{
    "author": "honzakral",
    "message": "Fixed #18491 -- deleting a proxy doesn't show warning about cascade deletes",
    "sha": "2b48fcc607010065c0f8107baf669dd41b164f3c",
    "files": [
        {
            "sha": "97858e688efda0f4692840792ca67a6100c38aa9",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/2b48fcc607010065c0f8107baf669dd41b164f3c/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/2b48fcc607010065c0f8107baf669dd41b164f3c/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=2b48fcc607010065c0f8107baf669dd41b164f3c",
            "patch": "@@ -154,6 +154,9 @@ def collect(self, objs, source_attr=None, **kwargs):\n             if source_attr:\n                 self.add_edge(getattr(obj, source_attr), obj)\n             else:\n+                if obj._meta.proxy:\n+                    # Take concrete model's instance to avoid mismatch in edges\n+                    obj = obj._meta.concrete_model(pk=obj.pk)\n                 self.add_edge(None, obj)\n         try:\n             return super(NestedObjects, self).collect(objs, source_attr=source_attr, **kwargs)"
        },
        {
            "sha": "2c11351bbc35ec2c411d5d53ac730b68e3c0fb8c",
            "filename": "setup.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/2b48fcc607010065c0f8107baf669dd41b164f3c/setup.py",
            "raw_url": "https://github.com/django/django/raw/2b48fcc607010065c0f8107baf669dd41b164f3c/setup.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/setup.py?ref=2b48fcc607010065c0f8107baf669dd41b164f3c",
            "patch": "@@ -1,4 +1,4 @@\n-from distutils.core import setup\n+from setuptools import setup\n from distutils.command.install_data import install_data\n from distutils.command.install import INSTALL_SCHEMES\n from distutils.sysconfig import get_python_lib"
        },
        {
            "sha": "15943064c8d54eaac539fce9d8998545c0351f02",
            "filename": "tests/modeltests/proxy_models/fixtures/myhorses.json",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/2b48fcc607010065c0f8107baf669dd41b164f3c/tests%2Fmodeltests%2Fproxy_models%2Ffixtures%2Fmyhorses.json",
            "raw_url": "https://github.com/django/django/raw/2b48fcc607010065c0f8107baf669dd41b164f3c/tests%2Fmodeltests%2Fproxy_models%2Ffixtures%2Fmyhorses.json",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fproxy_models%2Ffixtures%2Fmyhorses.json?ref=2b48fcc607010065c0f8107baf669dd41b164f3c",
            "patch": "@@ -0,0 +1,24 @@\n+[\n+    {\n+        \"pk\": 100,\n+        \"model\": \"proxy_models.BaseUser\",\n+        \"fields\": {\n+            \"name\": \"Django Pony\"\n+        }\n+    },\n+    {\n+        \"pk\": 100,\n+        \"model\": \"proxy_models.TrackerUser\",\n+        \"fields\": {\n+            \"status\": \"emperor\"\n+        }\n+    },\n+    {\n+        \"pk\": 100,\n+        \"model\": \"proxy_models.Issue\",\n+        \"fields\": {\n+            \"summary\": \"Pony's Issue\",\n+            \"assignee\": 100\n+        }\n+    }\n+]\n\\ No newline at end of file"
        },
        {
            "sha": "c0b67c29d1d1012e1e2ff0634987b4182227cde3",
            "filename": "tests/modeltests/proxy_models/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/2b48fcc607010065c0f8107baf669dd41b164f3c/tests%2Fmodeltests%2Fproxy_models%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2b48fcc607010065c0f8107baf669dd41b164f3c/tests%2Fmodeltests%2Fproxy_models%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fproxy_models%2Ftests.py?ref=2b48fcc607010065c0f8107baf669dd41b164f3c",
            "patch": "@@ -2,6 +2,7 @@\n import copy\n \n from django.conf import settings\n+from django.contrib import admin\n from django.contrib.contenttypes.models import ContentType\n from django.core import management\n from django.core.exceptions import FieldError\n@@ -14,7 +15,7 @@\n from .models import (MyPerson, Person, StatusPerson, LowerStatusPerson,\n     MyPersonProxy, Abstract, OtherPerson, User, UserProxy, UserProxyProxy,\n     Country, State, StateProxy, TrackerUser, BaseUser, Bug, ProxyTrackerUser,\n-    Improvement, ProxyProxyBug, ProxyBug, ProxyImprovement)\n+    Improvement, ProxyProxyBug, ProxyBug, ProxyImprovement, Issue)\n \n \n class ProxyModelTests(TestCase):\n@@ -360,3 +361,28 @@ def test_proxy_load_from_fixture(self):\n         management.call_command('loaddata', 'mypeople.json', verbosity=0, commit=False)\n         p = MyPerson.objects.get(pk=100)\n         self.assertEqual(p.name, 'Elvis Presley')\n+\n+\n+class ProxyModelAdminTests(TestCase):\n+    def setUp(self):\n+        management.call_command('loaddata', 'myhorses.json', verbosity=0,\n+            commit=False)\n+\n+    def tearDown(self):\n+        TrackerUser.objects.all().delete()\n+        Issue.objects.all().delete()\n+\n+    def test_cascade_delete_proxy_model_admin_warning(self):\n+        \"\"\"\n+        Test if admin gives warning about cascade deleting models referenced\n+        to concrete model by deleting proxy object.\n+        \"\"\"\n+        tracker_user = TrackerUser.objects.all()[0]\n+        base_user = BaseUser.objects.all()[0]\n+        issue = Issue.objects.all()[0]\n+        with self.assertNumQueries(7):\n+            collector = admin.util.NestedObjects('default')\n+            collector.collect(ProxyTrackerUser.objects.all())\n+        self.assertTrue(tracker_user in collector.edges.get(None, ()))\n+        self.assertTrue(base_user in collector.edges.get(None, ()))\n+        self.assertTrue(issue in collector.edges.get(tracker_user, ()))"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 55,
        "deletions": 2
    }
}