{
    "author": "spookylukey",
    "message": "Fixed #717 - If-Modified-Since handling should compare dates according to RFC 2616\n\nThanks to Maniac for the report, julienb for the initial patch, and\nespecially to aaugustin for the final patch and tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15696 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "dbe6ced0d6911386d731a045e00b0d4c005b8e45",
    "files": [
        {
            "sha": "e98858f772fa5f89e980b4f734bff815038763fe",
            "filename": "django/middleware/http.py",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Fmiddleware%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Fmiddleware%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fhttp.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -1,5 +1,5 @@\n from django.core.exceptions import MiddlewareNotUsed\n-from django.utils.http import http_date\n+from django.utils.http import http_date, parse_http_date_safe\n \n class ConditionalGetMiddleware(object):\n     \"\"\"\n@@ -15,18 +15,22 @@ def process_response(self, request, response):\n             response['Content-Length'] = str(len(response.content))\n \n         if response.has_header('ETag'):\n-            if_none_match = request.META.get('HTTP_IF_NONE_MATCH', None)\n+            if_none_match = request.META.get('HTTP_IF_NONE_MATCH')\n             if if_none_match == response['ETag']:\n                 # Setting the status is enough here. The response handling path\n                 # automatically removes content for this status code (in\n                 # http.conditional_content_removal()).\n                 response.status_code = 304\n \n         if response.has_header('Last-Modified'):\n-            if_modified_since = request.META.get('HTTP_IF_MODIFIED_SINCE', None)\n-            if if_modified_since == response['Last-Modified']:\n-                # Setting the status code is enough here (same reasons as\n-                # above).\n-                response.status_code = 304\n+            if_modified_since = request.META.get('HTTP_IF_MODIFIED_SINCE')\n+            if if_modified_since is not None:\n+                if_modified_since = parse_http_date_safe(if_modified_since)\n+            if if_modified_since is not None:\n+                last_modified = parse_http_date_safe(response['Last-Modified'])\n+                if last_modified is not None and last_modified <= if_modified_since:\n+                    # Setting the status code is enough here (same reasons as\n+                    # above).\n+                    response.status_code = 304\n \n         return response"
        },
        {
            "sha": "bdc367c8f78ff78cb91351e1ce0bdb508747b253",
            "filename": "django/utils/http.py",
            "status": "modified",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Futils%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Futils%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhttp.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -1,3 +1,5 @@\n+import calendar\n+import datetime\n import re\n import sys\n import urllib\n@@ -8,6 +10,17 @@\n \n ETAG_MATCH = re.compile(r'(?:W/)?\"((?:\\\\.|[^\"])*)\"')\n \n+MONTHS = 'jan feb mar apr may jun jul aug sep oct nov dec'.split()\n+__D = r'(?P<day>\\d{2})'\n+__D2 = r'(?P<day>[ \\d]\\d)'\n+__M = r'(?P<mon>\\w{3})'\n+__Y = r'(?P<year>\\d{4})'\n+__Y2 = r'(?P<year>\\d{2})'\n+__T = r'(?P<hour>\\d{2}):(?P<min>\\d{2}):(?P<sec>\\d{2})'\n+RFC1123_DATE = re.compile(r'^\\w{3}, %s %s %s %s GMT$' % (__D, __M, __Y, __T))\n+RFC850_DATE = re.compile(r'^\\w{6,9}, %s-%s-%s %s GMT$' % (__D, __M, __Y2, __T))\n+ASCTIME_DATE = re.compile(r'^\\w{3} %s %s %s %s$' % (__M, __D2, __T, __Y))\n+\n def urlquote(url, safe='/'):\n     \"\"\"\n     A version of Python's urllib.quote() function that can operate on unicode\n@@ -70,6 +83,48 @@ def http_date(epoch_seconds=None):\n     rfcdate = formatdate(epoch_seconds)\n     return '%s GMT' % rfcdate[:25]\n \n+def parse_http_date(date):\n+    \"\"\"\n+    Parses a date format as specified by HTTP RFC2616 section 3.3.1.\n+\n+    The three formats allowed by the RFC are accepted, even if only the first\n+    one is still in widespread use.\n+\n+    Returns an floating point number expressed in seconds since the epoch, in\n+    UTC.\n+    \"\"\"\n+    # emails.Util.parsedate does the job for RFC1123 dates; unfortunately\n+    # RFC2616 makes it mandatory to support RFC850 dates too. So we roll\n+    # our own RFC-compliant parsing.\n+    for regex in RFC1123_DATE, RFC850_DATE, ASCTIME_DATE:\n+        m = regex.match(date)\n+        if m is not None:\n+            break\n+    else:\n+        raise ValueError(\"%r is not in a valid HTTP date format\" % date)\n+    try:\n+        year = int(m.group('year'))\n+        if year < 100:\n+            year += 2000 if year < 70 else 1900\n+        month = MONTHS.index(m.group('mon').lower()) + 1\n+        day = int(m.group('day'))\n+        hour = int(m.group('hour'))\n+        min = int(m.group('min'))\n+        sec = int(m.group('sec'))\n+        result = datetime.datetime(year, month, day, hour, min, sec)\n+        return calendar.timegm(result.utctimetuple())\n+    except Exception:\n+        raise ValueError(\"%r is not a valid date\" % date)\n+\n+def parse_http_date_safe(date):\n+    \"\"\"\n+    Same as parse_http_date, but returns None if the input is invalid.\n+    \"\"\"\n+    try:\n+        return parse_http_date(date)\n+    except Exception:\n+        pass\n+\n # Base 36 functions: useful for generating compact URLs\n \n def base36_to_int(s):"
        },
        {
            "sha": "fb3181e10ed432070a741cbe56aeec9a6cbb6b1a",
            "filename": "django/views/decorators/http.py",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Fviews%2Fdecorators%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Fviews%2Fdecorators%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdecorators%2Fhttp.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -9,10 +9,9 @@\n \n from calendar import timegm\n from datetime import timedelta\n-from email.Utils import formatdate\n \n from django.utils.decorators import decorator_from_middleware, available_attrs\n-from django.utils.http import parse_etags, quote_etag\n+from django.utils.http import http_date, parse_http_date_safe, parse_etags, quote_etag\n from django.utils.log import getLogger\n from django.middleware.http import ConditionalGetMiddleware\n from django.http import HttpResponseNotAllowed, HttpResponseNotModified, HttpResponse\n@@ -79,6 +78,8 @@ def decorator(func):\n         def inner(request, *args, **kwargs):\n             # Get HTTP request headers\n             if_modified_since = request.META.get(\"HTTP_IF_MODIFIED_SINCE\")\n+            if if_modified_since:\n+                if_modified_since = parse_http_date_safe(if_modified_since)\n             if_none_match = request.META.get(\"HTTP_IF_NONE_MATCH\")\n             if_match = request.META.get(\"HTTP_IF_MATCH\")\n             if if_none_match or if_match:\n@@ -102,7 +103,7 @@ def inner(request, *args, **kwargs):\n             if last_modified_func:\n                 dt = last_modified_func(request, *args, **kwargs)\n                 if dt:\n-                    res_last_modified = formatdate(timegm(dt.utctimetuple()))[:26] + 'GMT'\n+                    res_last_modified = timegm(dt.utctimetuple())\n                 else:\n                     res_last_modified = None\n             else:\n@@ -116,7 +117,8 @@ def inner(request, *args, **kwargs):\n                 if ((if_none_match and (res_etag in etags or\n                         \"*\" in etags and res_etag)) and\n                         (not if_modified_since or\n-                            res_last_modified == if_modified_since)):\n+                            (res_last_modified and if_modified_since and\n+                            res_last_modified <= if_modified_since))):\n                     if request.method in (\"GET\", \"HEAD\"):\n                         response = HttpResponseNotModified()\n                     else:\n@@ -136,17 +138,17 @@ def inner(request, *args, **kwargs):\n                         }\n                     )\n                     response = HttpResponse(status=412)\n-                elif (not if_none_match and if_modified_since and\n-                        request.method == \"GET\" and\n-                        res_last_modified == if_modified_since):\n+                elif (not if_none_match and request.method == \"GET\" and\n+                        res_last_modified and if_modified_since and\n+                        res_last_modified <= if_modified_since):\n                     response = HttpResponseNotModified()\n \n             if response is None:\n                 response = func(request, *args, **kwargs)\n \n             # Set relevant headers on the response if they don't already exist.\n             if res_last_modified and not response.has_header('Last-Modified'):\n-                response['Last-Modified'] = res_last_modified\n+                response['Last-Modified'] = http_date(res_last_modified)\n             if res_etag and not response.has_header('ETag'):\n                 response['ETag'] = quote_etag(res_etag)\n "
        },
        {
            "sha": "3aeb2ed98e750e41df16d9251fd5f0b3aee0b9f7",
            "filename": "django/views/static.py",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Fviews%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/django%2Fviews%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fstatic.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -9,12 +9,11 @@\n import re\n import stat\n import urllib\n-from email.Utils import parsedate_tz, mktime_tz\n \n from django.template import loader\n from django.http import Http404, HttpResponse, HttpResponseRedirect, HttpResponseNotModified\n from django.template import Template, Context, TemplateDoesNotExist\n-from django.utils.http import http_date\n+from django.utils.http import http_date, parse_http_date\n \n def serve(request, path, document_root=None, show_indexes=False):\n     \"\"\"\n@@ -128,10 +127,7 @@ def was_modified_since(header=None, mtime=0, size=0):\n             raise ValueError\n         matches = re.match(r\"^([^;]+)(; length=([0-9]+))?$\", header,\n                            re.IGNORECASE)\n-        header_date = parsedate_tz(matches.group(1))\n-        if header_date is None:\n-            raise ValueError\n-        header_mtime = mktime_tz(header_date)\n+        header_mtime = parse_http_date(matches.group(1))\n         header_len = matches.group(3)\n         if header_len and int(header_len) != size:\n             raise ValueError"
        },
        {
            "sha": "129d11b07facb62e431fcbb36d400b2f9ea62080",
            "filename": "tests/regressiontests/conditional_processing/models.py",
            "status": "modified",
            "additions": 30,
            "deletions": 4,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/tests%2Fregressiontests%2Fconditional_processing%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/tests%2Fregressiontests%2Fconditional_processing%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fconditional_processing%2Fmodels.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -1,17 +1,20 @@\n # -*- coding:utf-8 -*-\n-from datetime import datetime, timedelta\n-from calendar import timegm\n+from datetime import datetime\n \n from django.test import TestCase\n-from django.utils.http import parse_etags, quote_etag\n+from django.utils import unittest\n+from django.utils.http import parse_etags, quote_etag, parse_http_date\n \n FULL_RESPONSE = 'Test conditional get response'\n LAST_MODIFIED = datetime(2007, 10, 21, 23, 21, 47)\n LAST_MODIFIED_STR = 'Sun, 21 Oct 2007 23:21:47 GMT'\n+LAST_MODIFIED_NEWER_STR = 'Mon, 18 Oct 2010 16:56:23 GMT'\n+LAST_MODIFIED_INVALID_STR = 'Mon, 32 Oct 2010 16:56:23 GMT'\n EXPIRED_LAST_MODIFIED_STR = 'Sat, 20 Oct 2007 23:21:47 GMT'\n ETAG = 'b4246ffc4f62314ca13147c9d4f76974'\n EXPIRED_ETAG = '7fae4cd4b0f81e7d2914700043aa8ed6'\n \n+\n class ConditionalGet(TestCase):\n     def assertFullResponse(self, response, check_last_modified=True, check_etag=True):\n         self.assertEquals(response.status_code, 200)\n@@ -33,6 +36,12 @@ def testIfModifiedSince(self):\n         self.client.defaults['HTTP_IF_MODIFIED_SINCE'] = LAST_MODIFIED_STR\n         response = self.client.get('/condition/')\n         self.assertNotModified(response)\n+        self.client.defaults['HTTP_IF_MODIFIED_SINCE'] = LAST_MODIFIED_NEWER_STR\n+        response = self.client.get('/condition/')\n+        self.assertNotModified(response)\n+        self.client.defaults['HTTP_IF_MODIFIED_SINCE'] = LAST_MODIFIED_INVALID_STR\n+        response = self.client.get('/condition/')\n+        self.assertFullResponse(response)\n         self.client.defaults['HTTP_IF_MODIFIED_SINCE'] = EXPIRED_LAST_MODIFIED_STR\n         response = self.client.get('/condition/')\n         self.assertFullResponse(response)\n@@ -118,11 +127,28 @@ def testInvalidETag(self):\n         self.assertFullResponse(response, check_last_modified=False)\n \n \n-class ETagProcesing(TestCase):\n+class ETagProcessing(unittest.TestCase):\n     def testParsing(self):\n         etags = parse_etags(r'\"\", \"etag\", \"e\\\"t\\\"ag\", \"e\\\\tag\", W/\"weak\"')\n         self.assertEquals(etags, ['', 'etag', 'e\"t\"ag', r'e\\tag', 'weak'])\n \n     def testQuoting(self):\n         quoted_etag = quote_etag(r'e\\t\"ag')\n         self.assertEquals(quoted_etag, r'\"e\\\\t\\\"ag\"')\n+\n+\n+class HttpDateProcessing(unittest.TestCase):\n+    def testParsingRfc1123(self):\n+        parsed = parse_http_date('Sun, 06 Nov 1994 08:49:37 GMT')\n+        self.assertEqual(datetime.utcfromtimestamp(parsed),\n+                         datetime(1994, 11, 06, 8, 49, 37))\n+\n+    def testParsingRfc850(self):\n+        parsed = parse_http_date('Sunday, 06-Nov-94 08:49:37 GMT')\n+        self.assertEqual(datetime.utcfromtimestamp(parsed),\n+                         datetime(1994, 11, 06, 8, 49, 37))\n+\n+    def testParsingAsctime(self):\n+        parsed = parse_http_date('Sun Nov  6 08:49:37 1994')\n+        self.assertEqual(datetime.utcfromtimestamp(parsed),\n+                         datetime(1994, 11, 06, 8, 49, 37))"
        },
        {
            "sha": "5d90ffc5dcbd241a025499127e18afa0b55ff0bf",
            "filename": "tests/regressiontests/middleware/tests.py",
            "status": "modified",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Ftests.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -3,6 +3,7 @@\n from django.conf import settings\n from django.http import HttpRequest\n from django.middleware.common import CommonMiddleware\n+from django.middleware.http import ConditionalGetMiddleware\n from django.test import TestCase\n \n \n@@ -247,3 +248,89 @@ def test_prepend_www_append_slash_slashless_custom_urlconf(self):\n       self.assertEquals(r.status_code, 301)\n       self.assertEquals(r['Location'],\n                         'http://www.testserver/middleware/customurlconf/slash/')\n+\n+class ConditionalGetMiddlewareTest(TestCase):\n+    urls = 'regressiontests.middleware.cond_get_urls'\n+    def setUp(self):\n+        self.req = HttpRequest()\n+        self.req.META = {\n+            'SERVER_NAME': 'testserver',\n+            'SERVER_PORT': 80,\n+        }\n+        self.req.path = self.req.path_info = \"/\"\n+        self.resp = self.client.get(self.req.path)\n+\n+    # Tests for the Date header\n+\n+    def test_date_header_added(self):\n+        self.assertFalse('Date' in self.resp)\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertTrue('Date' in self.resp)\n+\n+    # Tests for the Content-Length header\n+\n+    def test_content_length_header_added(self):\n+        content_length = len(self.resp.content)\n+        self.assertFalse('Content-Length' in self.resp)\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertTrue('Content-Length' in self.resp)\n+        self.assertEqual(int(self.resp['Content-Length']), content_length)\n+\n+    def test_content_length_header_not_changed(self):\n+        bad_content_length = len(self.resp.content) + 10\n+        self.resp['Content-Length'] = bad_content_length\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(int(self.resp['Content-Length']), bad_content_length)\n+\n+    # Tests for the ETag header\n+\n+    def test_if_none_match_and_no_etag(self):\n+        self.req.META['HTTP_IF_NONE_MATCH'] = 'spam'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 200)\n+\n+    def test_no_if_none_match_and_etag(self):\n+        self.resp['ETag'] = 'eggs'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 200)\n+\n+    def test_if_none_match_and_same_etag(self):\n+        self.req.META['HTTP_IF_NONE_MATCH'] = self.resp['ETag'] = 'spam'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 304)\n+\n+    def test_if_none_match_and_different_etag(self):\n+        self.req.META['HTTP_IF_NONE_MATCH'] = 'spam'\n+        self.resp['ETag'] = 'eggs'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 200)\n+\n+    # Tests for the Last-Modified header\n+\n+    def test_if_modified_since_and_no_last_modified(self):\n+        self.req.META['HTTP_IF_MODIFIED_SINCE'] = 'Sat, 12 Feb 2011 17:38:44 GMT'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 200)\n+\n+    def test_no_if_modified_since_and_last_modified(self):\n+        self.resp['Last-Modified'] = 'Sat, 12 Feb 2011 17:38:44 GMT'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 200)\n+\n+    def test_if_modified_since_and_same_last_modified(self):\n+        self.req.META['HTTP_IF_MODIFIED_SINCE'] = 'Sat, 12 Feb 2011 17:38:44 GMT'\n+        self.resp['Last-Modified'] = 'Sat, 12 Feb 2011 17:38:44 GMT'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 304)\n+\n+    def test_if_modified_since_and_last_modified_in_the_past(self):\n+        self.req.META['HTTP_IF_MODIFIED_SINCE'] = 'Sat, 12 Feb 2011 17:38:44 GMT'\n+        self.resp['Last-Modified'] = 'Sat, 12 Feb 2011 17:35:44 GMT'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 304)\n+\n+    def test_if_modified_since_and_last_modified_in_the_future(self):\n+        self.req.META['HTTP_IF_MODIFIED_SINCE'] = 'Sat, 12 Feb 2011 17:38:44 GMT'\n+        self.resp['Last-Modified'] = 'Sat, 12 Feb 2011 17:41:44 GMT'\n+        self.resp = ConditionalGetMiddleware().process_response(self.req, self.resp)\n+        self.assertEquals(self.resp.status_code, 200)"
        },
        {
            "sha": "e3bc1643c512ab5b81a3a0551412716f7f6d0108",
            "filename": "tests/regressiontests/views/tests/static.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/dbe6ced0d6911386d731a045e00b0d4c005b8e45/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/dbe6ced0d6911386d731a045e00b0d4c005b8e45/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py?ref=dbe6ced0d6911386d731a045e00b0d4c005b8e45",
            "patch": "@@ -51,7 +51,7 @@ def test_not_modified_since(self):\n         file_name = 'file.txt'\n         response = self.client.get(\n             '/views/%s/%s' % (self.prefix, file_name),\n-            HTTP_IF_MODIFIED_SINCE='Mon, 18 Jan 2038 05:14:07 UTC'\n+            HTTP_IF_MODIFIED_SINCE='Mon, 18 Jan 2038 05:14:07 GMT'\n             # This is 24h before max Unix time. Remember to fix Django and\n             # update this test well before 2038 :)\n             )"
        }
    ],
    "stats": {
        "total": 222,
        "additions": 196,
        "deletions": 26
    }
}