{
    "author": "claudep",
    "message": "Fixed #19171 -- Allowed coordinate transforms with custom SRIDs\n\nThanks reidpr at lanl.gov for the report.",
    "sha": "360217fc87db82575c8b07704143ced07c2a234c",
    "files": [
        {
            "sha": "01719c21d42ae9b35c07084e40235aa1ddaae4be",
            "filename": "django/contrib/gis/geos/geometry.py",
            "status": "modified",
            "additions": 16,
            "deletions": 12,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/360217fc87db82575c8b07704143ced07c2a234c/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "raw_url": "https://github.com/django/django/raw/360217fc87db82575c8b07704143ced07c2a234c/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py?ref=360217fc87db82575c8b07704143ced07c2a234c",
            "patch": "@@ -11,6 +11,8 @@\n # super-class for mutable list behavior\n from django.contrib.gis.geos.mutable_list import ListMixin\n \n+from django.contrib.gis.gdal.error import SRSException\n+\n # GEOS-related dependencies.\n from django.contrib.gis.geos.base import GEOSBase, gdal\n from django.contrib.gis.geos.coordseq import GEOSCoordSeq\n@@ -460,24 +462,26 @@ def prepared(self):\n     @property\n     def ogr(self):\n         \"Returns the OGR Geometry for this Geometry.\"\n-        if gdal.HAS_GDAL:\n-            if self.srid:\n-                return gdal.OGRGeometry(self.wkb, self.srid)\n-            else:\n-                return gdal.OGRGeometry(self.wkb)\n-        else:\n+        if not gdal.HAS_GDAL:\n             raise GEOSException('GDAL required to convert to an OGRGeometry.')\n+        if self.srid:\n+            try:\n+                return gdal.OGRGeometry(self.wkb, self.srid)\n+            except SRSException:\n+                pass\n+        return gdal.OGRGeometry(self.wkb)\n \n     @property\n     def srs(self):\n         \"Returns the OSR SpatialReference for SRID of this Geometry.\"\n-        if gdal.HAS_GDAL:\n-            if self.srid:\n-                return gdal.SpatialReference(self.srid)\n-            else:\n-                return None\n-        else:\n+        if not gdal.HAS_GDAL:\n             raise GEOSException('GDAL required to return a SpatialReference object.')\n+        if self.srid:\n+            try:\n+                return gdal.SpatialReference(self.srid)\n+            except SRSException:\n+                pass\n+        return None\n \n     @property\n     def crs(self):"
        },
        {
            "sha": "de9471211e6e5577996462612a2a773312af26d2",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/360217fc87db82575c8b07704143ced07c2a234c/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/360217fc87db82575c8b07704143ced07c2a234c/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=360217fc87db82575c8b07704143ced07c2a234c",
            "patch": "@@ -662,6 +662,22 @@ def test_srid(self):\n         p3 = fromstr(p1.hex, srid=-1) # -1 is intended.\n         self.assertEqual(-1, p3.srid)\n \n+    def test_custom_srid(self):\n+        \"\"\" Test with a srid unknown from GDAL \"\"\"\n+        pnt = Point(111200, 220900, srid=999999)\n+        self.assertTrue(pnt.ewkt.startswith(\"SRID=999999;POINT (111200.0\"))\n+        self.assertIsInstance(pnt.ogr, gdal.OGRGeometry)\n+        self.assertIsNone(pnt.srs)\n+\n+        # Test conversion from custom to a known srid\n+        c2w = gdal.CoordTransform(\n+            gdal.SpatialReference('+proj=mill +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +R_A +ellps=WGS84 +datum=WGS84 +units=m +no_defs'),\n+            gdal.SpatialReference(4326))\n+        new_pnt = pnt.transform(c2w, clone=True)\n+        self.assertEqual(new_pnt.srid, 4326)\n+        self.assertAlmostEqual(new_pnt.x, 1, 3)\n+        self.assertAlmostEqual(new_pnt.y, 2, 3)\n+\n     def test_mutable_geometries(self):\n         \"Testing the mutability of Polygons and Geometry Collections.\"\n         ### Testing the mutability of Polygons ###"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 32,
        "deletions": 12
    }
}