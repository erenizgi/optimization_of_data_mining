{
    "author": "jbronn",
    "message": "Fixed `F()` expression regressions in GeoDjango caused by recent datastructure changes in `SQLEvaluator`.",
    "sha": "cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8",
    "files": [
        {
            "sha": "0bd598997cb048a71db13fddf7c527d2e2523928",
            "filename": "django/contrib/gis/db/backends/base.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fbase.py?ref=cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8",
            "patch": "@@ -116,6 +116,16 @@ def get_geom_placeholder(self, f, value):\n         \"\"\"\n         raise NotImplementedError\n \n+    def get_expression_column(self, evaluator):\n+        \"\"\"\n+        Helper method to return the quoted column string from the evaluator\n+        for its expression.\n+        \"\"\"\n+        for expr, col_tup in evaluator.cols:\n+            if expr is evaluator.expression:\n+                return '%s.%s' % tuple(map(self.quote_name, col_tup))\n+        raise Exception(\"Could not find the column for the expression.\")\n+\n     # Spatial SQL Construction\n     def spatial_aggregate_sql(self, agg):\n         raise NotImplementedError('Aggregate support not implemented for this spatial backend.')"
        },
        {
            "sha": "0c1be624f122bc28be753d47e80a5fa1861bbd8c",
            "filename": "django/contrib/gis/db/backends/mysql/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fmysql%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fmysql%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fmysql%2Foperations.py?ref=cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8",
            "patch": "@@ -44,7 +44,7 @@ def get_geom_placeholder(self, value, srid):\n         modify the placeholder based on the contents of the given value.\n         \"\"\"\n         if hasattr(value, 'expression'):\n-            placeholder = '%s.%s' % tuple(map(self.quote_name, value.cols[value.expression]))\n+            placeholder = placeholder % self.get_expression_column(value)\n         else:\n             placeholder = '%s(%%s)' % self.from_text\n         return placeholder"
        },
        {
            "sha": "35a4d9491d1e82968ae5499f90c0b88b1da19d1e",
            "filename": "django/contrib/gis/db/backends/oracle/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py?ref=cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8",
            "patch": "@@ -213,7 +213,7 @@ def transform_value(val, srid):\n                 placeholder = '%s'\n             # No geometry value used for F expression, substitue in\n             # the column name instead.\n-            return placeholder % '%s.%s' % tuple(map(self.quote_name, value.cols[value.expression]))\n+            return placeholder % self.get_expression_column(value)\n         else:\n             if transform_value(value, f.srid):\n                 return '%s(SDO_GEOMETRY(%%s, %s), %s)' % (self.transform, value.srid, f.srid)"
        },
        {
            "sha": "ff9110de01c32005fe9c4aa192a93e1a727e4999",
            "filename": "django/contrib/gis/db/backends/postgis/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Foperations.py?ref=cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8",
            "patch": "@@ -381,7 +381,7 @@ def get_geom_placeholder(self, f, value):\n             # If this is an F expression, then we don't really want\n             # a placeholder and instead substitute in the column\n             # of the expression.\n-            placeholder = placeholder % '%s.%s' % tuple(map(self.quote_name, value.cols[value.expression]))\n+            placeholder = placeholder % self.get_expression_column(value)\n \n         return placeholder\n "
        },
        {
            "sha": "5f76501ef1f3e29d60e2293747df61fbe7f7ba88",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=cd99c12f05b10cb1b3a07b7b4fcd9fb89785f7a8",
            "patch": "@@ -208,7 +208,7 @@ def transform_value(value, srid):\n                 placeholder = '%s'\n             # No geometry value used for F expression, substitue in\n             # the column name instead.\n-            return placeholder % '%s.%s' % tuple(map(self.quote_name, value.cols[value.expression]))\n+            return placeholder % self.get_expression_column(value)\n         else:\n             if transform_value(value, f.srid):\n                 # Adding Transform() to the SQL placeholder."
        }
    ],
    "stats": {
        "total": 18,
        "additions": 14,
        "deletions": 4
    }
}