{
    "author": "spookylukey",
    "message": "Fixed #7267 - UnicodeDecodeError in clean_html\n\nThanks to Nikolay for the report, and gav and aaugustin for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16118 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "cf11e3789b6643cf451d79d675a97c4de94542b0",
    "files": [
        {
            "sha": "7fda015840c75043cafd35d8fa76ae0fe43017fe",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/cf11e3789b6643cf451d79d675a97c4de94542b0/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/cf11e3789b6643cf451d79d675a97c4de94542b0/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=cf11e3789b6643cf451d79d675a97c4de94542b0",
            "patch": "@@ -13,7 +13,7 @@\n TRAILING_PUNCTUATION = ['.', ',', ')', '>', '\\n', '&gt;']\n \n # List of possible strings used for bullets in bulleted lists.\n-DOTS = ['&middot;', '*', '\\xe2\\x80\\xa2', '&#149;', '&bull;', '&#8226;']\n+DOTS = [u'&middot;', u'*', u'\\u2022', u'&#149;', u'&bull;', u'&#8226;']\n \n unencoded_ampersands_re = re.compile(r'&(?!(\\w+|#\\d+);)')\n word_split_re = re.compile(r'(\\s+)')\n@@ -180,13 +180,13 @@ def clean_html(text):\n     text = html_gunk_re.sub('', text)\n     # Convert hard-coded bullets into HTML unordered lists.\n     def replace_p_tags(match):\n-        s = match.group().replace('</p>', '</li>')\n+        s = match.group().replace(u'</p>', u'</li>')\n         for d in DOTS:\n-            s = s.replace('<p>%s' % d, '<li>')\n+            s = s.replace(u'<p>%s' % d, u'<li>')\n         return u'<ul>\\n%s\\n</ul>' % s\n     text = hard_coded_bullets_re.sub(replace_p_tags, text)\n     # Remove stuff like \"<p>&nbsp;&nbsp;</p>\", but only if it's at the bottom\n     # of the text.\n-    text = trailing_empty_content_re.sub('', text)\n+    text = trailing_empty_content_re.sub(u'', text)\n     return text\n clean_html = allow_lazy(clean_html, unicode)"
        },
        {
            "sha": "d8b9bde8bf9d8b93f11fd08aed9c97e03f1094d3",
            "filename": "tests/regressiontests/utils/html.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/cf11e3789b6643cf451d79d675a97c4de94542b0/tests%2Fregressiontests%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/cf11e3789b6643cf451d79d675a97c4de94542b0/tests%2Fregressiontests%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fhtml.py?ref=cf11e3789b6643cf451d79d675a97c4de94542b0",
            "patch": "@@ -121,3 +121,15 @@ def test_escapejs(self):\n         )\n         for value, output in items:\n             self.check_output(f, value, output)\n+\n+    def test_clean_html(self):\n+        f = html.clean_html\n+        items = (\n+            (u'<p>I <i>believe</i> in <b>semantic markup</b>!</p>', u'<p>I <em>believe</em> in <strong>semantic markup</strong>!</p>'),\n+            (u'I escape & I don\\'t <a href=\"#\" target=\"_blank\">target</a>', u'I escape &amp; I don\\'t <a href=\"#\" >target</a>'),\n+            (u'<p>I kill whitespace</p><br clear=\"all\"><p>&nbsp;</p>', u'<p>I kill whitespace</p>'),\n+            # also a regression test for #7267: this used to raise an UnicodeDecodeError\n+            (u'<p>* foo</p><p>* bar</p>', u'<ul>\\n<li> foo</li><li> bar</li>\\n</ul>'),\n+        )\n+        for value, output in items:\n+            self.check_output(f, value, output)"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 16,
        "deletions": 4
    }
}