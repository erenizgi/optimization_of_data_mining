{
    "author": "aaugustin",
    "message": "Used commit_on_success_unless_managed in loaddata.",
    "sha": "d04964e70d5c6277e79874ba8950e23c224b323b",
    "files": [
        {
            "sha": "8aa40cf021e2bea6bc3fab13ce1eaf93594cc547",
            "filename": "django/core/management/commands/loaddata.py",
            "status": "modified",
            "additions": 21,
            "deletions": 48,
            "changes": 69,
            "blob_url": "https://github.com/django/django/blob/d04964e70d5c6277e79874ba8950e23c224b323b/django%2Fcore%2Fmanagement%2Fcommands%2Floaddata.py",
            "raw_url": "https://github.com/django/django/raw/d04964e70d5c6277e79874ba8950e23c224b323b/django%2Fcore%2Fmanagement%2Fcommands%2Floaddata.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Floaddata.py?ref=d04964e70d5c6277e79874ba8950e23c224b323b",
            "patch": "@@ -41,8 +41,6 @@ def handle(self, *fixture_labels, **options):\n         self.ignore = options.get('ignore')\n         self.using = options.get('database')\n \n-        connection = connections[self.using]\n-\n         if not len(fixture_labels):\n             raise CommandError(\n                 \"No database fixture specified. Please provide the path of at \"\n@@ -51,30 +49,25 @@ def handle(self, *fixture_labels, **options):\n \n         self.verbosity = int(options.get('verbosity'))\n \n-        # commit is a stealth option - it isn't really useful as\n-        # a command line option, but it can be useful when invoking\n-        # loaddata from within another script.\n-        # If commit=True, loaddata will use its own transaction;\n-        # if commit=False, the data load SQL will become part of\n-        # the transaction in place when loaddata was invoked.\n-        commit = options.get('commit', True)\n+        with transaction.commit_on_success_unless_managed(using=self.using):\n+            self.loaddata(fixture_labels)\n+\n+        # Close the DB connection -- unless we're still in a transaction. This\n+        # is required as a workaround for an  edge case in MySQL: if the same\n+        # connection is used to create tables, load data, and query, the query\n+        # can return incorrect results. See Django #7572, MySQL #37735.\n+        if transaction.get_autocommit(self.using):\n+            connections[self.using].close()\n+\n+    def loaddata(self, fixture_labels):\n+        connection = connections[self.using]\n \n         # Keep a count of the installed objects and fixtures\n         self.fixture_count = 0\n         self.loaded_object_count = 0\n         self.fixture_object_count = 0\n         self.models = set()\n \n-        # Get a cursor (even though we don't need one yet). This has\n-        # the side effect of initializing the test database (if\n-        # it isn't already initialized).\n-        cursor = connection.cursor()\n-\n-        # Start transaction management. All fixtures are installed in a\n-        # single transaction to ensure that all references are resolved.\n-        if commit:\n-            transaction.enter_transaction_management(using=self.using)\n-\n         class SingleZipReader(zipfile.ZipFile):\n             def __init__(self, *args, **kwargs):\n                 zipfile.ZipFile.__init__(self, *args, **kwargs)\n@@ -103,26 +96,17 @@ def read(self):\n \n         app_fixtures = [os.path.join(os.path.dirname(path), 'fixtures') for path in app_module_paths]\n \n-        try:\n-            with connection.constraint_checks_disabled():\n-                for fixture_label in fixture_labels:\n-                    self.load_label(fixture_label, app_fixtures)\n-\n-            # Since we disabled constraint checks, we must manually check for\n-            # any invalid keys that might have been added\n-            table_names = [model._meta.db_table for model in self.models]\n-            try:\n-                connection.check_constraints(table_names=table_names)\n-            except Exception as e:\n-                e.args = (\"Problem installing fixtures: %s\" % e,)\n-                raise\n+        with connection.constraint_checks_disabled():\n+            for fixture_label in fixture_labels:\n+                self.load_label(fixture_label, app_fixtures)\n \n-        except (SystemExit, KeyboardInterrupt):\n-            raise\n+        # Since we disabled constraint checks, we must manually check for\n+        # any invalid keys that might have been added\n+        table_names = [model._meta.db_table for model in self.models]\n+        try:\n+            connection.check_constraints(table_names=table_names)\n         except Exception as e:\n-            if commit:\n-                transaction.rollback(using=self.using)\n-                transaction.leave_transaction_management(using=self.using)\n+            e.args = (\"Problem installing fixtures: %s\" % e,)\n             raise\n \n         # If we found even one object in a fixture, we need to reset the\n@@ -135,10 +119,6 @@ def read(self):\n                 for line in sequence_sql:\n                     cursor.execute(line)\n \n-        if commit:\n-            transaction.commit(using=self.using)\n-            transaction.leave_transaction_management(using=self.using)\n-\n         if self.verbosity >= 1:\n             if self.fixture_object_count == self.loaded_object_count:\n                 self.stdout.write(\"Installed %d object(s) from %d fixture(s)\" % (\n@@ -147,13 +127,6 @@ def read(self):\n                 self.stdout.write(\"Installed %d object(s) (of %d) from %d fixture(s)\" % (\n                     self.loaded_object_count, self.fixture_object_count, self.fixture_count))\n \n-        # Close the DB connection. This is required as a workaround for an\n-        # edge case in MySQL: if the same connection is used to\n-        # create tables, load data, and query, the query can return\n-        # incorrect results. See Django #7572, MySQL #37735.\n-        if commit:\n-            connection.close()\n-\n     def load_label(self, fixture_label, app_fixtures):\n \n         parts = fixture_label.split('.')"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 21,
        "deletions": 48
    }
}