{
    "author": "jbronn",
    "message": "Fixed #16231 -- Added support for GML and KML on the SpatiaLite backend.  Thanks, steko for the bug report and jpaulett for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16800 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "28cb5bf1622cd8fa6f324cc516974e3badc31a51",
    "files": [
        {
            "sha": "6faa171e3150abb34ac3be0ab94b803ba3343671",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/28cb5bf1622cd8fa6f324cc516974e3badc31a51/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/28cb5bf1622cd8fa6f324cc516974e3badc31a51/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=28cb5bf1622cd8fa6f324cc516974e3badc31a51",
            "patch": "@@ -393,6 +393,7 @@ answer newbie questions, and generally made Django that much better:\n     Jay Parlar <parlar@gmail.com>\n     Claude Paroz <claude@2xlibre.net>\n     Carlos Eduardo de Paula <carlosedp@gmail.com>\n+    John Paulett <john@paulett.org>\n     pavithran s <pavithran.s@gmail.com>\n     Barry Pederson <bp@barryp.org>\n     Andreas Pelme <andreas@pelme.se>"
        },
        {
            "sha": "a0efb99527c7f869e41d41f069c87e6431375012",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/28cb5bf1622cd8fa6f324cc516974e3badc31a51/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/28cb5bf1622cd8fa6f324cc516974e3badc31a51/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=28cb5bf1622cd8fa6f324cc516974e3badc31a51",
            "patch": "@@ -133,6 +133,18 @@ def __init__(self, connection):\n         gis_terms += self.geometry_functions.keys()\n         self.gis_terms = dict([(term, None) for term in gis_terms])\n \n+        if version >= (2, 4, 0):\n+            # Spatialite 2.4.0-RC4 added AsGML and AsKML, however both\n+            # RC2 (shipped in popular Debian/Ubuntu packages) and RC4\n+            # report version as '2.4.0', so we fall back to feature detection\n+            try:\n+                self._get_spatialite_func(\"AsGML(GeomFromText('POINT(1 1)'))\")\n+                self.gml = 'AsGML'\n+                self.kml = 'AsKML'\n+            except DatabaseError:\n+                # we are using < 2.4.0-RC4\n+                pass\n+\n     def check_aggregate_support(self, aggregate):\n         \"\"\"\n         Checks if the given aggregate name is supported (that is, if it's"
        },
        {
            "sha": "25023d7bf5c52ae7fb4a3f0b1edd999f55d50a73",
            "filename": "django/contrib/gis/tests/geoapp/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/28cb5bf1622cd8fa6f324cc516974e3badc31a51/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/28cb5bf1622cd8fa6f324cc516974e3badc31a51/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py?ref=28cb5bf1622cd8fa6f324cc516974e3badc31a51",
            "patch": "@@ -1,5 +1,6 @@\n import re\n from django.db import connection\n+from django.db.utils import DatabaseError\n from django.contrib.gis import gdal\n from django.contrib.gis.geos import (fromstr, GEOSGeometry,\n     Point, LineString, LinearRing, Polygon, GeometryCollection)\n@@ -92,8 +93,8 @@ def test02_proxy(self):\n \n     def test03a_kml(self):\n         \"Testing KML output from the database using GeoQuerySet.kml().\"\n-        # Only PostGIS supports KML serialization\n-        if not postgis:\n+        # Only PostGIS and Spatialite (>=2.4.0-RC4) support KML serialization\n+        if not (postgis or (spatialite and connection.ops.kml)):\n             self.assertRaises(NotImplementedError, State.objects.all().kml, field_name='poly')\n             return\n \n@@ -117,7 +118,7 @@ def test03a_kml(self):\n \n     def test03b_gml(self):\n         \"Testing GML output from the database using GeoQuerySet.gml().\"\n-        if mysql or spatialite:\n+        if mysql or (spatialite and not connection.ops.gml) :\n             self.assertRaises(NotImplementedError, Country.objects.all().gml, field_name='mpoly')\n             return\n \n@@ -131,12 +132,15 @@ def test03b_gml(self):\n         if oracle:\n             # No precision parameter for Oracle :-/\n             gml_regex = re.compile(r'^<gml:Point srsName=\"SDO:4326\" xmlns:gml=\"http://www.opengis.net/gml\"><gml:coordinates decimal=\"\\.\" cs=\",\" ts=\" \">-104.60925\\d+,38.25500\\d+ </gml:coordinates></gml:Point>')\n-            for ptown in [ptown1, ptown2]:\n-                self.assertTrue(gml_regex.match(ptown.gml))\n+        elif spatialite:\n+            # Spatialite has extra colon in SrsName\n+            gml_regex = re.compile(r'^<gml:Point SrsName=\"EPSG::4326\"><gml:coordinates decimal=\"\\.\" cs=\",\" ts=\" \">-104.609251\\d+,38.255001</gml:coordinates></gml:Point>')\n         else:\n             gml_regex = re.compile(r'^<gml:Point srsName=\"EPSG:4326\"><gml:coordinates>-104\\.60925\\d+,38\\.255001</gml:coordinates></gml:Point>')\n-            for ptown in [ptown1, ptown2]:\n-                self.assertTrue(gml_regex.match(ptown.gml))\n+\n+        for ptown in [ptown1, ptown2]:\n+            self.assertTrue(gml_regex.match(ptown.gml))\n+\n \n     def test03c_geojson(self):\n         \"Testing GeoJSON output from the database using GeoQuerySet.geojson().\""
        },
        {
            "sha": "a75a04ee4fbfd9db1774bf474a99941ed516cdc4",
            "filename": "docs/ref/contrib/gis/db-api.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/28cb5bf1622cd8fa6f324cc516974e3badc31a51/docs%2Fref%2Fcontrib%2Fgis%2Fdb-api.txt",
            "raw_url": "https://github.com/django/django/raw/28cb5bf1622cd8fa6f324cc516974e3badc31a51/docs%2Fref%2Fcontrib%2Fgis%2Fdb-api.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Fdb-api.txt?ref=28cb5bf1622cd8fa6f324cc516974e3badc31a51",
            "patch": "@@ -287,9 +287,9 @@ Method                                PostGIS  Oracle  SpatiaLite\n :meth:`GeoQuerySet.force_rhr`         X\n :meth:`GeoQuerySet.geohash`           X\n :meth:`GeoQuerySet.geojson`           X\n-:meth:`GeoQuerySet.gml`               X        X\n+:meth:`GeoQuerySet.gml`               X        X       X\n :meth:`GeoQuerySet.intersection`      X        X       X\n-:meth:`GeoQuerySet.kml`               X\n+:meth:`GeoQuerySet.kml`               X                X\n :meth:`GeoQuerySet.length`            X        X       X\n :meth:`GeoQuerySet.make_line`         X\n :meth:`GeoQuerySet.mem_size`          X"
        },
        {
            "sha": "a58f472005a4aa0c87081b6914d2786c01302356",
            "filename": "docs/ref/contrib/gis/geoquerysets.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/28cb5bf1622cd8fa6f324cc516974e3badc31a51/docs%2Fref%2Fcontrib%2Fgis%2Fgeoquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/28cb5bf1622cd8fa6f324cc516974e3badc31a51/docs%2Fref%2Fcontrib%2Fgis%2Fgeoquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Fgeoquerysets.txt?ref=28cb5bf1622cd8fa6f324cc516974e3badc31a51",
            "patch": "@@ -982,7 +982,7 @@ __ http://geojson.org/\n \n .. method:: GeoQuerySet.gml(**kwargs)\n \n-*Availability*: PostGIS, Oracle\n+*Availability*: PostGIS, Oracle, SpatiaLite\n \n Attaches a ``gml`` attribute to every model in the queryset that contains the\n `Geographic Markup Language (GML)`__ representation of the geometry.\n@@ -1013,7 +1013,7 @@ __ http://en.wikipedia.org/wiki/Geography_Markup_Language\n \n .. method:: GeoQuerySet.kml(**kwargs)\n \n-*Availability*: PostGIS\n+*Availability*: PostGIS, SpatiaLite\n \n Attaches a ``kml`` attribute to every model in the queryset that contains the\n `Keyhole Markup Language (KML)`__ representation of the geometry fields. It"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 28,
        "deletions": 11
    }
}