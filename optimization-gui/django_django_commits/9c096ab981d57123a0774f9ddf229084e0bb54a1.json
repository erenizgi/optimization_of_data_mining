{
    "author": "claudep",
    "message": "Fixed #17328 -- Added OpenLayersWidget _has_changed method\n\nThanks Will Hardy for the report and the patch.",
    "sha": "9c096ab981d57123a0774f9ddf229084e0bb54a1",
    "files": [
        {
            "sha": "5e1314bdd84d7049315efc717c232baef707be89",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/9c096ab981d57123a0774f9ddf229084e0bb54a1/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/9c096ab981d57123a0774f9ddf229084e0bb54a1/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=9c096ab981d57123a0774f9ddf229084e0bb54a1",
            "patch": "@@ -230,6 +230,7 @@ answer newbie questions, and generally made Django that much better:\n     Scot Hacker <shacker@birdhouse.org>\n     dAniel hAhler\n     hambaloney\n+    Will Hardy <django@willhardy.com.au>\n     Brian Harring <ferringb@gmail.com>\n     Brant Harris\n     Ronny Haryanto <http://ronny.haryan.to/>"
        },
        {
            "sha": "c7b48e4263a89749830749121f6d072d3d73f959",
            "filename": "django/contrib/gis/admin/widgets.py",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/9c096ab981d57123a0774f9ddf229084e0bb54a1/django%2Fcontrib%2Fgis%2Fadmin%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/9c096ab981d57123a0774f9ddf229084e0bb54a1/django%2Fcontrib%2Fgis%2Fadmin%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fadmin%2Fwidgets.py?ref=9c096ab981d57123a0774f9ddf229084e0bb54a1",
            "patch": "@@ -4,7 +4,7 @@\n from django.utils import translation\n \n from django.contrib.gis.gdal import OGRException\n-from django.contrib.gis.geos import GEOSGeometry, GEOSException\n+from django.contrib.gis.geos import GEOSGeometry, GEOSException, fromstr\n \n # Creating a template context that contains Django settings\n # values needed by admin map templates.\n@@ -104,3 +104,25 @@ def ol_projection(srid):\n                     raise TypeError\n                 map_options[js_name] = value\n         return map_options\n+\n+    def _has_changed(self, initial, data):\n+        \"\"\" Compare geographic value of data with its initial value. \"\"\"\n+\n+        # Ensure we are dealing with a geographic object\n+        if isinstance(initial, basestring):\n+            try:\n+                initial = GEOSGeometry(initial)\n+            except (GEOSException, ValueError):\n+                initial = None\n+\n+        # Only do a geographic comparison if both values are available\n+        if initial and data:\n+            data = fromstr(data)\n+            data.transform(initial.srid)\n+            # If the initial value was not added by the browser, the geometry\n+            # provided may be slightly different, the first time it is saved.\n+            # The comparison is done with a very low tolerance.\n+            return not initial.equals_exact(data, tolerance=0.000001)\n+        else:\n+            # Check for change of state of existence\n+            return bool(initial) != bool(data)"
        },
        {
            "sha": "6fadebdb9a89bac3470bd3bbbac28c29ae8caad7",
            "filename": "django/contrib/gis/tests/geoadmin/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/9c096ab981d57123a0774f9ddf229084e0bb54a1/django%2Fcontrib%2Fgis%2Ftests%2Fgeoadmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9c096ab981d57123a0774f9ddf229084e0bb54a1/django%2Fcontrib%2Fgis%2Ftests%2Fgeoadmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoadmin%2Ftests.py?ref=9c096ab981d57123a0774f9ddf229084e0bb54a1",
            "patch": "@@ -2,15 +2,15 @@\n \n from django.test import TestCase\n from django.contrib.gis import admin\n-from django.contrib.gis.geos import Point\n+from django.contrib.gis.geos import GEOSGeometry, Point\n \n from .models import City\n \n \n class GeoAdminTest(TestCase):\n     urls = 'django.contrib.gis.tests.geoadmin.urls'\n \n-    def test01_ensure_geographic_media(self):\n+    def test_ensure_geographic_media(self):\n         geoadmin = admin.site._registry[City]\n         admin_js = geoadmin.media.render_js()\n         self.assertTrue(any([geoadmin.openlayers_url in js for js in admin_js]))\n@@ -33,3 +33,21 @@ def test_olmap_WMS_rendering(self):\n         self.assertIn(\n             \"\"\"geodjango_point.layers.base = new OpenLayers.Layer.WMS(\"OpenLayers WMS\", \"http://vmap0.tiles.osgeo.org/wms/vmap0\", {layers: \\'basic\\', format: 'image/jpeg'});\"\"\",\n             result)\n+\n+    def test_olwidget_has_changed(self):\n+        \"\"\" Check that changes are accurately noticed by OpenLayersWidget. \"\"\"\n+        geoadmin = admin.site._registry[City]\n+        form = geoadmin.get_changelist_form(None)()\n+        has_changed = form.fields['point'].widget._has_changed\n+\n+        initial = Point(13.4197458572965953, 52.5194108501149799, srid=4326)\n+        data_same = \"SRID=3857;POINT(1493879.2754093995 6894592.019687599)\"\n+        data_almost_same = \"SRID=3857;POINT(1493879.2754093990 6894592.019687590)\"\n+        data_changed = \"SRID=3857;POINT(1493884.0527237 6894593.8111804)\"\n+\n+        self.assertTrue(has_changed(None, data_changed))\n+        self.assertTrue(has_changed(initial, \"\"))\n+        self.assertFalse(has_changed(None, \"\"))\n+        self.assertFalse(has_changed(initial, data_same))\n+        self.assertFalse(has_changed(initial, data_almost_same))\n+        self.assertTrue(has_changed(initial, data_changed))"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 44,
        "deletions": 3
    }
}