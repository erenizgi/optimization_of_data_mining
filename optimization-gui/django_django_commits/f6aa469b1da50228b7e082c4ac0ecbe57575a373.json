{
    "author": "ramiro",
    "message": "Fixed #13007 -- Made cookie parsing resilent to the presence of cookies with invalid characters in their names. Thanks Warlax for the report, Ubercore for his work on a fix and Jannis and Luke for review and guidance.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15523 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f6aa469b1da50228b7e082c4ac0ecbe57575a373",
    "files": [
        {
            "sha": "74a5afa84ab172cddef27dab502c3aa244e03930",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 27,
            "deletions": 2,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/f6aa469b1da50228b7e082c4ac0ecbe57575a373/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f6aa469b1da50228b7e082c4ac0ecbe57575a373/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=f6aa469b1da50228b7e082c4ac0ecbe57575a373",
            "patch": "@@ -27,8 +27,12 @@\n _morsel_supports_httponly = Cookie.Morsel._reserved.has_key('httponly')\n # Some versions of Python 2.7 and later won't need this encoding bug fix:\n _cookie_encodes_correctly = Cookie.SimpleCookie().value_encode(';') == (';', '\"\\\\073\"')\n+# See ticket #13007, http://bugs.python.org/issue2193 and http://trac.edgewall.org/ticket/2256\n+_tc = Cookie.SimpleCookie()\n+_tc.load('f:oo')\n+_cookie_allows_colon_in_names = 'Set-Cookie: f:oo=' in _tc.output()\n \n-if _morsel_supports_httponly and _cookie_encodes_correctly:\n+if _morsel_supports_httponly and _cookie_encodes_correctly and _cookie_allows_colon_in_names:\n     SimpleCookie = Cookie.SimpleCookie\n else:\n     if not _morsel_supports_httponly:\n@@ -85,6 +89,27 @@ def value_encode(self, val):\n \n                 return val, encoded\n \n+        if not _cookie_allows_colon_in_names:\n+            def load(self, rawdata, ignore_parse_errors=False):\n+                if ignore_parse_errors:\n+                    self.bad_cookies = []\n+                    self._BaseCookie__set = self._loose_set\n+                super(SimpleCookie, self).load(rawdata)\n+                if ignore_parse_errors:\n+                    self._BaseCookie__set = self._strict_set\n+                    for key in self.bad_cookies:\n+                        del self[key]\n+\n+            _strict_set = Cookie.BaseCookie._BaseCookie__set\n+\n+            def _loose_set(self, key, real_value, coded_value):\n+                try:\n+                    self._strict_set(key, real_value, coded_value)\n+                except Cookie.CookieError:\n+                    self.bad_cookies.append(key)\n+                    dict.__setitem__(self, key, None)\n+\n+\n class CompatCookie(SimpleCookie):\n     def __init__(self, *args, **kwargs):\n         super(CompatCookie, self).__init__(*args, **kwargs)\n@@ -433,7 +458,7 @@ def parse_cookie(cookie):\n     if not isinstance(cookie, Cookie.BaseCookie):\n         try:\n             c = SimpleCookie()\n-            c.load(cookie)\n+            c.load(cookie, ignore_parse_errors=True)\n         except Cookie.CookieError:\n             # Invalid cookie\n             return {}"
        },
        {
            "sha": "7d6641a3d73affb7f7e4ed5c49a15cc310dfe94d",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/f6aa469b1da50228b7e082c4ac0ecbe57575a373/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f6aa469b1da50228b7e082c4ac0ecbe57575a373/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=f6aa469b1da50228b7e082c4ac0ecbe57575a373",
            "patch": "@@ -1,7 +1,8 @@\n import copy\n import pickle\n \n-from django.http import QueryDict, HttpResponse, SimpleCookie, BadHeaderError\n+from django.http import (QueryDict, HttpResponse, SimpleCookie, BadHeaderError,\n+        parse_cookie)\n from django.utils import unittest\n \n class QueryDictTests(unittest.TestCase):\n@@ -274,3 +275,9 @@ def test_decode_2(self):\n         c2 = SimpleCookie()\n         c2.load(c.output())\n         self.assertEqual(c['test'].value, c2['test'].value)\n+\n+    def test_nonstandard_keys(self):\n+        \"\"\"\n+        Test that a single non-standard cookie name doesn't affect all cookies. Ticket #13007.\n+        \"\"\"\n+        self.assertTrue('good_cookie' in parse_cookie('good_cookie=yes;bad:cookie=yes').keys())"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 35,
        "deletions": 3
    }
}