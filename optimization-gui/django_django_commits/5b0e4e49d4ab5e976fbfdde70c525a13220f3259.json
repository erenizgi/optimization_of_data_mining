{
    "author": "jacobian",
    "message": "Fixed #14091 - be more correct about logging queries in connection.queries.\n\nThanks to Aymeric Augustin for figuring out how to make this work across\nmultiple databases.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16081 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
    "files": [
        {
            "sha": "ddd3cf8566ad1e959f6b58cfcc0e5d88ef666c95",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -60,6 +60,7 @@ answer newbie questions, and generally made Django that much better:\n     atlithorn <atlithorn@gmail.com>\n     Jökull Sólberg Auðunsson <jokullsolberg@gmail.com>\n     Arthur <avandorp@gmail.com>\n+    Aymeric Augustin <aymeric.augustin@m4x.org>\n     av0000@mail.ru\n     David Avsajanishvili <avsd05@gmail.com>\n     Mike Axiak <axiak@mit.edu>"
        },
        {
            "sha": "6d02aa771c99008e2e935b17a168bc4c7b78ce8a",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -191,6 +191,12 @@ def force_no_ordering(self):\n     def fulltext_search_sql(self, field_name):\n         return 'MATCH (%s) AGAINST (%%s IN BOOLEAN MODE)' % field_name\n \n+    def last_executed_query(self, cursor, sql, params):\n+        # With MySQLdb, cursor objects have an (undocumented) \"_last_executed\"\n+        # attribute where the exact query sent to the database is saved.\n+        # See MySQLdb/cursors.py in the source distribution.\n+        return cursor._last_executed\n+\n     def no_limit_value(self):\n         # 2**64 - 1, as recommended by the MySQL documentation\n         return 18446744073709551615L"
        },
        {
            "sha": "c024e6d7d047b14272cdfc6a76af976356b219f9",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -210,6 +210,11 @@ def field_cast_sql(self, db_type):\n         else:\n             return \"%s\"\n \n+    def last_executed_query(self, cursor, sql, params):\n+        # http://cx-oracle.sourceforge.net/html/cursor.html#Cursor.statement\n+        # The DB API definition does not define this attribute.\n+        return cursor.statement\n+\n     def last_insert_id(self, cursor, table_name, pk_name):\n         sq_name = self._get_sequence_name(table_name)\n         cursor.execute('SELECT \"%s\".currval FROM dual' % sq_name)"
        },
        {
            "sha": "33159133d65764cca5b90d7b7f8204d5c8cb353b",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -202,9 +202,8 @@ def max_name_length(self):\n         return 63\n \n     def last_executed_query(self, cursor, sql, params):\n-        # With psycopg2, cursor objects have a \"query\" attribute that is the\n-        # exact query sent to the database. See docs here:\n-        # http://www.initd.org/tracker/psycopg/wiki/psycopg2_documentation#postgresql-status-message-and-executed-query\n+        # http://initd.org/psycopg/docs/cursor.html#cursor.query\n+        # The query attribute is a Psycopg extension to the DB API 2.0.\n         return cursor.query\n \n     def return_insert_id(self):"
        },
        {
            "sha": "5911d9f4878e461403a43c3b622738fb3f6b82a3",
            "filename": "docs/faq/models.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/docs%2Ffaq%2Fmodels.txt",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/docs%2Ffaq%2Fmodels.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ffaq%2Fmodels.txt?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -22,9 +22,8 @@ of dictionaries in order of query execution. Each dictionary has the following::\n \n ``connection.queries`` includes all SQL statements -- INSERTs, UPDATES,\n SELECTs, etc. Each time your app hits the database, the query will be recorded.\n-Note that the raw SQL logged in ``connection.queries`` may not include\n-parameter quoting.  Parameter quoting is performed by the database-specific\n-backend, and not all backends provide a way to retrieve the SQL after quoting.\n+Note that the SQL recorded here may be :ref:`incorrectly quoted under SQLite\n+<sqlite-connection-queries>`.\n \n .. versionadded:: 1.2\n "
        },
        {
            "sha": "82c780cb0f91a0178a828f3a0886aef902b3928e",
            "filename": "docs/ref/databases.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/docs%2Fref%2Fdatabases.txt",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/docs%2Fref%2Fdatabases.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdatabases.txt?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -465,7 +465,7 @@ itself to versions newer than the ones included with your particular Python\n binary distribution, if needed.\n \n \"Database is locked\" errors\n------------------------------------------------\n+---------------------------\n \n SQLite is meant to be a lightweight database, and thus can't support a high\n level of concurrency. ``OperationalError: database is locked`` errors indicate\n@@ -506,6 +506,16 @@ If you're getting this error, you can solve it by:\n SQLite does not support the ``SELECT ... FOR UPDATE`` syntax. Calling it will\n have no effect.\n \n+.. _sqlite-connection-queries:\n+\n+Parameters not quoted in ``connection.queries``\n+-----------------------------------------------\n+\n+``sqlite3`` does not provide a way to retrieve the SQL after quoting and\n+substituting the parameters. Instead, the SQL in ``connection.queries`` is\n+rebuilt with a simple string interpolation. It may be incorrect. Make sure\n+you add quotes where necessary before copying a query into a SQLite shell.\n+\n .. _oracle-notes:\n \n Oracle notes"
        },
        {
            "sha": "3191ef0c85c4651cd7288e27b9fc72b93502c170",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5b0e4e49d4ab5e976fbfdde70c525a13220f3259/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=5b0e4e49d4ab5e976fbfdde70c525a13220f3259",
            "patch": "@@ -2,6 +2,7 @@\n # Unit and doctests for specific database backends.\n import datetime\n \n+from django.conf import settings\n from django.core.management.color import no_style\n from django.db import backend, connection, connections, DEFAULT_DB_ALIAS, IntegrityError\n from django.db.backends.signals import connection_created\n@@ -85,6 +86,35 @@ def test_django_extract(self):\n         classes = models.SchoolClass.objects.filter(last_updated__day=20)\n         self.assertEqual(len(classes), 1)\n \n+class LastExecutedQueryTest(TestCase):\n+\n+    def setUp(self):\n+        # connection.queries will not be filled in without this\n+        settings.DEBUG = True\n+\n+    def tearDown(self):\n+        settings.DEBUG = False\n+\n+    # There are no tests for the sqlite backend because it does not\n+    # implement paramater escaping. See #14091.\n+\n+    @unittest.skipUnless(connection.vendor in ('oracle', 'postgresql'),\n+                         \"These backends use the standard parameter escaping rules\")\n+    def test_parameter_escaping(self):\n+        # check that both numbers and string are properly quoted\n+        list(models.Tag.objects.filter(name=\"special:\\\\\\\"':\", object_id=12))\n+        sql = connection.queries[-1]['sql']\n+        self.assertTrue(\"= 'special:\\\\\\\"'':' \" in sql)\n+        self.assertTrue(\"= 12 \" in sql)\n+\n+    @unittest.skipUnless(connection.vendor == 'mysql',\n+                         \"MySQL uses backslashes to escape parameters.\")\n+    def test_parameter_escaping(self):\n+        list(models.Tag.objects.filter(name=\"special:\\\\\\\"':\", object_id=12))\n+        sql = connection.queries[-1]['sql']\n+        # only this line is different from the test above\n+        self.assertTrue(\"= 'special:\\\\\\\\\\\\\\\"\\\\':' \" in sql)\n+        self.assertTrue(\"= 12 \" in sql)\n \n class ParameterHandlingTest(TestCase):\n     def test_bad_parameter_count(self):"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 57,
        "deletions": 7
    }
}