{
    "author": "SmileyChris",
    "message": "Fixed #7153 -- _resolve_lookup now does a better job of resolving callables and correctly catches all silent_variable_exceptions\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14992 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "df6ad35c56c270ea04865e43a83b1ff0f35a71f4",
    "files": [
        {
            "sha": "1440869098e579baae156bafd2c1fa486baf53d8",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 29,
            "deletions": 38,
            "changes": 67,
            "blob_url": "https://github.com/django/django/blob/df6ad35c56c270ea04865e43a83b1ff0f35a71f4/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/df6ad35c56c270ea04865e43a83b1ff0f35a71f4/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=df6ad35c56c270ea04865e43a83b1ff0f35a71f4",
            "patch": "@@ -674,46 +674,37 @@ def _resolve_lookup(self, context):\n         instead.\n         \"\"\"\n         current = context\n-        for bit in self.lookups:\n-            try: # dictionary lookup\n-                current = current[bit]\n-            except (TypeError, AttributeError, KeyError):\n-                try: # attribute lookup\n-                    current = getattr(current, bit)\n-                    if callable(current):\n-                        if getattr(current, 'alters_data', False):\n-                            current = settings.TEMPLATE_STRING_IF_INVALID\n-                        else:\n-                            try: # method call (assuming no args required)\n-                                current = current()\n-                            except TypeError: # arguments *were* required\n-                                # GOTCHA: This will also catch any TypeError\n-                                # raised in the function itself.\n-                                current = settings.TEMPLATE_STRING_IF_INVALID # invalid method call\n-                            except Exception, e:\n-                                if getattr(e, 'silent_variable_failure', False):\n-                                    current = settings.TEMPLATE_STRING_IF_INVALID\n-                                else:\n-                                    raise\n-                except (TypeError, AttributeError):\n-                    try: # list-index lookup\n-                        current = current[int(bit)]\n-                    except (IndexError, # list index out of range\n-                            ValueError, # invalid literal for int()\n-                            KeyError,   # current is a dict without `int(bit)` key\n-                            TypeError,  # unsubscriptable object\n-                            ):\n-                        raise VariableDoesNotExist(\"Failed lookup for key [%s] in %r\", (bit, current)) # missing attribute\n-                except Exception, e:\n-                    if getattr(e, 'silent_variable_failure', False):\n+        try: # catch-all for silent variable failures\n+            for bit in self.lookups:\n+                try: # dictionary lookup\n+                    current = current[bit]\n+                except (TypeError, AttributeError, KeyError):\n+                    try: # attribute lookup\n+                        current = getattr(current, bit)\n+                    except (TypeError, AttributeError):\n+                        try: # list-index lookup\n+                            current = current[int(bit)]\n+                        except (IndexError, # list index out of range\n+                                ValueError, # invalid literal for int()\n+                                KeyError,   # current is a dict without `int(bit)` key\n+                                TypeError,  # unsubscriptable object\n+                                ):\n+                            raise VariableDoesNotExist(\"Failed lookup for key [%s] in %r\", (bit, current)) # missing attribute\n+                if callable(current):\n+                    if getattr(current, 'alters_data', False):\n                         current = settings.TEMPLATE_STRING_IF_INVALID\n                     else:\n-                        raise\n-            except Exception, e:\n-                if getattr(e, 'silent_variable_failure', False):\n-                    current = settings.TEMPLATE_STRING_IF_INVALID\n-                else:\n-                    raise\n+                        try: # method call (assuming no args required)\n+                            current = current()\n+                        except TypeError: # arguments *were* required\n+                            # GOTCHA: This will also catch any TypeError\n+                            # raised in the function itself.\n+                            current = settings.TEMPLATE_STRING_IF_INVALID # invalid method call\n+        except Exception, e:\n+            if getattr(e, 'silent_variable_failure', False):\n+                current = settings.TEMPLATE_STRING_IF_INVALID\n+            else:\n+                raise\n \n         return current\n "
        },
        {
            "sha": "2bd6a878ca3ccaffd26b466100d6c58c3eeecbe8",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/df6ad35c56c270ea04865e43a83b1ff0f35a71f4/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/df6ad35c56c270ea04865e43a83b1ff0f35a71f4/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=df6ad35c56c270ea04865e43a83b1ff0f35a71f4",
            "patch": "@@ -91,6 +91,21 @@ def method3(self):\n     def method4(self):\n         raise SomeOtherException\n \n+    def __getitem__(self, key):\n+        if key == 'silent_fail_key':\n+            raise SomeException\n+        elif key == 'noisy_fail_key':\n+            raise SomeOtherException\n+        raise KeyError\n+\n+    def silent_fail_attribute(self):\n+        raise SomeException\n+    silent_fail_attribute = property(silent_fail_attribute)\n+\n+    def noisy_fail_attribute(self):\n+        raise SomeOtherException\n+    noisy_fail_attribute = property(noisy_fail_attribute)\n+\n class OtherClass:\n     def method(self):\n         return \"OtherClass.method\"\n@@ -529,6 +544,12 @@ def get_template_tests(self):\n             'basic-syntax35': (\"{{ 1 }}\", {\"1\": \"abc\"}, \"1\"),\n             'basic-syntax36': (\"{{ 1.2 }}\", {\"1\": \"abc\"}, \"1.2\"),\n \n+            # Call methods in the top level of the context\n+            'basic-syntax37': ('{{ callable }}', {\"callable\": lambda: \"foo bar\"}, \"foo bar\"),\n+\n+            # Call methods returned from dictionary lookups\n+            'basic-syntax38': ('{{ var.callable }}', {\"var\": {\"callable\": lambda: \"foo bar\"}}, \"foo bar\"),\n+\n             # List-index syntax allows a template to access a certain item of a subscriptable object.\n             'list-index01': (\"{{ var.1 }}\", {\"var\": [\"first item\", \"second item\"]}, \"second item\"),\n \n@@ -616,6 +637,17 @@ def get_template_tests(self):\n             #filters should accept empty string constants\n             'filter-syntax20': ('{{ \"\"|default_if_none:\"was none\" }}', {}, \"\"),\n \n+            # Fail silently for non-callable attribute and dict lookups which\n+            # raise an exception with a \"silent_variable_failure\" attribute\n+            'filter-syntax21': (r'1{{ var.silent_fail_key }}2', {\"var\": SomeClass()}, (\"12\", \"1INVALID2\")),\n+            'filter-syntax22': (r'1{{ var.silent_fail_attribute }}2', {\"var\": SomeClass()}, (\"12\", \"1INVALID2\")),\n+\n+            # In attribute and dict lookups that raise an unexpected exception\n+            # without a \"silent_variable_attribute\" set to True, the exception\n+            # propagates\n+            'filter-syntax23': (r'1{{ var.noisy_fail_key }}2', {\"var\": SomeClass()}, SomeOtherException),\n+            'filter-syntax24': (r'1{{ var.noisy_fail_attribute }}2', {\"var\": SomeClass()}, SomeOtherException),\n+\n             ### COMMENT SYNTAX ########################################################\n             'comment-syntax01': (\"{# this is hidden #}hello\", {}, \"hello\"),\n             'comment-syntax02': (\"{# this is hidden #}hello{# foo #}\", {}, \"hello\"),"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 61,
        "deletions": 38
    }
}