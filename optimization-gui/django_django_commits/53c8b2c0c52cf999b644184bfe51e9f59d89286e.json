{
    "author": "claudep",
    "message": "Fixed #17959 -- Silenced output during GIS tests",
    "sha": "53c8b2c0c52cf999b644184bfe51e9f59d89286e",
    "files": [
        {
            "sha": "7c6b128e0fe198357f8481458f0de378b6482fec",
            "filename": "django/contrib/gis/gdal/libgdal.py",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgdal%2Flibgdal.py",
            "raw_url": "https://github.com/django/django/raw/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgdal%2Flibgdal.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Flibgdal.py?ref=53c8b2c0c52cf999b644184bfe51e9f59d89286e",
            "patch": "@@ -1,11 +1,16 @@\n from __future__ import unicode_literals\n \n+import logging\n import os\n import re\n-from ctypes import c_char_p, CDLL\n+from ctypes import c_char_p, c_int, CDLL, CFUNCTYPE\n from ctypes.util import find_library\n+\n from django.contrib.gis.gdal.error import OGRException\n \n+\n+logger = logging.getLogger('django.contrib.gis')\n+\n # Custom library path set?\n try:\n     from django.conf import settings\n@@ -86,3 +91,18 @@ def gdal_version_info():\n GDAL_SUBMINOR_VERSION = _verinfo['subminor'] and int(_verinfo['subminor'])\n GDAL_VERSION = (GDAL_MAJOR_VERSION, GDAL_MINOR_VERSION, GDAL_SUBMINOR_VERSION)\n del _verinfo\n+\n+# Set library error handling so as errors are logged\n+CPLErrorHandler = CFUNCTYPE(None, c_int, c_int, c_char_p)\n+def err_handler(error_class, error_number, message):\n+    logger.error('GDAL_ERROR %d: %s' % (error_number, message))\n+err_handler = CPLErrorHandler(err_handler)\n+\n+def function(name, args, restype):\n+    func = std_call(name)\n+    func.argtypes = args\n+    func.restype = restype\n+    return func\n+\n+set_error_handler = function('CPLSetErrorHandler', [CPLErrorHandler], CPLErrorHandler)\n+set_error_handler(err_handler)"
        },
        {
            "sha": "69e3054422e52e7f3a1052d0c1aca9236a46ed3d",
            "filename": "django/contrib/gis/gdal/tests/test_ds.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "raw_url": "https://github.com/django/django/raw/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py?ref=53c8b2c0c52cf999b644184bfe51e9f59d89286e",
            "patch": "@@ -4,6 +4,7 @@\n from django.contrib.gis.gdal.field import OFTReal, OFTInteger, OFTString\n from django.contrib.gis.geometry.test_data import get_ds_file, TestDS, TEST_DATA\n \n+\n # List of acceptable data sources.\n ds_list = (TestDS('test_point', nfeat=5, nfld=3, geom='POINT', gtype=1, driver='ESRI Shapefile',\n                   fields={'dbl' : OFTReal, 'int' : OFTInteger, 'str' : OFTString,},\n@@ -59,7 +60,6 @@ def test02_invalid_shp(self):\n \n     def test03a_layers(self):\n         \"Testing Data Source Layers.\"\n-        print(\"\\nBEGIN - expecting out of range feature id error; safe to ignore.\\n\")\n         for source in ds_list:\n             ds = DataSource(source.ds)\n \n@@ -108,7 +108,6 @@ def test03a_layers(self):\n                         # the feature values here while in this loop.\n                         for fld_name in fld_names:\n                             self.assertEqual(source.field_values[fld_name][i], feat.get(fld_name))\n-        print(\"\\nEND - expecting out of range feature id error; safe to ignore.\")\n \n     def test03b_layer_slice(self):\n         \"Test indexing and slicing on Layers.\""
        },
        {
            "sha": "9b8ae6a26ba439b649fd7548c7cba07aa90458b0",
            "filename": "django/contrib/gis/gdal/tests/test_geom.py",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py",
            "raw_url": "https://github.com/django/django/raw/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_geom.py?ref=53c8b2c0c52cf999b644184bfe51e9f59d89286e",
            "patch": "@@ -235,15 +235,8 @@ def test07b_closepolygons(self):\n         # Both rings in this geometry are not closed.\n         poly = OGRGeometry('POLYGON((0 0, 5 0, 5 5, 0 5), (1 1, 2 1, 2 2, 2 1))')\n         self.assertEqual(8, poly.point_count)\n-        print(\"\\nBEGIN - expecting IllegalArgumentException; safe to ignore.\\n\")\n-        try:\n-            c = poly.centroid\n-        except OGRException:\n-            # Should raise an OGR exception, rings are not closed\n-            pass\n-        else:\n-            self.fail('Should have raised an OGRException!')\n-        print(\"\\nEND - expecting IllegalArgumentException; safe to ignore.\\n\")\n+        with self.assertRaises(OGRException):\n+            _ = poly.centroid\n \n         poly.close_rings()\n         self.assertEqual(10, poly.point_count) # Two closing points should've been added"
        },
        {
            "sha": "d19644ac490fa7bd908e956c5a5cda28402d564a",
            "filename": "django/contrib/gis/geos/libgeos.py",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgeos%2Flibgeos.py",
            "raw_url": "https://github.com/django/django/raw/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgeos%2Flibgeos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Flibgeos.py?ref=53c8b2c0c52cf999b644184bfe51e9f59d89286e",
            "patch": "@@ -6,13 +6,17 @@\n  This module also houses GEOS Pointer utilities, including\n  get_pointer_arr(), and GEOM_PTR.\n \"\"\"\n+import logging\n import os\n import re\n-import sys\n from ctypes import c_char_p, Structure, CDLL, CFUNCTYPE, POINTER\n from ctypes.util import find_library\n+\n from django.contrib.gis.geos.error import GEOSException\n \n+\n+logger = logging.getLogger('django.contrib.gis')\n+\n # Custom library path set?\n try:\n     from django.conf import settings\n@@ -56,23 +60,23 @@\n # Supposed to mimic the GEOS message handler (C below):\n #  typedef void (*GEOSMessageHandler)(const char *fmt, ...);\n NOTICEFUNC = CFUNCTYPE(None, c_char_p, c_char_p)\n-def notice_h(fmt, lst, output_h=sys.stdout):\n+def notice_h(fmt, lst):\n     fmt, lst = fmt.decode(), lst.decode()\n     try:\n         warn_msg = fmt % lst\n     except:\n         warn_msg = fmt\n-    output_h.write('GEOS_NOTICE: %s\\n' % warn_msg)\n+    logger.warn('GEOS_NOTICE: %s\\n' % warn_msg)\n notice_h = NOTICEFUNC(notice_h)\n \n ERRORFUNC = CFUNCTYPE(None, c_char_p, c_char_p)\n-def error_h(fmt, lst, output_h=sys.stderr):\n+def error_h(fmt, lst):\n     fmt, lst = fmt.decode(), lst.decode()\n     try:\n         err_msg = fmt % lst\n     except:\n         err_msg = fmt\n-    output_h.write('GEOS_ERROR: %s\\n' % err_msg)\n+    logger.error('GEOS_ERROR: %s\\n' % err_msg)\n error_h = ERRORFUNC(error_h)\n \n #### GEOS Geometry C data structures, and utility functions. ####"
        },
        {
            "sha": "283daa47c0e4f755f082215b98fe4c3f719278e6",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 5,
            "deletions": 17,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/53c8b2c0c52cf999b644184bfe51e9f59d89286e/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=53c8b2c0c52cf999b644184bfe51e9f59d89286e",
            "patch": "@@ -147,18 +147,13 @@ def test_kml(self):\n     def test_errors(self):\n         \"Testing the Error handlers.\"\n         # string-based\n-        print(\"\\nBEGIN - expecting GEOS_ERROR; safe to ignore.\\n\")\n         for err in self.geometries.errors:\n-            try:\n-                g = fromstr(err.wkt)\n-            except (GEOSException, ValueError):\n-                pass\n+            with self.assertRaises((GEOSException, ValueError)):\n+                _ = fromstr(err.wkt)\n \n         # Bad WKB\n         self.assertRaises(GEOSException, GEOSGeometry, memoryview(b'0'))\n \n-        print(\"\\nEND - expecting GEOS_ERROR; safe to ignore.\\n\")\n-\n         class NotAGeometry(object):\n             pass\n \n@@ -458,7 +453,6 @@ def test_polygons(self):\n \n     def test_multipolygons(self):\n         \"Testing MultiPolygon objects.\"\n-        print(\"\\nBEGIN - expecting GEOS_NOTICE; safe to ignore.\\n\")\n         prev = fromstr('POINT (0 0)')\n         for mp in self.geometries.multipolygons:\n             mpoly = fromstr(mp.wkt)\n@@ -477,8 +471,6 @@ def test_multipolygons(self):\n                     self.assertEqual(p.valid, True)\n                 self.assertEqual(mpoly.wkt, MultiPolygon(*tuple(poly.clone() for poly in mpoly)).wkt)\n \n-        print(\"\\nEND - expecting GEOS_NOTICE; safe to ignore.\\n\")\n-\n     def test_memory_hijinks(self):\n         \"Testing Geometry __del__() on rings and polygons.\"\n         #### Memory issues with rings and polygons\n@@ -1025,19 +1017,15 @@ def test_valid_reason(self):\n \n         g = GEOSGeometry(\"POINT(0 0)\")\n         self.assertTrue(g.valid)\n-        self.assertTrue(isinstance(g.valid_reason, six.string_types))\n+        self.assertIsInstance(g.valid_reason, six.string_types)\n         self.assertEqual(g.valid_reason, \"Valid Geometry\")\n \n-        print(\"\\nBEGIN - expecting GEOS_NOTICE; safe to ignore.\\n\")\n-\n         g = GEOSGeometry(\"LINESTRING(0 0, 0 0)\")\n \n-        self.assertTrue(not g.valid)\n-        self.assertTrue(isinstance(g.valid_reason, six.string_types))\n+        self.assertFalse(g.valid)\n+        self.assertIsInstance(g.valid_reason, six.string_types)\n         self.assertTrue(g.valid_reason.startswith(\"Too few points in geometry component\"))\n \n-        print(\"\\nEND - expecting GEOS_NOTICE; safe to ignore.\\n\")\n-\n     @unittest.skipUnless(geos_version_info()['version'] >= '3.2.0', \"geos >= 3.2.0 is required\")\n     def test_linearref(self):\n         \"Testing linear referencing\""
        }
    ],
    "stats": {
        "total": 72,
        "additions": 38,
        "deletions": 34
    }
}