{
    "author": "fisadev",
    "message": "Fixed #6585 -- Admin relationship widgets: Respect ordering defined by target model's ModelAdmin.\n\nThanks Gary Wilson for the report and Juan Pedro Fisanotti, Carlos\nMatías de la Torre for the fix.",
    "sha": "d9330d5be2ee60b208dcab2616eb164ea2e6bf36",
    "files": [
        {
            "sha": "a7adc5a9edde2822ff411f2a9119909f32f32a16",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=d9330d5be2ee60b208dcab2616eb164ea2e6bf36",
            "patch": "@@ -165,6 +165,7 @@ answer newbie questions, and generally made Django that much better:\n     Matt Dennenbaum\n     deric@monowerks.com\n     Max Derkachev <mderk@yandex.ru>\n+    Carlos Matías de la Torre <cmdelatorre@gmail.com>\n     Rajesh Dhawan <rajesh.dhawan@gmail.com>\n     Sander Dijkhuis <sander.dijkhuis@gmail.com>\n     Jordan Dimov <s3x3y1@gmail.com>\n@@ -205,6 +206,7 @@ answer newbie questions, and generally made Django that much better:\n     Stefane Fermgier <sf@fermigier.com>\n     J. Pablo Fernandez <pupeno@pupeno.com>\n     Maciej Fijalkowski\n+    Juan Pedro Fisanotti <fisadev@gmail.com>\n     Ben Firshman <ben@firshman.co.uk>\n     Matthew Flanagan <http://wadofstuff.blogspot.com>\n     Eric Floehr <eric@intellovations.com>"
        },
        {
            "sha": "cce92c6a95b998112edb88b6c4dd11ca84f6787b",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=d9330d5be2ee60b208dcab2616eb164ea2e6bf36",
            "patch": "@@ -157,6 +157,19 @@ def formfield_for_choice_field(self, db_field, request=None, **kwargs):\n                 )\n         return db_field.formfield(**kwargs)\n \n+    def get_field_queryset(self, db, db_field, request):\n+        \"\"\"\n+        If the ModelAdmin specifies ordering, the queryset should respect that\n+        ordering.  Otherwise don't specify the queryset, let the field decide\n+        (returns None in that case).\n+        \"\"\"\n+        related_admin = self.admin_site._registry.get(db_field.rel.to, None)\n+        if related_admin is not None:\n+            ordering = related_admin.get_ordering(request)\n+            if ordering is not None and ordering != ():\n+                return db_field.rel.to._default_manager.using(db).order_by(*ordering).complex_filter(db_field.rel.limit_choices_to)\n+        return None\n+\n     def formfield_for_foreignkey(self, db_field, request=None, **kwargs):\n         \"\"\"\n         Get a form Field for a ForeignKey.\n@@ -171,6 +184,10 @@ def formfield_for_foreignkey(self, db_field, request=None, **kwargs):\n             })\n             kwargs['empty_label'] = db_field.blank and _('None') or None\n \n+        queryset = self.get_field_queryset(db, db_field, request)\n+        if queryset is not None:\n+            kwargs['queryset'] = queryset\n+\n         return db_field.formfield(**kwargs)\n \n     def formfield_for_manytomany(self, db_field, request=None, **kwargs):\n@@ -190,6 +207,10 @@ def formfield_for_manytomany(self, db_field, request=None, **kwargs):\n         elif db_field.name in (list(self.filter_vertical) + list(self.filter_horizontal)):\n             kwargs['widget'] = widgets.FilteredSelectMultiple(db_field.verbose_name, (db_field.name in self.filter_vertical))\n \n+        queryset = self.get_field_queryset(db, db_field, request)\n+        if queryset is not None:\n+            kwargs['queryset'] = queryset\n+\n         return db_field.formfield(**kwargs)\n \n     def _declared_fieldsets(self):"
        },
        {
            "sha": "3da52b1b00f94442028ba2c9c4ac0b4e113a8932",
            "filename": "tests/admin_ordering/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/tests%2Fadmin_ordering%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/tests%2Fadmin_ordering%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fadmin_ordering%2Fmodels.py?ref=d9330d5be2ee60b208dcab2616eb164ea2e6bf36",
            "patch": "@@ -15,6 +15,7 @@ class Song(models.Model):\n     band = models.ForeignKey(Band)\n     name = models.CharField(max_length=100)\n     duration = models.IntegerField()\n+    other_interpreters = models.ManyToManyField(Band, related_name='covers')\n \n     class Meta:\n         ordering = ('name',)"
        },
        {
            "sha": "10faa9533f250d4c271dacf933fa896fd21cb538",
            "filename": "tests/admin_ordering/tests.py",
            "status": "modified",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/django/django/blob/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/tests%2Fadmin_ordering%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d9330d5be2ee60b208dcab2616eb164ea2e6bf36/tests%2Fadmin_ordering%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fadmin_ordering%2Ftests.py?ref=d9330d5be2ee60b208dcab2616eb164ea2e6bf36",
            "patch": "@@ -1,6 +1,7 @@\n from __future__ import absolute_import, unicode_literals\n \n from django.test import TestCase, RequestFactory\n+from django.contrib import admin\n from django.contrib.admin.options import ModelAdmin\n from django.contrib.auth.models import User\n \n@@ -104,3 +105,50 @@ def test_specified_ordering(self):\n         inline = SongInlineNewOrdering(self.b, None)\n         names = [s.name for s in inline.queryset(request)]\n         self.assertEqual(['Jaded', 'Pink', 'Dude (Looks Like a Lady)'], names)\n+\n+\n+class TestRelatedFieldsAdminOrdering(TestCase):\n+    def setUp(self):\n+        self.b1 = Band(name='Pink Floyd', bio='', rank=1)\n+        self.b1.save()\n+        self.b2 = Band(name='Foo Fighters', bio='', rank=5)\n+        self.b2.save()\n+\n+        # we need to register a custom ModelAdmin (instead of just using\n+        # ModelAdmin) because the field creator tries to find the ModelAdmin\n+        # for the related model\n+        class SongAdmin(admin.ModelAdmin):\n+            pass\n+        admin.site.register(Song, SongAdmin)\n+\n+    def check_ordering_of_field_choices(self, correct_ordering):\n+        fk_field = admin.site._registry[Song].formfield_for_foreignkey(Song.band.field)\n+        m2m_field = admin.site._registry[Song].formfield_for_manytomany(Song.other_interpreters.field)\n+\n+        self.assertEqual(list(fk_field.queryset), correct_ordering)\n+        self.assertEqual(list(m2m_field.queryset), correct_ordering)\n+\n+    def test_no_admin_fallback_to_model_ordering(self):\n+        # should be ordered by name (as defined by the model)\n+        self.check_ordering_of_field_choices([self.b2, self.b1])\n+\n+    def test_admin_with_no_ordering_fallback_to_model_ordering(self):\n+        class NoOrderingBandAdmin(admin.ModelAdmin):\n+            pass\n+        admin.site.register(Band, NoOrderingBandAdmin)\n+\n+        # should be ordered by name (as defined by the model)\n+        self.check_ordering_of_field_choices([self.b2, self.b1])\n+\n+    def test_admin_ordering_beats_model_ordering(self):\n+        class StaticOrderingBandAdmin(admin.ModelAdmin):\n+            ordering = ('rank', )\n+        admin.site.register(Band, StaticOrderingBandAdmin)\n+\n+        # should be ordered by rank (defined by the ModelAdmin)\n+        self.check_ordering_of_field_choices([self.b1, self.b2])\n+\n+    def tearDown(self):\n+        admin.site.unregister(Song)\n+        if Band in admin.site._registry:\n+            admin.site.unregister(Band)"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 72,
        "deletions": 0
    }
}