{
    "author": "unknown",
    "message": "Fixed #17906 - Autoescaping {% cycle %} and {% firstof %} templatetags.\n\nThis commit adds \"future\" version of these two tags with auto-escaping\nenabled.",
    "sha": "f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
    "files": [
        {
            "sha": "41db90c0ac3ee9f9f5910257c7f67120d30b3153",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 33,
            "deletions": 15,
            "changes": 48,
            "blob_url": "https://github.com/django/django/blob/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
            "patch": "@@ -5,13 +5,15 @@\n import re\n from datetime import datetime\n from itertools import groupby, cycle as itertools_cycle\n+import warnings\n \n from django.conf import settings\n from django.template.base import (Node, NodeList, Template, Context, Library,\n     TemplateSyntaxError, VariableDoesNotExist, InvalidTemplateLibrary,\n     BLOCK_TAG_START, BLOCK_TAG_END, VARIABLE_TAG_START, VARIABLE_TAG_END,\n     SINGLE_BRACE_START, SINGLE_BRACE_END, COMMENT_TAG_START, COMMENT_TAG_END,\n-    VARIABLE_ATTRIBUTE_SEPARATOR, get_library, token_kwargs, kwarg_re)\n+    VARIABLE_ATTRIBUTE_SEPARATOR, get_library, token_kwargs, kwarg_re,\n+    _render_value_in_context)\n from django.template.smartif import IfParser, Literal\n from django.template.defaultfilters import date\n from django.utils.encoding import smart_text\n@@ -54,15 +56,15 @@ def render(self, context):\n             # misconfiguration, so we raise a warning\n             from django.conf import settings\n             if settings.DEBUG:\n-                import warnings\n                 warnings.warn(\"A {% csrf_token %} was used in a template, but the context did not provide the value.  This is usually caused by not using RequestContext.\")\n             return ''\n \n class CycleNode(Node):\n-    def __init__(self, cyclevars, variable_name=None, silent=False):\n+    def __init__(self, cyclevars, variable_name=None, silent=False, escape=False):\n         self.cyclevars = cyclevars\n         self.variable_name = variable_name\n         self.silent = silent\n+        self.escape = escape        # only while the \"future\" version exists\n \n     def render(self, context):\n         if self not in context.render_context:\n@@ -74,7 +76,9 @@ def render(self, context):\n             context[self.variable_name] = value\n         if self.silent:\n             return ''\n-        return value\n+        if not self.escape:\n+            value = mark_safe(value)\n+        return _render_value_in_context(value, context)\n \n class DebugNode(Node):\n     def render(self, context):\n@@ -97,14 +101,17 @@ def render(self, context):\n         return filtered\n \n class FirstOfNode(Node):\n-    def __init__(self, vars):\n-        self.vars = vars\n+    def __init__(self, variables, escape=False):\n+        self.vars = variables\n+        self.escape = escape        # only while the \"future\" version exists\n \n     def render(self, context):\n         for var in self.vars:\n             value = var.resolve(context, True)\n             if value:\n-                return smart_text(value)\n+                if not self.escape:\n+                    value = mark_safe(value)\n+                return _render_value_in_context(value, context)\n         return ''\n \n class ForNode(Node):\n@@ -508,7 +515,7 @@ def comment(parser, token):\n     return CommentNode()\n \n @register.tag\n-def cycle(parser, token):\n+def cycle(parser, token, escape=False):\n     \"\"\"\n     Cycles among the given strings each time this tag is encountered.\n \n@@ -541,6 +548,11 @@ def cycle(parser, token):\n         {% endfor %}\n \n     \"\"\"\n+    if not escape:\n+        warnings.warn(\n+            \"'The syntax for the `cycle` template tag is changing. Load it \"\n+            \"from the `future` tag library to start using the new behavior.\",\n+            PendingDeprecationWarning, stacklevel=2)\n \n     # Note: This returns the exact same node on each {% cycle name %} call;\n     # that is, the node object returned from {% cycle a b c as name %} and the\n@@ -588,13 +600,13 @@ def cycle(parser, token):\n     if as_form:\n         name = args[-1]\n         values = [parser.compile_filter(arg) for arg in args[1:-2]]\n-        node = CycleNode(values, name, silent=silent)\n+        node = CycleNode(values, name, silent=silent, escape=escape)\n         if not hasattr(parser, '_namedCycleNodes'):\n             parser._namedCycleNodes = {}\n         parser._namedCycleNodes[name] = node\n     else:\n         values = [parser.compile_filter(arg) for arg in args[1:]]\n-        node = CycleNode(values)\n+        node = CycleNode(values, escape=escape)\n     return node\n \n @register.tag\n@@ -643,7 +655,7 @@ def do_filter(parser, token):\n     return FilterNode(filter_expr, nodelist)\n \n @register.tag\n-def firstof(parser, token):\n+def firstof(parser, token, escape=False):\n     \"\"\"\n     Outputs the first variable passed that is not False, without escaping.\n \n@@ -657,11 +669,11 @@ def firstof(parser, token):\n \n         {% if var1 %}\n             {{ var1|safe }}\n-        {% else %}{% if var2 %}\n+        {% elif var2 %}\n             {{ var2|safe }}\n-        {% else %}{% if var3 %}\n+        {% elif var3 %}\n             {{ var3|safe }}\n-        {% endif %}{% endif %}{% endif %}\n+        {% endif %}\n \n     but obviously much cleaner!\n \n@@ -677,10 +689,16 @@ def firstof(parser, token):\n         {% endfilter %}\n \n     \"\"\"\n+    if not escape:\n+        warnings.warn(\n+            \"'The syntax for the `firstof` template tag is changing. Load it \"\n+            \"from the `future` tag library to start using the new behavior.\",\n+            PendingDeprecationWarning, stacklevel=2)\n+\n     bits = token.split_contents()[1:]\n     if len(bits) < 1:\n         raise TemplateSyntaxError(\"'firstof' statement requires at least one argument\")\n-    return FirstOfNode([parser.compile_filter(bit) for bit in bits])\n+    return FirstOfNode([parser.compile_filter(bit) for bit in bits], escape=escape)\n \n @register.tag('for')\n def do_for(parser, token):"
        },
        {
            "sha": "a385c6d565382e6643bc02fbfb46d4cda33b815c",
            "filename": "django/templatetags/future.py",
            "status": "modified",
            "additions": 54,
            "deletions": 3,
            "changes": 57,
            "blob_url": "https://github.com/django/django/blob/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/django%2Ftemplatetags%2Ffuture.py",
            "raw_url": "https://github.com/django/django/raw/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/django%2Ftemplatetags%2Ffuture.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Ffuture.py?ref=f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
            "patch": "@@ -1,14 +1,65 @@\n from django.template import Library\n-from django.template.defaulttags import url as default_url, ssi as default_ssi\n+from django.template import defaulttags\n \n register = Library()\n \n+\n @register.tag\n def ssi(parser, token):\n     # Used for deprecation path during 1.3/1.4, will be removed in 2.0\n-    return default_ssi(parser, token)\n+    return defaulttags.ssi(parser, token)\n+\n \n @register.tag\n def url(parser, token):\n     # Used for deprecation path during 1.3/1.4, will be removed in 2.0\n-    return default_url(parser, token)\n+    return defaulttags.url(parser, token)\n+\n+\n+@register.tag\n+def cycle(parser, token):\n+    \"\"\"\n+    This is the future version of `cycle` with auto-escaping.\n+\n+    By default all strings are escaped.\n+\n+    If you want to disable auto-escaping of variables you can use:\n+\n+        {% autoescape off %}\n+            {% cycle var1 var2 var3 as somecycle %}\n+        {% autoescape %}\n+\n+    Or if only some variables should be escaped, you can use:\n+\n+        {% cycle var1 var2|safe var3|safe  as somecycle %}\n+    \"\"\"\n+    return defaulttags.cycle(parser, token, escape=True)\n+\n+\n+@register.tag\n+def firstof(parser, token):\n+    \"\"\"\n+    This is the future version of `firstof` with auto-escaping.\n+\n+    This is equivalent to:\n+\n+       {% if var1 %}\n+           {{ var1 }}\n+       {% elif var2 %}\n+           {{ var2 }}\n+       {% elif var3 %}\n+           {{ var3 }}\n+       {% endif %}\n+\n+    If you want to disable auto-escaping of variables you can use:\n+\n+        {% autoescape off %}\n+            {% firstof var1 var2 var3 \"<strong>fallback value</strong>\" %}\n+        {% autoescape %}\n+\n+    Or if only some variables should be escaped, you can use:\n+\n+        {% firstof var1 var2|safe var3 \"<strong>fallback value</strong>\"|safe %}\n+\n+    \"\"\"\n+    return defaulttags.firstof(parser, token, escape=True)"
        },
        {
            "sha": "ef9fd31d15eb5737871a9df36a4fc362dffb9ae5",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
            "patch": "@@ -323,6 +323,10 @@ these changes.\n 1.8\n ---\n \n+* The :ttag:`cycle` and :ttag:`firstof` template tags will auto-escape their\n+  arguments. In 1.6 and 1.7, this behavior is provided by the version of these\n+  tags in the ``future`` template tag library.\n+\n * The ``SEND_BROKEN_LINK_EMAILS`` setting will be removed. Add the\n   :class:`django.middleware.common.BrokenLinkEmailsMiddleware` middleware to\n   your :setting:`MIDDLEWARE_CLASSES` setting instead."
        },
        {
            "sha": "149a5573564717758f818a33200568a2f153daab",
            "filename": "docs/ref/templates/builtins.txt",
            "status": "modified",
            "additions": 43,
            "deletions": 12,
            "changes": 55,
            "blob_url": "https://github.com/django/django/blob/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/docs%2Fref%2Ftemplates%2Fbuiltins.txt",
            "raw_url": "https://github.com/django/django/raw/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/docs%2Fref%2Ftemplates%2Fbuiltins.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Ftemplates%2Fbuiltins.txt?ref=f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
            "patch": "@@ -147,9 +147,8 @@ You can use any number of values in a ``{% cycle %}`` tag, separated by spaces.\n Values enclosed in single (``'``) or double quotes (``\"``) are treated as\n string literals, while values without quotes are treated as template variables.\n \n-Note that the variables included in the cycle will not be escaped.\n-This is because template tags do not escape their content. Any HTML or\n-Javascript code contained in the printed variable will be rendered\n+Note that currently the variables included in the cycle will not be escaped.\n+Any HTML or Javascript code contained in the printed variable will be rendered\n as-is, which could potentially lead to security issues.\n \n For backwards compatibility, the ``{% cycle %}`` tag supports the much inferior\n@@ -190,6 +189,22 @@ call to ``{% cycle %}`` doesn't specify silent::\n     {% cycle 'row1' 'row2' as rowcolors silent %}\n     {% cycle rowcolors %}\n \n+.. versionchanged:: 1.6\n+\n+To improve safety, future versions of ``cycle`` will automatically escape\n+their output. You're encouraged to activate this behavior by loading\n+``cycle`` from the ``future`` template library::\n+\n+    {% load cycle from future %}\n+\n+When using the ``future`` version, you can disable auto-escaping with::\n+\n+    {% for o in some_list %}\n+        <tr class=\"{% autoescape off %}{% cycle rowvalue1 rowvalue2 %}{% endautoescape %}\">\n+            ...\n+        </tr>\n+    {% endfor %}\n+\n .. templatetag:: debug\n \n debug\n@@ -257,28 +272,44 @@ This is equivalent to::\n \n     {% if var1 %}\n         {{ var1|safe }}\n-    {% else %}{% if var2 %}\n+    {% elif var2 %}\n         {{ var2|safe }}\n-    {% else %}{% if var3 %}\n+    {% elif var3 %}\n         {{ var3|safe }}\n-    {% endif %}{% endif %}{% endif %}\n+    {% endif %}\n \n You can also use a literal string as a fallback value in case all\n passed variables are False::\n \n     {% firstof var1 var2 var3 \"fallback value\" %}\n \n-Note that the variables included in the firstof tag will not be\n-escaped. This is because template tags do not escape their content.\n-Any HTML or Javascript code contained in the printed variable will be\n-rendered as-is, which could potentially lead to security issues. If you\n-need to escape the variables in the firstof tag, you must do so\n-explicitly::\n+Note that currently the variables included in the firstof tag will not be\n+escaped. Any HTML or Javascript code contained in the printed variable will be\n+rendered as-is, which could potentially lead to security issues. If you need\n+to escape the variables in the firstof tag, you must do so explicitly::\n \n     {% filter force_escape %}\n         {% firstof var1 var2 var3 \"fallback value\" %}\n     {% endfilter %}\n \n+.. versionchanged:: 1.6\n+\n+To improve safety, future versions of ``firstof`` will automatically escape\n+their output. You're encouraged to activate this behavior by loading\n+``firstof`` from the ``future`` template library::\n+\n+    {% load firstof from future %}\n+\n+When using the ``future`` version, you can disable auto-escaping with::\n+\n+    {% autoescape off %}\n+        {% firstof var1 var2 var3 \"<strong>fallback value</strong>\" %}\n+    {% endautoescape %}\n+\n+Or if only some variables should be escaped, you can use::\n+\n+    {% firstof var1 var2|safe var3 \"<strong>fallback value</strong>\"|safe %}\n+\n .. templatetag:: for\n \n for"
        },
        {
            "sha": "ce1e6439461a24f9694c14db9c4a345e5080566b",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
            "patch": "@@ -160,6 +160,34 @@ Backwards incompatible changes in 1.6\n Features deprecated in 1.6\n ==========================\n \n+Changes to :ttag:`cycle` and :ttag:`firstof`\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The template system generally escapes all variables to avoid XSS attacks.\n+However, due to an accident of history, the :ttag:`cycle` and :ttag:`firstof`\n+tags render their arguments as-is.\n+\n+Django 1.6 starts a process to correct this inconsistency. The ``future``\n+template library provides alternate implementations of :ttag:`cycle` and\n+:ttag:`firstof` that autoescape their inputs. If you're using these tags,\n+you're encourage to include the following line at the top of your templates to\n+enable the new behavior::\n+\n+    {% load cycle from future %}\n+\n+or::\n+\n+    {% load firstof from future %}\n+\n+The tags implementing the old behavior have been deprecated, and in Django\n+1.8, the old behavior will be replaced with the new behavior. To ensure\n+compatibility with future versions of Django, existing templates should be\n+modified to use the ``future`` versions.\n+\n+If necessary, you can temporarily disable auto-escaping with\n+:func:`~django.utils.safestring.mark_safe` or :ttag:`{% autoescape off %}\n+<autoescape>`.\n+\n ``SEND_BROKEN_LINK_EMAILS`` setting\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "95b090fcde7b02c8567f46f9bd02b12504829bf4",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f49e9a517f2fdc1d9ed7ac841ace77636cbd6747/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=f49e9a517f2fdc1d9ed7ac841ace77636cbd6747",
            "patch": "@@ -773,6 +773,11 @@ def get_template_tests(self):\n             'cycle23': (\"{% for x in values %}{% cycle 'a' 'b' 'c' as abc silent %}{{ abc }}{{ x }}{% endfor %}\", {'values': [1,2,3,4]}, \"a1b2c3a4\"),\n             'included-cycle': ('{{ abc }}', {'abc': 'xxx'}, 'xxx'),\n             'cycle24': (\"{% for x in values %}{% cycle 'a' 'b' 'c' as abc silent %}{% include 'included-cycle' %}{% endfor %}\", {'values': [1,2,3,4]}, \"abca\"),\n+            'cycle25': ('{% cycle a as abc %}', {'a': '<'}, '<'),\n+\n+            'cycle26': ('{% load cycle from future %}{% cycle a b as ab %}{% cycle ab %}', {'a': '<', 'b': '>'}, '&lt;&gt;'),\n+            'cycle27': ('{% load cycle from future %}{% autoescape off %}{% cycle a b as ab %}{% cycle ab %}{% endautoescape %}', {'a': '<', 'b': '>'}, '<>'),\n+            'cycle28': ('{% load cycle from future %}{% cycle a|safe b as ab %}{% cycle ab %}', {'a': '<', 'b': '>'}, '<&gt;'),\n \n             ### EXCEPTIONS ############################################################\n \n@@ -804,7 +809,12 @@ def get_template_tests(self):\n             'firstof07': ('{% firstof a b \"c\" %}', {'a':0}, 'c'),\n             'firstof08': ('{% firstof a b \"c and d\" %}', {'a':0,'b':0}, 'c and d'),\n             'firstof09': ('{% firstof %}', {}, template.TemplateSyntaxError),\n-            'firstof10': ('{% firstof a %}', {'a': '<'}, '<'), # Variables are NOT auto-escaped.\n+            'firstof10': ('{% firstof a %}', {'a': '<'}, '<'),\n+\n+            'firstof11': ('{% load firstof from future %}{% firstof a b %}', {'a': '<', 'b': '>'}, '&lt;'),\n+            'firstof12': ('{% load firstof from future %}{% firstof a b %}', {'a': '', 'b': '>'}, '&gt;'),\n+            'firstof13': ('{% load firstof from future %}{% autoescape off %}{% firstof a %}{% endautoescape %}', {'a': '<'}, '<'),\n+            'firstof14': ('{% load firstof from future %}{% firstof a|safe b %}', {'a': '<'}, '<'),\n \n             ### FOR TAG ###############################################################\n             'for-tag01': (\"{% for val in values %}{{ val }}{% endfor %}\", {\"values\": [1, 2, 3]}, \"123\"),"
        }
    ],
    "stats": {
        "total": 204,
        "additions": 173,
        "deletions": 31
    }
}