{
    "author": "carljm",
    "message": "Fixed #18545 -- Make the 'no DJANGO_SETTINGS_MODULE' error message more useful.Thanks Nick Coghlan for the report, and Malcolm Tredinnick for review.",
    "sha": "307706d082d20ac868654ccbaee18879db5197db",
    "files": [
        {
            "sha": "f5ced6073583a8e171323ca1537d56b73a6b25a3",
            "filename": "django/conf/__init__.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/307706d082d20ac868654ccbaee18879db5197db/django%2Fconf%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/307706d082d20ac868654ccbaee18879db5197db/django%2Fconf%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2F__init__.py?ref=307706d082d20ac868654ccbaee18879db5197db",
            "patch": "@@ -26,7 +26,7 @@ class LazySettings(LazyObject):\n     The user can manually configure settings prior to using them. Otherwise,\n     Django uses the settings module pointed to by DJANGO_SETTINGS_MODULE.\n     \"\"\"\n-    def _setup(self):\n+    def _setup(self, name):\n         \"\"\"\n         Load the settings module pointed to by the environment variable. This\n         is used the first time we need any settings at all, if the user has not\n@@ -37,12 +37,21 @@ def _setup(self):\n             if not settings_module: # If it's set but is an empty string.\n                 raise KeyError\n         except KeyError:\n-            # NOTE: This is arguably an EnvironmentError, but that causes\n-            # problems with Python's interactive help.\n-            raise ImportError(\"Settings cannot be imported, because environment variable %s is undefined.\" % ENVIRONMENT_VARIABLE)\n+            raise ImproperlyConfigured(\n+                \"Requested setting %s, but settings are not configured. \"\n+                \"You must either define the environment variable %s \"\n+                \"or call settings.configure() before accessing settings.\"\n+                % (name, ENVIRONMENT_VARIABLE))\n \n         self._wrapped = Settings(settings_module)\n \n+\n+    def __getattr__(self, name):\n+        if self._wrapped is empty:\n+            self._setup(name)\n+        return getattr(self._wrapped, name)\n+\n+\n     def configure(self, default_settings=global_settings, **options):\n         \"\"\"\n         Called to manually configure the settings. The 'default_settings'"
        },
        {
            "sha": "b40570efc9e0ee73efe6d7c5b80bda2ea030167b",
            "filename": "django/core/management/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/307706d082d20ac868654ccbaee18879db5197db/django%2Fcore%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/307706d082d20ac868654ccbaee18879db5197db/django%2Fcore%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2F__init__.py?ref=307706d082d20ac868654ccbaee18879db5197db",
            "patch": "@@ -5,6 +5,7 @@\n import imp\n import warnings\n \n+from django.core.exceptions import ImproperlyConfigured\n from django.core.management.base import BaseCommand, CommandError, handle_default_options\n from django.core.management.color import color_style\n from django.utils.importlib import import_module\n@@ -105,7 +106,7 @@ def get_commands():\n         try:\n             from django.conf import settings\n             apps = settings.INSTALLED_APPS\n-        except (AttributeError, EnvironmentError, ImportError):\n+        except (AttributeError, ImproperlyConfigured):\n             apps = []\n \n         # Find and load the management module for each installed app."
        },
        {
            "sha": "6028eac846e9f647821db11f3864bef21d355abc",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 19,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/307706d082d20ac868654ccbaee18879db5197db/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/307706d082d20ac868654ccbaee18879db5197db/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=307706d082d20ac868654ccbaee18879db5197db",
            "patch": "@@ -181,11 +181,11 @@ class DjangoAdminNoSettings(AdminScriptTestCase):\n     \"A series of tests for django-admin.py when there is no settings.py file.\"\n \n     def test_builtin_command(self):\n-        \"no settings: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"no settings: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_bad_settings(self):\n         \"no settings: django-admin builtin commands fail if settings file (from argument) doesn't exist\"\n@@ -213,11 +213,11 @@ def tearDown(self):\n         self.remove_settings('settings.py')\n \n     def test_builtin_command(self):\n-        \"default: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"default: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_settings(self):\n         \"default: django-admin builtin commands succeed if settings are provided as argument\"\n@@ -279,11 +279,11 @@ def tearDown(self):\n         self.remove_settings('settings.py')\n \n     def test_builtin_command(self):\n-        \"fulldefault: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"fulldefault: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_settings(self):\n         \"fulldefault: django-admin builtin commands succeed if a settings file is provided\"\n@@ -345,11 +345,11 @@ def tearDown(self):\n         self.remove_settings('settings.py')\n \n     def test_builtin_command(self):\n-        \"minimal: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"minimal: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_settings(self):\n         \"minimal: django-admin builtin commands fail if settings are provided as argument\"\n@@ -411,11 +411,11 @@ def tearDown(self):\n         self.remove_settings('alternate_settings.py')\n \n     def test_builtin_command(self):\n-        \"alternate: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"alternate: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_settings(self):\n         \"alternate: django-admin builtin commands succeed if settings are provided as argument\"\n@@ -482,11 +482,11 @@ def tearDown(self):\n         self.remove_settings('alternate_settings.py')\n \n     def test_builtin_command(self):\n-        \"alternate: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"alternate: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_settings(self):\n         \"alternate: django-admin builtin commands succeed if settings are provided as argument\"\n@@ -570,11 +570,11 @@ def test_setup_environ_custom_template(self):\n         self.assertTrue(os.path.exists(os.path.join(app_path, 'api.py')))\n \n     def test_builtin_command(self):\n-        \"directory: django-admin builtin commands fail with an import error when no settings provided\"\n+        \"directory: django-admin builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, 'environment variable DJANGO_SETTINGS_MODULE is undefined')\n+        self.assertOutput(err, 'settings are not configured')\n \n     def test_builtin_with_bad_settings(self):\n         \"directory: django-admin builtin commands fail if settings file (from argument) doesn't exist\"\n@@ -621,7 +621,7 @@ class ManageNoSettings(AdminScriptTestCase):\n     \"A series of tests for manage.py when there is no settings.py file.\"\n \n     def test_builtin_command(self):\n-        \"no settings: manage.py builtin commands fail with an import error when no settings provided\"\n+        \"no settings: manage.py builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(out)\n@@ -786,7 +786,7 @@ def tearDown(self):\n         self.remove_settings('settings.py')\n \n     def test_builtin_command(self):\n-        \"minimal: manage.py builtin commands fail with an import error when no settings provided\"\n+        \"minimal: manage.py builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(out)\n@@ -852,7 +852,7 @@ def tearDown(self):\n         self.remove_settings('alternate_settings.py')\n \n     def test_builtin_command(self):\n-        \"alternate: manage.py builtin commands fail with an import error when no default settings provided\"\n+        \"alternate: manage.py builtin commands fail with an error when no default settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(out)\n@@ -895,7 +895,7 @@ def test_custom_command(self):\n         args = ['noargs_command']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(out)\n-        self.assertOutput(err, \"Unknown command: 'noargs_command'\")\n+        self.assertOutput(err, \"Could not import settings 'regressiontests.settings'\")\n \n     def test_custom_command_with_settings(self):\n         \"alternate: manage.py can execute user commands if settings are provided as argument\"\n@@ -927,7 +927,7 @@ def tearDown(self):\n         self.remove_settings('alternate_settings.py')\n \n     def test_builtin_command(self):\n-        \"multiple: manage.py builtin commands fail with an import error when no settings provided\"\n+        \"multiple: manage.py builtin commands fail with an error when no settings provided\"\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(out)"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 34,
        "deletions": 24
    }
}