{
    "author": "spookylukey",
    "message": "Fixed #15954 - New IGNORABLE_404_URLS setting that allows more powerful filtering of 404s to ignore\n\nThanks to aaugustin for implementing this.\n\n(Technically this doesn't fix the original report, as we've decided against\nhaving *any* default values, but the new feature makes it possible, and the\ndocs have an example addressing #15954).\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16160 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "171df93170df23d2fea1f8320ddb80c6f6444ff7",
    "files": [
        {
            "sha": "477f13b6750e9a7763bd87baecd57fa88642a234",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -246,9 +246,17 @@\n # is an admin.\n ADMIN_FOR = ()\n \n-# 404s that may be ignored.\n-IGNORABLE_404_STARTS = ('/cgi-bin/', '/_vti_bin', '/_vti_inf')\n-IGNORABLE_404_ENDS = ('mail.pl', 'mailform.pl', 'mail.cgi', 'mailform.cgi', 'favicon.ico', '.php')\n+# List of compiled regular expression objects representing URLs that need not\n+# be reported when SEND_BROKEN_LINK_EMAILS is True. Here are a few examples:\n+#    import re\n+#    IGNORABLE_404_URLS = (\n+#        re.compile(r'^/apple-touch-icon.*\\.png$'),\n+#        re.compile(r'^/favicon.ico$),\n+#        re.compile(r'^/robots.txt$),\n+#        re.compile(r'^/phpmyadmin/),\n+#        re.compile(r'\\.(cgi|php|pl)$'),\n+#    )\n+IGNORABLE_404_URLS = ()\n \n # A secret key for this particular Django installation. Used in secret-key\n # hashing algorithms. Set this in your settings, or Django will complain"
        },
        {
            "sha": "689929bea459993cd7fdd97eb349cb06b9dd4c50",
            "filename": "django/middleware/common.py",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/django%2Fmiddleware%2Fcommon.py",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/django%2Fmiddleware%2Fcommon.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcommon.py?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -127,13 +127,23 @@ def _is_ignorable_404(uri):\n     \"\"\"\n     Returns True if a 404 at the given URL *shouldn't* notify the site managers.\n     \"\"\"\n-    for start in settings.IGNORABLE_404_STARTS:\n-        if uri.startswith(start):\n-            return True\n-    for end in settings.IGNORABLE_404_ENDS:\n-        if uri.endswith(end):\n-            return True\n-    return False\n+    if getattr(settings, 'IGNORABLE_404_STARTS', ()):\n+        import warnings\n+        warnings.warn('The IGNORABLE_404_STARTS setting has been deprecated '\n+                      'in favour of IGNORABLE_404_URLS.',\n+                      PendingDeprecationWarning)\n+        for start in settings.IGNORABLE_404_STARTS:\n+            if uri.startswith(start):\n+                return True\n+    if getattr(settings, 'IGNORABLE_404_ENDS', ()):\n+        import warnings\n+        warnings.warn('The IGNORABLE_404_ENDS setting has been deprecated '\n+                      'in favour of IGNORABLE_404_URLS.',\n+                      PendingDeprecationWarning)\n+        for end in settings.IGNORABLE_404_ENDS:\n+            if uri.endswith(end):\n+                return True\n+    return any(pattern.search(uri) for pattern in settings.IGNORABLE_404_URLS)\n \n def _is_internal_request(domain, referer):\n     \"\"\""
        },
        {
            "sha": "ddef93873eb6d41ca74d716beff1bce6d3f56b9f",
            "filename": "docs/howto/error-reporting.txt",
            "status": "modified",
            "additions": 25,
            "deletions": 4,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Fhowto%2Ferror-reporting.txt",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Fhowto%2Ferror-reporting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Ferror-reporting.txt?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -66,15 +66,29 @@ a referer. (It doesn't bother to email for 404s that don't have a referer --\n those are usually just people typing in broken URLs or broken Web 'bots).\n \n You can tell Django to stop reporting particular 404s by tweaking the\n-:setting:`IGNORABLE_404_ENDS` and :setting:`IGNORABLE_404_STARTS` settings. Both\n-should be a tuple of strings. For example::\n+:setting:`IGNORABLE_404_URLS` setting. It should be a tuple of compiled\n+regular expression objects. For example::\n \n-    IGNORABLE_404_ENDS = ('.php', '.cgi')\n-    IGNORABLE_404_STARTS = ('/phpmyadmin/',)\n+    import re\n+    IGNORABLE_404_URLS = (\n+        re.compile(r'\\.(php|cgi)$'),\n+        re.compile(r'^/phpmyadmin/'),\n+    )\n \n In this example, a 404 to any URL ending with ``.php`` or ``.cgi`` will *not* be\n reported. Neither will any URL starting with ``/phpmyadmin/``.\n \n+The following example shows how to exclude some conventional URLs that browsers and\n+crawlers often request::\n+\n+    import re\n+    IGNORABLE_404_URLS = (\n+        re.compile(r'^/apple-touch-icon.*\\.png$'),\n+        re.compile(r'^/favicon.ico$),\n+        re.compile(r'^/robots.txt$),\n+    )\n+\n+\n The best way to disable this behavior is to set\n :setting:`SEND_BROKEN_LINK_EMAILS` to ``False``.\n \n@@ -93,3 +107,10 @@ The best way to disable this behavior is to set\n    records are ignored, but you can use them for error reporting by writing a\n    handler and :doc:`configuring logging </topics/logging>` appropriately.\n \n+.. seealso::\n+\n+   .. versionchanged:: 1.4\n+\n+   Previously, two settings were used to control which URLs not to report:\n+   :setting:`IGNORABLE_404_STARTS` and :setting:`IGNORABLE_404_ENDS`. They\n+   were replaced by :setting:`IGNORABLE_404_URLS`."
        },
        {
            "sha": "8ebeb668e914b2d9160362e07272480bb5c1382f",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -199,6 +199,10 @@ their deprecation, as per the :ref:`Django deprecation policy\n           ISO 3166 code for United Kingdom). They have been depreacted since the\n           1.4 release.\n \n+        * The :setting:`IGNORABLE_404_STARTS` and :setting:`IGNORABLE_404_ENDS`\n+          settings have been superseded by :setting:`IGNORABLE_404_URLS` in\n+          the 1.4 release. They will be removed.\n+\n     * 2.0\n         * ``django.views.defaults.shortcut()``. This function has been moved\n           to ``django.contrib.contenttypes.views.shortcut()`` as part of the"
        },
        {
            "sha": "3a28745598408e48f5786b4c919cf7849fa0cb5b",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 29,
            "deletions": 16,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -1020,25 +1020,23 @@ Available formats are ``DATE_FORMAT``, ``TIME_FORMAT``, ``DATETIME_FORMAT``,\n ``SHORT_DATETIME_FORMAT``, ``FIRST_DAY_OF_WEEK``, ``DECIMAL_SEPARATOR``,\n ``THOUSAND_SEPARATOR`` and ``NUMBER_GROUPING``.\n \n-.. setting:: IGNORABLE_404_ENDS\n+.. setting:: IGNORABLE_404_URLS\n \n-IGNORABLE_404_ENDS\n+IGNORABLE_404_URLS\n ------------------\n \n-Default: ``('mail.pl', 'mailform.pl', 'mail.cgi', 'mailform.cgi', 'favicon.ico', '.php')``\n-\n-See also ``IGNORABLE_404_STARTS`` and ``Error reporting via email``.\n-\n-.. setting:: IGNORABLE_404_STARTS\n+.. versionadded:: 1.4\n \n-IGNORABLE_404_STARTS\n---------------------\n+Default: ``()``\n \n-Default: ``('/cgi-bin/', '/_vti_bin', '/_vti_inf')``\n+List of compiled regular expression objects describing URLs that should be\n+ignored when reporting HTTP 404 errors via email (see\n+:doc:`/howto/error-reporting`). Use this if your site does not provide a\n+commonly requested file such as ``favicon.ico`` or ``robots.txt``, or if it\n+gets hammered by script kiddies.\n \n-A tuple of strings that specify beginnings of URLs that should be ignored by\n-the 404 emailer. See ``SEND_BROKEN_LINK_EMAILS``, ``IGNORABLE_404_ENDS`` and\n-the :doc:`/howto/error-reporting`.\n+This is only used if :setting:`SEND_BROKEN_LINK_EMAILS` is set to ``True`` and\n+``CommonMiddleware`` is installed (see :doc:`/topics/http/middleware`).\n \n .. setting:: INSTALLED_APPS\n \n@@ -1435,8 +1433,8 @@ Default: ``False``\n Whether to send an email to the ``MANAGERS`` each time somebody visits a\n Django-powered page that is 404ed with a non-empty referer (i.e., a broken\n link). This is only used if ``CommonMiddleware`` is installed (see\n-:doc:`/topics/http/middleware`. See also ``IGNORABLE_404_STARTS``,\n-``IGNORABLE_404_ENDS`` and :doc:`/howto/error-reporting`.\n+:doc:`/topics/http/middleware`). See also ``IGNORABLE_404_URLS`` and\n+:doc:`/howto/error-reporting`.\n \n .. setting:: SERIALIZATION_MODULES\n \n@@ -2045,6 +2043,22 @@ DATABASE_USER\n    This setting has been replaced by :setting:`USER` in\n    :setting:`DATABASES`.\n \n+.. setting:: IGNORABLE_404_ENDS\n+\n+IGNORABLE_404_ENDS\n+------------------\n+\n+.. deprecated:: 1.4\n+   This setting has been superseded by :setting:`IGNORABLE_404_URLS`.\n+\n+.. setting:: IGNORABLE_404_STARTS\n+\n+IGNORABLE_404_STARTS\n+--------------------\n+\n+.. deprecated:: 1.4\n+   This setting has been superseded by :setting:`IGNORABLE_404_URLS`.\n+\n .. setting:: TEST_DATABASE_CHARSET\n \n TEST_DATABASE_CHARSET\n@@ -2071,4 +2085,3 @@ TEST_DATABASE_NAME\n .. deprecated:: 1.2\n    This setting has been replaced by :setting:`TEST_NAME` in\n    :setting:`DATABASES`.\n-"
        },
        {
            "sha": "1b8510f4617fce9f3eba645b6c054030c9190e1a",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -176,3 +176,41 @@ Save this model manager in your custom comment app (e.g. in\n \n For more details see the docs about\n :doc:`customizing the comments framework </ref/contrib/comments/custom>`.\n+\n+`IGNORABLE_404_STARTS` and `IGNORABLE_404_ENDS` settings\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django can report 404 errors: see :doc:`/howto/error-reporting`.\n+Until Django 1.3, it was possible to exclude some URLs from the reporting\n+by adding prefixes to :setting:`IGNORABLE_404_STARTS` and suffixes to\n+:setting:`IGNORABLE_404_ENDS`.\n+\n+In Django 1.4, these two settings are superseded by\n+:setting:`IGNORABLE_404_URLS`, which is a list of compiled regular expressions.\n+Django won't send an email for 404 errors on URLs that match any of them.\n+\n+Furthermore, the previous settings had some rather arbitrary default values::\n+\n+    IGNORABLE_404_STARTS = ('/cgi-bin/', '/_vti_bin', '/_vti_inf')\n+    IGNORABLE_404_ENDS = ('mail.pl', 'mailform.pl', 'mail.cgi', 'mailform.cgi',\n+                          'favicon.ico', '.php')\n+\n+It's not Django's role to decide if your website has a legacy ``/cgi-bin/``\n+section or a ``favicon.ico``. As a consequence, the default values of\n+:setting:`IGNORABLE_404_URLS`, :setting:`IGNORABLE_404_STARTS` and\n+:setting:`IGNORABLE_404_ENDS` are all now empty.\n+\n+If you have customized :setting:`IGNORABLE_404_STARTS` or\n+:setting:`IGNORABLE_404_ENDS`, or if you want to keep the old default value,\n+you should add the following lines in your settings file::\n+\n+    import re\n+    IGNORABLE_404_URLS = (\n+        # for each <prefix> in IGNORABLE_404_STARTS\n+        re.compile(r'^<prefix>'),\n+        # for each <suffix> in IGNORABLE_404_ENDS\n+        re.compile(r'<suffix>$'),\n+    )\n+\n+Don't forget to escape characters that have a special meaning in a regular\n+expression."
        },
        {
            "sha": "c069228487d45d966d6b64162729e49075afc4c4",
            "filename": "tests/regressiontests/middleware/tests.py",
            "status": "modified",
            "additions": 41,
            "deletions": 4,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/171df93170df23d2fea1f8320ddb80c6f6444ff7/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/171df93170df23d2fea1f8320ddb80c6f6444ff7/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Ftests.py?ref=171df93170df23d2fea1f8320ddb80c6f6444ff7",
            "patch": "@@ -1,6 +1,9 @@\n # -*- coding: utf-8 -*-\n \n+import re\n+\n from django.conf import settings\n+from django.core import mail\n from django.http import HttpRequest\n from django.middleware.common import CommonMiddleware\n from django.middleware.http import ConditionalGetMiddleware\n@@ -9,12 +12,16 @@\n \n class CommonMiddlewareTest(TestCase):\n     def setUp(self):\n-        self.slash = settings.APPEND_SLASH\n-        self.www = settings.PREPEND_WWW\n+        self.append_slash = settings.APPEND_SLASH\n+        self.prepend_www = settings.PREPEND_WWW\n+        self.ignorable_404_urls = settings.IGNORABLE_404_URLS\n+        self.send_broken_email_links = settings.SEND_BROKEN_LINK_EMAILS\n \n     def tearDown(self):\n-        settings.APPEND_SLASH = self.slash\n-        settings.PREPEND_WWW = self.www\n+        settings.APPEND_SLASH = self.append_slash\n+        settings.PREPEND_WWW = self.prepend_www\n+        settings.IGNORABLE_404_URLS = self.ignorable_404_urls\n+        settings.SEND_BROKEN_LINK_EMAILS = self.send_broken_email_links\n \n     def _get_request(self, path):\n         request = HttpRequest()\n@@ -249,6 +256,36 @@ def test_prepend_www_append_slash_slashless_custom_urlconf(self):\n       self.assertEqual(r['Location'],\n                         'http://www.testserver/middleware/customurlconf/slash/')\n \n+    # Tests for the 404 error reporting via email\n+\n+    def test_404_error_reporting(self):\n+        settings.IGNORABLE_404_URLS = (re.compile(r'foo'),)\n+        settings.SEND_BROKEN_LINK_EMAILS = True\n+        request = self._get_request('regular_url/that/does/not/exist')\n+        request.META['HTTP_REFERER'] = '/another/url/'\n+        response = self.client.get(request.path)\n+        CommonMiddleware().process_response(request, response)\n+        self.assertEqual(len(mail.outbox), 1)\n+        self.assertIn('Broken', mail.outbox[0].subject)\n+\n+    def test_404_error_reporting_no_referer(self):\n+        settings.IGNORABLE_404_URLS = (re.compile(r'foo'),)\n+        settings.SEND_BROKEN_LINK_EMAILS = True\n+        request = self._get_request('regular_url/that/does/not/exist')\n+        response = self.client.get(request.path)\n+        CommonMiddleware().process_response(request, response)\n+        self.assertEqual(len(mail.outbox), 0)\n+\n+    def test_404_error_reporting_ignored_url(self):\n+        settings.IGNORABLE_404_URLS = (re.compile(r'foo'),)\n+        settings.SEND_BROKEN_LINK_EMAILS = True\n+        request = self._get_request('foo_url/that/does/not/exist/either')\n+        request.META['HTTP_REFERER'] = '/another/url/'\n+        response = self.client.get(request.path)\n+        CommonMiddleware().process_response(request, response)\n+        self.assertEqual(len(mail.outbox), 0)\n+\n+\n class ConditionalGetMiddlewareTest(TestCase):\n     urls = 'regressiontests.middleware.cond_get_urls'\n     def setUp(self):"
        }
    ],
    "stats": {
        "total": 199,
        "additions": 165,
        "deletions": 34
    }
}