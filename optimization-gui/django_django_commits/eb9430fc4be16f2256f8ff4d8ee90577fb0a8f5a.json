{
    "author": "claudep",
    "message": "Implemented some SpatiaLiteOperations as cached properties\n\nPreviously, some properties weren't set unless\nconfirm_spatial_components_versions() was explicitely called.",
    "sha": "eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a",
    "files": [
        {
            "sha": "d0a5f820332aeae7f419b0a51003e6e190577c9b",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a",
            "patch": "@@ -30,7 +30,6 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n \n         self.connection.close()\n         self.connection.settings_dict[\"NAME\"] = test_database_name\n-        self.connection.ops.confirm_spatial_components_versions()\n \n         # Need to load the SpatiaLite initialization SQL before running `syncdb`.\n         self.load_spatialite_sql()"
        },
        {
            "sha": "773ac0b57d6718ae9e170eef1117c2d9e7cdfee5",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 32,
            "deletions": 18,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=eb9430fc4be16f2256f8ff4d8ee90577fb0a8f5a",
            "patch": "@@ -10,6 +10,8 @@\n from django.db.backends.sqlite3.base import DatabaseOperations\n from django.db.utils import DatabaseError\n from django.utils import six\n+from django.utils.functional import cached_property\n+\n \n class SpatiaLiteOperator(SpatialOperation):\n     \"For SpatiaLite operators (e.g. `&&`, `~`).\"\n@@ -118,36 +120,48 @@ def __init__(self, connection):\n         gis_terms += self.geometry_functions.keys()\n         self.gis_terms = dict([(term, None) for term in gis_terms])\n \n-    def confirm_spatial_components_versions(self):\n-        # Determine the version of the SpatiaLite library.\n+    @cached_property\n+    def spatial_version(self):\n+        \"\"\"Determine the version of the SpatiaLite library.\"\"\"\n         try:\n-            vtup = self.spatialite_version_tuple()\n-            version = vtup[1:]\n-            if version < (2, 3, 0):\n-                raise ImproperlyConfigured('GeoDjango only supports SpatiaLite versions '\n-                                           '2.3.0 and above')\n-            self.spatial_version = version\n-        except ImproperlyConfigured:\n-            raise\n+            version = self.spatialite_version_tuple()[1:]\n         except Exception as msg:\n             raise ImproperlyConfigured('Cannot determine the SpatiaLite version for the \"%s\" '\n                                        'database (error was \"%s\").  Was the SpatiaLite initialization '\n                                        'SQL loaded on this database?' %\n                                        (self.connection.settings_dict['NAME'], msg))\n-\n-        if version >= (2, 4, 0):\n+        if version < (2, 3, 0):\n+            raise ImproperlyConfigured('GeoDjango only supports SpatiaLite versions '\n+                                       '2.3.0 and above')\n+        return version\n+\n+    @property\n+    def _version_greater_2_4_0_rc4(self):\n+        if self.spatial_version >= (2, 4, 1):\n+            return True\n+        elif self.spatial_version < (2, 4, 0):\n+            return False\n+        else:\n             # Spatialite 2.4.0-RC4 added AsGML and AsKML, however both\n             # RC2 (shipped in popular Debian/Ubuntu packages) and RC4\n             # report version as '2.4.0', so we fall back to feature detection\n             try:\n                 self._get_spatialite_func(\"AsGML(GeomFromText('POINT(1 1)'))\")\n-                self.gml = 'AsGML'\n-                self.kml = 'AsKML'\n             except DatabaseError:\n-                # we are using < 2.4.0-RC4\n-                pass\n-        if version >= (3, 0, 0):\n-            self.geojson = 'AsGeoJSON'\n+                return False\n+            return True\n+\n+    @cached_property\n+    def gml(self):\n+        return 'AsGML' if self._version_greater_2_4_0_rc4 else None\n+\n+    @cached_property\n+    def kml(self):\n+        return 'AsKML' if self._version_greater_2_4_0_rc4 else None\n+\n+    @cached_property\n+    def geojson(self):\n+        return 'AsGeoJSON' if self.spatial_version >= (3, 0, 0) else None\n \n     def check_aggregate_support(self, aggregate):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 51,
        "additions": 32,
        "deletions": 19
    }
}