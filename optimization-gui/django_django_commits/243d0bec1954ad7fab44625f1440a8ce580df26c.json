{
    "author": "spookylukey",
    "message": "Fixed #15617 - CSRF referer checking too strict\n\nThanks to adam for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15840 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "243d0bec1954ad7fab44625f1440a8ce580df26c",
    "files": [
        {
            "sha": "b5a85795b2452f6eff9371c1c147569c22144745",
            "filename": "django/middleware/csrf.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/243d0bec1954ad7fab44625f1440a8ce580df26c/django%2Fmiddleware%2Fcsrf.py",
            "raw_url": "https://github.com/django/django/raw/243d0bec1954ad7fab44625f1440a8ce580df26c/django%2Fmiddleware%2Fcsrf.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcsrf.py?ref=243d0bec1954ad7fab44625f1440a8ce580df26c",
            "patch": "@@ -13,6 +13,7 @@\n from django.core.urlresolvers import get_callable\n from django.utils.cache import patch_vary_headers\n from django.utils.hashcompat import md5_constructor\n+from django.utils.http import same_origin\n from django.utils.log import getLogger\n from django.utils.safestring import mark_safe\n from django.utils.crypto import constant_time_compare\n@@ -161,10 +162,9 @@ def process_view(self, request, callback, callback_args, callback_kwargs):\n                     )\n                     return self._reject(request, REASON_NO_REFERER)\n \n-                # The following check ensures that the referer is HTTPS,\n-                # the domains match and the ports match - the same origin policy.\n+                # Note that request.get_host() includes the port\n                 good_referer = 'https://%s/' % request.get_host()\n-                if not referer.startswith(good_referer):\n+                if not same_origin(referer, good_referer):\n                     reason = REASON_BAD_REFERER % (referer, good_referer)\n                     logger.warning('Forbidden (%s): %s' % (reason, request.path),\n                         extra={"
        },
        {
            "sha": "c93a338c3081039c38628ed8a4f41bef477cfa3b",
            "filename": "django/utils/http.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/243d0bec1954ad7fab44625f1440a8ce580df26c/django%2Futils%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/243d0bec1954ad7fab44625f1440a8ce580df26c/django%2Futils%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhttp.py?ref=243d0bec1954ad7fab44625f1440a8ce580df26c",
            "patch": "@@ -3,6 +3,7 @@\n import re\n import sys\n import urllib\n+import urlparse\n from email.Utils import formatdate\n \n from django.utils.encoding import smart_str, force_unicode\n@@ -186,3 +187,20 @@ def quote_etag(etag):\n     \"\"\"\n     return '\"%s\"' % etag.replace('\\\\', '\\\\\\\\').replace('\"', '\\\\\"')\n \n+if sys.version_info >= (2, 6):\n+    def same_origin(url1, url2):\n+        \"\"\"\n+        Checks if two URLs are 'same-origin'\n+        \"\"\"\n+        p1, p2 = urlparse.urlparse(url1), urlparse.urlparse(url2)\n+        return (p1.scheme, p1.hostname, p1.port) == (p2.scheme, p2.hostname, p2.port)\n+else:\n+    # Python 2.4, 2.5 compatibility. This actually works for Python 2.6 and\n+    # above, but the above definition is much more obviously correct and so is\n+    # preferred going forward.\n+    def same_origin(url1, url2):\n+        \"\"\"\n+        Checks if two URLs are 'same-origin'\n+        \"\"\"\n+        p1, p2 = urlparse.urlparse(url1), urlparse.urlparse(url2)\n+        return p1[0:2] == p2[0:2]"
        },
        {
            "sha": "d75adc917bb02914bc3cba7a5c02aae599bf284e",
            "filename": "tests/regressiontests/csrf_tests/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/243d0bec1954ad7fab44625f1440a8ce580df26c/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/243d0bec1954ad7fab44625f1440a8ce580df26c/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py?ref=243d0bec1954ad7fab44625f1440a8ce580df26c",
            "patch": "@@ -382,3 +382,16 @@ def test_https_good_referer(self):\n         req.META['HTTP_REFERER'] = 'https://www.example.com/somepage'\n         req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n         self.assertEqual(None, req2)\n+\n+    def test_https_good_referer_2(self):\n+        \"\"\"\n+        Test that a POST HTTPS request with a good referer is accepted\n+        where the referer contains no trailing slash\n+        \"\"\"\n+        # See ticket #15617\n+        req = self._get_POST_request_with_token()\n+        req._is_secure = True\n+        req.META['HTTP_HOST'] = 'www.example.com'\n+        req.META['HTTP_REFERER'] = 'https://www.example.com'\n+        req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n+        self.assertEqual(None, req2)"
        },
        {
            "sha": "83a4a7f54d7ed01c80d4c2df3bce06c872f5bc15",
            "filename": "tests/regressiontests/utils/http.py",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/243d0bec1954ad7fab44625f1440a8ce580df26c/tests%2Fregressiontests%2Futils%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/243d0bec1954ad7fab44625f1440a8ce580df26c/tests%2Fregressiontests%2Futils%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fhttp.py?ref=243d0bec1954ad7fab44625f1440a8ce580df26c",
            "patch": "@@ -0,0 +1,23 @@\n+from django.utils import http\n+from django.utils import unittest\n+\n+class TestUtilsHttp(unittest.TestCase):\n+\n+    def test_same_origin_true(self):\n+        # Identical\n+        self.assertTrue(http.same_origin('http://foo.com/', 'http://foo.com/'))\n+        # One with trailing slash - see #15617\n+        self.assertTrue(http.same_origin('http://foo.com', 'http://foo.com/'))\n+        self.assertTrue(http.same_origin('http://foo.com/', 'http://foo.com'))\n+        # With port\n+        self.assertTrue(http.same_origin('https://foo.com:8000', 'https://foo.com:8000/'))\n+\n+    def test_same_origin_false(self):\n+        # Different scheme\n+        self.assertFalse(http.same_origin('http://foo.com', 'https://foo.com'))\n+        # Different host\n+        self.assertFalse(http.same_origin('http://foo.com', 'http://goo.com'))\n+        # Different host again\n+        self.assertFalse(http.same_origin('http://foo.com', 'http://foo.com.evil.com'))\n+        # Different port\n+        self.assertFalse(http.same_origin('http://foo.com:8000', 'http://foo.com:8001'))"
        },
        {
            "sha": "5c4c0602e8f12647d50c124dd676e63d0e9e7dbd",
            "filename": "tests/regressiontests/utils/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/243d0bec1954ad7fab44625f1440a8ce580df26c/tests%2Fregressiontests%2Futils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/243d0bec1954ad7fab44625f1440a8ce580df26c/tests%2Fregressiontests%2Futils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftests.py?ref=243d0bec1954ad7fab44625f1440a8ce580df26c",
            "patch": "@@ -7,6 +7,7 @@\n from module_loading import *\n from termcolors import *\n from html import *\n+from http import *\n from checksums import *\n from text import *\n from simplelazyobject import *"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 58,
        "deletions": 3
    }
}