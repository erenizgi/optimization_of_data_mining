{
    "author": "aaugustin",
    "message": "Implemented persistent database connections.\n\nThanks Anssi Kääriäinen and Karen Tracey for their inputs.",
    "sha": "2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
    "files": [
        {
            "sha": "f14afcf290014e55f9a6b48c0d6480448f4ca928",
            "filename": "django/contrib/auth/handlers/modwsgi.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -25,7 +25,7 @@ def check_password(environ, username, password):\n             return None\n         return user.check_password(password)\n     finally:\n-        db.close_connection()\n+        db.close_old_connections()\n \n def groups_for_user(environ, username):\n     \"\"\"\n@@ -44,4 +44,4 @@ def groups_for_user(environ, username):\n             return []\n         return [force_bytes(group.name) for group in user.groups.all()]\n     finally:\n-        db.close_connection()\n+        db.close_old_connections()"
        },
        {
            "sha": "5e630392e7d2bb3e93f3eca3f6c22fcf43984d37",
            "filename": "django/db/__init__.py",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2F__init__.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -42,9 +42,10 @@ def __setattr__(self, name, value):\n connection = DefaultConnectionProxy()\n backend = load_backend(connection.settings_dict['ENGINE'])\n \n-# Register an event that closes the database connection\n-# when a Django request is finished.\n def close_connection(**kwargs):\n+    warnings.warn(\n+        \"close_connection is superseded by close_old_connections.\",\n+        PendingDeprecationWarning, stacklevel=2)\n     # Avoid circular imports\n     from django.db import transaction\n     for conn in connections:\n@@ -53,15 +54,25 @@ def close_connection(**kwargs):\n         # connection state will be cleaned up.\n         transaction.abort(conn)\n         connections[conn].close()\n-signals.request_finished.connect(close_connection)\n \n-# Register an event that resets connection.queries\n-# when a Django request is started.\n+# Register an event to reset saved queries when a Django request is started.\n def reset_queries(**kwargs):\n     for conn in connections.all():\n         conn.queries = []\n signals.request_started.connect(reset_queries)\n \n+# Register an event to reset transaction state and close connections past\n+# their lifetime. NB: abort() doesn't do anything outside of a transaction.\n+def close_old_connections(**kwargs):\n+    for conn in connections.all():\n+        try:\n+            conn.abort()\n+        except DatabaseError:\n+            pass\n+        conn.close_if_unusable_or_obsolete()\n+signals.request_started.connect(close_old_connections)\n+signals.request_finished.connect(close_old_connections)\n+\n # Register an event that rolls back the connections\n # when a Django request has an exception.\n def _rollback_on_exception(**kwargs):"
        },
        {
            "sha": "9fb2b236442c874cbe819b5dadb4ca7daec0eefc",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -1,4 +1,5 @@\n import datetime\n+import time\n \n from django.db.utils import DatabaseError\n \n@@ -49,6 +50,10 @@ def __init__(self, settings_dict, alias=DEFAULT_DB_ALIAS,\n         self._thread_ident = thread.get_ident()\n         self.allow_thread_sharing = allow_thread_sharing\n \n+        # Connection termination related attributes\n+        self.close_at = None\n+        self.errors_occurred = False\n+\n     def __eq__(self, other):\n         return self.alias == other.alias\n \n@@ -59,7 +64,7 @@ def __hash__(self):\n         return hash(self.alias)\n \n     def wrap_database_errors(self):\n-        return DatabaseErrorWrapper(self.Database)\n+        return DatabaseErrorWrapper(self)\n \n     def get_connection_params(self):\n         raise NotImplementedError\n@@ -76,6 +81,11 @@ def create_cursor(self):\n     def _cursor(self):\n         with self.wrap_database_errors():\n             if self.connection is None:\n+                # Reset parameters defining when to close the connection\n+                max_age = self.settings_dict['CONN_MAX_AGE']\n+                self.close_at = None if max_age is None else time.time() + max_age\n+                self.errors_occurred = False\n+                # Establish the connection\n                 conn_params = self.get_connection_params()\n                 self.connection = self.get_new_connection(conn_params)\n                 self.init_connection_state()\n@@ -351,6 +361,26 @@ def close(self):\n             self.connection = None\n         self.set_clean()\n \n+    def close_if_unusable_or_obsolete(self):\n+        if self.connection is not None:\n+            if self.errors_occurred:\n+                if self.is_usable():\n+                    self.errors_occurred = False\n+                else:\n+                    self.close()\n+                    return\n+            if self.close_at is not None and time.time() >= self.close_at:\n+                self.close()\n+                return\n+\n+    def is_usable(self):\n+        \"\"\"\n+        Test if the database connection is usable.\n+\n+        This function may assume that self.connection is not None.\n+        \"\"\"\n+        raise NotImplementedError\n+\n     def cursor(self):\n         self.validate_thread_sharing()\n         if (self.use_debug_cursor or"
        },
        {
            "sha": "6b2ecaead1984fa37ce0d7a1f723c873f6379590",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -439,6 +439,14 @@ def create_cursor(self):\n         cursor = self.connection.cursor()\n         return CursorWrapper(cursor)\n \n+    def is_usable(self):\n+        try:\n+            self.connection.ping()\n+        except DatabaseError:\n+            return False\n+        else:\n+            return True\n+\n     def _rollback(self):\n         try:\n             BaseDatabaseWrapper._rollback(self)"
        },
        {
            "sha": "478124f5dfbdf9ae53546a8c014fdb05e16326ff",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -598,6 +598,18 @@ def init_connection_state(self):\n             # stmtcachesize is available only in 4.3.2 and up.\n             pass\n \n+    def is_usable(self):\n+        try:\n+            if hasattr(self.connection, 'ping'):    # Oracle 10g R2 and higher\n+                self.connection.ping()\n+            else:\n+                # Use a cx_Oracle cursor directly, bypassing Django's utilities.\n+                self.connection.cursor().execute(\"SELECT 1 FROM DUAL\")\n+        except DatabaseError:\n+            return False\n+        else:\n+            return True\n+\n     # Oracle doesn't support savepoint commits.  Ignore them.\n     def _savepoint_commit(self, sid):\n         pass"
        },
        {
            "sha": "db4b5ade053cade23a31dae02083eb51d0a900ed",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -177,6 +177,15 @@ def create_cursor(self):\n         cursor.tzinfo_factory = utc_tzinfo_factory if settings.USE_TZ else None\n         return cursor\n \n+    def is_usable(self):\n+        try:\n+            # Use a psycopg cursor directly, bypassing Django's utilities.\n+            self.connection.cursor().execute(\"SELECT 1\")\n+        except DatabaseError:\n+            return False\n+        else:\n+            return True\n+\n     def _enter_transaction_management(self, managed):\n         \"\"\"\n         Switch the isolation level when needing transaction support, so that"
        },
        {
            "sha": "ad54af46add8d2a7b580cdb9cadeec3107ae2d3d",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -347,6 +347,9 @@ def init_connection_state(self):\n     def create_cursor(self):\n         return self.connection.cursor(factory=SQLiteCursorWrapper)\n \n+    def is_usable(self):\n+        return True\n+\n     def check_constraints(self, table_names=None):\n         \"\"\"\n         Checks each table name in `table_names` for rows with invalid foreign key references. This method is"
        },
        {
            "sha": "cc17b3e7a3b7600d9c86f6a888e3678d7ca24220",
            "filename": "django/db/utils.py",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Fdb%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Futils.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -56,11 +56,13 @@ class DatabaseErrorWrapper(object):\n     exceptions using Django's common wrappers.\n     \"\"\"\n \n-    def __init__(self, database):\n+    def __init__(self, wrapper):\n         \"\"\"\n-        database is a module defining PEP-249 exceptions.\n+        wrapper is a database wrapper.\n+\n+        It must have a Database attribute defining PEP-249 exceptions.\n         \"\"\"\n-        self.database = database\n+        self.wrapper = wrapper\n \n     def __enter__(self):\n         pass\n@@ -79,7 +81,7 @@ def __exit__(self, exc_type, exc_value, traceback):\n                 InterfaceError,\n                 Error,\n             ):\n-            db_exc_type = getattr(self.database, dj_exc_type.__name__)\n+            db_exc_type = getattr(self.wrapper.Database, dj_exc_type.__name__)\n             if issubclass(exc_type, db_exc_type):\n                 # Under Python 2.6, exc_value can still be a string.\n                 try:\n@@ -89,6 +91,10 @@ def __exit__(self, exc_type, exc_value, traceback):\n                 dj_exc_value = dj_exc_type(*args)\n                 if six.PY3:\n                     dj_exc_value.__cause__ = exc_value\n+                # Only set the 'errors_occurred' flag for errors that may make\n+                # the connection unusable.\n+                if dj_exc_type not in (DataError, IntegrityError):\n+                    self.wrapper.errors_occurred = True\n                 six.reraise(dj_exc_type, dj_exc_value, traceback)\n \n     def __call__(self, func):\n@@ -155,6 +161,7 @@ def ensure_defaults(self, alias):\n         conn.setdefault('ENGINE', 'django.db.backends.dummy')\n         if conn['ENGINE'] == 'django.db.backends.' or not conn['ENGINE']:\n             conn['ENGINE'] = 'django.db.backends.dummy'\n+        conn.setdefault('CONN_MAX_AGE', 600)\n         conn.setdefault('OPTIONS', {})\n         conn.setdefault('TIME_ZONE', 'UTC' if settings.USE_TZ else settings.TIME_ZONE)\n         for setting in ['NAME', 'USER', 'PASSWORD', 'HOST', 'PORT']:"
        },
        {
            "sha": "46f55d7cdc10cabe00e1b35ce6f745144cf46931",
            "filename": "django/test/client.py",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Ftest%2Fclient.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/django%2Ftest%2Fclient.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fclient.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -18,7 +18,7 @@\n from django.core.handlers.wsgi import WSGIRequest\n from django.core.signals import (request_started, request_finished,\n     got_request_exception)\n-from django.db import close_connection\n+from django.db import close_old_connections\n from django.http import SimpleCookie, HttpRequest, QueryDict\n from django.template import TemplateDoesNotExist\n from django.test import signals\n@@ -78,9 +78,9 @@ def closing_iterator_wrapper(iterable, close):\n         for item in iterable:\n             yield item\n     finally:\n-        request_finished.disconnect(close_connection)\n+        request_finished.disconnect(close_old_connections)\n         close()                                 # will fire request_finished\n-        request_finished.connect(close_connection)\n+        request_finished.connect(close_old_connections)\n \n \n class ClientHandler(BaseHandler):\n@@ -101,7 +101,9 @@ def __call__(self, environ):\n         if self._request_middleware is None:\n             self.load_middleware()\n \n+        request_started.disconnect(close_old_connections)\n         request_started.send(sender=self.__class__)\n+        request_started.connect(close_old_connections)\n         request = WSGIRequest(environ)\n         # sneaky little hack so that we can easily get round\n         # CsrfViewMiddleware.  This makes life easier, and is probably\n@@ -115,9 +117,9 @@ def __call__(self, environ):\n             response.streaming_content = closing_iterator_wrapper(\n                 response.streaming_content, response.close)\n         else:\n-            request_finished.disconnect(close_connection)\n+            request_finished.disconnect(close_old_connections)\n             response.close()                    # will fire request_finished\n-            request_finished.connect(close_connection)\n+            request_finished.connect(close_old_connections)\n \n         return response\n "
        },
        {
            "sha": "3a9cbd195d47e5e1a6aa1ea2d3d6768fa4488d08",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -339,6 +339,8 @@ these changes.\n \n * ``Model._meta.module_name`` was renamed to ``model_name``.\n \n+* The private API ``django.db.close_connection`` will be removed.\n+\n 2.0\n ---\n "
        },
        {
            "sha": "34f60e99acd4ce6e7a7084ef8089bca872303ffe",
            "filename": "docs/ref/databases.txt",
            "status": "modified",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Fref%2Fdatabases.txt",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Fref%2Fdatabases.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdatabases.txt?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -11,6 +11,68 @@ This file describes some of the features that might be relevant to Django\n usage. Of course, it is not intended as a replacement for server-specific\n documentation or reference manuals.\n \n+General notes\n+=============\n+\n+.. _persistent-database-connections:\n+\n+Persistent connections\n+----------------------\n+\n+.. versionadded:: 1.6\n+\n+Persistent connections avoid the overhead of re-establishing a connection to\n+the database in each request. By default, connections are kept open for up 10\n+minutes — if not specified, :setting:`CONN_MAX_AGE` defaults to 600 seconds.\n+\n+Django 1.5 and earlier didn't have persistent connections. To restore the\n+legacy behavior of closing the connection at the end of every request, set\n+:setting:`CONN_MAX_AGE` to ``0``.\n+\n+For unlimited persistent connections, set :setting:`CONN_MAX_AGE` to ``None``.\n+\n+Connection management\n+~~~~~~~~~~~~~~~~~~~~~\n+\n+Django opens a connection to the database when it first makes a database\n+query. It keeps this connection open and reuses it in subsequent requests.\n+Django closes the connection once it exceeds the maximum age defined by\n+:setting:`CONN_MAX_AGE` or when it isn't usable any longer.\n+\n+In detail, Django automatically opens a connection to the database whenever it\n+needs one and doesn't have one already — either because this is the first\n+connection, or because the previous connection was closed.\n+\n+At the beginning of each request, Django closes the connection if it has\n+reached its maximum age. If your database terminates idle connections after\n+some time, you should set :setting:`CONN_MAX_AGE` to a lower value, so that\n+Django doesn't attempt to use a connection that has been terminated by the\n+database server. (This problem may only affect very low traffic sites.)\n+\n+At the end of each request, Django closes the connection if it has reached its\n+maximum age or if it is in an unrecoverable error state. If any database\n+errors have occurred while processing the requests, Django checks whether the\n+connection still works, and closes it if it doesn't. Thus, database errors\n+affect at most one request; if the connection becomes unusable, the next\n+request gets a fresh connection.\n+\n+Caveats\n+~~~~~~~\n+\n+Since each thread maintains its own connection, your database must support at\n+least as many simultaneous connections as you have worker threads.\n+\n+Sometimes a database won't be accessed by the majority of your views, for\n+example because it's the database of an external system, or thanks to caching.\n+In such cases, you should set :setting:`CONN_MAX_AGE` to a lower value, or\n+even ``0``, because it doesn't make sense to maintain a connection that's\n+unlikely to be reused. This will help keep the number of simultaneous\n+connections to this database small.\n+\n+\n+The development server creates a new thread for each request it handles,\n+negating the effect of persistent connections.\n+\n .. _postgresql-notes:\n \n PostgreSQL notes"
        },
        {
            "sha": "baeb02c32d4d6d9b7e45f9ba09dfdb22f255bbd3",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -464,6 +464,19 @@ The name of the database to use. For SQLite, it's the full path to the database\n file. When specifying the path, always use forward slashes, even on Windows\n (e.g. ``C:/homes/user/mysite/sqlite3.db``).\n \n+.. setting:: CONN_MAX_AGE\n+\n+CONN_MAX_AGE\n+~~~~~~~~~~~~\n+\n+.. versionadded:: 1.6\n+\n+Default: ``600``\n+\n+The lifetime of a database connection, in seconds. Use ``0`` to close database\n+connections at the end of each request — Django's historical behavior — and\n+``None`` for unlimited persistent connections.\n+\n .. setting:: OPTIONS\n \n OPTIONS"
        },
        {
            "sha": "34fa687290bcf6e5c5290779a7a85c995fcf7a7f",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -30,6 +30,19 @@ prevention <clickjacking-prevention>` are turned on.\n If the default templates don't suit your tastes, you can use :ref:`custom\n project and app templates <custom-app-and-project-templates>`.\n \n+Persistent database connections\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django now supports reusing the same database connection for several requests.\n+This avoids the overhead of re-establishing a connection at the beginning of\n+each request.\n+\n+By default, database connections will kept open for 10 minutes. This behavior\n+is controlled by the :setting:`CONN_MAX_AGE` setting. To restore the previous\n+behavior of closing the connection at the end of each request, set\n+:setting:`CONN_MAX_AGE` to ``0``. See :ref:`persistent-database-connections`\n+for details.\n+\n Time zone aware aggregation\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -136,6 +149,14 @@ Backwards incompatible changes in 1.6\n * Model fields named ``hour``, ``minute`` or ``second`` may clash with the new\n   lookups. Append an explicit :lookup:`exact` lookup if this is an issue.\n \n+* When Django establishes a connection to the database, it sets up appropriate\n+  parameters, depending on the backend being used. Since `persistent database\n+  connections <persistent-database-connections>`_ are enabled by default in\n+  Django 1.6, this setup isn't repeated at every request any more. If you\n+  modifiy parameters such as the connection's isolation level or time zone,\n+  you should either restore Django's defaults at the end of each request, or\n+  force an appropriate value at the beginning of each request.\n+\n * If your CSS/Javascript code used to access HTML input widgets by type, you\n   should review it as ``type='text'`` widgets might be now output as\n   ``type='email'``, ``type='url'`` or ``type='number'`` depending on their"
        },
        {
            "sha": "6eb9bd23fe7c9139b6c4130ab43395801e23b814",
            "filename": "tests/handlers/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/tests%2Fhandlers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/tests%2Fhandlers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fhandlers%2Ftests.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -1,12 +1,19 @@\n from django.core.handlers.wsgi import WSGIHandler\n-from django.core import signals\n+from django.core.signals import request_started, request_finished\n+from django.db import close_old_connections\n from django.test import RequestFactory, TestCase\n from django.test.utils import override_settings\n from django.utils import six\n \n \n class HandlerTests(TestCase):\n \n+    def setUp(self):\n+        request_started.disconnect(close_old_connections)\n+\n+    def tearDown(self):\n+        request_started.connect(close_old_connections)\n+\n     # Mangle settings so the handler will fail\n     @override_settings(MIDDLEWARE_CLASSES=42)\n     def test_lock_safety(self):\n@@ -35,12 +42,12 @@ class SignalsTests(TestCase):\n \n     def setUp(self):\n         self.signals = []\n-        signals.request_started.connect(self.register_started)\n-        signals.request_finished.connect(self.register_finished)\n+        request_started.connect(self.register_started)\n+        request_finished.connect(self.register_finished)\n \n     def tearDown(self):\n-        signals.request_started.disconnect(self.register_started)\n-        signals.request_finished.disconnect(self.register_finished)\n+        request_started.disconnect(self.register_started)\n+        request_finished.disconnect(self.register_finished)\n \n     def register_started(self, **kwargs):\n         self.signals.append('started')"
        },
        {
            "sha": "194232e92fac53d3014085a7ecd9b0b2386c1961",
            "filename": "tests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/tests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/tests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fhttpwrappers%2Ftests.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -8,7 +8,7 @@\n \n from django.core.exceptions import SuspiciousOperation\n from django.core.signals import request_finished\n-from django.db import close_connection\n+from django.db import close_old_connections\n from django.http import (QueryDict, HttpResponse, HttpResponseRedirect,\n                          HttpResponsePermanentRedirect, HttpResponseNotAllowed,\n                          HttpResponseNotModified, StreamingHttpResponse,\n@@ -490,10 +490,10 @@ class FileCloseTests(TestCase):\n     def setUp(self):\n         # Disable the request_finished signal during this test\n         # to avoid interfering with the database connection.\n-        request_finished.disconnect(close_connection)\n+        request_finished.disconnect(close_old_connections)\n \n     def tearDown(self):\n-        request_finished.connect(close_connection)\n+        request_finished.connect(close_old_connections)\n \n     def test_response(self):\n         filename = os.path.join(os.path.dirname(upath(__file__)), 'abc.txt')"
        },
        {
            "sha": "a66258d4eb884776843a5134109857e24009da16",
            "filename": "tests/wsgi/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/tests%2Fwsgi%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5/tests%2Fwsgi%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fwsgi%2Ftests.py?ref=2ee21d9f0d9eaed0494f3b9cd4b5bc9beffffae5",
            "patch": "@@ -2,7 +2,9 @@\n \n from django.core.exceptions import ImproperlyConfigured\n from django.core.servers.basehttp import get_internal_wsgi_application\n+from django.core.signals import request_started\n from django.core.wsgi import get_wsgi_application\n+from django.db import close_old_connections\n from django.test import TestCase\n from django.test.client import RequestFactory\n from django.test.utils import override_settings\n@@ -12,6 +14,12 @@\n class WSGITest(TestCase):\n     urls = \"wsgi.urls\"\n \n+    def setUp(self):\n+        request_started.disconnect(close_old_connections)\n+\n+    def tearDown(self):\n+        request_started.connect(close_old_connections)\n+\n     def test_get_wsgi_application(self):\n         \"\"\"\n         Verify that ``get_wsgi_application`` returns a functioning WSGI"
        }
    ],
    "stats": {
        "total": 245,
        "additions": 220,
        "deletions": 25
    }
}