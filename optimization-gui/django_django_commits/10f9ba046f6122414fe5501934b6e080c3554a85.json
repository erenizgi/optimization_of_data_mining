{
    "author": "akaariai",
    "message": "Cleaned up join promotion in query.combine() with OR\n\nRefs #19849",
    "sha": "10f9ba046f6122414fe5501934b6e080c3554a85",
    "files": [
        {
            "sha": "64a3e7075befd15867fe69e364f677b975a9b172",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 7,
            "deletions": 23,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/10f9ba046f6122414fe5501934b6e080c3554a85/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/10f9ba046f6122414fe5501934b6e080c3554a85/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=10f9ba046f6122414fe5501934b6e080c3554a85",
            "patch": "@@ -524,31 +524,15 @@ def combine(self, rhs, connector):\n                 # the join type for the unused alias.\n                 self.unref_alias(new_alias)\n \n-        # So that we don't exclude valid results in an \"or\" query combination,\n+        # So that we don't exclude valid results in an OR query combination,\n         # all joins exclusive to either the lhs or the rhs must be converted\n-        # to an outer join.\n+        # to an outer join. RHS joins were already set to outer joins above,\n+        # so check which joins were used only in the lhs query.\n         if not conjunction:\n-            l_tables = set(self.tables)\n-            r_tables = set(rhs.tables)\n-            # Update r_tables aliases.\n-            for alias in change_map:\n-                if alias in r_tables:\n-                    # r_tables may contain entries that have a refcount of 0\n-                    # if the query has references to a table that can be\n-                    # trimmed because only the foreign key is used.\n-                    # We only need to fix the aliases for the tables that\n-                    # actually have aliases.\n-                    if rhs.alias_refcount[alias]:\n-                        r_tables.remove(alias)\n-                        r_tables.add(change_map[alias])\n-            # Find aliases that are exclusive to rhs or lhs.\n-            # These are promoted to outer joins.\n-            outer_tables = (l_tables | r_tables) - (l_tables & r_tables)\n-            for alias in outer_tables:\n-                # Again, some of the tables won't have aliases due to\n-                # the trimming of unnecessary tables.\n-                if self.alias_refcount.get(alias) or rhs.alias_refcount.get(alias):\n-                    self.promote_joins([alias], True)\n+            rhs_used_joins = set(change_map.values())\n+            to_promote = [alias for alias in self.tables\n+                          if alias not in rhs_used_joins]\n+            self.promote_joins(to_promote, True)\n \n         # Now relabel a copy of the rhs where-clause and add it to the current\n         # one."
        }
    ],
    "stats": {
        "total": 30,
        "additions": 7,
        "deletions": 23
    }
}