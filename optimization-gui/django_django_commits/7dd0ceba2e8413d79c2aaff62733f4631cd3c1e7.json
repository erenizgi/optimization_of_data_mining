{
    "author": "jezdez",
    "message": "Fixed #17720 -- Stopped the LocaleMiddleware from overeagerly using the request path for language activation if it's actually not wanted. Thanks to Anssi Kääriäinen for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17547 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
    "files": [
        {
            "sha": "2a71f3d150934eb5216364fc18d79271174a0d52",
            "filename": "django/middleware/locale.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Fmiddleware%2Flocale.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Fmiddleware%2Flocale.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Flocale.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -15,7 +15,9 @@ class LocaleMiddleware(object):\n     \"\"\"\n \n     def process_request(self, request):\n-        language = translation.get_language_from_request(request)\n+        check_path = self.is_language_prefix_patterns_used()\n+        language = translation.get_language_from_request(\n+            request, check_path=check_path)\n         translation.activate(language)\n         request.LANGUAGE_CODE = translation.get_language()\n "
        },
        {
            "sha": "dbe48239d087c5f82471f19b831b28ad0ef92c13",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -144,8 +144,8 @@ def check_for_language(lang_code):\n def to_locale(language):\n     return _trans.to_locale(language)\n \n-def get_language_from_request(request):\n-    return _trans.get_language_from_request(request)\n+def get_language_from_request(request, check_path=False):\n+    return _trans.get_language_from_request(request, check_path)\n \n def get_language_from_path(path):\n     return _trans.get_language_from_path(path)"
        },
        {
            "sha": "0fabc707ce244339e1d155a650755101faaf5bd4",
            "filename": "django/utils/translation/trans_null.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Futils%2Ftranslation%2Ftrans_null.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Futils%2Ftranslation%2Ftrans_null.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_null.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -55,7 +55,7 @@ def to_locale(language):\n     else:\n         return language.lower()\n \n-def get_language_from_request(request):\n+def get_language_from_request(request, check_path=False):\n     return settings.LANGUAGE_CODE\n \n def get_language_from_path(request):"
        },
        {
            "sha": "82072b139743d4537ec9b7b32524266e38f90b0e",
            "filename": "django/utils/translation/trans_real.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_real.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -363,20 +363,24 @@ def get_language_from_path(path, supported=None):\n         if lang_code in supported and check_for_language(lang_code):\n             return lang_code\n \n-def get_language_from_request(request):\n+def get_language_from_request(request, check_path=False):\n     \"\"\"\n     Analyzes the request to find what language the user wants the system to\n     show. Only languages listed in settings.LANGUAGES are taken into account.\n     If the user requests a sublanguage where we have a main language, we send\n     out the main language.\n+\n+    If check_path is True, the URL path prefix will be checked for a language\n+    code, otherwise this is skipped for backwards compatibility.\n     \"\"\"\n     global _accepted\n     from django.conf import settings\n     supported = dict(settings.LANGUAGES)\n \n-    lang_code = get_language_from_path(request.path_info, supported)\n-    if lang_code is not None:\n-        return lang_code\n+    if check_path:\n+        lang_code = get_language_from_path(request.path_info, supported)\n+        if lang_code is not None:\n+            return lang_code\n \n     if hasattr(request, 'session'):\n         lang_code = request.session.get('django_language', None)"
        },
        {
            "sha": "1cc4520358895f85eb5c08a9baf80a6f457c5837",
            "filename": "tests/regressiontests/i18n/patterns/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -78,6 +78,20 @@ def test_prefixed_i18n_disabled(self):\n             self.assertEqual(reverse('prefixed'), '/prefixed/')\n \n \n+class PathUnusedTests(URLTestCaseBase):\n+    \"\"\"\n+    Check that if no i18n_patterns is used in root urlconfs, then no\n+    language activation happens based on url prefix.\n+    \"\"\"\n+    urls = 'regressiontests.i18n.patterns.urls.path_unused'\n+\n+    def test_no_lang_activate(self):\n+        response = self.client.get('/nl/foo/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response['content-language'], 'en')\n+        self.assertEqual(response.context['LANGUAGE_CODE'], 'en')\n+\n+\n class URLTranslationTests(URLTestCaseBase):\n     \"\"\"\n     Tests if the pattern-strings are translated correctly (within the"
        },
        {
            "sha": "1254d16c4e176a58c1a20487d3f11f36c8056c00",
            "filename": "tests/regressiontests/i18n/patterns/urls/path_unused.py",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fpath_unused.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fpath_unused.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fpath_unused.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -0,0 +1,10 @@\n+from django.conf.urls import url\n+from django.conf.urls import patterns\n+from django.views.generic import TemplateView\n+\n+\n+view = TemplateView.as_view(template_name='dummy.html')\n+\n+urlpatterns = patterns('',\n+    url(r'^nl/foo/', view, name='not-translated'),\n+)"
        },
        {
            "sha": "99a55bd24d33e2461b66bd855fce5fc07532a6d6",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=7dd0ceba2e8413d79c2aaff62733f4631cd3c1e7",
            "patch": "@@ -39,7 +39,7 @@\n from .patterns.tests import (URLRedirectWithoutTrailingSlashTests,\n     URLTranslationTests, URLDisabledTests, URLTagTests, URLTestCaseBase,\n     URLRedirectWithoutTrailingSlashSettingTests, URLNamespaceTests,\n-    URLPrefixTests, URLResponseTests, URLRedirectTests)\n+    URLPrefixTests, URLResponseTests, URLRedirectTests, PathUnusedTests)\n from .test_warnings import DeprecationWarningTests\n \n "
        }
    ],
    "stats": {
        "total": 48,
        "additions": 39,
        "deletions": 9
    }
}