{
    "author": "unknown",
    "message": "Add sqldropindexes to manage\n\nChange patch from https://code.djangoproject.com/ticket/5568\nto work on modern Django.\nAdd special case for MySQL which has different syntax for DROP INDEX.\nAdd unit tests for the new functionality.",
    "sha": "d7429defe6f8d1dce49976cf49827d18ff6be025",
    "files": [
        {
            "sha": "fce77211fb9a26a0f27cef241011112c5491bc10",
            "filename": "django/core/management/commands/sqldropindexes.py",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fcore%2Fmanagement%2Fcommands%2Fsqldropindexes.py",
            "raw_url": "https://github.com/django/django/raw/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fcore%2Fmanagement%2Fcommands%2Fsqldropindexes.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fsqldropindexes.py?ref=d7429defe6f8d1dce49976cf49827d18ff6be025",
            "patch": "@@ -0,0 +1,23 @@\n+from __future__ import unicode_literals\n+\n+from optparse import make_option\n+\n+from django.core.management.base import AppCommand\n+from django.core.management.sql import sql_destroy_indexes\n+from django.db import connections, DEFAULT_DB_ALIAS\n+\n+class Command(AppCommand):\n+    help = \"Prints the DROP INDEX SQL statements for the given model module name(s).\"\n+\n+    option_list = AppCommand.option_list + (\n+        make_option('--database', action='store', dest='database',\n+            default=DEFAULT_DB_ALIAS, help='Nominates a database to print the '\n+                'SQL for.  Defaults to the \"default\" database.'),\n+\n+    )\n+\n+    output_transaction = True\n+\n+    def handle_app(self, app, **options):\n+        return '\\n'.join(sql_destroy_indexes(app, self.style, connections[options.get('database')]))\n+"
        },
        {
            "sha": "ac60ed470c6cd484f8d6dcd5d99628b46f6f5f1c",
            "filename": "django/core/management/sql.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fcore%2Fmanagement%2Fsql.py",
            "raw_url": "https://github.com/django/django/raw/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fcore%2Fmanagement%2Fsql.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fsql.py?ref=d7429defe6f8d1dce49976cf49827d18ff6be025",
            "patch": "@@ -137,6 +137,13 @@ def sql_indexes(app, style, connection):\n         output.extend(connection.creation.sql_indexes_for_model(model, style))\n     return output\n \n+def sql_destroy_indexes(app, style, connection):\n+    \"Returns a list of the DROP INDEX SQL statements for all models in the given app.\"\n+    output = []\n+    for model in models.get_models(app):\n+        output.extend(connection.creation.sql_destroy_indexes_for_model(model, style))\n+    return output\n+\n \n def sql_all(app, style, connection):\n     \"Returns a list of CREATE TABLE SQL, initial-data inserts, and CREATE INDEX SQL for the given module.\""
        },
        {
            "sha": "77c9e6c9e636991029b0d3c95e3ccc36115a5bbc",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=d7429defe6f8d1dce49976cf49827d18ff6be025",
            "patch": "@@ -259,6 +259,52 @@ def sql_remove_table_constraints(self, model, references_to_delete, style):\n         del references_to_delete[model]\n         return output\n \n+    def sql_destroy_indexes_for_model(self, model, style):\n+        \"\"\"\n+        Returns the DROP INDEX SQL statements for a single model.\n+        \"\"\"\n+        if not model._meta.managed or model._meta.proxy or model._meta.swapped:\n+            return []\n+        output = []\n+        for f in model._meta.local_fields:\n+            output.extend(self.sql_destroy_indexes_for_field(model, f, style))\n+        for fs in model._meta.index_together:\n+            fields = [model._meta.get_field_by_name(f)[0] for f in fs]\n+            output.extend(self.sql_destroy_indexes_for_fields(model, fields, style))\n+        return output\n+\n+    def sql_destroy_indexes_for_field(self, model, f, style):\n+        \"\"\"\n+        Return the DROP INDEX SQL statements for a single model field.\n+        \"\"\"\n+        if f.db_index and not f.unique:\n+            return self.sql_destroy_indexes_for_fields(model, [f], style)\n+        else:\n+            return []\n+\n+    def sql_destroy_indexes_for_fields(self, model, fields, style):\n+        if len(fields) == 1 and fields[0].db_tablespace:\n+            tablespace_sql = self.connection.ops.tablespace_sql(fields[0].db_tablespace)\n+        elif model._meta.db_tablespace:\n+            tablespace_sql = self.connection.ops.tablespace_sql(model._meta.db_tablespace)\n+        else:\n+            tablespace_sql = \"\"\n+        if tablespace_sql:\n+            tablespace_sql = \" \" + tablespace_sql\n+\n+        field_names = []\n+        qn = self.connection.ops.quote_name\n+        for f in fields:\n+            field_names.append(style.SQL_FIELD(qn(f.column)))\n+\n+        index_name = \"%s_%s\" % (model._meta.db_table, self._digest([f.name for f in fields]))\n+\n+        return [\n+            style.SQL_KEYWORD(\"DROP INDEX\") + \" \" +\n+            style.SQL_TABLE(qn(truncate_name(index_name, self.connection.ops.max_name_length()))) + \" \" +\n+            \";\",\n+        ]\n+\n     def create_test_db(self, verbosity=1, autoclobber=False):\n         \"\"\"\n         Creates a test database, prompting the user for confirmation if the"
        },
        {
            "sha": "01efe8d35b6bd6aac04a59ff92e933a959248fbd",
            "filename": "django/db/backends/mysql/creation.py",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fdb%2Fbackends%2Fmysql%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/d7429defe6f8d1dce49976cf49827d18ff6be025/django%2Fdb%2Fbackends%2Fmysql%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fcreation.py?ref=d7429defe6f8d1dce49976cf49827d18ff6be025",
            "patch": "@@ -41,3 +41,29 @@ def sql_table_creation_suffix(self):\n     def sql_for_inline_foreign_key_references(self, model, field, known_models, style):\n         \"All inline references are pending under MySQL\"\n         return [], True\n+\n+    def sql_destroy_indexes_for_fields(self, model, fields, style):\n+        if len(fields) == 1 and fields[0].db_tablespace:\n+            tablespace_sql = self.connection.ops.tablespace_sql(fields[0].db_tablespace)\n+        elif model._meta.db_tablespace:\n+            tablespace_sql = self.connection.ops.tablespace_sql(model._meta.db_tablespace)\n+        else:\n+            tablespace_sql = \"\"\n+        if tablespace_sql:\n+            tablespace_sql = \" \" + tablespace_sql\n+\n+        field_names = []\n+        qn = self.connection.ops.quote_name\n+        for f in fields:\n+            field_names.append(style.SQL_FIELD(qn(f.column)))\n+\n+        index_name = \"%s_%s\" % (model._meta.db_table, self._digest([f.name for f in fields]))\n+\n+        from ..util import truncate_name\n+\n+        return [\n+            style.SQL_KEYWORD(\"DROP INDEX\") + \" \" +\n+            style.SQL_TABLE(qn(truncate_name(index_name, self.connection.ops.max_name_length()))) + \" \" +\n+            style.SQL_KEYWORD(\"ON\") + \" \" +\n+            style.SQL_TABLE(qn(model._meta.db_table)) + \";\",\n+        ]"
        },
        {
            "sha": "4fdb793feb0b8fa46885e0024c77ba774566fc79",
            "filename": "tests/regressiontests/bash_completion/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/d7429defe6f8d1dce49976cf49827d18ff6be025/tests%2Fregressiontests%2Fbash_completion%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d7429defe6f8d1dce49976cf49827d18ff6be025/tests%2Fregressiontests%2Fbash_completion%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbash_completion%2Ftests.py?ref=d7429defe6f8d1dce49976cf49827d18ff6be025",
            "patch": "@@ -66,7 +66,7 @@ def test_subcommands(self):\n         \"Subcommands can be autocompleted\"\n         self._user_input('django-admin.py sql')\n         output = self._run_autocomplete()\n-        self.assertEqual(output, ['sql sqlall sqlclear sqlcustom sqlflush sqlindexes sqlinitialdata sqlsequencereset'])\n+        self.assertEqual(output, ['sql sqlall sqlclear sqlcustom sqldropindexes sqlflush sqlindexes sqlinitialdata sqlsequencereset'])\n \n     def test_help(self):\n         \"No errors, just an empty list if there are no autocomplete options\""
        },
        {
            "sha": "949032ae6f08a9869e1b78de2344a4c1c17e0183",
            "filename": "tests/regressiontests/commands_sql/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/d7429defe6f8d1dce49976cf49827d18ff6be025/tests%2Fregressiontests%2Fcommands_sql%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d7429defe6f8d1dce49976cf49827d18ff6be025/tests%2Fregressiontests%2Fcommands_sql%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcommands_sql%2Ftests.py?ref=d7429defe6f8d1dce49976cf49827d18ff6be025",
            "patch": "@@ -2,7 +2,7 @@\n \n from django.core.management.color import no_style\n from django.core.management.sql import (sql_create, sql_delete, sql_indexes,\n-    sql_all)\n+    sql_destroy_indexes, sql_all)\n from django.db import connections, DEFAULT_DB_ALIAS, models\n from django.test import TestCase\n from django.utils import six\n@@ -36,6 +36,13 @@ def test_sql_indexes(self):\n         self.assertIn(len(output), [1, 2])\n         self.assertTrue(output[0].startswith(\"CREATE INDEX\"))\n \n+    def test_sql_destroy_indexes(self):\n+        app = models.get_app('commands_sql')\n+        output = sql_destroy_indexes(app, no_style(), connections[DEFAULT_DB_ALIAS])\n+        # PostgreSQL creates two indexes\n+        self.assertIn(len(output), [1, 2])\n+        self.assertTrue(output[0].startswith(\"DROP INDEX\"))\n+\n     def test_sql_all(self):\n         app = models.get_app('commands_sql')\n         output = sql_all(app, no_style(), connections[DEFAULT_DB_ALIAS])"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 111,
        "deletions": 2
    }
}