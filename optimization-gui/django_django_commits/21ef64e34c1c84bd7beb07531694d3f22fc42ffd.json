{
    "author": "spookylukey",
    "message": "Removed Django 1.1 fallback for CSRF checks.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15948 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "21ef64e34c1c84bd7beb07531694d3f22fc42ffd",
    "files": [
        {
            "sha": "a16a17427bf1e590d499743f5fbb7d0efc7b99c5",
            "filename": "django/middleware/csrf.py",
            "status": "modified",
            "additions": 23,
            "deletions": 52,
            "changes": 75,
            "blob_url": "https://github.com/django/django/blob/21ef64e34c1c84bd7beb07531694d3f22fc42ffd/django%2Fmiddleware%2Fcsrf.py",
            "raw_url": "https://github.com/django/django/raw/21ef64e34c1c84bd7beb07531694d3f22fc42ffd/django%2Fmiddleware%2Fcsrf.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcsrf.py?ref=21ef64e34c1c84bd7beb07531694d3f22fc42ffd",
            "patch": "@@ -34,7 +34,6 @@\n \n REASON_NO_REFERER = \"Referer checking failed - no Referer.\"\n REASON_BAD_REFERER = \"Referer checking failed - %s does not match %s.\"\n-REASON_NO_COOKIE = \"No CSRF or session cookie.\"\n REASON_NO_CSRF_COOKIE = \"CSRF cookie not set.\"\n REASON_BAD_TOKEN = \"CSRF token missing or incorrect.\"\n \n@@ -105,22 +104,14 @@ def process_view(self, request, callback, callback_args, callback_kwargs):\n         if getattr(request, 'csrf_processing_done', False):\n             return None\n \n-        # If the user doesn't have a CSRF cookie, generate one and store it in the\n-        # request, so it's available to the view.  We'll store it in a cookie when\n-        # we reach the response.\n         try:\n-            # In case of cookies from untrusted sources, we strip anything\n-            # dangerous at this point, so that the cookie + token will have the\n-            # same, sanitized value.\n-            request.META[\"CSRF_COOKIE\"] = _sanitize_token(request.COOKIES[settings.CSRF_COOKIE_NAME])\n-            cookie_is_new = False\n+            csrf_token = _sanitize_token(request.COOKIES[settings.CSRF_COOKIE_NAME])\n+            # Use same token next time\n+            request.META['CSRF_COOKIE'] = csrf_token\n         except KeyError:\n-            # No cookie, so create one.  This will be sent with the next\n-            # response.\n+            csrf_token = None\n+            # Generate token and store it in the request, so it's available to the view.\n             request.META[\"CSRF_COOKIE\"] = _get_new_csrf_key()\n-            # Set a flag to allow us to fall back and allow the session id in\n-            # place of a CSRF cookie for this request only.\n-            cookie_is_new = True\n \n         # Wait until request.META[\"CSRF_COOKIE\"] has been manipulated before\n         # bailing out, so that get_token still works\n@@ -173,27 +164,17 @@ def process_view(self, request, callback, callback_args, callback_kwargs):\n                     )\n                     return self._reject(request, reason)\n \n-            # If the user didn't already have a CSRF cookie, then fall back to\n-            # the Django 1.1 method (hash of session ID), so a request is not\n-            # rejected if the form was sent to the user before upgrading to the\n-            # Django 1.2 method (session independent nonce)\n-            if cookie_is_new:\n-                try:\n-                    session_id = request.COOKIES[settings.SESSION_COOKIE_NAME]\n-                    csrf_token = _make_legacy_session_token(session_id)\n-                except KeyError:\n-                    # No CSRF cookie and no session cookie. For POST requests,\n-                    # we insist on a CSRF cookie, and in this way we can avoid\n-                    # all CSRF attacks, including login CSRF.\n-                    logger.warning('Forbidden (%s): %s' % (REASON_NO_COOKIE, request.path),\n-                        extra={\n-                            'status_code': 403,\n-                            'request': request,\n-                        }\n-                    )\n-                    return self._reject(request, REASON_NO_COOKIE)\n-            else:\n-                csrf_token = request.META[\"CSRF_COOKIE\"]\n+            if csrf_token is None:\n+                # No CSRF cookie. For POST requests, we insist on a CSRF cookie,\n+                # and in this way we can avoid all CSRF attacks, including login\n+                # CSRF.\n+                logger.warning('Forbidden (%s): %s' % (REASON_NO_CSRF_COOKIE, request.path),\n+                    extra={\n+                        'status_code': 403,\n+                        'request': request,\n+                    }\n+                )\n+                return self._reject(request, REASON_NO_CSRF_COOKIE)\n \n             # check incoming token\n             request_csrf_token = request.POST.get('csrfmiddlewaretoken', '')\n@@ -202,23 +183,13 @@ def process_view(self, request, callback, callback_args, callback_kwargs):\n                 request_csrf_token = request.META.get('HTTP_X_CSRFTOKEN', '')\n \n             if not constant_time_compare(request_csrf_token, csrf_token):\n-                if cookie_is_new:\n-                    # probably a problem setting the CSRF cookie\n-                    logger.warning('Forbidden (%s): %s' % (REASON_NO_CSRF_COOKIE, request.path),\n-                        extra={\n-                            'status_code': 403,\n-                            'request': request,\n-                        }\n-                    )\n-                    return self._reject(request, REASON_NO_CSRF_COOKIE)\n-                else:\n-                    logger.warning('Forbidden (%s): %s' % (REASON_BAD_TOKEN, request.path),\n-                        extra={\n-                            'status_code': 403,\n-                            'request': request,\n-                        }\n-                    )\n-                    return self._reject(request, REASON_BAD_TOKEN)\n+                logger.warning('Forbidden (%s): %s' % (REASON_BAD_TOKEN, request.path),\n+                    extra={\n+                        'status_code': 403,\n+                        'request': request,\n+                    }\n+                )\n+                return self._reject(request, REASON_BAD_TOKEN)\n \n         return self._accept(request)\n "
        },
        {
            "sha": "ba1760aa911a814193dbd6609b2ccc2961a54329",
            "filename": "tests/regressiontests/csrf_tests/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 47,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/21ef64e34c1c84bd7beb07531694d3f22fc42ffd/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/21ef64e34c1c84bd7beb07531694d3f22fc42ffd/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py?ref=21ef64e34c1c84bd7beb07531694d3f22fc42ffd",
            "patch": "@@ -6,8 +6,6 @@\n from django.middleware.csrf import CsrfMiddleware, CsrfViewMiddleware\n from django.views.decorators.csrf import csrf_exempt, csrf_view_exempt, requires_csrf_token\n from django.core.context_processors import csrf\n-from django.contrib.sessions.middleware import SessionMiddleware\n-from django.utils.importlib import import_module\n from django.conf import settings\n from django.template import RequestContext, Template\n \n@@ -62,14 +60,6 @@ class CsrfMiddlewareTest(TestCase):\n     _csrf_id_cookie = \"<1>\\xc2\\xa1\"\n     _csrf_id = \"1\"\n \n-    # This is a valid session token for this ID and secret key.  This was generated using\n-    # the old code that we're to be backwards-compatible with.  Don't use the CSRF code\n-    # to generate this hash, or we're merely testing the code against itself and not\n-    # checking backwards-compatibility.  This is also the output of (echo -n test1 | md5sum).\n-    _session_token = \"5a105e8b9d40e1329780d62ea2265d8a\"\n-    _session_id = \"1\"\n-    _secret_key_for_session_test= \"test\"\n-\n     def setUp(self):\n         self.save_warnings_state()\n         warnings.filterwarnings('ignore', category=DeprecationWarning,\n@@ -101,17 +91,6 @@ def _get_POST_request_with_token(self):\n         req.POST['csrfmiddlewaretoken'] = self._csrf_id\n         return req\n \n-    def _get_POST_session_request_with_token(self):\n-        req = self._get_POST_no_csrf_cookie_request()\n-        req.COOKIES[settings.SESSION_COOKIE_NAME] = self._session_id\n-        req.POST['csrfmiddlewaretoken'] = self._session_token\n-        return req\n-\n-    def _get_POST_session_request_no_token(self):\n-        req = self._get_POST_no_csrf_cookie_request()\n-        req.COOKIES[settings.SESSION_COOKIE_NAME] = self._session_id\n-        return req\n-\n     def _check_token_present(self, response, csrf_id=None):\n         self.assertContains(response, \"name='csrfmiddlewaretoken' value='%s'\" % (csrf_id or self._csrf_id))\n \n@@ -226,10 +205,10 @@ def test_process_response_exempt_view(self):\n         self.assertEqual(resp_content, resp2.content)\n \n     # Check the request processing\n-    def test_process_request_no_session_no_csrf_cookie(self):\n+    def test_process_request_no_csrf_cookie(self):\n         \"\"\"\n-        Check that if neither a CSRF cookie nor a session cookie are present,\n-        the middleware rejects the incoming request.  This will stop login CSRF.\n+        Check that if no CSRF cookies is present, the middleware rejects the\n+        incoming request.  This will stop login CSRF.\n         \"\"\"\n         req = self._get_POST_no_csrf_cookie_request()\n         req2 = CsrfMiddleware().process_view(req, post_form_view, (), {})\n@@ -252,29 +231,6 @@ def test_process_request_csrf_cookie_and_token(self):\n         req2 = CsrfMiddleware().process_view(req, post_form_view, (), {})\n         self.assertEqual(None, req2)\n \n-    def test_process_request_session_cookie_no_csrf_cookie_token(self):\n-        \"\"\"\n-        When no CSRF cookie exists, but the user has a session, check that a token\n-        using the session cookie as a legacy CSRF cookie is accepted.\n-        \"\"\"\n-        orig_secret_key = settings.SECRET_KEY\n-        settings.SECRET_KEY = self._secret_key_for_session_test\n-        try:\n-            req = self._get_POST_session_request_with_token()\n-            req2 = CsrfMiddleware().process_view(req, post_form_view, (), {})\n-            self.assertEqual(None, req2)\n-        finally:\n-            settings.SECRET_KEY = orig_secret_key\n-\n-    def test_process_request_session_cookie_no_csrf_cookie_no_token(self):\n-        \"\"\"\n-        Check that if a session cookie is present but no token and no CSRF cookie,\n-        the request is rejected.\n-        \"\"\"\n-        req = self._get_POST_session_request_no_token()\n-        req2 = CsrfMiddleware().process_view(req, post_form_view, (), {})\n-        self.assertEqual(403, req2.status_code)\n-\n     def test_process_request_csrf_cookie_no_token_exempt_view(self):\n         \"\"\"\n         Check that if a CSRF cookie is present and no token, but the csrf_exempt"
        }
    ],
    "stats": {
        "total": 125,
        "additions": 26,
        "deletions": 99
    }
}