{
    "author": "aaugustin",
    "message": "Fixed timezone tests when dict randomization is on\n\nRefs #17758.",
    "sha": "1d6b7f302a56fd6064f91d67c26c149c547de57b",
    "files": [
        {
            "sha": "2fdf6733a00e30f0a13297b194ea52ab7b87ab55",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "modified",
            "additions": 38,
            "deletions": 24,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/1d6b7f302a56fd6064f91d67c26c149c547de57b/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1d6b7f302a56fd6064f91d67c26c149c547de57b/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=1d6b7f302a56fd6064f91d67c26c149c547de57b",
            "patch": "@@ -5,6 +5,7 @@\n import sys\n import time\n import warnings\n+from xml.dom.minidom import parseString\n \n try:\n     import pytz\n@@ -492,147 +493,160 @@ class SerializationTests(TestCase):\n     #   returns a naive datetime object in UTC (http://pyyaml.org/ticket/202).\n     # Tests are adapted to take these quirks into account.\n \n+    def assert_python_contains_datetime(self, objects, dt):\n+        self.assertEqual(objects[0]['fields']['dt'], dt)\n+\n+    def assert_json_contains_datetime(self, json, dt):\n+        self.assertIn('\"fields\": {\"dt\": \"%s\"}' % dt, json)\n+\n+    def assert_xml_contains_datetime(self, xml, dt):\n+        field = parseString(xml).getElementsByTagName('field')[0]\n+        self.assertXMLEqual(field.childNodes[0].wholeText, dt)\n+\n+    def assert_yaml_contains_datetime(self, yaml, dt):\n+        self.assertIn(\"- fields: {dt: !!timestamp '%s'}\" % dt, yaml)\n+\n     def test_naive_datetime(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n \n         data = serializers.serialize('python', [Event(dt=dt)])\n-        self.assertEqual(data[0]['fields']['dt'], dt)\n+        self.assert_python_contains_datetime(data, dt)\n         obj = next(serializers.deserialize('python', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('json', [Event(dt=dt)])\n-        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T13:20:30\"}', data)\n+        self.assert_json_contains_datetime(data, \"2011-09-01T13:20:30\")\n         obj = next(serializers.deserialize('json', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('xml', [Event(dt=dt)])\n-        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T13:20:30</field>', data)\n+        self.assert_xml_contains_datetime(data, \"2011-09-01T13:20:30\")\n         obj = next(serializers.deserialize('xml', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         if 'yaml' in serializers.get_serializer_formats():\n             data = serializers.serialize('yaml', [Event(dt=dt)])\n-            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 13:20:30'}\", data)\n+            self.assert_yaml_contains_datetime(data, \"2011-09-01 13:20:30\")\n             obj = next(serializers.deserialize('yaml', data)).object\n             self.assertEqual(obj.dt, dt)\n \n     def test_naive_datetime_with_microsecond(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n \n         data = serializers.serialize('python', [Event(dt=dt)])\n-        self.assertEqual(data[0]['fields']['dt'], dt)\n+        self.assert_python_contains_datetime(data, dt)\n         obj = next(serializers.deserialize('python', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('json', [Event(dt=dt)])\n-        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T13:20:30.405\"}', data)\n+        self.assert_json_contains_datetime(data, \"2011-09-01T13:20:30.405\")\n         obj = next(serializers.deserialize('json', data)).object\n         self.assertEqual(obj.dt, dt.replace(microsecond=405000))\n \n         data = serializers.serialize('xml', [Event(dt=dt)])\n-        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T13:20:30.405060</field>', data)\n+        self.assert_xml_contains_datetime(data, \"2011-09-01T13:20:30.405060\")\n         obj = next(serializers.deserialize('xml', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         if 'yaml' in serializers.get_serializer_formats():\n             data = serializers.serialize('yaml', [Event(dt=dt)])\n-            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 13:20:30.405060'}\", data)\n+            self.assert_yaml_contains_datetime(data, \"2011-09-01 13:20:30.405060\")\n             obj = next(serializers.deserialize('yaml', data)).object\n             self.assertEqual(obj.dt, dt)\n \n     def test_aware_datetime_with_microsecond(self):\n         dt = datetime.datetime(2011, 9, 1, 17, 20, 30, 405060, tzinfo=ICT)\n \n         data = serializers.serialize('python', [Event(dt=dt)])\n-        self.assertEqual(data[0]['fields']['dt'], dt)\n+        self.assert_python_contains_datetime(data, dt)\n         obj = next(serializers.deserialize('python', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('json', [Event(dt=dt)])\n-        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T17:20:30.405+07:00\"}', data)\n+        self.assert_json_contains_datetime(data, \"2011-09-01T17:20:30.405+07:00\")\n         obj = next(serializers.deserialize('json', data)).object\n         self.assertEqual(obj.dt, dt.replace(microsecond=405000))\n \n         data = serializers.serialize('xml', [Event(dt=dt)])\n-        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T17:20:30.405060+07:00</field>', data)\n+        self.assert_xml_contains_datetime(data, \"2011-09-01T17:20:30.405060+07:00\")\n         obj = next(serializers.deserialize('xml', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         if 'yaml' in serializers.get_serializer_formats():\n             data = serializers.serialize('yaml', [Event(dt=dt)])\n-            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 17:20:30.405060+07:00'}\", data)\n+            self.assert_yaml_contains_datetime(data, \"2011-09-01 17:20:30.405060+07:00\")\n             obj = next(serializers.deserialize('yaml', data)).object\n             self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n \n     def test_aware_datetime_in_utc(self):\n         dt = datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC)\n \n         data = serializers.serialize('python', [Event(dt=dt)])\n-        self.assertEqual(data[0]['fields']['dt'], dt)\n+        self.assert_python_contains_datetime(data, dt)\n         obj = next(serializers.deserialize('python', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('json', [Event(dt=dt)])\n-        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T10:20:30Z\"}', data)\n+        self.assert_json_contains_datetime(data, \"2011-09-01T10:20:30Z\")\n         obj = next(serializers.deserialize('json', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('xml', [Event(dt=dt)])\n-        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T10:20:30+00:00</field>', data)\n+        self.assert_xml_contains_datetime(data, \"2011-09-01T10:20:30+00:00\")\n         obj = next(serializers.deserialize('xml', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         if 'yaml' in serializers.get_serializer_formats():\n             data = serializers.serialize('yaml', [Event(dt=dt)])\n-            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 10:20:30+00:00'}\", data)\n+            self.assert_yaml_contains_datetime(data, \"2011-09-01 10:20:30+00:00\")\n             obj = next(serializers.deserialize('yaml', data)).object\n             self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n \n     def test_aware_datetime_in_local_timezone(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT)\n \n         data = serializers.serialize('python', [Event(dt=dt)])\n-        self.assertEqual(data[0]['fields']['dt'], dt)\n+        self.assert_python_contains_datetime(data, dt)\n         obj = next(serializers.deserialize('python', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('json', [Event(dt=dt)])\n-        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T13:20:30+03:00\"}', data)\n+        self.assert_json_contains_datetime(data, \"2011-09-01T13:20:30+03:00\")\n         obj = next(serializers.deserialize('json', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('xml', [Event(dt=dt)])\n-        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T13:20:30+03:00</field>', data)\n+        self.assert_xml_contains_datetime(data, \"2011-09-01T13:20:30+03:00\")\n         obj = next(serializers.deserialize('xml', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         if 'yaml' in serializers.get_serializer_formats():\n             data = serializers.serialize('yaml', [Event(dt=dt)])\n-            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 13:20:30+03:00'}\", data)\n+            self.assert_yaml_contains_datetime(data, \"2011-09-01 13:20:30+03:00\")\n             obj = next(serializers.deserialize('yaml', data)).object\n             self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n \n     def test_aware_datetime_in_other_timezone(self):\n         dt = datetime.datetime(2011, 9, 1, 17, 20, 30, tzinfo=ICT)\n \n         data = serializers.serialize('python', [Event(dt=dt)])\n-        self.assertEqual(data[0]['fields']['dt'], dt)\n+        self.assert_python_contains_datetime(data, dt)\n         obj = next(serializers.deserialize('python', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('json', [Event(dt=dt)])\n-        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T17:20:30+07:00\"}', data)\n+        self.assert_json_contains_datetime(data, \"2011-09-01T17:20:30+07:00\")\n         obj = next(serializers.deserialize('json', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         data = serializers.serialize('xml', [Event(dt=dt)])\n-        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T17:20:30+07:00</field>', data)\n+        self.assert_xml_contains_datetime(data, \"2011-09-01T17:20:30+07:00\")\n         obj = next(serializers.deserialize('xml', data)).object\n         self.assertEqual(obj.dt, dt)\n \n         if 'yaml' in serializers.get_serializer_formats():\n             data = serializers.serialize('yaml', [Event(dt=dt)])\n-            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 17:20:30+07:00'}\", data)\n+            self.assert_yaml_contains_datetime(data, \"2011-09-01 17:20:30+07:00\")\n             obj = next(serializers.deserialize('yaml', data)).object\n             self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 38,
        "deletions": 24
    }
}