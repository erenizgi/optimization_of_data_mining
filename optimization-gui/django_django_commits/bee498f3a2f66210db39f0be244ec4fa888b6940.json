{
    "author": "spookylukey",
    "message": "Added 'format_html' utility for formatting HTML fragments safely",
    "sha": "bee498f3a2f66210db39f0be244ec4fa888b6940",
    "files": [
        {
            "sha": "390c45dcecf5d251cdb40ec76d621091e0d38027",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/bee498f3a2f66210db39f0be244ec4fa888b6940/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/bee498f3a2f66210db39f0be244ec4fa888b6940/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=bee498f3a2f66210db39f0be244ec4fa888b6940",
            "patch": "@@ -72,6 +72,37 @@ def conditional_escape(text):\n     else:\n         return escape(text)\n \n+def format_html(format_string, *args, **kwargs):\n+    \"\"\"\n+    Similar to str.format, but passes all arguments through conditional_escape,\n+    and calls 'mark_safe' on the result. This function should be used instead\n+    of str.format or % interpolation to build up small HTML fragments.\n+    \"\"\"\n+    args_safe = map(conditional_escape, args)\n+    kwargs_safe = dict([(k, conditional_escape(v)) for (k, v) in\n+                        kwargs.iteritems()])\n+    return mark_safe(format_string.format(*args_safe, **kwargs_safe))\n+\n+def format_html_join(sep, format_string, args_generator):\n+    \"\"\"\n+    A wrapper format_html, for the common case of a group of arguments that need\n+    to be formatted using the same format string, and then joined using\n+    'sep'. 'sep' is also passed through conditional_escape.\n+\n+    'args_generator' should be an iterator that returns the sequence of 'args'\n+    that will be passed to format_html.\n+\n+    Example:\n+\n+      format_html_join('\\n', \"<li>{0} {1}</li>\", ((u.first_name, u.last_name)\n+                                                  for u in users))\n+\n+    \"\"\"\n+    return mark_safe(conditional_escape(sep).join(\n+            format_html(format_string, *tuple(args))\n+            for args in args_generator))\n+\n+\n def linebreaks(value, autoescape=False):\n     \"\"\"Converts newlines into <p> and <br />s.\"\"\"\n     value = normalize_newlines(value)"
        },
        {
            "sha": "c74392df36b95fed8a1e177e74b480c02f95ce30",
            "filename": "docs/ref/utils.txt",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/bee498f3a2f66210db39f0be244ec4fa888b6940/docs%2Fref%2Futils.txt",
            "raw_url": "https://github.com/django/django/raw/bee498f3a2f66210db39f0be244ec4fa888b6940/docs%2Fref%2Futils.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Futils.txt?ref=bee498f3a2f66210db39f0be244ec4fa888b6940",
            "patch": "@@ -410,6 +410,45 @@ escaping HTML.\n     Similar to ``escape()``, except that it doesn't operate on pre-escaped strings,\n     so it will not double escape.\n \n+.. function:: format_html(format_string, *args, **kwargs)\n+\n+    This is similar to `str.format`_, except that it is appropriate for\n+    building up HTML fragments. All args and kwargs are passed through\n+    :func:`conditional_escape` before being passed to ``str.format``.\n+\n+    For the case of building up small HTML fragments, this function is to be\n+    preferred over string interpolation using ``%`` or ``str.format`` directly,\n+    because it applies escaping to all arguments - just like the Template system\n+    applies escaping by default.\n+\n+    So, instead of writing:\n+\n+    .. code-block:: python\n+\n+        mark_safe(u\"%s <b>%s</b> %s\" % (some_html,\n+                                        escape(some_text),\n+                                        escape(some_other_text),\n+                                        ))\n+\n+    you should instead use:\n+\n+    .. code-block:: python\n+\n+        format_html(u\"%{0} <b>{1}</b> {2}\",\n+                    mark_safe(some_html), some_text, some_other_text)\n+\n+    This has the advantage that you don't need to apply :func:`escape` to each\n+    argument and risk a bug and an XSS vulnerability if you forget one.\n+\n+    Note that although this function uses ``str.format`` to do the\n+    interpolation, some of the formatting options provided by `str.format`_\n+    (e.g. number formatting) will not work, since all arguments are passed\n+    through :func:`conditional_escape` which (ultimately) calls\n+    :func:`~django.utils.encoding.force_unicode` on the values.\n+\n+\n+.. _str.format: http://docs.python.org/library/stdtypes.html#str.format\n+\n ``django.utils.http``\n =====================\n "
        },
        {
            "sha": "389ae8ec755e472169eac8eb4d3a318d14a25018",
            "filename": "tests/regressiontests/utils/html.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/bee498f3a2f66210db39f0be244ec4fa888b6940/tests%2Fregressiontests%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/bee498f3a2f66210db39f0be244ec4fa888b6940/tests%2Fregressiontests%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fhtml.py?ref=bee498f3a2f66210db39f0be244ec4fa888b6940",
            "patch": "@@ -34,6 +34,17 @@ def test_escape(self):\n         # Verify it doesn't double replace &.\n         self.check_output(f, '<&', '&lt;&amp;')\n \n+    def test_format_html(self):\n+        self.assertEqual(\n+            html.format_html(u\"{0} {1} {third} {fourth}\",\n+                             u\"< Dangerous >\",\n+                             html.mark_safe(u\"<b>safe</b>\"),\n+                             third=\"< dangerous again\",\n+                             fourth=html.mark_safe(u\"<i>safe again</i>\")\n+                             ),\n+            u\"&lt; Dangerous &gt; <b>safe</b> &lt; dangerous again <i>safe again</i>\"\n+            )\n+\n     def test_linebreaks(self):\n         f = html.linebreaks\n         items = ("
        }
    ],
    "stats": {
        "total": 81,
        "additions": 81,
        "deletions": 0
    }
}