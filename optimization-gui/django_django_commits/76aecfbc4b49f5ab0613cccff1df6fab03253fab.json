{
    "author": "claudep",
    "message": "Fixed #9055 -- Standardized behaviour of parameter escaping in db cursors\n\nPreviously, depending on the database backend or the cursor type,\nyou'd need to double the percent signs in the query before passing\nit to cursor.execute. Now cursor.execute consistently need percent\ndoubling whenever params argument is not None (placeholder substitution\nwill happen).\nThanks Thomas GÃ¼ttler for the report and Walter Doekes for his work\non the patch.",
    "sha": "76aecfbc4b49f5ab0613cccff1df6fab03253fab",
    "files": [
        {
            "sha": "9acef4ad196e85226e90ee2b12f2b4a215535142",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -815,6 +815,8 @@ def last_executed_query(self, cursor, sql, params):\n         to_unicode = lambda s: force_text(s, strings_only=True, errors='replace')\n         if isinstance(params, (list, tuple)):\n             u_params = tuple(to_unicode(val) for val in params)\n+        elif params is None:\n+            u_params = ()\n         else:\n             u_params = dict((to_unicode(k), to_unicode(v)) for k, v in params.items())\n "
        },
        {
            "sha": "57b6f822709521ac7ac61afce7be9d5704ad81a7",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -115,6 +115,7 @@ def __init__(self, cursor):\n \n     def execute(self, query, args=None):\n         try:\n+            # args is None means no string interpolation\n             return self.cursor.execute(query, args)\n         except Database.OperationalError as e:\n             # Map some error codes to IntegrityError, since they seem to be"
        },
        {
            "sha": "9e69743d3394a0a9103cead1b41a3d3d9eec3992",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -757,18 +757,19 @@ def _param_generator(self, params):\n         return [p.force_bytes for p in params]\n \n     def execute(self, query, params=None):\n-        if params is None:\n-            params = []\n-        else:\n-            params = self._format_params(params)\n-        args = [(':arg%d' % i) for i in range(len(params))]\n         # cx_Oracle wants no trailing ';' for SQL statements.  For PL/SQL, it\n         # it does want a trailing ';' but not a trailing '/'.  However, these\n         # characters must be included in the original query in case the query\n         # is being passed to SQL*Plus.\n         if query.endswith(';') or query.endswith('/'):\n             query = query[:-1]\n-        query = convert_unicode(query % tuple(args), self.charset)\n+        if params is None:\n+            params = []\n+            query = convert_unicode(query, self.charset)\n+        else:\n+            params = self._format_params(params)\n+            args = [(':arg%d' % i) for i in range(len(params))]\n+            query = convert_unicode(query % tuple(args), self.charset)\n         self._guess_input_sizes([params])\n         try:\n             return self.cursor.execute(query, self._param_generator(params))"
        },
        {
            "sha": "ead325a33b1cd8ce5bf30e0f9f1175901fc45aed",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -433,7 +433,9 @@ class SQLiteCursorWrapper(Database.Cursor):\n     This fixes it -- but note that if you want to use a literal \"%s\" in a query,\n     you'll need to use \"%%s\".\n     \"\"\"\n-    def execute(self, query, params=()):\n+    def execute(self, query, params=None):\n+        if params is None:\n+            return Database.Cursor.execute(self, query)\n         query = self.convert_query(query)\n         return Database.Cursor.execute(self, query, params)\n "
        },
        {
            "sha": "b7fb48dca539e9f7193ac4c197e96304b1b1875c",
            "filename": "django/db/backends/util.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/django%2Fdb%2Fbackends%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Futil.py?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -35,11 +35,14 @@ def __iter__(self):\n \n class CursorDebugWrapper(CursorWrapper):\n \n-    def execute(self, sql, params=()):\n+    def execute(self, sql, params=None):\n         self.db.set_dirty()\n         start = time()\n         try:\n             with self.db.wrap_database_errors():\n+                if params is None:\n+                    # params default might be backend specific\n+                    return self.cursor.execute(sql)\n                 return self.cursor.execute(sql, params)\n         finally:\n             stop = time()"
        },
        {
            "sha": "34cfa382d3c71864dac102e2c99bf9656c350823",
            "filename": "docs/topics/db/sql.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/docs%2Ftopics%2Fdb%2Fsql.txt",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/docs%2Ftopics%2Fdb%2Fsql.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Fsql.txt?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -227,6 +227,12 @@ For example::\n     were committed to the database. Since Django now defaults to database-level\n     autocommit, this isn't necessary any longer.\n \n+Note that if you want to include literal percent signs in the query, you have to\n+double them in the case you are passing parameters::\n+\n+     cursor.execute(\"SELECT foo FROM bar WHERE baz = '30%'\")\n+     cursor.execute(\"SELECT foo FROM bar WHERE baz = '30%%' and id = %s\", [self.id])\n+\n If you are using :doc:`more than one database </topics/db/multi-db>`, you can\n use ``django.db.connections`` to obtain the connection (and cursor) for a\n specific database. ``django.db.connections`` is a dictionary-like"
        },
        {
            "sha": "9a5f6c008d0859cde212bfbb720ff14771807c1a",
            "filename": "tests/backends/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 4,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/76aecfbc4b49f5ab0613cccff1df6fab03253fab/tests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/76aecfbc4b49f5ab0613cccff1df6fab03253fab/tests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fbackends%2Ftests.py?ref=76aecfbc4b49f5ab0613cccff1df6fab03253fab",
            "patch": "@@ -361,18 +361,34 @@ def receiver(sender, connection, **kwargs):\n \n \n class EscapingChecks(TestCase):\n+    \"\"\"\n+    All tests in this test case are also run with settings.DEBUG=True in\n+    EscapingChecksDebug test case, to also test CursorDebugWrapper.\n+    \"\"\"\n+    def test_paramless_no_escaping(self):\n+        cursor = connection.cursor()\n+        cursor.execute(\"SELECT '%s'\")\n+        self.assertEqual(cursor.fetchall()[0][0], '%s')\n+\n+    def test_parameter_escaping(self):\n+        cursor = connection.cursor()\n+        cursor.execute(\"SELECT '%%', %s\", ('%d',))\n+        self.assertEqual(cursor.fetchall()[0], ('%', '%d'))\n \n     @unittest.skipUnless(connection.vendor == 'sqlite',\n                          \"This is a sqlite-specific issue\")\n-    def test_parameter_escaping(self):\n+    def test_sqlite_parameter_escaping(self):\n         #13648: '%s' escaping support for sqlite3\n         cursor = connection.cursor()\n-        response = cursor.execute(\n-            \"select strftime('%%s', date('now'))\").fetchall()[0][0]\n-        self.assertNotEqual(response, None)\n+        cursor.execute(\"select strftime('%s', date('now'))\")\n+        response = cursor.fetchall()[0][0]\n         # response should be an non-zero integer\n         self.assertTrue(int(response))\n \n+@override_settings(DEBUG=True)\n+class EscapingChecksDebug(EscapingChecks):\n+    pass\n+\n \n class SqlliteAggregationTests(TestCase):\n     \"\"\""
        }
    ],
    "stats": {
        "total": 55,
        "additions": 43,
        "deletions": 12
    }
}