{
    "author": "jphalip",
    "message": "Fixed #11670 -- Prevented genuine model fields named 'year', 'month', 'gt', 'lt' etc. from being mistaken for lookup types in lookups across relations. Thanks to andy for the report, to jpwatts for the initial patch and to Anssi Kääriäinen and Alex Gaynor for the reviews.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17450 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d02ba7f4ee7c448de28724369fc5dd9cf3e2538a",
    "files": [
        {
            "sha": "a78df343a7b84353bbe87c0eb589d2e218b229ec",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 25,
            "deletions": 5,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/d02ba7f4ee7c448de28724369fc5dd9cf3e2538a/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/d02ba7f4ee7c448de28724369fc5dd9cf3e2538a/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=d02ba7f4ee7c448de28724369fc5dd9cf3e2538a",
            "patch": "@@ -1061,11 +1061,31 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n         if not parts:\n             raise FieldError(\"Cannot parse keyword query %r\" % arg)\n \n-        # Work out the lookup type and remove it from 'parts', if necessary.\n-        if len(parts) == 1 or parts[-1] not in self.query_terms:\n-            lookup_type = 'exact'\n-        else:\n-            lookup_type = parts.pop()\n+        # Work out the lookup type and remove it from the end of 'parts',\n+        # if necessary.\n+        lookup_type = 'exact' # Default lookup type\n+        num_parts = len(parts)\n+        if (len(parts) > 1 and parts[-1] in self.query_terms\n+            and arg not in self.aggregates):\n+            # Traverse the lookup query to distinguish related fields from\n+            # lookup types.\n+            lookup_model = self.model\n+            for counter, field_name in enumerate(parts):\n+                try:\n+                    lookup_field = lookup_model._meta.get_field(field_name)\n+                except FieldDoesNotExist:\n+                    # Not a field. Bail out.\n+                    lookup_type = parts.pop()\n+                    break\n+                # Unless we're at the end of the list of lookups, let's attempt\n+                # to continue traversing relations.\n+                if (counter + 1) < num_parts:\n+                    try:\n+                        lookup_model = lookup_field.rel.to\n+                    except AttributeError:\n+                        # Not a related field. Bail out.\n+                        lookup_type = parts.pop()\n+                        break\n \n         # By default, this is a WHERE clause. If an aggregate is referenced\n         # in the value, the filter will be promoted to a HAVING"
        },
        {
            "sha": "bcdd3d7c68df220dec81446d4ee26783a71dd19a",
            "filename": "tests/modeltests/lookup/models.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/d02ba7f4ee7c448de28724369fc5dd9cf3e2538a/tests%2Fmodeltests%2Flookup%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/d02ba7f4ee7c448de28724369fc5dd9cf3e2538a/tests%2Fmodeltests%2Flookup%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Flookup%2Fmodels.py?ref=d02ba7f4ee7c448de28724369fc5dd9cf3e2538a",
            "patch": "@@ -27,3 +27,25 @@ class Tag(models.Model):\n     name = models.CharField(max_length=100)\n     class Meta:\n         ordering = ('name', )\n+\n+class Season(models.Model):\n+    year = models.PositiveSmallIntegerField()\n+    gt = models.IntegerField(null=True, blank=True)\n+\n+    def __unicode__(self):\n+        return unicode(self.year)\n+\n+class Game(models.Model):\n+    season = models.ForeignKey(Season, related_name='games')\n+    home = models.CharField(max_length=100)\n+    away = models.CharField(max_length=100)\n+\n+    def __unicode__(self):\n+        return u\"%s at %s\" % (self.away, self.home)\n+\n+class Player(models.Model):\n+    name = models.CharField(max_length=100)\n+    games = models.ManyToManyField(Game, related_name='players')\n+\n+    def __unicode__(self):\n+        return self.name\n\\ No newline at end of file"
        },
        {
            "sha": "3571e216be14ab40b5aa23132ccc7f8df9bdbf11",
            "filename": "tests/modeltests/lookup/tests.py",
            "status": "modified",
            "additions": 79,
            "deletions": 3,
            "changes": 82,
            "blob_url": "https://github.com/django/django/blob/d02ba7f4ee7c448de28724369fc5dd9cf3e2538a/tests%2Fmodeltests%2Flookup%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d02ba7f4ee7c448de28724369fc5dd9cf3e2538a/tests%2Fmodeltests%2Flookup%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Flookup%2Ftests.py?ref=d02ba7f4ee7c448de28724369fc5dd9cf3e2538a",
            "patch": "@@ -1,17 +1,16 @@\n-from __future__ import absolute_import\n+from __future__ import absolute_import, with_statement\n \n from datetime import datetime\n from operator import attrgetter\n \n from django.core.exceptions import FieldError\n from django.test import TestCase, skipUnlessDBFeature\n \n-from .models import Author, Article, Tag\n+from .models import Author, Article, Tag, Game, Season, Player\n \n \n class LookupTests(TestCase):\n \n-    #def setUp(self):\n     def setUp(self):\n         # Create a few Authors.\n         self.au1 = Author(name='Author 1')\n@@ -610,3 +609,80 @@ def test_regex_backreferencing(self):\n         a16.save()\n         self.assertQuerysetEqual(Article.objects.filter(headline__regex=r'b(.).*b\\1'),\n             ['<Article: barfoobaz>', '<Article: bazbaRFOO>', '<Article: foobarbaz>'])\n+\n+    def test_nonfield_lookups(self):\n+        \"\"\"\n+        Ensure that a lookup query containing non-fields raises the proper\n+        exception.\n+        \"\"\"\n+        with self.assertRaises(FieldError):\n+            Article.objects.filter(headline__blahblah=99)\n+        with self.assertRaises(FieldError):\n+            Article.objects.filter(headline__blahblah__exact=99)\n+        with self.assertRaises(FieldError):\n+            Article.objects.filter(blahblah=99)\n+\n+    def test_lookup_collision(self):\n+        \"\"\"\n+        Ensure that genuine field names don't collide with built-in lookup\n+        types ('year', 'gt', 'range', 'in' etc.).\n+        Refs #11670.\n+        \"\"\"\n+\n+        # Here we're using 'gt' as a code number for the year, e.g. 111=>2009.\n+        season_2009 = Season.objects.create(year=2009, gt=111)\n+        season_2009.games.create(home=\"Houston Astros\", away=\"St. Louis Cardinals\")\n+        season_2010 = Season.objects.create(year=2010, gt=222)\n+        season_2010.games.create(home=\"Houston Astros\", away=\"Chicago Cubs\")\n+        season_2010.games.create(home=\"Houston Astros\", away=\"Milwaukee Brewers\")\n+        season_2010.games.create(home=\"Houston Astros\", away=\"St. Louis Cardinals\")\n+        season_2011 = Season.objects.create(year=2011, gt=333)\n+        season_2011.games.create(home=\"Houston Astros\", away=\"St. Louis Cardinals\")\n+        season_2011.games.create(home=\"Houston Astros\", away=\"Milwaukee Brewers\")\n+        hunter_pence = Player.objects.create(name=\"Hunter Pence\")\n+        hunter_pence.games = Game.objects.filter(season__year__in=[2009, 2010])\n+        pudge = Player.objects.create(name=\"Ivan Rodriquez\")\n+        pudge.games = Game.objects.filter(season__year=2009)\n+        pedro_feliz = Player.objects.create(name=\"Pedro Feliz\")\n+        pedro_feliz.games = Game.objects.filter(season__year__in=[2011])\n+        johnson = Player.objects.create(name=\"Johnson\")\n+        johnson.games = Game.objects.filter(season__year__in=[2011])\n+\n+        # Games in 2010\n+        self.assertEqual(Game.objects.filter(season__year=2010).count(), 3)\n+        self.assertEqual(Game.objects.filter(season__year__exact=2010).count(), 3)\n+        self.assertEqual(Game.objects.filter(season__gt=222).count(), 3)\n+        self.assertEqual(Game.objects.filter(season__gt__exact=222).count(), 3)\n+\n+        # Games in 2011\n+        self.assertEqual(Game.objects.filter(season__year=2011).count(), 2)\n+        self.assertEqual(Game.objects.filter(season__year__exact=2011).count(), 2)\n+        self.assertEqual(Game.objects.filter(season__gt=333).count(), 2)\n+        self.assertEqual(Game.objects.filter(season__gt__exact=333).count(), 2)\n+        self.assertEqual(Game.objects.filter(season__year__gt=2010).count(), 2)\n+        self.assertEqual(Game.objects.filter(season__gt__gt=222).count(), 2)\n+\n+        # Games played in 2010 and 2011\n+        self.assertEqual(Game.objects.filter(season__year__in=[2010, 2011]).count(), 5)\n+        self.assertEqual(Game.objects.filter(season__year__gt=2009).count(), 5)\n+        self.assertEqual(Game.objects.filter(season__gt__in=[222, 333]).count(), 5)\n+        self.assertEqual(Game.objects.filter(season__gt__gt=111).count(), 5)\n+\n+        # Players who played in 2009\n+        self.assertEqual(Player.objects.filter(games__season__year=2009).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__year__exact=2009).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__gt=111).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__gt__exact=111).distinct().count(), 2)\n+\n+        # Players who played in 2010\n+        self.assertEqual(Player.objects.filter(games__season__year=2010).distinct().count(), 1)\n+        self.assertEqual(Player.objects.filter(games__season__year__exact=2010).distinct().count(), 1)\n+        self.assertEqual(Player.objects.filter(games__season__gt=222).distinct().count(), 1)\n+        self.assertEqual(Player.objects.filter(games__season__gt__exact=222).distinct().count(), 1)\n+\n+        # Players who played in 2011\n+        self.assertEqual(Player.objects.filter(games__season__year=2011).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__year__exact=2011).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__gt=333).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__year__gt=2010).distinct().count(), 2)\n+        self.assertEqual(Player.objects.filter(games__season__gt__gt=222).distinct().count(), 2)"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 126,
        "deletions": 8
    }
}