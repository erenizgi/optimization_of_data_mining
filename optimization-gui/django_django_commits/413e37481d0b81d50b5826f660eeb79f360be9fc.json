{
    "author": "PaulMcMillan",
    "message": "Fixes #17777 and makes tests run again.\n\nAdds a salted MD5 hasher for backwards compatibility.\nThanks gunnar@g10f.de for the report.\n\nAlso fixes a bug preventing the hasher tests from being run during\ncontrib tests.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17604 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "413e37481d0b81d50b5826f660eeb79f360be9fc",
    "files": [
        {
            "sha": "7bd7d50e7047f82f5b3571127f652ff0c4b1af16",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/413e37481d0b81d50b5826f660eeb79f360be9fc/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/413e37481d0b81d50b5826f660eeb79f360be9fc/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=413e37481d0b81d50b5826f660eeb79f360be9fc",
            "patch": "@@ -507,6 +507,7 @@\n     'django.contrib.auth.hashers.BCryptPasswordHasher',\n     'django.contrib.auth.hashers.SHA1PasswordHasher',\n     'django.contrib.auth.hashers.MD5PasswordHasher',\n+    'django.contrib.auth.hashers.UnsaltedMD5PasswordHasher',\n     'django.contrib.auth.hashers.CryptPasswordHasher',\n )\n "
        },
        {
            "sha": "58246852a8af628e63a4f14797d0043752048680",
            "filename": "django/contrib/auth/hashers.py",
            "status": "modified",
            "additions": 34,
            "deletions": 4,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/413e37481d0b81d50b5826f660eeb79f360be9fc/django%2Fcontrib%2Fauth%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/413e37481d0b81d50b5826f660eeb79f360be9fc/django%2Fcontrib%2Fauth%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhashers.py?ref=413e37481d0b81d50b5826f660eeb79f360be9fc",
            "patch": "@@ -36,7 +36,7 @@ def check_password(password, encoded, setter=None, preferred='default'):\n     encoded = smart_str(encoded)\n \n     if len(encoded) == 32 and '$' not in encoded:\n-        hasher = get_hasher('md5')\n+        hasher = get_hasher('unsalted_md5')\n     else:\n         algorithm = encoded.split('$', 1)[0]\n         hasher = get_hasher(algorithm)\n@@ -69,11 +69,13 @@ def make_password(password, salt=None, hasher='default'):\n     return hasher.encode(password, salt)\n \n \n-def load_hashers():\n+def load_hashers(password_hashers=None):\n     global HASHERS\n     global PREFERRED_HASHER\n     hashers = []\n-    for backend in settings.PASSWORD_HASHERS:\n+    if not password_hashers:\n+        password_hashers = settings.PASSWORD_HASHERS\n+    for backend in password_hashers:\n         try:\n             mod_path, cls_name = backend.rsplit('.', 1)\n             mod = importlib.import_module(mod_path)\n@@ -300,6 +302,34 @@ def safe_summary(self, encoded):\n \n \n class MD5PasswordHasher(BasePasswordHasher):\n+    \"\"\"\n+    The Salted MD5 password hashing algorithm (not recommended)\n+    \"\"\"\n+    algorithm = \"md5\"\n+\n+    def encode(self, password, salt):\n+        assert password\n+        assert salt and '$' not in salt\n+        hash = hashlib.md5(salt + password).hexdigest()\n+        return \"%s$%s$%s\" % (self.algorithm, salt, hash)\n+\n+    def verify(self, password, encoded):\n+        algorithm, salt, hash = encoded.split('$', 2)\n+        assert algorithm == self.algorithm\n+        encoded_2 = self.encode(password, salt)\n+        return constant_time_compare(encoded, encoded_2)\n+\n+    def safe_summary(self, encoded):\n+        algorithm, salt, hash = encoded.split('$', 2)\n+        assert algorithm == self.algorithm\n+        return SortedDict([\n+            (_('algorithm'), algorithm),\n+            (_('salt'), mask_hash(salt, show=2)),\n+            (_('hash'), mask_hash(hash)),\n+        ])\n+\n+\n+class UnsaltedMD5PasswordHasher(BasePasswordHasher):\n     \"\"\"\n     I am an incredibly insecure algorithm you should *never* use;\n     stores unsalted MD5 hashes without the algorithm prefix.\n@@ -308,7 +338,7 @@ class MD5PasswordHasher(BasePasswordHasher):\n     this way. Some older Django installs still have these values\n     lingering around so we need to handle and upgrade them properly.\n     \"\"\"\n-    algorithm = \"md5\"\n+    algorithm = \"unsalted_md5\"\n \n     def salt(self):\n         return ''"
        },
        {
            "sha": "865085a194cc62820c018b49f1d6de53a5bd5dc9",
            "filename": "django/contrib/auth/tests/hashers.py",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/413e37481d0b81d50b5826f660eeb79f360be9fc/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/413e37481d0b81d50b5826f660eeb79f360be9fc/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py?ref=413e37481d0b81d50b5826f660eeb79f360be9fc",
            "patch": "@@ -20,7 +20,7 @@\n \n class TestUtilsHashPass(unittest.TestCase):\n     def setUp(self):\n-        load_hashers()\n+        load_hashers(password_hashers=default_hashers)\n \n     def test_simple(self):\n         encoded = make_password('letmein')\n@@ -47,6 +47,14 @@ def test_sha1(self):\n \n     def test_md5(self):\n         encoded = make_password('letmein', 'seasalt', 'md5')\n+        self.assertEqual(encoded, \n+                         'md5$seasalt$f5531bef9f3687d0ccf0f617f0e25573')\n+        self.assertTrue(is_password_usable(encoded))\n+        self.assertTrue(check_password(u'letmein', encoded))\n+        self.assertFalse(check_password('letmeinz', encoded))\n+\n+    def test_unsalted_md5(self):\n+        encoded = make_password('letmein', 'seasalt', 'unsalted_md5')\n         self.assertEqual(encoded, '0d107d09f5bbe40cade3de5c71e9e9b7')\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password(u'letmein', encoded))\n@@ -123,6 +131,3 @@ def setter():\n                 state['upgraded'] = True\n             self.assertFalse(check_password('WRONG', encoded, setter))\n             self.assertFalse(state['upgraded'])\n-\n-\n-TestUtilsHashPass = override_settings(PASSWORD_HASHERS=default_hashers)(TestUtilsHashPass)"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 44,
        "deletions": 8
    }
}