{
    "author": "jezdez",
    "message": "Fixed #11212 -- Stopped using quoted-printable encoding for mails with non-ASCII characters but rely on 8bit encoding instead. Thanks, phr, gisle and Ramiro Morales.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16178 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31",
    "files": [
        {
            "sha": "831ab5d492c6e81f7e942f83f4334ce966893f57",
            "filename": "django/core/mail/message.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31/django%2Fcore%2Fmail%2Fmessage.py",
            "raw_url": "https://github.com/django/django/raw/2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31/django%2Fcore%2Fmail%2Fmessage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fmessage.py?ref=2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31",
            "patch": "@@ -21,7 +21,7 @@\n \n # Don't BASE64-encode UTF-8 messages so that we avoid unwanted attention from\n # some spam filters.\n-Charset.add_charset('utf-8', Charset.SHORTEST, Charset.QP, 'utf-8')\n+Charset.add_charset('utf-8', Charset.SHORTEST, None, 'utf-8')\n \n # Default MIME type to use on attachments (if it is not explicitly given\n # and cannot be guessed)."
        },
        {
            "sha": "706b3afff19a368bcdc8f82e6b386527f9106cab",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=2abd7af4ddd4d4cc83d2e3a52da1c76b10cd5a31",
            "patch": "@@ -120,7 +120,7 @@ def test_message_header_overrides(self):\n         \"\"\"\n         headers = {\"date\": \"Fri, 09 Nov 2001 01:08:47 -0000\", \"Message-ID\": \"foo\"}\n         email = EmailMessage('subject', 'content', 'from@example.com', ['to@example.com'], headers=headers)\n-        self.assertEqual(email.message().as_string(), 'Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: quoted-printable\\nSubject: subject\\nFrom: from@example.com\\nTo: to@example.com\\ndate: Fri, 09 Nov 2001 01:08:47 -0000\\nMessage-ID: foo\\n\\ncontent')\n+        self.assertEqual(email.message().as_string(), 'Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: 7bit\\nSubject: subject\\nFrom: from@example.com\\nTo: to@example.com\\ndate: Fri, 09 Nov 2001 01:08:47 -0000\\nMessage-ID: foo\\n\\ncontent')\n \n     def test_from_header(self):\n         \"\"\"\n@@ -294,6 +294,30 @@ def test_dont_mangle_from_in_body(self):\n         email = EmailMessage('Subject', 'From the future', 'bounce@example.com', ['to@example.com'], headers={'From': 'from@example.com'})\n         self.assertFalse('>From the future' in email.message().as_string())\n \n+    def test_dont_base64_encode(self):\n+        # Ticket #3472\n+        # Shouldn't use Base64 encoding at all\n+        msg = EmailMessage('Subject', 'UTF-8 encoded body', 'bounce@example.com', ['to@example.com'], headers={'From': 'from@example.com'})\n+        self.assertFalse('Content-Transfer-Encoding: base64' in msg.message().as_string())\n+\n+        # Ticket #11212\n+        # Shouldn't use quoted printable, should detect it can represent content with 7 bit data\n+        msg = EmailMessage('Subject', 'Body with only ASCII characters.', 'bounce@example.com', ['to@example.com'], headers={'From': 'from@example.com'})\n+        s = msg.message().as_string()\n+        self.assertFalse('Content-Transfer-Encoding: quoted-printable' in s)\n+        self.assertTrue('Content-Transfer-Encoding: 7bit' in s)\n+\n+        # Shouldn't use quoted printable, should detect it can represent content with 8 bit data\n+        msg = EmailMessage('Subject', 'Body with latin characters: àáä.', 'bounce@example.com', ['to@example.com'], headers={'From': 'from@example.com'})\n+        s = msg.message().as_string()\n+        self.assertFalse('Content-Transfer-Encoding: quoted-printable' in s)\n+        self.assertTrue('Content-Transfer-Encoding: 8bit' in s)\n+\n+        msg = EmailMessage('Subject', u'Body with non latin characters: А Б В Г Д Е Ж Ѕ З И І К Л М Н О П.', 'bounce@example.com', ['to@example.com'], headers={'From': 'from@example.com'})\n+        s = msg.message().as_string()\n+        self.assertFalse('Content-Transfer-Encoding: quoted-printable' in s)\n+        self.assertTrue('Content-Transfer-Encoding: 8bit' in s)\n+\n \n class BaseEmailBackendTests(object):\n     email_backend = None\n@@ -415,7 +439,7 @@ def test_message_cc_header(self):\n         email = EmailMessage('Subject', 'Content', 'from@example.com', ['to@example.com'], cc=['cc@example.com'])\n         mail.get_connection().send_messages([email])\n         message = self.get_the_message()\n-        self.assertStartsWith(message.as_string(), 'Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: quoted-printable\\nSubject: Subject\\nFrom: from@example.com\\nTo: to@example.com\\nCc: cc@example.com\\nDate: ')\n+        self.assertStartsWith(message.as_string(), 'Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: 7bit\\nSubject: Subject\\nFrom: from@example.com\\nTo: to@example.com\\nCc: cc@example.com\\nDate: ')\n \n     def test_idn_send(self):\n         \"\"\"\n@@ -553,7 +577,7 @@ def test_console_stream_kwarg(self):\n         s = StringIO()\n         connection = mail.get_connection('django.core.mail.backends.console.EmailBackend', stream=s)\n         send_mail('Subject', 'Content', 'from@example.com', ['to@example.com'], connection=connection)\n-        self.assertTrue(s.getvalue().startswith('Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: quoted-printable\\nSubject: Subject\\nFrom: from@example.com\\nTo: to@example.com\\nDate: '))\n+        self.assertTrue(s.getvalue().startswith('Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: 7bit\\nSubject: Subject\\nFrom: from@example.com\\nTo: to@example.com\\nDate: '))\n \n \n class FakeSMTPServer(smtpd.SMTPServer, threading.Thread):"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 28,
        "deletions": 4
    }
}