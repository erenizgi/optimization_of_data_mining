{
    "author": "honzakral",
    "message": "Fixed #11418 -- formset.cleaned_data no longer raises AttributeError when is_valid is True. Thanks mlavin!\n\nThis also introduces a slightly backwards-incompatible change in\nFormSet's behavior, see the release docs for details.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14667 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "65b380e74ab79ee011f7556e342dd4d656b018a5",
    "files": [
        {
            "sha": "6d922366868fb133a54207124cf9e0c09de6eb18",
            "filename": "django/forms/formsets.py",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/65b380e74ab79ee011f7556e342dd4d656b018a5/django%2Fforms%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/65b380e74ab79ee011f7556e342dd4d656b018a5/django%2Fforms%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fformsets.py?ref=65b380e74ab79ee011f7556e342dd4d656b018a5",
            "patch": "@@ -37,8 +37,8 @@ def __init__(self, data=None, files=None, auto_id='id_%s', prefix=None,\n         self.is_bound = data is not None or files is not None\n         self.prefix = prefix or self.get_default_prefix()\n         self.auto_id = auto_id\n-        self.data = data\n-        self.files = files\n+        self.data = data or {}\n+        self.files = files or {}\n         self.initial = initial\n         self.error_class = error_class\n         self._errors = None\n@@ -51,7 +51,7 @@ def __unicode__(self):\n \n     def _management_form(self):\n         \"\"\"Returns the ManagementForm instance for this FormSet.\"\"\"\n-        if self.data or self.files:\n+        if self.is_bound:\n             form = ManagementForm(self.data, auto_id=self.auto_id, prefix=self.prefix)\n             if not form.is_valid():\n                 raise ValidationError('ManagementForm data is missing or has been tampered with')\n@@ -66,7 +66,7 @@ def _management_form(self):\n \n     def total_form_count(self):\n         \"\"\"Returns the total number of forms in this FormSet.\"\"\"\n-        if self.data or self.files:\n+        if self.is_bound:\n             return self.management_form.cleaned_data[TOTAL_FORM_COUNT]\n         else:\n             initial_forms = self.initial_form_count()\n@@ -81,7 +81,7 @@ def total_form_count(self):\n \n     def initial_form_count(self):\n         \"\"\"Returns the number of forms that are required in this FormSet.\"\"\"\n-        if self.data or self.files:\n+        if self.is_bound:\n             return self.management_form.cleaned_data[INITIAL_FORM_COUNT]\n         else:\n             # Use the length of the inital data if it's there, 0 otherwise.\n@@ -101,7 +101,7 @@ def _construct_form(self, i, **kwargs):\n         Instantiates and returns the i-th form instance in a formset.\n         \"\"\"\n         defaults = {'auto_id': self.auto_id, 'prefix': self.add_prefix(i)}\n-        if self.data or self.files:\n+        if self.is_bound:\n             defaults['data'] = self.data\n             defaults['files'] = self.files\n         if self.initial:\n@@ -133,7 +133,7 @@ def _get_empty_form(self, **kwargs):\n             'prefix': self.add_prefix('__prefix__'),\n             'empty_permitted': True,\n         }\n-        if self.data or self.files:\n+        if self.is_bound:\n             defaults['data'] = self.data\n             defaults['files'] = self.files\n         defaults.update(kwargs)"
        },
        {
            "sha": "24702111a2144f6d443f81757fca563fbc352d48",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/65b380e74ab79ee011f7556e342dd4d656b018a5/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/65b380e74ab79ee011f7556e342dd4d656b018a5/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=65b380e74ab79ee011f7556e342dd4d656b018a5",
            "patch": "@@ -266,6 +266,36 @@ local flavors:\n       has been removed from the province list in favor of the new\n       official designation \"Aceh (ACE)\".\n \n+FormSet updates\n+~~~~~~~~~~~~~~~\n+\n+In Django 1.3 ``FormSet`` creation behavior is modified slightly. Historically\n+the class didn't make a distinction between not being passed data and being\n+passed empty dictionary. This was inconsistent with behavior in other parts of\n+the framework. Starting with 1.3 if you pass in empty dictionary the\n+``FormSet`` will raise a ``ValidationError``.\n+\n+For example with a ``FormSet``::\n+\n+    >>> class ArticleForm(Form):\n+    ...     title = CharField()\n+    ...     pub_date = DateField()\n+    >>> ArticleFormSet = formset_factory(ArticleForm)\n+\n+the following code will raise a ``ValidationError``::\n+\n+    >>> ArticleFormSet({})\n+    Traceback (most recent call last):\n+    ...\n+    ValidationError: [u'ManagementForm data is missing or has been tampered with']\n+\n+if you need to instantiate an empty ``FormSet``, don't pass in the data or use\n+``None``::\n+\n+    >>> formset = ArticleFormSet()\n+    >>> formset = ArticleFormSet(data=None)\n+\n+\n \n .. _deprecated-features-1.3:\n "
        },
        {
            "sha": "fae76c7a2e8ab42598ff7248e2018bde4b5977e3",
            "filename": "docs/topics/forms/formsets.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/65b380e74ab79ee011f7556e342dd4d656b018a5/docs%2Ftopics%2Fforms%2Fformsets.txt",
            "raw_url": "https://github.com/django/django/raw/65b380e74ab79ee011f7556e342dd4d656b018a5/docs%2Ftopics%2Fforms%2Fformsets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fforms%2Fformsets.txt?ref=65b380e74ab79ee011f7556e342dd4d656b018a5",
            "patch": "@@ -100,7 +100,12 @@ an ``is_valid`` method on the formset to provide a convenient way to validate\n all forms in the formset::\n \n     >>> ArticleFormSet = formset_factory(ArticleForm)\n-    >>> formset = ArticleFormSet({})\n+    >>> data = {\n+    ...     'form-TOTAL_FORMS': u'1',\n+    ...     'form-INITIAL_FORMS': u'0',\n+    ...     'form-MAX_NUM_FORMS': u'',\n+    ... }\n+    >>> formset = ArticleFormSet(data)\n     >>> formset.is_valid()\n     True\n \n@@ -113,7 +118,7 @@ provide an invalid article::\n     ...     'form-INITIAL_FORMS': u'0',\n     ...     'form-MAX_NUM_FORMS': u'',\n     ...     'form-0-title': u'Test',\n-    ...     'form-0-pub_date': u'16 June 1904',\n+    ...     'form-0-pub_date': u'1904-06-16',\n     ...     'form-1-title': u'Test',\n     ...     'form-1-pub_date': u'', # <-- this date is missing but required\n     ... }\n@@ -208,9 +213,9 @@ is where you define your own validation that works at the formset level::\n     ...     'form-INITIAL_FORMS': u'0',\n     ...     'form-MAX_NUM_FORMS': u'',\n     ...     'form-0-title': u'Test',\n-    ...     'form-0-pub_date': u'16 June 1904',\n+    ...     'form-0-pub_date': u'1904-06-16',\n     ...     'form-1-title': u'Test',\n-    ...     'form-1-pub_date': u'23 June 1912',\n+    ...     'form-1-pub_date': u'1912-06-23',\n     ... }\n     >>> formset = ArticleFormSet(data)\n     >>> formset.is_valid()"
        },
        {
            "sha": "ed2581f6ac1f497e1d140e4f5cae08cc418e59e0",
            "filename": "tests/regressiontests/forms/tests/formsets.py",
            "status": "modified",
            "additions": 47,
            "deletions": 2,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/65b380e74ab79ee011f7556e342dd4d656b018a5/tests%2Fregressiontests%2Fforms%2Ftests%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/65b380e74ab79ee011f7556e342dd4d656b018a5/tests%2Fregressiontests%2Fforms%2Ftests%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fformsets.py?ref=65b380e74ab79ee011f7556e342dd4d656b018a5",
            "patch": "@@ -1,5 +1,5 @@\n # -*- coding: utf-8 -*-\n-from django.forms import Form, CharField, IntegerField, ValidationError\n+from django.forms import Form, CharField, IntegerField, ValidationError, DateField\n from django.forms.formsets import formset_factory, BaseFormSet\n from django.utils.unittest import TestCase\n \n@@ -741,7 +741,12 @@ def test_regression_6926(self):\n         formset = FavoriteDrinksFormSet()\n         self.assertEqual(formset.management_form.prefix, 'form')\n \n-        formset = FavoriteDrinksFormSet(data={})\n+        data = {\n+            'form-TOTAL_FORMS': '2',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '0',\n+        }\n+        formset = FavoriteDrinksFormSet(data=data)\n         self.assertEqual(formset.management_form.prefix, 'form')\n \n         formset = FavoriteDrinksFormSet(initial={})\n@@ -795,3 +800,43 @@ def test_as_ul(self):\n         self.assertEqual(formset.as_ul(),\"\"\"<input type=\"hidden\" name=\"choices-TOTAL_FORMS\" value=\"1\" /><input type=\"hidden\" name=\"choices-INITIAL_FORMS\" value=\"0\" /><input type=\"hidden\" name=\"choices-MAX_NUM_FORMS\" value=\"0\" />\n <li>Choice: <input type=\"text\" name=\"choices-0-choice\" value=\"Calexico\" /></li>\n <li>Votes: <input type=\"text\" name=\"choices-0-votes\" value=\"100\" /></li>\"\"\")\n+\n+\n+# Regression test for #11418 ################################################# \n+class ArticleForm(Form):\n+    title = CharField()\n+    pub_date = DateField()\n+\n+ArticleFormSet = formset_factory(ArticleForm)\n+\n+class TestIsBoundBehavior(TestCase):\n+    def test_no_data_raises_validation_error(self):\n+        self.assertRaises(ValidationError, ArticleFormSet, {})\n+\n+    def test_with_management_data_attrs_work_fine(self):\n+        data = {\n+            'form-TOTAL_FORMS': u'1',\n+            'form-INITIAL_FORMS': u'0',\n+        }\n+        formset = ArticleFormSet(data)\n+        self.assertEquals(0, formset.initial_form_count())\n+        self.assertEquals(1, formset.total_form_count())\n+        self.assertTrue(formset.is_bound)\n+        self.assertTrue(formset.forms[0].is_bound)\n+        self.assertTrue(formset.is_valid())\n+        self.assertTrue(formset.forms[0].is_valid())\n+        self.assertEquals([{}], formset.cleaned_data)\n+\n+\n+    def test_form_errors_are_cought_by_formset(self):\n+        data = {\n+            'form-TOTAL_FORMS': u'2',\n+            'form-INITIAL_FORMS': u'0',\n+            'form-0-title': u'Test',\n+            'form-0-pub_date': u'1904-06-16',\n+            'form-1-title': u'Test',\n+            'form-1-pub_date': u'', # <-- this date is missing but required \n+        }\n+        formset = ArticleFormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEquals([{}, {'pub_date': [u'This field is required.']}], formset.errors)"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 93,
        "deletions": 13
    }
}