{
    "author": "claudep",
    "message": "Fixed #19665 -- Ensured proper stderr output for Command.run_from_argv\n\nThanks Stefan Koegl for the report and Simon Charette for the review.",
    "sha": "b9c8bbf3726a1956be1db70ffd3bef04a2e5311a",
    "files": [
        {
            "sha": "7b9001ed148dbe19868e12b6d3305bc2088b55b6",
            "filename": "django/core/management/base.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/b9c8bbf3726a1956be1db70ffd3bef04a2e5311a/django%2Fcore%2Fmanagement%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/b9c8bbf3726a1956be1db70ffd3bef04a2e5311a/django%2Fcore%2Fmanagement%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fbase.py?ref=b9c8bbf3726a1956be1db70ffd3bef04a2e5311a",
            "patch": "@@ -221,9 +221,12 @@ def run_from_argv(self, argv):\n         try:\n             self.execute(*args, **options.__dict__)\n         except Exception as e:\n+            # self.stderr is not guaranteed to be set here\n+            stderr = getattr(self, 'stderr', OutputWrapper(sys.stderr, self.style.ERROR))\n             if options.traceback:\n-                self.stderr.write(traceback.format_exc())\n-            self.stderr.write('%s: %s' % (e.__class__.__name__, e))\n+                stderr.write(traceback.format_exc())\n+            else:\n+                stderr.write('%s: %s' % (e.__class__.__name__, e))\n             sys.exit(1)\n \n     def execute(self, *args, **options):"
        },
        {
            "sha": "921108600e5c905f5c91d0f3ea63e322d3a991c0",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/b9c8bbf3726a1956be1db70ffd3bef04a2e5311a/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b9c8bbf3726a1956be1db70ffd3bef04a2e5311a/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=b9c8bbf3726a1956be1db70ffd3bef04a2e5311a",
            "patch": "@@ -16,11 +16,13 @@\n \n from django import conf, bin, get_version\n from django.conf import settings\n+from django.core.management import BaseCommand\n from django.db import connection\n from django.test.simple import DjangoTestSuiteRunner\n from django.utils import unittest\n from django.utils.encoding import force_str, force_text\n from django.utils._os import upath\n+from django.utils.six import StringIO\n from django.test import LiveServerTestCase\n \n test_dir = os.path.dirname(os.path.dirname(upath(__file__)))\n@@ -1279,6 +1281,31 @@ def test_base_command_with_options(self):\n         self.assertNoOutput(err)\n         self.assertOutput(out, \"EXECUTE:BaseCommand labels=('testlabel',), options=[('option_a', 'x'), ('option_b', 'y'), ('option_c', '3'), ('pythonpath', None), ('settings', None), ('traceback', None), ('verbosity', '1')]\")\n \n+    def test_base_run_from_argv(self):\n+        \"\"\"\n+        Test run_from_argv properly terminates even with custom execute() (#19665)\n+        Also test proper traceback display.\n+        \"\"\"\n+        command = BaseCommand()\n+        command.execute = lambda args: args  # This will trigger TypeError\n+\n+        old_stderr = sys.stderr\n+        sys.stderr = err = StringIO()\n+        try:\n+            with self.assertRaises(SystemExit):\n+                command.run_from_argv(['', ''])\n+            err_message = err.getvalue()\n+            self.assertNotIn(\"Traceback\", err_message)\n+            self.assertIn(\"TypeError\", err_message)\n+\n+            with self.assertRaises(SystemExit):\n+                command.run_from_argv(['', '', '--traceback'])\n+            err_message = err.getvalue()\n+            self.assertIn(\"Traceback (most recent call last)\", err_message)\n+            self.assertIn(\"TypeError\", err_message)\n+        finally:\n+            sys.stderr = old_stderr\n+\n     def test_noargs(self):\n         \"NoArg Commands can be executed\"\n         args = ['noargs_command']"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 32,
        "deletions": 2
    }
}