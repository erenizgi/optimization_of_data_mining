{
    "author": "carljm",
    "message": "Fixed #14896 -- Ensured that _meta.get_all_related_objects(include_hidden=True) also works correctly with model inheritance.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15248 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e01cb0740496f12323260205687111a54a91e10f",
    "files": [
        {
            "sha": "882d2f5709690ef585da238254bdb8b5f1c4c229",
            "filename": "django/db/models/options.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/e01cb0740496f12323260205687111a54a91e10f/django%2Fdb%2Fmodels%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/e01cb0740496f12323260205687111a54a91e10f/django%2Fdb%2Fmodels%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Foptions.py?ref=e01cb0740496f12323260205687111a54a91e10f",
            "patch": "@@ -371,7 +371,7 @@ def _fill_related_objects_cache(self):\n         cache = SortedDict()\n         parent_list = self.get_parent_list()\n         for parent in self.parents:\n-            for obj, model in parent._meta.get_all_related_objects_with_model():\n+            for obj, model in parent._meta.get_all_related_objects_with_model(include_hidden=True):\n                 if (obj.field.creation_counter < 0 or obj.field.rel.parent_link) and obj.model not in parent_list:\n                     continue\n                 if not model:"
        },
        {
            "sha": "07b58317aecd97d71c2b83db41826233c1f7568b",
            "filename": "tests/regressiontests/delete_regress/models.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/e01cb0740496f12323260205687111a54a91e10f/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/e01cb0740496f12323260205687111a54a91e10f/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py?ref=e01cb0740496f12323260205687111a54a91e10f",
            "patch": "@@ -35,3 +35,12 @@ class PlayedWith(models.Model):\n class PlayedWithNote(models.Model):\n     played = models.ForeignKey(PlayedWith)\n     note = models.TextField()\n+\n+class Contact(models.Model):\n+    label = models.CharField(max_length=100)\n+\n+class Email(Contact):\n+    email_address = models.EmailField(max_length=100)\n+\n+class Researcher(models.Model):\n+    contacts = models.ManyToManyField(Contact, related_name=\"research_contacts\")"
        },
        {
            "sha": "7e243c841c111cfba771e509173132deea969b61",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 16,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/e01cb0740496f12323260205687111a54a91e10f/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e01cb0740496f12323260205687111a54a91e10f/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=e01cb0740496f12323260205687111a54a91e10f",
            "patch": "@@ -4,7 +4,8 @@\n from django.db import backend, connection, transaction, DEFAULT_DB_ALIAS\n from django.test import TestCase, TransactionTestCase, skipUnlessDBFeature\n \n-from models import Book, Award, AwardNote, Person, Child, Toy, PlayedWith, PlayedWithNote\n+from models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n+    PlayedWithNote, Contact, Email, Researcher)\n \n \n # Can't run this test under SQLite, because you can't\n@@ -62,17 +63,12 @@ def test_concurrent_delete(self):\n         transaction.commit()\n         self.assertEqual(1, Book.objects.count())\n \n+\n class DeleteCascadeTests(TestCase):\n     def test_generic_relation_cascade(self):\n         \"\"\"\n-        Test that Django cascades deletes through generic-related\n-        objects to their reverse relations.\n-\n-        This might falsely succeed if the database cascades deletes\n-        itself immediately; the postgresql_psycopg2 backend does not\n-        give such a false success because ForeignKeys are created with\n-        DEFERRABLE INITIALLY DEFERRED, so its internal cascade is\n-        delayed until transaction commit.\n+        Django cascades deletes through generic-related objects to their\n+        reverse relations.\n \n         \"\"\"\n         person = Person.objects.create(name='Nelson Mandela')\n@@ -87,13 +83,10 @@ def test_generic_relation_cascade(self):\n \n     def test_fk_to_m2m_through(self):\n         \"\"\"\n-        Test that if a M2M relationship has an explicitly-specified\n-        through model, and some other model has an FK to that through\n-        model, deletion is cascaded from one of the participants in\n-        the M2M, to the through model, to its related model.\n-\n-        Like the above test, this could in theory falsely succeed if\n-        the DB cascades deletes itself immediately.\n+        If an M2M relationship has an explicitly-specified through model, and\n+        some other model has an FK to that through model, deletion is cascaded\n+        from one of the participants in the M2M, to the through model, to its\n+        related model.\n \n         \"\"\"\n         juan = Child.objects.create(name='Juan')\n@@ -108,6 +101,24 @@ def test_fk_to_m2m_through(self):\n         # first two asserts just sanity checks, this is the kicker:\n         self.assertEquals(PlayedWithNote.objects.count(), 0)\n \n+\n+class DeleteCascadeTransactionTests(TransactionTestCase):\n+    def test_inheritance(self):\n+        \"\"\"\n+        Auto-created many-to-many through tables referencing a parent model are\n+        correctly found by the delete cascade when a child of that parent is\n+        deleted.\n+\n+        Refs #14896.\n+        \"\"\"\n+        r = Researcher.objects.create()\n+        email = Email.objects.create(\n+            label=\"office-email\", email_address=\"carl@science.edu\"\n+        )\n+        r.contacts.add(email)\n+\n+        email.delete()\n+\n class LargeDeleteTests(TestCase):\n     def test_large_deletes(self):\n         \"Regression for #13309 -- if the number of objects > chunk size, deletion still occurs\""
        }
    ],
    "stats": {
        "total": 54,
        "additions": 37,
        "deletions": 17
    }
}