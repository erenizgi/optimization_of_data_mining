{
    "author": "freakboy3742",
    "message": "Fixed #15144 -- Corrected some problems with the Cache middleware when used with multiple cache settings. Thanks to Jim Dalton for the report, and to Jim and Joshua Ginsberg for the work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15285 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "fe581013b03b3dd38f4893bb5e9dc9695af25d71",
    "files": [
        {
            "sha": "ceb5f1a7c7b3528f6427385faaf1f3b6cae08651",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/fe581013b03b3dd38f4893bb5e9dc9695af25d71/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/fe581013b03b3dd38f4893bb5e9dc9695af25d71/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=fe581013b03b3dd38f4893bb5e9dc9695af25d71",
            "patch": "@@ -129,6 +129,7 @@ answer newbie questions, and generally made Django that much better:\n     Jure Cuhalev <gandalf@owca.info>\n     John D'Agostino <john.dagostino@gmail.com>\n     dackze+django@gmail.com\n+    Jim Dalton <jim.dalton@gmail.com>\n     Mihai Damian <yang_damian@yahoo.com>\n     David Danier <goliath.mailinglist@gmx.de>\n     Dirk Datzert <dummy@habmalnefrage.de>"
        },
        {
            "sha": "ced9875b079eea8a706c7a1176dcc7d50b2045d3",
            "filename": "django/core/cache/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/fe581013b03b3dd38f4893bb5e9dc9695af25d71/django%2Fcore%2Fcache%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/fe581013b03b3dd38f4893bb5e9dc9695af25d71/django%2Fcore%2Fcache%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcache%2F__init__.py?ref=fe581013b03b3dd38f4893bb5e9dc9695af25d71",
            "patch": "@@ -110,6 +110,7 @@ def parse_backend_conf(backend, **kwargs):\n     conf = settings.CACHES.get(backend, None)\n     if conf is not None:\n         args = conf.copy()\n+        args.update(kwargs)\n         backend = args.pop('BACKEND')\n         location = args.pop('LOCATION', '')\n         return backend, location, args"
        },
        {
            "sha": "907edbb16f903bf704b0a5035c5f493235c1de56",
            "filename": "django/middleware/cache.py",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/fe581013b03b3dd38f4893bb5e9dc9695af25d71/django%2Fmiddleware%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/fe581013b03b3dd38f4893bb5e9dc9695af25d71/django%2Fmiddleware%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcache.py?ref=fe581013b03b3dd38f4893bb5e9dc9695af25d71",
            "patch": "@@ -65,7 +65,8 @@ def __init__(self):\n         self.cache_timeout = settings.CACHE_MIDDLEWARE_SECONDS\n         self.key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n         self.cache_anonymous_only = getattr(settings, 'CACHE_MIDDLEWARE_ANONYMOUS_ONLY', False)\n-        self.cache = get_cache(settings.CACHE_MIDDLEWARE_ALIAS)\n+        self.cache_alias = settings.CACHE_MIDDLEWARE_ALIAS\n+        self.cache = get_cache(self.cache_alias)\n \n     def process_response(self, request, response):\n         \"\"\"Sets the cache, if needed.\"\"\"\n@@ -101,7 +102,8 @@ def __init__(self):\n         self.cache_timeout = settings.CACHE_MIDDLEWARE_SECONDS\n         self.key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n         self.cache_anonymous_only = getattr(settings, 'CACHE_MIDDLEWARE_ANONYMOUS_ONLY', False)\n-        self.cache = get_cache(settings.CACHE_MIDDLEWARE_ALIAS)\n+        self.cache_alias = settings.CACHE_MIDDLEWARE_ALIAS\n+        self.cache = get_cache(self.cache_alias)\n \n     def process_request(self, request):\n         \"\"\"\n@@ -152,23 +154,25 @@ def __init__(self, cache_timeout=None, cache_anonymous_only=None, **kwargs):\n         # we need to use middleware defaults.\n \n         cache_kwargs = {}\n+\n         try:\n-            self.key_prefix = kwargs.get('key_prefix')\n+            self.key_prefix = kwargs['key_prefix']\n             if self.key_prefix is not None:\n                 cache_kwargs['KEY_PREFIX'] = self.key_prefix\n             else:\n                 self.key_prefix = ''\n         except KeyError:\n             self.key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n             cache_kwargs['KEY_PREFIX'] = self.key_prefix\n+\n         try:\n-            cache_alias = kwargs.get('cache_alias')\n-            if cache_alias is None:\n-                cache_alias = DEFAULT_CACHE_ALIAS\n+            self.cache_alias = kwargs['cache_alias']\n+            if self.cache_alias is None:\n+                self.cache_alias = DEFAULT_CACHE_ALIAS\n             if cache_timeout is not None:\n                 cache_kwargs['TIMEOUT'] = cache_timeout\n         except KeyError:\n-            cache_alias = settings.CACHE_MIDDLEWARE_ALIAS\n+            self.cache_alias = settings.CACHE_MIDDLEWARE_ALIAS\n             if cache_timeout is None:\n                 cache_kwargs['TIMEOUT'] = settings.CACHE_MIDDLEWARE_SECONDS\n             else:\n@@ -179,5 +183,5 @@ def __init__(self, cache_timeout=None, cache_anonymous_only=None, **kwargs):\n         else:\n             self.cache_anonymous_only = cache_anonymous_only\n \n-        self.cache = get_cache(cache_alias, **cache_kwargs)\n+        self.cache = get_cache(self.cache_alias, **cache_kwargs)\n         self.cache_timeout = self.cache.default_timeout"
        },
        {
            "sha": "1a1e2438bd21984c7eea7417bca0bac81586afd6",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 62,
            "deletions": 8,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/fe581013b03b3dd38f4893bb5e9dc9695af25d71/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fe581013b03b3dd38f4893bb5e9dc9695af25d71/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=fe581013b03b3dd38f4893bb5e9dc9695af25d71",
            "patch": "@@ -1133,10 +1133,14 @@ class CacheMiddlewareTest(unittest.TestCase):\n     def setUp(self):\n         self.orig_cache_middleware_alias = settings.CACHE_MIDDLEWARE_ALIAS\n         self.orig_cache_middleware_key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n+        self.orig_cache_middleware_seconds = settings.CACHE_MIDDLEWARE_SECONDS\n+        self.orig_cache_middleware_anonymous_only = getattr(settings, 'CACHE_MIDDLEWARE_ANONYMOUS_ONLY', False)\n         self.orig_caches = settings.CACHES\n \n         settings.CACHE_MIDDLEWARE_ALIAS = 'other'\n         settings.CACHE_MIDDLEWARE_KEY_PREFIX = 'middlewareprefix'\n+        settings.CACHE_MIDDLEWARE_SECONDS = 30\n+        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = False\n         settings.CACHES = {\n             'default': {\n                 'BACKEND': 'django.core.cache.backends.locmem.LocMemCache'\n@@ -1151,8 +1155,42 @@ def setUp(self):\n     def tearDown(self):\n         settings.CACHE_MIDDLEWARE_ALIAS = self.orig_cache_middleware_alias\n         settings.CACHE_MIDDLEWARE_KEY_PREFIX = self.orig_cache_middleware_key_prefix\n+        settings.CACHE_MIDDLEWARE_SECONDS = self.orig_cache_middleware_seconds\n+        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = self.orig_cache_middleware_anonymous_only\n         settings.CACHES = self.orig_caches\n \n+    def test_constructor(self):\n+        \"\"\"\n+        Ensure the constructor is correctly distinguishing between usage of CacheMiddleware as\n+        Middleware vs. usage of CacheMiddleware as view decorator and setting attributes\n+        appropriately.\n+        \"\"\"\n+        # If no arguments are passed in construction, it's being used as middleware.\n+        middleware = CacheMiddleware()\n+\n+        # Now test object attributes against values defined in setUp above\n+        self.assertEquals(middleware.cache_timeout, 30)\n+        self.assertEquals(middleware.key_prefix, 'middlewareprefix')\n+        self.assertEquals(middleware.cache_alias, 'other')\n+        self.assertEquals(middleware.cache_anonymous_only, False)\n+\n+        # If arguments are being passed in construction, it's being used as a decorator.\n+        # First, test with \"defaults\":\n+        as_view_decorator = CacheMiddleware(cache_alias=None, key_prefix=None)\n+\n+        self.assertEquals(as_view_decorator.cache_timeout, 300) # Timeout value for 'default' cache, i.e. 300\n+        self.assertEquals(as_view_decorator.key_prefix, '')\n+        self.assertEquals(as_view_decorator.cache_alias, 'default') # Value of DEFAULT_CACHE_ALIAS from django.core.cache\n+        self.assertEquals(as_view_decorator.cache_anonymous_only, False)\n+\n+        # Next, test with custom values:\n+        as_view_decorator_with_custom = CacheMiddleware(cache_anonymous_only=True, cache_timeout=60, cache_alias='other', key_prefix='foo')\n+\n+        self.assertEquals(as_view_decorator_with_custom.cache_timeout, 60)\n+        self.assertEquals(as_view_decorator_with_custom.key_prefix, 'foo')\n+        self.assertEquals(as_view_decorator_with_custom.cache_alias, 'other')\n+        self.assertEquals(as_view_decorator_with_custom.cache_anonymous_only, True)\n+\n     def test_middleware(self):\n         def view(request, value):\n             return HttpResponse('Hello World %s' % value)\n@@ -1201,6 +1239,7 @@ def view(request, value):\n \n         other_view = cache_page(cache='other')(view)\n         other_with_prefix_view = cache_page(cache='other', key_prefix='prefix2')(view)\n+        other_with_timeout_view = cache_page(4, cache='other', key_prefix='prefix3')(view)\n \n         factory = RequestFactory()\n         request = factory.get('/view/')\n@@ -1241,33 +1280,48 @@ def view(request, value):\n         response = other_with_prefix_view(request, '9')\n         self.assertEquals(response.content, 'Hello World 9')\n \n+        # Request from the alternate cache with a new prefix and a custom timeout\n+        response = other_with_timeout_view(request, '10')\n+        self.assertEquals(response.content, 'Hello World 10')\n+\n         # But if we wait a couple of seconds...\n         time.sleep(2)\n \n         # ... the default cache will still hit\n         cache = get_cache('default')\n-        response = default_view(request, '10')\n+        response = default_view(request, '11')\n         self.assertEquals(response.content, 'Hello World 1')\n \n         # ... the default cache with a prefix will still hit\n-        response = default_with_prefix_view(request, '11')\n+        response = default_with_prefix_view(request, '12')\n         self.assertEquals(response.content, 'Hello World 4')\n \n         # ... the explicit default cache will still hit\n-        response = explicit_default_view(request, '12')\n+        response = explicit_default_view(request, '13')\n         self.assertEquals(response.content, 'Hello World 1')\n \n         # ... the explicit default cache with a prefix will still hit\n-        response = explicit_default_with_prefix_view(request, '13')\n+        response = explicit_default_with_prefix_view(request, '14')\n         self.assertEquals(response.content, 'Hello World 4')\n \n         # .. but a rapidly expiring cache won't hit\n-        response = other_view(request, '14')\n-        self.assertEquals(response.content, 'Hello World 14')\n+        response = other_view(request, '15')\n+        self.assertEquals(response.content, 'Hello World 15')\n \n         # .. even if it has a prefix\n-        response = other_with_prefix_view(request, '15')\n-        self.assertEquals(response.content, 'Hello World 15')\n+        response = other_with_prefix_view(request, '16')\n+        self.assertEquals(response.content, 'Hello World 16')\n+\n+        # ... but a view with a custom timeout will still hit\n+        response = other_with_timeout_view(request, '17')\n+        self.assertEquals(response.content, 'Hello World 10')\n+\n+        # And if we wait a few more seconds\n+        time.sleep(2)\n+\n+        # the custom timeouot cache will miss\n+        response = other_with_timeout_view(request, '18')\n+        self.assertEquals(response.content, 'Hello World 18')\n \n if __name__ == '__main__':\n     unittest.main()"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 76,
        "deletions": 16
    }
}