{
    "author": "jezdez",
    "message": "Fixed #17677 -- Made sure the WizardView doesn't accidentally overwrite the `instance` or `queryset` form parameters when they are already set by the `get_form_kwargs` method. Thanks to goodtune and Stephan JÃ¤kel.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17651 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "59a436e963db9018a930b9b5c83785bdc2ab0139",
    "files": [
        {
            "sha": "a2a9692ac6728b688f893a9a7a17b0b495a70930",
            "filename": "django/contrib/formtools/tests/wizard/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2F__init__.py?ref=59a436e963db9018a930b9b5c83785bdc2ab0139",
            "patch": "@@ -15,4 +15,5 @@\n     CookieWizardTests,\n     WizardTestKwargs,\n     WizardTestGenericViewInterface,\n+    WizardFormKwargsOverrideTests,\n )"
        },
        {
            "sha": "6a8132971b6605e13587f1795d018ed2eb3b026d",
            "filename": "django/contrib/formtools/tests/wizard/wizardtests/forms.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fwizardtests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fwizardtests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fwizardtests%2Fforms.py?ref=59a436e963db9018a930b9b5c83785bdc2ab0139",
            "patch": "@@ -2,8 +2,10 @@\n import tempfile\n \n from django import forms\n+from django.contrib.auth.models import User\n from django.core.files.storage import FileSystemStorage\n from django.forms.formsets import formset_factory\n+from django.forms.models import modelformset_factory\n from django.http import HttpResponse\n from django.template import Template, Context\n \n@@ -50,6 +52,13 @@ def get_context_data(self, form, **kwargs):\n             context.update({'another_var': True})\n         return context\n \n+class UserForm(forms.ModelForm):\n+    class Meta:\n+        model = User\n+        fields = ('username', 'email')\n+\n+UserFormSet = modelformset_factory(User, form=UserForm)\n+\n class SessionContactWizard(ContactWizard):\n     storage_name = 'django.contrib.formtools.wizard.storage.session.SessionStorage'\n "
        },
        {
            "sha": "2ef39dc7a3550bf27e99223330015aa4714261a1",
            "filename": "django/contrib/formtools/tests/wizard/wizardtests/tests.py",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fwizardtests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fwizardtests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fwizardtests%2Ftests.py?ref=59a436e963db9018a930b9b5c83785bdc2ab0139",
            "patch": "@@ -7,6 +7,7 @@\n from django.conf import settings\n from django.contrib.auth.models import User\n from django.contrib.formtools.wizard.views import CookieWizardView\n+from django.contrib.formtools.tests.wizard.forms import UserForm, UserFormSet\n \n \n class WizardTests(object):\n@@ -331,3 +332,48 @@ def get_context_data(self, **kwargs):\n         response = view(factory.get('/'))\n         self.assertEquals(response.context_data['test_key'], 'test_value')\n         self.assertEquals(response.context_data['another_key'], 'another_value')\n+\n+\n+class WizardFormKwargsOverrideTests(TestCase):\n+    def setUp(self):\n+        super(WizardFormKwargsOverrideTests, self).setUp()\n+        self.rf = RequestFactory()\n+\n+        # Create two users so we can filter by is_staff when handing our\n+        # wizard a queryset keyword argument.\n+        self.normal_user = User.objects.create(username='test1', email='normal@example.com')\n+        self.staff_user = User.objects.create(username='test2', email='staff@example.com', is_staff=True)\n+\n+    def test_instance_is_maintained(self):\n+        self.assertEqual(2, User.objects.count())\n+        queryset = User.objects.get(pk=self.staff_user.pk)\n+\n+        class InstanceOverrideWizard(CookieWizardView):\n+            def get_form_kwargs(self, step):\n+                return {'instance': queryset}\n+\n+        view = InstanceOverrideWizard.as_view([UserForm])\n+        response = view(self.rf.get('/'))\n+\n+        form = response.context_data['wizard']['form']\n+\n+        self.assertNotEqual(form.instance.pk, None)\n+        self.assertEqual(form.instance.pk, self.staff_user.pk)\n+        self.assertEqual('staff@example.com', form.initial.get('email', None))\n+\n+    def test_queryset_is_maintained(self):\n+        queryset = User.objects.filter(pk=self.staff_user.pk)\n+\n+        class QuerySetOverrideWizard(CookieWizardView):\n+            def get_form_kwargs(self, step):\n+                return {'queryset': queryset}\n+\n+        view = QuerySetOverrideWizard.as_view([UserFormSet])\n+        response = view(self.rf.get('/'))\n+\n+        formset = response.context_data['wizard']['form']\n+\n+        self.assertNotEqual(formset.queryset, None)\n+        self.assertEqual(formset.initial_form_count(), 1)\n+        self.assertEqual(['staff@example.com'],\n+            list(formset.queryset.values_list('email', flat=True)))"
        },
        {
            "sha": "4372c8aa6a31b02d2b87204a53cdb1ffe84c272c",
            "filename": "django/contrib/formtools/wizard/views.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Fwizard%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/59a436e963db9018a930b9b5c83785bdc2ab0139/django%2Fcontrib%2Fformtools%2Fwizard%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Fwizard%2Fviews.py?ref=59a436e963db9018a930b9b5c83785bdc2ab0139",
            "patch": "@@ -385,11 +385,13 @@ def get_form(self, step=None, data=None, files=None):\n             'initial': self.get_form_initial(step),\n         })\n         if issubclass(self.form_list[step], forms.ModelForm):\n-            # If the form is based on ModelForm, add instance if available.\n-            kwargs.update({'instance': self.get_form_instance(step)})\n+            # If the form is based on ModelForm, add instance if available\n+            # and not previously set.\n+            kwargs.setdefault('instance', self.get_form_instance(step))\n         elif issubclass(self.form_list[step], forms.models.BaseModelFormSet):\n-            # If the form is based on ModelFormSet, add queryset if available.\n-            kwargs.update({'queryset': self.get_form_instance(step)})\n+            # If the form is based on ModelFormSet, add queryset if available\n+            # and not previous set.\n+            kwargs.setdefault('queryset', self.get_form_instance(step))\n         return self.form_list[step](**kwargs)\n \n     def process_step(self, form):"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 62,
        "deletions": 4
    }
}