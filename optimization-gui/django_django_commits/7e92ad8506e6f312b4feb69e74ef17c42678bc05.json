{
    "author": "carljm",
    "message": "Fixed #16128 - Correctly cascade-delete proxy models as if they were the concrete model class. Thanks xkennyx for the report, and Aymeric Augustin, Claude Paroz, Adam Nelson, jaap3, and Anssi Kääriäinen for work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17664 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7e92ad8506e6f312b4feb69e74ef17c42678bc05",
    "files": [
        {
            "sha": "7d6594afc0d06ece72a6696c4fe0405a23b71417",
            "filename": "django/db/models/deletion.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/7e92ad8506e6f312b4feb69e74ef17c42678bc05/django%2Fdb%2Fmodels%2Fdeletion.py",
            "raw_url": "https://github.com/django/django/raw/7e92ad8506e6f312b4feb69e74ef17c42678bc05/django%2Fdb%2Fmodels%2Fdeletion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fdeletion.py?ref=7e92ad8506e6f312b4feb69e74ef17c42678bc05",
            "patch": "@@ -144,6 +144,7 @@ def collect(self, objs, source=None, nullable=False, collect_related=True,\n                             reverse_dependency=reverse_dependency)\n         if not new_objs:\n             return\n+\n         model = new_objs[0].__class__\n \n         # Recursively collect parent models, but not their related objects.\n@@ -157,7 +158,8 @@ def collect(self, objs, source=None, nullable=False, collect_related=True,\n                              reverse_dependency=True)\n \n         if collect_related:\n-            for related in model._meta.get_all_related_objects(include_hidden=True):\n+            for related in model._meta.get_all_related_objects(\n+                    include_hidden=True, include_proxy_eq=True):\n                 field = related.field\n                 if related.model._meta.auto_created:\n                     self.add_batch(related.model, field, new_objs)"
        },
        {
            "sha": "44f8891942294be42210cd8e6e3a29cef7c969d2",
            "filename": "django/db/models/options.py",
            "status": "modified",
            "additions": 18,
            "deletions": 7,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/7e92ad8506e6f312b4feb69e74ef17c42678bc05/django%2Fdb%2Fmodels%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/7e92ad8506e6f312b4feb69e74ef17c42678bc05/django%2Fdb%2Fmodels%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Foptions.py?ref=7e92ad8506e6f312b4feb69e74ef17c42678bc05",
            "patch": "@@ -359,12 +359,15 @@ def get_change_permission(self):\n     def get_delete_permission(self):\n         return 'delete_%s' % self.object_name.lower()\n \n-    def get_all_related_objects(self, local_only=False, include_hidden=False):\n+    def get_all_related_objects(self, local_only=False, include_hidden=False,\n+                                include_proxy_eq=False):\n         return [k for k, v in self.get_all_related_objects_with_model(\n-                local_only=local_only, include_hidden=include_hidden)]\n+                local_only=local_only, include_hidden=include_hidden,\n+                include_proxy_eq=include_proxy_eq)]\n \n     def get_all_related_objects_with_model(self, local_only=False,\n-                                           include_hidden=False):\n+                                           include_hidden=False,\n+                                           include_proxy_eq=False):\n         \"\"\"\n         Returns a list of (related-object, model) pairs. Similar to\n         get_fields_with_model().\n@@ -378,8 +381,9 @@ def get_all_related_objects_with_model(self, local_only=False,\n             predicates.append(lambda k, v: not v)\n         if not include_hidden:\n             predicates.append(lambda k, v: not k.field.rel.is_hidden())\n-        return filter(lambda t: all([p(*t) for p in predicates]),\n-                      self._related_objects_cache.items())\n+        cache = (self._related_objects_proxy_cache if include_proxy_eq\n+                 else self._related_objects_cache)\n+        return filter(lambda t: all([p(*t) for p in predicates]), cache.items())\n \n     def _fill_related_objects_cache(self):\n         cache = SortedDict()\n@@ -392,11 +396,18 @@ def _fill_related_objects_cache(self):\n                     cache[obj] = parent\n                 else:\n                     cache[obj] = model\n+        # Collect also objects which are in relation to some proxy child/parent of self.\n+        proxy_cache = cache.copy()\n         for klass in get_models(include_auto_created=True, only_installed=False):\n             for f in klass._meta.local_fields:\n-                if f.rel and not isinstance(f.rel.to, basestring) and self == f.rel.to._meta:\n-                    cache[RelatedObject(f.rel.to, klass, f)] = None\n+                if f.rel and not isinstance(f.rel.to, basestring):\n+                    if self == f.rel.to._meta:\n+                        cache[RelatedObject(f.rel.to, klass, f)] = None\n+                        proxy_cache[RelatedObject(f.rel.to, klass, f)] = None\n+                    elif self.concrete_model == f.rel.to._meta.concrete_model:\n+                        proxy_cache[RelatedObject(f.rel.to, klass, f)] = None\n         self._related_objects_cache = cache\n+        self._related_objects_proxy_cache = proxy_cache\n \n     def get_all_related_many_to_many_objects(self, local_only=False):\n         try:"
        },
        {
            "sha": "214452c97b5e6a70c2943428364df6197a5e28cb",
            "filename": "tests/regressiontests/delete_regress/models.py",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/7e92ad8506e6f312b4feb69e74ef17c42678bc05/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/7e92ad8506e6f312b4feb69e74ef17c42678bc05/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py?ref=7e92ad8506e6f312b4feb69e74ef17c42678bc05",
            "patch": "@@ -67,3 +67,27 @@ class Location(models.Model):\n class Item(models.Model):\n     version = models.ForeignKey(Version)\n     location = models.ForeignKey(Location, blank=True, null=True)\n+\n+# Models for #16128\n+\n+class File(models.Model):\n+    pass\n+\n+class Image(File):\n+    class Meta:\n+        proxy = True\n+\n+class Photo(Image):\n+    class Meta:\n+        proxy = True\n+\n+class FooImage(models.Model):\n+    my_image = models.ForeignKey(Image)\n+\n+class FooFile(models.Model):\n+    my_file = models.ForeignKey(File)\n+\n+class FooPhoto(models.Model):\n+    my_photo = models.ForeignKey(Photo)\n+\n+"
        },
        {
            "sha": "8ef00e92a5319e516be32899a97653a599442fdb",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 97,
            "deletions": 1,
            "changes": 98,
            "blob_url": "https://github.com/django/django/blob/7e92ad8506e6f312b4feb69e74ef17c42678bc05/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7e92ad8506e6f312b4feb69e74ef17c42678bc05/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=7e92ad8506e6f312b4feb69e74ef17c42678bc05",
            "patch": "@@ -8,7 +8,7 @@\n \n from .models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n     PlayedWithNote, Email, Researcher, Food, Eaten, Policy, Version, Location,\n-    Item)\n+    Item, Image, File, Photo, FooFile, FooImage, FooPhoto)\n \n \n # Can't run this test under SQLite, because you can't\n@@ -147,3 +147,99 @@ def test_large_deletes(self):\n             track = Book.objects.create(pagecount=x+100)\n         Book.objects.all().delete()\n         self.assertEqual(Book.objects.count(), 0)\n+\n+\n+\n+class ProxyDeleteTest(TestCase):\n+    \"\"\"\n+    Tests on_delete behaviour for proxy models. Deleting the *proxy*\n+    instance bubbles through to its non-proxy and *all* referring objects\n+    are deleted.\n+\n+    See #16128.\n+\n+    \"\"\"\n+\n+    def setUp(self):\n+        # Create an Image\n+        self.test_image = Image()\n+        self.test_image.save()\n+        foo_image = FooImage(my_image=self.test_image)\n+        foo_image.save()\n+\n+        # Get the Image instance as a File\n+        test_file = File.objects.get(pk=self.test_image.pk)\n+        foo_file = FooFile(my_file=test_file)\n+        foo_file.save()\n+\n+\n+    def test_delete(self):\n+        Image.objects.all().delete()\n+\n+        # An Image deletion == File deletion\n+        self.assertEqual(len(Image.objects.all()), 0)\n+        self.assertEqual(len(File.objects.all()), 0)\n+\n+        # The Image deletion cascaded and *all* references to it are deleted.\n+        self.assertEqual(len(FooImage.objects.all()), 0)\n+        self.assertEqual(len(FooFile.objects.all()), 0)\n+\n+\n+\n+class ProxyOfProxyDeleteTest(ProxyDeleteTest):\n+    \"\"\"\n+    Tests on_delete behaviour for proxy-of-proxy models. Deleting the *proxy*\n+    instance should bubble through to its proxy and non-proxy variants.\n+    Deleting *all* referring objects.\n+\n+    See #16128.\n+\n+    \"\"\"\n+\n+    def setUp(self):\n+        # Create the Image, FooImage and FooFile instances\n+        super(ProxyOfProxyDeleteTest, self).setUp()\n+\n+        # Get the Image as a Photo\n+        test_photo = Photo.objects.get(pk=self.test_image.pk)\n+        foo_photo = FooPhoto(my_photo=test_photo)\n+        foo_photo.save()\n+\n+\n+    def test_delete(self):\n+        Photo.objects.all().delete()\n+\n+        # A Photo deletion == Image deletion == File deletion\n+        self.assertEqual(len(Photo.objects.all()), 0)\n+        self.assertEqual(len(Image.objects.all()), 0)\n+        self.assertEqual(len(File.objects.all()), 0)\n+\n+        # The Photo deletion should have cascaded and deleted *all*\n+        # references to it.\n+        self.assertEqual(len(FooPhoto.objects.all()), 0)\n+        self.assertEqual(len(FooFile.objects.all()), 0)\n+        self.assertEqual(len(FooImage.objects.all()), 0)\n+\n+\n+\n+class ProxyParentDeleteTest(ProxyDeleteTest):\n+    \"\"\"\n+    Tests on_delete cascade behaviour for proxy models. Deleting the\n+    *non-proxy* instance of a model should delete objects referencing the\n+    proxy.\n+\n+    See #16128.\n+\n+    \"\"\"\n+\n+    def test_delete(self):\n+        File.objects.all().delete()\n+\n+        # A File deletion == Image deletion\n+        self.assertEqual(len(File.objects.all()), 0)\n+        self.assertEqual(len(Image.objects.all()), 0)\n+\n+        # The File deletion should have cascaded and deleted *all* references\n+        # to it.\n+        self.assertEqual(len(FooFile.objects.all()), 0)\n+        self.assertEqual(len(FooImage.objects.all()), 0)"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 142,
        "deletions": 9
    }
}