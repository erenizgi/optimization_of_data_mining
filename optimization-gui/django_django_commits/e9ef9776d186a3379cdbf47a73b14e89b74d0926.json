{
    "author": "claudep",
    "message": "Fixed #18461 -- Ensured that last_executed_query returns Unicode\n\nThanks Anssi Kääriäinen for the review.",
    "sha": "e9ef9776d186a3379cdbf47a73b14e89b74d0926",
    "files": [
        {
            "sha": "f381d4830771457c3f19d7ccf4d40dbfd332647b",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/e9ef9776d186a3379cdbf47a73b14e89b74d0926/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e9ef9776d186a3379cdbf47a73b14e89b74d0926/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=e9ef9776d186a3379cdbf47a73b14e89b74d0926",
            "patch": "@@ -238,7 +238,7 @@ def last_executed_query(self, cursor, sql, params):\n         # With MySQLdb, cursor objects have an (undocumented) \"_last_executed\"\n         # attribute where the exact query sent to the database is saved.\n         # See MySQLdb/cursors.py in the source distribution.\n-        return cursor._last_executed\n+        return cursor._last_executed.decode('utf-8')\n \n     def no_limit_value(self):\n         # 2**64 - 1, as recommended by the MySQL documentation"
        },
        {
            "sha": "e93a15512b9d4b17c5e178185fdc120a2f9e08ea",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/e9ef9776d186a3379cdbf47a73b14e89b74d0926/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/e9ef9776d186a3379cdbf47a73b14e89b74d0926/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=e9ef9776d186a3379cdbf47a73b14e89b74d0926",
            "patch": "@@ -193,7 +193,9 @@ def distinct_sql(self, fields):\n     def last_executed_query(self, cursor, sql, params):\n         # http://initd.org/psycopg/docs/cursor.html#cursor.query\n         # The query attribute is a Psycopg extension to the DB API 2.0.\n-        return cursor.query\n+        if cursor.query is not None:\n+            return cursor.query.decode('utf-8')\n+        return None\n \n     def return_insert_id(self):\n         return \"RETURNING %s\", ()"
        },
        {
            "sha": "cf6b9640703a2d7900e7bf7ece63b584911888aa",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/e9ef9776d186a3379cdbf47a73b14e89b74d0926/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e9ef9776d186a3379cdbf47a73b14e89b74d0926/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=e9ef9776d186a3379cdbf47a73b14e89b74d0926",
            "patch": "@@ -125,20 +125,14 @@ def test_django_extract(self):\n         classes = models.SchoolClass.objects.filter(last_updated__day=20)\n         self.assertEqual(len(classes), 1)\n \n-class LastExecutedQueryTest(TestCase):\n-\n-    def setUp(self):\n-        # connection.queries will not be filled in without this\n-        settings.DEBUG = True\n \n-    def tearDown(self):\n-        settings.DEBUG = False\n-\n-    # There are no tests for the sqlite backend because it does not\n+class LastExecutedQueryTest(TestCase):\n+    # There are no escaping tests for the sqlite backend because it does not\n     # implement paramater escaping. See #14091.\n \n     @unittest.skipUnless(connection.vendor in ('oracle', 'postgresql'),\n                          \"These backends use the standard parameter escaping rules\")\n+    @override_settings(DEBUG=True)\n     def test_parameter_escaping(self):\n         # check that both numbers and string are properly quoted\n         list(models.Tag.objects.filter(name=\"special:\\\\\\\"':\", object_id=12))\n@@ -148,13 +142,25 @@ def test_parameter_escaping(self):\n \n     @unittest.skipUnless(connection.vendor == 'mysql',\n                          \"MySQL uses backslashes to escape parameters.\")\n+    @override_settings(DEBUG=True)\n     def test_parameter_escaping(self):\n         list(models.Tag.objects.filter(name=\"special:\\\\\\\"':\", object_id=12))\n         sql = connection.queries[-1]['sql']\n         # only this line is different from the test above\n         self.assertTrue(\"= 'special:\\\\\\\\\\\\\\\"\\\\':' \" in sql)\n         self.assertTrue(\"= 12 \" in sql)\n \n+    def test_query_encoding(self):\n+        \"\"\"\n+        Test that last_executed_query() returns an Unicode string\n+        \"\"\"\n+        tags = models.Tag.objects.filter(name=\"й\", object_id=12).extra(select={'föö':1})\n+        sql, params = tags.query.sql_with_params()\n+        cursor = tags.query.get_compiler('default').execute_sql(None)\n+        last_sql = cursor.db.ops.last_executed_query(cursor, sql, params)\n+        self.assertTrue(isinstance(last_sql, unicode))\n+\n+\n class ParameterHandlingTest(TestCase):\n     def test_bad_parameter_count(self):\n         \"An executemany call with too many/not enough parameters will raise an exception (Refs #12612)\""
        }
    ],
    "stats": {
        "total": 30,
        "additions": 19,
        "deletions": 11
    }
}