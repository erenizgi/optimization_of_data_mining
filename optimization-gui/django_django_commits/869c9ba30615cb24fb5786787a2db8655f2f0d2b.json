{
    "author": "ramiro",
    "message": "Fixed #19730 -- Don't validate importability of settings by using i18n in management commands.\n\nThey are handled independently now and the latter can be influenced by\nthe new BaseCommand.leave_locale_alone internal option.\n\nThanks chrischambers for the report, Claude, lpiatek, neaf and gabooo for\ntheir work on a patch, originally on refs. #17379.",
    "sha": "869c9ba30615cb24fb5786787a2db8655f2f0d2b",
    "files": [
        {
            "sha": "9dc321a06130d3f660febafb2d433958c2e2ff19",
            "filename": "django/core/management/base.py",
            "status": "modified",
            "additions": 36,
            "deletions": 9,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fbase.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -143,6 +143,22 @@ class BaseCommand(object):\n         ``self.validate(app)`` from ``handle()``, where ``app`` is the\n         application's Python module.\n \n+    ``leave_locale_alone``\n+        A boolean indicating whether the locale set in settings should be\n+        preserved during the execution of the command instead of being\n+        forcibly set to 'en-us'.\n+\n+        Default value is ``False``.\n+\n+        Make sure you know what you are doing if you decide to change the value\n+        of this option in your custom command because many of them create\n+        database content that is locale-sensitive (like permissions) and that\n+        content shouldn't contain any translations so making the locale differ\n+        from the de facto default 'en-us' can cause unintended effects.\n+\n+        This option can't be False when the can_import_settings option is set\n+        to False too because attempting to set the locale needs access to\n+        settings. This condition will generate a CommandError.\n     \"\"\"\n     # Metadata about this command.\n     option_list = (\n@@ -163,6 +179,7 @@ class BaseCommand(object):\n     can_import_settings = True\n     requires_model_validation = True\n     output_transaction = False  # Whether to wrap the output in a \"BEGIN; COMMIT;\"\n+    leave_locale_alone = False\n \n     def __init__(self):\n         self.style = color_style()\n@@ -235,18 +252,28 @@ def execute(self, *args, **options):\n         needed (as controlled by the attribute\n         ``self.requires_model_validation``, except if force-skipped).\n         \"\"\"\n-\n-        # Switch to English, because django-admin.py creates database content\n-        # like permissions, and those shouldn't contain any translations.\n-        # But only do this if we can assume we have a working settings file,\n-        # because django.utils.translation requires settings.\n-        saved_lang = None\n         self.stdout = OutputWrapper(options.get('stdout', sys.stdout))\n         self.stderr = OutputWrapper(options.get('stderr', sys.stderr), self.style.ERROR)\n \n         if self.can_import_settings:\n+            from django.conf import settings\n+\n+        saved_locale = None\n+        if not self.leave_locale_alone:\n+            # Only mess with locales if we can assume we have a working\n+            # settings file, because django.utils.translation requires settings\n+            # (The final saying about whether the i18n machinery is active will be\n+            # found in the value of the USE_I18N setting)\n+            if not self.can_import_settings:\n+                raise CommandError(\"Incompatible values of 'leave_locale_alone' \"\n+                                   \"(%s) and 'can_import_settings' (%s) command \"\n+                                   \"options.\" % (self.leave_locale_alone,\n+                                                 self.can_import_settings))\n+            # Switch to US English, because django-admin.py creates database\n+            # content like permissions, and those shouldn't contain any\n+            # translations.\n             from django.utils import translation\n-            saved_lang = translation.get_language()\n+            saved_locale = translation.get_language()\n             translation.activate('en-us')\n \n         try:\n@@ -265,8 +292,8 @@ def execute(self, *args, **options):\n                 if self.output_transaction:\n                     self.stdout.write('\\n' + self.style.SQL_KEYWORD(\"COMMIT;\"))\n         finally:\n-            if saved_lang is not None:\n-                translation.activate(saved_lang)\n+            if saved_locale is not None:\n+                translation.activate(saved_locale)\n \n     def validate(self, app=None, display_num_errors=False):\n         \"\"\""
        },
        {
            "sha": "8f2c1ff771df8ce6d29ec7201fd5b7a27b5fde7f",
            "filename": "django/core/management/commands/compilemessages.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -63,7 +63,7 @@ class Command(BaseCommand):\n     help = 'Compiles .po files to .mo files for use with builtin gettext support.'\n \n     requires_model_validation = False\n-    can_import_settings = False\n+    leave_locale_alone = True\n \n     def handle(self, **options):\n         locale = options.get('locale')"
        },
        {
            "sha": "daa4c5f0232cce4e05cc22d84035a5c2a99540bc",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -189,7 +189,7 @@ class Command(NoArgsCommand):\n \"--locale or --all options.\")\n \n     requires_model_validation = False\n-    can_import_settings = False\n+    leave_locale_alone = True\n \n     def handle_noargs(self, *args, **options):\n         locale = options.get('locale')"
        },
        {
            "sha": "5ce50b4dfdaa96303767c35746340f583b669c39",
            "filename": "django/core/management/templates.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Ftemplates.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/django%2Fcore%2Fmanagement%2Ftemplates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Ftemplates.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -61,6 +61,9 @@ class TemplateCommand(BaseCommand):\n     can_import_settings = False\n     # The supported URL schemes\n     url_schemes = ['http', 'https', 'ftp']\n+    # Can't perform any active locale changes during this command, because\n+    # setting might not be available at all.\n+    leave_locale_alone = True\n \n     def handle(self, app_or_project, name, target=None, **options):\n         self.app_or_project = app_or_project"
        },
        {
            "sha": "eba187bb375609d2ac92581390b9564bb33fe618",
            "filename": "docs/howto/custom-management-commands.txt",
            "status": "modified",
            "additions": 65,
            "deletions": 35,
            "changes": 100,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/docs%2Fhowto%2Fcustom-management-commands.txt",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/docs%2Fhowto%2Fcustom-management-commands.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fcustom-management-commands.txt?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -112,54 +112,61 @@ In addition to being able to add custom command line options, all\n :doc:`management commands</ref/django-admin>` can accept some\n default options such as :djadminopt:`--verbosity` and :djadminopt:`--traceback`.\n \n-.. admonition:: Management commands and locales\n+.. _management-commands-and-locales:\n \n-    The :meth:`BaseCommand.execute` method sets the hardcoded ``en-us`` locale\n-    because the commands shipped with Django perform several tasks\n-    (for example, user-facing content rendering and database population) that\n-    require a system-neutral string language (for which we use ``en-us``).\n+Management commands and locales\n+===============================\n \n-    If your custom management command uses another locale, you should manually\n-    activate and deactivate it in your :meth:`~BaseCommand.handle` or\n-    :meth:`~NoArgsCommand.handle_noargs` method using the functions provided by\n-    the I18N support code:\n+By default, the :meth:`BaseCommand.execute` method sets the hardcoded 'en-us'\n+locale because most of the commands shipped with Django perform several tasks\n+(for example, user-facing content rendering and database population) that\n+require a system-neutral string language (for which we use 'en-us').\n \n-    .. code-block:: python\n+If, for some reason, your custom management command needs to use a fixed locale\n+different from 'en-us', you should manually activate and deactivate it in your\n+:meth:`~BaseCommand.handle` or :meth:`~NoArgsCommand.handle_noargs` method using\n+the functions provided by the I18N support code:\n \n-        from django.core.management.base import BaseCommand, CommandError\n-        from django.utils import translation\n+.. code-block:: python\n \n-        class Command(BaseCommand):\n-            ...\n-            can_import_settings = True\n+    from django.core.management.base import BaseCommand, CommandError\n+    from django.utils import translation\n \n-            def handle(self, *args, **options):\n+    class Command(BaseCommand):\n+        ...\n+        can_import_settings = True\n \n-                # Activate a fixed locale, e.g. Russian\n-                translation.activate('ru')\n+        def handle(self, *args, **options):\n \n-                # Or you can activate the LANGUAGE_CODE\n-                # chosen in the settings:\n-                #\n-                #from django.conf import settings\n-                #translation.activate(settings.LANGUAGE_CODE)\n+            # Activate a fixed locale, e.g. Russian\n+            translation.activate('ru')\n+\n+            # Or you can activate the LANGUAGE_CODE # chosen in the settings:\n+            #\n+            #from django.conf import settings\n+            #translation.activate(settings.LANGUAGE_CODE)\n+\n+            # Your command logic here\n+            # ...\n \n-                # Your command logic here\n-                # ...\n+            translation.deactivate()\n \n-                translation.deactivate()\n+Another need might be that your command simply should use the locale set in\n+settings and Django should be kept from forcing it to 'en-us'. You can achieve\n+it by using the :data:`BaseCommand.leave_locale_alone` option.\n \n-    Take into account though, that system management commands typically have to\n-    be very careful about running in non-uniform locales, so:\n+When working on the scenarios described above though, take into account that\n+system management commands typically have to be very careful about running in\n+non-uniform locales, so you might need to:\n \n-    * Make sure the :setting:`USE_I18N` setting is always ``True`` when running\n-      the command (this is one good example of the potential problems stemming\n-      from a dynamic runtime environment that Django commands avoid offhand by\n-      always using a fixed locale).\n+* Make sure the :setting:`USE_I18N` setting is always ``True`` when running\n+  the command (this is a good example of the potential problems stemming\n+  from a dynamic runtime environment that Django commands avoid offhand by\n+  always using a fixed locale).\n \n-    * Review the code of your command and the code it calls for behavioral\n-      differences when locales are changed and evaluate its impact on\n-      predictable behavior of your command.\n+* Review the code of your command and the code it calls for behavioral\n+  differences when locales are changed and evaluate its impact on\n+  predictable behavior of your command.\n \n Command objects\n ===============\n@@ -222,6 +229,29 @@ All attributes can be set in your derived class and can be used in\n   rather than all applications' models, call\n   :meth:`~BaseCommand.validate` from :meth:`~BaseCommand.handle`.\n \n+.. attribute:: BaseCommand.leave_locale_alone\n+\n+  A boolean indicating whether the locale set in settings should be preserved\n+  during the execution of the command instead of being forcibly set to 'en-us'.\n+\n+  Default value is ``False``.\n+\n+  Make sure you know what you are doing if you decide to change the value of\n+  this option in your custom command because many of them create database\n+  content that is locale-sensitive (like permissions) and that content\n+  shouldn't contain any translations so making the locale differ from the de\n+  facto default 'en-us' can cause unintended effects. See the `Management\n+  commands and locales`_ section above for further details.\n+\n+  This option can't be ``False`` when the\n+  :data:`~BaseCommand.can_import_settings` option is set to ``False`` too\n+  because attempting to set the locale needs access to settings. This condition\n+  will generate a :class:`CommandError`.\n+\n+.. versionadded:: 1.6\n+\n+    The ``leave_locale_alone`` option was added in Django 1.6.\n+\n Methods\n -------\n "
        },
        {
            "sha": "acc273cef4417a2d46a26fd8e907198a30cd06a4",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -39,6 +39,14 @@ Minor features\n   <lazy-plural-translations>` can be provided at translation time rather than\n   at definition time.\n \n+* For custom managemente commands: Validation of the presence of valid settings\n+  in managements commands that ask for it by using the\n+  :attr:`~django.core.management.BaseCommand.can_import_settings` internal\n+  option is now performed independently from handling of the locale that should\n+  active during the execution of the command. The latter can now be influenced\n+  by the new :attr:`~django.core.management.BaseCommand.leave_locale_alone`\n+  internal option. See :ref:`management-commands-and-locales` for more details.\n+\n Backwards incompatible changes in 1.6\n =====================================\n "
        },
        {
            "sha": "8ebb607d5a5e9a9a02a086429d73046080972a52",
            "filename": "tests/modeltests/user_commands/management/commands/leave_locale_alone_false.py",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fleave_locale_alone_false.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fleave_locale_alone_false.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fleave_locale_alone_false.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -0,0 +1,10 @@\n+from django.core.management.base import BaseCommand\n+from django.utils import translation\n+\n+class Command(BaseCommand):\n+\n+    can_import_settings = True\n+    leave_locale_alone = False\n+\n+    def handle(self, *args, **options):\n+        return translation.get_language()"
        },
        {
            "sha": "e0f923591e5ff6d651efbbdef1aa61ea4ad77300",
            "filename": "tests/modeltests/user_commands/management/commands/leave_locale_alone_true.py",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fleave_locale_alone_true.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fleave_locale_alone_true.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fleave_locale_alone_true.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -0,0 +1,10 @@\n+from django.core.management.base import BaseCommand\n+from django.utils import translation\n+\n+class Command(BaseCommand):\n+\n+    can_import_settings = True\n+    leave_locale_alone = True\n+\n+    def handle(self, *args, **options):\n+        return translation.get_language()"
        },
        {
            "sha": "c8740577a553bb87d4f09240b316f0a56f948f1c",
            "filename": "tests/modeltests/user_commands/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fmodeltests%2Fuser_commands%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fmodeltests%2Fuser_commands%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fuser_commands%2Ftests.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -44,3 +44,17 @@ def test_system_exit(self):\n         finally:\n             sys.stderr = old_stderr\n         self.assertIn(\"CommandError\", err.getvalue())\n+\n+    def test_default_en_us_locale_set(self):\n+        # Forces en_us when set to true\n+        out = StringIO()\n+        with translation.override('pl'):\n+            management.call_command('leave_locale_alone_false', stdout=out)\n+            self.assertEqual(out.getvalue(), \"en-us\\n\")\n+\n+    def test_configured_locale_preserved(self):\n+        # Leaves locale from settings when set to false\n+        out = StringIO()\n+        with translation.override('pl'):\n+            management.call_command('leave_locale_alone_true', stdout=out)\n+            self.assertEqual(out.getvalue(), \"pl\\n\")"
        },
        {
            "sha": "ca89f30de85566df464dfc5c3f754bdadb650758",
            "filename": "tests/regressiontests/i18n/commands/extraction.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "raw_url": "https://github.com/django/django/raw/869c9ba30615cb24fb5786787a2db8655f2f0d2b/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py?ref=869c9ba30615cb24fb5786787a2db8655f2f0d2b",
            "patch": "@@ -110,6 +110,11 @@ def test_templatize_blocktrans_tag(self):\n             self.assertMsgId('I think that 100%% is more that 50%% of %(obj)s.', po_contents)\n             self.assertMsgId(\"Blocktrans extraction shouldn't double escape this: %%, a=%(a)s\", po_contents)\n \n+    def test_force_en_us_locale(self):\n+        \"\"\"Value of locale-munging option used by the command is the right one\"\"\"\n+        from django.core.management.commands.makemessages import Command\n+        self.assertTrue(Command.leave_locale_alone)\n+\n     def test_extraction_error(self):\n         os.chdir(self.test_dir)\n         self.assertRaises(SyntaxError, management.call_command, 'makemessages', locale=LOCALE, extensions=['tpl'], verbosity=0)"
        }
    ],
    "stats": {
        "total": 199,
        "additions": 153,
        "deletions": 46
    }
}