{
    "author": "aaugustin",
    "message": "Added support for time zones. Thanks Luke Plant for the review. Fixed #2626.\n\nFor more information on this project, see this thread:\nhttp://groups.google.com/group/django-developers/browse_thread/thread/cf0423bbb85b1bbf\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17106 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "9b1cb755a28f020e27d4268c214b25315d4de42e",
    "files": [
        {
            "sha": "2ef2f63618f3ccf900a3e4446471eeb32db60377",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -31,9 +31,13 @@\n \n # Local time zone for this installation. All choices can be found here:\n # http://en.wikipedia.org/wiki/List_of_tz_zones_by_name (although not all\n-# systems may support all possibilities).\n+# systems may support all possibilities). When USE_TZ is True, this is\n+# interpreted as the default user time zone.\n TIME_ZONE = 'America/Chicago'\n \n+# If you set this to True, Django will use timezone-aware datetimes.\n+USE_TZ = False\n+\n # Language code for this installation. All choices can be found here:\n # http://www.i18nguy.com/unicode/language-identifiers.html\n LANGUAGE_CODE = 'en-us'\n@@ -119,7 +123,7 @@\n LANGUAGE_COOKIE_NAME = 'django_language'\n \n # If you set this to True, Django will format dates, numbers and calendars\n-# according to user current locale\n+# according to user current locale.\n USE_L10N = False\n \n # Not-necessarily-technical managers of the site. They get broken link\n@@ -192,6 +196,7 @@\n     'django.core.context_processors.i18n',\n     'django.core.context_processors.media',\n     'django.core.context_processors.static',\n+    'django.core.context_processors.tz',\n #    'django.core.context_processors.request',\n     'django.contrib.messages.context_processors.messages',\n )"
        },
        {
            "sha": "f28c61e15d5bad14cead05d7e1d6a580cf8f0f05",
            "filename": "django/conf/project_template/project_name/settings.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fconf%2Fproject_template%2Fproject_name%2Fsettings.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fconf%2Fproject_template%2Fproject_name%2Fsettings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fproject_template%2Fproject_name%2Fsettings.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -40,9 +40,12 @@\n USE_I18N = True\n \n # If you set this to False, Django will not format dates, numbers and\n-# calendars according to the current locale\n+# calendars according to the current locale.\n USE_L10N = True\n \n+# If you set this to False, Django will not use timezone-aware datetimes.\n+USE_TZ = True\n+\n # Absolute filesystem path to the directory that will hold user-uploaded files.\n # Example: \"/home/media/media.lawrence.com/media/\"\n MEDIA_ROOT = ''"
        },
        {
            "sha": "af8fad382e25ba18fc7180db8041a9eb2103925f",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -7,6 +7,7 @@\n from django.utils.html import escape\n from django.utils.safestring import mark_safe\n from django.utils.text import capfirst\n+from django.utils import timezone\n from django.utils.encoding import force_unicode, smart_unicode, smart_str\n from django.utils.translation import ungettext\n from django.core.urlresolvers import reverse\n@@ -293,6 +294,8 @@ def display_for_field(value, field):\n         return _boolean_icon(value)\n     elif value is None:\n         return EMPTY_CHANGELIST_VALUE\n+    elif isinstance(field, models.DateTimeField):\n+        return formats.localize(timezone.aslocaltime(value))\n     elif isinstance(field, models.DateField) or isinstance(field, models.TimeField):\n         return formats.localize(value)\n     elif isinstance(field, models.DecimalField):"
        },
        {
            "sha": "b075ff05c7cf0d53ff5008552390bfcd7405f005",
            "filename": "django/contrib/humanize/templatetags/humanize.py",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -7,7 +7,7 @@\n from django.utils.encoding import force_unicode\n from django.utils.formats import number_format\n from django.utils.translation import pgettext, ungettext, ugettext as _\n-from django.utils.tzinfo import LocalTimezone\n+from django.utils.timezone import is_aware, utc\n \n register = template.Library()\n \n@@ -158,8 +158,8 @@ def naturalday(value, arg=None):\n     except ValueError:\n         # Date arguments out of range\n         return value\n-    today = datetime.now(tzinfo).replace(microsecond=0, second=0, minute=0, hour=0)\n-    delta = value - today.date()\n+    today = datetime.now(tzinfo).date()\n+    delta = value - today\n     if delta.days == 0:\n         return _(u'today')\n     elif delta.days == 1:\n@@ -174,18 +174,10 @@ def naturaltime(value):\n     For date and time values shows how many seconds, minutes or hours ago\n     compared to current timestamp returns representing string.\n     \"\"\"\n-    try:\n-        value = datetime(value.year, value.month, value.day, value.hour, value.minute, value.second)\n-    except AttributeError:\n-        return value\n-    except ValueError:\n+    if not isinstance(value, date): # datetime is a subclass of date\n         return value\n \n-    if getattr(value, 'tzinfo', None):\n-        now = datetime.now(LocalTimezone(value))\n-    else:\n-        now = datetime.now()\n-    now = now - timedelta(0, 0, now.microsecond)\n+    now = datetime.now(utc if is_aware(value) else None)\n     if value < now:\n         delta = now - value\n         if delta.days != 0:"
        },
        {
            "sha": "0217136b11c851708c657963e6c36b728ee65f84",
            "filename": "django/contrib/humanize/tests.py",
            "status": "modified",
            "additions": 42,
            "deletions": 30,
            "changes": 72,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fhumanize%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fhumanize%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -1,11 +1,12 @@\n from __future__ import with_statement\n-from datetime import timedelta, date, datetime\n+import datetime\n \n from django.template import Template, Context, defaultfilters\n from django.test import TestCase\n from django.utils import translation, tzinfo\n from django.utils.translation import ugettext as _\n from django.utils.html import escape\n+from django.utils.timezone import utc\n \n \n class HumanizeTests(TestCase):\n@@ -88,10 +89,10 @@ def test_apnumber(self):\n         self.humanize_tester(test_list, result_list, 'apnumber')\n \n     def test_naturalday(self):\n-        today = date.today()\n-        yesterday = today - timedelta(days=1)\n-        tomorrow = today + timedelta(days=1)\n-        someday = today - timedelta(days=10)\n+        today = datetime.date.today()\n+        yesterday = today - datetime.timedelta(days=1)\n+        tomorrow = today + datetime.timedelta(days=1)\n+        someday = today - datetime.timedelta(days=10)\n         notdate = u\"I'm not a date value\"\n \n         test_list = (today, yesterday, tomorrow, someday, notdate, None)\n@@ -103,41 +104,46 @@ def test_naturalday(self):\n     def test_naturalday_tz(self):\n         from django.contrib.humanize.templatetags.humanize import naturalday\n \n-        today = date.today()\n-        tz_one = tzinfo.FixedOffset(timedelta(hours=-12))\n-        tz_two = tzinfo.FixedOffset(timedelta(hours=12))\n+        today = datetime.date.today()\n+        tz_one = tzinfo.FixedOffset(datetime.timedelta(hours=-12))\n+        tz_two = tzinfo.FixedOffset(datetime.timedelta(hours=12))\n \n         # Can be today or yesterday\n-        date_one = datetime(today.year, today.month, today.day, tzinfo=tz_one)\n+        date_one = datetime.datetime(today.year, today.month, today.day, tzinfo=tz_one)\n         naturalday_one = naturalday(date_one)\n         # Can be today or tomorrow\n-        date_two = datetime(today.year, today.month, today.day, tzinfo=tz_two)\n+        date_two = datetime.datetime(today.year, today.month, today.day, tzinfo=tz_two)\n         naturalday_two = naturalday(date_two)\n \n         # As 24h of difference they will never be the same\n         self.assertNotEqual(naturalday_one, naturalday_two)\n \n     def test_naturaltime(self):\n+        class naive(datetime.tzinfo):\n+            def utcoffset(self, dt):\n+                return None\n         # we're going to mock datetime.datetime, so use a fixed datetime\n-        now = datetime(2011, 8, 15)\n+        now = datetime.datetime(2011, 8, 15)\n         test_list = [\n             now,\n-            now - timedelta(seconds=1),\n-            now - timedelta(seconds=30),\n-            now - timedelta(minutes=1, seconds=30),\n-            now - timedelta(minutes=2),\n-            now - timedelta(hours=1, minutes=30, seconds=30),\n-            now - timedelta(hours=23, minutes=50, seconds=50),\n-            now - timedelta(days=1),\n-            now - timedelta(days=500),\n-            now + timedelta(seconds=1),\n-            now + timedelta(seconds=30),\n-            now + timedelta(minutes=1, seconds=30),\n-            now + timedelta(minutes=2),\n-            now + timedelta(hours=1, minutes=30, seconds=30),\n-            now + timedelta(hours=23, minutes=50, seconds=50),\n-            now + timedelta(days=1),\n-            now + timedelta(days=500),\n+            now - datetime.timedelta(seconds=1),\n+            now - datetime.timedelta(seconds=30),\n+            now - datetime.timedelta(minutes=1, seconds=30),\n+            now - datetime.timedelta(minutes=2),\n+            now - datetime.timedelta(hours=1, minutes=30, seconds=30),\n+            now - datetime.timedelta(hours=23, minutes=50, seconds=50),\n+            now - datetime.timedelta(days=1),\n+            now - datetime.timedelta(days=500),\n+            now + datetime.timedelta(seconds=1),\n+            now + datetime.timedelta(seconds=30),\n+            now + datetime.timedelta(minutes=1, seconds=30),\n+            now + datetime.timedelta(minutes=2),\n+            now + datetime.timedelta(hours=1, minutes=30, seconds=30),\n+            now + datetime.timedelta(hours=23, minutes=50, seconds=50),\n+            now + datetime.timedelta(days=1),\n+            now + datetime.timedelta(days=500),\n+            now.replace(tzinfo=naive()),\n+            now.replace(tzinfo=utc),\n         ]\n         result_list = [\n             'now',\n@@ -157,14 +163,20 @@ def test_naturaltime(self):\n             '23 hours from now',\n             '1 day from now',\n             '1 year, 4 months from now',\n+            'now',\n+            'now',\n         ]\n \n         # mock out datetime so these tests don't fail occasionally when the\n         # test runs too slow\n-        class MockDateTime(datetime):\n+        class MockDateTime(datetime.datetime):\n             @classmethod\n-            def now(self):\n-                return now\n+            def now(self, tz=None):\n+                if tz is None or tz.utcoffset(now) is None:\n+                    return now\n+                else:\n+                    # equals now.replace(tzinfo=utc)\n+                    return now.replace(tzinfo=tz) + tz.utcoffset(now)\n \n         # naturaltime also calls timesince/timeuntil\n         from django.contrib.humanize.templatetags import humanize"
        },
        {
            "sha": "a6e18e3cd8de112d600fef9d123be97461a1593d",
            "filename": "django/contrib/syndication/views.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fsyndication%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcontrib%2Fsyndication%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsyndication%2Fviews.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -6,6 +6,7 @@\n from django.utils import feedgenerator, tzinfo\n from django.utils.encoding import force_unicode, iri_to_uri, smart_unicode\n from django.utils.html import escape\n+from django.utils.timezone import is_naive\n \n def add_domain(domain, url, secure=False):\n     if not (url.startswith('http://')\n@@ -164,7 +165,7 @@ def get_feed(self, obj, request):\n                 author_email = author_link = None\n \n             pubdate = self.__get_dynamic_attr('item_pubdate', item)\n-            if pubdate and not pubdate.tzinfo:\n+            if pubdate and is_naive(pubdate):\n                 ltz = tzinfo.LocalTimezone(pubdate)\n                 pubdate = pubdate.replace(tzinfo=ltz)\n "
        },
        {
            "sha": "80f1e76d35b8a700ded913db091c8fbe6f96b529",
            "filename": "django/core/context_processors.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcore%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcore%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcontext_processors.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -48,6 +48,11 @@ def i18n(request):\n \n     return context_extras\n \n+def tz(request):\n+    from django.utils import timezone\n+\n+    return {'TIME_ZONE': timezone.get_current_timezone_name()}\n+\n def static(request):\n     \"\"\"\n     Adds static-related context variables to the context."
        },
        {
            "sha": "2b4b2a382bc4963e43095c94bf0b24cd7714c0f7",
            "filename": "django/core/serializers/json.py",
            "status": "modified",
            "additions": 15,
            "deletions": 10,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcore%2Fserializers%2Fjson.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fcore%2Fserializers%2Fjson.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fserializers%2Fjson.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -8,8 +8,8 @@\n \n from django.core.serializers.python import Serializer as PythonSerializer\n from django.core.serializers.python import Deserializer as PythonDeserializer\n-from django.utils import datetime_safe\n from django.utils import simplejson\n+from django.utils.timezone import is_aware\n \n class Serializer(PythonSerializer):\n     \"\"\"\n@@ -39,19 +39,24 @@ class DjangoJSONEncoder(simplejson.JSONEncoder):\n     \"\"\"\n     JSONEncoder subclass that knows how to encode date/time and decimal types.\n     \"\"\"\n-\n-    DATE_FORMAT = \"%Y-%m-%d\"\n-    TIME_FORMAT = \"%H:%M:%S\"\n-\n     def default(self, o):\n+        # See \"Date Time String Format\" in the ECMA-262 specification.\n         if isinstance(o, datetime.datetime):\n-            d = datetime_safe.new_datetime(o)\n-            return d.strftime(\"%s %s\" % (self.DATE_FORMAT, self.TIME_FORMAT))\n+            r = o.isoformat()\n+            if o.microsecond:\n+                r = r[:23] + r[26:]\n+            if r.endswith('+00:00'):\n+                r = r[:-6] + 'Z'\n+            return r\n         elif isinstance(o, datetime.date):\n-            d = datetime_safe.new_date(o)\n-            return d.strftime(self.DATE_FORMAT)\n+            return o.isoformat()\n         elif isinstance(o, datetime.time):\n-            return o.strftime(self.TIME_FORMAT)\n+            if is_aware(o):\n+                raise ValueError(\"JSON can't represent timezone-aware times.\")\n+            r = o.isoformat()\n+            if o.microsecond:\n+                r = r[:12]\n+            return r\n         elif isinstance(o, decimal.Decimal):\n             return str(o)\n         else:"
        },
        {
            "sha": "dd248787e2e63c02e7ed39b5da8fe0c9236fd2e8",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -10,6 +10,7 @@\n from django.db.backends import util\n from django.db.transaction import TransactionManagementError\n from django.utils.importlib import import_module\n+from django.utils.timezone import is_aware\n \n \n class BaseDatabaseWrapper(local):\n@@ -743,6 +744,8 @@ def value_to_db_time(self, value):\n         \"\"\"\n         if value is None:\n             return None\n+        if is_aware(value):\n+            raise ValueError(\"Django does not support timezone-aware times.\")\n         return unicode(value)\n \n     def value_to_db_decimal(self, value, max_digits, decimal_places):"
        },
        {
            "sha": "93aaf9971a297014ca100f0bcec34f7f51e92c18",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -33,6 +33,7 @@\n from django.db.backends.mysql.introspection import DatabaseIntrospection\n from django.db.backends.mysql.validation import DatabaseValidation\n from django.utils.safestring import SafeString, SafeUnicode\n+from django.utils.timezone import is_aware, is_naive, utc\n \n # Raise exceptions for database warnings if DEBUG is on\n from django.conf import settings\n@@ -43,16 +44,29 @@\n DatabaseError = Database.DatabaseError\n IntegrityError = Database.IntegrityError\n \n+# It's impossible to import datetime_or_None directly from MySQLdb.times\n+datetime_or_None = conversions[FIELD_TYPE.DATETIME]\n+\n+def datetime_or_None_with_timezone_support(value):\n+    dt = datetime_or_None(value)\n+    # Confirm that dt is naive before overwriting its tzinfo.\n+    if dt is not None and settings.USE_TZ and is_naive(dt):\n+        dt = dt.replace(tzinfo=utc)\n+    return dt\n+\n # MySQLdb-1.2.1 returns TIME columns as timedelta -- they are more like\n # timedelta in terms of actual behavior as they are signed and include days --\n # and Django expects time, so we still need to override that. We also need to\n # add special handling for SafeUnicode and SafeString as MySQLdb's type\n # checking is too tight to catch those (see Django ticket #6052).\n+# Finally, MySQLdb always returns naive datetime objects. However, when\n+# timezone support is active, Django expects timezone-aware datetime objects.\n django_conversions = conversions.copy()\n django_conversions.update({\n     FIELD_TYPE.TIME: util.typecast_time,\n     FIELD_TYPE.DECIMAL: util.typecast_decimal,\n     FIELD_TYPE.NEWDECIMAL: util.typecast_decimal,\n+    FIELD_TYPE.DATETIME: datetime_or_None_with_timezone_support,\n })\n \n # This should match the numerical portion of the version numbers (we can treat\n@@ -238,8 +252,11 @@ def value_to_db_datetime(self, value):\n             return None\n \n         # MySQL doesn't support tz-aware datetimes\n-        if value.tzinfo is not None:\n-            raise ValueError(\"MySQL backend does not support timezone-aware datetimes.\")\n+        if is_aware(value):\n+            if settings.USE_TZ:\n+                value = value.astimezone(utc).replace(tzinfo=None)\n+            else:\n+                raise ValueError(\"MySQL backend does not support timezone-aware datetimes when USE_TZ is False.\")\n \n         # MySQL doesn't support microseconds\n         return unicode(value.replace(microsecond=0))\n@@ -248,9 +265,9 @@ def value_to_db_time(self, value):\n         if value is None:\n             return None\n \n-        # MySQL doesn't support tz-aware datetimes\n-        if value.tzinfo is not None:\n-            raise ValueError(\"MySQL backend does not support timezone-aware datetimes.\")\n+        # MySQL doesn't support tz-aware times\n+        if is_aware(value):\n+            raise ValueError(\"MySQL backend does not support timezone-aware times.\")\n \n         # MySQL doesn't support microseconds\n         return unicode(value.replace(microsecond=0))"
        },
        {
            "sha": "c1974225f673276e12354ca7660ee896f678998f",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 36,
            "deletions": 9,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -44,13 +44,15 @@ def _setup_environment(environ):\n     from django.core.exceptions import ImproperlyConfigured\n     raise ImproperlyConfigured(\"Error loading cx_Oracle module: %s\" % e)\n \n+from django.conf import settings\n from django.db import utils\n from django.db.backends import *\n from django.db.backends.signals import connection_created\n from django.db.backends.oracle.client import DatabaseClient\n from django.db.backends.oracle.creation import DatabaseCreation\n from django.db.backends.oracle.introspection import DatabaseIntrospection\n from django.utils.encoding import smart_str, force_unicode\n+from django.utils.timezone import is_aware, is_naive, utc\n \n DatabaseError = Database.DatabaseError\n IntegrityError = Database.IntegrityError\n@@ -333,11 +335,17 @@ def tablespace_sql(self, tablespace, inline=False):\n             return \"TABLESPACE %s\" % self.quote_name(tablespace)\n \n     def value_to_db_datetime(self, value):\n+        if value is None:\n+            return None\n+\n         # Oracle doesn't support tz-aware datetimes\n-        if getattr(value, 'tzinfo', None) is not None:\n-            raise ValueError(\"Oracle backend does not support timezone-aware datetimes.\")\n+        if is_aware(value):\n+            if settings.USE_TZ:\n+                value = value.astimezone(utc).replace(tzinfo=None)\n+            else:\n+                raise ValueError(\"Oracle backend does not support timezone-aware datetimes when USE_TZ is False.\")\n \n-        return super(DatabaseOperations, self).value_to_db_datetime(value)\n+        return unicode(value)\n \n     def value_to_db_time(self, value):\n         if value is None:\n@@ -346,9 +354,9 @@ def value_to_db_time(self, value):\n         if isinstance(value, basestring):\n             return datetime.datetime.strptime(value, '%H:%M:%S')\n \n-        # Oracle doesn't support tz-aware datetimes\n-        if value.tzinfo is not None:\n-            raise ValueError(\"Oracle backend does not support timezone-aware datetimes.\")\n+        # Oracle doesn't support tz-aware times\n+        if is_aware(value):\n+            raise ValueError(\"Oracle backend does not support timezone-aware times.\")\n \n         return datetime.datetime(1900, 1, 1, value.hour, value.minute,\n                                  value.second, value.microsecond)\n@@ -472,9 +480,28 @@ def _cursor(self):\n             # Set oracle date to ansi date format.  This only needs to execute\n             # once when we create a new connection. We also set the Territory\n             # to 'AMERICA' which forces Sunday to evaluate to a '1' in TO_CHAR().\n-            cursor.execute(\"ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD HH24:MI:SS' \"\n-                           \"NLS_TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS.FF' \"\n-                           \"NLS_TERRITORY = 'AMERICA'\")\n+            cursor.execute(\"ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD HH24:MI:SS'\"\n+                           \" NLS_TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS.FF'\"\n+                           \" NLS_TERRITORY = 'AMERICA'\"\n+                           + (\" TIME_ZONE = 'UTC'\" if settings.USE_TZ else ''))\n+\n+            def datetime_converter(dt):\n+                # Confirm that dt is naive before overwriting its tzinfo.\n+                if dt is not None and is_naive(dt):\n+                    dt = dt.replace(tzinfo=utc)\n+                return dt\n+\n+            def output_type_handler(cursor, name, default_type,\n+                                    size, precision, scale):\n+                # datetimes are returned as TIMESTAMP, except the results\n+                # of \"dates\" queries, which are returned as DATETIME.\n+                if settings.USE_TZ and default_type in (Database.TIMESTAMP,\n+                                                        Database.DATETIME):\n+                    return cursor.var(default_type,\n+                                      arraysize=cursor.arraysize,\n+                                      outconverter=datetime_converter)\n+\n+            self.connection.outputtypehandler = output_type_handler\n \n             if 'operators' not in self.__dict__:\n                 # Ticket #14149: Check whether our LIKE implementation will"
        },
        {
            "sha": "87df6bd1bc864991cce820a38cf2f8906fe98cd3",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -13,8 +13,9 @@\n from django.db.backends.postgresql_psycopg2.creation import DatabaseCreation\n from django.db.backends.postgresql_psycopg2.version import get_version\n from django.db.backends.postgresql_psycopg2.introspection import DatabaseIntrospection\n-from django.utils.safestring import SafeUnicode, SafeString\n from django.utils.log import getLogger\n+from django.utils.safestring import SafeUnicode, SafeString\n+from django.utils.timezone import utc\n \n try:\n     import psycopg2 as Database\n@@ -32,6 +33,11 @@\n \n logger = getLogger('django.db.backends')\n \n+def utc_tzinfo_factory(offset):\n+    if offset != 0:\n+        raise AssertionError(\"database connection isn't set to UTC\")\n+    return utc\n+\n class CursorWrapper(object):\n     \"\"\"\n     A thin wrapper around psycopg2's normal cursor class so that we can catch\n@@ -144,11 +150,9 @@ def _get_pg_version(self):\n \n     def _cursor(self):\n         new_connection = False\n-        set_tz = False\n         settings_dict = self.settings_dict\n         if self.connection is None:\n             new_connection = True\n-            set_tz = settings_dict.get('TIME_ZONE')\n             if settings_dict['NAME'] == '':\n                 from django.core.exceptions import ImproperlyConfigured\n                 raise ImproperlyConfigured(\"You need to specify NAME in your Django settings file.\")\n@@ -171,10 +175,11 @@ def _cursor(self):\n             self.connection.set_isolation_level(self.isolation_level)\n             connection_created.send(sender=self.__class__, connection=self)\n         cursor = self.connection.cursor()\n-        cursor.tzinfo_factory = None\n+        cursor.tzinfo_factory = utc_tzinfo_factory if settings.USE_TZ else None\n         if new_connection:\n-            if set_tz:\n-                cursor.execute(\"SET TIME ZONE %s\", [settings_dict['TIME_ZONE']])\n+            tz = 'UTC' if settings.USE_TZ else settings_dict.get('TIME_ZONE')\n+            if tz:\n+                cursor.execute(\"SET TIME ZONE %s\", [tz])\n             self._get_pg_version()\n         return CursorWrapper(cursor)\n "
        },
        {
            "sha": "a6106066355670c5817a96968929c079e237e2a4",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 45,
            "deletions": 11,
            "changes": 56,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -10,13 +10,16 @@\n import re\n import sys\n \n+from django.conf import settings\n from django.db import utils\n from django.db.backends import *\n from django.db.backends.signals import connection_created\n from django.db.backends.sqlite3.client import DatabaseClient\n from django.db.backends.sqlite3.creation import DatabaseCreation\n from django.db.backends.sqlite3.introspection import DatabaseIntrospection\n+from django.utils.dateparse import parse_date, parse_datetime, parse_time\n from django.utils.safestring import SafeString\n+from django.utils.timezone import is_aware, is_naive, utc\n \n try:\n     try:\n@@ -31,22 +34,29 @@\n DatabaseError = Database.DatabaseError\n IntegrityError = Database.IntegrityError\n \n+def parse_datetime_with_timezone_support(value):\n+    dt = parse_datetime(value)\n+    # Confirm that dt is naive before overwriting its tzinfo.\n+    if dt is not None and settings.USE_TZ and is_naive(dt):\n+        dt = dt.replace(tzinfo=utc)\n+    return dt\n+\n Database.register_converter(\"bool\", lambda s: str(s) == '1')\n-Database.register_converter(\"time\", util.typecast_time)\n-Database.register_converter(\"date\", util.typecast_date)\n-Database.register_converter(\"datetime\", util.typecast_timestamp)\n-Database.register_converter(\"timestamp\", util.typecast_timestamp)\n-Database.register_converter(\"TIMESTAMP\", util.typecast_timestamp)\n+Database.register_converter(\"time\", parse_time)\n+Database.register_converter(\"date\", parse_date)\n+Database.register_converter(\"datetime\", parse_datetime_with_timezone_support)\n+Database.register_converter(\"timestamp\", parse_datetime_with_timezone_support)\n+Database.register_converter(\"TIMESTAMP\", parse_datetime_with_timezone_support)\n Database.register_converter(\"decimal\", util.typecast_decimal)\n Database.register_adapter(decimal.Decimal, util.rev_typecast_decimal)\n-if Database.version_info >= (2,4,1):\n+if Database.version_info >= (2, 4, 1):\n     # Starting in 2.4.1, the str type is not accepted anymore, therefore,\n     # we convert all str objects to Unicode\n     # As registering a adapter for a primitive type causes a small\n     # slow-down, this adapter is only registered for sqlite3 versions\n     # needing it.\n-    Database.register_adapter(str, lambda s:s.decode('utf-8'))\n-    Database.register_adapter(SafeString, lambda s:s.decode('utf-8'))\n+    Database.register_adapter(str, lambda s: s.decode('utf-8'))\n+    Database.register_adapter(SafeString, lambda s: s.decode('utf-8'))\n \n class DatabaseFeatures(BaseDatabaseFeatures):\n     # SQLite cannot handle us only partially reading from a cursor's result set\n@@ -56,6 +66,7 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     can_use_chunked_reads = False\n     test_db_allows_multiple_connections = False\n     supports_unspecified_pk = True\n+    supports_timezones = False\n     supports_1000_query_parameters = False\n     supports_mixed_date_datetime_comparisons = False\n     has_bulk_insert = True\n@@ -131,6 +142,29 @@ def sql_flush(self, style, tables, sequences):\n         # sql_flush() implementations). Just return SQL at this point\n         return sql\n \n+    def value_to_db_datetime(self, value):\n+        if value is None:\n+            return None\n+\n+        # SQLite doesn't support tz-aware datetimes\n+        if is_aware(value):\n+            if settings.USE_TZ:\n+                value = value.astimezone(utc).replace(tzinfo=None)\n+            else:\n+                raise ValueError(\"SQLite backend does not support timezone-aware datetimes when USE_TZ is False.\")\n+\n+        return unicode(value)\n+\n+    def value_to_db_time(self, value):\n+        if value is None:\n+            return None\n+\n+        # SQLite doesn't support tz-aware datetimes\n+        if is_aware(value):\n+            raise ValueError(\"SQLite backend does not support timezone-aware times.\")\n+\n+        return unicode(value)\n+\n     def year_lookup_bounds(self, value):\n         first = '%s-01-01'\n         second = '%s-12-31 23:59:59.999999'\n@@ -147,11 +181,11 @@ def convert_values(self, value, field):\n         elif internal_type and internal_type.endswith('IntegerField') or internal_type == 'AutoField':\n             return int(value)\n         elif internal_type == 'DateField':\n-            return util.typecast_date(value)\n+            return parse_date(value)\n         elif internal_type == 'DateTimeField':\n-            return util.typecast_timestamp(value)\n+            return parse_datetime_with_timezone_support(value)\n         elif internal_type == 'TimeField':\n-            return util.typecast_time(value)\n+            return parse_time(value)\n \n         # No field, or the field isn't known to be a decimal or integer\n         return value"
        },
        {
            "sha": "b0463b79af1598c4e28050c89642847a2fd23e3a",
            "filename": "django/db/backends/util.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fbackends%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Futil.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -3,7 +3,9 @@\n import hashlib\n from time import time\n \n+from django.conf import settings\n from django.utils.log import getLogger\n+from django.utils.timezone import utc\n \n \n logger = getLogger('django.db.backends')\n@@ -99,8 +101,10 @@ def typecast_timestamp(s): # does NOT store time zone information\n         seconds, microseconds = seconds.split('.')\n     else:\n         microseconds = '0'\n+    tzinfo = utc if settings.USE_TZ else None\n     return datetime.datetime(int(dates[0]), int(dates[1]), int(dates[2]),\n-        int(times[0]), int(times[1]), int(seconds), int((microseconds + '000000')[:6]))\n+        int(times[0]), int(times[1]), int(seconds),\n+        int((microseconds + '000000')[:6]), tzinfo)\n \n def typecast_decimal(s):\n     if s is None or s == '':"
        },
        {
            "sha": "5e7cf804e89542cb185c15547f361578e5b084e6",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 77,
            "deletions": 91,
            "changes": 168,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -1,8 +1,6 @@\n import copy\n import datetime\n import decimal\n-import re\n-import time\n import math\n from itertools import tee\n \n@@ -12,8 +10,10 @@\n from django import forms\n from django.core import exceptions, validators\n from django.utils.datastructures import DictWrapper\n+from django.utils.dateparse import parse_date, parse_datetime, parse_time\n from django.utils.functional import curry\n from django.utils.text import capfirst\n+from django.utils import timezone\n from django.utils.translation import ugettext_lazy as _\n from django.utils.encoding import smart_unicode, force_unicode, smart_str\n from django.utils.ipv6 import clean_ipv6_address\n@@ -180,8 +180,8 @@ def validate(self, value, model_instance):\n                             return\n                 elif value == option_key:\n                     return\n-            raise exceptions.ValidationError(\n-                self.error_messages['invalid_choice'] % value)\n+            msg = self.error_messages['invalid_choice'] % value\n+            raise exceptions.ValidationError(msg)\n \n         if value is None and not self.null:\n             raise exceptions.ValidationError(self.error_messages['null'])\n@@ -638,23 +638,19 @@ def formfield(self, **kwargs):\n         defaults.update(kwargs)\n         return super(CommaSeparatedIntegerField, self).formfield(**defaults)\n \n-ansi_date_re = re.compile(r'^\\d{4}-\\d{1,2}-\\d{1,2}$')\n-\n class DateField(Field):\n-    description = _(\"Date (without time)\")\n-\n     empty_strings_allowed = False\n     default_error_messages = {\n         'invalid': _(u\"'%s' value has an invalid date format. It must be \"\n                      u\"in YYYY-MM-DD format.\"),\n         'invalid_date': _(u\"'%s' value has the correct format (YYYY-MM-DD) \"\n                           u\"but it is an invalid date.\"),\n     }\n+    description = _(\"Date (without time)\")\n+\n     def __init__(self, verbose_name=None, name=None, auto_now=False,\n                  auto_now_add=False, **kwargs):\n         self.auto_now, self.auto_now_add = auto_now, auto_now_add\n-        # HACKs : auto_now_add/auto_now should be done as a default or a\n-        # pre_save.\n         if auto_now or auto_now_add:\n             kwargs['editable'] = False\n             kwargs['blank'] = True\n@@ -671,20 +667,19 @@ def to_python(self, value):\n         if isinstance(value, datetime.date):\n             return value\n \n-        if not ansi_date_re.search(value):\n-            msg = self.error_messages['invalid'] % str(value)\n-            raise exceptions.ValidationError(msg)\n-        # Now that we have the date string in YYYY-MM-DD format, check to make\n-        # sure it's a valid date.\n-        # We could use time.strptime here and catch errors, but datetime.date\n-        # produces much friendlier error messages.\n-        year, month, day = map(int, value.split('-'))\n+        value = smart_str(value)\n+\n         try:\n-            return datetime.date(year, month, day)\n-        except ValueError, e:\n-            msg = self.error_messages['invalid_date'] % str(value)\n+            parsed = parse_date(value)\n+            if parsed is not None:\n+                return parsed\n+        except ValueError:\n+            msg = self.error_messages['invalid_date'] % value\n             raise exceptions.ValidationError(msg)\n \n+        msg = self.error_messages['invalid'] % value\n+        raise exceptions.ValidationError(msg)\n+\n     def pre_save(self, model_instance, add):\n         if self.auto_now or (self.auto_now_add and add):\n             value = datetime.date.today()\n@@ -721,25 +716,28 @@ def get_db_prep_value(self, value, connection, prepared=False):\n \n     def value_to_string(self, obj):\n         val = self._get_val_from_obj(obj)\n-        if val is None:\n-            data = ''\n-        else:\n-            data = str(val)\n-        return data\n+        return '' if val is None else val.isoformat()\n \n     def formfield(self, **kwargs):\n         defaults = {'form_class': forms.DateField}\n         defaults.update(kwargs)\n         return super(DateField, self).formfield(**defaults)\n \n class DateTimeField(DateField):\n+    empty_strings_allowed = False\n     default_error_messages = {\n-        'invalid': _(u\"'%s' value either has an invalid valid format (The \"\n-                     u\"format must be YYYY-MM-DD HH:MM[:ss[.uuuuuu]]) or is \"\n-                     u\"an invalid date/time.\"),\n+        'invalid': _(u\"'%s' value has an invalid format. It must be in \"\n+                     u\"YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ] format.\"),\n+        'invalid_date': _(u\"'%s' value has the correct format \"\n+                          u\"(YYYY-MM-DD) but it is an invalid date.\"),\n+        'invalid_datetime': _(u\"'%s' value has the correct format \"\n+                              u\"(YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]) \"\n+                              u\"but it is an invalid date/time.\"),\n     }\n     description = _(\"Date (with time)\")\n \n+    # __init__ is inherited from DateField\n+\n     def get_internal_type(self):\n         return \"DateTimeField\"\n \n@@ -751,59 +749,59 @@ def to_python(self, value):\n         if isinstance(value, datetime.date):\n             return datetime.datetime(value.year, value.month, value.day)\n \n-        # Attempt to parse a datetime:\n         value = smart_str(value)\n-        # split usecs, because they are not recognized by strptime.\n-        if '.' in value:\n-            try:\n-                value, usecs = value.split('.')\n-                usecs = int(usecs)\n-            except ValueError:\n-                raise exceptions.ValidationError(\n-                    self.error_messages['invalid'] % str(value))\n-        else:\n-            usecs = 0\n-        kwargs = {'microsecond': usecs}\n-        try: # Seconds are optional, so try converting seconds first.\n-            return datetime.datetime(\n-                *time.strptime(value, '%Y-%m-%d %H:%M:%S')[:6], **kwargs)\n \n+        try:\n+            parsed = parse_datetime(value)\n+            if parsed is not None:\n+                return parsed\n+        except ValueError:\n+            msg = self.error_messages['invalid_datetime'] % value\n+            raise exceptions.ValidationError(msg)\n+\n+        try:\n+            parsed = parse_date(value)\n+            if parsed is not None:\n+                return datetime.datetime(parsed.year, parsed.month, parsed.day)\n         except ValueError:\n-            try: # Try without seconds.\n-                return datetime.datetime(\n-                    *time.strptime(value, '%Y-%m-%d %H:%M')[:5], **kwargs)\n-            except ValueError: # Try without hour/minutes/seconds.\n-                try:\n-                    return datetime.datetime(\n-                        *time.strptime(value, '%Y-%m-%d')[:3], **kwargs)\n-                except ValueError:\n-                    raise exceptions.ValidationError(\n-                        self.error_messages['invalid'] % str(value))\n+            msg = self.error_messages['invalid_date'] % value\n+            raise exceptions.ValidationError(msg)\n+\n+        msg = self.error_messages['invalid'] % value\n+        raise exceptions.ValidationError(msg)\n \n     def pre_save(self, model_instance, add):\n         if self.auto_now or (self.auto_now_add and add):\n-            value = datetime.datetime.now()\n+            value = timezone.now()\n             setattr(model_instance, self.attname, value)\n             return value\n         else:\n             return super(DateTimeField, self).pre_save(model_instance, add)\n \n+    # contribute_to_class is inherited from DateField, it registers\n+    # get_next_by_FOO and get_prev_by_FOO\n+\n+    # get_prep_lookup is inherited from DateField\n+\n     def get_prep_value(self, value):\n-        return self.to_python(value)\n+        value = self.to_python(value)\n+        if settings.USE_TZ and timezone.is_naive(value):\n+            # For backwards compatibility, interpret naive datetimes in local\n+            # time. This won't work during DST change, but we can't do much\n+            # about it, so we let the exceptions percolate up the call stack.\n+            default_timezone = timezone.get_default_timezone()\n+            value = timezone.make_aware(value, default_timezone)\n+        return value\n \n     def get_db_prep_value(self, value, connection, prepared=False):\n-        # Casts dates into the format expected by the backend\n+        # Casts datetimes into the format expected by the backend\n         if not prepared:\n             value = self.get_prep_value(value)\n         return connection.ops.value_to_db_datetime(value)\n \n     def value_to_string(self, obj):\n         val = self._get_val_from_obj(obj)\n-        if val is None:\n-            data = ''\n-        else:\n-            data = str(val.replace(microsecond=0, tzinfo=None))\n-        return data\n+        return '' if val is None else val.isoformat()\n \n     def formfield(self, **kwargs):\n         defaults = {'form_class': forms.DateTimeField}\n@@ -1158,17 +1156,21 @@ def formfield(self, **kwargs):\n         return super(TextField, self).formfield(**defaults)\n \n class TimeField(Field):\n-    description = _(\"Time\")\n-\n     empty_strings_allowed = False\n     default_error_messages = {\n-        'invalid': _('Enter a valid time in HH:MM[:ss[.uuuuuu]] format.'),\n+        'invalid': _(u\"'%s' value has an invalid format. It must be in \"\n+                     u\"HH:MM[:ss[.uuuuuu]] format.\"),\n+        'invalid_time': _(u\"'%s' value has the correct format \"\n+                          u\"(HH:MM[:ss[.uuuuuu]]) but it is an invalid time.\"),\n     }\n+    description = _(\"Time\")\n+\n     def __init__(self, verbose_name=None, name=None, auto_now=False,\n                  auto_now_add=False, **kwargs):\n         self.auto_now, self.auto_now_add = auto_now, auto_now_add\n         if auto_now or auto_now_add:\n             kwargs['editable'] = False\n+            kwargs['blank'] = True\n         Field.__init__(self, verbose_name, name, **kwargs)\n \n     def get_internal_type(self):\n@@ -1185,30 +1187,18 @@ def to_python(self, value):\n             # database backend (e.g. Oracle), so we'll be accommodating.\n             return value.time()\n \n-        # Attempt to parse a datetime:\n         value = smart_str(value)\n-        # split usecs, because they are not recognized by strptime.\n-        if '.' in value:\n-            try:\n-                value, usecs = value.split('.')\n-                usecs = int(usecs)\n-            except ValueError:\n-                raise exceptions.ValidationError(\n-                    self.error_messages['invalid'])\n-        else:\n-            usecs = 0\n-        kwargs = {'microsecond': usecs}\n \n-        try: # Seconds are optional, so try converting seconds first.\n-            return datetime.time(*time.strptime(value, '%H:%M:%S')[3:6],\n-                                 **kwargs)\n+        try:\n+            parsed = parse_time(value)\n+            if parsed is not None:\n+                return parsed\n         except ValueError:\n-            try: # Try without seconds.\n-                return datetime.time(*time.strptime(value, '%H:%M')[3:5],\n-                                         **kwargs)\n-            except ValueError:\n-                raise exceptions.ValidationError(\n-                    self.error_messages['invalid'])\n+            msg = self.error_messages['invalid_time'] % value\n+            raise exceptions.ValidationError(msg)\n+\n+        msg = self.error_messages['invalid'] % value\n+        raise exceptions.ValidationError(msg)\n \n     def pre_save(self, model_instance, add):\n         if self.auto_now or (self.auto_now_add and add):\n@@ -1229,11 +1219,7 @@ def get_db_prep_value(self, value, connection, prepared=False):\n \n     def value_to_string(self, obj):\n         val = self._get_val_from_obj(obj)\n-        if val is None:\n-            data = ''\n-        else:\n-            data = str(val.replace(microsecond=0))\n-        return data\n+        return '' if val is None else val.isoformat()\n \n     def formfield(self, **kwargs):\n         defaults = {'form_class': forms.TimeField}"
        },
        {
            "sha": "f0c13e3aac120c8bd4bb959fb3d38adabfb2b806",
            "filename": "django/db/utils.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fdb%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Futils.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -66,7 +66,7 @@ def ensure_defaults(self, alias):\n         if conn['ENGINE'] == 'django.db.backends.' or not conn['ENGINE']:\n             conn['ENGINE'] = 'django.db.backends.dummy'\n         conn.setdefault('OPTIONS', {})\n-        conn.setdefault('TIME_ZONE', settings.TIME_ZONE)\n+        conn.setdefault('TIME_ZONE', 'UTC' if settings.USE_TZ else settings.TIME_ZONE)\n         for setting in ['NAME', 'USER', 'PASSWORD', 'HOST', 'PORT']:\n             conn.setdefault(setting, '')\n         for setting in ['TEST_CHARSET', 'TEST_COLLATION', 'TEST_NAME', 'TEST_MIRROR']:"
        },
        {
            "sha": "0ba7467191ef07423f208c2046d22ca1ace16943",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -17,7 +17,7 @@\n \n from django.core import validators\n from django.core.exceptions import ValidationError\n-from django.forms.util import ErrorList\n+from django.forms.util import ErrorList, from_current_timezone, to_current_timezone\n from django.forms.widgets import (TextInput, PasswordInput, HiddenInput,\n     MultipleHiddenInput, ClearableFileInput, CheckboxInput, Select,\n     NullBooleanSelect, SelectMultiple, DateInput, DateTimeInput, TimeInput,\n@@ -409,6 +409,11 @@ class DateTimeField(BaseTemporalField):\n         'invalid': _(u'Enter a valid date/time.'),\n     }\n \n+    def prepare_value(self, value):\n+        if isinstance(value, datetime.datetime):\n+            value = to_current_timezone(value)\n+        return value\n+\n     def to_python(self, value):\n         \"\"\"\n         Validates that the input can be converted to a datetime. Returns a\n@@ -417,9 +422,10 @@ def to_python(self, value):\n         if value in validators.EMPTY_VALUES:\n             return None\n         if isinstance(value, datetime.datetime):\n-            return value\n+            return from_current_timezone(value)\n         if isinstance(value, datetime.date):\n-            return datetime.datetime(value.year, value.month, value.day)\n+            result = datetime.datetime(value.year, value.month, value.day)\n+            return from_current_timezone(result)\n         if isinstance(value, list):\n             # Input comes from a SplitDateTimeWidget, for example. So, it's two\n             # components: date and time.\n@@ -428,7 +434,8 @@ def to_python(self, value):\n             if value[0] in validators.EMPTY_VALUES and value[1] in validators.EMPTY_VALUES:\n                 return None\n             value = '%s %s' % tuple(value)\n-        return super(DateTimeField, self).to_python(value)\n+        result = super(DateTimeField, self).to_python(value)\n+        return from_current_timezone(result)\n \n     def strptime(self, value, format):\n         return datetime.datetime.strptime(value, format)\n@@ -979,7 +986,8 @@ def compress(self, data_list):\n                 raise ValidationError(self.error_messages['invalid_date'])\n             if data_list[1] in validators.EMPTY_VALUES:\n                 raise ValidationError(self.error_messages['invalid_time'])\n-            return datetime.datetime.combine(*data_list)\n+            result = datetime.datetime.combine(*data_list)\n+            return from_current_timezone(result)\n         return None\n \n "
        },
        {
            "sha": "886f08e581b00b006f0587bb8f105e87b1fcadf7",
            "filename": "django/forms/util.py",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fforms%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fforms%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Futil.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -1,6 +1,9 @@\n+from django.conf import settings\n from django.utils.html import conditional_escape\n from django.utils.encoding import StrAndUnicode, force_unicode\n from django.utils.safestring import mark_safe\n+from django.utils import timezone\n+from django.utils.translation import ugettext_lazy as _\n \n # Import ValidationError so that it can be imported from this\n # module to maintain backwards compatibility.\n@@ -52,3 +55,31 @@ def as_text(self):\n     def __repr__(self):\n         return repr([force_unicode(e) for e in self])\n \n+# Utilities for time zone support in DateTimeField et al.\n+\n+def from_current_timezone(value):\n+    \"\"\"\n+    When time zone support is enabled, convert naive datetimes\n+    entered in the current time zone to aware datetimes.\n+    \"\"\"\n+    if settings.USE_TZ and value is not None and timezone.is_naive(value):\n+        current_timezone = timezone.get_current_timezone()\n+        try:\n+            return timezone.make_aware(value, current_timezone)\n+        except Exception, e:\n+            raise ValidationError(_('%(datetime)s couldn\\'t be interpreted '\n+                                    'in time zone %(current_timezone)s; it '\n+                                    'may be ambiguous or it may not exist.')\n+                                  % {'datetime': value,\n+                                     'current_timezone': current_timezone})\n+    return value\n+\n+def to_current_timezone(value):\n+    \"\"\"\n+    When time zone support is enabled, convert aware datetimes\n+    to naive dateimes in the current time zone for display.\n+    \"\"\"\n+    if settings.USE_TZ and value is not None and timezone.is_aware(value):\n+        current_timezone = timezone.get_current_timezone()\n+        return timezone.make_naive(value, current_timezone)\n+    return value"
        },
        {
            "sha": "f75695796031d11210ec07b04fc2c127f8ac32de",
            "filename": "django/forms/widgets.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fforms%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Fforms%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fwidgets.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -10,7 +10,7 @@\n from urlparse import urljoin\n \n from django.conf import settings\n-from django.forms.util import flatatt\n+from django.forms.util import flatatt, to_current_timezone\n from django.utils.datastructures import MultiValueDict, MergeDict\n from django.utils.html import escape, conditional_escape\n from django.utils.translation import ugettext, ugettext_lazy\n@@ -847,6 +847,7 @@ def __init__(self, attrs=None, date_format=None, time_format=None):\n \n     def decompress(self, value):\n         if value:\n+            value = to_current_timezone(value)\n             return [value.date(), value.time().replace(microsecond=0)]\n         return [None, None]\n "
        },
        {
            "sha": "572ec6138f17f62f03b946e20cbcd4b244330427",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -18,6 +18,7 @@\n from django.utils.formats import localize\n from django.utils.html import escape\n from django.utils.module_loading import module_has_submodule\n+from django.utils.timezone import aslocaltime\n \n \n TOKEN_TEXT = 0\n@@ -593,6 +594,8 @@ def resolve(self, context, ignore_failures=False):\n                     arg_vals.append(mark_safe(arg))\n                 else:\n                     arg_vals.append(arg.resolve(context))\n+            if getattr(func, 'expects_localtime', False):\n+                obj = aslocaltime(obj, context.use_tz)\n             if getattr(func, 'needs_autoescape', False):\n                 new_obj = func(obj, autoescape=context.autoescape, *arg_vals)\n             else:\n@@ -853,6 +856,7 @@ def _render_value_in_context(value, context):\n     means escaping, if required, and conversion to a unicode object. If value\n     is a string, it is expected to have already been translated.\n     \"\"\"\n+    value = aslocaltime(value, use_tz=context.use_tz)\n     value = localize(value, use_l10n=context.use_l10n)\n     value = force_unicode(value)\n     if ((context.autoescape and not isinstance(value, SafeData)) or\n@@ -1077,7 +1081,7 @@ def dec(func):\n         elif name is not None and filter_func is not None:\n             # register.filter('somename', somefunc)\n             self.filters[name] = filter_func\n-            for attr in ('is_safe', 'needs_autoescape'):\n+            for attr in ('expects_localtime', 'is_safe', 'needs_autoescape'):\n                 if attr in flags:\n                     value = flags[attr]\n                     # set the flag on the filter for FilterExpression.resolve\n@@ -1189,6 +1193,7 @@ def render(self, context):\n                         'autoescape': context.autoescape,\n                         'current_app': context.current_app,\n                         'use_l10n': context.use_l10n,\n+                        'use_tz': context.use_tz,\n                     })\n                     # Copy across the CSRF token, if present, because\n                     # inclusion tags are often used for forms, and we need"
        },
        {
            "sha": "bbd38ad4682e161bcff669df8a99cc9a33948287",
            "filename": "django/template/context.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fcontext.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fcontext.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fcontext.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -83,10 +83,12 @@ def new(self, values=None):\n \n class Context(BaseContext):\n     \"A stack container for variable context\"\n-    def __init__(self, dict_=None, autoescape=True, current_app=None, use_l10n=None):\n+    def __init__(self, dict_=None, autoescape=True, current_app=None,\n+            use_l10n=None, use_tz=None):\n         self.autoescape = autoescape\n-        self.use_l10n = use_l10n\n         self.current_app = current_app\n+        self.use_l10n = use_l10n\n+        self.use_tz = use_tz\n         self.render_context = RenderContext()\n         super(Context, self).__init__(dict_)\n \n@@ -162,8 +164,10 @@ class RequestContext(Context):\n     Additional processors can be specified as a list of callables\n     using the \"processors\" keyword argument.\n     \"\"\"\n-    def __init__(self, request, dict=None, processors=None, current_app=None, use_l10n=None):\n-        Context.__init__(self, dict, current_app=current_app, use_l10n=use_l10n)\n+    def __init__(self, request, dict_=None, processors=None, current_app=None,\n+            use_l10n=None, use_tz=None):\n+        Context.__init__(self, dict_, current_app=current_app,\n+                use_l10n=use_l10n, use_tz=use_tz)\n         if processors is None:\n             processors = ()\n         else:"
        },
        {
            "sha": "d4b973b5e044a79c6b24669669b7223e3bf66d44",
            "filename": "django/template/debug.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdebug.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -3,6 +3,7 @@\n from django.utils.html import escape\n from django.utils.safestring import SafeData, EscapeData\n from django.utils.formats import localize\n+from django.utils.timezone import aslocaltime\n \n \n class DebugLexer(Lexer):\n@@ -81,6 +82,7 @@ class DebugVariableNode(VariableNode):\n     def render(self, context):\n         try:\n             output = self.filter_expression.resolve(context)\n+            output = aslocaltime(output, use_tz=context.use_tz)\n             output = localize(output, use_l10n=context.use_l10n)\n             output = force_unicode(output)\n         except UnicodeDecodeError:"
        },
        {
            "sha": "6b0e2f0b065d039342f3b779ac389d1346e16697",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -692,7 +692,7 @@ def get_digit(value, arg):\n # DATES           #\n ###################\n \n-@register.filter(is_safe=False)\n+@register.filter(expects_localtime=True, is_safe=False)\n def date(value, arg=None):\n     \"\"\"Formats a date according to the given format.\"\"\"\n     if not value:\n@@ -707,7 +707,7 @@ def date(value, arg=None):\n         except AttributeError:\n             return ''\n \n-@register.filter(is_safe=False)\n+@register.filter(expects_localtime=True, is_safe=False)\n def time(value, arg=None):\n     \"\"\"Formats a time according to the given format.\"\"\"\n     if value in (None, u''):"
        },
        {
            "sha": "14b613e24f0d0f85360d5f41e41912fc9de6e053",
            "filename": "django/templatetags/tz.py",
            "status": "added",
            "additions": 191,
            "deletions": 0,
            "changes": 191,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplatetags%2Ftz.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Ftemplatetags%2Ftz.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Ftz.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,191 @@\n+from __future__ import with_statement\n+\n+from datetime import datetime, tzinfo\n+\n+try:\n+    import pytz\n+except ImportError:\n+    pytz = None\n+\n+from django.template import Node\n+from django.template import TemplateSyntaxError, Library\n+from django.utils import timezone\n+\n+register = Library()\n+\n+# HACK: datetime is an old-style class, create a new-style equivalent\n+# so we can define additional attributes.\n+class datetimeobject(datetime, object):\n+    pass\n+\n+\n+# Template filters\n+\n+@register.filter\n+def aslocaltime(value):\n+    \"\"\"\n+    Converts a datetime to local time in the active time zone.\n+\n+    This only makes sense within a {% localtime off %} block.\n+    \"\"\"\n+    return astimezone(value, timezone.get_current_timezone())\n+\n+@register.filter\n+def asutc(value):\n+    \"\"\"\n+    Converts a datetime to UTC.\n+    \"\"\"\n+    return astimezone(value, timezone.utc)\n+\n+@register.filter\n+def astimezone(value, arg):\n+    \"\"\"\n+    Converts a datetime to local time in a given time zone.\n+\n+    The argument must be an instance of a tzinfo subclass or a time zone name.\n+    If it is a time zone name, pytz is required.\n+\n+    Naive datetimes are assumed to be in local time in the default time zone.\n+    \"\"\"\n+    if not isinstance(value, datetime):\n+        return ''\n+\n+    # Obtain a timezone-aware datetime\n+    try:\n+        if timezone.is_naive(value):\n+            default_timezone = timezone.get_default_timezone()\n+            value = timezone.make_aware(value, default_timezone)\n+    # Filters must never raise exceptions, and pytz' exceptions inherit\n+    # Exception directly, not a specific subclass. So catch everything.\n+    except Exception:\n+        return ''\n+\n+    # Obtain a tzinfo instance\n+    if isinstance(arg, tzinfo):\n+        tz = arg\n+    elif isinstance(arg, basestring) and pytz is not None:\n+        try:\n+            tz = pytz.timezone(arg)\n+        except pytz.UnknownTimeZoneError:\n+            return ''\n+    else:\n+        return ''\n+\n+    # Convert and prevent further conversion\n+    result = value.astimezone(tz)\n+    if hasattr(tz, 'normalize'):\n+        # available for pytz time zones\n+        result = tz.normalize(result)\n+\n+    # HACK: the convert_to_local_time flag will prevent\n+    #       automatic conversion of the value to local time.\n+    result = datetimeobject(result.year, result.month, result.day,\n+                            result.hour, result.minute, result.second,\n+                            result.microsecond, result.tzinfo)\n+    result.convert_to_local_time = False\n+    return result\n+\n+\n+# Template tags\n+\n+class LocalTimeNode(Node):\n+    \"\"\"\n+    Template node class used by ``localtime_tag``.\n+    \"\"\"\n+    def __init__(self, nodelist, use_tz):\n+        self.nodelist = nodelist\n+        self.use_tz = use_tz\n+\n+    def render(self, context):\n+        old_setting = context.use_tz\n+        context.use_tz = self.use_tz\n+        output = self.nodelist.render(context)\n+        context.use_tz = old_setting\n+        return output\n+\n+class TimezoneNode(Node):\n+    \"\"\"\n+    Template node class used by ``timezone_tag``.\n+    \"\"\"\n+    def __init__(self, nodelist, tz):\n+        self.nodelist = nodelist\n+        self.tz = tz\n+\n+    def render(self, context):\n+        with timezone.override(self.tz.resolve(context)):\n+            output = self.nodelist.render(context)\n+        return output\n+\n+class GetCurrentTimezoneNode(Node):\n+    \"\"\"\n+    Template node class used by ``get_current_timezone_tag``.\n+    \"\"\"\n+    def __init__(self, variable):\n+        self.variable = variable\n+\n+    def render(self, context):\n+        context[self.variable] = timezone.get_current_timezone_name()\n+        return ''\n+\n+@register.tag('localtime')\n+def localtime_tag(parser, token):\n+    \"\"\"\n+    Forces or prevents conversion of datetime objects to local time,\n+    regardless of the value of ``settings.USE_TZ``.\n+\n+    Sample usage::\n+\n+        {% localtime off %}{{ value_in_utc }}{% endlocaltime %}\n+\n+    \"\"\"\n+    bits = token.split_contents()\n+    if len(bits) == 1:\n+        use_tz = True\n+    elif len(bits) > 2 or bits[1] not in ('on', 'off'):\n+        raise TemplateSyntaxError(\"%r argument should be 'on' or 'off'\" % bits[0])\n+    else:\n+        use_tz = bits[1] == 'on'\n+    nodelist = parser.parse(('endlocaltime',))\n+    parser.delete_first_token()\n+    return LocalTimeNode(nodelist, use_tz)\n+\n+@register.tag('timezone')\n+def timezone_tag(parser, token):\n+    \"\"\"\n+    Enables a given time zone just for this block.\n+\n+    The ``timezone`` argument must be an instance of a ``tzinfo`` subclass, a\n+    time zone name, or ``None``. If is it a time zone name, pytz is required.\n+    If it is ``None``, the default time zone is used within the block.\n+\n+    Sample usage::\n+\n+        {% timezone \"Europe/Paris\" %}\n+            It is {{ now }} in Paris.\n+        {% endtimezone %}\n+\n+    \"\"\"\n+    bits = token.split_contents()\n+    if len(bits) != 2:\n+        raise TemplateSyntaxError(\"'%s' takes one argument (timezone)\" % bits[0])\n+    tz = parser.compile_filter(bits[1])\n+    nodelist = parser.parse(('endtimezone',))\n+    parser.delete_first_token()\n+    return TimezoneNode(nodelist, tz)\n+\n+@register.tag(\"get_current_timezone\")\n+def get_current_timezone_tag(parser, token):\n+    \"\"\"\n+    Stores the name of the current time zone in the context.\n+\n+    Usage::\n+\n+        {% get_current_timezone as TIME_ZONE %}\n+\n+    This will fetch the currently active time zone and put its name\n+    into the ``TIME_ZONE`` context variable.\n+    \"\"\"\n+    args = token.contents.split()\n+    if len(args) != 3 or args[1] != 'as':\n+        raise TemplateSyntaxError(\"'get_current_timezone' requires 'as variable' (got %r)\" % args)\n+    return GetCurrentTimezoneNode(args[2])"
        },
        {
            "sha": "1015c2f277c05e5e8bd5fad3e7c6bfb350788bfa",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -25,6 +25,7 @@\n from django.core.cache import get_cache\n from django.utils.encoding import smart_str, iri_to_uri\n from django.utils.http import http_date\n+from django.utils.timezone import get_current_timezone_name\n from django.utils.translation import get_language\n \n cc_delim_re = re.compile(r'\\s*,\\s*')\n@@ -157,12 +158,14 @@ def has_vary_header(response, header_query):\n     return header_query.lower() in existing_headers\n \n def _i18n_cache_key_suffix(request, cache_key):\n-    \"\"\"If enabled, returns the cache key ending with a locale.\"\"\"\n+    \"\"\"If necessary, adds the current locale or time zone to the cache key.\"\"\"\n     if settings.USE_I18N or settings.USE_L10N:\n         # first check if LocaleMiddleware or another middleware added\n         # LANGUAGE_CODE to request, then fall back to the active language\n         # which in turn can also fall back to settings.LANGUAGE_CODE\n         cache_key += '.%s' % getattr(request, 'LANGUAGE_CODE', get_language())\n+    if settings.USE_TZ:\n+        cache_key += '.%s' % get_current_timezone_name()\n     return cache_key\n \n def _generate_cache_key(request, method, headerlist, key_prefix):"
        },
        {
            "sha": "d87fb131058d448d4b3141e0298599611c9ec4fa",
            "filename": "django/utils/dateformat.py",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Fdateformat.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Fdateformat.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fdateformat.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -14,10 +14,13 @@\n import re\n import time\n import calendar\n+import datetime\n+\n from django.utils.dates import MONTHS, MONTHS_3, MONTHS_ALT, MONTHS_AP, WEEKDAYS, WEEKDAYS_ABBR\n from django.utils.tzinfo import LocalTimezone\n from django.utils.translation import ugettext as _\n from django.utils.encoding import force_unicode\n+from django.utils.timezone import is_aware, is_naive\n \n re_formatchars = re.compile(r'(?<!\\\\)([aAbBcdDEfFgGhHiIjlLmMnNOPrsStTUuwWyYzZ])')\n re_escaped = re.compile(r'\\\\(.)')\n@@ -115,9 +118,12 @@ class DateFormat(TimeFormat):\n     def __init__(self, dt):\n         # Accepts either a datetime or date object.\n         self.data = dt\n-        self.timezone = getattr(dt, 'tzinfo', None)\n-        if hasattr(self.data, 'hour') and not self.timezone:\n-            self.timezone = LocalTimezone(dt)\n+        self.timezone = None\n+        if isinstance(dt, datetime.datetime):\n+            if is_naive(dt):\n+                self.timezone = LocalTimezone(dt)\n+            else:\n+                self.timezone = dt.tzinfo\n \n     def b(self):\n         \"Month, textual, 3 letters, lowercase; e.g. 'jan'\"\n@@ -218,7 +224,7 @@ def T(self):\n \n     def U(self):\n         \"Seconds since the Unix epoch (January 1 1970 00:00:00 GMT)\"\n-        if getattr(self.data, 'tzinfo', None):\n+        if isinstance(self.data, datetime.datetime) and is_aware(self.data):\n             return int(calendar.timegm(self.data.utctimetuple()))\n         else:\n             return int(time.mktime(self.data.timetuple()))"
        },
        {
            "sha": "3ce475f5ea64f009e2b42d51d75f49367c33680e",
            "filename": "django/utils/dateparse.py",
            "status": "added",
            "additions": 93,
            "deletions": 0,
            "changes": 93,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Fdateparse.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Fdateparse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fdateparse.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,93 @@\n+\"\"\"Functions to parse datetime objects.\"\"\"\n+\n+# We're using regular expressions rather than time.strptime because:\n+# - they provide both validation and parsing,\n+# - they're more flexible for datetimes,\n+# - the date/datetime/time constructors produce friendlier error messages.\n+\n+\n+import datetime\n+import re\n+\n+from django.utils.timezone import utc\n+from django.utils.tzinfo import FixedOffset\n+\n+\n+date_re = re.compile(\n+        r'(?P<year>\\d{4})-(?P<month>\\d{1,2})-(?P<day>\\d{1,2})$'\n+)\n+\n+\n+datetime_re = re.compile(\n+        r'(?P<year>\\d{4})-(?P<month>\\d{1,2})-(?P<day>\\d{1,2})'\n+        r'[T ](?P<hour>\\d{1,2}):(?P<minute>\\d{1,2})'\n+        r'(?::(?P<second>\\d{1,2})(?:\\.(?P<microsecond>\\d{1,6})\\d{0,6})?)?'\n+        r'(?P<tzinfo>Z|[+-]\\d{1,2}:\\d{1,2})?$'\n+)\n+\n+\n+time_re = re.compile(\n+        r'(?P<hour>\\d{1,2}):(?P<minute>\\d{1,2})'\n+        r'(?::(?P<second>\\d{1,2})(?:\\.(?P<microsecond>\\d{1,6})\\d{0,6})?)?'\n+)\n+\n+\n+def parse_date(value):\n+    \"\"\"Parse a string and return a datetime.date.\n+\n+    Raise ValueError if the input is well formatted but not a valid date.\n+    Return None if the input isn't well formatted.\n+    \"\"\"\n+    match = date_re.match(value)\n+    if match:\n+        kw = dict((k, int(v)) for k, v in match.groupdict().iteritems())\n+        return datetime.date(**kw)\n+\n+\n+def parse_time(value):\n+    \"\"\"Parse a string and return a datetime.time.\n+\n+    This function doesn't support time zone offsets.\n+\n+    Sub-microsecond precision is accepted, but ignored.\n+\n+    Raise ValueError if the input is well formatted but not a valid time.\n+    Return None if the input isn't well formatted, in particular if it\n+    contains an offset.\n+    \"\"\"\n+    match = time_re.match(value)\n+    if match:\n+        kw = match.groupdict()\n+        if kw['microsecond']:\n+            kw['microsecond'] = kw['microsecond'].ljust(6, '0')\n+        kw = dict((k, int(v)) for k, v in kw.iteritems() if v is not None)\n+        return datetime.time(**kw)\n+\n+\n+def parse_datetime(value):\n+    \"\"\"Parse a string and return a datetime.datetime.\n+\n+    This function supports time zone offsets. When the input contains one,\n+    the output uses an instance of FixedOffset as tzinfo.\n+\n+    Sub-microsecond precision is accepted, but ignored.\n+\n+    Raise ValueError if the input is well formatted but not a valid datetime.\n+    Return None if the input isn't well formatted.\n+    \"\"\"\n+    match = datetime_re.match(value)\n+    if match:\n+        kw = match.groupdict()\n+        if kw['microsecond']:\n+            kw['microsecond'] = kw['microsecond'].ljust(6, '0')\n+        tzinfo = kw.pop('tzinfo')\n+        if tzinfo == 'Z':\n+            tzinfo = utc\n+        elif tzinfo is not None:\n+            offset = 60 * int(tzinfo[1:3]) + int(tzinfo[4:6])\n+            if tzinfo[0] == '-':\n+                offset = -offset\n+            tzinfo = FixedOffset(offset)\n+        kw = dict((k, int(v)) for k, v in kw.iteritems() if v is not None)\n+        kw['tzinfo'] = tzinfo\n+        return datetime.datetime(**kw)"
        },
        {
            "sha": "df3cf416523f97b36bb63a1cef1811e98c20b550",
            "filename": "django/utils/feedgenerator.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ffeedgenerator.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ffeedgenerator.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffeedgenerator.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -28,6 +28,7 @@\n from django.utils.xmlutils import SimplerXMLGenerator\n from django.utils.encoding import force_unicode, iri_to_uri\n from django.utils import datetime_safe\n+from django.utils.timezone import is_aware\n \n def rfc2822_date(date):\n     # We can't use strftime() because it produces locale-dependant results, so\n@@ -40,7 +41,7 @@ def rfc2822_date(date):\n     dow = days[date.weekday()]\n     month = months[date.month - 1]\n     time_str = date.strftime('%s, %%d %s %%Y %%H:%%M:%%S ' % (dow, month))\n-    if date.tzinfo:\n+    if is_aware(date):\n         offset = date.tzinfo.utcoffset(date)\n         timezone = (offset.days * 24 * 60) + (offset.seconds // 60)\n         hour, minute = divmod(timezone, 60)\n@@ -51,7 +52,7 @@ def rfc2822_date(date):\n def rfc3339_date(date):\n     # Support datetime objects older than 1900\n     date = datetime_safe.new_datetime(date)\n-    if date.tzinfo:\n+    if is_aware(date):\n         time_str = date.strftime('%Y-%m-%dT%H:%M:%S')\n         offset = date.tzinfo.utcoffset(date)\n         timezone = (offset.days * 24 * 60) + (offset.seconds // 60)"
        },
        {
            "sha": "511acb518a01746b10ae2facd3d81f8d37cc48f8",
            "filename": "django/utils/timesince.py",
            "status": "modified",
            "additions": 5,
            "deletions": 11,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ftimesince.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ftimesince.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftimesince.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -1,6 +1,6 @@\n import datetime\n \n-from django.utils.tzinfo import LocalTimezone\n+from django.utils.timezone import is_aware, utc\n from django.utils.translation import ungettext, ugettext\n \n def timesince(d, now=None):\n@@ -31,13 +31,10 @@ def timesince(d, now=None):\n         now = datetime.datetime(now.year, now.month, now.day)\n \n     if not now:\n-        if d.tzinfo:\n-            now = datetime.datetime.now(LocalTimezone(d))\n-        else:\n-            now = datetime.datetime.now()\n+        now = datetime.datetime.now(utc if is_aware(d) else None)\n \n-    # ignore microsecond part of 'd' since we removed it from 'now'\n-    delta = now - (d - datetime.timedelta(0, 0, d.microsecond))\n+    delta = now - d\n+    # ignore microseconds\n     since = delta.days * 24 * 60 * 60 + delta.seconds\n     if since <= 0:\n         # d is in the future compared to now, stop processing.\n@@ -61,8 +58,5 @@ def timeuntil(d, now=None):\n     the given time.\n     \"\"\"\n     if not now:\n-        if getattr(d, 'tzinfo', None):\n-            now = datetime.datetime.now(LocalTimezone(d))\n-        else:\n-            now = datetime.datetime.now()\n+        now = datetime.datetime.now(utc if is_aware(d) else None)\n     return timesince(now, d)"
        },
        {
            "sha": "22860eb8cc9d3b610b0d6ffd786df66aae32e238",
            "filename": "django/utils/timezone.py",
            "status": "added",
            "additions": 266,
            "deletions": 0,
            "changes": 266,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftimezone.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,266 @@\n+\"\"\"Timezone helper functions.\n+\n+This module uses pytz when it's available and fallbacks when it isn't.\n+\"\"\"\n+\n+from datetime import datetime, timedelta, tzinfo\n+from threading import local\n+import time as _time\n+\n+try:\n+    import pytz\n+except ImportError:\n+    pytz = None\n+\n+from django.conf import settings\n+\n+__all__ = [\n+    'utc', 'get_default_timezone', 'get_current_timezone',\n+    'activate', 'deactivate', 'override',\n+    'aslocaltime', 'isnaive',\n+]\n+\n+\n+# UTC and local time zones\n+\n+ZERO = timedelta(0)\n+\n+class UTC(tzinfo):\n+    \"\"\"\n+    UTC implementation taken from Python's docs.\n+\n+    Used only when pytz isn't available.\n+    \"\"\"\n+\n+    def utcoffset(self, dt):\n+        return ZERO\n+\n+    def tzname(self, dt):\n+        return \"UTC\"\n+\n+    def dst(self, dt):\n+        return ZERO\n+\n+class LocalTimezone(tzinfo):\n+    \"\"\"\n+    Local time implementation taken from Python's docs.\n+\n+    Used only when pytz isn't available, and most likely inaccurate. If you're\n+    having trouble with this class, don't waste your time, just install pytz.\n+    \"\"\"\n+\n+    def __init__(self):\n+        # This code is moved in __init__ to execute it as late as possible\n+        # See get_default_timezone().\n+        self.STDOFFSET = timedelta(seconds=-_time.timezone)\n+        if _time.daylight:\n+            self.DSTOFFSET = timedelta(seconds=-_time.altzone)\n+        else:\n+            self.DSTOFFSET = self.STDOFFSET\n+        self.DSTDIFF = self.DSTOFFSET - self.STDOFFSET\n+        tzinfo.__init__(self)\n+\n+    def utcoffset(self, dt):\n+        if self._isdst(dt):\n+            return self.DSTOFFSET\n+        else:\n+            return self.STDOFFSET\n+\n+    def dst(self, dt):\n+        if self._isdst(dt):\n+            return self.DSTDIFF\n+        else:\n+            return ZERO\n+\n+    def tzname(self, dt):\n+        return _time.tzname[self._isdst(dt)]\n+\n+    def _isdst(self, dt):\n+        tt = (dt.year, dt.month, dt.day,\n+              dt.hour, dt.minute, dt.second,\n+              dt.weekday(), 0, 0)\n+        stamp = _time.mktime(tt)\n+        tt = _time.localtime(stamp)\n+        return tt.tm_isdst > 0\n+\n+\n+utc = pytz.utc if pytz else UTC()\n+\"\"\"UTC time zone as a tzinfo instance.\"\"\"\n+\n+# In order to avoid accessing the settings at compile time,\n+# wrap the expression in a function and cache the result.\n+# If you change settings.TIME_ZONE in tests, reset _localtime to None.\n+_localtime = None\n+\n+def get_default_timezone():\n+    \"\"\"\n+    Returns the default time zone as a tzinfo instance.\n+\n+    This is the time zone defined by settings.TIME_ZONE.\n+\n+    See also :func:`get_current_timezone`.\n+    \"\"\"\n+    global _localtime\n+    if _localtime is None:\n+        tz = settings.TIME_ZONE\n+        _localtime = pytz.timezone(tz) if pytz else LocalTimezone()\n+    return _localtime\n+\n+# This function exists for consistency with get_current_timezone_name\n+def get_default_timezone_name():\n+    \"\"\"\n+    Returns the name of the default time zone.\n+    \"\"\"\n+    return _get_timezone_name(get_default_timezone())\n+\n+_active = local()\n+\n+def get_current_timezone():\n+    \"\"\"\n+    Returns the currently active time zone as a tzinfo instance.\n+    \"\"\"\n+    return getattr(_active, \"value\", get_default_timezone())\n+\n+def get_current_timezone_name():\n+    \"\"\"\n+    Returns the name of the currently active time zone.\n+    \"\"\"\n+    return _get_timezone_name(get_current_timezone())\n+\n+def _get_timezone_name(timezone):\n+    \"\"\"\n+    Returns the name of ``timezone``.\n+    \"\"\"\n+    try:\n+        # for pytz timezones\n+        return timezone.zone\n+    except AttributeError:\n+        # for regular tzinfo objects\n+        local_now = datetime.now(timezone)\n+        return timezone.tzname(local_now)\n+\n+# Timezone selection functions.\n+\n+# These functions don't change os.environ['TZ'] and call time.tzset()\n+# because it isn't thread safe.\n+\n+def activate(timezone):\n+    \"\"\"\n+    Sets the time zone for the current thread.\n+\n+    The ``timezone`` argument must be an instance of a tzinfo subclass or a\n+    time zone name. If it is a time zone name, pytz is required.\n+    \"\"\"\n+    if isinstance(timezone, tzinfo):\n+        _active.value = timezone\n+    elif isinstance(timezone, basestring) and pytz is not None:\n+        _active.value = pytz.timezone(timezone)\n+    else:\n+        raise ValueError(\"Invalid timezone: %r\" % timezone)\n+\n+def deactivate():\n+    \"\"\"\n+    Unsets the time zone for the current thread.\n+\n+    Django will then use the time zone defined by settings.TIME_ZONE.\n+    \"\"\"\n+    if hasattr(_active, \"value\"):\n+        del _active.value\n+\n+class override(object):\n+    \"\"\"\n+    Temporarily set the time zone for the current thread.\n+\n+    This is a context manager that uses ``~django.utils.timezone.activate()``\n+    to set the timezone on entry, and restores the previously active timezone\n+    on exit.\n+\n+    The ``timezone`` argument must be an instance of a ``tzinfo`` subclass, a\n+    time zone name, or ``None``. If is it a time zone name, pytz is required.\n+    If it is ``None``, Django enables the default time zone.\n+    \"\"\"\n+    def __init__(self, timezone):\n+        self.timezone = timezone\n+        self.old_timezone = getattr(_active, 'value', None)\n+\n+    def __enter__(self):\n+        if self.timezone is None:\n+            deactivate()\n+        else:\n+            activate(self.timezone)\n+\n+    def __exit__(self, exc_type, exc_value, traceback):\n+        if self.old_timezone is not None:\n+            _active.value = self.old_timezone\n+        else:\n+            del _active.value\n+\n+\n+# Utilities\n+\n+def aslocaltime(value, use_tz=None):\n+    \"\"\"\n+    Checks if value is a datetime and converts it to local time if necessary.\n+\n+    If use_tz is provided and is not None, that will force the value to\n+    be converted (or not), overriding the value of settings.USE_TZ.\n+    \"\"\"\n+    if (isinstance(value, datetime)\n+        and (settings.USE_TZ if use_tz is None else use_tz)\n+        and not is_naive(value)\n+        and getattr(value, 'convert_to_local_time', True)):\n+        timezone = get_current_timezone()\n+        value = value.astimezone(timezone)\n+        if hasattr(timezone, 'normalize'):\n+            # available for pytz time zones\n+            value = timezone.normalize(value)\n+    return value\n+\n+def now():\n+    \"\"\"\n+    Returns an aware or naive datetime.datetime, depending on settings.USE_TZ.\n+    \"\"\"\n+    if settings.USE_TZ:\n+        # timeit shows that datetime.now(tz=utc) is 24% slower\n+        return datetime.utcnow().replace(tzinfo=utc)\n+    else:\n+        return datetime.now()\n+\n+def is_aware(value):\n+    \"\"\"\n+    Determines if a given datetime.datetime is aware.\n+\n+    The logic is described in Python's docs:\n+    http://docs.python.org/library/datetime.html#datetime.tzinfo\n+    \"\"\"\n+    return value.tzinfo is not None and value.tzinfo.utcoffset(value) is not None\n+\n+def is_naive(value):\n+    \"\"\"\n+    Determines if a given datetime.datetime is naive.\n+\n+    The logic is described in Python's docs:\n+    http://docs.python.org/library/datetime.html#datetime.tzinfo\n+    \"\"\"\n+    return value.tzinfo is None or value.tzinfo.utcoffset(value) is None\n+\n+def make_aware(value, timezone):\n+    \"\"\"\n+    Makes a naive datetime.datetime in a given time zone aware.\n+    \"\"\"\n+    if hasattr(timezone, 'localize'):\n+        # available for pytz time zones\n+        return timezone.localize(value, is_dst=None)\n+    else:\n+        # may be wrong around DST changes\n+        return value.replace(tzinfo=timezone)\n+\n+def make_naive(value, timezone):\n+    \"\"\"\n+    Makes an aware datetime.datetime naive in a given time zone.\n+    \"\"\"\n+    value = value.astimezone(timezone)\n+    if hasattr(timezone, 'normalize'):\n+        # available for pytz time zones\n+        return timezone.normalize(value)\n+    return value.replace(tzinfo=None)"
        },
        {
            "sha": "a07b635a995d3ad5274434f07b0c918b2b76cf08",
            "filename": "django/utils/tzinfo.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ftzinfo.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/django%2Futils%2Ftzinfo.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftzinfo.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -2,8 +2,14 @@\n \n import time\n from datetime import timedelta, tzinfo\n+\n from django.utils.encoding import smart_unicode, smart_str, DEFAULT_LOCALE_ENCODING\n \n+# Python's doc say: \"A tzinfo subclass must have an __init__() method that can\n+# be called with no arguments\". FixedOffset and LocalTimezone don't honor this\n+# requirement. Defining __getinitargs__ is sufficient to fix copy/deepcopy as\n+# well as pickling/unpickling.\n+\n class FixedOffset(tzinfo):\n     \"Fixed offset in minutes east from UTC.\"\n     def __init__(self, offset):\n@@ -19,6 +25,9 @@ def __init__(self, offset):\n     def __repr__(self):\n         return self.__name\n \n+    def __getinitargs__(self):\n+        return self.__offset,\n+\n     def utcoffset(self, dt):\n         return self.__offset\n \n@@ -28,15 +37,25 @@ def tzname(self, dt):\n     def dst(self, dt):\n         return timedelta(0)\n \n+# This implementation is used for display purposes. It uses an approximation\n+# for DST computations on dates >= 2038.\n+\n+# A similar implementation exists in django.utils.timezone. It's used for\n+# timezone support (when USE_TZ = True) and focuses on correctness.\n+\n class LocalTimezone(tzinfo):\n     \"Proxy timezone information from time module.\"\n     def __init__(self, dt):\n         tzinfo.__init__(self)\n+        self.__dt = dt\n         self._tzname = self.tzname(dt)\n \n     def __repr__(self):\n         return smart_str(self._tzname)\n \n+    def __getinitargs__(self):\n+        return self.__dt,\n+\n     def utcoffset(self, dt):\n         if self._isdst(dt):\n             return timedelta(seconds=-time.altzone)"
        },
        {
            "sha": "0b962f88634c933b89fb4306f50c574a7d783319",
            "filename": "docs/howto/custom-template-tags.txt",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fhowto%2Fcustom-template-tags.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fhowto%2Fcustom-template-tags.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fcustom-template-tags.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -347,6 +347,31 @@ function; this syntax is deprecated.\n         return mark_safe(result)\n     initial_letter_filter.needs_autoescape = True\n \n+.. _filters-timezones:\n+\n+Filters and time zones\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+.. versionadded:: 1.4\n+\n+If you write a custom filter that operates on :class:`~datetime.datetime`\n+objects, you'll usually register it with the ``expects_localtime`` flag set to\n+``True``:\n+\n+.. code-block:: python\n+\n+    @register.filter(expects_localtime=True)\n+    def businesshours(value):\n+        try:\n+            return 9 <= value.hour < 17\n+        except AttributeError:\n+            return ''\n+\n+When this flag is set, if the first argument to your filter is a time zone\n+aware datetime, Django will convert it to the current time zone before passing\n+to your filter when appropriate, according to :ref:`rules for time zones\n+conversions in templates <time-zones-in-templates>`.\n+\n Writing custom template tags\n ----------------------------\n "
        },
        {
            "sha": "9736d94838f83e1b5d9d7be14f95104e1ff9a32f",
            "filename": "docs/ref/models/querysets.txt",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Fquerysets.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -546,6 +546,12 @@ Examples::\n     >>> Entry.objects.filter(headline__contains='Lennon').dates('pub_date', 'day')\n     [datetime.datetime(2005, 3, 20)]\n \n+.. warning::\n+\n+    When :doc:`time zone support </topics/i18n/timezones>` is enabled, Django\n+    uses UTC in the database connection, which means the aggregation is\n+    performed in UTC. This is a known limitation of the current implementation.\n+\n none\n ~~~~\n \n@@ -1953,6 +1959,13 @@ Note this will match any record with a ``pub_date`` that falls on a Monday (day\n 2 of the week), regardless of the month or year in which it occurs. Week days\n are indexed with day 1 being Sunday and day 7 being Saturday.\n \n+.. warning::\n+\n+    When :doc:`time zone support </topics/i18n/timezones>` is enabled, Django\n+    uses UTC in the database connection, which means the ``year``, ``month``,\n+    ``day`` and ``week_day`` lookups are performed in UTC. This is a known\n+    limitation of the current implementation.\n+\n .. fieldlookup:: isnull\n \n isnull"
        },
        {
            "sha": "0d91f16821091903f0448f35170f0cb0b6c7e9e4",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 42,
            "deletions": 12,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -1810,6 +1810,7 @@ Default::\n     \"django.core.context_processors.i18n\",\n     \"django.core.context_processors.media\",\n     \"django.core.context_processors.static\",\n+    \"django.core.context_processors.tz\",\n     \"django.contrib.messages.context_processors.messages\")\n \n A tuple of callables that are used to populate the context in ``RequestContext``.\n@@ -1830,6 +1831,10 @@ of items to be merged into the context.\n     The ``django.core.context_processors.static`` context processor\n     was added in this release.\n \n+.. versionadded:: 1.4\n+    The ``django.core.context_processors.tz`` context processor\n+    was added in this release.\n+\n .. setting:: TEMPLATE_DEBUG\n \n TEMPLATE_DEBUG\n@@ -1971,23 +1976,29 @@ Default: ``'America/Chicago'``\n .. versionchanged:: 1.2\n    ``None`` was added as an allowed value.\n \n+.. versionchanged:: 1.4\n+   The meaning of this setting now depends on the value of :setting:`USE_TZ`.\n+\n A string representing the time zone for this installation, or\n ``None``. `See available choices`_. (Note that list of available\n choices lists more than one on the same line; you'll want to use just\n one of the choices for a given time zone. For instance, one line says\n ``'Europe/London GB GB-Eire'``, but you should use the first bit of\n that -- ``'Europe/London'`` -- as your :setting:`TIME_ZONE` setting.)\n \n-Note that this is the time zone to which Django will convert all\n-dates/times -- not necessarily the timezone of the server. For\n-example, one server may serve multiple Django-powered sites, each with\n-a separate time-zone setting.\n+Note that this isn't necessarily the timezone of the server. For example, one\n+server may serve multiple Django-powered sites, each with a separate time zone\n+setting.\n+\n+When :setting:`USE_TZ` is ``False``, this is the time zone in which Django will\n+store all datetimes. When :setting:`USE_TZ` is ``True``, this is the default\n+time zone that Django will use to display datetimes in templates and to\n+interpret datetimes entered in forms.\n \n-Normally, Django sets the ``os.environ['TZ']`` variable to the time\n-zone you specify in the :setting:`TIME_ZONE` setting. Thus, all your views\n-and models will automatically operate in the correct time zone.\n-However, Django won't set the ``TZ`` environment variable under the\n-following conditions:\n+Django sets the ``os.environ['TZ']`` variable to the time zone you specify in\n+the :setting:`TIME_ZONE` setting. Thus, all your views and models will\n+automatically operate in this time zone. However, Django won't set the ``TZ``\n+environment variable under the following conditions:\n \n * If you're using the manual configuration option as described in\n   :ref:`manually configuring settings\n@@ -2004,7 +2015,6 @@ to ensure your processes are running in the correct environment.\n     environment. If you're running Django on Windows, this variable\n     must be set to match the system timezone.\n \n-\n .. _See available choices: http://www.postgresql.org/docs/8.1/static/datetime-keywords.html#DATETIME-TIMEZONE-SET-TABLE\n \n .. setting:: URL_VALIDATOR_USER_AGENT\n@@ -2043,7 +2053,7 @@ This provides an easy way to turn it off, for performance. If this is set to\n ``False``, Django will make some optimizations so as not to load the\n translation machinery.\n \n-See also :setting:`USE_L10N`\n+See also :setting:`LANGUAGE_CODE`, :setting:`USE_L10N` and :setting:`USE_TZ`.\n \n .. setting:: USE_L10N\n \n@@ -2058,7 +2068,7 @@ A boolean that specifies if localized formatting of data will be enabled by\n default or not. If this is set to ``True``, e.g. Django will display numbers and\n dates using the format of the current locale.\n \n-See also :setting:`USE_I18N` and :setting:`LANGUAGE_CODE`\n+See also :setting:`LANGUAGE_CODE`, :setting:`USE_I18N` and :setting:`USE_TZ`.\n \n .. note::\n \n@@ -2082,6 +2092,26 @@ When :setting:`USE_L10N` is set to ``True`` and if this is also set to\n See also :setting:`DECIMAL_SEPARATOR`, :setting:`NUMBER_GROUPING` and\n :setting:`THOUSAND_SEPARATOR`.\n \n+.. setting:: USE_TZ\n+\n+USE_TZ\n+------\n+\n+.. versionadded:: 1.4\n+\n+Default: ``False``\n+\n+A boolean that specifies if datetimes will be timezone-aware by default or not.\n+If this is set to ``True``, Django will use timezone-aware datetimes internally.\n+Otherwise, Django will use naive datetimes in local time.\n+\n+See also :setting:`TIME_ZONE`, :setting:`USE_I18N` and :setting:`USE_L10N`.\n+\n+.. note::\n+    The default :file:`settings.py` file created by\n+    :djadmin:`django-admin.py startproject <startproject>` includes\n+    ``USE_TZ = True`` for convenience.\n+\n .. setting:: USE_X_FORWARDED_HOST\n \n USE_X_FORWARDED_HOST"
        },
        {
            "sha": "695a21296b5a3abac2c661fb211f357dc20ead06",
            "filename": "docs/ref/templates/builtins.txt",
            "status": "modified",
            "additions": 39,
            "deletions": 24,
            "changes": 63,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Ftemplates%2Fbuiltins.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Ftemplates%2Fbuiltins.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Ftemplates%2Fbuiltins.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -2318,8 +2318,45 @@ Value       Argument                Outputs\n                                     if no mapping for None is given)\n ==========  ======================  ==================================\n \n-Other tags and filter libraries\n--------------------------------\n+Internationalization tags and filters\n+-------------------------------------\n+\n+Django provides template tags and filters to control each aspect of\n+`internationalization </topics/i18n/index>`_ in templates. They allow for\n+granular control of translations, formatting, and time zone conversions.\n+\n+i18n\n+^^^^\n+\n+This library allows specifying translatable text in templates.\n+To enable it, set :setting:`USE_I18N` to ``True``, then load it with\n+``{% load i18n %}``.\n+\n+See :ref:`specifying-translation-strings-in-template-code`.\n+\n+l10n\n+^^^^\n+\n+This library provides control over the localization of values in templates.\n+You only need to load the library using ``{% load l10n %}``, but you'll often\n+set :setting:`USE_L10N` to ``True`` so that localization is active by default.\n+\n+See :ref:`topic-l10n-templates`.\n+\n+tz\n+^^\n+\n+.. versionadded:: 1.4\n+\n+This library provides control over time zone conversions in templates.\n+Like ``l10n``, you only need to load the library using ``{% load tz %}``,\n+but you'll usually also set :setting:`USE_TZ` to ``True`` so that conversion\n+to local time happens by default.\n+\n+See :ref:`time-zones-in-templates`.\n+\n+Other tags and filters libraries\n+--------------------------------\n \n Django comes with a couple of other template-tag libraries that you have to\n enable explicitly in your :setting:`INSTALLED_APPS` setting and enable in your\n@@ -2348,28 +2385,6 @@ django.contrib.webdesign\n A collection of template tags that can be useful while designing a Web site,\n such as a generator of Lorem Ipsum text. See :doc:`/ref/contrib/webdesign`.\n \n-i18n\n-^^^^\n-\n-Provides a couple of templatetags that allow specifying translatable text in\n-Django templates. It is slightly different from the libraries described\n-above because you don't need to add any application to the\n-:setting:`INSTALLED_APPS` setting but rather set :setting:`USE_I18N` to True,\n-then loading it with ``{% load i18n %}``.\n-\n-See :ref:`specifying-translation-strings-in-template-code`.\n-\n-l10n\n-^^^^\n-\n-Provides a couple of templatetags that allow control over the localization of\n-values in Django templates. It is slightly different from the libraries\n-described above because you don't need to add any application to the\n-:setting:`INSTALLED_APPS`; you only need to load the library using\n-``{% load l10n %}``.\n-\n-See :ref:`topic-l10n-templates`.\n-\n static\n ^^^^^^\n "
        },
        {
            "sha": "9a9adba0d85128df671bae166dd5c34330244866",
            "filename": "docs/ref/utils.txt",
            "status": "modified",
            "additions": 125,
            "deletions": 0,
            "changes": 125,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Futils.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Fref%2Futils.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Futils.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -131,6 +131,41 @@ results. Instead do::\n \n     SortedDict([('b', 1), ('a', 2), ('c', 3)])\n \n+``django.utils.dateparse``\n+==========================\n+\n+.. versionadded:: 1.4\n+\n+.. module:: django.utils.dateparse\n+   :synopsis: Functions to parse datetime objects.\n+\n+The functions defined in this module share the following properties:\n+\n+- They raise :exc:`ValueError` if their input is well formatted but isn't a\n+  valid date or time.\n+- They return ``None`` if it isn't well formatted at all.\n+- They accept up to picosecond resolution in input, but they truncate it to\n+  microseconds, since that's what Python supports.\n+\n+.. function:: parse_date(value)\n+\n+    Parses a string and returns a :class:`datetime.date`.\n+\n+.. function:: parse_time(value)\n+\n+    Parses a string and returns a :class:`datetime.time`.\n+\n+    UTC offsets aren't supported; if ``value`` describes one, the result is\n+    ``None``.\n+\n+.. function:: parse_datetime(value)\n+\n+    Parses a string and returns a :class:`datetime.datetime`.\n+\n+    UTC offsets are supported; if ``value`` describes one, the result's\n+    ``tzinfo`` attribute is a :class:`~django.utils.tzinfo.FixedOffset`\n+    instance.\n+\n ``django.utils.encoding``\n =========================\n \n@@ -573,6 +608,96 @@ For a complete discussion on the usage of the following see the\n     so by translating the Django translation tags into standard gettext function\n     invocations.\n \n+.. _time-zone-selection-functions:\n+\n+``django.utils.timezone``\n+=========================\n+\n+.. versionadded:: 1.4\n+\n+.. module:: django.utils.timezone\n+    :synopsis: Timezone support.\n+\n+.. data:: utc\n+\n+    :class:`~datetime.tzinfo` instance that represents UTC.\n+\n+.. function:: get_default_timezone()\n+\n+    Returns a :class:`~datetime.tzinfo` instance that represents the\n+    :ref:`default time zone <default-current-time-zone>`.\n+\n+.. function:: get_default_timezone_name()\n+\n+    Returns the name of the :ref:`default time zone\n+    <default-current-time-zone>`.\n+\n+.. function:: get_current_timezone()\n+\n+    Returns a :class:`~datetime.tzinfo` instance that represents the\n+    :ref:`current time zone <default-current-time-zone>`.\n+\n+.. function:: get_current_timezone_name()\n+\n+    Returns the name of the :ref:`current time zone\n+    <default-current-time-zone>`.\n+\n+.. function:: activate(timezone)\n+\n+    Sets the :ref:`current time zone <default-current-time-zone>`. The\n+    ``timezone`` argument must be an instance of a :class:`~datetime.tzinfo`\n+    subclass or, if pytz_ is available, a time zone name.\n+\n+.. function:: deactivate()\n+\n+    Unsets the :ref:`current time zone <default-current-time-zone>`.\n+\n+.. function:: override(timezone)\n+\n+    This is a Python context manager that sets the :ref:`current time zone\n+    <default-current-time-zone>` on entry with :func:`activate()`, and restores\n+    the previously active time zone on exit. If the ``timezone`` argument is\n+    ``None``, the :ref:`current time zone <default-current-time-zone>` is unset\n+    on entry with :func:`deactivate()` instead.\n+\n+.. function:: aslocaltime(value, use_tz=None)\n+\n+    This function is used by the template engine to convert datetimes to local\n+    time where appropriate.\n+\n+.. function:: now()\n+\n+    Returns an aware or naive :class:`~datetime.datetime` that represents the\n+    current point in time when :setting:`USE_TZ` is ``True`` or ``False``\n+    respectively.\n+\n+.. function:: is_aware(value)\n+\n+    Returns ``True`` if ``value`` is aware, ``False`` if it is naive. This\n+    function assumes that ``value`` is a :class:`~datetime.datetime`.\n+\n+.. function:: is_naive(value)\n+\n+    Returns ``True`` if ``value`` is naive, ``False`` if it is aware. This\n+    function assumes that ``value`` is a :class:`~datetime.datetime`.\n+\n+.. function:: make_aware(value, timezone)\n+\n+    Returns an aware :class:`~datetime.datetime` that represents the same\n+    point in time as ``value`` in ``timezone``, ``value`` being a naive\n+    :class:`~datetime.datetime`.\n+\n+    This function can raise an exception if ``value`` doesn't exist or is\n+    ambiguous because of DST transitions.\n+\n+.. function:: make_naive(value, timezone)\n+\n+    Returns an naive :class:`~datetime.datetime` that represents in\n+    ``timezone``  the same point in time as ``value``, ``value`` being an\n+    aware :class:`~datetime.datetime`\n+\n+.. _pytz: http://pytz.sourceforge.net/\n+\n ``django.utils.tzinfo``\n =======================\n "
        },
        {
            "sha": "46527da581b507e95370dfccd14dc1140c565933",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -409,7 +409,6 @@ If the same code is imported inconsistently (some places with the project\n prefix, some places without it), the imports will need to be cleaned up when\n switching to the new ``manage.py``.\n \n-\n Improved WSGI support\n ~~~~~~~~~~~~~~~~~~~~~\n \n@@ -427,6 +426,25 @@ callable :djadmin:`runserver` uses.\n (The :djadmin:`runfcgi` management command also internally wraps the WSGI\n callable configured via :setting:`WSGI_APPLICATION`.)\n \n+Support for time zones\n+~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django 1.4 adds :ref:`support for time zones <time-zones>`. When it's enabled,\n+Django stores date and time information in UTC in the database, uses time\n+zone-aware datetime objects internally, and translates them to the end user's\n+time zone in templates and forms.\n+\n+Reasons for using this feature include:\n+\n+- Customizing date and time display for users around the world.\n+- Storing datetimes in UTC for database portability and interoperability.\n+  (This argument doesn't apply to PostgreSQL, because it already stores\n+  timestamps with time zone information in Django 1.3.)\n+- Avoiding data corruption problems around DST transitions.\n+\n+Time zone support in enabled by default in new projects created with\n+:djadmin:`startproject`. If you want to use this feature in an existing\n+project, there is a :ref:`migration guide <time-zones-migration-guide>`.\n \n Minor features\n ~~~~~~~~~~~~~~\n@@ -616,6 +634,39 @@ immediately raise a 404. Additionally redirects returned by flatpages are now\n permanent (301 status code) to match the behavior of the\n :class:`~django.middleware.common.CommonMiddleware`.\n \n+Serialization of :class:`~datetime.datetime` and :class:`~datetime.time`\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+As a consequence of time zone support, and according to the ECMA-262\n+specification, some changes were made to the JSON serializer:\n+\n+- It includes the time zone for aware datetime objects. It raises an exception\n+  for aware time objects.\n+- It includes milliseconds for datetime and time objects. There is still\n+  some precision loss, because Python stores microseconds (6 digits) and JSON\n+  only supports milliseconds (3 digits). However, it's better than discarding\n+  microseconds entirely.\n+\n+The XML serializer was also changed to use ISO8601 for datetimes. The letter\n+``T`` is used to separate the date part from the time part, instead of a\n+space. Time zone information is included in the ``[+-]HH:MM`` format.\n+\n+The serializers will dump datetimes in fixtures with these new formats. They\n+can still load fixtures that use the old format.\n+\n+``supports_timezone`` changed to ``False`` for SQLite\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The database feature ``supports_timezone`` used to be ``True`` for SQLite.\n+Indeed, if you saved an aware datetime object, SQLite stored a string that\n+included an UTC offset. However, this offset was ignored when loading the value\n+back from the database, which could corrupt the data.\n+\n+In the context of time zone support, this flag was changed to ``False``, and\n+datetimes are now stored without time zone information in SQLite. When\n+:setting:`USE_TZ` is ``False``, if you attempt to save an aware datetime\n+object, Django raises an exception.\n+\n `COMMENTS_BANNED_USERS_GROUP` setting\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "99d764b60d3c37890153f4fda6fe143cabffb996",
            "filename": "docs/topics/cache.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Ftopics%2Fcache.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Ftopics%2Fcache.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fcache.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -502,7 +502,9 @@ cache multilingual sites without having to create the cache key yourself.\n \n .. versionchanged:: 1.4\n \n-This also happens when :setting:`USE_L10N` is set to ``True``.\n+Cache keys also include the active :term:`language <language code>` when\n+:setting:`USE_L10N` is set to ``True`` and the :ref:`current time zone\n+<default-current-time-zone>` when :setting:`USE_TZ` is set to ``True``.\n \n __ `Controlling cache: Using other headers`_\n "
        },
        {
            "sha": "25ec8392de522f675be7d92bb2574363e161947e",
            "filename": "docs/topics/i18n/index.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Ftopics%2Fi18n%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Ftopics%2Fi18n%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Findex.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -8,6 +8,7 @@ Internationalization and localization\n \n    translation\n    formatting\n+   timezones\n \n Overview\n ========\n@@ -17,8 +18,8 @@ application to offer its content in languages and formats tailored to the\n audience.\n \n Django has full support for :doc:`translation of text\n-</topics/i18n/translation>` and :doc:`formatting of dates, times and numbers\n-</topics/i18n/formatting>`.\n+</topics/i18n/translation>`, :doc:`formatting of dates, times and numbers\n+</topics/i18n/formatting>`, and :doc:`time zones </topics/i18n/timezones>`.\n \n Essentially, Django does two things:\n \n@@ -27,8 +28,9 @@ Essentially, Django does two things:\n * It uses these hooks to localize Web apps for particular users according to\n   their preferences.\n \n-Obviously, translation depends on the target language. Formatting usually\n-depends on the target country.\n+Obviously, translation depends on the target language, and formatting usually\n+depends on the target country. These informations are provided by browsers in\n+the ``Accept-Language`` header. However, the time zone isn't readily available.\n \n Definitions\n ==========="
        },
        {
            "sha": "41e8380acc974d5d7ceaa7b809f5628e1326e9df",
            "filename": "docs/topics/i18n/timezones.txt",
            "status": "added",
            "additions": 429,
            "deletions": 0,
            "changes": 429,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Ftopics%2Fi18n%2Ftimezones.txt",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/docs%2Ftopics%2Fi18n%2Ftimezones.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Ftimezones.txt?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,429 @@\n+.. _time-zones:\n+\n+==========\n+Time zones\n+==========\n+\n+.. versionadded:: 1.4\n+\n+Overview\n+========\n+\n+When support for time zones is enabled, Django stores date and time\n+information in UTC in the database, uses time zone-aware datetime objects\n+internally, and translates them to the end user's time zone in templates and\n+forms.\n+\n+This is handy if your users live in more than one time zone and you want to\n+display date and time information according to each user's wall clock. Even if\n+your website is available in only one time zone, it's still a good practice to\n+store data in UTC in your database. Here is why.\n+\n+Many countries have a system of daylight saving time (DST), where clocks are\n+moved forwards in spring and backwards in autumn. If you're working in local\n+time, you're likely to encounter errors twice a year, when the transitions\n+happen. pytz' docs discuss `these issues`_ in greater detail. It probably\n+doesn't matter for your blog, but it's more annoying if you over-bill or\n+under-bill your customers by one hour, twice a year, every year. The solution\n+to this problem is to use UTC in the code and local time only when\n+interacting with end users.\n+\n+Time zone support is disabled by default. To enable it, set :setting:`USE_TZ =\n+True <USE_TZ>` in your settings file. Installing pytz_ is highly recommended,\n+but not mandatory.\n+\n+.. note::\n+\n+    The default :file:`settings.py` file created by :djadmin:`django-admin.py\n+    startproject <startproject>` includes :setting:`USE_TZ = True <USE_TZ>`\n+    for convenience.\n+\n+.. note::\n+\n+    There is also an independent but related :setting:`USE_L10N` setting that\n+    controls if Django should activate format localization. See\n+    :doc:`/topics/i18n/formatting` for more details.\n+\n+Concepts\n+========\n+\n+Naive and aware datetime objects\n+--------------------------------\n+\n+Python's :class:`datetime.datetime` objects have a ``tzinfo`` attribute that\n+can be used to store time zone information, represented as an instance of a\n+subclass of :class:`datetime.tzinfo`. When this attribute is set and describes\n+an offset, a datetime object is **aware**; otherwise, it's **naive**.\n+\n+You can use :func:`~django.utils.timezone.is_aware` and\n+:func:`~django.utils.timezone.is_naive` to determine if datetimes are aware or\n+naive.\n+\n+When time zone support is disabled, Django uses naive datetime objects in local\n+time. This is simple and sufficient for many use cases. In this mode, to obtain\n+the current time, you would write::\n+\n+    import datetime\n+\n+    now = datetime.datetime.now()\n+\n+When time zone support is enabled, Django uses time zone aware datetime\n+objects. If your code creates datetime objects, they should be aware too. In\n+this mode, the example above becomes::\n+\n+    import datetime\n+    from django.utils.timezone import utc\n+\n+    now = datetime.datetime.utcnow().replace(tzinfo=utc)\n+\n+.. note::\n+\n+    :mod:`django.utils.timezone` provides a\n+    :func:`~django.utils.timezone.now()` function that returns a naive or\n+    aware datetime object according to the value of :setting:`USE_TZ`.\n+\n+.. warning::\n+\n+    Dealing with aware datetime objects isn't always intuitive. For instance,\n+    the ``tzinfo`` argument of the standard datetime constructor doesn't work\n+    reliably for time zones with DST. Using UTC is generally safe; if you're\n+    using other time zones, you should review `pytz' documentation <pytz>`_\n+    carefully.\n+\n+.. note::\n+\n+    Python's :class:`datetime.time` objects also feature a ``tzinfo``\n+    attribute, and PostgreSQL has a matching ``time with time zone`` type.\n+    However, as PostgreSQL's docs put it, this type \"exhibits properties which\n+    lead to questionable usefulness\".\n+\n+    Django only supports naive time objects and will raise an exception if you\n+    attempt to save an aware time object.\n+\n+.. _naive-datetime-objects:\n+\n+Interpretation of naive datetime objects\n+----------------------------------------\n+\n+When :setting:`USE_TZ` is ``True``, Django still accepts naive datetime\n+objects, in order to preserve backwards-compatibility. It attempts to make them\n+aware by interpreting them in the :ref:`default time zone\n+<default-current-time-zone>`.\n+\n+Unfortunately, during DST transitions, some datetimes don't exist or are\n+ambiguous. In such situations, pytz_ raises an exception. Other\n+:class:`~datetime.tzinfo` implementations, such as the local time zone used as\n+a fallback when pytz_ isn't installed, may raise an exception or return\n+inaccurate results. That's why you should always create aware datetime objects\n+when time zone support is enabled.\n+\n+In practice, this is rarely an issue. Django gives you aware datetime objects\n+in the models and forms, and most often, new datetime objects are created from\n+existing ones through :class:`~datetime.timedelta` arithmetic. The only\n+datetime that's often created in application code is the current time, and\n+:func:`timezone.now() <django.utils.timezone.now>` automatically does the\n+right thing.\n+\n+.. _default-current-time-zone:\n+\n+Default time zone and current time zone\n+---------------------------------------\n+\n+The **default time zone** is the time zone defined by the :setting:`TIME_ZONE`\n+setting.\n+\n+When pytz_ is available, Django loads the definition of the default time zone\n+from the `tz database`_. This is the most accurate solution. Otherwise, it\n+relies on the difference between local time and UTC, as reported by the\n+operating system, to compute conversions. This is less reliable, especially\n+around DST transitions.\n+\n+The **current time zone** is the time zone that's used for rendering.\n+\n+You should set it to the end user's actual time zone with\n+:func:`~django.utils.timezone.activate`. Otherwise, the default time zone is\n+used.\n+\n+.. note::\n+\n+    As explained in the documentation of :setting:`TIME_ZONE`, Django sets\n+    environment variables so that its process runs in the default time zone.\n+    This happens regardless of the value of :setting:`USE_TZ` and of the\n+    current time zone.\n+\n+    When :setting:`USE_TZ` is ``True``, this is useful to preserve\n+    backwards-compatibility with applications that still rely on local time.\n+    However, :ref:`as explained above <naive-datetime-objects>`, this isn't\n+    entirely reliable, and you should always work with aware datetimes in UTC\n+    in your own code. For instance, use\n+    :meth:`~datetime.datetime.utcfromtimestamp` instead of\n+    :meth:`~datetime.datetime.fromtimestamp` -- and don't forget to set\n+    ``tzinfo`` to :data:`~django.utils.timezone.utc`.\n+\n+Selecting the current time zone\n+-------------------------------\n+\n+The current time zone is the equivalent of the current :term:`locale <locale\n+name>` for translations. However, there's no equivalent of the\n+``Accept-Language`` HTTP header that Django could use to determine the user's\n+time zone automatically. Instead, Django provides :ref:`time zone selection\n+functions <time-zone-selection-functions>`. Use them to build the time zone\n+selection logic that makes sense for you.\n+\n+Most websites who care about time zones just ask users in which time zone they\n+live and store this information in the user's profile. For anonymous users,\n+they use the time zone of their primary audience or UTC. pytz_ provides\n+helpers, like a list of time zones per country, that you can use to pre-select\n+the most likely choices.\n+\n+Here's an example that stores the current timezone in the session. (It skips\n+error handling entirely for the sake of simplicity.)\n+\n+Add the following middleware to :setting:`MIDDLEWARE_CLASSES`::\n+\n+    from django.utils import timezone\n+\n+    class TimezoneMiddleware(object):\n+        def process_request(self, request):\n+            tz = request.session.get('django_timezone')\n+            if tz:\n+                timezone.activate(tz)\n+\n+Create a view that can set the current timezone::\n+\n+    import pytz\n+    from django.shortcuts import redirect, render\n+\n+    def set_timezone(request):\n+        if request.method == 'POST':\n+            request.session[session_key] = pytz.timezone(request.POST['timezone'])\n+            return redirect('/')\n+        else:\n+            return render(request, 'template.html', {'timezones': pytz.common_timezones})\n+\n+Include in :file:`template.html` a form that will ``POST`` to this view:\n+\n+.. code-block:: html+django\n+\n+    {% load tz %}{% load url from future %}\n+    <form action=\"{% url 'set_timezone' %}\" method=\"POST\">\n+        {% csrf_token %}\n+        <label for=\"timezone\">Time zone:</label>\n+        <select name=\"timezone\">\n+            {% for tz in timezones %}\n+            <option value=\"{{ tz }}\"{% if tz == TIME_ZONE %} selected=\"selected\"{% endif %}>{{ tz }}</option>\n+            {% endfor %}\n+        </select>\n+        <input type=\"submit\" value=\"Set\" />\n+    </form>\n+\n+Time zone aware input in forms\n+==============================\n+\n+When you enable time zone support, Django interprets datetimes entered in\n+forms in the :ref:`current time zone <default-current-time-zone>` and returns\n+aware datetime objects in ``cleaned_data``.\n+\n+If the current time zone raises an exception for datetimes that don't exist or\n+are ambiguous because they fall in a DST transition (the timezones provided by\n+pytz_ do this), such datetimes will be reported as invalid values.\n+\n+.. _time-zones-in-templates:\n+\n+Time zone aware output in templates\n+===================================\n+\n+When you enable time zone support, Django converts aware datetime objects to\n+the :ref:`current time zone <default-current-time-zone>` when they're rendered\n+in templates. This behaves very much like :doc:`format localization\n+</topics/i18n/formatting>`.\n+\n+.. warning::\n+\n+    Django doesn't convert naive datetime objects, because they could be\n+    ambiguous, and because your code should never produce naive datetimes when\n+    time zone support is enabled. However, you can force conversion with the\n+    template filters described below.\n+\n+Conversion to local time isn't always appropriate -- you may be generating\n+output for computers rather than for humans. The following filters and tags,\n+provided the ``tz`` template library, allow you to control the time zone\n+conversions.\n+\n+Template tags\n+-------------\n+\n+.. templatetag:: localtime\n+\n+localtime\n+~~~~~~~~~\n+\n+Enables or disables conversion of aware datetime objects to the current time\n+zone in the contained block.\n+\n+This tag has exactly the same effects as the :setting:`USE_TZ` setting as far\n+as the template engine is concerned. It allows a more fine grained control of\n+conversion.\n+\n+To activate or deactivate conversion for a template block, use::\n+\n+    {% load tz %}\n+\n+    {% localtime on %}\n+        {{ value }}\n+    {% endlocaltime %}\n+\n+    {% localtime off %}\n+        {{ value }}\n+    {% endlocaltime %}\n+\n+.. note::\n+\n+    The value of :setting:`USE_TZ` isn't respected inside of a\n+    ``{% localtime %}`` block.\n+\n+.. templatetag:: timezone\n+\n+timezone\n+~~~~~~~~\n+\n+Sets or unsets the current time zone in the contained block. When the current\n+time zone is unset, the default time zone applies.\n+\n+::\n+\n+    {% load tz %}\n+\n+    {% timezone \"Europe/Paris\" %}\n+        Paris time: {{ value }}\n+    {% endtimezone %}\n+\n+    {% timezone None %}\n+        Server time: {{ value }}\n+    {% endtimezone %}\n+\n+.. note::\n+\n+    In the second block, ``None`` resolves to the Python object ``None``\n+    because isn't defined in the template context, not because it's the string\n+    ``None``.\n+\n+.. templatetag:: get_current_timezone\n+\n+get_current_timezone\n+~~~~~~~~~~~~~~~~~~~~\n+\n+When the :func:`django.core.context_processors.tz` context processor is\n+enabled -- by default, it is -- each :class:`~django.template.RequestContext`\n+contains a ``TIME_ZONE`` variable that provides the name of the current time\n+zone.\n+\n+If you don't use a :class:`~django.template.RequestContext`, you can obtain\n+this value with the ``get_current_timezone`` tag::\n+\n+    {% get_current_timezone as TIME_ZONE %}\n+\n+Template filters\n+----------------\n+\n+These filters accept both aware and naive datetimes. For conversion purposes,\n+they assume that naive datetimes are in the default time zone. They always\n+return aware datetimes.\n+\n+.. templatefilter:: aslocaltime\n+\n+aslocaltime\n+~~~~~~~~~~~\n+\n+Forces conversion of a single value to the current time zone.\n+\n+For example::\n+\n+    {% load tz %}\n+\n+    {{ value|aslocaltime }}\n+\n+.. templatefilter:: asutc\n+\n+asutc\n+~~~~~\n+\n+Forces conversion of a single value to UTC.\n+\n+For example::\n+\n+    {% load tz %}\n+\n+    {{ value|asutc }}\n+\n+astimezone\n+~~~~~~~~~~\n+\n+Forces conversion of a single value to an arbitrary timezone.\n+\n+The argument must be an instance of a :class:`~datetime.tzinfo` subclass or a\n+time zone name. If it is a time zone name, pytz_ is required.\n+\n+For example::\n+\n+    {% load tz %}\n+\n+    {{ value|astimezone:\"Europe/Paris\" }}\n+\n+.. _time-zones-migration-guide:\n+\n+Migration guide\n+===============\n+\n+Here's how to migrate a project that was started before Django supported time\n+zones.\n+\n+Data\n+----\n+\n+PostgreSQL\n+~~~~~~~~~~\n+\n+The PostgreSQL backend stores datetimes as ``timestamp with time zone``. In\n+practice, this means it converts datetimes from the connection's time zone to\n+UTC on storage, and from UTC to the connection's time zone on retrieval.\n+\n+As a consequence, if you're using PostgreSQL, you can switch between ``USE_TZ\n+= False`` and ``USE_TZ = True`` freely. The database connection's time zone\n+will be set to :setting:`TIME_ZONE` or ``UTC`` respectively, so that Django\n+obtains correct datetimes in all cases. You don't need to perform any data\n+conversions.\n+\n+Other databases\n+~~~~~~~~~~~~~~~\n+\n+Other backends store datetimes without time zone information. If you switch\n+from ``USE_TZ = False`` to ``USE_TZ = True``, you must convert your data from\n+local time to UTC -- which isn't deterministic if your local time has DST.\n+\n+Code\n+----\n+\n+The first step is to add :setting:`USE_TZ = True <USE_TZ>` to your settings\n+file and install pytz_ (if possible). At this point, things should mostly\n+work. If you create naive datetime objects in your code, Django makes them\n+aware when necessary.\n+\n+However, these conversions may fail around DST transitions, which means you\n+aren't getting the full benefits of time zone support yet. Also, you're likely\n+to run into a few problems because it's impossible to compare a naive datetime\n+with an aware datetime. Since Django now gives you aware datetimes, you'll get\n+exceptions wherever you compare a datetime that comes from a model or a form\n+with a naive datetime that you've created in your code.\n+\n+So the second step is to refactor your code wherever you instanciate datetime\n+objects to make them aware. This can be done incrementally.\n+:mod:`django.utils.timezone` defines some handy helpers for compatibility\n+code: :func:`~django.utils.timezone.is_aware`,\n+:func:`~django.utils.timezone.is_naive`,\n+:func:`~django.utils.timezone.make_aware`, and\n+:func:`~django.utils.timezone.make_naive`.\n+\n+.. _pytz: http://pytz.sourceforge.net/\n+.. _these issues: http://pytz.sourceforge.net/#problems-with-localtime\n+.. _tz database: http://en.wikipedia.org/wiki/Tz_database"
        },
        {
            "sha": "e7daf2d861d38e0e4b5657ba2e1ae2baa4d8595e",
            "filename": "tests/modeltests/fixtures/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ffixtures%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ffixtures%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ffixtures%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -56,25 +56,25 @@ def test_loading_and_dumping(self):\n         ])\n \n         # Dump the current contents of the database as a JSON fixture\n-        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # Try just dumping the contents of fixtures.Category\n         self._dumpdata_assert(['fixtures.Category'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}]')\n \n         # ...and just fixtures.Article\n-        self._dumpdata_assert(['fixtures.Article'], '[{\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures.Article'], '[{\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # ...and both\n-        self._dumpdata_assert(['fixtures.Category', 'fixtures.Article'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures.Category', 'fixtures.Article'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # Specify a specific model twice\n-        self._dumpdata_assert(['fixtures.Article', 'fixtures.Article'], '[{\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures.Article', 'fixtures.Article'], '[{\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # Specify a dump that specifies Article both explicitly and implicitly\n-        self._dumpdata_assert(['fixtures.Article', 'fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures.Article', 'fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # Same again, but specify in the reverse order\n-        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # Specify one model from one application, and an entire other application.\n         self._dumpdata_assert(['fixtures.Category', 'sites'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 1, \"model\": \"sites.site\", \"fields\": {\"domain\": \"example.com\", \"name\": \"example.com\"}}]')\n@@ -153,11 +153,11 @@ def test_loading_and_dumping(self):\n         self._dumpdata_assert(['fixtures.book'], '[{\"pk\": 1, \"model\": \"fixtures.book\", \"fields\": {\"name\": \"Music for all ages\", \"authors\": [[\"Artist formerly known as \\\\\"Prince\\\\\"\"], [\"Django Reinhardt\"]]}}]', natural_keys=True)\n \n         # Dump the current contents of the database as a JSON fixture\n-        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 5, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"XML identified as leading cause of cancer\", \"pub_date\": \"2006-06-16 16:00:00\"}}, {\"pk\": 4, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Django conquers world!\", \"pub_date\": \"2006-06-16 15:00:00\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Copyright is fine the way it is\", \"pub_date\": \"2006-06-16 14:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker on TV is great!\", \"pub_date\": \"2006-06-16 11:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"copyright\", \"tagged_id\": 3}}, {\"pk\": 2, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"legal\", \"tagged_id\": 3}}, {\"pk\": 3, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"django\", \"tagged_id\": 4}}, {\"pk\": 4, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"world domination\", \"tagged_id\": 4}}, {\"pk\": 3, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Artist formerly known as \\\\\"Prince\\\\\"\"}}, {\"pk\": 1, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Django Reinhardt\"}}, {\"pk\": 2, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Stephane Grappelli\"}}, {\"pk\": 1, \"model\": \"fixtures.visa\", \"fields\": {\"person\": [\"Django Reinhardt\"], \"permissions\": [[\"add_user\", \"auth\", \"user\"], [\"change_user\", \"auth\", \"user\"], [\"delete_user\", \"auth\", \"user\"]]}}, {\"pk\": 2, \"model\": \"fixtures.visa\", \"fields\": {\"person\": [\"Stephane Grappelli\"], \"permissions\": [[\"add_user\", \"auth\", \"user\"], [\"delete_user\", \"auth\", \"user\"]]}}, {\"pk\": 3, \"model\": \"fixtures.visa\", \"fields\": {\"person\": [\"Artist formerly known as \\\\\"Prince\\\\\"\"], \"permissions\": [[\"change_user\", \"auth\", \"user\"]]}}, {\"pk\": 1, \"model\": \"fixtures.book\", \"fields\": {\"name\": \"Music for all ages\", \"authors\": [[\"Artist formerly known as \\\\\"Prince\\\\\"\"], [\"Django Reinhardt\"]]}}]', natural_keys=True)\n+        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 5, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"XML identified as leading cause of cancer\", \"pub_date\": \"2006-06-16T16:00:00\"}}, {\"pk\": 4, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Django conquers world!\", \"pub_date\": \"2006-06-16T15:00:00\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Copyright is fine the way it is\", \"pub_date\": \"2006-06-16T14:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker on TV is great!\", \"pub_date\": \"2006-06-16T11:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"copyright\", \"tagged_id\": 3}}, {\"pk\": 2, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"legal\", \"tagged_id\": 3}}, {\"pk\": 3, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"django\", \"tagged_id\": 4}}, {\"pk\": 4, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"world domination\", \"tagged_id\": 4}}, {\"pk\": 3, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Artist formerly known as \\\\\"Prince\\\\\"\"}}, {\"pk\": 1, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Django Reinhardt\"}}, {\"pk\": 2, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Stephane Grappelli\"}}, {\"pk\": 1, \"model\": \"fixtures.visa\", \"fields\": {\"person\": [\"Django Reinhardt\"], \"permissions\": [[\"add_user\", \"auth\", \"user\"], [\"change_user\", \"auth\", \"user\"], [\"delete_user\", \"auth\", \"user\"]]}}, {\"pk\": 2, \"model\": \"fixtures.visa\", \"fields\": {\"person\": [\"Stephane Grappelli\"], \"permissions\": [[\"add_user\", \"auth\", \"user\"], [\"delete_user\", \"auth\", \"user\"]]}}, {\"pk\": 3, \"model\": \"fixtures.visa\", \"fields\": {\"person\": [\"Artist formerly known as \\\\\"Prince\\\\\"\"], \"permissions\": [[\"change_user\", \"auth\", \"user\"]]}}, {\"pk\": 1, \"model\": \"fixtures.book\", \"fields\": {\"name\": \"Music for all ages\", \"authors\": [[\"Artist formerly known as \\\\\"Prince\\\\\"\"], [\"Django Reinhardt\"]]}}]', natural_keys=True)\n \n         # Dump the current contents of the database as an XML fixture\n         self._dumpdata_assert(['fixtures'], \"\"\"<?xml version=\"1.0\" encoding=\"utf-8\"?>\n-<django-objects version=\"1.0\"><object pk=\"1\" model=\"fixtures.category\"><field type=\"CharField\" name=\"title\">News Stories</field><field type=\"TextField\" name=\"description\">Latest news stories</field></object><object pk=\"5\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">XML identified as leading cause of cancer</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 16:00:00</field></object><object pk=\"4\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Django conquers world!</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 15:00:00</field></object><object pk=\"3\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Copyright is fine the way it is</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 14:00:00</field></object><object pk=\"2\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Poker on TV is great!</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 11:00:00</field></object><object pk=\"1\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Python program becomes self aware</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 11:00:00</field></object><object pk=\"1\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">copyright</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"2\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">legal</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"3\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">django</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">4</field></object><object pk=\"4\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">world domination</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">4</field></object><object pk=\"3\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Artist formerly known as \"Prince\"</field></object><object pk=\"1\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Django Reinhardt</field></object><object pk=\"2\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Stephane Grappelli</field></object><object pk=\"1\" model=\"fixtures.visa\"><field to=\"fixtures.person\" name=\"person\" rel=\"ManyToOneRel\"><natural>Django Reinhardt</natural></field><field to=\"auth.permission\" name=\"permissions\" rel=\"ManyToManyRel\"><object><natural>add_user</natural><natural>auth</natural><natural>user</natural></object><object><natural>change_user</natural><natural>auth</natural><natural>user</natural></object><object><natural>delete_user</natural><natural>auth</natural><natural>user</natural></object></field></object><object pk=\"2\" model=\"fixtures.visa\"><field to=\"fixtures.person\" name=\"person\" rel=\"ManyToOneRel\"><natural>Stephane Grappelli</natural></field><field to=\"auth.permission\" name=\"permissions\" rel=\"ManyToManyRel\"><object><natural>add_user</natural><natural>auth</natural><natural>user</natural></object><object><natural>delete_user</natural><natural>auth</natural><natural>user</natural></object></field></object><object pk=\"3\" model=\"fixtures.visa\"><field to=\"fixtures.person\" name=\"person\" rel=\"ManyToOneRel\"><natural>Artist formerly known as \"Prince\"</natural></field><field to=\"auth.permission\" name=\"permissions\" rel=\"ManyToManyRel\"><object><natural>change_user</natural><natural>auth</natural><natural>user</natural></object></field></object><object pk=\"1\" model=\"fixtures.book\"><field type=\"CharField\" name=\"name\">Music for all ages</field><field to=\"fixtures.person\" name=\"authors\" rel=\"ManyToManyRel\"><object><natural>Artist formerly known as \"Prince\"</natural></object><object><natural>Django Reinhardt</natural></object></field></object></django-objects>\"\"\", format='xml', natural_keys=True)\n+<django-objects version=\"1.0\"><object pk=\"1\" model=\"fixtures.category\"><field type=\"CharField\" name=\"title\">News Stories</field><field type=\"TextField\" name=\"description\">Latest news stories</field></object><object pk=\"5\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">XML identified as leading cause of cancer</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T16:00:00</field></object><object pk=\"4\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Django conquers world!</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T15:00:00</field></object><object pk=\"3\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Copyright is fine the way it is</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T14:00:00</field></object><object pk=\"2\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Poker on TV is great!</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T11:00:00</field></object><object pk=\"1\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Python program becomes self aware</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T11:00:00</field></object><object pk=\"1\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">copyright</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"2\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">legal</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"3\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">django</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">4</field></object><object pk=\"4\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">world domination</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">4</field></object><object pk=\"3\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Artist formerly known as \"Prince\"</field></object><object pk=\"1\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Django Reinhardt</field></object><object pk=\"2\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Stephane Grappelli</field></object><object pk=\"1\" model=\"fixtures.visa\"><field to=\"fixtures.person\" name=\"person\" rel=\"ManyToOneRel\"><natural>Django Reinhardt</natural></field><field to=\"auth.permission\" name=\"permissions\" rel=\"ManyToManyRel\"><object><natural>add_user</natural><natural>auth</natural><natural>user</natural></object><object><natural>change_user</natural><natural>auth</natural><natural>user</natural></object><object><natural>delete_user</natural><natural>auth</natural><natural>user</natural></object></field></object><object pk=\"2\" model=\"fixtures.visa\"><field to=\"fixtures.person\" name=\"person\" rel=\"ManyToOneRel\"><natural>Stephane Grappelli</natural></field><field to=\"auth.permission\" name=\"permissions\" rel=\"ManyToManyRel\"><object><natural>add_user</natural><natural>auth</natural><natural>user</natural></object><object><natural>delete_user</natural><natural>auth</natural><natural>user</natural></object></field></object><object pk=\"3\" model=\"fixtures.visa\"><field to=\"fixtures.person\" name=\"person\" rel=\"ManyToOneRel\"><natural>Artist formerly known as \"Prince\"</natural></field><field to=\"auth.permission\" name=\"permissions\" rel=\"ManyToManyRel\"><object><natural>change_user</natural><natural>auth</natural><natural>user</natural></object></field></object><object pk=\"1\" model=\"fixtures.book\"><field type=\"CharField\" name=\"name\">Music for all ages</field><field to=\"fixtures.person\" name=\"authors\" rel=\"ManyToManyRel\"><object><natural>Artist formerly known as \"Prince\"</natural></object><object><natural>Django Reinhardt</natural></object></field></object></django-objects>\"\"\", format='xml', natural_keys=True)\n \n     def test_dumpdata_with_excludes(self):\n         # Load fixture1 which has a site, two articles, and a category\n@@ -305,11 +305,11 @@ def test_output_formats(self):\n         ])\n \n         # Dump the current contents of the database as a JSON fixture\n-        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"copyright\", \"tagged_id\": 3}}, {\"pk\": 2, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"law\", \"tagged_id\": 3}}, {\"pk\": 1, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Django Reinhardt\"}}, {\"pk\": 3, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Prince\"}}, {\"pk\": 2, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Stephane Grappelli\"}}]', natural_keys=True)\n+        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"copyright\", \"tagged_id\": 3}}, {\"pk\": 2, \"model\": \"fixtures.tag\", \"fields\": {\"tagged_type\": [\"fixtures\", \"article\"], \"name\": \"law\", \"tagged_id\": 3}}, {\"pk\": 1, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Django Reinhardt\"}}, {\"pk\": 3, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Prince\"}}, {\"pk\": 2, \"model\": \"fixtures.person\", \"fields\": {\"name\": \"Stephane Grappelli\"}}]', natural_keys=True)\n \n         # Dump the current contents of the database as an XML fixture\n         self._dumpdata_assert(['fixtures'], \"\"\"<?xml version=\"1.0\" encoding=\"utf-8\"?>\n-<django-objects version=\"1.0\"><object pk=\"1\" model=\"fixtures.category\"><field type=\"CharField\" name=\"title\">News Stories</field><field type=\"TextField\" name=\"description\">Latest news stories</field></object><object pk=\"3\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Time to reform copyright</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 13:00:00</field></object><object pk=\"2\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Poker has no place on ESPN</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 12:00:00</field></object><object pk=\"1\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Python program becomes self aware</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 11:00:00</field></object><object pk=\"1\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">copyright</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"2\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">law</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"1\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Django Reinhardt</field></object><object pk=\"3\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Prince</field></object><object pk=\"2\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Stephane Grappelli</field></object></django-objects>\"\"\", format='xml', natural_keys=True)\n+<django-objects version=\"1.0\"><object pk=\"1\" model=\"fixtures.category\"><field type=\"CharField\" name=\"title\">News Stories</field><field type=\"TextField\" name=\"description\">Latest news stories</field></object><object pk=\"3\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Time to reform copyright</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T13:00:00</field></object><object pk=\"2\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Poker has no place on ESPN</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T12:00:00</field></object><object pk=\"1\" model=\"fixtures.article\"><field type=\"CharField\" name=\"headline\">Python program becomes self aware</field><field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T11:00:00</field></object><object pk=\"1\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">copyright</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"2\" model=\"fixtures.tag\"><field type=\"CharField\" name=\"name\">law</field><field to=\"contenttypes.contenttype\" name=\"tagged_type\" rel=\"ManyToOneRel\"><natural>fixtures</natural><natural>article</natural></field><field type=\"PositiveIntegerField\" name=\"tagged_id\">3</field></object><object pk=\"1\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Django Reinhardt</field></object><object pk=\"3\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Prince</field></object><object pk=\"2\" model=\"fixtures.person\"><field type=\"CharField\" name=\"name\">Stephane Grappelli</field></object></django-objects>\"\"\", format='xml', natural_keys=True)\n \n class FixtureTransactionTests(TransactionTestCase):\n     def _dumpdata_assert(self, args, output, format='json'):\n@@ -344,7 +344,7 @@ def test_format_discovery(self):\n         ])\n \n         # Dump the current contents of the database as a JSON fixture\n-        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16 13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16 12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16 11:00:00\"}}]')\n+        self._dumpdata_assert(['fixtures'], '[{\"pk\": 1, \"model\": \"fixtures.category\", \"fields\": {\"description\": \"Latest news stories\", \"title\": \"News Stories\"}}, {\"pk\": 3, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Time to reform copyright\", \"pub_date\": \"2006-06-16T13:00:00\"}}, {\"pk\": 2, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Poker has no place on ESPN\", \"pub_date\": \"2006-06-16T12:00:00\"}}, {\"pk\": 1, \"model\": \"fixtures.article\", \"fields\": {\"headline\": \"Python program becomes self aware\", \"pub_date\": \"2006-06-16T11:00:00\"}}]')\n \n         # Load fixture 4 (compressed), using format discovery\n         management.call_command('loaddata', 'fixture4', verbosity=0, commit=False)"
        },
        {
            "sha": "721ca09282edb60de975a781e390c0a1504d0368",
            "filename": "tests/modeltests/serializers/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Fserializers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Fserializers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fserializers%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -230,7 +230,7 @@ def test_pre_1000ad_date(self):\n \n         serial_str = serializers.serialize(self.serializer_name, [a])\n         date_values = self._get_field_values(serial_str, \"pub_date\")\n-        self.assertEqual(date_values[0], \"0001-02-03 04:05:06\")\n+        self.assertEqual(date_values[0].replace('T', ' '), \"0001-02-03 04:05:06\")\n \n     def test_pkless_serialized_strings(self):\n         \"\"\"\n@@ -323,7 +323,7 @@ class XmlSerializerTransactionTestCase(SerializersTransactionTestBase, Transacti\n     <object pk=\"1\" model=\"serializers.article\">\n         <field to=\"serializers.author\" name=\"author\" rel=\"ManyToOneRel\">1</field>\n         <field type=\"CharField\" name=\"headline\">Forward references pose no problem</field>\n-        <field type=\"DateTimeField\" name=\"pub_date\">2006-06-16 15:00:00</field>\n+        <field type=\"DateTimeField\" name=\"pub_date\">2006-06-16T15:00:00</field>\n         <field to=\"serializers.category\" name=\"categories\" rel=\"ManyToManyRel\">\n             <object pk=\"1\"></object>\n         </field>\n@@ -374,7 +374,7 @@ class JsonSerializerTransactionTestCase(SerializersTransactionTestBase, Transact\n         \"model\": \"serializers.article\",\n         \"fields\": {\n             \"headline\": \"Forward references pose no problem\",\n-            \"pub_date\": \"2006-06-16 15:00:00\",\n+            \"pub_date\": \"2006-06-16T15:00:00\",\n             \"categories\": [1],\n             \"author\": 1\n         }"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/modeltests/timezones/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2F__init__.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e"
        },
        {
            "sha": "4c199813e2561dafdeef7c5b04639df0bb0c03fc",
            "filename": "tests/modeltests/timezones/admin.py",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Fadmin.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,15 @@\n+from __future__ import absolute_import\n+\n+from django.contrib import admin\n+\n+from .models import Event, Timestamp\n+\n+class EventAdmin(admin.ModelAdmin):\n+    list_display = ('dt',)\n+\n+admin.site.register(Event, EventAdmin)\n+\n+class TimestampAdmin(admin.ModelAdmin):\n+    readonly_fields = ('created', 'updated')\n+\n+admin.site.register(Timestamp, TimestampAdmin)"
        },
        {
            "sha": "6cf441f01ef5663638031af96e86d1157939d3bb",
            "filename": "tests/modeltests/timezones/fixtures/users.xml",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Ffixtures%2Fusers.xml",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Ffixtures%2Fusers.xml",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ffixtures%2Fusers.xml?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,17 @@\n+<?xml version=\"1.0\" encoding=\"utf-8\"?>\n+<django-objects version=\"1.0\">\n+    <object pk=\"100\" model=\"auth.user\">\n+        <field type=\"CharField\" name=\"username\">super</field>\n+        <field type=\"CharField\" name=\"first_name\">Super</field>\n+        <field type=\"CharField\" name=\"last_name\">User</field>\n+        <field type=\"CharField\" name=\"email\">super@example.com</field>\n+        <field type=\"CharField\" name=\"password\">sha1$995a3$6011485ea3834267d719b4c801409b8b1ddd0158</field>\n+        <field type=\"BooleanField\" name=\"is_staff\">True</field>\n+        <field type=\"BooleanField\" name=\"is_active\">True</field>\n+        <field type=\"BooleanField\" name=\"is_superuser\">True</field>\n+        <field type=\"DateTimeField\" name=\"last_login\">2007-05-30 13:20:10</field>\n+        <field type=\"DateTimeField\" name=\"date_joined\">2007-05-30 13:20:10</field>\n+        <field to=\"auth.group\" name=\"groups\" rel=\"ManyToManyRel\"></field>\n+        <field to=\"auth.permission\" name=\"user_permissions\" rel=\"ManyToManyRel\"></field>\n+    </object>\n+</django-objects>\n\\ No newline at end of file"
        },
        {
            "sha": "3c9c31167e6e66fe7591a85c179dd78ba004654e",
            "filename": "tests/modeltests/timezones/forms.py",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Fforms.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,13 @@\n+from django import forms\n+\n+from .models import Event\n+\n+class EventForm(forms.Form):\n+    dt = forms.DateTimeField()\n+\n+class EventSplitForm(forms.Form):\n+    dt = forms.SplitDateTimeField()\n+\n+class EventModelForm(forms.ModelForm):\n+    class Meta:\n+        model = Event"
        },
        {
            "sha": "bd488d1132ada9b8274d82ba57153cb6655bc3ce",
            "filename": "tests/modeltests/timezones/models.py",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Fmodels.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,8 @@\n+from django.db import models\n+\n+class Event(models.Model):\n+    dt = models.DateTimeField()\n+\n+class Timestamp(models.Model):\n+    created = models.DateTimeField(auto_now_add=True)\n+    updated = models.DateTimeField(auto_now=True)"
        },
        {
            "sha": "e33d4c61f84f84cc9ecf06b8b008137ffc658ce9",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "added",
            "additions": 871,
            "deletions": 0,
            "changes": 871,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,871 @@\n+from __future__ import with_statement\n+\n+import datetime\n+import os\n+import time\n+\n+try:\n+    import pytz\n+except ImportError:\n+    pytz = None\n+\n+from django.conf import settings\n+from django.core import serializers\n+from django.core.urlresolvers import reverse\n+from django.db import connection\n+from django.db.models import Min, Max\n+from django.http import HttpRequest\n+from django.template import Context, RequestContext, Template, TemplateSyntaxError\n+from django.test import TestCase, skipIfDBFeature, skipUnlessDBFeature\n+from django.test.utils import override_settings\n+from django.utils import timezone\n+from django.utils.tzinfo import FixedOffset\n+from django.utils.unittest import skipIf\n+\n+from .forms import EventForm, EventSplitForm, EventModelForm\n+from .models import Event, Timestamp\n+\n+\n+# These tests use the EAT (Eastern Africa Time) and ICT (Indochina Time)\n+# who don't have Daylight Saving Time, so we can represent them easily\n+# with FixedOffset, and use them directly as tzinfo in the constructors.\n+\n+# settings.TIME_ZONE is forced to EAT. Most tests use a variant of\n+# datetime.datetime(2011, 9, 1, 13, 20, 30), which translates to\n+# 10:20:30 in UTC and 17:20:30 in ICT.\n+\n+UTC = timezone.utc\n+EAT = FixedOffset(180)      # Africa/Nairobi\n+ICT = FixedOffset(420)      # Asia/Bangkok\n+\n+TZ_SUPPORT = hasattr(time, 'tzset')\n+\n+\n+class BaseDateTimeTests(TestCase):\n+\n+    @classmethod\n+    def setUpClass(self):\n+        self._old_time_zone = settings.TIME_ZONE\n+        settings.TIME_ZONE = connection.settings_dict['TIME_ZONE'] = 'Africa/Nairobi'\n+        timezone._localtime = None\n+        if TZ_SUPPORT:\n+            self._old_tz = os.environ.get('TZ')\n+            os.environ['TZ'] = 'Africa/Nairobi'\n+            time.tzset()\n+        # Create a new cursor, for test cases that change the value of USE_TZ.\n+        connection.close()\n+\n+    @classmethod\n+    def tearDownClass(self):\n+        settings.TIME_ZONE = connection.settings_dict['TIME_ZONE'] = self._old_time_zone\n+        timezone._localtime = None\n+        if TZ_SUPPORT:\n+            if self._old_tz is None:\n+                del os.environ['TZ']\n+            else:\n+                os.environ['TZ'] = self._old_tz\n+            time.tzset()\n+\n+\n+#@override_settings(USE_TZ=False)\n+class LegacyDatabaseTests(BaseDateTimeTests):\n+\n+    def test_naive_datetime(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertEqual(event.dt, dt)\n+\n+    @skipUnlessDBFeature('supports_microsecond_precision')\n+    def test_naive_datetime_with_microsecond(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertEqual(event.dt, dt)\n+\n+    @skipIfDBFeature('supports_microsecond_precision')\n+    def test_naive_datetime_with_microsecond_unsupported(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        # microseconds are lost during a round-trip in the database\n+        self.assertEqual(event.dt, dt.replace(microsecond=0))\n+\n+    @skipUnlessDBFeature('supports_timezones')\n+    def test_aware_datetime_in_local_timezone(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # interpret the naive datetime in local time to get the correct value\n+        self.assertEqual(event.dt.replace(tzinfo=EAT), dt)\n+\n+    @skipUnlessDBFeature('supports_timezones')\n+    @skipUnlessDBFeature('supports_microsecond_precision')\n+    def test_aware_datetime_in_local_timezone_with_microsecond(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060, tzinfo=EAT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # interpret the naive datetime in local time to get the correct value\n+        self.assertEqual(event.dt.replace(tzinfo=EAT), dt)\n+\n+    # This combination actually never happens.\n+    @skipUnlessDBFeature('supports_timezones')\n+    @skipIfDBFeature('supports_microsecond_precision')\n+    def test_aware_datetime_in_local_timezone_with_microsecond_unsupported(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060, tzinfo=EAT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # interpret the naive datetime in local time to get the correct value\n+        # microseconds are lost during a round-trip in the database\n+        self.assertEqual(event.dt.replace(tzinfo=EAT), dt.replace(microsecond=0))\n+\n+    @skipUnlessDBFeature('supports_timezones')\n+    @skipIfDBFeature('needs_datetime_string_cast')\n+    def test_aware_datetime_in_utc(self):\n+        dt = datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # interpret the naive datetime in local time to get the correct value\n+        self.assertEqual(event.dt.replace(tzinfo=EAT), dt)\n+\n+    # This combination is no longer possible since timezone support\n+    # was removed from the SQLite backend -- it didn't work.\n+    @skipUnlessDBFeature('supports_timezones')\n+    @skipUnlessDBFeature('needs_datetime_string_cast')\n+    def test_aware_datetime_in_utc_unsupported(self):\n+        dt = datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # django.db.backend.utils.typecast_dt will just drop the\n+        # timezone, so a round-trip in the database alters the data (!)\n+        # interpret the naive datetime in local time and you get a wrong value\n+        self.assertNotEqual(event.dt.replace(tzinfo=EAT), dt)\n+        # interpret the naive datetime in original time to get the correct value\n+        self.assertEqual(event.dt.replace(tzinfo=UTC), dt)\n+\n+    @skipUnlessDBFeature('supports_timezones')\n+    @skipIfDBFeature('needs_datetime_string_cast')\n+    def test_aware_datetime_in_other_timezone(self):\n+        dt = datetime.datetime(2011, 9, 1, 17, 20, 30, tzinfo=ICT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # interpret the naive datetime in local time to get the correct value\n+        self.assertEqual(event.dt.replace(tzinfo=EAT), dt)\n+\n+    # This combination is no longer possible since timezone support\n+    # was removed from the SQLite backend -- it didn't work.\n+    @skipUnlessDBFeature('supports_timezones')\n+    @skipUnlessDBFeature('needs_datetime_string_cast')\n+    def test_aware_datetime_in_other_timezone_unsupported(self):\n+        dt = datetime.datetime(2011, 9, 1, 17, 20, 30, tzinfo=ICT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertIsNone(event.dt.tzinfo)\n+        # django.db.backend.utils.typecast_dt will just drop the\n+        # timezone, so a round-trip in the database alters the data (!)\n+        # interpret the naive datetime in local time and you get a wrong value\n+        self.assertNotEqual(event.dt.replace(tzinfo=EAT), dt)\n+        # interpret the naive datetime in original time to get the correct value\n+        self.assertEqual(event.dt.replace(tzinfo=ICT), dt)\n+\n+    @skipIfDBFeature('supports_timezones')\n+    def test_aware_datetime_unspported(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT)\n+        with self.assertRaises(ValueError):\n+            Event.objects.create(dt=dt)\n+\n+    def test_auto_now_and_auto_now_add(self):\n+        now = datetime.datetime.now()\n+        past = now - datetime.timedelta(seconds=2)\n+        future = now + datetime.timedelta(seconds=2)\n+        Timestamp.objects.create()\n+        ts = Timestamp.objects.get()\n+        self.assertLess(past, ts.created)\n+        self.assertLess(past, ts.updated)\n+        self.assertGreater(future, ts.updated)\n+        self.assertGreater(future, ts.updated)\n+\n+    def test_query_filter(self):\n+        dt1 = datetime.datetime(2011, 9, 1, 12, 20, 30)\n+        dt2 = datetime.datetime(2011, 9, 1, 14, 20, 30)\n+        Event.objects.create(dt=dt1)\n+        Event.objects.create(dt=dt2)\n+        self.assertEqual(Event.objects.filter(dt__gte=dt1).count(), 2)\n+        self.assertEqual(Event.objects.filter(dt__gt=dt1).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__gte=dt2).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__gt=dt2).count(), 0)\n+\n+    def test_query_date_related_filters(self):\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 1, 30, 0))\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 4, 30, 0))\n+        self.assertEqual(Event.objects.filter(dt__year=2011).count(), 2)\n+        self.assertEqual(Event.objects.filter(dt__month=1).count(), 2)\n+        self.assertEqual(Event.objects.filter(dt__day=1).count(), 2)\n+        self.assertEqual(Event.objects.filter(dt__week_day=7).count(), 2)\n+\n+    def test_query_aggregation(self):\n+        # Only min and max make sense for datetimes.\n+        Event.objects.create(dt=datetime.datetime(2011, 9, 1, 23, 20, 20))\n+        Event.objects.create(dt=datetime.datetime(2011, 9, 1, 13, 20, 30))\n+        Event.objects.create(dt=datetime.datetime(2011, 9, 1, 3, 20, 40))\n+        result = Event.objects.all().aggregate(Min('dt'), Max('dt'))\n+        self.assertEqual(result, {\n+            'dt__min': datetime.datetime(2011, 9, 1, 3, 20, 40),\n+            'dt__max': datetime.datetime(2011, 9, 1, 23, 20, 20),\n+        })\n+\n+    def test_query_dates(self):\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 1, 30, 0))\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 4, 30, 0))\n+        self.assertQuerysetEqual(Event.objects.dates('dt', 'year'),\n+                [datetime.datetime(2011, 1, 1)], transform=lambda d: d)\n+        self.assertQuerysetEqual(Event.objects.dates('dt', 'month'),\n+                [datetime.datetime(2011, 1, 1)], transform=lambda d: d)\n+        self.assertQuerysetEqual(Event.objects.dates('dt', 'day'),\n+                [datetime.datetime(2011, 1, 1)], transform=lambda d: d)\n+\n+LegacyDatabaseTests = override_settings(USE_TZ=False)(LegacyDatabaseTests)\n+\n+\n+#@override_settings(USE_TZ=True)\n+class NewDatabaseTests(BaseDateTimeTests):\n+\n+    def test_naive_datetime(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        # naive datetimes are interpreted in local time\n+        self.assertEqual(event.dt, dt.replace(tzinfo=EAT))\n+\n+    @skipUnlessDBFeature('supports_microsecond_precision')\n+    def test_naive_datetime_with_microsecond(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        # naive datetimes are interpreted in local time\n+        self.assertEqual(event.dt, dt.replace(tzinfo=EAT))\n+\n+    @skipIfDBFeature('supports_microsecond_precision')\n+    def test_naive_datetime_with_microsecond_unsupported(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        # microseconds are lost during a round-trip in the database\n+        # naive datetimes are interpreted in local time\n+        self.assertEqual(event.dt, dt.replace(microsecond=0, tzinfo=EAT))\n+\n+    def test_aware_datetime_in_local_timezone(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertEqual(event.dt, dt)\n+\n+    @skipUnlessDBFeature('supports_microsecond_precision')\n+    def test_aware_datetime_in_local_timezone_with_microsecond(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060, tzinfo=EAT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertEqual(event.dt, dt)\n+\n+    @skipIfDBFeature('supports_microsecond_precision')\n+    def test_aware_datetime_in_local_timezone_with_microsecond_unsupported(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060, tzinfo=EAT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        # microseconds are lost during a round-trip in the database\n+        self.assertEqual(event.dt, dt.replace(microsecond=0))\n+\n+    def test_aware_datetime_in_utc(self):\n+        dt = datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertEqual(event.dt, dt)\n+\n+    def test_aware_datetime_in_other_timezone(self):\n+        dt = datetime.datetime(2011, 9, 1, 17, 20, 30, tzinfo=ICT)\n+        Event.objects.create(dt=dt)\n+        event = Event.objects.get()\n+        self.assertEqual(event.dt, dt)\n+\n+    def test_auto_now_and_auto_now_add(self):\n+        now = datetime.datetime.utcnow().replace(tzinfo=UTC)\n+        past = now - datetime.timedelta(seconds=2)\n+        future = now + datetime.timedelta(seconds=2)\n+        Timestamp.objects.create()\n+        ts = Timestamp.objects.get()\n+        self.assertLess(past, ts.created)\n+        self.assertLess(past, ts.updated)\n+        self.assertGreater(future, ts.updated)\n+        self.assertGreater(future, ts.updated)\n+\n+    def test_query_filter(self):\n+        dt1 = datetime.datetime(2011, 9, 1, 12, 20, 30, tzinfo=EAT)\n+        dt2 = datetime.datetime(2011, 9, 1, 14, 20, 30, tzinfo=EAT)\n+        Event.objects.create(dt=dt1)\n+        Event.objects.create(dt=dt2)\n+        self.assertEqual(Event.objects.filter(dt__gte=dt1).count(), 2)\n+        self.assertEqual(Event.objects.filter(dt__gt=dt1).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__gte=dt2).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__gt=dt2).count(), 0)\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_query_filter_with_pytz_timezones(self):\n+        tz = pytz.timezone('Europe/Paris')\n+        dt = datetime.datetime(2011, 9, 1, 12, 20, 30, tzinfo=tz)\n+        Event.objects.create(dt=dt)\n+        next = dt + datetime.timedelta(seconds=3)\n+        prev = dt - datetime.timedelta(seconds=3)\n+        self.assertEqual(Event.objects.filter(dt__exact=dt).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__exact=next).count(), 0)\n+        self.assertEqual(Event.objects.filter(dt__in=(prev, next)).count(), 0)\n+        self.assertEqual(Event.objects.filter(dt__in=(prev, dt, next)).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__range=(prev, next)).count(), 1)\n+\n+    def test_query_date_related_filters(self):\n+        # These two dates fall in the same day in EAT, but in different days,\n+        # years and months in UTC, and aggregation is performed in UTC when\n+        # time zone support is enabled. This test could be changed if the\n+        # implementation is changed to perform the aggregation is local time.\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 1, 30, 0, tzinfo=EAT))\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 4, 30, 0, tzinfo=EAT))\n+        self.assertEqual(Event.objects.filter(dt__year=2011).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__month=1).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__day=1).count(), 1)\n+        self.assertEqual(Event.objects.filter(dt__week_day=7).count(), 1)\n+\n+    def test_query_aggregation(self):\n+        # Only min and max make sense for datetimes.\n+        Event.objects.create(dt=datetime.datetime(2011, 9, 1, 23, 20, 20, tzinfo=EAT))\n+        Event.objects.create(dt=datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT))\n+        Event.objects.create(dt=datetime.datetime(2011, 9, 1, 3, 20, 40, tzinfo=EAT))\n+        result = Event.objects.all().aggregate(Min('dt'), Max('dt'))\n+        self.assertEqual(result, {\n+            'dt__min': datetime.datetime(2011, 9, 1, 3, 20, 40, tzinfo=EAT),\n+            'dt__max': datetime.datetime(2011, 9, 1, 23, 20, 20, tzinfo=EAT),\n+        })\n+\n+    def test_query_dates(self):\n+        # Same comment as in test_query_date_related_filters.\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 1, 30, 0, tzinfo=EAT))\n+        Event.objects.create(dt=datetime.datetime(2011, 1, 1, 4, 30, 0, tzinfo=EAT))\n+        self.assertQuerysetEqual(Event.objects.dates('dt', 'year'),\n+                [datetime.datetime(2010, 1, 1, tzinfo=UTC),\n+                 datetime.datetime(2011, 1, 1, tzinfo=UTC)],\n+                transform=lambda d: d)\n+        self.assertQuerysetEqual(Event.objects.dates('dt', 'month'),\n+                [datetime.datetime(2010, 12, 1, tzinfo=UTC),\n+                 datetime.datetime(2011, 1, 1, tzinfo=UTC)],\n+                transform=lambda d: d)\n+        self.assertQuerysetEqual(Event.objects.dates('dt', 'day'),\n+                [datetime.datetime(2010, 12, 31, tzinfo=UTC),\n+                 datetime.datetime(2011, 1, 1, tzinfo=UTC)],\n+                transform=lambda d: d)\n+\n+NewDatabaseTests = override_settings(USE_TZ=True)(NewDatabaseTests)\n+\n+\n+class SerializationTests(BaseDateTimeTests):\n+\n+    # Backend-specific notes:\n+    # - JSON supports only milliseconds, microseconds will be truncated.\n+    # - PyYAML dumps the UTC offset correctly for timezone-aware datetimes,\n+    #   but when it loads this representation, it substracts the offset and\n+    #   returns a naive datetime object in UTC (http://pyyaml.org/ticket/202).\n+    # Tests are adapted to take these quirks into account.\n+\n+    def test_naive_datetime(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n+\n+        data = serializers.serialize('python', [Event(dt=dt)])\n+        self.assertEqual(data[0]['fields']['dt'], dt)\n+        obj = serializers.deserialize('python', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('json', [Event(dt=dt)])\n+        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T13:20:30\"}', data)\n+        obj = serializers.deserialize('json', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('xml', [Event(dt=dt)])\n+        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T13:20:30</field>', data)\n+        obj = serializers.deserialize('xml', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        if 'yaml' in serializers.get_serializer_formats():\n+            data = serializers.serialize('yaml', [Event(dt=dt)])\n+            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 13:20:30'}\", data)\n+            obj = serializers.deserialize('yaml', data).next().object\n+            self.assertEqual(obj.dt, dt)\n+\n+    def test_naive_datetime_with_microsecond(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n+\n+        data = serializers.serialize('python', [Event(dt=dt)])\n+        self.assertEqual(data[0]['fields']['dt'], dt)\n+        obj = serializers.deserialize('python', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('json', [Event(dt=dt)])\n+        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T13:20:30.405\"}', data)\n+        obj = serializers.deserialize('json', data).next().object\n+        self.assertEqual(obj.dt, dt.replace(microsecond=405000))\n+\n+        data = serializers.serialize('xml', [Event(dt=dt)])\n+        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T13:20:30.405060</field>', data)\n+        obj = serializers.deserialize('xml', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        if 'yaml' in serializers.get_serializer_formats():\n+            data = serializers.serialize('yaml', [Event(dt=dt)])\n+            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 13:20:30.405060'}\", data)\n+            obj = serializers.deserialize('yaml', data).next().object\n+            self.assertEqual(obj.dt, dt)\n+\n+    def test_aware_datetime_with_microsecond(self):\n+        dt = datetime.datetime(2011, 9, 1, 17, 20, 30, 405060, tzinfo=ICT)\n+\n+        data = serializers.serialize('python', [Event(dt=dt)])\n+        self.assertEqual(data[0]['fields']['dt'], dt)\n+        obj = serializers.deserialize('python', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('json', [Event(dt=dt)])\n+        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T17:20:30.405+07:00\"}', data)\n+        obj = serializers.deserialize('json', data).next().object\n+        self.assertEqual(obj.dt, dt.replace(microsecond=405000))\n+\n+        data = serializers.serialize('xml', [Event(dt=dt)])\n+        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T17:20:30.405060+07:00</field>', data)\n+        obj = serializers.deserialize('xml', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        if 'yaml' in serializers.get_serializer_formats():\n+            data = serializers.serialize('yaml', [Event(dt=dt)])\n+            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 17:20:30.405060+07:00'}\", data)\n+            obj = serializers.deserialize('yaml', data).next().object\n+            self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n+\n+    def test_aware_datetime_in_utc(self):\n+        dt = datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC)\n+\n+        data = serializers.serialize('python', [Event(dt=dt)])\n+        self.assertEqual(data[0]['fields']['dt'], dt)\n+        obj = serializers.deserialize('python', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('json', [Event(dt=dt)])\n+        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T10:20:30Z\"}', data)\n+        obj = serializers.deserialize('json', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('xml', [Event(dt=dt)])\n+        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T10:20:30+00:00</field>', data)\n+        obj = serializers.deserialize('xml', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        if 'yaml' in serializers.get_serializer_formats():\n+            data = serializers.serialize('yaml', [Event(dt=dt)])\n+            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 10:20:30+00:00'}\", data)\n+            obj = serializers.deserialize('yaml', data).next().object\n+            self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n+\n+    def test_aware_datetime_in_local_timezone(self):\n+        dt = datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT)\n+\n+        data = serializers.serialize('python', [Event(dt=dt)])\n+        self.assertEqual(data[0]['fields']['dt'], dt)\n+        obj = serializers.deserialize('python', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('json', [Event(dt=dt)])\n+        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T13:20:30+03:00\"}', data)\n+        obj = serializers.deserialize('json', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('xml', [Event(dt=dt)])\n+        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T13:20:30+03:00</field>', data)\n+        obj = serializers.deserialize('xml', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        if 'yaml' in serializers.get_serializer_formats():\n+            data = serializers.serialize('yaml', [Event(dt=dt)])\n+            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 13:20:30+03:00'}\", data)\n+            obj = serializers.deserialize('yaml', data).next().object\n+            self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n+\n+    def test_aware_datetime_in_other_timezone(self):\n+        dt = datetime.datetime(2011, 9, 1, 17, 20, 30, tzinfo=ICT)\n+\n+        data = serializers.serialize('python', [Event(dt=dt)])\n+        self.assertEqual(data[0]['fields']['dt'], dt)\n+        obj = serializers.deserialize('python', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('json', [Event(dt=dt)])\n+        self.assertIn('\"fields\": {\"dt\": \"2011-09-01T17:20:30+07:00\"}', data)\n+        obj = serializers.deserialize('json', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        data = serializers.serialize('xml', [Event(dt=dt)])\n+        self.assertIn('<field type=\"DateTimeField\" name=\"dt\">2011-09-01T17:20:30+07:00</field>', data)\n+        obj = serializers.deserialize('xml', data).next().object\n+        self.assertEqual(obj.dt, dt)\n+\n+        if 'yaml' in serializers.get_serializer_formats():\n+            data = serializers.serialize('yaml', [Event(dt=dt)])\n+            self.assertIn(\"- fields: {dt: !!timestamp '2011-09-01 17:20:30+07:00'}\", data)\n+            obj = serializers.deserialize('yaml', data).next().object\n+            self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n+\n+#@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n+class TemplateTests(BaseDateTimeTests):\n+\n+    def test_localtime_templatetag_and_filters(self):\n+        \"\"\"\n+        Test the {% localtime %} templatetag and related filters.\n+        \"\"\"\n+        datetimes = {\n+            'utc': datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC),\n+            'eat': datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT),\n+            'ict': datetime.datetime(2011, 9, 1, 17, 20, 30, tzinfo=ICT),\n+            'naive': datetime.datetime(2011, 9, 1, 13, 20, 30),\n+        }\n+        templates = {\n+            'notag': Template(\"{% load tz %}{{ dt }}|{{ dt|aslocaltime }}|{{ dt|asutc }}|{{ dt|astimezone:ICT }}\"),\n+            'noarg': Template(\"{% load tz %}{% localtime %}{{ dt }}|{{ dt|aslocaltime }}|{{ dt|asutc }}|{{ dt|astimezone:ICT }}{% endlocaltime %}\"),\n+            'on':    Template(\"{% load tz %}{% localtime on %}{{ dt }}|{{ dt|aslocaltime }}|{{ dt|asutc }}|{{ dt|astimezone:ICT }}{% endlocaltime %}\"),\n+            'off':   Template(\"{% load tz %}{% localtime off %}{{ dt }}|{{ dt|aslocaltime }}|{{ dt|asutc }}|{{ dt|astimezone:ICT }}{% endlocaltime %}\"),\n+        }\n+\n+        # Transform a list of keys in 'datetimes' to the expected template\n+        # output. This makes the definition of 'results' more readable.\n+        def t(*result):\n+            return '|'.join(datetimes[key].isoformat() for key in result)\n+\n+        # Results for USE_TZ = True\n+\n+        results = {\n+            'utc': {\n+                'notag': t('eat', 'eat', 'utc', 'ict'),\n+                'noarg': t('eat', 'eat', 'utc', 'ict'),\n+                'on':    t('eat', 'eat', 'utc', 'ict'),\n+                'off':   t('utc', 'eat', 'utc', 'ict'),\n+            },\n+            'eat': {\n+                'notag': t('eat', 'eat', 'utc', 'ict'),\n+                'noarg': t('eat', 'eat', 'utc', 'ict'),\n+                'on':    t('eat', 'eat', 'utc', 'ict'),\n+                'off':   t('eat', 'eat', 'utc', 'ict'),\n+            },\n+            'ict': {\n+                'notag': t('eat', 'eat', 'utc', 'ict'),\n+                'noarg': t('eat', 'eat', 'utc', 'ict'),\n+                'on':    t('eat', 'eat', 'utc', 'ict'),\n+                'off':   t('ict', 'eat', 'utc', 'ict'),\n+            },\n+            'naive': {\n+                'notag': t('naive', 'eat', 'utc', 'ict'),\n+                'noarg': t('naive', 'eat', 'utc', 'ict'),\n+                'on':    t('naive', 'eat', 'utc', 'ict'),\n+                'off':   t('naive', 'eat', 'utc', 'ict'),\n+            }\n+        }\n+\n+        for k1, dt in datetimes.iteritems():\n+            for k2, tpl in templates.iteritems():\n+                ctx = Context({'dt': dt, 'ICT': ICT})\n+                actual = tpl.render(ctx)\n+                expected = results[k1][k2]\n+                self.assertEqual(actual, expected, '%s / %s: %r != %r' % (k1, k2, actual, expected))\n+\n+        # Changes for USE_TZ = False\n+\n+        results['utc']['notag'] = t('utc', 'eat', 'utc', 'ict')\n+        results['ict']['notag'] = t('ict', 'eat', 'utc', 'ict')\n+\n+        with self.settings(USE_TZ=False):\n+            for k1, dt in datetimes.iteritems():\n+                for k2, tpl in templates.iteritems():\n+                    ctx = Context({'dt': dt, 'ICT': ICT})\n+                    actual = tpl.render(ctx)\n+                    expected = results[k1][k2]\n+                    self.assertEqual(actual, expected, '%s / %s: %r != %r' % (k1, k2, actual, expected))\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_localtime_filters_with_pytz(self):\n+        \"\"\"\n+        Test the |aslocaltime, |asutc, and |astimezone filters with pytz.\n+        \"\"\"\n+        # Use a pytz timezone as local time\n+        tpl = Template(\"{% load tz %}{{ dt|aslocaltime }}|{{ dt|asutc }}\")\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 12, 20, 30)})\n+\n+        timezone._localtime = None\n+        with self.settings(TIME_ZONE='Europe/Paris'):\n+            self.assertEqual(tpl.render(ctx), \"2011-09-01T12:20:30+02:00|2011-09-01T10:20:30+00:00\")\n+        timezone._localtime = None\n+\n+        # Use a pytz timezone as argument\n+        tpl = Template(\"{% load tz %}{{ dt|astimezone:tz }}\")\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30),\n+                       'tz': pytz.timezone('Europe/Paris')})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01T12:20:30+02:00\")\n+\n+        # Use a pytz timezone name as argument\n+        tpl = Template(\"{% load tz %}{{ dt|astimezone:'Europe/Paris' }}\")\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30),\n+                       'tz': pytz.timezone('Europe/Paris')})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01T12:20:30+02:00\")\n+\n+    def test_localtime_templatetag_invalid_argument(self):\n+        with self.assertRaises(TemplateSyntaxError):\n+            Template(\"{% load tz %}{% localtime foo %}{% endlocaltime %}\").render()\n+\n+    def test_localtime_filters_do_not_raise_exceptions(self):\n+        \"\"\"\n+        Test the |aslocaltime, |asutc, and |astimezone filters on bad inputs.\n+        \"\"\"\n+        tpl = Template(\"{% load tz %}{{ dt }}|{{ dt|aslocaltime }}|{{ dt|asutc }}|{{ dt|astimezone:tz }}\")\n+        with self.settings(USE_TZ=True):\n+            # bad datetime value\n+            ctx = Context({'dt': None, 'tz': ICT})\n+            self.assertEqual(tpl.render(ctx), \"None|||\")\n+            ctx = Context({'dt': 'not a date', 'tz': ICT})\n+            self.assertEqual(tpl.render(ctx), \"not a date|||\")\n+            # bad timezone value\n+            tpl = Template(\"{% load tz %}{{ dt|astimezone:tz }}\")\n+            ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30), 'tz': None})\n+            self.assertEqual(tpl.render(ctx), \"\")\n+            ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30), 'tz': 'not a tz'})\n+            self.assertEqual(tpl.render(ctx), \"\")\n+\n+    def test_timezone_templatetag(self):\n+        \"\"\"\n+        Test the {% timezone %} templatetag.\n+        \"\"\"\n+        tpl = Template(\"{% load tz %}\"\n+                \"{{ dt }}|\"\n+                \"{% timezone tz1 %}\"\n+                    \"{{ dt }}|\"\n+                    \"{% timezone tz2 %}\"\n+                        \"{{ dt }}\"\n+                    \"{% endtimezone %}\"\n+                \"{% endtimezone %}\")\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC),\n+                       'tz1': ICT, 'tz2': None})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01T13:20:30+03:00|2011-09-01T17:20:30+07:00|2011-09-01T13:20:30+03:00\")\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_timezone_templatetag_with_pytz(self):\n+        \"\"\"\n+        Test the {% timezone %} templatetag with pytz.\n+        \"\"\"\n+        tpl = Template(\"{% load tz %}{% timezone tz %}{{ dt }}{% endtimezone %}\")\n+\n+        # Use a pytz timezone as argument\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT),\n+                       'tz': pytz.timezone('Europe/Paris')})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01T12:20:30+02:00\")\n+\n+        # Use a pytz timezone name as argument\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 13, 20, 30, tzinfo=EAT),\n+                       'tz': 'Europe/Paris'})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01T12:20:30+02:00\")\n+\n+    def test_timezone_templatetag_invalid_argument(self):\n+        with self.assertRaises(TemplateSyntaxError):\n+            Template(\"{% load tz %}{% timezone %}{% endtimezone %}\").render()\n+        with self.assertRaises(ValueError if pytz is None else pytz.UnknownTimeZoneError):\n+            Template(\"{% load tz %}{% timezone tz %}{% endtimezone %}\").render(Context({'tz': 'foobar'}))\n+\n+    def test_get_current_timezone_templatetag(self):\n+        \"\"\"\n+        Test the {% get_current_timezone %} templatetag.\n+        \"\"\"\n+        tpl = Template(\"{% load tz %}{% get_current_timezone as time_zone %}{{ time_zone }}\")\n+\n+        self.assertEqual(tpl.render(Context()), \"Africa/Nairobi\" if pytz else \"EAT\")\n+        with timezone.override(UTC):\n+            self.assertEqual(tpl.render(Context()), \"UTC\")\n+\n+        tpl = Template(\"{% load tz %}{% timezone tz %}{% get_current_timezone as time_zone %}{% endtimezone %}{{ time_zone }}\")\n+\n+        self.assertEqual(tpl.render(Context({'tz': ICT})), \"+0700\")\n+        with timezone.override(UTC):\n+            self.assertEqual(tpl.render(Context({'tz': ICT})), \"+0700\")\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_get_current_timezone_templatetag_with_pytz(self):\n+        \"\"\"\n+        Test the {% get_current_timezone %} templatetag with pytz.\n+        \"\"\"\n+        tpl = Template(\"{% load tz %}{% get_current_timezone as time_zone %}{{ time_zone }}\")\n+        with timezone.override(pytz.timezone('Europe/Paris')):\n+            self.assertEqual(tpl.render(Context()), \"Europe/Paris\")\n+\n+        tpl = Template(\"{% load tz %}{% timezone 'Europe/Paris' %}{% get_current_timezone as time_zone %}{% endtimezone %}{{ time_zone }}\")\n+        self.assertEqual(tpl.render(Context()), \"Europe/Paris\")\n+\n+    def test_get_current_timezone_templatetag_invalid_argument(self):\n+        with self.assertRaises(TemplateSyntaxError):\n+            Template(\"{% load tz %}{% get_current_timezone %}\").render()\n+\n+    def test_tz_template_context_processor(self):\n+        \"\"\"\n+        Test the django.core.context_processors.tz template context processor.\n+        \"\"\"\n+        tpl = Template(\"{{ TIME_ZONE }}\")\n+        self.assertEqual(tpl.render(Context()), \"\")\n+        self.assertEqual(tpl.render(RequestContext(HttpRequest())), \"Africa/Nairobi\" if pytz else \"EAT\")\n+\n+    def test_date_and_time_template_filters(self):\n+        tpl = Template(\"{{ dt|date:'Y-m-d' }} at {{ dt|time:'H:i:s' }}\")\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 20, 20, 20, tzinfo=UTC)})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01 at 23:20:20\")\n+        with timezone.override(ICT):\n+            self.assertEqual(tpl.render(ctx), \"2011-09-02 at 03:20:20\")\n+\n+    def test_date_and_time_template_filters_honor_localtime(self):\n+        tpl = Template(\"{% load tz %}{% localtime off %}{{ dt|date:'Y-m-d' }} at {{ dt|time:'H:i:s' }}{% endlocaltime %}\")\n+        ctx = Context({'dt': datetime.datetime(2011, 9, 1, 20, 20, 20, tzinfo=UTC)})\n+        self.assertEqual(tpl.render(ctx), \"2011-09-01 at 20:20:20\")\n+        with timezone.override(ICT):\n+            self.assertEqual(tpl.render(ctx), \"2011-09-01 at 20:20:20\")\n+\n+TemplateTests = override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)(TemplateTests)\n+\n+#@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=False)\n+class LegacyFormsTests(BaseDateTimeTests):\n+\n+    def test_form(self):\n+        form = EventForm({'dt': u'2011-09-01 13:20:30'})\n+        self.assertTrue(form.is_valid())\n+        self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 9, 1, 13, 20, 30))\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_form_with_non_existent_time(self):\n+        form = EventForm({'dt': u'2011-03-27 02:30:00'})\n+        with timezone.override(pytz.timezone('Europe/Paris')):\n+            # this is obviously a bug\n+            self.assertTrue(form.is_valid())\n+            self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 3, 27, 2, 30, 0))\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_form_with_ambiguous_time(self):\n+        form = EventForm({'dt': u'2011-10-30 02:30:00'})\n+        with timezone.override(pytz.timezone('Europe/Paris')):\n+            # this is obviously a bug\n+            self.assertTrue(form.is_valid())\n+            self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 10, 30, 2, 30, 0))\n+\n+    def test_split_form(self):\n+        form = EventSplitForm({'dt_0': u'2011-09-01', 'dt_1': u'13:20:30'})\n+        self.assertTrue(form.is_valid())\n+        self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 9, 1, 13, 20, 30))\n+\n+    def test_model_form(self):\n+        EventModelForm({'dt': u'2011-09-01 13:20:30'}).save()\n+        e = Event.objects.get()\n+        self.assertEqual(e.dt, datetime.datetime(2011, 9, 1, 13, 20, 30))\n+\n+LegacyFormsTests = override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=False)(LegacyFormsTests)\n+\n+#@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n+class NewFormsTests(BaseDateTimeTests):\n+\n+    def test_form(self):\n+        form = EventForm({'dt': u'2011-09-01 13:20:30'})\n+        self.assertTrue(form.is_valid())\n+        self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+\n+    def test_form_with_other_timezone(self):\n+        form = EventForm({'dt': u'2011-09-01 17:20:30'})\n+        with timezone.override(ICT):\n+            self.assertTrue(form.is_valid())\n+            self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_form_with_non_existent_time(self):\n+        with timezone.override(pytz.timezone('Europe/Paris')):\n+            form = EventForm({'dt': u'2011-03-27 02:30:00'})\n+            self.assertFalse(form.is_valid())\n+            self.assertEqual(form.errors['dt'],\n+                [u\"2011-03-27 02:30:00 couldn't be interpreted in time zone \"\n+                 u\"Europe/Paris; it may be ambiguous or it may not exist.\"])\n+\n+    @skipIf(pytz is None, \"this test requires pytz\")\n+    def test_form_with_ambiguous_time(self):\n+        with timezone.override(pytz.timezone('Europe/Paris')):\n+            form = EventForm({'dt': u'2011-10-30 02:30:00'})\n+            self.assertFalse(form.is_valid())\n+            self.assertEqual(form.errors['dt'],\n+                [u\"2011-10-30 02:30:00 couldn't be interpreted in time zone \"\n+                 u\"Europe/Paris; it may be ambiguous or it may not exist.\"])\n+\n+    def test_split_form(self):\n+        form = EventSplitForm({'dt_0': u'2011-09-01', 'dt_1': u'13:20:30'})\n+        self.assertTrue(form.is_valid())\n+        self.assertEqual(form.cleaned_data['dt'], datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+\n+    def test_model_form(self):\n+        EventModelForm({'dt': u'2011-09-01 13:20:30'}).save()\n+        e = Event.objects.get()\n+        self.assertEqual(e.dt, datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+\n+NewFormsTests = override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)(NewFormsTests)\n+\n+#@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n+class AdminTests(BaseDateTimeTests):\n+\n+    urls = 'modeltests.timezones.urls'\n+    fixtures = ['users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def test_changelist(self):\n+        e = Event.objects.create(dt=datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+        response = self.client.get(reverse('admin:timezones_event_changelist'))\n+        self.assertContains(response, e.dt.astimezone(EAT).isoformat())\n+\n+    def test_changelist_in_other_timezone(self):\n+        e = Event.objects.create(dt=datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+        with timezone.override(ICT):\n+            response = self.client.get(reverse('admin:timezones_event_changelist'))\n+        self.assertContains(response, e.dt.astimezone(ICT).isoformat())\n+\n+    def test_change_editable(self):\n+        e = Event.objects.create(dt=datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+        response = self.client.get(reverse('admin:timezones_event_change', args=(e.pk,)))\n+        self.assertContains(response, e.dt.astimezone(EAT).date().isoformat())\n+        self.assertContains(response, e.dt.astimezone(EAT).time().isoformat())\n+\n+    def test_change_editable_in_other_timezone(self):\n+        e = Event.objects.create(dt=datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n+        with timezone.override(ICT):\n+            response = self.client.get(reverse('admin:timezones_event_change', args=(e.pk,)))\n+        self.assertContains(response, e.dt.astimezone(ICT).date().isoformat())\n+        self.assertContains(response, e.dt.astimezone(ICT).time().isoformat())\n+\n+    def test_change_readonly(self):\n+        Timestamp.objects.create()\n+        # re-fetch the object for backends that lose microseconds (MySQL)\n+        t = Timestamp.objects.get()\n+        response = self.client.get(reverse('admin:timezones_timestamp_change', args=(t.pk,)))\n+        self.assertContains(response, t.created.astimezone(EAT).isoformat())\n+\n+    def test_change_readonly_in_other_timezone(self):\n+        Timestamp.objects.create()\n+        # re-fetch the object for backends that lose microseconds (MySQL)\n+        t = Timestamp.objects.get()\n+        with timezone.override(ICT):\n+            response = self.client.get(reverse('admin:timezones_timestamp_change', args=(t.pk,)))\n+        self.assertContains(response, t.created.astimezone(ICT).isoformat())\n+\n+AdminTests = override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)(AdminTests)"
        },
        {
            "sha": "e4f42972dbc1c017a6845fe0b11283074717b059",
            "filename": "tests/modeltests/timezones/urls.py",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Ftimezones%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Furls.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,10 @@\n+from __future__ import absolute_import\n+\n+from django.conf.urls import patterns, include\n+from django.contrib import admin\n+\n+from . import admin as tz_admin\n+\n+urlpatterns = patterns('',\n+    (r'^admin/', include(admin.site.urls)),\n+)"
        },
        {
            "sha": "4a2ad1fffad3b28295e60db4f32540232e30c6dd",
            "filename": "tests/modeltests/validation/test_error_messages.py",
            "status": "modified",
            "additions": 35,
            "deletions": 8,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Fvalidation%2Ftest_error_messages.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fmodeltests%2Fvalidation%2Ftest_error_messages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidation%2Ftest_error_messages.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -104,16 +104,43 @@ def test_datetime_field_raises_error_message(self):\n             f.clean('foo', None)\n         except ValidationError, e:\n             self.assertEqual(e.messages, [\n-                u\"'foo' value either has an invalid valid format \"\n-                u\"(The format must be YYYY-MM-DD HH:MM[:ss[.uuuuuu]]) \"\n-                u\"or is an invalid date/time.\"])\n-        self.assertRaises(ValidationError, f.clean,\n-                          '2011-10-32 10:10', None)\n+                u\"'foo' value has an invalid format. It must be \"\n+                u\"in YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ] format.\"])\n+\n+        # Correct format but invalid date\n+        self.assertRaises(ValidationError, f.clean, '2011-10-32', None)\n+        try:\n+            f.clean('2011-10-32', None)\n+        except ValidationError, e:\n+            self.assertEqual(e.messages, [\n+                u\"'2011-10-32' value has the correct format \"\n+                u\"(YYYY-MM-DD) but it is an invalid date.\"])\n+\n         # Correct format but invalid date/time\n+        self.assertRaises(ValidationError, f.clean, '2011-10-32 10:10', None)\n         try:\n             f.clean('2011-10-32 10:10', None)\n         except ValidationError, e:\n             self.assertEqual(e.messages, [\n-                u\"'2011-10-32 10:10' value either has an invalid valid format \"\n-                u\"(The format must be YYYY-MM-DD HH:MM[:ss[.uuuuuu]]) \"\n-                u\"or is an invalid date/time.\"])\n\\ No newline at end of file\n+                u\"'2011-10-32 10:10' value has the correct format \"\n+                u\"(YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]) \"\n+                u\"but it is an invalid date/time.\"])\n+\n+    def test_time_field_raises_error_message(self):\n+        f = models.TimeField()\n+        # Wrong format\n+        self.assertRaises(ValidationError, f.clean, 'foo', None)\n+        try:\n+            f.clean('foo', None)\n+        except ValidationError, e:\n+            self.assertEqual(e.messages, [\n+                u\"'foo' value has an invalid format. It must be in \"\n+                u\"HH:MM[:ss[.uuuuuu]] format.\"])\n+        # Correct format but invalid time\n+        self.assertRaises(ValidationError, f.clean, '25:50', None)\n+        try:\n+            f.clean('25:50', None)\n+        except ValidationError, e:\n+            self.assertEqual(e.messages, [\n+                u\"'25:50' value has the correct format \"\n+                u\"(HH:MM[:ss[.uuuuuu]]) but it is an invalid time.\"])"
        },
        {
            "sha": "f1590d1121a65f7b4b386000054771f10224c0d1",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -24,7 +24,7 @@\n from django.test import TestCase, RequestFactory\n from django.test.utils import (get_warnings_state, restore_warnings_state,\n     override_settings)\n-from django.utils import translation, unittest\n+from django.utils import timezone, translation, unittest\n from django.utils.cache import (patch_vary_headers, get_cache_key,\n     learn_cache_key, patch_cache_control, patch_response_headers)\n from django.views.decorators.cache import cache_page\n@@ -1154,7 +1154,7 @@ def _get_request_cache(self, query_string=None):\n         request.session = {}\n         return request\n \n-    @override_settings(USE_I18N=True, USE_L10N=False)\n+    @override_settings(USE_I18N=True, USE_L10N=False, USE_TZ=False)\n     def test_cache_key_i18n_translation(self):\n         request = self._get_request()\n         lang = translation.get_language()\n@@ -1164,7 +1164,7 @@ def test_cache_key_i18n_translation(self):\n         key2 = get_cache_key(request)\n         self.assertEqual(key, key2)\n \n-    @override_settings(USE_I18N=False, USE_L10N=True)\n+    @override_settings(USE_I18N=False, USE_L10N=True, USE_TZ=False)\n     def test_cache_key_i18n_formatting(self):\n         request = self._get_request()\n         lang = translation.get_language()\n@@ -1174,13 +1174,25 @@ def test_cache_key_i18n_formatting(self):\n         key2 = get_cache_key(request)\n         self.assertEqual(key, key2)\n \n+    @override_settings(USE_I18N=False, USE_L10N=False, USE_TZ=True)\n+    def test_cache_key_i18n_timezone(self):\n+        request = self._get_request()\n+        tz = timezone.get_current_timezone_name()\n+        response = HttpResponse()\n+        key = learn_cache_key(request, response)\n+        self.assertIn(tz, key, \"Cache keys should include the time zone name when time zones are active\")\n+        key2 = get_cache_key(request)\n+        self.assertEqual(key, key2)\n+\n     @override_settings(USE_I18N=False, USE_L10N=False)\n     def test_cache_key_no_i18n (self):\n         request = self._get_request()\n         lang = translation.get_language()\n+        tz = timezone.get_current_timezone_name()\n         response = HttpResponse()\n         key = learn_cache_key(request, response)\n         self.assertNotIn(lang, key, \"Cache keys shouldn't include the language name when i18n isn't active\")\n+        self.assertNotIn(tz, key, \"Cache keys shouldn't include the time zone name when i18n isn't active\")\n \n     @override_settings(\n             CACHE_MIDDLEWARE_KEY_PREFIX=\"test\","
        },
        {
            "sha": "fb94e831ba02f5c6264ab3f3d6f5c22e6d71aadd",
            "filename": "tests/regressiontests/datatypes/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Fdatatypes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Fdatatypes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdatatypes%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -3,7 +3,7 @@\n import datetime\n \n from django.test import TestCase, skipIfDBFeature\n-from django.utils import tzinfo\n+from django.utils.timezone import utc\n \n from .models import Donut, RumBaba\n \n@@ -79,7 +79,7 @@ def test_textfields_unicode(self):\n     def test_error_on_timezone(self):\n         \"\"\"Regression test for #8354: the MySQL and Oracle backends should raise\n         an error if given a timezone-aware datetime object.\"\"\"\n-        dt = datetime.datetime(2008, 8, 31, 16, 20, tzinfo=tzinfo.FixedOffset(0))\n+        dt = datetime.datetime(2008, 8, 31, 16, 20, tzinfo=utc)\n         d = Donut(name='Bear claw', consumed_at=dt)\n         self.assertRaises(ValueError, d.save)\n         # ValueError: MySQL backend does not support timezone-aware datetimes."
        },
        {
            "sha": "6da4f75a67d08fc609f0d55712669f8b56f6f10f",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -421,7 +421,7 @@ def test_timesince(self):\n \n     def test_timeuntil(self):\n         self.assertEqual(\n-            timeuntil_filter(datetime.datetime.now() + datetime.timedelta(1)),\n+            timeuntil_filter(datetime.datetime.now() + datetime.timedelta(1, 1)),\n             u'1 day')\n \n         self.assertEqual("
        },
        {
            "sha": "313a76ba4b392f89b78e43608c73f3951cb32ad7",
            "filename": "tests/regressiontests/utils/dateformat.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Fdateformat.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Fdateformat.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fdateformat.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -4,6 +4,7 @@\n \n from django.utils.dateformat import format\n from django.utils import dateformat, translation, unittest\n+from django.utils.timezone import utc\n from django.utils.tzinfo import FixedOffset, LocalTimezone\n \n \n@@ -56,7 +57,6 @@ def test_datetime_with_tzinfo(self):\n         self.assertEqual(datetime.fromtimestamp(int(format(dt, 'U')), ltz).utctimetuple(), dt.utctimetuple())\n \n     def test_epoch(self):\n-        utc = FixedOffset(0)\n         udt = datetime(1970, 1, 1, tzinfo=utc)\n         self.assertEqual(format(udt, 'U'), u'0')\n "
        },
        {
            "sha": "b72a88b33d5b41e087c58474c64ec0df37bfeff1",
            "filename": "tests/regressiontests/utils/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftests.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -23,3 +23,4 @@\n from .baseconv import TestBaseConv\n from .jslex import JsTokensTest, JsToCForGettextTest\n from .ipv6 import TestUtilsIPv6\n+from .timezone import TimezoneTests"
        },
        {
            "sha": "b0f94d182b87142d662c5acac284574dab3bc210",
            "filename": "tests/regressiontests/utils/timesince.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftimesince.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftimesince.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftimesince.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -105,3 +105,12 @@ def test_both_date_objects(self):\n         self.assertEqual(timeuntil(today+self.oneday, today), u'1 day')\n         self.assertEqual(timeuntil(today-self.oneday, today), u'0 minutes')\n         self.assertEqual(timeuntil(today+self.oneweek, today), u'1 week')\n+\n+    def test_naive_datetime_with_tzinfo_attribute(self):\n+        class naive(datetime.tzinfo):\n+            def utcoffset(self, dt):\n+                return None\n+        future = datetime.datetime(2080, 1, 1, tzinfo=naive())\n+        self.assertEqual(timesince(future), u'0 minutes')\n+        past = datetime.datetime(1980, 1, 1, tzinfo=naive())\n+        self.assertEqual(timeuntil(past), u'0 minutes')"
        },
        {
            "sha": "870997db65a9a4d9ee76ae6434737a7661d6b33e",
            "filename": "tests/regressiontests/utils/timezone.py",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftimezone.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -0,0 +1,18 @@\n+import copy\n+import pickle\n+from django.utils.timezone import UTC, LocalTimezone\n+from django.utils import unittest\n+\n+class TimezoneTests(unittest.TestCase):\n+\n+    def test_copy(self):\n+        self.assertIsInstance(copy.copy(UTC()), UTC)\n+        self.assertIsInstance(copy.copy(LocalTimezone()), LocalTimezone)\n+\n+    def test_deepcopy(self):\n+        self.assertIsInstance(copy.deepcopy(UTC()), UTC)\n+        self.assertIsInstance(copy.deepcopy(LocalTimezone()), LocalTimezone)\n+\n+    def test_pickling_unpickling(self):\n+        self.assertIsInstance(pickle.loads(pickle.dumps(UTC())), UTC)\n+        self.assertIsInstance(pickle.loads(pickle.dumps(LocalTimezone())), LocalTimezone)"
        },
        {
            "sha": "cec92652cdc47404a8b49ca2f1fa7f209dad851f",
            "filename": "tests/regressiontests/utils/tzinfo.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftzinfo.py",
            "raw_url": "https://github.com/django/django/raw/9b1cb755a28f020e27d4268c214b25315d4de42e/tests%2Fregressiontests%2Futils%2Ftzinfo.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftzinfo.py?ref=9b1cb755a28f020e27d4268c214b25315d4de42e",
            "patch": "@@ -1,5 +1,7 @@\n+import copy\n import datetime\n import os\n+import pickle\n import time\n from django.utils.tzinfo import FixedOffset, LocalTimezone\n from django.utils import unittest\n@@ -60,3 +62,18 @@ def test_16899(self):\n         self.assertEqual(\n                 repr(datetime.datetime.fromtimestamp(ts + 3600, tz)),\n                 'datetime.datetime(2010, 11, 7, 1, 0, tzinfo=EST)')\n+\n+    def test_copy(self):\n+        now = datetime.datetime.now()\n+        self.assertIsInstance(copy.copy(FixedOffset(90)), FixedOffset)\n+        self.assertIsInstance(copy.copy(LocalTimezone(now)), LocalTimezone)\n+\n+    def test_deepcopy(self):\n+        now = datetime.datetime.now()\n+        self.assertIsInstance(copy.deepcopy(FixedOffset(90)), FixedOffset)\n+        self.assertIsInstance(copy.deepcopy(LocalTimezone(now)), LocalTimezone)\n+\n+    def test_pickling_unpickling(self):\n+        now = datetime.datetime.now()\n+        self.assertIsInstance(pickle.loads(pickle.dumps(FixedOffset(90))), FixedOffset)\n+        self.assertIsInstance(pickle.loads(pickle.dumps(LocalTimezone(now))), LocalTimezone)"
        }
    ],
    "stats": {
        "total": 3002,
        "additions": 2719,
        "deletions": 283
    }
}