{
    "author": "claudep",
    "message": "Fixed #19387 -- Preserved SafeData status in contrib.messages\n\nThanks Anton Baklanov for the report and the patch.",
    "sha": "e277301c2c96915ba1408d57a866bc65e51de95a",
    "files": [
        {
            "sha": "619c69249e3062ef96fd04e051d63528369b7109",
            "filename": "django/contrib/messages/storage/cookie.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/e277301c2c96915ba1408d57a866bc65e51de95a/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py",
            "raw_url": "https://github.com/django/django/raw/e277301c2c96915ba1408d57a866bc65e51de95a/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py?ref=e277301c2c96915ba1408d57a866bc65e51de95a",
            "patch": "@@ -4,6 +4,7 @@\n from django.contrib.messages.storage.base import BaseStorage, Message\n from django.http import SimpleCookie\n from django.utils.crypto import salted_hmac, constant_time_compare\n+from django.utils.safestring import SafeData, mark_safe\n from django.utils import six\n \n \n@@ -15,7 +16,9 @@ class MessageEncoder(json.JSONEncoder):\n \n     def default(self, obj):\n         if isinstance(obj, Message):\n-            message = [self.message_key, obj.level, obj.message]\n+            # Using 0/1 here instead of False/True to produce more compact json\n+            is_safedata = 1 if isinstance(obj.message, SafeData) else 0\n+            message = [self.message_key, is_safedata, obj.level, obj.message]\n             if obj.extra_tags:\n                 message.append(obj.extra_tags)\n             return message\n@@ -30,7 +33,9 @@ class MessageDecoder(json.JSONDecoder):\n     def process_messages(self, obj):\n         if isinstance(obj, list) and obj:\n             if obj[0] == MessageEncoder.message_key:\n-                return Message(*obj[1:])\n+                if obj[1]:\n+                    obj[3] = mark_safe(obj[3])\n+                return Message(*obj[2:])\n             return [self.process_messages(item) for item in obj]\n         if isinstance(obj, dict):\n             return dict([(key, self.process_messages(value))"
        },
        {
            "sha": "77e4ece091089614df1fe92c9de7012a6dd53d0b",
            "filename": "django/contrib/messages/tests/cookie.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/e277301c2c96915ba1408d57a866bc65e51de95a/django%2Fcontrib%2Fmessages%2Ftests%2Fcookie.py",
            "raw_url": "https://github.com/django/django/raw/e277301c2c96915ba1408d57a866bc65e51de95a/django%2Fcontrib%2Fmessages%2Ftests%2Fcookie.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fcookie.py?ref=e277301c2c96915ba1408d57a866bc65e51de95a",
            "patch": "@@ -6,6 +6,7 @@\n     MessageEncoder, MessageDecoder)\n from django.contrib.messages.storage.base import Message\n from django.test.utils import override_settings\n+from django.utils.safestring import SafeData, mark_safe\n \n \n def set_cookie_data(storage, messages, invalid=False, encode_empty=False):\n@@ -132,3 +133,21 @@ def test_json_encoder_decoder(self):\n         value = encoder.encode(messages)\n         decoded_messages = json.loads(value, cls=MessageDecoder)\n         self.assertEqual(messages, decoded_messages)\n+\n+    def test_safedata(self):\n+        \"\"\"\n+        Tests that a message containing SafeData is keeping its safe status when\n+        retrieved from the message storage.\n+        \"\"\"\n+        def encode_decode(data):\n+            message = Message(constants.DEBUG, data)\n+            encoded = storage._encode(message)\n+            decoded = storage._decode(encoded)\n+            return decoded.message\n+\n+        storage = self.get_storage()\n+\n+        self.assertIsInstance(\n+            encode_decode(mark_safe(\"<b>Hello Django!</b>\")), SafeData)\n+        self.assertNotIsInstance(\n+            encode_decode(\"<b>Hello Django!</b>\"), SafeData)"
        },
        {
            "sha": "e162f49fc28ae358fd4651077703faafc5ef4610",
            "filename": "django/contrib/messages/tests/session.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/e277301c2c96915ba1408d57a866bc65e51de95a/django%2Fcontrib%2Fmessages%2Ftests%2Fsession.py",
            "raw_url": "https://github.com/django/django/raw/e277301c2c96915ba1408d57a866bc65e51de95a/django%2Fcontrib%2Fmessages%2Ftests%2Fsession.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fsession.py?ref=e277301c2c96915ba1408d57a866bc65e51de95a",
            "patch": "@@ -1,5 +1,8 @@\n+from django.contrib.messages import constants\n from django.contrib.messages.tests.base import BaseTest\n+from django.contrib.messages.storage.base import Message\n from django.contrib.messages.storage.session import SessionStorage\n+from django.utils.safestring import SafeData, mark_safe\n \n \n def set_session_data(storage, messages):\n@@ -36,3 +39,14 @@ def test_get(self):\n         set_session_data(storage, example_messages)\n         # Test that the message actually contains what we expect.\n         self.assertEqual(list(storage), example_messages)\n+\n+    def test_safedata(self):\n+        \"\"\"\n+        Tests that a message containing SafeData is keeping its safe status when\n+        retrieved from the message storage.\n+        \"\"\"\n+        storage = self.get_storage()\n+\n+        message = Message(constants.DEBUG, mark_safe(\"<b>Hello Django!</b>\"))\n+        set_session_data(storage, [message])\n+        self.assertIsInstance(list(storage)[0].message, SafeData)"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 40,
        "deletions": 2
    }
}