{
    "author": "carljm",
    "message": "Fixed #14234 -- Re-validating a model instance added via ModelForm no longer throws spurious PK uniqueness errors. Thanks to David Reynolds and Jeremy Dunck.\n\nAlso moved Model._adding to Model._state.adding to reduce instance namespace footprint.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14612 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "38ba3775ec86718fabdf0ba1d5baf04a0f2164a7",
    "files": [
        {
            "sha": "44f90a19f77214d253384a419befdbc6d09538dc",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=38ba3775ec86718fabdf0ba1d5baf04a0f2164a7",
            "patch": "@@ -262,6 +262,10 @@ class ModelState(object):\n     \"\"\"\n     def __init__(self, db=None):\n         self.db = db\n+        # If true, uniqueness validation checks will consider this a new, as-yet-unsaved object.\n+        # Necessary for correct validation of new instances of objects with explicit (non-auto) PKs.\n+        # This impacts validation only; it has no effect on the actual save.\n+        self.adding = False\n \n class Model(object):\n     __metaclass__ = ModelBase\n@@ -555,12 +559,15 @@ def save_base(self, raw=False, cls=None, origin=None, force_insert=False,\n \n         # Store the database on which the object was saved\n         self._state.db = using\n+        # Once saved, this is no longer a to-be-added instance.\n+        self._state.adding = False\n \n         # Signal that the save is complete\n         if origin and not meta.auto_created:\n             signals.post_save.send(sender=origin, instance=self,\n                 created=(not record_exists), raw=raw, using=using)\n \n+\n     save_base.alters_data = True\n \n     def delete(self, using=None):\n@@ -701,7 +708,7 @@ def _perform_unique_checks(self, unique_checks):\n                 if lookup_value is None:\n                     # no value, skip the lookup\n                     continue\n-                if f.primary_key and not getattr(self, '_adding', False):\n+                if f.primary_key and not self._state.adding:\n                     # no need to check for unique primary key when editing\n                     continue\n                 lookup_kwargs[str(field_name)] = lookup_value\n@@ -714,7 +721,7 @@ def _perform_unique_checks(self, unique_checks):\n \n             # Exclude the current object from the query if we are editing an\n             # instance (as opposed to creating a new one)\n-            if not getattr(self, '_adding', False) and self.pk is not None:\n+            if not self._state.adding and self.pk is not None:\n                 qs = qs.exclude(pk=self.pk)\n \n             if qs.exists():\n@@ -744,7 +751,7 @@ def _perform_date_checks(self, date_checks):\n             qs = model_class._default_manager.filter(**lookup_kwargs)\n             # Exclude the current object from the query if we are editing an\n             # instance (as opposed to creating a new one)\n-            if not getattr(self, '_adding', False) and self.pk is not None:\n+            if not self._state.adding and self.pk is not None:\n                 qs = qs.exclude(pk=self.pk)\n \n             if qs.exists():"
        },
        {
            "sha": "729f52310353e9cd036a2a6f170f71401d5667e7",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=38ba3775ec86718fabdf0ba1d5baf04a0f2164a7",
            "patch": "@@ -254,10 +254,10 @@ def __init__(self, data=None, files=None, auto_id='id_%s', prefix=None,\n             # if we didn't get an instance, instantiate a new one\n             self.instance = opts.model()\n             object_data = {}\n-            self.instance._adding = True\n+            self.instance._state.adding = True\n         else:\n             self.instance = instance\n-            self.instance._adding = False\n+            self.instance._state.adding = False\n             object_data = model_to_dict(instance, opts.fields, opts.exclude)\n         # if initial was provided, it should override the values from instance\n         if initial is not None:"
        },
        {
            "sha": "203980c11c84c74245d1d435149a189b910338ed",
            "filename": "tests/regressiontests/forms/models.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/tests%2Fregressiontests%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/tests%2Fregressiontests%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Fmodels.py?ref=38ba3775ec86718fabdf0ba1d5baf04a0f2164a7",
            "patch": "@@ -5,28 +5,34 @@\n from django.db import models\n from django.core.files.storage import FileSystemStorage\n \n+\n temp_storage_location = tempfile.mkdtemp()\n temp_storage = FileSystemStorage(location=temp_storage_location)\n \n+\n class BoundaryModel(models.Model):\n     positive_integer = models.PositiveIntegerField(null=True, blank=True)\n \n+\n callable_default_value = 0\n def callable_default():\n     global callable_default_value\n     callable_default_value = callable_default_value + 1\n     return callable_default_value\n \n+\n class Defaults(models.Model):\n     name = models.CharField(max_length=255, default='class default value')\n     def_date = models.DateField(default = datetime.date(1980, 1, 1))\n     value = models.IntegerField(default=42)\n     callable_default = models.IntegerField(default=callable_default)\n \n+\n class ChoiceModel(models.Model):\n     \"\"\"For ModelChoiceField and ModelMultipleChoiceField tests.\"\"\"\n     name = models.CharField(max_length=10)\n \n+\n class ChoiceOptionModel(models.Model):\n     \"\"\"Destination for ChoiceFieldModel's ForeignKey.\n     Can't reuse ChoiceModel because error_message tests require that it have no instances.\"\"\"\n@@ -38,6 +44,7 @@ class Meta:\n     def __unicode__(self):\n         return u'ChoiceOption %d' % self.pk\n \n+\n class ChoiceFieldModel(models.Model):\n     \"\"\"Model with ForeignKey to another model, for testing ModelForm\n     generation with ModelChoiceField.\"\"\"\n@@ -51,11 +58,17 @@ class ChoiceFieldModel(models.Model):\n     multi_choice_int = models.ManyToManyField(ChoiceOptionModel, blank=False, related_name='multi_choice_int',\n                                               default=lambda: [1])\n \n+\n class FileModel(models.Model):\n     file = models.FileField(storage=temp_storage, upload_to='tests')\n \n+\n class Group(models.Model):\n     name = models.CharField(max_length=10)\n \n     def __unicode__(self):\n         return u'%s' % self.name\n+\n+\n+class Cheese(models.Model):\n+   name = models.CharField(max_length=100)"
        },
        {
            "sha": "6c6a308db564d5a7ff31ced7427cb8656494c7c4",
            "filename": "tests/regressiontests/forms/tests/regressions.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/tests%2Fregressiontests%2Fforms%2Ftests%2Fregressions.py",
            "raw_url": "https://github.com/django/django/raw/38ba3775ec86718fabdf0ba1d5baf04a0f2164a7/tests%2Fregressiontests%2Fforms%2Ftests%2Fregressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fregressions.py?ref=38ba3775ec86718fabdf0ba1d5baf04a0f2164a7",
            "patch": "@@ -3,6 +3,9 @@\n from django.utils.unittest import TestCase\n from django.utils.translation import ugettext_lazy, activate, deactivate\n \n+from regressiontests.forms.models import Cheese\n+\n+\n class FormsRegressionsTestCase(TestCase):\n     def test_class(self):\n         # Tests to prevent against recurrences of earlier bugs.\n@@ -120,3 +123,21 @@ class SomeForm(Form):\n \n         f = SomeForm({'field': ['<script>']})\n         self.assertEqual(t.render(Context({'form': f})), u'<ul class=\"errorlist\"><li>field<ul class=\"errorlist\"><li>&quot;&lt;script&gt;&quot; is not a valid value for a primary key.</li></ul></li></ul>')\n+\n+    def test_regression_14234(self):\n+        \"\"\"\n+        Re-cleaning an instance that was added via a ModelForm should not raise\n+        a pk uniqueness error.\n+\n+        \"\"\"\n+        class CheeseForm(ModelForm):\n+            class Meta:\n+                model = Cheese\n+\n+        form = CheeseForm({\n+            'name': 'Brie',\n+        })\n+        if form.is_valid():\n+            obj = form.save()\n+            obj.name = 'Camembert'\n+            obj.full_clean()"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 46,
        "deletions": 5
    }
}