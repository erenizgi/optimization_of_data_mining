{
    "author": "jphalip",
    "message": "Fixed #16736 -- Enabled the merging of user-supplied arguments to format the error emails' subject in `AdminEmailHandler`.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16715 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b",
    "files": [
        {
            "sha": "a8098fcd2aac507e50813738333f132bc4dfe294",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b",
            "patch": "@@ -31,15 +31,16 @@ def emit(self, record):\n     logger.addHandler(NullHandler())\n \n class AdminEmailHandler(logging.Handler):\n-    def __init__(self, include_html=False):\n-        logging.Handler.__init__(self)\n-        self.include_html = include_html\n-\n     \"\"\"An exception log handler that emails log entries to site admins.\n \n     If the request is passed as the first argument to the log record,\n     request data will be provided in the email report.\n     \"\"\"\n+\n+    def __init__(self, include_html=False):\n+        logging.Handler.__init__(self)\n+        self.include_html = include_html\n+\n     def emit(self, record):\n         try:\n             request = record.request\n@@ -53,7 +54,7 @@ def emit(self, record):\n         except:\n             subject = '%s: %s' % (\n                 record.levelname,\n-                record.msg\n+                record.getMessage()\n             )\n             request = None\n             request_repr = \"Request repr() unavailable.\"\n@@ -62,7 +63,7 @@ def emit(self, record):\n             exc_info = record.exc_info\n             stack_trace = '\\n'.join(traceback.format_exception(*record.exc_info))\n         else:\n-            exc_info = (None, record.msg, None)\n+            exc_info = (None, record.getMessage(), None)\n             stack_trace = 'No stack trace available'\n \n         message = \"%s\\n\\n%s\" % (stack_trace, request_repr)"
        },
        {
            "sha": "76c5185e66533264c93c839d5919e3d9e638814e",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 44,
            "deletions": 1,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=de35a3ab14ca2fb88b4524c8ea0ebaa9e28eb85b",
            "patch": "@@ -4,7 +4,10 @@\n \n from django.conf import compat_patch_logging_config\n from django.test import TestCase\n-from django.utils.log import CallbackFilter\n+from django.test.utils import override_settings\n+from django.utils.log import CallbackFilter, getLogger\n+from django.core import mail\n+\n \n \n # logging config prior to using filter with mail_admins\n@@ -115,3 +118,43 @@ def _callback(record):\n         f.filter(\"a record\")\n \n         self.assertEqual(collector, [\"a record\"])\n+\n+\n+class AdminEmailHandlerTest(TestCase):\n+\n+    @override_settings(\n+            ADMINS=(('whatever admin', 'admin@example.com'),),\n+            EMAIL_SUBJECT_PREFIX='-SuperAwesomeSubject-'\n+        )\n+    def test_accepts_args(self):\n+        \"\"\"\n+        Ensure that user-supplied arguments and the EMAIL_SUBJECT_PREFIX\n+        setting are used to compose the email subject.\n+        Refs #16736.\n+        \"\"\"\n+\n+        message = \"Custom message that says '%s' and '%s'\"\n+        token1 = 'ping'\n+        token2 = 'pong'\n+\n+        logger = getLogger('django.request')\n+        # Inspired from regressiontests/views/views.py: send_log()\n+        # ensuring the AdminEmailHandler does not get filtered out\n+        # even with DEBUG=True.\n+        admin_email_handler = [\n+            h for h in logger.handlers\n+            if h.__class__.__name__ == \"AdminEmailHandler\"\n+            ][0]\n+        # Backup then override original filters\n+        orig_filters = admin_email_handler.filters\n+        admin_email_handler.filters = []\n+\n+        logger.error(message, token1, token2)\n+\n+        self.assertEqual(len(mail.outbox), 1)\n+        self.assertEqual(mail.outbox[0].to, ['admin@example.com'])\n+        self.assertEqual(mail.outbox[0].subject,\n+                         \"-SuperAwesomeSubject-ERROR: Custom message that says 'ping' and 'pong'\")\n+\n+        # Restore original filters\n+        admin_email_handler.filters = orig_filters"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 51,
        "deletions": 7
    }
}