{
    "author": "aaugustin",
    "message": "Factored out common code in database backends.",
    "sha": "29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0",
    "files": [
        {
            "sha": "7a0a577ef13f9aff344dccf43ee1c2284a06e844",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0",
            "patch": "@@ -11,6 +11,7 @@\n \n from django.conf import settings\n from django.db import DEFAULT_DB_ALIAS\n+from django.db.backends.signals import connection_created\n from django.db.backends import util\n from django.db.transaction import TransactionManagementError\n from django.utils.functional import cached_property\n@@ -52,6 +53,17 @@ def __ne__(self, other):\n \n     __hash__ = object.__hash__\n \n+    def _valid_connection(self):\n+        return self.connection is not None\n+\n+    def _cursor(self):\n+        if not self._valid_connection():\n+            conn_params = self.get_connection_params()\n+            self.connection = self.get_new_connection(conn_params)\n+            self.init_connection_state()\n+            connection_created.send(sender=self.__class__, connection=self)\n+        return self.create_cursor()\n+\n     def _commit(self):\n         if self.connection is not None:\n             return self.connection.commit()"
        },
        {
            "sha": "eb823083f449395b509e19b244b972f85280e256",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0",
            "patch": "@@ -33,19 +33,16 @@\n from django.conf import settings\n from django.db import utils\n from django.db.backends import *\n-from django.db.backends.signals import connection_created\n from django.db.backends.mysql.client import DatabaseClient\n from django.db.backends.mysql.creation import DatabaseCreation\n from django.db.backends.mysql.introspection import DatabaseIntrospection\n from django.db.backends.mysql.validation import DatabaseValidation\n from django.utils.encoding import force_str\n-from django.utils.functional import cached_property\n from django.utils.safestring import SafeBytes, SafeText\n from django.utils import six\n from django.utils import timezone\n \n # Raise exceptions for database warnings if DEBUG is on\n-from django.conf import settings\n if settings.DEBUG:\n     warnings.filterwarnings(\"error\", category=Database.Warning)\n \n@@ -454,12 +451,7 @@ def init_connection_state(self):\n         cursor.execute('SET SQL_AUTO_IS_NULL = 0')\n         cursor.close()\n \n-    def _cursor(self):\n-        if not self._valid_connection():\n-            conn_params = self.get_connection_params()\n-            self.connection = self.get_new_connection(conn_params)\n-            self.init_connection_state()\n-            connection_created.send(sender=self.__class__, connection=self)\n+    def create_cursor(self):\n         cursor = self.connection.cursor()\n         return CursorWrapper(cursor)\n "
        },
        {
            "sha": "e329ef3191557a0cc2233ff4304892b7a860284b",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 16,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0",
            "patch": "@@ -48,7 +48,6 @@ def _setup_environment(environ):\n from django.conf import settings\n from django.db import utils\n from django.db.backends import *\n-from django.db.backends.signals import connection_created\n from django.db.backends.oracle.client import DatabaseClient\n from django.db.backends.oracle.creation import DatabaseCreation\n from django.db.backends.oracle.introspection import DatabaseIntrospection\n@@ -521,9 +520,6 @@ def check_constraints(self, table_names=None):\n         self.cursor().execute('SET CONSTRAINTS ALL IMMEDIATE')\n         self.cursor().execute('SET CONSTRAINTS ALL DEFERRED')\n \n-    def _valid_connection(self):\n-        return self.connection is not None\n-\n     def _connect_string(self):\n         settings_dict = self.settings_dict\n         if not settings_dict['HOST'].strip():\n@@ -537,8 +533,8 @@ def _connect_string(self):\n         return \"%s/%s@%s\" % (settings_dict['USER'],\n                              settings_dict['PASSWORD'], dsn)\n \n-    def create_cursor(self, conn):\n-        return FormatStylePlaceholderCursor(conn)\n+    def create_cursor(self):\n+        return FormatStylePlaceholderCursor(self.connection)\n \n     def get_connection_params(self):\n         conn_params = self.settings_dict['OPTIONS'].copy()\n@@ -551,7 +547,7 @@ def get_new_connection(self, conn_params):\n         return Database.connect(conn_string, **conn_params)\n \n     def init_connection_state(self):\n-        cursor = self.create_cursor(self.connection)\n+        cursor = self.create_cursor()\n         # Set the territory first. The territory overrides NLS_DATE_FORMAT\n         # and NLS_TIMESTAMP_FORMAT to the territory default. When all of\n         # these are set in single statement it isn't clear what is supposed\n@@ -572,7 +568,7 @@ def init_connection_state(self):\n             # This check is performed only once per DatabaseWrapper\n             # instance per thread, since subsequent connections will use\n             # the same settings.\n-            cursor = self.create_cursor(self.connection)\n+            cursor = self.create_cursor()\n             try:\n                 cursor.execute(\"SELECT 1 FROM DUAL WHERE DUMMY %s\"\n                                % self._standard_operators['contains'],\n@@ -602,14 +598,6 @@ def init_connection_state(self):\n             # stmtcachesize is available only in 4.3.2 and up.\n             pass\n \n-    def _cursor(self):\n-        if not self._valid_connection():\n-            conn_params = self.get_connection_params()\n-            self.connection = self.get_new_connection(conn_params)\n-            self.init_connection_state()\n-            connection_created.send(sender=self.__class__, connection=self)\n-        return self.create_cursor(self.connection)\n-\n     # Oracle doesn't support savepoint commits.  Ignore them.\n     def _savepoint_commit(self, sid):\n         pass"
        },
        {
            "sha": "fb1ad5f991e5c8ac8622ec13b847dcd0d25c297f",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0",
            "patch": "@@ -8,7 +8,6 @@\n \n from django.db import utils\n from django.db.backends import *\n-from django.db.backends.signals import connection_created\n from django.db.backends.postgresql_psycopg2.operations import DatabaseOperations\n from django.db.backends.postgresql_psycopg2.client import DatabaseClient\n from django.db.backends.postgresql_psycopg2.creation import DatabaseCreation\n@@ -205,12 +204,7 @@ def init_connection_state(self):\n         self.connection.set_isolation_level(self.isolation_level)\n         self._get_pg_version()\n \n-    def _cursor(self):\n-        if self.connection is None:\n-            conn_params = self.get_connection_params()\n-            self.connection = self.get_new_connection(conn_params)\n-            self.init_connection_state()\n-            connection_created.send(sender=self.__class__, connection=self)\n+    def create_cursor(self):\n         cursor = self.connection.cursor()\n         cursor.tzinfo_factory = utc_tzinfo_factory if settings.USE_TZ else None\n         return CursorWrapper(cursor)"
        },
        {
            "sha": "7ddaaf8fe3cf94464ed1191075ab5cacbd4dfdab",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=29628e0b6e5b1c6324e0c06cc56a49a5aa0747e0",
            "patch": "@@ -14,7 +14,6 @@\n \n from django.db import utils\n from django.db.backends import *\n-from django.db.backends.signals import connection_created\n from django.db.backends.sqlite3.client import DatabaseClient\n from django.db.backends.sqlite3.creation import DatabaseCreation\n from django.db.backends.sqlite3.introspection import DatabaseIntrospection\n@@ -344,13 +343,7 @@ def get_new_connection(self, conn_params):\n     def init_connection_state(self):\n         pass\n \n-    def _cursor(self):\n-        if self.connection is None:\n-            conn_params = self.get_connection_params()\n-            self.connection = self.get_new_connection(conn_params)\n-            self.init_connection_state()\n-            connection_created.send(sender=self.__class__, connection=self)\n-\n+    def create_cursor(self):\n         return self.connection.cursor(factory=SQLiteCursorWrapper)\n \n     def check_constraints(self, table_names=None):"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 19,
        "deletions": 40
    }
}