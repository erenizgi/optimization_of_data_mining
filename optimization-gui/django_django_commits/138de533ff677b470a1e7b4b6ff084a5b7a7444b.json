{
    "author": "mvantellingen",
    "message": "Fixed #19819 - Improved template filter errors handling.\n\nWrap the Parser.compile_filter method call with a try/except and call the\nnewly added Parser.compile_filter_error(). Overwrite this method in the\nDebugParser to throw the correct error.\n\nSince this error was otherwise catched by the compile_function try/except\nblock the debugger highlighted the wrong line.",
    "sha": "138de533ff677b470a1e7b4b6ff084a5b7a7444b",
    "files": [
        {
            "sha": "9577d586d806517307ed7aa2cb2b39204516f0ff",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/138de533ff677b470a1e7b4b6ff084a5b7a7444b/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/138de533ff677b470a1e7b4b6ff084a5b7a7444b/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=138de533ff677b470a1e7b4b6ff084a5b7a7444b",
            "patch": "@@ -250,7 +250,11 @@ def parse(self, parse_until=None):\n             elif token.token_type == 1: # TOKEN_VAR\n                 if not token.contents:\n                     self.empty_variable(token)\n-                filter_expression = self.compile_filter(token.contents)\n+                try:\n+                    filter_expression = self.compile_filter(token.contents)\n+                except TemplateSyntaxError as e:\n+                    if not self.compile_filter_error(token, e):\n+                        raise\n                 var_node = self.create_variable_node(filter_expression)\n                 self.extend_nodelist(nodelist, var_node, token)\n             elif token.token_type == 2: # TOKEN_BLOCK\n@@ -330,6 +334,9 @@ def invalid_block_tag(self, token, command, parse_until=None):\n     def unclosed_block_tag(self, parse_until):\n         raise self.error(None, \"Unclosed tags: %s \" % ', '.join(parse_until))\n \n+    def compile_filter_error(self, token, e):\n+        pass\n+\n     def compile_function_error(self, token, e):\n         pass\n "
        },
        {
            "sha": "043dd91b4ed63208aa3def64ac66fbd89204f413",
            "filename": "django/template/debug.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/138de533ff677b470a1e7b4b6ff084a5b7a7444b/django%2Ftemplate%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/138de533ff677b470a1e7b4b6ff084a5b7a7444b/django%2Ftemplate%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdebug.py?ref=138de533ff677b470a1e7b4b6ff084a5b7a7444b",
            "patch": "@@ -64,6 +64,10 @@ def unclosed_block_tag(self, parse_until):\n         msg = \"Unclosed tag '%s'. Looking for one of: %s \" % (command, ', '.join(parse_until))\n         raise self.source_error(source, msg)\n \n+    def compile_filter_error(self, token, e):\n+        if not hasattr(e, 'django_template_source'):\n+            e.django_template_source = token.source\n+\n     def compile_function_error(self, token, e):\n         if not hasattr(e, 'django_template_source'):\n             e.django_template_source = token.source"
        },
        {
            "sha": "9422da80d7abb7fe21da6b283ea1987002405671",
            "filename": "tests/regressiontests/templates/parser.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/138de533ff677b470a1e7b4b6ff084a5b7a7444b/tests%2Fregressiontests%2Ftemplates%2Fparser.py",
            "raw_url": "https://github.com/django/django/raw/138de533ff677b470a1e7b4b6ff084a5b7a7444b/tests%2Fregressiontests%2Ftemplates%2Fparser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fparser.py?ref=138de533ff677b470a1e7b4b6ff084a5b7a7444b",
            "patch": "@@ -4,8 +4,10 @@\n from __future__ import unicode_literals\n \n from django.template import (TokenParser, FilterExpression, Parser, Variable,\n-    TemplateSyntaxError)\n+    Template, TemplateSyntaxError)\n+from django.test.utils import override_settings\n from django.utils.unittest import TestCase\n+from django.utils import six\n \n \n class ParserTests(TestCase):\n@@ -83,3 +85,11 @@ def test_variable_parsing(self):\n         self.assertRaises(TemplateSyntaxError,\n             Variable, \"article._hidden\"\n         )\n+\n+    @override_settings(DEBUG=True, TEMPLATE_DEBUG=True)\n+    def test_compile_filter_error(self):\n+        # regression test for #19819\n+        msg = \"Could not parse the remainder: '@bar' from 'foo@bar'\"\n+        with six.assertRaisesRegex(self, TemplateSyntaxError, msg) as cm:\n+            Template(\"{% if 1 %}{{ foo@bar }}{% endif %}\")\n+        self.assertEqual(cm.exception.django_template_source[1], (10, 23))"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 23,
        "deletions": 2
    }
}