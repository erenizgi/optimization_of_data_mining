{
    "author": "adrianholovaty",
    "message": "Fixed #16818 -- Fixed ORM bug with many-to-many add() method where it wasn't committing the change. Thanks, pressureman and kmtracey\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17189 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "073d987a84d7ebdf3b70789f22b8a12a9f5ae96f",
    "files": [
        {
            "sha": "c752049dcc748f782a4a97f1f126739a8a7f6ece",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 22,
            "deletions": 11,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/073d987a84d7ebdf3b70789f22b8a12a9f5ae96f/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/073d987a84d7ebdf3b70789f22b8a12a9f5ae96f/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=073d987a84d7ebdf3b70789f22b8a12a9f5ae96f",
            "patch": "@@ -396,18 +396,29 @@ def bulk_create(self, objs):\n         self._for_write = True\n         connection = connections[self.db]\n         fields = self.model._meta.local_fields\n-        if (connection.features.can_combine_inserts_with_and_without_auto_increment_pk\n-            and self.model._meta.has_auto_field):\n-            self.model._base_manager._insert(objs, fields=fields, using=self.db)\n+        if not transaction.is_managed(using=self.db):\n+            transaction.enter_transaction_management(using=self.db)\n+            forced_managed = True\n         else:\n-            objs_with_pk, objs_without_pk = partition(\n-                lambda o: o.pk is None,\n-                objs\n-            )\n-            if objs_with_pk:\n-                self.model._base_manager._insert(objs_with_pk, fields=fields, using=self.db)\n-            if objs_without_pk:\n-                self.model._base_manager._insert(objs_without_pk, fields=[f for f in fields if not isinstance(f, AutoField)], using=self.db)\n+            forced_managed = False\n+        try:\n+            if (connection.features.can_combine_inserts_with_and_without_auto_increment_pk\n+                and self.model._meta.has_auto_field):\n+                self.model._base_manager._insert(objs, fields=fields, using=self.db)\n+            else:\n+                objs_with_pk, objs_without_pk = partition(lambda o: o.pk is None, objs)\n+                if objs_with_pk:\n+                    self.model._base_manager._insert(objs_with_pk, fields=fields, using=self.db)\n+                if objs_without_pk:\n+                    self.model._base_manager._insert(objs_without_pk, fields=[f for f in fields if not isinstance(f, AutoField)], using=self.db)\n+            if forced_managed:\n+                transaction.commit(using=self.db)\n+            else:\n+                transaction.commit_unless_managed(using=self.db)\n+        finally:\n+            if forced_managed:\n+                transaction.leave_transaction_management(using=self.db)\n+\n         return objs\n \n     def get_or_create(self, **kwargs):"
        },
        {
            "sha": "e8bca8ada2473723982f3e2e9da3db2bc67d9ec4",
            "filename": "tests/regressiontests/transactions_regress/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/073d987a84d7ebdf3b70789f22b8a12a9f5ae96f/tests%2Fregressiontests%2Ftransactions_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/073d987a84d7ebdf3b70789f22b8a12a9f5ae96f/tests%2Fregressiontests%2Ftransactions_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftransactions_regress%2Fmodels.py?ref=073d987a84d7ebdf3b70789f22b8a12a9f5ae96f",
            "patch": "@@ -2,3 +2,9 @@\n \n class Mod(models.Model):\n     fld = models.IntegerField()\n+\n+class M2mA(models.Model):\n+    others = models.ManyToManyField('M2mB')\n+\n+class M2mB(models.Model):\n+    fld = models.IntegerField()"
        },
        {
            "sha": "bdc1b536003e21753360b0f1db0e3e1036f7790e",
            "filename": "tests/regressiontests/transactions_regress/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/073d987a84d7ebdf3b70789f22b8a12a9f5ae96f/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/073d987a84d7ebdf3b70789f22b8a12a9f5ae96f/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py?ref=073d987a84d7ebdf3b70789f22b8a12a9f5ae96f",
            "patch": "@@ -5,7 +5,7 @@\n from django.db.transaction import commit_on_success, commit_manually, TransactionManagementError\n from django.test import TransactionTestCase, skipUnlessDBFeature\n \n-from .models import Mod\n+from .models import Mod, M2mA, M2mB\n \n \n class TestTransactionClosing(TransactionTestCase):\n@@ -164,3 +164,17 @@ def create_system_user():\n             _ = User.objects.all()[0]\n         except:\n             self.fail(\"A transaction consisting of a failed operation was not closed.\")\n+\n+class TestManyToManyAddTransaction(TransactionTestCase):\n+    def test_manyrelated_add_commit(self):\n+        \"Test for https://code.djangoproject.com/ticket/16818\"\n+        a = M2mA.objects.create()\n+        b = M2mB.objects.create(fld=10)\n+        a.others.add(b)\n+\n+        # We're in a TransactionTestCase and have not changed transaction\n+        # behavior from default of \"autocommit\", so this rollback should not\n+        # actually do anything. If it does in fact undo our add, that's a bug\n+        # that the bulk insert was not auto-committed.\n+        transaction.rollback()\n+        self.assertEqual(a.others.count(), 1)"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 43,
        "deletions": 12
    }
}