{
    "author": "akaariai",
    "message": "Fixed #3881 -- skip saving session when response status is 500\n\nSaving session data is somewhat likely to lead into error when the\nstatus code is 500. It is guaranteed to lead into error if the reason\nfor the 500 code is query error on PostgreSQL.",
    "sha": "aeda55e6bffc3cfbf53698af398a19c1a0f02d46",
    "files": [
        {
            "sha": "9f65255f47f02af6de236f991359e899ba0215a8",
            "filename": "django/contrib/sessions/middleware.py",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/django%2Fcontrib%2Fsessions%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/django%2Fcontrib%2Fsessions%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fmiddleware.py?ref=aeda55e6bffc3cfbf53698af398a19c1a0f02d46",
            "patch": "@@ -33,11 +33,13 @@ def process_response(self, request, response):\n                     expires_time = time.time() + max_age\n                     expires = cookie_date(expires_time)\n                 # Save the session data and refresh the client cookie.\n-                request.session.save()\n-                response.set_cookie(settings.SESSION_COOKIE_NAME,\n-                        request.session.session_key, max_age=max_age,\n-                        expires=expires, domain=settings.SESSION_COOKIE_DOMAIN,\n-                        path=settings.SESSION_COOKIE_PATH,\n-                        secure=settings.SESSION_COOKIE_SECURE or None,\n-                        httponly=settings.SESSION_COOKIE_HTTPONLY or None)\n+                # Skip session save for 500 responses, refs #3881.\n+                if response.status_code != 500:\n+                    request.session.save()\n+                    response.set_cookie(settings.SESSION_COOKIE_NAME,\n+                            request.session.session_key, max_age=max_age,\n+                            expires=expires, domain=settings.SESSION_COOKIE_DOMAIN,\n+                            path=settings.SESSION_COOKIE_PATH,\n+                            secure=settings.SESSION_COOKIE_SECURE or None,\n+                            httponly=settings.SESSION_COOKIE_HTTPONLY or None)\n         return response"
        },
        {
            "sha": "328b085f1e8f5ce47c8c923a1c32c467557eca3e",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=aeda55e6bffc3cfbf53698af398a19c1a0f02d46",
            "patch": "@@ -409,6 +409,22 @@ def test_no_httponly_session_cookie(self):\n         self.assertNotIn('httponly',\n                          str(response.cookies[settings.SESSION_COOKIE_NAME]))\n \n+    def test_session_save_on_500(self):\n+        request = RequestFactory().get('/')\n+        response = HttpResponse('Horrible error')\n+        response.status_code = 500\n+        middleware = SessionMiddleware()\n+\n+        # Simulate a request the modifies the session\n+        middleware.process_request(request)\n+        request.session['hello'] = 'world'\n+\n+        # Handle the response through the middleware\n+        response = middleware.process_response(request, response)\n+\n+        # Check that the value wasn't saved above.\n+        self.assertNotIn('hello', request.session.load())\n+\n \n class CookieSessionTests(SessionTestsMixin, TestCase):\n "
        },
        {
            "sha": "b863d102ecdb3e4f6f4ebc9146ec0f006022cc4a",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=aeda55e6bffc3cfbf53698af398a19c1a0f02d46",
            "patch": "@@ -177,6 +177,12 @@ autocommit behavior was never restored. This bug is now fixed in 1.5. While\n this is only a bug fix, it is worth checking your applications behavior if\n you are using PostgreSQL together with the autocommit option.\n \n+Session not saved on 500 responses\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django's session middleware will skip saving the session data if the\n+response's status code is 500.\n+\n Miscellaneous\n ~~~~~~~~~~~~~\n "
        },
        {
            "sha": "1f55293413bb5ea884db301174b5419b8eae73bf",
            "filename": "docs/topics/http/sessions.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/docs%2Ftopics%2Fhttp%2Fsessions.txt",
            "raw_url": "https://github.com/django/django/raw/aeda55e6bffc3cfbf53698af398a19c1a0f02d46/docs%2Ftopics%2Fhttp%2Fsessions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fhttp%2Fsessions.txt?ref=aeda55e6bffc3cfbf53698af398a19c1a0f02d46",
            "patch": "@@ -423,6 +423,9 @@ cookie will be sent on every request.\n Similarly, the ``expires`` part of a session cookie is updated each time the\n session cookie is sent.\n \n+.. versionchanged:: 1.5\n+  The session is not saved if the response's status code is 500.\n+\n Browser-length sessions vs. persistent sessions\n ===============================================\n "
        }
    ],
    "stats": {
        "total": 41,
        "additions": 34,
        "deletions": 7
    }
}