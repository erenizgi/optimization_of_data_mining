{
    "author": "ptone",
    "message": "Added missed poisoned host header tests",
    "sha": "4fb510fde4db95d15205afefdefade97eee4d3ef",
    "files": [
        {
            "sha": "d80161371ee3fafe27cda7e25d439ec288c4672d",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/django/django/blob/4fb510fde4db95d15205afefdefade97eee4d3ef/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4fb510fde4db95d15205afefdefade97eee4d3ef/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=4fb510fde4db95d15205afefdefade97eee4d3ef",
            "patch": "@@ -6,6 +6,7 @@\n from io import BytesIO\n \n from django.conf import settings\n+from django.core.exceptions import SuspiciousOperation\n from django.core.handlers.wsgi import WSGIRequest, LimitedStream\n from django.http import HttpRequest, HttpResponse, parse_cookie, build_request_repr, UnreadablePostError\n from django.test.utils import str_prefix\n@@ -109,6 +110,38 @@ def test_http_get_host(self):\n             }\n             self.assertEqual(request.get_host(), 'internal.com:8042')\n \n+            # Poisoned host headers are rejected as suspicious\n+            legit_hosts = [\n+                'example.com',\n+                'example.com:80',\n+                '12.34.56.78',\n+                '12.34.56.78:443',\n+                '[2001:19f0:feee::dead:beef:cafe]',\n+                '[2001:19f0:feee::dead:beef:cafe]:8080',\n+            ]\n+\n+            poisoned_hosts = [\n+                'example.com@evil.tld',\n+                'example.com:dr.frankenstein@evil.tld',\n+                'example.com:someone@somestie.com:80',\n+                'example.com:80/badpath'\n+            ]\n+\n+            for host in legit_hosts:\n+                request = HttpRequest()\n+                request.META = {\n+                    'HTTP_HOST': host,\n+                }\n+                request.get_host()\n+\n+            for host in poisoned_hosts:\n+                with self.assertRaises(SuspiciousOperation):\n+                    request = HttpRequest()\n+                    request.META = {\n+                        'HTTP_HOST': host,\n+                    }\n+                    request.get_host()\n+\n         finally:\n             settings.USE_X_FORWARDED_HOST = old_USE_X_FORWARDED_HOST\n \n@@ -153,6 +186,38 @@ def test_http_get_host_with_x_forwarded_host(self):\n             }\n             self.assertEqual(request.get_host(), 'internal.com:8042')\n \n+            # Poisoned host headers are rejected as suspicious\n+            legit_hosts = [\n+                'example.com',\n+                'example.com:80',\n+                '12.34.56.78',\n+                '12.34.56.78:443',\n+                '[2001:19f0:feee::dead:beef:cafe]',\n+                '[2001:19f0:feee::dead:beef:cafe]:8080',\n+            ]\n+\n+            poisoned_hosts = [\n+                'example.com@evil.tld',\n+                'example.com:dr.frankenstein@evil.tld',\n+                'example.com:dr.frankenstein@evil.tld:80',\n+                'example.com:80/badpath'\n+            ]\n+\n+            for host in legit_hosts:\n+                request = HttpRequest()\n+                request.META = {\n+                    'HTTP_HOST': host,\n+                }\n+                request.get_host()\n+\n+            for host in poisoned_hosts:\n+                with self.assertRaises(SuspiciousOperation):\n+                    request = HttpRequest()\n+                    request.META = {\n+                        'HTTP_HOST': host,\n+                    }\n+                    request.get_host()\n+\n         finally:\n             settings.USE_X_FORWARDED_HOST = old_USE_X_FORWARDED_HOST\n "
        }
    ],
    "stats": {
        "total": 65,
        "additions": 65,
        "deletions": 0
    }
}