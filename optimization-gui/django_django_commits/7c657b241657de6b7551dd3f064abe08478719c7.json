{
    "author": "honzakral",
    "message": "Fixed #15802 -- pyscopg2 sometimes fail to close the connection when it's already closed by the server, Thanks Rick van Hattem\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16708 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7c657b241657de6b7551dd3f064abe08478719c7",
    "files": [
        {
            "sha": "aaf6262038f3b9f9bfbaaf8f8b2ee6f45497cb2f",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/7c657b241657de6b7551dd3f064abe08478719c7/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/7c657b241657de6b7551dd3f064abe08478719c7/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=7c657b241657de6b7551dd3f064abe08478719c7",
            "patch": "@@ -14,6 +14,7 @@\n from django.db.backends.postgresql_psycopg2.version import get_version\n from django.db.backends.postgresql_psycopg2.introspection import DatabaseIntrospection\n from django.utils.safestring import SafeUnicode, SafeString\n+from django.utils.log import getLogger\n \n try:\n     import psycopg2 as Database\n@@ -29,6 +30,8 @@\n psycopg2.extensions.register_adapter(SafeString, psycopg2.extensions.QuotedString)\n psycopg2.extensions.register_adapter(SafeUnicode, psycopg2.extensions.QuotedString)\n \n+logger = getLogger('django.db.backends')\n+\n class CursorWrapper(object):\n     \"\"\"\n     A thin wrapper around psycopg2's normal cursor class so that we can catch\n@@ -114,6 +117,24 @@ def check_constraints(self, table_names=None):\n         self.cursor().execute('SET CONSTRAINTS ALL IMMEDIATE')\n         self.cursor().execute('SET CONSTRAINTS ALL DEFERRED')\n \n+    def close(self):\n+        if self.connection is None:\n+            return\n+\n+        try:\n+            self.connection.close()\n+            self.connection = None\n+        except psycopg2.Error:\n+            # In some cases (database restart, network connection lost etc...)\n+            # the connection to the database is lost without giving Django a\n+            # notification. If we don't set self.connection to None, the error\n+            # will occur a every request.\n+            self.connection = None\n+            logger.warning('psycopg2 error while closing the connection.',\n+                exc_info=sys.exc_info()\n+            )\n+            raise\n+\n     def _get_pg_version(self):\n         if self._pg_version is None:\n             self._pg_version = get_version(self.connection)"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 21,
        "deletions": 0
    }
}