{
    "author": "claudep",
    "message": "Fixed #5076 -- Properly decode POSTs with non-utf-8 payload encoding\n\nThanks daniel at blogg.se for the report and Aymeric Augustin for\nhis assistance on the patch.",
    "sha": "6de6988f9990b4b53f5a20bfc3811b3cc49291c5",
    "files": [
        {
            "sha": "4c0710549ac907b9269b9f1a39025875039231b6",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/6de6988f9990b4b53f5a20bfc3811b3cc49291c5/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/6de6988f9990b4b53f5a20bfc3811b3cc49291c5/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=6de6988f9990b4b53f5a20bfc3811b3cc49291c5",
            "patch": "@@ -1,5 +1,6 @@\n from __future__ import unicode_literals\n \n+import codecs\n import logging\n import sys\n from io import BytesIO\n@@ -144,6 +145,14 @@ def __init__(self, environ):\n         self.META['PATH_INFO'] = path_info\n         self.META['SCRIPT_NAME'] = script_name\n         self.method = environ['REQUEST_METHOD'].upper()\n+        _, content_params = self._parse_content_type(self.META.get('CONTENT_TYPE', ''))\n+        if 'charset' in content_params:\n+            try:\n+                codecs.lookup(content_params['charset'])\n+            except LookupError:\n+                pass\n+            else:\n+                self.encoding = content_params['charset']\n         self._post_parse_error = False\n         try:\n             content_length = int(self.environ.get('CONTENT_LENGTH'))\n@@ -155,6 +164,21 @@ def __init__(self, environ):\n     def _is_secure(self):\n         return 'wsgi.url_scheme' in self.environ and self.environ['wsgi.url_scheme'] == 'https'\n \n+    def _parse_content_type(self, ctype):\n+        \"\"\"\n+        Media Types parsing according to RFC 2616, section 3.7.\n+\n+        Returns the data type and parameters. For example:\n+        Input: \"text/plain; charset=iso-8859-1\"\n+        Output: ('text/plain', {'charset': 'iso-8859-1'})\n+        \"\"\"\n+        content_type, _, params = ctype.partition(';')\n+        content_params = {}\n+        for parameter in params.split(';'):\n+            k, _, v = parameter.strip().partition('=')\n+            content_params[k] = v\n+        return content_type, content_params\n+\n     def _get_request(self):\n         if not hasattr(self, '_request'):\n             self._request = datastructures.MergeDict(self.POST, self.GET)"
        },
        {
            "sha": "eaf25ea7a6420d86de6759ab4873be248f0c3ecd",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/6de6988f9990b4b53f5a20bfc3811b3cc49291c5/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6de6988f9990b4b53f5a20bfc3811b3cc49291c5/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=6de6988f9990b4b53f5a20bfc3811b3cc49291c5",
            "patch": "@@ -1,3 +1,4 @@\n+# -*- encoding: utf-8 -*-\n from __future__ import unicode_literals\n \n import time\n@@ -352,6 +353,20 @@ def test_value_after_read(self):\n         self.assertRaises(Exception, lambda: request.body)\n         self.assertEqual(request.POST, {})\n \n+    def test_alternate_charset_POST(self):\n+        \"\"\"\n+        Test a POST with non-utf-8 payload encoding.\n+        \"\"\"\n+        from django.utils.http import urllib_parse\n+        payload = FakePayload(urllib_parse.urlencode({'key': 'España'.encode('latin-1')}))\n+        request = WSGIRequest({\n+            'REQUEST_METHOD': 'POST',\n+            'CONTENT_LENGTH': len(payload),\n+            'CONTENT_TYPE': 'application/x-www-form-urlencoded; charset=iso-8859-1',\n+            'wsgi.input': payload,\n+        })\n+        self.assertEqual(request.POST, {'key': ['España']})\n+\n     def test_body_after_POST_multipart(self):\n         \"\"\"\n         Reading body after parsing multipart is not allowed"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 39,
        "deletions": 0
    }
}