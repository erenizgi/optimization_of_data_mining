{
    "author": "jezdez",
    "message": "Fixed #16035 -- Appended the Etag response header if the GZipMiddleware is in use to follow RFC2616 better. Thanks, ext and dracos2.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17471 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b926765a7c04e88a85f2360a238efde9ffe98244",
    "files": [
        {
            "sha": "69f938cf0a41cc9aae575f8ac58a8fa1f2de32e8",
            "filename": "django/middleware/gzip.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/b926765a7c04e88a85f2360a238efde9ffe98244/django%2Fmiddleware%2Fgzip.py",
            "raw_url": "https://github.com/django/django/raw/b926765a7c04e88a85f2360a238efde9ffe98244/django%2Fmiddleware%2Fgzip.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fgzip.py?ref=b926765a7c04e88a85f2360a238efde9ffe98244",
            "patch": "@@ -37,6 +37,9 @@ def process_response(self, request, response):\n         if len(compressed_content) >= len(response.content):\n             return response\n \n+        if response.has_header('ETag'):\n+            response['ETag'] = re.sub('\"$', ';gzip\"', response['ETag'])\n+\n         response.content = compressed_content\n         response['Content-Encoding'] = 'gzip'\n         response['Content-Length'] = str(len(response.content))"
        },
        {
            "sha": "3adb10964afc0ad17b82052e4d32edec0aa5bcb7",
            "filename": "tests/regressiontests/middleware/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 2,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/b926765a7c04e88a85f2360a238efde9ffe98244/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b926765a7c04e88a85f2360a238efde9ffe98244/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Ftests.py?ref=b926765a7c04e88a85f2360a238efde9ffe98244",
            "patch": "@@ -13,8 +13,8 @@\n from django.middleware.common import CommonMiddleware\n from django.middleware.http import ConditionalGetMiddleware\n from django.middleware.gzip import GZipMiddleware\n-from django.test import TestCase\n-\n+from django.test import TestCase, RequestFactory\n+from django.test.utils import override_settings\n \n class CommonMiddlewareTest(TestCase):\n     def setUp(self):\n@@ -582,3 +582,32 @@ def test_no_compress_uncompressible_response(self):\n         r = GZipMiddleware().process_response(self.req, self.resp)\n         self.assertEqual(r.content, self.uncompressible_string)\n         self.assertEqual(r.get('Content-Encoding'), None)\n+\n+\n+@override_settings(USE_ETAGS=True)\n+class ETagGZipMiddlewareTest(TestCase):\n+    \"\"\"\n+    Tests if the ETag middleware behaves correctly with GZip middleware.\n+    \"\"\"\n+    compressible_string = 'a' * 500\n+\n+    def setUp(self):\n+        self.rf = RequestFactory()\n+\n+    def test_compress_response(self):\n+        \"\"\"\n+        Tests that ETag is changed after gzip compression is performed.\n+        \"\"\"\n+        request = self.rf.get('/', HTTP_ACCEPT_ENCODING='gzip, deflate')\n+        response = GZipMiddleware().process_response(request,\n+            CommonMiddleware().process_response(request,\n+                HttpResponse(self.compressible_string)))\n+        gzip_etag = response.get('ETag')\n+\n+        request = self.rf.get('/', HTTP_ACCEPT_ENCODING='')\n+        response = GZipMiddleware().process_response(request,\n+            CommonMiddleware().process_response(request,\n+                HttpResponse(self.compressible_string)))\n+        nogzip_etag = response.get('ETag')\n+\n+        self.assertNotEqual(gzip_etag, nogzip_etag)"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 34,
        "deletions": 2
    }
}