{
    "author": "claudep",
    "message": "Prevented leftover files and dirs in admin_scripts tests",
    "sha": "d30516e163c1870b2467c63f97c8263f9da40226",
    "files": [
        {
            "sha": "a26d7a6eaa3921fb3b3fb3716cc60bd627384870",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 23,
            "deletions": 27,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/d30516e163c1870b2467c63f97c8263f9da40226/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d30516e163c1870b2467c63f97c8263f9da40226/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=d30516e163c1870b2467c63f97c8263f9da40226",
            "patch": "@@ -138,6 +138,12 @@ def run_django_admin(self, args, settings_file=None):\n         return self.run_test(os.path.join(bin_dir, 'django-admin.py'), args, settings_file)\n \n     def run_manage(self, args, settings_file=None):\n+        def safe_remove(path):\n+            try:\n+                os.remove(path)\n+            except OSError:\n+                pass\n+\n         conf_dir = os.path.dirname(conf.__file__)\n         template_manage_py = os.path.join(conf_dir, 'project_template', 'manage.py')\n \n@@ -150,13 +156,9 @@ def run_manage(self, args, settings_file=None):\n             \"{{ project_name }}\", \"regressiontests\")\n         with open(test_manage_py, 'w') as fp:\n             fp.write(manage_py_contents)\n+        self.addCleanup(safe_remove, test_manage_py)\n \n-        stdout, stderr = self.run_test('./manage.py', args, settings_file)\n-\n-        # Cleanup - remove the generated manage.py script\n-        os.remove(test_manage_py)\n-\n-        return stdout, stderr\n+        return self.run_test('./manage.py', args, settings_file)\n \n     def assertNoOutput(self, stream):\n         \"Utility assertion: assert that the given stream is empty\"\n@@ -1410,9 +1412,9 @@ def test_simple_project(self):\n         \"Make sure the startproject management command creates a project\"\n         args = ['startproject', 'testproject']\n         testproject_dir = os.path.join(test_dir, 'testproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n \n@@ -1423,16 +1425,11 @@ def test_simple_project(self):\n \n     def test_invalid_project_name(self):\n         \"Make sure the startproject management command validates a project name\"\n-\n-        def cleanup(p):\n-            if os.path.exists(p):\n-                shutil.rmtree(p)\n-\n         args = ['startproject', '7testproject']\n         testproject_dir = os.path.join(test_dir, '7testproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(cleanup, testproject_dir)\n         self.assertOutput(err, \"Error: '7testproject' is not a valid project name. Please make sure the name begins with a letter or underscore.\")\n         self.assertFalse(os.path.exists(testproject_dir))\n \n@@ -1441,9 +1438,9 @@ def test_simple_project_different_directory(self):\n         args = ['startproject', 'testproject', 'othertestproject']\n         testproject_dir = os.path.join(test_dir, 'othertestproject')\n         os.mkdir(testproject_dir)\n+        self.addCleanup(shutil.rmtree, testproject_dir)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'manage.py')))\n \n@@ -1457,9 +1454,9 @@ def test_custom_project_template(self):\n         template_path = os.path.join(test_dir, 'admin_scripts', 'custom_templates', 'project_template')\n         args = ['startproject', '--template', template_path, 'customtestproject']\n         testproject_dir = os.path.join(test_dir, 'customtestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'additional_dir')))\n@@ -1469,9 +1466,9 @@ def test_template_dir_with_trailing_slash(self):\n         template_path = os.path.join(test_dir, 'admin_scripts', 'custom_templates', 'project_template' + os.sep)\n         args = ['startproject', '--template', template_path, 'customtestproject']\n         testproject_dir = os.path.join(test_dir, 'customtestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'additional_dir')))\n@@ -1481,9 +1478,9 @@ def test_custom_project_template_from_tarball_by_path(self):\n         template_path = os.path.join(test_dir, 'admin_scripts', 'custom_templates', 'project_template.tgz')\n         args = ['startproject', '--template', template_path, 'tarballtestproject']\n         testproject_dir = os.path.join(test_dir, 'tarballtestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'run.py')))\n@@ -1494,9 +1491,9 @@ def test_custom_project_template_from_tarball_to_alternative_location(self):\n         args = ['startproject', '--template', template_path, 'tarballtestproject', 'altlocation']\n         testproject_dir = os.path.join(test_dir, 'altlocation')\n         os.mkdir(testproject_dir)\n+        self.addCleanup(shutil.rmtree, testproject_dir)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'run.py')))\n@@ -1507,9 +1504,9 @@ def test_custom_project_template_from_tarball_by_url(self):\n \n         args = ['startproject', '--template', template_url, 'urltestproject']\n         testproject_dir = os.path.join(test_dir, 'urltestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'run.py')))\n@@ -1520,9 +1517,9 @@ def test_project_template_tarball_url(self):\n \n         args = ['startproject', '--template', template_url, 'urltestproject']\n         testproject_dir = os.path.join(test_dir, 'urltestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'run.py')))\n@@ -1532,9 +1529,9 @@ def test_file_without_extension(self):\n         template_path = os.path.join(test_dir, 'admin_scripts', 'custom_templates', 'project_template')\n         args = ['startproject', '--template', template_path, 'customtestproject', '-e', 'txt', '-n', 'Procfile']\n         testproject_dir = os.path.join(test_dir, 'customtestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         self.assertTrue(os.path.exists(os.path.join(testproject_dir, 'additional_dir')))\n@@ -1551,8 +1548,8 @@ def test_custom_project_template_context_variables(self):\n         args = ['startproject', '--template', template_path, 'another_project', 'project_dir']\n         testproject_dir = os.path.join(test_dir, 'project_dir')\n         os.mkdir(testproject_dir)\n-        out, err = self.run_django_admin(args)\n         self.addCleanup(shutil.rmtree, testproject_dir)\n+        out, err = self.run_django_admin(args)\n         self.assertNoOutput(err)\n         test_manage_py = os.path.join(testproject_dir, 'manage.py')\n         with open(test_manage_py, 'r') as fp:\n@@ -1564,19 +1561,18 @@ def test_no_escaping_of_project_variables(self):\n         \"Make sure template context variables are not html escaped\"\n         # We're using a custom command so we need the alternate settings\n         self.write_settings('alternate_settings.py')\n+        self.addCleanup(self.remove_settings, 'alternate_settings.py')\n         template_path = os.path.join(test_dir, 'admin_scripts', 'custom_templates', 'project_template')\n         args = ['custom_startproject', '--template', template_path, 'another_project', 'project_dir', '--extra', '<&>', '--settings=alternate_settings']\n         testproject_dir = os.path.join(test_dir, 'project_dir')\n         os.mkdir(testproject_dir)\n-        out, err = self.run_manage(args)\n         self.addCleanup(shutil.rmtree, testproject_dir)\n+        out, err = self.run_manage(args)\n         self.assertNoOutput(err)\n         test_manage_py = os.path.join(testproject_dir, 'additional_dir', 'extra.py')\n         with open(test_manage_py, 'r') as fp:\n             content = fp.read()\n             self.assertIn(\"<&>\", content)\n-        # tidy up alternate settings\n-        self.remove_settings('alternate_settings.py')\n \n     def test_custom_project_destination_missing(self):\n         \"\"\"\n@@ -1596,9 +1592,9 @@ def test_custom_project_template_with_non_ascii_templates(self):\n         template_path = os.path.join(test_dir, 'admin_scripts', 'custom_templates', 'project_template')\n         args = ['startproject', '--template', template_path, '--extension=txt', 'customtestproject']\n         testproject_dir = os.path.join(test_dir, 'customtestproject')\n+        self.addCleanup(shutil.rmtree, testproject_dir, True)\n \n         out, err = self.run_django_admin(args)\n-        self.addCleanup(shutil.rmtree, testproject_dir)\n         self.assertNoOutput(err)\n         self.assertTrue(os.path.isdir(testproject_dir))\n         path = os.path.join(testproject_dir, 'ticket-18091-non-ascii-template.txt')\n@@ -1612,8 +1608,8 @@ class DiffSettings(AdminScriptTestCase):\n     def test_basic(self):\n         \"Runs without error and emits settings diff.\"\n         self.write_settings('settings_to_diff.py', sdict={'FOO': '\"bar\"'})\n+        self.addCleanup(self.remove_settings, 'settings_to_diff.py')\n         args = ['diffsettings', '--settings=settings_to_diff']\n         out, err = self.run_manage(args)\n-        self.remove_settings('settings_to_diff.py')\n         self.assertNoOutput(err)\n         self.assertOutput(out, \"FOO = 'bar'  ###\")"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 23,
        "deletions": 27
    }
}