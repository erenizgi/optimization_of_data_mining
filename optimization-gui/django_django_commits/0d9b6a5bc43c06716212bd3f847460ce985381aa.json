{
    "author": "ramiro",
    "message": "Fixed #10841 -- Switched response served when DEBUG=True and request.is_ajax() returns True (indicating request has been generated by a JS library) to a plain text version for easier debugging.\n\nContents of this response are similar to its HTML counterpart modulo frame variables values in the Python traceback section.\n\nThanks to Riz for the report, to SmileyChris for the patch and to Julien for reviewing.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16921 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "0d9b6a5bc43c06716212bd3f847460ce985381aa",
    "files": [
        {
            "sha": "ad89a335e2e0bdf8c7f2ff375b62427669880512",
            "filename": "django/views/debug.py",
            "status": "modified",
            "additions": 83,
            "deletions": 7,
            "changes": 90,
            "blob_url": "https://github.com/django/django/blob/0d9b6a5bc43c06716212bd3f847460ce985381aa/django%2Fviews%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/0d9b6a5bc43c06716212bd3f847460ce985381aa/django%2Fviews%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdebug.py?ref=0d9b6a5bc43c06716212bd3f847460ce985381aa",
            "patch": "@@ -59,8 +59,12 @@ def technical_500_response(request, exc_type, exc_value, tb):\n     the values returned from sys.exc_info() and friends.\n     \"\"\"\n     reporter = ExceptionReporter(request, exc_type, exc_value, tb)\n-    html = reporter.get_traceback_html()\n-    return HttpResponseServerError(html, mimetype='text/html')\n+    if request.is_ajax():\n+        text = reporter.get_traceback_text()\n+        return HttpResponseServerError(text, mimetype='text/plain')\n+    else:\n+        html = reporter.get_traceback_html()\n+        return HttpResponseServerError(html, mimetype='text/html')\n \n # Cache for the default exception reporter filter instance.\n default_exception_reporter_filter = None\n@@ -201,8 +205,8 @@ def __init__(self, request, exc_type, exc_value, tb, is_email=False):\n             self.exc_value = Exception('Deprecated String Exception: %r' % self.exc_type)\n             self.exc_type = type(self.exc_value)\n \n-    def get_traceback_html(self):\n-        \"Return HTML code for traceback.\"\n+    def get_traceback_data(self):\n+        \"Return a Context instance containing traceback information.\"\n \n         if self.exc_type and issubclass(self.exc_type, TemplateDoesNotExist):\n             from django.template.loader import template_source_loaders\n@@ -240,8 +244,7 @@ def get_traceback_html(self):\n                 unicode_str = self.exc_value.args[1]\n                 unicode_hint = smart_unicode(unicode_str[max(start-5, 0):min(end+5, len(unicode_str))], 'ascii', errors='replace')\n         from django import get_version\n-        t = Template(TECHNICAL_500_TEMPLATE, name='Technical 500 template')\n-        c = Context({\n+        c = {\n             'is_email': self.is_email,\n             'unicode_hint': unicode_hint,\n             'frames': frames,\n@@ -256,14 +259,26 @@ def get_traceback_html(self):\n             'template_info': self.template_info,\n             'template_does_not_exist': self.template_does_not_exist,\n             'loader_debug_info': self.loader_debug_info,\n-        })\n+        }\n         # Check whether exception info is available\n         if self.exc_type:\n             c['exception_type'] = self.exc_type.__name__\n         if self.exc_value:\n             c['exception_value'] = smart_unicode(self.exc_value, errors='replace')\n         if frames:\n             c['lastframe'] = frames[-1]\n+        return c\n+\n+    def get_traceback_html(self):\n+        \"Return HTML version of debug 500 HTTP error page.\"\n+        t = Template(TECHNICAL_500_TEMPLATE, name='Technical 500 template')\n+        c = Context(self.get_traceback_data())\n+        return t.render(c)\n+\n+    def get_traceback_text(self):\n+        \"Return plain text version of debug 500 HTTP error page.\"\n+        t = Template(TECHNICAL_500_TEXT_TEMPLATE, name='Technical 500 template')\n+        c = Context(self.get_traceback_data(), autoescape=False)\n         return t.render(c)\n \n     def get_template_exception_info(self):\n@@ -890,6 +905,67 @@ def empty_urlconf(request):\n </html>\n \"\"\"\n \n+TECHNICAL_500_TEXT_TEMPLATE = \"\"\"{% firstof exception_type 'Report' %}{% if request %} at {{ request.path_info }}{% endif %}\n+{% firstof exception_value 'No exception supplied' %}\n+{% if request %}\n+Request Method: {{ request.META.REQUEST_METHOD }}\n+Request URL: {{ request.build_absolute_uri }}{% endif %}\n+Django Version: {{ django_version_info }}\n+Python Executable: {{ sys_executable }}\n+Python Version: {{ sys_version_info }}\n+Python Path: {{ sys_path }}\n+Server time: {{server_time|date:\"r\"}}\n+Installed Applications:\n+{{ settings.INSTALLED_APPS|pprint }}\n+Installed Middleware:\n+{{ settings.MIDDLEWARE_CLASSES|pprint }}\n+{% if template_does_not_exist %}Template loader Error:\n+{% if loader_debug_info %}Django tried loading these templates, in this order:\n+{% for loader in loader_debug_info %}Using loader {{ loader.loader }}:\n+{% for t in loader.templates %}{{ t.name }} (File {% if t.exists %}exists{% else %}does not exist{% endif %})\n+{% endfor %}{% endfor %}\n+{% else %}Django couldn't find any templates because your TEMPLATE_LOADERS setting is empty!\n+{% endif %}\n+{% endif %}{% if template_info %}\n+Template error:\n+In template {{ template_info.name }}, error at line {{ template_info.line }}\n+   {{ template_info.message }}{% for source_line in template_info.source_lines %}{% ifequal source_line.0 template_info.line %}\n+   {{ source_line.0 }} : {{ template_info.before }} {{ template_info.during }} {{ template_info.after }}\n+{% else %}\n+   {{ source_line.0 }} : {{ source_line.1 }}\n+   {% endifequal %}{% endfor %}{% endif %}{% if frames %}\n+Traceback:\n+{% for frame in frames %}File \"{{ frame.filename }}\" in {{ frame.function }}\n+{% if frame.context_line %}  {{ frame.lineno }}. {{ frame.context_line }}{% endif %}\n+{% endfor %}\n+{% if exception_type %}Exception Type: {{ exception_type }}{% if request %} at {{ request.path_info }}{% endif %}\n+{% if exception_value %}Exception Value: {{ exception_value }}{% endif %}{% endif %}{% endif %}\n+{% if request %}Request information:\n+GET:{% for k, v in request.GET.items %}\n+{{ k }} = {{ v|stringformat:\"r\" }}{% empty %} No GET data{% endfor %}\n+\n+POST:{% for k, v in filtered_POST.items %}\n+{{ k }} = {{ v|stringformat:\"r\" }}{% empty %} No POST data{% endfor %}\n+\n+FILES:{% for k, v in request.FILES.items %}\n+{{ k }} = {{ v|stringformat:\"r\" }}{% empty %} No FILES data{% endfor %}\n+\n+COOKIES:{% for k, v in request.COOKIES.items %}\n+{{ k }} = {{ v|stringformat:\"r\" }}{% empty %} No cookie data{% endfor %}\n+\n+META:{% for k, v in request.META.items|dictsort:\"0\" %}\n+{{ k }} = {{ v|stringformat:\"r\" }}{% endfor %}\n+{% else %}Request data not supplied\n+{% endif %}\n+Settings:\n+Using settings module {{ settings.SETTINGS_MODULE }}{% for k, v in settings.items|dictsort:\"0\" %}\n+{{ k }} = {{ v|stringformat:\"r\" }}{% endfor %}\n+\n+You're seeing this error because you have DEBUG = True in your\n+Django settings file. Change that to False, and Django will\n+display a standard 500 page.\n+\"\"\"\n+\n TECHNICAL_404_TEMPLATE = \"\"\"\n <!DOCTYPE html>\n <html lang=\"en\">"
        },
        {
            "sha": "89e1fc11ac00740387028d69fa0ceb59eaa203da",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/0d9b6a5bc43c06716212bd3f847460ce985381aa/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/0d9b6a5bc43c06716212bd3f847460ce985381aa/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=0d9b6a5bc43c06716212bd3f847460ce985381aa",
            "patch": "@@ -339,6 +339,17 @@ Django 1.4 also includes several smaller improvements worth noting:\n   be able to retrieve a translation string without displaying it but setting\n   a template context variable instead.\n \n+* A new plain text version of the HTTP 500 status code internal error page\n+  served when :setting:`DEBUG` is ``True`` is now sent to the client when\n+  Django detects that the request has originated in JavaScript code\n+  (:meth:`~django.http.HttpRequest.is_ajax` is used for this).\n+\n+  Similarly to its HTML counterpart, it contains a collection of different\n+  pieces of information about the state of the web application.\n+\n+  This should make it easier to read when debugging interaction with\n+  client-side Javascript code.\n+\n .. _backwards-incompatible-changes-1.4:\n \n Backwards incompatible changes in 1.4"
        },
        {
            "sha": "093d925f0f96ff2ba0c471c2d198151867e6f2d6",
            "filename": "tests/regressiontests/views/tests/debug.py",
            "status": "modified",
            "additions": 152,
            "deletions": 24,
            "changes": 176,
            "blob_url": "https://github.com/django/django/blob/0d9b6a5bc43c06716212bd3f847460ce985381aa/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/0d9b6a5bc43c06716212bd3f847460ce985381aa/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py?ref=0d9b6a5bc43c06716212bd3f847460ce985381aa",
            "patch": "@@ -171,45 +171,104 @@ def test_message_only(self):\n         self.assertIn('<p>Request data not supplied</p>', html)\n \n \n-class ExceptionReporterFilterTests(TestCase):\n-    \"\"\"\n-    Ensure that sensitive information can be filtered out of error reports.\n-    Refs #14614.\n-    \"\"\"\n+class PlainTextReportTests(TestCase):\n     rf = RequestFactory()\n+\n+    def test_request_and_exception(self):\n+        \"A simple exception report can be generated\"\n+        try:\n+            request = self.rf.get('/test_view/')\n+            raise ValueError(\"Can't find my keys\")\n+        except ValueError:\n+            exc_type, exc_value, tb = sys.exc_info()\n+        reporter = ExceptionReporter(request, exc_type, exc_value, tb)\n+        text = reporter.get_traceback_text()\n+        self.assertIn('ValueError at /test_view/', text)\n+        self.assertIn(\"Can't find my keys\", text)\n+        self.assertIn('Request Method:', text)\n+        self.assertIn('Request URL:', text)\n+        self.assertIn('Exception Type:', text)\n+        self.assertIn('Exception Value:', text)\n+        self.assertIn('Traceback:', text)\n+        self.assertIn('Request information:', text)\n+        self.assertNotIn('Request data not supplied', text)\n+\n+    def test_no_request(self):\n+        \"An exception report can be generated without request\"\n+        try:\n+            raise ValueError(\"Can't find my keys\")\n+        except ValueError:\n+            exc_type, exc_value, tb = sys.exc_info()\n+        reporter = ExceptionReporter(None, exc_type, exc_value, tb)\n+        text = reporter.get_traceback_text()\n+        self.assertIn('ValueError', text)\n+        self.assertIn(\"Can't find my keys\", text)\n+        self.assertNotIn('Request Method:', text)\n+        self.assertNotIn('Request URL:', text)\n+        self.assertIn('Exception Type:', text)\n+        self.assertIn('Exception Value:', text)\n+        self.assertIn('Traceback:', text)\n+        self.assertIn('Request data not supplied', text)\n+\n+    def test_no_exception(self):\n+        \"An exception report can be generated for just a request\"\n+        request = self.rf.get('/test_view/')\n+        reporter = ExceptionReporter(request, None, None, None)\n+        text = reporter.get_traceback_text()\n+\n+    def test_request_and_message(self):\n+        \"A message can be provided in addition to a request\"\n+        request = self.rf.get('/test_view/')\n+        reporter = ExceptionReporter(request, None, \"I'm a little teapot\", None)\n+        text = reporter.get_traceback_text()\n+\n+    def test_message_only(self):\n+        reporter = ExceptionReporter(None, None, \"I'm a little teapot\", None)\n+        text = reporter.get_traceback_text()\n+\n+\n+class ExceptionReportTestMixin(object):\n+\n+    # Mixin used in the ExceptionReporterFilterTests and\n+    # AjaxResponseExceptionReporterFilter tests below\n+\n     breakfast_data = {'sausage-key': 'sausage-value',\n                       'baked-beans-key': 'baked-beans-value',\n                       'hash-brown-key': 'hash-brown-value',\n                       'bacon-key': 'bacon-value',}\n \n-    def verify_unsafe_response(self, view):\n+    def verify_unsafe_response(self, view, check_for_vars=True):\n         \"\"\"\n         Asserts that potentially sensitive info are displayed in the response.\n         \"\"\"\n         request = self.rf.post('/some_url/', self.breakfast_data)\n         response = view(request)\n-        # All variables are shown.\n-        self.assertContains(response, 'cooked_eggs', status_code=500)\n-        self.assertContains(response, 'scrambled', status_code=500)\n-        self.assertContains(response, 'sauce', status_code=500)\n-        self.assertContains(response, 'worcestershire', status_code=500)\n+        if check_for_vars:\n+            # All variables are shown.\n+            self.assertContains(response, 'cooked_eggs', status_code=500)\n+            self.assertContains(response, 'scrambled', status_code=500)\n+            self.assertContains(response, 'sauce', status_code=500)\n+            self.assertContains(response, 'worcestershire', status_code=500)\n+\n         for k, v in self.breakfast_data.items():\n             # All POST parameters are shown.\n             self.assertContains(response, k, status_code=500)\n             self.assertContains(response, v, status_code=500)\n \n-    def verify_safe_response(self, view):\n+    def verify_safe_response(self, view, check_for_vars=True):\n         \"\"\"\n         Asserts that certain sensitive info are not displayed in the response.\n         \"\"\"\n         request = self.rf.post('/some_url/', self.breakfast_data)\n         response = view(request)\n-        # Non-sensitive variable's name and value are shown.\n-        self.assertContains(response, 'cooked_eggs', status_code=500)\n-        self.assertContains(response, 'scrambled', status_code=500)\n-        # Sensitive variable's name is shown but not its value.\n-        self.assertContains(response, 'sauce', status_code=500)\n-        self.assertNotContains(response, 'worcestershire', status_code=500)\n+        if check_for_vars:\n+            # Non-sensitive variable's name and value are shown.\n+            self.assertContains(response, 'cooked_eggs', status_code=500)\n+            self.assertContains(response, 'scrambled', status_code=500)\n+            # Sensitive variable's name is shown but not its value.\n+            self.assertContains(response, 'sauce', status_code=500)\n+            self.assertNotContains(response, 'worcestershire', status_code=500)\n+\n         for k, v in self.breakfast_data.items():\n             # All POST parameters' names are shown.\n             self.assertContains(response, k, status_code=500)\n@@ -220,17 +279,19 @@ def verify_safe_response(self, view):\n         self.assertNotContains(response, 'sausage-value', status_code=500)\n         self.assertNotContains(response, 'bacon-value', status_code=500)\n \n-    def verify_paranoid_response(self, view):\n+    def verify_paranoid_response(self, view, check_for_vars=True):\n         \"\"\"\n         Asserts that no variables or POST parameters are displayed in the response.\n         \"\"\"\n         request = self.rf.post('/some_url/', self.breakfast_data)\n         response = view(request)\n-        # Show variable names but not their values.\n-        self.assertContains(response, 'cooked_eggs', status_code=500)\n-        self.assertNotContains(response, 'scrambled', status_code=500)\n-        self.assertContains(response, 'sauce', status_code=500)\n-        self.assertNotContains(response, 'worcestershire', status_code=500)\n+        if check_for_vars:\n+            # Show variable names but not their values.\n+            self.assertContains(response, 'cooked_eggs', status_code=500)\n+            self.assertNotContains(response, 'scrambled', status_code=500)\n+            self.assertContains(response, 'sauce', status_code=500)\n+            self.assertNotContains(response, 'worcestershire', status_code=500)\n+\n         for k, v in self.breakfast_data.items():\n             # All POST parameters' names are shown.\n             self.assertContains(response, k, status_code=500)\n@@ -303,6 +364,14 @@ def verify_paranoid_email(self, view):\n                 # No POST parameters' values are shown.\n                 self.assertNotIn(v, email.body)\n \n+\n+class ExceptionReporterFilterTests(TestCase, ExceptionReportTestMixin):\n+    \"\"\"\n+    Ensure that sensitive information can be filtered out of error reports.\n+    Refs #14614.\n+    \"\"\"\n+    rf = RequestFactory()\n+\n     def test_non_sensitive_request(self):\n         \"\"\"\n         Ensure that everything (request info and frame variables) can bee seen\n@@ -354,3 +423,62 @@ def test_custom_exception_reporter_filter(self):\n         with self.settings(DEBUG=False):\n             self.verify_unsafe_response(custom_exception_reporter_filter_view)\n             self.verify_unsafe_email(custom_exception_reporter_filter_view)\n+\n+\n+class AjaxResponseExceptionReporterFilter(TestCase, ExceptionReportTestMixin):\n+    \"\"\"\n+    Ensure that sensitive information can be filtered out of error reports.\n+\n+    Here we specifically test the plain text 500 debug-only error page served\n+    when it has been detected the request was sent by JS code. We don't check\n+    for (non)existence of frames vars in the traceback information section of\n+    the response content because we don't include them in these error pages.\n+    Refs #14614.\n+    \"\"\"\n+    rf = RequestFactory(HTTP_X_REQUESTED_WITH='XMLHttpRequest')\n+\n+    def test_non_sensitive_request(self):\n+        \"\"\"\n+        Ensure that request info can bee seen in the default error reports for\n+        non-sensitive requests.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(non_sensitive_view, check_for_vars=False)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_unsafe_response(non_sensitive_view, check_for_vars=False)\n+\n+    def test_sensitive_request(self):\n+        \"\"\"\n+        Ensure that sensitive POST parameters cannot be seen in the default\n+        error reports for sensitive requests.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(sensitive_view, check_for_vars=False)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_safe_response(sensitive_view, check_for_vars=False)\n+\n+    def test_paranoid_request(self):\n+        \"\"\"\n+        Ensure that no POST parameters can be seen in the default error reports\n+        for \"paranoid\" requests.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(paranoid_view, check_for_vars=False)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_paranoid_response(paranoid_view, check_for_vars=False)\n+\n+    def test_custom_exception_reporter_filter(self):\n+        \"\"\"\n+        Ensure that it's possible to assign an exception reporter filter to\n+        the request to bypass the one set in DEFAULT_EXCEPTION_REPORTER_FILTER.\n+        \"\"\"\n+        with self.settings(DEBUG=True):\n+            self.verify_unsafe_response(custom_exception_reporter_filter_view,\n+                check_for_vars=False)\n+\n+        with self.settings(DEBUG=False):\n+            self.verify_unsafe_response(custom_exception_reporter_filter_view,\n+                check_for_vars=False)"
        }
    ],
    "stats": {
        "total": 277,
        "additions": 246,
        "deletions": 31
    }
}