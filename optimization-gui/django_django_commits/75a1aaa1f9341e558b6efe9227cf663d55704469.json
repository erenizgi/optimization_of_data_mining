{
    "author": "freakboy3742",
    "message": "Fixed #11513 -- Ensure that the redirect at the end of an object change won't redirect to a page for which the user doesn't have permission. Thanks to rlaager for the report and draft patch, and to Julien Phalip for the final patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15584 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "75a1aaa1f9341e558b6efe9227cf663d55704469",
    "files": [
        {
            "sha": "42c15166914b2272ed28df9aa9bf07a684fab38a",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/75a1aaa1f9341e558b6efe9227cf663d55704469/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/75a1aaa1f9341e558b6efe9227cf663d55704469/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=75a1aaa1f9341e558b6efe9227cf663d55704469",
            "patch": "@@ -766,7 +766,13 @@ def response_change(self, request, obj):\n             return HttpResponseRedirect(\"../add/\")\n         else:\n             self.message_user(request, msg)\n-            return HttpResponseRedirect(\"../\")\n+            # Figure out where to redirect. If the user has change permission,\n+            # redirect to the change-list page for this object. Otherwise,\n+            # redirect to the admin index.\n+            if self.has_change_permission(request, None):\n+                return HttpResponseRedirect('../')\n+            else:\n+                return HttpResponseRedirect('../../../')\n \n     def response_action(self, request, queryset):\n         \"\"\""
        },
        {
            "sha": "7d6cab3cbf9107be674c91f5ea1e193abc2c3dda",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/75a1aaa1f9341e558b6efe9227cf663d55704469/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/75a1aaa1f9341e558b6efe9227cf663d55704469/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=75a1aaa1f9341e558b6efe9227cf663d55704469",
            "patch": "@@ -133,6 +133,13 @@ def save_model(self, request, obj, form, change=True):\n         ).send()\n         return super(ArticleAdmin, self).save_model(request, obj, form, change)\n \n+class RowLevelChangePermissionModel(models.Model):\n+    name = models.CharField(max_length=100, blank=True)\n+\n+class RowLevelChangePermissionModelAdmin(admin.ModelAdmin):\n+    def has_change_permission(self, request, obj=None):\n+        \"\"\" Only allow changing objects with even id number \"\"\"\n+        return request.user.is_staff and (obj is not None) and (obj.id % 2 == 0)\n \n class CustomArticle(models.Model):\n     content = models.TextField()\n@@ -735,6 +742,7 @@ class FoodDeliveryAdmin(admin.ModelAdmin):\n admin.site.register(WorkHour, WorkHourAdmin)\n admin.site.register(Reservation)\n admin.site.register(FoodDelivery, FoodDeliveryAdmin)\n+admin.site.register(RowLevelChangePermissionModel, RowLevelChangePermissionModelAdmin)\n \n # We intentionally register Promo and ChapterXtra1 but not Chapter nor ChapterXtra2.\n # That way we cover all four cases:"
        },
        {
            "sha": "642186eee25e8c62afcb9a9d150e107e71b91196",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/75a1aaa1f9341e558b6efe9227cf663d55704469/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/75a1aaa1f9341e558b6efe9227cf663d55704469/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=75a1aaa1f9341e558b6efe9227cf663d55704469",
            "patch": "@@ -35,7 +35,8 @@\n     Person, Persona, Picture, Podcast, Section, Subscriber, Vodcast,\n     Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit,\n     Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee,\n-    Question, Answer, Inquisition, Actor, FoodDelivery)\n+    Question, Answer, Inquisition, Actor, FoodDelivery,\n+    RowLevelChangePermissionModel)\n \n \n class AdminViewBasicTest(TestCase):\n@@ -792,6 +793,40 @@ def testChangeView(self):\n                         'Plural error message not found in response to post with multiple errors.')\n         self.client.get('/test_admin/admin/logout/')\n \n+        # Test redirection when using row-level change permissions. Refs #11513.\n+        RowLevelChangePermissionModel.objects.create(name=\"odd id\")\n+        RowLevelChangePermissionModel.objects.create(name=\"even id\")\n+        for login_dict in [self.super_login, self.changeuser_login, self.adduser_login, self.deleteuser_login]:\n+            self.client.post('/test_admin/admin/', login_dict)\n+            request = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/1/')\n+            self.assertEqual(request.status_code, 403)\n+            request = self.client.post('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/1/', {'name': 'changed'})\n+            self.assertEquals(RowLevelChangePermissionModel.objects.get(id=1).name, 'odd id')\n+            self.assertEqual(request.status_code, 403)\n+            request = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/2/')\n+            self.assertEqual(request.status_code, 200)\n+            request = self.client.post('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/2/', {'name': 'changed'})\n+            self.assertEquals(RowLevelChangePermissionModel.objects.get(id=2).name, 'changed')\n+            self.assertRedirects(request, '/test_admin/admin/')\n+            self.client.get('/test_admin/admin/logout/')\n+        for login_dict in [self.joepublic_login, self.no_username_login]:\n+            self.client.post('/test_admin/admin/', login_dict)\n+            request = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/1/')\n+            self.assertEqual(request.status_code, 200)\n+            self.assertContains(request, 'login-form')\n+            request = self.client.post('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/1/', {'name': 'changed'})\n+            self.assertEquals(RowLevelChangePermissionModel.objects.get(id=1).name, 'odd id')\n+            self.assertEqual(request.status_code, 200)\n+            self.assertContains(request, 'login-form')\n+            request = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/2/')\n+            self.assertEqual(request.status_code, 200)\n+            self.assertContains(request, 'login-form')\n+            request = self.client.post('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/2/', {'name': 'changed again'})\n+            self.assertEquals(RowLevelChangePermissionModel.objects.get(id=2).name, 'changed')\n+            self.assertEqual(request.status_code, 200)\n+            self.assertContains(request, 'login-form')\n+            self.client.get('/test_admin/admin/logout/')\n+\n     def testConditionallyShowAddSectionLink(self):\n         \"\"\"\n         The foreign key widget should only show the \"add related\" button if the"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 51,
        "deletions": 2
    }
}