{
    "author": "jezdez",
    "message": "Fixed #15206 -- Added select_related call to the permissions field of the GroupAdmin to lower the number of queries. Thanks, Chris Adams.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16620 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "283526a5a6854d1ba43f2b277d43cdd2b7f19c54",
    "files": [
        {
            "sha": "24d45e33bcb6766abd201dc3657a8aa69e5f0ce5",
            "filename": "django/contrib/auth/admin.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/283526a5a6854d1ba43f2b277d43cdd2b7f19c54/django%2Fcontrib%2Fauth%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/283526a5a6854d1ba43f2b277d43cdd2b7f19c54/django%2Fcontrib%2Fauth%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fadmin.py?ref=283526a5a6854d1ba43f2b277d43cdd2b7f19c54",
            "patch": "@@ -21,6 +21,15 @@ class GroupAdmin(admin.ModelAdmin):\n     ordering = ('name',)\n     filter_horizontal = ('permissions',)\n \n+    def formfield_for_manytomany(self, db_field, request=None, **kwargs):\n+        if db_field.name == 'permissions':\n+            qs = kwargs.get('queryset', db_field.rel.to.objects)\n+            # Avoid a major performance hit resolving permission names which\n+            # triggers a content_type load:\n+            kwargs['queryset'] = qs.select_related('content_type')\n+        return super(GroupAdmin, self).formfield_for_manytomany(db_field, request=request, **kwargs)\n+\n+\n class UserAdmin(admin.ModelAdmin):\n     add_form_template = 'admin/auth/user/add_form.html'\n     change_user_password_template = None"
        },
        {
            "sha": "0d1628c3669aaac2fc3f46d9392f5164869f8bfa",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/283526a5a6854d1ba43f2b277d43cdd2b7f19c54/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/283526a5a6854d1ba43f2b277d43cdd2b7f19c54/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=283526a5a6854d1ba43f2b277d43cdd2b7f19c54",
            "patch": "@@ -12,7 +12,7 @@\n from django.core.urlresolvers import reverse\n # Register auth models with the admin.\n from django.contrib.auth import REDIRECT_FIELD_NAME, admin\n-from django.contrib.auth.models import User, Permission, UNUSABLE_PASSWORD\n+from django.contrib.auth.models import Group, User, Permission, UNUSABLE_PASSWORD\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.admin.models import LogEntry, DELETION\n from django.contrib.admin.sites import LOGIN_FORM_KEY\n@@ -2911,6 +2911,44 @@ def test_save_add_another_button(self):\n         self.assertEqual(User.objects.count(), user_count + 1)\n         self.assertNotEqual(new_user.password, UNUSABLE_PASSWORD)\n \n+    def test_user_permission_performance(self):\n+        u = User.objects.all()[0]\n+\n+        with self.assertNumQueries(7):\n+            response = self.client.get('/test_admin/admin/auth/user/%s/' % u.pk)\n+            self.assertEqual(response.status_code, 200)\n+\n+\n+class GroupAdminTest(TestCase):\n+    \"\"\"\n+    Tests group CRUD functionality.\n+    \"\"\"\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def tearDown(self):\n+        self.client.logout()\n+\n+    def test_save_button(self):\n+        group_count = Group.objects.count()\n+        response = self.client.post('/test_admin/admin/auth/group/add/', {\n+            'name': 'newgroup',\n+        })\n+\n+        new_group = Group.objects.order_by('-id')[0]\n+        self.assertRedirects(response, '/test_admin/admin/auth/group/')\n+        self.assertEqual(Group.objects.count(), group_count + 1)\n+\n+    def test_group_permission_performance(self):\n+        g = Group.objects.create(name=\"test_group\")\n+\n+        with self.assertNumQueries(6):  # instead of 259!\n+            response = self.client.get('/test_admin/admin/auth/group/%s/' % g.pk)\n+            self.assertEqual(response.status_code, 200)\n+\n+\n try:\n     import docutils\n except ImportError:"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 48,
        "deletions": 1
    }
}