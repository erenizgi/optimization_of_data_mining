{
    "author": "aaugustin",
    "message": "Fixed #18224 -- Changed the dev version number.\n\nFollowing the move from SVN to git.",
    "sha": "02a5b41db4ff8544f93a5d9854b346a9aae4f556",
    "files": [
        {
            "sha": "85cf02c9a4da1295551802e9ef0ca3c954b5fa89",
            "filename": "django/__init__.py",
            "status": "modified",
            "additions": 28,
            "deletions": 5,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/02a5b41db4ff8544f93a5d9854b346a9aae4f556/django%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/02a5b41db4ff8544f93a5d9854b346a9aae4f556/django%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2F__init__.py?ref=02a5b41db4ff8544f93a5d9854b346a9aae4f556",
            "patch": "@@ -1,5 +1,11 @@\n+import datetime\n+import os\n+import subprocess\n+\n+\n VERSION = (1, 5, 0, 'alpha', 0)\n \n+\n def get_version(version=None):\n     \"\"\"Derives a PEP386-compliant version number from VERSION.\"\"\"\n     if version is None:\n@@ -17,14 +23,31 @@ def get_version(version=None):\n \n     sub = ''\n     if version[3] == 'alpha' and version[4] == 0:\n-        # At the toplevel, this would cause an import loop.\n-        from django.utils.version import get_svn_revision\n-        svn_revision = get_svn_revision()[4:]\n-        if svn_revision != 'unknown':\n-            sub = '.dev%s' % svn_revision\n+        git_changeset = get_git_changeset()\n+        if git_changeset:\n+            sub = '.dev%s' % git_changeset\n \n     elif version[3] != 'final':\n         mapping = {'alpha': 'a', 'beta': 'b', 'rc': 'c'}\n         sub = mapping[version[3]] + str(version[4])\n \n     return main + sub\n+\n+\n+def get_git_changeset():\n+    \"\"\"Returns a numeric identifier of the latest git changeset.\n+\n+    The result is the UTC timestamp of the changeset in YYYYMMDDHHMMSS format.\n+    This value isn't guaranteed to be unique but collisions are very unlikely,\n+    so it's sufficient for generating the development version numbers.\n+    \"\"\"\n+    repo_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\n+    git_show = subprocess.Popen('git show --pretty=format:%ct --quiet HEAD',\n+            stdout=subprocess.PIPE, stderr=subprocess.PIPE,\n+            shell=True, cwd=repo_dir, universal_newlines=True)\n+    timestamp = git_show.communicate()[0].partition('\\n')[0]\n+    try:\n+        timestamp = datetime.datetime.utcfromtimestamp(int(timestamp))\n+    except ValueError:\n+        return None\n+    return timestamp.strftime('%Y%m%d%H%M%S')"
        },
        {
            "sha": "cb8623b1036bbffd4c0de2d808577a36b936eb42",
            "filename": "django/utils/version.py",
            "status": "removed",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/905bd7fb44a0dbd0be0d455ab428c388714ae700/django%2Futils%2Fversion.py",
            "raw_url": "https://github.com/django/django/raw/905bd7fb44a0dbd0be0d455ab428c388714ae700/django%2Futils%2Fversion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fversion.py?ref=905bd7fb44a0dbd0be0d455ab428c388714ae700",
            "patch": "@@ -1,41 +0,0 @@\n-import django\n-import re\n-\n-def get_svn_revision(path=None):\n-    \"\"\"\n-    Returns the SVN revision in the form SVN-XXXX,\n-    where XXXX is the revision number.\n-\n-    Returns SVN-unknown if anything goes wrong, such as an unexpected\n-    format of internal SVN files.\n-\n-    If path is provided, it should be a directory whose SVN info you want to\n-    inspect. If it's not provided, this will use the root django/ package\n-    directory.\n-    \"\"\"\n-    rev = None\n-    if path is None:\n-        path = django.__path__[0]\n-    entries_path = '%s/.svn/entries' % path\n-\n-    try:\n-        entries = open(entries_path, 'r').read()\n-    except IOError:\n-        pass\n-    else:\n-        # Versions >= 7 of the entries file are flat text.  The first line is\n-        # the version number. The next set of digits after 'dir' is the revision.\n-        if re.match('(\\d+)', entries):\n-            rev_match = re.search('\\d+\\s+dir\\s+(\\d+)', entries)\n-            if rev_match:\n-                rev = rev_match.groups()[0]\n-        # Older XML versions of the file specify revision as an attribute of\n-        # the first entries node.\n-        else:\n-            from xml.dom import minidom\n-            dom = minidom.parse(entries_path)\n-            rev = dom.getElementsByTagName('entry')[0].getAttribute('revision')\n-\n-    if rev:\n-        return u'SVN-%s' % rev\n-    return u'SVN-unknown'"
        },
        {
            "sha": "9b849ee4ba267f0eef3e8a032142a2c485a93078",
            "filename": "tests/regressiontests/version/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/02a5b41db4ff8544f93a5d9854b346a9aae4f556/tests%2Fregressiontests%2Fversion%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/02a5b41db4ff8544f93a5d9854b346a9aae4f556/tests%2Fregressiontests%2Fversion%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fversion%2Ftests.py?ref=02a5b41db4ff8544f93a5d9854b346a9aae4f556",
            "patch": "@@ -8,7 +8,7 @@ class VersionTests(TestCase):\n     def test_development(self):\n         ver_tuple = (1, 4, 0, 'alpha', 0)\n         # This will return a different result when it's run within or outside\n-        # of a SVN checkout: 1.4.devNNNNN or 1.4.\n+        # of a git clone: 1.4.devYYYYMMDDHHMMSS or 1.4.\n         ver_string = get_version(ver_tuple)\n         self.assertRegexpMatches(ver_string, r'1\\.4(\\.dev\\d+)?')\n "
        }
    ],
    "stats": {
        "total": 76,
        "additions": 29,
        "deletions": 47
    }
}