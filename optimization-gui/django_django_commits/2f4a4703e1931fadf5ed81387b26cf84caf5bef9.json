{
    "author": "unknown",
    "message": "Fixed #19758 -- Avoided leaking email existence through the password reset form.",
    "sha": "2f4a4703e1931fadf5ed81387b26cf84caf5bef9",
    "files": [
        {
            "sha": "98471041b569c4625198f9e87bc34acf919b98da",
            "filename": "django/contrib/admin/templates/registration/password_reset_done.html",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fadmin%2Ftemplates%2Fregistration%2Fpassword_reset_done.html",
            "raw_url": "https://github.com/django/django/raw/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fadmin%2Ftemplates%2Fregistration%2Fpassword_reset_done.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fregistration%2Fpassword_reset_done.html?ref=2f4a4703e1931fadf5ed81387b26cf84caf5bef9",
            "patch": "@@ -14,6 +14,8 @@\n \n <h1>{% trans 'Password reset successful' %}</h1>\n \n-<p>{% trans \"We've emailed you instructions for setting your password to the email address you submitted. You should be receiving it shortly.\" %}</p>\n+<p>{% trans \"We've emailed you instructions for setting your password. You should be receiving them shortly.\" %}</p>\n+\n+<p>{% trans \"If you don't receive an email, please make sure you've entered the address you registered with, and check your spam folder.\" %}</p>\n \n {% endblock %}"
        },
        {
            "sha": "c28971b94def82b827a2d7e4ad31d1f46ee3665d",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 8,
            "deletions": 24,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=2f4a4703e1931fadf5ed81387b26cf84caf5bef9",
            "patch": "@@ -206,31 +206,8 @@ def get_user(self):\n \n \n class PasswordResetForm(forms.Form):\n-    error_messages = {\n-        'unknown': _(\"That email address doesn't have an associated \"\n-                     \"user account. Are you sure you've registered?\"),\n-        'unusable': _(\"The user account associated with this email \"\n-                      \"address cannot reset the password.\"),\n-    }\n     email = forms.EmailField(label=_(\"Email\"), max_length=254)\n \n-    def clean_email(self):\n-        \"\"\"\n-        Validates that an active user exists with the given email address.\n-        \"\"\"\n-        UserModel = get_user_model()\n-        email = self.cleaned_data[\"email\"]\n-        self.users_cache = UserModel._default_manager.filter(email__iexact=email)\n-        if not len(self.users_cache):\n-            raise forms.ValidationError(self.error_messages['unknown'])\n-        if not any(user.is_active for user in self.users_cache):\n-            # none of the filtered users are active\n-            raise forms.ValidationError(self.error_messages['unknown'])\n-        if any((user.password == UNUSABLE_PASSWORD)\n-               for user in self.users_cache):\n-            raise forms.ValidationError(self.error_messages['unusable'])\n-        return email\n-\n     def save(self, domain_override=None,\n              subject_template_name='registration/password_reset_subject.txt',\n              email_template_name='registration/password_reset_email.html',\n@@ -241,7 +218,14 @@ def save(self, domain_override=None,\n         user.\n         \"\"\"\n         from django.core.mail import send_mail\n-        for user in self.users_cache:\n+        UserModel = get_user_model()\n+        email = self.cleaned_data[\"email\"]\n+        users = UserModel._default_manager.filter(email__iexact=email)\n+        for user in users:\n+            # Make sure that no email is sent to a user that actually has\n+            # a password marked as unusable\n+            if user.password == UNUSABLE_PASSWORD:\n+                continue\n             if not domain_override:\n                 current_site = get_current_site(request)\n                 site_name = current_site.name"
        },
        {
            "sha": "781b917517c0a39788de8b775e5f64c411c47a0e",
            "filename": "django/contrib/auth/tests/forms.py",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py?ref=2f4a4703e1931fadf5ed81387b26cf84caf5bef9",
            "patch": "@@ -326,20 +326,28 @@ def test_invalid_email(self):\n                          [force_text(EmailField.default_error_messages['invalid'])])\n \n     def test_nonexistant_email(self):\n-        # Test nonexistant email address\n+        # Test nonexistant email address. This should not fail because it would\n+        # expose information about registered users.\n         data = {'email': 'foo@bar.com'}\n         form = PasswordResetForm(data)\n-        self.assertFalse(form.is_valid())\n-        self.assertEqual(form.errors,\n-                         {'email': [force_text(form.error_messages['unknown'])]})\n+        self.assertTrue(form.is_valid())\n+        self.assertEquals(len(mail.outbox), 0)\n \n+    @override_settings(\n+        TEMPLATE_LOADERS=('django.template.loaders.filesystem.Loader',),\n+        TEMPLATE_DIRS=(\n+            os.path.join(os.path.dirname(upath(__file__)), 'templates'),\n+        ),\n+    )\n     def test_cleaned_data(self):\n         # Regression test\n         (user, username, email) = self.create_dummy_user()\n         data = {'email': email}\n         form = PasswordResetForm(data)\n         self.assertTrue(form.is_valid())\n+        form.save(domain_override='example.com')\n         self.assertEqual(form.cleaned_data['email'], email)\n+        self.assertEqual(len(mail.outbox), 1)\n \n     @override_settings(\n         TEMPLATE_LOADERS=('django.template.loaders.filesystem.Loader',),\n@@ -373,7 +381,8 @@ def test_inactive_user(self):\n         user.is_active = False\n         user.save()\n         form = PasswordResetForm({'email': email})\n-        self.assertFalse(form.is_valid())\n+        self.assertTrue(form.is_valid())\n+        self.assertEqual(len(mail.outbox), 0)\n \n     def test_unusable_password(self):\n         user = User.objects.create_user('testuser', 'test@example.com', 'test')\n@@ -383,9 +392,10 @@ def test_unusable_password(self):\n         user.set_unusable_password()\n         user.save()\n         form = PasswordResetForm(data)\n-        self.assertFalse(form.is_valid())\n-        self.assertEqual(form[\"email\"].errors,\n-                         [_(\"The user account associated with this email address cannot reset the password.\")])\n+        # The form itself is valid, but no email is sent\n+        self.assertTrue(form.is_valid())\n+        form.save()\n+        self.assertEquals(len(mail.outbox), 0)\n \n \n class ReadOnlyPasswordHashTest(TestCase):"
        },
        {
            "sha": "b41c7198f56ba3c2da978593a2b88cbb0a74d4d7",
            "filename": "django/contrib/auth/tests/views.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py?ref=2f4a4703e1931fadf5ed81387b26cf84caf5bef9",
            "patch": "@@ -86,11 +86,12 @@ def test_named_urls(self):\n class PasswordResetTest(AuthViewsTestCase):\n \n     def test_email_not_found(self):\n-        \"Error is raised if the provided email address isn't currently registered\"\n+        \"\"\"If the provided email is not registered, don't raise any error but\n+        also don't send any email.\"\"\"\n         response = self.client.get('/password_reset/')\n         self.assertEqual(response.status_code, 200)\n         response = self.client.post('/password_reset/', {'email': 'not_a_real_email@email.com'})\n-        self.assertFormError(response, PasswordResetForm.error_messages['unknown'])\n+        self.assertEqual(response.status_code, 302)\n         self.assertEqual(len(mail.outbox), 0)\n \n     def test_email_found(self):"
        },
        {
            "sha": "d82731f73bfe88534dd8d5043765e08382d4c7cb",
            "filename": "docs/topics/auth/default.txt",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/docs%2Ftopics%2Fauth%2Fdefault.txt",
            "raw_url": "https://github.com/django/django/raw/2f4a4703e1931fadf5ed81387b26cf84caf5bef9/docs%2Ftopics%2Fauth%2Fdefault.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth%2Fdefault.txt?ref=2f4a4703e1931fadf5ed81387b26cf84caf5bef9",
            "patch": "@@ -743,10 +743,24 @@ patterns.\n     that can be used to reset the password, and sending that link to the\n     user's registered email address.\n \n+    If the email address provided does not exist in the system, this view\n+    won't send an email, but the user won't receive any error message either.\n+    This prevents information leaking to potential attackers. If you want to\n+    provide an error message in this case, you can subclass\n+    :class:`~django.contrib.auth.forms.PasswordResetForm` and use the\n+    ``password_reset_form`` argument.\n+\n+\n     Users flagged with an unusable password (see\n     :meth:`~django.contrib.auth.models.User.set_unusable_password()` aren't\n     allowed to request a password reset to prevent misuse when using an\n-    external authentication source like LDAP.\n+    external authentication source like LDAP. Note that they won't receive any\n+    error message since this would expose their account's existence but no\n+    mail will be sent either.\n+\n+    .. versionchanged:: 1.6\n+        Previously, error messages indicated whether a given email was\n+        registered.\n \n     **URL name:** ``password_reset``\n "
        }
    ],
    "stats": {
        "total": 83,
        "additions": 47,
        "deletions": 36
    }
}