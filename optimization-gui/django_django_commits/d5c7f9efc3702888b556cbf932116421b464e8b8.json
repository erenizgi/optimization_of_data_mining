{
    "author": "akaariai",
    "message": "Fixed #18304 -- Optimized save() when update_can_self_select=False\n\nDatabases with update_can_self_select = False (MySQL for example)\ngenerated non-necessary queries when saving a multitable inherited\nmodel, and when the save resulted in update.",
    "sha": "d5c7f9efc3702888b556cbf932116421b464e8b8",
    "files": [
        {
            "sha": "36d45b7cb610d6864c567785d43d1e31cf9a965c",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/d5c7f9efc3702888b556cbf932116421b464e8b8/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/d5c7f9efc3702888b556cbf932116421b464e8b8/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=d5c7f9efc3702888b556cbf932116421b464e8b8",
            "patch": "@@ -1015,6 +1015,12 @@ def pre_sql_setup(self):\n         query.extra = {}\n         query.select = []\n         query.add_fields([query.model._meta.pk.name])\n+        # Recheck the count - it is possible that fiddling with the select\n+        # fields above removes tables from the query. Refs #18304.\n+        count = query.count_active_tables()\n+        if not self.query.related_updates and count == 1:\n+            return\n+\n         must_pre_select = count > 1 and not self.connection.features.update_can_self_select\n \n         # Now we adjust the current query: reset the where clause and get rid"
        },
        {
            "sha": "695d3f836c68f9b5b348887583fcb72f7f81352c",
            "filename": "tests/modeltests/model_inheritance/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/d5c7f9efc3702888b556cbf932116421b464e8b8/tests%2Fmodeltests%2Fmodel_inheritance%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d5c7f9efc3702888b556cbf932116421b464e8b8/tests%2Fmodeltests%2Fmodel_inheritance%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_inheritance%2Ftests.py?ref=d5c7f9efc3702888b556cbf932116421b464e8b8",
            "patch": "@@ -275,3 +275,21 @@ def test_multiple_table(self):\n     def test_mixin_init(self):\n         m = MixinModel()\n         self.assertEqual(m.other_attr, 1)\n+\n+    def test_update_query_counts(self):\n+        \"\"\"\n+        Test that update queries do not generate non-necessary queries.\n+        Refs #18304.\n+        \"\"\"\n+        c = Chef.objects.create(name=\"Albert\")\n+        ir = ItalianRestaurant.objects.create(\n+            name=\"Ristorante Miron\",\n+            address=\"1234 W. Ash\",\n+            serves_hot_dogs=False,\n+            serves_pizza=False,\n+            serves_gnocchi=True,\n+            rating=4,\n+            chef=c\n+        )\n+        with self.assertNumQueries(6):\n+            ir.save()"
        },
        {
            "sha": "e843bd7ab94dbfe07105b0984d1158fdeb74b888",
            "filename": "tests/modeltests/update_only_fields/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/d5c7f9efc3702888b556cbf932116421b464e8b8/tests%2Fmodeltests%2Fupdate_only_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d5c7f9efc3702888b556cbf932116421b464e8b8/tests%2Fmodeltests%2Fupdate_only_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fupdate_only_fields%2Ftests.py?ref=d5c7f9efc3702888b556cbf932116421b464e8b8",
            "patch": "@@ -1,6 +1,6 @@\n from __future__ import absolute_import\n \n-from django.test import TestCase, skipUnlessDBFeature\n+from django.test import TestCase\n from django.db.models.signals import pre_save, post_save\n from .models import Person, Employee, ProxyEmployee, Profile, Account\n \n@@ -123,9 +123,6 @@ def post_save_receiver(**kwargs):\n         self.assertEqual(len(pre_save_data), 0)\n         self.assertEqual(len(post_save_data), 0)\n \n-    # A bug in SQLUpdateCompiler prevents this test from succeeding on MySQL\n-    # Require update_can_self_select for this test for now. Refs #18304.\n-    @skipUnlessDBFeature('update_can_self_select')\n     def test_num_queries_inheritance(self):\n         s = Employee.objects.create(name='Sara', gender='F')\n         s.employee_num = 1"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 25,
        "deletions": 4
    }
}