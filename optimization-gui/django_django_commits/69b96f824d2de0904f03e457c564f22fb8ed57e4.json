{
    "author": "ramiro",
    "message": "Fixed #16329 -- Fixed detection of transaction-handling capabilities when all test databases are sqlite3, in-memory.\n\nThanks canassa for the report and agriffis (#17762) and lrekucki (in #17758) for their contribution to the fix.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17702 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "69b96f824d2de0904f03e457c564f22fb8ed57e4",
    "files": [
        {
            "sha": "5f55e3927c00e204ede517310c51b6d9e2d4f465",
            "filename": "django/db/backends/sqlite3/creation.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/69b96f824d2de0904f03e457c564f22fb8ed57e4/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/69b96f824d2de0904f03e457c564f22fb8ed57e4/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py?ref=69b96f824d2de0904f03e457c564f22fb8ed57e4",
            "patch": "@@ -72,3 +72,18 @@ def _destroy_test_db(self, test_database_name, verbosity):\n \n     def set_autocommit(self):\n         self.connection.connection.isolation_level = None\n+\n+    def test_db_signature(self):\n+        \"\"\"\n+        Returns a tuple that uniquely identifies a test database.\n+\n+        This takes into account the special cases of \":memory:\" and \"\" for\n+        SQLite since the databases will be distinct despite having the same\n+        TEST_NAME. See http://www.sqlite.org/inmemorydb.html\n+        \"\"\"\n+        settings_dict = self.connection.settings_dict\n+        test_dbname = self._get_test_db_name()\n+        sig = [self.connection.settings_dict['NAME']]\n+        if test_dbname == ':memory:':\n+            sig.append(self.connection.alias)\n+        return tuple(sig)"
        },
        {
            "sha": "12a28f9fcb33272be450a138a3cec8c482b4e9c6",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/69b96f824d2de0904f03e457c564f22fb8ed57e4/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/69b96f824d2de0904f03e457c564f22fb8ed57e4/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=69b96f824d2de0904f03e457c564f22fb8ed57e4",
            "patch": "@@ -11,6 +11,7 @@\n from django.core.management import call_command\n from django.test import simple\n from django.test.simple import DjangoTestSuiteRunner, get_tests\n+from django.test.testcases import connections_support_transactions\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import unittest\n from django.utils.importlib import import_module\n@@ -262,3 +263,38 @@ def test_import_error(self):\n         \"Test for #12658 - Tests with ImportError's shouldn't fail silently\"\n         module = import_module(TEST_APP_ERROR)\n         self.assertRaises(ImportError, get_tests, module)\n+\n+\n+class Sqlite3InMemoryTestDbs(unittest.TestCase):\n+    def test_transaction_support(self):\n+        \"\"\"Ticket #16329: sqlite3 in-memory test databases\"\"\"\n+        from django import db\n+        old_db_connections = db.connections\n+        for option in ('NAME', 'TEST_NAME'):\n+            try:\n+                db.connections = db.ConnectionHandler({\n+                    'default': {\n+                        'ENGINE': 'django.db.backends.sqlite3',\n+                        option: ':memory:',\n+                    },\n+                    'other': {\n+                        'ENGINE': 'django.db.backends.sqlite3',\n+                        option: ':memory:',\n+                    },\n+                })\n+                other = db.connections['other']\n+                self.assertEqual(other.features.supports_transactions, None)\n+                DjangoTestSuiteRunner(verbosity=0).setup_databases()\n+                # Transaction support should be properly initialised for the 'other' DB\n+                self.assertNotEqual(\n+                    other.features.supports_transactions,\n+                    None,\n+                    \"DATABASES setting '%s' option set to sqlite3's ':memory:' value causes problems with transaction support detection.\" % option\n+                )\n+                # And all the DBs should report that they support transactions\n+                self.assertTrue(\n+                    connections_support_transactions(),\n+                    \"DATABASES setting '%s' option set to sqlite3's ':memory:' value causes problems with transaction support detection.\" % option\n+                )\n+            finally:\n+                db.connections = old_db_connections"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 51,
        "deletions": 0
    }
}