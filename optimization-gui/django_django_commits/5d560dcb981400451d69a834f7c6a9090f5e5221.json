{
    "author": "aaugustin",
    "message": "Fixed #18504 -- Computed |naturalday in local time.",
    "sha": "5d560dcb981400451d69a834f7c6a9090f5e5221",
    "files": [
        {
            "sha": "8f6c2602c93ecb2ed6adcb0e28cdcbb586738f0d",
            "filename": "django/contrib/humanize/templatetags/humanize.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/5d560dcb981400451d69a834f7c6a9090f5e5221/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "raw_url": "https://github.com/django/django/raw/5d560dcb981400451d69a834f7c6a9090f5e5221/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py?ref=5d560dcb981400451d69a834f7c6a9090f5e5221",
            "patch": "@@ -1,6 +1,6 @@\n from __future__ import unicode_literals\n import re\n-from datetime import date, datetime, timedelta\n+from datetime import date, datetime\n \n from django import template\n from django.conf import settings\n@@ -143,7 +143,9 @@ def apnumber(value):\n         return value\n     return (_('one'), _('two'), _('three'), _('four'), _('five'), _('six'), _('seven'), _('eight'), _('nine'))[value-1]\n \n-@register.filter\n+# Perform the comparison in the default time zone when USE_TZ = True\n+# (unless a specific time zone has been applied with the |timezone filter).\n+@register.filter(expects_localtime=True)\n def naturalday(value, arg=None):\n     \"\"\"\n     For date values that are tomorrow, today or yesterday compared to\n@@ -169,6 +171,8 @@ def naturalday(value, arg=None):\n         return _('yesterday')\n     return defaultfilters.date(value, arg)\n \n+# This filter doesn't require expects_localtime=True because it deals properly\n+# with both naive and aware datetimes. Therefore avoid the cost of conversion.\n @register.filter\n def naturaltime(value):\n     \"\"\""
        },
        {
            "sha": "a0f13d3ee9418d8d46a62bfb456612e154a14998",
            "filename": "django/contrib/humanize/tests.py",
            "status": "modified",
            "additions": 47,
            "deletions": 25,
            "changes": 72,
            "blob_url": "https://github.com/django/django/blob/5d560dcb981400451d69a834f7c6a9090f5e5221/django%2Fcontrib%2Fhumanize%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5d560dcb981400451d69a834f7c6a9090f5e5221/django%2Fcontrib%2Fhumanize%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftests.py?ref=5d560dcb981400451d69a834f7c6a9090f5e5221",
            "patch": "@@ -1,13 +1,31 @@\n from __future__ import unicode_literals\n import datetime\n-import new\n \n+from django.contrib.humanize.templatetags import humanize\n from django.template import Template, Context, defaultfilters\n from django.test import TestCase\n-from django.utils import translation, tzinfo\n-from django.utils.translation import ugettext as _\n+from django.test.utils import override_settings\n from django.utils.html import escape\n from django.utils.timezone import utc\n+from django.utils import translation\n+from django.utils.translation import ugettext as _\n+from django.utils import tzinfo\n+\n+\n+# Mock out datetime in some tests so they don't fail occasionally when they\n+# run too slow. Use a fixed datetime for datetime.now(). DST change in\n+# America/Chicago (the default time zone) happened on March 11th in 2012.\n+\n+now = datetime.datetime(2012, 3, 9, 22, 30)\n+\n+class MockDateTime(datetime.datetime):\n+    @classmethod\n+    def now(self, tz=None):\n+        if tz is None or tz.utcoffset(now) is None:\n+            return now\n+        else:\n+            # equals now.replace(tzinfo=utc)\n+            return now.replace(tzinfo=tz) + tz.utcoffset(now)\n \n \n class HumanizeTests(TestCase):\n@@ -109,28 +127,36 @@ def test_naturalday(self):\n         self.humanize_tester(test_list, result_list, 'naturalday')\n \n     def test_naturalday_tz(self):\n-        from django.contrib.humanize.templatetags.humanize import naturalday\n-\n         today = datetime.date.today()\n         tz_one = tzinfo.FixedOffset(datetime.timedelta(hours=-12))\n         tz_two = tzinfo.FixedOffset(datetime.timedelta(hours=12))\n \n         # Can be today or yesterday\n         date_one = datetime.datetime(today.year, today.month, today.day, tzinfo=tz_one)\n-        naturalday_one = naturalday(date_one)\n+        naturalday_one = humanize.naturalday(date_one)\n         # Can be today or tomorrow\n         date_two = datetime.datetime(today.year, today.month, today.day, tzinfo=tz_two)\n-        naturalday_two = naturalday(date_two)\n+        naturalday_two = humanize.naturalday(date_two)\n \n         # As 24h of difference they will never be the same\n         self.assertNotEqual(naturalday_one, naturalday_two)\n \n+    def test_naturalday_uses_localtime(self):\n+        # Regression for #18504\n+        # This is 2012-03-08HT19:30:00-06:00 in Ameria/Chicago\n+        dt = datetime.datetime(2012, 3, 9, 1, 30, tzinfo=utc)\n+\n+        orig_humanize_datetime, humanize.datetime = humanize.datetime, MockDateTime\n+        try:\n+            with override_settings(USE_TZ=True):\n+                self.humanize_tester([dt], ['yesterday'], 'naturalday')\n+        finally:\n+            humanize.datetime = orig_humanize_datetime\n+\n     def test_naturaltime(self):\n         class naive(datetime.tzinfo):\n             def utcoffset(self, dt):\n                 return None\n-        # we're going to mock datetime.datetime, so use a fixed datetime\n-        now = datetime.datetime(2011, 8, 15, 1, 23)\n         test_list = [\n             now,\n             now - datetime.timedelta(seconds=1),\n@@ -148,6 +174,7 @@ def utcoffset(self, dt):\n             now + datetime.timedelta(hours=1, minutes=30, seconds=30),\n             now + datetime.timedelta(hours=23, minutes=50, seconds=50),\n             now + datetime.timedelta(days=1),\n+            now + datetime.timedelta(days=2, hours=6),\n             now + datetime.timedelta(days=500),\n             now.replace(tzinfo=naive()),\n             now.replace(tzinfo=utc),\n@@ -169,27 +196,22 @@ def utcoffset(self, dt):\n             'an hour from now',\n             '23 hours from now',\n             '1 day from now',\n+            '2 days, 6 hours from now',\n             '1 year, 4 months from now',\n             'now',\n             'now',\n         ]\n-\n-        # mock out datetime so these tests don't fail occasionally when the\n-        # test runs too slow\n-        class MockDateTime(datetime.datetime):\n-            @classmethod\n-            def now(self, tz=None):\n-                if tz is None or tz.utcoffset(now) is None:\n-                    return now\n-                else:\n-                    # equals now.replace(tzinfo=utc)\n-                    return now.replace(tzinfo=tz) + tz.utcoffset(now)\n-\n-        from django.contrib.humanize.templatetags import humanize\n-        orig_humanize_datetime = humanize.datetime\n-        humanize.datetime = MockDateTime\n-\n+        # Because of the DST change, 2 days and 6 hours after the chosen\n+        # date in naive arithmetic is only 2 days and 5 hours after in\n+        # aware arithmetic.\n+        result_list_with_tz_support = result_list[:]\n+        assert result_list_with_tz_support[-4] == '2 days, 6 hours from now'\n+        result_list_with_tz_support[-4] == '2 days, 5 hours from now'\n+\n+        orig_humanize_datetime, humanize.datetime = humanize.datetime, MockDateTime\n         try:\n             self.humanize_tester(test_list, result_list, 'naturaltime')\n+            with override_settings(USE_TZ=True):\n+                self.humanize_tester(test_list, result_list_with_tz_support, 'naturaltime')\n         finally:\n             humanize.datetime = orig_humanize_datetime"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 53,
        "deletions": 27
    }
}