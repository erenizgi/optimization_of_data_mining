{
    "author": "claudep",
    "message": "Fixed #18906 -- Ignored to-be-deleted forms in formset validate_unique\n\nThanks c.pollock at bangor.ac.uk for the report.",
    "sha": "f44922c79516b9caf0e09fb060f20c896668b90f",
    "files": [
        {
            "sha": "1addbc617b5677a478442d7d98ad3053fd0f4466",
            "filename": "django/forms/formsets.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/f44922c79516b9caf0e09fb060f20c896668b90f/django%2Fforms%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/f44922c79516b9caf0e09fb060f20c896668b90f/django%2Fforms%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fformsets.py?ref=f44922c79516b9caf0e09fb060f20c896668b90f",
            "patch": "@@ -179,11 +179,10 @@ def cleaned_data(self):\n     @property\n     def deleted_forms(self):\n         \"\"\"\n-        Returns a list of forms that have been marked for deletion. Raises an\n-        AttributeError if deletion is not allowed.\n+        Returns a list of forms that have been marked for deletion.\n         \"\"\"\n         if not self.is_valid() or not self.can_delete:\n-            raise AttributeError(\"'%s' object has no attribute 'deleted_forms'\" % self.__class__.__name__)\n+            return []\n         # construct _deleted_form_indexes which is just a list of form indexes\n         # that have had their deletion widget set to True\n         if not hasattr(self, '_deleted_form_indexes'):"
        },
        {
            "sha": "c4e030161477f072a0f06b746971ffa88a11fae8",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 13,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/f44922c79516b9caf0e09fb060f20c896668b90f/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f44922c79516b9caf0e09fb060f20c896668b90f/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=f44922c79516b9caf0e09fb060f20c896668b90f",
            "patch": "@@ -520,9 +520,9 @@ def validate_unique(self):\n         # Collect unique_checks and date_checks to run from all the forms.\n         all_unique_checks = set()\n         all_date_checks = set()\n-        for form in self.forms:\n-            if not form.is_valid():\n-                continue\n+        forms_to_delete = self.deleted_forms\n+        valid_forms = [form for form in self.forms if form.is_valid() and form not in forms_to_delete]\n+        for form in valid_forms:\n             exclude = form._get_validation_exclusions()\n             unique_checks, date_checks = form.instance._get_unique_checks(exclude=exclude)\n             all_unique_checks = all_unique_checks.union(set(unique_checks))\n@@ -532,9 +532,7 @@ def validate_unique(self):\n         # Do each of the unique checks (unique and unique_together)\n         for uclass, unique_check in all_unique_checks:\n             seen_data = set()\n-            for form in self.forms:\n-                if not form.is_valid():\n-                    continue\n+            for form in valid_forms:\n                 # get data for each field of each of unique_check\n                 row_data = tuple([form.cleaned_data[field] for field in unique_check if field in form.cleaned_data])\n                 if row_data and not None in row_data:\n@@ -554,9 +552,7 @@ def validate_unique(self):\n         for date_check in all_date_checks:\n             seen_data = set()\n             uclass, lookup, field, unique_for = date_check\n-            for form in self.forms:\n-                if not form.is_valid():\n-                    continue\n+            for form in valid_forms:\n                 # see if we have data for both fields\n                 if (form.cleaned_data and form.cleaned_data[field] is not None\n                     and form.cleaned_data[unique_for] is not None):\n@@ -611,10 +607,7 @@ def save_existing_objects(self, commit=True):\n             return []\n \n         saved_instances = []\n-        try:\n-            forms_to_delete = self.deleted_forms\n-        except AttributeError:\n-            forms_to_delete = []\n+        forms_to_delete = self.deleted_forms\n         for form in self.initial_forms:\n             pk_name = self._pk_field.name\n             raw_pk_value = form._raw_value(pk_name)"
        },
        {
            "sha": "50ee3c73fb0567fadd7cf51f93fd338e2730fe8e",
            "filename": "tests/modeltests/model_formsets/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/f44922c79516b9caf0e09fb060f20c896668b90f/tests%2Fmodeltests%2Fmodel_formsets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f44922c79516b9caf0e09fb060f20c896668b90f/tests%2Fmodeltests%2Fmodel_formsets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_formsets%2Ftests.py?ref=f44922c79516b9caf0e09fb060f20c896668b90f",
            "patch": "@@ -42,29 +42,37 @@ def test_add_form_deletion_when_invalid(self):\n         doesn't cause validation errors.\n         \"\"\"\n         PoetFormSet = modelformset_factory(Poet, can_delete=True)\n+        poet = Poet.objects.create(name='test')\n+        # One existing untouched and two new unvalid forms\n         data = {\n-            'form-TOTAL_FORMS': '1',\n-            'form-INITIAL_FORMS': '0',\n+            'form-TOTAL_FORMS': '3',\n+            'form-INITIAL_FORMS': '1',\n             'form-MAX_NUM_FORMS': '0',\n-            'form-0-id': '',\n-            'form-0-name': 'x' * 1000,\n+            'form-0-id': six.text_type(poet.id),\n+            'form-0-name': 'test',\n+            'form-1-id': '',\n+            'form-1-name': 'x' * 1000, # Too long\n+            'form-1-id': six.text_type(poet.id), # Violate unique constraint\n+            'form-1-name': 'test2',\n         }\n         formset = PoetFormSet(data, queryset=Poet.objects.all())\n         # Make sure this form doesn't pass validation.\n         self.assertEqual(formset.is_valid(), False)\n-        self.assertEqual(Poet.objects.count(), 0)\n+        self.assertEqual(Poet.objects.count(), 1)\n \n         # Then make sure that it *does* pass validation and delete the object,\n-        # even though the data isn't actually valid.\n+        # even though the data in new forms aren't actually valid.\n         data['form-0-DELETE'] = 'on'\n+        data['form-1-DELETE'] = 'on'\n+        data['form-2-DELETE'] = 'on'\n         formset = PoetFormSet(data, queryset=Poet.objects.all())\n         self.assertEqual(formset.is_valid(), True)\n         formset.save()\n         self.assertEqual(Poet.objects.count(), 0)\n \n     def test_change_form_deletion_when_invalid(self):\n         \"\"\"\n-        Make sure that an add form that is filled out, but marked for deletion\n+        Make sure that a change form that is filled out, but marked for deletion\n         doesn't cause validation errors.\n         \"\"\"\n         PoetFormSet = modelformset_factory(Poet, can_delete=True)"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 23,
        "deletions": 23
    }
}