{
    "author": "spookylukey",
    "message": "Fixed #11707 - limit_choices_to on a ForeignKey can render duplicate options in formfield\n\nThanks to Chris Wesseling for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15607 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6902824ac204d2207f50a3b788ae9d3d5947d01f",
    "files": [
        {
            "sha": "4c4e6f01e8cdb0460b6e5511385839ad778fd073",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/6902824ac204d2207f50a3b788ae9d3d5947d01f/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/6902824ac204d2207f50a3b788ae9d3d5947d01f/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=6902824ac204d2207f50a3b788ae9d3d5947d01f",
            "patch": "@@ -910,7 +910,7 @@ def formfield(self, **kwargs):\n         db = kwargs.pop('using', None)\n         defaults = {\n             'form_class': forms.ModelChoiceField,\n-            'queryset': self.rel.to._default_manager.using(db).complex_filter(self.rel.limit_choices_to),\n+            'queryset': self.rel.to._default_manager.using(db).complex_filter(self.rel.limit_choices_to).distinct(),\n             'to_field_name': self.rel.field_name,\n         }\n         defaults.update(kwargs)"
        },
        {
            "sha": "7db1f8904a4d61d1c9e902ea0f1cb4b86e783b69",
            "filename": "tests/regressiontests/model_fields/models.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/6902824ac204d2207f50a3b788ae9d3d5947d01f/tests%2Fregressiontests%2Fmodel_fields%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/6902824ac204d2207f50a3b788ae9d3d5947d01f/tests%2Fregressiontests%2Fmodel_fields%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Fmodels.py?ref=6902824ac204d2207f50a3b788ae9d3d5947d01f",
            "patch": "@@ -29,6 +29,11 @@ class Bar(models.Model):\n     b = models.CharField(max_length=10)\n     a = models.ForeignKey(Foo, default=get_foo)\n \n+class Baz(models.Model):\n+    a = models.CharField(max_length=5)\n+    #Only Foos related to Bars starting with 'a'\n+    foo = models.ForeignKey(Foo, limit_choices_to=models.Q(bar__b__startswith='a'))\n+\n class Whiz(models.Model):\n     CHOICES = (\n         ('Group 1', ("
        },
        {
            "sha": "d3f7199ec16aa60c873f3b29410df522a509f78d",
            "filename": "tests/regressiontests/model_fields/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/6902824ac204d2207f50a3b788ae9d3d5947d01f/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6902824ac204d2207f50a3b788ae9d3d5947d01f/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py?ref=6902824ac204d2207f50a3b788ae9d3d5947d01f",
            "patch": "@@ -1,5 +1,6 @@\n import datetime\n from decimal import Decimal\n+import re\n \n from django import test\n from django import forms\n@@ -8,7 +9,7 @@\n from django.db.models.fields.files import FieldFile\n from django.utils import unittest\n \n-from models import Foo, Bar, Whiz, BigD, BigS, Image, BigInt, Post, NullBooleanModel, BooleanModel, Document\n+from models import Foo, Bar, Baz, Whiz, BigD, BigS, Image, BigInt, Post, NullBooleanModel, BooleanModel, Document\n \n # If PIL available, do these tests.\n if Image:\n@@ -95,13 +96,29 @@ def test_lookup_really_big_value(self):\n         # This should not crash. That counts as a win for our purposes.\n         Foo.objects.filter(d__gte=100000000000)\n \n+class BazForm(forms.ModelForm):\n+    class Meta:\n+        model = Baz\n+\n class ForeignKeyTests(test.TestCase):\n     def test_callable_default(self):\n         \"\"\"Test the use of a lazy callable for ForeignKey.default\"\"\"\n         a = Foo.objects.create(id=1, a='abc', d=Decimal(\"12.34\"))\n         b = Bar.objects.create(b=\"bcd\")\n         self.assertEqual(b.a, a)\n \n+    def test_distinct_choice_limit(self):\n+        \"\"\"Doesn't make sense to offer the same ForeignKey multiple times in a form\"\"\"\n+        a = Foo.objects.create(a='a', d=Decimal(\"-1\"))\n+        b = Foo.objects.create(a='b', d=Decimal(\"1\"))\n+        bar_a = Bar.objects.create(b='ah', a=a)\n+        bar_b = Bar.objects.create(b='aha', a=a)\n+        bar_b = Bar.objects.create(b='bla', a=b)\n+        form = BazForm()\n+        fk_field = str(form['foo'])\n+        self.assertEqual(len(re.findall(r'value=\"2\"', fk_field)), 0)\n+        self.assertEqual(len(re.findall(r'value=\"1\"', fk_field)), 1)\n+\n class DateTimeFieldTests(unittest.TestCase):\n     def test_datetimefield_to_python_usecs(self):\n         \"\"\"DateTimeField.to_python should support usecs\"\"\""
        }
    ],
    "stats": {
        "total": 26,
        "additions": 24,
        "deletions": 2
    }
}