{
    "author": "mhlgio",
    "message": "Fixed #15915 -- Cleaned handling of duplicate permission codenames\n\nPreviously, a duplicate model, codename for permission would lead to\ndatabase integrity error. Cleaned the implementation so that this case\nnow raises an CommandError instead.",
    "sha": "8c427448d53ec0d860e1669f35deed73d0240ba1",
    "files": [
        {
            "sha": "b5fd29a1c216ab5318d9fc168d28aa35fa1d0d56",
            "filename": "django/contrib/auth/management/__init__.py",
            "status": "modified",
            "additions": 36,
            "deletions": 5,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/8c427448d53ec0d860e1669f35deed73d0240ba1/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/8c427448d53ec0d860e1669f35deed73d0240ba1/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py?ref=8c427448d53ec0d860e1669f35deed73d0240ba1",
            "patch": "@@ -9,6 +9,7 @@\n \n from django.contrib.auth import models as auth_app, get_user_model\n from django.core import exceptions\n+from django.core.management.base import CommandError\n from django.db.models import get_models, signals\n from django.utils import six\n from django.utils.six.moves import input\n@@ -18,13 +19,43 @@ def _get_permission_codename(action, opts):\n     return '%s_%s' % (action, opts.object_name.lower())\n \n \n-def _get_all_permissions(opts):\n-    \"Returns (codename, name) for all permissions in the given opts.\"\n+def _get_all_permissions(opts, ctype):\n+    \"\"\"\n+    Returns (codename, name) for all permissions in the given opts.\n+    \"\"\"\n+    builtin = _get_builtin_permissions(opts)\n+    custom = list(opts.permissions)\n+    _check_permission_clashing(custom, builtin, ctype)\n+    return builtin + custom\n+\n+def _get_builtin_permissions(opts):\n+    \"\"\"\n+    Returns (codename, name) for all autogenerated permissions.\n+    \"\"\"\n     perms = []\n     for action in ('add', 'change', 'delete'):\n-        perms.append((_get_permission_codename(action, opts), 'Can %s %s' % (action, opts.verbose_name_raw)))\n-    return perms + list(opts.permissions)\n+        perms.append((_get_permission_codename(action, opts),\n+            'Can %s %s' % (action, opts.verbose_name_raw)))\n+    return perms\n \n+def _check_permission_clashing(custom, builtin, ctype):\n+    \"\"\"\n+    Check that permissions for a model do not clash. Raises CommandError if\n+    there are duplicate permissions.\n+    \"\"\"\n+    pool = set()\n+    builtin_codenames = set(p[0] for p in builtin)\n+    for codename, _name in custom:\n+        if codename in pool:\n+            raise CommandError(\n+                \"The permission codename '%s' is duplicated for model '%s.%s'.\" %\n+                (codename, ctype.app_label, ctype.model_class().__name__))\n+        elif codename in builtin_codenames:\n+            raise CommandError(\n+                \"The permission codename '%s' clashes with a builtin permission \"\n+                \"for model '%s.%s'.\" %\n+                (codename, ctype.app_label, ctype.model_class().__name__))\n+        pool.add(codename)\n \n def create_permissions(app, created_models, verbosity, **kwargs):\n     from django.contrib.contenttypes.models import ContentType\n@@ -39,7 +70,7 @@ def create_permissions(app, created_models, verbosity, **kwargs):\n     for klass in app_models:\n         ctype = ContentType.objects.get_for_model(klass)\n         ctypes.add(ctype)\n-        for perm in _get_all_permissions(klass._meta):\n+        for perm in _get_all_permissions(klass._meta, ctype):\n             searched_perms.append((ctype, perm))\n \n     # Find all the Permissions that have a context_type for a model we're"
        },
        {
            "sha": "cab7b20f20fe635a1b68ad2a5aff66ea667900ee",
            "filename": "django/contrib/auth/tests/management.py",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/8c427448d53ec0d860e1669f35deed73d0240ba1/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/8c427448d53ec0d860e1669f35deed73d0240ba1/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py?ref=8c427448d53ec0d860e1669f35deed73d0240ba1",
            "patch": "@@ -2,6 +2,7 @@\n from datetime import date\n \n from django.contrib.auth import models, management\n+from django.contrib.auth.management import create_permissions\n from django.contrib.auth.management.commands import changepassword\n from django.contrib.auth.models import User\n from django.contrib.auth.tests import CustomUser\n@@ -167,3 +168,43 @@ def test_swappable_user_missing_required_field(self):\n             )\n \n         self.assertEqual(CustomUser.objects.count(), 0)\n+\n+\n+class PermissionDuplicationTestCase(TestCase):\n+\n+    def setUp(self):\n+        self._original_user_permission = models.User._meta.permissions\n+\n+    def tearUp(self):\n+        models.User._meta.permissions = self._original_user_permissions\n+\n+    def test_duplicated_permissions(self):\n+        \"\"\"\n+        Test that we show proper error message if we are trying to create\n+        duplicate permissions.\n+        \"\"\"\n+        # check duplicated default permission\n+        models.Permission._meta.permissions = [\n+           ('change_permission', 'Can edit permission (duplicate)')]\n+        self.assertRaisesRegexp(CommandError,\n+            \"The permission codename 'change_permission' clashes with a \"\n+            \"builtin permission for model 'auth.Permission'.\",\n+            create_permissions, models, [], verbosity=0)\n+\n+        # check duplicated custom permissions\n+        models.Permission._meta.permissions = [\n+            ('my_custom_permission', 'Some permission'),\n+            ('other_one', 'Some other permission'),\n+            ('my_custom_permission', 'Some permission with duplicate permission code'),\n+        ]\n+        self.assertRaisesRegexp(CommandError,\n+            \"The permission codename 'my_custom_permission' is duplicated for model \"\n+            \"'auth.Permission'.\",\n+            create_permissions, models, [], verbosity=0)\n+\n+        # should not raise anything\n+        models.Permission._meta.permissions = [\n+            ('my_custom_permission', 'Some permission'),\n+            ('other_one', 'Some other permission'),\n+        ]\n+        create_permissions(models, [], verbosity=0)"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 77,
        "deletions": 5
    }
}