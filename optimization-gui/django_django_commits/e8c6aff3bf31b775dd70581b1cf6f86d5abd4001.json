{
    "author": "apollo13",
    "message": "Fixed #18947 -- Don't make uploaded files executeable by default.\n\nThanks to Lauri Tirkkonen for the patch.",
    "sha": "e8c6aff3bf31b775dd70581b1cf6f86d5abd4001",
    "files": [
        {
            "sha": "650373f0c36523626e1d0c5178067b63b896fc39",
            "filename": "django/core/files/storage.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/e8c6aff3bf31b775dd70581b1cf6f86d5abd4001/django%2Fcore%2Ffiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/e8c6aff3bf31b775dd70581b1cf6f86d5abd4001/django%2Fcore%2Ffiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fstorage.py?ref=e8c6aff3bf31b775dd70581b1cf6f86d5abd4001",
            "patch": "@@ -192,7 +192,10 @@ def _save(self, name, content):\n                 else:\n                     # This fun binary flag incantation makes os.open throw an\n                     # OSError if the file already exists before we open it.\n-                    fd = os.open(full_path, os.O_WRONLY | os.O_CREAT | os.O_EXCL | getattr(os, 'O_BINARY', 0))\n+                    flags = (os.O_WRONLY | os.O_CREAT | os.O_EXCL |\n+                             getattr(os, 'O_BINARY', 0))\n+                    # The current umask value is masked out by os.open!\n+                    fd = os.open(full_path, flags, 0o666)\n                     try:\n                         locks.lock(fd, locks.LOCK_EX)\n                         _file = None"
        },
        {
            "sha": "26b6ad1bfadc53a35ba3fe4bf4c356f31d88064d",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/e8c6aff3bf31b775dd70581b1cf6f86d5abd4001/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/e8c6aff3bf31b775dd70581b1cf6f86d5abd4001/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=e8c6aff3bf31b775dd70581b1cf6f86d5abd4001",
            "patch": "@@ -333,6 +333,11 @@ Miscellaneous\n   function at :func:`django.utils.text.slugify`. Similarly, ``remove_tags`` is\n   available at :func:`django.utils.html.remove_tags`.\n \n+* Uploaded files are no longer created as executable by default. If you need\n+  them to be executeable change :setting:`FILE_UPLOAD_PERMISSIONS` to your\n+  needs. The new default value is `0666` (octal) and the current umask value\n+  is first masked out.\n+\n Features deprecated in 1.5\n ==========================\n "
        },
        {
            "sha": "6b57ad6160ee0c2114a89a4c126c020c8295e532",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/e8c6aff3bf31b775dd70581b1cf6f86d5abd4001/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e8c6aff3bf31b775dd70581b1cf6f86d5abd4001/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=e8c6aff3bf31b775dd70581b1cf6f86d5abd4001",
            "patch": "@@ -4,6 +4,7 @@\n import errno\n import os\n import shutil\n+import sys\n import tempfile\n import time\n from datetime import datetime, timedelta\n@@ -23,6 +24,7 @@\n from django.test import SimpleTestCase\n from django.utils import six\n from django.utils import unittest\n+from django.test.utils import override_settings\n from ..servers.tests import LiveServerBase\n \n # Try to import PIL in either of the two ways it can end up installed.\n@@ -433,22 +435,29 @@ def test_race_condition(self):\n         self.storage.delete('conflict')\n         self.storage.delete('conflict_1')\n \n+@unittest.skipIf(sys.platform.startswith('win'), \"Windows only partially supports umasks and chmod.\")\n class FileStoragePermissions(unittest.TestCase):\n     def setUp(self):\n-        self.old_perms = settings.FILE_UPLOAD_PERMISSIONS\n-        settings.FILE_UPLOAD_PERMISSIONS = 0o666\n+        self.umask = 0o027\n+        self.old_umask = os.umask(self.umask)\n         self.storage_dir = tempfile.mkdtemp()\n         self.storage = FileSystemStorage(self.storage_dir)\n \n     def tearDown(self):\n-        settings.FILE_UPLOAD_PERMISSIONS = self.old_perms\n         shutil.rmtree(self.storage_dir)\n+        os.umask(self.old_umask)\n \n+    @override_settings(FILE_UPLOAD_PERMISSIONS=0o654)\n     def test_file_upload_permissions(self):\n         name = self.storage.save(\"the_file\", ContentFile(\"data\"))\n         actual_mode = os.stat(self.storage.path(name))[0] & 0o777\n-        self.assertEqual(actual_mode, 0o666)\n+        self.assertEqual(actual_mode, 0o654)\n \n+    @override_settings(FILE_UPLOAD_PERMISSIONS=None)\n+    def test_file_upload_default_permissions(self):\n+        fname = self.storage.save(\"some_file\", ContentFile(\"data\"))\n+        mode = os.stat(self.storage.path(fname))[0] & 0o777\n+        self.assertEqual(mode, 0o666 & ~self.umask)\n \n class FileStoragePathParsing(unittest.TestCase):\n     def setUp(self):"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 22,
        "deletions": 5
    }
}