{
    "author": "spookylukey",
    "message": "Fixed #15103 - SuspiciousOperation with limit_choices_to and raw_id_fields\n\nThanks to natrius for the report.\n\nThis patch also fixes some unicode bugs in affected code.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15347 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
    "files": [
        {
            "sha": "db445247d24d1dffb4504f52c6d57b0b22cfc7ac",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -205,7 +205,16 @@ def queryset(self, request):\n             qs = qs.order_by(*ordering)\n         return qs\n \n-    def lookup_allowed(self, lookup):\n+    def lookup_allowed(self, lookup, value):\n+        model = self.model\n+        # Check FKey lookups that are allowed, so that popups produced by\n+        # ForeignKeyRawIdWidget, on the basis of ForeignKey.limit_choices_to,\n+        # are allowed to work.\n+        for l in model._meta.related_fkey_lookups:\n+            for k, v in widgets.url_params_from_lookup_dict(l).items():\n+                if k == lookup and v == value:\n+                    return True\n+\n         parts = lookup.split(LOOKUP_SEP)\n \n         # Last term in lookup is a query term (__exact, __startswith etc)\n@@ -217,7 +226,6 @@ def lookup_allowed(self, lookup):\n         # if foo has been specificially included in the lookup list; so\n         # drop __id if it is the last part. However, first we need to find\n         # the pk attribute name.\n-        model = self.model\n         pk_attr_name = None\n         for part in parts[:-1]:\n             field, _, _, _ = model._meta.get_field_by_name(part)"
        },
        {
            "sha": "00ab9fed211682720e4092cd36d36f5922327eba",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -183,16 +183,18 @@ def get_query_set(self):\n \n             # if key ends with __in, split parameter into separate values\n             if key.endswith('__in'):\n-                lookup_params[key] = value.split(',')\n+                value = value.split(',')\n+                lookup_params[key] = value\n \n             # if key ends with __isnull, special case '' and false\n             if key.endswith('__isnull'):\n                 if value.lower() in ('', 'false'):\n-                    lookup_params[key] = False\n+                    value = False\n                 else:\n-                    lookup_params[key] = True\n+                    value = True\n+                lookup_params[key] = value\n \n-            if not self.model_admin.lookup_allowed(key):\n+            if not self.model_admin.lookup_allowed(key, value):\n                 raise SuspiciousOperation(\n                     \"Filtering by %s not allowed\" % key\n                 )"
        },
        {
            "sha": "d861e25e16a6a916358cc6310aa4120c5c035e50",
            "filename": "django/contrib/admin/widgets.py",
            "status": "modified",
            "additions": 21,
            "deletions": 15,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fwidgets.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -91,6 +91,22 @@ class AdminFileWidget(forms.ClearableFileInput):\n     template_with_clear = (u'<span class=\"clearable-file-input\">%s</span>'\n                            % forms.ClearableFileInput.template_with_clear)\n \n+def url_params_from_lookup_dict(lookups):\n+    \"\"\"\n+    Converts the type of lookups specified in a ForeignKey limit_choices_to\n+    attribute to a dictionary of query parameters\n+    \"\"\"\n+    params = {}\n+    if lookups and hasattr(lookups, 'items'):\n+        items = []\n+        for k, v in lookups.items():\n+            if isinstance(v, list):\n+                v = u','.join([str(x) for x in v])\n+            else:\n+                v = unicode(v)\n+            items.append((k, v))\n+        params.update(dict(items))\n+    return params\n \n class ForeignKeyRawIdWidget(forms.TextInput):\n     \"\"\"\n@@ -108,33 +124,23 @@ def render(self, name, value, attrs=None):\n         related_url = '../../../%s/%s/' % (self.rel.to._meta.app_label, self.rel.to._meta.object_name.lower())\n         params = self.url_parameters()\n         if params:\n-            url = '?' + '&amp;'.join(['%s=%s' % (k, v) for k, v in params.items()])\n+            url = u'?' + u'&amp;'.join([u'%s=%s' % (k, v) for k, v in params.items()])\n         else:\n-            url = ''\n+            url = u''\n         if \"class\" not in attrs:\n             attrs['class'] = 'vForeignKeyRawIdAdminField' # The JavaScript looks for this hook.\n         output = [super(ForeignKeyRawIdWidget, self).render(name, value, attrs)]\n         # TODO: \"id_\" is hard-coded here. This should instead use the correct\n         # API to determine the ID dynamically.\n-        output.append('<a href=\"%s%s\" class=\"related-lookup\" id=\"lookup_id_%s\" onclick=\"return showRelatedObjectLookupPopup(this);\"> ' % \\\n+        output.append(u'<a href=\"%s%s\" class=\"related-lookup\" id=\"lookup_id_%s\" onclick=\"return showRelatedObjectLookupPopup(this);\"> ' % \\\n             (related_url, url, name))\n-        output.append('<img src=\"%simg/admin/selector-search.gif\" width=\"16\" height=\"16\" alt=\"%s\" /></a>' % (settings.ADMIN_MEDIA_PREFIX, _('Lookup')))\n+        output.append(u'<img src=\"%simg/admin/selector-search.gif\" width=\"16\" height=\"16\" alt=\"%s\" /></a>' % (settings.ADMIN_MEDIA_PREFIX, _('Lookup')))\n         if value:\n             output.append(self.label_for_value(value))\n         return mark_safe(u''.join(output))\n \n     def base_url_parameters(self):\n-        params = {}\n-        if self.rel.limit_choices_to and hasattr(self.rel.limit_choices_to, 'items'):\n-            items = []\n-            for k, v in self.rel.limit_choices_to.items():\n-                if isinstance(v, list):\n-                    v = ','.join([str(x) for x in v])\n-                else:\n-                    v = str(v)\n-                items.append((k, v))\n-            params.update(dict(items))\n-        return params\n+        return url_params_from_lookup_dict(self.rel.limit_choices_to)\n \n     def url_parameters(self):\n         from django.contrib.admin.views.main import TO_FIELD_VAR"
        },
        {
            "sha": "1318706040f2f902ff410c7f1efe5b6fa0726b63",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -901,6 +901,8 @@ def contribute_to_related_class(self, cls, related):\n         # don't get a related descriptor.\n         if not self.rel.is_hidden():\n             setattr(cls, related.get_accessor_name(), ForeignRelatedObjectsDescriptor(related))\n+            if self.rel.limit_choices_to:\n+                cls._meta.related_fkey_lookups.append(self.rel.limit_choices_to)\n         if self.rel.field_name is None:\n             self.rel.field_name = cls._meta.pk.name\n "
        },
        {
            "sha": "2f64c56b00d7022d93500ada975582336a01bcfe",
            "filename": "django/db/models/options.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fdb%2Fmodels%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/django%2Fdb%2Fmodels%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Foptions.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -55,6 +55,10 @@ def __init__(self, meta, app_label=None):\n         self.abstract_managers = []\n         self.concrete_managers = []\n \n+        # List of all lookups defined in ForeignKey 'limit_choices_to' options\n+        # from *other* models. Needed for some admin checks. Internal use only.\n+        self.related_fkey_lookups = []\n+\n     def contribute_to_class(self, cls, name):\n         from django.db import connection\n         from django.db.backends.util import truncate_name"
        },
        {
            "sha": "08a2d36c3f896c6d4992d45a353f5f6e2339ab48",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -178,6 +178,26 @@ def __unicode__(self):\n class ThingAdmin(admin.ModelAdmin):\n     list_filter = ('color__warm', 'color__value')\n \n+class Actor(models.Model):\n+    name = models.CharField(max_length=50)\n+    age = models.IntegerField()\n+    def __unicode__(self):\n+        return self.name\n+\n+class Inquisition(models.Model):\n+    expected = models.BooleanField()\n+    leader = models.ForeignKey(Actor)\n+    def __unicode__(self):\n+        return self.expected\n+\n+class Sketch(models.Model):\n+    title = models.CharField(max_length=100)\n+    inquisition = models.ForeignKey(Inquisition, limit_choices_to={'leader__name': 'Palin',\n+                                                                   'leader__age': 27,\n+                                                                   })\n+    def __unicode__(self):\n+        return self.title\n+\n class Fabric(models.Model):\n     NG_CHOICES = (\n         ('Textured', (\n@@ -642,6 +662,9 @@ def __unicode__(self):\n admin.site.register(ModelWithStringPrimaryKey)\n admin.site.register(Color)\n admin.site.register(Thing, ThingAdmin)\n+admin.site.register(Actor)\n+admin.site.register(Inquisition)\n+admin.site.register(Sketch)\n admin.site.register(Person, PersonAdmin)\n admin.site.register(Persona, PersonaAdmin)\n admin.site.register(Subscriber, SubscriberAdmin)"
        },
        {
            "sha": "30e8c2f8e07d6025ec96100e38206908874a9e03",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c24bdf044ba23f2aa09ea4637a368ea86fd1c128/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=c24bdf044ba23f2aa09ea4637a368ea86fd1c128",
            "patch": "@@ -393,6 +393,17 @@ def test_disallowed_filtering(self):\n         response = self.client.get(\"/test_admin/admin/admin_views/workhour/?employee__person_ptr__exact=%d\" % e1.pk)\n         self.assertEqual(response.status_code, 200)\n \n+    def test_allowed_filtering_15103(self):\n+        \"\"\"\n+        Regressions test for ticket 15103 - filtering on fields defined in a\n+        ForeignKey 'limit_choices_to' should be allowed, otherwise raw_id_fields\n+        can break.\n+        \"\"\"\n+        try:\n+            self.client.get(\"/test_admin/admin/admin_views/inquisition/?leader__name=Palin&leader__age=27\")\n+        except SuspiciousOperation:\n+            self.fail(\"Filters should be allowed if they are defined on a ForeignKey pointing to this model\")\n+\n class SaveAsTests(TestCase):\n     fixtures = ['admin-views-users.xml','admin-views-person.xml']\n "
        }
    ],
    "stats": {
        "total": 98,
        "additions": 77,
        "deletions": 21
    }
}