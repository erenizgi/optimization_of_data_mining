{
    "author": "freakboy3742",
    "message": "Fixed #12398 -- Added a TypedMultipleChoiceField. Thanks to Tai Lee.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14829 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4a1f2129d09658e705fbe0660275c6efccf1474a",
    "files": [
        {
            "sha": "d0a93cf0a66677e38d6aa5d5248b869bd6b4e6e5",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 28,
            "deletions": 2,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/4a1f2129d09658e705fbe0660275c6efccf1474a/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/4a1f2129d09658e705fbe0660275c6efccf1474a/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=4a1f2129d09658e705fbe0660275c6efccf1474a",
            "patch": "@@ -40,7 +40,7 @@\n     'BooleanField', 'NullBooleanField', 'ChoiceField', 'MultipleChoiceField',\n     'ComboField', 'MultiValueField', 'FloatField', 'DecimalField',\n     'SplitDateTimeField', 'IPAddressField', 'FilePathField', 'SlugField',\n-    'TypedChoiceField'\n+    'TypedChoiceField', 'TypedMultipleChoiceField'\n )\n \n def en_format(name):\n@@ -700,7 +700,7 @@ def __init__(self, *args, **kwargs):\n \n     def to_python(self, value):\n         \"\"\"\n-        Validate that the value is in self.choices and can be coerced to the\n+        Validates that the value is in self.choices and can be coerced to the\n         right type.\n         \"\"\"\n         value = super(TypedChoiceField, self).to_python(value)\n@@ -742,6 +742,32 @@ def validate(self, value):\n             if not self.valid_value(val):\n                 raise ValidationError(self.error_messages['invalid_choice'] % {'value': val})\n \n+class TypedMultipleChoiceField(MultipleChoiceField):\n+    def __init__(self, *args, **kwargs):\n+        self.coerce = kwargs.pop('coerce', lambda val: val)\n+        self.empty_value = kwargs.pop('empty_value', [])\n+        super(TypedMultipleChoiceField, self).__init__(*args, **kwargs)\n+\n+    def to_python(self, value):\n+        \"\"\"\n+        Validates that the values are in self.choices and can be coerced to the\n+        right type.\n+        \"\"\"\n+        value = super(TypedMultipleChoiceField, self).to_python(value)\n+        super(TypedMultipleChoiceField, self).validate(value)\n+        if value == self.empty_value or value in validators.EMPTY_VALUES:\n+            return self.empty_value\n+        new_value = []\n+        for choice in value:\n+            try:\n+                new_value.append(self.coerce(choice))\n+            except (ValueError, TypeError, ValidationError):\n+                raise ValidationError(self.error_messages['invalid_choice'] % {'value': choice})\n+        return new_value\n+\n+    def validate(self, value):\n+        pass\n+\n class ComboField(Field):\n     \"\"\"\n     A Field whose clean() method calls multiple Field clean() methods."
        },
        {
            "sha": "b36c9cc749e8fae6367a0b2d9587a6adc617c857",
            "filename": "docs/ref/forms/fields.txt",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/4a1f2129d09658e705fbe0660275c6efccf1474a/docs%2Fref%2Fforms%2Ffields.txt",
            "raw_url": "https://github.com/django/django/raw/4a1f2129d09658e705fbe0660275c6efccf1474a/docs%2Fref%2Fforms%2Ffields.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fforms%2Ffields.txt?ref=4a1f2129d09658e705fbe0660275c6efccf1474a",
            "patch": "@@ -361,13 +361,14 @@ Takes one extra required argument:\n \n .. class:: TypedChoiceField(**kwargs)\n \n-Just like a :class:`ChoiceField`, except :class:`TypedChoiceField` takes an\n-extra ``coerce`` argument.\n+Just like a :class:`ChoiceField`, except :class:`TypedChoiceField` takes two\n+extra arguments, ``coerce`` and ``empty_value``.\n \n     * Default widget: ``Select``\n     * Empty value: Whatever you've given as ``empty_value``\n-    * Normalizes to: the value returned by the ``coerce`` argument.\n-    * Validates that the given value exists in the list of choices.\n+    * Normalizes to: A value of the type provided by the ``coerce`` argument.\n+    * Validates that the given value exists in the list of choices and can be\n+      coerced.\n     * Error message keys: ``required``, ``invalid_choice``\n \n Takes extra arguments:\n@@ -635,7 +636,25 @@ Takes two optional arguments for validation:\n       of choices.\n     * Error message keys: ``required``, ``invalid_choice``, ``invalid_list``\n \n-Takes one extra argument, ``choices``, as for ``ChoiceField``.\n+Takes one extra required argument, ``choices``, as for ``ChoiceField``.\n+\n+``TypedMultipleChoiceField``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+.. class:: TypedMultipleChoiceField(**kwargs)\n+\n+Just like a :class:`MultipleChoiceField`, except :class:`TypedMultipleChoiceField`\n+takes two extra arguments, ``coerce`` and ``empty_value``.\n+\n+    * Default widget: ``SelectMultiple``\n+    * Empty value: Whatever you've given as ``empty_value``\n+    * Normalizes to: A list of values of the type provided by the ``coerce``\n+      argument.\n+    * Validates that the given values exists in the list of choices and can be\n+      coerced.\n+    * Error message keys: ``required``, ``invalid_choice``\n+\n+Takes two extra arguments, ``coerce`` and ``empty_value``, as for ``TypedChoiceField``.\n \n ``NullBooleanField``\n ~~~~~~~~~~~~~~~~~~~~"
        },
        {
            "sha": "93ca5c1762eeb8e17dc56e2bbaa0503d9c29e305",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 43,
            "deletions": 1,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/4a1f2129d09658e705fbe0660275c6efccf1474a/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/4a1f2129d09658e705fbe0660275c6efccf1474a/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=4a1f2129d09658e705fbe0660275c6efccf1474a",
            "patch": "@@ -750,7 +750,49 @@ def test_multiplechoicefield_3(self):\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Select a valid choice. 6 is not one of the available choices.']\", f.clean, ['6'])\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Select a valid choice. 6 is not one of the available choices.']\", f.clean, ['1','6'])\n \n-    # ComboField ##################################################################\n+    # TypedMultipleChoiceField ############################################################\n+    # TypedMultipleChoiceField is just like MultipleChoiceField, except that coerced types\n+    # will be returned:\n+\n+    def test_typedmultiplechoicefield_1(self):\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int)\n+        self.assertEqual([1], f.clean(['1']))\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'Select a valid choice. 2 is not one of the available choices.']\", f.clean, ['2'])\n+\n+    def test_typedmultiplechoicefield_2(self):\n+        # Different coercion, same validation.\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=float)\n+        self.assertEqual([1.0], f.clean(['1']))\n+\n+    def test_typedmultiplechoicefield_3(self):\n+        # This can also cause weirdness: be careful (bool(-1) == True, remember)\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=bool)\n+        self.assertEqual([True], f.clean(['-1']))\n+\n+    def test_typedmultiplechoicefield_4(self):\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int)\n+        self.assertEqual([1, -1], f.clean(['1','-1']))\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'Select a valid choice. 2 is not one of the available choices.']\", f.clean, ['1','2'])\n+\n+    def test_typedmultiplechoicefield_5(self):\n+        # Even more weirdness: if you have a valid choice but your coercion function\n+        # can't coerce, you'll still get a validation error. Don't do this!\n+        f = TypedMultipleChoiceField(choices=[('A', 'A'), ('B', 'B')], coerce=int)\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'Select a valid choice. B is not one of the available choices.']\", f.clean, ['B'])\n+        # Required fields require values\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'This field is required.']\", f.clean, [])\n+\n+    def test_typedmultiplechoicefield_6(self):\n+        # Non-required fields aren't required\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int, required=False)\n+        self.assertEqual([], f.clean([]))\n+\n+    def test_typedmultiplechoicefield_7(self):\n+        # If you want cleaning an empty value to return a different type, tell the field\n+        f = TypedMultipleChoiceField(choices=[(1, \"+1\"), (-1, \"-1\")], coerce=int, required=False, empty_value=None)\n+        self.assertEqual(None, f.clean([]))\n+\n+   # ComboField ##################################################################\n \n     def test_combofield_1(self):\n         f = ComboField(fields=[CharField(max_length=20), EmailField()])"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 95,
        "deletions": 8
    }
}