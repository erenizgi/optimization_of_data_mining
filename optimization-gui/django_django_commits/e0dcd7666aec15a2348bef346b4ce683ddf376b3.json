{
    "author": "freakboy3742",
    "message": "Fixed #12815 -- Added TemplateResponse, a lazy-evaluated Response class. Thanks to Simon Willison for the original idea, and to Mikhail Korobov and Ivan Sagalaev for their assistance, including the draft patch from Mikhail.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14850 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e0dcd7666aec15a2348bef346b4ce683ddf376b3",
    "files": [
        {
            "sha": "a0c66aa43dc3feafc86cc1e3426a86e85cd2665f",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -273,6 +273,7 @@ answer newbie questions, and generally made Django that much better:\n     Igor Kolar <ike@email.si>\n     Tomáš Kopeček <permonik@m6.cz>\n     Gasper Koren\n+    Mikhail Korobov <kmike84@googlemail.com>\n     Martin Kosír <martin@martinkosir.net>\n     Arthur Koziel <http://arthurkoziel.com>\n     Meir Kriheli <http://mksoft.co.il/>"
        },
        {
            "sha": "61938acc579df9e2be9b36b28a1a012c53621a5e",
            "filename": "django/contrib/messages/tests/base.py",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -103,7 +103,7 @@ def test_add(self):\n         storage = self.get_storage()\n         self.assertFalse(storage.added_new)\n         storage.add(constants.INFO, 'Test message 1')\n-        self.assert_(storage.added_new)\n+        self.assertTrue(storage.added_new)\n         storage.add(constants.INFO, 'Test message 2', extra_tags='tag')\n         self.assertEqual(len(storage), 2)\n \n@@ -180,6 +180,26 @@ def test_full_request_response_cycle(self):\n             for msg in data['messages']:\n                 self.assertContains(response, msg)\n \n+    def test_with_template_response(self):\n+        settings.MESSAGE_LEVEL = constants.DEBUG\n+        data = {\n+            'messages': ['Test message %d' % x for x in xrange(10)],\n+        }\n+        show_url = reverse('django.contrib.messages.tests.urls.show_template_response')\n+        for level in self.levels.keys():\n+            add_url = reverse('django.contrib.messages.tests.urls.add_template_response',\n+                              args=(level,))\n+            response = self.client.post(add_url, data, follow=True)\n+            self.assertRedirects(response, show_url)\n+            self.assertTrue('messages' in response.context)\n+            for msg in data['messages']:\n+                self.assertContains(response, msg)\n+\n+            # there shouldn't be any messages on second GET request\n+            response = self.client.get(show_url)\n+            for msg in data['messages']:\n+                self.assertNotContains(response, msg)\n+\n     def test_multiple_posts(self):\n         \"\"\"\n         Tests that messages persist properly when multiple POSTs are made"
        },
        {
            "sha": "7557f9af4c4cf650b4533534ed4c76bd5b05d006",
            "filename": "django/contrib/messages/tests/urls.py",
            "status": "modified",
            "additions": 24,
            "deletions": 10,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fcontrib%2Fmessages%2Ftests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fcontrib%2Fmessages%2Ftests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Furls.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -2,9 +2,20 @@\n from django.contrib import messages\n from django.core.urlresolvers import reverse\n from django.http import HttpResponseRedirect, HttpResponse\n-from django.shortcuts import render_to_response\n+from django.shortcuts import render_to_response, redirect\n from django.template import RequestContext, Template\n+from django.template.response import TemplateResponse\n \n+TEMPLATE = \"\"\"{% if messages %}\n+<ul class=\"messages\">\n+    {% for message in messages %}\n+    <li{% if message.tags %} class=\"{{ message.tags }}\"{% endif %}>\n+        {{ message }}\n+    </li>\n+    {% endfor %}\n+</ul>\n+{% endif %}\n+\"\"\"\n \n def add(request, message_type):\n     # don't default to False here, because we want to test that it defaults\n@@ -16,24 +27,27 @@ def add(request, message_type):\n                                             fail_silently=fail_silently)\n         else:\n             getattr(messages, message_type)(request, msg)\n+\n     show_url = reverse('django.contrib.messages.tests.urls.show')\n     return HttpResponseRedirect(show_url)\n \n+def add_template_response(request, message_type):\n+    for msg in request.POST.getlist('messages'):\n+        getattr(messages, message_type)(request, msg)\n+\n+    show_url = reverse('django.contrib.messages.tests.urls.show_template_response')\n+    return HttpResponseRedirect(show_url)\n \n def show(request):\n-    t = Template(\"\"\"{% if messages %}\n-<ul class=\"messages\">\n-    {% for message in messages %}\n-    <li{% if message.tags %} class=\"{{ message.tags }}\"{% endif %}>\n-        {{ message }}\n-    </li>\n-    {% endfor %}\n-</ul>\n-{% endif %}\"\"\")\n+    t = Template(TEMPLATE)\n     return HttpResponse(t.render(RequestContext(request)))\n \n+def show_template_response(request):\n+    return TemplateResponse(request, Template(TEMPLATE))\n \n urlpatterns = patterns('',\n     ('^add/(debug|info|success|warning|error)/$', add),\n     ('^show/$', show),\n+    ('^template_response/add/(debug|info|success|warning|error)/$', add_template_response),\n+    ('^template_response/show/$', show_template_response),\n )"
        },
        {
            "sha": "9468b1dab964a5bbdc7ed1ad66687b50c74a3d2c",
            "filename": "django/core/handlers/base.py",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fcore%2Fhandlers%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fcore%2Fhandlers%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fbase.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -21,6 +21,7 @@ class BaseHandler(object):\n     def __init__(self):\n         self._request_middleware = self._view_middleware = self._response_middleware = self._exception_middleware = None\n \n+\n     def load_middleware(self):\n         \"\"\"\n         Populate middleware lists from settings.MIDDLEWARE_CLASSES.\n@@ -30,16 +31,16 @@ def load_middleware(self):\n         from django.conf import settings\n         from django.core import exceptions\n         self._view_middleware = []\n+        self._template_response_middleware = []\n         self._response_middleware = []\n         self._exception_middleware = []\n \n         request_middleware = []\n         for middleware_path in settings.MIDDLEWARE_CLASSES:\n             try:\n-                dot = middleware_path.rindex('.')\n+                mw_module, mw_classname = middleware_path.rsplit('.', 1)\n             except ValueError:\n                 raise exceptions.ImproperlyConfigured('%s isn\\'t a middleware module' % middleware_path)\n-            mw_module, mw_classname = middleware_path[:dot], middleware_path[dot+1:]\n             try:\n                 mod = import_module(mw_module)\n             except ImportError, e:\n@@ -48,7 +49,6 @@ def load_middleware(self):\n                 mw_class = getattr(mod, mw_classname)\n             except AttributeError:\n                 raise exceptions.ImproperlyConfigured('Middleware module \"%s\" does not define a \"%s\" class' % (mw_module, mw_classname))\n-\n             try:\n                 mw_instance = mw_class()\n             except exceptions.MiddlewareNotUsed:\n@@ -58,6 +58,8 @@ def load_middleware(self):\n                 request_middleware.append(mw_instance.process_request)\n             if hasattr(mw_instance, 'process_view'):\n                 self._view_middleware.append(mw_instance.process_view)\n+            if hasattr(mw_instance, 'process_template_response'):\n+                self._template_response_middleware.insert(0, mw_instance.process_template_response)\n             if hasattr(mw_instance, 'process_response'):\n                 self._response_middleware.insert(0, mw_instance.process_response)\n             if hasattr(mw_instance, 'process_exception'):\n@@ -164,6 +166,13 @@ def get_response(self, request):\n             urlresolvers.set_urlconf(None)\n \n         try:\n+            # If the response supports deferred rendering, apply template\n+            # response middleware and the render the response\n+            if hasattr(response, 'render') and callable(response.render):\n+                for middleware_method in self._template_response_middleware:\n+                    response = middleware_method(request, response)\n+                response.render()\n+\n             # Apply response middleware, regardless of the response\n             for middleware_method in self._response_middleware:\n                 response = middleware_method(request, response)"
        },
        {
            "sha": "d89fee0aab7915bb20407f4c720c885ae9ebc38a",
            "filename": "django/template/response.py",
            "status": "added",
            "additions": 108,
            "deletions": 0,
            "changes": 108,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Ftemplate%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Ftemplate%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fresponse.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -0,0 +1,108 @@\n+from django.http import HttpResponse\n+from django.template import loader, Context, RequestContext\n+\n+class ContentNotRenderedError(Exception):\n+    pass\n+\n+class SimpleTemplateResponse(HttpResponse):\n+\n+    def __init__(self, template, context=None, mimetype=None, status=None,\n+            content_type=None):\n+        # It would seem obvious to call these next two members 'template' and\n+        # 'context', but those names are reserved as part of the test Client API.\n+        # To avoid the name collision, we use\n+        # tricky-to-debug problems\n+        self.template_name = template\n+        self.context_data = context\n+\n+        # _is_rendered tracks whether the template and context has been baked into\n+        # a final response.\n+        self._is_rendered = False\n+\n+        # content argument doesn't make sense here because it will be replaced\n+        # with rendered template so we always pass empty string in order to\n+        # prevent errors and provide shorter signature.\n+        super(SimpleTemplateResponse, self).__init__('', mimetype, status,\n+                                                     content_type)\n+\n+    def resolve_template(self, template):\n+        \"Accepts a template object, path-to-template or list of paths\"\n+        if isinstance(template, (list, tuple)):\n+            return loader.select_template(template)\n+        elif isinstance(template, basestring):\n+            return loader.get_template(template)\n+        else:\n+            return template\n+\n+    def resolve_context(self, context):\n+        \"\"\"Convert context data into a full Context object\n+        (assuming it isn't already a Context object).\n+        \"\"\"\n+        if isinstance(context, Context):\n+            return context\n+        else:\n+            return Context(context)\n+\n+    @property\n+    def rendered_content(self):\n+        \"\"\"Returns the freshly rendered content for the template and context\n+        described by the TemplateResponse.\n+\n+        This *does not* set the final content of the response. To set the\n+        response content, you must either call render(), or set the\n+        content explicitly using the value of this property.\n+        \"\"\"\n+        template = self.resolve_template(self.template_name)\n+        context = self.resolve_context(self.context_data)\n+        content = template.render(context)\n+        return content\n+\n+    def render(self):\n+        \"\"\"Render (thereby finalizing) the content of the response.\n+\n+        If the content has already been rendered, this is a no-op.\n+\n+        Returns the baked response instance.\n+        \"\"\"\n+        if not self._is_rendered:\n+            self._set_content(self.rendered_content)\n+        return self\n+\n+    is_rendered = property(lambda self: self._is_rendered)\n+\n+    def __iter__(self):\n+        if not self._is_rendered:\n+            raise ContentNotRenderedError('The response content must be rendered before it can be iterated over.')\n+        return super(SimpleTemplateResponse, self).__iter__()\n+\n+    def _get_content(self):\n+        if not self._is_rendered:\n+            raise ContentNotRenderedError('The response content must be rendered before it can be accessed.')\n+        return super(SimpleTemplateResponse, self)._get_content()\n+\n+    def _set_content(self, value):\n+        \"Overrides rendered content, unless you later call render()\"\n+        super(SimpleTemplateResponse, self)._set_content(value)\n+        self._is_rendered = True\n+\n+    content = property(_get_content, _set_content)\n+\n+\n+class TemplateResponse(SimpleTemplateResponse):\n+    def __init__(self, request, template, context=None, mimetype=None,\n+            status=None, content_type=None):\n+        # self.request gets over-written by django.test.client.Client - and\n+        # unlike context_data and template_name the _request should not\n+        # be considered part of the public API.\n+        self._request = request\n+        super(TemplateResponse, self).__init__(\n+            template, context, mimetype, status, content_type)\n+\n+    def resolve_context(self, context):\n+        \"\"\"Convert context data into a full RequestContext object\n+        (assuming it isn't already a Context object).\n+        \"\"\"\n+        if isinstance(context, Context):\n+            return context\n+        else:\n+            return RequestContext(self._request, context)"
        },
        {
            "sha": "5e69a8dd304a350f529491f4b045c708859be1c1",
            "filename": "django/views/generic/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 40,
            "changes": 51,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fviews%2Fgeneric%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/django%2Fviews%2Fgeneric%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Fbase.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -1,6 +1,7 @@\n from django import http\n from django.core.exceptions import ImproperlyConfigured\n from django.template import RequestContext, loader\n+from django.template.response import TemplateResponse\n from django.utils.functional import update_wrapper\n from django.utils.log import getLogger\n from django.utils.decorators import classonlymethod\n@@ -81,59 +82,29 @@ class TemplateResponseMixin(object):\n     A mixin that can be used to render a template.\n     \"\"\"\n     template_name = None\n+    response_class = TemplateResponse\n \n-    def render_to_response(self, context):\n+    def render_to_response(self, context, **response_kwargs):\n         \"\"\"\n         Returns a response with a template rendered with the given context.\n         \"\"\"\n-        return self.get_response(self.render_template(context))\n-\n-    def get_response(self, content, **httpresponse_kwargs):\n-        \"\"\"\n-        Construct an `HttpResponse` object.\n-        \"\"\"\n-        return http.HttpResponse(content, **httpresponse_kwargs)\n-\n-    def render_template(self, context):\n-        \"\"\"\n-        Render the template with a given context.\n-        \"\"\"\n-        context_instance = self.get_context_instance(context)\n-        return self.get_template().render(context_instance)\n-\n-    def get_context_instance(self, context):\n-        \"\"\"\n-        Get the template context instance. Must return a Context (or subclass)\n-        instance.\n-        \"\"\"\n-        return RequestContext(self.request, context)\n-\n-    def get_template(self):\n-        \"\"\"\n-        Get a ``Template`` object for the given request.\n-        \"\"\"\n-        names = self.get_template_names()\n-        if not names:\n-            raise ImproperlyConfigured(u\"'%s' must provide template_name.\"\n-                                       % self.__class__.__name__)\n-        return self.load_template(names)\n+        return self.response_class(\n+            request = self.request,\n+            template = self.get_template_names(),\n+            context = context,\n+            **response_kwargs\n+        )\n \n     def get_template_names(self):\n         \"\"\"\n-        Return a list of template names to be used for the request. Must return\n-        a list. May not be called if get_template is overridden.\n+        Returns a list of template names to be used for the request. Must return\n+        a list. May not be called if render_to_response is overridden.\n         \"\"\"\n         if self.template_name is None:\n             return []\n         else:\n             return [self.template_name]\n \n-    def load_template(self, names):\n-        \"\"\"\n-        Load a list of templates using the default template loader.\n-        \"\"\"\n-        return loader.select_template(names)\n-\n \n class TemplateView(TemplateResponseMixin, View):\n     \"\"\""
        },
        {
            "sha": "632adc8da3f5d465e6fffe405df0c5fb9b89bb3c",
            "filename": "docs/index.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Findex.txt?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -93,7 +93,9 @@ The view layer\n       :doc:`View functions <topics/http/views>` |\n       :doc:`Shortcuts <topics/http/shortcuts>`\n \n-    * **Reference:**  :doc:`Request/response objects <ref/request-response>`\n+    * **Reference:**\n+      :doc:`Request/response objects <ref/request-response>` |\n+      :doc:`TemplateResponse objects <ref/template-response>`\n \n     * **File uploads:**\n       :doc:`Overview <topics/http/file-uploads>` |"
        },
        {
            "sha": "150ffff2e13b7d7d198b041938d115bf8db31fca",
            "filename": "docs/ref/class-based-views.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 32,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Fref%2Fclass-based-views.txt",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Fref%2Fclass-based-views.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fclass-based-views.txt?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -76,39 +76,25 @@ TemplateResponseMixin\n \n         The path to the template to use when rendering the view.\n \n-    .. method:: render_to_response(context)\n+    .. attribute:: response_class\n \n-        Returns a full composed HttpResponse instance, ready to be returned to\n-        the user.\n+        The response class to be returned by ``render_to_response`` method.\n+        Default is\n+        :class:`TemplateResponse <django.template.response.TemplateResponse>`.\n+        The template and context of TemplateResponse instances can be\n+        altered later (e.g. in\n+        :ref:`template response middleware <template-response-middleware>`).\n \n-        Calls :meth:`~TemplateResponseMixin.render_template()` to build the\n-        content of the response, and\n-        :meth:`~TemplateResponseMixin.get_response()` to construct the\n-        :class:`~django.http.HttpResponse` object.\n+        Create TemplateResponse subclass and pass set it to\n+        ``template_response_class`` if you need custom template loading or\n+        custom context object instantiation.\n \n-    .. method:: get_response(content, **httpresponse_kwargs)\n+    .. method:: render_to_response(context, **response_kwargs)\n \n-        Constructs the :class:`~django.http.HttpResponse` object around the\n-        given content. If any keyword arguments are provided, they will be\n-        passed to the constructor of the :class:`~django.http.HttpResponse`\n-        instance.\n+        Returns a ``self.template_response_class`` instance.\n \n-    .. method:: render_template(context)\n-\n-        Calls :meth:`~TemplateResponseMixin.get_context_instance()` to obtain\n-        the :class:`Context` instance to use for rendering, and calls\n-        :meth:`TemplateReponseMixin.get_template()` to load the template that\n-        will be used to render the final content.\n-\n-    .. method:: get_context_instance(context)\n-\n-        Turns the data dictionary ``context`` into an actual context instance\n-        that can be used for rendering.\n-\n-        By default, constructs a :class:`~django.template.RequestContext`\n-        instance.\n-\n-    .. method:: get_template()\n+        If any keyword arguments are provided, they will be\n+        passed to the constructor of the response instance.\n \n         Calls :meth:`~TemplateResponseMixin.get_template_names()` to obtain the\n         list of template names that will be searched looking for an existent\n@@ -123,10 +109,6 @@ TemplateResponseMixin\n         default implementation will return a list containing\n         :attr:`TemplateResponseMixin.template_name` (if it is specified).\n \n-    .. method:: load_template(names)\n-\n-        Loads and returns a template found by searching the list of ``names``\n-        for a match. Uses Django's default template loader.\n \n Single object mixins\n --------------------"
        },
        {
            "sha": "f544e3cd982cda0a177b2c58f9e4f33104bd12ac",
            "filename": "docs/ref/index.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Fref%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Fref%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Findex.txt?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -16,6 +16,7 @@ API Reference\n    middleware\n    models/index\n    request-response\n+   template-response\n    settings\n    signals\n    templates/index"
        },
        {
            "sha": "09bcd16378cb145a9eb6285a01134a20e786460f",
            "filename": "docs/ref/template-response.txt",
            "status": "added",
            "additions": 211,
            "deletions": 0,
            "changes": 211,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Fref%2Ftemplate-response.txt",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Fref%2Ftemplate-response.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Ftemplate-response.txt?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -0,0 +1,211 @@\n+===========================================\n+TemplateResponse and SimpleTemplateResponse\n+===========================================\n+\n+.. versionadded:: 1.3\n+\n+.. module:: django.template.response\n+   :synopsis: Classes dealing with lazy-rendered HTTP responses.\n+\n+Standard HttpResponse objects are static structures. They are provided\n+with a block of pre-rendered content at time of construction, and\n+while that content can be modified, it isn't in a form that makes it\n+easy to perform modifications.\n+\n+However, it can sometimes be beneficial to allow decorators or\n+middleware to modify a response *after* it has been constructed by the\n+view. For example, you may want to change the template that is used,\n+or put additional data into the context.\n+\n+TemplateResponse provides a way to do just that. Unlike basic\n+HttpResponse objects, TemplateResponse objects retain the details of\n+the template and context that was provided by the view to compute the\n+response. The final output of the response is not computed until\n+it is needed, later in the response process.\n+\n+TemplateResponse objects\n+========================\n+\n+.. class:: SimpleTemplateResponse()\n+\n+Attributes\n+----------\n+\n+.. attribute:: SimpleTemplateResponse.template_name\n+\n+    The name of the template to be rendered. Accepts\n+    :class:`django.template.Template` object, path to template or list\n+    of paths.\n+\n+    Example: ``['foo.html', 'path/to/bar.html']``\n+\n+.. attribute:: SimpleTemplateResponse.context_data\n+\n+    The context data to be used when rendering the template. It can be\n+    a dictionary or a context object.\n+\n+    Example: ``{'foo': 123}``\n+\n+.. attr:: SimpleTemplateResponse.rendered_content:\n+\n+    The current rendered value of the response content, using the current\n+    template and context data.\n+\n+.. attr:: SimpleTemplateResponse.is_rendered:\n+\n+    A boolean indicating whether the response content has been rendered.\n+\n+\n+Methods\n+-------\n+\n+.. method:: SimpleTemplateResponse.__init__(template, context=None, mimetype=None, status=None, content_type=None)\n+\n+    Instantiates an\n+    :class:`~django.template.response.SimpleTemplateResponse` object\n+    with the given template, context, MIME type and HTTP status.\n+\n+    ``template`` is a full name of a template, or a sequence of\n+    template names. :class:`django.template.Template` instances can\n+    also be used.\n+\n+    ``context`` is a dictionary of values to add to the template\n+    context. By default, this is an empty dictionary.\n+    :class:`~django.template.Context` objects are also accepted as\n+    ``context`` values.\n+\n+    ``status`` is the HTTP Status code for the response.\n+\n+    ``content_type`` is an alias for ``mimetype``. Historically, this\n+    parameter was only called ``mimetype``, but since this is actually\n+    the value included in the HTTP ``Content-Type`` header, it can\n+    also include the character set encoding, which makes it more than\n+    just a MIME type specification. If ``mimetype`` is specified (not\n+    ``None``), that value is used. Otherwise, ``content_type`` is\n+    used. If neither is given, the ``DEFAULT_CONTENT_TYPE`` setting is\n+    used.\n+\n+\n+.. method:: SimpleTemplateResponse.resolve_context(context)\n+\n+    Converts context data into a context instance that can be used for\n+    rendering a template. Accepts a dictionary of context data or a\n+    context object. Returns a :class:`~django.template.Context`\n+    instance containing the provided data.\n+\n+    Override this method in order to customize context instantiation.\n+\n+.. method:: SimpleTemplateResponse.resolve_template(template)\n+\n+    Resolves the template instance to use for rendering. Accepts a\n+    path of a template to use, or a sequence of template paths.\n+    :class:`~django.template.Template` instances may also be provided.\n+    Returns the :class:`~django.template.Template` instance to be\n+    rendered.\n+\n+    Override this method in order to customize template rendering.\n+\n+.. method:: SimpleTemplateResponse.render():\n+\n+    Sets :attr:`response.content` to the result obtained by\n+    :attr:`SimpleTemplateResponse.rendered_content`.\n+\n+    :meth:`~SimpleTemplateResponse.render()` will only have an effect\n+    the first time it is called. On subsequent calls, it will return\n+    the result obtained from the first call.\n+\n+\n+.. class:: TemplateResponse()\n+\n+   TemplateResponse is a subclass of :class:`SimpleTemplateResponse\n+   <django.template.response.SimpleTemplateResponse>` that uses\n+   RequestContext instead of Context.\n+\n+.. method:: TemplateResponse.__init__(request, template, context=None, mimetype=None, status=None, content_type=None)\n+\n+   Instantiates an ``TemplateResponse`` object with the given\n+   template, context, MIME type and HTTP status.\n+\n+   ``request`` is a HttpRequest instance.\n+\n+   ``template`` is a full name of a template to use or sequence of\n+   template names. :class:`django.template.Template` instances are\n+   also accepted.\n+\n+   ``context`` is a dictionary of values to add to the template\n+   context. By default, this is an empty dictionary; context objects\n+   are also accepted as ``context`` values.\n+\n+   ``status`` is the HTTP Status code for the response.\n+\n+   ``content_type`` is an alias for ``mimetype``. Historically, this\n+   parameter was only called ``mimetype``, but since this is actually\n+   the value included in the HTTP ``Content-Type`` header, it can also\n+   include the character set encoding, which makes it more than just a\n+   MIME type specification. If ``mimetype`` is specified (not\n+   ``None``), that value is used. Otherwise, ``content_type`` is used.\n+   If neither is given, the ``DEFAULT_CONTENT_TYPE`` setting is used.\n+\n+\n+The rendering process\n+=====================\n+\n+Before a :class:`TemplateResponse()` instance can be returned to the\n+client, it must be rendered. The rendering process takes the\n+intermediate representation of template and context, and turns it into\n+the final byte stream that can be served to the client.\n+\n+There are three circumstances under which a TemplateResponse will be\n+rendered:\n+\n+    * When the TemplateResponse instance is explicitly rendered, using\n+      the :meth:`SimpleTemplateResponse.render()` method.\n+\n+    * When the content of the response is explicitly set by assigning\n+      :attr:`response.content`.\n+\n+    * After passing through template response middleware, but before\n+      passing through response middleware.\n+\n+A TemplateResponse can only be rendered once. The first call to\n+:meth:`SimpleTemplateResponse.render()` sets the content of the\n+response; subsequent rendering calls do not change the response\n+content.\n+\n+However, when :attr:`response.content` is explicitly assigned, the\n+change is always applied. If you want to force the content to be\n+re-rendered, you can re-evaluate the rendered content, and assign\n+the content of the response manually::\n+\n+    # Set up a baked TemplateResponse\n+    >>> t = TemplateResponse(request, 'original.html', {})\n+    >>> t.render()\n+    >>> print t.content\n+    Original content\n+\n+    # Rebaking doesn't change content\n+    >>> t.template_name = 'new.html'\n+    >>> t.render()\n+    >>> print t.content\n+    Original content\n+\n+    # Assigning content does change, no render() call required\n+    >>> t.content = t.rendered_content\n+    >>> print t.content\n+    New content\n+\n+Using TemplateResponse and SimpleTemplateResponse\n+=================================================\n+\n+A TemplateResponse object can be used anywhere that a normal\n+HttpResponse can be used. It can also be used as an alternative to\n+calling :method:`~django.shortcuts.render_to_response()`.\n+\n+For example, the following simple view returns a\n+:class:`TemplateResponse()` with a simple template, and a context\n+containing a queryset::\n+\n+    from django.template.response import TemplateResponse\n+\n+    def blog_index(request):\n+        return TemplateResponse(request, 'entry_list.html', {'entries': Entry.objects.all()})"
        },
        {
            "sha": "0c2dedc4816359fa5e30dc97d38a340539fe300c",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -133,6 +133,27 @@ can also add special translator comments in the source.\n For more information, see :ref:`contextual-markers` and\n :ref:`translator-comments`.\n \n+TemplateResponse\n+~~~~~~~~~~~~~~~~\n+\n+It can sometimes be beneficial to allow decorators or middleware to\n+modify a response *after* it has been constructed by the view. For\n+example, you may want to change the template that is used, or put\n+additional data into the context.\n+\n+However, you can't (easily) modify the content of a basic\n+:class:`~django.http.HttpResponse` after it has been constructed. To\n+overcome this limitation, Django 1.3 adds a new\n+:class:`~django.template.TemplateResponse` class. Unlike basic\n+:class:`~django.http.HttpResponse` objects,\n+:class:`~django.template.TemplateResponse` objects retain the details\n+of the template and context that was provided by the view to compute\n+the response. The final output of the response is not computed until\n+it is needed, later in the response process.\n+\n+For more details, see the :ref:`documentation </ref/template-response>`\n+on the :class:`~django.template.TemplateResponse` class.\n+\n Everything else\n ~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "c03eb155d6d3de93b58f77e4c9c94b6dae764104",
            "filename": "docs/topics/http/middleware.txt",
            "status": "modified",
            "additions": 35,
            "deletions": 1,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Ftopics%2Fhttp%2Fmiddleware.txt",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/docs%2Ftopics%2Fhttp%2Fmiddleware.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fhttp%2Fmiddleware.txt?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -97,6 +97,39 @@ calling ANY other request, view or exception middleware, or the appropriate\n view; it'll return that :class:`~django.http.HttpResponse`. Response\n middleware is always called on every response.\n \n+.. _template-response-middleware:\n+\n+``process_template_response``\n+-----------------------------\n+\n+.. versionadded:: 1.3\n+\n+.. method:: process_template_response(self, request, response)\n+\n+``request`` is an :class:`~django.http.HttpRequest` object. ``response`` is the\n+:class:`~django.template.response.SimpleTemplateResponse` subclass (e.g.\n+:class:`~django.template.response.TemplateResponse`) object returned by a\n+Django view.\n+\n+``process_template_response()`` must return an\n+:class:`~django.template.response.SimpleTemplateResponse` (or it's subclass)\n+object. It could alter the given ``response`` by changing\n+``response.template_name`` and ``response.template_context``, or it could\n+create and return a brand-new\n+:class:`~django.template.response.SimpleTemplateResponse` (or it's subclass)\n+instance.\n+\n+``process_template_response()`` will only be called if the response\n+instance has a ``render()`` method, indicating that it is a\n+:class:`~django.template.response.TemplateResponse`.\n+\n+You don't need to explicitly render responses -- responses will be\n+automatically rendered once all template response middleware has been\n+called.\n+\n+Middleware are run in reverse order during the response phase, which\n+includes process_template_response.\n+\n .. _response-middleware:\n \n ``process_response``\n@@ -120,6 +153,7 @@ an earlier middleware method returned an :class:`~django.http.HttpResponse`\n classes are applied in reverse order, from the bottom up. This means classes\n defined at the end of :setting:`MIDDLEWARE_CLASSES` will be run first.\n \n+\n .. _exception-middleware:\n \n ``process_exception``\n@@ -137,7 +171,7 @@ Django calls ``process_exception()`` when a view raises an exception.\n the browser. Otherwise, default exception handling kicks in.\n \n Again, middleware are run in reverse order during the response phase, which\n-includes ``process_exception``. If an exception middleware return a response,\n+includes ``process_exception``. If an exception middleware returns a response,\n the middleware classes above that middleware will not be called at all.\n \n ``__init__``"
        },
        {
            "sha": "f356c90a74725781e3f98325fffdeaa364d87aa1",
            "filename": "tests/regressiontests/generic_views/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fgeneric_views%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fgeneric_views%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Fbase.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -156,6 +156,7 @@ class TemplateViewTest(TestCase):\n     rf = RequestFactory()\n \n     def _assert_about(self, response):\n+        response.render()\n         self.assertEqual(response.status_code, 200)\n         self.assertEqual(response.content, '<h1>About</h1>')\n "
        },
        {
            "sha": "e68cd523135767838a33c83637ab2ea3ab7aac97",
            "filename": "tests/regressiontests/middleware_exceptions/tests.py",
            "status": "modified",
            "additions": 191,
            "deletions": 122,
            "changes": 313,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fmiddleware_exceptions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fmiddleware_exceptions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware_exceptions%2Ftests.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -3,9 +3,10 @@\n from django.conf import settings\n from django.core.signals import got_request_exception\n from django.http import HttpResponse\n+from django.template.response import TemplateResponse\n+from django.template import Template\n from django.test import TestCase\n \n-\n class TestException(Exception):\n     pass\n \n@@ -16,6 +17,7 @@ def __init__(self):\n         self.process_request_called = False\n         self.process_view_called = False\n         self.process_response_called = False\n+        self.process_template_response_called = False\n         self.process_exception_called = False\n \n     def process_request(self, request):\n@@ -24,6 +26,10 @@ def process_request(self, request):\n     def process_view(self, request, view_func, view_args, view_kwargs):\n         self.process_view_called = True\n \n+    def process_template_response(self, request, response):\n+        self.process_template_response_called = True\n+        return response\n+\n     def process_response(self, request, response):\n         self.process_response_called = True\n         return response\n@@ -48,6 +54,11 @@ def process_response(self, request, response):\n         super(ResponseMiddleware, self).process_response(request, response)\n         return HttpResponse('Response Middleware')\n \n+class TemplateResponseMiddleware(TestMiddleware):\n+    def process_template_response(self, request, response):\n+        super(TemplateResponseMiddleware, self).process_template_response(request, response)\n+        return TemplateResponse(request, Template('Template Response Middleware'))\n+\n class ExceptionMiddleware(TestMiddleware):\n     def process_exception(self, request, exception):\n         super(ExceptionMiddleware, self).process_exception(request, exception)\n@@ -66,6 +77,11 @@ def process_view(self, request, view_func, view_args, view_kwargs):\n         super(BadViewMiddleware, self).process_view(request, view_func, view_args, view_kwargs)\n         raise TestException('Test View Exception')\n \n+class BadTemplateResponseMiddleware(TestMiddleware):\n+    def process_template_response(self, request, response):\n+        super(BadTemplateResponseMiddleware, self).process_template_response(request, response)\n+        raise TestException('Test Template Response Exception')\n+\n class BadResponseMiddleware(TestMiddleware):\n     def process_response(self, request, response):\n         super(BadResponseMiddleware, self).process_response(request, response)\n@@ -93,6 +109,7 @@ def _on_request_exception(self, sender, request, **kwargs):\n     def _add_middleware(self, middleware):\n         self.client.handler._request_middleware.insert(0, middleware.process_request)\n         self.client.handler._view_middleware.insert(0, middleware.process_view)\n+        self.client.handler._template_response_middleware.append(middleware.process_template_response)\n         self.client.handler._response_middleware.append(middleware.process_response)\n         self.client.handler._exception_middleware.append(middleware.process_exception)\n \n@@ -113,9 +130,10 @@ def assert_exceptions_handled(self, url, errors, extra_error=None):\n             exception, value, tb = self.exceptions[i]\n             self.assertEquals(value.args, (error, ))\n \n-    def assert_middleware_usage(self, middleware, request, view, response, exception):\n+    def assert_middleware_usage(self, middleware, request, view, template_response, response, exception):\n         self.assertEqual(middleware.process_request_called, request)\n         self.assertEqual(middleware.process_view_called, view)\n+        self.assertEqual(middleware.process_template_response_called, template_response)\n         self.assertEqual(middleware.process_response_called, response)\n         self.assertEqual(middleware.process_exception_called, exception)\n \n@@ -132,9 +150,9 @@ def test_process_request_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(middleware,      True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(middleware,      True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_middleware(self):\n         pre_middleware = TestMiddleware()\n@@ -146,9 +164,9 @@ def test_process_view_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_middleware(self):\n         pre_middleware = TestMiddleware()\n@@ -160,9 +178,23 @@ def test_process_response_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True,  False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, False)\n+\n+    def test_process_template_response_middleware(self):\n+        pre_middleware = TestMiddleware()\n+        middleware = TemplateResponseMiddleware()\n+        post_middleware = TestMiddleware()\n+        self._add_middleware(post_middleware)\n+        self._add_middleware(middleware)\n+        self._add_middleware(pre_middleware)\n+        self.assert_exceptions_handled('/middleware_exceptions/template_response/', [])\n+\n+        # Check that the right middleware methods have been invoked\n+        self.assert_middleware_usage(pre_middleware,  True, True, True, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, True, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, True, True, False)\n \n     def test_process_exception_middleware(self):\n         pre_middleware = TestMiddleware()\n@@ -174,9 +206,9 @@ def test_process_exception_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, False)\n \n     def test_process_request_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -188,9 +220,9 @@ def test_process_request_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(middleware,      True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(middleware,      True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -202,9 +234,23 @@ def test_process_view_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n+\n+    def test_process_template_response_middleware_not_found(self):\n+        pre_middleware = TestMiddleware()\n+        middleware = TemplateResponseMiddleware()\n+        post_middleware = TestMiddleware()\n+        self._add_middleware(post_middleware)\n+        self._add_middleware(middleware)\n+        self._add_middleware(pre_middleware)\n+        self.assert_exceptions_handled('/middleware_exceptions/not_found/', [])\n+\n+        # Check that the right middleware methods have been invoked\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_response_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -216,9 +262,9 @@ def test_process_response_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_exception_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -230,9 +276,9 @@ def test_process_exception_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_request_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -244,9 +290,9 @@ def test_process_request_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(middleware,      True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -258,9 +304,9 @@ def test_process_view_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -272,9 +318,9 @@ def test_process_response_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', ['Error in view'], Exception())\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_exception_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -286,9 +332,9 @@ def test_process_exception_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_request_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -300,9 +346,9 @@ def test_process_request_middleware_null_view(self):\n         self.assert_exceptions_handled('/middleware_exceptions/null_view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(middleware,      True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(middleware,      True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -314,9 +360,9 @@ def test_process_view_middleware_null_view(self):\n         self.assert_exceptions_handled('/middleware_exceptions/null_view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -331,9 +377,9 @@ def test_process_response_middleware_null_view(self):\n             ValueError())\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True,  False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, False)\n \n     def test_process_exception_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -348,9 +394,9 @@ def test_process_exception_middleware_null_view(self):\n             ValueError())\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, False)\n \n     def test_process_request_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -362,9 +408,9 @@ def test_process_request_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(middleware,      True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(middleware,      True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -376,9 +422,9 @@ def test_process_view_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,      True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -390,9 +436,9 @@ def test_process_response_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(middleware,      True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_exception_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -404,9 +450,18 @@ def test_process_exception_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(middleware,      True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n+\n+    def test_process_template_response_error(self):\n+        middleware = TestMiddleware()\n+        self._add_middleware(middleware)\n+        self.assert_exceptions_handled('/middleware_exceptions/template_response_error/', [])\n+\n+        # Check that the right middleware methods have been invoked\n+        self.assert_middleware_usage(middleware, True, True, True, True, False)\n+\n \n class BadMiddlewareTests(BaseMiddlewareExceptionTest):\n \n@@ -420,9 +475,9 @@ def test_process_request_bad_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', ['Test Request Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(bad_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_bad_middleware(self):\n         pre_middleware = TestMiddleware()\n@@ -434,9 +489,23 @@ def test_process_view_bad_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', ['Test View Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n+\n+    def test_process_template_response_bad_middleware(self):\n+        pre_middleware = TestMiddleware()\n+        bad_middleware = BadTemplateResponseMiddleware()\n+        post_middleware = TestMiddleware()\n+        self._add_middleware(post_middleware)\n+        self._add_middleware(bad_middleware)\n+        self._add_middleware(pre_middleware)\n+        self.assert_exceptions_handled('/middleware_exceptions/template_response/', ['Test Template Response Exception'])\n+\n+        # Check that the right middleware methods have been invoked\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, False, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, True,  False, False)\n+        self.assert_middleware_usage(post_middleware, True, True, True,  False, False)\n \n     def test_process_response_bad_middleware(self):\n         pre_middleware = TestMiddleware()\n@@ -448,9 +517,9 @@ def test_process_response_bad_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', ['Test Response Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  False, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, False, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True,  False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True,  False)\n \n     def test_process_exception_bad_middleware(self):\n         pre_middleware = TestMiddleware()\n@@ -462,9 +531,9 @@ def test_process_exception_bad_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/view/', [])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, False)\n \n     def test_process_request_bad_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -476,9 +545,9 @@ def test_process_request_bad_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', ['Test Request Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(bad_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_bad_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -490,9 +559,9 @@ def test_process_view_bad_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', ['Test View Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_bad_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -504,9 +573,9 @@ def test_process_response_bad_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', ['Test Response Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  False, True)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, False, True)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True,  True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True,  True)\n \n     def test_process_exception_bad_middleware_not_found(self):\n         pre_middleware = TestMiddleware()\n@@ -518,9 +587,9 @@ def test_process_exception_bad_middleware_not_found(self):\n         self.assert_exceptions_handled('/middleware_exceptions/not_found/', ['Test Exception Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_request_bad_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -532,9 +601,9 @@ def test_process_request_bad_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', ['Test Request Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(bad_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_bad_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -546,9 +615,9 @@ def test_process_view_bad_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', ['Test View Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_bad_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -560,9 +629,9 @@ def test_process_response_bad_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', ['Error in view', 'Test Response Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  False, True)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, False, True)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True,  True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True,  True)\n \n     def test_process_exception_bad_middleware_exception(self):\n         pre_middleware = TestMiddleware()\n@@ -574,9 +643,9 @@ def test_process_exception_bad_middleware_exception(self):\n         self.assert_exceptions_handled('/middleware_exceptions/error/', ['Test Exception Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n     def test_process_request_bad_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -588,9 +657,9 @@ def test_process_request_bad_middleware_null_view(self):\n         self.assert_exceptions_handled('/middleware_exceptions/null_view/', ['Test Request Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(bad_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_bad_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -602,9 +671,9 @@ def test_process_view_bad_middleware_null_view(self):\n         self.assert_exceptions_handled('/middleware_exceptions/null_view/', ['Test View Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_bad_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -619,9 +688,9 @@ def test_process_response_bad_middleware_null_view(self):\n             ])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  False, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, False, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True,  False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True,  False)\n \n     def test_process_exception_bad_middleware_null_view(self):\n         pre_middleware = TestMiddleware()\n@@ -636,9 +705,9 @@ def test_process_exception_bad_middleware_null_view(self):\n             ValueError())\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, False)\n \n     def test_process_request_bad_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -650,9 +719,9 @@ def test_process_request_bad_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', ['Test Request Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(bad_middleware,  True,  False, True,  False)\n-        self.assert_middleware_usage(post_middleware, False, False, True,  False)\n+        self.assert_middleware_usage(pre_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True,  False, False, True, False)\n+        self.assert_middleware_usage(post_middleware, False, False, False, True, False)\n \n     def test_process_view_bad_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -664,9 +733,9 @@ def test_process_view_bad_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', ['Test View Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(post_middleware, True,  False, True, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True,  False, True, False)\n+        self.assert_middleware_usage(post_middleware, True, False, False, True, False)\n \n     def test_process_response_bad_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -678,9 +747,9 @@ def test_process_response_bad_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', ['Test Response Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  False, True)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, False, True)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True,  True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True,  True)\n \n     def test_process_exception_bad_middleware_permission_denied(self):\n         pre_middleware = TestMiddleware()\n@@ -692,9 +761,9 @@ def test_process_exception_bad_middleware_permission_denied(self):\n         self.assert_exceptions_handled('/middleware_exceptions/permission_denied/', ['Test Exception Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True,  True,  True, False)\n-        self.assert_middleware_usage(bad_middleware,  True,  True,  True,  True)\n-        self.assert_middleware_usage(post_middleware, True,  True,  True,  True)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, False, True, True)\n+        self.assert_middleware_usage(post_middleware, True, True, False, True, True)\n \n \n _missing = object()"
        },
        {
            "sha": "37d47f796ae0ff81d1072207ff718d967ea9d91e",
            "filename": "tests/regressiontests/middleware_exceptions/urls.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fmiddleware_exceptions%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fmiddleware_exceptions%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware_exceptions%2Furls.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -9,4 +9,7 @@\n     (r'^error/$', views.server_error),\n     (r'^null_view/$', views.null_view),\n     (r'^permission_denied/$', views.permission_denied),\n+\n+    (r'^template_response/$', views.template_response),\n+    (r'^template_response_error/$', views.template_response_error),\n )"
        },
        {
            "sha": "ddf28c46a39a444a2cf79520f36b7eafa13ae59f",
            "filename": "tests/regressiontests/middleware_exceptions/views.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fmiddleware_exceptions%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fmiddleware_exceptions%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware_exceptions%2Fviews.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -1,9 +1,18 @@\n from django import http\n from django.core.exceptions import PermissionDenied\n+from django.template import Template\n+from django.template.response import TemplateResponse\n+\n \n def normal_view(request):\n     return http.HttpResponse('OK')\n \n+def template_response(request):\n+    return TemplateResponse(request, Template('OK'))\n+\n+def template_response_error(request):\n+    return TemplateResponse(request, Template('{%'))\n+\n def not_found(request):\n     raise http.Http404()\n "
        },
        {
            "sha": "8bdf7f419659d67fb6dcc501611d2708ea7b34d7",
            "filename": "tests/regressiontests/templates/response.py",
            "status": "added",
            "additions": 174,
            "deletions": 0,
            "changes": 174,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fresponse.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -0,0 +1,174 @@\n+import os\n+from django.utils import unittest\n+from django.test import RequestFactory\n+from django.conf import settings\n+import django.template.context\n+from django.template import Template, Context, RequestContext\n+from django.template.response import (TemplateResponse, SimpleTemplateResponse,\n+                                      ContentNotRenderedError)\n+\n+def test_processor(request):\n+    return {'processors': 'yes'}\n+test_processor_name = 'regressiontests.templates.response.test_processor'\n+\n+class BaseTemplateResponseTest(unittest.TestCase):\n+    # tests rely on fact that global context\n+    # processors should only work when RequestContext is used.\n+\n+    def setUp(self):\n+        self.factory = RequestFactory()\n+        self._old_processors = settings.TEMPLATE_CONTEXT_PROCESSORS\n+        self._old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n+        settings.TEMPLATE_CONTEXT_PROCESSORS = [test_processor_name]\n+        settings.TEMPLATE_DIRS = (\n+            os.path.join(\n+                os.path.dirname(__file__),\n+                'templates'\n+            ),\n+        )\n+        # Force re-evaluation of the contex processor list\n+        django.template.context._standard_context_processors = None\n+\n+    def tearDown(self):\n+        settings.TEMPLATE_DIRS = self._old_TEMPLATE_DIRS\n+        settings.TEMPLATE_CONTEXT_PROCESSORS = self._old_processors\n+        # Force re-evaluation of the contex processor list\n+        django.template.context._standard_context_processors = None\n+\n+\n+class SimpleTemplateResponseTest(BaseTemplateResponseTest):\n+\n+    def _response(self, template='foo', *args, **kwargs):\n+        return SimpleTemplateResponse(Template(template), *args, **kwargs)\n+\n+    def test_template_resolving(self):\n+        response = SimpleTemplateResponse('first/test.html')\n+        response.render()\n+        self.assertEqual('First template\\n', response.content)\n+\n+        templates = ['foo.html', 'second/test.html', 'first/test.html']\n+        response = SimpleTemplateResponse(templates)\n+        response.render()\n+        self.assertEqual('Second template\\n', response.content)\n+\n+        response = self._response()\n+        response.render()\n+        self.assertEqual(response.content, 'foo')\n+\n+    def test_explicit_baking(self):\n+        # explicit baking\n+        response = self._response()\n+        self.assertFalse(response.is_rendered)\n+        response.render()\n+        self.assertTrue(response.is_rendered)\n+\n+    def test_render(self):\n+        # response is not re-rendered without the render call\n+        response = self._response().render()\n+        self.assertEqual(response.content, 'foo')\n+\n+        # rebaking doesn't change the rendered content\n+        response.template_name = Template('bar{{ baz }}')\n+        response.render()\n+        self.assertEqual(response.content, 'foo')\n+\n+        # but rendered content can be overridden by manually\n+        # setting content\n+        response.content = 'bar'\n+        self.assertEqual(response.content, 'bar')\n+\n+    def test_iteration_unrendered(self):\n+        # unrendered response raises an exception on iteration\n+        response = self._response()\n+        self.assertFalse(response.is_rendered)\n+\n+        def iteration():\n+            for x in response:\n+                pass\n+        self.assertRaises(ContentNotRenderedError, iteration)\n+        self.assertFalse(response.is_rendered)\n+\n+    def test_iteration_rendered(self):\n+        # iteration works for rendered responses\n+        response = self._response().render()\n+        res = [x for x in response]\n+        self.assertEqual(res, ['foo'])\n+\n+    def test_content_access_unrendered(self):\n+        # unrendered response raises an exception when content is accessed\n+        response = self._response()\n+        self.assertFalse(response.is_rendered)\n+        self.assertRaises(ContentNotRenderedError, lambda: response.content)\n+        self.assertFalse(response.is_rendered)\n+\n+    def test_content_access_rendered(self):\n+        # rendered response content can be accessed\n+        response = self._response().render()\n+        self.assertEqual(response.content, 'foo')\n+\n+    def test_set_content(self):\n+        # content can be overriden\n+        response = self._response()\n+        self.assertFalse(response.is_rendered)\n+        response.content = 'spam'\n+        self.assertTrue(response.is_rendered)\n+        self.assertEqual(response.content, 'spam')\n+        response.content = 'baz'\n+        self.assertEqual(response.content, 'baz')\n+\n+    def test_dict_context(self):\n+        response = self._response('{{ foo }}{{ processors }}',\n+                                  {'foo': 'bar'})\n+        self.assertEqual(response.context_data, {'foo': 'bar'})\n+        response.render()\n+        self.assertEqual(response.content, 'bar')\n+\n+    def test_context_instance(self):\n+        response = self._response('{{ foo }}{{ processors }}',\n+                                  Context({'foo': 'bar'}))\n+        self.assertEqual(response.context_data.__class__, Context)\n+        response.render()\n+        self.assertEqual(response.content, 'bar')\n+\n+    def test_kwargs(self):\n+        response = self._response(content_type = 'application/json', status=504)\n+        self.assertEqual(response['content-type'], 'application/json')\n+        self.assertEqual(response.status_code, 504)\n+\n+    def test_args(self):\n+        response = SimpleTemplateResponse('', {}, 'application/json', 504)\n+        self.assertEqual(response['content-type'], 'application/json')\n+        self.assertEqual(response.status_code, 504)\n+\n+\n+class TemplateResponseTest(BaseTemplateResponseTest):\n+\n+    def _response(self, template='foo', *args, **kwargs):\n+        return TemplateResponse(self.factory.get('/'), Template(template),\n+                                *args, **kwargs)\n+\n+    def test_render(self):\n+        response = self._response('{{ foo }}{{ processors }}').render()\n+        self.assertEqual(response.content, 'yes')\n+\n+    def test_render_with_requestcontext(self):\n+        response = self._response('{{ foo }}{{ processors }}',\n+                                  {'foo': 'bar'}).render()\n+        self.assertEqual(response.content, 'baryes')\n+\n+    def test_render_with_context(self):\n+        response = self._response('{{ foo }}{{ processors }}',\n+                                  Context({'foo': 'bar'})).render()\n+        self.assertEqual(response.content, 'bar')\n+\n+    def test_kwargs(self):\n+        response = self._response(content_type = 'application/json',\n+                                  status=504)\n+        self.assertEqual(response['content-type'], 'application/json')\n+        self.assertEqual(response.status_code, 504)\n+\n+    def test_args(self):\n+        response = TemplateResponse(self.factory.get('/'), '', {},\n+                                    'application/json', 504)\n+        self.assertEqual(response['content-type'], 'application/json')\n+        self.assertEqual(response.status_code, 504)"
        },
        {
            "sha": "405b333addcfac0130aa2596ac906ff8e8a5e861",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -28,6 +28,7 @@\n from unicode import UnicodeTests\n from nodelist import NodelistTest\n from smartif import *\n+from response import *\n \n try:\n     from loaders import *"
        },
        {
            "sha": "259cb80a5ca400461d713d26991ea0eab5eeb491",
            "filename": "tests/regressiontests/views/templates/debug/render_test.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fviews%2Ftemplates%2Fdebug%2Frender_test.html",
            "raw_url": "https://github.com/django/django/raw/e0dcd7666aec15a2348bef346b4ce683ddf376b3/tests%2Fregressiontests%2Fviews%2Ftemplates%2Fdebug%2Frender_test.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftemplates%2Fdebug%2Frender_test.html?ref=e0dcd7666aec15a2348bef346b4ce683ddf376b3",
            "patch": "@@ -0,0 +1 @@\n+{{ foo }}.{{ bar }}.{{ baz }}.{{ processors }}"
        }
    ],
    "stats": {
        "total": 1052,
        "additions": 842,
        "deletions": 210
    }
}