{
    "author": "jezdez",
    "message": "Fixed #17602 -- Stopped the XML serializer from doing unneeded queries. Thanks, gnosek.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17439 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "62efdcb037da9df8fb1a3a29cabb517d49288b5d",
    "files": [
        {
            "sha": "6cdfc9f2406f0ed331637384dda4ad826cdbb087",
            "filename": "django/core/serializers/python.py",
            "status": "modified",
            "additions": 6,
            "deletions": 12,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/62efdcb037da9df8fb1a3a29cabb517d49288b5d/django%2Fcore%2Fserializers%2Fpython.py",
            "raw_url": "https://github.com/django/django/raw/62efdcb037da9df8fb1a3a29cabb517d49288b5d/django%2Fcore%2Fserializers%2Fpython.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fserializers%2Fpython.py?ref=62efdcb037da9df8fb1a3a29cabb517d49288b5d",
            "patch": "@@ -45,18 +45,12 @@ def handle_field(self, obj, field):\n             self._current[field.name] = field.value_to_string(obj)\n \n     def handle_fk_field(self, obj, field):\n-        related = getattr(obj, field.name)\n-        if related is not None:\n-            if self.use_natural_keys and hasattr(related, 'natural_key'):\n-                related = related.natural_key()\n-            else:\n-                if field.rel.field_name == related._meta.pk.name:\n-                    # Related to remote object via primary key\n-                    related = related._get_pk_val()\n-                else:\n-                    # Related to remote object via other field\n-                    related = smart_unicode(getattr(related, field.rel.field_name), strings_only=True)\n-        self._current[field.name] = related\n+        if self.use_natural_keys and hasattr(field.rel.to, 'natural_key'):\n+            related = getattr(obj, field.name)\n+            value = related.natural_key()\n+        else:\n+            value = getattr(obj, field.get_attname())\n+        self._current[field.name] = value\n \n     def handle_m2m_field(self, obj, field):\n         if field.rel.through._meta.auto_created:"
        },
        {
            "sha": "a5edeac5af03693981f6c1140c85243b789ca2fb",
            "filename": "django/core/serializers/xml_serializer.py",
            "status": "modified",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/62efdcb037da9df8fb1a3a29cabb517d49288b5d/django%2Fcore%2Fserializers%2Fxml_serializer.py",
            "raw_url": "https://github.com/django/django/raw/62efdcb037da9df8fb1a3a29cabb517d49288b5d/django%2Fcore%2Fserializers%2Fxml_serializer.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fserializers%2Fxml_serializer.py?ref=62efdcb037da9df8fb1a3a29cabb517d49288b5d",
            "patch": "@@ -85,9 +85,10 @@ def handle_fk_field(self, obj, field):\n         differently from regular fields).\n         \"\"\"\n         self._start_relational_field(field)\n-        related = getattr(obj, field.name)\n-        if related is not None:\n-            if self.use_natural_keys and hasattr(related, 'natural_key'):\n+        related_att = getattr(obj, field.get_attname())\n+        if related_att is not None:\n+            if self.use_natural_keys and hasattr(field.rel.to, 'natural_key'):\n+                related = getattr(obj, field.name)\n                 # If related object has a natural key, use it\n                 related = related.natural_key()\n                 # Iterable natural keys are rolled out as subelements\n@@ -96,13 +97,7 @@ def handle_fk_field(self, obj, field):\n                     self.xml.characters(smart_unicode(key_value))\n                     self.xml.endElement(\"natural\")\n             else:\n-                if field.rel.field_name == related._meta.pk.name:\n-                    # Related to remote object via primary key\n-                    related = related._get_pk_val()\n-                else:\n-                    # Related to remote object via other field\n-                    related = getattr(related, field.rel.field_name)\n-                self.xml.characters(smart_unicode(related))\n+                self.xml.characters(smart_unicode(related_att))\n         else:\n             self.xml.addQuickElement(\"None\")\n         self.xml.endElement(\"field\")"
        },
        {
            "sha": "309a83e8b4796d982962347372ea126cab24d6bb",
            "filename": "tests/modeltests/serializers/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/62efdcb037da9df8fb1a3a29cabb517d49288b5d/tests%2Fmodeltests%2Fserializers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/62efdcb037da9df8fb1a3a29cabb517d49288b5d/tests%2Fmodeltests%2Fserializers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fserializers%2Ftests.py?ref=62efdcb037da9df8fb1a3a29cabb517d49288b5d",
            "patch": "@@ -178,6 +178,19 @@ def test_serialize_unicode(self):\n         mv_obj = obj_list[0].object\n         self.assertEqual(mv_obj.title, movie_title)\n \n+    def test_serialize_superfluous_queries(self):\n+        \"\"\"Ensure no superfluous queries are made when serializing ForeignKeys\n+\n+        #17602\n+        \"\"\"\n+        ac = Actor(name='Actor name')\n+        ac.save()\n+        mv = Movie(title='Movie title', actor_id=ac.pk)\n+        mv.save()\n+\n+        with self.assertNumQueries(0):\n+            serial_str = serializers.serialize(self.serializer_name, [mv])\n+\n     def test_serialize_with_null_pk(self):\n         \"\"\"\n         Tests that serialized data with no primary key results"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 24,
        "deletions": 22
    }
}