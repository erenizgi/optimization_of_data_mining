{
    "author": "aaugustin",
    "message": "Fixed #18153 -- Reverse OneToOne lookups on unsaved instances.\n\nThanks David Hatch and Anssi Kääriäinen for their inputs.",
    "sha": "3190abcd75b1fcd660353da4001885ef82cbc596",
    "files": [
        {
            "sha": "a7af2377142be76c0ef2207142c0bee24b258532",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/3190abcd75b1fcd660353da4001885ef82cbc596/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/3190abcd75b1fcd660353da4001885ef82cbc596/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=3190abcd75b1fcd660353da4001885ef82cbc596",
            "patch": "@@ -261,13 +261,17 @@ def __get__(self, instance, instance_type=None):\n         try:\n             rel_obj = getattr(instance, self.cache_name)\n         except AttributeError:\n-            params = {'%s__pk' % self.related.field.name: instance._get_pk_val()}\n-            try:\n-                rel_obj = self.get_query_set(instance=instance).get(**params)\n-            except self.related.model.DoesNotExist:\n+            related_pk = instance._get_pk_val()\n+            if related_pk is None:\n                 rel_obj = None\n             else:\n-                setattr(rel_obj, self.related.field.get_cache_name(), instance)\n+                params = {'%s__pk' % self.related.field.name: related_pk}\n+                try:\n+                    rel_obj = self.get_query_set(instance=instance).get(**params)\n+                except self.related.model.DoesNotExist:\n+                    rel_obj = None\n+                else:\n+                    setattr(rel_obj, self.related.field.get_cache_name(), instance)\n             setattr(instance, self.cache_name, rel_obj)\n         if rel_obj is None:\n             raise self.related.model.DoesNotExist\n@@ -301,8 +305,13 @@ def __set__(self, instance, value):\n                     raise ValueError('Cannot assign \"%r\": instance is on database \"%s\", value is on database \"%s\"' %\n                                         (value, instance._state.db, value._state.db))\n \n+        related_pk = getattr(instance, self.related.field.rel.get_related_field().attname)\n+        if related_pk is None:\n+            raise ValueError('Cannot assign \"%r\": \"%s\" instance isn\\'t saved in the database.' %\n+                                (value, self.related.opts.object_name))\n+\n         # Set the value of the related field to the value of the related object's related field\n-        setattr(value, self.related.field.attname, getattr(instance, self.related.field.rel.get_related_field().attname))\n+        setattr(value, self.related.field.attname, related_pk)\n \n         # Since we already know what the related object is, seed the related\n         # object caches now, too. This avoids another db hit if you get the"
        },
        {
            "sha": "615536ba386dc04ae4a494943306e4b75c521384",
            "filename": "tests/regressiontests/one_to_one_regress/tests.py",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/3190abcd75b1fcd660353da4001885ef82cbc596/tests%2Fregressiontests%2Fone_to_one_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3190abcd75b1fcd660353da4001885ef82cbc596/tests%2Fregressiontests%2Fone_to_one_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fone_to_one_regress%2Ftests.py?ref=3190abcd75b1fcd660353da4001885ef82cbc596",
            "patch": "@@ -202,3 +202,43 @@ def test_reverse_object_cached_when_related_is_unset(self):\n         with self.assertNumQueries(0):\n             with self.assertRaises(UndergroundBar.DoesNotExist):\n                 self.p1.undergroundbar\n+\n+    def test_get_reverse_on_unsaved_object(self):\n+        \"\"\"\n+        Regression for #18153 and #19089.\n+\n+        Accessing the reverse relation on an unsaved object\n+        always raises an exception.\n+        \"\"\"\n+        p = Place()\n+\n+        # When there's no instance of the origin of the one-to-one\n+        with self.assertNumQueries(0):\n+            with self.assertRaises(UndergroundBar.DoesNotExist):\n+                p.undergroundbar\n+\n+        UndergroundBar.objects.create()\n+\n+        # When there's one instance of the origin\n+        # (p.undergroundbar used to return that instance)\n+        with self.assertNumQueries(0):\n+            with self.assertRaises(UndergroundBar.DoesNotExist):\n+                p.undergroundbar\n+\n+        UndergroundBar.objects.create()\n+\n+        # When there are several instances of the origin\n+        with self.assertNumQueries(0):\n+            with self.assertRaises(UndergroundBar.DoesNotExist):\n+                p.undergroundbar\n+\n+    def test_set_reverse_on_unsaved_object(self):\n+        \"\"\"\n+        Writing to the reverse relation on an unsaved object\n+        is impossible too.\n+        \"\"\"\n+        p = Place()\n+        b = UndergroundBar.objects.create()\n+        with self.assertNumQueries(0):\n+            with self.assertRaises(ValueError):\n+                p.undergroundbar = b"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 55,
        "deletions": 6
    }
}