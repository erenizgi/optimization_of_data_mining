{
    "author": "ramiro",
    "message": "Fixed #16409 -- Fixed an error condition when using QuerySet only()/defer() on the result of an annotate() call. Thanks jaklaassen AT gmail DOT com and Tai Lee for the reports and Tai for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16522 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b2050ff546da4164f90a795e55d7d8c55981783d",
    "files": [
        {
            "sha": "57288f42dd7e8e6e3ac4ef3a45827697241f0422",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/b2050ff546da4164f90a795e55d7d8c55981783d/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/b2050ff546da4164f90a795e55d7d8c55981783d/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=b2050ff546da4164f90a795e55d7d8c55981783d",
            "patch": "@@ -231,9 +231,6 @@ def iterator(self):\n             fields = self.model._meta.fields\n             pk_idx = self.model._meta.pk_index()\n \n-        index_start = len(extra_select)\n-        aggregate_start = index_start + len(self.model._meta.fields)\n-\n         load_fields = []\n         # If only/defer clauses have been specified,\n         # build the list of fields that are to be loaded.\n@@ -253,6 +250,9 @@ def iterator(self):\n                     # Therefore, we need to load all fields from this model\n                     load_fields.append(field.name)\n \n+        index_start = len(extra_select)\n+        aggregate_start = index_start + len(load_fields or self.model._meta.fields)\n+\n         skip = None\n         if load_fields and not fill_cache:\n             # Some fields have been deferred, so we have to initialise"
        },
        {
            "sha": "b5f170eb49b366bcbe14887ecefb586879c7108f",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/b2050ff546da4164f90a795e55d7d8c55981783d/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/b2050ff546da4164f90a795e55d7d8c55981783d/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=b2050ff546da4164f90a795e55d7d8c55981783d",
            "patch": "@@ -169,7 +169,7 @@ def get_columns(self, with_aliases=False):\n                 if isinstance(col, (list, tuple)):\n                     alias, column = col\n                     table = self.query.alias_map[alias][TABLE_NAME]\n-                    if table in only_load and col not in only_load[table]:\n+                    if table in only_load and column not in only_load[table]:\n                         continue\n                     r = '%s.%s' % (qn(alias), qn(column))\n                     if with_aliases:"
        },
        {
            "sha": "b1d88e3f3697e5af11f27d7d0d0f501f0f4a3592",
            "filename": "tests/regressiontests/defer_regress/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/b2050ff546da4164f90a795e55d7d8c55981783d/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b2050ff546da4164f90a795e55d7d8c55981783d/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py?ref=b2050ff546da4164f90a795e55d7d8c55981783d",
            "patch": "@@ -4,6 +4,7 @@\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.sessions.backends.db import SessionStore\n from django.db import connection\n+from django.db.models import Count\n from django.db.models.loading import cache\n from django.test import TestCase\n \n@@ -148,6 +149,10 @@ def test():\n             ]\n         )\n \n+        # Regression for #16409 - make sure defer() and only() work with annotate()\n+        self.assertIsInstance(list(Item.objects.annotate(Count('relateditem')).defer('name')), list)\n+        self.assertIsInstance(list(Item.objects.annotate(Count('relateditem')).only('name')), list)\n+\n     def test_only_and_defer_usage_on_proxy_models(self):\n         # Regression for #15790 - only() broken for proxy models\n         proxy = Proxy.objects.create(name=\"proxy\", value=42)"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 9,
        "deletions": 4
    }
}