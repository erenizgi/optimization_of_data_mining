{
    "author": "jbronn",
    "message": "Fixed #15378 -- Now properly handle OGR layers that have features with invalid geometries.  Thanks, kunitoki for bug report and initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15813 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1fdbcadd223641f63d0548c39860d255cef325ed",
    "files": [
        {
            "sha": "aa2109047a4f7b5d4f7fdc372c065148aff5f8c7",
            "filename": "django/contrib/gis/tests/data/invalid/emptypoints.dbf",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.dbf",
            "raw_url": "https://github.com/django/django/raw/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.dbf",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.dbf?ref=1fdbcadd223641f63d0548c39860d255cef325ed"
        },
        {
            "sha": "bdcfb83be42f71ecb07c7d395f4c40e13e6cde16",
            "filename": "django/contrib/gis/tests/data/invalid/emptypoints.shp",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.shp",
            "raw_url": "https://github.com/django/django/raw/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.shp",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.shp?ref=1fdbcadd223641f63d0548c39860d255cef325ed"
        },
        {
            "sha": "dea663eb087d4a778415da28a9ee226864363515",
            "filename": "django/contrib/gis/tests/data/invalid/emptypoints.shx",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.shx",
            "raw_url": "https://github.com/django/django/raw/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.shx",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Finvalid%2Femptypoints.shx?ref=1fdbcadd223641f63d0548c39860d255cef325ed"
        },
        {
            "sha": "51213eb0b81607bec46dc38552f507d72cbd8f86",
            "filename": "django/contrib/gis/tests/layermap/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Fmodels.py?ref=1fdbcadd223641f63d0548c39860d255cef325ed",
            "patch": "@@ -43,6 +43,9 @@ class ICity1(CityBase):\n class ICity2(ICity1):\n     dt_time = models.DateTimeField(auto_now=True)\n \n+class Invalid(models.Model):\n+    point = models.PointField()\n+\n # Mapping dictionaries for the models above.\n co_mapping = {'name' : 'Name',\n               'state' : {'name' : 'State'}, # ForeignKey's use another mapping dictionary for the _related_ Model (State in this case)."
        },
        {
            "sha": "ad7a50462c231ce3f8b9ff3c0e1fea972db6c93e",
            "filename": "django/contrib/gis/tests/layermap/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py?ref=1fdbcadd223641f63d0548c39860d255cef325ed",
            "patch": "@@ -4,16 +4,19 @@\n from django.utils.copycompat import copy\n from django.utils.unittest import TestCase\n \n-from django.contrib.gis.gdal import DataSource\n+from django.contrib.gis.gdal import DataSource, OGRException\n from django.contrib.gis.tests.utils import mysql\n from django.contrib.gis.utils.layermapping import LayerMapping, LayerMapError, InvalidDecimal, MissingForeignKey\n \n-from models import City, County, CountyFeat, Interstate, ICity1, ICity2, State, city_mapping, co_mapping, cofeat_mapping, inter_mapping\n+from models import \\\n+    City, County, CountyFeat, Interstate, ICity1, ICity2, Invalid, State, \\\n+    city_mapping, co_mapping, cofeat_mapping, inter_mapping\n \n shp_path = os.path.realpath(os.path.join(os.path.dirname(__file__), os.pardir, 'data'))\n city_shp = os.path.join(shp_path, 'cities', 'cities.shp')\n co_shp = os.path.join(shp_path, 'counties', 'counties.shp')\n inter_shp = os.path.join(shp_path, 'interstates', 'interstates.shp')\n+invalid_shp = os.path.join(shp_path, 'invalid', 'emptypoints.shp')\n \n # Dictionaries to hold what's expected in the county shapefile.\n NAMES  = ['Bexar', 'Galveston', 'Harris', 'Honolulu', 'Pueblo']\n@@ -265,3 +268,10 @@ def test06_model_inheritance(self):\n \n         self.assertEqual(6, ICity1.objects.count())\n         self.assertEqual(3, ICity2.objects.count())\n+\n+    def test07_invalid_layer(self):\n+        \"Tests LayerMapping on invalid geometries.  See #15378.\"\n+        invalid_mapping = {'point': 'POINT'}\n+        lm = LayerMapping(Invalid, invalid_shp, invalid_mapping,\n+                          source_srs=4326)\n+        lm.save(silent=True)"
        },
        {
            "sha": "0f3a72213dc4b07f9037510b2dc0af87096f80aa",
            "filename": "django/contrib/gis/utils/layermapping.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "raw_url": "https://github.com/django/django/raw/1fdbcadd223641f63d0548c39860d255cef325ed/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py?ref=1fdbcadd223641f63d0548c39860d255cef325ed",
            "patch": "@@ -294,7 +294,10 @@ def feature_kwargs(self, feat):\n \n             if isinstance(model_field, GeometryField):\n                 # Verify OGR geometry.\n-                val = self.verify_geom(feat.geom, model_field)\n+                try:\n+                    val = self.verify_geom(feat.geom, model_field)\n+                except OGRException:\n+                    raise LayerMapError('Could not retrieve geometry from feature.')\n             elif isinstance(model_field, models.base.ModelBase):\n                 # The related _model_, not a field was passed in -- indicating\n                 # another mapping for the related Model."
        }
    ],
    "stats": {
        "total": 22,
        "additions": 19,
        "deletions": 3
    }
}