{
    "author": "alex",
    "message": "Cleaned up how ``request.user`` is set, this is a follow up to [16297]. Thanks for the review Luke.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16305 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1cfb00dc4164f7a5342c1866a50485b1c2845cb7",
    "files": [
        {
            "sha": "3ffab01e94bb53b68cb220686a533d9f9c0f5206",
            "filename": "django/contrib/auth/context_processors.py",
            "status": "modified",
            "additions": 7,
            "deletions": 19,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/1cfb00dc4164f7a5342c1866a50485b1c2845cb7/django%2Fcontrib%2Fauth%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/1cfb00dc4164f7a5342c1866a50485b1c2845cb7/django%2Fcontrib%2Fauth%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fcontext_processors.py?ref=1cfb00dc4164f7a5342c1866a50485b1c2845cb7",
            "patch": "@@ -1,5 +1,3 @@\n-from django.utils.functional import lazy, memoize, SimpleLazyObject\n-\n # PermWrapper and PermLookupDict proxy the permissions system into objects that\n # the template system can understand.\n \n@@ -36,23 +34,13 @@ def auth(request):\n     If there is no 'user' attribute in the request, uses AnonymousUser (from\n     django.contrib.auth).\n     \"\"\"\n-    # If we access request.user, request.session is accessed, which results in\n-    # 'Vary: Cookie' being sent in every request that uses this context\n-    # processor, which can easily be every request on a site if\n-    # TEMPLATE_CONTEXT_PROCESSORS has this context processor added.  This kills\n-    # the ability to cache.  So, we carefully ensure these attributes are lazy.\n-    # We don't use django.utils.functional.lazy() for User, because that\n-    # requires knowing the class of the object we want to proxy, which could\n-    # break with custom auth backends.  LazyObject is a less complete but more\n-    # flexible solution that is a good enough wrapper for 'User'.\n-    def get_user():\n-        if hasattr(request, 'user'):\n-            return request.user\n-        else:\n-            from django.contrib.auth.models import AnonymousUser\n-            return AnonymousUser()\n+    if hasattr(request, 'user'):\n+        user = request.user\n+    else:\n+        from django.contrib.auth.models import AnonymousUser\n+        user = AnonymousUser()\n \n     return {\n-        'user': SimpleLazyObject(get_user),\n-        'perms':  lazy(lambda: PermWrapper(get_user()), PermWrapper)(),\n+        'user': user,\n+        'perms': PermWrapper(user),\n     }"
        },
        {
            "sha": "1cd8ae588516c60be198f37f0e7d0e36da3c56de",
            "filename": "django/contrib/auth/middleware.py",
            "status": "modified",
            "additions": 8,
            "deletions": 13,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/1cfb00dc4164f7a5342c1866a50485b1c2845cb7/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/1cfb00dc4164f7a5342c1866a50485b1c2845cb7/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmiddleware.py?ref=1cfb00dc4164f7a5342c1866a50485b1c2845cb7",
            "patch": "@@ -1,26 +1,21 @@\n from django.contrib import auth\n from django.core.exceptions import ImproperlyConfigured\n+from django.utils.functional import SimpleLazyObject\n \n \n-class LazyUser(object):\n-    def __get__(self, request, obj_type=None):\n-        if not hasattr(request, '_cached_user'):\n-            from django.contrib.auth import get_user\n-            request._cached_user = get_user(request)\n-        return request._cached_user\n+def get_user(request):\n+    from django.contrib.auth import get_user\n+\n+    if not hasattr(request, '_cached_user'):\n+        request._cached_user = get_user(request)\n+    return request._cached_user\n \n \n class AuthenticationMiddleware(object):\n     def process_request(self, request):\n         assert hasattr(request, 'session'), \"The Django authentication middleware requires session middleware to be installed. Edit your MIDDLEWARE_CLASSES setting to insert 'django.contrib.sessions.middleware.SessionMiddleware'.\"\n \n-        # We dynamically subclass request.__class__ rather than monkey patch the\n-        # original class.\n-        class RequestWithUser(request.__class__):\n-            user = LazyUser()\n-\n-        request.__class__ = RequestWithUser\n-        return None\n+        request.user = SimpleLazyObject(lambda: get_user(request))\n \n \n class RemoteUserMiddleware(object):"
        },
        {
            "sha": "b0233de6edce8e693e17a7fbd986204380a64578",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/1cfb00dc4164f7a5342c1866a50485b1c2845cb7/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/1cfb00dc4164f7a5342c1866a50485b1c2845cb7/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=1cfb00dc4164f7a5342c1866a50485b1c2845cb7",
            "patch": "@@ -208,7 +208,7 @@ def _setup(self):\n     def __dir__(self):\n         if self._wrapped is None:\n             self._setup()\n-        return  dir(self._wrapped)\n+        return dir(self._wrapped)\n \n class SimpleLazyObject(LazyObject):\n     \"\"\"\n@@ -227,9 +227,7 @@ def __init__(self, func):\n         value.\n         \"\"\"\n         self.__dict__['_setupfunc'] = func\n-        # For some reason, we have to inline LazyObject.__init__ here to avoid\n-        # recursion\n-        self._wrapped = None\n+        super(SimpleLazyObject, self).__init__()\n \n     def __str__(self):\n         if self._wrapped is None: self._setup()"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 17,
        "deletions": 36
    }
}