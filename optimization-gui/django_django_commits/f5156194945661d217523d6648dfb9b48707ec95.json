{
    "author": "aaugustin",
    "message": "Added an API to control database-level autocommit.",
    "sha": "f5156194945661d217523d6648dfb9b48707ec95",
    "files": [
        {
            "sha": "379416fad7174761724a9bd47cd47c720f3a2789",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -44,6 +44,7 @@ def __init__(self, settings_dict, alias=DEFAULT_DB_ALIAS,\n         self.savepoint_state = 0\n \n         # Transaction management related attributes\n+        self.autocommit = False\n         self.transaction_state = []\n         # Tracks if the connection is believed to be in transaction. This is\n         # set somewhat aggressively, as the DBAPI doesn't make it easy to\n@@ -232,6 +233,12 @@ def _leave_transaction_management(self, managed):\n         \"\"\"\n         pass\n \n+    def _set_autocommit(self, autocommit):\n+        \"\"\"\n+        Backend-specific implementation to enable or disable autocommit.\n+        \"\"\"\n+        raise NotImplementedError\n+\n     ##### Generic transaction management methods #####\n \n     def enter_transaction_management(self, managed=True, forced=False):\n@@ -274,6 +281,13 @@ def leave_transaction_management(self):\n             raise TransactionManagementError(\n                 \"Transaction managed block ended with pending COMMIT/ROLLBACK\")\n \n+    def set_autocommit(self, autocommit=True):\n+        \"\"\"\n+        Enable or disable autocommit.\n+        \"\"\"\n+        self._set_autocommit(autocommit)\n+        self.autocommit = autocommit\n+\n     def abort(self):\n         \"\"\"\n         Roll back any ongoing transaction and clean the transaction state"
        },
        {
            "sha": "aa4fb82b1294f2c9781bdc4684d78521c995315c",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -1,6 +1,7 @@\n import hashlib\n import sys\n import time\n+import warnings\n \n from django.conf import settings\n from django.db.utils import load_backend\n@@ -466,7 +467,10 @@ def set_autocommit(self):\n         anymore by Django code. Kept for compatibility with user code that\n         might use it.\n         \"\"\"\n-        pass\n+        warnings.warn(\n+            \"set_autocommit was moved from BaseDatabaseCreation to \"\n+            \"BaseDatabaseWrapper.\", PendingDeprecationWarning, stacklevel=2)\n+        return self.connection.set_autocommit()\n \n     def _prepare_for_test_db_ddl(self):\n         \"\"\""
        },
        {
            "sha": "a8c2d5badaa79f162f56e7c2147e0398c54243a6",
            "filename": "django/db/backends/dummy/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fdummy%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fdummy%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fdummy%2Fbase.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -57,6 +57,7 @@ class DatabaseWrapper(BaseDatabaseWrapper):\n     _savepoint_rollback = ignore\n     _enter_transaction_management = complain\n     _leave_transaction_management = ignore\n+    _set_autocommit = complain\n     set_dirty = complain\n     set_clean = complain\n     commit_unless_managed = complain"
        },
        {
            "sha": "39fd3695b7c26043fce6400e1081010621f63fff",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -445,6 +445,9 @@ def _rollback(self):\n         except Database.NotSupportedError:\n             pass\n \n+    def _set_autocommit(self, autocommit):\n+        self.connection.autocommit(autocommit)\n+\n     def disable_constraint_checking(self):\n         \"\"\"\n         Disables foreign key checks, primarily for use in adding rows with forward references. Always returns True,"
        },
        {
            "sha": "d895c1583ab4ff0a8140bad5e9909c53777386a7",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -612,6 +612,9 @@ def _commit(self):\n     def _savepoint_commit(self, sid):\n         pass\n \n+    def _set_autocommit(self, autocommit):\n+        self.connection.autocommit = autocommit\n+\n     def check_constraints(self, table_names=None):\n         \"\"\"\n         To check constraints, we set constraints to immediate. Then, when, we're done we must ensure they"
        },
        {
            "sha": "5485830bf56d7e3e298c2e3ed1cf35eed3564339",
            "filename": "django/db/backends/oracle/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -273,6 +273,3 @@ def test_db_signature(self):\n             settings_dict['NAME'],\n             self._test_database_user(),\n         )\n-\n-    def set_autocommit(self):\n-        self.connection.connection.autocommit = True"
        },
        {
            "sha": "a14844433e17e54447887c24f74ef0b77d774d7f",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -201,6 +201,14 @@ def _set_isolation_level(self, level):\n             self.isolation_level = level\n             self.features.uses_savepoints = bool(level)\n \n+    def _set_autocommit(self, autocommit):\n+        if autocommit:\n+            level = psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT\n+        else:\n+            level = self.settings_dict[\"OPTIONS\"].get('isolation_level',\n+                psycopg2.extensions.ISOLATION_LEVEL_READ_COMMITTED)\n+        self._set_isolation_level(level)\n+\n     def set_dirty(self):\n         if ((self.transaction_state and self.transaction_state[-1]) or\n                 not self.features.uses_autocommit):"
        },
        {
            "sha": "e6400d79a132f4723313f4adb6d65336dd1358d8",
            "filename": "django/db/backends/postgresql_psycopg2/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -78,9 +78,6 @@ def get_index_sql(index_name, opclass=''):\n                                             ' text_pattern_ops'))\n         return output\n \n-    def set_autocommit(self):\n-        self._prepare_for_test_db_ddl()\n-\n     def _prepare_for_test_db_ddl(self):\n         \"\"\"Rollback and close the active transaction.\"\"\"\n         # Make sure there is an open connection."
        },
        {
            "sha": "9a37dd17fefc2d5ef5d3a73a01eac7eefd65d03a",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -355,6 +355,17 @@ def close(self):\n         if self.settings_dict['NAME'] != \":memory:\":\n             BaseDatabaseWrapper.close(self)\n \n+    def _set_autocommit(self, autocommit):\n+        if autocommit:\n+            level = None\n+        else:\n+            # sqlite3's internal default is ''. It's different from None.\n+            # See Modules/_sqlite/connection.c.\n+            level = ''\n+        # 'isolation_level' is a misleading API.\n+        # SQLite always runs at the SERIALIZABLE isolation level.\n+        self.connection.isolation_level = level\n+\n     def check_constraints(self, table_names=None):\n         \"\"\"\n         Checks each table name in `table_names` for rows with invalid foreign key references. This method is"
        },
        {
            "sha": "a9fb273f7ad22eaccb2f0d407f7b71752368ff5a",
            "filename": "django/db/backends/sqlite3/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -72,9 +72,6 @@ def _destroy_test_db(self, test_database_name, verbosity):\n             # Remove the SQLite database file\n             os.remove(test_database_name)\n \n-    def set_autocommit(self):\n-        self.connection.connection.isolation_level = None\n-\n     def test_db_signature(self):\n         \"\"\"\n         Returns a tuple that uniquely identifies a test database."
        },
        {
            "sha": "dd48e14bf40d827e4d4fccc860584320797e49b0",
            "filename": "django/db/transaction.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Ftransaction.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Fdb%2Ftransaction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Ftransaction.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -39,6 +39,18 @@ def get_connection(using=None):\n         using = DEFAULT_DB_ALIAS\n     return connections[using]\n \n+def get_autocommit(using=None):\n+    \"\"\"\n+    Get the autocommit status of the connection.\n+    \"\"\"\n+    return get_connection(using).autocommit\n+\n+def set_autocommit(using=None, autocommit=True):\n+    \"\"\"\n+    Set the autocommit status of the connection.\n+    \"\"\"\n+    return get_connection(using).set_autocommit(autocommit)\n+\n def abort(using=None):\n     \"\"\"\n     Roll back any ongoing transactions and clean the transaction management"
        },
        {
            "sha": "4b9116e3bcb94b8643980aebe942c10735d3f145",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -63,6 +63,7 @@ def to_list(value):\n         value = [value]\n     return value\n \n+real_set_autocommit = transaction.set_autocommit\n real_commit = transaction.commit\n real_rollback = transaction.rollback\n real_enter_transaction_management = transaction.enter_transaction_management\n@@ -73,13 +74,15 @@ def nop(*args, **kwargs):\n     return\n \n def disable_transaction_methods():\n+    transaction.set_autocommit = nop\n     transaction.commit = nop\n     transaction.rollback = nop\n     transaction.enter_transaction_management = nop\n     transaction.leave_transaction_management = nop\n     transaction.abort = nop\n \n def restore_transaction_methods():\n+    transaction.set_autocommit = real_set_autocommit\n     transaction.commit = real_commit\n     transaction.rollback = real_rollback\n     transaction.enter_transaction_management = real_enter_transaction_management"
        },
        {
            "sha": "74fbb563f00b5f3c179ab493dba615dce5385e7a",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -348,9 +348,10 @@ these changes.\n * Remove the backward compatible shims introduced to rename the attributes\n   ``ChangeList.root_query_set`` and ``ChangeList.query_set``.\n \n-* The private API ``django.db.close_connection`` will be removed.\n-\n-* The private API ``django.transaction.managed`` will be removed.\n+* The following private APIs will be removed:\n+  - ``django.db.close_connection()``\n+  - ``django.db.backends.creation.BaseDatabaseCreation.set_autocommit()``\n+  - ``django.db.transaction.managed()``\n \n 2.0\n ---"
        },
        {
            "sha": "e145edf1492cc6ce6b2be1d23a9cba504dfe1d24",
            "filename": "docs/topics/db/transactions.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/f5156194945661d217523d6648dfb9b48707ec95/docs%2Ftopics%2Fdb%2Ftransactions.txt",
            "raw_url": "https://github.com/django/django/raw/f5156194945661d217523d6648dfb9b48707ec95/docs%2Ftopics%2Fdb%2Ftransactions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Ftransactions.txt?ref=f5156194945661d217523d6648dfb9b48707ec95",
            "patch": "@@ -208,6 +208,23 @@ This applies to all database operations, not just write operations. Even\n if your transaction only reads from the database, the transaction must\n be committed or rolled back before you complete a request.\n \n+.. _managing-autocommit:\n+\n+Managing autocommit\n+===================\n+\n+.. versionadded:: 1.6\n+\n+Django provides a straightforward API to manage the autocommit state of each\n+database connection, if you need to.\n+\n+.. function:: get_autocommit(using=None)\n+\n+.. function:: set_autocommit(using=None, autocommit=True)\n+\n+These functions take a ``using`` argument which should be the name of a\n+database. If it isn't provided, Django uses the ``\"default\"`` database.\n+\n .. _deactivate-transaction-management:\n \n How to globally deactivate transaction management"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 81,
        "deletions": 13
    }
}