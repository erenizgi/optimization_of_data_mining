{
    "author": "spookylukey",
    "message": "Fixed bug with our SimpleCookie regarding load/custom Morsel, and simplified implementation\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16526 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6d029359e955a6a5fd7e4024ddd9159004c30d20",
    "files": [
        {
            "sha": "c97b402f482e493dd9e7a6dbb62cdded2fcf1781",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 7,
            "deletions": 14,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/6d029359e955a6a5fd7e4024ddd9159004c30d20/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/6d029359e955a6a5fd7e4024ddd9159004c30d20/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=6d029359e955a6a5fd7e4024ddd9159004c30d20",
            "patch": "@@ -54,18 +54,10 @@ def OutputString(self, attrs=None):\n                 if \"httponly\" in self:\n                     output += \"; httponly\"\n                 return output\n+    else:\n+        Morsel = Cookie.Morsel\n \n     class SimpleCookie(Cookie.SimpleCookie):\n-        if not _morsel_supports_httponly:\n-            def __set(self, key, real_value, coded_value):\n-                M = self.get(key, Morsel())\n-                M.set(key, real_value, coded_value)\n-                dict.__setitem__(self, key, M)\n-\n-            def __setitem__(self, key, value):\n-                rval, cval = self.value_encode(value)\n-                self.__set(key, rval, cval)\n-\n         if not _cookie_encodes_correctly:\n             def value_encode(self, val):\n                 # Some browsers do not support quoted-string from RFC 2109,\n@@ -91,19 +83,20 @@ def value_encode(self, val):\n \n                 return val, encoded\n \n-        if not _cookie_allows_colon_in_names:\n+        if not _cookie_allows_colon_in_names or not _morsel_supports_httponly:\n             def load(self, rawdata):\n                 self.bad_cookies = set()\n                 super(SimpleCookie, self).load(rawdata)\n                 for key in self.bad_cookies:\n                     del self[key]\n \n-            _strict_set = Cookie.BaseCookie._BaseCookie__set\n-\n             # override private __set() method:\n+            # (needed for using our Morsel, and for laxness with CookieError\n             def _BaseCookie__set(self, key, real_value, coded_value):\n                 try:\n-                    self._strict_set(key, real_value, coded_value)\n+                    M = self.get(key, Morsel())\n+                    M.set(key, real_value, coded_value)\n+                    dict.__setitem__(self, key, M)\n                 except Cookie.CookieError:\n                     self.bad_cookies.add(key)\n                     dict.__setitem__(self, key, Cookie.Morsel())"
        },
        {
            "sha": "66bd804259d34d9642e8134274932961948c723b",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/6d029359e955a6a5fd7e4024ddd9159004c30d20/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6d029359e955a6a5fd7e4024ddd9159004c30d20/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=6d029359e955a6a5fd7e4024ddd9159004c30d20",
            "patch": "@@ -291,3 +291,13 @@ def test_repeated_nonstandard_keys(self):\n         Test that a repeated non-standard name doesn't affect all cookies. Ticket #15852\n         \"\"\"\n         self.assertTrue('good_cookie' in parse_cookie('a,=b; a,=c; good_cookie=yes').keys())\n+\n+    def test_httponly_after_load(self):\n+        \"\"\"\n+        Test that we can use httponly attribute on cookies that we load\n+        \"\"\"\n+        c = SimpleCookie()\n+        c.load(\"name=val\")\n+        c['name']['httponly'] = True\n+        self.assertTrue(c['name']['httponly'])\n+"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 17,
        "deletions": 14
    }
}