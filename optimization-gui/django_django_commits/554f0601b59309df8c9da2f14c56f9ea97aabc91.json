{
    "author": "ramiro",
    "message": "Stopped unconditionally reversing admin model add/change URLs.\n\nStarting with [16857] this could cause HTTP 500 errors when\n`ModelAdmin.get_urls()` has been customized to the point it doesn't\nprovide these standard URLs.\n\nFixes #17333. Refs #15294.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17237 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "554f0601b59309df8c9da2f14c56f9ea97aabc91",
    "files": [
        {
            "sha": "83a08699c229767793586d1514a0840ff0d0ff01",
            "filename": "django/contrib/admin/sites.py",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/554f0601b59309df8c9da2f14c56f9ea97aabc91/django%2Fcontrib%2Fadmin%2Fsites.py",
            "raw_url": "https://github.com/django/django/raw/554f0601b59309df8c9da2f14c56f9ea97aabc91/django%2Fcontrib%2Fadmin%2Fsites.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fsites.py?ref=554f0601b59309df8c9da2f14c56f9ea97aabc91",
            "patch": "@@ -7,7 +7,7 @@\n from django.views.decorators.csrf import csrf_protect\n from django.db.models.base import ModelBase\n from django.core.exceptions import ImproperlyConfigured\n-from django.core.urlresolvers import reverse\n+from django.core.urlresolvers import reverse, NoReverseMatch\n from django.template.response import TemplateResponse\n from django.utils.safestring import mark_safe\n from django.utils.text import capfirst\n@@ -342,10 +342,18 @@ def index(self, request, extra_context=None):\n                     info = (app_label, model._meta.module_name)\n                     model_dict = {\n                         'name': capfirst(model._meta.verbose_name_plural),\n-                        'admin_url': reverse('admin:%s_%s_changelist' % info, current_app=self.name),\n-                        'add_url': reverse('admin:%s_%s_add' % info, current_app=self.name),\n                         'perms': perms,\n                     }\n+                    if perms.get('change', False):\n+                        try:\n+                            model_dict['admin_url'] = reverse('admin:%s_%s_changelist' % info, current_app=self.name)\n+                        except NoReverseMatch:\n+                            pass\n+                    if perms.get('add', False):\n+                        try:\n+                            model_dict['add_url'] = reverse('admin:%s_%s_add' % info, current_app=self.name)\n+                        except NoReverseMatch:\n+                            pass\n                     if app_label in app_dict:\n                         app_dict[app_label]['models'].append(model_dict)\n                     else:\n@@ -388,10 +396,18 @@ def app_index(self, request, app_label, extra_context=None):\n                         info = (app_label, model._meta.module_name)\n                         model_dict = {\n                             'name': capfirst(model._meta.verbose_name_plural),\n-                            'admin_url': reverse('admin:%s_%s_changelist' % info, current_app=self.name),\n-                            'add_url': reverse('admin:%s_%s_add' % info, current_app=self.name),\n                             'perms': perms,\n                         }\n+                        if perms.get('change', False):\n+                            try:\n+                                model_dict['admin_url'] = reverse('admin:%s_%s_changelist' % info, current_app=self.name)\n+                            except NoReverseMatch:\n+                                pass\n+                        if perms.get('add', False):\n+                            try:\n+                                model_dict['add_url'] = reverse('admin:%s_%s_add' % info, current_app=self.name)\n+                            except NoReverseMatch:\n+                                pass\n                         if app_dict:\n                             app_dict['models'].append(model_dict),\n                         else:"
        },
        {
            "sha": "a8ced3912198488ed08a43cc9012bca1161aed85",
            "filename": "django/contrib/admin/templates/admin/index.html",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/554f0601b59309df8c9da2f14c56f9ea97aabc91/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Findex.html",
            "raw_url": "https://github.com/django/django/raw/554f0601b59309df8c9da2f14c56f9ea97aabc91/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Findex.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Findex.html?ref=554f0601b59309df8c9da2f14c56f9ea97aabc91",
            "patch": "@@ -19,19 +19,19 @@\n         <caption><a href=\"{{ app.app_url }}\" class=\"section\">{% blocktrans with name=app.name %}{{ name }}{% endblocktrans %}</a></caption>\n         {% for model in app.models %}\n             <tr>\n-            {% if model.perms.change %}\n+            {% if model.admin_url %}\n                 <th scope=\"row\"><a href=\"{{ model.admin_url }}\">{{ model.name }}</a></th>\n             {% else %}\n                 <th scope=\"row\">{{ model.name }}</th>\n             {% endif %}\n \n-            {% if model.perms.add %}\n+            {% if model.add_url %}\n                 <td><a href=\"{{ model.add_url }}\" class=\"addlink\">{% trans 'Add' %}</a></td>\n             {% else %}\n                 <td>&nbsp;</td>\n             {% endif %}\n \n-            {% if model.perms.change %}\n+            {% if model.admin_url %}\n                 <td><a href=\"{{ model.admin_url }}\" class=\"changelink\">{% trans 'Change' %}</a></td>\n             {% else %}\n                 <td>&nbsp;</td>"
        },
        {
            "sha": "8c5b511d1eb828a8dfe6614f459b1823f295c6d2",
            "filename": "tests/regressiontests/admin_views/admin.py",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/554f0601b59309df8c9da2f14c56f9ea97aabc91/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/554f0601b59309df8c9da2f14c56f9ea97aabc91/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py?ref=554f0601b59309df8c9da2f14c56f9ea97aabc91",
            "patch": "@@ -1,7 +1,6 @@\n # -*- coding: utf-8 -*-\n from __future__ import absolute_import\n \n-import datetime\n import tempfile\n import os\n \n@@ -10,8 +9,10 @@\n from django.contrib.admin.views.main import ChangeList\n from django.core.files.storage import FileSystemStorage\n from django.core.mail import EmailMessage\n+from django.conf.urls import patterns, url\n from django.db import models\n from django.forms.models import BaseModelFormSet\n+from django.http import HttpResponse\n \n from .models import (Article, Chapter, Account, Media, Child, Parent, Picture,\n     Widget, DooHickey, Grommet, Whatsit, FancyDoodad, Category, Link,\n@@ -24,7 +25,7 @@\n     CoverLetter, Story, OtherStory, Book, Promo, ChapterXtra1, Pizza, Topping,\n     Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug,\n     AdminOrderedField, AdminOrderedModelMethod, AdminOrderedAdminMethod,\n-    AdminOrderedCallable)\n+    AdminOrderedCallable, Report)\n \n \n def callable_year(dt_value):\n@@ -499,6 +500,17 @@ class AdminOrderedCallableAdmin(admin.ModelAdmin):\n     ordering = ('order',)\n     list_display = ('stuff', admin_ordered_callable)\n \n+class ReportAdmin(admin.ModelAdmin):\n+    def extra(self, request):\n+        return HttpResponse()\n+\n+    def get_urls(self):\n+        # Corner case: Don't call parent implementation\n+        return patterns('',\n+            url(r'^extra/$',\n+                self.extra,\n+                name='cable_extra'),\n+        )\n \n site = admin.AdminSite(name=\"admin\")\n site.register(Article, ArticleAdmin)\n@@ -543,6 +555,7 @@ class AdminOrderedCallableAdmin(admin.ModelAdmin):\n site.register(CoverLetter, CoverLetterAdmin)\n site.register(Story, StoryAdmin)\n site.register(OtherStory, OtherStoryAdmin)\n+site.register(Report, ReportAdmin)\n \n # We intentionally register Promo and ChapterXtra1 but not Chapter nor ChapterXtra2.\n # That way we cover all four cases:"
        },
        {
            "sha": "0029fcc1524bceb1625890341f79c64f4d43d66d",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/554f0601b59309df8c9da2f14c56f9ea97aabc91/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/554f0601b59309df8c9da2f14c56f9ea97aabc91/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=554f0601b59309df8c9da2f14c56f9ea97aabc91",
            "patch": "@@ -566,3 +566,9 @@ class AdminOrderedAdminMethod(models.Model):\n class AdminOrderedCallable(models.Model):\n     order = models.IntegerField()\n     stuff = models.CharField(max_length=200)\n+\n+class Report(models.Model):\n+    title = models.CharField(max_length=100)\n+\n+    def __unicode__(self):\n+        return self.title"
        },
        {
            "sha": "6037c2b187eea4a402e140aa8fabbb490043acbc",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/554f0601b59309df8c9da2f14c56f9ea97aabc91/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/554f0601b59309df8c9da2f14c56f9ea97aabc91/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=554f0601b59309df8c9da2f14c56f9ea97aabc91",
            "patch": "@@ -38,7 +38,8 @@\n     Book, Promo, WorkHour, Employee, Question, Answer, Inquisition, Actor,\n     FoodDelivery, RowLevelChangePermissionModel, Paper, CoverLetter, Story,\n     OtherStory, ComplexSortedPerson, Parent, Child, AdminOrderedField,\n-    AdminOrderedModelMethod, AdminOrderedAdminMethod, AdminOrderedCallable)\n+    AdminOrderedModelMethod, AdminOrderedAdminMethod, AdminOrderedCallable,\n+    Report)\n \n \n ERROR_MESSAGE = \"Please enter the correct username and password \\\n@@ -1090,6 +1091,37 @@ def testDisabledPermissionsWhenLoggedIn(self):\n         self.assertContains(response, 'id=\"login-form\"')\n \n \n+class AdminViewsNoUrlTest(TestCase):\n+    \"\"\"Regression test for #17333\"\"\"\n+\n+    urls = \"regressiontests.admin_views.urls\"\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        opts = Report._meta\n+        # User who can change Reports\n+        change_user = User.objects.get(username='changeuser')\n+        change_user.user_permissions.add(get_perm(Report,\n+            opts.get_change_permission()))\n+\n+        # login POST dict\n+        self.changeuser_login = {\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'changeuser',\n+            'password': 'secret',\n+        }\n+\n+    def test_no_standard_modeladmin_urls(self):\n+        \"\"\"Admin index views don't break when user's ModelAdmin removes standard urls\"\"\"\n+        self.client.get('/test_admin/admin/')\n+        self.client.post('/test_admin/admin/', self.changeuser_login)\n+        r = self.client.get('/test_admin/admin/')\n+        # we shouldn' get an 500 error caused by a NoReverseMatch\n+        self.assertEqual(r.status_code, 200)\n+        self.client.get('/test_admin/admin/logout/')\n+\n+\n class AdminViewDeletedObjectsTest(TestCase):\n     urls = \"regressiontests.admin_views.urls\"\n     fixtures = ['admin-views-users.xml', 'deleted-objects.xml']"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 78,
        "deletions": 11
    }
}