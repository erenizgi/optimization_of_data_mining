{
    "author": "freakboy3742",
    "message": "Fixed #15018 -- Corrected the handling of LimitedStream under one edge case involving size restricted buffers and newlines. Thanks to xjdrew for the report, and aaugustin for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15222 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b4f0921463956215c9852398df2674262ac7548e",
    "files": [
        {
            "sha": "537154c0cbb223ec1ab43e3a2642d16a7b9e6af7",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/b4f0921463956215c9852398df2674262ac7548e/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/b4f0921463956215c9852398df2674262ac7548e/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=b4f0921463956215c9852398df2674262ac7548e",
            "patch": "@@ -96,9 +96,10 @@ def read(self, size=None):\n         return result\n \n     def readline(self, size=None):\n-        while '\\n' not in self.buffer or \\\n-              (size is not None and len(self.buffer) < size):\n+        while '\\n' not in self.buffer and \\\n+              (size is None or len(self.buffer) < size):\n             if size:\n+                # since size is not None here, len(self.buffer) < size\n                 chunk = self._read_limited(size - len(self.buffer))\n             else:\n                 chunk = self._read_limited()"
        },
        {
            "sha": "a80ee9d57133415dcbb81a6393778ea2ac16711f",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/b4f0921463956215c9852398df2674262ac7548e/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b4f0921463956215c9852398df2674262ac7548e/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=b4f0921463956215c9852398df2674262ac7548e",
            "patch": "@@ -102,15 +102,21 @@ def test_limited_stream(self):\n         # Read all of a limited stream\n         stream = LimitedStream(StringIO('test'), 2)\n         self.assertEqual(stream.read(), 'te')\n+        # Reading again returns nothing.\n+        self.assertEqual(stream.read(), '')\n \n         # Read a number of characters greater than the stream has to offer\n         stream = LimitedStream(StringIO('test'), 2)\n         self.assertEqual(stream.read(5), 'te')\n+        # Reading again returns nothing.\n+        self.assertEqual(stream.readline(5), '')\n \n         # Read sequentially from a stream\n         stream = LimitedStream(StringIO('12345678'), 8)\n         self.assertEqual(stream.read(5), '12345')\n         self.assertEqual(stream.read(5), '678')\n+        # Reading again returns nothing.\n+        self.assertEqual(stream.readline(5), '')\n \n         # Read lines from a stream\n         stream = LimitedStream(StringIO('1234\\n5678\\nabcd\\nefgh\\nijkl'), 24)\n@@ -129,6 +135,26 @@ def test_limited_stream(self):\n         # Read everything else.\n         self.assertEqual(stream.readline(), 'ijkl')\n \n+        # Regression for #15018\n+        # If a stream contains a newline, but the provided length\n+        # is less than the number of provided characters, the newline\n+        # doesn't reset the available character count\n+        stream = LimitedStream(StringIO('1234\\nabcdef'), 9)\n+        self.assertEqual(stream.readline(10), '1234\\n')\n+        self.assertEqual(stream.readline(3), 'abc')\n+        # Now expire the available characters\n+        self.assertEqual(stream.readline(3), 'd')\n+        # Reading again returns nothing.\n+        self.assertEqual(stream.readline(2), '')\n+\n+        # Same test, but with read, not readline.\n+        stream = LimitedStream(StringIO('1234\\nabcdef'), 9)\n+        self.assertEqual(stream.read(6), '1234\\na')\n+        self.assertEqual(stream.read(2), 'bc')\n+        self.assertEqual(stream.read(2), 'd')\n+        self.assertEqual(stream.read(2), '')\n+        self.assertEqual(stream.read(), '')\n+\n     def test_stream(self):\n         request = WSGIRequest({'REQUEST_METHOD': 'POST', 'wsgi.input': StringIO('name=value')})\n         self.assertEqual(request.read(), 'name=value')"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 29,
        "deletions": 2
    }
}