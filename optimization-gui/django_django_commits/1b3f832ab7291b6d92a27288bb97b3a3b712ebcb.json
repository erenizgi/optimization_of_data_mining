{
    "author": "claudep",
    "message": "Fixed #19134 -- Allowed closing smtp backend when the server is stopped\n\nThanks Sebastian Noack for the report and the initial patch.",
    "sha": "1b3f832ab7291b6d92a27288bb97b3a3b712ebcb",
    "files": [
        {
            "sha": "baffa8f2dfba1001b2751476bc78f172c9b99176",
            "filename": "django/core/mail/backends/smtp.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/1b3f832ab7291b6d92a27288bb97b3a3b712ebcb/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "raw_url": "https://github.com/django/django/raw/1b3f832ab7291b6d92a27288bb97b3a3b712ebcb/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py?ref=1b3f832ab7291b6d92a27288bb97b3a3b712ebcb",
            "patch": "@@ -63,9 +63,10 @@ def close(self):\n         try:\n             try:\n                 self.connection.quit()\n-            except socket.sslerror:\n+            except (socket.sslerror, smtplib.SMTPServerDisconnected):\n                 # This happens when calling quit() on a TLS connection\n-                # sometimes.\n+                # sometimes, or when the connection was already disconnected\n+                # by the server.\n                 self.connection.close()\n             except:\n                 if self.fail_silently:"
        },
        {
            "sha": "9ab8c2c301fbc50782fd106ee0e8bfd6a5a8b118",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/1b3f832ab7291b6d92a27288bb97b3a3b712ebcb/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1b3f832ab7291b6d92a27288bb97b3a3b712ebcb/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=1b3f832ab7291b6d92a27288bb97b3a3b712ebcb",
            "patch": "@@ -659,9 +659,9 @@ def run(self):\n         asyncore.close_all()\n \n     def stop(self):\n-        assert self.active\n-        self.active = False\n-        self.join()\n+        if self.active:\n+            self.active = False\n+            self.join()\n \n \n class SMTPBackendTests(BaseEmailBackendTests, TestCase):\n@@ -715,3 +715,16 @@ def test_email_disabled_authentication(self):\n         backend = smtp.EmailBackend(username='', password='')\n         self.assertEqual(backend.username, '')\n         self.assertEqual(backend.password, '')\n+\n+    def test_server_stopped(self):\n+        \"\"\"\n+        Test that closing the backend while the SMTP server is stopped doesn't\n+        raise an exception.\n+        \"\"\"\n+        backend = smtp.EmailBackend(username='', password='')\n+        backend.open()\n+        self.server.stop()\n+        try:\n+            backend.close()\n+        except Exception as e:\n+            self.fail(\"close() unexpectedly raised an exception: %s\" % e)"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 19,
        "deletions": 5
    }
}