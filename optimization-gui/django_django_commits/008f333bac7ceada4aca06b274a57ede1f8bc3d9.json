{
    "author": "carljm",
    "message": "Fixed pk uniqueness validation for new objects created outside of a ModelForm. Also removed need for ModelForm to poke at Model._state.adding, keeping it an internal ORM concern.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14613 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "008f333bac7ceada4aca06b274a57ede1f8bc3d9",
    "files": [
        {
            "sha": "18a684d715c4e775739a5a8f314c19f129c30bd7",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/008f333bac7ceada4aca06b274a57ede1f8bc3d9/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/008f333bac7ceada4aca06b274a57ede1f8bc3d9/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=008f333bac7ceada4aca06b274a57ede1f8bc3d9",
            "patch": "@@ -265,7 +265,7 @@ def __init__(self, db=None):\n         # If true, uniqueness validation checks will consider this a new, as-yet-unsaved object.\n         # Necessary for correct validation of new instances of objects with explicit (non-auto) PKs.\n         # This impacts validation only; it has no effect on the actual save.\n-        self.adding = False\n+        self.adding = True\n \n class Model(object):\n     __metaclass__ = ModelBase"
        },
        {
            "sha": "25e37cc70122f0c5bfed6d0179cdfe7147b22191",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/008f333bac7ceada4aca06b274a57ede1f8bc3d9/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/008f333bac7ceada4aca06b274a57ede1f8bc3d9/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=008f333bac7ceada4aca06b274a57ede1f8bc3d9",
            "patch": "@@ -284,6 +284,8 @@ def iterator(self):\n \n                 # Store the source database of the object\n                 obj._state.db = self.db\n+                # This object came from the database; it's not being added.\n+                obj._state.adding = False\n \n             for i, k in enumerate(extra_select):\n                 setattr(obj, k, row[i])\n@@ -1204,6 +1206,7 @@ def get_cached_row(klass, row, index_start, using, max_depth=0, cur_depth=0,\n     # If an object was retrieved, set the database state.\n     if obj:\n         obj._state.db = using\n+        obj._state.adding = False\n \n     index_end = index_start + field_count + offset\n     # Iterate over each related object, populating any\n@@ -1387,6 +1390,7 @@ def transform_results(self, values):\n             setattr(instance, field, value)\n \n         instance._state.db = self.query.using\n+        instance._state.adding = False\n \n         return instance\n "
        },
        {
            "sha": "4ffc3b6fac146afd9d500677989402512663edd5",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/008f333bac7ceada4aca06b274a57ede1f8bc3d9/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/008f333bac7ceada4aca06b274a57ede1f8bc3d9/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=008f333bac7ceada4aca06b274a57ede1f8bc3d9",
            "patch": "@@ -254,10 +254,8 @@ def __init__(self, data=None, files=None, auto_id='id_%s', prefix=None,\n             # if we didn't get an instance, instantiate a new one\n             self.instance = opts.model()\n             object_data = {}\n-            self.instance._state.adding = True\n         else:\n             self.instance = instance\n-            self.instance._state.adding = False\n             object_data = model_to_dict(instance, opts.fields, opts.exclude)\n         # if initial was provided, it should override the values from instance\n         if initial is not None:"
        },
        {
            "sha": "e4c7c3bf36b6fd41ad475725be6455ac6e385f5d",
            "filename": "tests/regressiontests/model_regress/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/008f333bac7ceada4aca06b274a57ede1f8bc3d9/tests%2Fregressiontests%2Fmodel_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/008f333bac7ceada4aca06b274a57ede1f8bc3d9/tests%2Fregressiontests%2Fmodel_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_regress%2Fmodels.py?ref=008f333bac7ceada4aca06b274a57ede1f8bc3d9",
            "patch": "@@ -58,6 +58,8 @@ def __unicode__(self):\n         # object).\n         return 'NÃ¡zov: %s' % self.name\n \n+class NonAutoPK(models.Model):\n+    name = models.CharField(max_length=10, primary_key=True)\n \n __test__ = {'API_TESTS': \"\"\"\n (NOTE: Part of the regression test here is merely parsing the model"
        },
        {
            "sha": "6397b90a66fcdf5998cd237135d9b6abda032e4b",
            "filename": "tests/regressiontests/model_regress/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/008f333bac7ceada4aca06b274a57ede1f8bc3d9/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/008f333bac7ceada4aca06b274a57ede1f8bc3d9/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py?ref=008f333bac7ceada4aca06b274a57ede1f8bc3d9",
            "patch": "@@ -1,16 +1,26 @@\n-from models import Worker\n+from django.core.exceptions import ValidationError\n from django.test import TestCase\n \n+from models import Worker, NonAutoPK\n+\n+\n class RelatedModelOrderedLookupTest(TestCase):\n     \"\"\"\n     Regression test for #10153: foreign key __gte and __lte lookups.\n     \"\"\"\n-    \n+\n     # The bug is that the following queries would raise:\n     # \"TypeError: Related Field has invalid lookup: gte\"\n-    \n+\n     def test_related_gte_lookup(self):\n         Worker.objects.filter(department__gte=0)\n \n     def test_related_lte_lookup(self):\n         Worker.objects.filter(department__lte=0)\n+\n+\n+class ModelValidationTest(TestCase):\n+    def test_pk_validation(self):\n+        one = NonAutoPK.objects.create(name=\"one\")\n+        again = NonAutoPK(name=\"one\")\n+        self.assertRaises(ValidationError, again.validate_unique)"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 20,
        "deletions": 6
    }
}