{
    "author": "jezdez",
    "message": "Fixed #16003 -- Restored compatibility of the admin when using USE_ETAGS. Thanks for the initial patch, pterk.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16729 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7cb140e6d86e9c592983ddb50bfd82480ecec7eb",
    "files": [
        {
            "sha": "10d0a23ff86d8dd8236e7caddd7e20047bd46812",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/7cb140e6d86e9c592983ddb50bfd82480ecec7eb/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/7cb140e6d86e9c592983ddb50bfd82480ecec7eb/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=7cb140e6d86e9c592983ddb50bfd82480ecec7eb",
            "patch": "@@ -92,6 +92,10 @@ def get_max_age(response):\n         except (ValueError, TypeError):\n             pass\n \n+def _set_response_etag(response):\n+    response['ETag'] = '\"%s\"' % hashlib.md5(response.content).hexdigest()\n+    return response\n+\n def patch_response_headers(response, cache_timeout=None):\n     \"\"\"\n     Adds some useful headers to the given HttpResponse object:\n@@ -107,7 +111,10 @@ def patch_response_headers(response, cache_timeout=None):\n     if cache_timeout < 0:\n         cache_timeout = 0 # Can't have max-age negative\n     if settings.USE_ETAGS and not response.has_header('ETag'):\n-        response['ETag'] = '\"%s\"' % hashlib.md5(response.content).hexdigest()\n+        if hasattr(response, 'render') and callable(response.render):\n+            response.add_post_render_callback(_set_response_etag)\n+        else:\n+            response = _set_response_etag(response)\n     if not response.has_header('Last-Modified'):\n         response['Last-Modified'] = http_date()\n     if not response.has_header('Expires'):"
        },
        {
            "sha": "2a326ade5d196f7806ae78a592ace8c4005e9db0",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 118,
            "deletions": 7,
            "changes": 125,
            "blob_url": "https://github.com/django/django/blob/7cb140e6d86e9c592983ddb50bfd82480ecec7eb/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7cb140e6d86e9c592983ddb50bfd82480ecec7eb/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=7cb140e6d86e9c592983ddb50bfd82480ecec7eb",
            "patch": "@@ -2,6 +2,7 @@\n \n # Unit tests for cache framework\n # Uses whatever cache backend is set in the test settings file.\n+from __future__ import with_statement\n \n import hashlib\n import os\n@@ -13,14 +14,19 @@\n from django.conf import settings\n from django.core import management\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n-from django.core.cache.backends.base import CacheKeyWarning, InvalidCacheBackendError\n+from django.core.cache.backends.base import (CacheKeyWarning,\n+    InvalidCacheBackendError)\n from django.http import HttpResponse, HttpRequest, QueryDict\n-from django.middleware.cache import FetchFromCacheMiddleware, UpdateCacheMiddleware, CacheMiddleware\n-from django.test import RequestFactory\n-from django.test.utils import get_warnings_state, restore_warnings_state\n-from django.utils import translation\n-from django.utils import unittest\n-from django.utils.cache import patch_vary_headers, get_cache_key, learn_cache_key, patch_cache_control\n+from django.middleware.cache import (FetchFromCacheMiddleware,\n+    UpdateCacheMiddleware, CacheMiddleware)\n+from django.template import Template\n+from django.template.response import TemplateResponse\n+from django.test import TestCase, RequestFactory\n+from django.test.utils import (get_warnings_state, restore_warnings_state,\n+    override_settings)\n+from django.utils import translation, unittest\n+from django.utils.cache import (patch_vary_headers, get_cache_key,\n+    learn_cache_key, patch_cache_control, patch_response_headers)\n from django.views.decorators.cache import cache_page\n \n from regressiontests.cache.models import Poll, expensive_calculation\n@@ -1491,5 +1497,110 @@ def test_view_decorator(self):\n         response = other_with_timeout_view(request, '18')\n         self.assertEqual(response.content, 'Hello World 18')\n \n+\n+class TestWithTemplateResponse(TestCase):\n+    \"\"\"\n+    Tests various headers w/ TemplateResponse.\n+\n+    Most are probably redundant since they manipulate the same object\n+    anyway but the Etag header is 'special' because it relies on the\n+    content being complete (which is not necessarily always the case\n+    with a TemplateResponse)\n+    \"\"\"\n+    def setUp(self):\n+        self.path = '/cache/test/'\n+\n+    def _get_request(self, path, method='GET'):\n+        request = HttpRequest()\n+        request.META = {\n+            'SERVER_NAME': 'testserver',\n+            'SERVER_PORT': 80,\n+        }\n+        request.method = method\n+        request.path = request.path_info = \"/cache/%s\" % path\n+        return request\n+\n+    def test_patch_vary_headers(self):\n+        headers = (\n+            # Initial vary, new headers, resulting vary.\n+            (None, ('Accept-Encoding',), 'Accept-Encoding'),\n+            ('Accept-Encoding', ('accept-encoding',), 'Accept-Encoding'),\n+            ('Accept-Encoding', ('ACCEPT-ENCODING',), 'Accept-Encoding'),\n+            ('Cookie', ('Accept-Encoding',), 'Cookie, Accept-Encoding'),\n+            ('Cookie, Accept-Encoding', ('Accept-Encoding',), 'Cookie, Accept-Encoding'),\n+            ('Cookie, Accept-Encoding', ('Accept-Encoding', 'cookie'), 'Cookie, Accept-Encoding'),\n+            (None, ('Accept-Encoding', 'COOKIE'), 'Accept-Encoding, COOKIE'),\n+            ('Cookie,     Accept-Encoding', ('Accept-Encoding', 'cookie'), 'Cookie, Accept-Encoding'),\n+            ('Cookie    ,     Accept-Encoding', ('Accept-Encoding', 'cookie'), 'Cookie, Accept-Encoding'),\n+        )\n+        for initial_vary, newheaders, resulting_vary in headers:\n+            response = TemplateResponse(HttpResponse(), Template(\"This is a test\"))\n+            if initial_vary is not None:\n+                response['Vary'] = initial_vary\n+            patch_vary_headers(response, newheaders)\n+            self.assertEqual(response['Vary'], resulting_vary)\n+\n+    def test_get_cache_key(self):\n+        request = self._get_request(self.path)\n+        response = TemplateResponse(HttpResponse(), Template(\"This is a test\"))\n+        key_prefix = 'localprefix'\n+        # Expect None if no headers have been set yet.\n+        self.assertEqual(get_cache_key(request), None)\n+        # Set headers to an empty list.\n+        learn_cache_key(request, response)\n+        self.assertEqual(get_cache_key(request), 'views.decorators.cache.cache_page.settingsprefix.GET.a8c87a3d8c44853d7f79474f7ffe4ad5.d41d8cd98f00b204e9800998ecf8427e')\n+        # Verify that a specified key_prefix is taken into account.\n+        learn_cache_key(request, response, key_prefix=key_prefix)\n+        self.assertEqual(get_cache_key(request, key_prefix=key_prefix), 'views.decorators.cache.cache_page.localprefix.GET.a8c87a3d8c44853d7f79474f7ffe4ad5.d41d8cd98f00b204e9800998ecf8427e')\n+\n+    def test_get_cache_key_with_query(self):\n+        request = self._get_request(self.path + '?test=1')\n+        response = TemplateResponse(HttpResponse(), Template(\"This is a test\"))\n+        # Expect None if no headers have been set yet.\n+        self.assertEqual(get_cache_key(request), None)\n+        # Set headers to an empty list.\n+        learn_cache_key(request, response)\n+        # Verify that the querystring is taken into account.\n+        self.assertEqual(get_cache_key(request), 'views.decorators.cache.cache_page.settingsprefix.GET.bd889c5a59603af44333ed21504db3cd.d41d8cd98f00b204e9800998ecf8427e')\n+\n+    @override_settings(USE_ETAGS=False)\n+    def test_without_etag(self):\n+        response = TemplateResponse(HttpResponse(), Template(\"This is a test\"))\n+        self.assertFalse(response.has_header('ETag'))\n+        patch_response_headers(response)\n+        self.assertFalse(response.has_header('ETag'))\n+        response = response.render()\n+        self.assertFalse(response.has_header('ETag'))\n+\n+    @override_settings(USE_ETAGS=True)\n+    def test_with_etag(self):\n+        response = TemplateResponse(HttpResponse(), Template(\"This is a test\"))\n+        self.assertFalse(response.has_header('ETag'))\n+        patch_response_headers(response)\n+        self.assertFalse(response.has_header('ETag'))\n+        response = response.render()\n+        self.assertTrue(response.has_header('ETag'))\n+\n+TestWithTemplateResponse = override_settings(\n+    CACHE_MIDDLEWARE_KEY_PREFIX='settingsprefix',\n+    CACHE_MIDDLEWARE_SECONDS=1,\n+    USE_I18N=False,\n+)(TestWithTemplateResponse)\n+\n+\n+class TestEtagWithAdmin(TestCase):\n+    # See https://code.djangoproject.com/ticket/16003\n+    def test_admin(self):\n+        with self.settings(USE_ETAGS=False):\n+            response = self.client.get('/test_admin/admin/')\n+            self.assertEqual(response.status_code, 200)\n+            self.assertFalse(response.has_header('ETag'))\n+\n+        with self.settings(USE_ETAGS=True):\n+            response = self.client.get('/test_admin/admin/')\n+            self.assertEqual(response.status_code, 200)\n+            self.assertTrue(response.has_header('ETag'))\n+\n if __name__ == '__main__':\n     unittest.main()\n+"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 126,
        "deletions": 8
    }
}