{
    "author": "jezdez",
    "message": "Fixed #11559 -- Fixed the URL resolver to be able to handle captured parameters in parent URLconfs when also using namespaces. Thanks, cwb, ungenio and hvdklauw.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16608 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "02dcbe33171851bb8b658965a96460a458bc09a8",
    "files": [
        {
            "sha": "709a1fea11ed925746e08bb29773094bfe853c14",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 34,
            "deletions": 14,
            "changes": 48,
            "blob_url": "https://github.com/django/django/blob/02dcbe33171851bb8b658965a96460a458bc09a8/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/02dcbe33171851bb8b658965a96460a458bc09a8/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=02dcbe33171851bb8b658965a96460a458bc09a8",
            "patch": "@@ -22,6 +22,7 @@\n \n \n _resolver_cache = {} # Maps URLconf modules to RegexURLResolver instances.\n+_ns_resolver_cache = {} # Maps namespaces to RegexURLResolver instances.\n _callable_cache = {} # Maps view and url pattern names to their view functions.\n \n # SCRIPT_NAME prefixes for each thread are stored here. If there's no entry for\n@@ -91,20 +92,20 @@ def get_callable(lookup_view, can_fail=False):\n                 lookup_view = getattr(import_module(mod_name), func_name)\n                 if not callable(lookup_view):\n                     raise ViewDoesNotExist(\n-                        \"Could not import %s.%s. View is not callable.\"\n-                    % (mod_name, func_name))\n+                        \"Could not import %s.%s. View is not callable.\" %\n+                        (mod_name, func_name))\n         except AttributeError:\n             if not can_fail:\n                 raise ViewDoesNotExist(\n-                    \"Could not import %s. View does not exist in module %s.\"\n-                    % (lookup_view, mod_name))\n+                    \"Could not import %s. View does not exist in module %s.\" %\n+                    (lookup_view, mod_name))\n         except ImportError:\n             parentmod, submod = get_mod_func(mod_name)\n             if (not can_fail and submod != '' and\n                     not module_has_submodule(import_module(parentmod), submod)):\n                 raise ViewDoesNotExist(\n-                    \"Could not import %s. Parent module %s does not exist.\"\n-                    % (lookup_view, mod_name))\n+                    \"Could not import %s. Parent module %s does not exist.\" %\n+                    (lookup_view, mod_name))\n             if not can_fail:\n                 raise\n     return lookup_view\n@@ -117,6 +118,15 @@ def get_resolver(urlconf):\n     return RegexURLResolver(r'^/', urlconf)\n get_resolver = memoize(get_resolver, _resolver_cache, 1)\n \n+def get_ns_resolver(ns_pattern, resolver):\n+    # Build a namespaced resolver for the given parent urlconf pattern.\n+    # This makes it possible to have captured parameters in the parent\n+    # urlconf pattern.\n+    ns_resolver = RegexURLResolver(ns_pattern,\n+                                          resolver.url_patterns)\n+    return RegexURLResolver(r'^/', [ns_resolver])\n+get_ns_resolver = memoize(get_ns_resolver, _ns_resolver_cache, 2)\n+\n def get_mod_func(callback):\n     # Converts 'django.views.news.stories.story_detail' to\n     # ['django.views.news.stories', 'story_detail']\n@@ -424,6 +434,7 @@ def reverse(viewname, urlconf=None, args=None, kwargs=None, prefix=None, current\n         path = parts[1:]\n \n         resolved_path = []\n+        ns_pattern = ''\n         while path:\n             ns = path.pop()\n \n@@ -432,34 +443,43 @@ def reverse(viewname, urlconf=None, args=None, kwargs=None, prefix=None, current\n                 app_list = resolver.app_dict[ns]\n                 # Yes! Path part matches an app in the current Resolver\n                 if current_app and current_app in app_list:\n-                    # If we are reversing for a particular app, use that namespace\n+                    # If we are reversing for a particular app,\n+                    # use that namespace\n                     ns = current_app\n                 elif ns not in app_list:\n-                    # The name isn't shared by one of the instances (i.e., the default)\n-                    # so just pick the first instance as the default.\n+                    # The name isn't shared by one of the instances\n+                    # (i.e., the default) so just pick the first instance\n+                    # as the default.\n                     ns = app_list[0]\n             except KeyError:\n                 pass\n \n             try:\n                 extra, resolver = resolver.namespace_dict[ns]\n                 resolved_path.append(ns)\n-                prefix = prefix + extra\n+                ns_pattern = ns_pattern + extra\n             except KeyError, key:\n                 if resolved_path:\n-                    raise NoReverseMatch(\"%s is not a registered namespace inside '%s'\" % (key, ':'.join(resolved_path)))\n+                    raise NoReverseMatch(\n+                        \"%s is not a registered namespace inside '%s'\" %\n+                        (key, ':'.join(resolved_path)))\n                 else:\n-                    raise NoReverseMatch(\"%s is not a registered namespace\" % key)\n+                    raise NoReverseMatch(\"%s is not a registered namespace\" %\n+                                         key)\n+        if ns_pattern:\n+            resolver = get_ns_resolver(ns_pattern, resolver)\n \n-    return iri_to_uri(u'%s%s' % (prefix, resolver.reverse(view,\n-            *args, **kwargs)))\n+    return iri_to_uri(u'%s%s' %\n+                      (prefix, resolver.reverse(view, *args, **kwargs)))\n \n reverse_lazy = lazy(reverse, str)\n \n def clear_url_caches():\n     global _resolver_cache\n+    global _ns_resolver_cache\n     global _callable_cache\n     _resolver_cache.clear()\n+    _ns_resolver_cache.clear()\n     _callable_cache.clear()\n \n def set_script_prefix(prefix):"
        },
        {
            "sha": "4e411eed9c838f7b418f00a2bd5aa7a0928de881",
            "filename": "tests/regressiontests/urlpatterns_reverse/namespace_urls.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/02dcbe33171851bb8b658965a96460a458bc09a8/tests%2Fregressiontests%2Furlpatterns_reverse%2Fnamespace_urls.py",
            "raw_url": "https://github.com/django/django/raw/02dcbe33171851bb8b658965a96460a458bc09a8/tests%2Fregressiontests%2Furlpatterns_reverse%2Fnamespace_urls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Fnamespace_urls.py?ref=02dcbe33171851bb8b658965a96460a458bc09a8",
            "patch": "@@ -44,4 +44,6 @@ def urls(self):\n \n     (r'^included/', include('regressiontests.urlpatterns_reverse.included_namespace_urls')),\n \n+    (r'^ns-outer/(?P<outer>\\d+)/', include('regressiontests.urlpatterns_reverse.included_namespace_urls', namespace='inc-outer')),\n+\n )"
        },
        {
            "sha": "57e6ae7888ddd3a7e5ce3b6af47be6b5255c9415",
            "filename": "tests/regressiontests/urlpatterns_reverse/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/02dcbe33171851bb8b658965a96460a458bc09a8/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/02dcbe33171851bb8b658965a96460a458bc09a8/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py?ref=02dcbe33171851bb8b658965a96460a458bc09a8",
            "patch": "@@ -327,6 +327,13 @@ def test_namespace_pattern(self):\n         self.assertEqual('/ns-included1/normal/37/42/', reverse('inc-ns1:inc-normal-view', args=[37,42]))\n         self.assertEqual('/ns-included1/normal/42/37/', reverse('inc-ns1:inc-normal-view', kwargs={'arg1':42, 'arg2':37}))\n \n+    def test_namespace_pattern_with_variable_prefix(self):\n+        \"When using a include with namespaces when there is a regex variable in front of it\"\n+        self.assertEqual('/ns-outer/42/normal/', reverse('inc-outer:inc-normal-view', kwargs={'outer':42}))\n+        self.assertEqual('/ns-outer/42/normal/', reverse('inc-outer:inc-normal-view', args=[42]))\n+        self.assertEqual('/ns-outer/42/normal/37/4/', reverse('inc-outer:inc-normal-view', kwargs={'outer':42, 'arg1': 37, 'arg2': 4}))\n+        self.assertEqual('/ns-outer/42/normal/37/4/', reverse('inc-outer:inc-normal-view', args=[42, 37, 4]))\n+\n     def test_multiple_namespace_pattern(self):\n         \"Namespaces can be embedded\"\n         self.assertEqual('/ns-included1/test3/inner/', reverse('inc-ns1:test-ns3:urlobject-view'))"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 43,
        "deletions": 14
    }
}