{
    "author": "spookylukey",
    "message": "Updated FormPreview to use form_hmac rather than the old security_hash function\n\nThis ought to have been done in [14218], but although the FormPreview class\nwas modified, and some tests were added, the crucial lines of code were not\nchanged (the 'FormPreview.security_hash' method), and tests for the new\nbehaviour were not added.  So it is being changed now.  Unlike some of the\nother code in that changeset, this does not need to have a compatibility\nfallback to cope with existing hashes, because the consequence of a failed\nhash is minimal - the user is re-presented with the preview stage of the\nform, which will then have a correct hash.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15952 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c922a046755db20d08c714b469503d3dcb5e0dfc",
    "files": [
        {
            "sha": "b4cdeba4de6d3705ecc192de8960090875610c30",
            "filename": "django/contrib/formtools/preview.py",
            "status": "modified",
            "additions": 3,
            "deletions": 20,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/c922a046755db20d08c714b469503d3dcb5e0dfc/django%2Fcontrib%2Fformtools%2Fpreview.py",
            "raw_url": "https://github.com/django/django/raw/c922a046755db20d08c714b469503d3dcb5e0dfc/django%2Fcontrib%2Fformtools%2Fpreview.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Fpreview.py?ref=c922a046755db20d08c714b469503d3dcb5e0dfc",
            "patch": "@@ -12,7 +12,7 @@\n from django.shortcuts import render_to_response\n from django.template.context import RequestContext\n from django.utils.crypto import constant_time_compare\n-from django.contrib.formtools.utils import security_hash\n+from django.contrib.formtools.utils import form_hmac\n \n AUTO_ID = 'formtools_%s' # Each form here uses this as its auto_id parameter.\n \n@@ -72,24 +72,7 @@ def preview_post(self, request):\n \n     def _check_security_hash(self, token, request, form):\n         expected = self.security_hash(request, form)\n-        if constant_time_compare(token, expected):\n-            return True\n-        else:\n-            # Fall back to Django 1.2 method, for compatibility with forms that\n-            # are in the middle of being used when the upgrade occurs. However,\n-            # we don't want to do this fallback if a subclass has provided their\n-            # own security_hash method - because they might have implemented a\n-            # more secure method, and this would punch a hole in that.\n-\n-            # PendingDeprecationWarning <- left here to remind us that this\n-            # compatibility fallback should be removed in Django 1.5\n-            FormPreview_expected = FormPreview.security_hash(self, request, form)\n-            if expected == FormPreview_expected:\n-                # They didn't override security_hash, do the fallback:\n-                old_expected = security_hash(request, form)\n-                return constant_time_compare(token, old_expected)\n-            else:\n-                return False\n+        return constant_time_compare(token, expected)\n \n     def post_post(self, request):\n         \"Validates the POST data. If valid, calls done(). Else, redisplays form.\"\n@@ -155,7 +138,7 @@ def security_hash(self, request, form):\n         Subclasses may want to take into account request-specific information,\n         such as the IP address.\n         \"\"\"\n-        return security_hash(request, form)\n+        return form_hmac(form)\n \n     def failed_hash(self, request):\n         \"Returns an HttpResponse in the case of an invalid security hash.\""
        },
        {
            "sha": "f093ba79f9faa84f794b6bba4cbef721032809c4",
            "filename": "django/contrib/formtools/tests/__init__.py",
            "status": "modified",
            "additions": 10,
            "deletions": 18,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/c922a046755db20d08c714b469503d3dcb5e0dfc/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/c922a046755db20d08c714b469503d3dcb5e0dfc/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py?ref=c922a046755db20d08c714b469503d3dcb5e0dfc",
            "patch": "@@ -28,14 +28,6 @@ class TestForm(forms.Form):\n     bool1 = forms.BooleanField(required=False)\n \n \n-class UserSecuredFormPreview(TestFormPreview):\n-    \"\"\"\n-    FormPreview with a custum security_hash method\n-    \"\"\"\n-    def security_hash(self, request, form):\n-        return \"123\"\n-\n-\n class PreviewTests(TestCase):\n     urls = 'django.contrib.formtools.tests.urls'\n \n@@ -124,36 +116,36 @@ def test_bool_submit(self):\n         response = self.client.post('/test1/', self.test_data)\n         self.assertEqual(response.content, success_string)\n \n-    def test_form_submit_django12_hash(self):\n+    def test_form_submit_good_hash(self):\n         \"\"\"\n-        Test contrib.formtools.preview form submittal, using the hash function\n-        used in Django 1.2\n+        Test contrib.formtools.preview form submittal, using a correct\n+        hash\n         \"\"\"\n         # Pass strings for form submittal and add stage variable to\n         # show we previously saw first stage of the form.\n         self.test_data.update({'stage':2})\n         response = self.client.post('/test1/', self.test_data)\n         self.assertNotEqual(response.content, success_string)\n-        hash = utils.security_hash(None, TestForm(self.test_data))\n+        hash = utils.form_hmac(TestForm(self.test_data))\n         self.test_data.update({'hash': hash})\n         response = self.client.post('/test1/', self.test_data)\n         self.assertEqual(response.content, success_string)\n \n \n-    def test_form_submit_django12_hash_custom_hash(self):\n+    def test_form_submit_bad_hash(self):\n         \"\"\"\n-        Test contrib.formtools.preview form submittal, using the hash function\n-        used in Django 1.2 and a custom security_hash method.\n+        Test contrib.formtools.preview form submittal does not proceed\n+        if the hash is incorrect.\n         \"\"\"\n         # Pass strings for form submittal and add stage variable to\n         # show we previously saw first stage of the form.\n         self.test_data.update({'stage':2})\n-        response = self.client.post('/test2/', self.test_data)\n+        response = self.client.post('/test1/', self.test_data)\n         self.assertEqual(response.status_code, 200)\n         self.assertNotEqual(response.content, success_string)\n-        hash = utils.security_hash(None, TestForm(self.test_data))\n+        hash = utils.form_hmac(TestForm(self.test_data)) + \"bad\"\n         self.test_data.update({'hash': hash})\n-        response = self.client.post('/test2/', self.test_data)\n+        response = self.client.post('/test1/', self.test_data)\n         self.assertNotEqual(response.content, success_string)\n \n "
        },
        {
            "sha": "6fc1e4ee22a068187d4a71484005ef2d365cf82e",
            "filename": "django/contrib/formtools/tests/urls.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/c922a046755db20d08c714b469503d3dcb5e0dfc/django%2Fcontrib%2Fformtools%2Ftests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/c922a046755db20d08c714b469503d3dcb5e0dfc/django%2Fcontrib%2Fformtools%2Ftests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Furls.py?ref=c922a046755db20d08c714b469503d3dcb5e0dfc",
            "patch": "@@ -7,7 +7,6 @@\n \n urlpatterns = patterns('',\n                        (r'^test1/', TestFormPreview(TestForm)),\n-                       (r'^test2/', UserSecuredFormPreview(TestForm)),\n                        (r'^wizard/$', WizardClass([WizardPageOneForm,\n                                                    WizardPageTwoForm,\n                                                    WizardPageThreeForm])),"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 13,
        "deletions": 39
    }
}