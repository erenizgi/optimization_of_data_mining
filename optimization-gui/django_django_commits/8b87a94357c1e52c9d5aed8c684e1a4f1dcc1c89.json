{
    "author": "freakboy3742",
    "message": "Corrected the setup and teardown of the refactored invalid_models test so that it guarantees that stdout is restored, and purges all the temporary models from the app cache after running the test.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16670 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8b87a94357c1e52c9d5aed8c684e1a4f1dcc1c89",
    "files": [
        {
            "sha": "d6a1a25f186147578261cd4b12e6865dc08fc5d5",
            "filename": "tests/modeltests/invalid_models/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 15,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/8b87a94357c1e52c9d5aed8c684e1a4f1dcc1c89/tests%2Fmodeltests%2Finvalid_models%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/8b87a94357c1e52c9d5aed8c684e1a4f1dcc1c89/tests%2Fmodeltests%2Finvalid_models%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Finvalid_models%2Ftests.py?ref=8b87a94357c1e52c9d5aed8c684e1a4f1dcc1c89",
            "patch": "@@ -1,3 +1,8 @@\n+import copy\n+\n+from django.core.management.validation import get_validation_errors\n+from django.db.models.loading import cache, load_app\n+from cStringIO import StringIO\n import sys\n \n from django.utils import unittest\n@@ -6,32 +11,40 @@\n class InvalidModelTestCase(unittest.TestCase):\n     \"\"\"Import an appliation with invalid models and test the exceptions.\"\"\"\n \n+    def setUp(self):\n+        # Make sure sys.stdout is not a tty so that we get errors without\n+        # coloring attached (makes matching the results easier). We restore\n+        # sys.stderr afterwards.\n+        self.old_stdout = sys.stdout\n+        self.stdout = StringIO()\n+        sys.stdout = self.stdout\n+\n+        # This test adds dummy applications to the app cache. These\n+        # need to be removed in order to prevent bad interactions\n+        # with the flush operation in other tests.\n+        self.old_app_models = copy.deepcopy(cache.app_models)\n+        self.old_app_store = copy.deepcopy(cache.app_store)\n+\n+    def tearDown(self):\n+        cache.app_models = self.old_app_models\n+        cache.app_store = self.old_app_store\n+        cache._get_models_cache = {}\n+        sys.stdout = self.old_stdout\n+\n     def test_invalid_models(self):\n-        from django.core.management.validation import get_validation_errors\n-        from django.db.models.loading import load_app\n-        from cStringIO import StringIO\n \n         try:\n             module = load_app(\"modeltests.invalid_models.invalid_models\")\n         except Exception, e:\n             self.fail('Unable to load invalid model module')\n \n-        # Make sure sys.stdout is not a tty so that we get errors without\n-        # coloring attached (makes matching the results easier). We restore\n-        # sys.stderr afterwards.\n-        orig_stdout = sys.stdout\n-        s = StringIO()\n-        sys.stdout = s\n-        count = get_validation_errors(s, module)\n-        sys.stdout = orig_stdout\n-        s.seek(0)\n-        error_log = s.read()\n+        count = get_validation_errors(self.stdout, module)\n+        self.stdout.seek(0)\n+        error_log = self.stdout.read()\n         actual = error_log.split('\\n')\n         expected = module.model_errors.split('\\n')\n \n         unexpected = [err for err in actual if err not in expected]\n         missing = [err for err in expected if err not in actual]\n         self.assertFalse(unexpected, \"Unexpected Errors: \" + '\\n'.join(unexpected))\n         self.assertFalse(missing, \"Missing Errors: \" + '\\n'.join(missing))\n-\n-"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 28,
        "deletions": 15
    }
}