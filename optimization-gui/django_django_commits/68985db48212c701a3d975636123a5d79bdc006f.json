{
    "author": "akaariai",
    "message": "Added Query.join_parent_model()\n\nThis simplifies especially compiler.py a lot, where almost the same\ncode was repeated multiple times.\n\nRefs #19385",
    "sha": "68985db48212c701a3d975636123a5d79bdc006f",
    "files": [
        {
            "sha": "16aa031e5947e829fcd5072d1909c7f432c639b2",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 5,
            "deletions": 57,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/68985db48212c701a3d975636123a5d79bdc006f/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/68985db48212c701a3d975636123a5d79bdc006f/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=68985db48212c701a3d975636123a5d79bdc006f",
            "patch": "@@ -261,27 +261,14 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n         qn2 = self.connection.ops.quote_name\n         aliases = set()\n         only_load = self.deferred_to_columns()\n-\n+        seen = self.query.included_inherited_models.copy()\n         if start_alias:\n-            seen = {None: start_alias}\n+            seen[None] = start_alias\n         for field, model in opts.get_fields_with_model():\n             if from_parent and model is not None and issubclass(from_parent, model):\n                 # Avoid loading data for already loaded parents.\n                 continue\n-            if start_alias:\n-                try:\n-                    alias = seen[model]\n-                except KeyError:\n-                    link_field = opts.get_ancestor_link(model)\n-                    alias = self.query.join((start_alias, model._meta.db_table,\n-                            link_field.column, model._meta.pk.column),\n-                            join_field=link_field)\n-                    seen[model] = alias\n-            else:\n-                # If we're starting from the base model of the queryset, the\n-                # aliases will have already been set up in pre_sql_setup(), so\n-                # we can save time here.\n-                alias = self.query.included_inherited_models[model]\n+            alias = self.query.join_parent_model(opts, model, start_alias, seen)\n             table = self.query.alias_map[alias].table_name\n             if table in only_load and field.column not in only_load[table]:\n                 continue\n@@ -623,26 +610,7 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                 continue\n             table = f.rel.to._meta.db_table\n             promote = nullable or f.null\n-            if model:\n-                int_opts = opts\n-                alias = root_alias\n-                alias_chain = []\n-                for int_model in opts.get_base_chain(model):\n-                    # Proxy model have elements in base chain\n-                    # with no parents, assign the new options\n-                    # object and skip to the next base in that\n-                    # case\n-                    if not int_opts.parents[int_model]:\n-                        int_opts = int_model._meta\n-                        continue\n-                    lhs_col = int_opts.parents[int_model].column\n-                    link_field = int_opts.get_ancestor_link(int_model)\n-                    int_opts = int_model._meta\n-                    alias = self.query.join((alias, int_opts.db_table, lhs_col,\n-                            int_opts.pk.column), promote=promote, join_field=link_field)\n-                    alias_chain.append(alias)\n-            else:\n-                alias = root_alias\n+            alias = self.query.join_parent_model(opts, model, root_alias, {})\n \n             alias = self.query.join((alias, table, f.column,\n                     f.rel.get_related_field().column),\n@@ -670,28 +638,8 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                                               only_load.get(model), reverse=True):\n                     continue\n \n+                alias = self.query.join_parent_model(opts, f.rel.to, root_alias, {})\n                 table = model._meta.db_table\n-                int_opts = opts\n-                alias = root_alias\n-                alias_chain = []\n-                chain = opts.get_base_chain(f.rel.to)\n-                if chain is not None:\n-                    for int_model in chain:\n-                        # Proxy model have elements in base chain\n-                        # with no parents, assign the new options\n-                        # object and skip to the next base in that\n-                        # case\n-                        if not int_opts.parents[int_model]:\n-                            int_opts = int_model._meta\n-                            continue\n-                        lhs_col = int_opts.parents[int_model].column\n-                        link_field = int_opts.get_ancestor_link(int_model)\n-                        int_opts = int_model._meta\n-                        alias = self.query.join(\n-                            (alias, int_opts.db_table, lhs_col, int_opts.pk.column),\n-                            promote=True, join_field=link_field\n-                        )\n-                        alias_chain.append(alias)\n                 alias = self.query.join(\n                     (alias, table, f.rel.get_related_field().column, f.column),\n                     promote=True, join_field=f"
        },
        {
            "sha": "2546d6c889d960b275c1373ae85ded921db16e63",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 32,
            "deletions": 4,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/68985db48212c701a3d975636123a5d79bdc006f/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/68985db48212c701a3d975636123a5d79bdc006f/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=68985db48212c701a3d975636123a5d79bdc006f",
            "patch": "@@ -1004,12 +1004,40 @@ def setup_inherited_models(self):\n \n         for field, model in opts.get_fields_with_model():\n             if model not in seen:\n-                link_field = opts.get_ancestor_link(model)\n-                seen[model] = self.join(\n-                    (root_alias, model._meta.db_table, link_field.column,\n-                     model._meta.pk.column), join_field=link_field)\n+                self.join_parent_model(opts, model, root_alias, seen)\n         self.included_inherited_models = seen\n \n+    def join_parent_model(self, opts, model, alias, seen):\n+        \"\"\"\n+        Makes sure the given 'model' is joined in the query. If 'model' isn't\n+        a parent of 'opts' or if it is None this method is a no-op.\n+\n+        The 'alias' is the root alias for starting the join, 'seen' is a dict\n+        of model -> alias of existing joins.\n+        \"\"\"\n+        if model in seen:\n+            return seen[model]\n+        int_opts = opts\n+        chain = opts.get_base_chain(model)\n+        if chain is None:\n+            return alias\n+        for int_model in chain:\n+            if int_model in seen:\n+                return seen[int_model]\n+            # Proxy model have elements in base chain\n+            # with no parents, assign the new options\n+            # object and skip to the next base in that\n+            # case\n+            if not int_opts.parents[int_model]:\n+                int_opts = int_model._meta\n+                continue\n+            link_field = int_opts.get_ancestor_link(int_model)\n+            int_opts = int_model._meta\n+            connection = (alias, int_opts.db_table, link_field.column, int_opts.pk.column)\n+            alias = seen[int_model] = self.join(connection, nullable=False,\n+                                                join_field=link_field)\n+        return alias\n+\n     def remove_inherited_models(self):\n         \"\"\"\n         Undoes the effects of setup_inherited_models(). Should be called"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 37,
        "deletions": 61
    }
}