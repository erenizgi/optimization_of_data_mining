{
    "author": "claudep",
    "message": "Fixed #19725 -- Made createsuperuser handle non-ascii prompts\n\nThanks Michisu for the report.",
    "sha": "55c585f1c7a9c91308193f0648caf36203174564",
    "files": [
        {
            "sha": "4169da248c1495624744aa6841b22096416d42c9",
            "filename": "django/contrib/auth/management/commands/createsuperuser.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/55c585f1c7a9c91308193f0648caf36203174564/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "raw_url": "https://github.com/django/django/raw/55c585f1c7a9c91308193f0648caf36203174564/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py?ref=55c585f1c7a9c91308193f0648caf36203174564",
            "patch": "@@ -11,6 +11,7 @@\n from django.core import exceptions\n from django.core.management.base import BaseCommand, CommandError\n from django.db import DEFAULT_DB_ALIAS\n+from django.utils.encoding import force_str\n from django.utils.six.moves import input\n from django.utils.text import capfirst\n \n@@ -83,8 +84,9 @@ def handle(self, *args, **options):\n                     if not username:\n                         input_msg = capfirst(self.username_field.verbose_name)\n                         if default_username:\n-                            input_msg += \" (leave blank to use '%s')\" % default_username\n-                        raw_value = input(input_msg + ': ')\n+                            input_msg = \"%s (leave blank to use '%s')\" % (\n+                                input_msg, default_username)\n+                        raw_value = input(force_str('%s: ' % input_msg))\n \n                     if default_username and raw_value == '':\n                         raw_value = default_username\n@@ -107,7 +109,7 @@ def handle(self, *args, **options):\n                     field = self.UserModel._meta.get_field(field_name)\n                     user_data[field_name] = options.get(field_name)\n                     while user_data[field_name] is None:\n-                        raw_value = input(capfirst(field.verbose_name + ': '))\n+                        raw_value = input(force_str('%s: ' % capfirst(field.verbose_name)))\n                         try:\n                             user_data[field_name] = field.clean(raw_value, None)\n                         except exceptions.ValidationError as e:"
        },
        {
            "sha": "86273298708331f9196ccb1c3529e5ba60bf002f",
            "filename": "django/contrib/auth/tests/basic.py",
            "status": "modified",
            "additions": 56,
            "deletions": 14,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/55c585f1c7a9c91308193f0648caf36203174564/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py",
            "raw_url": "https://github.com/django/django/raw/55c585f1c7a9c91308193f0648caf36203174564/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py?ref=55c585f1c7a9c91308193f0648caf36203174564",
            "patch": "@@ -1,3 +1,6 @@\n+# -*- encoding: utf-8 -*-\n+from __future__ import unicode_literals\n+\n import locale\n \n from django.contrib.auth import get_user_model\n@@ -12,6 +15,37 @@\n from django.utils.six import StringIO\n \n \n+def mock_inputs(inputs):\n+    \"\"\"\n+    Decorator to temporarily replace input/getpass to allow interactive\n+    createsuperuser.\n+    \"\"\"\n+    def inner(test_func):\n+        def wrapped(*args):\n+            class mock_getpass:\n+                pass\n+            mock_getpass.getpass = staticmethod(lambda p=None: inputs['password'])\n+\n+            def mock_input(prompt):\n+                # prompt should be encoded in Python 2. This line will raise an\n+                # Exception if prompt contains unencoded non-ascii on Python 2.\n+                prompt = str(prompt)\n+                if str('leave blank to use') in prompt:\n+                    return inputs['username']\n+\n+            old_getpass = createsuperuser.getpass\n+            old_input = createsuperuser.input\n+            createsuperuser.getpass = mock_getpass\n+            createsuperuser.input = mock_input\n+            try:\n+                test_func(*args)\n+            finally:\n+                createsuperuser.getpass = old_getpass\n+                createsuperuser.input = old_input\n+        return wrapped\n+    return inner\n+\n+\n @skipIfCustomUser\n class BasicTestCase(TestCase):\n     def test_user(self):\n@@ -103,57 +137,65 @@ def test_createsuperuser_management_command(self):\n         self.assertEqual(u.email, 'joe2@somewhere.org')\n         self.assertFalse(u.has_usable_password())\n \n-        new_io = StringIO()\n         call_command(\"createsuperuser\",\n             interactive=False,\n             username=\"joe+admin@somewhere.org\",\n             email=\"joe@somewhere.org\",\n-            stdout=new_io\n+            verbosity=0\n         )\n         u = User.objects.get(username=\"joe+admin@somewhere.org\")\n         self.assertEqual(u.email, 'joe@somewhere.org')\n         self.assertFalse(u.has_usable_password())\n \n+    @mock_inputs({'password': \"nopasswd\"})\n     def test_createsuperuser_nolocale(self):\n         \"\"\"\n         Check that createsuperuser does not break when no locale is set. See\n         ticket #16017.\n         \"\"\"\n \n         old_getdefaultlocale = locale.getdefaultlocale\n-        old_getpass = createsuperuser.getpass\n         try:\n             # Temporarily remove locale information\n             locale.getdefaultlocale = lambda: (None, None)\n \n-            # Temporarily replace getpass to allow interactive code to be used\n-            # non-interactively\n-            class mock_getpass:\n-                pass\n-            mock_getpass.getpass = staticmethod(lambda p=None: \"nopasswd\")\n-            createsuperuser.getpass = mock_getpass\n-\n             # Call the command in this new environment\n-            new_io = StringIO()\n             call_command(\"createsuperuser\",\n                 interactive=True,\n                 username=\"nolocale@somewhere.org\",\n                 email=\"nolocale@somewhere.org\",\n-                stdout=new_io\n+                verbosity=0\n             )\n \n         except TypeError:\n             self.fail(\"createsuperuser fails if the OS provides no information about the current locale\")\n \n         finally:\n-            # Re-apply locale and getpass information\n-            createsuperuser.getpass = old_getpass\n+            # Re-apply locale information\n             locale.getdefaultlocale = old_getdefaultlocale\n \n         # If we were successful, a user should have been created\n         u = User.objects.get(username=\"nolocale@somewhere.org\")\n         self.assertEqual(u.email, 'nolocale@somewhere.org')\n \n+    @mock_inputs({'password': \"nopasswd\", 'username': 'foo'})\n+    def test_createsuperuser_non_ascii_verbose_name(self):\n+        username_field = User._meta.get_field('username')\n+        old_verbose_name = username_field.verbose_name\n+        username_field.verbose_name = 'u≈æivatel'\n+        new_io = StringIO()\n+        try:\n+            call_command(\"createsuperuser\",\n+                interactive=True,\n+                email=\"nolocale@somewhere.org\",\n+                stdout=new_io\n+            )\n+        finally:\n+            username_field.verbose_name = old_verbose_name\n+\n+        command_output = new_io.getvalue().strip()\n+        self.assertEqual(command_output, 'Superuser created successfully.')\n+\n     def test_get_user_model(self):\n         \"The current user model can be retrieved\"\n         self.assertEqual(get_user_model(), User)"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 61,
        "deletions": 17
    }
}