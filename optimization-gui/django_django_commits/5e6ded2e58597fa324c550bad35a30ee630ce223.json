{
    "author": "claudep",
    "message": "Fixed #18363 -- Added Python 3 compatibility layer.\n\nThanks Vinay Sajip for the support of his django3 branch\nand Alex Gaynor, kezabelle, YorikSar for the review.",
    "sha": "5e6ded2e58597fa324c550bad35a30ee630ce223",
    "files": [
        {
            "sha": "8a5c37e97662fed5545db0d6d108da90a944b84c",
            "filename": "django/utils/py3.py",
            "status": "added",
            "additions": 109,
            "deletions": 0,
            "changes": 109,
            "blob_url": "https://github.com/django/django/blob/5e6ded2e58597fa324c550bad35a30ee630ce223/django%2Futils%2Fpy3.py",
            "raw_url": "https://github.com/django/django/raw/5e6ded2e58597fa324c550bad35a30ee630ce223/django%2Futils%2Fpy3.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fpy3.py?ref=5e6ded2e58597fa324c550bad35a30ee630ce223",
            "patch": "@@ -0,0 +1,109 @@\n+# Compatibility layer for running Django both in 2.x and 3.x\n+\n+import sys\n+\n+if sys.version_info[0] < 3:\n+    PY3 = False\n+    # Changed module locations\n+    from urlparse import (urlparse, urlunparse, urljoin, urlsplit, urlunsplit,\n+                          urldefrag, parse_qsl)\n+    from urllib import (quote, unquote, quote_plus, urlopen, urlencode,\n+                        url2pathname, urlretrieve, unquote_plus)\n+    from urllib2 import (Request, OpenerDirector, UnknownHandler, HTTPHandler,\n+                         HTTPSHandler, HTTPDefaultErrorHandler, FTPHandler,\n+                         HTTPError, HTTPErrorProcessor)\n+    import urllib2\n+    import Cookie as cookies\n+    try:\n+        import cPickle as pickle\n+    except ImportError:\n+        import pickle\n+    try:\n+        import thread\n+    except ImportError:\n+        import dummy_thread as thread\n+    from htmlentitydefs import name2codepoint\n+    import HTMLParser\n+    from os import getcwdu\n+    from itertools import izip as zip\n+    unichr = unichr\n+    xrange = xrange\n+    maxsize = sys.maxint\n+\n+    # Type aliases\n+    string_types = basestring,\n+    text_type = unicode\n+    integer_types = int, long\n+    long_type = long\n+\n+    from io import BytesIO as OutputIO\n+\n+    # Glue code for syntax differences\n+    def reraise(tp, value, tb=None):\n+        exec(\"raise tp, value, tb\")\n+\n+    def with_metaclass(meta, base=object):\n+        class _DjangoBase(base):\n+            __metaclass__ = meta\n+        return _DjangoBase\n+\n+    iteritems = lambda o: o.iteritems()\n+    itervalues = lambda o: o.itervalues()\n+    iterkeys = lambda o: o.iterkeys()\n+\n+    # n() is useful when python3 needs a str (unicode), and python2 str (bytes)\n+    n = lambda s: s.encode('utf-8')\n+\n+else:\n+    PY3 = True\n+    import builtins\n+\n+    # Changed module locations\n+    from urllib.parse import (urlparse, urlunparse, urlencode, urljoin,\n+                              urlsplit, urlunsplit, quote, unquote,\n+                              quote_plus, unquote_plus, parse_qsl,\n+                              urldefrag)\n+    from urllib.request import (urlopen, url2pathname, Request, OpenerDirector,\n+                                UnknownHandler, HTTPHandler, HTTPSHandler,\n+                                HTTPDefaultErrorHandler, FTPHandler,\n+                                HTTPError, HTTPErrorProcessor, urlretrieve)\n+    import urllib.request as urllib2\n+    import http.cookies as cookies\n+    import pickle\n+    try:\n+        import _thread as thread\n+    except ImportError:\n+        import _dummy_thread as thread\n+    from html.entities import name2codepoint\n+    import html.parser as HTMLParser\n+    from os import getcwd as getcwdu\n+    zip = zip\n+    unichr = chr\n+    xrange = range\n+    maxsize = sys.maxsize\n+\n+    # Type aliases\n+    string_types = str,\n+    text_type = str\n+    integer_types = int,\n+    long_type = int\n+\n+    from io import StringIO as OutputIO\n+\n+    # Glue code for syntax differences\n+    def reraise(tp, value, tb=None):\n+        if value.__traceback__ is not tb:\n+            raise value.with_traceback(tb)\n+        raise value\n+\n+    def with_metaclass(meta, base=object):\n+        ns = dict(base=base, meta=meta)\n+        exec(\"\"\"class _DjangoBase(base, metaclass=meta):\n+    pass\"\"\", ns)\n+        return ns[\"_DjangoBase\"]\n+\n+    iteritems = lambda o: o.items()\n+    itervalues = lambda o: o.values()\n+    iterkeys = lambda o: o.keys()\n+\n+    n = lambda s: s"
        },
        {
            "sha": "d85aabed4e623c58ec087f5bc64b47d00dacffce",
            "filename": "docs/index.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Findex.txt?ref=5e6ded2e58597fa324c550bad35a30ee630ce223",
            "patch": "@@ -183,6 +183,7 @@ Other batteries included\n * :doc:`Logging <topics/logging>`\n * :doc:`Messages <ref/contrib/messages>`\n * :doc:`Pagination <topics/pagination>`\n+* :doc:`Python 3 compatibility <topics/python3>`\n * :doc:`Redirects <ref/contrib/redirects>`\n * :doc:`Security <topics/security>`\n * :doc:`Serialization <topics/serialization>`"
        },
        {
            "sha": "b9253e70b31e44d3bc1c1a01c722657c3c5b02ba",
            "filename": "docs/ref/unicode.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Fref%2Funicode.txt",
            "raw_url": "https://github.com/django/django/raw/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Fref%2Funicode.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Funicode.txt?ref=5e6ded2e58597fa324c550bad35a30ee630ce223",
            "patch": "@@ -65,7 +65,8 @@ Python 2 with unicode literals or Python 3::\n \n     my_string = b\"This is a bytestring\"\n     my_unicode = \"This is an Unicode string\"\n-    \n+\n+See also :doc:`Python 3 compatibility </topics/python3>`.\n \n .. admonition:: Warning\n "
        },
        {
            "sha": "00647bc8b790a621ce72eb836fa4e4ec3627463a",
            "filename": "docs/topics/index.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Ftopics%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Ftopics%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Findex.txt?ref=5e6ded2e58597fa324c550bad35a30ee630ce223",
            "patch": "@@ -22,6 +22,7 @@ Introductions to all the key parts of Django you'll need to know:\n    i18n/index\n    logging\n    pagination\n+   python3\n    security\n    serialization\n    settings"
        },
        {
            "sha": "974ddb0e88c6f53bcf6b524aaa7ceaf6dc2a648f",
            "filename": "docs/topics/python3.txt",
            "status": "added",
            "additions": 252,
            "deletions": 0,
            "changes": 252,
            "blob_url": "https://github.com/django/django/blob/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Ftopics%2Fpython3.txt",
            "raw_url": "https://github.com/django/django/raw/5e6ded2e58597fa324c550bad35a30ee630ce223/docs%2Ftopics%2Fpython3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fpython3.txt?ref=5e6ded2e58597fa324c550bad35a30ee630ce223",
            "patch": "@@ -0,0 +1,252 @@\n+======================\n+Python 3 compatibility\n+======================\n+\n+Django 1.5 introduces a compatibility layer that allows the code to be run both\n+in Python 2 (2.6/2.7) and Python 3 (>= 3.2) (*work in progress*).\n+\n+This document is not meant as a complete Python 2 to Python 3 migration guide.\n+There are many existing resources you can read. But we describe some utilities\n+and guidelines that we recommend you should use when you want to ensure your\n+code can be run with both Python 2 and 3.\n+\n+* http://docs.python.org/py3k/howto/pyporting.html\n+* http://python3porting.com/\n+\n+django.utils.py3\n+================\n+\n+Whenever a symbol or module has different semantics or different locations on\n+Python 2 and Python 3, you can import it from ``django.utils.py3`` where it\n+will be automatically converted depending on your current Python version.\n+\n+PY3\n+---\n+\n+If you need to know anywhere in your code if you are running Python 3 or a\n+previous Python 2 version, you can check the ``PY3`` boolean variable::\n+\n+    from django.utils.py3 import PY3\n+\n+    if PY3:\n+        # Do stuff Python 3-wise\n+    else:\n+        # Do stuff Python 2-wise\n+\n+This should be considered as a last resort solution when it is not possible\n+to import a compatible name from django.utils.py3, as described in the sections\n+below.\n+\n+String handling\n+===============\n+\n+In Python 3, all strings are considered Unicode strings by default. Byte strings\n+have to be prefixed with the letter 'b'. To mimic the same behaviour in Python 2,\n+we recommend you import ``unicode_literals`` from the ``__future__`` library::\n+\n+    from __future__ import unicode_literals\n+\n+    my_string = \"This is an unicode literal\"\n+    my_bytestring = b\"This is a bytestring\"\n+\n+Be cautious if you have to slice bytestrings.\n+See http://docs.python.org/py3k/howto/pyporting.html#bytes-literals\n+\n+Different expected strings\n+--------------------------\n+\n+Some method parameters have changed the expected string type of a parameter.\n+For example, ``strftime`` format parameter expects a bytestring on Python 2 but\n+a normal (Unicode) string on Python 3. For these cases, ``django.utils.py3``\n+provides a ``n()`` function which encodes the string parameter only with\n+Python 2.\n+\n+    >>> from __future__ import unicode_literals\n+    >>> from datetime import datetime\n+\n+    >>> print(datetime.date(2012, 5, 21).strftime(n(\"%m → %Y\")))\n+    05 → 2012\n+\n+Renamed types\n+=============\n+\n+Several types are named differently in Python 2 and Python 3. In order to keep\n+compatibility while using those types, import their corresponding aliases from\n+``django.utils.py3``.\n+\n+===========  =========  =====================\n+Python 2     Python 3   django.utils.py3\n+===========  =========  =====================\n+basestring,  str,       string_types (tuple)\n+unicode      str        text_type\n+int, long    int,       integer_types (tuple)\n+long         int        long_type\n+===========  =========  =====================\n+\n+String aliases\n+--------------\n+\n+Code sample::\n+\n+    if isinstance(foo, basestring):\n+        print(\"foo is a string\")\n+\n+    # I want to convert a number to a Unicode string\n+    bar = 45\n+    bar_string = unicode(bar)\n+\n+Should be replaced by::\n+\n+    from django.utils.py3 import string_types, text_type\n+\n+    if isinstance(foo, string_types):\n+        print(\"foo is a string\")\n+\n+    # I want to convert a number to a Unicode string\n+    bar = 45\n+    bar_string = text_type(bar)\n+\n+No more long type\n+-----------------\n+\n+``long`` and ``int`` types have been unified in Python 3, meaning that  ``long``\n+is no longer available. ``django.utils.py3`` provides both ``long_type`` and\n+``integer_types`` aliases. For example:\n+\n+.. code-block:: python\n+\n+    # Old Python 2 code\n+    my_var = long(333463247234623)\n+    if isinstance(my_var, (int, long)):\n+        # ...\n+\n+Should be replaced by:\n+\n+.. code-block:: python\n+\n+    from django.utils.py3 import long_type, integer_types\n+\n+    my_var = long_type(333463247234623)\n+    if isinstance(my_var, integer_types):\n+        # ...\n+\n+\n+Changed module locations\n+========================\n+\n+The following modules have changed their location in Python 3. Therefore, it is\n+recommended to import them from the ``django.utils.py3`` compatibility layer:\n+\n+=============================== ======================================  ======================\n+Python 2                        Python3                                 django.utils.py3\n+=============================== ======================================  ======================\n+Cookie                          http.cookies                            cookies\n+\n+urlparse.urlparse               urllib.parse.urlparse                   urlparse\n+urlparse.urlunparse             urllib.parse.urlunparse                 urlunparse\n+urlparse.urljoin                urllib.parse.urljoin                    urljoin\n+urlparse.urlsplit               urllib.parse.urlsplit                   urlsplit\n+urlparse.urlunsplit             urllib.parse.urlunsplit                 urlunsplit\n+urlparse.urldefrag              urllib.parse.urldefrag                  urldefrag\n+urlparse.parse_qsl              urllib.parse.parse_qsl                  parse_qsl\n+urllib.quote                    urllib.parse.quote                      quote\n+urllib.unquote                  urllib.parse.unquote                    unquote\n+urllib.quote_plus               urllib.parse.quote_plus                 quote_plus\n+urllib.unquote_plus             urllib.parse.unquote_plus               unquote_plus\n+urllib.urlencode                urllib.parse.urlencode                  urlencode\n+urllib.urlopen                  urllib.request.urlopen                  urlopen\n+urllib.url2pathname             urllib.request.url2pathname             url2pathname\n+urllib.urlretrieve              urllib.request.urlretrieve              urlretrieve\n+urllib2                         urllib.request                          urllib2\n+urllib2.Request                 urllib.request.Request                  Request\n+urllib2.OpenerDirector          urllib.request.OpenerDirector           OpenerDirector\n+urllib2.UnknownHandler          urllib.request.UnknownHandler           UnknownHandler\n+urllib2.HTTPHandler             urllib.request.HTTPHandler              HTTPHandler\n+urllib2.HTTPSHandler            urllib.request.HTTPSHandler             HTTPSHandler\n+urllib2.HTTPDefaultErrorHandler urllib.request.HTTPDefaultErrorHandler  HTTPDefaultErrorHandler\n+urllib2.FTPHandler              urllib.request.FTPHandler               FTPHandler\n+urllib2.HTTPError               urllib.request.HTTPError                HTTPError\n+urllib2.HTTPErrorProcessor      urllib.request.HTTPErrorProcessor       HTTPErrorProcessor\n+\n+htmlentitydefs.name2codepoint   html.entities.name2codepoint            name2codepoint\n+HTMLParser                      html.parser                             HTMLParser\n+cPickle/pickle                  pickle                                  pickle\n+thread/dummy_thread             _thread/_dummy_thread                   thread\n+\n+os.getcwdu                      os.getcwd                               getcwdu\n+itertools.izip                  zip                                     zip\n+sys.maxint                      sys.maxsize                             maxsize\n+unichr                          chr                                     unichr\n+xrange                          range                                   xrange\n+=============================== ======================================  ======================\n+\n+\n+Ouptut encoding now Unicode\n+===========================\n+\n+If you want to catch stdout/stderr output, the output content is UTF-8 encoded\n+in Python 2, while it is Unicode strings in Python 3. You can use the OutputIO\n+stream to capture this output::\n+\n+    from django.utils.py3 import OutputIO\n+\n+    try:\n+        old_stdout = sys.stdout\n+        out = OutputIO()\n+        sys.stdout = out\n+        # Do stuff which produces standard output\n+        result = out.getvalue()\n+    finally:\n+        sys.stdout = old_stdout\n+\n+Dict iteritems/itervalues/iterkeys\n+==================================\n+\n+The iteritems(), itervalues() and iterkeys() methods of dictionaries do not\n+exist any more in Python 3, simply because they represent the default items()\n+values() and keys() behavior in Python 3. Therefore, to keep compatibility,\n+use similar functions from ``django.utils.py3``::\n+\n+    from django.utils.py3 import iteritems, itervalues, iterkeys\n+\n+    my_dict = {'a': 21, 'b': 42}\n+    for key, value in iteritems(my_dict):\n+        # ...\n+    for value in itervalues(my_dict):\n+        # ...\n+    for key in iterkeys(my_dict):\n+        # ...\n+\n+Note that in Python 3, dict.keys(), dict.items() and dict.values() return\n+\"views\" instead of lists. Wrap them into list() if you really need their return\n+values to be in a list.\n+\n+http://docs.python.org/release/3.0.1/whatsnew/3.0.html#views-and-iterators-instead-of-lists\n+\n+Metaclass\n+=========\n+\n+The syntax for declaring metaclasses has changed in Python 3.\n+``django.utils.py3`` offers a compatible way to declare metaclasses::\n+\n+    from django.utils.py3 import with_metaclass\n+\n+    class MyClass(with_metaclass(SubClass1, SubClass2,...)):\n+        # ...\n+\n+Re-raising exceptions\n+=====================\n+\n+One of the syntaxes to raise exceptions (raise E, V, T) is gone in Python 3.\n+This is especially used in very specific cases where you want to re-raise a\n+different exception that the initial one, while keeping the original traceback.\n+So, instead of::\n+\n+    raise Exception, Exception(msg), traceback\n+\n+Use::\n+\n+    from django.utils.py3 import reraise\n+\n+    reraise(Exception, Exception(msg), traceback)\n+"
        }
    ],
    "stats": {
        "total": 366,
        "additions": 365,
        "deletions": 1
    }
}