{
    "author": "jbronn",
    "message": "Fixed #15305 -- Made `Count` aggregate and `.values()` play nice together on `GeoQuerySets`.  Thanks, vrehak for the bug report and milosu for initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16797 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a25413bf86e5e65129f8582a713a29308296c374",
    "files": [
        {
            "sha": "9a4ea6a942d2a2c122633b6564e8e7224e393246",
            "filename": "django/contrib/gis/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/a25413bf86e5e65129f8582a713a29308296c374/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/a25413bf86e5e65129f8582a713a29308296c374/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=a25413bf86e5e65129f8582a713a29308296c374",
            "patch": "@@ -171,10 +171,6 @@ def resolve_columns(self, row, fields=()):\n         \"\"\"\n         values = []\n         aliases = self.query.extra_select.keys()\n-        if self.query.aggregates:\n-            # If we have an aggregate annotation, must extend the aliases\n-            # so their corresponding row values are included.\n-            aliases.extend([None for i in xrange(len(self.query.aggregates))])\n \n         # Have to set a starting row number offset that is used for\n         # determining the correct starting row index -- needed for"
        },
        {
            "sha": "9ef090b90176893ad16f8ad5021169efb6f09411",
            "filename": "django/contrib/gis/tests/relatedapp/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/a25413bf86e5e65129f8582a713a29308296c374/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a25413bf86e5e65129f8582a713a29308296c374/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ftests.py?ref=a25413bf86e5e65129f8582a713a29308296c374",
            "patch": "@@ -245,6 +245,13 @@ def test12b_count(self):\n         self.assertEqual(1, len(vqs))\n         self.assertEqual(3, vqs[0]['num_books'])\n \n+    def test13c_count(self):\n+        \"Testing `Count` aggregate with `.values()`.  See #15305.\"\n+        qs = Location.objects.filter(id=5).annotate(num_cities=Count('city')).values('id', 'point', 'num_cities')\n+        self.assertEqual(1, len(qs))\n+        self.assertEqual(2, qs[0]['num_cities'])\n+        self.assertTrue(isinstance(qs[0]['point'], GEOSGeometry))\n+\n     # TODO: The phantom model does appear on Oracle.\n     @no_oracle\n     def test13_select_related_null_fk(self):\n@@ -284,7 +291,7 @@ def test15_invalid_select_related(self):\n \n     def test16_annotated_date_queryset(self):\n         \"Ensure annotated date querysets work if spatial backend is used.  See #14648.\"\n-        birth_years = [dt.year for dt in \n+        birth_years = [dt.year for dt in\n                        list(Author.objects.annotate(num_books=Count('books')).dates('dob', 'year'))]\n         birth_years.sort()\n         self.assertEqual([1950, 1974], birth_years)"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 8,
        "deletions": 5
    }
}