{
    "author": "aaugustin",
    "message": "[py3] Supported integers in HttpResponse\n\nFixed #18764.",
    "sha": "536b0303637c55c914784b57841e6d59c4968d5f",
    "files": [
        {
            "sha": "9ec2afd96897668578beaf9d27e0cc343f65cae2",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/536b0303637c55c914784b57841e6d59c4968d5f/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/536b0303637c55c914784b57841e6d59c4968d5f/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=536b0303637c55c914784b57841e6d59c4968d5f",
            "patch": "@@ -85,7 +85,7 @@ def _BaseCookie__set(self, key, real_value, coded_value):\n from django.http.multipartparser import MultiPartParser\n from django.http.utils import *\n from django.utils.datastructures import MultiValueDict, ImmutableList\n-from django.utils.encoding import smart_bytes, smart_str, iri_to_uri, force_text\n+from django.utils.encoding import force_bytes, force_text, iri_to_uri, smart_bytes, smart_str\n from django.utils.http import cookie_date\n from django.utils import six\n from django.utils import timezone\n@@ -670,10 +670,12 @@ def delete_cookie(self, key, path='/', domain=None):\n                         expires='Thu, 01-Jan-1970 00:00:00 GMT')\n \n     def _get_content(self):\n-        if self.has_header('Content-Encoding'):\n-            # XXX this doesn't work under Python 3 when e is an integer (#18764)\n-            return b''.join([bytes(e) for e in self._container])\n-        return b''.join([smart_bytes(e, self._charset) for e in self._container])\n+        # The logic below obeys the following constraints:\n+        # - do not perform any encoding if a Content-Encoding is set (#4969)\n+        # - force string conversion of non-string types (#16494)\n+        # - avoid simply calling bytes() with Python 3 (#18764)\n+        encoding = 'ascii' if self.has_header('Content-Encoding') else self._charset\n+        return b''.join(force_bytes(e, encoding) for e in self._container)\n \n     def _set_content(self, value):\n         if hasattr(value, '__iter__') and not isinstance(value, (bytes, six.string_types)):\n@@ -690,10 +692,9 @@ def __iter__(self):\n         return self\n \n     def __next__(self):\n-        chunk = next(self._iterator)\n-        if isinstance(chunk, six.text_type):\n-            chunk = chunk.encode(self._charset)\n-        return bytes(chunk)\n+        # Use the same logic as _get_content.\n+        encoding = 'ascii' if self.has_header('Content-Encoding') else self._charset\n+        return force_bytes(next(self._iterator), encoding)\n \n     next = __next__             # Python 2 compatibility\n "
        },
        {
            "sha": "bbb2518b32ccfab085987703a120c41aa474f985",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/536b0303637c55c914784b57841e6d59c4968d5f/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/536b0303637c55c914784b57841e6d59c4968d5f/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=536b0303637c55c914784b57841e6d59c4968d5f",
            "patch": "@@ -296,7 +296,7 @@ def test_iter_content(self):\n         my_iter = r.__iter__()\n         result = list(my_iter)\n         #'\\xde\\x9e' == unichr(1950).encode('utf-8')\n-        self.assertEqual(result, ['1', '2', '3', b'\\xde\\x9e'])\n+        self.assertEqual(result, [b'1', b'2', b'3', b'\\xde\\x9e'])\n         self.assertEqual(r.content, b'123\\xde\\x9e')\n \n         #with Content-Encoding header"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 11,
        "deletions": 10
    }
}