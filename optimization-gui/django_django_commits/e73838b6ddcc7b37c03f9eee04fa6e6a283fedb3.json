{
    "author": "aaugustin",
    "message": "Fixed #17371 -- Made the test client more flexible\n\nThe OPTIONS, PUT and DELETE methods no longer apply arbitrary\ndata encoding (in the query string or in the request body).",
    "sha": "e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3",
    "files": [
        {
            "sha": "3cc6a6e5376a6474e4de93e257aa958e4fec9e7b",
            "filename": "django/test/client.py",
            "status": "modified",
            "additions": 32,
            "deletions": 38,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/django%2Ftest%2Fclient.py",
            "raw_url": "https://github.com/django/django/raw/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/django%2Ftest%2Fclient.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fclient.py?ref=e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3",
            "patch": "@@ -155,7 +155,6 @@ def encode_file(boundary, key, file):\n     ]\n \n \n-\n class RequestFactory(object):\n     \"\"\"\n     Class that lets you create mock Request objects for use in testing.\n@@ -227,7 +226,7 @@ def _get_path(self, parsed):\n             return urllib.unquote(parsed[2])\n \n     def get(self, path, data={}, **extra):\n-        \"Construct a GET request\"\n+        \"Construct a GET request.\"\n \n         parsed = urlparse(path)\n         r = {\n@@ -270,49 +269,39 @@ def head(self, path, data={}, **extra):\n         r.update(extra)\n         return self.request(**r)\n \n-    def options(self, path, data={}, **extra):\n-        \"Constrict an OPTIONS request\"\n-\n-        parsed = urlparse(path)\n-        r = {\n-            'PATH_INFO':       self._get_path(parsed),\n-            'QUERY_STRING':    urlencode(data, doseq=True) or parsed[4],\n-            'REQUEST_METHOD': 'OPTIONS',\n-        }\n-        r.update(extra)\n-        return self.request(**r)\n+    def options(self, path, data='', content_type='application/octet-stream',\n+            **extra):\n+        \"Construct an OPTIONS request.\"\n+        return self.generic('OPTIONS', path, data, content_type, **extra)\n \n-    def put(self, path, data={}, content_type=MULTIPART_CONTENT,\n+    def put(self, path, data='', content_type='application/octet-stream',\n             **extra):\n         \"Construct a PUT request.\"\n+        return self.generic('PUT', path, data, content_type, **extra)\n \n-        put_data = self._encode_data(data, content_type)\n+    def delete(self, path, data='', content_type='application/octet-stream',\n+            **extra):\n+        \"Construct a DELETE request.\"\n+        return self.generic('DELETE', path, data, content_type, **extra)\n \n+    def generic(self, method, path,\n+                data='', content_type='application/octet-stream', **extra):\n         parsed = urlparse(path)\n+        data = smart_str(data, settings.DEFAULT_CHARSET)\n         r = {\n-            'CONTENT_LENGTH': len(put_data),\n-            'CONTENT_TYPE':   content_type,\n             'PATH_INFO':      self._get_path(parsed),\n             'QUERY_STRING':   parsed[4],\n-            'REQUEST_METHOD': 'PUT',\n-            'wsgi.input':     FakePayload(put_data),\n+            'REQUEST_METHOD': method,\n         }\n+        if data:\n+            r.update({\n+                'CONTENT_LENGTH': len(data),\n+                'CONTENT_TYPE':   content_type,\n+                'wsgi.input':     FakePayload(data),\n+            })\n         r.update(extra)\n         return self.request(**r)\n \n-    def delete(self, path, data={}, **extra):\n-        \"Construct a DELETE request.\"\n-\n-        parsed = urlparse(path)\n-        r = {\n-            'PATH_INFO':       self._get_path(parsed),\n-            'QUERY_STRING':    urlencode(data, doseq=True) or parsed[4],\n-            'REQUEST_METHOD': 'DELETE',\n-        }\n-        r.update(extra)\n-        return self.request(**r)\n-\n-\n class Client(RequestFactory):\n     \"\"\"\n     A class that can act as a client for testing purposes.\n@@ -445,30 +434,35 @@ def head(self, path, data={}, follow=False, **extra):\n             response = self._handle_redirects(response, **extra)\n         return response\n \n-    def options(self, path, data={}, follow=False, **extra):\n+    def options(self, path, data='', content_type='application/octet-stream',\n+            follow=False, **extra):\n         \"\"\"\n         Request a response from the server using OPTIONS.\n         \"\"\"\n-        response = super(Client, self).options(path, data=data, **extra)\n+        response = super(Client, self).options(path,\n+                data=data, content_type=content_type, **extra)\n         if follow:\n             response = self._handle_redirects(response, **extra)\n         return response\n \n-    def put(self, path, data={}, content_type=MULTIPART_CONTENT,\n+    def put(self, path, data='', content_type='application/octet-stream',\n             follow=False, **extra):\n         \"\"\"\n         Send a resource to the server using PUT.\n         \"\"\"\n-        response = super(Client, self).put(path, data=data, content_type=content_type, **extra)\n+        response = super(Client, self).put(path,\n+                data=data, content_type=content_type, **extra)\n         if follow:\n             response = self._handle_redirects(response, **extra)\n         return response\n \n-    def delete(self, path, data={}, follow=False, **extra):\n+    def delete(self, path, data='', content_type='application/octet-stream',\n+            follow=False, **extra):\n         \"\"\"\n         Send a DELETE request to the server.\n         \"\"\"\n-        response = super(Client, self).delete(path, data=data, **extra)\n+        response = super(Client, self).delete(path,\n+                data=data, content_type=content_type, **extra)\n         if follow:\n             response = self._handle_redirects(response, **extra)\n         return response"
        },
        {
            "sha": "851fed69f7a2bf8616e3f5e5ad29a5187338a69c",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3",
            "patch": "@@ -56,7 +56,7 @@ previously loaded. For example, with the tutorial's models::\n     True\n \n In Django 1.5, the third line no longer triggers a new SQL query to fetch\n-``first_choice.poll``; it was set when by the second line.\n+``first_choice.poll``; it was set by the second line.\n \n For one-to-one relationships, both sides can be cached. For many-to-one\n relationships, only the single side of the relationship can be cached. This\n@@ -101,6 +101,26 @@ year|date:\"Y\" }}``.\n ``next_year`` and ``previous_year`` were also added in the context. They are\n calculated according to ``allow_empty`` and ``allow_future``.\n \n+OPTIONS, PUT and DELETE requests in the test client\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Unlike GET and POST, these HTTP methods aren't implemented by web browsers.\n+Rather, they're used in APIs, which transfer data in various formats such as\n+JSON or XML. Since such requests may contain arbitrary data, Django doesn't\n+attempt to decode their body.\n+\n+However, the test client used to build a query string for OPTIONS and DELETE\n+requests like for GET, and a request body for PUT requests like for POST. This\n+encoding was arbitrary and inconsistent with Django's behavior when it\n+receives the requests, so it was removed in Django 1.5.\n+\n+If you were using the ``data`` parameter in an OPTIONS or a DELETE request,\n+you must convert it to a query string and append it to the ``path`` parameter.\n+\n+If you were using the ``data`` parameter in a PUT request without a\n+``content_type``, you must encode your data before passing it to the test\n+client and set the ``content_type`` argument.\n+\n Features deprecated in 1.5\n ==========================\n "
        },
        {
            "sha": "f35c545c30bd52292c306956bfd1a5838d29abef",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 34,
            "deletions": 23,
            "changes": 57,
            "blob_url": "https://github.com/django/django/blob/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3",
            "patch": "@@ -805,45 +805,56 @@ arguments at time of construction:\n \n     .. method:: Client.head(path, data={}, follow=False, **extra)\n \n-        Makes a HEAD request on the provided ``path`` and returns a ``Response``\n-        object. Useful for testing RESTful interfaces. Acts just like\n-        :meth:`Client.get` except it does not return a message body.\n+        Makes a HEAD request on the provided ``path`` and returns a\n+        ``Response`` object. This method works just like :meth:`Client.get`,\n+        including the ``follow`` and ``extra`` arguments, except it does not\n+        return a message body.\n \n-        If you set ``follow`` to ``True`` the client will follow any redirects\n-        and a ``redirect_chain`` attribute will be set in the response object\n-        containing tuples of the intermediate urls and status codes.\n-\n-    .. method:: Client.options(path, data={}, follow=False, **extra)\n+    .. method:: Client.options(path, data='', content_type='application/octet-stream', follow=False, **extra)\n \n         Makes an OPTIONS request on the provided ``path`` and returns a\n         ``Response`` object. Useful for testing RESTful interfaces.\n \n-        If you set ``follow`` to ``True`` the client will follow any redirects\n-        and a ``redirect_chain`` attribute will be set in the response object\n-        containing tuples of the intermediate urls and status codes.\n+        When ``data`` is provided, it is used as the request body, and\n+        a ``Content-Type`` header is set to ``content_type``.\n \n-        The ``extra`` argument acts the same as for :meth:`Client.get`.\n+        .. versionchanged:: 1.5\n+            :meth:`Client.options` used to process ``data`` like\n+            :meth:`Client.get`.\n+\n+        The ``follow`` and ``extra`` arguments act the same as for\n+        :meth:`Client.get`.\n \n-    .. method:: Client.put(path, data={}, content_type=MULTIPART_CONTENT, follow=False, **extra)\n+    .. method:: Client.put(path, data='', content_type='application/octet-stream', follow=False, **extra)\n \n         Makes a PUT request on the provided ``path`` and returns a\n-        ``Response`` object. Useful for testing RESTful interfaces. Acts just\n-        like :meth:`Client.post` except with the PUT request method.\n+        ``Response`` object. Useful for testing RESTful interfaces.\n \n-        If you set ``follow`` to ``True`` the client will follow any redirects\n-        and a ``redirect_chain`` attribute will be set in the response object\n-        containing tuples of the intermediate urls and status codes.\n+        When ``data`` is provided, it is used as the request body, and\n+        a ``Content-Type`` header is set to ``content_type``.\n+\n+        .. versionchanged:: 1.5\n+            :meth:`Client.put` used to process ``data`` like\n+            :meth:`Client.post`.\n \n-    .. method:: Client.delete(path, follow=False, **extra)\n+        The ``follow`` and ``extra`` arguments act the same as for\n+        :meth:`Client.get`.\n+\n+    .. method:: Client.delete(path, data='', content_type='application/octet-stream', follow=False, **extra)\n \n         Makes an DELETE request on the provided ``path`` and returns a\n         ``Response`` object. Useful for testing RESTful interfaces.\n \n-        If you set ``follow`` to ``True`` the client will follow any redirects\n-        and a ``redirect_chain`` attribute will be set in the response object\n-        containing tuples of the intermediate urls and status codes.\n+        When ``data`` is provided, it is used as the request body, and\n+        a ``Content-Type`` header is set to ``content_type``.\n+\n+        .. versionchanged:: 1.5\n+            :meth:`Client.delete` used to process ``data`` like\n+            :meth:`Client.get`.\n+\n+        The ``follow`` and ``extra`` arguments act the same as for\n+        :meth:`Client.get`.\n \n-        The ``extra`` argument acts the same as for :meth:`Client.get`.\n \n     .. method:: Client.login(**credentials)\n "
        },
        {
            "sha": "97aeff5eaa0f262daa8ac36207db8cf496aa6b12",
            "filename": "tests/regressiontests/conditional_processing/models.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/tests%2Fregressiontests%2Fconditional_processing%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/tests%2Fregressiontests%2Fconditional_processing%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fconditional_processing%2Fmodels.py?ref=e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3",
            "patch": "@@ -63,10 +63,10 @@ def testIfNoneMatch(self):\n \n     def testIfMatch(self):\n         self.client.defaults['HTTP_IF_MATCH'] = '\"%s\"' % ETAG\n-        response = self.client.put('/condition/etag/', {'data': ''})\n+        response = self.client.put('/condition/etag/')\n         self.assertEqual(response.status_code, 200)\n         self.client.defaults['HTTP_IF_MATCH'] = '\"%s\"' % EXPIRED_ETAG\n-        response = self.client.put('/condition/etag/', {'data': ''})\n+        response = self.client.put('/condition/etag/')\n         self.assertEqual(response.status_code, 412)\n \n     def testBothHeaders(self):"
        },
        {
            "sha": "ca55bd156b143c5b335f52f83496e4fe828a13b7",
            "filename": "tests/regressiontests/test_client_regress/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 17,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py?ref=e73838b6ddcc7b37c03f9eee04fa6e6a283fedb3",
            "patch": "@@ -347,23 +347,23 @@ def test_redirect_chain_head(self):\n     def test_redirect_chain_options(self):\n         \"A redirect chain will be followed from an initial OPTIONS request\"\n         response = self.client.options('/test_client_regress/redirects/',\n-            {'nothing': 'to_send'}, follow=True)\n+            follow=True)\n         self.assertRedirects(response,\n             '/test_client_regress/no_template_view/', 301, 200)\n         self.assertEqual(len(response.redirect_chain), 3)\n \n     def test_redirect_chain_put(self):\n         \"A redirect chain will be followed from an initial PUT request\"\n         response = self.client.put('/test_client_regress/redirects/',\n-            {'nothing': 'to_send'}, follow=True)\n+            follow=True)\n         self.assertRedirects(response,\n             '/test_client_regress/no_template_view/', 301, 200)\n         self.assertEqual(len(response.redirect_chain), 3)\n \n     def test_redirect_chain_delete(self):\n         \"A redirect chain will be followed from an initial DELETE request\"\n         response = self.client.delete('/test_client_regress/redirects/',\n-            {'nothing': 'to_send'}, follow=True)\n+            follow=True)\n         self.assertRedirects(response,\n             '/test_client_regress/no_template_view/', 301, 200)\n         self.assertEqual(len(response.redirect_chain), 3)\n@@ -809,8 +809,7 @@ def test_put(self):\n class QueryStringTests(TestCase):\n     def test_get_like_requests(self):\n         # See: https://code.djangoproject.com/ticket/10571.\n-        # Removed 'put' and 'delete' here as they are 'GET-like requests'\n-        for method_name in ('get','head','options'):\n+        for method_name in ('get', 'head'):\n             # A GET-like request can pass a query string as data\n             method = getattr(self.client, method_name)\n             response = method(\"/test_client_regress/request_data/\", data={'foo':'whiz'})\n@@ -867,9 +866,6 @@ def test_simple_unicode_payload(self):\n         response = self.client.post(\"/test_client_regress/parse_unicode_json/\", json,\n                                     content_type=\"application/json\")\n         self.assertEqual(response.content, json)\n-        response = self.client.put(\"/test_client_regress/parse_unicode_json/\", json,\n-                                    content_type=\"application/json\")\n-        self.assertEqual(response.content, json)\n \n     def test_unicode_payload_utf8(self):\n         \"A non-ASCII unicode data encoded as UTF-8 can be POSTed\"\n@@ -878,9 +874,6 @@ def test_unicode_payload_utf8(self):\n         response = self.client.post(\"/test_client_regress/parse_unicode_json/\", json,\n                                     content_type=\"application/json; charset=utf-8\")\n         self.assertEqual(response.content, json.encode('utf-8'))\n-        response = self.client.put(\"/test_client_regress/parse_unicode_json/\", json,\n-                                    content_type=\"application/json; charset=utf-8\")\n-        self.assertEqual(response.content, json.encode('utf-8'))\n \n     def test_unicode_payload_utf16(self):\n         \"A non-ASCII unicode data encoded as UTF-16 can be POSTed\"\n@@ -889,9 +882,6 @@ def test_unicode_payload_utf16(self):\n         response = self.client.post(\"/test_client_regress/parse_unicode_json/\", json,\n                                     content_type=\"application/json; charset=utf-16\")\n         self.assertEqual(response.content, json.encode('utf-16'))\n-        response = self.client.put(\"/test_client_regress/parse_unicode_json/\", json,\n-                                    content_type=\"application/json; charset=utf-16\")\n-        self.assertEqual(response.content, json.encode('utf-16'))\n \n     def test_unicode_payload_non_utf(self):\n         \"A non-ASCII unicode data as a non-UTF based encoding can be POSTed\"\n@@ -900,9 +890,6 @@ def test_unicode_payload_non_utf(self):\n         response = self.client.post(\"/test_client_regress/parse_unicode_json/\", json,\n                                     content_type=\"application/json; charset=koi8-r\")\n         self.assertEqual(response.content, json.encode('koi8-r'))\n-        response = self.client.put(\"/test_client_regress/parse_unicode_json/\", json,\n-                                    content_type=\"application/json; charset=koi8-r\")\n-        self.assertEqual(response.content, json.encode('koi8-r'))\n \n class DummyFile(object):\n     def __init__(self, filename):"
        }
    ],
    "stats": {
        "total": 174,
        "additions": 93,
        "deletions": 81
    }
}