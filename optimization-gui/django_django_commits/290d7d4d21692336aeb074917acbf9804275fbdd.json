{
    "author": "ramiro",
    "message": "Fixed #16542 -- Made Raw ID form widgets shipped with the admin app render the related object lookup tool only when the related model is effectively registered with the AdminSite.\n\nAlso, converted these widgets to reverse named URLs instead of hard-coded '../../...'-style links, refs #15294.\nThanks Florian Apolloner for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16578 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "290d7d4d21692336aeb074917acbf9804275fbdd",
    "files": [
        {
            "sha": "35c3cde0fc6d7ed2611a6ed65c1b7a6583463e26",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/290d7d4d21692336aeb074917acbf9804275fbdd/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/290d7d4d21692336aeb074917acbf9804275fbdd/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=290d7d4d21692336aeb074917acbf9804275fbdd",
            "patch": "@@ -154,7 +154,8 @@ def formfield_for_foreignkey(self, db_field, request=None, **kwargs):\n         \"\"\"\n         db = kwargs.get('using')\n         if db_field.name in self.raw_id_fields:\n-            kwargs['widget'] = widgets.ForeignKeyRawIdWidget(db_field.rel, using=db)\n+            kwargs['widget'] = widgets.ForeignKeyRawIdWidget(db_field.rel,\n+                                    self.admin_site, using=db)\n         elif db_field.name in self.radio_fields:\n             kwargs['widget'] = widgets.AdminRadioSelect(attrs={\n                 'class': get_ul_class(self.radio_fields[db_field.name]),\n@@ -174,7 +175,8 @@ def formfield_for_manytomany(self, db_field, request=None, **kwargs):\n         db = kwargs.get('using')\n \n         if db_field.name in self.raw_id_fields:\n-            kwargs['widget'] = widgets.ManyToManyRawIdWidget(db_field.rel, using=db)\n+            kwargs['widget'] = widgets.ManyToManyRawIdWidget(db_field.rel,\n+                                    self.admin_site, using=db)\n             kwargs['help_text'] = ''\n         elif db_field.name in (list(self.filter_vertical) + list(self.filter_horizontal)):\n             kwargs['widget'] = widgets.FilteredSelectMultiple(db_field.verbose_name, (db_field.name in self.filter_vertical))"
        },
        {
            "sha": "038351e6daa178c1b242277417b0a8eb49233628",
            "filename": "django/contrib/admin/widgets.py",
            "status": "modified",
            "additions": 31,
            "deletions": 20,
            "changes": 51,
            "blob_url": "https://github.com/django/django/blob/290d7d4d21692336aeb074917acbf9804275fbdd/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/290d7d4d21692336aeb074917acbf9804275fbdd/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fwidgets.py?ref=290d7d4d21692336aeb074917acbf9804275fbdd",
            "patch": "@@ -4,7 +4,7 @@\n \n import copy\n from django import forms\n-from django.core.urlresolvers import reverse, NoReverseMatch\n+from django.core.urlresolvers import reverse\n from django.forms.widgets import RadioFieldRenderer\n from django.forms.util import flatatt\n from django.templatetags.static import static\n@@ -112,29 +112,38 @@ class ForeignKeyRawIdWidget(forms.TextInput):\n     A Widget for displaying ForeignKeys in the \"raw_id\" interface rather than\n     in a <select> box.\n     \"\"\"\n-    def __init__(self, rel, attrs=None, using=None):\n+    def __init__(self, rel, admin_site, attrs=None, using=None):\n         self.rel = rel\n+        self.admin_site = admin_site\n         self.db = using\n         super(ForeignKeyRawIdWidget, self).__init__(attrs)\n \n     def render(self, name, value, attrs=None):\n+        rel_to = self.rel.to\n         if attrs is None:\n             attrs = {}\n-        related_url = '../../../%s/%s/' % (self.rel.to._meta.app_label, self.rel.to._meta.object_name.lower())\n-        params = self.url_parameters()\n-        if params:\n-            url = u'?' + u'&amp;'.join([u'%s=%s' % (k, v) for k, v in params.items()])\n-        else:\n-            url = u''\n-        if \"class\" not in attrs:\n-            attrs['class'] = 'vForeignKeyRawIdAdminField' # The JavaScript looks for this hook.\n-        output = [super(ForeignKeyRawIdWidget, self).render(name, value, attrs)]\n-        # TODO: \"id_\" is hard-coded here. This should instead use the correct\n-        # API to determine the ID dynamically.\n-        output.append(u'<a href=\"%s%s\" class=\"related-lookup\" id=\"lookup_id_%s\" onclick=\"return showRelatedObjectLookupPopup(this);\"> '\n-                      % (related_url, url, name))\n-        output.append(u'<img src=\"%s\" width=\"16\" height=\"16\" alt=\"%s\" /></a>'\n-                      % (static('admin/img/selector-search.gif'), _('Lookup')))\n+        extra = []\n+        if rel_to in self.admin_site._registry:\n+            # The related object is registered with the same AdminSite\n+            related_url = reverse('admin:%s_%s_changelist' %\n+                                    (rel_to._meta.app_label,\n+                                    rel_to._meta.module_name),\n+                                    current_app=self.admin_site.name)\n+\n+            params = self.url_parameters()\n+            if params:\n+                url = u'?' + u'&amp;'.join([u'%s=%s' % (k, v) for k, v in params.items()])\n+            else:\n+                url = u''\n+            if \"class\" not in attrs:\n+                attrs['class'] = 'vForeignKeyRawIdAdminField' # The JavaScript code looks for this hook.\n+            # TODO: \"lookup_id_\" is hard-coded here. This should instead use\n+            # the correct API to determine the ID dynamically.\n+            extra.append(u'<a href=\"%s%s\" class=\"related-lookup\" id=\"lookup_id_%s\" onclick=\"return showRelatedObjectLookupPopup(this);\"> '\n+                            % (related_url, url, name))\n+            extra.append(u'<img src=\"%s\" width=\"16\" height=\"16\" alt=\"%s\" /></a>'\n+                            % (static('admin/img/selector-search.gif'), _('Lookup')))\n+        output = [super(ForeignKeyRawIdWidget, self).render(name, value, attrs)] + extra\n         if value:\n             output.append(self.label_for_value(value))\n         return mark_safe(u''.join(output))\n@@ -164,7 +173,9 @@ class ManyToManyRawIdWidget(ForeignKeyRawIdWidget):\n     def render(self, name, value, attrs=None):\n         if attrs is None:\n             attrs = {}\n-        attrs['class'] = 'vManyToManyRawIdAdminField'\n+        if self.rel.to in self.admin_site._registry:\n+            # The related object is registered with the same AdminSite\n+            attrs['class'] = 'vManyToManyRawIdAdminField'\n         if value:\n             value = ','.join([force_unicode(v) for v in value])\n         else:\n@@ -232,8 +243,8 @@ def render(self, name, value, *args, **kwargs):\n         output = [self.widget.render(name, value, *args, **kwargs)]\n         if self.can_add_related:\n             related_url = reverse('admin:%s_%s_add' % info, current_app=self.admin_site.name)\n-            # TODO: \"id_\" is hard-coded here. This should instead use the correct\n-            # API to determine the ID dynamically.\n+            # TODO: \"add_id_\" is hard-coded here. This should instead use the\n+            # correct API to determine the ID dynamically.\n             output.append(u'<a href=\"%s\" class=\"add-another\" id=\"add_id_%s\" onclick=\"return showAddAnotherPopup(this);\"> '\n                           % (related_url, name))\n             output.append(u'<img src=\"%s\" width=\"10\" height=\"10\" alt=\"%s\"/></a>'"
        },
        {
            "sha": "c4489e07c761533836c77f5d80548045ea01131f",
            "filename": "tests/regressiontests/admin_widgets/models.py",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/290d7d4d21692336aeb074917acbf9804275fbdd/tests%2Fregressiontests%2Fadmin_widgets%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/290d7d4d21692336aeb074917acbf9804275fbdd/tests%2Fregressiontests%2Fadmin_widgets%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_widgets%2Fmodels.py?ref=290d7d4d21692336aeb074917acbf9804275fbdd",
            "patch": "@@ -67,3 +67,35 @@ class CarTire(models.Model):\n     A single car tire. This to test that a user can only select their own cars.\n     \"\"\"\n     car = models.ForeignKey(Car)\n+\n+class Honeycomb(models.Model):\n+    location = models.CharField(max_length=20)\n+\n+class Bee(models.Model):\n+    \"\"\"\n+    A model with a FK to a model that won't be registered with the admin\n+    (Honeycomb) so the corresponding raw ID widget won't have a magnifying\n+    glass link to select related honeycomb instances.\n+    \"\"\"\n+    honeycomb = models.ForeignKey(Honeycomb)\n+\n+class Individual(models.Model):\n+    \"\"\"\n+    A model with a FK to itself. It won't be registered with the admin, so the\n+    corresponding raw ID widget won't have a magnifying glass link to select\n+    related instances (rendering will be called programmatically in this case).\n+    \"\"\"\n+    name = models.CharField(max_length=20)\n+    parent = models.ForeignKey('self', null=True)\n+\n+class Company(models.Model):\n+    name = models.CharField(max_length=20)\n+\n+class Advisor(models.Model):\n+    \"\"\"\n+    A model with a m2m to a model that won't be registered with the admin\n+    (Company) so the corresponding raw ID widget won't have a magnifying\n+    glass link to select related company instances.\n+    \"\"\"\n+    name = models.CharField(max_length=20)\n+    companies = models.ManyToManyField(Company)"
        },
        {
            "sha": "c1b6888967e7ed90376f80e3b2e4da70e540db1b",
            "filename": "tests/regressiontests/admin_widgets/tests.py",
            "status": "modified",
            "additions": 66,
            "deletions": 26,
            "changes": 92,
            "blob_url": "https://github.com/django/django/blob/290d7d4d21692336aeb074917acbf9804275fbdd/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/290d7d4d21692336aeb074917acbf9804275fbdd/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py?ref=290d7d4d21692336aeb074917acbf9804275fbdd",
            "patch": "@@ -7,10 +7,6 @@\n from django.conf import settings\n from django.contrib import admin\n from django.contrib.admin import widgets\n-from django.contrib.admin.widgets import (FilteredSelectMultiple,\n-    AdminSplitDateTime, AdminFileWidget, ForeignKeyRawIdWidget, AdminRadioSelect,\n-    RelatedFieldWidgetWrapper, ManyToManyRawIdWidget,\n-    url_params_from_lookup_dict)\n from django.core.files.storage import default_storage\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.db.models import DateField\n@@ -20,6 +16,7 @@\n from django.utils.unittest import TestCase\n \n import models\n+from widgetadmin import site as widget_admin_site\n \n admin_media_prefix = lambda: {\n     'ADMIN_MEDIA_PREFIX': \"%sadmin/\" % settings.STATIC_URL,\n@@ -186,22 +183,22 @@ def test_invalid_target_id(self):\n                 'Select a valid choice. That choice is not one of the available choices.')\n \n     def test_url_params_from_lookup_dict_any_iterable(self):\n-        lookup1 = url_params_from_lookup_dict({'color__in': ('red', 'blue')})\n-        lookup2 = url_params_from_lookup_dict({'color__in': ['red', 'blue']})\n+        lookup1 = widgets.url_params_from_lookup_dict({'color__in': ('red', 'blue')})\n+        lookup2 = widgets.url_params_from_lookup_dict({'color__in': ['red', 'blue']})\n         self.assertEqual(lookup1, {'color__in': 'red,blue'})\n         self.assertEqual(lookup1, lookup2)\n \n \n class FilteredSelectMultipleWidgetTest(DjangoTestCase):\n     def test_render(self):\n-        w = FilteredSelectMultiple('test', False)\n+        w = widgets.FilteredSelectMultiple('test', False)\n         self.assertEqual(\n             conditional_escape(w.render('test', 'test')),\n             '<select multiple=\"multiple\" name=\"test\" class=\"selectfilter\">\\n</select><script type=\"text/javascript\">addEvent(window, \"load\", function(e) {SelectFilter.init(\"id_test\", \"test\", 0, \"%(ADMIN_MEDIA_PREFIX)s\"); });</script>\\n' % admin_media_prefix()\n         )\n \n     def test_stacked_render(self):\n-        w = FilteredSelectMultiple('test', True)\n+        w = widgets.FilteredSelectMultiple('test', True)\n         self.assertEqual(\n             conditional_escape(w.render('test', 'test')),\n             '<select multiple=\"multiple\" name=\"test\" class=\"selectfilterstacked\">\\n</select><script type=\"text/javascript\">addEvent(window, \"load\", function(e) {SelectFilter.init(\"id_test\", \"test\", 1, \"%(ADMIN_MEDIA_PREFIX)s\"); });</script>\\n' % admin_media_prefix()\n@@ -210,14 +207,14 @@ def test_stacked_render(self):\n \n class AdminSplitDateTimeWidgetTest(DjangoTestCase):\n     def test_render(self):\n-        w = AdminSplitDateTime()\n+        w = widgets.AdminSplitDateTime()\n         self.assertEqual(\n             conditional_escape(w.render('test', datetime(2007, 12, 1, 9, 30))),\n             '<p class=\"datetime\">Date: <input value=\"2007-12-01\" type=\"text\" class=\"vDateField\" name=\"test_0\" size=\"10\" /><br />Time: <input value=\"09:30:00\" type=\"text\" class=\"vTimeField\" name=\"test_1\" size=\"8\" /></p>',\n         )\n \n     def test_localization(self):\n-        w = AdminSplitDateTime()\n+        w = widgets.AdminSplitDateTime()\n \n         with self.settings(USE_L10N=True):\n             with translation.override('de-at'):\n@@ -235,7 +232,7 @@ def test_render(self):\n             name='Hybrid Theory', cover_art=r'albums\\hybrid_theory.jpg'\n         )\n \n-        w = AdminFileWidget()\n+        w = widgets.AdminFileWidget()\n         self.assertEqual(\n             conditional_escape(w.render('test', album.cover_art)),\n             '<p class=\"file-upload\">Currently: <a href=\"%(STORAGE_URL)salbums/hybrid_theory.jpg\">albums\\hybrid_theory.jpg</a> <span class=\"clearable-file-input\"><input type=\"checkbox\" name=\"test-clear\" id=\"test-clear_id\" /> <label for=\"test-clear_id\">Clear</label></span><br />Change: <input type=\"file\" name=\"test\" /></p>' % { 'STORAGE_URL': default_storage.url('') },\n@@ -255,10 +252,10 @@ def test_render(self):\n         )\n         rel = models.Album._meta.get_field('band').rel\n \n-        w = ForeignKeyRawIdWidget(rel)\n+        w = widgets.ForeignKeyRawIdWidget(rel, widget_admin_site)\n         self.assertEqual(\n             conditional_escape(w.render('test', band.pk, attrs={})),\n-            '<input type=\"text\" name=\"test\" value=\"%(bandpk)s\" class=\"vForeignKeyRawIdAdminField\" /><a href=\"../../../admin_widgets/band/?t=id\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>&nbsp;<strong>Linkin Park</strong>' % dict(admin_media_prefix(), bandpk=band.pk),\n+            '<input type=\"text\" name=\"test\" value=\"%(bandpk)s\" class=\"vForeignKeyRawIdAdminField\" /><a href=\"/widget_admin/admin_widgets/band/?t=id\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>&nbsp;<strong>Linkin Park</strong>' % dict(admin_media_prefix(), bandpk=band.pk)\n         )\n \n     def test_relations_to_non_primary_key(self):\n@@ -270,17 +267,42 @@ def test_relations_to_non_primary_key(self):\n             barcode=87, name='Core', parent=apple\n         )\n         rel = models.Inventory._meta.get_field('parent').rel\n-        w = ForeignKeyRawIdWidget(rel)\n+        w = widgets.ForeignKeyRawIdWidget(rel, widget_admin_site)\n         self.assertEqual(\n             w.render('test', core.parent_id, attrs={}),\n-            '<input type=\"text\" name=\"test\" value=\"86\" class=\"vForeignKeyRawIdAdminField\" /><a href=\"../../../admin_widgets/inventory/?t=barcode\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>&nbsp;<strong>Apple</strong>' % admin_media_prefix(),\n+            '<input type=\"text\" name=\"test\" value=\"86\" class=\"vForeignKeyRawIdAdminField\" /><a href=\"/widget_admin/admin_widgets/inventory/?t=barcode\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>&nbsp;<strong>Apple</strong>' % admin_media_prefix()\n         )\n \n+    def test_fk_related_model_not_in_admin(self):\n+        # FK to a model not registered with admin site. Raw ID widget shoud\n+        # have no magnifying glass link. See #16542\n+        big_honeycomb = models.Honeycomb.objects.create(location='Old tree')\n+        big_honeycomb.bee_set.create()\n+        rel = models.Bee._meta.get_field('honeycomb').rel\n+\n+        w = widgets.ForeignKeyRawIdWidget(rel, widget_admin_site)\n+        self.assertEqual(\n+            conditional_escape(w.render('honeycomb_widget', big_honeycomb.pk, attrs={})),\n+            '<input type=\"text\" name=\"honeycomb_widget\" value=\"%(hcombpk)s\" />&nbsp;<strong>Honeycomb object</strong>' % {'hcombpk': big_honeycomb.pk}\n+        )\n+\n+    def test_fk_to_self_model_not_in_admin(self):\n+        # FK to self, not registered with admin site. Raw ID widget shoud have\n+        # no magnifying glass link. See #16542\n+        subject1 = models.Individual.objects.create(name='Subject #1')\n+        models.Individual.objects.create(name='Child', parent=subject1)\n+        rel = models.Individual._meta.get_field('parent').rel\n+\n+        w = widgets.ForeignKeyRawIdWidget(rel, widget_admin_site)\n+        self.assertEqual(\n+            conditional_escape(w.render('individual_widget', subject1.pk, attrs={})),\n+            '<input type=\"text\" name=\"individual_widget\" value=\"%(subj1pk)s\" />&nbsp;<strong>Individual object</strong>' % {'subj1pk': subject1.pk}\n+        )\n \n     def test_proper_manager_for_label_lookup(self):\n         # see #9258\n         rel = models.Inventory._meta.get_field('parent').rel\n-        w = ForeignKeyRawIdWidget(rel)\n+        w = widgets.ForeignKeyRawIdWidget(rel, widget_admin_site)\n \n         hidden = models.Inventory.objects.create(\n             barcode=93, name='Hidden', hidden=True\n@@ -290,31 +312,28 @@ def test_proper_manager_for_label_lookup(self):\n         )\n         self.assertEqual(\n             w.render('test', child_of_hidden.parent_id, attrs={}),\n-            '<input type=\"text\" name=\"test\" value=\"93\" class=\"vForeignKeyRawIdAdminField\" /><a href=\"../../../admin_widgets/inventory/?t=barcode\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>&nbsp;<strong>Hidden</strong>' % admin_media_prefix(),\n+            '<input type=\"text\" name=\"test\" value=\"93\" class=\"vForeignKeyRawIdAdminField\" /><a href=\"/widget_admin/admin_widgets/inventory/?t=barcode\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>&nbsp;<strong>Hidden</strong>' % admin_media_prefix()\n         )\n \n \n class ManyToManyRawIdWidgetTest(DjangoTestCase):\n     def test_render(self):\n         band = models.Band.objects.create(name='Linkin Park')\n-        band.album_set.create(\n-            name='Hybrid Theory', cover_art=r'albums\\hybrid_theory.jpg'\n-        )\n \n         m1 = models.Member.objects.create(name='Chester')\n         m2 = models.Member.objects.create(name='Mike')\n         band.members.add(m1, m2)\n         rel = models.Band._meta.get_field('members').rel\n \n-        w = ManyToManyRawIdWidget(rel)\n+        w = widgets.ManyToManyRawIdWidget(rel, widget_admin_site)\n         self.assertEqual(\n             conditional_escape(w.render('test', [m1.pk, m2.pk], attrs={})),\n-            '<input type=\"text\" name=\"test\" value=\"%(m1pk)s,%(m2pk)s\" class=\"vManyToManyRawIdAdminField\" /><a href=\"../../../admin_widgets/member/\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>' % dict(admin_media_prefix(), m1pk=m1.pk, m2pk=m2.pk),\n+            '<input type=\"text\" name=\"test\" value=\"%(m1pk)s,%(m2pk)s\" class=\"vManyToManyRawIdAdminField\" /><a href=\"/widget_admin/admin_widgets/member/\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"/static/admin/img/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>' % dict(admin_media_prefix(), m1pk=m1.pk, m2pk=m2.pk)\n         )\n \n         self.assertEqual(\n             conditional_escape(w.render('test', [m1.pk])),\n-            '<input type=\"text\" name=\"test\" value=\"%(m1pk)s\" class=\"vManyToManyRawIdAdminField\" /><a href=\"../../../admin_widgets/member/\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>' % dict(admin_media_prefix(), m1pk=m1.pk, m2pk=m2.pk),\n+            '<input type=\"text\" name=\"test\" value=\"%(m1pk)s\" class=\"vManyToManyRawIdAdminField\" /><a href=\"/widget_admin/admin_widgets/member/\" class=\"related-lookup\" id=\"lookup_id_test\" onclick=\"return showRelatedObjectLookupPopup(this);\"> <img src=\"%(ADMIN_MEDIA_PREFIX)simg/selector-search.gif\" width=\"16\" height=\"16\" alt=\"Lookup\" /></a>' % dict(admin_media_prefix(), m1pk=m1.pk)\n         )\n \n         self.assertEqual(w._has_changed(None, None), False)\n@@ -324,10 +343,31 @@ def test_render(self):\n         self.assertEqual(w._has_changed([1, 2], [u'1']), True)\n         self.assertEqual(w._has_changed([1, 2], [u'1', u'3']), True)\n \n+    def test_m2m_related_model_not_in_admin(self):\n+        # M2M relationship with model not registered with admin site. Raw ID\n+        # widget shoud have no magnifying glass link. See #16542\n+        consultor1 = models.Advisor.objects.create(name='Rockstar Techie')\n+\n+        c1 = models.Company.objects.create(name='Doodle')\n+        c2 = models.Company.objects.create(name='Pear')\n+        consultor1.companies.add(c1, c2)\n+        rel = models.Advisor._meta.get_field('companies').rel\n+\n+        w = widgets.ManyToManyRawIdWidget(rel, widget_admin_site)\n+        self.assertEqual(\n+            conditional_escape(w.render('company_widget1', [c1.pk, c2.pk], attrs={})),\n+            '<input type=\"text\" name=\"company_widget1\" value=\"%(c1pk)s,%(c2pk)s\" />' % {'c1pk': c1.pk, 'c2pk': c2.pk}\n+        )\n+\n+        self.assertEqual(\n+            conditional_escape(w.render('company_widget2', [c1.pk])),\n+            '<input type=\"text\" name=\"company_widget2\" value=\"%(c1pk)s\" />' % {'c1pk': c1.pk}\n+        )\n+\n class RelatedFieldWidgetWrapperTests(DjangoTestCase):\n     def test_no_can_add_related(self):\n-        rel = models.Inventory._meta.get_field('parent').rel\n-        w = AdminRadioSelect()\n+        rel = models.Individual._meta.get_field('parent').rel\n+        w = widgets.AdminRadioSelect()\n         # Used to fail with a name error.\n-        w = RelatedFieldWidgetWrapper(w, rel, admin.site)\n+        w = widgets.RelatedFieldWidgetWrapper(w, rel, widget_admin_site)\n         self.assertFalse(w.can_add_related)"
        },
        {
            "sha": "ea738125fefb00595715a1b847e3fe3f638b3985",
            "filename": "tests/regressiontests/admin_widgets/widgetadmin.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/290d7d4d21692336aeb074917acbf9804275fbdd/tests%2Fregressiontests%2Fadmin_widgets%2Fwidgetadmin.py",
            "raw_url": "https://github.com/django/django/raw/290d7d4d21692336aeb074917acbf9804275fbdd/tests%2Fregressiontests%2Fadmin_widgets%2Fwidgetadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_widgets%2Fwidgetadmin.py?ref=290d7d4d21692336aeb074917acbf9804275fbdd",
            "patch": "@@ -27,4 +27,14 @@ class EventAdmin(admin.ModelAdmin):\n site.register(models.User)\n site.register(models.Car, CarAdmin)\n site.register(models.CarTire, CarTireAdmin)\n+\n+site.register(models.Member)\n+site.register(models.Band)\n site.register(models.Event, EventAdmin)\n+site.register(models.Album)\n+\n+site.register(models.Inventory)\n+\n+site.register(models.Bee)\n+\n+site.register(models.Advisor)"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 143,
        "deletions": 48
    }
}