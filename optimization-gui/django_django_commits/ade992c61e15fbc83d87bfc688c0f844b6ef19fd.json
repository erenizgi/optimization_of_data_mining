{
    "author": "mxsasha",
    "message": "Fixed #16302 -- Ensure contrib.comments is IPv6 capable\n\nChanged the ip_address field for Comment to GenericIPAddressField. Added\ninstructions to the release notes on how to update the schema of existing\ndatabases.",
    "sha": "ade992c61e15fbc83d87bfc688c0f844b6ef19fd",
    "files": [
        {
            "sha": "bc4d9324647fd288adb38f08d07b5d630d1741f7",
            "filename": "django/contrib/comments/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/ade992c61e15fbc83d87bfc688c0f844b6ef19fd/django%2Fcontrib%2Fcomments%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/ade992c61e15fbc83d87bfc688c0f844b6ef19fd/django%2Fcontrib%2Fcomments%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fmodels.py?ref=ade992c61e15fbc83d87bfc688c0f844b6ef19fd",
            "patch": "@@ -60,7 +60,7 @@ class Comment(BaseCommentAbstractModel):\n \n     # Metadata about the comment\n     submit_date = models.DateTimeField(_('date/time submitted'), default=None)\n-    ip_address = models.IPAddressField(_('IP address'), blank=True, null=True)\n+    ip_address = models.GenericIPAddressField(_('IP address'), unpack_ipv4=True, blank=True, null=True)\n     is_public = models.BooleanField(_('is public'), default=True,\n                     help_text=_('Uncheck this box to make the comment effectively ' \\\n                                 'disappear from the site.'))"
        },
        {
            "sha": "497a0349db46aab9b744a3c12ec755e736ebb2a8",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/ade992c61e15fbc83d87bfc688c0f844b6ef19fd/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/ade992c61e15fbc83d87bfc688c0f844b6ef19fd/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=ade992c61e15fbc83d87bfc688c0f844b6ef19fd",
            "patch": "@@ -149,6 +149,30 @@ Backwards incompatible changes in 1.6\n     {{ title }}{# Translators: Extracted and associated with 'Welcome' below #}\n     <h1>{% trans \"Welcome\" %}</h1>\n \n+* The :doc:`comments </ref/contrib/comments/index>` app now uses a ``GenericIPAddressField``\n+  for storing commenters' IP addresses, to support comments submitted from IPv6 addresses.\n+  Until now, it stored them in an ``IPAddressField``, which is only meant to support IPv4.\n+  When saving a comment made from an IPv6 address, the address would be silently truncated\n+  on MySQL databases, and raise an exception on Oracle.\n+  You will need to change the column type in your database to benefit from this change.\n+\n+  For MySQL, execute this query on your project's database:\n+\n+  .. code-block:: sql\n+\n+    ALTER TABLE django_comments MODIFY ip_address VARCHAR(39);\n+\n+  For Oracle, execute this query:\n+\n+  .. code-block:: sql\n+\n+    ALTER TABLE DJANGO_COMMENTS MODIFY (ip_address VARCHAR2(39));\n+\n+  If you do not apply this change, the behaviour is unchanged: on MySQL, IPv6 addresses\n+  are silently truncated; on Oracle, an exception is generated. No database\n+  change is needed for SQLite or PostgreSQL databases.\n+\n+\n .. warning::\n \n     In addition to the changes outlined in this section, be sure to review the"
        },
        {
            "sha": "0d994d3af8bdf4db71b59a7135fe1be845a6689b",
            "filename": "tests/regressiontests/comment_tests/tests/comment_view_tests.py",
            "status": "modified",
            "additions": 32,
            "deletions": 2,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/ade992c61e15fbc83d87bfc688c0f844b6ef19fd/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fcomment_view_tests.py",
            "raw_url": "https://github.com/django/django/raw/ade992c61e15fbc83d87bfc688c0f844b6ef19fd/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fcomment_view_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fcomment_view_tests.py?ref=ade992c61e15fbc83d87bfc688c0f844b6ef19fd",
            "patch": "@@ -101,13 +101,43 @@ def testDebugCommentErrors(self):\n         settings.DEBUG = olddebug\n \n     def testCreateValidComment(self):\n+        address = \"1.2.3.4\"\n         a = Article.objects.get(pk=1)\n         data = self.getValidData(a)\n-        self.response = self.client.post(\"/post/\", data, REMOTE_ADDR=\"1.2.3.4\")\n+        self.response = self.client.post(\"/post/\", data, REMOTE_ADDR=address)\n         self.assertEqual(self.response.status_code, 302)\n         self.assertEqual(Comment.objects.count(), 1)\n         c = Comment.objects.all()[0]\n-        self.assertEqual(c.ip_address, \"1.2.3.4\")\n+        self.assertEqual(c.ip_address, address)\n+        self.assertEqual(c.comment, \"This is my comment\")\n+\n+    def testCreateValidCommentIPv6(self):\n+        \"\"\"\n+        Test creating a valid comment with a long IPv6 address.\n+        Note that this test should fail when Comment.ip_address is an IPAddress instead of a GenericIPAddress,\n+        but does not do so on SQLite or PostgreSQL, because they use the TEXT and INET types, which already\n+        allow storing an IPv6 address internally.\n+        \"\"\"\n+        address = \"2a02::223:6cff:fe8a:2e8a\"\n+        a = Article.objects.get(pk=1)\n+        data = self.getValidData(a)\n+        self.response = self.client.post(\"/post/\", data, REMOTE_ADDR=address)\n+        self.assertEqual(self.response.status_code, 302)\n+        self.assertEqual(Comment.objects.count(), 1)\n+        c = Comment.objects.all()[0]\n+        self.assertEqual(c.ip_address, address)\n+        self.assertEqual(c.comment, \"This is my comment\")\n+\n+    def testCreateValidCommentIPv6Unpack(self):\n+        address = \"::ffff:18.52.18.52\"\n+        a = Article.objects.get(pk=1)\n+        data = self.getValidData(a)\n+        self.response = self.client.post(\"/post/\", data, REMOTE_ADDR=address)\n+        self.assertEqual(self.response.status_code, 302)\n+        self.assertEqual(Comment.objects.count(), 1)\n+        c = Comment.objects.all()[0]\n+        # We trim the '::ffff:' bit off because it is an IPv4 addr\n+        self.assertEqual(c.ip_address, address[7:])\n         self.assertEqual(c.comment, \"This is my comment\")\n \n     def testPostAsAuthenticatedUser(self):"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 57,
        "deletions": 3
    }
}