{
    "author": "aaugustin",
    "message": "Fixed #12972 -- Validated that flatpages URLs start and (when appropriate) end with a slash. Thanks jabapyth, claudep and kmtracey.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17402 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6b16580aaa7aa3453a874802e14eaf17db745c46",
    "files": [
        {
            "sha": "8ffae833e5cc4fd9b43c85993f33db85c061871a",
            "filename": "django/contrib/flatpages/forms.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/6b16580aaa7aa3453a874802e14eaf17db745c46/django%2Fcontrib%2Fflatpages%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/6b16580aaa7aa3453a874802e14eaf17db745c46/django%2Fcontrib%2Fflatpages%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Fforms.py?ref=6b16580aaa7aa3453a874802e14eaf17db745c46",
            "patch": "@@ -1,6 +1,7 @@\n from django import forms\n-from django.utils.translation import ugettext_lazy as _\n+from django.conf import settings\n from django.contrib.flatpages.models import FlatPage\n+from django.utils.translation import ugettext, ugettext_lazy as _\n \n class FlatpageForm(forms.ModelForm):\n     url = forms.RegexField(label=_(\"URL\"), max_length=100, regex=r'^[-\\w/\\.~]+$',\n@@ -12,6 +13,16 @@ class FlatpageForm(forms.ModelForm):\n     class Meta:\n         model = FlatPage\n \n+    def clean_url(self):\n+        url = self.cleaned_data['url']\n+        if not url.startswith('/'):\n+            raise forms.ValidationError(ugettext(\"URL is missing a leading slash.\"))\n+        if (settings.APPEND_SLASH and\n+            'django.middleware.common.CommonMiddleware' in settings.MIDDLEWARE_CLASSES and\n+            not url.endswith('/')):\n+            raise forms.ValidationError(ugettext(\"URL is missing a trailing slash.\"))\n+        return url\n+\n     def clean(self):\n         url = self.cleaned_data.get('url', None)\n         sites = self.cleaned_data.get('sites', None)"
        },
        {
            "sha": "884c40acc80169931d0880fd315ce7aa932ab7f1",
            "filename": "django/contrib/flatpages/tests/forms.py",
            "status": "modified",
            "additions": 26,
            "deletions": 4,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/6b16580aaa7aa3453a874802e14eaf17db745c46/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/6b16580aaa7aa3453a874802e14eaf17db745c46/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py?ref=6b16580aaa7aa3453a874802e14eaf17db745c46",
            "patch": "@@ -2,6 +2,8 @@\n from django.contrib.flatpages.forms import FlatpageForm\n from django.contrib.flatpages.models import FlatPage\n from django.test import TestCase\n+from django.test.utils import override_settings\n+from django.utils import translation\n \n class FlatpageAdminFormTests(TestCase):\n     def setUp(self):\n@@ -23,9 +25,29 @@ def test_flatpage_admin_form_url_validation(self):\n         self.assertFalse(FlatpageForm(data=dict(url='/a & char/', **self.form_data)).is_valid())\n         self.assertFalse(FlatpageForm(data=dict(url='/a ? char/', **self.form_data)).is_valid())\n \n+    def test_flatpage_requires_leading_slash(self):\n+        form = FlatpageForm(data=dict(url='no_leading_slash/', **self.form_data))\n+        with translation.override('en'):\n+            self.assertFalse(form.is_valid())\n+            self.assertEqual(form.errors['url'], [\"URL is missing a leading slash.\"])\n+\n+    @override_settings(APPEND_SLASH=True,\n+            MIDDLEWARE_CLASSES=('django.middleware.common.CommonMiddleware',))\n+    def test_flatpage_requires_trailing_slash_with_append_slash(self):\n+        form = FlatpageForm(data=dict(url='/no_trailing_slash', **self.form_data))\n+        with translation.override('en'):\n+            self.assertFalse(form.is_valid())\n+            self.assertEqual(form.errors['url'], [\"URL is missing a trailing slash.\"])\n+\n+    @override_settings(APPEND_SLASH=False,\n+            MIDDLEWARE_CLASSES=('django.middleware.common.CommonMiddleware',))\n+    def test_flatpage_doesnt_requires_trailing_slash_without_append_slash(self):\n+        form = FlatpageForm(data=dict(url='/no_trailing_slash', **self.form_data))\n+        self.assertTrue(form.is_valid())\n+\n     def test_flatpage_admin_form_url_uniqueness_validation(self):\n         \"The flatpage admin form correctly enforces url uniqueness among flatpages of the same site\"\n-        data = dict(url='/myflatpage1', **self.form_data)\n+        data = dict(url='/myflatpage1/', **self.form_data)\n \n         FlatpageForm(data=data).save()\n \n@@ -35,7 +57,7 @@ def test_flatpage_admin_form_url_uniqueness_validation(self):\n \n         self.assertEqual(\n             f.errors,\n-            {'__all__': [u'Flatpage with url /myflatpage1 already exists for site example.com']})\n+            {'__all__': [u'Flatpage with url /myflatpage1/ already exists for site example.com']})\n \n     def test_flatpage_admin_form_edit(self):\n         \"\"\"\n@@ -44,10 +66,10 @@ def test_flatpage_admin_form_edit(self):\n \n         \"\"\"\n         existing = FlatPage.objects.create(\n-            url=\"/myflatpage1\", title=\"Some page\", content=\"The content\")\n+            url=\"/myflatpage1/\", title=\"Some page\", content=\"The content\")\n         existing.sites.add(settings.SITE_ID)\n \n-        data = dict(url='/myflatpage1', **self.form_data)\n+        data = dict(url='/myflatpage1/', **self.form_data)\n \n         f = FlatpageForm(data=data, instance=existing)\n "
        }
    ],
    "stats": {
        "total": 43,
        "additions": 38,
        "deletions": 5
    }
}