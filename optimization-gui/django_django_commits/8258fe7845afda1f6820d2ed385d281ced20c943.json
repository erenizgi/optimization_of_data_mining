{
    "author": "jezdez",
    "message": "Fixed #16042 -- Use the content types caching in the comments contrib app. Thanks, ptone, Julien Phalip and Thejaswi Puthraya.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16737 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8258fe7845afda1f6820d2ed385d281ced20c943",
    "files": [
        {
            "sha": "ce1825e52939c096846b2ab7f0f90c65341245d4",
            "filename": "django/contrib/comments/templatetags/comments.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/8258fe7845afda1f6820d2ed385d281ced20c943/django%2Fcontrib%2Fcomments%2Ftemplatetags%2Fcomments.py",
            "raw_url": "https://github.com/django/django/raw/8258fe7845afda1f6820d2ed385d281ced20c943/django%2Fcontrib%2Fcomments%2Ftemplatetags%2Fcomments.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Ftemplatetags%2Fcomments.py?ref=8258fe7845afda1f6820d2ed385d281ced20c943",
            "patch": "@@ -47,7 +47,7 @@ def handle_token(cls, parser, token):\n     def lookup_content_type(token, tagname):\n         try:\n             app, model = token.split('.')\n-            return ContentType.objects.get(app_label=app, model=model)\n+            return ContentType.objects.get_by_natural_key(app, model)\n         except ValueError:\n             raise template.TemplateSyntaxError(\"Third argument in %r must be in the format 'app.model'\" % tagname)\n         except ContentType.DoesNotExist:"
        },
        {
            "sha": "99c3ca37fa3185766008c4fc02e7aecafb51b610",
            "filename": "tests/regressiontests/comment_tests/tests/templatetag_tests.py",
            "status": "modified",
            "additions": 83,
            "deletions": 9,
            "changes": 92,
            "blob_url": "https://github.com/django/django/blob/8258fe7845afda1f6820d2ed385d281ced20c943/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "raw_url": "https://github.com/django/django/raw/8258fe7845afda1f6820d2ed385d281ced20c943/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py?ref=8258fe7845afda1f6820d2ed385d281ced20c943",
            "patch": "@@ -1,4 +1,7 @@\n+from __future__ import with_statement\n+\n from django.contrib.comments.forms import CommentForm\n+from django.contrib.comments.models import Comment\n from django.contrib.contenttypes.models import ContentType\n from django.template import Template, Context\n from regressiontests.comment_tests.models import Article, Author\n@@ -44,30 +47,41 @@ def test():\n             self.testRenderCommentFormFromObject()\n         self.assertNumQueries(1, test)\n \n-    def testGetCommentCount(self, tag=None):\n-        self.createSomeComments()\n+    def verifyGetCommentCount(self, tag=None):\n         t = \"{% load comments %}\" + (tag or \"{% get_comment_count for comment_tests.article a.id as cc %}\") + \"{{ cc }}\"\n         ctx, out = self.render(t, a=Article.objects.get(pk=1))\n         self.assertEqual(out, \"2\")\n \n+    def testGetCommentCount(self):\n+        self.createSomeComments()\n+        self.verifyGetCommentCount(\"{% get_comment_count for comment_tests.article a.id as cc %}\")\n+\n     def testGetCommentCountFromLiteral(self):\n-        self.testGetCommentCount(\"{% get_comment_count for comment_tests.article 1 as cc %}\")\n+        self.createSomeComments()\n+        self.verifyGetCommentCount(\"{% get_comment_count for comment_tests.article 1 as cc %}\")\n \n     def testGetCommentCountFromObject(self):\n-        self.testGetCommentCount(\"{% get_comment_count for a as cc %}\")\n+        self.createSomeComments()\n+        self.verifyGetCommentCount(\"{% get_comment_count for a as cc %}\")\n \n-    def testGetCommentList(self, tag=None):\n-        c1, c2, c3, c4 = self.createSomeComments()\n-        t = \"{% load comments %}\" + (tag or \"{% get_comment_list for comment_tests.author a.id as cl %}\")\n+    def verifyGetCommentList(self, tag=None):\n+        c1, c2, c3, c4 = Comment.objects.all()[:4]\n+        t = \"{% load comments %}\" +  (tag or \"{% get_comment_list for comment_tests.author a.id as cl %}\")\n         ctx, out = self.render(t, a=Author.objects.get(pk=1))\n         self.assertEqual(out, \"\")\n         self.assertEqual(list(ctx[\"cl\"]), [c2])\n \n+    def testGetCommentList(self):\n+        self.createSomeComments()\n+        self.verifyGetCommentList(\"{% get_comment_list for comment_tests.author a.id as cl %}\")\n+\n     def testGetCommentListFromLiteral(self):\n-        self.testGetCommentList(\"{% get_comment_list for comment_tests.author 1 as cl %}\")\n+        self.createSomeComments()\n+        self.verifyGetCommentList(\"{% get_comment_list for comment_tests.author 1 as cl %}\")\n \n     def testGetCommentListFromObject(self):\n-        self.testGetCommentList(\"{% get_comment_list for a as cl %}\")\n+        self.createSomeComments()\n+        self.verifyGetCommentList(\"{% get_comment_list for a as cl %}\")\n \n     def testGetCommentPermalink(self):\n         c1, c2, c3, c4 = self.createSomeComments()\n@@ -99,3 +113,63 @@ def testRenderCommentListFromLiteral(self):\n     def testRenderCommentListFromObject(self):\n         self.testRenderCommentList(\"{% render_comment_list for a %}\")\n \n+    def testNumberQueries(self):\n+        \"\"\"\n+        Ensure that the template tags use cached content types to reduce the\n+        number of DB queries.\n+        Refs #16042.\n+        \"\"\"\n+\n+        self.createSomeComments()\n+\n+        # {% render_comment_list %} -----------------\n+\n+        # Clear CT cache\n+        ContentType.objects.clear_cache()\n+        with self.assertNumQueries(4):\n+            self.testRenderCommentListFromObject()\n+\n+        # Force the CT to be cached\n+        ct = ContentType.objects.get_for_model(Article)\n+        with self.assertNumQueries(3):\n+            self.testRenderCommentListFromObject()\n+\n+        # {% get_comment_list %} --------------------\n+\n+        ContentType.objects.clear_cache()\n+        with self.assertNumQueries(4):\n+            self.verifyGetCommentList()\n+\n+        ct = ContentType.objects.get_for_model(Author)\n+        with self.assertNumQueries(3):\n+            self.verifyGetCommentList()\n+\n+        # {% render_comment_form %} -----------------\n+\n+        ContentType.objects.clear_cache()\n+        with self.assertNumQueries(3):\n+            self.testRenderCommentForm()\n+\n+        ct = ContentType.objects.get_for_model(Article)\n+        with self.assertNumQueries(2):\n+            self.testRenderCommentForm()\n+\n+        # {% get_comment_form %} --------------------\n+\n+        ContentType.objects.clear_cache()\n+        with self.assertNumQueries(3):\n+            self.testGetCommentForm()\n+\n+        ct = ContentType.objects.get_for_model(Article)\n+        with self.assertNumQueries(2):\n+            self.testGetCommentForm()\n+\n+        # {% get_comment_count %} -------------------\n+\n+        ContentType.objects.clear_cache()\n+        with self.assertNumQueries(3):\n+            self.verifyGetCommentCount()\n+\n+        ct = ContentType.objects.get_for_model(Article)\n+        with self.assertNumQueries(2):\n+            self.verifyGetCommentCount()"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 84,
        "deletions": 10
    }
}