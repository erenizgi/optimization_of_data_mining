{
    "author": "jezdez",
    "message": "Fixed the relative static file resolution of the CachedStaticFilesStorage backend and the post processing of deeply nested static files.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16862 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5",
    "files": [
        {
            "sha": "cf0c4a0e3a9846454dd80be174add950407cfa0f",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5",
            "patch": "@@ -113,13 +113,22 @@ def converter(matchobj):\n                 return matched\n             name_parts = name.split('/')\n             # Using posix normpath here to remove duplicates\n-            result = url_parts = posixpath.normpath(url).split('/')\n-            level = url.count('..')\n-            if level:\n-                result = name_parts[:-level - 1] + url_parts[level:]\n-            elif name_parts[:-1]:\n-                result = name_parts[:-1] + url_parts[-1:]\n-            joined_result = '/'.join(result)\n+            url = posixpath.normpath(url)\n+            url_parts = url.split('/')\n+            parent_level, sub_level = url.count('..'), url.count('/')\n+            if url.startswith('/'):\n+                sub_level -= 1\n+                url_parts = url_parts[1:]\n+            if parent_level or not url.startswith('/'):\n+                start, end = parent_level + 1, parent_level\n+            else:\n+                if sub_level:\n+                    if sub_level == 1:\n+                        parent_level -= 1\n+                    start, end = parent_level, sub_level - 1\n+                else:\n+                    start, end = 1, sub_level - 1\n+            joined_result = '/'.join(name_parts[:-start] + url_parts[end:])\n             hashed_url = self.url(joined_result, force=True)\n             # Return the hashed and normalized version to the file\n             return 'url(\"%s\")' % hashed_url"
        },
        {
            "sha": "ba48325c0a580d4480cb9f76713d5ec9b2c3756a",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/css/img/window.png",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Fimg%2Fwindow.png",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Fimg%2Fwindow.png",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Fimg%2Fwindow.png?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5"
        },
        {
            "sha": "9fea4e8a5e96dfd03d8fee5315c2c5d810a1c5a4",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/css/window.css",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Fwindow.css",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Fwindow.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Fwindow.css?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5",
            "patch": "@@ -0,0 +1,3 @@\n+body {\n+    background: #d3d6d8 url(\"img/window.png\");\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "ba48325c0a580d4480cb9f76713d5ec9b2c3756a",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/img/relative.png",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fimg%2Frelative.png",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fimg%2Frelative.png",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fimg%2Frelative.png?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5"
        },
        {
            "sha": "afa658dbebd2ac8383ed878ca7f7e99a64b05089",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/relative.css",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Frelative.css?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5",
            "patch": "@@ -1,2 +1,5 @@\n @import url(\"../cached/styles.css\");\n-@import url(\"absolute.css\");\n\\ No newline at end of file\n+@import url(\"absolute.css\");\n+body {\n+    background: #d3d6d8 url(img/relative.png);\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "ca28fc35cd737a9d0d2299559d8949ae722dd7e0",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/styles.css",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fstyles.css",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fstyles.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fstyles.css?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5",
            "patch": "@@ -1 +1 @@\n-@import url(\"cached/other.css\");\n\\ No newline at end of file\n+@import url(\"other.css\");\n\\ No newline at end of file"
        },
        {
            "sha": "8a179141b9ef4d513a24d088f94561e068a9824d",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=eb5df8e98db5c5592d5f0a0ca4680f9368ed0db5",
            "patch": "@@ -300,11 +300,11 @@ def test_template_tag_return(self):\n             \"\"\", \"/static/test/file.dad0999e4f8f.txt\")\n         self.assertTemplateRenders(\"\"\"\n             {% load static from staticfiles %}{% static \"cached/styles.css\" %}\n-            \"\"\", \"/static/cached/styles.5653c259030b.css\")\n+            \"\"\", \"/static/cached/styles.93b1147e8552.css\")\n \n     def test_template_tag_simple_content(self):\n         relpath = self.cached_file_path(\"cached/styles.css\")\n-        self.assertEqual(relpath, \"cached/styles.5653c259030b.css\")\n+        self.assertEqual(relpath, \"cached/styles.93b1147e8552.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n             self.assertFalse(\"cached/other.css\" in content, content)\n@@ -316,24 +316,34 @@ def test_template_tag_absolute(self):\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n             self.assertFalse(\"/static/cached/styles.css\" in content)\n-            self.assertTrue(\"/static/cached/styles.5653c259030b.css\" in content)\n+            self.assertTrue(\"/static/cached/styles.93b1147e8552.css\" in content)\n \n     def test_template_tag_denorm(self):\n         relpath = self.cached_file_path(\"cached/denorm.css\")\n         self.assertEqual(relpath, \"cached/denorm.363de96e9b4b.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n             self.assertFalse(\"..//cached///styles.css\" in content)\n-            self.assertTrue(\"/static/cached/styles.5653c259030b.css\" in content)\n+            self.assertTrue(\"/static/cached/styles.93b1147e8552.css\" in content)\n \n     def test_template_tag_relative(self):\n         relpath = self.cached_file_path(\"cached/relative.css\")\n-        self.assertEqual(relpath, \"cached/relative.298ff891a8d4.css\")\n+        self.assertEqual(relpath, \"cached/relative.8dffb45d91f5.css\")\n         with storage.staticfiles_storage.open(relpath) as relfile:\n             content = relfile.read()\n             self.assertFalse(\"../cached/styles.css\" in content)\n             self.assertFalse('@import \"styles.css\"' in content)\n-            self.assertTrue(\"/static/cached/styles.5653c259030b.css\" in content)\n+            self.assertTrue(\"/static/cached/styles.93b1147e8552.css\" in content)\n+            self.assertFalse(\"url(img/relative.png)\" in content)\n+            self.assertTrue(\"/static/cached/img/relative.acae32e4532b.png\" in content)\n+\n+    def test_template_tag_deep_relative(self):\n+        relpath = self.cached_file_path(\"cached/css/window.css\")\n+        self.assertEqual(relpath, \"cached/css/window.9db38d5169f3.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertFalse('url(img/window.png)' in content)\n+            self.assertTrue('url(\"/static/cached/css/img/window.acae32e4532b.png\")' in content)\n \n     def test_template_tag_url(self):\n         relpath = self.cached_file_path(\"cached/url.css\")"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 40,
        "deletions": 15
    }
}