{
    "author": "jezdez",
    "message": "Fixed #16332 -- Added language template tag that switches the activate language for the enclosed template section, e.g. to allow translation of URLs as added in r16405. Many thanks to Florian Apolloner and Orne Brocaar.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16501 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "286a1cad8839da3219dc3901540fb9422686e5ab",
    "files": [
        {
            "sha": "edb297404a63cfb182b42c754db697eff253d3ff",
            "filename": "django/templatetags/i18n.py",
            "status": "modified",
            "additions": 46,
            "deletions": 7,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/286a1cad8839da3219dc3901540fb9422686e5ab/django%2Ftemplatetags%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/286a1cad8839da3219dc3901540fb9422686e5ab/django%2Ftemplatetags%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fi18n.py?ref=286a1cad8839da3219dc3901540fb9422686e5ab",
            "patch": "@@ -1,15 +1,16 @@\n+from __future__ import with_statement\n import re\n \n-from django.template import Node, Variable, VariableNode\n-from django.template import TemplateSyntaxError, TokenParser, Library\n-from django.template import TOKEN_TEXT, TOKEN_VAR\n+from django.template import (Node, Variable, TemplateSyntaxError,\n+    TokenParser, Library, TOKEN_TEXT, TOKEN_VAR)\n from django.template.base import _render_value_in_context\n-from django.utils import translation\n-from django.utils.encoding import force_unicode\n from django.template.defaulttags import token_kwargs\n+from django.utils import translation\n+\n \n register = Library()\n \n+\n class GetAvailableLanguagesNode(Node):\n     def __init__(self, variable):\n         self.variable = variable\n@@ -19,6 +20,7 @@ def render(self, context):\n         context[self.variable] = [(k, translation.ugettext(v)) for k, v in settings.LANGUAGES]\n         return ''\n \n+\n class GetLanguageInfoNode(Node):\n     def __init__(self, lang_code, variable):\n         self.lang_code = Variable(lang_code)\n@@ -29,6 +31,7 @@ def render(self, context):\n         context[self.variable] = translation.get_language_info(lang_code)\n         return ''\n \n+\n class GetLanguageInfoListNode(Node):\n     def __init__(self, languages, variable):\n         self.languages = Variable(languages)\n@@ -47,6 +50,7 @@ def render(self, context):\n         context[self.variable] = [self.get_language_info(lang) for lang in langs]\n         return ''\n \n+\n class GetCurrentLanguageNode(Node):\n     def __init__(self, variable):\n         self.variable = variable\n@@ -55,6 +59,7 @@ def render(self, context):\n         context[self.variable] = translation.get_language()\n         return ''\n \n+\n class GetCurrentLanguageBidiNode(Node):\n     def __init__(self, variable):\n         self.variable = variable\n@@ -63,6 +68,7 @@ def render(self, context):\n         context[self.variable] = translation.get_language_bidi()\n         return ''\n \n+\n class TranslateNode(Node):\n     def __init__(self, filter_expression, noop):\n         self.noop = noop\n@@ -75,6 +81,7 @@ def render(self, context):\n         output = self.filter_expression.resolve(context)\n         return _render_value_in_context(output, context)\n \n+\n class BlockTranslateNode(Node):\n     def __init__(self, extra_context, singular, plural=None, countervar=None,\n             counter=None):\n@@ -117,6 +124,18 @@ def render(self, context):\n         context.pop()\n         return result % data\n \n+\n+class LanguageNode(Node):\n+    def __init__(self, nodelist, language):\n+        self.nodelist = nodelist\n+        self.language = language\n+\n+    def render(self, context):\n+        with translation.override(self.language.resolve(context)):\n+            output = self.nodelist.render(context)\n+        return output\n+\n+\n @register.tag(\"get_available_languages\")\n def do_get_available_languages(parser, token):\n     \"\"\"\n@@ -271,9 +290,9 @@ def top(self):\n             # where single quote use is supported.\n             if value[0] == \"'\":\n                 pos = None\n-                m = re.match(\"^'([^']+)'(\\|.*$)\",value)\n+                m = re.match(\"^'([^']+)'(\\|.*$)\", value)\n                 if m:\n-                    value = '\"%s\"%s' % (m.group(1).replace('\"','\\\\\"'),m.group(2))\n+                    value = '\"%s\"%s' % (m.group(1).replace('\"','\\\\\"'), m.group(2))\n                 elif value[-1] == \"'\":\n                     value = '\"%s\"' % value[1:-1].replace('\"','\\\\\"')\n \n@@ -366,3 +385,23 @@ def do_block_translate(parser, token):\n \n     return BlockTranslateNode(extra_context, singular, plural, countervar,\n             counter)\n+\n+@register.tag\n+def language(parser, token):\n+    \"\"\"\n+    This will enable the given language just for this block.\n+\n+    Usage::\n+\n+        {% language \"de\" %}\n+            This is {{ bar }} and {{ boo }}.\n+        {% endlanguage %}\n+\n+    \"\"\"\n+    bits = token.split_contents()\n+    if len(bits) < 2:\n+        raise TemplateSyntaxError(\"'%s' takes one argument (language)\" % bits[0])\n+    language = parser.compile_filter(bits[1])\n+    nodelist = parser.parse(('endlanguage',))\n+    parser.delete_first_token()\n+    return LanguageNode(nodelist, language)"
        },
        {
            "sha": "f06dbe1506c3ff6546508817e93cbeef201e5b24",
            "filename": "docs/topics/http/urls.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/286a1cad8839da3219dc3901540fb9422686e5ab/docs%2Ftopics%2Fhttp%2Furls.txt",
            "raw_url": "https://github.com/django/django/raw/286a1cad8839da3219dc3901540fb9422686e5ab/docs%2Ftopics%2Fhttp%2Furls.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fhttp%2Furls.txt?ref=286a1cad8839da3219dc3901540fb9422686e5ab",
            "patch": "@@ -28,6 +28,12 @@ This mapping can be as short or as long as needed. It can reference other\n mappings. And, because it's pure Python code, it can be constructed\n dynamically.\n \n+.. versionadded:: 1.4\n+\n+    Django also allows to translate URLs according to the active language.\n+    This process is described in the\n+    :ref:`internationalization docs <url-internationalization>`.\n+\n .. _how-django-processes-a-request:\n \n How Django processes a request"
        },
        {
            "sha": "5e9c1cd3b069402e482f52821193dadfda361650",
            "filename": "docs/topics/i18n/internationalization.txt",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/286a1cad8839da3219dc3901540fb9422686e5ab/docs%2Ftopics%2Fi18n%2Finternationalization.txt",
            "raw_url": "https://github.com/django/django/raw/286a1cad8839da3219dc3901540fb9422686e5ab/docs%2Ftopics%2Fi18n%2Finternationalization.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Finternationalization.txt?ref=286a1cad8839da3219dc3901540fb9422686e5ab",
            "patch": "@@ -887,6 +887,32 @@ return the URL in the active language. Example::\n     that a carelessly translated URL causes a collision with a non-translated\n     URL pattern.\n \n+.. _reversing_in_templates:\n+\n+.. templatetag:: language\n+\n+Reversing in templates\n+----------------------\n+\n+If localized URLs get reversed in templates they always use the current\n+language. To link to a URL in another language use the ``language``\n+template tag. It enables the given language in the enclosed template section:\n+\n+.. code-block:: html+django\n+\n+    {% load i18n %}\n+\n+    {% get_available_languages as languages %}\n+\n+    {% trans \"View this category in:\" %}\n+    {% for lang_code, lang_name in languages %}\n+        {% language lang_code %}\n+        <a href=\"{% url category slug=category.slug %}\">{{ lang_name }}</a>\n+        {% endlanguage %}\n+    {% endfor %}\n+\n+The :ttag:`language` tag expects the language code as the only argument.\n+\n .. _set_language-redirect-view:\n \n The ``set_language`` redirect view"
        },
        {
            "sha": "724eb03e27fa99d46b8f6913de9a491b163584b0",
            "filename": "tests/regressiontests/i18n/patterns/tests.py",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/django/django/blob/286a1cad8839da3219dc3901540fb9422686e5ab/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/286a1cad8839da3219dc3901540fb9422686e5ab/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py?ref=286a1cad8839da3219dc3901540fb9422686e5ab",
            "patch": "@@ -6,6 +6,7 @@\n from django.core.urlresolvers import reverse, clear_url_caches\n from django.test import TestCase\n from django.test.utils import override_settings\n+from django.template import Template, Context\n from django.utils import translation\n \n \n@@ -241,3 +242,44 @@ def test_pt_br_url(self):\n         self.assertEqual(response.status_code, 200)\n         self.assertEqual(response['content-language'], 'pt-br')\n         self.assertEqual(response.context['LANGUAGE_CODE'], 'pt-br')\n+\n+\n+class URLTagTests(URLTestCaseBase):\n+    \"\"\"\n+    Test if the language tag works.\n+    \"\"\"\n+    def test_strings_only(self):\n+        t = Template(\"\"\"{% load i18n %}\n+            {% language 'nl' %}{% url no-prefix-translated %}{% endlanguage %}\n+            {% language 'pt-br' %}{% url no-prefix-translated %}{% endlanguage %}\"\"\")\n+        self.assertEqual(t.render(Context({})).strip().split(),\n+                         [u'/vertaald/', u'/traduzidos/'])\n+\n+    def test_context(self):\n+        ctx = Context({'lang1':'nl', 'lang2':'pt-br'})\n+        tpl = Template(\"\"\"{% load i18n %}\n+            {% language lang1 %}{% url no-prefix-translated %}{% endlanguage %}\n+            {% language lang2 %}{% url no-prefix-translated %}{% endlanguage %}\"\"\")\n+        self.assertEqual(tpl.render(ctx).strip().split(),\n+                         [u'/vertaald/', u'/traduzidos/'])\n+\n+    def test_args(self):\n+        tpl = Template(\"\"\"{% load i18n %}\n+            {% language 'nl' %}{% url no-prefix-translated-slug 'apo' %}{% endlanguage %}\n+            {% language 'pt-br' %}{% url no-prefix-translated-slug 'apo' %}{% endlanguage %}\"\"\")\n+        self.assertEqual(tpl.render(Context({})).strip().split(),\n+                         [u'/vertaald/apo/', u'/traduzidos/apo/'])\n+\n+    def test_kwargs(self):\n+        tpl = Template(\"\"\"{% load i18n %}\n+            {% language 'nl'  %}{% url no-prefix-translated-slug slug='apo' %}{% endlanguage %}\n+            {% language 'pt-br' %}{% url no-prefix-translated-slug slug='apo' %}{% endlanguage %}\"\"\")\n+        self.assertEqual(tpl.render(Context({})).strip().split(),\n+                         [u'/vertaald/apo/', u'/traduzidos/apo/'])\n+\n+    def test_future_kwargs(self):\n+        tpl = Template(\"\"\"{% load i18n %}{% load url from future %}\n+            {% language 'nl'  %}{% url 'no-prefix-translated-slug' slug='apo' %}{% endlanguage %}\n+            {% language 'pt-br' %}{% url 'no-prefix-translated-slug' slug='apo' %}{% endlanguage %}\"\"\")\n+        self.assertEqual(tpl.render(Context({})).strip().split(),\n+                         [u'/vertaald/apo/', u'/traduzidos/apo/'])"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 120,
        "deletions": 7
    }
}