{
    "author": "charettes",
    "message": "Made model fields comparable to other objects\n\nFixed #17851 -- Added __lt__ and @total_ordering to models.Field,\nmade sure these work correctly on other objects than Field, too.",
    "sha": "5cbfb48b92cb26a335f9c8c0f79d3390290103e2",
    "files": [
        {
            "sha": "f6949586924446467c34108d75331d7cefdf20ac",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/5cbfb48b92cb26a335f9c8c0f79d3390290103e2/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/5cbfb48b92cb26a335f9c8c0f79d3390290103e2/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=5cbfb48b92cb26a335f9c8c0f79d3390290103e2",
            "patch": "@@ -12,7 +12,7 @@\n from django.core import exceptions, validators\n from django.utils.datastructures import DictWrapper\n from django.utils.dateparse import parse_date, parse_datetime, parse_time\n-from django.utils.functional import curry\n+from django.utils.functional import curry, total_ordering\n from django.utils.text import capfirst\n from django.utils import timezone\n from django.utils.translation import ugettext_lazy as _\n@@ -45,6 +45,7 @@ class FieldDoesNotExist(Exception):\n #\n #     getattr(obj, opts.pk.attname)\n \n+@total_ordering\n class Field(object):\n     \"\"\"Base class for all field types\"\"\"\n \n@@ -118,9 +119,17 @@ def __init__(self, verbose_name=None, name=None, primary_key=False,\n         messages.update(error_messages or {})\n         self.error_messages = messages\n \n-    def __cmp__(self, other):\n+    def __eq__(self, other):\n+        # Needed for @total_ordering\n+        if isinstance(other, Field):\n+            return self.creation_counter == other.creation_counter\n+        return NotImplemented\n+\n+    def __lt__(self, other):\n         # This is needed because bisect does not take a comparison function.\n-        return cmp(self.creation_counter, other.creation_counter)\n+        if isinstance(other, Field):\n+            return self.creation_counter < other.creation_counter\n+        return NotImplemented\n \n     def __deepcopy__(self, memodict):\n         # We don't have to deepcopy very much here, since most things are not"
        },
        {
            "sha": "86bbed7a7b2ce7fe27956ded194258f7da3fd3ae",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/5cbfb48b92cb26a335f9c8c0f79d3390290103e2/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/5cbfb48b92cb26a335f9c8c0f79d3390290103e2/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=5cbfb48b92cb26a335f9c8c0f79d3390290103e2",
            "patch": "@@ -310,3 +310,35 @@ def partition(predicate, values):\n     for item in values:\n         results[predicate(item)].append(item)\n     return results\n+\n+try:\n+    from functools import total_ordering\n+except ImportError:\n+    # For Python < 2.7\n+    # Code borrowed from python 2.7.3 stdlib\n+    def total_ordering(cls):\n+        \"\"\"Class decorator that fills in missing ordering methods\"\"\"\n+        convert = {\n+            '__lt__': [('__gt__', lambda self, other: not (self < other or self == other)),\n+                       ('__le__', lambda self, other: self < other or self == other),\n+                       ('__ge__', lambda self, other: not self < other)],\n+            '__le__': [('__ge__', lambda self, other: not self <= other or self == other),\n+                       ('__lt__', lambda self, other: self <= other and not self == other),\n+                       ('__gt__', lambda self, other: not self <= other)],\n+            '__gt__': [('__lt__', lambda self, other: not (self > other or self == other)),\n+                       ('__ge__', lambda self, other: self > other or self == other),\n+                       ('__le__', lambda self, other: not self > other)],\n+            '__ge__': [('__le__', lambda self, other: (not self >= other) or self == other),\n+                       ('__gt__', lambda self, other: self >= other and not self == other),\n+                       ('__lt__', lambda self, other: not self >= other)]\n+        }\n+        roots = set(dir(cls)) & set(convert)\n+        if not roots:\n+            raise ValueError('must define at least one ordering operation: < > <= >=')\n+        root = max(roots)       # prefer __lt__ to __le__ to __gt__ to __ge__\n+        for opname, opfunc in convert[root]:\n+            if opname not in roots:\n+                opfunc.__name__ = opname\n+                opfunc.__doc__ = getattr(int, opname).__doc__\n+                setattr(cls, opname, opfunc)\n+        return cls"
        },
        {
            "sha": "84e20487c5a595ef105d9cb694b38ac2787cb3a1",
            "filename": "tests/modeltests/basic/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/5cbfb48b92cb26a335f9c8c0f79d3390290103e2/tests%2Fmodeltests%2Fbasic%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5cbfb48b92cb26a335f9c8c0f79d3390290103e2/tests%2Fmodeltests%2Fbasic%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fbasic%2Ftests.py?ref=5cbfb48b92cb26a335f9c8c0f79d3390290103e2",
            "patch": "@@ -3,7 +3,7 @@\n from datetime import datetime\n \n from django.core.exceptions import ObjectDoesNotExist\n-from django.db.models.fields import FieldDoesNotExist\n+from django.db.models.fields import Field, FieldDoesNotExist\n from django.test import TestCase, skipIfDBFeature, skipUnlessDBFeature\n from django.utils.translation import ugettext_lazy\n \n@@ -520,6 +520,22 @@ def test_hash_function(self):\n         s = set([a10, a11, a12])\n         self.assertTrue(Article.objects.get(headline='Article 11') in s)\n \n+    def test_field_ordering(self):\n+        \"\"\"\n+        Field instances have a `__lt__` comparison function to define an\n+        ordering based on their creation. Prior to #17851 this ordering\n+        comparison relied on the now unsupported `__cmp__` and was assuming\n+        compared objects were both Field instances raising `AttributeError`\n+        when it should have returned `NotImplemented`.\n+        \"\"\"\n+        f1 = Field()\n+        f2 = Field(auto_created=True)\n+        f3 = Field()\n+        self.assertTrue(f2 < f1)\n+        self.assertTrue(f3 > f1)\n+        self.assertFalse(f1 == None)\n+        self.assertFalse(f2 in (None, 1, ''))\n+\n     def test_extra_method_select_argument_with_dashes_and_values(self):\n         # The 'select' argument to extra() supports names with dashes in\n         # them, as long as you use values()."
        }
    ],
    "stats": {
        "total": 65,
        "additions": 61,
        "deletions": 4
    }
}