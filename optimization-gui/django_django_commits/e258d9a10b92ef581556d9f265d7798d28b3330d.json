{
    "author": "jezdez",
    "message": "Fixed #14955 -- Made the URLValidator use a HEAD request when verifying a URL. Thanks, Claude Paroz.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15500 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e258d9a10b92ef581556d9f265d7798d28b3330d",
    "files": [
        {
            "sha": "7562330dcd026e8bb4147d0245f0de1d9db01af6",
            "filename": "django/core/validators.py",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/e258d9a10b92ef581556d9f265d7798d28b3330d/django%2Fcore%2Fvalidators.py",
            "raw_url": "https://github.com/django/django/raw/e258d9a10b92ef581556d9f265d7798d28b3330d/django%2Fcore%2Fvalidators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fvalidators.py?ref=e258d9a10b92ef581556d9f265d7798d28b3330d",
            "patch": "@@ -1,4 +1,5 @@\n import re\n+import urllib2\n import urlparse\n \n from django.core.exceptions import ValidationError\n@@ -38,6 +39,10 @@ def __call__(self, value):\n         if not self.regex.search(smart_unicode(value)):\n             raise ValidationError(self.message, code=self.code)\n \n+class HeadRequest(urllib2.Request):\n+    def get_method(self):\n+        return \"HEAD\"\n+\n class URLValidator(RegexValidator):\n     regex = re.compile(\n         r'^https?://' # http:// or https://\n@@ -72,21 +77,33 @@ def __call__(self, value):\n             url = value\n \n         if self.verify_exists:\n-            import urllib2\n             headers = {\n                 \"Accept\": \"text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5\",\n                 \"Accept-Language\": \"en-us,en;q=0.5\",\n                 \"Accept-Charset\": \"ISO-8859-1,utf-8;q=0.7,*;q=0.7\",\n                 \"Connection\": \"close\",\n                 \"User-Agent\": self.user_agent,\n             }\n+            broken_error = ValidationError(\n+                _(u'This URL appears to be a broken link.'), code='invalid_link')\n             try:\n-                req = urllib2.Request(url, None, headers)\n+                req = HeadRequest(url, None, headers)\n                 u = urllib2.urlopen(req)\n             except ValueError:\n                 raise ValidationError(_(u'Enter a valid URL.'), code='invalid')\n+            except urllib2.HTTPError, e:\n+                if e.code in (405, 501):\n+                    # Try a GET request (HEAD refused)\n+                    # See also: http://www.w3.org/Protocols/rfc2616/rfc2616.html\n+                    try:\n+                        req = urllib2.Request(url, None, headers)\n+                        u = urllib2.urlopen(req)\n+                    except:\n+                        raise broken_error\n+                else:\n+                    raise broken_error\n             except: # urllib2.URLError, httplib.InvalidURL, etc.\n-                raise ValidationError(_(u'This URL appears to be a broken link.'), code='invalid_link')\n+                raise broken_error\n \n \n def validate_integer(value):"
        },
        {
            "sha": "65c1172bd28245c45c3f0c824b50a7b19a065d8d",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e258d9a10b92ef581556d9f265d7798d28b3330d/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/e258d9a10b92ef581556d9f265d7798d28b3330d/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=e258d9a10b92ef581556d9f265d7798d28b3330d",
            "patch": "@@ -561,6 +561,7 @@ def test_urlfield_3(self):\n         self.assertEqual(u'http://www.google.com/', f.clean('http://www.google.com')) # This will fail if there's no Internet connection\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, 'http://example')\n         self.assertRaises(ValidationError, f.clean, 'http://www.broken.djangoproject.com') # bad domain\n+        self.assertRaises(ValidationError, f.clean, 'http://qa-dev.w3.org/link-testsuite/http.php?code=405') # Method not allowed\n         try:\n             f.clean('http://www.broken.djangoproject.com') # bad domain\n         except ValidationError, e:"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 21,
        "deletions": 3
    }
}