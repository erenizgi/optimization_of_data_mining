{
    "author": "carljm",
    "message": "Fixed #17287 -- Prevented LocMemCache.incr/decr from changing key expiry time. Thanks Ivan Virabyan for report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17151 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1086a9a8455420b7167fe5195bca4c74883dcef0",
    "files": [
        {
            "sha": "59293527b7d46ff399fbcdab91b7fd73d03db10b",
            "filename": "django/core/cache/backends/locmem.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/1086a9a8455420b7167fe5195bca4c74883dcef0/django%2Fcore%2Fcache%2Fbackends%2Flocmem.py",
            "raw_url": "https://github.com/django/django/raw/1086a9a8455420b7167fe5195bca4c74883dcef0/django%2Fcore%2Fcache%2Fbackends%2Flocmem.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcache%2Fbackends%2Flocmem.py?ref=1086a9a8455420b7167fe5195bca4c74883dcef0",
            "patch": "@@ -87,6 +87,22 @@ def set(self, key, value, timeout=None, version=None):\n         finally:\n             self._lock.writer_leaves()\n \n+    def incr(self, key, delta=1, version=None):\n+        value = self.get(key, version=version)\n+        if value is None:\n+            raise ValueError(\"Key '%s' not found\" % key)\n+        new_value = value + delta\n+        key = self.make_key(key, version=version)\n+        self._lock.writer_enters()\n+        try:\n+            pickled = pickle.dumps(new_value, pickle.HIGHEST_PROTOCOL)\n+            self._cache[key] = pickled\n+        except pickle.PickleError:\n+            pass\n+        finally:\n+            self._lock.writer_leaves()\n+        return new_value\n+\n     def has_key(self, key, version=None):\n         key = self.make_key(key, version=version)\n         self.validate_key(key)"
        },
        {
            "sha": "307588c4ead30cadd6852b4a5adebf60e4c9c8d8",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/1086a9a8455420b7167fe5195bca4c74883dcef0/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1086a9a8455420b7167fe5195bca4c74883dcef0/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=1086a9a8455420b7167fe5195bca4c74883dcef0",
            "patch": "@@ -865,6 +865,16 @@ def test_multiple_caches(self):\n         self.assertEqual(mirror_cache.get('value1'), 42)\n         self.assertEqual(other_cache.get('value1'), None)\n \n+    def test_incr_decr_timeout(self):\n+        \"\"\"incr/decr does not modify expiry time (matches memcached behavior)\"\"\"\n+        key = 'value'\n+        _key = self.cache.make_key(key)\n+        self.cache.set(key, 1, timeout=self.cache.default_timeout*10)\n+        expire = self.cache._expire_info[_key]\n+        self.cache.incr(key)\n+        self.assertEqual(expire, self.cache._expire_info[_key])\n+        self.cache.decr(key)\n+        self.assertEqual(expire, self.cache._expire_info[_key])\n \n # memcached backend isn't guaranteed to be available.\n # To check the memcached backend, the test settings file will"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 26,
        "deletions": 0
    }
}