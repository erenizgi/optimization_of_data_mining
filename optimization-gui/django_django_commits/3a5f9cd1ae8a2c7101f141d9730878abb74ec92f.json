{
    "author": "jezdez",
    "message": "Fixed #17861 -- Took care of special characters when creating the staticfiles storage cache keys. Many thanks to Preston Holmes.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17688 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3a5f9cd1ae8a2c7101f141d9730878abb74ec92f",
    "files": [
        {
            "sha": "97e7e9c494218ad36d74d6cd33f3da5555a1fda6",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/3a5f9cd1ae8a2c7101f141d9730878abb74ec92f/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/3a5f9cd1ae8a2c7101f141d9730878abb74ec92f/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=3a5f9cd1ae8a2c7101f141d9730878abb74ec92f",
            "patch": "@@ -95,7 +95,7 @@ def hashed_name(self, name, content=None):\n         return urlunsplit(unparsed_name)\n \n     def cache_key(self, name):\n-        return u'staticfiles:cache:%s' % name\n+        return u'staticfiles:%s' % hashlib.md5(smart_str(name)).hexdigest()\n \n     def url(self, name, force=False):\n         \"\"\""
        },
        {
            "sha": "7850b44b77f6084c1094d7490286b63e44b250f6",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/3a5f9cd1ae8a2c7101f141d9730878abb74ec92f/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3a5f9cd1ae8a2c7101f141d9730878abb74ec92f/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=3a5f9cd1ae8a2c7101f141d9730878abb74ec92f",
            "patch": "@@ -7,10 +7,12 @@\n import shutil\n import sys\n import tempfile\n+import warnings\n from StringIO import StringIO\n \n from django.template import loader, Context\n from django.conf import settings\n+from django.core.cache.backends.base import BaseCache, CacheKeyWarning\n from django.core.exceptions import ImproperlyConfigured\n from django.core.files.storage import default_storage\n from django.core.management import call_command\n@@ -498,6 +500,20 @@ def test_post_processing(self):\n         self.assertTrue(os.path.join('cached', 'css', 'window.css') in stats['post_processed'])\n         self.assertTrue(os.path.join('cached', 'css', 'img', 'window.png') in stats['unmodified'])\n \n+    def test_cache_key_memcache_validation(self):\n+        \"\"\"\n+        Handle cache key creation correctly, see #17861.\n+        \"\"\"\n+        name = \"/some crazy/long filename/ with spaces Here and ?#%#$/other/stuff/some crazy/long filename/ with spaces Here and ?#%#$/other/stuff/some crazy/long filename/ with spaces Here and ?#%#$/other/stuff/some crazy/long filename/ with spaces Here and ?#%#$/other/stuff/some crazy/long filename/ with spaces Here and ?#%#$/other/stuff/some crazy/\" + chr(22) + chr(180)\n+        cache_key = storage.staticfiles_storage.cache_key(name)\n+        self.save_warnings_state()\n+        cache_validator = BaseCache({})\n+        warnings.filterwarnings('error', category=CacheKeyWarning)\n+        cache_validator.validate_key(cache_key)\n+        self.restore_warnings_state()\n+        self.assertEqual(cache_key, 'staticfiles:e95bbc36387084582df2a70750d7b351')\n+\n+\n # we set DEBUG to False here since the template tag wouldn't work otherwise\n TestCollectionCachedStorage = override_settings(**dict(TEST_SETTINGS,\n     STATICFILES_STORAGE='django.contrib.staticfiles.storage.CachedStaticFilesStorage',"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 17,
        "deletions": 1
    }
}