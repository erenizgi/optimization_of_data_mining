{
    "author": "alex",
    "message": "Convert the contettypes tests to use self.assertNumQueries, rather than hand rolling their own version. Thanks to carl for the review.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16962 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a5e691e5de3bededca32ec8d9d997abae5ca81c9",
    "files": [
        {
            "sha": "e7f843ddd0986026f4ef83058fca7e59a7d0031b",
            "filename": "django/contrib/contenttypes/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 18,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/a5e691e5de3bededca32ec8d9d997abae5ca81c9/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a5e691e5de3bededca32ec8d9d997abae5ca81c9/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Ftests.py?ref=a5e691e5de3bededca32ec8d9d997abae5ca81c9",
            "patch": "@@ -1,12 +1,13 @@\n+from __future__ import with_statement\n+\n import urllib\n-from django import db\n-from django.conf import settings\n+\n+from django.db import models\n from django.contrib.contenttypes.models import ContentType\n-from django.contrib.sites.models import Site\n from django.contrib.contenttypes.views import shortcut\n+from django.contrib.sites.models import Site\n from django.http import HttpRequest, Http404\n from django.test import TestCase\n-from django.db import models\n from django.utils.encoding import smart_str\n \n \n@@ -33,16 +34,10 @@ def get_absolute_url(self):\n class ContentTypesTests(TestCase):\n \n     def setUp(self):\n-        # First, let's make sure we're dealing with a blank slate (and that\n-        # DEBUG is on so that queries get logged)\n-        self.old_DEBUG = settings.DEBUG\n         self.old_Site_meta_installed = Site._meta.installed\n-        settings.DEBUG = True\n         ContentType.objects.clear_cache()\n-        db.reset_queries()\n \n     def tearDown(self):\n-        settings.DEBUG = self.old_DEBUG\n         Site._meta.installed = self.old_Site_meta_installed\n         ContentType.objects.clear_cache()\n \n@@ -54,19 +49,19 @@ def test_lookup_cache(self):\n         \"\"\"\n \n         # At this point, a lookup for a ContentType should hit the DB\n-        ContentType.objects.get_for_model(ContentType)\n-        self.assertEqual(1, len(db.connection.queries))\n+        with self.assertNumQueries(1):\n+            ContentType.objects.get_for_model(ContentType)\n \n         # A second hit, though, won't hit the DB, nor will a lookup by ID\n-        ct = ContentType.objects.get_for_model(ContentType)\n-        self.assertEqual(1, len(db.connection.queries))\n-        ContentType.objects.get_for_id(ct.id)\n-        self.assertEqual(1, len(db.connection.queries))\n+        with self.assertNumQueries(0):\n+            ct = ContentType.objects.get_for_model(ContentType)\n+        with self.assertNumQueries(0):\n+            ContentType.objects.get_for_id(ct.id)\n \n         # Once we clear the cache, another lookup will again hit the DB\n         ContentType.objects.clear_cache()\n-        ContentType.objects.get_for_model(ContentType)\n-        self.assertEqual(2, len(db.connection.queries))\n+        with self.assertNumQueries(1):\n+            ContentType.objects.get_for_model(ContentType)\n \n     def test_shortcut_view(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 31,
        "additions": 13,
        "deletions": 18
    }
}