{
    "author": "jphalip",
    "message": "Fixed #10057 -- Ensured that the 'show_delete' context variable in the admin's change view actually controls the display of the delete button. Thanks to rajeesh for the report, to patcoll for the patch, and to David Gouldin for the test.",
    "sha": "01c392623d988d7486bdaa870886df0ea3da5fa7",
    "files": [
        {
            "sha": "40f6e2842cdcf66b0fa29d75495df4fbdd10eba8",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/01c392623d988d7486bdaa870886df0ea3da5fa7/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/01c392623d988d7486bdaa870886df0ea3da5fa7/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=01c392623d988d7486bdaa870886df0ea3da5fa7",
            "patch": "@@ -998,7 +998,6 @@ def add_view(self, request, form_url='', extra_context=None):\n             'title': _('Add %s') % force_unicode(opts.verbose_name),\n             'adminform': adminForm,\n             'is_popup': \"_popup\" in request.REQUEST,\n-            'show_delete': False,\n             'media': media,\n             'inline_admin_formsets': inline_admin_formsets,\n             'errors': helpers.AdminErrorList(form, formsets),"
        },
        {
            "sha": "c190533f9569bd062d85e690347a37b938550069",
            "filename": "django/contrib/admin/templatetags/admin_modify.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/01c392623d988d7486bdaa870886df0ea3da5fa7/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py",
            "raw_url": "https://github.com/django/django/raw/01c392623d988d7486bdaa870886df0ea3da5fa7/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_modify.py?ref=01c392623d988d7486bdaa870886df0ea3da5fa7",
            "patch": "@@ -32,7 +32,7 @@ def submit_row(context):\n         'onclick_attrib': (opts.get_ordered_objects() and change\n                             and 'onclick=\"submitOrderForm();\"' or ''),\n         'show_delete_link': (not is_popup and context['has_delete_permission']\n-                              and (change or context['show_delete'])),\n+                              and change and context.get('show_delete', True)),\n         'show_save_as_new': not is_popup and change and save_as,\n         'show_save_and_add_another': context['has_add_permission'] and\n                             not is_popup and (not save_as or context['add']),"
        },
        {
            "sha": "6ec933f89b58f9faf96ab6e43f1adbae9b1ce7ef",
            "filename": "tests/regressiontests/admin_views/admin.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py?ref=01c392623d988d7486bdaa870886df0ea3da5fa7",
            "patch": "@@ -27,7 +27,7 @@\n     Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug,\n     AdminOrderedField, AdminOrderedModelMethod, AdminOrderedAdminMethod,\n     AdminOrderedCallable, Report, Color2, UnorderedObject, MainPrepopulated,\n-    RelatedPrepopulated)\n+    RelatedPrepopulated, UndeletableObject)\n \n \n def callable_year(dt_value):\n@@ -569,6 +569,11 @@ class UnorderedObjectAdmin(admin.ModelAdmin):\n     list_per_page = 2\n \n \n+class UndeletableObjectAdmin(admin.ModelAdmin):\n+    def change_view(self, *args, **kwargs):\n+        kwargs['extra_context'] = {'show_delete': False}\n+        return super(UndeletableObjectAdmin, self).change_view(*args, **kwargs)\n+\n \n site = admin.AdminSite(name=\"admin\")\n site.register(Article, ArticleAdmin)\n@@ -616,6 +621,7 @@ class UnorderedObjectAdmin(admin.ModelAdmin):\n site.register(Report, ReportAdmin)\n site.register(MainPrepopulated, MainPrepopulatedAdmin)\n site.register(UnorderedObject, UnorderedObjectAdmin)\n+site.register(UndeletableObject, UndeletableObjectAdmin)\n \n # We intentionally register Promo and ChapterXtra1 but not Chapter nor ChapterXtra2.\n # That way we cover all four cases:"
        },
        {
            "sha": "142527b022b11cb647deb5bf56ac339629370279",
            "filename": "tests/regressiontests/admin_views/customadmin.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py",
            "raw_url": "https://github.com/django/django/raw/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py?ref=01c392623d988d7486bdaa870886df0ea3da5fa7",
            "patch": "@@ -48,3 +48,4 @@ def queryset(self, request):\n site.register(models.Fabric, base_admin.FabricAdmin)\n site.register(models.ChapterXtra1, base_admin.ChapterXtra1Admin)\n site.register(User, UserLimitedAdmin)\n+site.register(models.UndeletableObject, base_admin.UndeletableObjectAdmin)"
        },
        {
            "sha": "aee193b572fa6bb5a397563697e9c0175fc63ba2",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=01c392623d988d7486bdaa870886df0ea3da5fa7",
            "patch": "@@ -611,3 +611,10 @@ class UnorderedObject(models.Model):\n     \"\"\"\n     name = models.CharField(max_length=255)\n     bool = models.BooleanField(default=True)\n+\n+class UndeletableObject(models.Model):\n+    \"\"\"\n+    Model whose show_delete in admin change_view has been disabled\n+    Refs #10057.\n+    \"\"\"\n+    name = models.CharField(max_length=255)"
        },
        {
            "sha": "630758a91dac9cd21d22b18d60991dea52874364",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/01c392623d988d7486bdaa870886df0ea3da5fa7/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=01c392623d988d7486bdaa870886df0ea3da5fa7",
            "patch": "@@ -41,7 +41,8 @@\n     FoodDelivery, RowLevelChangePermissionModel, Paper, CoverLetter, Story,\n     OtherStory, ComplexSortedPerson, Parent, Child, AdminOrderedField,\n     AdminOrderedModelMethod, AdminOrderedAdminMethod, AdminOrderedCallable,\n-    Report, MainPrepopulated, RelatedPrepopulated, UnorderedObject)\n+    Report, MainPrepopulated, RelatedPrepopulated, UnorderedObject,\n+    UndeletableObject)\n \n \n ERROR_MESSAGE = \"Please enter the correct username and password \\\n@@ -588,6 +589,16 @@ def test_hide_change_password(self):\n         self.assertFalse(reverse('admin:password_change') in response.content,\n             msg='The \"change password\" link should not be displayed if a user does not have a usable password.')\n \n+    def test_change_view_with_show_delete_extra_context(self):\n+        \"\"\"\n+        Ensured that the 'show_delete' context variable in the admin's change\n+        view actually controls the display of the delete button.\n+        Refs #10057.\n+        \"\"\"\n+        instance = UndeletableObject.objects.create(name='foo')\n+        response = self.client.get('/test_admin/%s/admin_views/undeletableobject/%d/' %\n+                                   (self.urlbit, instance.pk))\n+        self.assertNotContains(response, 'deletelink')\n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n class AdminViewFormUrlTest(TestCase):"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 28,
        "deletions": 4
    }
}