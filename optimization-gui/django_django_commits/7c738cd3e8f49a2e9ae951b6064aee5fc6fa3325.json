{
    "author": "jezdez",
    "message": "Fixed #15618 -- Fixed regression introduced in r15848 regarding not properly deleting messages cookies when honoring SESSION_COOKIE_DOMAIN. Thanks, Julien.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15885 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325",
    "files": [
        {
            "sha": "45a20d0f94cf35dca01b6104d32579c981e42a27",
            "filename": "django/contrib/messages/storage/cookie.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py",
            "raw_url": "https://github.com/django/django/raw/7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Fstorage%2Fcookie.py?ref=7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325",
            "patch": "@@ -75,7 +75,8 @@ def _update_cookie(self, encoded_data, response):\n             response.set_cookie(self.cookie_name, encoded_data,\n                 domain=settings.SESSION_COOKIE_DOMAIN)\n         else:\n-            response.delete_cookie(self.cookie_name)\n+            response.delete_cookie(self.cookie_name,\n+                domain=settings.SESSION_COOKIE_DOMAIN)\n \n     def _store(self, messages, response, remove_oldest=True, *args, **kwargs):\n         \"\"\""
        },
        {
            "sha": "95e1f99c79132902382193f9132b5e8526bed9c7",
            "filename": "django/contrib/messages/tests/cookie.py",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325/django%2Fcontrib%2Fmessages%2Ftests%2Fcookie.py",
            "raw_url": "https://github.com/django/django/raw/7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325/django%2Fcontrib%2Fmessages%2Ftests%2Fcookie.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fcookie.py?ref=7c738cd3e8f49a2e9ae951b6064aee5fc6fa3325",
            "patch": "@@ -4,6 +4,7 @@\n                                             MessageEncoder, MessageDecoder\n from django.contrib.messages.storage.base import Message\n from django.utils import simplejson as json\n+from django.conf import settings\n \n \n def set_cookie_data(storage, messages, invalid=False, encode_empty=False):\n@@ -40,6 +41,15 @@ def stored_cookie_messages_count(storage, response):\n class CookieTest(BaseTest):\n     storage_class = CookieStorage\n \n+    def setUp(self):\n+        super(CookieTest, self).setUp()\n+        self.old_SESSION_COOKIE_DOMAIN = settings.SESSION_COOKIE_DOMAIN\n+        settings.SESSION_COOKIE_DOMAIN = '.lawrence.com'\n+\n+    def tearDown(self):\n+        super(CookieTest, self).tearDown()\n+        settings.SESSION_COOKIE_DOMAIN = self.old_SESSION_COOKIE_DOMAIN\n+\n     def stored_messages_count(self, storage, response):\n         return stored_cookie_messages_count(storage, response)\n \n@@ -51,6 +61,31 @@ def test_get(self):\n         # Test that the message actually contains what we expect.\n         self.assertEqual(list(storage), example_messages)\n \n+    def test_domain(self):\n+        \"\"\"\n+        Ensure that CookieStorage honors SESSION_COOKIE_DOMAIN.\n+        Refs #15618.\n+        \"\"\"\n+        # Test before the messages have been consumed\n+        storage = self.get_storage()\n+        response = self.get_response()\n+        storage.add(constants.INFO, 'test')\n+        storage.update(response)\n+        self.assertTrue('test' in response.cookies['messages'].value)\n+        self.assertEqual(response.cookies['messages']['domain'], '.lawrence.com')\n+        self.assertEqual(response.cookies['messages']['expires'], '')\n+\n+        # Test after the messages have been consumed\n+        storage = self.get_storage()\n+        response = self.get_response()\n+        storage.add(constants.INFO, 'test')\n+        for m in storage:\n+            pass # Iterate through the storage to simulate consumption of messages.\n+        storage.update(response)\n+        self.assertEqual(response.cookies['messages'].value, '')\n+        self.assertEqual(response.cookies['messages']['domain'], '.lawrence.com')\n+        self.assertEqual(response.cookies['messages']['expires'], 'Thu, 01-Jan-1970 00:00:00 GMT')\n+\n     def test_get_bad_cookie(self):\n         request = self.get_request()\n         storage = self.storage_class(request)"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 37,
        "deletions": 1
    }
}