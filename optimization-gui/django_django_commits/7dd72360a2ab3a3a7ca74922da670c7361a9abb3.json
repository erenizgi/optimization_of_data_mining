{
    "author": "jezdez",
    "message": "Make use of new translation and settings context manager in the tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16167 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
    "files": [
        {
            "sha": "fe6e2ff6a561804ba1f80ace29acac7bf57b6e83",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 26,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -22,12 +22,11 @@\n import django.template.context\n from django.template.response import TemplateResponse\n from django.test import TestCase\n-from django.utils import formats\n+from django.utils import formats, translation\n from django.utils.cache import get_max_age\n from django.utils.encoding import iri_to_uri\n from django.utils.html import escape\n from django.utils.http import urlencode\n-from django.utils.translation import activate, deactivate\n from django.utils import unittest\n \n # local test models\n@@ -361,42 +360,31 @@ def testI18NLanguageNonEnglishDefault(self):\n         if the default language is non-English but the selected language\n         is English. See #13388 and #3594 for more details.\n         \"\"\"\n-        try:\n-            settings.LANGUAGE_CODE = 'fr'\n-            activate('en-us')\n-            response = self.client.get('/test_admin/admin/jsi18n/')\n-            self.assertNotContains(response, 'Choisir une heure')\n-        finally:\n-            deactivate()\n+        with self.settings(LANGUAGE_CODE='fr'):\n+            with translation.override('en-us'):\n+                response = self.client.get('/test_admin/admin/jsi18n/')\n+                self.assertNotContains(response, 'Choisir une heure')\n \n     def testI18NLanguageNonEnglishFallback(self):\n         \"\"\"\n         Makes sure that the fallback language is still working properly\n         in cases where the selected language cannot be found.\n         \"\"\"\n-        try:\n-            settings.LANGUAGE_CODE = 'fr'\n-            activate('none')\n-            response = self.client.get('/test_admin/admin/jsi18n/')\n-            self.assertContains(response, 'Choisir une heure')\n-        finally:\n-            deactivate()\n+        with self.settings(LANGUAGE_CODE='fr'):\n+            with translation.override('none'):\n+                response = self.client.get('/test_admin/admin/jsi18n/')\n+                self.assertContains(response, 'Choisir une heure')\n \n     def testL10NDeactivated(self):\n         \"\"\"\n         Check if L10N is deactivated, the Javascript i18n view doesn't\n         return localized date/time formats. Refs #14824.\n         \"\"\"\n-        try:\n-            settings.LANGUAGE_CODE = 'ru'\n-            settings.USE_L10N = False\n-            activate('ru')\n-            response = self.client.get('/test_admin/admin/jsi18n/')\n-            self.assertNotContains(response, '%d.%m.%Y %H:%M:%S')\n-            self.assertContains(response, '%Y-%m-%d %H:%M:%S')\n-        finally:\n-            deactivate()\n-\n+        with self.settings(LANGUAGE_CODE='ru', USE_L10N=False):\n+            with translation.override('none'):\n+                response = self.client.get('/test_admin/admin/jsi18n/')\n+                self.assertNotContains(response, '%d.%m.%Y %H:%M:%S')\n+                self.assertContains(response, '%Y-%m-%d %H:%M:%S')\n \n     def test_disallowed_filtering(self):\n         self.assertRaises(SuspiciousOperation,"
        },
        {
            "sha": "b498525a914d8792b937e52726f0f4f14e8af50d",
            "filename": "tests/regressiontests/admin_widgets/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 14,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -14,8 +14,8 @@\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.db.models import DateField\n from django.test import TestCase as DjangoTestCase\n+from django.utils import translation\n from django.utils.html import conditional_escape\n-from django.utils.translation import activate, deactivate\n from django.utils.unittest import TestCase\n \n import models\n@@ -204,7 +204,7 @@ def test_stacked_render(self):\n         )\n \n \n-class AdminSplitDateTimeWidgetTest(TestCase):\n+class AdminSplitDateTimeWidgetTest(DjangoTestCase):\n     def test_render(self):\n         w = AdminSplitDateTime()\n         self.assertEqual(\n@@ -215,18 +215,13 @@ def test_render(self):\n     def test_localization(self):\n         w = AdminSplitDateTime()\n \n-        activate('de-at')\n-        old_USE_L10N = settings.USE_L10N\n-        try:\n-            settings.USE_L10N = True\n-            w.is_localized = True\n-            self.assertEqual(\n-                conditional_escape(w.render('test', datetime(2007, 12, 1, 9, 30))),\n-                '<p class=\"datetime\">Datum: <input value=\"01.12.2007\" type=\"text\" class=\"vDateField\" name=\"test_0\" size=\"10\" /><br />Zeit: <input value=\"09:30:00\" type=\"text\" class=\"vTimeField\" name=\"test_1\" size=\"8\" /></p>',\n-            )\n-        finally:\n-            deactivate()\n-            settings.USE_L10N = old_USE_L10N\n+        with self.settings(USE_L10N=True):\n+            with translation.override('de-at'):\n+                w.is_localized = True\n+                self.assertEqual(\n+                    conditional_escape(w.render('test', datetime(2007, 12, 1, 9, 30))),\n+                    '<p class=\"datetime\">Datum: <input value=\"01.12.2007\" type=\"text\" class=\"vDateField\" name=\"test_0\" size=\"10\" /><br />Zeit: <input value=\"09:30:00\" type=\"text\" class=\"vTimeField\" name=\"test_1\" size=\"8\" /></p>',\n+                )\n \n \n class AdminFileWidgetTest(DjangoTestCase):"
        },
        {
            "sha": "80424a82342fedd2e83390fd8f060bd8c22f8aa1",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 27,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -1,10 +1,11 @@\n # -*- coding: utf-8 -*-\n import datetime\n-from django.utils import unittest\n+from django.test import TestCase\n+from django.utils import unittest, translation\n \n from django.template.defaultfilters import *\n \n-class DefaultFiltersTests(unittest.TestCase):\n+class DefaultFiltersTests(TestCase):\n \n     def test_floatformat(self):\n         self.assertEqual(floatformat(7.7), u'7.7')\n@@ -458,31 +459,25 @@ def test_filesizeformat(self):\n                           u'0 bytes')\n \n     def test_localized_filesizeformat(self):\n-        from django.utils.translation import activate, deactivate\n-        old_localize = settings.USE_L10N\n-        try:\n-            activate('de')\n-            settings.USE_L10N = True\n-            self.assertEqual(filesizeformat(1023), u'1023 Bytes')\n-            self.assertEqual(filesizeformat(1024), u'1,0 KB')\n-            self.assertEqual(filesizeformat(10*1024), u'10,0 KB')\n-            self.assertEqual(filesizeformat(1024*1024-1), u'1024,0 KB')\n-            self.assertEqual(filesizeformat(1024*1024), u'1,0 MB')\n-            self.assertEqual(filesizeformat(1024*1024*50), u'50,0 MB')\n-            self.assertEqual(filesizeformat(1024*1024*1024-1), u'1024,0 MB')\n-            self.assertEqual(filesizeformat(1024*1024*1024), u'1,0 GB')\n-            self.assertEqual(filesizeformat(1024*1024*1024*1024), u'1,0 TB')\n-            self.assertEqual(filesizeformat(1024*1024*1024*1024*1024),\n-                              u'1,0 PB')\n-            self.assertEqual(filesizeformat(1024*1024*1024*1024*1024*2000),\n-                              u'2000,0 PB')\n-            self.assertEqual(filesizeformat(complex(1,-1)), u'0 Bytes')\n-            self.assertEqual(filesizeformat(\"\"), u'0 Bytes')\n-            self.assertEqual(filesizeformat(u\"\\N{GREEK SMALL LETTER ALPHA}\"),\n-                              u'0 Bytes')\n-        finally:\n-            deactivate()\n-            settings.USE_L10N = old_localize\n+        with self.settings(USE_L10N=True):\n+            with translation.override('de', deactivate=True):\n+                self.assertEqual(filesizeformat(1023), u'1023 Bytes')\n+                self.assertEqual(filesizeformat(1024), u'1,0 KB')\n+                self.assertEqual(filesizeformat(10*1024), u'10,0 KB')\n+                self.assertEqual(filesizeformat(1024*1024-1), u'1024,0 KB')\n+                self.assertEqual(filesizeformat(1024*1024), u'1,0 MB')\n+                self.assertEqual(filesizeformat(1024*1024*50), u'50,0 MB')\n+                self.assertEqual(filesizeformat(1024*1024*1024-1), u'1024,0 MB')\n+                self.assertEqual(filesizeformat(1024*1024*1024), u'1,0 GB')\n+                self.assertEqual(filesizeformat(1024*1024*1024*1024), u'1,0 TB')\n+                self.assertEqual(filesizeformat(1024*1024*1024*1024*1024),\n+                                  u'1,0 PB')\n+                self.assertEqual(filesizeformat(1024*1024*1024*1024*1024*2000),\n+                                  u'2000,0 PB')\n+                self.assertEqual(filesizeformat(complex(1,-1)), u'0 Bytes')\n+                self.assertEqual(filesizeformat(\"\"), u'0 Bytes')\n+                self.assertEqual(filesizeformat(u\"\\N{GREEK SMALL LETTER ALPHA}\"),\n+                                  u'0 Bytes')\n \n     def test_pluralize(self):\n         self.assertEqual(pluralize(1), u'')"
        },
        {
            "sha": "1f8f5a49ea5939375d4c86fd365acd42b852e040",
            "filename": "tests/regressiontests/forms/tests/regressions.py",
            "status": "modified",
            "additions": 8,
            "deletions": 10,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fforms%2Ftests%2Fregressions.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fforms%2Ftests%2Fregressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fregressions.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -1,7 +1,7 @@\n # -*- coding: utf-8 -*-\n from django.forms import *\n from django.utils.unittest import TestCase\n-from django.utils.translation import ugettext_lazy, activate, deactivate\n+from django.utils.translation import ugettext_lazy, override\n \n from regressiontests.forms.models import Cheese\n \n@@ -28,11 +28,10 @@ class SomeForm(Form):\n         self.assertEqual(f.as_p(), '<p><label for=\"id_username\">Username:</label> <input id=\"id_username\" type=\"text\" name=\"username\" maxlength=\"10\" /></p>')\n \n         # Translations are done at rendering time, so multi-lingual apps can define forms)\n-        activate('de')\n-        self.assertEqual(f.as_p(), '<p><label for=\"id_username\">Benutzername:</label> <input id=\"id_username\" type=\"text\" name=\"username\" maxlength=\"10\" /></p>')\n-        activate('pl')\n-        self.assertEqual(f.as_p(), u'<p><label for=\"id_username\">Nazwa u\\u017cytkownika:</label> <input id=\"id_username\" type=\"text\" name=\"username\" maxlength=\"10\" /></p>')\n-        deactivate()\n+        with override('de'):\n+            self.assertEqual(f.as_p(), '<p><label for=\"id_username\">Benutzername:</label> <input id=\"id_username\" type=\"text\" name=\"username\" maxlength=\"10\" /></p>')\n+        with override('pl', deactivate=True):\n+            self.assertEqual(f.as_p(), u'<p><label for=\"id_username\">Nazwa u\\u017cytkownika:</label> <input id=\"id_username\" type=\"text\" name=\"username\" maxlength=\"10\" /></p>')\n \n     def test_regression_5216(self):\n         # There was some problems with form translations in #5216\n@@ -61,10 +60,9 @@ class SomeForm(Form):\n         self.assertEqual(f.clean('\\xd1\\x88\\xd1\\x82.'), u'\\u0448\\u0442.')\n \n         # Translated error messages used to be buggy.\n-        activate('ru')\n-        f = SomeForm({})\n-        self.assertEqual(f.as_p(), u'<ul class=\"errorlist\"><li>\\u041e\\u0431\\u044f\\u0437\\u0430\\u0442\\u0435\\u043b\\u044c\\u043d\\u043e\\u0435 \\u043f\\u043e\\u043b\\u0435.</li></ul>\\n<p><label for=\"id_somechoice_0\">\\xc5\\xf8\\xdf:</label> <ul>\\n<li><label for=\"id_somechoice_0\"><input type=\"radio\" id=\"id_somechoice_0\" value=\"\\xc5\" name=\"somechoice\" /> En tied\\xe4</label></li>\\n<li><label for=\"id_somechoice_1\"><input type=\"radio\" id=\"id_somechoice_1\" value=\"\\xf8\" name=\"somechoice\" /> Mies</label></li>\\n<li><label for=\"id_somechoice_2\"><input type=\"radio\" id=\"id_somechoice_2\" value=\"\\xdf\" name=\"somechoice\" /> Nainen</label></li>\\n</ul></p>')\n-        deactivate()\n+        with override('ru'):\n+            f = SomeForm({})\n+            self.assertEqual(f.as_p(), u'<ul class=\"errorlist\"><li>\\u041e\\u0431\\u044f\\u0437\\u0430\\u0442\\u0435\\u043b\\u044c\\u043d\\u043e\\u0435 \\u043f\\u043e\\u043b\\u0435.</li></ul>\\n<p><label for=\"id_somechoice_0\">\\xc5\\xf8\\xdf:</label> <ul>\\n<li><label for=\"id_somechoice_0\"><input type=\"radio\" id=\"id_somechoice_0\" value=\"\\xc5\" name=\"somechoice\" /> En tied\\xe4</label></li>\\n<li><label for=\"id_somechoice_1\"><input type=\"radio\" id=\"id_somechoice_1\" value=\"\\xf8\" name=\"somechoice\" /> Mies</label></li>\\n<li><label for=\"id_somechoice_2\"><input type=\"radio\" id=\"id_somechoice_2\" value=\"\\xdf\" name=\"somechoice\" /> Nainen</label></li>\\n</ul></p>')\n \n         # Deep copying translated text shouldn't raise an error)\n         from django.utils.translation import gettext_lazy"
        },
        {
            "sha": "8a37c6e0463a291d98ad984d9a456244f92cd8af",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 146,
            "deletions": 210,
            "changes": 356,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -14,10 +14,10 @@\n from django.utils.importlib import import_module\n from django.utils.numberformat import format as nformat\n from django.utils.safestring import mark_safe, SafeString, SafeUnicode\n+from django.utils import translation\n from django.utils.translation import (ugettext, ugettext_lazy, activate,\n         deactivate, gettext_lazy, pgettext, npgettext, to_locale,\n         get_language_info, get_language)\n-from django.utils.unittest import TestCase\n \n \n from forms import I18nForm, SelectDateForm, SelectDateWidget, CompanyForm\n@@ -43,13 +43,10 @@ def test_lazy_objects(self):\n         s = ugettext_lazy('Add %(name)s')\n         d = {'name': 'Ringo'}\n         self.assertEqual(u'Add Ringo', s % d)\n-        activate('de')\n-        try:\n+        with translation.override('de', deactivate=True):\n             self.assertEqual(u'Ringo hinzuf\\xfcgen', s % d)\n-            activate('pl')\n-            self.assertEqual(u'Dodaj Ringo', s % d)\n-        finally:\n-            deactivate()\n+            with translation.override('pl'):\n+                self.assertEqual(u'Dodaj Ringo', s % d)\n \n         # It should be possible to compare *_lazy objects.\n         s1 = ugettext_lazy('Add %(name)s')\n@@ -69,19 +66,18 @@ def test_lazy_pickle(self):\n \n     def test_pgettext(self):\n         # Reset translation catalog to include other/locale/de\n-        self.old_locale_paths = settings.LOCALE_PATHS\n-        settings.LOCALE_PATHS += (os.path.join(os.path.dirname(os.path.abspath(__file__)), 'other', 'locale'),)\n-        from django.utils.translation import trans_real\n-        trans_real._active = local()\n-        trans_real._translations = {}\n-        activate('de')\n-\n-        self.assertEqual(pgettext(\"unexisting\", \"May\"), u\"May\")\n-        self.assertEqual(pgettext(\"month name\", \"May\"), u\"Mai\")\n-        self.assertEqual(pgettext(\"verb\", \"May\"), u\"Kann\")\n-        self.assertEqual(npgettext(\"search\", \"%d result\", \"%d results\", 4) % 4, u\"4 Resultate\")\n-\n-        settings.LOCALE_PATHS = self.old_locale_paths\n+        extended_locale_paths = settings.LOCALE_PATHS + (\n+            os.path.join(os.path.dirname(os.path.abspath(__file__)), 'other', 'locale'),\n+        )\n+        with self.settings(LOCALE_PATHS=extended_locale_paths):\n+            from django.utils.translation import trans_real\n+            trans_real._active = local()\n+            trans_real._translations = {}\n+            with translation.override('de'):\n+                self.assertEqual(pgettext(\"unexisting\", \"May\"), u\"May\")\n+                self.assertEqual(pgettext(\"month name\", \"May\"), u\"Mai\")\n+                self.assertEqual(pgettext(\"verb\", \"May\"), u\"Kann\")\n+                self.assertEqual(npgettext(\"search\", \"%d result\", \"%d results\", 4) % 4, u\"4 Resultate\")\n \n     def test_string_concat(self):\n         \"\"\"\n@@ -96,11 +92,8 @@ def test_safe_status(self):\n         \"\"\"\n         s = mark_safe('Password')\n         self.assertEqual(SafeString, type(s))\n-        activate('de')\n-        try:\n+        with translation.override('de', deactivate=True):\n             self.assertEqual(SafeUnicode, type(ugettext(s)))\n-        finally:\n-            deactivate()\n         self.assertEqual('aPassword', SafeString('a') + s)\n         self.assertEqual('Passworda', s + SafeString('a'))\n         self.assertEqual('Passworda', s + mark_safe('a'))\n@@ -112,16 +105,13 @@ def test_maclines(self):\n         Translations on files with mac or dos end of lines will be converted\n         to unix eof in .po catalogs, and they have to match when retrieved\n         \"\"\"\n-        from django.utils.translation.trans_real import translation\n-        ca_translation = translation('ca')\n+        from django.utils.translation.trans_real import translation as Trans\n+        ca_translation = Trans('ca')\n         ca_translation._catalog[u'Mac\\nEOF\\n'] = u'Catalan Mac\\nEOF\\n'\n         ca_translation._catalog[u'Win\\nEOF\\n'] = u'Catalan Win\\nEOF\\n'\n-        activate('ca')\n-        try:\n+        with translation.override('ca', deactivate=True):\n             self.assertEqual(u'Catalan Mac\\nEOF\\n', ugettext(u'Mac\\rEOF\\r'))\n             self.assertEqual(u'Catalan Win\\nEOF\\n', ugettext(u'Win\\r\\nEOF\\r\\n'))\n-        finally:\n-            deactivate()\n \n     def test_to_locale(self):\n         \"\"\"\n@@ -175,31 +165,29 @@ def test_locale_independent(self):\n         \"\"\"\n         Localization of numbers\n         \"\"\"\n-        settings.USE_L10N = True\n-        settings.USE_THOUSAND_SEPARATOR = False\n-        self.assertEqual(u'66666.66', nformat(self.n, decimal_sep='.', decimal_pos=2, grouping=3, thousand_sep=','))\n-        self.assertEqual(u'66666A6', nformat(self.n, decimal_sep='A', decimal_pos=1, grouping=1, thousand_sep='B'))\n-        self.assertEqual(u'66666', nformat(self.n, decimal_sep='X', decimal_pos=0, grouping=1, thousand_sep='Y'))\n-\n-        settings.USE_THOUSAND_SEPARATOR = True\n-        self.assertEqual(u'66,666.66', nformat(self.n, decimal_sep='.', decimal_pos=2, grouping=3, thousand_sep=','))\n-        self.assertEqual(u'6B6B6B6B6A6', nformat(self.n, decimal_sep='A', decimal_pos=1, grouping=1, thousand_sep='B'))\n-        self.assertEqual(u'-66666.6', nformat(-66666.666, decimal_sep='.', decimal_pos=1))\n-        self.assertEqual(u'-66666.0', nformat(int('-66666'), decimal_sep='.', decimal_pos=1))\n-        self.assertEqual(u'10000.0', nformat(self.l, decimal_sep='.', decimal_pos=1))\n-\n-        # date filter\n-        self.assertEqual(u'31.12.2009 в 20:50', Template('{{ dt|date:\"d.m.Y в H:i\" }}').render(self.ctxt))\n-        self.assertEqual(u'⌚ 10:15', Template('{{ t|time:\"⌚ H:i\" }}').render(self.ctxt))\n+        with self.settings(USE_L10N=True, USE_THOUSAND_SEPARATOR=False):\n+            self.assertEqual(u'66666.66', nformat(self.n, decimal_sep='.', decimal_pos=2, grouping=3, thousand_sep=','))\n+            self.assertEqual(u'66666A6', nformat(self.n, decimal_sep='A', decimal_pos=1, grouping=1, thousand_sep='B'))\n+            self.assertEqual(u'66666', nformat(self.n, decimal_sep='X', decimal_pos=0, grouping=1, thousand_sep='Y'))\n+\n+        with self.settings(USE_L10N=True, USE_THOUSAND_SEPARATOR=True):\n+            self.assertEqual(u'66,666.66', nformat(self.n, decimal_sep='.', decimal_pos=2, grouping=3, thousand_sep=','))\n+            self.assertEqual(u'6B6B6B6B6A6', nformat(self.n, decimal_sep='A', decimal_pos=1, grouping=1, thousand_sep='B'))\n+            self.assertEqual(u'-66666.6', nformat(-66666.666, decimal_sep='.', decimal_pos=1))\n+            self.assertEqual(u'-66666.0', nformat(int('-66666'), decimal_sep='.', decimal_pos=1))\n+            self.assertEqual(u'10000.0', nformat(self.l, decimal_sep='.', decimal_pos=1))\n+\n+            # date filter\n+            self.assertEqual(u'31.12.2009 в 20:50', Template('{{ dt|date:\"d.m.Y в H:i\" }}').render(self.ctxt))\n+            self.assertEqual(u'⌚ 10:15', Template('{{ t|time:\"⌚ H:i\" }}').render(self.ctxt))\n \n     def test_l10n_disabled(self):\n         \"\"\"\n         Catalan locale with format i18n disabled translations will be used,\n         but not formats\n         \"\"\"\n         settings.USE_L10N = False\n-        activate('ca')\n-        try:\n+        with translation.override('ca', deactivate=True):\n             self.assertEqual(u'N j, Y', get_format('DATE_FORMAT'))\n             self.assertEqual(0, get_format('FIRST_DAY_OF_WEEK'))\n             self.assertEqual(u'.', get_format('DECIMAL_SEPARATOR'))\n@@ -254,19 +242,15 @@ def test_l10n_disabled(self):\n             # thousand separator and grouping when USE_L10N is False even\n             # if the USE_THOUSAND_SEPARATOR, NUMBER_GROUPING and\n             # THOUSAND_SEPARATOR settings are specified\n-            settings.USE_THOUSAND_SEPARATOR = True\n-            settings.NUMBER_GROUPING = 1\n-            settings.THOUSAND_SEPARATOR = '!'\n-            self.assertEqual(u'66666.67', Template('{{ n|floatformat:2 }}').render(self.ctxt))\n-            self.assertEqual(u'100000.0', Template('{{ f|floatformat }}').render(self.ctxt))\n-        finally:\n-            deactivate()\n+            with self.settings(USE_THOUSAND_SEPARATOR=True,\n+                    NUMBER_GROUPING=1, THOUSAND_SEPARATOR='!'):\n+                self.assertEqual(u'66666.67', Template('{{ n|floatformat:2 }}').render(self.ctxt))\n+                self.assertEqual(u'100000.0', Template('{{ f|floatformat }}').render(self.ctxt))\n \n     def test_l10n_enabled(self):\n         settings.USE_L10N = True\n         # Catalan locale\n-        activate('ca')\n-        try:\n+        with translation.override('ca', deactivate=True):\n             self.assertEqual('j \\de F \\de Y', get_format('DATE_FORMAT'))\n             self.assertEqual(1, get_format('FIRST_DAY_OF_WEEK'))\n             self.assertEqual(',', get_format('DECIMAL_SEPARATOR'))\n@@ -348,22 +332,16 @@ def test_l10n_enabled(self):\n                 u'<select name=\"mydate_day\" id=\"id_mydate_day\">\\n<option value=\"1\">1</option>\\n<option value=\"2\">2</option>\\n<option value=\"3\">3</option>\\n<option value=\"4\">4</option>\\n<option value=\"5\">5</option>\\n<option value=\"6\">6</option>\\n<option value=\"7\">7</option>\\n<option value=\"8\">8</option>\\n<option value=\"9\">9</option>\\n<option value=\"10\">10</option>\\n<option value=\"11\">11</option>\\n<option value=\"12\">12</option>\\n<option value=\"13\">13</option>\\n<option value=\"14\">14</option>\\n<option value=\"15\">15</option>\\n<option value=\"16\">16</option>\\n<option value=\"17\">17</option>\\n<option value=\"18\">18</option>\\n<option value=\"19\">19</option>\\n<option value=\"20\">20</option>\\n<option value=\"21\">21</option>\\n<option value=\"22\">22</option>\\n<option value=\"23\">23</option>\\n<option value=\"24\">24</option>\\n<option value=\"25\">25</option>\\n<option value=\"26\">26</option>\\n<option value=\"27\">27</option>\\n<option value=\"28\">28</option>\\n<option value=\"29\">29</option>\\n<option value=\"30\">30</option>\\n<option value=\"31\" selected=\"selected\">31</option>\\n</select>\\n<select name=\"mydate_month\" id=\"id_mydate_month\">\\n<option value=\"1\">gener</option>\\n<option value=\"2\">febrer</option>\\n<option value=\"3\">mar\\xe7</option>\\n<option value=\"4\">abril</option>\\n<option value=\"5\">maig</option>\\n<option value=\"6\">juny</option>\\n<option value=\"7\">juliol</option>\\n<option value=\"8\">agost</option>\\n<option value=\"9\">setembre</option>\\n<option value=\"10\">octubre</option>\\n<option value=\"11\">novembre</option>\\n<option value=\"12\" selected=\"selected\">desembre</option>\\n</select>\\n<select name=\"mydate_year\" id=\"id_mydate_year\">\\n<option value=\"2009\" selected=\"selected\">2009</option>\\n<option value=\"2010\">2010</option>\\n<option value=\"2011\">2011</option>\\n<option value=\"2012\">2012</option>\\n<option value=\"2013\">2013</option>\\n<option value=\"2014\">2014</option>\\n<option value=\"2015\">2015</option>\\n<option value=\"2016\">2016</option>\\n<option value=\"2017\">2017</option>\\n<option value=\"2018\">2018</option>\\n</select>',\n                 SelectDateWidget(years=range(2009, 2019)).render('mydate', datetime.date(2009, 12, 31))\n             )\n-        finally:\n-            deactivate()\n \n         # Russian locale (with E as month)\n-        activate('ru')\n-        try:\n+        with translation.override('ru', deactivate=True):\n             self.assertEqual(\n                     u'<select name=\"mydate_day\" id=\"id_mydate_day\">\\n<option value=\"1\">1</option>\\n<option value=\"2\">2</option>\\n<option value=\"3\">3</option>\\n<option value=\"4\">4</option>\\n<option value=\"5\">5</option>\\n<option value=\"6\">6</option>\\n<option value=\"7\">7</option>\\n<option value=\"8\">8</option>\\n<option value=\"9\">9</option>\\n<option value=\"10\">10</option>\\n<option value=\"11\">11</option>\\n<option value=\"12\">12</option>\\n<option value=\"13\">13</option>\\n<option value=\"14\">14</option>\\n<option value=\"15\">15</option>\\n<option value=\"16\">16</option>\\n<option value=\"17\">17</option>\\n<option value=\"18\">18</option>\\n<option value=\"19\">19</option>\\n<option value=\"20\">20</option>\\n<option value=\"21\">21</option>\\n<option value=\"22\">22</option>\\n<option value=\"23\">23</option>\\n<option value=\"24\">24</option>\\n<option value=\"25\">25</option>\\n<option value=\"26\">26</option>\\n<option value=\"27\">27</option>\\n<option value=\"28\">28</option>\\n<option value=\"29\">29</option>\\n<option value=\"30\">30</option>\\n<option value=\"31\" selected=\"selected\">31</option>\\n</select>\\n<select name=\"mydate_month\" id=\"id_mydate_month\">\\n<option value=\"1\">\\u042f\\u043d\\u0432\\u0430\\u0440\\u044c</option>\\n<option value=\"2\">\\u0424\\u0435\\u0432\\u0440\\u0430\\u043b\\u044c</option>\\n<option value=\"3\">\\u041c\\u0430\\u0440\\u0442</option>\\n<option value=\"4\">\\u0410\\u043f\\u0440\\u0435\\u043b\\u044c</option>\\n<option value=\"5\">\\u041c\\u0430\\u0439</option>\\n<option value=\"6\">\\u0418\\u044e\\u043d\\u044c</option>\\n<option value=\"7\">\\u0418\\u044e\\u043b\\u044c</option>\\n<option value=\"8\">\\u0410\\u0432\\u0433\\u0443\\u0441\\u0442</option>\\n<option value=\"9\">\\u0421\\u0435\\u043d\\u0442\\u044f\\u0431\\u0440\\u044c</option>\\n<option value=\"10\">\\u041e\\u043a\\u0442\\u044f\\u0431\\u0440\\u044c</option>\\n<option value=\"11\">\\u041d\\u043e\\u044f\\u0431\\u0440\\u044c</option>\\n<option value=\"12\" selected=\"selected\">\\u0414\\u0435\\u043a\\u0430\\u0431\\u0440\\u044c</option>\\n</select>\\n<select name=\"mydate_year\" id=\"id_mydate_year\">\\n<option value=\"2009\" selected=\"selected\">2009</option>\\n<option value=\"2010\">2010</option>\\n<option value=\"2011\">2011</option>\\n<option value=\"2012\">2012</option>\\n<option value=\"2013\">2013</option>\\n<option value=\"2014\">2014</option>\\n<option value=\"2015\">2015</option>\\n<option value=\"2016\">2016</option>\\n<option value=\"2017\">2017</option>\\n<option value=\"2018\">2018</option>\\n</select>',\n                     SelectDateWidget(years=range(2009, 2019)).render('mydate', datetime.date(2009, 12, 31))\n             )\n-        finally:\n-            deactivate()\n \n         # English locale\n-        activate('en')\n-        try:\n+        with translation.override('en', deactivate=True):\n             self.assertEqual('N j, Y', get_format('DATE_FORMAT'))\n             self.assertEqual(0, get_format('FIRST_DAY_OF_WEEK'))\n             self.assertEqual('.', get_format('DECIMAL_SEPARATOR'))\n@@ -426,34 +404,23 @@ def test_l10n_enabled(self):\n                 u'<select name=\"mydate_month\" id=\"id_mydate_month\">\\n<option value=\"1\">January</option>\\n<option value=\"2\">February</option>\\n<option value=\"3\">March</option>\\n<option value=\"4\">April</option>\\n<option value=\"5\">May</option>\\n<option value=\"6\">June</option>\\n<option value=\"7\">July</option>\\n<option value=\"8\">August</option>\\n<option value=\"9\">September</option>\\n<option value=\"10\">October</option>\\n<option value=\"11\">November</option>\\n<option value=\"12\" selected=\"selected\">December</option>\\n</select>\\n<select name=\"mydate_day\" id=\"id_mydate_day\">\\n<option value=\"1\">1</option>\\n<option value=\"2\">2</option>\\n<option value=\"3\">3</option>\\n<option value=\"4\">4</option>\\n<option value=\"5\">5</option>\\n<option value=\"6\">6</option>\\n<option value=\"7\">7</option>\\n<option value=\"8\">8</option>\\n<option value=\"9\">9</option>\\n<option value=\"10\">10</option>\\n<option value=\"11\">11</option>\\n<option value=\"12\">12</option>\\n<option value=\"13\">13</option>\\n<option value=\"14\">14</option>\\n<option value=\"15\">15</option>\\n<option value=\"16\">16</option>\\n<option value=\"17\">17</option>\\n<option value=\"18\">18</option>\\n<option value=\"19\">19</option>\\n<option value=\"20\">20</option>\\n<option value=\"21\">21</option>\\n<option value=\"22\">22</option>\\n<option value=\"23\">23</option>\\n<option value=\"24\">24</option>\\n<option value=\"25\">25</option>\\n<option value=\"26\">26</option>\\n<option value=\"27\">27</option>\\n<option value=\"28\">28</option>\\n<option value=\"29\">29</option>\\n<option value=\"30\">30</option>\\n<option value=\"31\" selected=\"selected\">31</option>\\n</select>\\n<select name=\"mydate_year\" id=\"id_mydate_year\">\\n<option value=\"2009\" selected=\"selected\">2009</option>\\n<option value=\"2010\">2010</option>\\n<option value=\"2011\">2011</option>\\n<option value=\"2012\">2012</option>\\n<option value=\"2013\">2013</option>\\n<option value=\"2014\">2014</option>\\n<option value=\"2015\">2015</option>\\n<option value=\"2016\">2016</option>\\n<option value=\"2017\">2017</option>\\n<option value=\"2018\">2018</option>\\n</select>',\n                 SelectDateWidget(years=range(2009, 2019)).render('mydate', datetime.date(2009, 12, 31))\n             )\n-        finally:\n-            deactivate()\n \n     def test_sub_locales(self):\n         \"\"\"\n         Check if sublocales fall back to the main locale\n         \"\"\"\n-        settings.USE_L10N = True\n-        activate('de-at')\n-        settings.USE_THOUSAND_SEPARATOR = True\n-        try:\n-            self.assertEqual(u'66.666,666', Template('{{ n }}').render(self.ctxt))\n-        finally:\n-            deactivate()\n-\n-        activate('es-us')\n-        try:\n-            self.assertEqual(u'31 de diciembre de 2009', date_format(self.d))\n-        finally:\n-            deactivate()\n+        with self.settings(USE_L10N=True, USE_THOUSAND_SEPARATOR=True):\n+            with translation.override('de-at', deactivate=True):\n+                self.assertEqual(u'66.666,666', Template('{{ n }}').render(self.ctxt))\n+            with translation.override('es-us', deactivate=True):\n+                self.assertEqual(u'31 de diciembre de 2009', date_format(self.d))\n \n     def test_localized_input(self):\n         \"\"\"\n         Tests if form input is correctly localized\n         \"\"\"\n         settings.USE_L10N = True\n-        activate('de-at')\n-        try:\n+        with translation.override('de-at', deactivate=True):\n             form6 = CompanyForm({\n                 'name': u'acme',\n                 'date_added': datetime.datetime(2009, 12, 31, 6, 0, 0),\n@@ -467,28 +434,21 @@ def test_localized_input(self):\n             )\n             self.assertEqual(localize_input(datetime.datetime(2009, 12, 31, 6, 0, 0)), '31.12.2009 06:00:00')\n             self.assertEqual(datetime.datetime(2009, 12, 31, 6, 0, 0), form6.cleaned_data['date_added'])\n-            settings.USE_THOUSAND_SEPARATOR = True\n-            # Checking for the localized \"products_delivered\" field\n-            self.assertTrue(u'<input type=\"text\" name=\"products_delivered\" value=\"12.000\" id=\"id_products_delivered\" />' in form6.as_ul())\n-        finally:\n-            deactivate()\n+            with self.settings(USE_THOUSAND_SEPARATOR=True):\n+                # Checking for the localized \"products_delivered\" field\n+                self.assertTrue(u'<input type=\"text\" name=\"products_delivered\" value=\"12.000\" id=\"id_products_delivered\" />' in form6.as_ul())\n \n     def test_iter_format_modules(self):\n         \"\"\"\n         Tests the iter_format_modules function.\n         \"\"\"\n-        activate('de-at')\n-        old_format_module_path = settings.FORMAT_MODULE_PATH\n-        try:\n-            settings.USE_L10N = True\n+        settings.USE_L10N = True\n+        with translation.override('de-at', deactivate=True):\n             de_format_mod = import_module('django.conf.locale.de.formats')\n             self.assertEqual(list(iter_format_modules('de')), [de_format_mod])\n-            settings.FORMAT_MODULE_PATH = 'regressiontests.i18n.other.locale'\n-            test_de_format_mod = import_module('regressiontests.i18n.other.locale.de.formats')\n-            self.assertEqual(list(iter_format_modules('de')), [test_de_format_mod, de_format_mod])\n-        finally:\n-            settings.FORMAT_MODULE_PATH = old_format_module_path\n-            deactivate()\n+            with self.settings(FORMAT_MODULE_PATH='regressiontests.i18n.other.locale'):\n+                test_de_format_mod = import_module('regressiontests.i18n.other.locale.de.formats')\n+                self.assertEqual(list(iter_format_modules('de')), [test_de_format_mod, de_format_mod])\n \n     def test_iter_format_modules_stability(self):\n         \"\"\"\n@@ -501,17 +461,12 @@ def test_iter_format_modules_stability(self):\n         self.assertEqual(list(iter_format_modules('en-gb')), [en_gb_format_mod, en_format_mod])\n \n     def test_get_format_modules_stability(self):\n-        activate('de')\n-        old_format_module_path = settings.FORMAT_MODULE_PATH\n-        settings.FORMAT_MODULE_PATH = 'regressiontests.i18n.other.locale'\n-        try:\n-            settings.USE_L10N = True\n-            old = \"%r\" % get_format_modules(reverse=True)\n-            new = \"%r\" % get_format_modules(reverse=True) # second try\n-            self.assertEqual(new, old, 'Value returned by get_formats_modules() must be preserved between calls.')\n-        finally:\n-            settings.FORMAT_MODULE_PATH = old_format_module_path\n-            deactivate()\n+        with self.settings(USE_L10N=True,\n+                FORMAT_MODULE_PATH='regressiontests.i18n.other.locale'):\n+            with translation.override('de', deactivate=True):\n+                old = \"%r\" % get_format_modules(reverse=True)\n+                new = \"%r\" % get_format_modules(reverse=True) # second try\n+                self.assertEqual(new, old, 'Value returned by get_formats_modules() must be preserved between calls.')\n \n     def test_localize_templatetag_and_filter(self):\n         \"\"\"\n@@ -526,19 +481,14 @@ def test_localize_templatetag_and_filter(self):\n         output2 = '3,14;3.14;3,14'\n         output3 = '3,14;3.14'\n         output4 = '3.14;3,14'\n-        old_localize = settings.USE_L10N\n-        try:\n-            activate('de')\n-            settings.USE_L10N = False\n-            self.assertEqual(template1.render(context), output1)\n-            self.assertEqual(template4.render(context), output4)\n-            settings.USE_L10N = True\n-            self.assertEqual(template1.render(context), output1)\n-            self.assertEqual(template2.render(context), output2)\n-            self.assertEqual(template3.render(context), output3)\n-        finally:\n-            deactivate()\n-            settings.USE_L10N = old_localize\n+        with translation.override('de', deactivate=True):\n+            with self.settings(USE_L10N=False):\n+                self.assertEqual(template1.render(context), output1)\n+                self.assertEqual(template4.render(context), output4)\n+            with self.settings(USE_L10N=True):\n+                self.assertEqual(template1.render(context), output1)\n+                self.assertEqual(template2.render(context), output2)\n+                self.assertEqual(template3.render(context), output3)\n \n class MiscTests(TestCase):\n \n@@ -696,20 +646,13 @@ def test_locale_paths_translation(self):\n         self.assertUgettext('Time', 'LOCALE_PATHS')\n \n     def test_locale_paths_override_app_translation(self):\n-        old_installed_apps = settings.INSTALLED_APPS\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS) + ['regressiontests.i18n.resolution']\n-        try:\n+        extended_apps = list(settings.INSTALLED_APPS) + ['regressiontests.i18n.resolution']\n+        with self.settings(INSTALLED_APPS=extended_apps):\n             self.assertUgettext('Time', 'LOCALE_PATHS')\n-        finally:\n-            settings.INSTALLED_APPS = old_installed_apps\n \n     def test_locale_paths_override_project_translation(self):\n-        old_settings_module = settings.SETTINGS_MODULE\n-        settings.SETTINGS_MODULE = 'regressiontests'\n-        try:\n+        with self.settings(SETTINGS_MODULE='regressiontests'):\n             self.assertUgettext('Date/time', 'LOCALE_PATHS')\n-        finally:\n-            settings.SETTINGS_MODULE = old_settings_module\n \n class ProjectResolutionOrderI18NTests(ResolutionOrderI18NTests):\n \n@@ -726,12 +669,9 @@ def test_project_translation(self):\n         self.assertUgettext('Date/time', 'PROJECT')\n \n     def test_project_override_app_translation(self):\n-        old_installed_apps = settings.INSTALLED_APPS\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS) + ['regressiontests.i18n.resolution']\n-        try:\n+        extended_apps = list(settings.INSTALLED_APPS) + ['regressiontests.i18n.resolution']\n+        with self.settings(INSTALLED_APPS=extended_apps):\n             self.assertUgettext('Date/time', 'PROJECT')\n-        finally:\n-            settings.INSTALLED_APPS = old_installed_apps\n \n class DjangoFallbackResolutionOrderI18NTests(ResolutionOrderI18NTests):\n \n@@ -776,117 +716,113 @@ def test_single_locale_activation(self):\n         \"\"\"\n         Simple baseline behavior with one locale for all the supported i18n constructs.\n         \"\"\"\n-        activate('fr')\n-        self.assertEqual(Template(\"{{ _('Yes') }}\").render(Context({})), 'Oui')\n-        self.assertEqual(Template(\"{% load i18n %}{% trans 'Yes' %}\").render(Context({})), 'Oui')\n-        self.assertEqual(Template(\"{% load i18n %}{% blocktrans %}Yes{% endblocktrans %}\").render(Context({})), 'Oui')\n+        with translation.override('fr'):\n+            self.assertEqual(Template(\"{{ _('Yes') }}\").render(Context({})), 'Oui')\n+            self.assertEqual(Template(\"{% load i18n %}{% trans 'Yes' %}\").render(Context({})), 'Oui')\n+            self.assertEqual(Template(\"{% load i18n %}{% blocktrans %}Yes{% endblocktrans %}\").render(Context({})), 'Oui')\n \n     # Literal marked up with _() in a filter expression\n \n     def test_multiple_locale_filter(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{{ 0|yesno:_('yes,no,maybe') }}\")\n-        activate(self._old_language)\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{{ 0|yesno:_('yes,no,maybe') }}\")\n+        with translation.override(self._old_language):\n+            with translation.override('nl'):\n+                self.assertEqual(t.render(Context({})), 'nee')\n \n     def test_multiple_locale_filter_deactivate(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{{ 0|yesno:_('yes,no,maybe') }}\")\n-        deactivate()\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'nee')\n+        with translation.override('de', deactivate=True):\n+            t = Template(\"{% load i18n %}{{ 0|yesno:_('yes,no,maybe') }}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'nee')\n \n     def test_multiple_locale_filter_direct_switch(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{{ 0|yesno:_('yes,no,maybe') }}\")\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{{ 0|yesno:_('yes,no,maybe') }}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'nee')\n \n     # Literal marked up with _()\n \n     def test_multiple_locale(self):\n-        activate('de')\n-        t = Template(\"{{ _('No') }}\")\n-        activate(self._old_language)\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{{ _('No') }}\")\n+        with translation.override(self._old_language):\n+            with translation.override('nl'):\n+                self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_deactivate(self):\n-        activate('de')\n-        t = Template(\"{{ _('No') }}\")\n-        deactivate()\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de', deactivate=True):\n+            t = Template(\"{{ _('No') }}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_direct_switch(self):\n-        activate('de')\n-        t = Template(\"{{ _('No') }}\")\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{{ _('No') }}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     # Literal marked up with _(), loading the i18n template tag library\n \n     def test_multiple_locale_loadi18n(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{{ _('No') }}\")\n-        activate(self._old_language)\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{{ _('No') }}\")\n+        with translation.override(self._old_language):\n+            with translation.override('nl'):\n+                self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_loadi18n_deactivate(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{{ _('No') }}\")\n-        deactivate()\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de', deactivate=True):\n+            t = Template(\"{% load i18n %}{{ _('No') }}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_loadi18n_direct_switch(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{{ _('No') }}\")\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{{ _('No') }}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     # trans i18n tag\n \n     def test_multiple_locale_trans(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{% trans 'No' %}\")\n-        activate(self._old_language)\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{% trans 'No' %}\")\n+        with translation.override(self._old_language):\n+            with translation.override('nl'):\n+                self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_deactivate_trans(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{% trans 'No' %}\")\n-        deactivate()\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de', deactivate=True):\n+            t = Template(\"{% load i18n %}{% trans 'No' %}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_direct_switch_trans(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{% trans 'No' %}\")\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{% trans 'No' %}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     # blocktrans i18n tag\n \n     def test_multiple_locale_btrans(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n-        activate(self._old_language)\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n+        with translation.override(self._old_language):\n+            with translation.override('nl'):\n+                self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_deactivate_btrans(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n-        deactivate()\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de', deactivate=True):\n+            t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n \n     def test_multiple_locale_direct_switch_btrans(self):\n-        activate('de')\n-        t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n-        activate('nl')\n-        self.assertEqual(t.render(Context({})), 'Nee')\n+        with translation.override('de'):\n+            t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n+        with translation.override('nl'):\n+            self.assertEqual(t.render(Context({})), 'Nee')\n+"
        },
        {
            "sha": "6395d2363e26f64dd061d56e0a54f112e4027e55",
            "filename": "tests/regressiontests/text/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Ftext%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Ftext%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftext%2Ftests.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -4,7 +4,7 @@\n from django.utils.text import *\n from django.utils.http import urlquote, urlquote_plus, cookie_date, http_date\n from django.utils.encoding import iri_to_uri\n-from django.utils.translation import activate, deactivate\n+from django.utils.translation import override\n \n class TextTests(TestCase):\n     \"\"\"\n@@ -17,9 +17,8 @@ def test_get_text_list(self):\n         self.assertEqual(get_text_list(['a', 'b'], 'and'), u'a and b')\n         self.assertEqual(get_text_list(['a']), u'a')\n         self.assertEqual(get_text_list([]), u'')\n-        activate('ar')\n-        self.assertEqual(get_text_list(['a', 'b', 'c']), u\"a، b أو c\")\n-        deactivate()\n+        with override('ar'):\n+            self.assertEqual(get_text_list(['a', 'b', 'c']), u\"a، b أو c\")\n \n     def test_smart_split(self):\n "
        },
        {
            "sha": "ce40448393b0a2de6b1099a9a2f75ca147ed10c5",
            "filename": "tests/regressiontests/views/tests/i18n.py",
            "status": "modified",
            "additions": 40,
            "deletions": 58,
            "changes": 98,
            "blob_url": "https://github.com/django/django/blob/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fviews%2Ftests%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/7dd72360a2ab3a3a7ca74922da670c7361a9abb3/tests%2Fregressiontests%2Fviews%2Ftests%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fi18n.py?ref=7dd72360a2ab3a3a7ca74922da670c7361a9abb3",
            "patch": "@@ -4,7 +4,7 @@\n \n from django.conf import settings\n from django.test import TestCase\n-from django.utils.translation import activate, deactivate\n+from django.utils.translation import override, activate\n from django.utils.text import javascript_quote\n \n from regressiontests.views.urls import locale_dir\n@@ -42,15 +42,6 @@ class JsI18NTests(TestCase):\n     settings.LANGUAGE_CODE.\n     \"\"\"\n \n-    def setUp(self):\n-        self.old_language_code = settings.LANGUAGE_CODE\n-        self.old_installed_apps = settings.INSTALLED_APPS\n-\n-    def tearDown(self):\n-        deactivate()\n-        settings.LANGUAGE_CODE = self.old_language_code\n-        settings.INSTALLED_APPS = self.old_installed_apps\n-\n     def test_jsi18n_with_missing_en_files(self):\n         \"\"\"\n         The javascript_catalog shouldn't load the fallback language in the\n@@ -61,20 +52,20 @@ def test_jsi18n_with_missing_en_files(self):\n         languages and you've set settings.LANGUAGE_CODE to some other language\n         than English.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'es'\n-        activate('en-us')\n-        response = self.client.get('/views/jsi18n/')\n-        self.assertNotContains(response, 'esto tiene que ser traducido')\n+        with self.settings(LANGUAGE_CODE='es'):\n+            with override('en-us'):\n+                response = self.client.get('/views/jsi18n/')\n+                self.assertNotContains(response, 'esto tiene que ser traducido')\n \n     def test_jsi18n_fallback_language(self):\n         \"\"\"\n         Let's make sure that the fallback language is still working properly\n         in cases where the selected language cannot be found.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        activate('fi')\n-        response = self.client.get('/views/jsi18n/')\n-        self.assertContains(response, 'il faut le traduire')\n+        with self.settings(LANGUAGE_CODE='fr'):\n+            with override('fi'):\n+                response = self.client.get('/views/jsi18n/')\n+                self.assertContains(response, 'il faut le traduire')\n \n     def testI18NLanguageNonEnglishDefault(self):\n         \"\"\"\n@@ -83,48 +74,39 @@ def testI18NLanguageNonEnglishDefault(self):\n         is English and there is not 'en' translation available. See #13388,\n         #3594 and #13726 for more details.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        activate('en-us')\n-        response = self.client.get('/views/jsi18n/')\n-        self.assertNotContains(response, 'Choisir une heure')\n+        with self.settings(LANGUAGE_CODE='fr'):\n+            with override('en-us'):\n+                response = self.client.get('/views/jsi18n/')\n+                self.assertNotContains(response, 'Choisir une heure')\n \n     def test_nonenglish_default_english_userpref(self):\n         \"\"\"\n         Same as above with the difference that there IS an 'en' translation\n         available. The Javascript i18n view must return a NON empty language catalog\n         with the proper English translations. See #13726 for more details.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS) + ['regressiontests.views.app0']\n-        activate('en-us')\n-        response = self.client.get('/views/jsi18n_english_translation/')\n-        self.assertContains(response, javascript_quote('this app0 string is to be translated'))\n+        extended_apps = list(settings.INSTALLED_APPS) + ['regressiontests.views.app0']\n+        with self.settings(LANGUAGE_CODE='fr', INSTALLED_APPS=extended_apps):\n+            with override('en-us'):\n+                response = self.client.get('/views/jsi18n_english_translation/')\n+                self.assertContains(response, javascript_quote('this app0 string is to be translated'))\n \n     def testI18NLanguageNonEnglishFallback(self):\n         \"\"\"\n         Makes sure that the fallback language is still working properly\n         in cases where the selected language cannot be found.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        activate('none')\n-        response = self.client.get('/views/jsi18n/')\n-        self.assertContains(response, 'Choisir une heure')\n+        with self.settings(LANGUAGE_CODE='fr'):\n+            with override('none'):\n+                response = self.client.get('/views/jsi18n/')\n+                self.assertContains(response, 'Choisir une heure')\n \n \n class JsI18NTestsMultiPackage(TestCase):\n     \"\"\"\n     Tests for django views in django/views/i18n.py that need to change\n     settings.LANGUAGE_CODE and merge JS translation from several packages.\n     \"\"\"\n-\n-    def setUp(self):\n-        self.old_language_code = settings.LANGUAGE_CODE\n-        self.old_installed_apps = settings.INSTALLED_APPS\n-\n-    def tearDown(self):\n-        settings.LANGUAGE_CODE = self.old_language_code\n-        settings.INSTALLED_APPS = self.old_installed_apps\n-\n     def testI18NLanguageEnglishDefault(self):\n         \"\"\"\n         Check if the JavaScript i18n view returns a complete language catalog\n@@ -133,29 +115,29 @@ def testI18NLanguageEnglishDefault(self):\n         translations of multiple Python packages is requested. See #13388,\n         #3594 and #13514 for more details.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'en-us'\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS) + ['regressiontests.views.app1', 'regressiontests.views.app2']\n-        activate('fr')\n-        response = self.client.get('/views/jsi18n_multi_packages1/')\n-        self.assertContains(response, javascript_quote('il faut traduire cette chaîne de caractères de app1'))\n-        deactivate()\n+        extended_apps = list(settings.INSTALLED_APPS) + ['regressiontests.views.app1', 'regressiontests.views.app2']\n+        with self.settings(LANGUAGE_CODE='en-us', INSTALLED_APPS=extended_apps):\n+            with override('fr'):\n+                response = self.client.get('/views/jsi18n_multi_packages1/')\n+                self.assertContains(response, javascript_quote('il faut traduire cette chaîne de caractères de app1'))\n \n     def testI18NDifferentNonEnLangs(self):\n         \"\"\"\n         Similar to above but with neither default or requested language being\n         English.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS) + ['regressiontests.views.app3', 'regressiontests.views.app4']\n-        activate('es-ar')\n-        response = self.client.get('/views/jsi18n_multi_packages2/')\n-        self.assertContains(response, javascript_quote('este texto de app3 debe ser traducido'))\n-        deactivate()\n+        extended_apps = list(settings.INSTALLED_APPS) + ['regressiontests.views.app3', 'regressiontests.views.app4']\n+        with self.settings(LANGUAGE_CODE='fr', INSTALLED_APPS=extended_apps):\n+            with override('es-ar'):\n+                response = self.client.get('/views/jsi18n_multi_packages2/')\n+                self.assertContains(response, javascript_quote('este texto de app3 debe ser traducido'))\n \n     def testI18NWithLocalePaths(self):\n-        settings.LANGUAGE_CODE = 'es-ar'\n-        self.old_locale_paths = settings.LOCALE_PATHS\n-        settings.LOCALE_PATHS += (path.join(path.dirname(path.dirname(path.abspath(__file__))), 'app3', 'locale'),)\n-        response = self.client.get('/views/jsi18n/')\n-        self.assertContains(response, javascript_quote('este texto de app3 debe ser traducido'))\n-        settings.LOCALE_PATHS = self.old_locale_paths\n+        extended_locale_paths = settings.LOCALE_PATHS + (\n+            path.join(path.dirname(\n+                path.dirname(path.abspath(__file__))), 'app3', 'locale'),)\n+        with self.settings(LANGUAGE_CODE='es-ar', LOCALE_PATHS=extended_locale_paths):\n+            with override('es-ar'):\n+                response = self.client.get('/views/jsi18n/')\n+                self.assertContains(response,\n+                    javascript_quote('este texto de app3 debe ser traducido'))"
        }
    ],
    "stats": {
        "total": 591,
        "additions": 242,
        "deletions": 349
    }
}