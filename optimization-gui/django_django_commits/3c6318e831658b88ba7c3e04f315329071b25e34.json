{
    "author": "akaariai",
    "message": "Fixed #19870 -- Regression in select_related in inheritance cases\n\nThere was a regression in case two models inherited the same parent,\nand one contained a foreign key to other. When select_related travelled\nthe foreign key the other model reused the parent join made by the\nfirst model. This was likely caused by Query.join_parent_model()\naddition in commit 68985db48212c701a3d975636123a5d79bdc006f.\n\nThanks to Trac alias loic84 for report & tests.",
    "sha": "3c6318e831658b88ba7c3e04f315329071b25e34",
    "files": [
        {
            "sha": "22d025ecb2ede803a7b9f346fccf79d705ef1f76",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/3c6318e831658b88ba7c3e04f315329071b25e34/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/3c6318e831658b88ba7c3e04f315329071b25e34/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=3c6318e831658b88ba7c3e04f315329071b25e34",
            "patch": "@@ -265,14 +265,19 @@ def get_default_columns(self, with_aliases=False, col_aliases=None,\n         qn2 = self.connection.ops.quote_name\n         aliases = set()\n         only_load = self.deferred_to_columns()\n-        seen = self.query.included_inherited_models.copy()\n-        if start_alias:\n-            seen[None] = start_alias\n+        if not start_alias:\n+            start_alias = self.query.get_initial_alias()\n+        # The 'seen_models' is used to optimize checking the needed parent\n+        # alias for a given field. This also includes None -> start_alias to\n+        # be used by local fields.\n+        seen_models = {None: start_alias}\n+\n         for field, model in opts.get_fields_with_model():\n             if from_parent and model is not None and issubclass(from_parent, model):\n                 # Avoid loading data for already loaded parents.\n                 continue\n-            alias = self.query.join_parent_model(opts, model, start_alias, seen)\n+            alias = self.query.join_parent_model(opts, model, start_alias,\n+                                                 seen_models)\n             table = self.query.alias_map[alias].table_name\n             if table in only_load and field.column not in only_load[table]:\n                 continue"
        },
        {
            "sha": "620b8eb5eac116f3411c358d78ff64fe46c1ac12",
            "filename": "tests/regressiontests/select_related_regress/models.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/3c6318e831658b88ba7c3e04f315329071b25e34/tests%2Fregressiontests%2Fselect_related_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/3c6318e831658b88ba7c3e04f315329071b25e34/tests%2Fregressiontests%2Fselect_related_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fselect_related_regress%2Fmodels.py?ref=3c6318e831658b88ba7c3e04f315329071b25e34",
            "patch": "@@ -94,3 +94,17 @@ class Item(models.Model):\n \n     def __str__(self):\n         return self.name\n+\n+# Models for testing bug #19870.\n+@python_2_unicode_compatible\n+class Fowl(models.Model):\n+    name = models.CharField(max_length=10)\n+\n+    def __str__(self):\n+        return self.name\n+\n+class Hen(Fowl):\n+    pass\n+\n+class Chick(Fowl):\n+    mother = models.ForeignKey(Hen)"
        },
        {
            "sha": "f6d21b2dd9c25d14ebae4534565ed2b241b24002",
            "filename": "tests/regressiontests/select_related_regress/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/3c6318e831658b88ba7c3e04f315329071b25e34/tests%2Fregressiontests%2Fselect_related_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3c6318e831658b88ba7c3e04f315329071b25e34/tests%2Fregressiontests%2Fselect_related_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fselect_related_regress%2Ftests.py?ref=3c6318e831658b88ba7c3e04f315329071b25e34",
            "patch": "@@ -5,7 +5,7 @@\n \n from .models import (Building, Child, Device, Port, Item, Country, Connection,\n     ClientStatus, State, Client, SpecialClient, TUser, Person, Student,\n-    Organizer, Class, Enrollment)\n+    Organizer, Class, Enrollment, Hen, Chick)\n \n \n class SelectRelatedRegressTests(TestCase):\n@@ -162,3 +162,14 @@ def test_null_join_promotion(self):\n             # The select_related join was promoted as there is already an\n             # existing join.\n             self.assertTrue('LEFT OUTER' in str(qs.query))\n+\n+    def test_regression_19870(self):\n+        \"\"\"\n+        Regression for #19870\n+\n+        \"\"\"\n+        hen = Hen.objects.create(name='Hen')\n+        chick = Chick.objects.create(name='Chick', mother=hen)\n+\n+        self.assertEqual(Chick.objects.all()[0].mother.name, 'Hen')\n+        self.assertEqual(Chick.objects.select_related()[0].mother.name, 'Hen')"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 35,
        "deletions": 5
    }
}