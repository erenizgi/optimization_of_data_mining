{
    "author": "slurms",
    "message": "Fixed #19360 -- Raised an explicit exception for aggregates on date/time fields in sqlite3\n\nThanks lsaffre for the report and Chris Medrela for the initial\npatch.",
    "sha": "eb6c107624930c97390185fdbf7f887c50665808",
    "files": [
        {
            "sha": "f4fd1cc379a53020fd47fc31dc45fd88e634ba4c",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/eb6c107624930c97390185fdbf7f887c50665808/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/eb6c107624930c97390185fdbf7f887c50665808/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=eb6c107624930c97390185fdbf7f887c50665808",
            "patch": "@@ -18,6 +18,8 @@\n from django.db.backends.sqlite3.client import DatabaseClient\n from django.db.backends.sqlite3.creation import DatabaseCreation\n from django.db.backends.sqlite3.introspection import DatabaseIntrospection\n+from django.db.models import fields\n+from django.db.models.sql import aggregates\n from django.utils.dateparse import parse_date, parse_datetime, parse_time\n from django.utils.functional import cached_property\n from django.utils.safestring import SafeBytes\n@@ -127,6 +129,17 @@ def bulk_batch_size(self, fields, objs):\n         limit = 999 if len(fields) > 1 else 500\n         return (limit // len(fields)) if len(fields) > 0 else len(objs)\n \n+    def check_aggregate_support(self, aggregate):\n+        bad_fields = (fields.DateField, fields.DateTimeField, fields.TimeField)\n+        bad_aggregates = (aggregates.Sum, aggregates.Avg,\n+                          aggregates.Variance, aggregates.StdDev)\n+        if (isinstance(aggregate.source, bad_fields) and\n+                isinstance(aggregate, bad_aggregates)):\n+            raise NotImplementedError(\n+                'You cannot use Sum, Avg, StdDev and Variance aggregations '\n+                'on date/time fields in sqlite3 '\n+                'since date/time is saved as text.')\n+\n     def date_extract_sql(self, lookup_type, field_name):\n         # sqlite doesn't support extract, so we fake it with the user-defined\n         # function django_extract that's registered in connect(). Note that"
        },
        {
            "sha": "71049703c90ec7af3ecd1a9917f9a8bed9715ce8",
            "filename": "docs/ref/models/querysets.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/eb6c107624930c97390185fdbf7f887c50665808/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/eb6c107624930c97390185fdbf7f887c50665808/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Fquerysets.txt?ref=eb6c107624930c97390185fdbf7f887c50665808",
            "patch": "@@ -2188,6 +2188,14 @@ Django provides the following aggregation functions in the\n aggregate functions, see\n :doc:`the topic guide on aggregation </topics/db/aggregation>`.\n \n+.. warning::\n+\n+    SQLite can't handle aggregation on date/time fields out of the box.\n+    This is because there are no native date/time fields in SQLite and Django\n+    currently emulates these features using a text field. Attempts to use\n+    aggregation on date/time fields in SQLite will raise\n+    ``NotImplementedError``.\n+\n Avg\n ~~~\n "
        },
        {
            "sha": "a92aa71e1747f315a510a4372a1ae0426e3fd905",
            "filename": "tests/regressiontests/backends/models.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/eb6c107624930c97390185fdbf7f887c50665808/tests%2Fregressiontests%2Fbackends%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/eb6c107624930c97390185fdbf7f887c50665808/tests%2Fregressiontests%2Fbackends%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Fmodels.py?ref=eb6c107624930c97390185fdbf7f887c50665808",
            "patch": "@@ -75,3 +75,14 @@ class Article(models.Model):\n \n     def __str__(self):\n         return self.headline\n+\n+\n+@python_2_unicode_compatible\n+class Item(models.Model):\n+    name = models.CharField(max_length=30)\n+    date = models.DateField()\n+    time = models.TimeField()\n+    last_modified = models.DateTimeField()\n+\n+    def __str__(self):\n+        return self.name"
        },
        {
            "sha": "b29384739d8aff3ce60c05412567ef8f35f07f14",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/eb6c107624930c97390185fdbf7f887c50665808/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/eb6c107624930c97390185fdbf7f887c50665808/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=eb6c107624930c97390185fdbf7f887c50665808",
            "patch": "@@ -12,6 +12,7 @@\n     IntegrityError, transaction)\n from django.db.backends.signals import connection_created\n from django.db.backends.postgresql_psycopg2 import version as pg_version\n+from django.db.models import fields, Sum, Avg, Variance, StdDev\n from django.db.utils import ConnectionHandler, DatabaseError, load_backend\n from django.test import (TestCase, skipUnlessDBFeature, skipIfDBFeature,\n     TransactionTestCase)\n@@ -362,6 +363,22 @@ def test_parameter_escaping(self):\n         self.assertTrue(int(response))\n \n \n+class SqlliteAggregationTests(TestCase):\n+    \"\"\"\n+    #19360: Raise NotImplementedError when aggregating on date/time fields.\n+    \"\"\"\n+    @unittest.skipUnless(connection.vendor == 'sqlite',\n+                         \"No need to check SQLite aggregation semantics\")\n+    def test_aggregation(self):\n+        for aggregate in (Sum, Avg, Variance, StdDev):\n+            self.assertRaises(NotImplementedError,\n+                models.Item.objects.all().aggregate, aggregate('time'))\n+            self.assertRaises(NotImplementedError,\n+                models.Item.objects.all().aggregate, aggregate('date'))\n+            self.assertRaises(NotImplementedError,\n+                models.Item.objects.all().aggregate, aggregate('last_modified'))\n+\n+\n class BackendTestCase(TestCase):\n \n     def create_squares_with_executemany(self, args):\n@@ -400,7 +417,6 @@ def test_cursor_executemany_with_iterator(self):\n             self.create_squares_with_executemany(args)\n         self.assertEqual(models.Square.objects.count(), 9)\n \n-\n     def test_unicode_fetches(self):\n         #6254: fetchone, fetchmany, fetchall return strings as unicode objects\n         qn = connection.ops.quote_name"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 49,
        "deletions": 1
    }
}