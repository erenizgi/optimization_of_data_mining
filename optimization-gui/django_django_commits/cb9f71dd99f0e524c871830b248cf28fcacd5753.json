{
    "author": "claudep",
    "message": "Fixed #18640 -- Allowed access to GDAL Feature without Datasource\n\nThanks Justin Bronn for improving my initial patch.",
    "sha": "cb9f71dd99f0e524c871830b248cf28fcacd5753",
    "files": [
        {
            "sha": "cf154d74b868c596d88aeb839a6b76d68839edd4",
            "filename": "django/contrib/gis/gdal/feature.py",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py",
            "raw_url": "https://github.com/django/django/raw/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py?ref=cb9f71dd99f0e524c871830b248cf28fcacd5753",
            "patch": "@@ -16,15 +16,21 @@\n #\n # The OGR_F_* routines are relevant here.\n class Feature(GDALBase):\n-    \"A class that wraps an OGR Feature, needs to be instantiated from a Layer object.\"\n+    \"\"\"\n+    This class that wraps an OGR Feature, needs to be instantiated\n+    from a Layer object.\n+    \"\"\"\n \n     #### Python 'magic' routines ####\n-    def __init__(self, feat, fdefn):\n-        \"Initializes on the pointers for the feature and the layer definition.\"\n-        if not feat or not fdefn:\n+    def __init__(self, feat, layer):\n+        \"\"\"\n+        Initializes on the feature pointers for the feature and the layer\n+        definition, as well as the Layer.\n+        \"\"\"\n+        if not feat:\n             raise OGRException('Cannot create OGR Feature, invalid pointer given.')\n         self.ptr = feat\n-        self._fdefn = fdefn\n+        self._layer = layer\n \n     def __del__(self):\n         \"Releases a reference to this object.\"\n@@ -43,7 +49,7 @@ def __getitem__(self, index):\n             if index < 0 or index > self.num_fields:\n                 raise OGRIndexError('index out of range')\n             i = index\n-        return Field(self.ptr, i)\n+        return Field(self, i)\n \n     def __iter__(self):\n         \"Iterates over each field in the Feature.\"\n@@ -71,7 +77,7 @@ def fid(self):\n     @property\n     def layer_name(self):\n         \"Returns the name of the layer for the feature.\"\n-        return capi.get_feat_name(self._fdefn)\n+        return capi.get_feat_name(self._layer._ldefn)\n \n     @property\n     def num_fields(self):\n@@ -81,7 +87,7 @@ def num_fields(self):\n     @property\n     def fields(self):\n         \"Returns a list of fields in the Feature.\"\n-        return [capi.get_field_name(capi.get_field_defn(self._fdefn, i))\n+        return [capi.get_field_name(capi.get_field_defn(self._layer._ldefn, i))\n                 for i in xrange(self.num_fields)]\n \n     @property\n@@ -94,7 +100,7 @@ def geom(self):\n     @property\n     def geom_type(self):\n         \"Returns the OGR Geometry Type for this Feture.\"\n-        return OGRGeomType(capi.get_fd_geom_type(self._fdefn))\n+        return OGRGeomType(capi.get_fd_geom_type(self._layer._ldefn))\n \n     #### Feature Methods ####\n     def get(self, field):"
        },
        {
            "sha": "16230afdc8b8122a13b79ba25f40d8869aa9989a",
            "filename": "django/contrib/gis/gdal/field.py",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py",
            "raw_url": "https://github.com/django/django/raw/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py?ref=cb9f71dd99f0e524c871830b248cf28fcacd5753",
            "patch": "@@ -9,20 +9,23 @@\n #\n # The OGR_Fld_* routines are relevant here.\n class Field(GDALBase):\n-    \"A class that wraps an OGR Field, needs to be instantiated from a Feature object.\"\n+    \"\"\"\n+    This class wraps an OGR Field, and needs to be instantiated\n+    from a Feature object.\n+    \"\"\"\n \n     #### Python 'magic' routines ####\n     def __init__(self, feat, index):\n         \"\"\"\n-        Initializes on the feature pointer and the integer index of\n+        Initializes on the feature object and the integer index of\n         the field within the feature.\n         \"\"\"\n         # Setting the feature pointer and index.\n         self._feat = feat\n         self._index = index\n \n         # Getting the pointer for this field.\n-        fld_ptr = capi.get_feat_field_defn(feat, index)\n+        fld_ptr = capi.get_feat_field_defn(feat.ptr, index)\n         if not fld_ptr:\n             raise OGRException('Cannot create OGR Field, invalid pointer given.')\n         self.ptr = fld_ptr\n@@ -42,21 +45,22 @@ def __str__(self):\n     #### Field Methods ####\n     def as_double(self):\n         \"Retrieves the Field's value as a double (float).\"\n-        return capi.get_field_as_double(self._feat, self._index)\n+        return capi.get_field_as_double(self._feat.ptr, self._index)\n \n     def as_int(self):\n         \"Retrieves the Field's value as an integer.\"\n-        return capi.get_field_as_integer(self._feat, self._index)\n+        return capi.get_field_as_integer(self._feat.ptr, self._index)\n \n     def as_string(self):\n         \"Retrieves the Field's value as a string.\"\n-        return capi.get_field_as_string(self._feat, self._index)\n+        return capi.get_field_as_string(self._feat.ptr, self._index)\n \n     def as_datetime(self):\n         \"Retrieves the Field's value as a tuple of date & time components.\"\n         yy, mm, dd, hh, mn, ss, tz = [c_int() for i in range(7)]\n-        status = capi.get_field_as_datetime(self._feat, self._index, byref(yy), byref(mm), byref(dd),\n-                                            byref(hh), byref(mn), byref(ss), byref(tz))\n+        status = capi.get_field_as_datetime(\n+            self._feat.ptr, self._index, byref(yy), byref(mm), byref(dd),\n+            byref(hh), byref(mn), byref(ss), byref(tz))\n         if status:\n             return (yy, mm, dd, hh, mn, ss, tz)\n         else:"
        },
        {
            "sha": "da0f5669690842ce5d2c647e4dfaa6e6e10304ba",
            "filename": "django/contrib/gis/gdal/layer.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py",
            "raw_url": "https://github.com/django/django/raw/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py?ref=cb9f71dd99f0e524c871830b248cf28fcacd5753",
            "patch": "@@ -61,7 +61,7 @@ def __iter__(self):\n         # ResetReading() must be called before iteration is to begin.\n         capi.reset_reading(self._ptr)\n         for i in xrange(self.num_feat):\n-            yield Feature(capi.get_next_feature(self._ptr), self._ldefn)\n+            yield Feature(capi.get_next_feature(self._ptr), self)\n \n     def __len__(self):\n         \"The length is the number of features.\"\n@@ -81,7 +81,7 @@ def _make_feature(self, feat_id):\n         if self._random_read:\n             # If the Layer supports random reading, return.\n             try:\n-                return Feature(capi.get_feature(self.ptr, feat_id), self._ldefn)\n+                return Feature(capi.get_feature(self.ptr, feat_id), self)\n             except OGRException:\n                 pass\n         else:"
        },
        {
            "sha": "9ac1bc8d70a73b1b8dbeb52c10ee01ebd1ca9e1e",
            "filename": "django/contrib/gis/gdal/tests/test_ds.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "raw_url": "https://github.com/django/django/raw/cb9f71dd99f0e524c871830b248cf28fcacd5753/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py?ref=cb9f71dd99f0e524c871830b248cf28fcacd5753",
            "patch": "@@ -125,7 +125,10 @@ def test03b_layer_slice(self):\n             self.assertEqual(control_vals, test_vals)\n \n     def test03c_layer_references(self):\n-        \"Test to make sure Layer access is still available without the DataSource.\"\n+        \"\"\"\n+        Test to make sure Layer/Feature access is still available without\n+        the DataSource/Feature.\n+        \"\"\"\n         source = ds_list[0]\n \n         # See ticket #9448.\n@@ -141,6 +144,9 @@ def get_layer():\n         self.assertEqual(source.nfeat, len(lyr))\n         self.assertEqual(source.gtype, lyr.geom_type.num)\n \n+        # Same issue for Feature/Field objects, see #18640\n+        self.assertEqual(str(lyr[0]['str']), \"1\")\n+\n     def test04_features(self):\n         \"Testing Data Source Features.\"\n         for source in ds_list:"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 36,
        "deletions": 20
    }
}