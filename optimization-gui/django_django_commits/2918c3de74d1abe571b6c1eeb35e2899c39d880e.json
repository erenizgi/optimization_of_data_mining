{
    "author": "jbronn",
    "message": "Fixed #14648 -- Fixed annotated date querysets when `GeoManager` is used.  Thanks, codysoyland, for the bug report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16796 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2918c3de74d1abe571b6c1eeb35e2899c39d880e",
    "files": [
        {
            "sha": "3f81ae68a13d876bda07422b82211ba480323b35",
            "filename": "django/contrib/gis/db/backends/spatialite/compiler.py",
            "status": "removed",
            "additions": 0,
            "deletions": 32,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/8e1226b4a00a0d26752b26d0ebf21ff8c5a247ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/8e1226b4a00a0d26752b26d0ebf21ff8c5a247ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcompiler.py?ref=8e1226b4a00a0d26752b26d0ebf21ff8c5a247ad",
            "patch": "@@ -1,32 +0,0 @@\n-from django.db.backends.util import typecast_timestamp\n-from django.db.models.sql import compiler\n-from django.db.models.sql.constants import MULTI\n-from django.contrib.gis.db.models.sql.compiler import GeoSQLCompiler as BaseGeoSQLCompiler\n-\n-SQLCompiler = compiler.SQLCompiler\n-\n-class GeoSQLCompiler(BaseGeoSQLCompiler, SQLCompiler):\n-    pass\n-\n-class SQLInsertCompiler(compiler.SQLInsertCompiler, GeoSQLCompiler):\n-    pass\n-\n-class SQLDeleteCompiler(compiler.SQLDeleteCompiler, GeoSQLCompiler):\n-    pass\n-\n-class SQLUpdateCompiler(compiler.SQLUpdateCompiler, GeoSQLCompiler):\n-    pass\n-\n-class SQLAggregateCompiler(compiler.SQLAggregateCompiler, GeoSQLCompiler):\n-    pass\n-\n-class SQLDateCompiler(compiler.SQLDateCompiler, GeoSQLCompiler):\n-    \"\"\"\n-    This is overridden for GeoDjango to properly cast date columns, see #16757.\n-    \"\"\"\n-    def results_iter(self):\n-        offset = len(self.query.extra_select)\n-        for rows in self.execute_sql(MULTI):\n-            for row in rows:\n-                date = typecast_timestamp(str(row[offset]))\n-                yield date"
        },
        {
            "sha": "449c527187bfcdd170d300cd6d4c1015016efbce",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=2918c3de74d1abe571b6c1eeb35e2899c39d880e",
            "patch": "@@ -48,7 +48,7 @@ def get_dist_ops(operator):\n     return (SpatiaLiteDistance(operator),)\n \n class SpatiaLiteOperations(DatabaseOperations, BaseSpatialOperations):\n-    compiler_module = 'django.contrib.gis.db.backends.spatialite.compiler'\n+    compiler_module = 'django.contrib.gis.db.models.sql.compiler'\n     name = 'spatialite'\n     spatialite = True\n     version_regex = re.compile(r'^(?P<major>\\d)\\.(?P<minor1>\\d)\\.(?P<minor2>\\d+)')"
        },
        {
            "sha": "405a000f42392d4d04406b32aca3899fa2304215",
            "filename": "django/contrib/gis/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 24,
            "deletions": 4,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=2918c3de74d1abe571b6c1eeb35e2899c39d880e",
            "patch": "@@ -1,7 +1,7 @@\n from itertools import izip\n-from django.db.backends.util import truncate_name\n+from django.db.backends.util import truncate_name, typecast_timestamp\n from django.db.models.sql import compiler\n-from django.db.models.sql.constants import TABLE_NAME\n+from django.db.models.sql.constants import TABLE_NAME, MULTI\n from django.db.models.sql.query import get_proxied_model\n \n SQLCompiler = compiler.SQLCompiler\n@@ -194,7 +194,7 @@ def resolve_columns(self, row, fields=()):\n             # We resolve the rest of the columns if we're on Oracle or if\n             # the `geo_values` attribute is defined.\n             for value, field in map(None, row[index_start:], fields):\n-                values.append(self.query.convert_values(value, field, connection=self.connection))\n+                values.append(self.query.convert_values(value, field, self.connection))\n         else:\n             values.extend(row[index_start:])\n         return tuple(values)\n@@ -275,4 +275,24 @@ class SQLAggregateCompiler(compiler.SQLAggregateCompiler, GeoSQLCompiler):\n     pass\n \n class SQLDateCompiler(compiler.SQLDateCompiler, GeoSQLCompiler):\n-    pass\n+    \"\"\"\n+    This is overridden for GeoDjango to properly cast date columns, since\n+    `GeoQuery.resolve_columns` is used for spatial values.\n+    See #14648, #16757.\n+    \"\"\"\n+    def results_iter(self):\n+        if self.connection.ops.oracle:\n+            from django.db.models.fields import DateTimeField\n+            fields = [DateTimeField()]\n+        else:\n+            needs_string_cast = self.connection.features.needs_datetime_string_cast\n+\n+        offset = len(self.query.extra_select)\n+        for rows in self.execute_sql(MULTI):\n+            for row in rows:\n+                date = row[offset]\n+                if self.connection.ops.oracle:\n+                    date = self.resolve_columns(row, fields)[offset]\n+                elif needs_string_cast:\n+                    date = typecast_timestamp(str(date))\n+                yield date"
        },
        {
            "sha": "893763724b819f615c09dd01e1b5705f5352d4c6",
            "filename": "django/contrib/gis/tests/relatedapp/fixtures/initial_data.json.gz",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ffixtures%2Finitial_data.json.gz",
            "raw_url": "https://github.com/django/django/raw/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ffixtures%2Finitial_data.json.gz",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ffixtures%2Finitial_data.json.gz?ref=2918c3de74d1abe571b6c1eeb35e2899c39d880e"
        },
        {
            "sha": "aec4e157497365135a63515d2f31f555c71465fa",
            "filename": "django/contrib/gis/tests/relatedapp/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Fmodels.py?ref=2918c3de74d1abe571b6c1eeb35e2899c39d880e",
            "patch": "@@ -36,6 +36,7 @@ def __unicode__(self): return self.name\n # These use the GeoManager but do not have any geographic fields.\n class Author(models.Model):\n     name = models.CharField(max_length=100)\n+    dob = models.DateField()\n     objects = models.GeoManager()\n \n class Article(models.Model):"
        },
        {
            "sha": "685700e9ae232c7e322fcb07d78484199636a307",
            "filename": "django/contrib/gis/tests/relatedapp/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2918c3de74d1abe571b6c1eeb35e2899c39d880e/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Frelatedapp%2Ftests.py?ref=2918c3de74d1abe571b6c1eeb35e2899c39d880e",
            "patch": "@@ -1,3 +1,4 @@\n+from datetime import date\n from django.test import TestCase\n \n from django.contrib.gis.geos import GEOSGeometry, Point, MultiPoint\n@@ -281,4 +282,11 @@ def test15_invalid_select_related(self):\n         # evaluated as list generation swallows TypeError in CPython.\n         sql = str(qs.query)\n \n+    def test16_annotated_date_queryset(self):\n+        \"Ensure annotated date querysets work if spatial backend is used.  See #14648.\"\n+        birth_years = [dt.year for dt in \n+                       list(Author.objects.annotate(num_books=Count('books')).dates('dob', 'year'))]\n+        birth_years.sort()\n+        self.assertEqual([1950, 1974], birth_years)\n+\n     # TODO: Related tests for KML, GML, and distance lookups."
        }
    ],
    "stats": {
        "total": 71,
        "additions": 34,
        "deletions": 37
    }
}