{
    "author": "jezdez",
    "message": "Fixed #7735 -- Added support for IPv6 adresses to runserver and testserver management command. Thanks to Jason Alonso and ≈Åukasz Rekucki for the report and initial patches.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14711 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6a32e253f68b62b75d787f698ebaef461886c21c",
    "files": [
        {
            "sha": "b63b57a67cea8f31cf4da0cfe937ec3f8710cf34",
            "filename": "django/core/management/commands/runserver.py",
            "status": "modified",
            "additions": 28,
            "deletions": 12,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/6a32e253f68b62b75d787f698ebaef461886c21c/django%2Fcore%2Fmanagement%2Fcommands%2Frunserver.py",
            "raw_url": "https://github.com/django/django/raw/6a32e253f68b62b75d787f698ebaef461886c21c/django%2Fcore%2Fmanagement%2Fcommands%2Frunserver.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Frunserver.py?ref=6a32e253f68b62b75d787f698ebaef461886c21c",
            "patch": "@@ -1,14 +1,21 @@\n from optparse import make_option\n import os\n+import re\n import sys\n+import socket\n \n from django.core.management.base import BaseCommand, CommandError\n from django.core.handlers.wsgi import WSGIHandler\n from django.core.servers.basehttp import AdminMediaHandler, run, WSGIServerException\n from django.utils import autoreload\n \n+naiveip_re = r'^(?:(?P<addr>\\d{1,3}(?:\\.\\d{1,3}){3}|\\[[a-fA-F0-9:]+\\]):)?(?P<port>\\d+)$'\n+DEFAULT_PORT = \"8000\"\n+\n class BaseRunserverCommand(BaseCommand):\n     option_list = BaseCommand.option_list + (\n+        make_option('--ipv6', '-6', action='store_true', dest='use_ipv6', default=False,\n+            help='Tells Django to use a IPv6 address.'),\n         make_option('--noreload', action='store_false', dest='use_reloader', default=True,\n             help='Tells Django to NOT use the auto-reloader.'),\n     )\n@@ -25,22 +32,31 @@ def get_handler(self, *args, **options):\n         return WSGIHandler()\n \n     def handle(self, addrport='', *args, **options):\n+        self.use_ipv6 = options.get('use_ipv6')\n+        if self.use_ipv6 and not hasattr(socket, 'AF_INET6'):\n+            raise CommandError('Your Python does not support IPv6.')\n         if args:\n             raise CommandError('Usage is runserver %s' % self.args)\n         if not addrport:\n             self.addr = ''\n-            self.port = '8000'\n+            self.port = DEFAULT_PORT\n         else:\n-            try:\n-                self.addr, self.port = addrport.split(':')\n-            except ValueError:\n-                self.addr, self.port = '', addrport\n+            m = re.match(naiveip_re, addrport)\n+            if m is None:\n+                raise CommandError('%r is not a valid port number'\n+                                   'or address:port pair.' % addrport)\n+            self.addr, self.port = m.groups()\n+            if not self.port.isdigit():\n+                raise CommandError(\"%r is not a valid port number.\" % self.port)\n+            if self.addr:\n+                if self.addr.startswith('[') and self.addr.endswith(']'):\n+                    self.addr = self.addr[1:-1]\n+                    self.use_ipv6 = True\n+                elif self.use_ipv6:\n+                    raise CommandError('IPv6 addresses must be surrounded '\n+                                       'with brackets, e.g. [::1].')\n         if not self.addr:\n-            self.addr = '127.0.0.1'\n-\n-        if not self.port.isdigit():\n-            raise CommandError(\"%r is not a valid port number.\" % self.port)\n-\n+            self.addr = self.use_ipv6 and '::1' or '127.0.0.1'\n         self.run(*args, **options)\n \n     def run(self, *args, **options):\n@@ -70,7 +86,7 @@ def inner_run(self, *args, **options):\n         ) % {\n             \"version\": self.get_version(),\n             \"settings\": settings.SETTINGS_MODULE,\n-            \"addr\": self.addr,\n+            \"addr\": self.use_ipv6 and '[%s]' % self.addr or self.addr,\n             \"port\": self.port,\n             \"quit_command\": quit_command,\n         })\n@@ -81,7 +97,7 @@ def inner_run(self, *args, **options):\n \n         try:\n             handler = self.get_handler(*args, **options)\n-            run(self.addr, int(self.port), handler)\n+            run(self.addr, int(self.port), handler, ipv6=self.use_ipv6)\n         except WSGIServerException, e:\n             # Use helpful error messages instead of ugly tracebacks.\n             ERRORS = {"
        },
        {
            "sha": "3f62e5775b7f277c361b540dbbf9080d302368da",
            "filename": "django/core/management/commands/testserver.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/6a32e253f68b62b75d787f698ebaef461886c21c/django%2Fcore%2Fmanagement%2Fcommands%2Ftestserver.py",
            "raw_url": "https://github.com/django/django/raw/6a32e253f68b62b75d787f698ebaef461886c21c/django%2Fcore%2Fmanagement%2Fcommands%2Ftestserver.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Ftestserver.py?ref=6a32e253f68b62b75d787f698ebaef461886c21c",
            "patch": "@@ -9,6 +9,8 @@ class Command(BaseCommand):\n         make_option('--addrport', action='store', dest='addrport',\n             type='string', default='',\n             help='port number or ipaddr:port to run the server on'),\n+        make_option('--ipv6', '-6', action='store_true', dest='use_ipv6', default=False,\n+            help='Tells Django to use a IPv6 address.'),\n     )\n     help = 'Runs a development server with data from the given fixture(s).'\n     args = '[fixture ...]'\n@@ -33,4 +35,4 @@ def handle(self, *fixture_labels, **options):\n         # a strange error -- it causes this handle() method to be called\n         # multiple times.\n         shutdown_message = '\\nServer stopped.\\nNote that the test database, %r, has not been deleted. You can explore it on your own.' % db_name\n-        call_command('runserver', addrport=addrport, shutdown_message=shutdown_message, use_reloader=False)\n+        call_command('runserver', addrport=addrport, shutdown_message=shutdown_message, use_reloader=False, use_ipv6=options['use_ipv6'])"
        },
        {
            "sha": "7772a0b5f8b3c406bbb41d39ef967d154a2def18",
            "filename": "django/core/servers/basehttp.py",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/6a32e253f68b62b75d787f698ebaef461886c21c/django%2Fcore%2Fservers%2Fbasehttp.py",
            "raw_url": "https://github.com/django/django/raw/6a32e253f68b62b75d787f698ebaef461886c21c/django%2Fcore%2Fservers%2Fbasehttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fservers%2Fbasehttp.py?ref=6a32e253f68b62b75d787f698ebaef461886c21c",
            "patch": "@@ -10,6 +10,7 @@\n from BaseHTTPServer import BaseHTTPRequestHandler, HTTPServer\n import os\n import re\n+import socket\n import sys\n import urllib\n import warnings\n@@ -526,6 +527,11 @@ class WSGIServer(HTTPServer):\n     \"\"\"BaseHTTPServer that implements the Python WSGI protocol\"\"\"\n     application = None\n \n+    def __init__(self, *args, **kwargs):\n+        if kwargs.pop('ipv6', False):\n+            self.address_family = socket.AF_INET6\n+        HTTPServer.__init__(self, *args, **kwargs)\n+\n     def server_bind(self):\n         \"\"\"Override server_bind to store the server name.\"\"\"\n         try:\n@@ -683,9 +689,8 @@ def _should_handle(self, path):\n         \"\"\"\n         return path.startswith(self.base_url[2]) and not self.base_url[1]\n \n-\n-def run(addr, port, wsgi_handler):\n+def run(addr, port, wsgi_handler, ipv6=False):\n     server_address = (addr, port)\n-    httpd = WSGIServer(server_address, WSGIRequestHandler)\n+    httpd = WSGIServer(server_address, WSGIRequestHandler, ipv6=ipv6)\n     httpd.set_app(wsgi_handler)\n     httpd.serve_forever()"
        },
        {
            "sha": "73815ef68bef0c3b8f03b6e2db952aaa13f57c24",
            "filename": "docs/man/django-admin.1",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/6a32e253f68b62b75d787f698ebaef461886c21c/docs%2Fman%2Fdjango-admin.1",
            "raw_url": "https://github.com/django/django/raw/6a32e253f68b62b75d787f698ebaef461886c21c/docs%2Fman%2Fdjango-admin.1",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fman%2Fdjango-admin.1?ref=6a32e253f68b62b75d787f698ebaef461886c21c",
            "patch": "@@ -75,7 +75,7 @@ Runs this project as a FastCGI application. Requires flup. Use\n .B runfcgi help\n for help on the KEY=val pairs.\n .TP\n-.BI \"runserver [\" \"\\-\\-noreload\" \"] [\" \"\\-\\-nostatic\" \"] [\" \"\\-\\-insecure\" \"] [\" \"\\-\\-adminmedia=ADMIN_MEDIA_PATH\" \"] [\" \"port|ipaddr:port\" \"]\"\n+.BI \"runserver [\" \"\\-\\-noreload\" \"] [\" \"\\-\\-nostatic\" \"] [\" \"\\-\\-insecure\" \"] [\" \"\\-\\-ipv6\" \"] [\" \"\\-\\-adminmedia=ADMIN_MEDIA_PATH\" \"] [\" \"port|ipaddr:port\" \"]\"\n Starts a lightweight Web server for development.\n .TP\n .BI \"shell [\" \"\\-\\-plain\" \"]\"\n@@ -170,6 +170,9 @@ Disable automatic serving of static files from STATIC_URL.\n .I \\-\\-insecure\n Enables serving of static files even if DEBUG is False.\n .TP\n+.I \\-\\-ipv6\n+Enables IPv6 addresses.\n+.TP\n .I \\-\\-verbosity=VERBOSITY\n Verbosity level: 0=minimal output, 1=normal output, 2=all output.\n .TP"
        },
        {
            "sha": "eeb5fee91168fc9acbe7a04ca8037db9bdb01430",
            "filename": "docs/ref/django-admin.txt",
            "status": "modified",
            "additions": 39,
            "deletions": 10,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/6a32e253f68b62b75d787f698ebaef461886c21c/docs%2Fref%2Fdjango-admin.txt",
            "raw_url": "https://github.com/django/django/raw/6a32e253f68b62b75d787f698ebaef461886c21c/docs%2Fref%2Fdjango-admin.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdjango-admin.txt?ref=6a32e253f68b62b75d787f698ebaef461886c21c",
            "patch": "@@ -630,7 +630,7 @@ runserver [port or ipaddr:port]\n .. django-admin:: runserver\n \n Starts a lightweight development Web server on the local machine. By default,\n-the server runs on port 8000 on the IP address 127.0.0.1. You can pass in an\n+the server runs on port 8000 on the IP address ``127.0.0.1``. You can pass in an\n IP address and port number explicitly.\n \n If you run this script as a user with normal privileges (recommended), you\n@@ -654,10 +654,15 @@ them to standard output, but it won't stop the server.\n You can run as many servers as you want, as long as they're on separate ports.\n Just execute ``django-admin.py runserver`` more than once.\n \n-Note that the default IP address, 127.0.0.1, is not accessible from other\n+Note that the default IP address, ``127.0.0.1``, is not accessible from other\n machines on your network. To make your development server viewable to other\n machines on the network, use its own IP address (e.g. ``192.168.2.1``) or\n-``0.0.0.0``.\n+``0.0.0.0`` or ``::`` (with IPv6 enabled).\n+\n+.. versionchanged:: 1.3\n+\n+You can also provide an IPv6 address surrounded by brackets\n+(eg. ``[200a::1]:8000``). This will automaticaly enable IPv6 support.\n \n .. django-admin-option:: --adminmedia\n \n@@ -681,25 +686,49 @@ Example usage::\n \n     django-admin.py runserver --noreload\n \n+.. django-admin-option:: --ipv6, -6\n+\n+.. versionadded:: 1.3\n+\n+Use the ``--ipv6`` (or shorter ``-6``) option to tell Django to use IPv6 for\n+the development server. This changes the default IP address from\n+``127.0.0.1`` to ``::1``.\n+\n+Example usage::\n+\n+    django-admin.py runserver --ipv6\n+\n Examples of using different ports and addresses\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-Port 8000 on IP address 127.0.0.1::\n+Port 8000 on IP address ``127.0.0.1``::\n \n-\tdjango-admin.py runserver\n+    django-admin.py runserver\n \n-Port 8000 on IP address 1.2.3.4::\n+Port 8000 on IP address ``1.2.3.4``::\n \n-\tdjango-admin.py runserver 1.2.3.4:8000\n+    django-admin.py runserver 1.2.3.4:8000\n \n-Port 7000 on IP address 127.0.0.1::\n+Port 7000 on IP address ``127.0.0.1``::\n \n     django-admin.py runserver 7000\n \n-Port 7000 on IP address 1.2.3.4::\n+Port 7000 on IP address ``1.2.3.4``::\n \n     django-admin.py runserver 1.2.3.4:7000\n \n+Port 8000 on IPv6 address ``::1``::\n+\n+    django-admin.py runserver -6\n+\n+Port 7000 on IPv6 address ``::1``::\n+\n+    django-admin.py runserver -6 7000\n+\n+Port 7000 on IPv6 address ``2001:0db8:1234:5678::9``::\n+\n+    django-admin.py runserver [2001:0db8:1234:5678::9]:7000\n+\n Serving static files with the development server\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -963,7 +992,7 @@ templates.\n .. django-admin-option:: --addrport [port number or ipaddr:port]\n \n Use ``--addrport`` to specify a different port, or IP address and port, from\n-the default of 127.0.0.1:8000. This value follows exactly the same format and\n+the default of ``127.0.0.1:8000``. This value follows exactly the same format and\n serves exactly the same function as the argument to the ``runserver`` command.\n \n Examples:"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 82,
        "deletions": 27
    }
}