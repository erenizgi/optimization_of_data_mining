{
    "author": "aaugustin",
    "message": "Fixed several problems that hid one another in the cache tests and code.\n\n1 - Used django.test.TestCase instead of unittest.TestCase so that the override_settings decorator works.\n2 - Reverted parts of r17039 that caused failures (masked until 1).\n3 - Isolated tests by clearing the cache in tear down (masked until 1). Refs #11505.\n4 - Fixed a bug in cache key generation (revealed by 3).\n5 - Fixed a test that relied on this bug -- hardcoding the generated cache keys in tests isn't a very good idea anyway.\n6 - Uniformized some parts of the cache tests.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17042 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "0cf139d20196cd055cae47b302370ec5442eac66",
    "files": [
        {
            "sha": "71c091ee18c28c7f58523b1a3dd0b6ff13315d18",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/0cf139d20196cd055cae47b302370ec5442eac66/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/0cf139d20196cd055cae47b302370ec5442eac66/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=0cf139d20196cd055cae47b302370ec5442eac66",
            "patch": "@@ -174,7 +174,7 @@ def _generate_cache_key(request, method, headerlist, key_prefix):\n             ctx.update(value)\n     path = hashlib.md5(iri_to_uri(request.get_full_path()))\n     cache_key = 'views.decorators.cache.cache_page.%s.%s.%s.%s' % (\n-        key_prefix, request.method, path.hexdigest(), ctx.hexdigest())\n+        key_prefix, method, path.hexdigest(), ctx.hexdigest())\n     return _i18n_cache_key_suffix(request, cache_key)\n \n def _generate_cache_header_key(key_prefix, request):"
        },
        {
            "sha": "ee2c926699d41c7008e99f95eb5dec6b4421cd9a",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 50,
            "deletions": 22,
            "changes": 72,
            "blob_url": "https://github.com/django/django/blob/0cf139d20196cd055cae47b302370ec5442eac66/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0cf139d20196cd055cae47b302370ec5442eac66/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=0cf139d20196cd055cae47b302370ec5442eac66",
            "patch": "@@ -941,11 +941,15 @@ def test_simple(self):\n         self.assertRaises(InvalidCacheBackendError, get_cache, 'does_not_exist')\n \n \n-class CacheUtils(unittest.TestCase):\n+class CacheUtils(TestCase):\n     \"\"\"TestCase for django.utils.cache functions.\"\"\"\n \n     def setUp(self):\n         self.path = '/cache/test/'\n+        self.cache = get_cache('default')\n+\n+    def tearDown(self):\n+        self.cache.clear()\n \n     def _get_request(self, path, method='GET'):\n         request = HttpRequest()\n@@ -1006,7 +1010,7 @@ def test_learn_cache_key(self):\n         response['Vary'] = 'Pony'\n         # Make sure that the Vary header is added to the key hash\n         learn_cache_key(request, response)\n-        self.assertEqual(get_cache_key(request), 'views.decorators.cache.cache_page.settingsprefix.HEAD.a8c87a3d8c44853d7f79474f7ffe4ad5.d41d8cd98f00b204e9800998ecf8427e')\n+        self.assertEqual(get_cache_key(request), 'views.decorators.cache.cache_page.settingsprefix.GET.a8c87a3d8c44853d7f79474f7ffe4ad5.d41d8cd98f00b204e9800998ecf8427e')\n \n     def test_patch_cache_control(self):\n         tests = (\n@@ -1054,10 +1058,14 @@ def test_patch_cache_control(self):\n )(CacheUtils)\n \n \n-class CacheHEADTest(unittest.TestCase):\n+class CacheHEADTest(TestCase):\n \n     def setUp(self):\n         self.path = '/cache/test/'\n+        self.cache = get_cache('default')\n+\n+    def tearDown(self):\n+        self.cache.clear()\n \n     def _get_request(self, method):\n         request = HttpRequest()\n@@ -1112,17 +1120,22 @@ def test_head_with_cached_get(self):\n )(CacheHEADTest)\n \n \n-class CacheI18nTest(unittest.TestCase):\n+class CacheI18nTest(TestCase):\n \n     def setUp(self):\n         self.path = '/cache/test/'\n+        self.cache = get_cache('default')\n \n-    def _get_request(self):\n+    def tearDown(self):\n+        self.cache.clear()\n+\n+    def _get_request(self, method='GET'):\n         request = HttpRequest()\n         request.META = {\n             'SERVER_NAME': 'testserver',\n             'SERVER_PORT': 80,\n         }\n+        request.method = method\n         request.path = request.path_info = self.path\n         return request\n \n@@ -1167,10 +1180,10 @@ def test_cache_key_no_i18n (self):\n     )\n     def test_middleware(self):\n         def set_cache(request, lang, msg):\n-            with translation.override(lang):\n-                response = HttpResponse()\n-                response.content= msg\n-                return UpdateCacheMiddleware().process_response(request, response)\n+            translation.activate(lang)\n+            response = HttpResponse()\n+            response.content = msg\n+            return UpdateCacheMiddleware().process_response(request, response)\n \n         # cache with non empty request.GET\n         request = self._get_request_cache(query_string='foo=bar&other=true')\n@@ -1198,8 +1211,8 @@ def set_cache(request, lang, msg):\n         set_cache(request, 'en', en_message)\n         get_cache_data = FetchFromCacheMiddleware().process_request(request)\n         # Check that we can recover the cache\n-        self.assertNotEqual(get_cache_data.content, None)\n-        self.assertEqual(en_message, get_cache_data.content)\n+        self.assertNotEqual(get_cache_data, None)\n+        self.assertEqual(get_cache_data.content, en_message)\n         # Check that we use etags\n         self.assertTrue(get_cache_data.has_header('ETag'))\n         # Check that we can disable etags\n@@ -1212,14 +1225,14 @@ def set_cache(request, lang, msg):\n         request = self._get_request_cache()\n         set_cache(request, 'es', es_message)\n         # change again the language\n-        with translation.override('en'):\n-            # retrieve the content from cache\n-            get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-            self.assertEqual(get_cache_data.content, en_message)\n+        translation.activate('en')\n+        # retrieve the content from cache\n+        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+        self.assertEqual(get_cache_data.content, en_message)\n         # change again the language\n-        with translation.override('es'):\n-            get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-            self.assertEqual(get_cache_data.content, es_message)\n+        translation.activate('es')\n+        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+        self.assertEqual(get_cache_data.content, es_message)\n \n CacheI18nTest = override_settings(\n         CACHE_MIDDLEWARE_KEY_PREFIX='settingsprefix',\n@@ -1248,10 +1261,16 @@ def hello_world_view(request, value):\n     return HttpResponse('Hello World %s' % value)\n \n \n-class CacheMiddlewareTest(unittest.TestCase):\n+class CacheMiddlewareTest(TestCase):\n \n     def setUp(self):\n         self.factory = RequestFactory()\n+        self.default_cache = get_cache('default')\n+        self.other_cache = get_cache('other')\n+\n+    def tearDown(self):\n+        self.default_cache.clear()\n+        self.other_cache.clear()\n \n     def test_constructor(self):\n         \"\"\"\n@@ -1488,6 +1507,10 @@ class TestWithTemplateResponse(TestCase):\n     \"\"\"\n     def setUp(self):\n         self.path = '/cache/test/'\n+        self.cache = get_cache('default')\n+\n+    def tearDown(self):\n+        self.cache.clear()\n \n     def _get_request(self, path, method='GET'):\n         request = HttpRequest()\n@@ -1561,9 +1584,14 @@ def test_with_etag(self):\n         self.assertTrue(response.has_header('ETag'))\n \n TestWithTemplateResponse = override_settings(\n-    CACHE_MIDDLEWARE_KEY_PREFIX='settingsprefix',\n-    CACHE_MIDDLEWARE_SECONDS=1,\n-    USE_I18N=False,\n+        CACHE_MIDDLEWARE_KEY_PREFIX='settingsprefix',\n+        CACHE_MIDDLEWARE_SECONDS=1,\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+            },\n+        },\n+        USE_I18N=False,\n )(TestWithTemplateResponse)\n \n "
        }
    ],
    "stats": {
        "total": 74,
        "additions": 51,
        "deletions": 23
    }
}