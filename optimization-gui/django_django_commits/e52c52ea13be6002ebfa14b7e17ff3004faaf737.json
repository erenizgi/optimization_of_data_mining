{
    "author": "SmileyChris",
    "message": "Fixed #17492 -- Allow reversal of named backreferences. Thanks nate_b\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17336 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e52c52ea13be6002ebfa14b7e17ff3004faaf737",
    "files": [
        {
            "sha": "ab101e8c32a1132182b6c2b726b8f66d03a89f46",
            "filename": "django/utils/regex_helper.py",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/e52c52ea13be6002ebfa14b7e17ff3004faaf737/django%2Futils%2Fregex_helper.py",
            "raw_url": "https://github.com/django/django/raw/e52c52ea13be6002ebfa14b7e17ff3004faaf737/django%2Futils%2Fregex_helper.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fregex_helper.py?ref=e52c52ea13be6002ebfa14b7e17ff3004faaf737",
            "patch": "@@ -134,18 +134,28 @@ def normalize(pattern):\n                         raise ValueError(\"Non-reversible reg-exp portion: '(?%s'\" % ch)\n                     else:\n                         ch, escaped = pattern_iter.next()\n-                        if ch != '<':\n+                        if ch not in ('<', '='):\n                             raise ValueError(\"Non-reversible reg-exp portion: '(?P%s'\" % ch)\n                         # We are in a named capturing group. Extra the name and\n                         # then skip to the end.\n+                        if ch == '<':\n+                            terminal_char = '>'\n+                        # We are in a named backreference.\n+                        else:\n+                            terminal_char = ')'\n                         name = []\n                         ch, escaped = pattern_iter.next()\n-                        while ch != '>':\n+                        while ch != terminal_char:\n                             name.append(ch)\n                             ch, escaped = pattern_iter.next()\n                         param = ''.join(name)\n-                        result.append(Group(((u\"%%(%s)s\" % param), param)))\n-                        walk_to_end(ch, pattern_iter)\n+                        # Named backreferences have already consumed the\n+                        # parenthesis.\n+                        if terminal_char != ')':\n+                            result.append(Group(((u\"%%(%s)s\" % param), param)))\n+                            walk_to_end(ch, pattern_iter)\n+                        else:\n+                            result.append(Group(((u\"%%(%s)s\" % param), None)))\n             elif ch in \"*?+{\":\n                 # Quanitifers affect the previous item in the result list.\n                 count, ch = get_quantifier(ch, pattern_iter)"
        },
        {
            "sha": "a1c92449180c5eb9c94b0e90ca1c9c365f432319",
            "filename": "tests/regressiontests/urlpatterns_reverse/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Ftests.py?ref=e52c52ea13be6002ebfa14b7e17ff3004faaf737",
            "patch": "@@ -76,6 +76,8 @@\n     ('people', NoReverseMatch, [], {'name': 'name with spaces'}),\n     ('people2', '/people/name/', [], {}),\n     ('people2a', '/people/name/fred/', ['fred'], {}),\n+    ('people_backref', '/people/nate-nate/', ['nate'], {}),\n+    ('people_backref', '/people/nate-nate/', [], {'name': 'nate'}),\n     ('optional', '/optional/fred/', [], {'name': 'fred'}),\n     ('optional', '/optional/fred/', ['fred'], {}),\n     ('hardcoded', '/hardcoded/', [], {}),"
        },
        {
            "sha": "1d4ae73c676edc9acc7288354cd16e7ff4fc9c42",
            "filename": "tests/regressiontests/urlpatterns_reverse/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Furlpatterns_reverse%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Furlpatterns_reverse%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Furlpatterns_reverse%2Furls.py?ref=e52c52ea13be6002ebfa14b7e17ff3004faaf737",
            "patch": "@@ -22,6 +22,7 @@\n     url(r'^people/(?P<name>\\w+)/$', empty_view, name=\"people\"),\n     url(r'^people/(?:name/)', empty_view, name=\"people2\"),\n     url(r'^people/(?:name/(\\w+)/)?', empty_view, name=\"people2a\"),\n+    url(r'^people/(?P<name>\\w+)-(?P=name)/$', empty_view, name=\"people_backref\"),\n     url(r'^optional/(?P<name>.*)/(?:.+/)?', empty_view, name=\"optional\"),\n     url(r'^hardcoded/$', empty_view, name=\"hardcoded\"),\n     url(r'^hardcoded/doc\\.pdf$', empty_view, name=\"hardcoded2\"),\n@@ -65,7 +66,4 @@\n     (r'defaults_view2/(?P<arg1>\\d+)/', 'defaults_view', {'arg2': 2}, 'defaults'),\n \n     url('^includes/', include(other_patterns)),\n-\n )\n-\n-"
        },
        {
            "sha": "8dc712f5b935767bce8c879447ad5c1a98fa9f2a",
            "filename": "tests/regressiontests/utils/regex_helper.py",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/django/django/blob/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Futils%2Fregex_helper.py",
            "raw_url": "https://github.com/django/django/raw/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Futils%2Fregex_helper.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fregex_helper.py?ref=e52c52ea13be6002ebfa14b7e17ff3004faaf737",
            "patch": "@@ -0,0 +1,48 @@\n+from django.utils import regex_helper\n+from django.utils import unittest\n+\n+\n+class NormalizeTests(unittest.TestCase):\n+    def test_empty(self):\n+        pattern = r\"\"\n+        expected = [(u'', [])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)\n+\n+    def test_escape(self):\n+        pattern = r\"\\\\\\^\\$\\.\\|\\?\\*\\+\\(\\)\\[\"\n+        expected = [(u'\\\\^$.|?*+()[', [])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)\n+\n+    def test_group_positional(self):\n+        pattern = r\"(.*)-(.+)\"\n+        expected = [(u'%(_0)s-%(_1)s', ['_0', '_1'])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)\n+\n+    def test_group_ignored(self):\n+        pattern = r\"(?i)(?L)(?m)(?s)(?u)(?#)\"\n+        expected = [(u'', [])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)\n+\n+    def test_group_noncapturing(self):\n+        pattern = r\"(?:non-capturing)\"\n+        expected = [(u'non-capturing', [])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)\n+\n+    def test_group_named(self):\n+        pattern = r\"(?P<first_group_name>.*)-(?P<second_group_name>.*)\"\n+        expected = [(u'%(first_group_name)s-%(second_group_name)s',\n+                    ['first_group_name', 'second_group_name'])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)\n+\n+    def test_group_backreference(self):\n+        pattern = r\"(?P<first_group_name>.*)-(?P=first_group_name)\"\n+        expected = [(u'%(first_group_name)s-%(first_group_name)s',\n+                    ['first_group_name'])]\n+        result = regex_helper.normalize(pattern)\n+        self.assertEqual(result, expected)"
        },
        {
            "sha": "f5ca06ef1ea11f38e042fc09b221f3adb9e5fe8d",
            "filename": "tests/regressiontests/utils/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Futils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e52c52ea13be6002ebfa14b7e17ff3004faaf737/tests%2Fregressiontests%2Futils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftests.py?ref=e52c52ea13be6002ebfa14b7e17ff3004faaf737",
            "patch": "@@ -25,3 +25,4 @@\n from .timezone import TimezoneTests\n from .crypto import TestUtilsCryptoPBKDF2\n from .archive import TestZip, TestTar, TestGzipTar, TestBzip2Tar\n+from .regex_helper import NormalizeTests"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 66,
        "deletions": 7
    }
}