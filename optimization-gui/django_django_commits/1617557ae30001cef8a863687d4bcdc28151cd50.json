{
    "author": "aaugustin",
    "message": "Added BaseDatabaseWrapper.ensure_connection.\n\nThis API is useful because autocommit cannot be managed without an open\nconnection.",
    "sha": "1617557ae30001cef8a863687d4bcdc28151cd50",
    "files": [
        {
            "sha": "b7f4628e9a905c3d798dc115bd7d531b715c093c",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 24,
            "deletions": 10,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/1617557ae30001cef8a863687d4bcdc28151cd50/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/1617557ae30001cef8a863687d4bcdc28151cd50/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=1617557ae30001cef8a863687d4bcdc28151cd50",
            "patch": "@@ -86,20 +86,33 @@ def create_cursor(self):\n         \"\"\"Creates a cursor. Assumes that a connection is established.\"\"\"\n         raise NotImplementedError\n \n+    ##### Backend-specific methods for creating connections #####\n+\n+    def connect(self):\n+        \"\"\"Connects to the database. Assumes that the connection is closed.\"\"\"\n+        # Reset parameters defining when to close the connection\n+        max_age = self.settings_dict['CONN_MAX_AGE']\n+        self.close_at = None if max_age is None else time.time() + max_age\n+        self.errors_occurred = False\n+        # Establish the connection\n+        conn_params = self.get_connection_params()\n+        self.connection = self.get_new_connection(conn_params)\n+        self.init_connection_state()\n+        connection_created.send(sender=self.__class__, connection=self)\n+\n+    def ensure_connection(self):\n+        \"\"\"\n+        Guarantees that a connection to the database is established.\n+        \"\"\"\n+        if self.connection is None:\n+            with self.wrap_database_errors():\n+                self.connect()\n+\n     ##### Backend-specific wrappers for PEP-249 connection methods #####\n \n     def _cursor(self):\n+        self.ensure_connection()\n         with self.wrap_database_errors():\n-            if self.connection is None:\n-                # Reset parameters defining when to close the connection\n-                max_age = self.settings_dict['CONN_MAX_AGE']\n-                self.close_at = None if max_age is None else time.time() + max_age\n-                self.errors_occurred = False\n-                # Establish the connection\n-                conn_params = self.get_connection_params()\n-                self.connection = self.get_new_connection(conn_params)\n-                self.init_connection_state()\n-                connection_created.send(sender=self.__class__, connection=self)\n             return self.create_cursor()\n \n     def _commit(self):\n@@ -285,6 +298,7 @@ def set_autocommit(self, autocommit=True):\n         \"\"\"\n         Enable or disable autocommit.\n         \"\"\"\n+        self.ensure_connection()\n         self._set_autocommit(autocommit)\n         self.autocommit = autocommit\n "
        },
        {
            "sha": "384b38cc58d1620e6f6112ca8ef50300dfc981cb",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/1617557ae30001cef8a863687d4bcdc28151cd50/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/1617557ae30001cef8a863687d4bcdc28151cd50/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=1617557ae30001cef8a863687d4bcdc28151cd50",
            "patch": "@@ -169,8 +169,6 @@ def _enter_transaction_management(self, managed):\n         Switch the isolation level when needing transaction support, so that\n         the same transaction is visible across all the queries.\n         \"\"\"\n-        if self.connection is None:             # Force creating a connection.\n-            self.cursor().close()\n         if managed and self.autocommit:\n             self.set_autocommit(False)\n \n@@ -179,8 +177,6 @@ def _leave_transaction_management(self, managed):\n         If the normal operating mode is \"autocommit\", switch back to that when\n         leaving transaction management.\n         \"\"\"\n-        if self.connection is None:             # Force creating a connection.\n-            self.cursor().close()\n         if not managed and not self.autocommit:\n             self.rollback()                     # Must terminate transaction first.\n             self.set_autocommit(True)"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 24,
        "deletions": 14
    }
}