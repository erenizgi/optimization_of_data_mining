{
    "author": "PaulMcMillan",
    "message": "Fixed #17837. Improved markdown safety.\n\nMarkdown enable_attributes is now False when safe_mode is enabled. Documented\nthe markdown \"safe\" argument. Added warnings when the safe argument is\npassed to versions of markdown which cannot be made safe. Deprecated\nversions of markdown < 2.1. Many thanks to ptone for the patch.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17735 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "14df122f865e5c050a26c619f616d4983d6a4ed2",
    "files": [
        {
            "sha": "b9fdce86a6a470d28cdeda571b4b454701138b47",
            "filename": "django/contrib/markup/templatetags/markup.py",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/14df122f865e5c050a26c619f616d4983d6a4ed2/django%2Fcontrib%2Fmarkup%2Ftemplatetags%2Fmarkup.py",
            "raw_url": "https://github.com/django/django/raw/14df122f865e5c050a26c619f616d4983d6a4ed2/django%2Fcontrib%2Fmarkup%2Ftemplatetags%2Fmarkup.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmarkup%2Ftemplatetags%2Fmarkup.py?ref=14df122f865e5c050a26c619f616d4983d6a4ed2",
            "patch": "@@ -11,6 +11,8 @@\n     * reStructuredText, which requires docutils from http://docutils.sf.net/\n \"\"\"\n \n+import warnings\n+\n from django import template\n from django.conf import settings\n from django.utils.encoding import smart_str, force_unicode\n@@ -63,14 +65,25 @@ def markdown(value, arg=''):\n                 safe_mode = True\n             else:\n                 safe_mode = False\n-\n+            python_markdown_deprecation = \"The use of Python-Markdown \"\n+            \"< 2.1 in Django is deprecated; please update to the current version\"\n             # Unicode support only in markdown v1.7 or above. Version_info\n             # exist only in markdown v1.6.2rc-2 or above.\n-            if getattr(markdown, \"version_info\", None) < (1,7):\n+            markdown_vers = getattr(markdown, \"version_info\", None)\n+            if markdown_vers < (1,7):\n+                warnings.warn(python_markdown_deprecation, DeprecationWarning)\n                 return mark_safe(force_unicode(markdown.markdown(smart_str(value), extensions, safe_mode=safe_mode)))\n             else:\n-                return mark_safe(markdown.markdown(force_unicode(value), extensions, safe_mode=safe_mode))\n+                if markdown_vers >= (2,1):\n+                    if safe_mode:\n+                        return mark_safe(markdown.markdown(force_unicode(value), extensions, safe_mode=safe_mode, enable_attributes=False))\n+                    else:\n+                        return mark_safe(markdown.markdown(force_unicode(value), extensions, safe_mode=safe_mode))\n+                else:\n+                    warnings.warn(python_markdown_deprecation, DeprecationWarning)\n+                    return mark_safe(markdown.markdown(force_unicode(value), extensions, safe_mode=safe_mode))\n         else:\n+            warnings.warn(python_markdown_deprecation, DeprecationWarning)\n             return mark_safe(force_unicode(markdown.markdown(smart_str(value))))\n \n @register.filter(is_safe=True)"
        },
        {
            "sha": "4539657bd4fc1c5d0611c45328fa3b3a109cff0c",
            "filename": "django/contrib/markup/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/14df122f865e5c050a26c619f616d4983d6a4ed2/django%2Fcontrib%2Fmarkup%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/14df122f865e5c050a26c619f616d4983d6a4ed2/django%2Fcontrib%2Fmarkup%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmarkup%2Ftests.py?ref=14df122f865e5c050a26c619f616d4983d6a4ed2",
            "patch": "@@ -58,6 +58,20 @@ def test_markdown(self):\n         pattern = re.compile(\"\"\"<p>Paragraph 1\\s*</p>\\s*<h2>\\s*An h2</h2>\"\"\")\n         self.assertTrue(pattern.match(rendered))\n \n+    @unittest.skipUnless(markdown, 'markdown no installed')\n+    def test_markdown_attribute_disable(self):\n+        t = Template(\"{% load markup %}{{ markdown_content|markdown:'safe' }}\")\n+        markdown_content = \"{@onclick=alert('hi')}some paragraph\"\n+        rendered = t.render(Context({'markdown_content':markdown_content})).strip()\n+        self.assertTrue('@' in rendered)\n+\n+    @unittest.skipUnless(markdown, 'markdown no installed')\n+    def test_markdown_attribute_enable(self):\n+        t = Template(\"{% load markup %}{{ markdown_content|markdown }}\")\n+        markdown_content = \"{@onclick=alert('hi')}some paragraph\"\n+        rendered = t.render(Context({'markdown_content':markdown_content})).strip()\n+        self.assertFalse('@' in rendered)\n+\n     @unittest.skipIf(markdown, 'markdown is installed')\n     def test_no_markdown(self):\n         t = Template(\"{% load markup %}{{ markdown_content|markdown }}\")"
        },
        {
            "sha": "81ca7afa27ce42a63dea537424c0336128dac9ff",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/14df122f865e5c050a26c619f616d4983d6a4ed2/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/14df122f865e5c050a26c619f616d4983d6a4ed2/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=14df122f865e5c050a26c619f616d4983d6a4ed2",
            "patch": "@@ -196,6 +196,11 @@ these changes.\n   filesystem path to a ``locale`` directory containing non-app-specific\n   translations in its value.\n \n+* The Markup contrib app will no longer support versions of Python-Markdown\n+  library earlier than 2.1. An accelerated timeline was used as this was\n+  a security related deprecation.\n+\n+\n 1.6\n ---\n "
        },
        {
            "sha": "3abc27bf5da7a6a6a37c758342206f717f463683",
            "filename": "docs/ref/contrib/markup.txt",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/14df122f865e5c050a26c619f616d4983d6a4ed2/docs%2Fref%2Fcontrib%2Fmarkup.txt",
            "raw_url": "https://github.com/django/django/raw/14df122f865e5c050a26c619f616d4983d6a4ed2/docs%2Fref%2Fcontrib%2Fmarkup.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fmarkup.txt?ref=14df122f865e5c050a26c619f616d4983d6a4ed2",
            "patch": "@@ -47,3 +47,19 @@ override the default writer settings. See the `restructuredtext writer\n settings`_ for details on what these settings are.\n \n .. _restructuredtext writer settings: http://docutils.sourceforge.net/docs/user/config.html#html4css1-writer\n+\n+Markdown\n+--------\n+\n+The Python Markdown library supports options named \"safe_mode\" and\n+\"enable_attributes\". Both relate to the security of the output. To enable both\n+options in tandem, the markdown filter supports the \"safe\" argument.\n+\n+    {{ markdown_content_var|markdown:\"safe\" }}\n+\n+.. warning::\n+\n+    Versions of the Python-Markdown library prior to 2.1 do not support the\n+    optional disabling of attributes and by default they will be included in\n+    any output from the markdown filter - a warning is issued if this is the\n+    case."
        },
        {
            "sha": "d82ca03d2886c9ca708d4db09e0402fd12c3e32c",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/14df122f865e5c050a26c619f616d4983d6a4ed2/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/14df122f865e5c050a26c619f616d4983d6a4ed2/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=14df122f865e5c050a26c619f616d4983d6a4ed2",
            "patch": "@@ -1096,6 +1096,16 @@ field. This was something that should not have worked, and in 1.4 loading such\n incomplete fixtures will fail. Because fixtures are a raw import, they should\n explicitly specify all field values, regardless of field options on the model.\n \n+Attributes disabled in markdown when safe mode set\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Prior to Django 1.4, attributes were included in any markdown output regardless\n+of safe mode setting of the filter. With version > 2.1 of the Python-Markdown\n+library, an enable_attributes option was added. When the safe argument is\n+passed to the markdown filter, both the ``safe_mode=True`` and\n+``enable_attributes=False`` options are set. If using a version of the\n+Python-Markdown library less than 2.1, a warning is issued that the output is\n+insecure.\n \n Features deprecated in 1.4\n ==========================\n@@ -1262,3 +1272,12 @@ each request to a site map now creates a new Paginator object and calls the\n ``items()`` method is doing, this may have a negative performance impact.\n To mitigate the performance impact, consider using the :doc:`caching\n framework </topics/cache>` within your ``Sitemap`` subclass.\n+\n+Versions of Python-Markdown earlier than 2.1\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Versions of Python-Markdown earlier than 2.1 do not support the option to\n+disable attributes. As a security issue, earlier versions of this library will\n+not be supported by the markup contrib app in 1.5 under an accelerated\n+deprecation timeline.\n+"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 70,
        "deletions": 3
    }
}