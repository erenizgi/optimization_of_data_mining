{
    "author": "aaugustin",
    "message": "Fixed #19343 -- Deadlock with TransactionTestCase + TEST_MIRROR + multi_db.\n\nThanks Jeremy Dunck for the review.",
    "sha": "be64dd35fbb9b2b49fa5774b7e7f777df8351c1a",
    "files": [
        {
            "sha": "3bb40a58381349a97fb5195ba3fd0b0f60835c66",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 14,
            "deletions": 23,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/be64dd35fbb9b2b49fa5774b7e7f777df8351c1a/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/be64dd35fbb9b2b49fa5774b7e7f777df8351c1a/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=be64dd35fbb9b2b49fa5774b7e7f777df8351c1a",
            "patch": "@@ -416,6 +416,15 @@ def _pre_setup(self):\n         self._urlconf_setup()\n         mail.outbox = []\n \n+    def _databases_names(self, include_mirrors=True):\n+        # If the test case has a multi_db=True flag, act on all databases,\n+        # including mirrors or not. Otherwise, just on the default DB.\n+        if getattr(self, 'multi_db', False):\n+            return [alias for alias in connections\n+                    if include_mirrors or not connections[alias].settings_dict['TEST_MIRROR']]\n+        else:\n+            return [DEFAULT_DB_ALIAS]\n+\n     def _reset_sequences(self, db_name):\n         conn = connections[db_name]\n         if conn.features.supports_sequence_reset:\n@@ -433,10 +442,7 @@ def _reset_sequences(self, db_name):\n                 transaction.commit_unless_managed(using=db_name)\n \n     def _fixture_setup(self):\n-        # If the test case has a multi_db=True flag, act on all databases.\n-        # Otherwise, just on the default DB.\n-        db_names = connections if getattr(self, 'multi_db', False) else [DEFAULT_DB_ALIAS]\n-        for db_name in db_names:\n+        for db_name in self._databases_names(include_mirrors=False):\n             # Reset sequences\n             if self.reset_sequences:\n                 self._reset_sequences(db_name)\n@@ -502,16 +508,12 @@ def _post_teardown(self):\n             conn.close()\n \n     def _fixture_teardown(self):\n-        # If the test case has a multi_db=True flag, flush all databases.\n-        # Otherwise, just flush default.\n-        databases = connections if getattr(self, 'multi_db', False) else [DEFAULT_DB_ALIAS]\n-\n         # Roll back any pending transactions in order to avoid a deadlock\n         # during flush when TEST_MIRROR is used (#18984).\n         for conn in connections.all():\n             conn.rollback_unless_managed()\n \n-        for db in databases:\n+        for db in self._databases_names(include_mirrors=False):\n             call_command('flush', verbosity=0, interactive=False, database=db,\n                          skip_validation=True, reset_sequences=False)\n \n@@ -796,19 +798,15 @@ def _fixture_setup(self):\n \n         assert not self.reset_sequences, 'reset_sequences cannot be used on TestCase instances'\n \n-        # If the test case has a multi_db=True flag, setup all databases.\n-        # Otherwise, just use default.\n-        db_names = connections if getattr(self, 'multi_db', False) else [DEFAULT_DB_ALIAS]\n-\n-        for db_name in db_names:\n+        for db_name in self._databases_names():\n             transaction.enter_transaction_management(using=db_name)\n             transaction.managed(True, using=db_name)\n         disable_transaction_methods()\n \n         from django.contrib.sites.models import Site\n         Site.objects.clear_cache()\n \n-        for db in db_names:\n+        for db in self._databases_names(include_mirrors=False):\n             if hasattr(self, 'fixtures'):\n                 call_command('loaddata', *self.fixtures,\n                              **{\n@@ -822,15 +820,8 @@ def _fixture_teardown(self):\n         if not connections_support_transactions():\n             return super(TestCase, self)._fixture_teardown()\n \n-        # If the test case has a multi_db=True flag, teardown all databases.\n-        # Otherwise, just teardown default.\n-        if getattr(self, 'multi_db', False):\n-            databases = connections\n-        else:\n-            databases = [DEFAULT_DB_ALIAS]\n-\n         restore_transaction_methods()\n-        for db in databases:\n+        for db in self._databases_names():\n             transaction.rollback(using=db)\n             transaction.leave_transaction_management(using=db)\n "
        }
    ],
    "stats": {
        "total": 37,
        "additions": 14,
        "deletions": 23
    }
}