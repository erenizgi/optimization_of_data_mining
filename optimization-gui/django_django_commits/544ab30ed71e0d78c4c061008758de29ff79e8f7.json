{
    "author": "jezdez",
    "message": "Fixed #6218 -- Made MEDIA_URL and STATIC_URL require a trailing slash to ensure there is a consistent way to combine paths in templates. Thanks to Michael Toomim, Chris Heisel and Chris Beaven.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15130 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "544ab30ed71e0d78c4c061008758de29ff79e8f7",
    "files": [
        {
            "sha": "47eec6ad059fd4ea04f6ec54e5945da9936f11ff",
            "filename": "django/conf/__init__.py",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/544ab30ed71e0d78c4c061008758de29ff79e8f7/django%2Fconf%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/544ab30ed71e0d78c4c061008758de29ff79e8f7/django%2Fconf%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2F__init__.py?ref=544ab30ed71e0d78c4c061008758de29ff79e8f7",
            "patch": "@@ -9,6 +9,7 @@\n import os\n import re\n import time     # Needed for Windows\n+import warnings\n \n from django.conf import global_settings\n from django.utils.functional import LazyObject\n@@ -60,7 +61,19 @@ def configured(self):\n         return bool(self._wrapped)\n     configured = property(configured)\n \n-class Settings(object):\n+\n+class BaseSettings(object):\n+    \"\"\"\n+    Common logic for settings whether set by a module or by the user.\n+    \"\"\"\n+    def __setattr__(self, name, value):\n+        if name in (\"MEDIA_URL\", \"STATIC_URL\") and value and not value.endswith('/'):\n+            warnings.warn('If set, %s must end with a slash' % name,\n+                          PendingDeprecationWarning)\n+        object.__setattr__(self, name, value)\n+\n+\n+class Settings(BaseSettings):\n     def __init__(self, settings_module):\n         # update this dict from global settings (but only for ALL_CAPS settings)\n         for setting in dir(global_settings):\n@@ -125,7 +138,8 @@ def __init__(self, settings_module):\n             # ... then invoke it with the logging settings\n             logging_config_func(self.LOGGING)\n \n-class UserSettingsHolder(object):\n+\n+class UserSettingsHolder(BaseSettings):\n     \"\"\"\n     Holder for user configured settings.\n     \"\"\""
        },
        {
            "sha": "4f9fdcb38f72ca0accc1eb614f83ae6c57b0a178",
            "filename": "django/conf/project_template/settings.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/544ab30ed71e0d78c4c061008758de29ff79e8f7/django%2Fconf%2Fproject_template%2Fsettings.py",
            "raw_url": "https://github.com/django/django/raw/544ab30ed71e0d78c4c061008758de29ff79e8f7/django%2Fconf%2Fproject_template%2Fsettings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fproject_template%2Fsettings.py?ref=544ab30ed71e0d78c4c061008758de29ff79e8f7",
            "patch": "@@ -48,7 +48,7 @@\n MEDIA_ROOT = ''\n \n # URL that handles the media served from MEDIA_ROOT. Make sure to use a\n-# trailing slash if there is a path component (optional in other cases).\n+# trailing slash.\n # Examples: \"http://media.lawrence.com/media/\", \"http://example.com/media/\"\n MEDIA_URL = ''\n "
        },
        {
            "sha": "4613b7e3ee5d3eed2d3db7ec918493c7896e2a5e",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/544ab30ed71e0d78c4c061008758de29ff79e8f7/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/544ab30ed71e0d78c4c061008758de29ff79e8f7/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=544ab30ed71e0d78c4c061008758de29ff79e8f7",
            "patch": "@@ -101,6 +101,10 @@ their deprecation, as per the :ref:`Django deprecation policy\n         * Authentication backends need to define the boolean attribute\n           ``supports_inactive_user``.\n \n+        * The ``MEDIA_URL`` or ``STATIC_URL`` settings are required to end\n+          with a trailing slash to ensure there is a consistent way to\n+          combine paths in templates.\n+\n     * 1.5\n         * The ``mod_python`` request handler has been deprecated since the 1.3\n           release. The ``mod_wsgi`` handler should be used instead."
        },
        {
            "sha": "87a71fe6edbdedebff8b7c449f172d5f0f1caad3",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/544ab30ed71e0d78c4c061008758de29ff79e8f7/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/544ab30ed71e0d78c4c061008758de29ff79e8f7/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=544ab30ed71e0d78c4c061008758de29ff79e8f7",
            "patch": "@@ -1251,10 +1251,8 @@ for :doc:`managing stored files </topics/files>`.\n \n Example: ``\"http://media.lawrence.com/\"``\n \n-Note that this should have a trailing slash if it has a path component.\n-\n- * Good: ``\"http://www.example.com/media/\"``\n- * Bad: ``\"http://www.example.com/media\"``\n+.. versionchanged:: 1.3\n+   It must end in a slash if set to a non-empty value.\n \n MESSAGE_LEVEL\n -------------\n@@ -1664,6 +1662,8 @@ If not ``None``, this will be used as the base path for\n :ref:`media definitions<form-media-paths>` and the\n :doc:`staticfiles app</ref/contrib/staticfiles>`.\n \n+It must end in a slash if set to a non-empty value.\n+\n See :setting:`STATIC_ROOT`.\n \n .. setting:: TEMPLATE_CONTEXT_PROCESSORS"
        },
        {
            "sha": "8928bee5eee169a00fa59824d9fe13d85c9fe4af",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/544ab30ed71e0d78c4c061008758de29ff79e8f7/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/544ab30ed71e0d78c4c061008758de29ff79e8f7/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=544ab30ed71e0d78c4c061008758de29ff79e8f7",
            "patch": "@@ -192,6 +192,22 @@ The GeoDjango test suite is now included when\n :ref:`running the Django test suite <running-unit-tests>` with ``runtests.py``\n when using :ref:`spatial database backends <spatial-backends>`.\n \n+``MEDIA_URL`` and ``STATIC_URL`` must end in a slash\n+----------------------------------------------------\n+\n+Previously, the ``MEDIA_URL`` setting only required a trailing slash if it\n+contained a suffix beyond the domain name.\n+\n+A trailing slash is now *required* for ``MEDIA_URL`` and the new\n+``STATIC_URL`` setting as long as it is not blank. This ensures there is\n+a consistent way to combine paths in templates.\n+\n+Project settings which provide either of both settings without a trailing\n+slash will now raise a ``PendingDeprecation`` warning.\n+\n+In Django 1.4 this same condition will raise an ``ImproperlyConfigured``\n+exception.\n+\n Everything else\n ~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "dc7fde4f2cda32465209d75ed2244a825a0f35d2",
            "filename": "tests/regressiontests/settings_tests/tests.py",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/django/django/blob/544ab30ed71e0d78c4c061008758de29ff79e8f7/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/544ab30ed71e0d78c4c061008758de29ff79e8f7/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py?ref=544ab30ed71e0d78c4c061008758de29ff79e8f7",
            "patch": "@@ -1,5 +1,7 @@\n from django.conf import settings\n from django.utils import unittest\n+from django.conf import settings, UserSettingsHolder, global_settings\n+\n \n class SettingsTests(unittest.TestCase):\n \n@@ -15,3 +17,62 @@ def test_settings_delete(self):\n \n     def test_settings_delete_wrapped(self):\n         self.assertRaises(TypeError, delattr, settings, '_wrapped')\n+\n+\n+class TrailingSlashURLTests(unittest.TestCase):\n+    settings_module = settings\n+\n+    def setUp(self):\n+        self._original_media_url = self.settings_module.MEDIA_URL\n+\n+    def tearDown(self):\n+        self.settings_module.MEDIA_URL = self._original_media_url\n+\n+    def test_blank(self):\n+        \"\"\"\n+        If blank, no PendingDeprecationWarning error will be raised, even though it\n+        doesn't end in a slash.\n+        \"\"\"\n+        self.settings_module.MEDIA_URL = ''\n+        self.assertEqual('', self.settings_module.MEDIA_URL)\n+\n+    def test_end_slash(self):\n+        \"\"\"\n+        MEDIA_URL works if you end in a slash.\n+        \"\"\"\n+        self.settings_module.MEDIA_URL = '/foo/'\n+        self.assertEqual('/foo/', self.settings_module.MEDIA_URL)\n+\n+        self.settings_module.MEDIA_URL = 'http://media.foo.com/'\n+        self.assertEqual('http://media.foo.com/',\n+                         self.settings_module.MEDIA_URL)\n+\n+    def test_no_end_slash(self):\n+        \"\"\"\n+        MEDIA_URL raises an PendingDeprecationWarning error if it doesn't end in a\n+        slash.\n+        \"\"\"\n+        import warnings\n+        warnings.filterwarnings('error', 'If set, MEDIA_URL must end with a slash', PendingDeprecationWarning)\n+\n+        def setattr_settings(settings_module, attr, value):\n+            setattr(settings_module, attr, value)\n+\n+        self.assertRaises(PendingDeprecationWarning, setattr_settings,\n+                          self.settings_module, 'MEDIA_URL', '/foo')\n+\n+        self.assertRaises(PendingDeprecationWarning, setattr_settings,\n+                          self.settings_module, 'MEDIA_URL',\n+                          'http://media.foo.com')\n+\n+    def test_double_slash(self):\n+        \"\"\"\n+        If a MEDIA_URL ends in more than one slash, presume they know what\n+        they're doing.\n+        \"\"\"\n+        self.settings_module.MEDIA_URL = '/stupid//'\n+        self.assertEqual('/stupid//', self.settings_module.MEDIA_URL)\n+\n+        self.settings_module.MEDIA_URL = 'http://media.foo.com/stupid//'\n+        self.assertEqual('http://media.foo.com/stupid//',\n+                         self.settings_module.MEDIA_URL)"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 102,
        "deletions": 7
    }
}