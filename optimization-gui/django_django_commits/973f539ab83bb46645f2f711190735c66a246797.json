{
    "author": "aaugustin",
    "message": "Fixed #15152 -- Avoided crash of CommonMiddleware on broken querystring",
    "sha": "973f539ab83bb46645f2f711190735c66a246797",
    "files": [
        {
            "sha": "ccc9fbfaadce460ac4f5675c3f2faa13becfac3f",
            "filename": "django/middleware/common.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/973f539ab83bb46645f2f711190735c66a246797/django%2Fmiddleware%2Fcommon.py",
            "raw_url": "https://github.com/django/django/raw/973f539ab83bb46645f2f711190735c66a246797/django%2Fmiddleware%2Fcommon.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcommon.py?ref=973f539ab83bb46645f2f711190735c66a246797",
            "patch": "@@ -6,6 +6,7 @@\n from django import http\n from django.core.mail import mail_managers\n from django.utils.http import urlquote\n+from django.utils import six\n from django.core import urlresolvers\n \n \n@@ -87,7 +88,17 @@ def process_request(self, request):\n         else:\n             newurl = urlquote(new_url[1])\n         if request.META.get('QUERY_STRING', ''):\n-            newurl += '?' + request.META['QUERY_STRING']\n+            if six.PY3:\n+                newurl += '?' + request.META['QUERY_STRING']\n+            else:\n+                # `query_string` is a bytestring. Appending it to the unicode\n+                # string `newurl` will fail if it isn't ASCII-only. This isn't\n+                # allowed; only broken software generates such query strings.\n+                # Better drop the invalid query string than crash (#15152).\n+                try:\n+                    newurl += '?' + request.META['QUERY_STRING'].decode()\n+                except UnicodeDecodeError:\n+                    pass\n         return http.HttpResponsePermanentRedirect(newurl)\n \n     def process_response(self, request, response):"
        },
        {
            "sha": "b8cffd9c92528cbdb39e172b4cccb1488a3965dd",
            "filename": "tests/regressiontests/middleware/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/973f539ab83bb46645f2f711190735c66a246797/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/973f539ab83bb46645f2f711190735c66a246797/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Ftests.py?ref=973f539ab83bb46645f2f711190735c66a246797",
            "patch": "@@ -294,6 +294,15 @@ def test_404_error_reporting_ignored_url(self):\n         CommonMiddleware().process_response(request, response)\n         self.assertEqual(len(mail.outbox), 0)\n \n+    # Other tests\n+\n+    def test_non_ascii_query_string_does_not_crash(self):\n+        \"\"\"Regression test for #15152\"\"\"\n+        request = self._get_request('slash')\n+        request.META['QUERY_STRING'] = 'drink=caf√©'\n+        response = CommonMiddleware().process_request(request)\n+        self.assertEqual(response.status_code, 301)\n+\n \n class ConditionalGetMiddlewareTest(TestCase):\n     urls = 'regressiontests.middleware.cond_get_urls'"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 21,
        "deletions": 1
    }
}