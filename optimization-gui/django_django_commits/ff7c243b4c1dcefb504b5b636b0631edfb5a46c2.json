{
    "author": "spookylukey",
    "message": "Fixed #14697 - speeded up model instance creation by moving work outside of loops\n\nThanks to akaariai for the report and initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14687 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ff7c243b4c1dcefb504b5b636b0631edfb5a46c2",
    "files": [
        {
            "sha": "d22a158188752e65db31e9f266a58bb4c866a16d",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 14,
            "deletions": 9,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/ff7c243b4c1dcefb504b5b636b0631edfb5a46c2/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/ff7c243b4c1dcefb504b5b636b0631edfb5a46c2/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=ff7c243b4c1dcefb504b5b636b0631edfb5a46c2",
            "patch": "@@ -266,11 +266,14 @@ def iterator(self):\n                     init_list.append(field.attname)\n             model_cls = deferred_class_factory(self.model, skip)\n \n-        compiler = self.query.get_compiler(using=self.db)\n+        # Cache db and model outside the loop\n+        db = self.db\n+        model = self.model\n+        compiler = self.query.get_compiler(using=db)\n         for row in compiler.results_iter():\n             if fill_cache:\n-                obj, _ = get_cached_row(self.model, row,\n-                            index_start, using=self.db, max_depth=max_depth,\n+                obj, _ = get_cached_row(model, row,\n+                            index_start, using=db, max_depth=max_depth,\n                             requested=requested, offset=len(aggregate_select),\n                             only_load=only_load)\n             else:\n@@ -280,19 +283,21 @@ def iterator(self):\n                     obj = model_cls(**dict(zip(init_list, row_data)))\n                 else:\n                     # Omit aggregates in object creation.\n-                    obj = self.model(*row[index_start:aggregate_start])\n+                    obj = model(*row[index_start:aggregate_start])\n \n                 # Store the source database of the object\n-                obj._state.db = self.db\n+                obj._state.db = db\n                 # This object came from the database; it's not being added.\n                 obj._state.adding = False\n \n-            for i, k in enumerate(extra_select):\n-                setattr(obj, k, row[i])\n+            if extra_select:\n+                for i, k in enumerate(extra_select):\n+                    setattr(obj, k, row[i])\n \n             # Add the aggregates to the model\n-            for i, aggregate in enumerate(aggregate_select):\n-                setattr(obj, aggregate, row[i+aggregate_start])\n+            if aggregate_select:\n+                for i, aggregate in enumerate(aggregate_select):\n+                    setattr(obj, aggregate, row[i+aggregate_start])\n \n             yield obj\n "
        },
        {
            "sha": "b2249dc607c4f665778c78f41eb2e22533e2a247",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/ff7c243b4c1dcefb504b5b636b0631edfb5a46c2/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/ff7c243b4c1dcefb504b5b636b0631edfb5a46c2/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=ff7c243b4c1dcefb504b5b636b0631edfb5a46c2",
            "patch": "@@ -672,6 +672,7 @@ def results_iter(self):\n         \"\"\"\n         resolve_columns = hasattr(self, 'resolve_columns')\n         fields = None\n+        has_aggregate_select = bool(self.query.aggregate_select)\n         for rows in self.execute_sql(MULTI):\n             for row in rows:\n                 if resolve_columns:\n@@ -692,7 +693,7 @@ def results_iter(self):\n                                       f.column in only_load[db_table]]\n                     row = self.resolve_columns(row, fields)\n \n-                if self.query.aggregate_select:\n+                if has_aggregate_select:\n                     aggregate_start = len(self.query.extra_select.keys()) + len(self.query.select)\n                     aggregate_end = aggregate_start + len(self.query.aggregate_select)\n                     row = tuple(row[:aggregate_start]) + tuple(["
        }
    ],
    "stats": {
        "total": 26,
        "additions": 16,
        "deletions": 10
    }
}