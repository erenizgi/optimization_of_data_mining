{
    "author": "akaariai",
    "message": "Fixed SQLite's collapsing of same-valued instances in bulk_create\n\nSQLite used INSERT INTO tbl SELECT %s UNION SELECT %s, the problem\nwas that there should have been UNION ALL instead of UNION.\n\nRefs #19351",
    "sha": "a27582484cf814554907d2d1ad077852de36963f",
    "files": [
        {
            "sha": "7f0c51dd50f606c26911a05040870f87d28ae798",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/a27582484cf814554907d2d1ad077852de36963f/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/a27582484cf814554907d2d1ad077852de36963f/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=a27582484cf814554907d2d1ad077852de36963f",
            "patch": "@@ -227,7 +227,7 @@ def bulk_insert_sql(self, fields, num_values):\n         res.append(\"SELECT %s\" % \", \".join(\n             \"%%s AS %s\" % self.quote_name(f.column) for f in fields\n         ))\n-        res.extend([\"UNION SELECT %s\" % \", \".join([\"%s\"] * len(fields))] * (num_values - 1))\n+        res.extend([\"UNION ALL SELECT %s\" % \", \".join([\"%s\"] * len(fields))] * (num_values - 1))\n         return \" \".join(res)\n \n class DatabaseWrapper(BaseDatabaseWrapper):"
        },
        {
            "sha": "7cd74d1b476e7a0de7dde3cd55f5b8ee3060f106",
            "filename": "tests/regressiontests/bulk_create/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/a27582484cf814554907d2d1ad077852de36963f/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a27582484cf814554907d2d1ad077852de36963f/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbulk_create%2Ftests.py?ref=a27582484cf814554907d2d1ad077852de36963f",
            "patch": "@@ -82,6 +82,14 @@ def test_zero_as_autoval(self):\n         with self.assertRaises(ValueError):\n             Country.objects.bulk_create([valid_country, invalid_country])\n \n+    def test_batch_same_vals(self):\n+        # Sqlite had a problem where all the same-valued models were\n+        # collapsed to one insert.\n+        Restaurant.objects.bulk_create([\n+            Restaurant(name='foo') for i in range(0, 2)\n+        ])\n+        self.assertEqual(Restaurant.objects.count(), 2)\n+\n     def test_large_batch(self):\n         with override_settings(DEBUG=True):\n             connection.queries = []"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 9,
        "deletions": 1
    }
}