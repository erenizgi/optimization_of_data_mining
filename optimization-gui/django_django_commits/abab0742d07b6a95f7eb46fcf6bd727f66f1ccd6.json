{
    "author": "jbronn",
    "message": "Fixed integer overflows that occurred when `OFTReal` fields were treated as `OFTInteger`.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15946 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6",
    "files": [
        {
            "sha": "2b831b5516c247a8db9163d1273940c76595b22c",
            "filename": "django/contrib/gis/gdal/field.py",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py",
            "raw_url": "https://github.com/django/django/raw/abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py?ref=abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6",
            "patch": "@@ -20,7 +20,7 @@ def __init__(self, feat, index):\n         # Setting the feature pointer and index.\n         self._feat = feat\n         self._index = index\n-        \n+\n         # Getting the pointer for this field.\n         fld_ptr = capi.get_feat_field_defn(feat, index)\n         if not fld_ptr:\n@@ -33,6 +33,7 @@ def __init__(self, feat, index):\n         # OFTReal with no precision should be an OFTInteger.\n         if isinstance(self, OFTReal) and self.precision == 0:\n             self.__class__ = OFTInteger\n+            self._double = True\n \n     def __str__(self):\n         \"Returns the string representation of the Field.\"\n@@ -95,10 +96,17 @@ def width(self):\n \n ### The Field sub-classes for each OGR Field type. ###\n class OFTInteger(Field):\n+    _double = False\n+\n     @property\n     def value(self):\n         \"Returns an integer contained in this field.\"\n-        return self.as_int()\n+        if self._double:\n+            # If this is really from an OFTReal field with no precision,\n+            # read as a double and cast as Python int (to prevent overflow).\n+            return int(self.as_double())\n+        else:\n+            return self.as_int()\n \n     @property\n     def type(self):\n@@ -137,7 +145,7 @@ def value(self):\n         \"Returns a Python `datetime` object for this OFTDateTime field.\"\n         # TODO: Adapt timezone information.\n         #  See http://lists.maptools.org/pipermail/gdal-dev/2006-February/007990.html\n-        #  The `tz` variable has values of: 0=unknown, 1=localtime (ambiguous), \n+        #  The `tz` variable has values of: 0=unknown, 1=localtime (ambiguous),\n         #  100=GMT, 104=GMT+1, 80=GMT-5, etc.\n         try:\n             yy, mm, dd, hh, mn, ss, tz = self.as_datetime()"
        },
        {
            "sha": "16d6e8603b7abb68c7db4beec6ef7a7394f8adb5",
            "filename": "django/contrib/gis/gdal/tests/test_ds.py",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "raw_url": "https://github.com/django/django/raw/abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py?ref=abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6",
            "patch": "@@ -1,7 +1,8 @@\n-import os, os.path, unittest\n+import os\n+import unittest\n from django.contrib.gis.gdal import DataSource, Envelope, OGRGeometry, OGRException, OGRIndexError, GDAL_VERSION\n from django.contrib.gis.gdal.field import OFTReal, OFTInteger, OFTString\n-from django.contrib.gis.geometry.test_data import get_ds_file, TestDS\n+from django.contrib.gis.geometry.test_data import get_ds_file, TestDS, TEST_DATA\n \n # List of acceptable data sources.\n ds_list = (TestDS('test_point', nfeat=5, nfld=3, geom='POINT', gtype=1, driver='ESRI Shapefile',\n@@ -72,7 +73,7 @@ def test03a_layers(self):\n                 self.assertEqual(source.nfld, len(layer.fields))\n \n                 # Testing the layer's extent (an Envelope), and it's properties\n-                if source.driver == 'VRT' and (GDAL_VERSION > (1, 7, 0) and GDAL_VERSION < (1, 7, 3)):\n+                if source.driver == 'VRT' and (GDAL_VERSION >= (1, 7, 0) and GDAL_VERSION < (1, 7, 3)):\n                     # There's a known GDAL regression with retrieving the extent\n                     # of a VRT layer in versions 1.7.0-1.7.2:\n                     #  http://trac.osgeo.org/gdal/ticket/3783\n@@ -217,6 +218,16 @@ def test06_spatial_filter(self):\n         lyr.spatial_filter = None\n         self.assertEqual(3, len(lyr))\n \n+    def test07_integer_overflow(self):\n+        \"Testing that OFTReal fields, treated as OFTInteger, do not overflow.\"\n+        # Using *.dbf from Census 2010 TIGER Shapefile for Texas,\n+        # which has land area ('ALAND10') stored in a Real field\n+        # with no precision.\n+        ds = DataSource(os.path.join(TEST_DATA, 'texas.dbf'))\n+        feat = ds[0][0]\n+        # Reference value obtained using `ogrinfo`.\n+        self.assertEqual(676586997978, feat.get('ALAND10'))\n+\n def suite():\n     s = unittest.TestSuite()\n     s.addTest(unittest.makeSuite(DataSourceTest))"
        },
        {
            "sha": "827c06507199fae9134db5d43eea9a142933e828",
            "filename": "django/contrib/gis/tests/data/texas.dbf",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Ftexas.dbf",
            "raw_url": "https://github.com/django/django/raw/abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Ftexas.dbf",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Ftexas.dbf?ref=abab0742d07b6a95f7eb46fcf6bd727f66f1ccd6"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 25,
        "deletions": 6
    }
}