{
    "author": "claudep",
    "message": "Used skipIf decorator to skip image tests when PIL is not available",
    "sha": "86eb606b88b3979de8074c3a049535150a0cc8a5",
    "files": [
        {
            "sha": "7446f222ff5b1b409362a4ea6d2d42b90c27c450",
            "filename": "tests/regressiontests/model_fields/imagefield.py",
            "status": "modified",
            "additions": 400,
            "deletions": 388,
            "changes": 788,
            "blob_url": "https://github.com/django/django/blob/86eb606b88b3979de8074c3a049535150a0cc8a5/tests%2Fregressiontests%2Fmodel_fields%2Fimagefield.py",
            "raw_url": "https://github.com/django/django/raw/86eb606b88b3979de8074c3a049535150a0cc8a5/tests%2Fregressiontests%2Fmodel_fields%2Fimagefield.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Fimagefield.py?ref=86eb606b88b3979de8074c3a049535150a0cc8a5",
            "patch": "@@ -6,416 +6,428 @@\n from django.core.files import File\n from django.core.files.images import ImageFile\n from django.test import TestCase\n+from django.utils.unittest import skipIf\n \n-from .models import (Image, Person, PersonWithHeight, PersonWithHeightAndWidth,\n-    PersonDimensionsFirst, PersonTwoImages, TestImageFieldFile)\n+from .models import Image\n \n-\n-# If PIL available, do these tests.\n if Image:\n-\n+    from .models import (Person, PersonWithHeight, PersonWithHeightAndWidth,\n+        PersonDimensionsFirst, PersonTwoImages, TestImageFieldFile)\n     from .models import temp_storage_dir\n+else:\n+    # PIL not available, create dummy classes (tests will be skipped anyway)\n+    class Person():\n+        pass\n+    PersonWithHeight = PersonWithHeightAndWidth = PersonDimensionsFirst = Person\n+    PersonTwoImages = Person\n+\n \n+class ImageFieldTestMixin(object):\n+    \"\"\"\n+    Mixin class to provide common functionality to ImageField test classes.\n+    \"\"\"\n \n-    class ImageFieldTestMixin(object):\n+    # Person model to use for tests.\n+    PersonModel = PersonWithHeightAndWidth\n+    # File class to use for file instances.\n+    File = ImageFile\n+\n+    def setUp(self):\n         \"\"\"\n-        Mixin class to provide common functionality to ImageField test classes.\n+        Creates a pristine temp directory (or deletes and recreates if it\n+        already exists) that the model uses as its storage directory.\n+\n+        Sets up two ImageFile instances for use in tests.\n         \"\"\"\n+        if os.path.exists(temp_storage_dir):\n+            shutil.rmtree(temp_storage_dir)\n+        os.mkdir(temp_storage_dir)\n \n-        # Person model to use for tests.\n-        PersonModel = PersonWithHeightAndWidth\n-        # File class to use for file instances.\n-        File = ImageFile\n+        file_path1 = os.path.join(os.path.dirname(__file__), \"4x8.png\")\n+        self.file1 = self.File(open(file_path1, 'rb'))\n \n-        def setUp(self):\n-            \"\"\"\n-            Creates a pristine temp directory (or deletes and recreates if it\n-            already exists) that the model uses as its storage directory.\n+        file_path2 = os.path.join(os.path.dirname(__file__), \"8x4.png\")\n+        self.file2 = self.File(open(file_path2, 'rb'))\n \n-            Sets up two ImageFile instances for use in tests.\n-            \"\"\"\n-            if os.path.exists(temp_storage_dir):\n-                shutil.rmtree(temp_storage_dir)\n-            os.mkdir(temp_storage_dir)\n+    def tearDown(self):\n+        \"\"\"\n+        Removes temp directory and all its contents.\n+        \"\"\"\n+        shutil.rmtree(temp_storage_dir)\n \n-            file_path1 = os.path.join(os.path.dirname(__file__), \"4x8.png\")\n-            self.file1 = self.File(open(file_path1, 'rb'))\n+    def check_dimensions(self, instance, width, height,\n+                         field_name='mugshot'):\n+        \"\"\"\n+        Asserts that the given width and height values match both the\n+        field's height and width attributes and the height and width fields\n+        (if defined) the image field is caching to.\n \n-            file_path2 = os.path.join(os.path.dirname(__file__), \"8x4.png\")\n-            self.file2 = self.File(open(file_path2, 'rb'))\n+        Note, this method will check for dimension fields named by adding\n+        \"_width\" or \"_height\" to the name of the ImageField.  So, the\n+        models used in these tests must have their fields named\n+        accordingly.\n \n-        def tearDown(self):\n-            \"\"\"\n-            Removes temp directory and all its contents.\n-            \"\"\"\n-            shutil.rmtree(temp_storage_dir)\n+        By default, we check the field named \"mugshot\", but this can be\n+        specified by passing the field_name parameter.\n+        \"\"\"\n+        field = getattr(instance, field_name)\n+        # Check height/width attributes of field.\n+        if width is None and height is None:\n+            self.assertRaises(ValueError, getattr, field, 'width')\n+            self.assertRaises(ValueError, getattr, field, 'height')\n+        else:\n+            self.assertEqual(field.width, width)\n+            self.assertEqual(field.height, height)\n+\n+        # Check height/width fields of model, if defined.\n+        width_field_name = field_name + '_width'\n+        if hasattr(instance, width_field_name):\n+            self.assertEqual(getattr(instance, width_field_name), width)\n+        height_field_name = field_name + '_height'\n+        if hasattr(instance, height_field_name):\n+            self.assertEqual(getattr(instance, height_field_name), height)\n+\n+\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class ImageFieldTests(ImageFieldTestMixin, TestCase):\n+    \"\"\"\n+    Tests for ImageField that don't need to be run with each of the\n+    different test model classes.\n+    \"\"\"\n+\n+    def test_equal_notequal_hash(self):\n+        \"\"\"\n+        Bug #9786: Ensure '==' and '!=' work correctly.\n+        Bug #9508: make sure hash() works as expected (equal items must\n+        hash to the same value).\n+        \"\"\"\n+        # Create two Persons with different mugshots.\n+        p1 = self.PersonModel(name=\"Joe\")\n+        p1.mugshot.save(\"mug\", self.file1)\n+        p2 = self.PersonModel(name=\"Bob\")\n+        p2.mugshot.save(\"mug\", self.file2)\n+        self.assertEqual(p1.mugshot == p2.mugshot, False)\n+        self.assertEqual(p1.mugshot != p2.mugshot, True)\n+\n+        # Test again with an instance fetched from the db.\n+        p1_db = self.PersonModel.objects.get(name=\"Joe\")\n+        self.assertEqual(p1_db.mugshot == p2.mugshot, False)\n+        self.assertEqual(p1_db.mugshot != p2.mugshot, True)\n+\n+        # Instance from db should match the local instance.\n+        self.assertEqual(p1_db.mugshot == p1.mugshot, True)\n+        self.assertEqual(hash(p1_db.mugshot), hash(p1.mugshot))\n+        self.assertEqual(p1_db.mugshot != p1.mugshot, False)\n+\n+    def test_instantiate_missing(self):\n+        \"\"\"\n+        If the underlying file is unavailable, still create instantiate the\n+        object without error.\n+        \"\"\"\n+        p = self.PersonModel(name=\"Joan\")\n+        p.mugshot.save(\"shot\", self.file1)\n+        p = self.PersonModel.objects.get(name=\"Joan\")\n+        path = p.mugshot.path\n+        shutil.move(path, path + '.moved')\n+        p2 = self.PersonModel.objects.get(name=\"Joan\")\n+\n+    def test_delete_when_missing(self):\n+        \"\"\"\n+        Bug #8175: correctly delete an object where the file no longer\n+        exists on the file system.\n+        \"\"\"\n+        p = self.PersonModel(name=\"Fred\")\n+        p.mugshot.save(\"shot\", self.file1)\n+        os.remove(p.mugshot.path)\n+        p.delete()\n \n-        def check_dimensions(self, instance, width, height,\n-                             field_name='mugshot'):\n-            \"\"\"\n-            Asserts that the given width and height values match both the\n-            field's height and width attributes and the height and width fields\n-            (if defined) the image field is caching to.\n-\n-            Note, this method will check for dimension fields named by adding\n-            \"_width\" or \"_height\" to the name of the ImageField.  So, the\n-            models used in these tests must have their fields named\n-            accordingly.\n-\n-            By default, we check the field named \"mugshot\", but this can be\n-            specified by passing the field_name parameter.\n-            \"\"\"\n-            field = getattr(instance, field_name)\n-            # Check height/width attributes of field.\n-            if width is None and height is None:\n-                self.assertRaises(ValueError, getattr, field, 'width')\n-                self.assertRaises(ValueError, getattr, field, 'height')\n-            else:\n-                self.assertEqual(field.width, width)\n-                self.assertEqual(field.height, height)\n-\n-            # Check height/width fields of model, if defined.\n-            width_field_name = field_name + '_width'\n-            if hasattr(instance, width_field_name):\n-                self.assertEqual(getattr(instance, width_field_name), width)\n-            height_field_name = field_name + '_height'\n-            if hasattr(instance, height_field_name):\n-                self.assertEqual(getattr(instance, height_field_name), height)\n-\n-\n-    class ImageFieldTests(ImageFieldTestMixin, TestCase):\n-        \"\"\"\n-        Tests for ImageField that don't need to be run with each of the\n-        different test model classes.\n-        \"\"\"\n-\n-        def test_equal_notequal_hash(self):\n-            \"\"\"\n-            Bug #9786: Ensure '==' and '!=' work correctly.\n-            Bug #9508: make sure hash() works as expected (equal items must\n-            hash to the same value).\n-            \"\"\"\n-            # Create two Persons with different mugshots.\n-            p1 = self.PersonModel(name=\"Joe\")\n-            p1.mugshot.save(\"mug\", self.file1)\n-            p2 = self.PersonModel(name=\"Bob\")\n-            p2.mugshot.save(\"mug\", self.file2)\n-            self.assertEqual(p1.mugshot == p2.mugshot, False)\n-            self.assertEqual(p1.mugshot != p2.mugshot, True)\n-\n-            # Test again with an instance fetched from the db.\n-            p1_db = self.PersonModel.objects.get(name=\"Joe\")\n-            self.assertEqual(p1_db.mugshot == p2.mugshot, False)\n-            self.assertEqual(p1_db.mugshot != p2.mugshot, True)\n-\n-            # Instance from db should match the local instance.\n-            self.assertEqual(p1_db.mugshot == p1.mugshot, True)\n-            self.assertEqual(hash(p1_db.mugshot), hash(p1.mugshot))\n-            self.assertEqual(p1_db.mugshot != p1.mugshot, False)\n-\n-        def test_instantiate_missing(self):\n-            \"\"\"\n-            If the underlying file is unavailable, still create instantiate the\n-            object without error.\n-            \"\"\"\n-            p = self.PersonModel(name=\"Joan\")\n-            p.mugshot.save(\"shot\", self.file1)\n-            p = self.PersonModel.objects.get(name=\"Joan\")\n-            path = p.mugshot.path\n-            shutil.move(path, path + '.moved')\n-            p2 = self.PersonModel.objects.get(name=\"Joan\")\n-\n-        def test_delete_when_missing(self):\n-            \"\"\"\n-            Bug #8175: correctly delete an object where the file no longer\n-            exists on the file system.\n-            \"\"\"\n-            p = self.PersonModel(name=\"Fred\")\n-            p.mugshot.save(\"shot\", self.file1)\n-            os.remove(p.mugshot.path)\n-            p.delete()\n-\n-        def test_size_method(self):\n-            \"\"\"\n-            Bug #8534: FileField.size should not leave the file open.\n-            \"\"\"\n-            p = self.PersonModel(name=\"Joan\")\n-            p.mugshot.save(\"shot\", self.file1)\n-\n-            # Get a \"clean\" model instance\n-            p = self.PersonModel.objects.get(name=\"Joan\")\n-            # It won't have an opened file.\n-            self.assertEqual(p.mugshot.closed, True)\n-\n-            # After asking for the size, the file should still be closed.\n-            _ = p.mugshot.size\n-            self.assertEqual(p.mugshot.closed, True)\n-\n-        def test_pickle(self):\n-            \"\"\"\n-            Tests that ImageField can be pickled, unpickled, and that the\n-            image of the unpickled version is the same as the original.\n-            \"\"\"\n-            import pickle\n-\n-            p = Person(name=\"Joe\")\n-            p.mugshot.save(\"mug\", self.file1)\n-            dump = pickle.dumps(p)\n-\n-            p2 = Person(name=\"Bob\")\n-            p2.mugshot = self.file1\n-\n-            loaded_p = pickle.loads(dump)\n-            self.assertEqual(p.mugshot, loaded_p.mugshot)\n-\n-\n-    class ImageFieldTwoDimensionsTests(ImageFieldTestMixin, TestCase):\n-        \"\"\"\n-        Tests behavior of an ImageField and its dimensions fields.\n-        \"\"\"\n-\n-        def test_constructor(self):\n-            \"\"\"\n-            Tests assigning an image field through the model's constructor.\n-            \"\"\"\n-            p = self.PersonModel(name='Joe', mugshot=self.file1)\n-            self.check_dimensions(p, 4, 8)\n-            p.save()\n-            self.check_dimensions(p, 4, 8)\n-\n-        def test_image_after_constructor(self):\n-            \"\"\"\n-            Tests behavior when image is not passed in constructor.\n-            \"\"\"\n-            p = self.PersonModel(name='Joe')\n-            # TestImageField value will default to being an instance of its\n-            # attr_class, a  TestImageFieldFile, with name == None, which will\n-            # cause it to evaluate as False.\n-            self.assertEqual(isinstance(p.mugshot, TestImageFieldFile), True)\n-            self.assertEqual(bool(p.mugshot), False)\n-\n-            # Test setting a fresh created model instance.\n-            p = self.PersonModel(name='Joe')\n-            p.mugshot = self.file1\n-            self.check_dimensions(p, 4, 8)\n-\n-        def test_create(self):\n-            \"\"\"\n-            Tests assigning an image in Manager.create().\n-            \"\"\"\n-            p = self.PersonModel.objects.create(name='Joe', mugshot=self.file1)\n-            self.check_dimensions(p, 4, 8)\n-\n-        def test_default_value(self):\n-            \"\"\"\n-            Tests that the default value for an ImageField is an instance of\n-            the field's attr_class (TestImageFieldFile in this case) with no\n-            name (name set to None).\n-            \"\"\"\n-            p = self.PersonModel()\n-            self.assertEqual(isinstance(p.mugshot, TestImageFieldFile), True)\n-            self.assertEqual(bool(p.mugshot), False)\n-\n-        def test_assignment_to_None(self):\n-            \"\"\"\n-            Tests that assigning ImageField to None clears dimensions.\n-            \"\"\"\n-            p = self.PersonModel(name='Joe', mugshot=self.file1)\n-            self.check_dimensions(p, 4, 8)\n+    def test_size_method(self):\n+        \"\"\"\n+        Bug #8534: FileField.size should not leave the file open.\n+        \"\"\"\n+        p = self.PersonModel(name=\"Joan\")\n+        p.mugshot.save(\"shot\", self.file1)\n \n-            # If image assigned to None, dimension fields should be cleared.\n-            p.mugshot = None\n-            self.check_dimensions(p, None, None)\n+        # Get a \"clean\" model instance\n+        p = self.PersonModel.objects.get(name=\"Joan\")\n+        # It won't have an opened file.\n+        self.assertEqual(p.mugshot.closed, True)\n \n-            p.mugshot = self.file2\n-            self.check_dimensions(p, 8, 4)\n+        # After asking for the size, the file should still be closed.\n+        _ = p.mugshot.size\n+        self.assertEqual(p.mugshot.closed, True)\n \n-        def test_field_save_and_delete_methods(self):\n-            \"\"\"\n-            Tests assignment using the field's save method and deletion using\n-            the field's delete method.\n-            \"\"\"\n-            p = self.PersonModel(name='Joe')\n-            p.mugshot.save(\"mug\", self.file1)\n-            self.check_dimensions(p, 4, 8)\n+    def test_pickle(self):\n+        \"\"\"\n+        Tests that ImageField can be pickled, unpickled, and that the\n+        image of the unpickled version is the same as the original.\n+        \"\"\"\n+        import pickle\n \n-            # A new file should update dimensions.\n-            p.mugshot.save(\"mug\", self.file2)\n-            self.check_dimensions(p, 8, 4)\n+        p = Person(name=\"Joe\")\n+        p.mugshot.save(\"mug\", self.file1)\n+        dump = pickle.dumps(p)\n \n-            # Field and dimensions should be cleared after a delete.\n-            p.mugshot.delete(save=False)\n-            self.assertEqual(p.mugshot, None)\n-            self.check_dimensions(p, None, None)\n+        p2 = Person(name=\"Bob\")\n+        p2.mugshot = self.file1\n \n-        def test_dimensions(self):\n-            \"\"\"\n-            Checks that dimensions are updated correctly in various situations.\n-            \"\"\"\n-            p = self.PersonModel(name='Joe')\n+        loaded_p = pickle.loads(dump)\n+        self.assertEqual(p.mugshot, loaded_p.mugshot)\n \n-            # Dimensions should get set if file is saved.\n-            p.mugshot.save(\"mug\", self.file1)\n-            self.check_dimensions(p, 4, 8)\n \n-            # Test dimensions after fetching from database.\n-            p = self.PersonModel.objects.get(name='Joe')\n-            # Bug 11084: Dimensions should not get recalculated if file is\n-            # coming from the database.  We test this by checking if the file\n-            # was opened.\n-            self.assertEqual(p.mugshot.was_opened, False)\n-            self.check_dimensions(p, 4, 8)\n-            # After checking dimensions on the image field, the file will have\n-            # opened.\n-            self.assertEqual(p.mugshot.was_opened, True)\n-            # Dimensions should now be cached, and if we reset was_opened and\n-            # check dimensions again, the file should not have opened.\n-            p.mugshot.was_opened = False\n-            self.check_dimensions(p, 4, 8)\n-            self.assertEqual(p.mugshot.was_opened, False)\n-\n-            # If we assign a new image to the instance, the dimensions should\n-            # update.\n-            p.mugshot = self.file2\n-            self.check_dimensions(p, 8, 4)\n-            # Dimensions were recalculated, and hence file should have opened.\n-            self.assertEqual(p.mugshot.was_opened, True)\n-\n-\n-    class ImageFieldNoDimensionsTests(ImageFieldTwoDimensionsTests):\n-        \"\"\"\n-        Tests behavior of an ImageField with no dimension fields.\n-        \"\"\"\n-\n-        PersonModel = Person\n-\n-\n-    class ImageFieldOneDimensionTests(ImageFieldTwoDimensionsTests):\n-        \"\"\"\n-        Tests behavior of an ImageField with one dimensions field.\n-        \"\"\"\n-\n-        PersonModel = PersonWithHeight\n-\n-\n-    class ImageFieldDimensionsFirstTests(ImageFieldTwoDimensionsTests):\n-        \"\"\"\n-        Tests behavior of an ImageField where the dimensions fields are\n-        defined before the ImageField.\n-        \"\"\"\n-\n-        PersonModel = PersonDimensionsFirst\n-\n-\n-    class ImageFieldUsingFileTests(ImageFieldTwoDimensionsTests):\n-        \"\"\"\n-        Tests behavior of an ImageField when assigning it a File instance\n-        rather than an ImageFile instance.\n-        \"\"\"\n-\n-        PersonModel = PersonDimensionsFirst\n-        File = File\n-\n-\n-    class TwoImageFieldTests(ImageFieldTestMixin, TestCase):\n-        \"\"\"\n-        Tests a model with two ImageFields.\n-        \"\"\"\n-\n-        PersonModel = PersonTwoImages\n-\n-        def test_constructor(self):\n-            p = self.PersonModel(mugshot=self.file1, headshot=self.file2)\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-            p.save()\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-\n-        def test_create(self):\n-            p = self.PersonModel.objects.create(mugshot=self.file1,\n-                                                headshot=self.file2)\n-            self.check_dimensions(p, 4, 8)\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-\n-        def test_assignment(self):\n-            p = self.PersonModel()\n-            self.check_dimensions(p, None, None, 'mugshot')\n-            self.check_dimensions(p, None, None, 'headshot')\n-\n-            p.mugshot = self.file1\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, None, None, 'headshot')\n-            p.headshot = self.file2\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-\n-            # Clear the ImageFields one at a time.\n-            p.mugshot = None\n-            self.check_dimensions(p, None, None, 'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-            p.headshot = None\n-            self.check_dimensions(p, None, None, 'mugshot')\n-            self.check_dimensions(p, None, None, 'headshot')\n-\n-        def test_field_save_and_delete_methods(self):\n-            p = self.PersonModel(name='Joe')\n-            p.mugshot.save(\"mug\", self.file1)\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, None, None, 'headshot')\n-            p.headshot.save(\"head\", self.file2)\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-\n-            # We can use save=True when deleting the image field with null=True\n-            # dimension fields and the other field has an image.\n-            p.headshot.delete(save=True)\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, None, None, 'headshot')\n-            p.mugshot.delete(save=False)\n-            self.check_dimensions(p, None, None, 'mugshot')\n-            self.check_dimensions(p, None, None, 'headshot')\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class ImageFieldTwoDimensionsTests(ImageFieldTestMixin, TestCase):\n+    \"\"\"\n+    Tests behavior of an ImageField and its dimensions fields.\n+    \"\"\"\n \n-        def test_dimensions(self):\n-            \"\"\"\n-            Checks that dimensions are updated correctly in various situations.\n-            \"\"\"\n-            p = self.PersonModel(name='Joe')\n+    def test_constructor(self):\n+        \"\"\"\n+        Tests assigning an image field through the model's constructor.\n+        \"\"\"\n+        p = self.PersonModel(name='Joe', mugshot=self.file1)\n+        self.check_dimensions(p, 4, 8)\n+        p.save()\n+        self.check_dimensions(p, 4, 8)\n \n-            # Dimensions should get set for the saved file.\n-            p.mugshot.save(\"mug\", self.file1)\n-            p.headshot.save(\"head\", self.file2)\n-            self.check_dimensions(p, 4, 8, 'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-\n-            # Test dimensions after fetching from database.\n-            p = self.PersonModel.objects.get(name='Joe')\n-            # Bug 11084: Dimensions should not get recalculated if file is\n-            # coming from the database.  We test this by checking if the file\n-            # was opened.\n-            self.assertEqual(p.mugshot.was_opened, False)\n-            self.assertEqual(p.headshot.was_opened, False)\n-            self.check_dimensions(p, 4, 8,'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-            # After checking dimensions on the image fields, the files will\n-            # have been opened.\n-            self.assertEqual(p.mugshot.was_opened, True)\n-            self.assertEqual(p.headshot.was_opened, True)\n-            # Dimensions should now be cached, and if we reset was_opened and\n-            # check dimensions again, the file should not have opened.\n-            p.mugshot.was_opened = False\n-            p.headshot.was_opened = False\n-            self.check_dimensions(p, 4, 8,'mugshot')\n-            self.check_dimensions(p, 8, 4, 'headshot')\n-            self.assertEqual(p.mugshot.was_opened, False)\n-            self.assertEqual(p.headshot.was_opened, False)\n-\n-            # If we assign a new image to the instance, the dimensions should\n-            # update.\n-            p.mugshot = self.file2\n-            p.headshot = self.file1\n-            self.check_dimensions(p, 8, 4, 'mugshot')\n-            self.check_dimensions(p, 4, 8, 'headshot')\n-            # Dimensions were recalculated, and hence file should have opened.\n-            self.assertEqual(p.mugshot.was_opened, True)\n-            self.assertEqual(p.headshot.was_opened, True)\n+    def test_image_after_constructor(self):\n+        \"\"\"\n+        Tests behavior when image is not passed in constructor.\n+        \"\"\"\n+        p = self.PersonModel(name='Joe')\n+        # TestImageField value will default to being an instance of its\n+        # attr_class, a  TestImageFieldFile, with name == None, which will\n+        # cause it to evaluate as False.\n+        self.assertEqual(isinstance(p.mugshot, TestImageFieldFile), True)\n+        self.assertEqual(bool(p.mugshot), False)\n+\n+        # Test setting a fresh created model instance.\n+        p = self.PersonModel(name='Joe')\n+        p.mugshot = self.file1\n+        self.check_dimensions(p, 4, 8)\n+\n+    def test_create(self):\n+        \"\"\"\n+        Tests assigning an image in Manager.create().\n+        \"\"\"\n+        p = self.PersonModel.objects.create(name='Joe', mugshot=self.file1)\n+        self.check_dimensions(p, 4, 8)\n+\n+    def test_default_value(self):\n+        \"\"\"\n+        Tests that the default value for an ImageField is an instance of\n+        the field's attr_class (TestImageFieldFile in this case) with no\n+        name (name set to None).\n+        \"\"\"\n+        p = self.PersonModel()\n+        self.assertEqual(isinstance(p.mugshot, TestImageFieldFile), True)\n+        self.assertEqual(bool(p.mugshot), False)\n+\n+    def test_assignment_to_None(self):\n+        \"\"\"\n+        Tests that assigning ImageField to None clears dimensions.\n+        \"\"\"\n+        p = self.PersonModel(name='Joe', mugshot=self.file1)\n+        self.check_dimensions(p, 4, 8)\n+\n+        # If image assigned to None, dimension fields should be cleared.\n+        p.mugshot = None\n+        self.check_dimensions(p, None, None)\n+\n+        p.mugshot = self.file2\n+        self.check_dimensions(p, 8, 4)\n+\n+    def test_field_save_and_delete_methods(self):\n+        \"\"\"\n+        Tests assignment using the field's save method and deletion using\n+        the field's delete method.\n+        \"\"\"\n+        p = self.PersonModel(name='Joe')\n+        p.mugshot.save(\"mug\", self.file1)\n+        self.check_dimensions(p, 4, 8)\n+\n+        # A new file should update dimensions.\n+        p.mugshot.save(\"mug\", self.file2)\n+        self.check_dimensions(p, 8, 4)\n+\n+        # Field and dimensions should be cleared after a delete.\n+        p.mugshot.delete(save=False)\n+        self.assertEqual(p.mugshot, None)\n+        self.check_dimensions(p, None, None)\n+\n+    def test_dimensions(self):\n+        \"\"\"\n+        Checks that dimensions are updated correctly in various situations.\n+        \"\"\"\n+        p = self.PersonModel(name='Joe')\n+\n+        # Dimensions should get set if file is saved.\n+        p.mugshot.save(\"mug\", self.file1)\n+        self.check_dimensions(p, 4, 8)\n+\n+        # Test dimensions after fetching from database.\n+        p = self.PersonModel.objects.get(name='Joe')\n+        # Bug 11084: Dimensions should not get recalculated if file is\n+        # coming from the database.  We test this by checking if the file\n+        # was opened.\n+        self.assertEqual(p.mugshot.was_opened, False)\n+        self.check_dimensions(p, 4, 8)\n+        # After checking dimensions on the image field, the file will have\n+        # opened.\n+        self.assertEqual(p.mugshot.was_opened, True)\n+        # Dimensions should now be cached, and if we reset was_opened and\n+        # check dimensions again, the file should not have opened.\n+        p.mugshot.was_opened = False\n+        self.check_dimensions(p, 4, 8)\n+        self.assertEqual(p.mugshot.was_opened, False)\n+\n+        # If we assign a new image to the instance, the dimensions should\n+        # update.\n+        p.mugshot = self.file2\n+        self.check_dimensions(p, 8, 4)\n+        # Dimensions were recalculated, and hence file should have opened.\n+        self.assertEqual(p.mugshot.was_opened, True)\n+\n+\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class ImageFieldNoDimensionsTests(ImageFieldTwoDimensionsTests):\n+    \"\"\"\n+    Tests behavior of an ImageField with no dimension fields.\n+    \"\"\"\n+\n+    PersonModel = Person\n+\n+\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class ImageFieldOneDimensionTests(ImageFieldTwoDimensionsTests):\n+    \"\"\"\n+    Tests behavior of an ImageField with one dimensions field.\n+    \"\"\"\n+\n+    PersonModel = PersonWithHeight\n+\n+\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class ImageFieldDimensionsFirstTests(ImageFieldTwoDimensionsTests):\n+    \"\"\"\n+    Tests behavior of an ImageField where the dimensions fields are\n+    defined before the ImageField.\n+    \"\"\"\n+\n+    PersonModel = PersonDimensionsFirst\n+\n+\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class ImageFieldUsingFileTests(ImageFieldTwoDimensionsTests):\n+    \"\"\"\n+    Tests behavior of an ImageField when assigning it a File instance\n+    rather than an ImageFile instance.\n+    \"\"\"\n+\n+    PersonModel = PersonDimensionsFirst\n+    File = File\n+\n+\n+@skipIf(Image is None, \"PIL is required to test ImageField\")\n+class TwoImageFieldTests(ImageFieldTestMixin, TestCase):\n+    \"\"\"\n+    Tests a model with two ImageFields.\n+    \"\"\"\n+\n+    PersonModel = PersonTwoImages\n+\n+    def test_constructor(self):\n+        p = self.PersonModel(mugshot=self.file1, headshot=self.file2)\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+        p.save()\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+\n+    def test_create(self):\n+        p = self.PersonModel.objects.create(mugshot=self.file1,\n+                                            headshot=self.file2)\n+        self.check_dimensions(p, 4, 8)\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+\n+    def test_assignment(self):\n+        p = self.PersonModel()\n+        self.check_dimensions(p, None, None, 'mugshot')\n+        self.check_dimensions(p, None, None, 'headshot')\n+\n+        p.mugshot = self.file1\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, None, None, 'headshot')\n+        p.headshot = self.file2\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+\n+        # Clear the ImageFields one at a time.\n+        p.mugshot = None\n+        self.check_dimensions(p, None, None, 'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+        p.headshot = None\n+        self.check_dimensions(p, None, None, 'mugshot')\n+        self.check_dimensions(p, None, None, 'headshot')\n+\n+    def test_field_save_and_delete_methods(self):\n+        p = self.PersonModel(name='Joe')\n+        p.mugshot.save(\"mug\", self.file1)\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, None, None, 'headshot')\n+        p.headshot.save(\"head\", self.file2)\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+\n+        # We can use save=True when deleting the image field with null=True\n+        # dimension fields and the other field has an image.\n+        p.headshot.delete(save=True)\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, None, None, 'headshot')\n+        p.mugshot.delete(save=False)\n+        self.check_dimensions(p, None, None, 'mugshot')\n+        self.check_dimensions(p, None, None, 'headshot')\n+\n+    def test_dimensions(self):\n+        \"\"\"\n+        Checks that dimensions are updated correctly in various situations.\n+        \"\"\"\n+        p = self.PersonModel(name='Joe')\n+\n+        # Dimensions should get set for the saved file.\n+        p.mugshot.save(\"mug\", self.file1)\n+        p.headshot.save(\"head\", self.file2)\n+        self.check_dimensions(p, 4, 8, 'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+\n+        # Test dimensions after fetching from database.\n+        p = self.PersonModel.objects.get(name='Joe')\n+        # Bug 11084: Dimensions should not get recalculated if file is\n+        # coming from the database.  We test this by checking if the file\n+        # was opened.\n+        self.assertEqual(p.mugshot.was_opened, False)\n+        self.assertEqual(p.headshot.was_opened, False)\n+        self.check_dimensions(p, 4, 8,'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+        # After checking dimensions on the image fields, the files will\n+        # have been opened.\n+        self.assertEqual(p.mugshot.was_opened, True)\n+        self.assertEqual(p.headshot.was_opened, True)\n+        # Dimensions should now be cached, and if we reset was_opened and\n+        # check dimensions again, the file should not have opened.\n+        p.mugshot.was_opened = False\n+        p.headshot.was_opened = False\n+        self.check_dimensions(p, 4, 8,'mugshot')\n+        self.check_dimensions(p, 8, 4, 'headshot')\n+        self.assertEqual(p.mugshot.was_opened, False)\n+        self.assertEqual(p.headshot.was_opened, False)\n+\n+        # If we assign a new image to the instance, the dimensions should\n+        # update.\n+        p.mugshot = self.file2\n+        p.headshot = self.file1\n+        self.check_dimensions(p, 8, 4, 'mugshot')\n+        self.check_dimensions(p, 4, 8, 'headshot')\n+        # Dimensions were recalculated, and hence file should have opened.\n+        self.assertEqual(p.mugshot.was_opened, True)\n+        self.assertEqual(p.headshot.was_opened, True)"
        },
        {
            "sha": "b94c4696f9afdb9bcef96b564fe87272f44bcc7d",
            "filename": "tests/regressiontests/model_fields/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/86eb606b88b3979de8074c3a049535150a0cc8a5/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/86eb606b88b3979de8074c3a049535150a0cc8a5/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py?ref=86eb606b88b3979de8074c3a049535150a0cc8a5",
            "patch": "@@ -13,12 +13,10 @@\n from .models import (Foo, Bar, Whiz, BigD, BigS, Image, BigInt, Post,\n     NullBooleanModel, BooleanModel, Document, RenamedField)\n \n-# If PIL available, do these tests.\n-if Image:\n-    from .imagefield import (ImageFieldTests, ImageFieldTwoDimensionsTests,\n-        TwoImageFieldTests, ImageFieldNoDimensionsTests,\n-        ImageFieldOneDimensionTests, ImageFieldDimensionsFirstTests,\n-        ImageFieldUsingFileTests)\n+from .imagefield import (ImageFieldTests, ImageFieldTwoDimensionsTests,\n+    TwoImageFieldTests, ImageFieldNoDimensionsTests,\n+    ImageFieldOneDimensionTests, ImageFieldDimensionsFirstTests,\n+    ImageFieldUsingFileTests)\n \n \n class BasicFieldTests(test.TestCase):"
        }
    ],
    "stats": {
        "total": 798,
        "additions": 404,
        "deletions": 394
    }
}