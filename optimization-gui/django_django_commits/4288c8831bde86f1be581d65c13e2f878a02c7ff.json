{
    "author": "aaugustin",
    "message": "Fixed #10762, #17514 -- Prevented the GZip middleware from returning a response longer than the original content, allowed compression of non-200 responses, and added tests (there were none). Thanks cannona for the initial patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17365 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4288c8831bde86f1be581d65c13e2f878a02c7ff",
    "files": [
        {
            "sha": "39ec6248514ffcd8c20b52a4886dbf658e3df1e2",
            "filename": "django/middleware/gzip.py",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/4288c8831bde86f1be581d65c13e2f878a02c7ff/django%2Fmiddleware%2Fgzip.py",
            "raw_url": "https://github.com/django/django/raw/4288c8831bde86f1be581d65c13e2f878a02c7ff/django%2Fmiddleware%2Fgzip.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fgzip.py?ref=4288c8831bde86f1be581d65c13e2f878a02c7ff",
            "patch": "@@ -12,8 +12,8 @@ class GZipMiddleware(object):\n     on the Accept-Encoding header.\n     \"\"\"\n     def process_response(self, request, response):\n-        # It's not worth compressing non-OK or really short responses.\n-        if response.status_code != 200 or len(response.content) < 200:\n+        # It's not worth attempting to compress really short responses.\n+        if len(response.content) < 200:\n             return response\n \n         patch_vary_headers(response, ('Accept-Encoding',))\n@@ -32,7 +32,12 @@ def process_response(self, request, response):\n         if not re_accepts_gzip.search(ae):\n             return response\n \n-        response.content = compress_string(response.content)\n+        # Return the compressed content only if it's actually shorter.\n+        compressed_content = compress_string(response.content)\n+        if len(compressed_content) >= len(response.content):\n+            return response\n+\n+        response.content = compressed_content\n         response['Content-Encoding'] = 'gzip'\n         response['Content-Length'] = str(len(response.content))\n         return response"
        },
        {
            "sha": "d57dbc9adc3abfa612e79d691d1dd749210eb951",
            "filename": "docs/ref/middleware.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/4288c8831bde86f1be581d65c13e2f878a02c7ff/docs%2Fref%2Fmiddleware.txt",
            "raw_url": "https://github.com/django/django/raw/4288c8831bde86f1be581d65c13e2f878a02c7ff/docs%2Fref%2Fmiddleware.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmiddleware.txt?ref=4288c8831bde86f1be581d65c13e2f878a02c7ff",
            "patch": "@@ -82,22 +82,29 @@ addresses defined in the :setting:`INTERNAL_IPS` setting. This is used by\n Django's :doc:`automatic documentation system </ref/contrib/admin/admindocs>`.\n Depends on :class:`~django.contrib.auth.middleware.AuthenticationMiddleware`.\n \n-GZIP middleware\n+GZip middleware\n ---------------\n \n .. module:: django.middleware.gzip\n-   :synopsis: Middleware to serve gziped content for performance.\n+   :synopsis: Middleware to serve GZipped content for performance.\n \n .. class:: GZipMiddleware\n \n-Compresses content for browsers that understand gzip compression (all modern\n+Compresses content for browsers that understand GZip compression (all modern\n browsers).\n \n It is suggested to place this first in the middleware list, so that the\n-compression of the response content is the last thing that happens. Will not\n-compress content bodies less than 200 bytes long, when the response code is\n-something other than 200, JavaScript files (for IE compatibility), or\n-responses that have the ``Content-Encoding`` header already specified.\n+compression of the response content is the last thing that happens.\n+\n+It will not compress content bodies less than 200 bytes long, when the\n+``Content-Encoding`` header is already set, or when the browser does not send\n+an ``Accept-Encoding`` header containing ``gzip``.\n+\n+Content will also not be compressed when the browser is Internet Explorer and\n+the ``Content-Type`` header contains ``javascript`` or starts with anything\n+other than ``text/``. This is done to overcome a bug present in early versions\n+of Internet Explorer which caused decompression not to be performed on certain\n+content types.\n \n GZip compression can be applied to individual views using the\n :func:`~django.views.decorators.http.gzip_page()` decorator."
        },
        {
            "sha": "50cb81d9a107e988214d107b294a76701fabd73d",
            "filename": "tests/regressiontests/middleware/tests.py",
            "status": "modified",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/django/django/blob/4288c8831bde86f1be581d65c13e2f878a02c7ff/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4288c8831bde86f1be581d65c13e2f878a02c7ff/tests%2Fregressiontests%2Fmiddleware%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware%2Ftests.py?ref=4288c8831bde86f1be581d65c13e2f878a02c7ff",
            "patch": "@@ -1,6 +1,9 @@\n # -*- coding: utf-8 -*-\n \n+import gzip\n import re\n+import random\n+import StringIO\n \n from django.conf import settings\n from django.core import mail\n@@ -9,6 +12,7 @@\n from django.middleware.clickjacking import XFrameOptionsMiddleware\n from django.middleware.common import CommonMiddleware\n from django.middleware.http import ConditionalGetMiddleware\n+from django.middleware.gzip import GZipMiddleware\n from django.test import TestCase\n \n \n@@ -495,3 +499,86 @@ def get_xframe_options_value(self, request, response):\n         r = OtherXFrameOptionsMiddleware().process_response(HttpRequest(),\n                                                        HttpResponse())\n         self.assertEqual(r['X-Frame-Options'], 'DENY')\n+\n+\n+class GZipMiddlewareTest(TestCase):\n+    \"\"\"\n+    Tests the GZip middleware.\n+    \"\"\"\n+    short_string = \"This string is too short to be worth compressing.\"\n+    compressible_string = 'a' * 500\n+    uncompressible_string = ''.join(chr(random.randint(0, 255)) for _ in xrange(500))\n+\n+    def setUp(self):\n+        self.req = HttpRequest()\n+        self.req.META = {\n+            'SERVER_NAME': 'testserver',\n+            'SERVER_PORT': 80,\n+        }\n+        self.req.path = self.req.path_info = \"/\"\n+        self.req.META['HTTP_ACCEPT_ENCODING'] = 'gzip, deflate'\n+        self.req.META['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1'\n+        self.resp = HttpResponse()\n+        self.resp.status_code = 200\n+        self.resp.content = self.compressible_string\n+        self.resp['Content-Type'] = 'text/html; charset=UTF-8'\n+\n+    @staticmethod\n+    def decompress(gzipped_string):\n+        return gzip.GzipFile(mode='rb', fileobj=StringIO.StringIO(gzipped_string)).read()\n+\n+    def test_compress_response(self):\n+        \"\"\"\n+        Tests that compression is performed on responses with compressible content.\n+        \"\"\"\n+        r = GZipMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(self.decompress(r.content), self.compressible_string)\n+        self.assertEqual(r.get('Content-Encoding'), 'gzip')\n+        self.assertEqual(r.get('Content-Length'), str(len(r.content)))\n+\n+    def test_compress_non_200_response(self):\n+        \"\"\"\n+        Tests that compression is performed on responses with a status other than 200.\n+        See #10762.\n+        \"\"\"\n+        self.resp.status_code = 404\n+        r = GZipMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(self.decompress(r.content), self.compressible_string)\n+        self.assertEqual(r.get('Content-Encoding'), 'gzip')\n+\n+    def test_no_compress_short_response(self):\n+        \"\"\"\n+        Tests that compression isn't performed on responses with short content.\n+        \"\"\"\n+        self.resp.content = self.short_string\n+        r = GZipMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(r.content, self.short_string)\n+        self.assertEqual(r.get('Content-Encoding'), None)\n+\n+    def test_no_compress_compressed_response(self):\n+        \"\"\"\n+        Tests that compression isn't performed on responses that are already compressed.\n+        \"\"\"\n+        self.resp['Content-Encoding'] = 'deflate'\n+        r = GZipMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(r.content, self.compressible_string)\n+        self.assertEqual(r.get('Content-Encoding'), 'deflate')\n+\n+    def test_no_compress_ie_js_requests(self):\n+        \"\"\"\n+        Tests that compression isn't performed on JavaScript requests from Internet Explorer.\n+        \"\"\"\n+        self.req.META['HTTP_USER_AGENT'] = 'Mozilla/4.0 (compatible; MSIE 5.00; Windows 98)'\n+        self.resp['Content-Type'] = 'application/javascript; charset=UTF-8'\n+        r = GZipMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(r.content, self.compressible_string)\n+        self.assertEqual(r.get('Content-Encoding'), None)\n+\n+    def test_no_compress_uncompressible_response(self):\n+        \"\"\"\n+        Tests that compression isn't performed on responses with uncompressible content.\n+        \"\"\"\n+        self.resp.content = self.uncompressible_string\n+        r = GZipMiddleware().process_response(self.req, self.resp)\n+        self.assertEqual(r.content, self.uncompressible_string)\n+        self.assertEqual(r.get('Content-Encoding'), None)"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 109,
        "deletions": 10
    }
}