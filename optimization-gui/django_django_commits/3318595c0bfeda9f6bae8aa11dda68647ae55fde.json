{
    "author": "claudep",
    "message": "Fixed #18898 -- Added tests with a fix for ModelMultipleChoiceField",
    "sha": "3318595c0bfeda9f6bae8aa11dda68647ae55fde",
    "files": [
        {
            "sha": "87fd546f2a3cf193f9afc13ae58453587cf0346c",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/3318595c0bfeda9f6bae8aa11dda68647ae55fde/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/3318595c0bfeda9f6bae8aa11dda68647ae55fde/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=3318595c0bfeda9f6bae8aa11dda68647ae55fde",
            "patch": "@@ -1072,6 +1072,6 @@ def _has_changed(self, initial, data):\n             data = []\n         if len(initial) != len(data):\n             return True\n-        initial_set = set([force_text(value) for value in initial])\n+        initial_set = set([force_text(value) for value in self.prepare_value(initial)])\n         data_set = set([force_text(value) for value in data])\n         return data_set != initial_set"
        },
        {
            "sha": "c48f88ded8b84516f649b2fd4f743fe902710728",
            "filename": "tests/model_formsets/tests.py",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/3318595c0bfeda9f6bae8aa11dda68647ae55fde/tests%2Fmodel_formsets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3318595c0bfeda9f6bae8aa11dda68647ae55fde/tests%2Fmodel_formsets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodel_formsets%2Ftests.py?ref=3318595c0bfeda9f6bae8aa11dda68647ae55fde",
            "patch": "@@ -1071,6 +1071,38 @@ def test_model_formset_with_custom_pk(self):\n         FormSet = modelformset_factory(ClassyMexicanRestaurant, fields=[\"tacos_are_yummy\"])\n         self.assertEqual(sorted(FormSet().forms[0].fields.keys()), ['restaurant', 'tacos_are_yummy'])\n \n+    def test_model_formset_with_initial_model_instance(self):\n+        # has_changed should compare model instance and primary key\n+        # see #18898\n+        FormSet = modelformset_factory(Poem)\n+        john_milton = Poet(name=\"John Milton\")\n+        john_milton.save()\n+        data = {\n+            'form-TOTAL_FORMS': 1,\n+            'form-INITIAL_FORMS': 0,\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-name': '',\n+            'form-0-poet': str(john_milton.id),\n+        }\n+        formset = FormSet(initial=[{'poet': john_milton}], data=data)\n+        self.assertFalse(formset.extra_forms[0].has_changed())\n+\n+    def test_model_formset_with_initial_queryset(self):\n+        # has_changed should work with queryset and list of pk's\n+        # see #18898\n+        FormSet = modelformset_factory(AuthorMeeting)\n+        author = Author.objects.create(pk=1, name='Charles Baudelaire')\n+        data = {\n+            'form-TOTAL_FORMS': 1,\n+            'form-INITIAL_FORMS': 0,\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-name': '',\n+            'form-0-created': '',\n+            'form-0-authors': list(Author.objects.values_list('id', flat=True)),\n+        }\n+        formset = FormSet(initial=[{'authors': Author.objects.all()}], data=data)\n+        self.assertFalse(formset.extra_forms[0].has_changed())\n+\n     def test_prevent_duplicates_from_with_the_same_formset(self):\n         FormSet = modelformset_factory(Product, extra=2)\n         data = {"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 33,
        "deletions": 1
    }
}