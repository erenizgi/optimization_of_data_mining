{
    "author": "akaariai",
    "message": "Refactored the empty/full result logic in WhereNode.as_sql()\n\nMade sure the WhereNode.as_sql() handles various EmptyResultSet and\nFullResultSet conditions correctly. Also, got rid of the FullResultSet\nexception class. It is now represented by '', [] return value in the\nas_sql() methods.",
    "sha": "bd283aa844b04651b7c8b4e85f48c6dced1678f0",
    "files": [
        {
            "sha": "b8e06daf01a748ea3b516fd6cef103598c34be95",
            "filename": "django/db/models/sql/datastructures.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/bd283aa844b04651b7c8b4e85f48c6dced1678f0/django%2Fdb%2Fmodels%2Fsql%2Fdatastructures.py",
            "raw_url": "https://github.com/django/django/raw/bd283aa844b04651b7c8b4e85f48c6dced1678f0/django%2Fdb%2Fmodels%2Fsql%2Fdatastructures.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fdatastructures.py?ref=bd283aa844b04651b7c8b4e85f48c6dced1678f0",
            "patch": "@@ -6,9 +6,6 @@\n class EmptyResultSet(Exception):\n     pass\n \n-class FullResultSet(Exception):\n-    pass\n-\n class MultiJoin(Exception):\n     \"\"\"\n     Used by join construction code to indicate the point at which a"
        },
        {
            "sha": "70ff5310f7bf69410295bffb401ac9327ff8b943",
            "filename": "django/db/models/sql/where.py",
            "status": "modified",
            "additions": 48,
            "deletions": 35,
            "changes": 83,
            "blob_url": "https://github.com/django/django/blob/bd283aa844b04651b7c8b4e85f48c6dced1678f0/django%2Fdb%2Fmodels%2Fsql%2Fwhere.py",
            "raw_url": "https://github.com/django/django/raw/bd283aa844b04651b7c8b4e85f48c6dced1678f0/django%2Fdb%2Fmodels%2Fsql%2Fwhere.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fwhere.py?ref=bd283aa844b04651b7c8b4e85f48c6dced1678f0",
            "patch": "@@ -10,7 +10,7 @@\n \n from django.utils import tree\n from django.db.models.fields import Field\n-from django.db.models.sql.datastructures import EmptyResultSet, FullResultSet\n+from django.db.models.sql.datastructures import EmptyResultSet\n from django.db.models.sql.aggregates import Aggregate\n \n # Connection types\n@@ -75,57 +75,70 @@ def add(self, data, connector):\n     def as_sql(self, qn, connection):\n         \"\"\"\n         Returns the SQL version of the where clause and the value to be\n-        substituted in. Returns None, None if this node is empty.\n-\n-        If 'node' is provided, that is the root of the SQL generation\n-        (generally not needed except by the internal implementation for\n-        recursion).\n+        substituted in. Returns '', [] if this node matches everything,\n+        None, [] if this node is empty, and raises EmptyResultSet if this\n+        node can't match anything.\n         \"\"\"\n-        if not self.children:\n-            return None, []\n+        # Note that the logic here is made slightly more complex than\n+        # necessary because there are two kind of empty nodes: Nodes\n+        # containing 0 children, and nodes that are known to match everything.\n+        # A match-everything node is different than empty node (which also\n+        # technically matches everything) for backwards compatibility reasons.\n+        # Refs #5261.\n         result = []\n         result_params = []\n-        empty = True\n+        everything_childs, nothing_childs = 0, 0\n+        non_empty_childs = len(self.children)\n+\n         for child in self.children:\n             try:\n                 if hasattr(child, 'as_sql'):\n                     sql, params = child.as_sql(qn=qn, connection=connection)\n                 else:\n                     # A leaf node in the tree.\n                     sql, params = self.make_atom(child, qn, connection)\n-\n             except EmptyResultSet:\n-                if self.connector == AND and not self.negated:\n-                    # We can bail out early in this particular case (only).\n-                    raise\n-                elif self.negated:\n-                    empty = False\n-                continue\n-            except FullResultSet:\n-                if self.connector == OR:\n-                    if self.negated:\n-                        empty = True\n-                        break\n-                    # We match everything. No need for any constraints.\n+                nothing_childs += 1\n+            else:\n+                if sql:\n+                    result.append(sql)\n+                    result_params.extend(params)\n+                else:\n+                    if sql is None:\n+                        # Skip empty childs totally.\n+                        non_empty_childs -= 1\n+                        continue\n+                    everything_childs += 1\n+            # Check if this node matches nothing or everything.\n+            # First check the amount of full nodes and empty nodes\n+            # to make this node empty/full.\n+            if self.connector == AND:\n+                full_needed, empty_needed = non_empty_childs, 1\n+            else:\n+                full_needed, empty_needed = 1, non_empty_childs\n+            # Now, check if this node is full/empty using the\n+            # counts.\n+            if empty_needed - nothing_childs <= 0:\n+                if self.negated:\n                     return '', []\n+                else:\n+                    raise EmptyResultSet\n+            if full_needed - everything_childs <= 0:\n                 if self.negated:\n-                    empty = True\n-                continue\n-\n-            empty = False\n-            if sql:\n-                result.append(sql)\n-                result_params.extend(params)\n-        if empty:\n-            raise EmptyResultSet\n+                    raise EmptyResultSet\n+                else:\n+                    return '', []\n \n+        if non_empty_childs == 0:\n+            # All the child nodes were empty, so this one is empty, too.\n+            return None, []\n         conn = ' %s ' % self.connector\n         sql_string = conn.join(result)\n         if sql_string:\n-            if self.negated:\n-                sql_string = 'NOT (%s)' % sql_string\n-            elif len(self.children) != 1:\n+            if len(result) > 1:\n                 sql_string = '(%s)' % sql_string\n+            if self.negated:\n+                sql_string = 'NOT %s' % sql_string\n         return sql_string, result_params\n \n     def make_atom(self, child, qn, connection):\n@@ -261,7 +274,7 @@ class EverythingNode(object):\n     \"\"\"\n \n     def as_sql(self, qn=None, connection=None):\n-        raise FullResultSet\n+        return '', []\n \n     def relabel_aliases(self, change_map, node=None):\n         return"
        },
        {
            "sha": "3d2aafd2d96db235f2a48da3d474e7731353cdde",
            "filename": "tests/regressiontests/queries/tests.py",
            "status": "modified",
            "additions": 86,
            "deletions": 0,
            "changes": 86,
            "blob_url": "https://github.com/django/django/blob/bd283aa844b04651b7c8b4e85f48c6dced1678f0/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bd283aa844b04651b7c8b4e85f48c6dced1678f0/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Ftests.py?ref=bd283aa844b04651b7c8b4e85f48c6dced1678f0",
            "patch": "@@ -10,6 +10,8 @@\n from django.db import DatabaseError, connection, connections, DEFAULT_DB_ALIAS\n from django.db.models import Count\n from django.db.models.query import Q, ITER_CHUNK_SIZE, EmptyQuerySet\n+from django.db.models.sql.where import WhereNode, EverythingNode, NothingNode\n+from django.db.models.sql.datastructures import EmptyResultSet\n from django.test import TestCase, skipUnlessDBFeature\n from django.test.utils import str_prefix\n from django.utils import unittest\n@@ -1316,10 +1318,23 @@ def test_ticket9848(self):\n         )\n \n     def test_ticket5261(self):\n+        # Test different empty excludes.\n         self.assertQuerysetEqual(\n             Note.objects.exclude(Q()),\n             ['<Note: n1>', '<Note: n2>']\n         )\n+        self.assertQuerysetEqual(\n+            Note.objects.filter(~Q()),\n+            ['<Note: n1>', '<Note: n2>']\n+        )\n+        self.assertQuerysetEqual(\n+            Note.objects.filter(~Q()|~Q()),\n+            ['<Note: n1>', '<Note: n2>']\n+        )\n+        self.assertQuerysetEqual(\n+            Note.objects.exclude(~Q()&~Q()),\n+            ['<Note: n1>', '<Note: n2>']\n+        )\n \n \n class SelectRelatedTests(TestCase):\n@@ -2020,3 +2035,74 @@ def test_evaluated_proxy_count(self):\n         self.assertEqual(qs.count(), 1)\n         str(qs.query)\n         self.assertEqual(qs.count(), 1)\n+\n+class WhereNodeTest(TestCase):\n+    class DummyNode(object):\n+        def as_sql(self, qn, connection):\n+            return 'dummy', []\n+\n+    def test_empty_full_handling_conjunction(self):\n+        qn = connection.ops.quote_name\n+        w = WhereNode(children=[EverythingNode()])\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w.negate()\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w = WhereNode(children=[NothingNode()])\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w = WhereNode(children=[EverythingNode(), EverythingNode()])\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w.negate()\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w = WhereNode(children=[EverythingNode(), self.DummyNode()])\n+        self.assertEquals(w.as_sql(qn, connection), ('dummy', []))\n+        w = WhereNode(children=[self.DummyNode(), self.DummyNode()])\n+        self.assertEquals(w.as_sql(qn, connection), ('(dummy AND dummy)', []))\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), ('NOT (dummy AND dummy)', []))\n+        w = WhereNode(children=[NothingNode(), self.DummyNode()])\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+\n+    def test_empty_full_handling_disjunction(self):\n+        qn = connection.ops.quote_name\n+        w = WhereNode(children=[EverythingNode()], connector='OR')\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w.negate()\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w = WhereNode(children=[NothingNode()], connector='OR')\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w = WhereNode(children=[EverythingNode(), EverythingNode()], connector='OR')\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w.negate()\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w = WhereNode(children=[EverythingNode(), self.DummyNode()], connector='OR')\n+        self.assertEquals(w.as_sql(qn, connection), ('', []))\n+        w.negate()\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)\n+        w = WhereNode(children=[self.DummyNode(), self.DummyNode()], connector='OR')\n+        self.assertEquals(w.as_sql(qn, connection), ('(dummy OR dummy)', []))\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), ('NOT (dummy OR dummy)', []))\n+        w = WhereNode(children=[NothingNode(), self.DummyNode()], connector='OR')\n+        self.assertEquals(w.as_sql(qn, connection), ('dummy', []))\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), ('NOT dummy', []))\n+\n+    def test_empty_nodes(self):\n+        qn = connection.ops.quote_name\n+        empty_w = WhereNode()\n+        w = WhereNode(children=[empty_w, empty_w])\n+        self.assertEquals(w.as_sql(qn, connection), (None, []))\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), (None, []))\n+        w.connector = 'OR'\n+        self.assertEquals(w.as_sql(qn, connection), (None, []))\n+        w.negate()\n+        self.assertEquals(w.as_sql(qn, connection), (None, []))\n+        w = WhereNode(children=[empty_w, NothingNode()], connector='OR')\n+        self.assertRaises(EmptyResultSet, w.as_sql, qn, connection)"
        }
    ],
    "stats": {
        "total": 172,
        "additions": 134,
        "deletions": 38
    }
}