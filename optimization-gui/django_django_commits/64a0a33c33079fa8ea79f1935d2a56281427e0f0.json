{
    "author": "jezdez",
    "message": "Fixed the staticfiles management commands collectstatic and findstatic to not raise encoding related exceptions when handlings filenames with non-ASCII characters.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15538 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "64a0a33c33079fa8ea79f1935d2a56281427e0f0",
    "files": [
        {
            "sha": "563a6ac16104aa696a1673acb14b51d03c92cd2d",
            "filename": "django/contrib/staticfiles/management/commands/collectstatic.py",
            "status": "modified",
            "additions": 14,
            "deletions": 12,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/64a0a33c33079fa8ea79f1935d2a56281427e0f0/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "raw_url": "https://github.com/django/django/raw/64a0a33c33079fa8ea79f1935d2a56281427e0f0/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py?ref=64a0a33c33079fa8ea79f1935d2a56281427e0f0",
            "patch": "@@ -6,6 +6,7 @@\n from django.conf import settings\n from django.core.files.storage import get_storage_class\n from django.core.management.base import CommandError, NoArgsCommand\n+from django.utils.encoding import smart_str\n \n from django.contrib.staticfiles import finders\n \n@@ -64,7 +65,7 @@ def handle_noargs(self, **options):\n \n         # Warn before doing anything more.\n         if options.get('interactive'):\n-            confirm = raw_input(\"\"\"\n+            confirm = raw_input(u\"\"\"\n You have requested to collect static files at the destination\n location as specified in your settings file ('%s').\n \n@@ -90,17 +91,18 @@ def handle_noargs(self, **options):\n         actual_count = len(self.copied_files) + len(self.symlinked_files)\n         unmodified_count = len(self.unmodified_files)\n         if self.verbosity >= 1:\n-            self.stdout.write(\"\\n%s static file%s %s to '%s'%s.\\n\"\n+            self.stdout.write(smart_str(u\"\\n%s static file%s %s to '%s'%s.\\n\"\n                               % (actual_count, actual_count != 1 and 's' or '',\n                                  symlink and 'symlinked' or 'copied',\n                                  settings.STATIC_ROOT,\n                                  unmodified_count and ' (%s unmodified)'\n-                                 % unmodified_count or ''))\n+                                 % unmodified_count or '')))\n \n     def log(self, msg, level=2):\n         \"\"\"\n         Small log helper\n         \"\"\"\n+        msg = smart_str(msg)\n         if not msg.endswith(\"\\n\"):\n             msg += \"\\n\"\n         if self.verbosity >= level:\n@@ -135,13 +137,13 @@ def delete_file(self, path, prefixed_path, source_storage, **options):\n                                 (not symlink and full_path and os.path.islink(full_path))):\n                             if prefixed_path not in self.unmodified_files:\n                                 self.unmodified_files.append(prefixed_path)\n-                            self.log(\"Skipping '%s' (not modified)\" % path)\n+                            self.log(u\"Skipping '%s' (not modified)\" % path)\n                             return False\n             # Then delete the existing file if really needed\n             if options['dry_run']:\n-                self.log(\"Pretending to delete '%s'\" % path)\n+                self.log(u\"Pretending to delete '%s'\" % path)\n             else:\n-                self.log(\"Deleting '%s'\" % path)\n+                self.log(u\"Deleting '%s'\" % path)\n                 self.storage.delete(prefixed_path)\n         return True\n \n@@ -151,17 +153,17 @@ def link_file(self, path, prefixed_path, source_storage, **options):\n         \"\"\"\n         # Skip this file if it was already copied earlier\n         if prefixed_path in self.symlinked_files:\n-            return self.log(\"Skipping '%s' (already linked earlier)\" % path)\n+            return self.log(u\"Skipping '%s' (already linked earlier)\" % path)\n         # Delete the target file if needed or break\n         if not self.delete_file(path, prefixed_path, source_storage, **options):\n             return\n         # The full path of the source file\n         source_path = source_storage.path(path)\n         # Finally link the file\n         if options['dry_run']:\n-            self.log(\"Pretending to link '%s'\" % source_path, level=1)\n+            self.log(u\"Pretending to link '%s'\" % source_path, level=1)\n         else:\n-            self.log(\"Linking '%s'\" % source_path, level=1)\n+            self.log(u\"Linking '%s'\" % source_path, level=1)\n             full_path = self.storage.path(prefixed_path)\n             try:\n                 os.makedirs(os.path.dirname(full_path))\n@@ -177,17 +179,17 @@ def copy_file(self, path, prefixed_path, source_storage, **options):\n         \"\"\"\n         # Skip this file if it was already copied earlier\n         if prefixed_path in self.copied_files:\n-            return self.log(\"Skipping '%s' (already copied earlier)\" % path)\n+            return self.log(u\"Skipping '%s' (already copied earlier)\" % path)\n         # Delete the target file if needed or break\n         if not self.delete_file(path, prefixed_path, source_storage, **options):\n             return\n         # The full path of the source file\n         source_path = source_storage.path(path)\n         # Finally start copying\n         if options['dry_run']:\n-            self.log(\"Pretending to copy '%s'\" % source_path, level=1)\n+            self.log(u\"Pretending to copy '%s'\" % source_path, level=1)\n         else:\n-            self.log(\"Copying '%s'\" % source_path, level=1)\n+            self.log(u\"Copying '%s'\" % source_path, level=1)\n             if self.local:\n                 full_path = self.storage.path(prefixed_path)\n                 try:"
        },
        {
            "sha": "bcf0c2f055f23d4ebb87c6a7a22338cc883a4a0d",
            "filename": "django/contrib/staticfiles/management/commands/findstatic.py",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/64a0a33c33079fa8ea79f1935d2a56281427e0f0/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Ffindstatic.py",
            "raw_url": "https://github.com/django/django/raw/64a0a33c33079fa8ea79f1935d2a56281427e0f0/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Ffindstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Ffindstatic.py?ref=64a0a33c33079fa8ea79f1935d2a56281427e0f0",
            "patch": "@@ -1,6 +1,7 @@\n import os\n from optparse import make_option\n from django.core.management.base import LabelCommand\n+from django.utils.encoding import smart_str, smart_unicode\n \n from django.contrib.staticfiles import finders\n \n@@ -16,11 +17,15 @@ class Command(LabelCommand):\n     def handle_label(self, path, **options):\n         verbosity = int(options.get('verbosity', 1))\n         result = finders.find(path, all=options['all'])\n+        path = smart_unicode(path)\n         if result:\n             if not isinstance(result, (list, tuple)):\n                 result = [result]\n-            output = '\\n  '.join((os.path.realpath(path) for path in result))\n-            self.stdout.write(\"Found %r here:\\n  %s\\n\" % (path, output))\n+            output = u'\\n  '.join(\n+                (smart_unicode(os.path.realpath(path)) for path in result))\n+            self.stdout.write(\n+                smart_str(u\"Found '%s' here:\\n  %s\\n\" % (path, output)))\n         else:\n             if verbosity >= 1:\n-                self.stdout.write(\"No matching file found for %r.\\n\" % path)\n+                self.stderr.write(\n+                    smart_str(\"No matching file found for '%s'.\\n\" % path))"
        },
        {
            "sha": "5da2e1683153920c735d90933b9d22bf067232bc",
            "filename": "tests/regressiontests/staticfiles_tests/apps/test/static/test/speçial.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/64a0a33c33079fa8ea79f1935d2a56281427e0f0/tests%2Fregressiontests%2Fstaticfiles_tests%2Fapps%2Ftest%2Fstatic%2Ftest%2Fspec%CC%A7ial.txt",
            "raw_url": "https://github.com/django/django/raw/64a0a33c33079fa8ea79f1935d2a56281427e0f0/tests%2Fregressiontests%2Fstaticfiles_tests%2Fapps%2Ftest%2Fstatic%2Ftest%2Fspec%CC%A7ial.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fapps%2Ftest%2Fstatic%2Ftest%2Fspec%CC%A7ial.txt?ref=64a0a33c33079fa8ea79f1935d2a56281427e0f0",
            "patch": "@@ -0,0 +1 @@\n+speçial in the app dir\n\\ No newline at end of file"
        },
        {
            "sha": "0e73e48480881911ce0db7dc3ea70c5f2ac6c3fe",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/64a0a33c33079fa8ea79f1935d2a56281427e0f0/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/64a0a33c33079fa8ea79f1935d2a56281427e0f0/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=64a0a33c33079fa8ea79f1935d2a56281427e0f0",
            "patch": "@@ -1,3 +1,5 @@\n+# -*- encoding: utf-8 -*-\n+import codecs\n import os\n import posixpath\n import shutil\n@@ -11,6 +13,7 @@\n from django.core.files.storage import default_storage\n from django.core.management import call_command\n from django.test import TestCase\n+from django.utils.encoding import smart_unicode\n from django.utils._os import rmtree_errorhandler\n \n \n@@ -72,8 +75,8 @@ def tearDown(self):\n         settings.INSTALLED_APPS = self.old_installed_apps\n \n     def assertFileContains(self, filepath, text):\n-        self.assertTrue(text in self._get_file(filepath),\n-                        \"'%s' not in '%s'\" % (text, filepath))\n+        self.assertTrue(text in self._get_file(smart_unicode(filepath)),\n+                        u\"'%s' not in '%s'\" % (text, filepath))\n \n     def assertFileNotFound(self, filepath):\n         self.assertRaises(IOError, self._get_file, filepath)\n@@ -108,7 +111,7 @@ def run_collectstatic(self, **kwargs):\n     def _get_file(self, filepath):\n         assert filepath, 'filepath is empty.'\n         filepath = os.path.join(settings.STATIC_ROOT, filepath)\n-        f = open(filepath)\n+        f = codecs.open(filepath, \"r\", \"utf-8\")\n         try:\n             return f.read()\n         finally:\n@@ -140,10 +143,16 @@ def test_staticfiles_dirs_priority(self):\n \n     def test_app_files(self):\n         \"\"\"\n-        Can find a file in an app media/ directory.\n+        Can find a file in an app static/ directory.\n         \"\"\"\n         self.assertFileContains('test/file1.txt', 'file1 in the app dir')\n \n+    def test_nonascii_filenames(self):\n+        \"\"\"\n+        Can find a file with non-ASCII character in an app static/ directory.\n+        \"\"\"\n+        self.assertFileContains(u'test/speçial.txt', u'speçial in the app dir')\n+\n \n class TestFindStatic(BuildStaticTestCase, TestDefaults):\n     \"\"\"\n@@ -156,7 +165,7 @@ def _get_file(self, filepath):\n             call_command('findstatic', filepath, all=False, verbosity='0')\n             sys.stdout.seek(0)\n             lines = [l.strip() for l in sys.stdout.readlines()]\n-            contents = open(lines[1].strip()).read()\n+            contents = codecs.open(lines[1].strip(), \"r\", \"utf-8\").read()\n         finally:\n             sys.stdout = _stdout\n         return contents"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 37,
        "deletions": 20
    }
}