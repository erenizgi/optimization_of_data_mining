{
    "author": "jezdez",
    "message": "Fixed #11223 -- Fixed logout view to use the 'next' GET parameter correctly as described in the docs, while only allowing redirection to the same host.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15706 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "751888ece3c970e208d9d77f21a35464c9122835",
    "files": [
        {
            "sha": "baea1fc95f99f62b8ca2b10c1c84e98ddd0720be",
            "filename": "django/contrib/auth/tests/views.py",
            "status": "modified",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/django/django/blob/751888ece3c970e208d9d77f21a35464c9122835/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/751888ece3c970e208d9d77f21a35464c9122835/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py?ref=751888ece3c970e208d9d77f21a35464c9122835",
            "patch": "@@ -333,6 +333,19 @@ def test_14377(self):\n         response = self.client.get('/logout/')\n         self.assertTrue('site' in response.context)\n \n+    def test_logout_with_overridden_redirect_url(self):\n+        # Bug 11223\n+        self.login()\n+        response = self.client.get('/logout/next_page/')\n+        self.assertEqual(response.status_code, 302)\n+        self.assert_(response['Location'].endswith('/somewhere/'))\n+\n+        response = self.client.get('/logout/next_page/?next=/login/')\n+        self.assertEqual(response.status_code, 302)\n+        self.assert_(response['Location'].endswith('/login/'))\n+\n+        self.confirm_logged_out()\n+\n     def test_logout_with_next_page_specified(self): \n         \"Logout with next_page option given redirects to specified resource\"\n         self.login()\n@@ -356,3 +369,45 @@ def test_logout_with_custom_redirect_argument(self):\n         self.assertEqual(response.status_code, 302)\n         self.assert_(response['Location'].endswith('/somewhere/'))\n         self.confirm_logged_out()\n+\n+    def test_security_check(self, password='password'):\n+        logout_url = reverse('django.contrib.auth.views.logout')\n+\n+        # Those URLs should not pass the security check\n+        for bad_url in ('http://example.com',\n+                        'https://example.com',\n+                        'ftp://exampel.com',\n+                        '//example.com'\n+                        ):\n+            nasty_url = '%(url)s?%(next)s=%(bad_url)s' % {\n+                'url': logout_url,\n+                'next': REDIRECT_FIELD_NAME,\n+                'bad_url': urllib.quote(bad_url)\n+            }\n+            self.login()\n+            response = self.client.get(nasty_url)\n+            self.assertEquals(response.status_code, 302)\n+            self.assertFalse(bad_url in response['Location'],\n+                             \"%s should be blocked\" % bad_url)\n+            self.confirm_logged_out()\n+\n+        # These URLs *should* still pass the security check\n+        for good_url in ('/view/?param=http://example.com',\n+                         '/view/?param=https://example.com',\n+                         '/view?param=ftp://exampel.com',\n+                         'view/?param=//example.com',\n+                         'https:///',\n+                         '//testserver/',\n+                         '/url%20with%20spaces/', # see ticket #12534\n+                         ):\n+            safe_url = '%(url)s?%(next)s=%(good_url)s' % {\n+                'url': logout_url,\n+                'next': REDIRECT_FIELD_NAME,\n+                'good_url': urllib.quote(good_url)\n+            }\n+            self.login()\n+            response = self.client.get(safe_url)\n+            self.assertEquals(response.status_code, 302)\n+            self.assertTrue(good_url in response['Location'],\n+                            \"%s should be allowed\" % good_url)\n+            self.confirm_logged_out()"
        },
        {
            "sha": "eba83a269e521388ed1b4c33cba03b9370930b61",
            "filename": "django/contrib/auth/views.py",
            "status": "modified",
            "additions": 42,
            "deletions": 33,
            "changes": 75,
            "blob_url": "https://github.com/django/django/blob/751888ece3c970e208d9d77f21a35464c9122835/django%2Fcontrib%2Fauth%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/751888ece3c970e208d9d77f21a35464c9122835/django%2Fcontrib%2Fauth%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fviews.py?ref=751888ece3c970e208d9d77f21a35464c9122835",
            "patch": "@@ -1,32 +1,33 @@\n-import re\n import urlparse\n+\n from django.conf import settings\n-from django.contrib.auth import REDIRECT_FIELD_NAME\n-# Avoid shadowing the login() view below.\n-from django.contrib.auth import login as auth_login\n-from django.contrib.auth.decorators import login_required\n-from django.contrib.auth.forms import AuthenticationForm\n-from django.contrib.auth.forms import PasswordResetForm, SetPasswordForm, PasswordChangeForm\n-from django.contrib.auth.tokens import default_token_generator\n-from django.views.decorators.csrf import csrf_protect\n from django.core.urlresolvers import reverse\n-from django.shortcuts import render_to_response, get_object_or_404\n-from django.contrib.sites.models import get_current_site\n-from django.http import HttpResponseRedirect, Http404, QueryDict\n+from django.http import HttpResponseRedirect, QueryDict\n+from django.shortcuts import render_to_response\n from django.template import RequestContext\n from django.utils.http import base36_to_int\n from django.utils.translation import ugettext as _\n-from django.contrib.auth.models import User\n from django.views.decorators.cache import never_cache\n+from django.views.decorators.csrf import csrf_protect\n+\n+# Avoid shadowing the login() and logout() views below.\n+from django.contrib.auth import REDIRECT_FIELD_NAME, login as auth_login, logout as auth_logout\n+from django.contrib.auth.decorators import login_required\n+from django.contrib.auth.forms import AuthenticationForm, PasswordResetForm, SetPasswordForm, PasswordChangeForm\n+from django.contrib.auth.models import User\n+from django.contrib.auth.tokens import default_token_generator\n+from django.contrib.sites.models import get_current_site\n+\n \n @csrf_protect\n @never_cache\n def login(request, template_name='registration/login.html',\n           redirect_field_name=REDIRECT_FIELD_NAME,\n           authentication_form=AuthenticationForm,\n           current_app=None, extra_context=None):\n-    \"\"\"Displays the login form and handles the login action.\"\"\"\n-\n+    \"\"\"\n+    Displays the login form and handles the login action.\n+    \"\"\"\n     redirect_to = request.REQUEST.get(redirect_field_name, '')\n \n     if request.method == \"POST\":\n@@ -71,36 +72,44 @@ def logout(request, next_page=None,\n            template_name='registration/logged_out.html',\n            redirect_field_name=REDIRECT_FIELD_NAME,\n            current_app=None, extra_context=None):\n-    \"Logs out the user and displays 'You are logged out' message.\"\n-    from django.contrib.auth import logout\n-    logout(request)\n-    if next_page is None:\n-        redirect_to = request.REQUEST.get(redirect_field_name, '')\n-        if redirect_to:\n+    \"\"\"\n+    Logs out the user and displays 'You are logged out' message.\n+    \"\"\"\n+    auth_logout(request)\n+    redirect_to = request.REQUEST.get(redirect_field_name, '')\n+    if redirect_to:\n+        netloc = urlparse.urlparse(redirect_to)[1]\n+        # Security check -- don't allow redirection to a different host.\n+        if not (netloc and netloc != request.get_host()):\n             return HttpResponseRedirect(redirect_to)\n-        else:\n-            current_site = get_current_site(request)\n-            context = {\n-                'site': current_site,\n-                'site_name': current_site.name,\n-                'title': _('Logged out')\n-            }\n-            context.update(extra_context or {})\n-            return render_to_response(template_name, context,\n-                                      context_instance=RequestContext(request, current_app=current_app))\n+\n+    if next_page is None:\n+        current_site = get_current_site(request)\n+        context = {\n+            'site': current_site,\n+            'site_name': current_site.name,\n+            'title': _('Logged out')\n+        }\n+        context.update(extra_context or {})\n+        return render_to_response(template_name, context,\n+                                  context_instance=RequestContext(request, current_app=current_app))\n     else:\n         # Redirect to this page until the session has been cleared.\n         return HttpResponseRedirect(next_page or request.path)\n \n def logout_then_login(request, login_url=None, current_app=None, extra_context=None):\n-    \"Logs out the user if he is logged in. Then redirects to the log-in page.\"\n+    \"\"\"\n+    Logs out the user if he is logged in. Then redirects to the log-in page.\n+    \"\"\"\n     if not login_url:\n         login_url = settings.LOGIN_URL\n     return logout(request, login_url, current_app=current_app, extra_context=extra_context)\n \n def redirect_to_login(next, login_url=None,\n                       redirect_field_name=REDIRECT_FIELD_NAME):\n-    \"Redirects the user to the login page, passing the given 'next' page\"\n+    \"\"\"\n+    Redirects the user to the login page, passing the given 'next' page\n+    \"\"\"\n     if not login_url:\n         login_url = settings.LOGIN_URL\n "
        }
    ],
    "stats": {
        "total": 130,
        "additions": 97,
        "deletions": 33
    }
}