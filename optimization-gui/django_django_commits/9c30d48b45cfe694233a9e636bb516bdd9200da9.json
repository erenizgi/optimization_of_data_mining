{
    "author": "aaugustin",
    "message": "Fixed #17263 -- Added a warning when a naive datetime reaches the database layer while time zone support is enabled.\n\nAfter this commit, timezones.AdminTests will raise warnings because the sessions contrib app hasn't been upgraded to support time zones yet.\nThis will be fixed in an upcoming commit.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17117 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "9c30d48b45cfe694233a9e636bb516bdd9200da9",
    "files": [
        {
            "sha": "6824ba17f202821f1f2a7990aa74cd9ae6cfe603",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/9c30d48b45cfe694233a9e636bb516bdd9200da9/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/9c30d48b45cfe694233a9e636bb516bdd9200da9/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=9c30d48b45cfe694233a9e636bb516bdd9200da9",
            "patch": "@@ -2,6 +2,7 @@\n import datetime\n import decimal\n import math\n+import warnings\n from itertools import tee\n \n from django.db import connection\n@@ -789,6 +790,9 @@ def get_prep_value(self, value):\n             # For backwards compatibility, interpret naive datetimes in local\n             # time. This won't work during DST change, but we can't do much\n             # about it, so we let the exceptions percolate up the call stack.\n+            warnings.warn(u\"DateTimeField received a naive datetime (%s)\"\n+                          u\" while time zone support is active.\" % value,\n+                          RuntimeWarning)\n             default_timezone = timezone.get_default_timezone()\n             value = timezone.make_aware(value, default_timezone)\n         return value"
        },
        {
            "sha": "52c26aa0388ddf36eca9330f58b2993784a22915",
            "filename": "docs/topics/i18n/timezones.txt",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/9c30d48b45cfe694233a9e636bb516bdd9200da9/docs%2Ftopics%2Fi18n%2Ftimezones.txt",
            "raw_url": "https://github.com/django/django/raw/9c30d48b45cfe694233a9e636bb516bdd9200da9/docs%2Ftopics%2Fi18n%2Ftimezones.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Ftimezones.txt?ref=9c30d48b45cfe694233a9e636bb516bdd9200da9",
            "patch": "@@ -106,9 +106,9 @@ Interpretation of naive datetime objects\n ----------------------------------------\n \n When :setting:`USE_TZ` is ``True``, Django still accepts naive datetime\n-objects, in order to preserve backwards-compatibility. It attempts to make them\n-aware by interpreting them in the :ref:`default time zone\n-<default-current-time-zone>`.\n+objects, in order to preserve backwards-compatibility. When the database layer\n+receives one, it attempts to make it aware by interpreting it in the\n+:ref:`default time zone <default-current-time-zone>` and raises a warning.\n \n Unfortunately, during DST transitions, some datetimes don't exist or are\n ambiguous. In such situations, pytz_ raises an exception. Other\n@@ -421,11 +421,22 @@ with a naive datetime that you've created in your code.\n So the second step is to refactor your code wherever you instanciate datetime\n objects to make them aware. This can be done incrementally.\n :mod:`django.utils.timezone` defines some handy helpers for compatibility\n-code: :func:`~django.utils.timezone.is_aware`,\n+code: :func:`~django.utils.timezone.now`,\n+:func:`~django.utils.timezone.is_aware`,\n :func:`~django.utils.timezone.is_naive`,\n :func:`~django.utils.timezone.make_aware`, and\n :func:`~django.utils.timezone.make_naive`.\n \n+Finally, in order to help you locate code that needs upgrading, Django raises\n+a warning when you attempt to save a naive datetime to the database. During\n+development, you can turn such warnings into exceptions and get a traceback\n+by adding to your settings file::\n+\n+    import warnings\n+    warnings.filterwarnings(\n+            'error', r\"DateTimeField received a naive datetime\",\n+            RuntimeWarning, r'django\\.db\\.models\\.fields')\n+\n .. _pytz: http://pytz.sourceforge.net/\n .. _these issues: http://pytz.sourceforge.net/#problems-with-localtime\n .. _tz database: http://en.wikipedia.org/wiki/Tz_database"
        },
        {
            "sha": "4311ef4c5fac75265b57a9afa9397a7f34be01b4",
            "filename": "tests/modeltests/timezones/fixtures/tz_users.xml",
            "status": "renamed",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/9c30d48b45cfe694233a9e636bb516bdd9200da9/tests%2Fmodeltests%2Ftimezones%2Ffixtures%2Ftz_users.xml",
            "raw_url": "https://github.com/django/django/raw/9c30d48b45cfe694233a9e636bb516bdd9200da9/tests%2Fmodeltests%2Ftimezones%2Ffixtures%2Ftz_users.xml",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ffixtures%2Ftz_users.xml?ref=9c30d48b45cfe694233a9e636bb516bdd9200da9",
            "patch": "@@ -9,9 +9,9 @@\n         <field type=\"BooleanField\" name=\"is_staff\">True</field>\n         <field type=\"BooleanField\" name=\"is_active\">True</field>\n         <field type=\"BooleanField\" name=\"is_superuser\">True</field>\n-        <field type=\"DateTimeField\" name=\"last_login\">2007-05-30 13:20:10</field>\n-        <field type=\"DateTimeField\" name=\"date_joined\">2007-05-30 13:20:10</field>\n+        <field type=\"DateTimeField\" name=\"last_login\">2001-01-01 00:00:00+00:00</field>\n+        <field type=\"DateTimeField\" name=\"date_joined\">2001-01-01 00:00:00+00:00</field>\n         <field to=\"auth.group\" name=\"groups\" rel=\"ManyToManyRel\"></field>\n         <field to=\"auth.permission\" name=\"user_permissions\" rel=\"ManyToManyRel\"></field>\n     </object>\n-</django-objects>\n\\ No newline at end of file\n+</django-objects>",
            "previous_filename": "tests/modeltests/timezones/fixtures/users.xml"
        },
        {
            "sha": "bf0520adf80c299f93396bf46f544f82f63863f9",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/9c30d48b45cfe694233a9e636bb516bdd9200da9/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9c30d48b45cfe694233a9e636bb516bdd9200da9/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=9c30d48b45cfe694233a9e636bb516bdd9200da9",
            "patch": "@@ -3,6 +3,7 @@\n import datetime\n import os\n import time\n+import warnings\n \n try:\n     import pytz\n@@ -238,23 +239,35 @@ class NewDatabaseTests(BaseDateTimeTests):\n \n     def test_naive_datetime(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n-        Event.objects.create(dt=dt)\n+        with warnings.catch_warnings(record=True) as recorded:\n+            Event.objects.create(dt=dt)\n+            self.assertEqual(len(recorded), 1)\n+            msg = str(recorded[0].message)\n+            self.assertTrue(msg.startswith(\"DateTimeField received a naive datetime\"))\n         event = Event.objects.get()\n         # naive datetimes are interpreted in local time\n         self.assertEqual(event.dt, dt.replace(tzinfo=EAT))\n \n     @skipUnlessDBFeature('supports_microsecond_precision')\n     def test_naive_datetime_with_microsecond(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n-        Event.objects.create(dt=dt)\n+        with warnings.catch_warnings(record=True) as recorded:\n+            Event.objects.create(dt=dt)\n+            self.assertEqual(len(recorded), 1)\n+            msg = str(recorded[0].message)\n+            self.assertTrue(msg.startswith(\"DateTimeField received a naive datetime\"))\n         event = Event.objects.get()\n         # naive datetimes are interpreted in local time\n         self.assertEqual(event.dt, dt.replace(tzinfo=EAT))\n \n     @skipIfDBFeature('supports_microsecond_precision')\n     def test_naive_datetime_with_microsecond_unsupported(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30, 405060)\n-        Event.objects.create(dt=dt)\n+        with warnings.catch_warnings(record=True) as recorded:\n+            Event.objects.create(dt=dt)\n+            self.assertEqual(len(recorded), 1)\n+            msg = str(recorded[0].message)\n+            self.assertTrue(msg.startswith(\"DateTimeField received a naive datetime\"))\n         event = Event.objects.get()\n         # microseconds are lost during a round-trip in the database\n         # naive datetimes are interpreted in local time\n@@ -294,7 +307,7 @@ def test_aware_datetime_in_other_timezone(self):\n         self.assertEqual(event.dt, dt)\n \n     def test_auto_now_and_auto_now_add(self):\n-        now = datetime.datetime.utcnow().replace(tzinfo=UTC)\n+        now = timezone.now()\n         past = now - datetime.timedelta(seconds=2)\n         future = now + datetime.timedelta(seconds=2)\n         Timestamp.objects.create()\n@@ -824,7 +837,7 @@ def test_model_form(self):\n class AdminTests(BaseDateTimeTests):\n \n     urls = 'modeltests.timezones.urls'\n-    fixtures = ['users.xml']\n+    fixtures = ['tz_users.xml']\n \n     def setUp(self):\n         self.client.login(username='super', password='secret')"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 40,
        "deletions": 12
    }
}