{
    "author": "ramiro",
    "message": "Fixed #16250 -- Made test database creation support code in the PostgreSQL DB backend compatible with psycopg2 2.4.2.\n\nImplemented this by adding an internal hook for work that should be performed\nbefore that point.\n\nAlso, regarding the `DatabaseCreation.set_autocommit()` method:\n * Stop using it for such tasks\n * Stop providing an implementation that tries to cover all the possible\n   idioms a third party database backend DB-API 2 driver could need to activate\n   autocommit. It is now left for third party backends to implement.\n\nThis can be backwards incompatible in the case of user applications that:\n * Had started using this method\n * Use a third a party database backend\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16520 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "569aa34ea5eec46ec0d899f4db682687964feec0",
    "files": [
        {
            "sha": "8cfca3b8503d9e0e136646a99d579f9e77dd3829",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 18,
            "deletions": 11,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=569aa34ea5eec46ec0d899f4db682687964feec0",
            "patch": "@@ -247,7 +247,7 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n             verbosity=max(verbosity - 1, 0),\n             interactive=False,\n             database=self.connection.alias)\n-        \n+\n         # One effect of calling syncdb followed by flush is that the id of the\n         # default site may or may not be 1, depending on how the sequence was\n         # reset.  If the sites app is loaded, then we coerce it.\n@@ -294,7 +294,7 @@ def _create_test_db(self, verbosity, autoclobber):\n         # if the database supports it because PostgreSQL doesn't allow\n         # CREATE/DROP DATABASE statements within transactions.\n         cursor = self.connection.cursor()\n-        self.set_autocommit()\n+        self._prepare_for_test_db_ddl()\n         try:\n             cursor.execute(\"CREATE DATABASE %s %s\" % (qn(test_database_name), suffix))\n         except Exception, e:\n@@ -339,20 +339,27 @@ def _destroy_test_db(self, test_database_name, verbosity):\n         # to do so, because it's not allowed to delete a database while being\n         # connected to it.\n         cursor = self.connection.cursor()\n-        self.set_autocommit()\n+        self._prepare_for_test_db_ddl()\n         time.sleep(1) # To avoid \"database is being accessed by other users\" errors.\n         cursor.execute(\"DROP DATABASE %s\" % self.connection.ops.quote_name(test_database_name))\n         self.connection.close()\n \n     def set_autocommit(self):\n-        \"Make sure a connection is in autocommit mode.\"\n-        if hasattr(self.connection.connection, \"autocommit\"):\n-            if callable(self.connection.connection.autocommit):\n-                self.connection.connection.autocommit(True)\n-            else:\n-                self.connection.connection.autocommit = True\n-        elif hasattr(self.connection.connection, \"set_isolation_level\"):\n-            self.connection.connection.set_isolation_level(0)\n+        \"\"\"\n+        Make sure a connection is in autocommit mode. - Deprecated, not used\n+        anymore by Django code. Kept for compatibility with user code that\n+        might use it.\n+        \"\"\"\n+        pass\n+\n+    def _prepare_for_test_db_ddl(self):\n+        \"\"\"\n+        Internal implementation - Hook for tasks that should be performed before\n+        the ``CREATE DATABASE``/``DROP DATABASE`` clauses used by testing code\n+        to create/ destroy test databases. Needed e.g. in PostgreSQL to rollback\n+        and close any active transaction.\n+        \"\"\"\n+        pass\n \n     def sql_table_creation_suffix(self):\n         \"SQL to append to the end of the test table creation statements\""
        },
        {
            "sha": "1e95a89f1e3d9cf7e318e5286c74c81953e2180e",
            "filename": "django/db/backends/oracle/creation.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py?ref=569aa34ea5eec46ec0d899f4db682687964feec0",
            "patch": "@@ -270,3 +270,6 @@ def test_db_signature(self):\n             settings_dict['NAME'],\n             self._test_database_user(),\n         )\n+\n+    def set_autocommit(self):\n+        self.connection.connection.autocommit = True"
        },
        {
            "sha": "1f5609a1588c01731dfd9600cbb849a501c1ee81",
            "filename": "django/db/backends/postgresql_psycopg2/creation.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py?ref=569aa34ea5eec46ec0d899f4db682687964feec0",
            "patch": "@@ -76,3 +76,11 @@ def get_index_sql(index_name, opclass=''):\n         else:\n             output = []\n         return output\n+\n+    def set_autocommit(self):\n+        self._prepare_for_test_db_ddl()\n+\n+    def _prepare_for_test_db_ddl(self):\n+        \"\"\"Rollback and close the active transaction.\"\"\"\n+        self.connection.connection.rollback()\n+        self.connection.connection.set_isolation_level(0)"
        },
        {
            "sha": "cd393561d1a50fa56ad4eb27d8a3cfe28224fa49",
            "filename": "django/db/backends/sqlite3/creation.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/569aa34ea5eec46ec0d899f4db682687964feec0/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py?ref=569aa34ea5eec46ec0d899f4db682687964feec0",
            "patch": "@@ -69,3 +69,6 @@ def _destroy_test_db(self, test_database_name, verbosity):\n         if test_database_name and test_database_name != \":memory:\":\n             # Remove the SQLite database file\n             os.remove(test_database_name)\n+\n+    def set_autocommit(self):\n+        self.connection.connection.isolation_level = None"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 32,
        "deletions": 11
    }
}