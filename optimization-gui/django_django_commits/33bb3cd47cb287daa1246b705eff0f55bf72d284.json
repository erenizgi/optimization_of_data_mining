{
    "author": "aaugustin",
    "message": "Fixed #17343 -- Changed the {% now %} tag to use the current time zone when time zone support is enabled. Thanks oinopion for the report.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17169 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "33bb3cd47cb287daa1246b705eff0f55bf72d284",
    "files": [
        {
            "sha": "a1a3f5f70cf4f0bfe2089308bf0df43c9b069736",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/33bb3cd47cb287daa1246b705eff0f55bf72d284/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/33bb3cd47cb287daa1246b705eff0f55bf72d284/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=33bb3cd47cb287daa1246b705eff0f55bf72d284",
            "patch": "@@ -15,6 +15,7 @@\n from django.template.defaultfilters import date\n from django.utils.encoding import smart_str, smart_unicode\n from django.utils.safestring import mark_safe\n+from django.utils import timezone\n \n register = Library()\n \n@@ -343,7 +344,8 @@ def __init__(self, format_string):\n         self.format_string = format_string\n \n     def render(self, context):\n-        return date(datetime.now(), self.format_string)\n+        tzinfo = timezone.get_current_timezone() if settings.USE_TZ else None\n+        return date(datetime.now(tz=tzinfo), self.format_string)\n \n class SpacelessNode(Node):\n     def __init__(self, nodelist):"
        },
        {
            "sha": "774595be0510a0d18dc9b8a4de539c96e5cbbb27",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/33bb3cd47cb287daa1246b705eff0f55bf72d284/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/33bb3cd47cb287daa1246b705eff0f55bf72d284/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=33bb3cd47cb287daa1246b705eff0f55bf72d284",
            "patch": "@@ -790,6 +790,13 @@ def test_localtime_with_time_zone_setting_set_to_none(self):\n             self.assertTrue(tpl.render(ctx).startswith(\"2011\"))\n         timezone._localtime = None\n \n+    def test_now_template_tag_uses_current_time_zone(self):\n+        # Regression for #17343\n+        tpl = Template(\"{% now \\\"O\\\" %}\")\n+        self.assertEqual(tpl.render(Context({})), \"+0300\")\n+        with timezone.override(ICT):\n+            self.assertEqual(tpl.render(Context({})), \"+0700\")\n+\n TemplateTests = override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)(TemplateTests)\n \n #@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=False)"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 10,
        "deletions": 1
    }
}