{
    "author": "jezdez",
    "message": "Fixed #17628 -- Extended makemessages command to also ignore directories when walking, not only when looking for files. Thanks, Claude Paroz.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17441 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c6065545ef127ef244defd520b2bb1afe3a5c153",
    "files": [
        {
            "sha": "22befeff4a6d826b2d5c28438187a5f1d1a2d23d",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 42,
            "deletions": 31,
            "changes": 73,
            "blob_url": "https://github.com/django/django/blob/c6065545ef127ef244defd520b2bb1afe3a5c153/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/c6065545ef127ef244defd520b2bb1afe3a5c153/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=c6065545ef127ef244defd520b2bb1afe3a5c153",
            "patch": "@@ -7,6 +7,7 @@\n from optparse import make_option\n from subprocess import PIPE, Popen\n \n+import django\n from django.core.management.base import CommandError, NoArgsCommand\n from django.utils.text import get_text_list\n from django.utils.jslex import prepare_js_for_gettext\n@@ -44,11 +45,23 @@ def _popen(cmd):\n     p = Popen(cmd, shell=True, stdout=PIPE, stderr=PIPE, close_fds=os.name != 'nt', universal_newlines=True)\n     return p.communicate()\n \n-def walk(root, topdown=True, onerror=None, followlinks=False):\n+def walk(root, topdown=True, onerror=None, followlinks=False,\n+         ignore_patterns=[], verbosity=0, stdout=sys.stdout):\n     \"\"\"\n     A version of os.walk that can follow symlinks for Python < 2.6\n     \"\"\"\n+    dir_suffix = '%s*' % os.sep\n+    norm_patterns = map(lambda p: p.endswith(dir_suffix)\n+                        and p[:-len(dir_suffix)] or p, ignore_patterns)\n     for dirpath, dirnames, filenames in os.walk(root, topdown, onerror):\n+        remove_dirs = []\n+        for dirname in dirnames:\n+            if is_ignored(os.path.normpath(os.path.join(dirpath, dirname)), norm_patterns):\n+                remove_dirs.append(dirname)\n+        for dirname in remove_dirs:\n+            dirnames.remove(dirname)\n+            if verbosity > 1:\n+                stdout.write('ignoring directory %s\\n' % dirname)\n         yield (dirpath, dirnames, filenames)\n         if followlinks:\n             for d in dirnames:\n@@ -66,29 +79,29 @@ def is_ignored(path, ignore_patterns):\n             return True\n     return False\n \n-def find_files(root, ignore_patterns, verbosity, symlinks=False):\n+def find_files(root, ignore_patterns, verbosity, stdout=sys.stdout, symlinks=False):\n     \"\"\"\n     Helper function to get all files in the given root.\n     \"\"\"\n     all_files = []\n-    for (dirpath, dirnames, filenames) in walk(\".\", followlinks=symlinks):\n-        for f in filenames:\n-            norm_filepath = os.path.normpath(os.path.join(dirpath, f))\n+    for (dirpath, dirnames, filenames) in walk(\".\", followlinks=symlinks,\n+            ignore_patterns=ignore_patterns, verbosity=verbosity, stdout=stdout):\n+        for filename in filenames:\n+            norm_filepath = os.path.normpath(os.path.join(dirpath, filename))\n             if is_ignored(norm_filepath, ignore_patterns):\n                 if verbosity > 1:\n-                    sys.stdout.write('ignoring file %s in %s\\n' % (f, dirpath))\n+                    stdout.write('ignoring file %s in %s\\n' % (f, dirpath))\n             else:\n-                all_files.extend([(dirpath, f)])\n+                all_files.extend([(dirpath, filename)])\n     all_files.sort()\n     return all_files\n \n-def copy_plural_forms(msgs, locale, domain, verbosity):\n+def copy_plural_forms(msgs, locale, domain, verbosity, stdout=sys.stdout):\n     \"\"\"\n     Copies plural forms header contents from a Django catalog of locale to\n     the msgs string, inserting it at the right place. msgs should be the\n     contents of a newly created .po file.\n     \"\"\"\n-    import django\n     django_dir = os.path.normpath(os.path.join(os.path.dirname(django.__file__)))\n     if domain == 'djangojs':\n         domains = ('djangojs', 'django')\n@@ -100,7 +113,7 @@ def copy_plural_forms(msgs, locale, domain, verbosity):\n             m = plural_forms_re.search(open(django_po, 'rU').read())\n             if m:\n                 if verbosity > 1:\n-                    sys.stderr.write(\"copying plural forms: %s\\n\" % m.group('value'))\n+                    stdout.write(\"copying plural forms: %s\\n\" % m.group('value'))\n                 lines = []\n                 seen = False\n                 for line in msgs.split('\\n'):\n@@ -132,8 +145,8 @@ def write_pot_file(potfile, msgs, file, work_file, is_templatized):\n     finally:\n         f.close()\n \n-def process_file(file, dirpath, potfile, domain, verbosity, extensions, wrap,\n-        location):\n+def process_file(file, dirpath, potfile, domain, verbosity,\n+                 extensions, wrap, location, stdout=sys.stdout):\n     \"\"\"\n     Extract translatable literals from :param file: for :param domain:\n     creating or updating the :param potfile: POT file.\n@@ -144,7 +157,7 @@ def process_file(file, dirpath, potfile, domain, verbosity, extensions, wrap,\n     from django.utils.translation import templatize\n \n     if verbosity > 1:\n-        sys.stdout.write('processing file %s in %s\\n' % (file, dirpath))\n+        stdout.write('processing file %s in %s\\n' % (file, dirpath))\n     _, file_ext = os.path.splitext(file)\n     if domain == 'djangojs' and file_ext in extensions:\n         is_templatized = True\n@@ -162,10 +175,8 @@ def process_file(file, dirpath, potfile, domain, verbosity, extensions, wrap,\n             'xgettext -d %s -L C %s %s --keyword=gettext_noop '\n             '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n             '--keyword=pgettext:1c,2 --keyword=npgettext:1c,2,3 '\n-            '--from-code UTF-8 --add-comments=Translators -o - \"%s\"' % (\n-                domain, wrap, location, work_file\n-            )\n-        )\n+            '--from-code UTF-8 --add-comments=Translators -o - \"%s\"' %\n+            (domain, wrap, location, work_file))\n     elif domain == 'django' and (file_ext == '.py' or file_ext in extensions):\n         thefile = file\n         orig_file = os.path.join(dirpath, file)\n@@ -187,9 +198,8 @@ def process_file(file, dirpath, potfile, domain, verbosity, extensions, wrap,\n             '--keyword=ungettext_lazy:1,2 --keyword=pgettext:1c,2 '\n             '--keyword=npgettext:1c,2,3 --keyword=pgettext_lazy:1c,2 '\n             '--keyword=npgettext_lazy:1c,2,3 --from-code UTF-8 '\n-            '--add-comments=Translators -o - \"%s\"' % (\n-                domain, wrap, location, work_file)\n-        )\n+            '--add-comments=Translators -o - \"%s\"' %\n+            (domain, wrap, location, work_file))\n     else:\n         return\n     msgs, errors = _popen(cmd)\n@@ -206,8 +216,8 @@ def process_file(file, dirpath, potfile, domain, verbosity, extensions, wrap,\n     if is_templatized:\n         os.unlink(work_file)\n \n-def write_po_file(pofile, potfile, domain, locale, verbosity,\n-        copy_pforms, wrap, location, no_obsolete):\n+def write_po_file(pofile, potfile, domain, locale, verbosity, stdout,\n+                  copy_pforms, wrap, location, no_obsolete):\n     \"\"\"\n     Creates of updates the :param pofile: PO file for :param domain: and :param\n     locale:.  Uses contents of the existing :param potfile:.\n@@ -232,7 +242,7 @@ def write_po_file(pofile, potfile, domain, locale, verbosity,\n             raise CommandError(\n                 \"errors happened while running msgmerge\\n%s\" % errors)\n     elif copy_pforms:\n-        msgs = copy_plural_forms(msgs, locale, domain, verbosity)\n+        msgs = copy_plural_forms(msgs, locale, domain, verbosity, stdout)\n     msgs = msgs.replace(\n         \"#. #-#-#-#-#  %s.pot (PACKAGE VERSION)  #-#-#-#-#\\n\" % domain, \"\")\n     f = open(pofile, 'wb')\n@@ -250,7 +260,7 @@ def write_po_file(pofile, potfile, domain, locale, verbosity,\n \n def make_messages(locale=None, domain='django', verbosity=1, all=False,\n         extensions=None, symlinks=False, ignore_patterns=None, no_wrap=False,\n-        no_location=False, no_obsolete=False):\n+        no_location=False, no_obsolete=False, stdout=sys.stdout):\n     \"\"\"\n     Uses the ``locale/`` directory from the Django SVN tree or an\n     application/project to process all files with translatable literals for\n@@ -312,7 +322,7 @@ def make_messages(locale=None, domain='django', verbosity=1, all=False,\n \n     for locale in locales:\n         if verbosity > 0:\n-            print \"processing language\", locale\n+            stdout.write(\"processing language %s\" % locale)\n         basedir = os.path.join(localedir, locale, 'LC_MESSAGES')\n         if not os.path.isdir(basedir):\n             os.makedirs(basedir)\n@@ -324,12 +334,12 @@ def make_messages(locale=None, domain='django', verbosity=1, all=False,\n             os.unlink(potfile)\n \n         for dirpath, file in find_files(\".\", ignore_patterns, verbosity,\n-                symlinks=symlinks):\n+                stdout, symlinks=symlinks):\n             process_file(file, dirpath, potfile, domain, verbosity, extensions,\n-                    wrap, location)\n+                    wrap, location, stdout)\n \n         if os.path.exists(potfile):\n-            write_po_file(pofile, potfile, domain, locale, verbosity,\n+            write_po_file(pofile, potfile, domain, locale, verbosity, stdout,\n                     not invoked_for_django, wrap, location, no_obsolete)\n \n \n@@ -357,7 +367,7 @@ class Command(NoArgsCommand):\n         make_option('--no-obsolete', action='store_true', dest='no_obsolete',\n             default=False, help=\"Remove obsolete message strings\"),\n     )\n-    help = ( \"Runs over the entire source tree of the current directory and \"\n+    help = (\"Runs over the entire source tree of the current directory and \"\n \"pulls out all strings marked for translation. It creates (or updates) a message \"\n \"file in the conf/locale (in the django tree) or locale (for projects and \"\n \"applications) directory.\\n\\nYou must run this command with one of either the \"\n@@ -386,7 +396,8 @@ def handle_noargs(self, *args, **options):\n             extensions = handle_extensions(extensions or ['html', 'txt'])\n \n         if verbosity > 1:\n-            sys.stdout.write('examining files with the extensions: %s\\n'\n+            self.stdout.write('examining files with the extensions: %s\\n'\n                              % get_text_list(list(extensions), 'and'))\n \n-        make_messages(locale, domain, verbosity, process_all, extensions, symlinks, ignore_patterns, no_wrap, no_location, no_obsolete)\n+        make_messages(locale, domain, verbosity, process_all, extensions,\n+            symlinks, ignore_patterns, no_wrap, no_location, no_obsolete, self.stdout)"
        },
        {
            "sha": "4eb7abc7f0f888e47900ec0fe7e2496a4a83e9c5",
            "filename": "tests/regressiontests/i18n/commands/extraction.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/c6065545ef127ef244defd520b2bb1afe3a5c153/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "raw_url": "https://github.com/django/django/raw/c6065545ef127ef244defd520b2bb1afe3a5c153/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py?ref=c6065545ef127ef244defd520b2bb1afe3a5c153",
            "patch": "@@ -4,6 +4,7 @@\n import os\n import re\n import shutil\n+from StringIO import StringIO\n \n from django.core import management\n from django.test import TestCase\n@@ -177,7 +178,11 @@ class IgnoredExtractorTests(ExtractorTests):\n     def test_ignore_option(self):\n         os.chdir(self.test_dir)\n         pattern1 = os.path.join('ignore_dir', '*')\n-        management.call_command('makemessages', locale=LOCALE, verbosity=0, ignore_patterns=[pattern1])\n+        stdout = StringIO()\n+        management.call_command('makemessages', locale=LOCALE, verbosity=2,\n+            ignore_patterns=[pattern1], stdout=stdout)\n+        data = stdout.getvalue()\n+        self.assertTrue(\"ignoring directory ignore_dir\" in data)\n         self.assertTrue(os.path.exists(self.PO_FILE))\n         with open(self.PO_FILE, 'r') as fp:\n             po_contents = fp.read()"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 48,
        "deletions": 32
    }
}