{
    "author": "oinopion",
    "message": "Proposed fix for #18162.",
    "sha": "b6f4a92ff45d98a63dc29402d8ad86b88e6a6697",
    "files": [
        {
            "sha": "279c712a9835e8591846027f8c74b96faa84026e",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/b6f4a92ff45d98a63dc29402d8ad86b88e6a6697/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/b6f4a92ff45d98a63dc29402d8ad86b88e6a6697/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=b6f4a92ff45d98a63dc29402d8ad86b88e6a6697",
            "patch": "@@ -467,7 +467,7 @@ def _get_flatchoices(self):\n     def save_form_data(self, instance, data):\n         setattr(instance, self.name, data)\n \n-    def formfield(self, form_class=forms.CharField, **kwargs):\n+    def formfield(self, form_class=None, **kwargs):\n         \"\"\"\n         Returns a django.forms.Field instance for this database Field.\n         \"\"\"\n@@ -488,7 +488,8 @@ def formfield(self, form_class=forms.CharField, **kwargs):\n             defaults['coerce'] = self.to_python\n             if self.null:\n                 defaults['empty_value'] = None\n-            form_class = forms.TypedChoiceField\n+            if form_class is None or not issubclass(form_class, forms.TypedChoiceField):\n+                form_class = forms.TypedChoiceField\n             # Many of the subclass-specific formfield arguments (min_value,\n             # max_value) don't apply for choice fields, so be sure to only pass\n             # the values that TypedChoiceField will understand.\n@@ -498,6 +499,8 @@ def formfield(self, form_class=forms.CharField, **kwargs):\n                              'error_messages', 'show_hidden_initial'):\n                     del kwargs[k]\n         defaults.update(kwargs)\n+        if form_class is None:\n+            form_class = forms.CharField\n         return form_class(**defaults)\n \n     def value_from_object(self, obj):"
        },
        {
            "sha": "8c596ed4f5c4221038620a94a931ea8c5eeb6fae",
            "filename": "tests/regressiontests/model_fields/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/b6f4a92ff45d98a63dc29402d8ad86b88e6a6697/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b6f4a92ff45d98a63dc29402d8ad86b88e6a6697/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py?ref=b6f4a92ff45d98a63dc29402d8ad86b88e6a6697",
            "patch": "@@ -73,6 +73,16 @@ def test_field_verbose_name(self):\n \n         self.assertEqual(m._meta.get_field('id').verbose_name, 'verbose pk')\n \n+    def test_formclass_with_choices(self):\n+        # regression for 18162\n+        class CustomChoiceField(forms.TypedChoiceField):\n+            pass\n+        choices = [('a@b.cc', 'a@b.cc'), ('b@b.cc', 'b@b.cc')]\n+        field = models.CharField(choices=choices)\n+        klass = CustomChoiceField\n+        self.assertIsInstance(field.formfield(form_class=klass), klass)\n+\n+\n class DecimalFieldTests(test.TestCase):\n     def test_to_python(self):\n         f = models.DecimalField(max_digits=4, decimal_places=2)"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 15,
        "deletions": 2
    }
}