{
    "author": "carljm",
    "message": "Fixed #15161 - Corrected handling of ManyToManyField with through table using to_field on its ForeignKeys. Thanks to adehnert for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15330 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "84291b7b8456b554f162b6eeaffa9b124907c1d2",
    "files": [
        {
            "sha": "76f8eaf973eb1acfc6e0c05a4ee3f6bbf01f333c",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/84291b7b8456b554f162b6eeaffa9b124907c1d2/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/84291b7b8456b554f162b6eeaffa9b124907c1d2/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=84291b7b8456b554f162b6eeaffa9b124907c1d2",
            "patch": "@@ -135,6 +135,12 @@ def m2m_column_name(self):\n     def m2m_reverse_name(self):\n         return self.rel.to._meta.pk.column\n \n+    def m2m_target_field_name(self):\n+        return self.model._meta.pk.name\n+\n+    def m2m_reverse_target_field_name(self):\n+        return self.rel.to._meta.pk.name\n+\n     def contribute_to_class(self, cls, name):\n         super(GenericRelation, self).contribute_to_class(cls, name)\n "
        },
        {
            "sha": "6e18f6d470192b9cc2a58a4b39f33d51cf5fd0c8",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/84291b7b8456b554f162b6eeaffa9b124907c1d2/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/84291b7b8456b554f162b6eeaffa9b124907c1d2/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=84291b7b8456b554f162b6eeaffa9b124907c1d2",
            "patch": "@@ -1131,6 +1131,11 @@ def contribute_to_related_class(self, cls, related):\n         self.m2m_field_name = curry(self._get_m2m_attr, related, 'name')\n         self.m2m_reverse_field_name = curry(self._get_m2m_reverse_attr, related, 'name')\n \n+        get_m2m_rel = curry(self._get_m2m_attr, related, 'rel')\n+        self.m2m_target_field_name = lambda: get_m2m_rel().field_name\n+        get_m2m_reverse_rel = curry(self._get_m2m_reverse_attr, related, 'rel')\n+        self.m2m_reverse_target_field_name = lambda: get_m2m_reverse_rel().field_name\n+\n     def set_attributes_from_rel(self):\n         pass\n "
        },
        {
            "sha": "43cb9d71b5584d668904180f374d54693ca5dd9c",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/84291b7b8456b554f162b6eeaffa9b124907c1d2/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/84291b7b8456b554f162b6eeaffa9b124907c1d2/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=84291b7b8456b554f162b6eeaffa9b124907c1d2",
            "patch": "@@ -1282,12 +1282,14 @@ def setup_joins(self, names, opts, alias, dupe_multis, allow_many=True,\n                                 to_col2, opts, target) = cached_data\n                     else:\n                         table1 = field.m2m_db_table()\n-                        from_col1 = opts.pk.column\n+                        from_col1 = opts.get_field_by_name(\n+                            field.m2m_target_field_name())[0].column\n                         to_col1 = field.m2m_column_name()\n                         opts = field.rel.to._meta\n                         table2 = opts.db_table\n                         from_col2 = field.m2m_reverse_name()\n-                        to_col2 = opts.pk.column\n+                        to_col2 = opts.get_field_by_name(\n+                            field.m2m_reverse_target_field_name())[0].column\n                         target = opts.pk\n                         orig_opts._join_cache[name] = (table1, from_col1,\n                                 to_col1, table2, from_col2, to_col2, opts,\n@@ -1335,12 +1337,14 @@ def setup_joins(self, names, opts, alias, dupe_multis, allow_many=True,\n                                 to_col2, opts, target) = cached_data\n                     else:\n                         table1 = field.m2m_db_table()\n-                        from_col1 = opts.pk.column\n+                        from_col1 = opts.get_field_by_name(\n+                            field.m2m_reverse_target_field_name())[0].column\n                         to_col1 = field.m2m_reverse_name()\n                         opts = orig_field.opts\n                         table2 = opts.db_table\n                         from_col2 = field.m2m_column_name()\n-                        to_col2 = opts.pk.column\n+                        to_col2 = opts.get_field_by_name(\n+                            field.m2m_target_field_name())[0].column\n                         target = opts.pk\n                         orig_opts._join_cache[name] = (table1, from_col1,\n                                 to_col1, table2, from_col2, to_col2, opts,"
        },
        {
            "sha": "121ef22470af13b1b353cc99e2d6e617925e21f7",
            "filename": "tests/regressiontests/m2m_through_regress/models.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/84291b7b8456b554f162b6eeaffa9b124907c1d2/tests%2Fregressiontests%2Fm2m_through_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/84291b7b8456b554f162b6eeaffa9b124907c1d2/tests%2Fregressiontests%2Fm2m_through_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fm2m_through_regress%2Fmodels.py?ref=84291b7b8456b554f162b6eeaffa9b124907c1d2",
            "patch": "@@ -53,3 +53,25 @@ class Through(ThroughBase):\n class B(models.Model):\n     b_text = models.CharField(max_length=20)\n     a_list = models.ManyToManyField(A, through=Through)\n+\n+\n+# Using to_field on the through model\n+class Car(models.Model):\n+    make = models.CharField(max_length=20, unique=True)\n+    drivers = models.ManyToManyField('Driver', through='CarDriver')\n+\n+    def __unicode__(self, ):\n+        return self.make\n+\n+class Driver(models.Model):\n+    name = models.CharField(max_length=20, unique=True)\n+\n+    def __unicode__(self, ):\n+        return self.name\n+\n+class CarDriver(models.Model):\n+    car = models.ForeignKey('Car', to_field='make')\n+    driver = models.ForeignKey('Driver', to_field='name')\n+\n+    def __unicode__(self, ):\n+        return u\"pk=%s car=%s driver=%s\" % (str(self.pk), self.car, self.driver)"
        },
        {
            "sha": "fb2cb04d9b0da651aef87b3278857b6a842afb7c",
            "filename": "tests/regressiontests/m2m_through_regress/tests.py",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/84291b7b8456b554f162b6eeaffa9b124907c1d2/tests%2Fregressiontests%2Fm2m_through_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/84291b7b8456b554f162b6eeaffa9b124907c1d2/tests%2Fregressiontests%2Fm2m_through_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fm2m_through_regress%2Ftests.py?ref=84291b7b8456b554f162b6eeaffa9b124907c1d2",
            "patch": "@@ -7,7 +7,8 @@\n from django.contrib.auth.models import User\n from django.test import TestCase\n \n-from models import Person, Group, Membership, UserMembership\n+from models import (Person, Group, Membership, UserMembership,\n+                    Car, Driver, CarDriver)\n \n \n class M2MThroughTestCase(TestCase):\n@@ -118,6 +119,25 @@ def test_join_trimming(self):\n             ]\n         )\n \n+\n+class ToFieldThroughTests(TestCase):\n+    def setUp(self):\n+        self.car = Car.objects.create(make=\"Toyota\")\n+        self.driver = Driver.objects.create(name=\"Ryan Briscoe\")\n+        CarDriver.objects.create(car=self.car, driver=self.driver)\n+\n+    def test_to_field(self):\n+        self.assertQuerysetEqual(\n+            self.car.drivers.all(),\n+            [\"<Driver: Ryan Briscoe>\"]\n+            )\n+\n+    def test_to_field_reverse(self):\n+        self.assertQuerysetEqual(\n+            self.driver.car_set.all(),\n+            [\"<Car: Toyota>\"]\n+            )\n+\n class ThroughLoadDataTestCase(TestCase):\n     fixtures = [\"m2m_through\"]\n "
        }
    ],
    "stats": {
        "total": 67,
        "additions": 62,
        "deletions": 5
    }
}