{
    "author": "carljm",
    "message": "Fixed #18083 -- Fixed cascade deletion with proxy model of concrete subclass. Thanks Simon Charette for report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17887 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f195f1ed2481d34ff56df36cf46ad7d377f2af93",
    "files": [
        {
            "sha": "d8bb8f2e66f650ae8811c889a6b66a209980b4b6",
            "filename": "django/db/models/deletion.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/f195f1ed2481d34ff56df36cf46ad7d377f2af93/django%2Fdb%2Fmodels%2Fdeletion.py",
            "raw_url": "https://github.com/django/django/raw/f195f1ed2481d34ff56df36cf46ad7d377f2af93/django%2Fdb%2Fmodels%2Fdeletion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fdeletion.py?ref=f195f1ed2481d34ff56df36cf46ad7d377f2af93",
            "patch": "@@ -154,9 +154,10 @@ def collect(self, objs, source=None, nullable=False, collect_related=True,\n \n         model = new_objs[0].__class__\n \n-        # Recursively collect parent models, but not their related objects.\n-        # These will be found by meta.get_all_related_objects()\n-        for parent_model, ptr in model._meta.parents.iteritems():\n+        # Recursively collect concrete model's parent models, but not their\n+        # related objects. These will be found by meta.get_all_related_objects()\n+        concrete_model = model._meta.concrete_model\n+        for ptr in concrete_model._meta.parents.itervalues():\n             if ptr:\n                 parent_objs = [getattr(obj, ptr.name) for obj in new_objs]\n                 self.collect(parent_objs, source=model,"
        },
        {
            "sha": "ef9ac6b0d3b77077306aeab14393114fb7651ed2",
            "filename": "tests/modeltests/proxy_model_inheritance/models.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/f195f1ed2481d34ff56df36cf46ad7d377f2af93/tests%2Fmodeltests%2Fproxy_model_inheritance%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f195f1ed2481d34ff56df36cf46ad7d377f2af93/tests%2Fmodeltests%2Fproxy_model_inheritance%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fproxy_model_inheritance%2Fmodels.py?ref=f195f1ed2481d34ff56df36cf46ad7d377f2af93",
            "patch": "@@ -0,0 +1,13 @@\n+\n+from django.db import models\n+\n+\n+class ConcreteModel(models.Model):\n+    pass\n+\n+class ConcreteModelSubclass(ConcreteModel):\n+    pass\n+\n+class ConcreteModelSubclassProxy(ConcreteModelSubclass):\n+    class Meta:\n+        proxy = True"
        },
        {
            "sha": "061cdc7e918c362eeef40eaba457329f87d65085",
            "filename": "tests/modeltests/proxy_model_inheritance/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 9,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/f195f1ed2481d34ff56df36cf46ad7d377f2af93/tests%2Fmodeltests%2Fproxy_model_inheritance%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f195f1ed2481d34ff56df36cf46ad7d377f2af93/tests%2Fmodeltests%2Fproxy_model_inheritance%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fproxy_model_inheritance%2Ftests.py?ref=f195f1ed2481d34ff56df36cf46ad7d377f2af93",
            "patch": "@@ -1,11 +1,3 @@\n-\"\"\"\n-XX. Proxy model inheritance\n-\n-Proxy model inheritance across apps can result in syncdb not creating the table\n-for the proxied model (as described in #12286).  This test creates two dummy\n-apps and calls syncdb, then verifies that the table has been created.\n-\"\"\"\n-\n from __future__ import absolute_import\n \n import os\n@@ -14,12 +6,20 @@\n from django.conf import settings\n from django.core.management import call_command\n from django.db.models.loading import cache, load_app\n-from django.test import TransactionTestCase\n+from django.test import TestCase, TransactionTestCase\n from django.test.utils import override_settings\n \n+from .models import (ConcreteModel, ConcreteModelSubclass,\n+    ConcreteModelSubclassProxy)\n+\n \n @override_settings(INSTALLED_APPS=('app1', 'app2'))\n class ProxyModelInheritanceTests(TransactionTestCase):\n+    \"\"\"\n+    Proxy model inheritance across apps can result in syncdb not creating the table\n+    for the proxied model (as described in #12286).  This test creates two dummy\n+    apps and calls syncdb, then verifies that the table has been created.\n+    \"\"\"\n \n     def setUp(self):\n         self.old_sys_path = sys.path[:]\n@@ -41,3 +41,19 @@ def test_table_exists(self):\n         from .app2.models import NiceModel\n         self.assertEqual(NiceModel.objects.all().count(), 0)\n         self.assertEqual(ProxyModel.objects.all().count(), 0)\n+\n+\n+class MultiTableInheritanceProxyTest(TestCase):\n+\n+    def test_model_subclass_proxy(self):\n+        \"\"\"\n+        Deleting an instance of a model proxying a multi-table inherited\n+        subclass should cascade delete down the whole inheritance chain (see\n+        #18083).\n+\n+        \"\"\"\n+        instance = ConcreteModelSubclassProxy.objects.create()\n+        instance.delete()\n+        self.assertEqual(0, ConcreteModelSubclassProxy.objects.count())\n+        self.assertEqual(0, ConcreteModelSubclass.objects.count())\n+        self.assertEqual(0, ConcreteModel.objects.count())"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 42,
        "deletions": 12
    }
}