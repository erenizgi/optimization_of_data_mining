{
    "author": "ramiro",
    "message": "Made email attachment handling code accept non-ASCII filenames.\n\nThanks to Anton Chaporgin for the report and to Claude Paroz for the patch.\n\nFixes #14964.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17375 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "665ec600a40ffc3c9baea30be9c8765939512748",
    "files": [
        {
            "sha": "7347391f0b9485b76e1ab2169279c9adacd34225",
            "filename": "django/core/mail/message.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/665ec600a40ffc3c9baea30be9c8765939512748/django%2Fcore%2Fmail%2Fmessage.py",
            "raw_url": "https://github.com/django/django/raw/665ec600a40ffc3c9baea30be9c8765939512748/django%2Fcore%2Fmail%2Fmessage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fmessage.py?ref=665ec600a40ffc3c9baea30be9c8765939512748",
            "patch": "@@ -311,6 +311,10 @@ def _create_attachment(self, filename, content, mimetype=None):\n                 mimetype = DEFAULT_ATTACHMENT_MIME_TYPE\n         attachment = self._create_mime_attachment(content, mimetype)\n         if filename:\n+            try:\n+                filename = filename.encode('ascii')\n+            except UnicodeEncodeError:\n+                filename = ('utf-8', '', filename.encode('utf-8'))\n             attachment.add_header('Content-Disposition', 'attachment',\n                                   filename=filename)\n         return attachment"
        },
        {
            "sha": "1286dcfdd0394cd732989635b2166fbb97d885eb",
            "filename": "docs/ref/unicode.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/665ec600a40ffc3c9baea30be9c8765939512748/docs%2Fref%2Funicode.txt",
            "raw_url": "https://github.com/django/django/raw/665ec600a40ffc3c9baea30be9c8765939512748/docs%2Fref%2Funicode.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Funicode.txt?ref=665ec600a40ffc3c9baea30be9c8765939512748",
            "patch": "@@ -322,7 +322,9 @@ can be non-ASCII::\n     sender = u'Arnbjörg Ráðormsdóttir <arnbjorg@example.com>'\n     recipients = ['Fred <fred@example.com']\n     body = u'...'\n-    EmailMessage(subject, body, sender, recipients).send()\n+    msg = EmailMessage(subject, body, sender, recipients)\n+    msg.attach(u\"Une pièce jointe.pdf\", \"%PDF-1.4.%...\", mimetype=\"application/pdf\")\n+    msg.send()\n \n Form submission\n ==============="
        },
        {
            "sha": "ed85918f17aebc3080524083577dbbbb8836ee1f",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/665ec600a40ffc3c9baea30be9c8765939512748/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/665ec600a40ffc3c9baea30be9c8765939512748/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=665ec600a40ffc3c9baea30be9c8765939512748",
            "patch": "@@ -198,6 +198,19 @@ def test_attachments(self):\n         self.assertEqual(payload[0].get_content_type(), 'multipart/alternative')\n         self.assertEqual(payload[1].get_content_type(), 'application/pdf')\n \n+    def test_non_ascii_attachment_filename(self):\n+        \"\"\"Regression test for #14964\"\"\"\n+        headers = {\"Date\": \"Fri, 09 Nov 2001 01:08:47 -0000\", \"Message-ID\": \"foo\"}\n+        subject, from_email, to = 'hello', 'from@example.com', 'to@example.com'\n+        content = 'This is the message.'\n+        msg = EmailMessage(subject, content, from_email, [to], headers=headers)\n+        # Unicode in file name\n+        msg.attach(u\"une pièce jointe.pdf\", \"%PDF-1.4.%...\", mimetype=\"application/pdf\")\n+        msg_str = msg.message().as_string()\n+        message = email.message_from_string(msg_str)\n+        payload = message.get_payload()\n+        self.assertEqual(payload[1].get_filename(), u'une pièce jointe.pdf')\n+\n     def test_dummy_backend(self):\n         \"\"\"\n         Make sure that dummy backends returns correct number of sent messages"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 20,
        "deletions": 1
    }
}