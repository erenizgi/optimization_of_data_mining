{
    "author": "aaugustin",
    "message": "Modified the tablespaces tests so that they no longer rely on settings.DEFAULT_INDEX_TABLESPACE being empty. Refs #12308.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16990 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c582609c8dbaa0a782999fa5f81e71d34ff219b8",
    "files": [
        {
            "sha": "17fdb8dd7416fcf273ca54721df7648c7285276f",
            "filename": "tests/modeltests/tablespaces/tests.py",
            "status": "modified",
            "additions": 61,
            "deletions": 23,
            "changes": 84,
            "blob_url": "https://github.com/django/django/blob/c582609c8dbaa0a782999fa5f81e71d34ff219b8/tests%2Fmodeltests%2Ftablespaces%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c582609c8dbaa0a782999fa5f81e71d34ff219b8/tests%2Fmodeltests%2Ftablespaces%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftablespaces%2Ftests.py?ref=c582609c8dbaa0a782999fa5f81e71d34ff219b8",
            "patch": "@@ -1,5 +1,6 @@\n import copy\n \n+from django.conf import settings\n from django.db import connection\n from django.db import models\n from django.db.models.loading import cache\n@@ -10,7 +11,7 @@\n \n # We can't test the DEFAULT_TABLESPACE and DEFAULT_INDEX_TABLESPACE settings\n # because they're evaluated when the model class is defined. As a consequence,\n-# @override_settings doesn't work.\n+# @override_settings doesn't work, and the tests depend\n \n def sql_for_table(model):\n     return '\\n'.join(connection.creation.sql_create_model(model, no_style())[0])\n@@ -45,8 +46,15 @@ def assertNumContains(self, haystack, needle, count):\n \n     @skipUnlessDBFeature('supports_tablespaces')\n     def test_tablespace_for_model(self):\n-        # 1 for the table + 1 for the index on the primary key\n-        self.assertNumContains(sql_for_table(Scientist).lower(), 'tbl_tbsp', 2)\n+        sql = sql_for_table(Scientist).lower()\n+        if settings.DEFAULT_INDEX_TABLESPACE:\n+            # 1 for the table\n+            self.assertNumContains(sql, 'tbl_tbsp', 1)\n+            # 1 for the index on the primary key\n+            self.assertNumContains(sql, settings.DEFAULT_INDEX_TABLESPACE, 1)\n+        else:\n+            # 1 for the table + 1 for the index on the primary key\n+            self.assertNumContains(sql, 'tbl_tbsp', 2)\n \n     @skipIfDBFeature('supports_tablespaces')\n     def test_tablespace_ignored_for_model(self):\n@@ -56,10 +64,18 @@ def test_tablespace_ignored_for_model(self):\n \n     @skipUnlessDBFeature('supports_tablespaces')\n     def test_tablespace_for_indexed_field(self):\n-        # 1 for the table + 1 for the primary key + 1 for the index on name\n-        self.assertNumContains(sql_for_table(Article).lower(), 'tbl_tbsp', 3)\n+        sql = sql_for_table(Article).lower()\n+        if settings.DEFAULT_INDEX_TABLESPACE:\n+            # 1 for the table\n+            self.assertNumContains(sql, 'tbl_tbsp', 1)\n+            # 1 for the primary key + 1 for the index on code\n+            self.assertNumContains(sql, settings.DEFAULT_INDEX_TABLESPACE, 2)\n+        else:\n+            # 1 for the table + 1 for the primary key + 1 for the index on code\n+            self.assertNumContains(sql, 'tbl_tbsp', 3)\n+\n         # 1 for the index on reference\n-        self.assertNumContains(sql_for_table(Article).lower(), 'idx_tbsp', 1)\n+        self.assertNumContains(sql, 'idx_tbsp', 1)\n \n     @skipIfDBFeature('supports_tablespaces')\n     def test_tablespace_ignored_for_indexed_field(self):\n@@ -69,20 +85,42 @@ def test_tablespace_ignored_for_indexed_field(self):\n \n     @skipUnlessDBFeature('supports_tablespaces')\n     def test_tablespace_for_many_to_many_field(self):\n-        # The join table of the ManyToManyField always goes to the tablespace\n-        # of the model.\n-        self.assertNumContains(sql_for_table(Authors).lower(), 'tbl_tbsp', 2)\n-        self.assertNumContains(sql_for_table(Authors).lower(), 'idx_tbsp', 0)\n-        # The ManyToManyField declares no db_tablespace, indexes for the two\n-        # foreign keys in the join table go to the tablespace of the model.\n-        self.assertNumContains(sql_for_index(Authors).lower(), 'tbl_tbsp', 2)\n-        self.assertNumContains(sql_for_index(Authors).lower(), 'idx_tbsp', 0)\n-\n-        # The join table of the ManyToManyField always goes to the tablespace\n-        # of the model.\n-        self.assertNumContains(sql_for_table(Reviewers).lower(), 'tbl_tbsp', 2)\n-        self.assertNumContains(sql_for_table(Reviewers).lower(), 'idx_tbsp', 0)\n-        # The ManyToManyField declares db_tablespace, indexes for the two\n-        # foreign keys in the join table go to this tablespace.\n-        self.assertNumContains(sql_for_index(Reviewers).lower(), 'tbl_tbsp', 0)\n-        self.assertNumContains(sql_for_index(Reviewers).lower(), 'idx_tbsp', 2)\n+        sql = sql_for_table(Authors).lower()\n+        # The join table of the ManyToManyField goes to the model's tablespace,\n+        # and its indexes too, unless DEFAULT_INDEX_TABLESPACE is set.\n+        if settings.DEFAULT_INDEX_TABLESPACE:\n+            # 1 for the table\n+            self.assertNumContains(sql, 'tbl_tbsp', 1)\n+            # 1 for the primary key\n+            self.assertNumContains(sql, settings.DEFAULT_INDEX_TABLESPACE, 1)\n+        else:\n+            # 1 for the table + 1 for the index on the primary key\n+            self.assertNumContains(sql, 'tbl_tbsp', 2)\n+        self.assertNumContains(sql, 'idx_tbsp', 0)\n+\n+        sql = sql_for_index(Authors).lower()\n+        # The ManyToManyField declares no db_tablespace, its indexes go to\n+        # the model's tablespace, unless DEFAULT_INDEX_TABLESPACE is set.\n+        if settings.DEFAULT_INDEX_TABLESPACE:\n+            self.assertNumContains(sql, settings.DEFAULT_INDEX_TABLESPACE, 2)\n+        else:\n+            self.assertNumContains(sql, 'tbl_tbsp', 2)\n+        self.assertNumContains(sql, 'idx_tbsp', 0)\n+\n+        sql = sql_for_table(Reviewers).lower()\n+        # The join table of the ManyToManyField goes to the model's tablespace,\n+        # and its indexes too, unless DEFAULT_INDEX_TABLESPACE is set.\n+        if settings.DEFAULT_INDEX_TABLESPACE:\n+            # 1 for the table\n+            self.assertNumContains(sql, 'tbl_tbsp', 1)\n+            # 1 for the primary key\n+            self.assertNumContains(sql, settings.DEFAULT_INDEX_TABLESPACE, 1)\n+        else:\n+            # 1 for the table + 1 for the index on the primary key\n+            self.assertNumContains(sql, 'tbl_tbsp', 2)\n+        self.assertNumContains(sql, 'idx_tbsp', 0)\n+\n+        sql = sql_for_index(Reviewers).lower()\n+        # The ManyToManyField declares db_tablespace, its indexes go there.\n+        self.assertNumContains(sql, 'tbl_tbsp', 0)\n+        self.assertNumContains(sql, 'idx_tbsp', 2)"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 61,
        "deletions": 23
    }
}