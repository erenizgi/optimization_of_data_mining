{
    "author": "jphalip",
    "message": "Fixed #16340 -- Made `get_or_create()` re-raise any `IntegrityError` with its original traceback. Thanks to d0ugal and Jonas Obrist.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17333 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "31b1cbc623c246570e7301c0334df938d840638f",
    "files": [
        {
            "sha": "41c24c7a583cc31e31678320acaf14150ac7fe6f",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/31b1cbc623c246570e7301c0334df938d840638f/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/31b1cbc623c246570e7301c0334df938d840638f/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=31b1cbc623c246570e7301c0334df938d840638f",
            "patch": "@@ -4,6 +4,7 @@\n \n import copy\n import itertools\n+import sys\n \n from django.db import connections, router, transaction, IntegrityError\n from django.db.models.fields import AutoField\n@@ -450,10 +451,12 @@ def get_or_create(self, **kwargs):\n                 return obj, True\n             except IntegrityError, e:\n                 transaction.savepoint_rollback(sid, using=self.db)\n+                exc_info = sys.exc_info()\n                 try:\n                     return self.get(**lookup), False\n                 except self.model.DoesNotExist:\n-                    raise e\n+                    # Re-raise the IntegrityError with its original traceback.\n+                    raise exc_info[1], None, exc_info[2]\n \n     def latest(self, field_name=None):\n         \"\"\""
        },
        {
            "sha": "f98f0e63d84aa529423c995e63aae288274d0266",
            "filename": "tests/modeltests/get_or_create/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/31b1cbc623c246570e7301c0334df938d840638f/tests%2Fmodeltests%2Fget_or_create%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/31b1cbc623c246570e7301c0334df938d840638f/tests%2Fmodeltests%2Fget_or_create%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fget_or_create%2Ftests.py?ref=31b1cbc623c246570e7301c0334df938d840638f",
            "patch": "@@ -1,6 +1,7 @@\n from __future__ import absolute_import\n \n from datetime import date\n+import traceback\n \n from django.db import IntegrityError\n from django.test import TestCase\n@@ -52,3 +53,14 @@ def test_get_or_create(self):\n             ManualPrimaryKeyTest.objects.get_or_create, id=1, data=\"Different\"\n         )\n         self.assertEqual(ManualPrimaryKeyTest.objects.get(id=1).data, \"Original\")\n+\n+        # get_or_create should raise IntegrityErrors with the full traceback.\n+        # This is tested by checking that a known method call is in the traceback.\n+        # We cannot use assertRaises/assertRaises here because we need to inspect\n+        # the actual traceback. Refs #16340.\n+        try:\n+            ManualPrimaryKeyTest.objects.get_or_create(id=1, data=\"Different\")\n+        except IntegrityError, e:\n+            formatted_traceback = traceback.format_exc()\n+            self.assertIn('obj.save', formatted_traceback)\n+"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 16,
        "deletions": 1
    }
}