{
    "author": "aaugustin",
    "message": "Fix #19524 -- Incorrect caching of parents of unsaved model instances.\n\nThanks qcwxezdas for the report. Refs #13839.",
    "sha": "e9c24bef74e55729b190cf07e0ac452aa4c86fcd",
    "files": [
        {
            "sha": "bd638e2499045fbbcadae4870874528cf69b3d8a",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=e9c24bef74e55729b190cf07e0ac452aa4c86fcd",
            "patch": "@@ -583,6 +583,15 @@ def save_base(self, raw=False, cls=None, origin=None, force_insert=False,\n \n                 if field:\n                     setattr(self, field.attname, self._get_pk_val(parent._meta))\n+                    # Since we didn't have an instance of the parent handy, we\n+                    # set attname directly, bypassing the descriptor.\n+                    # Invalidate the related object cache, in case it's been\n+                    # accidentally populated. A fresh instance will be\n+                    # re-built from the database if necessary.\n+                    cache_name = field.get_cache_name()\n+                    if hasattr(self, cache_name):\n+                        delattr(self, cache_name)\n+\n             if meta.proxy:\n                 return\n "
        },
        {
            "sha": "27c246b668d91ac71658ebcd7f650d01a30ca8ed",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=e9c24bef74e55729b190cf07e0ac452aa4c86fcd",
            "patch": "@@ -692,7 +692,10 @@ def __init__(self, data=None, files=None, instance=None,\n         self.rel_name = RelatedObject(self.fk.rel.to, self.model, self.fk).get_accessor_name()\n         if queryset is None:\n             queryset = self.model._default_manager\n-        qs = queryset.filter(**{self.fk.name: self.instance})\n+        if self.instance.pk:\n+            qs = queryset.filter(**{self.fk.name: self.instance})\n+        else:\n+            qs = queryset.none()\n         super(BaseInlineFormSet, self).__init__(data, files, prefix=prefix,\n                                                 queryset=qs, **kwargs)\n "
        },
        {
            "sha": "536c3ec0797054a8635d6ef7b691bedc1c759864",
            "filename": "tests/regressiontests/admin_inlines/admin.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/tests%2Fregressiontests%2Fadmin_inlines%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/tests%2Fregressiontests%2Fadmin_inlines%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Fadmin.py?ref=e9c24bef74e55729b190cf07e0ac452aa4c86fcd",
            "patch": "@@ -124,6 +124,9 @@ class ChildModel1Inline(admin.TabularInline):\n class ChildModel2Inline(admin.StackedInline):\n     model = ChildModel2\n \n+# admin for #19524\n+class SightingInline(admin.TabularInline):\n+    model = Sighting\n \n site.register(TitleCollection, inlines=[TitleInline])\n # Test bug #12561 and #12778\n@@ -141,4 +144,5 @@ class ChildModel2Inline(admin.StackedInline):\n site.register(Author, AuthorAdmin)\n site.register(CapoFamiglia, inlines=[ConsigliereInline, SottoCapoInline])\n site.register(ProfileCollection, inlines=[ProfileInline])\n-site.register(ParentModelWithCustomPk, inlines=[ChildModel1Inline, ChildModel2Inline])\n\\ No newline at end of file\n+site.register(ParentModelWithCustomPk, inlines=[ChildModel1Inline, ChildModel2Inline])\n+site.register(ExtraTerrestrial, inlines=[SightingInline])"
        },
        {
            "sha": "147873a9e867e5372c3c6798d5a657bfe6ec1f15",
            "filename": "tests/regressiontests/admin_inlines/models.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py?ref=e9c24bef74e55729b190cf07e0ac452aa4c86fcd",
            "patch": "@@ -90,7 +90,6 @@ class Inner4Tabular(models.Model):\n     dummy = models.IntegerField(help_text=\"Awesome tabular help text is awesome.\")\n     holder = models.ForeignKey(Holder4)\n \n-\n # Models for #12749\n \n class Person(models.Model):\n@@ -133,6 +132,7 @@ class Chapter(models.Model):\n \n \n # Models for #16838\n+\n class CapoFamiglia(models.Model):\n     name = models.CharField(max_length=100)\n \n@@ -170,6 +170,17 @@ class ChildModel2(models.Model):\n     def get_absolute_url(self):\n         return '/child_model2/'\n \n+# Models for #19524\n+\n+class LifeForm(models.Model):\n+    pass\n+\n+class ExtraTerrestrial(LifeForm):\n+    name = models.CharField(max_length=100)\n+\n+class Sighting(models.Model):\n+    et = models.ForeignKey(ExtraTerrestrial)\n+    place = models.CharField(max_length=100)\n \n # Other models\n "
        },
        {
            "sha": "54283bf50965560167f1416d848d477d5f2db1e2",
            "filename": "tests/regressiontests/admin_inlines/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e9c24bef74e55729b190cf07e0ac452aa4c86fcd/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py?ref=e9c24bef74e55729b190cf07e0ac452aa4c86fcd",
            "patch": "@@ -12,7 +12,7 @@\n from .models import (Holder, Inner, Holder2, Inner2, Holder3, Inner3, Person,\n     OutfitItem, Fashionista, Teacher, Parent, Child, Author, Book, Profile,\n     ProfileCollection, ParentModelWithCustomPk, ChildModel1, ChildModel2,\n-    Title)\n+    Sighting, Title)\n \n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n@@ -172,6 +172,23 @@ def test_custom_pk_shortcut(self):\n         self.assertContains(response, child1_shortcut)\n         self.assertContains(response, child2_shortcut)\n \n+    def test_create_inlines_on_inherited_model(self):\n+        \"\"\"\n+        Ensure that an object can be created with inlines when it inherits\n+        another class. Bug #19524.\n+        \"\"\"\n+        data = {\n+            'name': 'Martian',\n+            'sighting_set-TOTAL_FORMS': 1,\n+            'sighting_set-INITIAL_FORMS': 0,\n+            'sighting_set-MAX_NUM_FORMS': 0,\n+            'sighting_set-0-place': 'Zone 51',\n+            '_save': 'Save',\n+        }\n+        response = self.client.post('/admin/admin_inlines/extraterrestrial/add/', data)\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(Sighting.objects.filter(et__name='Martian').count(), 1)\n+\n \n @override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n class TestInlineMedia(TestCase):"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 48,
        "deletions": 4
    }
}