{
    "author": "PaulMcMillan",
    "message": "Fixed #16494 by normalizing HttpResponse behavior with non-string input. HttpResponse now always converts content to string on output, regardless of input type.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16829 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "50255e33053714ec3b363cf39e2d9a7f4b0ed83c",
    "files": [
        {
            "sha": "913c7eb704841f50b6f6a5136dc31c665cb93cf9",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/50255e33053714ec3b363cf39e2d9a7f4b0ed83c/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/50255e33053714ec3b363cf39e2d9a7f4b0ed83c/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=50255e33053714ec3b363cf39e2d9a7f4b0ed83c",
            "patch": "@@ -544,12 +544,7 @@ def __init__(self, content='', mimetype=None, status=None,\n         if not content_type:\n             content_type = \"%s; charset=%s\" % (settings.DEFAULT_CONTENT_TYPE,\n                     self._charset)\n-        if not isinstance(content, basestring) and hasattr(content, '__iter__'):\n-            self._container = content\n-            self._is_string = False\n-        else:\n-            self._container = [content]\n-            self._is_string = True\n+        HttpResponse._set_content(self, content)\n         self.cookies = SimpleCookie()\n         if status:\n             self.status_code = status\n@@ -649,12 +644,16 @@ def delete_cookie(self, key, path='/', domain=None):\n \n     def _get_content(self):\n         if self.has_header('Content-Encoding'):\n-            return ''.join(self._container)\n-        return smart_str(''.join(self._container), self._charset)\n+            return ''.join([str(e) for e in self._container])\n+        return ''.join([smart_str(e, self._charset) for e in self._container])\n \n     def _set_content(self, value):\n-        self._container = [value]\n-        self._is_string = True\n+        if hasattr(value, '__iter__'):\n+            self._container = value\n+            self._base_content_is_iter = True\n+        else:\n+            self._container = [value]\n+            self._base_content_is_iter = False\n \n     content = property(_get_content, _set_content)\n \n@@ -675,17 +674,17 @@ def close(self):\n     # The remaining methods partially implement the file-like object interface.\n     # See http://docs.python.org/lib/bltin-file-objects.html\n     def write(self, content):\n-        if not self._is_string:\n+        if self._base_content_is_iter:\n             raise Exception(\"This %s instance is not writable\" % self.__class__)\n         self._container.append(content)\n \n     def flush(self):\n         pass\n \n     def tell(self):\n-        if not self._is_string:\n+        if self._base_content_is_iter:\n             raise Exception(\"This %s instance cannot tell its position\" % self.__class__)\n-        return sum([len(chunk) for chunk in self._container])\n+        return sum([len(str(chunk)) for chunk in self._container])\n \n class HttpResponseRedirect(HttpResponse):\n     status_code = 302"
        },
        {
            "sha": "e15fa5016fe2e9335a7ef4cc1ff50638c7ee87a4",
            "filename": "docs/ref/request-response.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/50255e33053714ec3b363cf39e2d9a7f4b0ed83c/docs%2Fref%2Frequest-response.txt",
            "raw_url": "https://github.com/django/django/raw/50255e33053714ec3b363cf39e2d9a7f4b0ed83c/docs%2Fref%2Frequest-response.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Frequest-response.txt?ref=50255e33053714ec3b363cf39e2d9a7f4b0ed83c",
            "patch": "@@ -587,7 +587,7 @@ Attributes\n \n .. attribute:: HttpResponse.content\n \n-    A normal Python string representing the content, encoded from a Unicode\n+    A string representing the content, encoded from a Unicode\n     object if necessary.\n \n .. attribute:: HttpResponse.status_code\n@@ -603,9 +603,11 @@ Methods\n     string) and MIME type. The :setting:`DEFAULT_CONTENT_TYPE` is\n     ``'text/html'``.\n \n-    ``content`` can be an iterator or a string. If it's an iterator, it should\n-    return strings, and those strings will be joined together to form the\n-    content of the response.\n+    ``content`` should be an iterator or a string. If it's an\n+    iterator, it should return strings, and those strings will be\n+    joined together to form the content of the response. If it is not\n+    an iterator or a string, it will be converted to a string when\n+    accessed.\n \n     ``status`` is the `HTTP Status code`_ for the response.\n "
        },
        {
            "sha": "81065564c74a61fd34f28313c266ae8e7ce90a2f",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 47,
            "deletions": 2,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/50255e33053714ec3b363cf39e2d9a7f4b0ed83c/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/50255e33053714ec3b363cf39e2d9a7f4b0ed83c/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=50255e33053714ec3b363cf39e2d9a7f4b0ed83c",
            "patch": "@@ -216,13 +216,13 @@ def test_unicode_headers(self):\n         r['value'] = u'test value'\n         self.assertTrue(isinstance(r['value'], str))\n \n-        # An error is raised ~hen a unicode object with non-ascii is assigned.\n+        # An error is raised when a unicode object with non-ascii is assigned.\n         self.assertRaises(UnicodeEncodeError, r.__setitem__, 'value', u't\\xebst value')\n \n         # An error is raised when  a unicode object with non-ASCII format is\n         # passed as initial mimetype or content_type.\n         self.assertRaises(UnicodeEncodeError, HttpResponse,\n-                mimetype=u't\\xebst value')\n+                content_type=u't\\xebst value')\n \n         # HttpResponse headers must be convertible to ASCII.\n         self.assertRaises(UnicodeEncodeError, HttpResponse,\n@@ -250,6 +250,51 @@ def test_dict_behavior(self):\n         r = HttpResponse()\n         self.assertEqual(r.get('test'), None)\n \n+    def test_non_string_content(self):\n+        #Bug 16494: HttpResponse should behave consistently with non-strings\n+        r = HttpResponse(12345)\n+        self.assertEqual(r.content, '12345')\n+\n+        #test content via property\n+        r = HttpResponse()\n+        r.content = 12345\n+        self.assertEqual(r.content, '12345')\n+\n+    def test_iter_content(self):\n+        r = HttpResponse(['abc', 'def', 'ghi'])\n+        self.assertEqual(r.content, 'abcdefghi')\n+\n+        #test iter content via property\n+        r = HttpResponse()\n+        r.content = ['idan', 'alex', 'jacob']\n+        self.assertEqual(r.content, 'idanalexjacob')\n+\n+        r = HttpResponse()\n+        r.content = [1, 2, 3]\n+        self.assertEqual(r.content, '123')\n+\n+        #test retrieval explicitly using iter and odd inputs\n+        r = HttpResponse()\n+        r.content = ['1', u'2', 3, unichr(1950)]\n+        result = []\n+        my_iter = r.__iter__()\n+        while True:\n+            try:\n+                result.append(my_iter.next())\n+            except StopIteration:\n+                break\n+        #'\\xde\\x9e' == unichr(1950).encode('utf-8')\n+        self.assertEqual(result, ['1', '2', '3', '\\xde\\x9e'])\n+        self.assertEqual(r.content, '123\\xde\\x9e')\n+\n+        #with Content-Encoding header\n+        r = HttpResponse([1,1,2,4,8])\n+        r['Content-Encoding'] = 'winning'\n+        self.assertEqual(r.content, '11248')\n+        r.content = [unichr(1950),]\n+        self.assertRaises(UnicodeEncodeError,\n+                          getattr, r, 'content')\n+\n class CookieTests(unittest.TestCase):\n     def test_encode(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 84,
        "additions": 65,
        "deletions": 19
    }
}