{
    "author": "jezdez",
    "message": "Fixed #15921 -- Refined naturaltime filter added in r16071 to use timesince and timeuntil filters as fallbacks instead of date filter.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16233 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "578a31fea3cb439f6bfeeb7825ac835820a9f58c",
    "files": [
        {
            "sha": "ba05bc9d70f7aef593f0822f575b7fc81ca798c3",
            "filename": "django/contrib/humanize/locale/en/LC_MESSAGES/django.mo",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/578a31fea3cb439f6bfeeb7825ac835820a9f58c/django%2Fcontrib%2Fhumanize%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.mo",
            "raw_url": "https://github.com/django/django/raw/578a31fea3cb439f6bfeeb7825ac835820a9f58c/django%2Fcontrib%2Fhumanize%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.mo",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.mo?ref=578a31fea3cb439f6bfeeb7825ac835820a9f58c"
        },
        {
            "sha": "360bdd94e68a2f69ee301340704035070ab761df",
            "filename": "django/contrib/humanize/locale/en/LC_MESSAGES/django.po",
            "status": "modified",
            "additions": 64,
            "deletions": 31,
            "changes": 95,
            "blob_url": "https://github.com/django/django/blob/578a31fea3cb439f6bfeeb7825ac835820a9f58c/django%2Fcontrib%2Fhumanize%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/578a31fea3cb439f6bfeeb7825ac835820a9f58c/django%2Fcontrib%2Fhumanize%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po?ref=578a31fea3cb439f6bfeeb7825ac835820a9f58c",
            "patch": "@@ -4,141 +4,174 @@ msgid \"\"\n msgstr \"\"\n \"Project-Id-Version: Django\\n\"\n \"Report-Msgid-Bugs-To: \\n\"\n-\"POT-Creation-Date: 2011-05-07 21:53+0200\\n\"\n+\"POT-Creation-Date: 2011-05-16 17:30+0200\\n\"\n \"PO-Revision-Date: 2010-05-13 15:35+0200\\n\"\n \"Last-Translator: Django team\\n\"\n \"Language-Team: English <en@li.org>\\n\"\n \"MIME-Version: 1.0\\n\"\n \"Content-Type: text/plain; charset=UTF-8\\n\"\n \"Content-Transfer-Encoding: 8bit\\n\"\n \n-#: templatetags/humanize.py:21\n+#: templatetags/humanize.py:25\n msgid \"th\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:21\n+#: templatetags/humanize.py:25\n msgid \"st\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:21\n+#: templatetags/humanize.py:25\n msgid \"nd\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:21\n+#: templatetags/humanize.py:25\n msgid \"rd\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:74\n+#: templatetags/humanize.py:78\n #, python-format\n msgid \"%(value).1f million\"\n msgid_plural \"%(value).1f million\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:75\n+#: templatetags/humanize.py:79\n #, python-format\n msgid \"%(value)s million\"\n msgid_plural \"%(value)s million\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:80\n+#: templatetags/humanize.py:84\n #, python-format\n msgid \"%(value).1f billion\"\n msgid_plural \"%(value).1f billion\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:81\n+#: templatetags/humanize.py:85\n #, python-format\n msgid \"%(value)s billion\"\n msgid_plural \"%(value)s billion\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:86\n+#: templatetags/humanize.py:90\n #, python-format\n msgid \"%(value).1f trillion\"\n msgid_plural \"%(value).1f trillion\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:87\n+#: templatetags/humanize.py:91\n #, python-format\n msgid \"%(value)s trillion\"\n msgid_plural \"%(value)s trillion\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"one\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"two\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"three\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"four\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"five\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"six\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"seven\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"eight\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:104\n+#: templatetags/humanize.py:108\n msgid \"nine\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:127\n+#: templatetags/humanize.py:131\n msgid \"today\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:129\n+#: templatetags/humanize.py:133\n msgid \"tomorrow\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:131\n+#: templatetags/humanize.py:135\n msgid \"yesterday\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:153\n+#: templatetags/humanize.py:160\n+#, python-format\n+msgctxt \"naturaltime\"\n+msgid \"%(delta)s ago\"\n+msgstr \"\"\n+\n+#: templatetags/humanize.py:163 templatetags/humanize.py:185\n msgid \"now\"\n msgstr \"\"\n \n-#: templatetags/humanize.py:155\n+#: templatetags/humanize.py:166\n #, python-format\n-msgid \"%s seconds ago\"\n-msgid_plural \"%s seconds ago\"\n+msgid \"a second ago\"\n+msgid_plural \"%(count)s seconds ago\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:157\n+#: templatetags/humanize.py:171\n #, python-format\n msgid \"a minute ago\"\n-msgid_plural \"%s minutes ago\"\n+msgid_plural \"%(count)s minutes ago\"\n msgstr[0] \"\"\n msgstr[1] \"\"\n \n-#: templatetags/humanize.py:159\n+#: templatetags/humanize.py:176\n #, python-format\n msgid \"an hour ago\"\n-msgid_plural \"%s hours ago\"\n+msgid_plural \"%(count)s hours ago\"\n+msgstr[0] \"\"\n+msgstr[1] \"\"\n+\n+#: templatetags/humanize.py:182\n+#, python-format\n+msgctxt \"naturaltime\"\n+msgid \"%(delta)s from now\"\n+msgstr \"\"\n+\n+#: templatetags/humanize.py:188\n+#, python-format\n+msgid \"a second from now\"\n+msgid_plural \"%(count)s seconds from now\"\n+msgstr[0] \"\"\n+msgstr[1] \"\"\n+\n+#: templatetags/humanize.py:193\n+#, python-format\n+msgid \"a minute from now\"\n+msgid_plural \"%(count)s minutes from now\"\n+msgstr[0] \"\"\n+msgstr[1] \"\"\n+\n+#: templatetags/humanize.py:198\n+#, python-format\n+msgid \"an hour from now\"\n+msgid_plural \"%(count)s hours from now\"\n msgstr[0] \"\"\n msgstr[1] \"\""
        },
        {
            "sha": "7a4defd39277d5df575de60c392058e4aa68185c",
            "filename": "django/contrib/humanize/templatetags/humanize.py",
            "status": "modified",
            "additions": 62,
            "deletions": 23,
            "changes": 85,
            "blob_url": "https://github.com/django/django/blob/578a31fea3cb439f6bfeeb7825ac835820a9f58c/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "raw_url": "https://github.com/django/django/raw/578a31fea3cb439f6bfeeb7825ac835820a9f58c/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fhumanize%2Ftemplatetags%2Fhumanize.py?ref=578a31fea3cb439f6bfeeb7825ac835820a9f58c",
            "patch": "@@ -1,11 +1,15 @@\n-from django.utils.translation import ungettext, ugettext as _\n-from django.utils.encoding import force_unicode\n-from django.utils.formats import number_format\n+import re\n+from datetime import date, datetime, timedelta\n+\n from django import template\n-from django.template import defaultfilters\n from django.conf import settings\n-from datetime import date, datetime\n-import re\n+from django.template import defaultfilters\n+from django.utils.datetime_safe import datetime, date\n+from django.utils.encoding import force_unicode\n+from django.utils.formats import number_format\n+from django.utils.translation import pgettext, ungettext, ugettext as _\n+from django.utils.tzinfo import LocalTimezone\n+\n \n register = template.Library()\n \n@@ -132,11 +136,10 @@ def naturalday(value, arg=None):\n     return defaultfilters.date(value, arg)\n \n @register.filter\n-def naturaltime(value, arg=None):\n+def naturaltime(value):\n     \"\"\"\n-    For date and time values shows how many seconds, minutes or hours ago compared to\n-    current timestamp returns representing string. Otherwise, returns a string\n-    formatted according to settings.DATE_FORMAT\n+    For date and time values shows how many seconds, minutes or hours ago\n+    compared to current timestamp returns representing string.\n     \"\"\"\n     try:\n         value = datetime(value.year, value.month, value.day, value.hour, value.minute, value.second)\n@@ -145,16 +148,52 @@ def naturaltime(value, arg=None):\n     except ValueError:\n         return value\n \n-    delta = datetime.now() - value\n-    if delta.days != 0:\n-        value = date(value.year, value.month, value.day)\n-        return naturalday(value, arg)\n-    elif delta.seconds == 0:\n-        return _(u'now')\n-    elif delta.seconds < 60:\n-        return ungettext(u'%s seconds ago', u'%s seconds ago', delta.seconds)\n-    elif delta.seconds / 60 < 60:\n-        return ungettext(u'a minute ago', u'%s minutes ago', delta.seconds/60)\n-    elif delta.seconds / 60 / 60 < 24:\n-        return ungettext(u'an hour ago', u'%s hours ago', delta.seconds/60/60)\n-    return naturalday(value, arg)\n+    if getattr(value, 'tzinfo', None):\n+        now = datetime.now(LocalTimezone(value))\n+    else:\n+        now = datetime.now()\n+    now = now - timedelta(0, 0, now.microsecond)\n+    if value < now:\n+        delta = now - value\n+        if delta.days != 0:\n+            return pgettext(\n+                'naturaltime', '%(delta)s ago'\n+            ) % {'delta': defaultfilters.timesince(value)}\n+        elif delta.seconds == 0:\n+            return _(u'now')\n+        elif delta.seconds < 60:\n+            return ungettext(\n+                u'a second ago', u'%(count)s seconds ago', delta.seconds\n+            ) % {'count': delta.seconds}\n+        elif delta.seconds / 60 < 60:\n+            count = delta.seconds / 60\n+            return ungettext(\n+                u'a minute ago', u'%(count)s minutes ago', count\n+            ) % {'count': count}\n+        else:\n+            count = delta.seconds / 60 / 60\n+            return ungettext(\n+                u'an hour ago', u'%(count)s hours ago', count\n+            ) % {'count': count}\n+    else:\n+        delta = value - now\n+        if delta.days != 0:\n+            return pgettext(\n+                'naturaltime', '%(delta)s from now'\n+            ) % {'delta': defaultfilters.timeuntil(value)}\n+        elif delta.seconds == 0:\n+            return _(u'now')\n+        elif delta.seconds < 60:\n+            return ungettext(\n+                u'a second from now', u'%(count)s seconds from now', delta.seconds\n+            ) % {'count': delta.seconds}\n+        elif delta.seconds / 60 < 60:\n+            count = delta.seconds / 60\n+            return ungettext(\n+                u'a minute from now', u'%(count)s minutes from now', count\n+            ) % {'count': count}\n+        else:\n+            count = delta.seconds / 60 / 60\n+            return ungettext(\n+                u'an hour from now', u'%(count)s hours from now', count\n+            ) % {'count': count}"
        },
        {
            "sha": "2f544c7ef766f50228a2c6aed4b7c03d4b3e15df",
            "filename": "docs/ref/contrib/humanize.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/578a31fea3cb439f6bfeeb7825ac835820a9f58c/docs%2Fref%2Fcontrib%2Fhumanize.txt",
            "raw_url": "https://github.com/django/django/raw/578a31fea3cb439f6bfeeb7825ac835820a9f58c/docs%2Fref%2Fcontrib%2Fhumanize.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fhumanize.txt?ref=578a31fea3cb439f6bfeeb7825ac835820a9f58c",
            "patch": "@@ -104,9 +104,8 @@ naturaltime\n \n For datetime values, returns a string representing how many seconds,\n minutes or hours ago it was -- falling back to a longer date format if the\n-value is more than a day old.\n-\n-**Argument:** Date formatting string as described in the :tfilter:`date` tag.\n+value is more than a day old. In case the datetime value is in the future\n+the return value will automatically use an appropriate phrase.\n \n Examples (when 'now' is 17 Feb 2007 16:30:00):\n \n@@ -116,9 +115,13 @@ Examples (when 'now' is 17 Feb 2007 16:30:00):\n     * ``17 Feb 2007 16:25:35`` becomes ``4 minutes ago``.\n     * ``17 Feb 2007 15:30:29`` becomes ``an hour ago``.\n     * ``17 Feb 2007 13:31:29`` becomes ``2 hours ago``.\n-    * ``16 Feb 2007 13:31:29`` becomes ``yesterday``.\n-    * Any other day is formatted according to given argument or the\n-      :setting:`DATE_FORMAT` setting if no argument is given.\n+    * ``16 Feb 2007 13:31:29`` becomes ``1 day ago``.\n+    * ``17 Feb 2007 16:30:30`` becomes ``29 seconds from now``.\n+    * ``17 Feb 2007 16:31:00`` becomes ``a minute from now``.\n+    * ``17 Feb 2007 16:34:35`` becomes ``4 minutes from now``.\n+    * ``17 Feb 2007 16:30:29`` becomes ``an hour from now``.\n+    * ``17 Feb 2007 18:31:29`` becomes ``2 hours from now``.\n+    * ``18 Feb 2007 16:31:29`` becomes ``1 day from now``.\n \n .. templatefilter:: ordinal\n "
        },
        {
            "sha": "370575a84a4fd84cd17766b3d0d0cd1c1be71679",
            "filename": "tests/regressiontests/humanize/tests.py",
            "status": "modified",
            "additions": 42,
            "deletions": 25,
            "changes": 67,
            "blob_url": "https://github.com/django/django/blob/578a31fea3cb439f6bfeeb7825ac835820a9f58c/tests%2Fregressiontests%2Fhumanize%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/578a31fea3cb439f6bfeeb7825ac835820a9f58c/tests%2Fregressiontests%2Fhumanize%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhumanize%2Ftests.py?ref=578a31fea3cb439f6bfeeb7825ac835820a9f58c",
            "patch": "@@ -89,31 +89,6 @@ def test_naturalday(self):\n                        someday_result, u\"I'm not a date value\", None)\n         self.humanize_tester(test_list, result_list, 'naturalday')\n \n-    def test_naturaltime(self):\n-        from django.template import defaultfilters\n-        now = datetime.now()\n-        seconds_ago = now - timedelta(seconds=30)\n-        a_minute_ago = now - timedelta(minutes=1, seconds=30)\n-        minutes_ago = now - timedelta(minutes=2)\n-        an_hour_ago = now - timedelta(hours=1, minutes=30, seconds=30)\n-        hours_ago = now - timedelta(hours=23, minutes=50, seconds=50)\n-\n-        test_list = (now, a_minute_ago, an_hour_ago)\n-        result_list = (_(u'now'), _(u'a minute ago'), _(u'an hour ago'))\n-        self.humanize_tester(test_list, result_list, 'naturaltime')\n-\n-        t = Template('{{ seconds_ago|%s }}' % 'naturaltime')\n-        rendered = t.render(Context(locals())).strip()\n-        self.assertTrue(u' seconds ago' in rendered)\n-\n-        t = Template('{{ minutes_ago|%s }}' % 'naturaltime')\n-        rendered = t.render(Context(locals())).strip()\n-        self.assertTrue(u' minutes ago' in rendered)\n-\n-        t = Template('{{ hours_ago|%s }}' % 'naturaltime')\n-        rendered = t.render(Context(locals())).strip()\n-        self.assertTrue(u' hours ago' in rendered)\n-\n     def test_naturalday_tz(self):\n         from django.contrib.humanize.templatetags.humanize import naturalday\n \n@@ -130,3 +105,45 @@ def test_naturalday_tz(self):\n \n         # As 24h of difference they will never be the same\n         self.assertNotEqual(naturalday_one, naturalday_two)\n+\n+    def test_naturaltime(self):\n+        now = datetime.now()\n+        test_list = [\n+            now,\n+            now - timedelta(seconds=1),\n+            now - timedelta(seconds=30),\n+            now - timedelta(minutes=1, seconds=30),\n+            now - timedelta(minutes=2),\n+            now - timedelta(hours=1, minutes=30, seconds=30),\n+            now - timedelta(hours=23, minutes=50, seconds=50),\n+            now - timedelta(days=1),\n+            now - timedelta(days=500),\n+            now + timedelta(seconds=1),\n+            now + timedelta(seconds=30),\n+            now + timedelta(minutes=1, seconds=30),\n+            now + timedelta(minutes=2),\n+            now + timedelta(hours=1, minutes=30, seconds=30),\n+            now + timedelta(hours=23, minutes=50, seconds=50),\n+            now + timedelta(days=1),\n+            now + timedelta(days=500),\n+        ]\n+        result_list = [\n+            'now',\n+            'a second ago',\n+            '30 seconds ago',\n+            'a minute ago',\n+            '2 minutes ago',\n+            'an hour ago',\n+            '23 hours ago',\n+            '1 day ago',\n+            '1 year, 4 months ago',\n+            'a second from now',\n+            '30 seconds from now',\n+            'a minute from now',\n+            '2 minutes from now',\n+            'an hour from now',\n+            '23 hours from now',\n+            '1 day from now',\n+            '1 year, 4 months from now',\n+        ]\n+        self.humanize_tester(test_list, result_list, 'naturaltime')"
        }
    ],
    "stats": {
        "total": 262,
        "additions": 177,
        "deletions": 85
    }
}