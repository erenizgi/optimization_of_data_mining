{
    "author": "freakboy3742",
    "message": "Fixed #15499 -- Ensure that cache control headers don't try to set public and private as a result of multiple calls to patch_cache_control with different arguments. Thanks to AndiDog for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16657 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6cd90236350b6531122ddbb5a99874add09f3f15",
    "files": [
        {
            "sha": "45d8a95f664713e31bd76a9bda85a6bc2ff36aeb",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6cd90236350b6531122ddbb5a99874add09f3f15/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/6cd90236350b6531122ddbb5a99874add09f3f15/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=6cd90236350b6531122ddbb5a99874add09f3f15",
            "patch": "@@ -66,6 +66,12 @@ def dictvalue(t):\n     if 'max-age' in cc and 'max_age' in kwargs:\n         kwargs['max_age'] = min(cc['max-age'], kwargs['max_age'])\n \n+    # Allow overriding private caching and vice versa\n+    if 'private' in cc and 'public' in kwargs:\n+        del cc['private']\n+    elif 'public' in cc and 'private' in kwargs:\n+        del cc['public']\n+\n     for (k, v) in kwargs.items():\n         cc[k.replace('_', '-')] = v\n     cc = ', '.join([dictvalue(el) for el in cc.items()])"
        },
        {
            "sha": "10b63b7b04f76997e87cd49a95cdb06d1e7a0a8e",
            "filename": "docs/topics/cache.txt",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/6cd90236350b6531122ddbb5a99874add09f3f15/docs%2Ftopics%2Fcache.txt",
            "raw_url": "https://github.com/django/django/raw/6cd90236350b6531122ddbb5a99874add09f3f15/docs%2Ftopics%2Fcache.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fcache.txt?ref=6cd90236350b6531122ddbb5a99874add09f3f15",
            "patch": "@@ -1059,6 +1059,28 @@ Django, use the ``cache_control`` view decorator. Example::\n This decorator takes care of sending out the appropriate HTTP header behind the\n scenes.\n \n+Note that the cache control settings \"private\" and \"public\" are mutually\n+exclusive. The decorator ensures that the \"public\" directive is removed if\n+\"private\" should be set (and vice versa). An example use of the two directives\n+would be a blog site that offers both private and public entries. Public\n+entries may be cached on any shared cache. The following code uses\n+``patch_cache_control``, the manual way to modify the cache control header\n+(it is internally called by the ``cache_control`` decorator)::\n+\n+    from django.views.decorators.cache import patch_cache_control\n+    from django.views.decorators.vary import vary_on_cookie\n+\n+    @vary_on_cookie\n+    def list_blog_entries_view(request):\n+        if request.user.is_anonymous():\n+            response = render_only_public_entries()\n+            patch_cache_control(response, public=True)\n+        else:\n+            response = render_private_and_public_entries(request.user)\n+            patch_cache_control(response, private=True)\n+\n+        return response\n+\n There are a few other ways to control cache parameters. For example, HTTP\n allows applications to do the following:\n "
        },
        {
            "sha": "fad60570c9d880b6eb13a9a99a6e92a4d323c7a4",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 27,
            "deletions": 1,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/6cd90236350b6531122ddbb5a99874add09f3f15/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6cd90236350b6531122ddbb5a99874add09f3f15/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=6cd90236350b6531122ddbb5a99874add09f3f15",
            "patch": "@@ -5,6 +5,7 @@\n \n import hashlib\n import os\n+import re\n import tempfile\n import time\n import warnings\n@@ -19,7 +20,7 @@\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import translation\n from django.utils import unittest\n-from django.utils.cache import patch_vary_headers, get_cache_key, learn_cache_key\n+from django.utils.cache import patch_vary_headers, get_cache_key, learn_cache_key, patch_cache_control\n from django.views.decorators.cache import cache_page\n \n from regressiontests.cache.models import Poll, expensive_calculation\n@@ -1003,6 +1004,31 @@ def test_learn_cache_key(self):\n         learn_cache_key(request, response)\n         self.assertEqual(get_cache_key(request), 'views.decorators.cache.cache_page.settingsprefix.HEAD.a8c87a3d8c44853d7f79474f7ffe4ad5.d41d8cd98f00b204e9800998ecf8427e')\n \n+    def test_patch_cache_control(self):\n+        tests = (\n+            # Initial Cache-Control, kwargs to patch_cache_control, expected Cache-Control parts\n+            (None, {'private' : True}, set(['private'])),\n+\n+            # Test whether private/public attributes are mutually exclusive\n+            ('private', {'private' : True}, set(['private'])),\n+            ('private', {'public' : True}, set(['public'])),\n+            ('public', {'public' : True}, set(['public'])),\n+            ('public', {'private' : True}, set(['private'])),\n+            ('must-revalidate,max-age=60,private', {'public' : True}, set(['must-revalidate', 'max-age=60', 'public'])),\n+            ('must-revalidate,max-age=60,public', {'private' : True}, set(['must-revalidate', 'max-age=60', 'private'])),\n+            ('must-revalidate,max-age=60', {'public' : True}, set(['must-revalidate', 'max-age=60', 'public'])),\n+        )\n+\n+        cc_delim_re = re.compile(r'\\s*,\\s*')\n+\n+        for initial_cc, newheaders, expected_cc in tests:\n+            response = HttpResponse()\n+            if initial_cc is not None:\n+                response['Cache-Control'] = initial_cc\n+            patch_cache_control(response, **newheaders)\n+            parts = set(cc_delim_re.split(response['Cache-Control']))\n+            self.assertEqual(parts, expected_cc)\n+\n class PrefixedCacheUtils(CacheUtils):\n     def setUp(self):\n         super(PrefixedCacheUtils, self).setUp()"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 55,
        "deletions": 1
    }
}