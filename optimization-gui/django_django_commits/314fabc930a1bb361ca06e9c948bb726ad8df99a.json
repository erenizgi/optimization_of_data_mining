{
    "author": "freakboy3742",
    "message": "Fixed #14908 -- Added a 'takes_context' argument to simple_tag. Thanks to Julien Phalip for driving the issue and providing the final patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14987 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "314fabc930a1bb361ca06e9c948bb726ad8df99a",
    "files": [
        {
            "sha": "2a1d8be1cebb9c89121236d9403991fdb53d134b",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 31,
            "deletions": 12,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/314fabc930a1bb361ca06e9c948bb726ad8df99a/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/314fabc930a1bb361ca06e9c948bb726ad8df99a/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=314fabc930a1bb361ca06e9c948bb726ad8df99a",
            "patch": "@@ -872,21 +872,40 @@ def filter_function(self, func):\n         self.filters[getattr(func, \"_decorated_function\", func).__name__] = func\n         return func\n \n-    def simple_tag(self,func):\n-        params, xx, xxx, defaults = getargspec(func)\n+    def simple_tag(self, func=None, takes_context=None):\n+        def dec(func):\n+            params, xx, xxx, defaults = getargspec(func)\n+            if takes_context:\n+                if params[0] == 'context':\n+                    params = params[1:]\n+                else:\n+                    raise TemplateSyntaxError(\"Any tag function decorated with takes_context=True must have a first argument of 'context'\")\n \n-        class SimpleNode(Node):\n-            def __init__(self, vars_to_resolve):\n-                self.vars_to_resolve = map(Variable, vars_to_resolve)\n+            class SimpleNode(Node):\n+                def __init__(self, vars_to_resolve):\n+                    self.vars_to_resolve = map(Variable, vars_to_resolve)\n \n-            def render(self, context):\n-                resolved_vars = [var.resolve(context) for var in self.vars_to_resolve]\n-                return func(*resolved_vars)\n+                def render(self, context):\n+                    resolved_vars = [var.resolve(context) for var in self.vars_to_resolve]\n+                    if takes_context:\n+                        func_args = [context] + resolved_vars\n+                    else:\n+                        func_args = resolved_vars\n+                    return func(*func_args)\n \n-        compile_func = curry(generic_tag_compiler, params, defaults, getattr(func, \"_decorated_function\", func).__name__, SimpleNode)\n-        compile_func.__doc__ = func.__doc__\n-        self.tag(getattr(func, \"_decorated_function\", func).__name__, compile_func)\n-        return func\n+            compile_func = curry(generic_tag_compiler, params, defaults, getattr(func, \"_decorated_function\", func).__name__, SimpleNode)\n+            compile_func.__doc__ = func.__doc__\n+            self.tag(getattr(func, \"_decorated_function\", func).__name__, compile_func)\n+            return func\n+\n+        if func is None:\n+            # @register.simple_tag(...)\n+            return dec\n+        elif callable(func):\n+            # @register.simple_tag\n+            return dec(func)\n+        else:\n+            raise TemplateSyntaxError(\"Invalid arguments provided to simple_tag\")\n \n     def inclusion_tag(self, file_name, context_class=Context, takes_context=False):\n         def dec(func):"
        },
        {
            "sha": "246bb67af0d477aea28839176af8af9094922c38",
            "filename": "docs/howto/custom-template-tags.txt",
            "status": "modified",
            "additions": 21,
            "deletions": 3,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/314fabc930a1bb361ca06e9c948bb726ad8df99a/docs%2Fhowto%2Fcustom-template-tags.txt",
            "raw_url": "https://github.com/django/django/raw/314fabc930a1bb361ca06e9c948bb726ad8df99a/docs%2Fhowto%2Fcustom-template-tags.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fcustom-template-tags.txt?ref=314fabc930a1bb361ca06e9c948bb726ad8df99a",
            "patch": "@@ -669,9 +669,27 @@ A couple of things to note about the ``simple_tag`` helper function:\n     * If the argument was a template variable, our function is passed the\n       current value of the variable, not the variable itself.\n \n-When your template tag does not need access to the current context, writing a\n-function to work with the input values and using the ``simple_tag`` helper is\n-the easiest way to create a new tag.\n+.. versionadded:: 1.3\n+\n+If your template tag needs to access the current context, you can use the\n+``takes_context`` argument when registering your tag::\n+\n+    # The first argument *must* be called \"context\" here.\n+    def current_time(context, format_string):\n+        timezone = context['timezone']\n+        return your_get_current_time_method(timezone)\n+\n+    register.simple_tag(takes_context=True)(current_time)\n+\n+Or, using decorator syntax::\n+\n+    @register.simple_tag(takes_context=True)\n+    def current_time(context, format_string):\n+        timezone = context['timezone']\n+        return your_get_current_time_method(timezone)\n+\n+For more information on how the ``takes_context`` option works, see the section\n+on `inclusion tags`_.\n \n .. _howto-custom-template-tags-inclusion-tags:\n "
        },
        {
            "sha": "06c39c756e3abdf2532bb35545788c9c27e32724",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/314fabc930a1bb361ca06e9c948bb726ad8df99a/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/314fabc930a1bb361ca06e9c948bb726ad8df99a/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=314fabc930a1bb361ca06e9c948bb726ad8df99a",
            "patch": "@@ -184,12 +184,16 @@ requests. These include:\n \n     * Support for _HTTPOnly cookies.\n \n-    * mail_admins() and mail_managers() now support easily attaching\n-      HTML content to messages.\n+    * :meth:`mail_admins()` and :meth:`mail_managers()` now support\n+      easily attaching HTML content to messages.\n \n     * Error emails now include more of the detail and formatting of\n       the debug server error page.\n \n+    * :meth:`simple_tag` now accepts a :attr:`takes_context` argument,\n+      making it easier to write simple template tags that require\n+      access to template context.\n+\n .. _HTTPOnly: http://www.owasp.org/index.php/HTTPOnly\n \n .. _backwards-incompatible-changes-1.3:"
        },
        {
            "sha": "a517bd1810de933cca87ef5e565798642e895596",
            "filename": "tests/regressiontests/templates/custom.py",
            "status": "modified",
            "additions": 45,
            "deletions": 2,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/314fabc930a1bb361ca06e9c948bb726ad8df99a/tests%2Fregressiontests%2Ftemplates%2Fcustom.py",
            "raw_url": "https://github.com/django/django/raw/314fabc930a1bb361ca06e9c948bb726ad8df99a/tests%2Fregressiontests%2Ftemplates%2Fcustom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fcustom.py?ref=314fabc930a1bb361ca06e9c948bb726ad8df99a",
            "patch": "@@ -1,11 +1,54 @@\n from django import template\n from django.utils.unittest import TestCase\n+from templatetags import custom\n \n-\n-class CustomTests(TestCase):\n+class CustomFilterTests(TestCase):\n     def test_filter(self):\n         t = template.Template(\"{% load custom %}{{ string|trim:5 }}\")\n         self.assertEqual(\n             t.render(template.Context({\"string\": \"abcdefghijklmnopqrstuvwxyz\"})),\n             u\"abcde\"\n         )\n+\n+\n+class CustomTagTests(TestCase):\n+    def verify_tag(self, tag, name):\n+        self.assertEquals(tag.__name__, name)\n+        self.assertEquals(tag.__doc__, 'Expected %s __doc__' % name)\n+        self.assertEquals(tag.__dict__['anything'], 'Expected %s __dict__' % name)\n+\n+    def test_simple_tags(self):\n+        c = template.Context({'value': 42})\n+\n+        t = template.Template('{% load custom %}{% no_params %}')\n+        self.assertEquals(t.render(c), u'no_params - Expected result')\n+\n+        t = template.Template('{% load custom %}{% one_param 37 %}')\n+        self.assertEquals(t.render(c), u'one_param - Expected result: 37')\n+\n+        t = template.Template('{% load custom %}{% explicit_no_context 37 %}')\n+        self.assertEquals(t.render(c), u'explicit_no_context - Expected result: 37')\n+\n+        t = template.Template('{% load custom %}{% no_params_with_context %}')\n+        self.assertEquals(t.render(c), u'no_params_with_context - Expected result (context value: 42)')\n+\n+        t = template.Template('{% load custom %}{% params_and_context 37 %}')\n+        self.assertEquals(t.render(c), u'params_and_context - Expected result (context value: 42): 37')\n+\n+    def test_simple_tag_registration(self):\n+        # Test that the decorators preserve the decorated function's docstring, name and attributes.\n+        self.verify_tag(custom.no_params, 'no_params')\n+        self.verify_tag(custom.one_param, 'one_param')\n+        self.verify_tag(custom.explicit_no_context, 'explicit_no_context')\n+        self.verify_tag(custom.no_params_with_context, 'no_params_with_context')\n+        self.verify_tag(custom.params_and_context, 'params_and_context')\n+\n+    def test_simple_tag_missing_context(self):\n+        # That the 'context' parameter must be present when takes_context is True\n+        def a_simple_tag_without_parameters(arg):\n+            \"\"\"Expected __doc__\"\"\"\n+            return \"Expected result\"\n+\n+        register = template.Library()\n+        decorator = register.simple_tag(takes_context=True)\n+        self.assertRaises(template.TemplateSyntaxError, decorator, a_simple_tag_without_parameters)"
        },
        {
            "sha": "701131626be4d176fce3d347f1618037dfc08472",
            "filename": "tests/regressiontests/templates/templatetags/custom.py",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/314fabc930a1bb361ca06e9c948bb726ad8df99a/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "raw_url": "https://github.com/django/django/raw/314fabc930a1bb361ca06e9c948bb726ad8df99a/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py?ref=314fabc930a1bb361ca06e9c948bb726ad8df99a",
            "patch": "@@ -9,3 +9,33 @@ def trim(value, num):\n \n register.filter(trim)\n \n+@register.simple_tag\n+def no_params():\n+    \"\"\"Expected no_params __doc__\"\"\"\n+    return \"no_params - Expected result\"\n+no_params.anything = \"Expected no_params __dict__\"\n+\n+@register.simple_tag\n+def one_param(arg):\n+    \"\"\"Expected one_param __doc__\"\"\"\n+    return \"one_param - Expected result: %s\" % arg\n+one_param.anything = \"Expected one_param __dict__\"\n+\n+@register.simple_tag(takes_context=False)\n+def explicit_no_context(arg):\n+    \"\"\"Expected explicit_no_context __doc__\"\"\"\n+    return \"explicit_no_context - Expected result: %s\" % arg\n+explicit_no_context.anything = \"Expected explicit_no_context __dict__\"\n+\n+@register.simple_tag(takes_context=True)\n+def no_params_with_context(context):\n+    \"\"\"Expected no_params_with_context __doc__\"\"\"\n+    return \"no_params_with_context - Expected result (context value: %s)\" % context['value']\n+no_params_with_context.anything = \"Expected no_params_with_context __dict__\"\n+\n+@register.simple_tag(takes_context=True)\n+def params_and_context(context, arg):\n+    \"\"\"Expected params_and_context __doc__\"\"\"\n+    return \"params_and_context - Expected result (context value: %s): %s\" % (context['value'], arg)\n+params_and_context.anything = \"Expected params_and_context __dict__\"\n+"
        },
        {
            "sha": "8f31bd4ad60fd1e89507e67aefc1c01f724a115c",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/314fabc930a1bb361ca06e9c948bb726ad8df99a/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/314fabc930a1bb361ca06e9c948bb726ad8df99a/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=314fabc930a1bb361ca06e9c948bb726ad8df99a",
            "patch": "@@ -23,7 +23,7 @@\n from django.utils.tzinfo import LocalTimezone\n \n from context import ContextTests\n-from custom import CustomTests\n+from custom import CustomTagTests, CustomFilterTests\n from parser import ParserTests\n from unicode import UnicodeTests\n from nodelist import NodelistTest"
        }
    ],
    "stats": {
        "total": 154,
        "additions": 134,
        "deletions": 20
    }
}