{
    "author": "spookylukey",
    "message": "Fixed #17668 - prefetch_related does not work in in_bulk\n\nThanks to gurets for the report, and akaariai for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17600 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "de9942a6673cfbe442abdfabc1e8f7c0a652ef5b",
    "files": [
        {
            "sha": "08fda7833201ccac4bba8b3346969291cc3636d8",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/de9942a6673cfbe442abdfabc1e8f7c0a652ef5b/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/de9942a6673cfbe442abdfabc1e8f7c0a652ef5b/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=de9942a6673cfbe442abdfabc1e8f7c0a652ef5b",
            "patch": "@@ -485,7 +485,7 @@ def in_bulk(self, id_list):\n         qs = self._clone()\n         qs.query.add_filter(('pk__in', id_list))\n         qs.query.clear_ordering(force_empty=True)\n-        return dict([(obj._get_pk_val(), obj) for obj in qs.iterator()])\n+        return dict([(obj._get_pk_val(), obj) for obj in qs])\n \n     def delete(self):\n         \"\"\""
        },
        {
            "sha": "13504f41cf0f0df1077251d760e6223da8887d0a",
            "filename": "docs/ref/models/querysets.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/de9942a6673cfbe442abdfabc1e8f7c0a652ef5b/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/de9942a6673cfbe442abdfabc1e8f7c0a652ef5b/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Fquerysets.txt?ref=de9942a6673cfbe442abdfabc1e8f7c0a652ef5b",
            "patch": "@@ -871,6 +871,9 @@ could be generated, which, depending on the database, might have performance\n problems of its own when it comes to parsing or executing the SQL query. Always\n profile for your use case!\n \n+Note that if you use ``iterator()`` to run the query, ``prefetch_related()``\n+calls will be ignored since these two optimizations do not make sense together.\n+\n extra\n ~~~~~\n \n@@ -1430,6 +1433,9 @@ performance and a significant reduction in memory.\n Note that using ``iterator()`` on a ``QuerySet`` which has already been\n evaluated will force it to evaluate again, repeating the query.\n \n+Also, use of ``iterator()`` causes previous ``prefetch_related()`` calls to be\n+ignored since these two optimizations do not make sense together.\n+\n latest\n ~~~~~~\n "
        },
        {
            "sha": "382aed68b4514bc95b1a6d782f31aac5f76b6ddb",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/de9942a6673cfbe442abdfabc1e8f7c0a652ef5b/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/de9942a6673cfbe442abdfabc1e8f7c0a652ef5b/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=de9942a6673cfbe442abdfabc1e8f7c0a652ef5b",
            "patch": "@@ -470,3 +470,16 @@ def test_prefetch_nullable(self):\n                         for e in qs2]\n \n         self.assertEqual(co_serfs, co_serfs2)\n+\n+    def test_in_bulk(self):\n+        \"\"\"\n+        In-bulk does correctly prefetch objects by not using .iterator()\n+        directly.\n+        \"\"\"\n+        boss1 = Employee.objects.create(name=\"Peter\")\n+        boss2 = Employee.objects.create(name=\"Jack\")\n+        with self.assertNumQueries(2):\n+            # Check that prefetch is done and it does not cause any errors.\n+            bulk = Employee.objects.prefetch_related('serfs').in_bulk([boss1.pk, boss2.pk])\n+            for b in bulk.values():\n+                list(b.serfs.all())"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 20,
        "deletions": 1
    }
}