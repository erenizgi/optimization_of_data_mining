{
    "author": "freakboy3742",
    "message": "Fixed #19060 -- Corrected assumptions about the name of the User model in the ModelBackend.\n\nThanks to Ivan Virabyan for the report and initial patch.",
    "sha": "b9039268a17b06e7fe069721e99f6d69181c344d",
    "files": [
        {
            "sha": "00cb67a0b5adcc4f3770b2636921716d3b3df646",
            "filename": "django/contrib/auth/backends.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/b9039268a17b06e7fe069721e99f6d69181c344d/django%2Fcontrib%2Fauth%2Fbackends.py",
            "raw_url": "https://github.com/django/django/raw/b9039268a17b06e7fe069721e99f6d69181c344d/django%2Fcontrib%2Fauth%2Fbackends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fbackends.py?ref=b9039268a17b06e7fe069721e99f6d69181c344d",
            "patch": "@@ -30,7 +30,9 @@ def get_group_permissions(self, user_obj, obj=None):\n             if user_obj.is_superuser:\n                 perms = Permission.objects.all()\n             else:\n-                perms = Permission.objects.filter(group__user=user_obj)\n+                user_groups_field = get_user_model()._meta.get_field('groups')\n+                user_groups_query = 'group__%s' % user_groups_field.related_query_name()\n+                perms = Permission.objects.filter(**{user_groups_query: user_obj})\n             perms = perms.values_list('content_type__app_label', 'codename').order_by()\n             user_obj._group_perm_cache = set([\"%s.%s\" % (ct, name) for ct, name in perms])\n         return user_obj._group_perm_cache"
        },
        {
            "sha": "e92f159ff91070eac9b273b1b7003e52d2076d2d",
            "filename": "django/contrib/auth/tests/auth_backends.py",
            "status": "modified",
            "additions": 78,
            "deletions": 18,
            "changes": 96,
            "blob_url": "https://github.com/django/django/blob/b9039268a17b06e7fe069721e99f6d69181c344d/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "raw_url": "https://github.com/django/django/raw/b9039268a17b06e7fe069721e99f6d69181c344d/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py?ref=b9039268a17b06e7fe069721e99f6d69181c344d",
            "patch": "@@ -1,24 +1,29 @@\n from __future__ import unicode_literals\n+from datetime import date\n \n from django.conf import settings\n from django.contrib.auth.models import User, Group, Permission, AnonymousUser\n from django.contrib.auth.tests.utils import skipIfCustomUser\n+from django.contrib.auth.tests.custom_user import ExtensionUser\n from django.contrib.contenttypes.models import ContentType\n from django.core.exceptions import ImproperlyConfigured\n from django.test import TestCase\n from django.test.utils import override_settings\n \n \n-@skipIfCustomUser\n-class BackendTest(TestCase):\n-\n+class BaseModelBackendTest(object):\n+    \"\"\"\n+    A base class for tests that need to validate the ModelBackend\n+    with different User models. Subclasses should define a class\n+    level UserModel attribute, and a create_users() method to\n+    construct two users for test purposes.\n+    \"\"\"\n     backend = 'django.contrib.auth.backends.ModelBackend'\n \n     def setUp(self):\n         self.curr_auth = settings.AUTHENTICATION_BACKENDS\n         settings.AUTHENTICATION_BACKENDS = (self.backend,)\n-        User.objects.create_user('test', 'test@example.com', 'test')\n-        User.objects.create_superuser('test2', 'test2@example.com', 'test')\n+        self.create_users()\n \n     def tearDown(self):\n         settings.AUTHENTICATION_BACKENDS = self.curr_auth\n@@ -28,7 +33,7 @@ def tearDown(self):\n         ContentType.objects.clear_cache()\n \n     def test_has_perm(self):\n-        user = User.objects.get(username='test')\n+        user = self.UserModel.objects.get(username='test')\n         self.assertEqual(user.has_perm('auth.test'), False)\n         user.is_staff = True\n         user.save()\n@@ -47,14 +52,14 @@ def test_has_perm(self):\n         self.assertEqual(user.has_perm('auth.test'), False)\n \n     def test_custom_perms(self):\n-        user = User.objects.get(username='test')\n-        content_type=ContentType.objects.get_for_model(Group)\n+        user = self.UserModel.objects.get(username='test')\n+        content_type = ContentType.objects.get_for_model(Group)\n         perm = Permission.objects.create(name='test', content_type=content_type, codename='test')\n         user.user_permissions.add(perm)\n         user.save()\n \n         # reloading user to purge the _perm_cache\n-        user = User.objects.get(username='test')\n+        user = self.UserModel.objects.get(username='test')\n         self.assertEqual(user.get_all_permissions() == set(['auth.test']), True)\n         self.assertEqual(user.get_group_permissions(), set([]))\n         self.assertEqual(user.has_module_perms('Group'), False)\n@@ -65,7 +70,7 @@ def test_custom_perms(self):\n         perm = Permission.objects.create(name='test3', content_type=content_type, codename='test3')\n         user.user_permissions.add(perm)\n         user.save()\n-        user = User.objects.get(username='test')\n+        user = self.UserModel.objects.get(username='test')\n         self.assertEqual(user.get_all_permissions(), set(['auth.test2', 'auth.test', 'auth.test3']))\n         self.assertEqual(user.has_perm('test'), False)\n         self.assertEqual(user.has_perm('auth.test'), True)\n@@ -75,7 +80,7 @@ def test_custom_perms(self):\n         group.permissions.add(perm)\n         group.save()\n         user.groups.add(group)\n-        user = User.objects.get(username='test')\n+        user = self.UserModel.objects.get(username='test')\n         exp = set(['auth.test2', 'auth.test', 'auth.test3', 'auth.test_group'])\n         self.assertEqual(user.get_all_permissions(), exp)\n         self.assertEqual(user.get_group_permissions(), set(['auth.test_group']))\n@@ -87,8 +92,8 @@ def test_custom_perms(self):\n \n     def test_has_no_object_perm(self):\n         \"\"\"Regressiontest for #12462\"\"\"\n-        user = User.objects.get(username='test')\n-        content_type=ContentType.objects.get_for_model(Group)\n+        user = self.UserModel.objects.get(username='test')\n+        content_type = ContentType.objects.get_for_model(Group)\n         perm = Permission.objects.create(name='test', content_type=content_type, codename='test')\n         user.user_permissions.add(perm)\n         user.save()\n@@ -100,17 +105,73 @@ def test_has_no_object_perm(self):\n \n     def test_get_all_superuser_permissions(self):\n         \"A superuser has all permissions. Refs #14795\"\n-        user = User.objects.get(username='test2')\n+        user = self.UserModel.objects.get(username='test2')\n         self.assertEqual(len(user.get_all_permissions()), len(Permission.objects.all()))\n \n+\n+@skipIfCustomUser\n+class ModelBackendTest(BaseModelBackendTest, TestCase):\n+    \"\"\"\n+    Tests for the ModelBackend using the default User model.\n+    \"\"\"\n+    UserModel = User\n+\n+    def create_users(self):\n+        User.objects.create_user(\n+            username='test',\n+            email='test@example.com',\n+            password='test',\n+        )\n+        User.objects.create_superuser(\n+            username='test2',\n+            email='test2@example.com',\n+            password='test',\n+        )\n+\n+\n+@override_settings(AUTH_USER_MODEL='auth.ExtensionUser')\n+class ExtensionUserModelBackendTest(BaseModelBackendTest, TestCase):\n+    \"\"\"\n+    Tests for the ModelBackend using the custom ExtensionUser model.\n+\n+    This isn't a perfect test, because both the User and ExtensionUser are\n+    synchronized to the database, which wouldn't ordinary happen in\n+    production. As a result, it doesn't catch errors caused by the non-\n+    existence of the User table.\n+\n+    The specific problem is queries on .filter(groups__user) et al, which\n+    makes an implicit assumption that the user model is called 'User'. In\n+    production, the auth.User table won't exist, so the requested join\n+    won't exist either; in testing, the auth.User *does* exist, and\n+    so does the join. However, the join table won't contain any useful\n+    data; for testing, we check that the data we expect actually does exist.\n+    \"\"\"\n+\n+    UserModel = ExtensionUser\n+\n+    def create_users(self):\n+        ExtensionUser.objects.create_user(\n+            username='test',\n+            email='test@example.com',\n+            password='test',\n+            date_of_birth=date(2006, 4, 25)\n+        )\n+        ExtensionUser.objects.create_superuser(\n+            username='test2',\n+            email='test2@example.com',\n+            password='test',\n+            date_of_birth=date(1976, 11, 8)\n+        )\n+\n+\n class TestObj(object):\n     pass\n \n \n class SimpleRowlevelBackend(object):\n     def has_perm(self, user, perm, obj=None):\n         if not obj:\n-            return # We only support row level perms\n+            return  # We only support row level perms\n \n         if isinstance(obj, TestObj):\n             if user.username == 'test2':\n@@ -128,7 +189,7 @@ def has_module_perms(self, user, app_label):\n \n     def get_all_permissions(self, user, obj=None):\n         if not obj:\n-            return [] # We only support row level perms\n+            return []  # We only support row level perms\n \n         if not isinstance(obj, TestObj):\n             return ['none']\n@@ -142,7 +203,7 @@ def get_all_permissions(self, user, obj=None):\n \n     def get_group_permissions(self, user, obj=None):\n         if not obj:\n-            return # We only support row level perms\n+            return  # We only support row level perms\n \n         if not isinstance(obj, TestObj):\n             return ['none']\n@@ -189,7 +250,6 @@ def test_get_all_permissions(self):\n         self.assertEqual(self.user2.get_all_permissions(), set([]))\n \n     def test_get_group_permissions(self):\n-        content_type=ContentType.objects.get_for_model(Group)\n         group = Group.objects.create(name='test_group')\n         self.user3.groups.add(group)\n         self.assertEqual(self.user3.get_group_permissions(TestObj()), set(['group_perm']))"
        },
        {
            "sha": "9bd74c0ac84d700827960258d871279b7186f4cb",
            "filename": "django/contrib/auth/tests/custom_user.py",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/b9039268a17b06e7fe069721e99f6d69181c344d/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "raw_url": "https://github.com/django/django/raw/b9039268a17b06e7fe069721e99f6d69181c344d/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py?ref=b9039268a17b06e7fe069721e99f6d69181c344d",
            "patch": "@@ -1,11 +1,11 @@\n+from django.db import models\n+from django.contrib.auth.models import BaseUserManager, AbstractBaseUser, AbstractUser, UserManager\n+\n+\n # The custom User uses email as the unique identifier, and requires\n # that every user provide a date of birth. This lets us test\n # changes in username datatype, and non-text required fields.\n \n-from django.db import models\n-from django.contrib.auth.models import BaseUserManager, AbstractBaseUser\n-\n-\n class CustomUserManager(BaseUserManager):\n     def create_user(self, email, date_of_birth, password=None):\n         \"\"\"\n@@ -73,3 +73,18 @@ def has_module_perms(self, app_label):\n     @property\n     def is_staff(self):\n         return self.is_admin\n+\n+\n+# The extension user is a simple extension of the built-in user class,\n+# adding a required date_of_birth field. This allows us to check for\n+# any hard references to the name \"User\" in forms/handlers etc.\n+\n+class ExtensionUser(AbstractUser):\n+    date_of_birth = models.DateField()\n+\n+    objects = UserManager()\n+\n+    REQUIRED_FIELDS = AbstractUser.REQUIRED_FIELDS + ['date_of_birth']\n+\n+    class Meta:\n+        app_label = 'auth'"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 100,
        "deletions": 23
    }
}