{
    "author": "claudep",
    "message": "Fixed #18919 -- Stopped dropping Z attribute when transforming geometries\n\nPreviously, the wkb of geometries was dropping the Z attribute.\nThanks luizvital for the report and tests and georger.silva@gmail.com\nfor the tests.",
    "sha": "ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
    "files": [
        {
            "sha": "df396bdbd3a70d2560e62d3b0c98555636e11059",
            "filename": "django/contrib/gis/geos/geometry.py",
            "status": "modified",
            "additions": 18,
            "deletions": 25,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "raw_url": "https://github.com/django/django/raw/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py?ref=ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
            "patch": "@@ -25,7 +25,7 @@\n \n # These functions provide access to a thread-local instance\n # of their corresponding GEOS I/O class.\n-from django.contrib.gis.geos.prototypes.io import wkt_r, wkt_w, wkb_r, wkb_w, ewkb_w, ewkb_w3d\n+from django.contrib.gis.geos.prototypes.io import wkt_r, wkt_w, wkb_r, wkb_w, ewkb_w\n \n # For recognizing geometry input.\n from django.contrib.gis.geometry.regex import hex_regex, wkt_regex, json_regex\n@@ -388,28 +388,24 @@ def wkt(self):\n     def hex(self):\n         \"\"\"\n         Returns the WKB of this Geometry in hexadecimal form.  Please note\n-        that the SRID and Z values are not included in this representation\n-        because it is not a part of the OGC specification (use the `hexewkb`\n-        property instead).\n+        that the SRID is not included in this representation because it is not\n+        a part of the OGC specification (use the `hexewkb` property instead).\n         \"\"\"\n         # A possible faster, all-python, implementation:\n         #  str(self.wkb).encode('hex')\n-        return wkb_w().write_hex(self)\n+        return wkb_w(self.hasz and 3 or 2).write_hex(self)\n \n     @property\n     def hexewkb(self):\n         \"\"\"\n         Returns the EWKB of this Geometry in hexadecimal form.  This is an\n-        extension of the WKB specification that includes SRID and Z values\n-        that are a part of this geometry.\n-        \"\"\"\n-        if self.hasz:\n-            if not GEOS_PREPARE:\n-                # See: http://trac.osgeo.org/geos/ticket/216\n-                raise GEOSException('Upgrade GEOS to 3.1 to get valid 3D HEXEWKB.')\n-            return ewkb_w3d().write_hex(self)\n-        else:\n-            return ewkb_w().write_hex(self)\n+        extension of the WKB specification that includes SRID value that are\n+        a part of this geometry.\n+        \"\"\"\n+        if self.hasz and not GEOS_PREPARE:\n+            # See: http://trac.osgeo.org/geos/ticket/216\n+            raise GEOSException('Upgrade GEOS to 3.1 to get valid 3D HEXEWKB.')\n+        return ewkb_w(self.hasz and 3 or 2).write_hex(self)\n \n     @property\n     def json(self):\n@@ -429,22 +425,19 @@ def wkb(self):\n         as a Python buffer.  SRID and Z values are not included, use the\n         `ewkb` property instead.\n         \"\"\"\n-        return wkb_w().write(self)\n+        return wkb_w(self.hasz and 3 or 2).write(self)\n \n     @property\n     def ewkb(self):\n         \"\"\"\n         Return the EWKB representation of this Geometry as a Python buffer.\n         This is an extension of the WKB specification that includes any SRID\n-        and Z values that are a part of this geometry.\n+        value that are a part of this geometry.\n         \"\"\"\n-        if self.hasz:\n-            if not GEOS_PREPARE:\n-                # See: http://trac.osgeo.org/geos/ticket/216\n-                raise GEOSException('Upgrade GEOS to 3.1 to get valid 3D EWKB.')\n-            return ewkb_w3d().write(self)\n-        else:\n-            return ewkb_w().write(self)\n+        if self.hasz and not GEOS_PREPARE:\n+            # See: http://trac.osgeo.org/geos/ticket/216\n+            raise GEOSException('Upgrade GEOS to 3.1 to get valid 3D EWKB.')\n+        return ewkb_w(self.hasz and 3 or 2).write(self)\n \n     @property\n     def kml(self):\n@@ -516,7 +509,7 @@ def transform(self, ct, clone=False):\n             raise GEOSException(\"GDAL library is not available to transform() geometry.\")\n \n         # Creating an OGR Geometry, which is then transformed.\n-        g = gdal.OGRGeometry(self.wkb, srid)\n+        g = self.ogr\n         g.transform(ct)\n         # Getting a new GEOS pointer\n         ptr = wkb_r().read(g.wkb)"
        },
        {
            "sha": "1be7da88451e9532beeec19908470da4f948ed29",
            "filename": "django/contrib/gis/geos/prototypes/io.py",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "raw_url": "https://github.com/django/django/raw/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py?ref=ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
            "patch": "@@ -207,7 +207,6 @@ class ThreadLocalIO(threading.local):\n     wkb_r = None\n     wkb_w = None\n     ewkb_w = None\n-    ewkb_w3d = None\n \n thread_context = ThreadLocalIO()\n \n@@ -228,20 +227,15 @@ def wkb_r():\n         thread_context.wkb_r = _WKBReader()\n     return thread_context.wkb_r\n \n-def wkb_w():\n+def wkb_w(dim=2):\n    if not thread_context.wkb_w:\n        thread_context.wkb_w = WKBWriter()\n+   thread_context.wkb_w.outdim = dim\n    return thread_context.wkb_w\n \n-def ewkb_w():\n+def ewkb_w(dim=2):\n     if not thread_context.ewkb_w:\n         thread_context.ewkb_w = WKBWriter()\n         thread_context.ewkb_w.srid = True\n+    thread_context.ewkb_w.outdim = dim\n     return thread_context.ewkb_w\n-\n-def ewkb_w3d():\n-    if not thread_context.ewkb_w3d:\n-        thread_context.ewkb_w3d = WKBWriter()\n-        thread_context.ewkb_w3d.srid = True\n-        thread_context.ewkb_w3d.outdim = 3\n-    return thread_context.ewkb_w3d"
        },
        {
            "sha": "cbe51367aea4f3db2a97edd661692abe431b1f63",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 22,
            "deletions": 7,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
            "patch": "@@ -92,6 +92,7 @@ def test_hexewkb(self):\n         \"Testing (HEX)EWKB output.\"\n         # For testing HEX(EWKB).\n         ogc_hex = b'01010000000000000000000000000000000000F03F'\n+        ogc_hex_3d = b'01010000800000000000000000000000000000F03F0000000000000040'\n         # `SELECT ST_AsHEXEWKB(ST_GeomFromText('POINT(0 1)', 4326));`\n         hexewkb_2d = b'0101000020E61000000000000000000000000000000000F03F'\n         # `SELECT ST_AsHEXEWKB(ST_GeomFromEWKT('SRID=4326;POINT(0 1 2)'));`\n@@ -100,9 +101,9 @@ def test_hexewkb(self):\n         pnt_2d = Point(0, 1, srid=4326)\n         pnt_3d = Point(0, 1, 2, srid=4326)\n \n-        # OGC-compliant HEX will not have SRID nor Z value.\n+        # OGC-compliant HEX will not have SRID value.\n         self.assertEqual(ogc_hex, pnt_2d.hex)\n-        self.assertEqual(ogc_hex, pnt_3d.hex)\n+        self.assertEqual(ogc_hex_3d, pnt_3d.hex)\n \n         # HEXEWKB should be appropriate for its dimension -- have to use an\n         # a WKBWriter w/dimension set accordingly, else GEOS will insert\n@@ -830,12 +831,17 @@ def test_collections_of_collections(self):\n     def test_gdal(self):\n         \"Testing `ogr` and `srs` properties.\"\n         g1 = fromstr('POINT(5 23)')\n-        self.assertEqual(True, isinstance(g1.ogr, gdal.OGRGeometry))\n-        self.assertEqual(g1.srs, None)\n+        self.assertIsInstance(g1.ogr, gdal.OGRGeometry)\n+        self.assertIsNone(g1.srs)\n+\n+        if GEOS_PREPARE:\n+            g1_3d = fromstr('POINT(5 23 8)')\n+            self.assertIsInstance(g1_3d.ogr, gdal.OGRGeometry)\n+            self.assertEqual(g1_3d.ogr.z, 8)\n \n         g2 = fromstr('LINESTRING(0 0, 5 5, 23 23)', srid=4326)\n-        self.assertEqual(True, isinstance(g2.ogr, gdal.OGRGeometry))\n-        self.assertEqual(True, isinstance(g2.srs, gdal.SpatialReference))\n+        self.assertIsInstance(g2.ogr, gdal.OGRGeometry)\n+        self.assertIsInstance(g2.srs, gdal.SpatialReference)\n         self.assertEqual(g2.hex, g2.ogr.hex)\n         self.assertEqual('WGS 84', g2.srs.name)\n \n@@ -848,7 +854,7 @@ def test_copy(self):\n         self.assertNotEqual(poly._ptr, cpy1._ptr)\n         self.assertNotEqual(poly._ptr, cpy2._ptr)\n \n-    @unittest.skipUnless(gdal.HAS_GDAL, \"gdal is required\")\n+    @unittest.skipUnless(gdal.HAS_GDAL, \"gdal is required to transform geometries\")\n     def test_transform(self):\n         \"Testing `transform` method.\"\n         orig = GEOSGeometry('POINT (-104.609 38.255)', 4326)\n@@ -873,6 +879,15 @@ def test_transform(self):\n             self.assertAlmostEqual(trans.x, p.x, prec)\n             self.assertAlmostEqual(trans.y, p.y, prec)\n \n+    @unittest.skipUnless(gdal.HAS_GDAL, \"gdal is required to transform geometries\")\n+    def test_transform_3d(self):\n+        p3d = GEOSGeometry('POINT (5 23 100)', 4326)\n+        p3d.transform(2774)\n+        if GEOS_PREPARE:\n+            self.assertEqual(p3d.z, 100)\n+        else:\n+            self.assertIsNone(p3d.z)\n+\n     def test_transform_noop(self):\n         \"\"\" Testing `transform` method (SRID match) \"\"\"\n         # transform() should no-op if source & dest SRIDs match,"
        },
        {
            "sha": "f7590fe84aab60176d57630fe73cf260fd4c709d",
            "filename": "django/contrib/gis/tests/geo3d/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Ftests%2Fgeo3d%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/django%2Fcontrib%2Fgis%2Ftests%2Fgeo3d%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeo3d%2Ftests.py?ref=ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
            "patch": "@@ -4,7 +4,7 @@\n import re\n \n from django.contrib.gis.db.models import Union, Extent3D\n-from django.contrib.gis.geos import GEOSGeometry, Point, Polygon\n+from django.contrib.gis.geos import GEOSGeometry, LineString, Point, Polygon\n from django.contrib.gis.utils import LayerMapping, LayerMapError\n from django.test import TestCase\n \n@@ -67,8 +67,7 @@ def _load_interstate_data(self):\n         # Interstate (2D / 3D and Geographic/Projected variants)\n         for name, line, exp_z in interstate_data:\n             line_3d = GEOSGeometry(line, srid=4269)\n-            # Using `hex` attribute because it omits 3D.\n-            line_2d = GEOSGeometry(line_3d.hex, srid=4269)\n+            line_2d = LineString([l[:2] for l in line_3d.coords], srid=4269)\n \n             # Creating a geographic and projected version of the\n             # interstate in both 2D and 3D."
        },
        {
            "sha": "eb20b1f41150ea72dd346cee952aee0d941a271d",
            "filename": "docs/ref/contrib/gis/geos.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/docs%2Fref%2Fcontrib%2Fgis%2Fgeos.txt",
            "raw_url": "https://github.com/django/django/raw/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/docs%2Fref%2Fcontrib%2Fgis%2Fgeos.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Fgeos.txt?ref=ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
            "patch": "@@ -273,14 +273,18 @@ Essentially the SRID is prepended to the WKT representation, for example\n .. attribute:: GEOSGeometry.hex\n \n Returns the WKB of this Geometry in hexadecimal form.  Please note\n-that the SRID and Z values are not included in this representation\n+that the SRID value is not included in this representation\n because it is not a part of the OGC specification (use the\n :attr:`GEOSGeometry.hexewkb` property instead).\n \n+.. versionchanged:: 1.5\n+\n+    Prior to Django 1.5, the Z value of the geometry was dropped.\n+\n .. attribute:: GEOSGeometry.hexewkb\n \n Returns the EWKB of this Geometry in hexadecimal form.  This is an\n-extension of the WKB specification that includes SRID and Z values\n+extension of the WKB specification that includes the SRID value\n that are a part of this geometry.\n \n .. note::\n@@ -319,16 +323,20 @@ correspondg to the GEOS geometry.\n .. attribute:: GEOSGeometry.wkb\n \n Returns the WKB (Well-Known Binary) representation of this Geometry\n-as a Python buffer.  SRID and Z values are not included, use the\n+as a Python buffer.  SRID value is not included, use the\n :attr:`GEOSGeometry.ewkb` property instead.\n \n+.. versionchanged:: 1.5\n+\n+    Prior to Django 1.5, the Z value of the geometry was dropped.\n+\n .. _ewkb:\n \n .. attribute:: GEOSGeometry.ewkb\n \n Return the EWKB representation of this Geometry as a Python buffer.\n This is an extension of the WKB specification that includes any SRID\n-and Z values that are a part of this geometry.\n+value that are a part of this geometry.\n \n .. note::\n \n@@ -822,7 +830,7 @@ Writer Objects\n All writer objects have a ``write(geom)`` method that returns either the\n WKB or WKT of the given geometry.  In addition, :class:`WKBWriter` objects\n also have properties that may be used to change the byte order, and or\n-include the SRID and 3D values (in other words, EWKB).\n+include the SRID value (in other words, EWKB).\n \n .. class:: WKBWriter\n \n@@ -884,7 +892,7 @@ so that the Z value is included in the WKB.\n Outdim Value Description\n ============ ===========================\n 2            The default, output 2D WKB.\n-3            Output 3D EWKB.\n+3            Output 3D WKB.\n ============ ===========================\n \n Example::"
        },
        {
            "sha": "b769debb0b810b906f73decd8f9ef1aa5301a3b7",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/ffdd6595ea2220f8e8a6fb3aacd3213b751d982f/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=ffdd6595ea2220f8e8a6fb3aacd3213b751d982f",
            "patch": "@@ -117,6 +117,8 @@ GeoDjango\n   :meth:`~django.contrib.gis.geos.GEOSGeometry.project()` methods\n   (so-called linear referencing).\n \n+* The wkb and hex properties of `GEOSGeometry` objects preserve the Z dimension.\n+\n * Support for GDAL < 1.5 has been dropped.\n \n Minor features"
        }
    ],
    "stats": {
        "total": 113,
        "additions": 62,
        "deletions": 51
    }
}