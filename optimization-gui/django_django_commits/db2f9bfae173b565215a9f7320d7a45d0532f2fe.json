{
    "author": "spookylukey",
    "message": "Fixed #16178 - Cleanup request classes' `__repr__()`\n\nThanks to julien for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16350 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "db2f9bfae173b565215a9f7320d7a45d0532f2fe",
    "files": [
        {
            "sha": "5affea45c518ca7626ae7cb22a8d40ce2054c14f",
            "filename": "django/core/handlers/modpython.py",
            "status": "modified",
            "additions": 0,
            "deletions": 26,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fcore%2Fhandlers%2Fmodpython.py",
            "raw_url": "https://github.com/django/django/raw/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fcore%2Fhandlers%2Fmodpython.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fmodpython.py?ref=db2f9bfae173b565215a9f7320d7a45d0532f2fe",
            "patch": "@@ -45,32 +45,6 @@ def __init__(self, req):\n         self._stream = self._req\n         self._read_started = False\n \n-    def __repr__(self):\n-        # Since this is called as part of error handling, we need to be very\n-        # robust against potentially malformed input.\n-        try:\n-            get = pformat(self.GET)\n-        except:\n-            get = '<could not parse>'\n-        if self._post_parse_error:\n-            post = '<could not parse>'\n-        else:\n-            try:\n-                post = pformat(self.POST)\n-            except:\n-                post = '<could not parse>'\n-        try:\n-            cookies = pformat(self.COOKIES)\n-        except:\n-            cookies = '<could not parse>'\n-        try:\n-            meta = pformat(self.META)\n-        except:\n-            meta = '<could not parse>'\n-        return smart_str(u'<ModPythonRequest\\npath:%s,\\nGET:%s,\\nPOST:%s,\\nCOOKIES:%s,\\nMETA:%s>' %\n-                         (self.path, unicode(get), unicode(post),\n-                          unicode(cookies), unicode(meta)))\n-\n     def get_full_path(self):\n         # RFC 3986 requires self._req.args to be in the ASCII range, but this\n         # doesn't always happen, so rather than crash, we defensively encode it."
        },
        {
            "sha": "2acb3b1ee756cef05d74e24611b290220dde2eea",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=db2f9bfae173b565215a9f7320d7a45d0532f2fe",
            "patch": "@@ -157,31 +157,6 @@ def __init__(self, environ):\n             self._stream = self.environ['wsgi.input']\n         self._read_started = False\n \n-    def __repr__(self):\n-        # Since this is called as part of error handling, we need to be very\n-        # robust against potentially malformed input.\n-        try:\n-            get = pformat(self.GET)\n-        except:\n-            get = '<could not parse>'\n-        if self._post_parse_error:\n-            post = '<could not parse>'\n-        else:\n-            try:\n-                post = pformat(self.POST)\n-            except:\n-                post = '<could not parse>'\n-        try:\n-            cookies = pformat(self.COOKIES)\n-        except:\n-            cookies = '<could not parse>'\n-        try:\n-            meta = pformat(self.META)\n-        except:\n-            meta = '<could not parse>'\n-        return '<WSGIRequest\\nGET:%s,\\nPOST:%s,\\nCOOKIES:%s,\\nMETA:%s>' % \\\n-            (get, post, cookies, meta)\n-\n     def get_full_path(self):\n         # RFC 3986 requires query string arguments to be in the ASCII range.\n         # Rather than crash if this doesn't happen, we encode defensively."
        },
        {
            "sha": "7f198a7b08e255f782e6a6a5dbf12dc7d51ca8de",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 49,
            "deletions": 3,
            "changes": 52,
            "blob_url": "https://github.com/django/django/blob/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=db2f9bfae173b565215a9f7320d7a45d0532f2fe",
            "patch": "@@ -134,6 +134,53 @@ class Http404(Exception):\n \n RAISE_ERROR = object()\n \n+\n+def build_request_repr(request, path_override=None, GET_override=None,\n+                       POST_override=None, COOKIES_override=None,\n+                       META_override=None):\n+    \"\"\"\n+    Builds and returns the request's representation string. The request's\n+    attributes may be overridden by pre-processed values.\n+    \"\"\"\n+    # Since this is called as part of error handling, we need to be very\n+    # robust against potentially malformed input.\n+    try:\n+        get = (pformat(GET_override)\n+               if GET_override is not None\n+               else pformat(request.GET))\n+    except:\n+        get = '<could not parse>'\n+    if request._post_parse_error:\n+        post = '<could not parse>'\n+    else:\n+        try:\n+            post = (pformat(POST_override)\n+                    if POST_override is not None\n+                    else pformat(request.POST))\n+        except:\n+            post = '<could not parse>'\n+    try:\n+        cookies = (pformat(COOKIES_override)\n+                   if COOKIES_override is not None\n+                   else pformat(request.COOKIES))\n+    except:\n+        cookies = '<could not parse>'\n+    try:\n+        meta = (pformat(META_override)\n+                if META_override is not None\n+                else pformat(request.META))\n+    except:\n+        meta = '<could not parse>'\n+    path = path_override if path_override is not None else request.path\n+    return smart_str(u'<%s\\npath:%s,\\nGET:%s,\\nPOST:%s,\\nCOOKIES:%s,\\nMETA:%s>' %\n+                     (request.__class__.__name__,\n+                      path,\n+                      unicode(get),\n+                      unicode(post),\n+                      unicode(cookies),\n+                      unicode(meta)))\n+\n+\n class HttpRequest(object):\n     \"\"\"A basic HTTP request.\"\"\"\n \n@@ -146,11 +193,10 @@ def __init__(self):\n         self.path = ''\n         self.path_info = ''\n         self.method = None\n+        self._post_parse_error = False\n \n     def __repr__(self):\n-        return '<HttpRequest\\nGET:%s,\\nPOST:%s,\\nCOOKIES:%s,\\nMETA:%s>' % \\\n-            (pformat(self.GET), pformat(self.POST), pformat(self.COOKIES),\n-            pformat(self.META))\n+        return build_request_repr(self)\n \n     def get_host(self):\n         \"\"\"Returns the HTTP host using the environment or request headers.\"\"\""
        },
        {
            "sha": "490d4bbecf3034a6a16aba394bf3746291ee00b9",
            "filename": "django/views/debug.py",
            "status": "modified",
            "additions": 2,
            "deletions": 29,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fviews%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/db2f9bfae173b565215a9f7320d7a45d0532f2fe/django%2Fviews%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdebug.py?ref=db2f9bfae173b565215a9f7320d7a45d0532f2fe",
            "patch": "@@ -7,7 +7,7 @@\n \n from django.conf import settings\n from django.http import (HttpResponse, HttpResponseServerError,\n-    HttpResponseNotFound, HttpRequest)\n+    HttpResponseNotFound, HttpRequest, build_request_repr)\n from django.template import (Template, Context, TemplateDoesNotExist,\n     TemplateSyntaxError)\n from django.template.defaultfilters import force_escape, pprint\n@@ -96,34 +96,7 @@ def get_request_repr(self, request):\n         if request is None:\n             return repr(None)\n         else:\n-            # Since this is called as part of error handling, we need to be very\n-            # robust against potentially malformed input.\n-            try:\n-                get = pformat(request.GET)\n-            except:\n-                get = '<could not parse>'\n-            if request._post_parse_error:\n-                post = '<could not parse>'\n-            else:\n-                try:\n-                    post = pformat(self.get_post_parameters(request))\n-                except:\n-                    post = '<could not parse>'\n-            try:\n-                cookies = pformat(request.COOKIES)\n-            except:\n-                cookies = '<could not parse>'\n-            try:\n-                meta = pformat(request.META)\n-            except:\n-                meta = '<could not parse>'\n-            return smart_str(u'<%s\\npath:%s,\\nGET:%s,\\nPOST:%s,\\nCOOKIES:%s,\\nMETA:%s>' %\n-                             (request.__class__.__name__,\n-                              request.path,\n-                              unicode(get),\n-                              unicode(post),\n-                              unicode(cookies),\n-                              unicode(meta)))\n+            return build_request_repr(request, POST_override=self.get_post_parameters(request))\n \n     def get_post_parameters(self, request):\n         if request is None:"
        },
        {
            "sha": "703e387319be2309184345c7eb0206c604cde1bc",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 40,
            "deletions": 1,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/db2f9bfae173b565215a9f7320d7a45d0532f2fe/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/db2f9bfae173b565215a9f7320d7a45d0532f2fe/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=db2f9bfae173b565215a9f7320d7a45d0532f2fe",
            "patch": "@@ -4,7 +4,7 @@\n \n from django.core.handlers.modpython import ModPythonRequest\n from django.core.handlers.wsgi import WSGIRequest, LimitedStream\n-from django.http import HttpRequest, HttpResponse, parse_cookie\n+from django.http import HttpRequest, HttpResponse, parse_cookie, build_request_repr\n from django.utils import unittest\n from django.utils.http import cookie_date\n \n@@ -16,6 +16,18 @@ def test_httprequest(self):\n         self.assertEqual(request.COOKIES.keys(), [])\n         self.assertEqual(request.META.keys(), [])\n \n+    def test_httprequest_repr(self):\n+        request = HttpRequest()\n+        request.path = u'/somepath/'\n+        request.GET = {u'get-key': u'get-value'}\n+        request.POST = {u'post-key': u'post-value'}\n+        request.COOKIES = {u'post-key': u'post-value'}\n+        request.META = {u'post-key': u'post-value'}\n+        self.assertEqual(repr(request), u\"<HttpRequest\\npath:/somepath/,\\nGET:{u'get-key': u'get-value'},\\nPOST:{u'post-key': u'post-value'},\\nCOOKIES:{u'post-key': u'post-value'},\\nMETA:{u'post-key': u'post-value'}>\")\n+        self.assertEqual(build_request_repr(request), repr(request))\n+        self.assertEqual(build_request_repr(request, path_override='/otherpath/', GET_override={u'a': u'b'}, POST_override={u'c': u'd'}, COOKIES_override={u'e': u'f'}, META_override={u'g': u'h'}),\n+                         u\"<HttpRequest\\npath:/otherpath/,\\nGET:{u'a': u'b'},\\nPOST:{u'c': u'd'},\\nCOOKIES:{u'e': u'f'},\\nMETA:{u'g': u'h'}>\")\n+\n     def test_wsgirequest(self):\n         request = WSGIRequest({'PATH_INFO': 'bogus', 'REQUEST_METHOD': 'bogus', 'wsgi.input': StringIO('')})\n         self.assertEqual(request.GET.keys(), [])\n@@ -26,6 +38,17 @@ def test_wsgirequest(self):\n         self.assertEqual(request.META['REQUEST_METHOD'], 'bogus')\n         self.assertEqual(request.META['SCRIPT_NAME'], '')\n \n+    def test_wsgirequest_repr(self):\n+        request = WSGIRequest({'PATH_INFO': '/somepath/', 'REQUEST_METHOD': 'get', 'wsgi.input': StringIO('')})\n+        request.GET = {u'get-key': u'get-value'}\n+        request.POST = {u'post-key': u'post-value'}\n+        request.COOKIES = {u'post-key': u'post-value'}\n+        request.META = {u'post-key': u'post-value'}\n+        self.assertEqual(repr(request), u\"<WSGIRequest\\npath:/somepath/,\\nGET:{u'get-key': u'get-value'},\\nPOST:{u'post-key': u'post-value'},\\nCOOKIES:{u'post-key': u'post-value'},\\nMETA:{u'post-key': u'post-value'}>\")\n+        self.assertEqual(build_request_repr(request), repr(request))\n+        self.assertEqual(build_request_repr(request, path_override='/otherpath/', GET_override={u'a': u'b'}, POST_override={u'c': u'd'}, COOKIES_override={u'e': u'f'}, META_override={u'g': u'h'}),\n+                         u\"<WSGIRequest\\npath:/otherpath/,\\nGET:{u'a': u'b'},\\nPOST:{u'c': u'd'},\\nCOOKIES:{u'e': u'f'},\\nMETA:{u'g': u'h'}>\")\n+\n     def test_modpythonrequest(self):\n         class FakeModPythonRequest(ModPythonRequest):\n            def __init__(self, *args, **kwargs):\n@@ -45,6 +68,22 @@ def get_options(self):\n         self.assertEqual(request.COOKIES.keys(), [])\n         self.assertEqual(request.META.keys(), [])\n \n+    def test_modpythonrequest_repr(self):\n+        class Dummy:\n+            def get_options(self):\n+                return {}\n+        req = Dummy()\n+        req.uri = '/somepath/'\n+        request = ModPythonRequest(req)\n+        request._get = {u'get-key': u'get-value'}\n+        request._post = {u'post-key': u'post-value'}\n+        request._cookies = {u'post-key': u'post-value'}\n+        request._meta = {u'post-key': u'post-value'}\n+        self.assertEqual(repr(request), u\"<ModPythonRequest\\npath:/somepath/,\\nGET:{u'get-key': u'get-value'},\\nPOST:{u'post-key': u'post-value'},\\nCOOKIES:{u'post-key': u'post-value'},\\nMETA:{u'post-key': u'post-value'}>\")\n+        self.assertEqual(build_request_repr(request), repr(request))\n+        self.assertEqual(build_request_repr(request, path_override='/otherpath/', GET_override={u'a': u'b'}, POST_override={u'c': u'd'}, COOKIES_override={u'e': u'f'}, META_override={u'g': u'h'}),\n+                         u\"<ModPythonRequest\\npath:/otherpath/,\\nGET:{u'a': u'b'},\\nPOST:{u'c': u'd'},\\nCOOKIES:{u'e': u'f'},\\nMETA:{u'g': u'h'}>\")\n+\n     def test_parse_cookie(self):\n         self.assertEqual(parse_cookie('invalid:key=true'), {})\n "
        }
    ],
    "stats": {
        "total": 175,
        "additions": 91,
        "deletions": 84
    }
}