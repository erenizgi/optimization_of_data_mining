{
    "author": "honzakral",
    "message": "Few improvements to FormPreview, thanks Andy!\n\nThis commit adds several new hooks in backwards-compatible way:\n * get_initial to specify initial data based on request\n * get_auto_id to enable different AUTO_ID values\n * get_context for overriding and extending default context contents\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14659 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "70b3ac1f07b60dd1b6888b71fe20596fa64527dc",
    "files": [
        {
            "sha": "3fa61ba6bfeb39275ea8a00268fa386c2c485bf8",
            "filename": "django/contrib/formtools/preview.py",
            "status": "modified",
            "additions": 26,
            "deletions": 7,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/70b3ac1f07b60dd1b6888b71fe20596fa64527dc/django%2Fcontrib%2Fformtools%2Fpreview.py",
            "raw_url": "https://github.com/django/django/raw/70b3ac1f07b60dd1b6888b71fe20596fa64527dc/django%2Fcontrib%2Fformtools%2Fpreview.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Fpreview.py?ref=70b3ac1f07b60dd1b6888b71fe20596fa64527dc",
            "patch": "@@ -51,17 +51,17 @@ def unused_name(self, name):\n \n     def preview_get(self, request):\n         \"Displays the form\"\n-        f = self.form(auto_id=AUTO_ID)\n+        f = self.form(auto_id=self.get_auto_id(), initial=self.get_initial(request))\n         return render_to_response(self.form_template,\n-            {'form': f, 'stage_field': self.unused_name('stage'), 'state': self.state},\n+            self.get_context(request, f),\n             context_instance=RequestContext(request))\n \n     def preview_post(self, request):\n         \"Validates the POST data. If valid, displays the preview page. Else, redisplays form.\"\n-        f = self.form(request.POST, auto_id=AUTO_ID)\n-        context = {'form': f, 'stage_field': self.unused_name('stage'), 'state': self.state}\n+        f = self.form(request.POST, auto_id=self.get_auto_id())\n+        context = self.get_context(request, f)\n         if f.is_valid():\n-            self.process_preview(request, f, context) \n+            self.process_preview(request, f, context)\n             context['hash_field'] = self.unused_name('hash')\n             context['hash_value'] = self.security_hash(request, f)\n             return render_to_response(self.preview_template, context, context_instance=RequestContext(request))\n@@ -91,19 +91,38 @@ def _check_security_hash(self, token, request, form):\n \n     def post_post(self, request):\n         \"Validates the POST data. If valid, calls done(). Else, redisplays form.\"\n-        f = self.form(request.POST, auto_id=AUTO_ID)\n+        f = self.form(request.POST, auto_id=self.get_auto_id())\n         if f.is_valid():\n             if not self._check_security_hash(request.POST.get(self.unused_name('hash'), ''),\n                                              request, f):\n                 return self.failed_hash(request) # Security hash failed.\n             return self.done(request, f.cleaned_data)\n         else:\n             return render_to_response(self.form_template,\n-                {'form': f, 'stage_field': self.unused_name('stage'), 'state': self.state},\n+                self.get_context(request, f),\n                 context_instance=RequestContext(request))\n \n     # METHODS SUBCLASSES MIGHT OVERRIDE IF APPROPRIATE ########################\n \n+    def get_auto_id(self):\n+        \"\"\"\n+        Hook to override the ``auto_id`` kwarg for the form. Needed when\n+        rendering two form previews in the same template.\n+        \"\"\"\n+        return AUTO_ID\n+\n+    def get_initial(self, request):\n+        \"\"\"\n+        Takes a request argument and returns a dictionary to pass to the form's\n+        ``initial`` kwarg when the form is being created from an HTTP get.\n+        \"\"\"\n+        return {}\n+\n+    def get_context(self, request, form):\n+        \"Context for template rendering.\"\n+        return {'form': form, 'stage_field': self.unused_name('stage'), 'state': self.state}\n+\n+\n     def parse_params(self, *args, **kwargs):\n         \"\"\"\n         Given captured args and kwargs from the URLconf, saves something in"
        },
        {
            "sha": "6aeeaf5a3dd20a1bbef8e5ab7397dbd15308afb5",
            "filename": "django/contrib/formtools/tests/__init__.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/70b3ac1f07b60dd1b6888b71fe20596fa64527dc/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/70b3ac1f07b60dd1b6888b71fe20596fa64527dc/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py?ref=70b3ac1f07b60dd1b6888b71fe20596fa64527dc",
            "patch": "@@ -11,6 +11,13 @@\n \n \n class TestFormPreview(preview.FormPreview):\n+    def get_context(self, request, form):\n+        context = super(TestFormPreview, self).get_context(request, form)\n+        context.update({'custom_context': True})\n+        return context\n+\n+    def get_initial(self, request):\n+        return {'field1': 'Works!'}\n \n     def done(self, request, cleaned_data):\n         return http.HttpResponse(success_string)\n@@ -59,6 +66,8 @@ def test_form_get(self):\n         response = self.client.get('/test1/')\n         stage = self.input % 1\n         self.assertContains(response, stage, 1)\n+        self.assertEquals(response.context['custom_context'], True)\n+        self.assertEquals(response.context['form'].initial, {'field1': 'Works!'})\n \n     def test_form_preview(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 42,
        "additions": 35,
        "deletions": 7
    }
}