{
    "author": "mjtamlyn",
    "message": "Fixed #20094 - Be more careful when checking for Iterator\n\nPython 2.6 has some different behaviour when checking\nisinstance(foo, collections.Iterator).",
    "sha": "829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
    "files": [
        {
            "sha": "1f0ce5e4ed1bad5e744cfe6a81dc06c90e62246a",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
            "patch": "@@ -1,6 +1,5 @@\n from __future__ import unicode_literals\n \n-import collections\n import copy\n import datetime\n import decimal\n@@ -18,6 +17,7 @@\n from django.utils.datastructures import DictWrapper\n from django.utils.dateparse import parse_date, parse_datetime, parse_time\n from django.utils.functional import curry, total_ordering\n+from django.utils.itercompat import is_iterator\n from django.utils.text import capfirst\n from django.utils import timezone\n from django.utils.translation import ugettext_lazy as _\n@@ -488,7 +488,7 @@ def bind(self, fieldmapping, original, bound_field_class):\n         return bound_field_class(self, fieldmapping, original)\n \n     def _get_choices(self):\n-        if isinstance(self._choices, collections.Iterator):\n+        if is_iterator(self._choices):\n             choices, self._choices = tee(self._choices)\n             return choices\n         else:"
        },
        {
            "sha": "42682c342e4549f77ac3c546f230bfb289443f73",
            "filename": "django/db/models/sql/where.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/django%2Fdb%2Fmodels%2Fsql%2Fwhere.py",
            "raw_url": "https://github.com/django/django/raw/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/django%2Fdb%2Fmodels%2Fsql%2Fwhere.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fwhere.py?ref=829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
            "patch": "@@ -4,14 +4,14 @@\n \n from __future__ import absolute_import\n \n-import collections\n import datetime\n from itertools import repeat\n \n from django.conf import settings\n from django.db.models.fields import DateTimeField, Field\n from django.db.models.sql.datastructures import EmptyResultSet, Empty\n from django.db.models.sql.aggregates import Aggregate\n+from django.utils.itercompat import is_iterator\n from django.utils.six.moves import xrange\n from django.utils import timezone\n from django.utils import tree\n@@ -58,7 +58,7 @@ def _prepare_data(self, data):\n         if not isinstance(data, (list, tuple)):\n             return data\n         obj, lookup_type, value = data\n-        if isinstance(value, collections.Iterator):\n+        if is_iterator(value):\n             # Consume any generators immediately, so that we can determine\n             # emptiness and transform any non-empty values correctly.\n             value = list(value)"
        },
        {
            "sha": "c50dcfb779258dcf2a3016e3e712a3afd0066048",
            "filename": "django/utils/itercompat.py",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/django%2Futils%2Fitercompat.py",
            "raw_url": "https://github.com/django/django/raw/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/django%2Futils%2Fitercompat.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fitercompat.py?ref=829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
            "patch": "@@ -4,10 +4,12 @@\n these implementations if necessary.\n \"\"\"\n \n-from django.utils.six.moves import builtins\n+import collections\n import itertools\n+import sys\n import warnings\n \n+\n def is_iterable(x):\n     \"A implementation independent way of checking for iterables\"\n     try:\n@@ -17,6 +19,17 @@ def is_iterable(x):\n     else:\n         return True\n \n+def is_iterator(x):\n+    \"\"\"An implementation independent way of checking for iterators\n+\n+    Python 2.6 has a different implementation of collections.Iterator which\n+    accepts anything with a `next` method. 2.7+ requires and `__iter__` method\n+    as well.\n+    \"\"\"\n+    if sys.version_info >= (2, 7):\n+        return isinstance(x, collections.Iterator)\n+    return isinstance(x, collections.Iterator) and hasattr(x, '__iter__')\n+\n def product(*args, **kwds):\n     warnings.warn(\"django.utils.itercompat.product is deprecated; use the native version instead\",\n                   DeprecationWarning, stacklevel=2)"
        },
        {
            "sha": "02d3463370b632bc2908f1a4f977e8609e27f00f",
            "filename": "tests/utils_tests/itercompat.py",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/tests%2Futils_tests%2Fitercompat.py",
            "raw_url": "https://github.com/django/django/raw/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/tests%2Futils_tests%2Fitercompat.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Futils_tests%2Fitercompat.py?ref=829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
            "patch": "@@ -0,0 +1,11 @@\n+from django.test import TestCase\n+\n+from .models import Category, Thing\n+\n+\n+class TestIsIterator(TestCase):\n+    def test_regression(self):\n+        \"\"\"This failed on Django 1.5/Py2.6 because category has a next method.\"\"\"\n+        category = Category.objects.create(name='category')\n+        Thing.objects.create(category=category)\n+        Thing.objects.filter(category=category)"
        },
        {
            "sha": "de8f9e38032c6a5742b0170feb78b141a45d8029",
            "filename": "tests/utils_tests/models.py",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/tests%2Futils_tests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/tests%2Futils_tests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Futils_tests%2Fmodels.py?ref=829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
            "patch": "@@ -1 +1,13 @@\n-# Test runner needs a models.py file.\n+from django.db import models\n+\n+\n+class Category(models.Model):\n+    name = models.CharField(max_length=100)\n+\n+    def next(self):\n+        return self\n+\n+\n+class Thing(models.Model):\n+    name = models.CharField(max_length=100)\n+    category = models.ForeignKey(Category)"
        },
        {
            "sha": "f9c6e558478e2a1e3258aa530950d9e80a92f3d1",
            "filename": "tests/utils_tests/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/tests%2Futils_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/829dc3c5a64d3fa203b8cc0055e83cf23addfee3/tests%2Futils_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Futils_tests%2Ftests.py?ref=829dc3c5a64d3fa203b8cc0055e83cf23addfee3",
            "patch": "@@ -18,6 +18,7 @@\n from .functional import FunctionalTestCase\n from .html import TestUtilsHtml\n from .http import TestUtilsHttp, ETagProcessingTests, HttpDateProcessingTests\n+from .itercompat import TestIsIterator\n from .ipv6 import TestUtilsIPv6\n from .jslex import JsToCForGettextTest, JsTokensTest\n from .module_loading import (CustomLoader, DefaultLoader, EggLoader,"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 43,
        "deletions": 6
    }
}