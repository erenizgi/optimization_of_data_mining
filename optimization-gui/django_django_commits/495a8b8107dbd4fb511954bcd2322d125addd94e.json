{
    "author": "aaugustin",
    "message": "Fixed #6527 -- Provided repeatable content access\n\nin HttpResponses instantiated with iterators.",
    "sha": "495a8b8107dbd4fb511954bcd2322d125addd94e",
    "files": [
        {
            "sha": "e9cc3f70a967aad4ed8e50fd12c1c5ce27f47931",
            "filename": "django/http/response.py",
            "status": "modified",
            "additions": 25,
            "deletions": 5,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/495a8b8107dbd4fb511954bcd2322d125addd94e/django%2Fhttp%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/495a8b8107dbd4fb511954bcd2322d125addd94e/django%2Fhttp%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2Fresponse.py?ref=495a8b8107dbd4fb511954bcd2322d125addd94e",
            "patch": "@@ -246,8 +246,18 @@ def serialize(self):\n     else:\n         __str__ = serialize\n \n+    def _consume_content(self):\n+        # If the response was instantiated with an iterator, when its content\n+        # is accessed, the iterator is going be exhausted and the content\n+        # loaded in memory. At this point, it's better to abandon the original\n+        # iterator and save the content for later reuse. This is a temporary\n+        # solution. See the comment in __iter__ below for the long term plan.\n+        if self._base_content_is_iter:\n+            self.content = b''.join(self.make_bytes(e) for e in self._container)\n+\n     @property\n     def content(self):\n+        self._consume_content()\n         return b''.join(self.make_bytes(e) for e in self._container)\n \n     @content.setter\n@@ -262,6 +272,17 @@ def content(self, value):\n             self._base_content_is_iter = False\n \n     def __iter__(self):\n+        # Raise a deprecation warning only if the content wasn't consumed yet,\n+        # because the response may be intended to be streamed.\n+        # Once the deprecation completes, iterators should be consumed upon\n+        # assignment rather than upon access. The _consume_content method\n+        # should be removed. See #6527.\n+        if self._base_content_is_iter:\n+            warnings.warn(\n+                'Creating streaming responses with `HttpResponse` is '\n+                'deprecated. Use `StreamingHttpResponse` instead '\n+                'if you need the streaming behavior.',\n+                PendingDeprecationWarning, stacklevel=2)\n         self._iterator = iter(self._container)\n         return self\n \n@@ -277,14 +298,12 @@ def __next__(self):\n     next = __next__             # Python 2 compatibility\n \n     def write(self, content):\n-        if self._base_content_is_iter:\n-            raise Exception(\"This %s instance is not writable\" % self.__class__.__name__)\n+        self._consume_content()\n         self._container.append(content)\n \n     def tell(self):\n-        if self._base_content_is_iter:\n-            raise Exception(\"This %s instance cannot tell its position\" % self.__class__.__name__)\n-        return sum([len(chunk) for chunk in self])\n+        self._consume_content()\n+        return sum(len(chunk) for chunk in self)\n \n \n class StreamingHttpResponse(HttpResponseBase):\n@@ -389,6 +408,7 @@ def content(self, value):\n         if value:\n             raise AttributeError(\"You cannot set content to a 304 (Not Modified) response\")\n         self._container = []\n+        self._base_content_is_iter = False\n \n \n class HttpResponseBadRequest(HttpResponse):"
        },
        {
            "sha": "014ea05a512086da351539579d8d10e76a08caee",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/495a8b8107dbd4fb511954bcd2322d125addd94e/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/495a8b8107dbd4fb511954bcd2322d125addd94e/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=495a8b8107dbd4fb511954bcd2322d125addd94e",
            "patch": "@@ -286,6 +286,10 @@ these changes.\n * The ``mimetype`` argument to :class:`~django.http.HttpResponse` ``__init__``\n   will be removed (``content_type`` should be used instead).\n \n+* When :class:`~django.http.HttpResponse` is instantiated with an iterator,\n+  or when :attr:`~django.http.HttpResponse.content` is set to an iterator,\n+  that iterator will be immediately consumed.\n+\n * The ``AUTH_PROFILE_MODULE`` setting, and the ``get_profile()`` method on\n   the User model, will be removed.\n "
        },
        {
            "sha": "c3ba99168db87f59e6ab42e99567c599e4fc8080",
            "filename": "docs/ref/request-response.txt",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/495a8b8107dbd4fb511954bcd2322d125addd94e/docs%2Fref%2Frequest-response.txt",
            "raw_url": "https://github.com/django/django/raw/495a8b8107dbd4fb511954bcd2322d125addd94e/docs%2Fref%2Frequest-response.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Frequest-response.txt?ref=495a8b8107dbd4fb511954bcd2322d125addd94e",
            "patch": "@@ -569,18 +569,25 @@ Passing iterators\n Finally, you can pass ``HttpResponse`` an iterator rather than strings. If you\n use this technique, the iterator should return strings.\n \n+Passing an iterator as content to :class:`HttpResponse` creates a\n+streaming response if (and only if) no middleware accesses the\n+:attr:`HttpResponse.content` attribute before the response is returned.\n+\n .. versionchanged:: 1.5\n \n-    Passing an iterator as content to :class:`HttpResponse` creates a\n-    streaming response if (and only if) no middleware accesses the\n-    :attr:`HttpResponse.content` attribute before the response is returned.\n+This technique is fragile and was deprecated in Django 1.5. If you need the\n+response to be streamed from the iterator to the client, you should use the\n+:class:`StreamingHttpResponse` class instead.\n+\n+As of Django 1.7, when :class:`HttpResponse` is instantiated with an\n+iterator, it will consume it immediately, store the response content as a\n+string, and discard the iterator.\n \n-    If you want to guarantee that your response will stream to the client, you\n-    should use the new :class:`StreamingHttpResponse` class instead.\n+.. versionchanged:: 1.5\n \n-If an :class:`HttpResponse` instance has been initialized with an iterator as\n-its content, you can't use it as a file-like object. Doing so will raise an\n-exception.\n+You can now use :class:`HttpResponse` as a file-like object even if it was\n+instantiated with an iterator. Django will consume and save the content of\n+the iterator on first access.\n \n Setting headers\n ~~~~~~~~~~~~~~~"
        },
        {
            "sha": "ac61fb363bb0b4d94064b2fdf6048ccbfe81b976",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 34,
            "deletions": 20,
            "changes": 54,
            "blob_url": "https://github.com/django/django/blob/495a8b8107dbd4fb511954bcd2322d125addd94e/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/495a8b8107dbd4fb511954bcd2322d125addd94e/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=495a8b8107dbd4fb511954bcd2322d125addd94e",
            "patch": "@@ -84,6 +84,8 @@ For one-to-one relationships, both sides can be cached. For many-to-one\n relationships, only the single side of the relationship can be cached. This\n is particularly helpful in combination with ``prefetch_related``.\n \n+.. _explicit-streaming-responses:\n+\n Explicit support for streaming responses\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -98,7 +100,7 @@ You can now explicitly generate a streaming response with the new\n is an iterator.\n \n Since :class:`~django.http.StreamingHttpResponse` does not have a ``content``\n-attribute, middleware that need access to the response content must test for\n+attribute, middleware that needs access to the response content must test for\n streaming responses and behave accordingly. See :ref:`response-middleware` for\n more information.\n \n@@ -483,6 +485,30 @@ Features deprecated in 1.5\n \n .. _simplejson-deprecation:\n \n+:setting:`AUTH_PROFILE_MODULE`\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+With the introduction of :ref:`custom User models <auth-custom-user>`, there is\n+no longer any need for a built-in mechanism to store user profile data.\n+\n+You can still define user profiles models that have a one-to-one relation with\n+the User model - in fact, for many applications needing to associate data with\n+a User account, this will be an appropriate design pattern to follow. However,\n+the :setting:`AUTH_PROFILE_MODULE` setting, and the\n+:meth:`~django.contrib.auth.models.User.get_profile()` method for accessing\n+the user profile model, should not be used any longer.\n+\n+Streaming behavior of :class:`HttpResponse`\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django 1.5 deprecates the ability to stream a response by passing an iterator\n+to :class:`~django.http.HttpResponse`. If you rely on this behavior, switch to\n+:class:`~django.http.StreamingHttpResponse`. See :ref:`explicit-streaming-\n+responses` above.\n+\n+In Django 1.7 and above, the iterator will be consumed immediately by\n+:class:`~django.http.HttpResponse`.\n+\n ``django.utils.simplejson``\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n@@ -497,36 +523,24 @@ incompatibilities between versions of :mod:`simplejson` -- see the\n If you rely on features added to :mod:`simplejson` after it became Python's\n :mod:`json`, you should import :mod:`simplejson` explicitly.\n \n-``itercompat.product``\n-~~~~~~~~~~~~~~~~~~~~~~\n-\n-The :func:`~django.utils.itercompat.product` function has been deprecated. Use\n-the built-in :func:`itertools.product` instead.\n-\n ``django.utils.encoding.StrAndUnicode``\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n The :class:`~django.utils.encoding.StrAndUnicode` mix-in has been deprecated.\n Define a ``__str__`` method and apply the\n :func:`~django.utils.encoding.python_2_unicode_compatible` decorator instead.\n \n+``django.utils.itercompat.product``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The :func:`~django.utils.itercompat.product` function has been deprecated. Use\n+the built-in :func:`itertools.product` instead.\n+\n+\n ``django.utils.markup``\n ~~~~~~~~~~~~~~~~~~~~~~~\n \n The markup contrib module has been deprecated and will follow an accelerated\n deprecation schedule. Direct use of python markup libraries or 3rd party tag\n libraries is preferred to Django maintaining this functionality in the\n framework.\n-\n-:setting:`AUTH_PROFILE_MODULE`\n-~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n-\n-With the introduction of :ref:`custom User models <auth-custom-user>`, there is\n-no longer any need for a built-in mechanism to store user profile data.\n-\n-You can still define user profiles models that have a one-to-one relation with\n-the User model - in fact, for many applications needing to associate data with\n-a User account, this will be an appropriate design pattern to follow. However,\n-the :setting:`AUTH_PROFILE_MODULE` setting, and the\n-:meth:`~django.contrib.auth.models.User.get_profile()` method for accessing\n-the user profile model, should not be used any longer."
        },
        {
            "sha": "7f61a3074fa0653f166d5f554f12248681cf2652",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 26,
            "deletions": 5,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/495a8b8107dbd4fb511954bcd2322d125addd94e/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/495a8b8107dbd4fb511954bcd2322d125addd94e/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=495a8b8107dbd4fb511954bcd2322d125addd94e",
            "patch": "@@ -4,6 +4,7 @@\n import copy\n import os\n import pickle\n+import warnings\n \n from django.core.exceptions import SuspiciousOperation\n from django.http import (QueryDict, HttpResponse, HttpResponseRedirect,\n@@ -313,11 +314,17 @@ def test_iter_content(self):\n         r.content = [1, 2, 3]\n         self.assertEqual(r.content, b'123')\n \n-        #test retrieval explicitly using iter and odd inputs\n+        #test retrieval explicitly using iter (deprecated) and odd inputs\n         r = HttpResponse()\n         r.content = ['1', '2', 3, '\\u079e']\n-        my_iter = r.__iter__()\n-        result = list(my_iter)\n+        with warnings.catch_warnings(record=True) as w:\n+            warnings.simplefilter(\"always\", PendingDeprecationWarning)\n+            my_iter = iter(r)\n+            self.assertEqual(w[0].category, PendingDeprecationWarning)\n+        with warnings.catch_warnings(record=True) as w:\n+            warnings.simplefilter(\"always\", PendingDeprecationWarning)\n+            result = list(my_iter)\n+            self.assertEqual(w[0].category, PendingDeprecationWarning)\n         #'\\xde\\x9e' == unichr(1950).encode('utf-8')\n         self.assertEqual(result, [b'1', b'2', b'3', b'\\xde\\x9e'])\n         self.assertEqual(r.content, b'123\\xde\\x9e')\n@@ -330,6 +337,16 @@ def test_iter_content(self):\n         self.assertRaises(UnicodeEncodeError,\n                           getattr, r, 'content')\n \n+        # content can safely be accessed multiple times.\n+        r = HttpResponse(iter(['hello', 'world']))\n+        self.assertEqual(r.content, r.content)\n+        self.assertEqual(r.content, b'helloworld')\n+\n+        # additional content can be written to the response.\n+        r.write('!')\n+        self.assertEqual(r.content, b'helloworld!')\n+\n+\n     def test_file_interface(self):\n         r = HttpResponse()\n         r.write(b\"hello\")\n@@ -338,7 +355,9 @@ def test_file_interface(self):\n         self.assertEqual(r.tell(), 17)\n \n         r = HttpResponse(['abc'])\n-        self.assertRaises(Exception, r.write, 'def')\n+        r.write('def')\n+        self.assertEqual(r.tell(), 6)\n+        self.assertEqual(r.content, b'abcdef')\n \n     def test_unsafe_redirect(self):\n         bad_urls = [\n@@ -447,7 +466,9 @@ def test_response(self):\n         file1 = open(filename)\n         r = HttpResponse(file1)\n         self.assertFalse(file1.closed)\n-        list(r)\n+        with warnings.catch_warnings():\n+            warnings.simplefilter(\"ignore\", PendingDeprecationWarning)\n+            list(r)\n         self.assertFalse(file1.closed)\n         r.close()\n         self.assertTrue(file1.closed)"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 104,
        "deletions": 38
    }
}