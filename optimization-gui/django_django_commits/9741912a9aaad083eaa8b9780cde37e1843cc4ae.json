{
    "author": "ptone",
    "message": "Fixed #17869 - force logout when REMOTE_USER header disappears\n\nIf the current sessions user was logged in via a remote user backend log out\nthe user if REMOTE_USER header not available - otherwise leave it to other auth\nmiddleware to install the AnonymousUser.\n\nThanks to Sylvain Bouchard for the initial patch and ticket maintenance.",
    "sha": "9741912a9aaad083eaa8b9780cde37e1843cc4ae",
    "files": [
        {
            "sha": "f38efdd1d2117433f87de9ae83861a4220e1faa9",
            "filename": "django/contrib/auth/middleware.py",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/9741912a9aaad083eaa8b9780cde37e1843cc4ae/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/9741912a9aaad083eaa8b9780cde37e1843cc4ae/django%2Fcontrib%2Fauth%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmiddleware.py?ref=9741912a9aaad083eaa8b9780cde37e1843cc4ae",
            "patch": "@@ -1,4 +1,6 @@\n from django.contrib import auth\n+from django.contrib.auth import load_backend\n+from django.contrib.auth.backends import RemoteUserBackend\n from django.core.exceptions import ImproperlyConfigured\n from django.utils.functional import SimpleLazyObject\n \n@@ -47,9 +49,18 @@ def process_request(self, request):\n         try:\n             username = request.META[self.header]\n         except KeyError:\n-            # If specified header doesn't exist then return (leaving\n-            # request.user set to AnonymousUser by the\n-            # AuthenticationMiddleware).\n+            # If specified header doesn't exist then remove any existing\n+            # authenticated remote-user, or return (leaving request.user set to\n+            # AnonymousUser by the AuthenticationMiddleware).\n+            if request.user.is_authenticated():\n+                try:\n+                    stored_backend = load_backend(request.session.get(\n+                        auth.BACKEND_SESSION_KEY, ''))\n+                    if isinstance(stored_backend, RemoteUserBackend):\n+                        auth.logout(request)\n+                except ImproperlyConfigured as e:\n+                    # backend failed to load\n+                    auth.logout(request)\n             return\n         # If the user is already authenticated and that user is the user we are\n         # getting passed in the headers, then the correct user is already"
        },
        {
            "sha": "0e59b291a8b17a1f07bbef14ef1c5929f303716a",
            "filename": "django/contrib/auth/tests/remote_user.py",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/9741912a9aaad083eaa8b9780cde37e1843cc4ae/django%2Fcontrib%2Fauth%2Ftests%2Fremote_user.py",
            "raw_url": "https://github.com/django/django/raw/9741912a9aaad083eaa8b9780cde37e1843cc4ae/django%2Fcontrib%2Fauth%2Ftests%2Fremote_user.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fremote_user.py?ref=9741912a9aaad083eaa8b9780cde37e1843cc4ae",
            "patch": "@@ -1,8 +1,9 @@\n from datetime import datetime\n \n from django.conf import settings\n+from django.contrib.auth import authenticate\n from django.contrib.auth.backends import RemoteUserBackend\n-from django.contrib.auth.models import User\n+from django.contrib.auth.models import User, AnonymousUser\n from django.contrib.auth.tests.utils import skipIfCustomUser\n from django.test import TestCase\n from django.utils import timezone\n@@ -23,7 +24,7 @@ def setUp(self):\n         self.curr_middleware = settings.MIDDLEWARE_CLASSES\n         self.curr_auth = settings.AUTHENTICATION_BACKENDS\n         settings.MIDDLEWARE_CLASSES += (self.middleware,)\n-        settings.AUTHENTICATION_BACKENDS = (self.backend,)\n+        settings.AUTHENTICATION_BACKENDS += (self.backend,)\n \n     def test_no_remote_user(self):\n         \"\"\"\n@@ -97,6 +98,26 @@ def test_last_login(self):\n         response = self.client.get('/remote_user/', REMOTE_USER=self.known_user)\n         self.assertEqual(default_login, response.context['user'].last_login)\n \n+    def test_header_disappears(self):\n+        \"\"\"\n+        Tests that a logged in user is logged out automatically when\n+        the REMOTE_USER header disappears during the same browser session.\n+        \"\"\"\n+        User.objects.create(username='knownuser')\n+        # Known user authenticates\n+        response = self.client.get('/remote_user/', REMOTE_USER=self.known_user)\n+        self.assertEqual(response.context['user'].username, 'knownuser')\n+        # During the session, the REMOTE_USER header disappears. Should trigger logout.\n+        response = self.client.get('/remote_user/')\n+        self.assertEqual(response.context['user'].is_anonymous(), True)\n+        # verify the remoteuser middleware will not remove a user\n+        # authenticated via another backend\n+        User.objects.create_user(username='modeluser', password='foo')\n+        self.client.login(username='modeluser', password='foo')\n+        authenticate(username='modeluser', password='foo')\n+        response = self.client.get('/remote_user/')\n+        self.assertEqual(response.context['user'].username, 'modeluser')\n+\n     def tearDown(self):\n         \"\"\"Restores settings to avoid breaking other tests.\"\"\"\n         settings.MIDDLEWARE_CLASSES = self.curr_middleware"
        },
        {
            "sha": "3ee1b2d21f2ffef11abaf3d584329defab73e411",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/9741912a9aaad083eaa8b9780cde37e1843cc4ae/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/9741912a9aaad083eaa8b9780cde37e1843cc4ae/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=9741912a9aaad083eaa8b9780cde37e1843cc4ae",
            "patch": "@@ -296,6 +296,9 @@ Django 1.5 also includes several smaller improvements worth noting:\n   you to test equality for XML content at a semantic level, without caring for\n   syntax differences (spaces, attribute order, etc.).\n \n+* RemoteUserMiddleware now forces logout when the REMOTE_USER header\n+  disappears during the same browser session.\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        }
    ],
    "stats": {
        "total": 45,
        "additions": 40,
        "deletions": 5
    }
}