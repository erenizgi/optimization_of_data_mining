{
    "author": "akaariai",
    "message": "Fixed #17615 -- Corrected unique field validation when using multitable inheritance. The validation used wrong pk value if the parent and child model had different pk fields. Thanks ungenio for the report and patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17920 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "53fb45c6d82da6136bd06c0318c364fd076e67be",
    "files": [
        {
            "sha": "e28add30a9de4cf50dc1057dc511764b14b07413",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/53fb45c6d82da6136bd06c0318c364fd076e67be/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/53fb45c6d82da6136bd06c0318c364fd076e67be/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=53fb45c6d82da6136bd06c0318c364fd076e67be",
            "patch": "@@ -718,9 +718,13 @@ def _perform_unique_checks(self, unique_checks):\n \n             # Exclude the current object from the query if we are editing an\n             # instance (as opposed to creating a new one)\n-            if not self._state.adding and self.pk is not None:\n-                qs = qs.exclude(pk=self.pk)\n-\n+            # Note that we need to use the pk as defined by model_class, not\n+            # self.pk. These can be different fields because model inheritance\n+            # allows single model to have effectively multiple primary keys.\n+            # Refs #17615.\n+            model_class_pk = self._get_pk_val(model_class._meta)\n+            if not self._state.adding and model_class_pk is not None:\n+                qs = qs.exclude(pk=model_class_pk)\n             if qs.exists():\n                 if len(unique_check) == 1:\n                     key = unique_check[0]"
        },
        {
            "sha": "161569bcb33c505e5b7884eec8e9b2a671b5c37d",
            "filename": "tests/regressiontests/model_inheritance_regress/models.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/53fb45c6d82da6136bd06c0318c364fd076e67be/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/53fb45c6d82da6136bd06c0318c364fd076e67be/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Fmodels.py?ref=53fb45c6d82da6136bd06c0318c364fd076e67be",
            "patch": "@@ -163,3 +163,10 @@ class BusStation(Station):\n \n class TrainStation(Station):\n     zone = models.IntegerField()\n+\n+class User(models.Model):\n+    username = models.CharField(max_length=30, unique=True)\n+\n+class Profile(User):\n+    profile_id = models.AutoField(primary_key=True)\n+    extra = models.CharField(max_length=30, blank=True)"
        },
        {
            "sha": "3cb6f9d6030e2bbb50d0c027737bb7dcc254814a",
            "filename": "tests/regressiontests/model_inheritance_regress/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/53fb45c6d82da6136bd06c0318c364fd076e67be/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/53fb45c6d82da6136bd06c0318c364fd076e67be/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Ftests.py?ref=53fb45c6d82da6136bd06c0318c364fd076e67be",
            "patch": "@@ -6,14 +6,15 @@\n \n import datetime\n from operator import attrgetter\n+from django import forms\n \n from django.test import TestCase\n \n from .models import (Place, Restaurant, ItalianRestaurant, ParkingLot,\n     ParkingLot2, ParkingLot3, Supplier, Wholesaler, Child, SelfRefParent,\n     SelfRefChild, ArticleWithAuthor, M2MChild, QualityControl, DerivedM,\n     Person, BirthdayParty, BachelorParty, MessyBachelorParty,\n-    InternalCertificationAudit, BusStation, TrainStation)\n+    InternalCertificationAudit, BusStation, TrainStation, User, Profile)\n \n \n class ModelInheritanceTest(TestCase):\n@@ -408,3 +409,17 @@ def test_concrete_abstract_concrete_pk(self):\n         )\n         self.assertIs(BusStation._meta.pk.model, BusStation)\n         self.assertIs(TrainStation._meta.pk.model, TrainStation)\n+\n+    def test_inherited_unique_field_with_form(self):\n+        \"\"\"\n+        Test that a model which has different primary key for the parent model\n+        passes unique field checking correctly. Refs #17615.\n+        \"\"\"\n+        class ProfileForm(forms.ModelForm):\n+            class Meta:\n+                model = Profile\n+        User.objects.create(username=\"user_only\")\n+        p = Profile.objects.create(username=\"user_with_profile\")\n+        form = ProfileForm({'username': \"user_with_profile\", 'extra': \"hello\"},\n+                           instance=p)\n+        self.assertTrue(form.is_valid())"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}