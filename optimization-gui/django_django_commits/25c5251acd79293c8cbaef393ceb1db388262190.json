{
    "author": "ramiro",
    "message": "Fixed #6189 -- Modified test that need Internet access so they use a mock instead. Thanks Gregor MÃ¼ellegger for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16451 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "25c5251acd79293c8cbaef393ceb1db388262190",
    "files": [
        {
            "sha": "93f35704ed31a66cac86be49647b0b59da1a2c0d",
            "filename": "tests/regressiontests/forms/tests/error_messages.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/25c5251acd79293c8cbaef393ceb1db388262190/tests%2Fregressiontests%2Fforms%2Ftests%2Ferror_messages.py",
            "raw_url": "https://github.com/django/django/raw/25c5251acd79293c8cbaef393ceb1db388262190/tests%2Fregressiontests%2Fforms%2Ftests%2Ferror_messages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ferror_messages.py?ref=25c5251acd79293c8cbaef393ceb1db388262190",
            "patch": "@@ -4,6 +4,7 @@\n from django.test import TestCase\n from django.utils.safestring import mark_safe\n from django.utils import unittest\n+from regressiontests.forms.tests.fields import verify_exists_urls\n \n class AssertFormErrorsMixin(object):\n     def assertFormErrors(self, expected, the_callable, *args, **kwargs):\n@@ -139,6 +140,7 @@ def test_filefield(self):\n         self.assertFormErrors([u'EMPTY FILE'], f.clean, SimpleUploadedFile('name', None))\n         self.assertFormErrors([u'EMPTY FILE'], f.clean, SimpleUploadedFile('name', ''))\n \n+    @verify_exists_urls()\n     def test_urlfield(self):\n         e = {\n             'required': 'REQUIRED',"
        },
        {
            "sha": "67804134ac03bd130c3544ccd3611b3d664b4a85",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 31,
            "deletions": 12,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/25c5251acd79293c8cbaef393ceb1db388262190/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/25c5251acd79293c8cbaef393ceb1db388262190/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=25c5251acd79293c8cbaef393ceb1db388262190",
            "patch": "@@ -25,11 +25,11 @@\n __init__(). For example, CharField has a max_length option.\n \"\"\"\n import datetime\n-import time\n import re\n import os\n import urllib2\n from decimal import Decimal\n+from functools import wraps\n \n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.forms import *\n@@ -48,6 +48,28 @@ def fix_os_paths(x):\n         return x\n \n \n+def verify_exists_urls(existing_urls=()):\n+    def decorator(func):\n+        @wraps(func)\n+        def wrapper(*args, **kwargs):\n+            from django.core import validators\n+            # patch urllib2\n+            original_urlopen = validators.urllib2.urlopen\n+            def urlopen(req):\n+                url = req.get_full_url()\n+                if url in existing_urls:\n+                    return True\n+                raise Exception()\n+            try:\n+                urllib2.urlopen = urlopen\n+                func(*args, **kwargs)\n+            finally:\n+                # unpatch urllib2\n+                validators.urllib2.urlopen = original_urlopen\n+        return wrapper\n+    return decorator\n+\n+\n class FieldsTests(TestCase):\n \n     def assertRaisesErrorWithMessage(self, error, message, callable, *args, **kwargs):\n@@ -595,9 +617,10 @@ def test_urlfield_2(self):\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, 'http://example.')\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, 'http://.com')\n \n+    @verify_exists_urls(('http://www.google.com/',))\n     def test_urlfield_3(self):\n         f = URLField(verify_exists=True)\n-        self.assertEqual(u'http://www.google.com/', f.clean('http://www.google.com')) # This will fail if there's no Internet connection\n+        self.assertEqual(u'http://www.google.com/', f.clean('http://www.google.com'))\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid URL.']\", f.clean, 'http://example')\n         self.assertRaises(ValidationError, f.clean, 'http://www.broken.djangoproject.com') # bad domain\n         self.assertRaises(ValidationError, f.clean, 'http://qa-dev.w3.org/link-testsuite/http.php?code=405') # Method not allowed\n@@ -611,10 +634,11 @@ def test_urlfield_3(self):\n         except ValidationError, e:\n             self.assertEqual(\"[u'This URL appears to be a broken link.']\", str(e))\n \n+    @verify_exists_urls(('http://www.google.com/',))\n     def test_urlfield_4(self):\n         f = URLField(verify_exists=True, required=False)\n         self.assertEqual(u'', f.clean(''))\n-        self.assertEqual(u'http://www.google.com/', f.clean('http://www.google.com')) # This will fail if there's no Internet connection\n+        self.assertEqual(u'http://www.google.com/', f.clean('http://www.google.com'))\n \n     def test_urlfield_5(self):\n         f = URLField(min_length=15, max_length=20)\n@@ -663,17 +687,12 @@ def test_urlfield_9(self):\n         except ValidationError, e:\n             self.assertEqual(\"[u'This URL appears to be a broken link.']\", str(e))\n \n+    @verify_exists_urls(('http://xn--tr-xka.djangoproject.com/',))\n     def test_urlfield_10(self):\n-        # UTF-8 char in path, enclosed by a monkey-patch to make sure\n-        # the encoding is passed to urllib2.urlopen\n+        # UTF-8 char in path\n         f = URLField(verify_exists=True)\n-        try:\n-            _orig_urlopen = urllib2.urlopen\n-            urllib2.urlopen = lambda req: True\n-            url = u'http://t\\xfcr.djangoproject.com/'\n-            self.assertEqual(url, f.clean(url))\n-        finally:\n-            urllib2.urlopen = _orig_urlopen\n+        url = u'http://t\\xfcr.djangoproject.com/'\n+        self.assertEqual(url, f.clean(url))\n \n     # BooleanField ################################################################\n "
        }
    ],
    "stats": {
        "total": 45,
        "additions": 33,
        "deletions": 12
    }
}