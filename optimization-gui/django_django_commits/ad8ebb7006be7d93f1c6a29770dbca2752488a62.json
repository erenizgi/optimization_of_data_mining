{
    "author": "jphalip",
    "message": "Fixed #8317 -- Corrected the inspectdb management command to properly set `primary_key=True` and `unique=True` on foreign keys. Thanks to bthomas for the report and patch, and to David Gouldin for the tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17451 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ad8ebb7006be7d93f1c6a29770dbca2752488a62",
    "files": [
        {
            "sha": "e81f3997881dc3786055e0b154bdf8590310e1bb",
            "filename": "django/core/management/commands/inspectdb.py",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/ad8ebb7006be7d93f1c6a29770dbca2752488a62/django%2Fcore%2Fmanagement%2Fcommands%2Finspectdb.py",
            "raw_url": "https://github.com/django/django/raw/ad8ebb7006be7d93f1c6a29770dbca2752488a62/django%2Fcore%2Fmanagement%2Fcommands%2Finspectdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Finspectdb.py?ref=ad8ebb7006be7d93f1c6a29770dbca2752488a62",
            "patch": "@@ -62,15 +62,22 @@ def handle_inspection(self, options):\n                 if ' ' in att_name or '-' in att_name or keyword.iskeyword(att_name) or column_name != att_name:\n                     extra_params['db_column'] = column_name\n \n+                # Add primary_key and unique, if necessary.\n+                if column_name in indexes:\n+                    if indexes[column_name]['primary_key']:\n+                        extra_params['primary_key'] = True\n+                    elif indexes[column_name]['unique']:\n+                        extra_params['unique'] = True\n+\n                 # Modify the field name to make it Python-compatible.\n                 if ' ' in att_name:\n                     att_name = att_name.replace(' ', '_')\n                     comment_notes.append('Field renamed to remove spaces.')\n-                    \n+\n                 if '-' in att_name:\n                     att_name = att_name.replace('-', '_')\n                     comment_notes.append('Field renamed to remove dashes.')\n-                    \n+\n                 if column_name != att_name:\n                     comment_notes.append('Field name made lowercase.')\n \n@@ -88,15 +95,8 @@ def handle_inspection(self, options):\n                     extra_params.update(field_params)\n                     comment_notes.extend(field_notes)\n \n-                    # Add primary_key and unique, if necessary.\n-                    if column_name in indexes:\n-                        if indexes[column_name]['primary_key']:\n-                            extra_params['primary_key'] = True\n-                        elif indexes[column_name]['unique']:\n-                            extra_params['unique'] = True\n-\n                     field_type += '('\n-                    \n+\n                 if keyword.iskeyword(att_name):\n                     att_name += '_field'\n                     comment_notes.append('Field renamed because it was a Python reserved word.')"
        },
        {
            "sha": "fac47aa34f230ef0aee39ed786907823b1834ae1",
            "filename": "tests/regressiontests/inspectdb/models.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/ad8ebb7006be7d93f1c6a29770dbca2752488a62/tests%2Fregressiontests%2Finspectdb%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/ad8ebb7006be7d93f1c6a29770dbca2752488a62/tests%2Fregressiontests%2Finspectdb%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finspectdb%2Fmodels.py?ref=ad8ebb7006be7d93f1c6a29770dbca2752488a62",
            "patch": "@@ -6,3 +6,12 @@ class People(models.Model):\n \n class Message(models.Model):\n     from_field = models.ForeignKey(People, db_column='from_id')\n+\n+class PeopleData(models.Model):\n+    people_pk = models.ForeignKey(People, primary_key=True)\n+    ssn = models.CharField(max_length=11)\n+\n+class PeopleMoreData(models.Model):\n+    people_unique = models.ForeignKey(People, unique=True)\n+    license = models.CharField(max_length=255)\n+"
        },
        {
            "sha": "e2eced576dccea0b5c7d2f37fafd779743b6a2cf",
            "filename": "tests/regressiontests/inspectdb/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/ad8ebb7006be7d93f1c6a29770dbca2752488a62/tests%2Fregressiontests%2Finspectdb%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ad8ebb7006be7d93f1c6a29770dbca2752488a62/tests%2Fregressiontests%2Finspectdb%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Finspectdb%2Ftests.py?ref=ad8ebb7006be7d93f1c6a29770dbca2752488a62",
            "patch": "@@ -13,4 +13,8 @@ def test_attribute_name_not_python_keyword(self):\n         error_message = \"inspectdb generated an attribute name which is a python keyword\"\n         self.assertNotIn(\"from = models.ForeignKey(InspectdbPeople)\", out.getvalue(), msg=error_message)\n         self.assertIn(\"from_field = models.ForeignKey(InspectdbPeople)\", out.getvalue())\n+        self.assertIn(\"people_pk = models.ForeignKey(InspectdbPeople, primary_key=True)\",\n+            out.getvalue())\n+        self.assertIn(\"people_unique = models.ForeignKey(InspectdbPeople, unique=True)\",\n+            out.getvalue())\n         out.close()"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 23,
        "deletions": 10
    }
}