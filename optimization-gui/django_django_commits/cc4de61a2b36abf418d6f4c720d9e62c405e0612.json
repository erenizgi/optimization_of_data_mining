{
    "author": "apollo13",
    "message": "Fixed #19596 -- Use `_default_manager` instead of `objects` in the auth app.\n\nThis is needed to support custom user models which don't define a manager\nnamed `objects`.",
    "sha": "cc4de61a2b36abf418d6f4c720d9e62c405e0612",
    "files": [
        {
            "sha": "703fd2519dc14e2b3f4445a205cb623630a04c5d",
            "filename": "django/contrib/auth/backends.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fbackends.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fbackends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fbackends.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -13,7 +13,7 @@ class ModelBackend(object):\n     def authenticate(self, username=None, password=None):\n         try:\n             UserModel = get_user_model()\n-            user = UserModel.objects.get_by_natural_key(username)\n+            user = UserModel._default_manager.get_by_natural_key(username)\n             if user.check_password(password):\n                 return user\n         except UserModel.DoesNotExist:\n@@ -64,7 +64,7 @@ def has_module_perms(self, user_obj, app_label):\n     def get_user(self, user_id):\n         try:\n             UserModel = get_user_model()\n-            return UserModel.objects.get(pk=user_id)\n+            return UserModel._default_manager.get(pk=user_id)\n         except UserModel.DoesNotExist:\n             return None\n "
        },
        {
            "sha": "cbce8ad6e257d95caefcfb1574db5c05177dbc9c",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -89,7 +89,7 @@ def clean_username(self):\n         # but it sets a nicer error message than the ORM. See #13147.\n         username = self.cleaned_data[\"username\"]\n         try:\n-            User.objects.get(username=username)\n+            User._default_manager.get(username=username)\n         except User.DoesNotExist:\n             return username\n         raise forms.ValidationError(self.error_messages['duplicate_username'])\n@@ -217,7 +217,7 @@ def clean_email(self):\n         \"\"\"\n         UserModel = get_user_model()\n         email = self.cleaned_data[\"email\"]\n-        self.users_cache = UserModel.objects.filter(email__iexact=email)\n+        self.users_cache = UserModel._default_manager.filter(email__iexact=email)\n         if not len(self.users_cache):\n             raise forms.ValidationError(self.error_messages['unknown'])\n         if not any(user.is_active for user in self.users_cache):"
        },
        {
            "sha": "a26d6219dd9c033612565d16d0cd45d647833918",
            "filename": "django/contrib/auth/handlers/modwsgi.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -18,7 +18,7 @@ def check_password(environ, username, password):\n \n     try:\n         try:\n-            user = UserModel.objects.get_by_natural_key(username)\n+            user = UserModel._default_manager.get_by_natural_key(username)\n         except UserModel.DoesNotExist:\n             return None\n         if not user.is_active:\n@@ -37,7 +37,7 @@ def groups_for_user(environ, username):\n \n     try:\n         try:\n-            user = UserModel.objects.get_by_natural_key(username)\n+            user = UserModel._default_manager.get_by_natural_key(username)\n         except UserModel.DoesNotExist:\n             return []\n         try:"
        },
        {
            "sha": "a77bba0f73e160259889d37ed208f7a35a3d6ff3",
            "filename": "django/contrib/auth/management/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -174,7 +174,7 @@ def get_default_username(check_db=True):\n     # Don't return the default username if it is already taken.\n     if check_db and default_username:\n         try:\n-            auth_app.User.objects.get(username=default_username)\n+            auth_app.User._default_manager.get(username=default_username)\n         except auth_app.User.DoesNotExist:\n             pass\n         else:"
        },
        {
            "sha": "3240b0f99225700e551dd17d9c91cccb81eb9ff5",
            "filename": "django/contrib/auth/management/commands/changepassword.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -33,7 +33,7 @@ def handle(self, *args, **options):\n         UserModel = get_user_model()\n \n         try:\n-            u = UserModel.objects.using(options.get('database')).get(**{\n+            u = UserModel._default_manager.using(options.get('database')).get(**{\n                     UserModel.USERNAME_FIELD: username\n                 })\n         except UserModel.DoesNotExist:"
        },
        {
            "sha": "7b4764abc3f2ef1cddfa6c3dab5631edc003f411",
            "filename": "django/contrib/auth/management/commands/createsuperuser.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -95,7 +95,7 @@ def handle(self, *args, **options):\n                         username = None\n                         continue\n                     try:\n-                        self.UserModel.objects.db_manager(database).get_by_natural_key(username)\n+                        self.UserModel._default_manager.db_manager(database).get_by_natural_key(username)\n                     except self.UserModel.DoesNotExist:\n                         pass\n                     else:\n@@ -134,6 +134,6 @@ def handle(self, *args, **options):\n \n         user_data[self.UserModel.USERNAME_FIELD] = username\n         user_data['password'] = password\n-        self.UserModel.objects.db_manager(database).create_superuser(**user_data)\n+        self.UserModel._default_manager.db_manager(database).create_superuser(**user_data)\n         if verbosity >= 1:\n             self.stdout.write(\"Superuser created successfully.\")"
        },
        {
            "sha": "074374cd5accec267500f5c39afe97bbc5bb061d",
            "filename": "django/contrib/auth/tests/auth_backends.py",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -34,7 +34,7 @@ def tearDown(self):\n         ContentType.objects.clear_cache()\n \n     def test_has_perm(self):\n-        user = self.UserModel.objects.get(pk=self.user.pk)\n+        user = self.UserModel._default_manager.get(pk=self.user.pk)\n         self.assertEqual(user.has_perm('auth.test'), False)\n         user.is_staff = True\n         user.save()\n@@ -53,14 +53,14 @@ def test_has_perm(self):\n         self.assertEqual(user.has_perm('auth.test'), False)\n \n     def test_custom_perms(self):\n-        user = self.UserModel.objects.get(pk=self.user.pk)\n+        user = self.UserModel._default_manager.get(pk=self.user.pk)\n         content_type = ContentType.objects.get_for_model(Group)\n         perm = Permission.objects.create(name='test', content_type=content_type, codename='test')\n         user.user_permissions.add(perm)\n         user.save()\n \n         # reloading user to purge the _perm_cache\n-        user = self.UserModel.objects.get(pk=self.user.pk)\n+        user = self.UserModel._default_manager.get(pk=self.user.pk)\n         self.assertEqual(user.get_all_permissions() == set(['auth.test']), True)\n         self.assertEqual(user.get_group_permissions(), set([]))\n         self.assertEqual(user.has_module_perms('Group'), False)\n@@ -71,7 +71,7 @@ def test_custom_perms(self):\n         perm = Permission.objects.create(name='test3', content_type=content_type, codename='test3')\n         user.user_permissions.add(perm)\n         user.save()\n-        user = self.UserModel.objects.get(pk=self.user.pk)\n+        user = self.UserModel._default_manager.get(pk=self.user.pk)\n         self.assertEqual(user.get_all_permissions(), set(['auth.test2', 'auth.test', 'auth.test3']))\n         self.assertEqual(user.has_perm('test'), False)\n         self.assertEqual(user.has_perm('auth.test'), True)\n@@ -81,7 +81,7 @@ def test_custom_perms(self):\n         group.permissions.add(perm)\n         group.save()\n         user.groups.add(group)\n-        user = self.UserModel.objects.get(pk=self.user.pk)\n+        user = self.UserModel._default_manager.get(pk=self.user.pk)\n         exp = set(['auth.test2', 'auth.test', 'auth.test3', 'auth.test_group'])\n         self.assertEqual(user.get_all_permissions(), exp)\n         self.assertEqual(user.get_group_permissions(), set(['auth.test_group']))\n@@ -93,7 +93,7 @@ def test_custom_perms(self):\n \n     def test_has_no_object_perm(self):\n         \"\"\"Regressiontest for #12462\"\"\"\n-        user = self.UserModel.objects.get(pk=self.user.pk)\n+        user = self.UserModel._default_manager.get(pk=self.user.pk)\n         content_type = ContentType.objects.get_for_model(Group)\n         perm = Permission.objects.create(name='test', content_type=content_type, codename='test')\n         user.user_permissions.add(perm)\n@@ -106,7 +106,7 @@ def test_has_no_object_perm(self):\n \n     def test_get_all_superuser_permissions(self):\n         \"A superuser has all permissions. Refs #14795\"\n-        user = self.UserModel.objects.get(pk=self.superuser.pk)\n+        user = self.UserModel._default_manager.get(pk=self.superuser.pk)\n         self.assertEqual(len(user.get_all_permissions()), len(Permission.objects.all()))\n \n \n@@ -151,13 +151,13 @@ class ExtensionUserModelBackendTest(BaseModelBackendTest, TestCase):\n     UserModel = ExtensionUser\n \n     def create_users(self):\n-        self.user = ExtensionUser.objects.create_user(\n+        self.user = ExtensionUser._default_manager.create_user(\n             username='test',\n             email='test@example.com',\n             password='test',\n             date_of_birth=date(2006, 4, 25)\n         )\n-        self.superuser = ExtensionUser.objects.create_superuser(\n+        self.superuser = ExtensionUser._default_manager.create_superuser(\n             username='test2',\n             email='test2@example.com',\n             password='test',\n@@ -178,12 +178,12 @@ class CustomPermissionsUserModelBackendTest(BaseModelBackendTest, TestCase):\n     UserModel = CustomPermissionsUser\n \n     def create_users(self):\n-        self.user = CustomPermissionsUser.objects.create_user(\n+        self.user = CustomPermissionsUser._default_manager.create_user(\n             email='test@example.com',\n             password='test',\n             date_of_birth=date(2006, 4, 25)\n         )\n-        self.superuser = CustomPermissionsUser.objects.create_superuser(\n+        self.superuser = CustomPermissionsUser._default_manager.create_superuser(\n             email='test2@example.com',\n             password='test',\n             date_of_birth=date(1976, 11, 8)"
        },
        {
            "sha": "8cc57d4caf0532ccea71459c5d979984ca8a00e3",
            "filename": "django/contrib/auth/tests/custom_user.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -42,7 +42,7 @@ class CustomUser(AbstractBaseUser):\n     is_admin = models.BooleanField(default=False)\n     date_of_birth = models.DateField()\n \n-    objects = CustomUserManager()\n+    custom_objects = CustomUserManager()\n \n     USERNAME_FIELD = 'email'\n     REQUIRED_FIELDS = ['date_of_birth']\n@@ -88,7 +88,7 @@ def is_staff(self):\n class ExtensionUser(AbstractUser):\n     date_of_birth = models.DateField()\n \n-    objects = UserManager()\n+    custom_objects = UserManager()\n \n     REQUIRED_FIELDS = AbstractUser.REQUIRED_FIELDS + ['date_of_birth']\n \n@@ -112,7 +112,7 @@ class CustomPermissionsUser(AbstractBaseUser, PermissionsMixin):\n     email = models.EmailField(verbose_name='email address', max_length=255, unique=True)\n     date_of_birth = models.DateField()\n \n-    objects = CustomPermissionsUserManager()\n+    custom_objects = CustomPermissionsUserManager()\n \n     USERNAME_FIELD = 'email'\n     REQUIRED_FIELDS = ['date_of_birth']\n@@ -136,7 +136,7 @@ class IsActiveTestUser1(AbstractBaseUser):\n     \"\"\"\n     username = models.CharField(max_length=30, unique=True)\n \n-    objects = BaseUserManager()\n+    custom_objects = BaseUserManager()\n \n     USERNAME_FIELD = 'username'\n "
        },
        {
            "sha": "41063aaf4a95dd46433ee2bb557808f209cb4556",
            "filename": "django/contrib/auth/tests/handlers.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -42,7 +42,7 @@ def test_check_password_custom_user(self):\n         with custom user installed\n         \"\"\"\n \n-        CustomUser.objects.create_user('test@example.com', '1990-01-01', 'test')\n+        CustomUser._default_manager.create_user('test@example.com', '1990-01-01', 'test')\n \n         # User not in database\n         self.assertTrue(check_password({}, 'unknown', '') is None)"
        },
        {
            "sha": "42f14d6d5c97871d5322736efdb03b5c50dd0d06",
            "filename": "django/contrib/auth/tests/management.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -125,7 +125,7 @@ def test_email_in_username(self):\n             email=\"joe@somewhere.org\",\n             stdout=new_io\n         )\n-        u = User.objects.get(username=\"joe+admin@somewhere.org\")\n+        u = User._default_manager.get(username=\"joe+admin@somewhere.org\")\n         self.assertEqual(u.email, 'joe@somewhere.org')\n         self.assertFalse(u.has_usable_password())\n \n@@ -145,7 +145,7 @@ def test_swappable_user(self):\n         )\n         command_output = new_io.getvalue().strip()\n         self.assertEqual(command_output, 'Superuser created successfully.')\n-        u = CustomUser.objects.get(email=\"joe@somewhere.org\")\n+        u = CustomUser._default_manager.get(email=\"joe@somewhere.org\")\n         self.assertEqual(u.date_of_birth, date(1976, 4, 1))\n \n         # created password should be unusable\n@@ -167,7 +167,7 @@ def test_swappable_user_missing_required_field(self):\n                 skip_validation=True\n             )\n \n-        self.assertEqual(CustomUser.objects.count(), 0)\n+        self.assertEqual(CustomUser._default_manager.count(), 0)\n \n \n class PermissionDuplicationTestCase(TestCase):"
        },
        {
            "sha": "8ac0599e6bc1a577df86d8b9345cad1308c3cd6f",
            "filename": "django/contrib/auth/tests/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmodels.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -137,6 +137,6 @@ def test_is_active_field_default(self):\n         user.is_active = False\n         # there should be no problem saving - but the attribute is not saved\n         user.save()\n-        user_fetched = UserModel.objects.get(pk=user.pk)\n+        user_fetched = UserModel._default_manager.get(pk=user.pk)\n         # the attribute is always true for newly retrieved instance\n         self.assertEqual(user_fetched.is_active, True)"
        },
        {
            "sha": "9d1534651b6b874c6c28e004d6deb30ec0ce92c7",
            "filename": "django/contrib/auth/views.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/cc4de61a2b36abf418d6f4c720d9e62c405e0612/django%2Fcontrib%2Fauth%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fviews.py?ref=cc4de61a2b36abf418d6f4c720d9e62c405e0612",
            "patch": "@@ -200,7 +200,7 @@ def password_reset_confirm(request, uidb36=None, token=None,\n         post_reset_redirect = reverse('django.contrib.auth.views.password_reset_complete')\n     try:\n         uid_int = base36_to_int(uidb36)\n-        user = UserModel.objects.get(pk=uid_int)\n+        user = UserModel._default_manager.get(pk=uid_int)\n     except (ValueError, OverflowError, UserModel.DoesNotExist):\n         user = None\n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 31,
        "deletions": 31
    }
}