{
    "author": "jacobian",
    "message": "Ensured that the test suite creates the default DB before any others.\n\nRefs #14799. Technically this fixes the problem, but I'm far from convinced\nit's the perfect solution, so I'm leaving the ticket open. I'm committing\nthis now because it's the minimum required to get the test suite running\nagain, but this commit can -- and probably should -- be reverted in favor of\na more holistic fix later on.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14756 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2fa22a4b6414235a38fa646b2c6e17e49630185f",
    "files": [
        {
            "sha": "41d9f72f23d48e235257aaa6db7a405b6537f864",
            "filename": "django/test/simple.py",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/2fa22a4b6414235a38fa646b2c6e17e49630185f/django%2Ftest%2Fsimple.py",
            "raw_url": "https://github.com/django/django/raw/2fa22a4b6414235a38fa646b2c6e17e49630185f/django%2Ftest%2Fsimple.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsimple.py?ref=2fa22a4b6414235a38fa646b2c6e17e49630185f",
            "patch": "@@ -216,7 +216,7 @@ def build_suite(self, test_labels, extra_tests=None, **kwargs):\n         return reorder_suite(suite, (TestCase,))\n \n     def setup_databases(self, **kwargs):\n-        from django.db import connections\n+        from django.db import connections, DEFAULT_DB_ALIAS\n \n         # First pass -- work out which databases actually need to be created,\n         # and which ones are test mirrors or duplicate entries in DATABASES\n@@ -238,11 +238,21 @@ def setup_databases(self, **kwargs):\n                         connection.settings_dict['ENGINE'],\n                         connection.settings_dict['NAME'],\n                     ), []).append(alias)\n-\n-        # Second pass -- actually create the databases.\n+        \n+        # Re-order the list of databases to create, making sure the default\n+        # database is first. Otherwise, creation order is semi-random (i.e. \n+        # dict ordering dependent).\n+        dbs_to_create = []\n+        for dbinfo, aliases in test_databases.items():\n+            if DEFAULT_DB_ALIAS in aliases:\n+                dbs_to_create.insert(0, (dbinfo, aliases))\n+            else:\n+                dbs_to_create.append((dbinfo, aliases))\n+                \n+        # Final pass -- actually create the databases.\n         old_names = []\n         mirrors = []\n-        for (host, port, engine, db_name), aliases in test_databases.items():\n+        for (host, port, engine, db_name), aliases in dbs_to_create:\n             # Actually create the database for the first connection\n             connection = connections[aliases[0]]\n             old_names.append((connection, db_name, True))"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 14,
        "deletions": 4
    }
}