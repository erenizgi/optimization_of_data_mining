{
    "author": "jezdez",
    "message": "Fixed #15907 -- Fixed another conflict between the ModelForm exclude and the GenericInline. Thanks, leonelfreire and prestontimmons.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16603 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "386b12c1c668dd54d24704ef974e17b38abb825d",
    "files": [
        {
            "sha": "69dd52703782e5cbc93e36754a180d3d60e2b249",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/386b12c1c668dd54d24704ef974e17b38abb825d/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/386b12c1c668dd54d24704ef974e17b38abb825d/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=386b12c1c668dd54d24704ef974e17b38abb825d",
            "patch": "@@ -406,6 +406,10 @@ def get_formset(self, request, obj=None, **kwargs):\n         else:\n             exclude = list(self.exclude)\n         exclude.extend(self.get_readonly_fields(request, obj))\n+        if self.exclude is None and hasattr(self.form, '_meta') and self.form._meta.exclude:\n+            # Take the custom ModelForm's Meta.exclude into account only if the\n+            # GenericInlineModelAdmin doesn't define its own.\n+            exclude.extend(self.form._meta.exclude)\n         exclude = exclude or None\n         defaults = {\n             \"ct_field\": self.ct_field,"
        },
        {
            "sha": "32ecd3b889a2b323f8083889ac0e42e33ffa668c",
            "filename": "tests/regressiontests/generic_inline_admin/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 12,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/386b12c1c668dd54d24704ef974e17b38abb825d/tests%2Fregressiontests%2Fgeneric_inline_admin%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/386b12c1c668dd54d24704ef974e17b38abb825d/tests%2Fregressiontests%2Fgeneric_inline_admin%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_inline_admin%2Fmodels.py?ref=386b12c1c668dd54d24704ef974e17b38abb825d",
            "patch": "@@ -5,6 +5,8 @@\n \n class Episode(models.Model):\n     name = models.CharField(max_length=100)\n+    length = models.CharField(max_length=100, blank=True)\n+    author = models.CharField(max_length=100, blank=True)\n \n class Media(models.Model):\n     \"\"\"\n@@ -14,6 +16,8 @@ class Media(models.Model):\n     object_id = models.PositiveIntegerField()\n     content_object = generic.GenericForeignKey()\n     url = models.URLField(verify_exists=False)\n+    description = models.CharField(max_length=100, blank=True)\n+    keywords = models.CharField(max_length=100, blank=True)\n \n     def __unicode__(self):\n         return self.url\n@@ -59,18 +63,6 @@ class MediaMaxNumInline(generic.GenericTabularInline):\n \n admin.site.register(EpisodeMaxNum, inlines=[MediaMaxNumInline])\n \n-#\n-# Generic inline with exclude\n-#\n-\n-class EpisodeExclude(Episode):\n-    pass\n-\n-class MediaExcludeInline(generic.GenericTabularInline):\n-    model = Media\n-    exclude = ['url']\n-\n-admin.site.register(EpisodeExclude, inlines=[MediaExcludeInline])\n \n #\n # Generic inline with unique_together"
        },
        {
            "sha": "da59922fe57f59ff1a7697971145d4369dfb883c",
            "filename": "tests/regressiontests/generic_inline_admin/tests.py",
            "status": "modified",
            "additions": 89,
            "deletions": 13,
            "changes": 102,
            "blob_url": "https://github.com/django/django/blob/386b12c1c668dd54d24704ef974e17b38abb825d/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/386b12c1c668dd54d24704ef974e17b38abb825d/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py?ref=386b12c1c668dd54d24704ef974e17b38abb825d",
            "patch": "@@ -1,13 +1,16 @@\n # coding: utf-8\n \n from django.conf import settings\n+from django.contrib import admin\n from django.contrib.admin.sites import AdminSite\n-from django.contrib.contenttypes.generic import generic_inlineformset_factory\n+from django.contrib.contenttypes.generic import (\n+    generic_inlineformset_factory, GenericTabularInline)\n+from django.forms.models import ModelForm\n from django.test import TestCase\n \n # local test models\n-from models import (Episode, EpisodeExtra, EpisodeMaxNum, EpisodeExclude,\n-    Media, MediaInline, EpisodePermanent, MediaPermanentInline, Category)\n+from models import (Episode, EpisodeExtra, EpisodeMaxNum, Media,\n+    MediaInline, EpisodePermanent, MediaPermanentInline, Category)\n \n \n class GenericAdminViewTest(TestCase):\n@@ -88,7 +91,7 @@ def testBasicEditPost(self):\n         self.assertEqual(response.status_code, 302) # redirect somewhere\n \n     def testGenericInlineFormset(self):\n-        EpisodeMediaFormSet = generic_inlineformset_factory(Media, can_delete=False, extra=3)\n+        EpisodeMediaFormSet = generic_inlineformset_factory(Media, can_delete=False, exclude=['description', 'keywords'], extra=3)\n         e = Episode.objects.get(name='This Week in Django')\n \n         # Works with no queryset\n@@ -105,7 +108,6 @@ def testGenericInlineFormset(self):\n         self.assertEqual(formset.forms[1].as_p(), '<p><label for=\"id_generic_inline_admin-media-content_type-object_id-1-url\">Url:</label> <input id=\"id_generic_inline_admin-media-content_type-object_id-1-url\" type=\"text\" name=\"generic_inline_admin-media-content_type-object_id-1-url\" value=\"http://example.com/podcast.mp3\" maxlength=\"200\" /><input type=\"hidden\" name=\"generic_inline_admin-media-content_type-object_id-1-id\" value=\"%s\" id=\"id_generic_inline_admin-media-content_type-object_id-1-id\" /></p>' % self.mp3_media_pk)\n         self.assertEqual(formset.forms[2].as_p(), '<p><label for=\"id_generic_inline_admin-media-content_type-object_id-2-url\">Url:</label> <input id=\"id_generic_inline_admin-media-content_type-object_id-2-url\" type=\"text\" name=\"generic_inline_admin-media-content_type-object_id-2-url\" maxlength=\"200\" /><input type=\"hidden\" name=\"generic_inline_admin-media-content_type-object_id-2-id\" id=\"id_generic_inline_admin-media-content_type-object_id-2-id\" /></p>')\n \n-\n         # Works with a queryset that omits items\n         formset = EpisodeMediaFormSet(instance=e, queryset=Media.objects.filter(url__endswith=\".png\"))\n         self.assertEqual(len(formset.forms), 4)\n@@ -173,14 +175,6 @@ def testMaxNumParam(self):\n         self.assertEqual(formset.total_form_count(), 2)\n         self.assertEqual(formset.initial_form_count(), 1)\n \n-    def testExcludeParam(self):\n-        \"\"\"\n-        Generic inline formsets should respect include.\n-        \"\"\"\n-        e = self._create_object(EpisodeExclude)\n-        response = self.client.get('/generic_inline_admin/admin/generic_inline_admin/episodeexclude/%s/' % e.pk)\n-        formset = response.context['inline_admin_formsets'][0].formset\n-        self.assertFalse('url' in formset.forms[0], 'The formset has excluded \"url\" field.')\n \n class GenericInlineAdminWithUniqueTogetherTest(TestCase):\n     fixtures = ['users.xml']\n@@ -218,6 +212,9 @@ def test_no_deletion(self):\n \n class GenericInlineModelAdminTest(TestCase):\n \n+    def setUp(self):\n+        self.site = AdminSite()\n+\n     def test_get_formset_kwargs(self):\n         media_inline = MediaInline(Media, AdminSite())\n \n@@ -230,3 +227,82 @@ def test_get_formset_kwargs(self):\n         formset = media_inline.get_formset(None, max_num=100, can_order=True)\n         self.assertEqual(formset.max_num, 100)\n         self.assertEqual(formset.can_order, True)\n+\n+    def test_custom_form_meta_exclude_with_readonly(self):\n+        \"\"\"\n+        Ensure that the custom ModelForm's `Meta.exclude` is respected when\n+        used in conjunction with `GenericInlineModelAdmin.readonly_fields`\n+        and when no `ModelAdmin.exclude` is defined.\n+        \"\"\"\n+\n+        request = None\n+\n+        class MediaForm(ModelForm):\n+\n+            class Meta:\n+                model = Media\n+                exclude = ['url']\n+\n+        class MediaInline(GenericTabularInline):\n+            readonly_fields = ['description']\n+            form = MediaForm\n+            model = Media\n+\n+        class EpisodeAdmin(admin.ModelAdmin):\n+            inlines = [\n+                MediaInline\n+            ]\n+\n+        ma = EpisodeAdmin(Episode, self.site)\n+        self.assertEqual(\n+            list(ma.get_formsets(request))[0]().forms[0].fields.keys(),\n+            ['keywords', 'id', 'DELETE'])\n+\n+    def test_custom_form_meta_exclude(self):\n+        \"\"\"\n+        Ensure that the custom ModelForm's `Meta.exclude` is respected by\n+        `GenericInlineModelAdmin.get_formset`, and overridden if\n+        `ModelAdmin.exclude` or `GenericInlineModelAdmin.exclude` are defined.\n+        Refs #15907.\n+        \"\"\"\n+\n+        request = None\n+\n+        # First with `GenericInlineModelAdmin`  -----------------\n+\n+        class MediaForm(ModelForm):\n+\n+            class Meta:\n+                model = Media\n+                exclude = ['url']\n+\n+        class MediaInline(GenericTabularInline):\n+            exclude = ['description']\n+            form = MediaForm\n+            model = Media\n+\n+        class EpisodeAdmin(admin.ModelAdmin):\n+            inlines = [\n+                MediaInline\n+            ]\n+\n+        ma = EpisodeAdmin(Episode, self.site)\n+        self.assertEqual(\n+            list(ma.get_formsets(request))[0]().forms[0].fields.keys(),\n+            ['url', 'keywords', 'id', 'DELETE'])\n+\n+        # Then, only with `ModelForm`  -----------------\n+\n+        class MediaInline(GenericTabularInline):\n+            form = MediaForm\n+            model = Media\n+\n+        class EpisodeAdmin(admin.ModelAdmin):\n+            inlines = [\n+                MediaInline\n+            ]\n+\n+        ma = EpisodeAdmin(Episode, self.site)\n+        self.assertEqual(\n+            list(ma.get_formsets(request))[0]().forms[0].fields.keys(),\n+            ['description', 'keywords', 'id', 'DELETE'])"
        },
        {
            "sha": "0adcb15afa29abea08e493ca4c0f5ee6a894bb01",
            "filename": "tests/regressiontests/generic_views/edit.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/386b12c1c668dd54d24704ef974e17b38abb825d/tests%2Fregressiontests%2Fgeneric_views%2Fedit.py",
            "raw_url": "https://github.com/django/django/raw/386b12c1c668dd54d24704ef974e17b38abb825d/tests%2Fregressiontests%2Fgeneric_views%2Fedit.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Fedit.py?ref=386b12c1c668dd54d24704ef974e17b38abb825d",
            "patch": "@@ -10,7 +10,7 @@\n class ModelFormMixinTests(TestCase):\n     def test_get_form(self):\n         form_class = views.AuthorGetQuerySetFormView().get_form_class()\n-        self.assertEqual(form_class.Meta.model, Author)\n+        self.assertEqual(form_class._meta.model, Author)\n \n class CreateViewTests(TestCase):\n     urls = 'regressiontests.generic_views.urls'"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 98,
        "deletions": 26
    }
}