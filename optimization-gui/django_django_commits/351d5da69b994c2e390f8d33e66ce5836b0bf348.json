{
    "author": "jezdez",
    "message": "Fixed #4617 -- Added `raise_exception` option to `permission_required` decorator to be able to raise a PermissionDenied exception instead of redirecting to the login page.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16607 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "351d5da69b994c2e390f8d33e66ce5836b0bf348",
    "files": [
        {
            "sha": "5805a3122c12e16ecaaeaf77d57474beb1776a07",
            "filename": "django/contrib/auth/decorators.py",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/351d5da69b994c2e390f8d33e66ce5836b0bf348/django%2Fcontrib%2Fauth%2Fdecorators.py",
            "raw_url": "https://github.com/django/django/raw/351d5da69b994c2e390f8d33e66ce5836b0bf348/django%2Fcontrib%2Fauth%2Fdecorators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fdecorators.py?ref=351d5da69b994c2e390f8d33e66ce5836b0bf348",
            "patch": "@@ -2,6 +2,7 @@\n from functools import wraps\n from django.conf import settings\n from django.contrib.auth import REDIRECT_FIELD_NAME\n+from django.core.exceptions import PermissionDenied\n from django.utils.decorators import available_attrs\n \n \n@@ -47,9 +48,20 @@ def login_required(function=None, redirect_field_name=REDIRECT_FIELD_NAME, login\n     return actual_decorator\n \n \n-def permission_required(perm, login_url=None):\n+def permission_required(perm, login_url=None, raise_exception=False):\n     \"\"\"\n     Decorator for views that checks whether a user has a particular permission\n-    enabled, redirecting to the log-in page if necessary.\n+    enabled, redirecting to the log-in page if neccesary.\n+    If the raise_exception parameter is given the PermissionDenied exception\n+    is raised.\n     \"\"\"\n-    return user_passes_test(lambda u: u.has_perm(perm), login_url=login_url)\n+    def check_perms(user):\n+        # First check if the user has the permission (even anon users)\n+        if user.has_perm(perm):\n+            return True\n+        # In case the 403 handler should be called raise the exception\n+        if raise_exception:\n+            raise PermissionDenied\n+        # As the last resort, show the login form\n+        return False\n+    return user_passes_test(check_perms, login_url=login_url)"
        },
        {
            "sha": "9df2d11115b80996359af638dc17b8b1049365a7",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/351d5da69b994c2e390f8d33e66ce5836b0bf348/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/351d5da69b994c2e390f8d33e66ce5836b0bf348/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=351d5da69b994c2e390f8d33e66ce5836b0bf348",
            "patch": "@@ -1167,7 +1167,7 @@ checks to make sure the user is logged in and has the permission\n             return HttpResponse(\"You can't vote in this poll.\")\n         # ...\n \n-.. function:: user_passes_test()\n+.. function:: user_passes_test(func, [login_url=None])\n \n     As a shortcut, you can use the convenient ``user_passes_test`` decorator::\n \n@@ -1205,7 +1205,7 @@ checks to make sure the user is logged in and has the permission\n The permission_required decorator\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n \n-.. function:: permission_required()\n+.. function:: permission_required([login_url=None, raise_exception=False])\n \n     It's a relatively common task to check whether a user has a particular\n     permission. For that reason, Django provides a shortcut for that case: the\n@@ -1234,6 +1234,13 @@ The permission_required decorator\n     As in the :func:`~decorators.login_required` decorator, ``login_url``\n     defaults to :setting:`settings.LOGIN_URL <LOGIN_URL>`.\n \n+    .. versionchanged:: 1.4\n+\n+    Added ``raise_exception`` parameter. If given, the decorator will raise\n+    :exc:`~django.core.exceptions.PermissionDenied`, prompting\n+    :ref:`the 403 (HTTP Forbidden) view<http_forbidden_view>` instead of\n+    redirecting to the login page.\n+\n .. currentmodule:: django.contrib.auth\n \n Limiting access to generic views\n@@ -1632,6 +1639,8 @@ the ``auth_permission`` table most of the time.\n \n .. _django/contrib/auth/backends.py: http://code.djangoproject.com/browser/django/trunk/django/contrib/auth/backends.py\n \n+.. _anonymous_auth:\n+\n Authorization for anonymous users\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "e7bb004ff4fe8ea05e37838a0a0e804bd609d409",
            "filename": "tests/modeltests/test_client/models.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/351d5da69b994c2e390f8d33e66ce5836b0bf348/tests%2Fmodeltests%2Ftest_client%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/351d5da69b994c2e390f8d33e66ce5836b0bf348/tests%2Fmodeltests%2Ftest_client%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftest_client%2Fmodels.py?ref=351d5da69b994c2e390f8d33e66ce5836b0bf348",
            "patch": "@@ -370,6 +370,21 @@ def test_view_with_permissions(self):\n \n         # TODO: Log in with right permissions and request the page again\n \n+    def test_view_with_permissions_exception(self):\n+        \"Request a page that is protected with @permission_required but raises a exception\"\n+\n+        # Get the page without logging in. Should result in 403.\n+        response = self.client.get('/test_client/permission_protected_view_exception/')\n+        self.assertEquals(response.status_code, 403)\n+\n+        # Log in\n+        login = self.client.login(username='testclient', password='password')\n+        self.assertTrue(login, 'Could not log in')\n+\n+        # Log in with wrong permissions. Should result in 403.\n+        response = self.client.get('/test_client/permission_protected_view_exception/')\n+        self.assertEquals(response.status_code, 403)\n+\n     def test_view_with_method_permissions(self):\n         \"Request a page that is protected with a @permission_required method\"\n "
        },
        {
            "sha": "66019498e6b65b50b696d8cad3f273878fb0c5db",
            "filename": "tests/modeltests/test_client/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/351d5da69b994c2e390f8d33e66ce5836b0bf348/tests%2Fmodeltests%2Ftest_client%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/351d5da69b994c2e390f8d33e66ce5836b0bf348/tests%2Fmodeltests%2Ftest_client%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftest_client%2Furls.py?ref=351d5da69b994c2e390f8d33e66ce5836b0bf348",
            "patch": "@@ -21,6 +21,7 @@\n     (r'^login_protected_method_view/$', views.login_protected_method_view),\n     (r'^login_protected_view_custom_redirect/$', views.login_protected_view_changed_redirect),\n     (r'^permission_protected_view/$', views.permission_protected_view),\n+    (r'^permission_protected_view_exception/$', views.permission_protected_view_exception),\n     (r'^permission_protected_method_view/$', views.permission_protected_method_view),\n     (r'^session_view/$', views.session_view),\n     (r'^broken_view/$', views.broken_view),"
        },
        {
            "sha": "6f597c091129b24c20df0dab22560805ffda3e86",
            "filename": "tests/modeltests/test_client/views.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/351d5da69b994c2e390f8d33e66ce5836b0bf348/tests%2Fmodeltests%2Ftest_client%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/351d5da69b994c2e390f8d33e66ce5836b0bf348/tests%2Fmodeltests%2Ftest_client%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftest_client%2Fviews.py?ref=351d5da69b994c2e390f8d33e66ce5836b0bf348",
            "patch": "@@ -143,15 +143,16 @@ def login_protected_view_changed_redirect(request):\n     return HttpResponse(t.render(c))\n login_protected_view_changed_redirect = login_required(redirect_field_name=\"redirect_to\")(login_protected_view_changed_redirect)\n \n-def permission_protected_view(request):\n+def _permission_protected_view(request):\n     \"A simple view that is permission protected.\"\n     t = Template('This is a permission protected test. '\n                  'Username is {{ user.username }}. '\n                  'Permissions are {{ user.get_all_permissions }}.' ,\n                  name='Permissions Template')\n     c = Context({'user': request.user})\n     return HttpResponse(t.render(c))\n-permission_protected_view = permission_required('modeltests.test_perm')(permission_protected_view)\n+permission_protected_view = permission_required('modeltests.test_perm')(_permission_protected_view)\n+permission_protected_view_exception = permission_required('modeltests.test_perm', raise_exception=True)(_permission_protected_view)\n \n class _ViewManager(object):\n     @method_decorator(login_required)"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 45,
        "deletions": 7
    }
}