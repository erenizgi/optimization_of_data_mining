{
    "author": "fcurella",
    "message": "Fixed #19152 -- Allowed PostGIS tests to be run without template\n\nFrom version 2, a PostGIS template is no longer required to create\na GIS-enabled database.",
    "sha": "fbd1df8e16fc17a5d73f36136298c20b8ec3d618",
    "files": [
        {
            "sha": "4447b64db80efe8f9db5cd5b1d47b165d085328d",
            "filename": "django/contrib/gis/db/backends/postgis/creation.py",
            "status": "modified",
            "additions": 27,
            "deletions": 2,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/fbd1df8e16fc17a5d73f36136298c20b8ec3d618/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/fbd1df8e16fc17a5d73f36136298c20b8ec3d618/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py?ref=fbd1df8e16fc17a5d73f36136298c20b8ec3d618",
            "patch": "@@ -1,12 +1,23 @@\n from django.conf import settings\n from django.core.exceptions import ImproperlyConfigured\n from django.db.backends.postgresql_psycopg2.creation import DatabaseCreation\n+from django.utils.functional import cached_property\n+\n \n class PostGISCreation(DatabaseCreation):\n     geom_index_type = 'GIST'\n     geom_index_ops = 'GIST_GEOMETRY_OPS'\n     geom_index_ops_nd = 'GIST_GEOMETRY_OPS_ND'\n \n+    @cached_property\n+    def template_postgis(self):\n+        template_postgis = getattr(settings, 'POSTGIS_TEMPLATE', 'template_postgis')\n+        cursor = self.connection.cursor()\n+        cursor.execute('SELECT 1 FROM pg_database WHERE datname = %s LIMIT 1;', (template_postgis,))\n+        if cursor.fetchone():\n+            return template_postgis\n+        return None\n+\n     def sql_indexes_for_field(self, model, f, style):\n         \"Return any spatial index creation SQL for the field.\"\n         from django.contrib.gis.db.models.fields import GeometryField\n@@ -67,5 +78,19 @@ def sql_indexes_for_field(self, model, f, style):\n         return output\n \n     def sql_table_creation_suffix(self):\n-        postgis_template = getattr(settings, 'POSTGIS_TEMPLATE', 'template_postgis')\n-        return ' TEMPLATE %s' % self.connection.ops.quote_name(postgis_template)\n+        if self.template_postgis is not None:\n+            return ' TEMPLATE %s' % (\n+                self.connection.ops.quote_name(self.template_postgis),)\n+        return ''\n+\n+    def _create_test_db(self, verbosity, autoclobber):\n+        test_database_name = super(PostGISCreation, self)._create_test_db(verbosity, autoclobber)\n+        if self.template_postgis is None:\n+            # Connect to the test database in order to create the postgis extension\n+            self.connection.close()\n+            self.connection.settings_dict[\"NAME\"] = test_database_name\n+            cursor = self.connection.cursor()\n+            cursor.execute(\"CREATE EXTENSION postgis\")\n+            cursor.commit()\n+\n+        return test_database_name"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 27,
        "deletions": 2
    }
}