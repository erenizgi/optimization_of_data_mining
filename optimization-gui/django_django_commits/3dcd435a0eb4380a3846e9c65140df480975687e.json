{
    "author": "akaariai",
    "message": "Fixed #19500 -- Solved a regression in join reuse\n\nThe ORM didn't reuse joins for direct foreign key traversals when using\nchained filters. For example:\n    qs.filter(fk__somefield=1).filter(fk__somefield=2))\nproduced two joins.\n\nAs a bonus, reverse onetoone filters can now reuse joins correctly\n\nThe regression was caused by the join() method refactor in commit\n68847135bc9acb2c51c2d36797d0a85395f0cd35\n\nThanks for Simon Charette for spotting some issues with the first draft\nof the patch.",
    "sha": "3dcd435a0eb4380a3846e9c65140df480975687e",
    "files": [
        {
            "sha": "4a12d744521e094372fe0978ac60b6cbc2ec69b0",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -6,7 +6,7 @@\n from django.db.models.constants import LOOKUP_SEP\n from django.db.models.query_utils import select_related_descend\n from django.db.models.sql.constants import (SINGLE, MULTI, ORDER_DIR,\n-        GET_ITERATOR_CHUNK_SIZE, REUSE_ALL, SelectInfo)\n+        GET_ITERATOR_CHUNK_SIZE, SelectInfo)\n from django.db.models.sql.datastructures import EmptyResultSet\n from django.db.models.sql.expressions import SQLEvaluator\n from django.db.models.sql.query import get_order_dir, Query\n@@ -317,7 +317,7 @@ def get_distinct(self):\n \n         for name in self.query.distinct_fields:\n             parts = name.split(LOOKUP_SEP)\n-            field, col, alias, _, _ = self._setup_joins(parts, opts, None)\n+            field, col, alias, _, _ = self._setup_joins(parts, opts)\n             col, alias = self._final_join_removal(col, alias)\n             result.append(\"%s.%s\" % (qn(alias), qn2(col)))\n         return result\n@@ -450,7 +450,7 @@ def _setup_joins(self, pieces, opts, alias):\n         if not alias:\n             alias = self.query.get_initial_alias()\n         field, target, opts, joins, _ = self.query.setup_joins(\n-            pieces, opts, alias, REUSE_ALL)\n+            pieces, opts, alias)\n         # We will later on need to promote those joins that were added to the\n         # query afresh above.\n         joins_to_promote = [j for j in joins if self.query.alias_refcount[j] < 2]\n@@ -688,7 +688,7 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                         int_opts = int_model._meta\n                         alias = self.query.join(\n                             (alias, int_opts.db_table, lhs_col, int_opts.pk.column),\n-                            promote=True,\n+                            promote=True\n                         )\n                         alias_chain.append(alias)\n                 alias = self.query.join("
        },
        {
            "sha": "9f82f426edb2a289e3df3719b1cf2999d868e91d",
            "filename": "django/db/models/sql/constants.py",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fconstants.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fconstants.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fconstants.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -44,6 +44,3 @@\n     'ASC': ('ASC', 'DESC'),\n     'DESC': ('DESC', 'ASC'),\n }\n-\n-# A marker for join-reusability.\n-REUSE_ALL = object()"
        },
        {
            "sha": "a4c1d85c65431f6907ca3c94e74d096719b03b84",
            "filename": "django/db/models/sql/expressions.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -1,10 +1,9 @@\n from django.core.exceptions import FieldError\n from django.db.models.constants import LOOKUP_SEP\n from django.db.models.fields import FieldDoesNotExist\n-from django.db.models.sql.constants import REUSE_ALL\n \n class SQLEvaluator(object):\n-    def __init__(self, expression, query, allow_joins=True, reuse=REUSE_ALL):\n+    def __init__(self, expression, query, allow_joins=True, reuse=None):\n         self.expression = expression\n         self.opts = query.get_meta()\n         self.cols = []\n@@ -54,7 +53,7 @@ def prepare_leaf(self, node, query, allow_joins):\n                     field_list, query.get_meta(),\n                     query.get_initial_alias(), self.reuse)\n                 col, _, join_list = query.trim_joins(source, join_list, path)\n-                if self.reuse is not None and self.reuse != REUSE_ALL:\n+                if self.reuse is not None:\n                     self.reuse.update(join_list)\n                 self.cols.append((node, (join_list[-1], col)))\n             except FieldDoesNotExist:"
        },
        {
            "sha": "a030112e757c5b8394565c5aceb9442b975263ff",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 19,
            "deletions": 20,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -20,7 +20,7 @@\n from django.db.models.loading import get_model\n from django.db.models.sql import aggregates as base_aggregates_module\n from django.db.models.sql.constants import (QUERY_TERMS, ORDER_DIR, SINGLE,\n-        ORDER_PATTERN, REUSE_ALL, JoinInfo, SelectInfo, PathInfo)\n+        ORDER_PATTERN, JoinInfo, SelectInfo, PathInfo)\n from django.db.models.sql.datastructures import EmptyResultSet, Empty, MultiJoin\n from django.db.models.sql.expressions import SQLEvaluator\n from django.db.models.sql.where import (WhereNode, Constraint, EverythingNode,\n@@ -891,7 +891,7 @@ def count_active_tables(self):\n         \"\"\"\n         return len([1 for count in self.alias_refcount.values() if count])\n \n-    def join(self, connection, reuse=REUSE_ALL, promote=False,\n+    def join(self, connection, reuse=None, promote=False,\n              outer_if_first=False, nullable=False, join_field=None):\n         \"\"\"\n         Returns an alias for the join in 'connection', either reusing an\n@@ -902,10 +902,9 @@ def join(self, connection, reuse=REUSE_ALL, promote=False,\n \n             lhs.lhs_col = table.col\n \n-        The 'reuse' parameter can be used in three ways: it can be REUSE_ALL\n-        which means all joins (matching the connection) are reusable, it can\n-        be a set containing the aliases that can be reused, or it can be None\n-        which means a new join is always created.\n+        The 'reuse' parameter can be either None which means all joins\n+        (matching the connection) are reusable, or it can be a set containing\n+        the aliases that can be reused.\n \n         If 'promote' is True, the join type for the alias will be LOUTER (if\n         the alias previously existed, the join type will be promoted from INNER\n@@ -926,10 +925,8 @@ def join(self, connection, reuse=REUSE_ALL, promote=False,\n         \"\"\"\n         lhs, table, lhs_col, col = connection\n         existing = self.join_map.get(connection, ())\n-        if reuse == REUSE_ALL:\n+        if reuse is None:\n             reuse = existing\n-        elif reuse is None:\n-            reuse = set()\n         else:\n             reuse = [a for a in existing if a in reuse]\n         for alias in reuse:\n@@ -1040,7 +1037,7 @@ def add_aggregate(self, aggregate, model, alias, is_summary):\n             # then we need to explore the joins that are required.\n \n             field, source, opts, join_list, path = self.setup_joins(\n-                field_list, opts, self.get_initial_alias(), REUSE_ALL)\n+                field_list, opts, self.get_initial_alias())\n \n             # Process the join chain to see if it can be trimmed\n             col, _, join_list = self.trim_joins(source, join_list, path)\n@@ -1441,7 +1438,7 @@ def names_to_path(self, names, opts, allow_many=False,\n             raise MultiJoin(multijoin_pos + 1)\n         return path, final_field, target\n \n-    def setup_joins(self, names, opts, alias, can_reuse, allow_many=True,\n+    def setup_joins(self, names, opts, alias, can_reuse=None, allow_many=True,\n                     allow_explicit_fk=False):\n         \"\"\"\n         Compute the necessary table joins for the passage through the fields\n@@ -1450,9 +1447,9 @@ def setup_joins(self, names, opts, alias, can_reuse, allow_many=True,\n         the table to start the joining from.\n \n         The 'can_reuse' defines the reverse foreign key joins we can reuse. It\n-        can be sql.constants.REUSE_ALL in which case all joins are reusable\n-        or a set of aliases that can be reused. Note that Non-reverse foreign\n-        keys are always reusable.\n+        can be None in which case all joins are reusable or a set of aliases\n+        that can be reused. Note that non-reverse foreign keys are always\n+        reusable when using setup_joins().\n \n         If 'allow_many' is False, then any reverse foreign key seen will\n         generate a MultiJoin exception.\n@@ -1485,8 +1482,9 @@ def setup_joins(self, names, opts, alias, can_reuse, allow_many=True,\n             else:\n                 nullable = True\n             connection = alias, opts.db_table, from_field.column, to_field.column\n-            alias = self.join(connection, reuse=can_reuse, nullable=nullable,\n-                              join_field=join_field)\n+            reuse = None if direct or to_field.unique else can_reuse\n+            alias = self.join(connection, reuse=reuse,\n+                              nullable=nullable, join_field=join_field)\n             joins.append(alias)\n         return final_field, target, opts, joins, path\n \n@@ -1643,7 +1641,7 @@ def add_fields(self, field_names, allow_m2m=True):\n         try:\n             for name in field_names:\n                 field, target, u2, joins, u3 = self.setup_joins(\n-                        name.split(LOOKUP_SEP), opts, alias, REUSE_ALL, allow_m2m,\n+                        name.split(LOOKUP_SEP), opts, alias, None, allow_m2m,\n                         True)\n                 final_alias = joins[-1]\n                 col = target.column\n@@ -1729,8 +1727,9 @@ def add_count_column(self):\n         else:\n             opts = self.model._meta\n             if not self.select:\n-                count = self.aggregates_module.Count((self.join((None, opts.db_table, None, None)), opts.pk.column),\n-                                         is_summary=True, distinct=True)\n+                count = self.aggregates_module.Count(\n+                    (self.join((None, opts.db_table, None, None)), opts.pk.column),\n+                    is_summary=True, distinct=True)\n             else:\n                 # Because of SQL portability issues, multi-column, distinct\n                 # counts need a sub-query -- see get_count() for details.\n@@ -1934,7 +1933,7 @@ def set_start(self, start):\n         opts = self.model._meta\n         alias = self.get_initial_alias()\n         field, col, opts, joins, extra = self.setup_joins(\n-                start.split(LOOKUP_SEP), opts, alias, REUSE_ALL)\n+                start.split(LOOKUP_SEP), opts, alias)\n         select_col = self.alias_map[joins[1]].lhs_join_col\n         select_alias = alias\n "
        },
        {
            "sha": "607280469772692de047c8a843c973ea44e285de",
            "filename": "django/db/models/sql/subqueries.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -232,7 +232,6 @@ def add_date_select(self, field_name, lookup_type, order='ASC'):\n                 field_name.split(LOOKUP_SEP),\n                 self.get_meta(),\n                 self.get_initial_alias(),\n-                False\n             )\n         except FieldError:\n             raise FieldDoesNotExist(\"%s has no field named '%s'\" % ("
        },
        {
            "sha": "262c2e491798d2115a4b730b39d6cd26dc496edc",
            "filename": "tests/regressiontests/generic_relations_regress/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/tests%2Fregressiontests%2Fgeneric_relations_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/tests%2Fregressiontests%2Fgeneric_relations_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_relations_regress%2Ftests.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -72,5 +72,11 @@ def test_q_object_or(self):\n             Q(notes__note__icontains=r'other note'))\n         self.assertTrue(org_contact in qs)\n \n-\n+    def test_join_reuse(self):\n+        qs = Person.objects.filter(\n+            addresses__street='foo'\n+        ).filter(\n+            addresses__street='bar'\n+        )\n+        self.assertEqual(str(qs.query).count('JOIN'), 2)\n "
        },
        {
            "sha": "92709558771b47c57d03532823a815143c1b6f1a",
            "filename": "tests/regressiontests/queries/tests.py",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/3dcd435a0eb4380a3846e9c65140df480975687e/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3dcd435a0eb4380a3846e9c65140df480975687e/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Ftests.py?ref=3dcd435a0eb4380a3846e9c65140df480975687e",
            "patch": "@@ -2418,3 +2418,36 @@ def test_reverse_trimming(self):\n         qs = Tag.objects.filter(annotation__tag=t.pk)\n         self.assertIn('INNER JOIN', str(qs.query))\n         self.assertEquals(list(qs), [])\n+\n+class JoinReuseTest(TestCase):\n+    \"\"\"\n+    Test that the queries reuse joins sensibly (for example, direct joins\n+    are always reused).\n+    \"\"\"\n+    def test_fk_reuse(self):\n+        qs = Annotation.objects.filter(tag__name='foo').filter(tag__name='bar')\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)\n+\n+    def test_fk_reuse_select_related(self):\n+        qs = Annotation.objects.filter(tag__name='foo').select_related('tag')\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)\n+\n+    def test_fk_reuse_annotation(self):\n+        qs = Annotation.objects.filter(tag__name='foo').annotate(cnt=Count('tag__name'))\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)\n+\n+    def test_fk_reuse_disjunction(self):\n+        qs = Annotation.objects.filter(Q(tag__name='foo') | Q(tag__name='bar'))\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)\n+\n+    def test_fk_reuse_order_by(self):\n+        qs = Annotation.objects.filter(tag__name='foo').order_by('tag__name')\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)\n+\n+    def test_revo2o_reuse(self):\n+        qs = Detail.objects.filter(member__name='foo').filter(member__name='foo')\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)\n+\n+    def test_revfk_noreuse(self):\n+        qs = Author.objects.filter(report__name='r4').filter(report__name='r1')\n+        self.assertEqual(str(qs.query).count('JOIN'), 2)"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 65,
        "deletions": 32
    }
}