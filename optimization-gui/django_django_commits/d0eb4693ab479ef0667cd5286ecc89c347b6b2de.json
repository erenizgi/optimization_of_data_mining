{
    "author": "aaugustin",
    "message": "Fixed #15255 -- Ensured createcachetable honors database routers.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17114 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d0eb4693ab479ef0667cd5286ecc89c347b6b2de",
    "files": [
        {
            "sha": "03ea45da44b37907aea405d8c76a079d9410b9c8",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=d0eb4693ab479ef0667cd5286ecc89c347b6b2de",
            "patch": "@@ -61,9 +61,7 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n-                from django.db import router\n-                if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n-                    call_command('createcachetable', cache._table, database=self.connection.alias)\n+                call_command('createcachetable', cache._table, database=self.connection.alias)\n \n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database."
        },
        {
            "sha": "287a036819b8ec03b4cf3ecfe45d80d7b53098a9",
            "filename": "django/core/management/commands/createcachetable.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "raw_url": "https://github.com/django/django/raw/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py?ref=d0eb4693ab479ef0667cd5286ecc89c347b6b2de",
            "patch": "@@ -1,7 +1,8 @@\n from optparse import make_option\n \n+from django.core.cache.backends.db import BaseDatabaseCache\n from django.core.management.base import LabelCommand\n-from django.db import connections, transaction, models, DEFAULT_DB_ALIAS\n+from django.db import connections, router, transaction, models, DEFAULT_DB_ALIAS\n \n class Command(LabelCommand):\n     help = \"Creates the table needed to use the SQL cache backend.\"\n@@ -18,8 +19,11 @@ class Command(LabelCommand):\n     requires_model_validation = False\n \n     def handle_label(self, tablename, **options):\n-        alias = options.get('database')\n-        connection = connections[alias]\n+        db = options.get('database', DEFAULT_DB_ALIAS)\n+        cache = BaseDatabaseCache(tablename, {})\n+        if not router.allow_syncdb(db, cache.cache_model_class):\n+            return\n+        connection = connections[db]\n         fields = (\n             # \"key\" is a reserved word in MySQL, so use \"cache_key\" instead.\n             models.CharField(name='cache_key', max_length=255, unique=True, primary_key=True),\n@@ -50,4 +54,4 @@ def handle_label(self, tablename, **options):\n         curs.execute(\"\\n\".join(full_statement))\n         for statement in index_output:\n             curs.execute(statement)\n-        transaction.commit_unless_managed(using=alias)\n+        transaction.commit_unless_managed(using=db)"
        },
        {
            "sha": "ce1da6d4c4c96c949cb45da47549a2b55af1fea5",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=d0eb4693ab479ef0667cd5286ecc89c347b6b2de",
            "patch": "@@ -255,9 +255,7 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n-                from django.db import router\n-                if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n-                    call_command('createcachetable', cache._table, database=self.connection.alias)\n+                call_command('createcachetable', cache._table, database=self.connection.alias)\n \n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database."
        },
        {
            "sha": "5f9676beb60b77ac83cf65bc5750430aff130c43",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d0eb4693ab479ef0667cd5286ecc89c347b6b2de/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=d0eb4693ab479ef0667cd5286ecc89c347b6b2de",
            "patch": "@@ -16,6 +16,7 @@\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n from django.core.cache.backends.base import (CacheKeyWarning,\n     InvalidCacheBackendError)\n+from django.db import router\n from django.http import HttpResponse, HttpRequest, QueryDict\n from django.middleware.cache import (FetchFromCacheMiddleware,\n     UpdateCacheMiddleware, CacheMiddleware)\n@@ -775,6 +776,44 @@ def test_old_initialization(self):\n         self.perform_cull_test(50, 18)\n \n \n+class DBCacheRouter(object):\n+    \"\"\"A router that puts the cache table on the 'other' database.\"\"\"\n+\n+    def db_for_read(self, model, **hints):\n+        if model._meta.app_label == 'django_cache':\n+            return 'other'\n+\n+    def db_for_write(self, model, **hints):\n+        if model._meta.app_label == 'django_cache':\n+            return 'other'\n+\n+    def allow_syncdb(self, db, model):\n+        if model._meta.app_label == 'django_cache':\n+            return db == 'other'\n+\n+\n+class CreateCacheTableForDBCacheTests(TestCase):\n+    multi_db = True\n+\n+    def test_createcachetable_observes_database_router(self):\n+        old_routers = router.routers\n+        try:\n+            router.routers = [DBCacheRouter()]\n+            # cache table should not be created on 'default'\n+            with self.assertNumQueries(0, using='default'):\n+                management.call_command('createcachetable', 'cache_table',\n+                                        database='default',\n+                                        verbosity=0, interactive=False)\n+            # cache table should be created on 'other'\n+            # one query is used to create the table and another one the index\n+            with self.assertNumQueries(2, using='other'):\n+                management.call_command('createcachetable', 'cache_table',\n+                                        database='other',\n+                                        verbosity=0, interactive=False)\n+        finally:\n+            router.routers = old_routers\n+\n+\n class LocMemCacheTests(unittest.TestCase, BaseCacheTests):\n     backend_name = 'django.core.cache.backends.locmem.LocMemCache'\n "
        }
    ],
    "stats": {
        "total": 59,
        "additions": 49,
        "deletions": 10
    }
}