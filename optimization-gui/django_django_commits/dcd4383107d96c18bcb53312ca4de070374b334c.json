{
    "author": "aaugustin",
    "message": "Fixed #9893 -- Validated the length of file names\n\nafter the full file name is generated by the storage class.\n\nThanks Refefer for the report, carsongee for the patch, and\neveryone else involved in the discussion.",
    "sha": "dcd4383107d96c18bcb53312ca4de070374b334c",
    "files": [
        {
            "sha": "34cf84dbc0a7fa0acd0c412ada25cb91b40a7562",
            "filename": "django/db/models/fields/files.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/dcd4383107d96c18bcb53312ca4de070374b334c/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py",
            "raw_url": "https://github.com/django/django/raw/dcd4383107d96c18bcb53312ca4de070374b334c/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Ffiles.py?ref=dcd4383107d96c18bcb53312ca4de070374b334c",
            "patch": "@@ -3,6 +3,7 @@\n \n from django import forms\n from django.db.models.fields import Field\n+from django.core.exceptions import ValidationError\n from django.core.files.base import File\n from django.core.files.storage import default_storage\n from django.core.files.images import ImageFile\n@@ -204,6 +205,11 @@ def __set__(self, instance, value):\n         instance.__dict__[self.field.name] = value\n \n class FileField(Field):\n+\n+    default_error_messages = {\n+        'max_length': _(u'Filename is %(extra)d characters too long.')\n+    }\n+\n     # The class to wrap instance attributes in. Accessing the file object off\n     # the instance will always return an instance of attr_class.\n     attr_class = FieldFile\n@@ -226,6 +232,21 @@ def __init__(self, verbose_name=None, name=None, upload_to='', storage=None, **k\n         kwargs['max_length'] = kwargs.get('max_length', 100)\n         super(FileField, self).__init__(verbose_name, name, **kwargs)\n \n+    def validate(self, value, model_instance):\n+        \"\"\"\n+        Validates that the generated file name still fits within max_length.\n+        \"\"\"\n+        # The generated file name stored in the database is generally longer\n+        # than the uploaded file name. Using the length of generated name in\n+        # the error message would be confusing. However, in the common case\n+        # (ie. upload_to='path/to/upload/dir'), the length of the generated\n+        # name equals the length of the uploaded name plus a constant. Thus\n+        # we can tell the user how much shorter the name should be (roughly).\n+        length = len(self.generate_filename(model_instance, value.name))\n+        if self.max_length and length > self.max_length:\n+            error_values = {'extra': length - self.max_length}\n+            raise ValidationError(self.error_messages['max_length'] % error_values)\n+\n     def get_internal_type(self):\n         return \"FileField\"\n "
        },
        {
            "sha": "4b48616e99808a44390db30ce4a0603da25cfb69",
            "filename": "tests/regressiontests/model_fields/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/dcd4383107d96c18bcb53312ca4de070374b334c/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dcd4383107d96c18bcb53312ca4de070374b334c/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py?ref=dcd4383107d96c18bcb53312ca4de070374b334c",
            "patch": "@@ -365,3 +365,15 @@ def test_changed(self):\n         field = d._meta.get_field('myfile')\n         field.save_form_data(d, 'else.txt')\n         self.assertEqual(d.myfile, 'else.txt')\n+\n+    def test_max_length(self):\n+        \"\"\"\n+        Test that FileField validates the length of the generated file name\n+        that will be stored in the database. Regression for #9893.\n+\n+        \"\"\"\n+        # upload_to = 'unused', so file names are saved as 'unused/xxxxx'.\n+        # max_length = 100, so names longer than 93 characters are rejected.\n+        Document(myfile=93 * 'x').full_clean()\n+        with self.assertRaises(ValidationError):\n+            Document(myfile=94 * 'x').full_clean()"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 33,
        "deletions": 0
    }
}