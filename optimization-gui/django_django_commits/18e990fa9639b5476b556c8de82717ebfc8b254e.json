{
    "author": "claudep",
    "message": "Fixed #16110 -- Fixed GeometryField odd behaviour regarding null values\n\nThanks slinkp for the report and the initial patch.",
    "sha": "18e990fa9639b5476b556c8de82717ebfc8b254e",
    "files": [
        {
            "sha": "249617f771a58d7a3c4b80c3ce4bd3137b1f6487",
            "filename": "django/contrib/gis/db/models/fields.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/18e990fa9639b5476b556c8de82717ebfc8b254e/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/18e990fa9639b5476b556c8de82717ebfc8b254e/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Ffields.py?ref=18e990fa9639b5476b556c8de82717ebfc8b254e",
            "patch": "@@ -202,7 +202,6 @@ def db_type(self, connection):\n \n     def formfield(self, **kwargs):\n         defaults = {'form_class' : forms.GeometryField,\n-                    'null' : self.null,\n                     'geom_type' : self.geom_type,\n                     'srid' : self.srid,\n                     }"
        },
        {
            "sha": "d3feac83e70a6fa52fade29f5279a8a31ed98bae",
            "filename": "django/contrib/gis/forms/fields.py",
            "status": "modified",
            "additions": 12,
            "deletions": 11,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/18e990fa9639b5476b556c8de82717ebfc8b254e/django%2Fcontrib%2Fgis%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/18e990fa9639b5476b556c8de82717ebfc8b254e/django%2Fcontrib%2Fgis%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fforms%2Ffields.py?ref=18e990fa9639b5476b556c8de82717ebfc8b254e",
            "patch": "@@ -1,5 +1,7 @@\n from __future__ import unicode_literals\n \n+import warnings\n+\n from django import forms\n from django.utils import six\n from django.utils.translation import ugettext_lazy as _\n@@ -18,7 +20,7 @@ class GeometryField(forms.Field):\n     widget = forms.Textarea\n \n     default_error_messages = {\n-        'no_geom' : _('No geometry value provided.'),\n+        'required' : _('No geometry value provided.'),\n         'invalid_geom' : _('Invalid geometry value.'),\n         'invalid_geom_type' : _('Invalid geometry type.'),\n         'transform_error' : _('An error occurred when transforming the geometry '\n@@ -30,13 +32,18 @@ def __init__(self, **kwargs):\n         # defaults (e.g., allow None).\n         self.srid = kwargs.pop('srid', None)\n         self.geom_type = kwargs.pop('geom_type', 'GEOMETRY')\n-        self.null = kwargs.pop('null', True)\n+        if 'null' in kwargs:\n+            kwargs.pop('null', True)\n+            warnings.warn(\"Passing 'null' keyword argument to GeometryField is deprecated.\",\n+                DeprecationWarning, stacklevel=2)\n         super(GeometryField, self).__init__(**kwargs)\n \n     def to_python(self, value):\n         \"\"\"\n         Transforms the value to a Geometry object.\n         \"\"\"\n+        if value in self.empty_values:\n+            return None\n         try:\n             return GEOSGeometry(value)\n         except (GEOSException, ValueError, TypeError):\n@@ -48,15 +55,9 @@ def clean(self, value):\n         object (which is returned).  A ValidationError is raised if\n         the value cannot be instantiated as a Geometry.\n         \"\"\"\n-        if not value:\n-            if self.null and not self.required:\n-                # The geometry column allows NULL and is not required.\n-                return None\n-            else:\n-                raise forms.ValidationError(self.error_messages['no_geom'])\n-\n-        # Transform the value to a python object first\n-        geom = self.to_python(value)\n+        geom = super(GeometryField, self).clean(value)\n+        if geom is None:\n+            return geom\n \n         # Ensuring that the geometry is of the correct type (indicated\n         # using the OGC string label)."
        },
        {
            "sha": "24bb50c6bc93630f22b9a1f34d53ea8047a28c33",
            "filename": "django/contrib/gis/tests/test_geoforms.py",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/18e990fa9639b5476b556c8de82717ebfc8b254e/django%2Fcontrib%2Fgis%2Ftests%2Ftest_geoforms.py",
            "raw_url": "https://github.com/django/django/raw/18e990fa9639b5476b556c8de82717ebfc8b254e/django%2Fcontrib%2Fgis%2Ftests%2Ftest_geoforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Ftest_geoforms.py?ref=18e990fa9639b5476b556c8de82717ebfc8b254e",
            "patch": "@@ -1,6 +1,7 @@\n from django.forms import ValidationError\n from django.contrib.gis.gdal import HAS_GDAL\n from django.contrib.gis.tests.utils import HAS_SPATIALREFSYS\n+from django.utils import six\n from django.utils import unittest\n \n \n@@ -37,15 +38,13 @@ def test02_null(self):\n         \"Testing GeometryField's handling of null (None) geometries.\"\n         # Form fields, by default, are required (`required=True`)\n         fld = forms.GeometryField()\n-        self.assertRaises(forms.ValidationError, fld.clean, None)\n-\n-        # Still not allowed if `null=False`.\n-        fld = forms.GeometryField(required=False, null=False)\n-        self.assertRaises(forms.ValidationError, fld.clean, None)\n+        with six.assertRaisesRegex(self, forms.ValidationError,\n+                \"No geometry value provided.\"):\n+            fld.clean(None)\n \n         # This will clean None as a geometry (See #10660).\n         fld = forms.GeometryField(required=False)\n-        self.assertEqual(None, fld.clean(None))\n+        self.assertIsNone(fld.clean(None))\n \n     def test03_geom_type(self):\n         \"Testing GeometryField's handling of different geometry types.\""
        }
    ],
    "stats": {
        "total": 35,
        "additions": 17,
        "deletions": 18
    }
}