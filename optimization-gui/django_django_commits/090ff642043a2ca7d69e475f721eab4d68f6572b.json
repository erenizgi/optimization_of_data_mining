{
    "author": "freakboy3742",
    "message": "Fixed #15181 -- Ensure that special characters are escaped when querying for the URL of an uploaded file. Thanks to e.generalov for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15409 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "090ff642043a2ca7d69e475f721eab4d68f6572b",
    "files": [
        {
            "sha": "14e3b657b2025df8787490d40c9061038d3efe34",
            "filename": "django/core/files/storage.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/090ff642043a2ca7d69e475f721eab4d68f6572b/django%2Fcore%2Ffiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/090ff642043a2ca7d69e475f721eab4d68f6572b/django%2Fcore%2Ffiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fstorage.py?ref=090ff642043a2ca7d69e475f721eab4d68f6572b",
            "patch": "@@ -8,7 +8,7 @@\n from django.core.exceptions import ImproperlyConfigured, SuspiciousOperation\n from django.core.files import locks, File\n from django.core.files.move import file_move_safe\n-from django.utils.encoding import force_unicode\n+from django.utils.encoding import force_unicode, filepath_to_uri\n from django.utils.functional import LazyObject\n from django.utils.importlib import import_module\n from django.utils.text import get_valid_filename\n@@ -240,7 +240,7 @@ def size(self, name):\n     def url(self, name):\n         if self.base_url is None:\n             raise ValueError(\"This file is not accessible via a URL.\")\n-        return urlparse.urljoin(self.base_url, name).replace('\\\\', '/')\n+        return urlparse.urljoin(self.base_url, filepath_to_uri(name))\n \n     def accessed_time(self, name):\n         return datetime.fromtimestamp(os.path.getatime(self.path(name)))"
        },
        {
            "sha": "96d915a4335350826088ff06ad7ec77a52d279ae",
            "filename": "django/utils/encoding.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/090ff642043a2ca7d69e475f721eab4d68f6572b/django%2Futils%2Fencoding.py",
            "raw_url": "https://github.com/django/django/raw/090ff642043a2ca7d69e475f721eab4d68f6572b/django%2Futils%2Fencoding.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fencoding.py?ref=090ff642043a2ca7d69e475f721eab4d68f6572b",
            "patch": "@@ -156,6 +156,24 @@ def iri_to_uri(iri):\n         return iri\n     return urllib.quote(smart_str(iri), safe=\"/#%[]=:;$&()+,!?*@'~\")\n \n+def filepath_to_uri(path):\n+    \"\"\"Convert an file system path to a URI portion that is suitable for\n+    inclusion in a URL.\n+\n+    We are assuming input is either UTF-8 or unicode already.\n+\n+    This method will encode certain chars that would normally be recognized as\n+    special chars for URIs.  Note that this method does not encode the '\n+    character, as it is a valid character within URIs.  See\n+    encodeURIComponent() JavaScript function for more details.\n+\n+    Returns an ASCII string containing the encoded result.\n+    \"\"\"\n+    if path is None:\n+        return path\n+    # I know about `os.sep` and `os.altsep` but I want to leave\n+    # some flexibility for hardcoding separators.\n+    return urllib.quote(smart_str(path).replace(\"\\\\\", \"/\"), safe=\"/~!*()'\")\n \n # The encoding of the default system locale but falls back to the\n # given fallback encoding if the encoding is unsupported by python or could"
        },
        {
            "sha": "a4f118f2df757dcc24177a2f061a1c1daa724919",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/090ff642043a2ca7d69e475f721eab4d68f6572b/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/090ff642043a2ca7d69e475f721eab4d68f6572b/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=090ff642043a2ca7d69e475f721eab4d68f6572b",
            "patch": "@@ -204,6 +204,15 @@ def test_file_url(self):\n         self.assertEqual(self.storage.url('test.file'),\n             '%s%s' % (self.storage.base_url, 'test.file'))\n \n+        # should encode special chars except ~!*()'\n+        # like encodeURIComponent() JavaScript function do\n+        self.assertEqual(self.storage.url(r\"\"\"~!*()'@#$%^&*abc`+=.file\"\"\"),\n+            \"\"\"/test_media_url/~!*()'%40%23%24%25%5E%26*abc%60%2B%3D.file\"\"\")\n+\n+        # should stanslate os path separator(s) to the url path separator\n+        self.assertEqual(self.storage.url(\"\"\"a/b\\\\c.file\"\"\"),\n+            \"\"\"/test_media_url/a/b/c.file\"\"\")\n+\n         self.storage.base_url = None\n         self.assertRaises(ValueError, self.storage.url, 'test.file')\n "
        }
    ],
    "stats": {
        "total": 31,
        "additions": 29,
        "deletions": 2
    }
}