{
    "author": "kmtracey",
    "message": "Fix #17879: Corrected regression in python (inherited by yaml and json) serializer that prevented serializing model instances with null FK ref to a model when serializing with natural keys. Thanks danfairs and tmitchell.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17685 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "20c69c5e51f1ca180978a51d64246b70f778df83",
    "files": [
        {
            "sha": "82f77585f3504383cf9e6e5893eb1bff0de5d52d",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/20c69c5e51f1ca180978a51d64246b70f778df83/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/20c69c5e51f1ca180978a51d64246b70f778df83/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=20c69c5e51f1ca180978a51d64246b70f778df83",
            "patch": "@@ -369,6 +369,7 @@ answer newbie questions, and generally made Django that much better:\n     Slawek Mikula <slawek dot mikula at gmail dot com>\n     Shawn Milochik <shawn@milochik.com>\n     mitakummaa@gmail.com\n+    Taylor Mitchell <taylor.mitchell@gmail.com>\n     mmarshall\n     Andreas Mock <andreas.mock@web.de>\n     Reza Mohammadi <reza@zeerak.ir>"
        },
        {
            "sha": "195bf11d2464201125bda55be8084f06667823fc",
            "filename": "django/core/serializers/python.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/20c69c5e51f1ca180978a51d64246b70f778df83/django%2Fcore%2Fserializers%2Fpython.py",
            "raw_url": "https://github.com/django/django/raw/20c69c5e51f1ca180978a51d64246b70f778df83/django%2Fcore%2Fserializers%2Fpython.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fserializers%2Fpython.py?ref=20c69c5e51f1ca180978a51d64246b70f778df83",
            "patch": "@@ -47,7 +47,10 @@ def handle_field(self, obj, field):\n     def handle_fk_field(self, obj, field):\n         if self.use_natural_keys and hasattr(field.rel.to, 'natural_key'):\n             related = getattr(obj, field.name)\n-            value = related.natural_key()\n+            if related:\n+                value = related.natural_key()\n+            else:\n+                value = None\n         else:\n             value = getattr(obj, field.get_attname())\n         self._current[field.name] = value"
        },
        {
            "sha": "52223e72d880f0b9e26ef53bb5737a63c51199bf",
            "filename": "tests/regressiontests/serializers_regress/models.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/20c69c5e51f1ca180978a51d64246b70f778df83/tests%2Fregressiontests%2Fserializers_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/20c69c5e51f1ca180978a51d64246b70f778df83/tests%2Fregressiontests%2Fserializers_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fserializers_regress%2Fmodels.py?ref=20c69c5e51f1ca180978a51d64246b70f778df83",
            "patch": "@@ -111,6 +111,18 @@ class Anchor(models.Model):\n     class Meta:\n         ordering = ('id',)\n \n+class NaturalKeyAnchorManager(models.Manager):\n+    def get_by_natural_key(self, data):\n+        return self.get(data=data)\n+\n+class NaturalKeyAnchor(models.Model):\n+    objects = NaturalKeyAnchorManager()\n+\n+    data = models.CharField(max_length=100, unique=True)\n+\n+    def natural_key(self):\n+        return (self.data,)\n+\n class UniqueAnchor(models.Model):\n     \"\"\"This is a model that can be used as\n     something for other models to point at\"\"\"\n@@ -120,6 +132,9 @@ class UniqueAnchor(models.Model):\n class FKData(models.Model):\n     data = models.ForeignKey(Anchor, null=True)\n \n+class FKDataNaturalKey(models.Model):\n+    data = models.ForeignKey(NaturalKeyAnchor, null=True)\n+\n class M2MData(models.Model):\n     data = models.ManyToManyField(Anchor, null=True)\n \n@@ -272,3 +287,4 @@ class LengthModel(models.Model):\n \n     def __len__(self):\n         return self.data\n+"
        },
        {
            "sha": "65194da42813a0147fd7f2c482a6cd0a44482813",
            "filename": "tests/regressiontests/serializers_regress/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/20c69c5e51f1ca180978a51d64246b70f778df83/tests%2Fregressiontests%2Fserializers_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/20c69c5e51f1ca180978a51d64246b70f778df83/tests%2Fregressiontests%2Fserializers_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fserializers_regress%2Ftests.py?ref=20c69c5e51f1ca180978a51d64246b70f778df83",
            "patch": "@@ -42,7 +42,8 @@\n     PositiveSmallIntegerPKData, SlugPKData, SmallPKData, USStatePKData,\n     AutoNowDateTimeData, ModifyingSaveData, InheritAbstractModel, BaseModel,\n     ExplicitInheritBaseModel, InheritBaseModel, ProxyBaseModel,\n-    ProxyProxyBaseModel, BigIntegerData, LengthModel, Tag, ComplexModel)\n+    ProxyProxyBaseModel, BigIntegerData, LengthModel, Tag, ComplexModel,\n+    NaturalKeyAnchor, FKDataNaturalKey)\n \n # A set of functions that can be used to recreate\n # test data objects of various kinds.\n@@ -353,6 +354,12 @@ def inherited_compare(testcase, pk, klass, data):\n     (data_obj, 1005, LengthModel, 1),\n ]\n \n+natural_key_test_data = [\n+    (data_obj, 1100, NaturalKeyAnchor, \"Natural Key Anghor\"),\n+    (fk_obj, 1101, FKDataNaturalKey, 1100),\n+    (fk_obj, 1102, FKDataNaturalKey, None),\n+]\n+\n # Because Oracle treats the empty string as NULL, Oracle is expected to fail\n # when field.empty_strings_allowed is True and the value is None; skip these\n # tests.\n@@ -452,6 +459,35 @@ def serializerTest(format, self):\n     for klass, count in instance_count.items():\n         self.assertEqual(count, klass.objects.count())\n \n+def naturalKeySerializerTest(format, self):\n+    # Create all the objects defined in the test data\n+    objects = []\n+    instance_count = {}\n+    for (func, pk, klass, datum) in natural_key_test_data:\n+        with connection.constraint_checks_disabled():\n+            objects.extend(func[0](pk, klass, datum))\n+\n+    # Get a count of the number of objects created for each class\n+    for klass in instance_count:\n+        instance_count[klass] = klass.objects.count()\n+\n+    # Serialize the test database\n+    serialized_data = serializers.serialize(format, objects, indent=2,\n+        use_natural_keys=True)\n+\n+    for obj in serializers.deserialize(format, serialized_data):\n+        obj.save()\n+\n+    # Assert that the deserialized data is the same\n+    # as the original source\n+    for (func, pk, klass, datum) in natural_key_test_data:\n+        func[1](self, pk, klass, datum)\n+\n+    # Assert that the number of objects deserialized is the\n+    # same as the number that was serialized.\n+    for klass, count in instance_count.items():\n+        self.assertEqual(count, klass.objects.count())\n+\n def fieldsTest(format, self):\n     obj = ComplexModel(field1='first', field2='second', field3='third')\n     obj.save_base(raw=True)\n@@ -482,6 +518,8 @@ def streamTest(format, self):\n \n for format in serializers.get_serializer_formats():\n     setattr(SerializerTests, 'test_' + format + '_serializer', curry(serializerTest, format))\n+    setattr(SerializerTests, 'test_' + format + '_natural_key_serializer', curry(naturalKeySerializerTest, format))\n     setattr(SerializerTests, 'test_' + format + '_serializer_fields', curry(fieldsTest, format))\n     if format != 'python':\n         setattr(SerializerTests, 'test_' + format + '_serializer_stream', curry(streamTest, format))\n+"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 60,
        "deletions": 2
    }
}