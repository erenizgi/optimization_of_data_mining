{
    "author": "claudep",
    "message": "Fixed #19088 -- Always escape % inside blocktrans tag\n\nThanks vlinhart for the report and ≈Åukasz Rekucki for the patch.",
    "sha": "9fd2f9c5f3c008f524874fd7cf78237e65bf567e",
    "files": [
        {
            "sha": "5576beb4a31bcd067aade77446c0acef337da982",
            "filename": "django/templatetags/i18n.py",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/9fd2f9c5f3c008f524874fd7cf78237e65bf567e/django%2Ftemplatetags%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/9fd2f9c5f3c008f524874fd7cf78237e65bf567e/django%2Ftemplatetags%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fi18n.py?ref=9fd2f9c5f3c008f524874fd7cf78237e65bf567e",
            "patch": "@@ -110,13 +110,13 @@ def render_token_list(self, tokens):\n         vars = []\n         for token in tokens:\n             if token.token_type == TOKEN_TEXT:\n-                result.append(token.contents)\n+                result.append(token.contents.replace('%', '%%'))\n             elif token.token_type == TOKEN_VAR:\n                 result.append('%%(%s)s' % token.contents)\n                 vars.append(token.contents)\n         return ''.join(result), vars\n \n-    def render(self, context):\n+    def render(self, context, nested=False):\n         if self.message_context:\n             message_context = self.message_context.resolve(context)\n         else:\n@@ -128,13 +128,10 @@ def render(self, context):\n         # the end of function\n         context.update(tmp_context)\n         singular, vars = self.render_token_list(self.singular)\n-        # Escape all isolated '%'\n-        singular = re.sub('%(?!\\()', '%%', singular)\n         if self.plural and self.countervar and self.counter:\n             count = self.counter.resolve(context)\n             context[self.countervar] = count\n             plural, plural_vars = self.render_token_list(self.plural)\n-            plural = re.sub('%(?!\\()', '%%', plural)\n             if message_context:\n                 result = translation.npgettext(message_context, singular,\n                                                plural, count)\n@@ -151,8 +148,12 @@ def render(self, context):\n         try:\n             result = result % data\n         except (KeyError, ValueError):\n+            if nested:\n+                # Either string is malformed, or it's a bug\n+                raise TemplateSyntaxError(\"'blocktrans' is unable to format \"\n+                    \"string returned by gettext: %r using %r\" % (result, data))\n             with translation.override(None):\n-                result = self.render(context)\n+                result = self.render(context, nested=True)\n         return result\n \n "
        },
        {
            "sha": "4054f85ef044758b1d8ad3bc351ce26dc8104282",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/9fd2f9c5f3c008f524874fd7cf78237e65bf567e/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9fd2f9c5f3c008f524874fd7cf78237e65bf567e/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=9fd2f9c5f3c008f524874fd7cf78237e65bf567e",
            "patch": "@@ -269,7 +269,6 @@ def test_bad_placeholder_1(self):\n         (%(person)s is translated as %(personne)s in fr.po)\n         Refs #16516.\n         \"\"\"\n-        from django.template import Template, Context\n         with translation.override('fr'):\n             t = Template('{% load i18n %}{% blocktrans %}My name is {{ person }}.{% endblocktrans %}')\n             rendered = t.render(Context({'person': 'James'}))\n@@ -282,7 +281,6 @@ def test_bad_placeholder_2(self):\n         (%(person) misses a 's' in fr.po, causing the string formatting to fail)\n         Refs #18393.\n         \"\"\"\n-        from django.template import Template, Context\n         with translation.override('fr'):\n             t = Template('{% load i18n %}{% blocktrans %}My other name is {{ person }}.{% endblocktrans %}')\n             rendered = t.render(Context({'person': 'James'}))\n@@ -821,6 +819,20 @@ def test_percent_in_translatable_block(self):\n             self.assertEqual(t_plur.render(Context({'percent': 42, 'num': 1})), '42% stellt 1 Objekt dar')\n             self.assertEqual(t_plur.render(Context({'percent': 42, 'num': 4})), '42% stellt 4 Objekte dar')\n \n+    @override_settings(LOCALE_PATHS=extended_locale_paths)\n+    def test_percent_formatting_in_blocktrans(self):\n+        \"\"\"\n+        Test that using Python's %-formatting is properly escaped in blocktrans,\n+        singular or plural\n+        \"\"\"\n+        t_sing = Template(\"{% load i18n %}{% blocktrans %}There are %(num_comments)s comments{% endblocktrans %}\")\n+        t_plur = Template(\"{% load i18n %}{% blocktrans count num as number %}%(percent)s% represents {{ num }} object{% plural %}%(percent)s% represents {{ num }} objects{% endblocktrans %}\")\n+        with translation.override('de'):\n+            # Strings won't get translated as they don't match after escaping %\n+            self.assertEqual(t_sing.render(Context({'num_comments': 42})), 'There are %(num_comments)s comments')\n+            self.assertEqual(t_plur.render(Context({'percent': 42, 'num': 1})), '%(percent)s% represents 1 object')\n+            self.assertEqual(t_plur.render(Context({'percent': 42, 'num': 4})), '%(percent)s% represents 4 objects')\n+\n \n class ResolutionOrderI18NTests(TestCase):\n "
        }
    ],
    "stats": {
        "total": 29,
        "additions": 21,
        "deletions": 8
    }
}