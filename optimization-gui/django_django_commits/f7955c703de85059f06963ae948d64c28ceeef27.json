{
    "author": "andrewgodwin",
    "message": "All tests passing on MySQL",
    "sha": "f7955c703de85059f06963ae948d64c28ceeef27",
    "files": [
        {
            "sha": "48d69050925af9d9c761f35c1f8372edb415fb2e",
            "filename": "django/db/backends/mysql/introspection.py",
            "status": "modified",
            "additions": 36,
            "deletions": 26,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/f7955c703de85059f06963ae948d64c28ceeef27/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py",
            "raw_url": "https://github.com/django/django/raw/f7955c703de85059f06963ae948d64c28ceeef27/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py?ref=f7955c703de85059f06963ae948d64c28ceeef27",
            "patch": "@@ -105,32 +105,42 @@ def get_indexes(self, cursor, table_name):\n     def get_constraints(self, cursor, table_name):\n         \"\"\"\n         Retrieves any constraints (unique, pk, fk, check) across one or more columns.\n-        Returns {'cnname': {'columns': set(columns), 'primary_key': bool, 'unique': bool}}\n+        Returns {'cnname': {'columns': set(columns), 'primary_key': bool, 'unique': bool, 'foreign_key': None|(tbl, col)}}\n         \"\"\"\n         constraints = {}\n-        # Loop over the constraint tables, collecting things as constraints\n-        ifsc_tables = [\"constraint_column_usage\", \"key_column_usage\"]\n-        for ifsc_table in ifsc_tables:\n-            cursor.execute(\"\"\"\n-                SELECT kc.constraint_name, kc.column_name, c.constraint_type\n-                FROM information_schema.%s AS kc\n-                JOIN information_schema.table_constraints AS c ON\n-                    kc.table_schema = c.table_schema AND\n-                    kc.table_name = c.table_name AND\n-                    kc.constraint_name = c.constraint_name\n-                WHERE\n-                    kc.table_schema = %%s AND\n-                    kc.table_name = %%s\n-            \"\"\" % ifsc_table, [self.connection.settings_dict['NAME'], table_name])\n-            for constraint, column, kind in cursor.fetchall():\n-                # If we're the first column, make the record\n-                if constraint not in constraints:\n-                    constraints[constraint] = {\n-                        \"columns\": set(),\n-                        \"primary_key\": kind.lower() == \"primary key\",\n-                        \"foreign_key\": kind.lower() == \"foreign key\",\n-                        \"unique\": kind.lower() in [\"primary key\", \"unique\"],\n-                    }\n-                # Record the details\n-                constraints[constraint]['columns'].add(column)\n+        # Get the actual constraint names and columns\n+        name_query = \"\"\"\n+            SELECT kc.`constraint_name`, kc.`column_name`,\n+                kc.`referenced_table_name`, kc.`referenced_column_name`\n+            FROM information_schema.key_column_usage AS kc\n+            WHERE\n+                kc.table_schema = %s AND\n+                kc.table_name = %s\n+        \"\"\"\n+        cursor.execute(name_query, [self.connection.settings_dict['NAME'], table_name])\n+        for constraint, column, ref_table, ref_column in cursor.fetchall():\n+            if constraint not in constraints:\n+                constraints[constraint] = {\n+                    'columns': set(),\n+                    'primary_key': False,\n+                    'unique': False,\n+                    'foreign_key': (ref_table, ref_column) if ref_column else None,\n+                }\n+            constraints[constraint]['columns'].add(column)\n+        # Now get the constraint types\n+        type_query = \"\"\"\n+            SELECT c.constraint_name, c.constraint_type\n+            FROM information_schema.table_constraints AS c\n+            WHERE\n+                c.table_schema = %s AND\n+                c.table_name = %s\n+        \"\"\"\n+        cursor.execute(type_query, [self.connection.settings_dict['NAME'], table_name])\n+        for constraint, kind in cursor.fetchall():\n+            if kind.lower() == \"primary key\":\n+                constraints[constraint]['primary_key'] = True\n+                constraints[constraint]['unique'] = True\n+            elif kind.lower() == \"unique\":\n+                constraints[constraint]['unique'] = True\n+        # Return\n         return constraints"
        },
        {
            "sha": "efc469d9fb7352a461fb9df010e312ee2d0f0c0d",
            "filename": "django/db/backends/mysql/schema.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/f7955c703de85059f06963ae948d64c28ceeef27/django%2Fdb%2Fbackends%2Fmysql%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/f7955c703de85059f06963ae948d64c28ceeef27/django%2Fdb%2Fbackends%2Fmysql%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fschema.py?ref=f7955c703de85059f06963ae948d64c28ceeef27",
            "patch": "@@ -7,6 +7,8 @@ class DatabaseSchemaEditor(BaseDatabaseSchemaEditor):\n \n     sql_alter_column_null = \"MODIFY %(column)s %(type)s NULL\"\n     sql_alter_column_not_null = \"MODIFY %(column)s %(type)s NULL\"\n+    sql_alter_column_type = \"MODIFY %(column)s %(type)s\"\n+    sql_rename_column = \"ALTER TABLE %(table)s CHANGE %(old_column)s %(new_column)s %(type)s\"\n \n     sql_delete_unique = \"ALTER TABLE %(table)s DROP INDEX %(name)s\"\n \n@@ -17,8 +19,5 @@ class DatabaseSchemaEditor(BaseDatabaseSchemaEditor):\n \n     sql_delete_pk = \"ALTER TABLE %(table)s DROP PRIMARY KEY\"\n \n-\n-\n-\n     alter_string_set_null = 'MODIFY %(column)s %(type)s NULL;'\n     alter_string_drop_null = 'MODIFY %(column)s %(type)s NOT NULL;'"
        },
        {
            "sha": "788be3be35bd4977f06026f168e537f40e5909db",
            "filename": "django/db/backends/schema.py",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/f7955c703de85059f06963ae948d64c28ceeef27/django%2Fdb%2Fbackends%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/f7955c703de85059f06963ae948d64c28ceeef27/django%2Fdb%2Fbackends%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fschema.py?ref=f7955c703de85059f06963ae948d64c28ceeef27",
            "patch": "@@ -25,6 +25,7 @@ class BaseDatabaseSchemaEditor(object):\n         - Repointing of M2Ms\n         - Check constraints (PosIntField)\n         - PK changing\n+        - db_index on alter field\n     \"\"\"\n \n     # Overrideable SQL templates\n@@ -358,7 +359,7 @@ def alter_field(self, model, old_field, new_field):\n         \"\"\"\n         # Ensure this field is even column-based\n         old_type = old_field.db_type(connection=self.connection)\n-        new_type = new_field.db_type(connection=self.connection)\n+        new_type = self._type_for_alter(new_field)\n         if old_type is None and new_type is None:\n             # TODO: Handle M2M fields being repointed\n             return\n@@ -389,6 +390,7 @@ def alter_field(self, model, old_field, new_field):\n                 \"table\": self.quote_name(model._meta.db_table),\n                 \"old_column\": self.quote_name(old_field.column),\n                 \"new_column\": self.quote_name(new_field.column),\n+                \"type\": new_type,\n             })\n         # Next, start accumulating actions to do\n         actions = []\n@@ -426,13 +428,15 @@ def alter_field(self, model, old_field, new_field):\n                 actions.append((\n                     self.sql_alter_column_null % {\n                         \"column\": self.quote_name(new_field.column),\n+                        \"type\": new_type,\n                     },\n                     [],\n                 ))\n             else:\n                 actions.append((\n                     self.sql_alter_column_null % {\n                         \"column\": self.quote_name(new_field.column),\n+                        \"type\": new_type,\n                     },\n                     [],\n                 ))\n@@ -460,6 +464,14 @@ def alter_field(self, model, old_field, new_field):\n                 }\n             )\n \n+    def _type_for_alter(self, field):\n+        \"\"\"\n+        Returns a field's type suitable for ALTER COLUMN.\n+        By default it just returns field.db_type().\n+        To be overriden by backend specific subclasses\n+        \"\"\"\n+        return field.db_type(connection=self.connection)\n+\n     def _create_index_name(self, model, column_names, suffix=\"\"):\n         \"Generates a unique name for an index/unique constraint.\"\n         # If there is just one column in the index, use a default algorithm from Django"
        },
        {
            "sha": "70311382804f81a5df0074933e96d234d35d8b3e",
            "filename": "tests/modeltests/schema/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/f7955c703de85059f06963ae948d64c28ceeef27/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f7955c703de85059f06963ae948d64c28ceeef27/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Ftests.py?ref=f7955c703de85059f06963ae948d64c28ceeef27",
            "patch": "@@ -39,6 +39,7 @@ def tearDown(self):\n         connection.rollback()\n         # Delete any tables made for our models\n         cursor = connection.cursor()\n+        connection.disable_constraint_checking()\n         for model in self.models:\n             # Remove any M2M tables first\n             for field in model._meta.local_many_to_many:\n@@ -59,6 +60,7 @@ def tearDown(self):\n                 connection.rollback()\n             else:\n                 connection.commit()\n+        connection.enable_constraint_checking()\n         # Unhook our models\n         for model in self.models:\n             model._meta.managed = False"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 53,
        "deletions": 30
    }
}