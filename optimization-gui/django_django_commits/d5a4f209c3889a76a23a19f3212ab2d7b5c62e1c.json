{
    "author": "akaariai",
    "message": "Fixed #18991 -- Allowed permission lookup by \"if in\"\n\nWhen looking permissions from PermWrapper it is now possible to use\n{% if \"someapp.someperm\" in perms %} instead of\n{% if perms.someapp.someperm %}.",
    "sha": "d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
    "files": [
        {
            "sha": "5929505359c1053e0f971e39bbe3f3001caf1d7b",
            "filename": "django/contrib/auth/context_processors.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fcontext_processors.py?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -32,6 +32,17 @@ def __iter__(self):\n         # I am large, I contain multitudes.\n         raise TypeError(\"PermWrapper is not iterable.\")\n \n+    def __contains__(self, perm_name):\n+        \"\"\"\n+        Lookup by \"someapp\" or \"someapp.someperm\" in perms.\n+        \"\"\"\n+        if '.' not in perm_name:\n+            # The name refers to module.\n+            return bool(self[perm_name])\n+        module_name, perm_name = perm_name.split('.', 1)\n+        return self[module_name][perm_name]\n+\n+\n def auth(request):\n     \"\"\"\n     Returns context variables required by apps that use Django's authentication"
        },
        {
            "sha": "32fea8ac80fae73d9ceda897ee8568c429fff22d",
            "filename": "django/contrib/auth/tests/context_processors.py",
            "status": "modified",
            "additions": 34,
            "deletions": 7,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcontext_processors.py?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -3,20 +3,22 @@\n from django.conf import global_settings\n from django.contrib.auth import authenticate\n from django.contrib.auth.tests.utils import skipIfCustomUser\n+from django.contrib.auth.models import User, Permission\n+from django.contrib.contenttypes.models import ContentType\n from django.contrib.auth.context_processors import PermWrapper, PermLookupDict\n from django.db.models import Q\n from django.test import TestCase\n from django.test.utils import override_settings\n \n \n class MockUser(object):\n-    def has_module_perm(self, perm):\n-        if perm == 'mockapp.someapp':\n+    def has_module_perms(self, perm):\n+        if perm == 'mockapp':\n             return True\n         return False\n \n     def has_perm(self, perm):\n-        if perm == 'someperm':\n+        if perm == 'mockapp.someperm':\n             return True\n         return False\n \n@@ -40,13 +42,19 @@ def __eq__(self, other):\n \n     def test_permwrapper_in(self):\n         \"\"\"\n-        Test that 'something' in PermWrapper doesn't end up in endless loop.\n+        Test that 'something' in PermWrapper works as expected.\n         \"\"\"\n         perms = PermWrapper(MockUser())\n-        with self.assertRaises(TypeError):\n-            self.EQLimiterObject() in perms\n+        # Works for modules and full permissions.\n+        self.assertTrue('mockapp' in perms)\n+        self.assertFalse('nonexisting' in perms)\n+        self.assertTrue('mockapp.someperm' in perms)\n+        self.assertFalse('mockapp.nonexisting' in perms)\n \n     def test_permlookupdict_in(self):\n+        \"\"\"\n+        No endless loops if accessed with 'in' - refs #18979.\n+        \"\"\"\n         pldict = PermLookupDict(MockUser(), 'mockapp')\n         with self.assertRaises(TypeError):\n             self.EQLimiterObject() in pldict\n@@ -92,9 +100,28 @@ def test_session_is_accessed(self):\n         self.assertContains(response, \"Session accessed\")\n \n     def test_perms_attrs(self):\n-        self.client.login(username='super', password='secret')\n+        u = User.objects.create_user(username='normal', password='secret')\n+        u.user_permissions.add(\n+            Permission.objects.get(\n+                content_type=ContentType.objects.get_for_model(Permission),\n+                codename='add_permission'))\n+        self.client.login(username='normal', password='secret')\n         response = self.client.get('/auth_processor_perms/')\n         self.assertContains(response, \"Has auth permissions\")\n+        self.assertContains(response, \"Has auth.add_permission permissions\")\n+        self.assertNotContains(response, \"nonexisting\")\n+    \n+    def test_perm_in_perms_attrs(self):\n+        u = User.objects.create_user(username='normal', password='secret')\n+        u.user_permissions.add(\n+            Permission.objects.get(\n+                content_type=ContentType.objects.get_for_model(Permission),\n+                codename='add_permission'))\n+        self.client.login(username='normal', password='secret')\n+        response = self.client.get('/auth_processor_perm_in_perms/')\n+        self.assertContains(response, \"Has auth permissions\")\n+        self.assertContains(response, \"Has auth.add_permission permissions\")\n+        self.assertNotContains(response, \"nonexisting\")\n \n     def test_message_attrs(self):\n         self.client.login(username='super', password='secret')"
        },
        {
            "sha": "3a18cd7405f329bad7edbe680698c3d87da04075",
            "filename": "django/contrib/auth/tests/templates/context_processors/auth_attrs_perm_in_perms.html",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Ftemplates%2Fcontext_processors%2Fauth_attrs_perm_in_perms.html",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Ftemplates%2Fcontext_processors%2Fauth_attrs_perm_in_perms.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Ftemplates%2Fcontext_processors%2Fauth_attrs_perm_in_perms.html?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -0,0 +1,4 @@\n+{% if 'auth' in perms %}Has auth permissions{% endif %}\n+{% if 'auth.add_permission' in perms %}Has auth.add_permission permissions{% endif %}\n+{% if 'nonexisting' in perms %}nonexisting perm found{% endif %}\n+{% if 'auth.nonexisting' in perms %}auth.nonexisting perm found{% endif %}"
        },
        {
            "sha": "6f441afc10b855d2ecec252abf7a485679e2c9ce",
            "filename": "django/contrib/auth/tests/templates/context_processors/auth_attrs_perms.html",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Ftemplates%2Fcontext_processors%2Fauth_attrs_perms.html",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Ftemplates%2Fcontext_processors%2Fauth_attrs_perms.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Ftemplates%2Fcontext_processors%2Fauth_attrs_perms.html?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -1 +1,4 @@\n {% if perms.auth %}Has auth permissions{% endif %}\n+{% if perms.auth.add_permission %}Has auth.add_permission permissions{% endif %}\n+{% if perms.nonexisting %}nonexisting perm found{% endif %}\n+{% if perms.auth.nonexisting in perms %}auth.nonexisting perm found{% endif %}"
        },
        {
            "sha": "8f9e848aa952947af9f3ae670ad6deb263477879",
            "filename": "django/contrib/auth/tests/urls.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/django%2Fcontrib%2Fauth%2Ftests%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Furls.py?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -37,6 +37,10 @@ def auth_processor_perms(request):\n     return render_to_response('context_processors/auth_attrs_perms.html',\n         RequestContext(request, {}, processors=[context_processors.auth]))\n \n+def auth_processor_perm_in_perms(request):\n+    return render_to_response('context_processors/auth_attrs_perm_in_perms.html',\n+        RequestContext(request, {}, processors=[context_processors.auth]))\n+\n def auth_processor_messages(request):\n     info(request, \"Message 1\")\n     return render_to_response('context_processors/auth_attrs_messages.html',\n@@ -58,6 +62,7 @@ def userpage(request):\n     (r'^auth_processor_attr_access/$', auth_processor_attr_access),\n     (r'^auth_processor_user/$', auth_processor_user),\n     (r'^auth_processor_perms/$', auth_processor_perms),\n+    (r'^auth_processor_perm_in_perms/$', auth_processor_perm_in_perms),\n     (r'^auth_processor_messages/$', auth_processor_messages),\n     url(r'^userpage/(.+)/$', userpage, name=\"userpage\"),\n )"
        },
        {
            "sha": "c39592122bcc2a9ba0ff001b18c4ca0ae6bcd69e",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -180,6 +180,10 @@ Django 1.5 also includes several smaller improvements worth noting:\n   and inversion, expanding the types of expressions that can be passed to the\n   database.\n \n+* When using :class:`~django.template.RequestContext`, it is now possible to\n+  look up permissions by using ``{% if 'someapp.someperm' in perms %}``\n+  in templates.\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        },
        {
            "sha": "0a19f5ed5ac0b2813d2b96eb233ed3efe9f94932",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=d5a4f209c3889a76a23a19f3212ab2d7b5c62e1c",
            "patch": "@@ -1710,6 +1710,20 @@ Thus, you can check permissions in template ``{% if %}`` statements:\n         <p>You don't have permission to do anything in the foo app.</p>\n     {% endif %}\n \n+.. versionadded:: 1.5\n+    Permission lookup by \"if in\".\n+\n+It is possible to also look permissions up by ``{% if in %}`` statements.\n+For example:\n+\n+.. code-block:: html+django\n+\n+    {% if 'foo' in perms %}\n+        {% if 'foo.can_vote' in perms %}\n+            <p>In lookup works, too.</p>\n+        {% endif %}\n+    {% endif %}\n+\n Groups\n ======\n "
        }
    ],
    "stats": {
        "total": 82,
        "additions": 75,
        "deletions": 7
    }
}