{
    "author": "aaugustin",
    "message": "Fixed #18984 -- Avoided a deadlock in test teardown.\n\nThanks Jeremy Dunck for the report.",
    "sha": "891c5306242760c8bb494412b9f8f86762664427",
    "files": [
        {
            "sha": "0f76e11c1a684465ce35a7692b5a264dae492982",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/891c5306242760c8bb494412b9f8f86762664427/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/891c5306242760c8bb494412b9f8f86762664427/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=891c5306242760c8bb494412b9f8f86762664427",
            "patch": "@@ -505,6 +505,12 @@ def _fixture_teardown(self):\n         # If the test case has a multi_db=True flag, flush all databases.\n         # Otherwise, just flush default.\n         databases = connections if getattr(self, 'multi_db', False) else [DEFAULT_DB_ALIAS]\n+\n+        # Roll back any pending transactions in order to avoid a deadlock\n+        # during flush when TEST_MIRROR is used (#18984).\n+        for conn in connections.all():\n+            conn.rollback_unless_managed()\n+\n         for db in databases:\n             call_command('flush', verbosity=0, interactive=False, database=db,\n                          skip_validation=True, reset_sequences=False)"
        }
    ],
    "stats": {
        "total": 6,
        "additions": 6,
        "deletions": 0
    }
}