{
    "author": "aaugustin",
    "message": "Fixed #13222 -- Made HttpResponse iterable once\n\nresponse.content can be accessed many times as desired, and always\nreturns the same result.\n\niter(response) works only once and consumes the iterator.",
    "sha": "82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0",
    "files": [
        {
            "sha": "6bbadd7e2b368755a8758a0e593947166b9f902c",
            "filename": "django/http/response.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0/django%2Fhttp%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0/django%2Fhttp%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2Fresponse.py?ref=82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0",
            "patch": "@@ -283,7 +283,8 @@ def __iter__(self):\n                 'deprecated. Use `StreamingHttpResponse` instead '\n                 'if you need the streaming behavior.',\n                 PendingDeprecationWarning, stacklevel=2)\n-        self._iterator = iter(self._container)\n+        if not hasattr(self, '_iterator'):\n+            self._iterator = iter(self._container)\n         return self\n \n     def __next__(self):\n@@ -303,7 +304,7 @@ def write(self, content):\n \n     def tell(self):\n         self._consume_content()\n-        return sum(len(chunk) for chunk in self)\n+        return len(self.content)\n \n \n class StreamingHttpResponse(HttpResponseBase):"
        },
        {
            "sha": "1239275264b43a41fa0fadc0fa868b89ece078bd",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0",
            "patch": "@@ -596,7 +596,11 @@ def assertContains(self, response, text, count=None, status_code=200,\n             msg_prefix + \"Couldn't retrieve content: Response code was %d\"\n             \" (expected %d)\" % (response.status_code, status_code))\n         text = force_text(text, encoding=response._charset)\n-        content = b''.join(response).decode(response._charset)\n+        if response.streaming:\n+            content = b''.join(response.streaming_content)\n+        else:\n+            content = response.content\n+        content = content.decode(response._charset)\n         # Avoid ResourceWarning about unclosed files.\n         response.close()\n         if html:"
        },
        {
            "sha": "8e20c80de31a5203fd67cf34ed6dab67059308b4",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=82b3e6ffcb9d810cc0e3ec27d25f89ce1fd525e0",
            "patch": "@@ -337,15 +337,36 @@ def test_iter_content(self):\n         self.assertRaises(UnicodeEncodeError,\n                           getattr, r, 'content')\n \n-        # content can safely be accessed multiple times.\n+        # .content can safely be accessed multiple times.\n         r = HttpResponse(iter(['hello', 'world']))\n         self.assertEqual(r.content, r.content)\n         self.assertEqual(r.content, b'helloworld')\n+        # accessing the iterator works (once) after accessing .content\n+        self.assertEqual(b''.join(r), b'helloworld')\n+        self.assertEqual(b''.join(r), b'')\n+        # accessing .content still works\n+        self.assertEqual(r.content, b'helloworld')\n+\n+        # XXX accessing .content doesn't work if the response was iterated first\n+        # XXX change this when the deprecation completes in HttpResponse\n+        r = HttpResponse(iter(['hello', 'world']))\n+        with warnings.catch_warnings():\n+            warnings.simplefilter(\"ignore\", PendingDeprecationWarning)\n+            self.assertEqual(b''.join(r), b'helloworld')\n+        self.assertEqual(r.content, b'')                # not the expected result!\n \n         # additional content can be written to the response.\n+        r = HttpResponse(iter(['hello', 'world']))\n+        self.assertEqual(r.content, b'helloworld')\n         r.write('!')\n         self.assertEqual(r.content, b'helloworld!')\n \n+    def test_iterator_isnt_rewound(self):\n+        # Regression test for #13222\n+        r = HttpResponse('abc')\n+        i = iter(r)\n+        self.assertEqual(list(i), [b'abc'])\n+        self.assertEqual(list(i), [])\n \n     def test_file_interface(self):\n         r = HttpResponse()"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}