{
    "author": "andrewgodwin",
    "message": "Fix app loading/test interaction",
    "sha": "dbf8b93c527733fb5e3ea101a67bd94db745888e",
    "files": [
        {
            "sha": "6f7a50dcf853a3183d10c1c81090b52ec5eaaf1b",
            "filename": "django/db/models/loading.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/dbf8b93c527733fb5e3ea101a67bd94db745888e/django%2Fdb%2Fmodels%2Floading.py",
            "raw_url": "https://github.com/django/django/raw/dbf8b93c527733fb5e3ea101a67bd94db745888e/django%2Fdb%2Fmodels%2Floading.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Floading.py?ref=dbf8b93c527733fb5e3ea101a67bd94db745888e",
            "patch": "@@ -251,7 +251,7 @@ def save_state(self):\n         \"\"\"\n         return {\n             \"app_store\": SortedDict(self.app_store.items()),\n-            \"app_labels\": dict(self.app_errors.items()),\n+            \"app_labels\": dict(self.app_labels.items()),\n             \"app_models\": SortedDict(self.app_models.items()),\n             \"app_errors\": dict(self.app_errors.items()),\n         }\n@@ -264,6 +264,7 @@ def restore_state(self, state):\n         self.app_labels = state['app_labels']\n         self.app_models = state['app_models']\n         self.app_errors = state['app_errors']\n+        self._get_models_cache.clear()\n \n     def temporary_state(self):\n         \"Returns a context manager that restores the state on exit\""
        },
        {
            "sha": "fdc3cf38ce721e50992f0b382b3137d10df8f055",
            "filename": "tests/modeltests/schema/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 10,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/dbf8b93c527733fb5e3ea101a67bd94db745888e/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dbf8b93c527733fb5e3ea101a67bd94db745888e/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Ftests.py?ref=dbf8b93c527733fb5e3ea101a67bd94db745888e",
            "patch": "@@ -7,7 +7,7 @@\n from django.db.models.fields import IntegerField, TextField, CharField, SlugField\n from django.db.models.fields.related import ManyToManyField, ForeignKey\n from django.db.models.loading import cache\n-from .models import Author, Book, BookWithSlug, BookWithM2M, AuthorWithM2M, Tag, TagUniqueRename, UniqueTest\n+from .models import Author, AuthorWithM2M, Book, BookWithSlug, BookWithM2M, Tag, TagUniqueRename, UniqueTest\n \n \n class SchemaTests(TestCase):\n@@ -19,7 +19,7 @@ class SchemaTests(TestCase):\n     as the code it is testing.\n     \"\"\"\n \n-    models = [Author, Book, BookWithSlug, BookWithM2M, AuthorWithM2M, Tag, TagUniqueRename, UniqueTest]\n+    models = [Author, AuthorWithM2M, Book, BookWithSlug, BookWithM2M, Tag, TagUniqueRename, UniqueTest]\n \n     # Utility functions\n \n@@ -30,15 +30,25 @@ def setUp(self):\n         connection.managed(True)\n         # The unmanaged models need to be removed after the test in order to\n         # prevent bad interactions with the flush operation in other tests.\n-        self.old_app_models = copy.deepcopy(cache.app_models)\n-        self.old_app_store = copy.deepcopy(cache.app_store)\n+        self.cache_state = cache.save_state()\n+        cache.load_app(\"modeltests.schema\")\n         for model in self.models:\n             model._meta.managed = True\n \n     def tearDown(self):\n         # Rollback anything that may have happened\n         connection.rollback()\n         # Delete any tables made for our models\n+        self.delete_tables()\n+        # Unhook our models\n+        for model in self.models:\n+            model._meta.managed = False\n+        if \"schema\" in self.cache_state['app_labels']:\n+            del self.cache_state['app_labels']['schema']\n+        cache.restore_state(self.cache_state)\n+\n+    def delete_tables(self):\n+        \"Deletes all model tables for our models for a clean test environment\"\n         cursor = connection.cursor()\n         connection.disable_constraint_checking()\n         for model in self.models:\n@@ -62,12 +72,6 @@ def tearDown(self):\n             else:\n                 connection.commit()\n         connection.enable_constraint_checking()\n-        # Unhook our models\n-        for model in self.models:\n-            model._meta.managed = False\n-        cache.app_models = self.old_app_models\n-        cache.app_store = self.old_app_store\n-        cache._get_models_cache = {}\n \n     def column_classes(self, model):\n         cursor = connection.cursor()"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 16,
        "deletions": 11
    }
}