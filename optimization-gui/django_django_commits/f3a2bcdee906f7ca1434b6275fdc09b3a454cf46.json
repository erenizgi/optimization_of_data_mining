{
    "author": "spookylukey",
    "message": "Fixed #15040 - Boolean fields return 0 and 1 when loaded through select_related\n\nThanks to homm for the report and ramiro for the patch.",
    "sha": "f3a2bcdee906f7ca1434b6275fdc09b3a454cf46",
    "files": [
        {
            "sha": "b9095e503ae109791c611604e30c75b8fc7cff01",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/f3a2bcdee906f7ca1434b6275fdc09b3a454cf46/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/f3a2bcdee906f7ca1434b6275fdc09b3a454cf46/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=f3a2bcdee906f7ca1434b6275fdc09b3a454cf46",
            "patch": "@@ -774,10 +774,20 @@ def results_iter(self):\n                         # We only set this up here because\n                         # related_select_fields isn't populated until\n                         # execute_sql() has been called.\n+\n+                        # We also include types of fields of related models that\n+                        # will be included via select_related() for the benefit\n+                        # of MySQL/MySQLdb when boolean fields are involved\n+                        # (#15040).\n+\n+                        # This code duplicates the logic for the order of fields\n+                        # found in get_columns(). It would be nice to clean this up.\n                         if self.query.select_fields:\n-                            fields = self.query.select_fields + self.query.related_select_fields\n+                            fields = self.query.select_fields\n                         else:\n                             fields = self.query.model._meta.fields\n+                        fields = fields + self.query.related_select_fields\n+\n                         # If the field was deferred, exclude it from being passed\n                         # into `resolve_columns` because it wasn't selected.\n                         only_load = self.deferred_to_columns()"
        },
        {
            "sha": "1d20f44fae51bddd98f2ae12eeabbb0cb30a791f",
            "filename": "tests/regressiontests/model_fields/models.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/f3a2bcdee906f7ca1434b6275fdc09b3a454cf46/tests%2Fregressiontests%2Fmodel_fields%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f3a2bcdee906f7ca1434b6275fdc09b3a454cf46/tests%2Fregressiontests%2Fmodel_fields%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Fmodels.py?ref=f3a2bcdee906f7ca1434b6275fdc09b3a454cf46",
            "patch": "@@ -66,6 +66,11 @@ class BooleanModel(models.Model):\n     bfield = models.BooleanField()\n     string = models.CharField(max_length=10, default='abc')\n \n+class FksToBooleans(models.Model):\n+    \"\"\"Model wih FKs to models with {Null,}BooleanField's, #15040\"\"\"\n+    bf = models.ForeignKey(BooleanModel)\n+    nbf = models.ForeignKey(NullBooleanModel)\n+\n class RenamedField(models.Model):\n     modelname = models.IntegerField(name=\"fieldname\", choices=((1,'One'),))\n "
        },
        {
            "sha": "a49894e36ceadc8c0508435acf5ec4d745138dd5",
            "filename": "tests/regressiontests/model_fields/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/f3a2bcdee906f7ca1434b6275fdc09b3a454cf46/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f3a2bcdee906f7ca1434b6275fdc09b3a454cf46/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_fields%2Ftests.py?ref=f3a2bcdee906f7ca1434b6275fdc09b3a454cf46",
            "patch": "@@ -12,7 +12,8 @@\n from django.utils import unittest\n \n from .models import (Foo, Bar, Whiz, BigD, BigS, Image, BigInt, Post,\n-    NullBooleanModel, BooleanModel, Document, RenamedField, VerboseNameField)\n+    NullBooleanModel, BooleanModel, Document, RenamedField, VerboseNameField,\n+    FksToBooleans)\n \n from .imagefield import (ImageFieldTests, ImageFieldTwoDimensionsTests,\n     TwoImageFieldTests, ImageFieldNoDimensionsTests,\n@@ -218,6 +219,43 @@ def test_return_type(self):\n             select={'string_col': 'string'})[0]\n         self.assertFalse(isinstance(b5.pk, bool))\n \n+    def test_select_related(self):\n+        \"\"\"\n+        Test type of boolean fields when retrieved via select_related() (MySQL,\n+        #15040)\n+        \"\"\"\n+        bmt = BooleanModel.objects.create(bfield=True)\n+        bmf = BooleanModel.objects.create(bfield=False)\n+        nbmt = NullBooleanModel.objects.create(nbfield=True)\n+        nbmf = NullBooleanModel.objects.create(nbfield=False)\n+\n+        m1 = FksToBooleans.objects.create(bf=bmt, nbf=nbmt)\n+        m2 = FksToBooleans.objects.create(bf=bmf, nbf=nbmf)\n+\n+        # Test select_related('fk_field_name')\n+        ma = FksToBooleans.objects.select_related('bf').get(pk=m1.id)\n+        # verify types -- should't be 0/1\n+        self.assertIsInstance(ma.bf.bfield, bool)\n+        self.assertIsInstance(ma.nbf.nbfield, bool)\n+        # verify values\n+        self.assertEqual(ma.bf.bfield, True)\n+        self.assertEqual(ma.nbf.nbfield, True)\n+\n+        # Test select_related()\n+        mb = FksToBooleans.objects.select_related().get(pk=m1.id)\n+        mc = FksToBooleans.objects.select_related().get(pk=m2.id)\n+        # verify types -- shouldn't be 0/1\n+        self.assertIsInstance(mb.bf.bfield, bool)\n+        self.assertIsInstance(mb.nbf.nbfield, bool)\n+        self.assertIsInstance(mc.bf.bfield, bool)\n+        self.assertIsInstance(mc.nbf.nbfield, bool)\n+        # verify values\n+        self.assertEqual(mb.bf.bfield, True)\n+        self.assertEqual(mb.nbf.nbfield, True)\n+        self.assertEqual(mc.bf.bfield, False)\n+        self.assertEqual(mc.nbf.nbfield, False)\n+\n+\n class ChoicesTests(test.TestCase):\n     def test_choices_and_field_display(self):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 57,
        "additions": 55,
        "deletions": 2
    }
}