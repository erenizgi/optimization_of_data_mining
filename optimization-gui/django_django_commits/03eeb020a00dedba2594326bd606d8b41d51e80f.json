{
    "author": "jezdez",
    "message": "Fixed #159 -- Prevent the `AdminSite` from logging users out when they try to log in form the logout page. Many thanks, ashchristopher.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17465 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "03eeb020a00dedba2594326bd606d8b41d51e80f",
    "files": [
        {
            "sha": "4bb6440877326216faf976701357df9af4810b2e",
            "filename": "django/contrib/admin/sites.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/03eeb020a00dedba2594326bd606d8b41d51e80f/django%2Fcontrib%2Fadmin%2Fsites.py",
            "raw_url": "https://github.com/django/django/raw/03eeb020a00dedba2594326bd606d8b41d51e80f/django%2Fcontrib%2Fadmin%2Fsites.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fsites.py?ref=03eeb020a00dedba2594326bd606d8b41d51e80f",
            "patch": "@@ -1,5 +1,5 @@\n from functools import update_wrapper\n-from django import http\n+from django.http import Http404, HttpResponseRedirect\n from django.contrib.admin import ModelAdmin, actions\n from django.contrib.admin.forms import AdminAuthenticationForm\n from django.contrib.auth import REDIRECT_FIELD_NAME\n@@ -188,6 +188,10 @@ def get_urls(self):\n         \"\"\"\n         def inner(request, *args, **kwargs):\n             if not self.has_permission(request):\n+                if request.path == reverse('admin:logout',\n+                                           current_app=self.name):\n+                    index_path = reverse('admin:index', current_app=self.name)\n+                    return HttpResponseRedirect(index_path)\n                 return self.login(request)\n             return view(request, *args, **kwargs)\n         if not cacheable:\n@@ -421,7 +425,7 @@ def app_index(self, request, app_label, extra_context=None):\n                                 'models': [model_dict],\n                             }\n         if not app_dict:\n-            raise http.Http404('The requested admin page does not exist.')\n+            raise Http404('The requested admin page does not exist.')\n         # Sort the models alphabetically within each app.\n         app_dict['models'].sort(key=lambda x: x['name'])\n         context = {"
        },
        {
            "sha": "6b001e97ab84196d2ff556c25f7ece5d7bbbf325",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/03eeb020a00dedba2594326bd606d8b41d51e80f/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/03eeb020a00dedba2594326bd606d8b41d51e80f/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=03eeb020a00dedba2594326bd606d8b41d51e80f",
            "patch": "@@ -3385,3 +3385,31 @@ def test_should_be_able_to_edit_related_objects_on_changelist_view(self):\n \n         self.assertEqual('Josh Stone', Parent.objects.latest('id').name)\n         self.assertEqual([u'Catherine Stone', u'Paul Stone'], children_names)\n+\n+\n+class AdminViewLogoutTest(TestCase):\n+    urls = \"regressiontests.admin_views.urls\"\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def tearDown(self):\n+        self.client.logout()\n+\n+    def test_client_logout_url_can_be_used_to_login(self):\n+        response = self.client.get('/test_admin/admin/logout/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.template_name, 'registration/logged_out.html')\n+        self.assertEqual(response.request['PATH_INFO'], '/test_admin/admin/logout/')\n+\n+        # we are now logged out\n+        response = self.client.get('/test_admin/admin/logout/')\n+        self.assertEqual(response.status_code, 302)  # we should be redirected to the login page.\n+\n+        # follow the redirect and test results.\n+        response = self.client.get('/test_admin/admin/logout/', follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.template_name, 'admin/login.html')\n+        self.assertEqual(response.request['PATH_INFO'], '/test_admin/admin/')\n+        self.assertContains(response, '<input type=\"hidden\" name=\"next\" value=\"/test_admin/admin/\" />')"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 34,
        "deletions": 2
    }
}