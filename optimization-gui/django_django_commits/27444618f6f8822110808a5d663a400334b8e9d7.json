{
    "author": "aaugustin",
    "message": "Fixed #15789 -- Set the decimal precisio to avoid an exception in the floatformat filter, and added a few more tests. Thanks akaihola for the report, igalarzab for the patch and ptone for the review.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17297 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "27444618f6f8822110808a5d663a400334b8e9d7",
    "files": [
        {
            "sha": "4530adf7c5be6a325e357a8ff18fa82963d0f8fc",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/27444618f6f8822110808a5d663a400334b8e9d7/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/27444618f6f8822110808a5d663a400334b8e9d7/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=27444618f6f8822110808a5d663a400334b8e9d7",
            "patch": "@@ -3,7 +3,7 @@\n import re\n import random as random_module\n import unicodedata\n-from decimal import Decimal, InvalidOperation, ROUND_HALF_UP\n+from decimal import Decimal, InvalidOperation, Context, ROUND_HALF_UP\n from functools import wraps\n from pprint import pformat\n \n@@ -166,9 +166,15 @@ def floatformat(text, arg=-1):\n     else:\n         exp = Decimal(u'1.0') / (Decimal(10) ** abs(p))\n     try:\n+        # Set the precision high enough to avoid an exception, see #15789.\n+        tupl = d.as_tuple()\n+        units = len(tupl[1]) - tupl[2]\n+        prec = abs(arg) + units + 1\n+\n         # Avoid conversion to scientific notation by accessing `sign`, `digits`\n         # and `exponent` from `Decimal.as_tuple()` directly.\n-        sign, digits, exponent = d.quantize(exp, ROUND_HALF_UP).as_tuple()\n+        sign, digits, exponent = d.quantize(exp, ROUND_HALF_UP,\n+            Context(prec=prec)).as_tuple()\n         digits = [unicode(digit) for digit in reversed(digits)]\n         while len(digits) <= abs(exponent):\n             digits.append(u'0')"
        },
        {
            "sha": "5288e5017753e9fec47f30b8fc2bff7d12e62636",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/27444618f6f8822110808a5d663a400334b8e9d7/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/27444618f6f8822110808a5d663a400334b8e9d7/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=27444618f6f8822110808a5d663a400334b8e9d7",
            "patch": "@@ -2,6 +2,7 @@\n from __future__ import with_statement\n \n import datetime\n+import decimal\n \n from django.template.defaultfilters import *\n from django.test import TestCase\n@@ -26,6 +27,11 @@ def test_floatformat(self):\n         self.assertEqual(floatformat(11.0000, -2), u'11')\n         self.assertEqual(floatformat(11.000001, -2), u'11.00')\n         self.assertEqual(floatformat(8.2798, 3), u'8.280')\n+        self.assertEqual(floatformat(5555.555, 2), u'5555.56')\n+        self.assertEqual(floatformat(001.3000, 2), u'1.30')\n+        self.assertEqual(floatformat(0.12345, 2), u'0.12')\n+        self.assertEqual(floatformat(decimal.Decimal('555.555'), 2), u'555.56')\n+        self.assertEqual(floatformat(decimal.Decimal('09.000')), u'9')\n         self.assertEqual(floatformat(u'foo'), u'')\n         self.assertEqual(floatformat(13.1031, u'bar'), u'13.1031')\n         self.assertEqual(floatformat(18.125, 2), u'18.13')\n@@ -57,6 +63,18 @@ def __float__(self):\n \n         self.assertEqual(floatformat(FloatWrapper(11.000001), -2), u'11.00')\n \n+        # Regression for #15789\n+        decimal_ctx = decimal.getcontext()\n+        old_prec, decimal_ctx.prec = decimal_ctx.prec, 2\n+        try:\n+            self.assertEqual(floatformat(1.2345, 2), u'1.23')\n+            self.assertEqual(floatformat(15.2042, -3), u'15.204')\n+            self.assertEqual(floatformat(decimal.Decimal('1.2345'), 2), u'1.23')\n+            self.assertEqual(floatformat(decimal.Decimal('15.2042'), -3), u'15.204')\n+        finally:\n+            decimal_ctx.prec = old_prec\n+\n+\n     # This fails because of Python's float handling. Floats with many zeroes\n     # after the decimal point should be passed in as another type such as\n     # unicode or Decimal."
        }
    ],
    "stats": {
        "total": 28,
        "additions": 26,
        "deletions": 2
    }
}