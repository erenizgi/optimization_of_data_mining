{
    "author": "jezdez",
    "message": "Fixed #14288 -- Fixed linebreaksbr template filter to normalize newlines first. Thanks, Julien Phalip.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16573 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "343b4f1ea5ffc48c03138640a85a1781ccbf2964",
    "files": [
        {
            "sha": "13de9d53345c1c6b8ccebfb4f87b35edaa1a4285",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/343b4f1ea5ffc48c03138640a85a1781ccbf2964/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/343b4f1ea5ffc48c03138640a85a1781ccbf2964/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=343b4f1ea5ffc48c03138640a85a1781ccbf2964",
            "patch": "@@ -19,6 +19,7 @@\n from django.utils.safestring import mark_safe, SafeData, mark_for_escaping\n from django.utils.timesince import timesince, timeuntil\n from django.utils.translation import ugettext, ungettext\n+from django.utils.text import normalize_newlines\n \n register = Library()\n \n@@ -421,13 +422,16 @@ def linebreaks_filter(value, autoescape=None):\n     return mark_safe(linebreaks(value, autoescape))\n linebreaks_filter.is_safe = True\n linebreaks_filter.needs_autoescape = True\n+linebreaks = stringfilter(linebreaks)\n \n def linebreaksbr(value, autoescape=None):\n     \"\"\"\n     Converts all newlines in a piece of plain text to HTML line breaks\n     (``<br />``).\n     \"\"\"\n-    if autoescape and not isinstance(value, SafeData):\n+    autoescape = autoescape and not isinstance(value, SafeData)\n+    value = normalize_newlines(value)\n+    if autoescape:\n         value = escape(value)\n     return mark_safe(value.replace('\\n', '<br />'))\n linebreaksbr.is_safe = True"
        },
        {
            "sha": "2687eb523274f120caebc78083e0534c80ac3fd4",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/343b4f1ea5ffc48c03138640a85a1781ccbf2964/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/343b4f1ea5ffc48c03138640a85a1781ccbf2964/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=343b4f1ea5ffc48c03138640a85a1781ccbf2964",
            "patch": "@@ -7,6 +7,7 @@\n from django.utils.encoding import force_unicode\n from django.utils.functional import allow_lazy\n from django.utils.http import urlquote\n+from django.utils.text import normalize_newlines\n \n # Configuration for urlize() function.\n LEADING_PUNCTUATION  = ['(', '<', '&lt;']\n@@ -70,7 +71,7 @@ def conditional_escape(html):\n \n def linebreaks(value, autoescape=False):\n     \"\"\"Converts newlines into <p> and <br />s.\"\"\"\n-    value = re.sub(r'\\r\\n|\\r|\\n', '\\n', force_unicode(value)) # normalize newlines\n+    value = normalize_newlines(value)\n     paras = re.split('\\n{2,}', value)\n     if autoescape:\n         paras = [u'<p>%s</p>' % escape(p).replace('\\n', '<br />') for p in paras]"
        },
        {
            "sha": "cbd4776a50048548690e26f875cbc1dcf1e4420b",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/343b4f1ea5ffc48c03138640a85a1781ccbf2964/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/343b4f1ea5ffc48c03138640a85a1781ccbf2964/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=343b4f1ea5ffc48c03138640a85a1781ccbf2964",
            "patch": "@@ -266,6 +266,18 @@ def test_linebreaks(self):\n         self.assertEqual(linebreaks(u'line 1'), u'<p>line 1</p>')\n         self.assertEqual(linebreaks(u'line 1\\nline 2'),\n                           u'<p>line 1<br />line 2</p>')\n+        self.assertEqual(linebreaks(u'line 1\\rline 2'),\n+                          u'<p>line 1<br />line 2</p>')\n+        self.assertEqual(linebreaks(u'line 1\\r\\nline 2'),\n+                          u'<p>line 1<br />line 2</p>')\n+\n+    def test_linebreaksbr(self):\n+        self.assertEqual(linebreaksbr(u'line 1\\nline 2'),\n+                          u'line 1<br />line 2')\n+        self.assertEqual(linebreaksbr(u'line 1\\rline 2'),\n+                          u'line 1<br />line 2')\n+        self.assertEqual(linebreaksbr(u'line 1\\r\\nline 2'),\n+                          u'line 1<br />line 2')\n \n     def test_removetags(self):\n         self.assertEqual(removetags(u'some <b>html</b> with <script>alert'\\"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 19,
        "deletions": 2
    }
}