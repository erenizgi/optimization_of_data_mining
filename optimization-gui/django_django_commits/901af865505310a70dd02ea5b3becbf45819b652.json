{
    "author": "carljm",
    "message": "Fixed #16865 -- Made get_or_create use read database for initial get query.\n\nThanks Rick van Hattem for the report and trbs for the patch.",
    "sha": "901af865505310a70dd02ea5b3becbf45819b652",
    "files": [
        {
            "sha": "441426a107b202b4cf58206b7e501649a5e21fda",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/901af865505310a70dd02ea5b3becbf45819b652/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/901af865505310a70dd02ea5b3becbf45819b652/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=901af865505310a70dd02ea5b3becbf45819b652",
            "patch": "@@ -455,9 +455,9 @@ def get_or_create(self, **kwargs):\n             if f.attname in lookup:\n                 lookup[f.name] = lookup.pop(f.attname)\n         try:\n-            self._for_write = True\n             return self.get(**lookup), False\n         except self.model.DoesNotExist:\n+            self._for_write = True\n             try:\n                 params = dict([(k, v) for k, v in kwargs.items() if '__' not in k])\n                 params.update(defaults)"
        },
        {
            "sha": "84c37af9ee2afddb94d22d0cd96f309f5aa622ac",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/901af865505310a70dd02ea5b3becbf45819b652/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/901af865505310a70dd02ea5b3becbf45819b652/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=901af865505310a70dd02ea5b3becbf45819b652",
            "patch": "@@ -338,6 +338,15 @@ Miscellaneous\n   needs. The new default value is `0666` (octal) and the current umask value\n   is first masked out.\n \n+* In a multi-database situation, ``get_or_create()`` will now use a read\n+  database for the initial ``get`` attempt (previously, it used only the write\n+  database for all queries). This change reduces load on the write (master)\n+  database, in exchange for slightly more frequent false-negatives on the\n+  initial ``get`` due to replication lag. In those cases the subsequent insert\n+  will still go to the master and fail, after which the existing object will be\n+  fetched from the master.\n+\n+\n Features deprecated in 1.5\n ==========================\n "
        },
        {
            "sha": "cc7d2c29abefd79eddd31b3a2100271ea048fc08",
            "filename": "tests/modeltests/get_or_create/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/901af865505310a70dd02ea5b3becbf45819b652/tests%2Fmodeltests%2Fget_or_create%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/901af865505310a70dd02ea5b3becbf45819b652/tests%2Fmodeltests%2Fget_or_create%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fget_or_create%2Ftests.py?ref=901af865505310a70dd02ea5b3becbf45819b652",
            "patch": "@@ -64,3 +64,27 @@ def test_get_or_create(self):\n             formatted_traceback = traceback.format_exc()\n             self.assertIn('obj.save', formatted_traceback)\n \n+\n+    def test_initial_get_on_read_db(self):\n+        \"\"\"\n+        get_or_create should only set _for_write when it's actually doing a\n+        create action. This makes sure that the initial .get() will be able to\n+        use a slave database. Specially when some form of database pinning is\n+        in place this will help to not put all the SELECT queries on the\n+        master. Refs #16865.\n+\n+        \"\"\"\n+        qs = Person.objects.get_query_set()\n+        p, created = qs.get_or_create(\n+            first_name=\"Stuart\", last_name=\"Sutcliffe\", defaults={\n+                \"birthday\": date(1940, 6, 23),\n+                }\n+            )\n+        self.assertTrue(created)\n+        self.assertTrue(qs._for_write)\n+\n+        qs = Person.objects.get_query_set()\n+        p, created = qs.get_or_create(\n+            first_name=\"Stuart\", last_name=\"Sutcliffe\")\n+        self.assertFalse(created)\n+        self.assertFalse(qs._for_write)"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 34,
        "deletions": 1
    }
}