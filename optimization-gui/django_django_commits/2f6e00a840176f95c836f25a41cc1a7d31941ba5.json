{
    "author": "claudep",
    "message": "Fixed #11948 -- Added interpolate and project linear referencing methods\n\nThanks novalis for the report and the initial patch, and Anssi\nKääriäinen and Justin Bronn for the review.",
    "sha": "2f6e00a840176f95c836f25a41cc1a7d31941ba5",
    "files": [
        {
            "sha": "079308bba8b2c91a63261ac4b89b8e03cea61c19",
            "filename": "django/contrib/gis/geos/geometry.py",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/2f6e00a840176f95c836f25a41cc1a7d31941ba5/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "raw_url": "https://github.com/django/django/raw/2f6e00a840176f95c836f25a41cc1a7d31941ba5/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py?ref=2f6e00a840176f95c836f25a41cc1a7d31941ba5",
            "patch": "@@ -581,6 +581,20 @@ def envelope(self):\n         \"Return the envelope for this geometry (a polygon).\"\n         return self._topology(capi.geos_envelope(self.ptr))\n \n+    def interpolate(self, distance):\n+        if not isinstance(self, (LineString, MultiLineString)):\n+            raise TypeError('interpolate only works on LineString and MultiLineString geometries')\n+        if not hasattr(capi, 'geos_interpolate'):\n+            raise NotImplementedError('interpolate requires GEOS 3.2+')\n+        return self._topology(capi.geos_interpolate(self.ptr, distance))\n+\n+    def interpolate_normalized(self, distance):\n+        if not isinstance(self, (LineString, MultiLineString)):\n+            raise TypeError('interpolate only works on LineString and MultiLineString geometries')\n+        if not hasattr(capi, 'geos_interpolate_normalized'):\n+            raise NotImplementedError('interpolate_normalized requires GEOS 3.2+')\n+        return self._topology(capi.geos_interpolate_normalized(self.ptr, distance))\n+\n     def intersection(self, other):\n         \"Returns a Geometry representing the points shared by this Geometry and other.\"\n         return self._topology(capi.geos_intersection(self.ptr, other.ptr))\n@@ -590,6 +604,24 @@ def point_on_surface(self):\n         \"Computes an interior point of this Geometry.\"\n         return self._topology(capi.geos_pointonsurface(self.ptr))\n \n+    def project(self, point):\n+        if not isinstance(point, Point):\n+            raise TypeError('locate_point argument must be a Point')\n+        if not isinstance(self, (LineString, MultiLineString)):\n+            raise TypeError('locate_point only works on LineString and MultiLineString geometries')\n+        if not hasattr(capi, 'geos_project'):\n+            raise NotImplementedError('geos_project requires GEOS 3.2+')\n+        return capi.geos_project(self.ptr, point.ptr)\n+\n+    def project_normalized(self, point):\n+        if not isinstance(point, Point):\n+            raise TypeError('locate_point argument must be a Point')\n+        if not isinstance(self, (LineString, MultiLineString)):\n+            raise TypeError('locate_point only works on LineString and MultiLineString geometries')\n+        if not hasattr(capi, 'geos_project_normalized'):\n+            raise NotImplementedError('project_normalized requires GEOS 3.2+')\n+        return capi.geos_project_normalized(self.ptr, point.ptr)\n+\n     def relate(self, other):\n         \"Returns the DE-9IM intersection matrix for this Geometry and the other.\"\n         return capi.geos_relate(self.ptr, other.ptr).decode()"
        },
        {
            "sha": "dfea3e98b628fffa664630a5eb94b212af4e19ca",
            "filename": "django/contrib/gis/geos/prototypes/topology.py",
            "status": "modified",
            "additions": 18,
            "deletions": 5,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/2f6e00a840176f95c836f25a41cc1a7d31941ba5/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Ftopology.py",
            "raw_url": "https://github.com/django/django/raw/2f6e00a840176f95c836f25a41cc1a7d31941ba5/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Ftopology.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Ftopology.py?ref=2f6e00a840176f95c836f25a41cc1a7d31941ba5",
            "patch": "@@ -8,18 +8,18 @@\n            'geos_simplify', 'geos_symdifference', 'geos_union', 'geos_relate']\n \n from ctypes import c_double, c_int\n-from django.contrib.gis.geos.libgeos import GEOM_PTR, GEOS_PREPARE\n-from django.contrib.gis.geos.prototypes.errcheck import check_geom, check_string\n+from django.contrib.gis.geos.libgeos import geos_version_info, GEOM_PTR, GEOS_PREPARE\n+from django.contrib.gis.geos.prototypes.errcheck import check_geom, check_minus_one, check_string\n from django.contrib.gis.geos.prototypes.geom import geos_char_p\n from django.contrib.gis.geos.prototypes.threadsafe import GEOSFunc\n \n-def topology(func, *args):\n+def topology(func, *args, **kwargs):\n     \"For GEOS unary topology functions.\"\n     argtypes = [GEOM_PTR]\n     if args: argtypes += args\n     func.argtypes = argtypes\n-    func.restype = GEOM_PTR\n-    func.errcheck = check_geom\n+    func.restype = kwargs.get('restype', GEOM_PTR)\n+    func.errcheck = kwargs.get('errcheck', check_geom)\n     return func\n \n ### Topology Routines ###\n@@ -49,3 +49,16 @@ def topology(func, *args):\n     geos_cascaded_union.argtypes = [GEOM_PTR]\n     geos_cascaded_union.restype = GEOM_PTR\n     __all__.append('geos_cascaded_union')\n+\n+# Linear referencing routines\n+info = geos_version_info()\n+if info['version'] >= '3.2.0':\n+    geos_project = topology(GEOSFunc('GEOSProject'), GEOM_PTR,\n+        restype=c_double, errcheck=check_minus_one)\n+    geos_interpolate = topology(GEOSFunc('GEOSInterpolate'), c_double)\n+\n+    geos_project_normalized = topology(GEOSFunc('GEOSProjectNormalized'),\n+        GEOM_PTR, restype=c_double, errcheck=check_minus_one)\n+    geos_interpolate_normalized = topology(GEOSFunc('GEOSInterpolateNormalized'), c_double)\n+    __all__.extend(['geos_project', 'geos_interpolate',\n+        'geos_project_normalized', 'geos_interpolate_normalized'])"
        },
        {
            "sha": "e10ac8098271b06ac03b7756668551acfc2b4de5",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/2f6e00a840176f95c836f25a41cc1a7d31941ba5/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/2f6e00a840176f95c836f25a41cc1a7d31941ba5/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=2f6e00a840176f95c836f25a41cc1a7d31941ba5",
            "patch": "@@ -1023,6 +1023,27 @@ def test_valid_reason(self):\n \n         print(\"\\nEND - expecting GEOS_NOTICE; safe to ignore.\\n\")\n \n+    @unittest.skipUnless(geos_version_info()['version'] >= '3.2.0', \"geos >= 3.2.0 is required\")\n+    def test_linearref(self):\n+        \"Testing linear referencing\"\n+\n+        ls = fromstr('LINESTRING(0 0, 0 10, 10 10, 10 0)')\n+        mls = fromstr('MULTILINESTRING((0 0, 0 10), (10 0, 10 10))')\n+\n+        self.assertEqual(ls.project(Point(0, 20)), 10.0)\n+        self.assertEqual(ls.project(Point(7, 6)), 24)\n+        self.assertEqual(ls.project_normalized(Point(0, 20)), 1.0/3)\n+\n+        self.assertEqual(ls.interpolate(10), Point(0, 10))\n+        self.assertEqual(ls.interpolate(24), Point(10, 6))\n+        self.assertEqual(ls.interpolate_normalized(1.0/3), Point(0, 10))\n+\n+        self.assertEqual(mls.project(Point(0, 20)), 10)\n+        self.assertEqual(mls.project(Point(7, 6)), 16)\n+\n+        self.assertEqual(mls.interpolate(9), Point(0, 9))\n+        self.assertEqual(mls.interpolate(17), Point(10, 7))\n+\n     def test_geos_version(self):\n         \"Testing the GEOS version regular expression.\"\n         from django.contrib.gis.geos.libgeos import version_regex"
        },
        {
            "sha": "88883784f909f74ecf5af4528231e3cf15762467",
            "filename": "docs/ref/contrib/gis/geos.txt",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/2f6e00a840176f95c836f25a41cc1a7d31941ba5/docs%2Fref%2Fcontrib%2Fgis%2Fgeos.txt",
            "raw_url": "https://github.com/django/django/raw/2f6e00a840176f95c836f25a41cc1a7d31941ba5/docs%2Fref%2Fcontrib%2Fgis%2Fgeos.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Fgeos.txt?ref=2f6e00a840176f95c836f25a41cc1a7d31941ba5",
            "patch": "@@ -416,11 +416,36 @@ quarter circle (defaults is 8).\n Returns a :class:`GEOSGeometry` representing the points making up this\n geometry that do not make up other.\n \n+.. method:: GEOSGeometry.interpolate(distance)\n+.. method:: GEOSGeometry.interpolate_normalized(distance)\n+\n+.. versionadded:: 1.5\n+\n+Given a distance (float), returns the point (or closest point) within the\n+geometry (:class:`LineString` or :class:`MultiLineString`) at that distance.\n+The normalized version takes the distance as a float between 0 (origin) and 1\n+(endpoint).\n+\n+Reverse of :meth:`GEOSGeometry.project`.\n+\n .. method:: GEOSGeometry:intersection(other)\n \n Returns a :class:`GEOSGeometry` representing the points shared by this\n geometry and other.\n \n+.. method:: GEOSGeometry.project(point)\n+.. method:: GEOSGeometry.project_normalized(point)\n+\n+.. versionadded:: 1.5\n+\n+Returns the distance (float) from the origin of the geometry\n+(:class:`LineString` or :class:`MultiLineString`) to the point projected on the\n+geometry (that is to a point of the line the closest to the given point).\n+The normalized version returns the distance as a float between 0 (origin) and 1\n+(endpoint).\n+\n+Reverse of :meth:`GEOSGeometry.interpolate`.\n+\n .. method:: GEOSGeometry.relate(other)\n \n Returns the DE-9IM intersection matrix (a string) representing the"
        },
        {
            "sha": "294ceb159ee0c7bba71501c050d019c09f5bc4b7",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/2f6e00a840176f95c836f25a41cc1a7d31941ba5/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/2f6e00a840176f95c836f25a41cc1a7d31941ba5/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=2f6e00a840176f95c836f25a41cc1a7d31941ba5",
            "patch": "@@ -103,10 +103,22 @@ associated with proxy models.\n \n New ``view`` variable in class-based views context\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n In all :doc:`generic class-based views </topics/class-based-views/index>`\n (or any class-based view inheriting from ``ContextMixin``), the context dictionary\n contains a ``view`` variable that points to the ``View`` instance.\n \n+GeoDjango\n+~~~~~~~~~\n+\n+* :class:`~django.contrib.gis.geos.LineString` and\n+  :class:`~django.contrib.gis.geos.MultiLineString` GEOS objects now support the\n+  :meth:`~django.contrib.gis.geos.GEOSGeometry.interpolate()` and\n+  :meth:`~django.contrib.gis.geos.GEOSGeometry.project()` methods\n+  (so-called linear referencing).\n+\n+* Support for GDAL < 1.5 has been dropped.\n+\n Minor features\n ~~~~~~~~~~~~~~\n \n@@ -379,8 +391,6 @@ on the form.\n Miscellaneous\n ~~~~~~~~~~~~~\n \n-* GeoDjango dropped support for GDAL < 1.5\n-\n * :func:`~django.utils.http.int_to_base36` properly raises a :exc:`TypeError`\n   instead of :exc:`ValueError` for non-integer inputs.\n "
        }
    ],
    "stats": {
        "total": 115,
        "additions": 108,
        "deletions": 7
    }
}