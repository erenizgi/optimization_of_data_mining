{
    "author": "jphalip",
    "message": "Fixed #17256 -- Ensured that content types get cached when retrieved by natural key. Thanks, defaultwombat and charettes.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17502 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "130e7ab617d746291629de6a5a1fbb5ea9cd3fe5",
    "files": [
        {
            "sha": "6d919b4237de34c13eb3ee00559b229b8b45a19b",
            "filename": "django/contrib/contenttypes/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/130e7ab617d746291629de6a5a1fbb5ea9cd3fe5/django%2Fcontrib%2Fcontenttypes%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/130e7ab617d746291629de6a5a1fbb5ea9cd3fe5/django%2Fcontrib%2Fcontenttypes%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fmodels.py?ref=130e7ab617d746291629de6a5a1fbb5ea9cd3fe5",
            "patch": "@@ -13,6 +13,7 @@ def get_by_natural_key(self, app_label, model):\n             ct = self.__class__._cache[self.db][(app_label, model)]\n         except KeyError:\n             ct = self.get(app_label=app_label, model=model)\n+            self._add_to_cache(self.db, ct)\n         return ct\n \n     def _get_opts(self, model):"
        },
        {
            "sha": "3b7906c8129d6675779d7b4e06ad1d9d8c7b6aab",
            "filename": "django/contrib/contenttypes/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/130e7ab617d746291629de6a5a1fbb5ea9cd3fe5/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/130e7ab617d746291629de6a5a1fbb5ea9cd3fe5/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Ftests.py?ref=130e7ab617d746291629de6a5a1fbb5ea9cd3fe5",
            "patch": "@@ -51,25 +51,39 @@ def tearDown(self):\n     def test_lookup_cache(self):\n         \"\"\"\n         Make sure that the content type cache (see ContentTypeManager)\n-        works correctly. Lookups for a particular content type -- by model or\n-        by ID -- should hit the database only on the first lookup.\n+        works correctly. Lookups for a particular content type -- by model, ID\n+        or natural key -- should hit the database only on the first lookup.\n         \"\"\"\n \n         # At this point, a lookup for a ContentType should hit the DB\n         with self.assertNumQueries(1):\n             ContentType.objects.get_for_model(ContentType)\n \n         # A second hit, though, won't hit the DB, nor will a lookup by ID\n+        # or natural key\n         with self.assertNumQueries(0):\n             ct = ContentType.objects.get_for_model(ContentType)\n         with self.assertNumQueries(0):\n             ContentType.objects.get_for_id(ct.id)\n+        with self.assertNumQueries(0):\n+            ContentType.objects.get_by_natural_key('contenttypes',\n+                                                   'contenttype')\n \n         # Once we clear the cache, another lookup will again hit the DB\n         ContentType.objects.clear_cache()\n         with self.assertNumQueries(1):\n             ContentType.objects.get_for_model(ContentType)\n \n+        # The same should happen with a lookup by natural key\n+        ContentType.objects.clear_cache()\n+        with self.assertNumQueries(1):\n+            ContentType.objects.get_by_natural_key('contenttypes',\n+                                                   'contenttype')\n+        # And a second hit shouldn't hit the DB\n+        with self.assertNumQueries(0):\n+            ContentType.objects.get_by_natural_key('contenttypes',\n+                                                   'contenttype')\n+\n     def test_get_for_models_empty_cache(self):\n         # Empty cache.\n         with self.assertNumQueries(1):"
        },
        {
            "sha": "0b036ce9213615a79a478058a9e8caac477425ec",
            "filename": "tests/regressiontests/comment_tests/tests/templatetag_tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/130e7ab617d746291629de6a5a1fbb5ea9cd3fe5/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "raw_url": "https://github.com/django/django/raw/130e7ab617d746291629de6a5a1fbb5ea9cd3fe5/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Ftemplatetag_tests.py?ref=130e7ab617d746291629de6a5a1fbb5ea9cd3fe5",
            "patch": "@@ -130,8 +130,7 @@ def testNumberQueries(self):\n         with self.assertNumQueries(4):\n             self.testRenderCommentListFromObject()\n \n-        # Force the CT to be cached\n-        ct = ContentType.objects.get_for_model(Article)\n+        # CT's should be cached\n         with self.assertNumQueries(3):\n             self.testRenderCommentListFromObject()\n \n@@ -141,7 +140,6 @@ def testNumberQueries(self):\n         with self.assertNumQueries(4):\n             self.verifyGetCommentList()\n \n-        ct = ContentType.objects.get_for_model(Author)\n         with self.assertNumQueries(3):\n             self.verifyGetCommentList()\n \n@@ -151,7 +149,6 @@ def testNumberQueries(self):\n         with self.assertNumQueries(3):\n             self.testRenderCommentForm()\n \n-        ct = ContentType.objects.get_for_model(Article)\n         with self.assertNumQueries(2):\n             self.testRenderCommentForm()\n \n@@ -161,7 +158,6 @@ def testNumberQueries(self):\n         with self.assertNumQueries(3):\n             self.testGetCommentForm()\n \n-        ct = ContentType.objects.get_for_model(Article)\n         with self.assertNumQueries(2):\n             self.testGetCommentForm()\n \n@@ -171,6 +167,5 @@ def testNumberQueries(self):\n         with self.assertNumQueries(3):\n             self.verifyGetCommentCount()\n \n-        ct = ContentType.objects.get_for_model(Article)\n         with self.assertNumQueries(2):\n             self.verifyGetCommentCount()"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 18,
        "deletions": 8
    }
}