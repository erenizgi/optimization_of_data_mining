{
    "author": "jezdez",
    "message": "Fixed #15997 -- Added `list_max_show_all` option to `ModelAdmin` in replacement for a global module level variable. Thanks, jsdalton.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16725 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "cf70c96ce08bec8834ada695451cc915f7558dbd",
    "files": [
        {
            "sha": "c9f256214211e278eea945c662dd148ca2047e31",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -278,6 +278,7 @@ class ModelAdmin(BaseModelAdmin):\n     list_filter = ()\n     list_select_related = False\n     list_per_page = 100\n+    list_max_show_all = 200\n     list_editable = ()\n     search_fields = ()\n     date_hierarchy = None\n@@ -1087,7 +1088,7 @@ def changelist_view(self, request, extra_context=None):\n         try:\n             cl = ChangeList(request, self.model, list_display, self.list_display_links,\n                 self.list_filter, self.date_hierarchy, self.search_fields,\n-                self.list_select_related, self.list_per_page, self.list_editable, self)\n+                self.list_select_related, self.list_per_page, self.list_max_show_all, self.list_editable, self)\n         except IncorrectLookupParameters:\n             # Wacky lookup parameters were given, so redirect to the main\n             # changelist page, without parameters, and pass an 'invalid=1'"
        },
        {
            "sha": "733f89d06f0887ee9cf5ca3c226ffb4396b703cb",
            "filename": "django/contrib/admin/validation.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fvalidation.py?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -96,6 +96,11 @@ def validate(cls, model):\n         raise ImproperlyConfigured(\"'%s.list_per_page' should be a integer.\"\n                 % cls.__name__)\n \n+    # list_max_show_all\n+    if hasattr(cls, 'list_max_show_all') and not isinstance(cls.list_max_show_all, int):\n+        raise ImproperlyConfigured(\"'%s.list_max_show_all' should be an integer.\"\n+                % cls.__name__)\n+\n     # list_editable\n     if hasattr(cls, 'list_editable') and cls.list_editable:\n         check_isseq(cls, 'list_editable', cls.list_editable)"
        },
        {
            "sha": "616b24957a1ca20d1abd5c5785db846e3bbb2c96",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -12,10 +12,6 @@\n from django.contrib.admin.options import IncorrectLookupParameters\n from django.contrib.admin.util import quote, get_fields_from_path\n \n-# The system will display a \"Show all\" link on the change list only if the\n-# total result count is less than or equal to this setting.\n-MAX_SHOW_ALL_ALLOWED = 200\n-\n # Changelist settings\n ALL_VAR = 'all'\n ORDER_VAR = 'o'\n@@ -44,7 +40,7 @@ def field_needs_distinct(field):\n class ChangeList(object):\n     def __init__(self, request, model, list_display, list_display_links,\n             list_filter, date_hierarchy, search_fields, list_select_related,\n-            list_per_page, list_editable, model_admin):\n+            list_per_page, list_max_show_all, list_editable, model_admin):\n         self.model = model\n         self.opts = model._meta\n         self.lookup_opts = self.opts\n@@ -56,6 +52,7 @@ def __init__(self, request, model, list_display, list_display_links,\n         self.search_fields = search_fields\n         self.list_select_related = list_select_related\n         self.list_per_page = list_per_page\n+        self.list_max_show_all = list_max_show_all\n         self.model_admin = model_admin\n \n         # Get search parameters from the query string.\n@@ -145,7 +142,7 @@ def get_results(self, request):\n         else:\n             full_result_count = self.root_query_set.count()\n \n-        can_show_all = result_count <= MAX_SHOW_ALL_ALLOWED\n+        can_show_all = result_count <= self.list_max_show_all\n         multi_page = result_count > self.list_per_page\n \n         # Get the list of objects to display on this page."
        },
        {
            "sha": "d68197e57bbaa9048745ce78285c1a0e5e7b431f",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -695,6 +695,15 @@ subclass::\n               The ``FieldListFilter`` API is currently considered internal\n               and prone to refactoring.\n \n+.. attribute:: ModelAdmin.list_max_show_all\n+\n+    .. versionadded:: 1.4\n+\n+    Set ``list_max_show_all`` to control how many items can appear on a \"Show\n+    all\" admin change list page. The admin will display a \"Show all\" link on the\n+    change list only if the total result count is less than or equal to this\n+    setting. By default, this is set to ``200``.\n+\n .. attribute:: ModelAdmin.list_per_page\n \n     Set ``list_per_page`` to control how many items appear on each paginated"
        },
        {
            "sha": "09ec1907858b4e0e5dbeb1f6777ff50c5ec7ee7b",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 47,
            "deletions": 15,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -1,6 +1,8 @@\n+from __future__ import with_statement\n+\n from django.contrib import admin\n from django.contrib.admin.options import IncorrectLookupParameters\n-from django.contrib.admin.views.main import ChangeList, SEARCH_VAR\n+from django.contrib.admin.views.main import ChangeList, SEARCH_VAR, ALL_VAR\n from django.core.paginator import Paginator\n from django.template import Context, Template\n from django.test import TestCase\n@@ -24,7 +26,7 @@ def test_select_related_preserved(self):\n         request = self.factory.get('/child/')\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n         self.assertEqual(cl.query_set.query.select_related, {'parent': {'name': {}}})\n \n     def test_result_list_empty_changelist_value(self):\n@@ -37,7 +39,7 @@ def test_result_list_empty_changelist_value(self):\n         m = ChildAdmin(Child, admin.site)\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n         cl.formset = None\n         template = Template('{% load admin_list %}{% spaceless %}{% result_list cl %}{% endspaceless %}')\n         context = Context({'cl': cl})\n@@ -57,7 +59,7 @@ def test_result_list_html(self):\n         m = ChildAdmin(Child, admin.site)\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n         cl.formset = None\n         template = Template('{% load admin_list %}{% spaceless %}{% result_list cl %}{% endspaceless %}')\n         context = Context({'cl': cl})\n@@ -86,7 +88,7 @@ def test_result_list_editable_html(self):\n         m.list_editable = ['name']\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n         FormSet = m.get_changelist_formset(request)\n         cl.formset = FormSet(queryset=cl.result_list)\n         template = Template('{% load admin_list %}{% spaceless %}{% result_list cl %}{% endspaceless %}')\n@@ -119,7 +121,7 @@ def test_result_list_editable(self):\n         self.assertRaises(IncorrectLookupParameters, lambda: \\\n             ChangeList(request, Child, m.list_display, m.list_display_links,\n                     m.list_filter, m.date_hierarchy, m.search_fields,\n-                    m.list_select_related, m.list_per_page, m.list_editable, m))\n+                    m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m))\n \n     def test_custom_paginator(self):\n         new_parent = Parent.objects.create(name='parent')\n@@ -135,7 +137,7 @@ def test_custom_paginator(self):\n \n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all, m.list_editable, m)\n \n         cl.get_results(request)\n         self.assertIsInstance(cl.paginator, CustomPaginator)\n@@ -157,7 +159,7 @@ def test_distinct_for_m2m_in_list_filter(self):\n         cl = ChangeList(request, Band, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n-                m.list_editable, m)\n+                m.list_max_show_all, m.list_editable, m)\n \n         cl.get_results(request)\n \n@@ -180,7 +182,7 @@ def test_distinct_for_through_m2m_in_list_filter(self):\n         cl = ChangeList(request, Group, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n-                m.list_editable, m)\n+                m.list_max_show_all, m.list_editable, m)\n \n         cl.get_results(request)\n \n@@ -204,7 +206,7 @@ def test_distinct_for_inherited_m2m_in_list_filter(self):\n         cl = ChangeList(request, Quartet, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n-                m.list_editable, m)\n+                m.list_max_show_all, m.list_editable, m)\n \n         cl.get_results(request)\n \n@@ -228,7 +230,7 @@ def test_distinct_for_m2m_to_inherited_in_list_filter(self):\n         cl = ChangeList(request, ChordsBand, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n                 m.search_fields, m.list_select_related, m.list_per_page,\n-                m.list_editable, m)\n+                m.list_max_show_all, m.list_editable, m)\n \n         cl.get_results(request)\n \n@@ -251,7 +253,7 @@ def test_distinct_for_non_unique_related_object_in_list_filter(self):\n         cl = ChangeList(request, Parent, m.list_display, m.list_display_links,\n                         m.list_filter, m.date_hierarchy, m.search_fields,\n                         m.list_select_related, m.list_per_page,\n-                        m.list_editable, m)\n+                        m.list_max_show_all, m.list_editable, m)\n \n         # Make sure distinct() was called\n         self.assertEqual(cl.query_set.count(), 1)\n@@ -271,7 +273,7 @@ def test_distinct_for_non_unique_related_object_in_search_fields(self):\n         cl = ChangeList(request, Parent, m.list_display, m.list_display_links,\n                         m.list_filter, m.date_hierarchy, m.search_fields,\n                         m.list_select_related, m.list_per_page,\n-                        m.list_editable, m)\n+                        m.list_max_show_all, m.list_editable, m)\n \n         # Make sure distinct() was called\n         self.assertEqual(cl.query_set.count(), 1)\n@@ -292,7 +294,8 @@ def test_pagination(self):\n         m = ChildAdmin(Child, admin.site)\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all,\n+                m.list_editable, m)\n         self.assertEqual(cl.query_set.count(), 60)\n         self.assertEqual(cl.paginator.count, 60)\n         self.assertEqual(cl.paginator.page_range, [1, 2, 3, 4, 5, 6])\n@@ -301,7 +304,8 @@ def test_pagination(self):\n         m = FilteredChildAdmin(Child, admin.site)\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n-                m.list_select_related, m.list_per_page, m.list_editable, m)\n+                m.list_select_related, m.list_per_page, m.list_max_show_all,\n+                m.list_editable, m)\n         self.assertEqual(cl.query_set.count(), 30)\n         self.assertEqual(cl.paginator.count, 30)\n         self.assertEqual(cl.paginator.page_range, [1, 2, 3])\n@@ -351,6 +355,34 @@ def _mocked_authenticated_request(user):\n         response.render()\n         self.assertContains(response, 'Parent object')\n \n+    def test_show_all(self):\n+        parent = Parent.objects.create(name='anything')\n+        for i in range(30):\n+            Child.objects.create(name='name %s' % i, parent=parent)\n+            Child.objects.create(name='filtered %s' % i, parent=parent)\n+\n+        # Add \"show all\" parameter to request\n+        request = self.factory.get('/child/', data={ALL_VAR: ''})\n+\n+        # Test valid \"show all\" request (number of total objects is under max)\n+        m = ChildAdmin(Child, admin.site)\n+        # 200 is the max we'll pass to ChangeList\n+        cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n+                m.list_filter, m.date_hierarchy, m.search_fields,\n+                m.list_select_related, m.list_per_page, 200, m.list_editable, m)\n+        cl.get_results(request)\n+        self.assertEqual(len(cl.result_list), 60)\n+\n+        # Test invalid \"show all\" request (number of total objects over max)\n+        # falls back to paginated pages\n+        m = ChildAdmin(Child, admin.site)\n+        # 30 is the max we'll pass to ChangeList for this test\n+        cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n+                m.list_filter, m.date_hierarchy, m.search_fields,\n+                m.list_select_related, m.list_per_page, 30, m.list_editable, m)\n+        cl.get_results(request)\n+        self.assertEqual(len(cl.result_list), 10)\n+\n \n class ParentAdmin(admin.ModelAdmin):\n     list_filter = ['child__name']"
        },
        {
            "sha": "7f52f9c20db4d52750c1494681e990a1ad7d9b7e",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -119,7 +119,7 @@ def setUp(self):\n     def get_changelist(self, request, model, modeladmin):\n         return ChangeList(request, model, modeladmin.list_display, modeladmin.list_display_links,\n             modeladmin.list_filter, modeladmin.date_hierarchy, modeladmin.search_fields,\n-            modeladmin.list_select_related, modeladmin.list_per_page, modeladmin.list_editable, modeladmin)\n+            modeladmin.list_select_related, modeladmin.list_per_page, modeladmin.list_max_show_all, modeladmin.list_editable, modeladmin)\n \n     def test_datefieldlistfilter(self):\n         modeladmin = BookAdmin(Book, site)"
        },
        {
            "sha": "872fb0c3fe92fdef962179051aa340550cf832be",
            "filename": "tests/regressiontests/modeladmin/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/cf70c96ce08bec8834ada695451cc915f7558dbd/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cf70c96ce08bec8834ada695451cc915f7558dbd/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py?ref=cf70c96ce08bec8834ada695451cc915f7558dbd",
            "patch": "@@ -1115,6 +1115,24 @@ class ValidationTestModelAdmin(ModelAdmin):\n \n         validate(ValidationTestModelAdmin, ValidationTestModel)\n \n+    def test_max_show_all_allowed_validation(self):\n+\n+        class ValidationTestModelAdmin(ModelAdmin):\n+            list_max_show_all = 'hello'\n+\n+        self.assertRaisesRegexp(\n+            ImproperlyConfigured,\n+            \"'ValidationTestModelAdmin.list_max_show_all' should be an integer.\",\n+            validate,\n+            ValidationTestModelAdmin,\n+            ValidationTestModel,\n+        )\n+\n+        class ValidationTestModelAdmin(ModelAdmin):\n+            list_max_show_all = 200\n+\n+        validate(ValidationTestModelAdmin, ValidationTestModel)\n+\n     def test_search_fields_validation(self):\n \n         class ValidationTestModelAdmin(ModelAdmin):"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 85,
        "deletions": 23
    }
}