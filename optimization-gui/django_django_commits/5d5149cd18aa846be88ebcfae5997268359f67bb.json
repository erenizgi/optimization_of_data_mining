{
    "author": "freakboy3742",
    "message": "Advanced deprecation of user-based messages and the LegacyFallbackStorage in contrib.messages.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15975 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5d5149cd18aa846be88ebcfae5997268359f67bb",
    "files": [
        {
            "sha": "c6692852990510276e4cb26d1da6f17473a95ad6",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=5d5149cd18aa846be88ebcfae5997268359f67bb",
            "patch": "@@ -502,7 +502,7 @@\n ############\n \n # Class to use as messges backend\n-MESSAGE_STORAGE = 'django.contrib.messages.storage.user_messages.LegacyFallbackStorage'\n+MESSAGE_STORAGE = 'django.contrib.messages.storage.fallback.FallbackStorage'\n \n # Default values of MESSAGE_LEVEL and MESSAGE_TAGS are defined within\n # django.contrib.messages to avoid imports in this settings file."
        },
        {
            "sha": "e0a76360862a719c6a09b4f1281ac811da0dbdbd",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 0,
            "deletions": 22,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=5d5149cd18aa846be88ebcfae5997268359f67bb",
            "patch": "@@ -345,13 +345,6 @@ def has_module_perms(self, app_label):\n \n         return _user_has_module_perms(self, app_label)\n \n-    def get_and_delete_messages(self):\n-        messages = []\n-        for m in self.message_set.all():\n-            messages.append(m.message)\n-            m.delete()\n-        return messages\n-\n     def email_user(self, subject, message, from_email=None):\n         \"Sends an email to this User.\"\n         from django.core.mail import send_mail\n@@ -387,21 +380,6 @@ def get_profile(self):\n         return self._profile_cache\n \n \n-class Message(models.Model):\n-    \"\"\"\n-    The message system is a lightweight way to queue messages for given\n-    users. A message is associated with a User instance (so it is only\n-    applicable for registered users). There's no concept of expiration or\n-    timestamps. Messages are created by the Django admin after successful\n-    actions. For example, \"The poll Foo was created successfully.\" is a\n-    message.\n-    \"\"\"\n-    user = models.ForeignKey(User, related_name='_message_set')\n-    message = models.TextField(_('message'))\n-\n-    def __unicode__(self):\n-        return self.message\n-\n class AnonymousUser(object):\n     id = None\n     username = ''"
        },
        {
            "sha": "1079ae17db05b630a83cedd441d1e964170080a4",
            "filename": "django/contrib/messages/api.py",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fmessages%2Fapi.py",
            "raw_url": "https://github.com/django/django/raw/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fmessages%2Fapi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Fapi.py?ref=5d5149cd18aa846be88ebcfae5997268359f67bb",
            "patch": "@@ -20,8 +20,6 @@ def add_message(request, level, message, extra_tags='', fail_silently=False):\n     \"\"\"\n     if hasattr(request, '_messages'):\n         return request._messages.add(level, message, extra_tags)\n-    if hasattr(request, 'user') and request.user.is_authenticated():\n-        return request.user.message_set.create(message=message)\n     if not fail_silently:\n         raise MessageFailure('Without the django.contrib.messages '\n                                 'middleware, messages can only be added to '"
        },
        {
            "sha": "17f0c552900010f25ac6e4a2320de04a7a7bc68d",
            "filename": "django/contrib/messages/storage/user_messages.py",
            "status": "removed",
            "additions": 0,
            "deletions": 64,
            "changes": 64,
            "blob_url": "https://github.com/django/django/blob/c349aad4129ee115a0ce4832009bab56b3f10781/django%2Fcontrib%2Fmessages%2Fstorage%2Fuser_messages.py",
            "raw_url": "https://github.com/django/django/raw/c349aad4129ee115a0ce4832009bab56b3f10781/django%2Fcontrib%2Fmessages%2Fstorage%2Fuser_messages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Fstorage%2Fuser_messages.py?ref=c349aad4129ee115a0ce4832009bab56b3f10781",
            "patch": "@@ -1,64 +0,0 @@\n-\"\"\"\n-Storages used to assist in the deprecation of contrib.auth User messages.\n-\n-\"\"\"\n-from django.contrib.messages import constants\n-from django.contrib.messages.storage.base import BaseStorage, Message\n-from django.contrib.auth.models import User\n-from django.contrib.messages.storage.fallback import FallbackStorage\n-\n-\n-class UserMessagesStorage(BaseStorage):\n-    \"\"\"\n-    Retrieves messages from the User, using the legacy user.message_set API.\n-\n-    This storage is \"read-only\" insofar as it can only retrieve and delete\n-    messages, not store them.\n-    \"\"\"\n-    session_key = '_messages'\n-\n-    def _get_messages_queryset(self):\n-        \"\"\"\n-        Returns the QuerySet containing all user messages (or ``None`` if\n-        request.user is not a contrib.auth User).\n-        \"\"\"\n-        user = getattr(self.request, 'user', None)\n-        if isinstance(user, User):\n-            return user._message_set.all()\n-\n-    def add(self, *args, **kwargs):\n-        raise NotImplementedError('This message storage is read-only.')\n-\n-    def _get(self, *args, **kwargs):\n-        \"\"\"\n-        Retrieves a list of messages assigned to the User.  This backend never\n-        stores anything, so all_retrieved is assumed to be False.\n-        \"\"\"\n-        queryset = self._get_messages_queryset()\n-        if queryset is None:\n-            # This is a read-only and optional storage, so to ensure other\n-            # storages will also be read if used with FallbackStorage an empty\n-            # list is returned rather than None.\n-            return [], False\n-        messages = []\n-        for user_message in queryset:\n-            messages.append(Message(constants.INFO, user_message.message))\n-        return messages, False\n-\n-    def _store(self, messages, *args, **kwargs):\n-        \"\"\"\n-        Removes any messages assigned to the User and returns the list of\n-        messages (since no messages are stored in this read-only storage).\n-        \"\"\"\n-        queryset = self._get_messages_queryset()\n-        if queryset is not None:\n-            queryset.delete()\n-        return messages\n-\n-\n-class LegacyFallbackStorage(FallbackStorage):\n-    \"\"\"\n-    Works like ``FallbackStorage`` but also handles retrieving (and clearing)\n-    contrib.auth User messages.\n-    \"\"\"\n-    storage_classes = (UserMessagesStorage,) + FallbackStorage.storage_classes"
        },
        {
            "sha": "f3f6b653d0ac350ce026d5add1e413f1c2047146",
            "filename": "django/contrib/messages/tests/__init__.py",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fmessages%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fmessages%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2F__init__.py?ref=5d5149cd18aa846be88ebcfae5997268359f67bb",
            "patch": "@@ -2,5 +2,3 @@\n from django.contrib.messages.tests.fallback import FallbackTest\n from django.contrib.messages.tests.middleware import MiddlewareTest\n from django.contrib.messages.tests.session import SessionTest\n-from django.contrib.messages.tests.user_messages import \\\n-                                           UserMessagesTest, LegacyFallbackTest"
        },
        {
            "sha": "932ca277dbb4057904cb07e38bd307884e632ee1",
            "filename": "django/contrib/messages/tests/base.py",
            "status": "modified",
            "additions": 0,
            "deletions": 42,
            "changes": 42,
            "blob_url": "https://github.com/django/django/blob/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/5d5149cd18aa846be88ebcfae5997268359f67bb/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fbase.py?ref=5d5149cd18aa846be88ebcfae5997268359f67bb",
            "patch": "@@ -60,9 +60,6 @@ def setUp(self):\n                                               self.storage_class.__name__)\n         self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n         settings.TEMPLATE_DIRS = ()\n-        self.save_warnings_state()\n-        warnings.filterwarnings('ignore', category=DeprecationWarning,\n-                                module='django.contrib.auth.models')\n \n     def tearDown(self):\n         for setting in self.restore_settings:\n@@ -74,7 +71,6 @@ def tearDown(self):\n         settings.INSTALLED_APPS = self._installed_apps\n         settings.MESSAGE_STORAGE = self._message_storage\n         settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n-        self.restore_warnings_state()\n \n     def restore_setting(self, setting):\n         if setting in self._remembered_settings:\n@@ -226,44 +222,6 @@ def test_multiple_posts(self):\n         for msg in data['messages']:\n             self.assertContains(response, msg)\n \n-    @skipUnlessAuthIsInstalled\n-    def test_middleware_disabled_auth_user(self):\n-        \"\"\"\n-        Tests that the messages API successfully falls back to using\n-        user.message_set to store messages directly when the middleware is\n-        disabled.\n-        \"\"\"\n-        settings.MESSAGE_LEVEL = constants.DEBUG\n-        user = User.objects.create_user('test', 'test@example.com', 'test')\n-        self.client.login(username='test', password='test')\n-        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS)\n-        settings.INSTALLED_APPS.remove(\n-            'django.contrib.messages',\n-        )\n-        settings.MIDDLEWARE_CLASSES = list(settings.MIDDLEWARE_CLASSES)\n-        settings.MIDDLEWARE_CLASSES.remove(\n-            'django.contrib.messages.middleware.MessageMiddleware',\n-        )\n-        settings.TEMPLATE_CONTEXT_PROCESSORS = \\\n-          list(settings.TEMPLATE_CONTEXT_PROCESSORS)\n-        settings.TEMPLATE_CONTEXT_PROCESSORS.remove(\n-            'django.contrib.messages.context_processors.messages',\n-        )\n-        data = {\n-            'messages': ['Test message %d' % x for x in xrange(10)],\n-        }\n-        show_url = reverse('django.contrib.messages.tests.urls.show')\n-        for level in ('debug', 'info', 'success', 'warning', 'error'):\n-            add_url = reverse('django.contrib.messages.tests.urls.add',\n-                              args=(level,))\n-            response = self.client.post(add_url, data, follow=True)\n-            self.assertRedirects(response, show_url)\n-            self.assertTrue('messages' in response.context)\n-            context_messages = list(response.context['messages'])\n-            for msg in data['messages']:\n-                self.assertTrue(msg in context_messages)\n-                self.assertContains(response, msg)\n-\n     def test_middleware_disabled_anon_user(self):\n         \"\"\"\n         Tests that, when the middleware is disabled and a user is not logged"
        },
        {
            "sha": "dad552c6feec8e6bc256c18ca0f679c3d82d6388",
            "filename": "django/contrib/messages/tests/user_messages.py",
            "status": "removed",
            "additions": 0,
            "deletions": 70,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/c349aad4129ee115a0ce4832009bab56b3f10781/django%2Fcontrib%2Fmessages%2Ftests%2Fuser_messages.py",
            "raw_url": "https://github.com/django/django/raw/c349aad4129ee115a0ce4832009bab56b3f10781/django%2Fcontrib%2Fmessages%2Ftests%2Fuser_messages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fmessages%2Ftests%2Fuser_messages.py?ref=c349aad4129ee115a0ce4832009bab56b3f10781",
            "patch": "@@ -1,70 +0,0 @@\n-from django import http\n-from django.contrib.auth.models import User\n-from django.contrib.messages.storage.user_messages import UserMessagesStorage,\\\n-    LegacyFallbackStorage\n-from django.contrib.messages.tests.base import skipUnlessAuthIsInstalled\n-from django.contrib.messages.tests.cookie import set_cookie_data\n-from django.contrib.messages.tests.fallback import FallbackTest\n-from django.test import TestCase\n-\n-\n-class UserMessagesTest(TestCase):\n-\n-    def setUp(self):\n-        self.user = User.objects.create(username='tester')\n-\n-    def test_add(self):\n-        storage = UserMessagesStorage(http.HttpRequest())\n-        self.assertRaises(NotImplementedError, storage.add, 'Test message 1')\n-\n-    def test_get_anonymous(self):\n-        # Ensure that the storage still works if no user is attached to the\n-        # request.\n-        storage = UserMessagesStorage(http.HttpRequest())\n-        self.assertEqual(len(storage), 0)\n-\n-    def test_get(self):\n-        storage = UserMessagesStorage(http.HttpRequest())\n-        storage.request.user = self.user\n-        self.user.message_set.create(message='test message')\n-\n-        self.assertEqual(len(storage), 1)\n-        self.assertEqual(list(storage)[0].message, 'test message')\n-\n-UserMessagesTest = skipUnlessAuthIsInstalled(UserMessagesTest)\n-\n-\n-class LegacyFallbackTest(FallbackTest, TestCase):\n-    storage_class = LegacyFallbackStorage\n-\n-    def setUp(self):\n-        super(LegacyFallbackTest, self).setUp()\n-        self.user = User.objects.create(username='tester')\n-\n-    def get_request(self, *args, **kwargs):\n-        request = super(LegacyFallbackTest, self).get_request(*args, **kwargs)\n-        request.user = self.user\n-        return request\n-\n-    def test_get_legacy_only(self):\n-        request = self.get_request()\n-        storage = self.storage_class(request)\n-        self.user.message_set.create(message='user message')\n-\n-        # Test that the message actually contains what we expect.\n-        self.assertEqual(len(storage), 1)\n-        self.assertEqual(list(storage)[0].message, 'user message')\n-\n-    def test_get_legacy(self):\n-        request = self.get_request()\n-        storage = self.storage_class(request)\n-        cookie_storage = self.get_cookie_storage(storage)\n-        self.user.message_set.create(message='user message')\n-        set_cookie_data(cookie_storage, ['cookie'])\n-\n-        # Test that the message actually contains what we expect.\n-        self.assertEqual(len(storage), 2)\n-        self.assertEqual(list(storage)[0].message, 'user message')\n-        self.assertEqual(list(storage)[1], 'cookie')\n-\n-LegacyFallbackTest = skipUnlessAuthIsInstalled(LegacyFallbackTest)"
        },
        {
            "sha": "a23faef54dc4eb75be0b3f5c0ee7a4f4a7df9905",
            "filename": "docs/ref/contrib/messages.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 29,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/5d5149cd18aa846be88ebcfae5997268359f67bb/docs%2Fref%2Fcontrib%2Fmessages.txt",
            "raw_url": "https://github.com/django/django/raw/5d5149cd18aa846be88ebcfae5997268359f67bb/docs%2Fref%2Fcontrib%2Fmessages.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fmessages.txt?ref=5d5149cd18aa846be88ebcfae5997268359f67bb",
            "patch": "@@ -83,37 +83,10 @@ Four storage classes are included:\n     Since it is uses SessionStorage, it also requires Django's\n     ``contrib.sessions`` application.\n \n-``'django.contrib.messages.storage.user_messages.LegacyFallbackStorage'``\n-    This is the default temporary storage class.\n-\n-    This class extends FallbackStorage and adds compatibility methods\n-    to retrieve any messages stored in the user Message model by code that\n-    has not yet been updated to use the new API. This storage is temporary\n-    (because it makes use of code that is pending deprecation) and will be\n-    removed in Django 1.4. At that time, the default storage will become\n-    ``django.contrib.messages.storage.fallback.FallbackStorage``. For more\n-    information, see `LegacyFallbackStorage`_ below.\n-\n To write your own storage class, subclass the ``BaseStorage`` class in\n ``django.contrib.messages.storage.base`` and implement the ``_get`` and\n ``_store`` methods.\n \n-LegacyFallbackStorage\n-^^^^^^^^^^^^^^^^^^^^^\n-\n-The ``LegacyFallbackStorage`` is a temporary tool to facilitate the transition\n-from the deprecated ``user.message_set`` API and will be removed in Django 1.4\n-according to Django's standard deprecation policy. For more information, see\n-the full :doc:`release process documentation </internals/release-process>`.\n-\n-In addition to the functionality in the ``FallbackStorage``, it adds a custom,\n-read-only storage class that retrieves messages from the user ``Message``\n-model. Any messages that were stored in the ``Message`` model (e.g., by code\n-that has not yet been updated to use the messages framework) will be retrieved\n-first, followed by those stored in a cookie and in the session, if any. Since\n-messages stored in the ``Message`` model do not have a concept of levels, they\n-will be assigned the ``INFO`` level by default.\n-\n Message levels\n --------------\n \n@@ -368,14 +341,13 @@ This sets the minimum message that will be saved in the message storage. See\n MESSAGE_STORAGE\n ---------------\n \n-Default: ``'django.contrib.messages.storage.user_messages.LegacyFallbackStorage'``\n+Default: ``'django.contrib.messages.storage.user_messages.FallbackStorage'``\n \n Controls where Django stores message data. Valid values are:\n \n     * ``'django.contrib.messages.storage.fallback.FallbackStorage'``\n     * ``'django.contrib.messages.storage.session.SessionStorage'``\n     * ``'django.contrib.messages.storage.cookie.CookieStorage'``\n-    * ``'django.contrib.messages.storage.user_messages.LegacyFallbackStorage'``\n \n See `Storage backends`_ for more details.\n "
        }
    ],
    "stats": {
        "total": 234,
        "additions": 2,
        "deletions": 232
    }
}