{
    "author": "claudep",
    "message": "Fixed #19367 -- Fixed saving ContentFile in filesystem storage\n\nThis was not working properly when ContentFile was initialized with\nan unicode string.\nThanks Alexey Boriskin for the report and the test.",
    "sha": "34dcf51e06fc57fc5462bd40f6a4c8ee949521da",
    "files": [
        {
            "sha": "2d1010001933b68cdeea90cdc19376d037cb6301",
            "filename": "django/core/files/base.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/34dcf51e06fc57fc5462bd40f6a4c8ee949521da/django%2Fcore%2Ffiles%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/34dcf51e06fc57fc5462bd40f6a4c8ee949521da/django%2Fcore%2Ffiles%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fbase.py?ref=34dcf51e06fc57fc5462bd40f6a4c8ee949521da",
            "patch": "@@ -6,7 +6,7 @@\n from django.utils.encoding import smart_text\n from django.core.files.utils import FileProxyMixin\n from django.utils import six\n-from django.utils.encoding import python_2_unicode_compatible\n+from django.utils.encoding import force_bytes, python_2_unicode_compatible\n \n @python_2_unicode_compatible\n class File(FileProxyMixin):\n@@ -134,8 +134,11 @@ class ContentFile(File):\n     A File-like object that takes just raw content, rather than an actual file.\n     \"\"\"\n     def __init__(self, content, name=None):\n-        content = content or b''\n-        stream_class = StringIO if isinstance(content, six.text_type) else BytesIO\n+        if six.PY3:\n+            stream_class = StringIO if isinstance(content, six.text_type) else BytesIO\n+        else:\n+            stream_class = BytesIO\n+            content = force_bytes(content)\n         super(ContentFile, self).__init__(stream_class(content), name=name)\n         self.size = len(content)\n "
        },
        {
            "sha": "45c18ba14a3a95ed5b9037c0b9688b4b277dead4",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/34dcf51e06fc57fc5462bd40f6a4c8ee949521da/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/34dcf51e06fc57fc5462bd40f6a4c8ee949521da/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=34dcf51e06fc57fc5462bd40f6a4c8ee949521da",
            "patch": "@@ -560,6 +560,13 @@ def test_multiple_calls(self):\n \n class ContentFileTestCase(unittest.TestCase):\n \n+    def setUp(self):\n+        self.storage_dir = tempfile.mkdtemp()\n+        self.storage = FileSystemStorage(self.storage_dir)\n+\n+    def tearDown(self):\n+        shutil.rmtree(self.storage_dir)\n+\n     def test_content_file_default_name(self):\n         self.assertEqual(ContentFile(b\"content\").name, None)\n \n@@ -576,7 +583,18 @@ def test_content_file_input_type(self):\n         retrieved content is of the same type.\n         \"\"\"\n         self.assertTrue(isinstance(ContentFile(b\"content\").read(), bytes))\n-        self.assertTrue(isinstance(ContentFile(\"espa単ol\").read(), six.text_type))\n+        if six.PY3:\n+            self.assertTrue(isinstance(ContentFile(\"espa単ol\").read(), six.text_type))\n+        else:\n+            self.assertTrue(isinstance(ContentFile(\"espa単ol\").read(), bytes))\n+\n+    def test_content_saving(self):\n+        \"\"\"\n+        Test that ContentFile can be saved correctly with the filesystem storage,\n+        both if it was initialized with string or unicode content\"\"\"\n+        self.storage.save('bytes.txt', ContentFile(b\"content\"))\n+        self.storage.save('unicode.txt', ContentFile(\"espa単ol\"))\n+\n \n class NoNameFileTestCase(unittest.TestCase):\n     \"\"\""
        }
    ],
    "stats": {
        "total": 29,
        "additions": 25,
        "deletions": 4
    }
}