{
    "author": "freakboy3742",
    "message": "Fixed #14824 -- Corrected the handling of formats when USE_L10N is disabled. Thanks to nullie for the report and initial patch, and to idle for the separate report with helpful debug info.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15404 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d44fb0557a0a9d8fab62b1e48078be498c61287a",
    "files": [
        {
            "sha": "0dc23402f20bc988fff8d7fdcbbb8a967d36eb85",
            "filename": "django/utils/formats.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/d44fb0557a0a9d8fab62b1e48078be498c61287a/django%2Futils%2Fformats.py",
            "raw_url": "https://github.com/django/django/raw/d44fb0557a0a9d8fab62b1e48078be498c61287a/django%2Futils%2Fformats.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fformats.py?ref=d44fb0557a0a9d8fab62b1e48078be498c61287a",
            "patch": "@@ -14,11 +14,21 @@\n _format_cache = {}\n _format_modules_cache = {}\n \n+def reset_format_cache():\n+    \"\"\"Clear any cached formats.\n+\n+    This method is provided primarily for testing purposes,\n+    so that the effects of cached formats can be removed.\n+    \"\"\"\n+    global _format_cache, _format_modules_cache\n+    _format_cache = {}\n+    _format_modules_cache = {}\n+\n def iter_format_modules(lang):\n     \"\"\"\n     Does the heavy lifting of finding format modules.\n     \"\"\"\n-    if check_for_language(lang) or settings.USE_L10N:\n+    if check_for_language(lang):\n         format_locations = ['django.conf.locale.%s']\n         if settings.FORMAT_MODULE_PATH:\n             format_locations.append(settings.FORMAT_MODULE_PATH + '.%s')"
        },
        {
            "sha": "096fdeafb3e68a7006e6ae3f49298a8ccc314454",
            "filename": "django/views/i18n.py",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/d44fb0557a0a9d8fab62b1e48078be498c61287a/django%2Fviews%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/d44fb0557a0a9d8fab62b1e48078be498c61287a/django%2Fviews%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fi18n.py?ref=d44fb0557a0a9d8fab62b1e48078be498c61287a",
            "patch": "@@ -7,7 +7,7 @@\n from django.utils.translation import check_for_language, activate, to_locale, get_language\n from django.utils.text import javascript_quote\n from django.utils.encoding import smart_unicode\n-from django.utils.formats import get_format_modules\n+from django.utils.formats import get_format_modules, get_format\n \n def set_language(request):\n     \"\"\"\n@@ -49,10 +49,7 @@ def get_formats():\n     result = {}\n     for module in [settings] + get_format_modules(reverse=True):\n         for attr in FORMAT_SETTINGS:\n-            try:\n-                result[attr] = getattr(module, attr)\n-            except AttributeError:\n-                pass\n+            result[attr] = get_format(attr)\n     src = []\n     for k, v in result.items():\n         if isinstance(v, (basestring, int)):"
        },
        {
            "sha": "21c5eb3471c606953f9bfdaa9d3996704082c643",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 38,
            "deletions": 12,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/d44fb0557a0a9d8fab62b1e48078be498c61287a/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d44fb0557a0a9d8fab62b1e48078be498c61287a/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=d44fb0557a0a9d8fab62b1e48078be498c61287a",
            "patch": "@@ -48,12 +48,18 @@ class AdminViewBasicTest(TestCase):\n     urlbit = 'admin'\n \n     def setUp(self):\n-        self.old_language_code = settings.LANGUAGE_CODE\n+        self.old_USE_I18N = settings.LANGUAGE_CODE\n+        self.old_USE_L10N = settings.USE_L10N\n+        self.old_LANGUAGE_CODE = settings.LANGUAGE_CODE\n         self.client.login(username='super', password='secret')\n+        settings.USE_I18N = True\n \n     def tearDown(self):\n-        settings.LANGUAGE_CODE = self.old_language_code\n+        settings.USE_I18N = self.old_USE_I18N\n+        settings.USE_L10N = self.old_USE_L10N\n+        settings.LANGUAGE_CODE = self.old_LANGUAGE_CODE\n         self.client.logout()\n+        formats.reset_format_cache()\n \n     def testTrailingSlashRequired(self):\n         \"\"\"\n@@ -351,22 +357,42 @@ def testI18NLanguageNonEnglishDefault(self):\n         if the default language is non-English but the selected language\n         is English. See #13388 and #3594 for more details.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        activate('en-us')\n-        response = self.client.get('/test_admin/admin/jsi18n/')\n-        self.assertNotContains(response, 'Choisir une heure')\n-        deactivate()\n+        try:\n+            settings.LANGUAGE_CODE = 'fr'\n+            activate('en-us')\n+            response = self.client.get('/test_admin/admin/jsi18n/')\n+            self.assertNotContains(response, 'Choisir une heure')\n+        finally:\n+            deactivate()\n \n     def testI18NLanguageNonEnglishFallback(self):\n         \"\"\"\n         Makes sure that the fallback language is still working properly\n         in cases where the selected language cannot be found.\n         \"\"\"\n-        settings.LANGUAGE_CODE = 'fr'\n-        activate('none')\n-        response = self.client.get('/test_admin/admin/jsi18n/')\n-        self.assertContains(response, 'Choisir une heure')\n-        deactivate()\n+        try:\n+            settings.LANGUAGE_CODE = 'fr'\n+            activate('none')\n+            response = self.client.get('/test_admin/admin/jsi18n/')\n+            self.assertContains(response, 'Choisir une heure')\n+        finally:\n+            deactivate()\n+\n+    def testL10NDeactivated(self):\n+        \"\"\"\n+        Check if L10N is deactivated, the Javascript i18n view doesn't\n+        return localized date/time formats. Refs #14824.\n+        \"\"\"\n+        try:\n+            settings.LANGUAGE_CODE = 'ru'\n+            settings.USE_L10N = False\n+            activate('ru')\n+            response = self.client.get('/test_admin/admin/jsi18n/')\n+            self.assertNotContains(response, '%d.%m.%Y %H:%M:%S')\n+            self.assertContains(response, '%Y-%m-%d %H:%M:%S')\n+        finally:\n+            deactivate()\n+\n \n     def test_disallowed_filtering(self):\n         self.assertRaises(SuspiciousOperation,"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 51,
        "deletions": 18
    }
}