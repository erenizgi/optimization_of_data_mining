{
    "author": "jezdez",
    "message": "Fixed #11585 -- Added ability to translate and prefix URL patterns with a language code as an alternative method for language discovery. Many thanks to Orne Brocaar for his initial work and Carl Meyer for feedback.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16405 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "896e3c69c7eec311085da349a329ee80c8fca132",
    "files": [
        {
            "sha": "0e774138df728d7317655697c0511d4f8514abf3",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -94,6 +94,7 @@ answer newbie questions, and generally made Django that much better:\n     Sean Brant\n     Andrew Brehaut <http://brehaut.net/blog>\n     David Brenneman <http://davidbrenneman.com>\n+    Orne Brocaar <http://brocaar.com/>\n     brut.alll@gmail.com\n     bthomas\n     btoll@bestweb.net"
        },
        {
            "sha": "84b1f25bf79b8dc66e6eef9bebf11601c4bf62d4",
            "filename": "django/conf/urls/defaults.py",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fconf%2Furls%2Fdefaults.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fconf%2Furls%2Fdefaults.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Furls%2Fdefaults.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -1,5 +1,8 @@\n-from django.core.urlresolvers import RegexURLPattern, RegexURLResolver\n+from django.core.urlresolvers import (RegexURLPattern,\n+    RegexURLResolver, LocaleRegexURLResolver)\n from django.core.exceptions import ImproperlyConfigured\n+from django.utils.importlib import import_module\n+\n \n __all__ = ['handler404', 'handler500', 'include', 'patterns', 'url']\n \n@@ -15,6 +18,21 @@ def include(arg, namespace=None, app_name=None):\n     else:\n         # No namespace hint - use manually provided namespace\n         urlconf_module = arg\n+\n+    if isinstance(urlconf_module, basestring):\n+        urlconf_module = import_module(urlconf_module)\n+    patterns = getattr(urlconf_module, 'urlpatterns', urlconf_module)\n+\n+    # Make sure we can iterate through the patterns (without this, some\n+    # testcases will break).\n+    if isinstance(patterns, (list, tuple)):\n+        for url_pattern in patterns:\n+            # Test if the LocaleRegexURLResolver is used within the include;\n+            # this should throw an error since this is not allowed!\n+            if isinstance(url_pattern, LocaleRegexURLResolver):\n+                raise ImproperlyConfigured(\n+                    'Using i18n_patterns in an included URLconf is not allowed.')\n+\n     return (urlconf_module, app_name, namespace)\n \n def patterns(prefix, *args):"
        },
        {
            "sha": "67931aaf1c5be58246378ff7a9252b8b68884a84",
            "filename": "django/conf/urls/i18n.py",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fconf%2Furls%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fconf%2Furls%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Furls%2Fi18n.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -1,4 +1,19 @@\n-from django.conf.urls.defaults import *\n+from django.conf import settings\n+from django.conf.urls.defaults import patterns\n+from django.core.urlresolvers import LocaleRegexURLResolver\n+\n+def i18n_patterns(prefix, *args):\n+    \"\"\"\n+    Adds the language code prefix to every URL pattern within this\n+    function. This may only be used in the root URLconf, not in an included\n+    URLconf.\n+\n+    \"\"\"\n+    pattern_list = patterns(prefix, *args)\n+    if not settings.USE_I18N:\n+        return pattern_list\n+    return [LocaleRegexURLResolver(pattern_list)]\n+\n \n urlpatterns = patterns('',\n     (r'^setlang/$', 'django.views.i18n.set_language'),"
        },
        {
            "sha": "079f7ab2da4a4972eb68fea7aa85cdafebfb6662",
            "filename": "django/contrib/admindocs/views.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fcontrib%2Fadmindocs%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fcontrib%2Fadmindocs%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmindocs%2Fviews.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -346,12 +346,12 @@ def extract_views_from_urlpatterns(urlpatterns, base=''):\n     \"\"\"\n     views = []\n     for p in urlpatterns:\n-        if hasattr(p, '_get_callback'):\n+        if hasattr(p, 'callback'):\n             try:\n-                views.append((p._get_callback(), base + p.regex.pattern))\n+                views.append((p.callback, base + p.regex.pattern))\n             except ViewDoesNotExist:\n                 continue\n-        elif hasattr(p, '_get_url_patterns'):\n+        elif hasattr(p, 'url_patterns'):\n             try:\n                 patterns = p.url_patterns\n             except ImportError:"
        },
        {
            "sha": "5a78c9bfc347f48ed1a3a5d1bb48e31b8a01b45f",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 87,
            "deletions": 34,
            "changes": 121,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -11,13 +11,14 @@\n from threading import local\n \n from django.http import Http404\n-from django.conf import settings\n from django.core.exceptions import ImproperlyConfigured, ViewDoesNotExist\n from django.utils.datastructures import MultiValueDict\n from django.utils.encoding import iri_to_uri, force_unicode, smart_str\n from django.utils.functional import memoize, lazy\n from django.utils.importlib import import_module\n from django.utils.regex_helper import normalize\n+from django.utils.translation import get_language\n+\n \n _resolver_cache = {} # Maps URLconf modules to RegexURLResolver instances.\n _callable_cache = {} # Maps view and url pattern names to their view functions.\n@@ -50,13 +51,13 @@ def __init__(self, func, args, kwargs, url_name=None, app_name=None, namespaces=\n                 url_name = '.'.join([func.__module__, func.__name__])\n         self.url_name = url_name\n \n+    @property\n     def namespace(self):\n         return ':'.join(self.namespaces)\n-    namespace = property(namespace)\n \n+    @property\n     def view_name(self):\n         return ':'.join([ x for x in [ self.namespace, self.url_name ]  if x ])\n-    view_name = property(view_name)\n \n     def __getitem__(self, index):\n         return (self.func, self.args, self.kwargs)[index]\n@@ -115,13 +116,43 @@ def get_mod_func(callback):\n         return callback, ''\n     return callback[:dot], callback[dot+1:]\n \n-class RegexURLPattern(object):\n+class LocaleRegexProvider(object):\n+    \"\"\"\n+    A mixin to provide a default regex property which can vary by active\n+    language.\n+\n+    \"\"\"\n+    def __init__(self, regex):\n+        # regex is either a string representing a regular expression, or a\n+        # translatable string (using ugettext_lazy) representing a regular\n+        # expression.\n+        self._regex = regex\n+        self._regex_dict = {}\n+\n+\n+    @property\n+    def regex(self):\n+        \"\"\"\n+        Returns a compiled regular expression, depending upon the activated\n+        language-code.\n+        \"\"\"\n+        language_code = get_language()\n+        if language_code not in self._regex_dict:\n+            if isinstance(self._regex, basestring):\n+                compiled_regex = re.compile(self._regex, re.UNICODE)\n+            else:\n+                regex = force_unicode(self._regex)\n+                compiled_regex = re.compile(regex, re.UNICODE)\n+            self._regex_dict[language_code] = compiled_regex\n+        return self._regex_dict[language_code]\n+\n+\n+class RegexURLPattern(LocaleRegexProvider):\n     def __init__(self, regex, callback, default_args=None, name=None):\n-        # regex is a string representing a regular expression.\n+        LocaleRegexProvider.__init__(self, regex)\n         # callback is either a string like 'foo.views.news.stories.story_detail'\n         # which represents the path to a module and a view function name, or a\n         # callable object (view).\n-        self.regex = re.compile(regex, re.UNICODE)\n         if callable(callback):\n             self._callback = callback\n         else:\n@@ -157,7 +188,8 @@ def resolve(self, path):\n \n             return ResolverMatch(self.callback, args, kwargs, self.name)\n \n-    def _get_callback(self):\n+    @property\n+    def callback(self):\n         if self._callback is not None:\n             return self._callback\n         try:\n@@ -169,23 +201,21 @@ def _get_callback(self):\n             mod_name, func_name = get_mod_func(self._callback_str)\n             raise ViewDoesNotExist(\"Tried %s in module %s. Error was: %s\" % (func_name, mod_name, str(e)))\n         return self._callback\n-    callback = property(_get_callback)\n \n-class RegexURLResolver(object):\n+class RegexURLResolver(LocaleRegexProvider):\n     def __init__(self, regex, urlconf_name, default_kwargs=None, app_name=None, namespace=None):\n-        # regex is a string representing a regular expression.\n+        LocaleRegexProvider.__init__(self, regex)\n         # urlconf_name is a string representing the module containing URLconfs.\n-        self.regex = re.compile(regex, re.UNICODE)\n         self.urlconf_name = urlconf_name\n         if not isinstance(urlconf_name, basestring):\n             self._urlconf_module = self.urlconf_name\n         self.callback = None\n         self.default_kwargs = default_kwargs or {}\n         self.namespace = namespace\n         self.app_name = app_name\n-        self._reverse_dict = None\n-        self._namespace_dict = None\n-        self._app_dict = None\n+        self._reverse_dict = {}\n+        self._namespace_dict = {}\n+        self._app_dict = {}\n \n     def __repr__(self):\n         return smart_str(u'<%s %s (%s:%s) %s>' % (self.__class__.__name__, self.urlconf_name, self.app_name, self.namespace, self.regex.pattern))\n@@ -194,6 +224,7 @@ def _populate(self):\n         lookups = MultiValueDict()\n         namespaces = {}\n         apps = {}\n+        language_code = get_language()\n         for pattern in reversed(self.url_patterns):\n             p_pattern = pattern.regex.pattern\n             if p_pattern.startswith('^'):\n@@ -220,27 +251,30 @@ def _populate(self):\n                 lookups.appendlist(pattern.callback, (bits, p_pattern, pattern.default_args))\n                 if pattern.name is not None:\n                     lookups.appendlist(pattern.name, (bits, p_pattern, pattern.default_args))\n-        self._reverse_dict = lookups\n-        self._namespace_dict = namespaces\n-        self._app_dict = apps\n-\n-    def _get_reverse_dict(self):\n-        if self._reverse_dict is None:\n+        self._reverse_dict[language_code] = lookups\n+        self._namespace_dict[language_code] = namespaces\n+        self._app_dict[language_code] = apps\n+\n+    @property\n+    def reverse_dict(self):\n+        language_code = get_language()\n+        if language_code not in self._reverse_dict:\n             self._populate()\n-        return self._reverse_dict\n-    reverse_dict = property(_get_reverse_dict)\n+        return self._reverse_dict[language_code]\n \n-    def _get_namespace_dict(self):\n-        if self._namespace_dict is None:\n+    @property\n+    def namespace_dict(self):\n+        language_code = get_language()\n+        if language_code not in self._namespace_dict:\n             self._populate()\n-        return self._namespace_dict\n-    namespace_dict = property(_get_namespace_dict)\n+        return self._namespace_dict[language_code]\n \n-    def _get_app_dict(self):\n-        if self._app_dict is None:\n+    @property\n+    def app_dict(self):\n+        language_code = get_language()\n+        if language_code not in self._app_dict:\n             self._populate()\n-        return self._app_dict\n-    app_dict = property(_get_app_dict)\n+        return self._app_dict[language_code]\n \n     def resolve(self, path):\n         tried = []\n@@ -267,22 +301,22 @@ def resolve(self, path):\n             raise Resolver404({'tried': tried, 'path': new_path})\n         raise Resolver404({'path' : path})\n \n-    def _get_urlconf_module(self):\n+    @property\n+    def urlconf_module(self):\n         try:\n             return self._urlconf_module\n         except AttributeError:\n             self._urlconf_module = import_module(self.urlconf_name)\n             return self._urlconf_module\n-    urlconf_module = property(_get_urlconf_module)\n \n-    def _get_url_patterns(self):\n+    @property\n+    def url_patterns(self):\n         patterns = getattr(self.urlconf_module, \"urlpatterns\", self.urlconf_module)\n         try:\n             iter(patterns)\n         except TypeError:\n             raise ImproperlyConfigured(\"The included urlconf %s doesn't have any patterns in it\" % self.urlconf_name)\n         return patterns\n-    url_patterns = property(_get_url_patterns)\n \n     def _resolve_special(self, view_type):\n         callback = getattr(self.urlconf_module, 'handler%s' % view_type, None)\n@@ -343,6 +377,25 @@ def reverse(self, lookup_view, *args, **kwargs):\n         raise NoReverseMatch(\"Reverse for '%s' with arguments '%s' and keyword \"\n                 \"arguments '%s' not found.\" % (lookup_view_s, args, kwargs))\n \n+class LocaleRegexURLResolver(RegexURLResolver):\n+    \"\"\"\n+    A URL resolver that always matches the active language code as URL prefix.\n+\n+    Rather than taking a regex argument, we just override the ``regex``\n+    function to always return the active language-code as regex.\n+    \"\"\"\n+    def __init__(self, urlconf_name, default_kwargs=None, app_name=None, namespace=None):\n+        super(LocaleRegexURLResolver, self).__init__(\n+            None, urlconf_name, default_kwargs, app_name, namespace)\n+\n+    @property\n+    def regex(self):\n+        language_code = get_language()\n+        if language_code not in self._regex_dict:\n+            regex_compiled = re.compile('^%s/' % language_code, re.UNICODE)\n+            self._regex_dict[language_code] = regex_compiled\n+        return self._regex_dict[language_code]\n+\n def resolve(path, urlconf=None):\n     if urlconf is None:\n         urlconf = get_urlconf()"
        },
        {
            "sha": "d42a615b04dda315350099a19c5a2ad857ff703f",
            "filename": "django/middleware/locale.py",
            "status": "modified",
            "additions": 23,
            "deletions": 3,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fmiddleware%2Flocale.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Fmiddleware%2Flocale.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Flocale.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -1,5 +1,7 @@\n-\"this is the locale selecting middleware that will look at accept headers\"\n+\"This is the locale selecting middleware that will look at accept headers\"\n \n+from django.core.urlresolvers import get_resolver, LocaleRegexURLResolver\n+from django.http import HttpResponseRedirect\n from django.utils.cache import patch_vary_headers\n from django.utils import translation\n \n@@ -18,8 +20,26 @@ def process_request(self, request):\n         request.LANGUAGE_CODE = translation.get_language()\n \n     def process_response(self, request, response):\n+        language = translation.get_language()\n+        translation.deactivate()\n+\n+        if (response.status_code == 404 and\n+                not translation.get_language_from_path(request.path_info)\n+                    and self.is_language_prefix_patterns_used()):\n+            return HttpResponseRedirect(\n+                '/%s%s' % (language, request.get_full_path()))\n+\n         patch_vary_headers(response, ('Accept-Language',))\n         if 'Content-Language' not in response:\n-            response['Content-Language'] = translation.get_language()\n-        translation.deactivate()\n+            response['Content-Language'] = language\n         return response\n+\n+    def is_language_prefix_patterns_used(self):\n+        \"\"\"\n+        Returns `True` if the `LocaleRegexURLResolver` is used\n+        at root level of the urlpatterns, else it returns `False`.\n+        \"\"\"\n+        for url_pattern in get_resolver(None).url_patterns:\n+            if isinstance(url_pattern, LocaleRegexURLResolver):\n+                return True\n+        return False"
        },
        {
            "sha": "acf4d8deadb6666a1ce832be1c555a1b2389c145",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -144,6 +144,9 @@ def to_locale(language):\n def get_language_from_request(request):\n     return _trans.get_language_from_request(request)\n \n+def get_language_from_path(path):\n+    return _trans.get_language_from_path(path)\n+\n def templatize(src, origin=None):\n     return _trans.templatize(src, origin)\n "
        },
        {
            "sha": "daee96eb752ce3089cdf7068611b5b284b32cb04",
            "filename": "django/utils/translation/trans_null.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Futils%2Ftranslation%2Ftrans_null.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Futils%2Ftranslation%2Ftrans_null.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_null.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -58,3 +58,7 @@ def to_locale(language):\n \n def get_language_from_request(request):\n     return settings.LANGUAGE_CODE\n+\n+def get_language_from_path(request):\n+    return None\n+"
        },
        {
            "sha": "9f930b54ef3b1ff6df64ddc2f3e18006e770de1c",
            "filename": "django/utils/translation/trans_real.py",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/django%2Futils%2Ftranslation%2Ftrans_real.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_real.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -35,6 +35,8 @@\n         (?:\\s*,\\s*|$)                            # Multiple accepts per header.\n         ''', re.VERBOSE)\n \n+language_code_prefix_re = re.compile(r'^/([\\w-]+)/')\n+\n def to_locale(language, to_lower=False):\n     \"\"\"\n     Turns a language name (en-us) into a locale name (en_US). If 'to_lower' is\n@@ -336,14 +338,28 @@ def check_for_language(lang_code):\n     \"\"\"\n     Checks whether there is a global language file for the given language\n     code. This is used to decide whether a user-provided language is\n-    available. This is only used for language codes from either the cookies or\n-    session and during format localization.\n+    available. This is only used for language codes from either the cookies\n+    or session and during format localization.\n     \"\"\"\n     for path in all_locale_paths():\n         if gettext_module.find('django', path, [to_locale(lang_code)]) is not None:\n             return True\n     return False\n \n+def get_language_from_path(path, supported=None):\n+    \"\"\"\n+    Returns the language-code if there is a valid language-code\n+    found in the `path`.\n+    \"\"\"\n+    if supported is None:\n+        from django.conf import settings\n+        supported = dict(settings.LANGUAGES)\n+    regex_match = language_code_prefix_re.match(path)\n+    if regex_match:\n+        lang_code = regex_match.group(1)\n+        if lang_code in supported and check_for_language(lang_code):\n+            return lang_code\n+\n def get_language_from_request(request):\n     \"\"\"\n     Analyzes the request to find what language the user wants the system to\n@@ -355,6 +371,10 @@ def get_language_from_request(request):\n     from django.conf import settings\n     supported = dict(settings.LANGUAGES)\n \n+    lang_code = get_language_from_path(request.path_info, supported)\n+    if lang_code is not None:\n+        return lang_code\n+\n     if hasattr(request, 'session'):\n         lang_code = request.session.get('django_language', None)\n         if lang_code in supported and lang_code is not None and check_for_language(lang_code):"
        },
        {
            "sha": "e7e8f45795c8961759d08757f16dbe56ad33d4b3",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -167,6 +167,16 @@ a :class:`~django.forms.fields.GenericIPAddressField` form field and\n the validators :data:`~django.core.validators.validate_ipv46_address` and\n :data:`~django.core.validators.validate_ipv6_address`\n \n+Translating URL patterns\n+~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Django 1.4 gained the ability to look for a language prefix in the URL pattern\n+when using the new :func:`django.conf.urls.i18n.i18n_patterns` helper function.\n+Additionally, it's now possible to define translatable URL patterns using\n+:func:`~django.utils.translation.ugettext_lazy`. See\n+:ref:`url-internationalization` for more information about the language prefix\n+and how to internationalize URL patterns.\n+\n Minor features\n ~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "641deae939f205862e139c4a7e866c3bf6761fd0",
            "filename": "docs/topics/i18n/deployment.txt",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/docs%2Ftopics%2Fi18n%2Fdeployment.txt",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/docs%2Ftopics%2Fi18n%2Fdeployment.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Fdeployment.txt?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -59,7 +59,9 @@ matters, you should follow these guidelines:\n \n     * Make sure it's one of the first middlewares installed.\n     * It should come after ``SessionMiddleware``, because ``LocaleMiddleware``\n-      makes use of session data.\n+      makes use of session data. And it should come before ``CommonMiddleware``\n+      because ``CommonMiddleware`` needs an activated language in order\n+      to resolve the requested URL.\n     * If you use ``CacheMiddleware``, put ``LocaleMiddleware`` after it.\n \n For example, your :setting:`MIDDLEWARE_CLASSES` might look like this::\n@@ -76,8 +78,15 @@ For example, your :setting:`MIDDLEWARE_CLASSES` might look like this::\n ``LocaleMiddleware`` tries to determine the user's language preference by\n following this algorithm:\n \n-    * First, it looks for a ``django_language`` key in the current user's\n-      session.\n+.. versionchanged:: 1.4\n+\n+    * First, it looks for the language prefix in the requested URL.  This is\n+      only performed when you are using the ``i18n_patterns`` function in your\n+      root URLconf. See :ref:`url-internationalization` for more information\n+      about the language prefix and how to internationalize URL patterns.\n+\n+    * Failing that, it looks for a ``django_language`` key in the current\n+      user's session.\n \n     * Failing that, it looks for a cookie.\n "
        },
        {
            "sha": "559f60fcc5a79e76d51b186edc7746728fdb0371",
            "filename": "docs/topics/i18n/internationalization.txt",
            "status": "modified",
            "additions": 132,
            "deletions": 0,
            "changes": 132,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/docs%2Ftopics%2Fi18n%2Finternationalization.txt",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/docs%2Ftopics%2Fi18n%2Finternationalization.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Finternationalization.txt?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -753,6 +753,138 @@ This isn't as fast as string interpolation in Python, so keep it to those\n cases where you really need it (for example, in conjunction with ``ngettext``\n to produce proper pluralizations).\n \n+.. _url-internationalization:\n+\n+Specifying translation strings: In URL patterns\n+===============================================\n+\n+..  versionadded:: 1.4\n+\n+.. module:: django.conf.urls.i18n\n+\n+Django provides two mechanisms to internationalize URL patterns:\n+\n+* Adding the language prefix to the root of the URL patterns to make it\n+  possible for :class:`~django.middleware.locale.LocaleMiddleware` to detect\n+  the language to activate from the requested URL.\n+\n+* Making URL patterns themselves translatable via the\n+  :func:`django.utils.translation.ugettext_lazy()` function.\n+\n+.. warning::\n+\n+    Using either one of these features requires that an active language be set\n+    for each request; in other words, you need to have\n+    :class:`django.middleware.locale.LocaleMiddleware` in your\n+    :setting:`MIDDLEWARE_CLASSES` setting.\n+\n+Language prefix in URL patterns\n+-------------------------------\n+\n+.. function:: i18n_patterns(prefix, pattern_description, ...)\n+\n+This function can be used in your root URLconf as a replacement for the normal\n+:func:`django.conf.urls.defaults.patterns` function. Django will automatically\n+prepend the current active language code to all url patterns defined within\n+:func:`~django.conf.urls.i18n.i18n_patterns`. Example URL patterns::\n+\n+    from django.conf.urls.defaults import patterns, include, url\n+    from django.conf.urls.i18n import i18n_patterns\n+\n+    urlpatterns = patterns(''\n+        url(r'^sitemap\\.xml$', 'sitemap.view', name='sitemap_xml'),\n+    )\n+\n+    news_patterns = patterns(''\n+        url(r'^$', 'news.views.index', name='index'),\n+        url(r'^category/(?P<slug>[\\w-]+)/$', 'news.views.category', name='category'),\n+        url(r'^(?P<slug>[\\w-]+)/$', 'news.views.details', name='detail'),\n+    )\n+\n+    urlpatterns += i18n_patterns('',\n+        url(r'^about/$', 'about.view', name='about'),\n+        url(r'^news/$', include(news_patterns, namespace='news')),\n+    )\n+\n+\n+After defining these URL patterns, Django will automatically add the\n+language prefix to the URL patterns that were added by the ``i18n_patterns``\n+function. Example::\n+\n+    from django.core.urlresolvers import reverse\n+    from django.utils.translation import activate\n+\n+    >>> activate('en')\n+    >>> reverse('sitemap_xml')\n+    '/sitemap.xml'\n+    >>> reverse('news:index')\n+    '/en/news/'\n+\n+    >>> activate('nl')\n+    >>> reverse('news:detail', kwargs={'slug': 'news-slug'})\n+    '/nl/news/news-slug/'\n+\n+.. warning::\n+\n+    :func:`~django.conf.urls.i18n.i18n_patterns` is only allowed in your root\n+    URLconf. Using it within an included URLconf will throw an\n+    :exc:`ImproperlyConfigured` exception.\n+\n+.. warning::\n+\n+    Ensure that you don't have non-prefixed URL patterns that might collide\n+    with an automatically-added language prefix.\n+\n+\n+Translating URL patterns\n+------------------------\n+\n+URL patterns can also be marked translatable using the\n+:func:`~django.utils.translation.ugettext_lazy` function. Example::\n+\n+    from django.conf.urls.defaults import patterns, include, url\n+    from django.conf.urls.i18n import i18n_patterns\n+    from django.utils.translation import ugettext_lazy as _\n+\n+    urlpatterns = patterns(''\n+        url(r'^sitemap\\.xml$', 'sitemap.view', name='sitemap_xml'),\n+    )\n+\n+    news_patterns = patterns(''\n+        url(r'^$', 'news.views.index', name='index'),\n+        url(_(r'^category/(?P<slug>[\\w-]+)/$'), 'news.views.category', name='category'),\n+        url(r'^(?P<slug>[\\w-]+)/$', 'news.views.details', name='detail'),\n+    )\n+\n+    urlpatterns += i18n_patterns('',\n+        url(_(r'^about/$'), 'about.view', name='about'),\n+        url(_(r'^news/$'), include(news_patterns, namespace='news')),\n+    )\n+\n+\n+After you've created the translations (see :doc:`localization` for more\n+information), the :func:`~django.core.urlresolvers.reverse` function will\n+return the URL in the active language. Example::\n+\n+    from django.core.urlresolvers import reverse\n+    from django.utils.translation import activate\n+\n+    >>> activate('en')\n+    >>> reverse('news:category', kwargs={'slug': 'recent'})\n+    '/en/news/category/recent/'\n+\n+    >>> activate('nl')\n+    >>> reverse('news:category', kwargs={'slug': 'recent'})\n+    '/nl/nieuws/categorie/recent/'\n+\n+.. warning::\n+\n+    In most cases, it's best to use translated URLs only within a\n+    language-code-prefixed block of patterns (using\n+    :func:`~django.conf.urls.i18n.i18n_patterns`), to avoid the possibility\n+    that a carelessly translated URL causes a collision with a non-translated\n+    URL pattern.\n+\n .. _set_language-redirect-view:\n \n The ``set_language`` redirect view"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/i18n/patterns/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2F__init__.py?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "ec7644b504c3a368f4fd1c48bf1fc666890d797e",
            "filename": "tests/regressiontests/i18n/patterns/locale/en/LC_MESSAGES/django.mo",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.mo",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.mo",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.mo?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "9a14a80ceb8f99d48c93f5eac9cd7971b6ce1898",
            "filename": "tests/regressiontests/i18n/patterns/locale/en/LC_MESSAGES/django.po",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fen%2FLC_MESSAGES%2Fdjango.po?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,37 @@\n+# SOME DESCRIPTIVE TITLE.\n+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER\n+# This file is distributed under the same license as the PACKAGE package.\n+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.\n+#\n+msgid \"\"\n+msgstr \"\"\n+\"Project-Id-Version: PACKAGE VERSION\\n\"\n+\"Report-Msgid-Bugs-To: \\n\"\n+\"POT-Creation-Date: 2011-06-15 11:33+0200\\n\"\n+\"PO-Revision-Date: 2011-06-14 16:16+0100\\n\"\n+\"Last-Translator: Jannis Leidel <jannis@leidel.info>\\n\"\n+\"Language-Team: LANGUAGE <LL@li.org>\\n\"\n+\"MIME-Version: 1.0\\n\"\n+\"Content-Type: text/plain; charset=UTF-8\\n\"\n+\"Content-Transfer-Encoding: 8bit\\n\"\n+\"Language: \\n\"\n+\n+#: urls/default.py:11\n+msgid \"^translated/$\"\n+msgstr \"^translated/$\"\n+\n+#: urls/default.py:12\n+msgid \"^translated/(?P<slug>[\\\\w-]+)/$\"\n+msgstr \"^translated/(?P<slug>[\\\\w-]+)/$\"\n+\n+#: urls/default.py:17\n+msgid \"^users/$\"\n+msgstr \"^users/$\"\n+\n+#: urls/default.py:18 urls/wrong.py:7\n+msgid \"^account/\"\n+msgstr \"^account/\"\n+\n+#: urls/namespace.py:9 urls/wrong_namespace.py:10\n+msgid \"^register/$\"\n+msgstr \"^register/$\""
        },
        {
            "sha": "86c847ecf2be01cee036efd0e67f58a33282baa7",
            "filename": "tests/regressiontests/i18n/patterns/locale/nl/LC_MESSAGES/django.mo",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fnl%2FLC_MESSAGES%2Fdjango.mo",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fnl%2FLC_MESSAGES%2Fdjango.mo",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fnl%2FLC_MESSAGES%2Fdjango.mo?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "fff4bfe394c754b508243b7719f553cea784e4da",
            "filename": "tests/regressiontests/i18n/patterns/locale/nl/LC_MESSAGES/django.po",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fnl%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fnl%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fnl%2FLC_MESSAGES%2Fdjango.po?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,38 @@\n+# SOME DESCRIPTIVE TITLE.\n+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER\n+# This file is distributed under the same license as the PACKAGE package.\n+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.\n+#\n+msgid \"\"\n+msgstr \"\"\n+\"Project-Id-Version: PACKAGE VERSION\\n\"\n+\"Report-Msgid-Bugs-To: \\n\"\n+\"POT-Creation-Date: 2011-06-15 11:33+0200\\n\"\n+\"PO-Revision-Date: 2011-06-14 16:16+0100\\n\"\n+\"Last-Translator: Jannis Leidel <jannis@leidel.info>\\n\"\n+\"Language-Team: LANGUAGE <LL@li.org>\\n\"\n+\"MIME-Version: 1.0\\n\"\n+\"Content-Type: text/plain; charset=UTF-8\\n\"\n+\"Content-Transfer-Encoding: 8bit\\n\"\n+\"Language: \\n\"\n+\"Plural-Forms: nplurals=2; plural=(n != 1)\\n\"\n+\n+#: urls/default.py:11\n+msgid \"^translated/$\"\n+msgstr \"^vertaald/$\"\n+\n+#: urls/default.py:12\n+msgid \"^translated/(?P<slug>[\\\\w-]+)/$\"\n+msgstr \"^vertaald/(?P<slug>[\\\\w-]+)/$\"\n+\n+#: urls/default.py:17\n+msgid \"^users/$\"\n+msgstr \"^gebruikers/$\"\n+\n+#: urls/default.py:18 urls/wrong.py:7\n+msgid \"^account/\"\n+msgstr \"^profiel/\"\n+\n+#: urls/namespace.py:9 urls/wrong_namespace.py:10\n+msgid \"^register/$\"\n+msgstr \"^registeren/$\""
        },
        {
            "sha": "1d7b346c278c58207efa2f1ba17b1ae72c0a35a4",
            "filename": "tests/regressiontests/i18n/patterns/locale/pt_BR/LC_MESSAGES/django.mo",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fpt_BR%2FLC_MESSAGES%2Fdjango.mo",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fpt_BR%2FLC_MESSAGES%2Fdjango.mo",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fpt_BR%2FLC_MESSAGES%2Fdjango.mo?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "fd3388e4b013de1f276c15bb5bb592c2086373ef",
            "filename": "tests/regressiontests/i18n/patterns/locale/pt_BR/LC_MESSAGES/django.po",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fpt_BR%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fpt_BR%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Flocale%2Fpt_BR%2FLC_MESSAGES%2Fdjango.po?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,38 @@\n+# SOME DESCRIPTIVE TITLE.\n+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER\n+# This file is distributed under the same license as the PACKAGE package.\n+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.\n+#\n+msgid \"\"\n+msgstr \"\"\n+\"Project-Id-Version: PACKAGE VERSION\\n\"\n+\"Report-Msgid-Bugs-To: \\n\"\n+\"POT-Creation-Date: 2011-06-15 11:34+0200\\n\"\n+\"PO-Revision-Date: 2011-06-14 16:17+0100\\n\"\n+\"Last-Translator: Jannis Leidel <jannis@leidel.info>\\n\"\n+\"Language-Team: LANGUAGE <LL@li.org>\\n\"\n+\"MIME-Version: 1.0\\n\"\n+\"Content-Type: text/plain; charset=UTF-8\\n\"\n+\"Content-Transfer-Encoding: 8bit\\n\"\n+\"Language: \\n\"\n+\"Plural-Forms: nplurals=2; plural=(n > 1)\\n\"\n+\n+#: urls/default.py:11\n+msgid \"^translated/$\"\n+msgstr \"^traduzidos/$\"\n+\n+#: urls/default.py:12\n+msgid \"^translated/(?P<slug>[\\\\w-]+)/$\"\n+msgstr \"^traduzidos/(?P<slug>[\\\\w-]+)/$\"\n+\n+#: urls/default.py:17\n+msgid \"^users/$\"\n+msgstr \"^usuarios/$\"\n+\n+#: urls/default.py:18 urls/wrong.py:7\n+msgid \"^account/\"\n+msgstr \"^conta/\"\n+\n+#: urls/namespace.py:9 urls/wrong_namespace.py:10\n+msgid \"^register/$\"\n+msgstr \"^registre-se/$\""
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/i18n/patterns/templates/404.html",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftemplates%2F404.html",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftemplates%2F404.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftemplates%2F404.html?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/i18n/patterns/templates/dummy.html",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftemplates%2Fdummy.html",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftemplates%2Fdummy.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftemplates%2Fdummy.html?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "9451bc69661ad0970e121f91c99b292bd7d81c49",
            "filename": "tests/regressiontests/i18n/patterns/tests.py",
            "status": "added",
            "additions": 241,
            "deletions": 0,
            "changes": 241,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,241 @@\n+import os\n+\n+from django.core.exceptions import ImproperlyConfigured\n+from django.core.urlresolvers import reverse, clear_url_caches\n+from django.test import TestCase\n+from django.test.utils import override_settings\n+from django.utils import translation\n+\n+\n+class URLTestCaseBase(TestCase):\n+    \"\"\"\n+    TestCase base-class for the URL tests.\n+    \"\"\"\n+    urls = 'regressiontests.i18n.patterns.urls.default'\n+\n+    def setUp(self):\n+        # Make sure the cache is empty before we are doing our tests.\n+        clear_url_caches()\n+\n+    def tearDown(self):\n+        # Make sure we will leave an empty cache for other testcases.\n+        clear_url_caches()\n+\n+URLTestCaseBase = override_settings(\n+    USE_I18N=True,\n+    LOCALE_PATHS=(\n+        os.path.join(os.path.dirname(__file__), 'locale'),\n+    ),\n+    TEMPLATE_DIRS=(\n+        os.path.join(os.path.dirname(__file__), 'templates'),\n+    ),\n+    LANGUAGE_CODE='en',\n+    LANGUAGES=(\n+        ('nl', 'Dutch'),\n+        ('en', 'English'),\n+        ('pt-br', 'Brazilian Portuguese'),\n+    ),\n+    MIDDLEWARE_CLASSES=(\n+        'django.middleware.locale.LocaleMiddleware',\n+        'django.middleware.common.CommonMiddleware',\n+    ),\n+)(URLTestCaseBase)\n+\n+\n+class URLPrefixTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests if the `i18n_patterns` is adding the prefix correctly.\n+    \"\"\"\n+    def test_not_prefixed(self):\n+        with translation.override('en'):\n+            self.assertEqual(reverse('not-prefixed'), '/not-prefixed/')\n+        with translation.override('nl'):\n+            self.assertEqual(reverse('not-prefixed'), '/not-prefixed/')\n+\n+    def test_prefixed(self):\n+        with translation.override('en'):\n+            self.assertEqual(reverse('prefixed'), '/en/prefixed/')\n+        with translation.override('nl'):\n+            self.assertEqual(reverse('prefixed'), '/nl/prefixed/')\n+\n+    @override_settings(ROOT_URLCONF='regressiontests.i18n.patterns.urls.wrong')\n+    def test_invalid_prefix_use(self):\n+        self.assertRaises(ImproperlyConfigured, lambda: reverse('account:register'))\n+\n+\n+class URLDisabledTests(URLTestCaseBase):\n+    urls = 'regressiontests.i18n.patterns.urls.disabled'\n+\n+    @override_settings(USE_I18N=False)\n+    def test_prefixed_i18n_disabled(self):\n+        with translation.override('en'):\n+            self.assertEqual(reverse('prefixed'), '/prefixed/')\n+        with translation.override('nl'):\n+            self.assertEqual(reverse('prefixed'), '/prefixed/')\n+\n+\n+class URLTranslationTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests if the pattern-strings are translated correctly (within the\n+    `i18n_patterns` and the normal `patterns` function).\n+    \"\"\"\n+    def test_no_prefix_translated(self):\n+        with translation.override('en'):\n+            self.assertEqual(reverse('no-prefix-translated'), '/translated/')\n+            self.assertEqual(reverse('no-prefix-translated-slug', kwargs={'slug': 'yeah'}), '/translated/yeah/')\n+\n+        with translation.override('nl'):\n+            self.assertEqual(reverse('no-prefix-translated'), '/vertaald/')\n+            self.assertEqual(reverse('no-prefix-translated-slug', kwargs={'slug': 'yeah'}), '/vertaald/yeah/')\n+\n+        with translation.override('pt-br'):\n+            self.assertEqual(reverse('no-prefix-translated'), '/traduzidos/')\n+            self.assertEqual(reverse('no-prefix-translated-slug', kwargs={'slug': 'yeah'}), '/traduzidos/yeah/')\n+\n+    def test_users_url(self):\n+        with translation.override('en'):\n+            self.assertEqual(reverse('users'), '/en/users/')\n+\n+        with translation.override('nl'):\n+            self.assertEqual(reverse('users'), '/nl/gebruikers/')\n+\n+        with translation.override('pt-br'):\n+            self.assertEqual(reverse('users'), '/pt-br/usuarios/')\n+\n+\n+class URLNamespaceTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests if the translations are still working within namespaces.\n+    \"\"\"\n+    def test_account_register(self):\n+        with translation.override('en'):\n+            self.assertEqual(reverse('account:register'), '/en/account/register/')\n+\n+        with translation.override('nl'):\n+            self.assertEqual(reverse('account:register'), '/nl/profiel/registeren/')\n+\n+\n+class URLRedirectTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests if the user gets redirected to the right URL when there is no\n+    language-prefix in the request URL.\n+    \"\"\"\n+    def test_no_prefix_response(self):\n+        response = self.client.get('/not-prefixed/')\n+        self.assertEqual(response.status_code, 200)\n+\n+    def test_en_redirect(self):\n+        response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertRedirects(response, 'http://testserver/en/account/register/')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 200)\n+\n+    def test_en_redirect_wrong_url(self):\n+        response = self.client.get('/profiel/registeren/', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(response['location'], 'http://testserver/en/profiel/registeren/')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 404)\n+\n+    def test_nl_redirect(self):\n+        response = self.client.get('/profiel/registeren/', HTTP_ACCEPT_LANGUAGE='nl')\n+        self.assertRedirects(response, 'http://testserver/nl/profiel/registeren/')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 200)\n+\n+    def test_nl_redirect_wrong_url(self):\n+        response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='nl')\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(response['location'], 'http://testserver/nl/account/register/')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 404)\n+\n+    def test_pt_br_redirect(self):\n+        response = self.client.get('/conta/registre-se/', HTTP_ACCEPT_LANGUAGE='pt-br')\n+        self.assertRedirects(response, 'http://testserver/pt-br/conta/registre-se/')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 200)\n+\n+\n+class URLRedirectWithoutTrailingSlashTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests the redirect when the requested URL doesn't end with a slash\n+    (`settings.APPEND_SLASH=True`).\n+    \"\"\"\n+    def test_not_prefixed_redirect(self):\n+        response = self.client.get('/not-prefixed', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertEqual(response.status_code, 301)\n+        self.assertEqual(response['location'], 'http://testserver/not-prefixed/')\n+\n+    def test_en_redirect(self):\n+        response = self.client.get('/account/register', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(response['location'], 'http://testserver/en/account/register')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 301)\n+        self.assertEqual(response['location'], 'http://testserver/en/account/register/')\n+\n+\n+class URLRedirectWithoutTrailingSlashSettingTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests the redirect when the requested URL doesn't end with a slash\n+    (`settings.APPEND_SLASH=False`).\n+    \"\"\"\n+    @override_settings(APPEND_SLASH=False)\n+    def test_not_prefixed_redirect(self):\n+        response = self.client.get('/not-prefixed', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(response['location'], 'http://testserver/en/not-prefixed')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 404)\n+\n+    @override_settings(APPEND_SLASH=False)\n+    def test_en_redirect(self):\n+        response = self.client.get('/account/register', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertEqual(response.status_code, 302)\n+        self.assertEqual(response['location'], 'http://testserver/en/account/register')\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 404)\n+\n+\n+class URLResponseTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests if the response has the right language-code.\n+    \"\"\"\n+    def test_not_prefixed_with_prefix(self):\n+        response = self.client.get('/en/not-prefixed/')\n+        self.assertEqual(response.status_code, 404)\n+\n+    def test_en_url(self):\n+        response = self.client.get('/en/account/register/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response['content-language'], 'en')\n+        self.assertEqual(response.context['LANGUAGE_CODE'], 'en')\n+\n+    def test_nl_url(self):\n+        response = self.client.get('/nl/profiel/registeren/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response['content-language'], 'nl')\n+        self.assertEqual(response.context['LANGUAGE_CODE'], 'nl')\n+\n+    def test_wrong_en_prefix(self):\n+        response = self.client.get('/en/profiel/registeren/')\n+        self.assertEqual(response.status_code, 404)\n+\n+    def test_wrong_nl_prefix(self):\n+        response = self.client.get('/nl/account/register/')\n+        self.assertEqual(response.status_code, 404)\n+\n+    def test_pt_br_url(self):\n+        response = self.client.get('/pt-br/conta/registre-se/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response['content-language'], 'pt-br')\n+        self.assertEqual(response.context['LANGUAGE_CODE'], 'pt-br')"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/i18n/patterns/urls/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2F__init__.py?ref=896e3c69c7eec311085da349a329ee80c8fca132"
        },
        {
            "sha": "8d178e67d4d540a544494b02d193479dc44a1360",
            "filename": "tests/regressiontests/i18n/patterns/urls/default.py",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fdefault.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fdefault.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fdefault.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,19 @@\n+from django.conf.urls.defaults import patterns, include, url\n+from django.conf.urls.i18n import i18n_patterns\n+from django.utils.translation import ugettext_lazy as _\n+from django.views.generic import TemplateView\n+\n+\n+view = TemplateView.as_view(template_name='dummy.html')\n+\n+urlpatterns = patterns('',\n+    url(r'^not-prefixed/$', view, name='not-prefixed'),\n+    url(_(r'^translated/$'), view, name='no-prefix-translated'),\n+    url(_(r'^translated/(?P<slug>[\\w-]+)/$'), view, name='no-prefix-translated-slug'),\n+)\n+\n+urlpatterns += i18n_patterns('',\n+    url(r'^prefixed/$', view, name='prefixed'),\n+    url(_(r'^users/$'), view, name='users'),\n+    url(_(r'^account/'), include('regressiontests.i18n.patterns.urls.namespace', namespace='account')),\n+)"
        },
        {
            "sha": "e4094695f92eac5626a06ba3c9863175148a3fdc",
            "filename": "tests/regressiontests/i18n/patterns/urls/disabled.py",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fdisabled.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fdisabled.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fdisabled.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,9 @@\n+from django.conf.urls.defaults import url\n+from django.conf.urls.i18n import i18n_patterns\n+from django.views.generic import TemplateView\n+\n+view = TemplateView.as_view(template_name='dummy.html')\n+\n+urlpatterns = i18n_patterns('',\n+    url(r'^prefixed/$', view, name='prefixed'),\n+)"
        },
        {
            "sha": "878e08feae3270463d80e3b8410508922c3fee58",
            "filename": "tests/regressiontests/i18n/patterns/urls/namespace.py",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fnamespace.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fnamespace.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fnamespace.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,10 @@\n+from django.conf.urls.defaults import patterns, include, url\n+from django.utils.translation import ugettext_lazy as _\n+from django.views.generic import TemplateView\n+\n+\n+view = TemplateView.as_view(template_name='dummy.html')\n+\n+urlpatterns = patterns('',\n+    url(_(r'^register/$'), view, name='register'),\n+)"
        },
        {
            "sha": "3e45743cdfb5c5853c1eebcfac07e1ac57f98396",
            "filename": "tests/regressiontests/i18n/patterns/urls/wrong.py",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fwrong.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fwrong.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fwrong.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,8 @@\n+from django.conf.urls.defaults import patterns, include, url\n+from django.conf.urls.i18n import i18n_patterns\n+from django.utils.translation import ugettext_lazy as _\n+\n+\n+urlpatterns = i18n_patterns('',\n+    url(_(r'^account/'), include('regressiontests.i18n.patterns.urls.wrong_namespace', namespace='account')),\n+)"
        },
        {
            "sha": "90ee2a0538a9feb8ccd1976f0c6ed84be19c704f",
            "filename": "tests/regressiontests/i18n/patterns/urls/wrong_namespace.py",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fwrong_namespace.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fwrong_namespace.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fwrong_namespace.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -0,0 +1,11 @@\n+from django.conf.urls.defaults import include, url\n+from django.conf.urls.i18n import i18n_patterns\n+from django.utils.translation import ugettext_lazy as _\n+from django.views.generic import TemplateView\n+\n+\n+view = TemplateView.as_view(template_name='dummy.html')\n+\n+urlpatterns = i18n_patterns('',\n+    url(_(r'^register/$'), view, name='register'),\n+)"
        },
        {
            "sha": "9c24c3fb40bb1fa6c87162c841b1180d7aeb0f2b",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 11,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/896e3c69c7eec311085da349a329ee80c8fca132/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=896e3c69c7eec311085da349a329ee80c8fca132",
            "patch": "@@ -3,13 +3,12 @@\n import datetime\n import decimal\n import os\n-import sys\n import pickle\n from threading import local\n \n from django.conf import settings\n from django.template import Template, Context\n-from django.test import TestCase\n+from django.test import TestCase, RequestFactory\n from django.utils.formats import (get_format, date_format, time_format,\n     localize, localize_input, iter_format_modules, get_format_modules)\n from django.utils.importlib import import_module\n@@ -18,14 +17,14 @@\n from django.utils import translation\n from django.utils.translation import (ugettext, ugettext_lazy, activate,\n         deactivate, gettext_lazy, pgettext, npgettext, to_locale,\n-        get_language_info, get_language)\n+        get_language_info, get_language, get_language_from_request)\n \n \n from forms import I18nForm, SelectDateForm, SelectDateWidget, CompanyForm\n from models import Company, TestModel\n \n from commands.tests import *\n-\n+from patterns.tests import *\n from test_warnings import DeprecationWarningTests\n \n class TranslationTests(TestCase):\n@@ -494,6 +493,9 @@ def test_localize_templatetag_and_filter(self):\n \n class MiscTests(TestCase):\n \n+    def setUp(self):\n+        self.rf = RequestFactory()\n+\n     def test_parse_spec_http_header(self):\n         \"\"\"\n         Testing HTTP header parsing. First, we test that we can parse the\n@@ -534,10 +536,8 @@ def test_parse_literal_http_header(self):\n         \"\"\"\n         Now test that we parse a literal HTTP header correctly.\n         \"\"\"\n-        from django.utils.translation.trans_real import get_language_from_request\n         g = get_language_from_request\n-        from django.http import HttpRequest\n-        r = HttpRequest\n+        r = self.rf.get('/')\n         r.COOKIES = {}\n         r.META = {'HTTP_ACCEPT_LANGUAGE': 'pt-br'}\n         self.assertEqual('pt-br', g(r))\n@@ -569,10 +569,8 @@ def test_parse_language_cookie(self):\n         \"\"\"\n         Now test that we parse language preferences stored in a cookie correctly.\n         \"\"\"\n-        from django.utils.translation.trans_real import get_language_from_request\n         g = get_language_from_request\n-        from django.http import HttpRequest\n-        r = HttpRequest\n+        r = self.rf.get('/')\n         r.COOKIES = {settings.LANGUAGE_COOKIE_NAME: 'pt-br'}\n         r.META = {}\n         self.assertEqual('pt-br', g(r))\n@@ -827,4 +825,3 @@ def test_multiple_locale_direct_switch_btrans(self):\n             t = Template(\"{% load i18n %}{% blocktrans %}No{% endblocktrans %}\")\n         with translation.override('nl'):\n             self.assertEqual(t.render(Context({})), 'Nee')\n-"
        }
    ],
    "stats": {
        "total": 809,
        "additions": 751,
        "deletions": 58
    }
}