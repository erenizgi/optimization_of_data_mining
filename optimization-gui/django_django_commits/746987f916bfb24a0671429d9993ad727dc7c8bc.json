{
    "author": "jezdez",
    "message": "Fixed #17734 -- Made sure to only redirect translated URLs if they can actually be resolved to prevent unwanted redirects. Many thanks to Orne Brocaar and Anssi Kääriäinen for input.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17621 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "746987f916bfb24a0671429d9993ad727dc7c8bc",
    "files": [
        {
            "sha": "1497d43e91546e880c3a34c9ffb2787bab1d14e6",
            "filename": "django/core/urlresolvers.py",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/746987f916bfb24a0671429d9993ad727dc7c8bc/django%2Fcore%2Furlresolvers.py",
            "raw_url": "https://github.com/django/django/raw/746987f916bfb24a0671429d9993ad727dc7c8bc/django%2Fcore%2Furlresolvers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Furlresolvers.py?ref=746987f916bfb24a0671429d9993ad727dc7c8bc",
            "patch": "@@ -518,3 +518,17 @@ def get_urlconf(default=None):\n     changed from the default one.\n     \"\"\"\n     return getattr(_urlconfs, \"value\", default)\n+\n+def is_valid_path(path, urlconf=None):\n+    \"\"\"\n+    Returns True if the given path resolves against the default URL resolver,\n+    False otherwise.\n+\n+    This is a convenience method to make working with \"is this a match?\" cases\n+    easier, avoiding unnecessarily indented try...except blocks.\n+    \"\"\"\n+    try:\n+        resolve(path, urlconf)\n+        return True\n+    except Resolver404:\n+        return False"
        },
        {
            "sha": "d894ec832f2239f2756a645681ceeedf3412dcc8",
            "filename": "django/middleware/common.py",
            "status": "modified",
            "additions": 2,
            "deletions": 17,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/746987f916bfb24a0671429d9993ad727dc7c8bc/django%2Fmiddleware%2Fcommon.py",
            "raw_url": "https://github.com/django/django/raw/746987f916bfb24a0671429d9993ad727dc7c8bc/django%2Fmiddleware%2Fcommon.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcommon.py?ref=746987f916bfb24a0671429d9993ad727dc7c8bc",
            "patch": "@@ -64,8 +64,8 @@ def process_request(self, request):\n         # trailing slash and there is no pattern for the current path\n         if settings.APPEND_SLASH and (not old_url[1].endswith('/')):\n             urlconf = getattr(request, 'urlconf', None)\n-            if (not _is_valid_path(request.path_info, urlconf) and\n-                    _is_valid_path(\"%s/\" % request.path_info, urlconf)):\n+            if (not urlresolvers.is_valid_path(request.path_info, urlconf) and\n+                    urlresolvers.is_valid_path(\"%s/\" % request.path_info, urlconf)):\n                 new_url[1] = new_url[1] + '/'\n                 if settings.DEBUG and request.method == 'POST':\n                     raise RuntimeError((\"\"\n@@ -151,18 +151,3 @@ def _is_internal_request(domain, referer):\n     \"\"\"\n     # Different subdomains are treated as different domains.\n     return referer is not None and re.match(\"^https?://%s/\" % re.escape(domain), referer)\n-\n-def _is_valid_path(path, urlconf=None):\n-    \"\"\"\n-    Returns True if the given path resolves against the default URL resolver,\n-    False otherwise.\n-\n-    This is a convenience method to make working with \"is this a match?\" cases\n-    easier, avoiding unnecessarily indented try...except blocks.\n-    \"\"\"\n-    try:\n-        urlresolvers.resolve(path, urlconf)\n-        return True\n-    except urlresolvers.Resolver404:\n-        return False\n-"
        },
        {
            "sha": "77113e29879189e55252ff8cca26f2f8f292483a",
            "filename": "django/middleware/locale.py",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/746987f916bfb24a0671429d9993ad727dc7c8bc/django%2Fmiddleware%2Flocale.py",
            "raw_url": "https://github.com/django/django/raw/746987f916bfb24a0671429d9993ad727dc7c8bc/django%2Fmiddleware%2Flocale.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Flocale.py?ref=746987f916bfb24a0671429d9993ad727dc7c8bc",
            "patch": "@@ -1,10 +1,13 @@\n \"This is the locale selecting middleware that will look at accept headers\"\n \n-from django.core.urlresolvers import get_resolver, LocaleRegexURLResolver\n+from django.conf import settings\n+from django.core.urlresolvers import (is_valid_path, get_resolver,\n+                                      LocaleRegexURLResolver)\n from django.http import HttpResponseRedirect\n from django.utils.cache import patch_vary_headers\n from django.utils import translation\n \n+\n class LocaleMiddleware(object):\n     \"\"\"\n     This is a very simple middleware that parses a request\n@@ -23,13 +26,17 @@ def process_request(self, request):\n \n     def process_response(self, request, response):\n         language = translation.get_language()\n-        translation.deactivate()\n-\n         if (response.status_code == 404 and\n                 not translation.get_language_from_path(request.path_info)\n                     and self.is_language_prefix_patterns_used()):\n-            return HttpResponseRedirect(\n-                '/%s%s' % (language, request.get_full_path()))\n+            urlconf = getattr(request, 'urlconf', None)\n+            language_path = '/%s%s' % (language, request.path_info)\n+            if settings.APPEND_SLASH and not language_path.endswith('/'):\n+                language_path = language_path + '/'\n+            if is_valid_path(language_path, urlconf):\n+                return HttpResponseRedirect(\n+                    '/%s%s' % (language, request.get_full_path()))\n+        translation.deactivate()\n \n         patch_vary_headers(response, ('Accept-Language',))\n         if 'Content-Language' not in response:"
        },
        {
            "sha": "1216d0bde99d3151a6eb127638bb21e607e6d1ae",
            "filename": "tests/regressiontests/i18n/patterns/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 25,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/746987f916bfb24a0671429d9993ad727dc7c8bc/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/746987f916bfb24a0671429d9993ad727dc7c8bc/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py?ref=746987f916bfb24a0671429d9993ad727dc7c8bc",
            "patch": "@@ -144,37 +144,29 @@ def test_no_prefix_response(self):\n \n     def test_en_redirect(self):\n         response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='en')\n-        self.assertRedirects(response, 'http://testserver/en/account/register/')\n+        self.assertRedirects(response, '/en/account/register/')\n \n         response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 200)\n \n     def test_en_redirect_wrong_url(self):\n         response = self.client.get('/profiel/registeren/', HTTP_ACCEPT_LANGUAGE='en')\n-        self.assertEqual(response.status_code, 302)\n-        self.assertEqual(response['location'], 'http://testserver/en/profiel/registeren/')\n-\n-        response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 404)\n \n     def test_nl_redirect(self):\n         response = self.client.get('/profiel/registeren/', HTTP_ACCEPT_LANGUAGE='nl')\n-        self.assertRedirects(response, 'http://testserver/nl/profiel/registeren/')\n+        self.assertRedirects(response, '/nl/profiel/registeren/')\n \n         response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 200)\n \n     def test_nl_redirect_wrong_url(self):\n         response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='nl')\n-        self.assertEqual(response.status_code, 302)\n-        self.assertEqual(response['location'], 'http://testserver/nl/account/register/')\n-\n-        response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 404)\n \n     def test_pt_br_redirect(self):\n         response = self.client.get('/conta/registre-se/', HTTP_ACCEPT_LANGUAGE='pt-br')\n-        self.assertRedirects(response, 'http://testserver/pt-br/conta/registre-se/')\n+        self.assertRedirects(response, '/pt-br/conta/registre-se/')\n \n         response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 200)\n@@ -187,17 +179,15 @@ class URLRedirectWithoutTrailingSlashTests(URLTestCaseBase):\n     \"\"\"\n     def test_not_prefixed_redirect(self):\n         response = self.client.get('/not-prefixed', HTTP_ACCEPT_LANGUAGE='en')\n-        self.assertEqual(response.status_code, 301)\n-        self.assertEqual(response['location'], 'http://testserver/not-prefixed/')\n+        self.assertRedirects(response, '/not-prefixed/', 301)\n \n     def test_en_redirect(self):\n         response = self.client.get('/account/register', HTTP_ACCEPT_LANGUAGE='en')\n-        self.assertEqual(response.status_code, 302)\n-        self.assertEqual(response['location'], 'http://testserver/en/account/register')\n+        # target status code of 301 because of CommonMiddleware redirecting\n+        self.assertRedirects(response, '/en/account/register', 302, target_status_code=301)\n \n         response = self.client.get(response['location'])\n-        self.assertEqual(response.status_code, 301)\n-        self.assertEqual(response['location'], 'http://testserver/en/account/register/')\n+        self.assertRedirects(response, '/en/account/register/', 301)\n \n \n class URLRedirectWithoutTrailingSlashSettingTests(URLTestCaseBase):\n@@ -208,20 +198,15 @@ class URLRedirectWithoutTrailingSlashSettingTests(URLTestCaseBase):\n     @override_settings(APPEND_SLASH=False)\n     def test_not_prefixed_redirect(self):\n         response = self.client.get('/not-prefixed', HTTP_ACCEPT_LANGUAGE='en')\n-        self.assertEqual(response.status_code, 302)\n-        self.assertEqual(response['location'], 'http://testserver/en/not-prefixed')\n-\n-        response = self.client.get(response['location'])\n         self.assertEqual(response.status_code, 404)\n \n     @override_settings(APPEND_SLASH=False)\n     def test_en_redirect(self):\n-        response = self.client.get('/account/register', HTTP_ACCEPT_LANGUAGE='en')\n-        self.assertEqual(response.status_code, 302)\n-        self.assertEqual(response['location'], 'http://testserver/en/account/register')\n+        response = self.client.get('/account/register-without-slash', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertRedirects(response, '/en/account/register-without-slash', 302)\n \n         response = self.client.get(response['location'])\n-        self.assertEqual(response.status_code, 404)\n+        self.assertEqual(response.status_code, 200)\n \n \n class URLResponseTests(URLTestCaseBase):"
        },
        {
            "sha": "3a2467b7b54ec0d92c2df75a953b85fdb253bb2a",
            "filename": "tests/regressiontests/i18n/patterns/urls/namespace.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/746987f916bfb24a0671429d9993ad727dc7c8bc/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fnamespace.py",
            "raw_url": "https://github.com/django/django/raw/746987f916bfb24a0671429d9993ad727dc7c8bc/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fnamespace.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Furls%2Fnamespace.py?ref=746987f916bfb24a0671429d9993ad727dc7c8bc",
            "patch": "@@ -7,4 +7,5 @@\n \n urlpatterns = patterns('',\n     url(_(r'^register/$'), view, name='register'),\n+    url(_(r'^register-without-slash$'), view, name='register-without-slash'),\n )"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 39,
        "deletions": 47
    }
}