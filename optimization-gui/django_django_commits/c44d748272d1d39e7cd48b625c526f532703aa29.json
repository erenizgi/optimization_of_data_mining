{
    "author": "ptone",
    "message": "Fixed #19662 -- alter auth modelbackend to accept custom username fields\n\nThanks to Aymeric and Carl for the review.",
    "sha": "c44d748272d1d39e7cd48b625c526f532703aa29",
    "files": [
        {
            "sha": "05e9bfd72127eefef2b0f433d10f5547c1c31358",
            "filename": "django/contrib/auth/backends.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/c44d748272d1d39e7cd48b625c526f532703aa29/django%2Fcontrib%2Fauth%2Fbackends.py",
            "raw_url": "https://github.com/django/django/raw/c44d748272d1d39e7cd48b625c526f532703aa29/django%2Fcontrib%2Fauth%2Fbackends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fbackends.py?ref=c44d748272d1d39e7cd48b625c526f532703aa29",
            "patch": "@@ -8,11 +8,11 @@ class ModelBackend(object):\n     Authenticates against django.contrib.auth.models.User.\n     \"\"\"\n \n-    # TODO: Model, login attribute name and password attribute name should be\n-    # configurable.\n-    def authenticate(self, username=None, password=None):\n+    def authenticate(self, username=None, password=None, **kwargs):\n+        UserModel = get_user_model()\n+        if username is None:\n+            username = kwargs.get(UserModel.USERNAME_FIELD)\n         try:\n-            UserModel = get_user_model()\n             user = UserModel._default_manager.get_by_natural_key(username)\n             if user.check_password(password):\n                 return user"
        },
        {
            "sha": "20bbb4dbd4ec0fba41db6f6334ad9828eeb1b8ad",
            "filename": "django/contrib/auth/tests/auth_backends.py",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/c44d748272d1d39e7cd48b625c526f532703aa29/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "raw_url": "https://github.com/django/django/raw/c44d748272d1d39e7cd48b625c526f532703aa29/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py?ref=c44d748272d1d39e7cd48b625c526f532703aa29",
            "patch": "@@ -4,7 +4,7 @@\n from django.conf import settings\n from django.contrib.auth.models import User, Group, Permission, AnonymousUser\n from django.contrib.auth.tests.utils import skipIfCustomUser\n-from django.contrib.auth.tests.custom_user import ExtensionUser, CustomPermissionsUser\n+from django.contrib.auth.tests.custom_user import ExtensionUser, CustomPermissionsUser, CustomUser\n from django.contrib.contenttypes.models import ContentType\n from django.core.exceptions import ImproperlyConfigured, PermissionDenied\n from django.contrib.auth import authenticate\n@@ -190,6 +190,24 @@ def create_users(self):\n         )\n \n \n+@override_settings(AUTH_USER_MODEL='auth.CustomUser')\n+class CustomUserModelBackendAuthenticateTest(TestCase):\n+    \"\"\"\n+    Tests that the model backend can accept a credentials kwarg labeled with\n+    custom user model's USERNAME_FIELD.\n+    \"\"\"\n+\n+    def test_authenticate(self):\n+        test_user = CustomUser._default_manager.create_user(\n+            email='test@example.com',\n+            password='test',\n+            date_of_birth=date(2006, 4, 25)\n+        )\n+        authenticated_user = authenticate(email='test@example.com', password='test')\n+        self.assertEqual(test_user, authenticated_user)\n+\n+\n+\n class TestObj(object):\n     pass\n "
        },
        {
            "sha": "9bd7fe79b7641deea9b6051f81007dfc538db377",
            "filename": "docs/ref/contrib/auth.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/c44d748272d1d39e7cd48b625c526f532703aa29/docs%2Fref%2Fcontrib%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/c44d748272d1d39e7cd48b625c526f532703aa29/docs%2Fref%2Fcontrib%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fauth.txt?ref=c44d748272d1d39e7cd48b625c526f532703aa29",
            "patch": "@@ -412,9 +412,15 @@ The following backends are available in :mod:`django.contrib.auth.backends`:\n .. class:: ModelBackend\n \n     This is the default authentication backend used by Django.  It\n-    authenticates using usernames and passwords stored in the\n-    :class:`~django.contrib.auth.models.User` model.\n-\n+    authenticates using credentials consisting of a user identifier and\n+    password.  For Django's default user model, the user identifier is the\n+    username, for custom user models it is the field specified by\n+    USERNAME_FIELD (see :doc:`Customizing Users and authentication\n+    </topics/auth/customizing>`).\n+\n+    It also handles the default permissions model as defined for\n+    :class:`~django.contrib.auth.models.User` and\n+    :class:`~django.contrib.auth.models.PermissionsMixin`.\n \n .. class:: RemoteUserBackend\n "
        }
    ],
    "stats": {
        "total": 40,
        "additions": 32,
        "deletions": 8
    }
}