{
    "author": "aaugustin",
    "message": "Improved settings manipulation in the cache tests with the suitable decorators and context managers.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17039 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4819797f70ce718276466962418ba5ecc80d0fba",
    "files": [
        {
            "sha": "d5c6a43d4fc0f56aa60c72b76e1db6dfcaa4052c",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 104,
            "deletions": 125,
            "changes": 229,
            "blob_url": "https://github.com/django/django/blob/4819797f70ce718276466962418ba5ecc80d0fba/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4819797f70ce718276466962418ba5ecc80d0fba/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=4819797f70ce718276466962418ba5ecc80d0fba",
            "patch": "@@ -34,10 +34,12 @@\n # functions/classes for complex data type tests\n def f():\n     return 42\n+\n class C:\n     def m(n):\n         return 24\n \n+\n class DummyCacheTests(unittest.TestCase):\n     # The Dummy cache backend doesn't really behave like a test backend,\n     # so it has different test requirements.\n@@ -737,10 +739,12 @@ def test_custom_key_func(self):\n         self.assertEqual(self.custom_key_cache.get('answer2'), 42)\n         self.assertEqual(self.custom_key_cache2.get('answer2'), 42)\n \n+\n def custom_key_func(key, key_prefix, version):\n     \"A customized cache key function\"\n     return 'CUSTOM-' + '-'.join([key_prefix, str(version), key])\n \n+\n class DBCacheTests(unittest.TestCase, BaseCacheTests):\n     backend_name = 'django.core.cache.backends.db.DatabaseCache'\n \n@@ -818,6 +822,7 @@ def test_multiple_caches(self):\n         self.assertEqual(mirror_cache.get('value1'), 42)\n         self.assertEqual(other_cache.get('value1'), None)\n \n+\n # memcached backend isn't guaranteed to be available.\n # To check the memcached backend, the test settings file will\n # need to contain a cache backend setting that points at\n@@ -853,6 +858,7 @@ def test_invalid_keys(self):\n \n MemcachedCacheTests = unittest.skipUnless(settings.CACHES[DEFAULT_CACHE_ALIAS]['BACKEND'].startswith('django.core.cache.backends.memcached.'), \"memcached not available\")(MemcachedCacheTests)\n \n+\n class FileBasedCacheTests(unittest.TestCase, BaseCacheTests):\n     \"\"\"\n     Specific test cases for the file-based cache.\n@@ -900,6 +906,7 @@ def test_old_initialization(self):\n         self.cache = get_cache('file://%s?max_entries=30' % self.dirname)\n         self.perform_cull_test(50, 29)\n \n+\n class CustomCacheKeyValidationTests(unittest.TestCase):\n     \"\"\"\n     Tests for the ability to mixin a custom ``validate_key`` method to\n@@ -933,22 +940,12 @@ def test_simple(self):\n \n         self.assertRaises(InvalidCacheBackendError, get_cache, 'does_not_exist')\n \n+\n class CacheUtils(unittest.TestCase):\n     \"\"\"TestCase for django.utils.cache functions.\"\"\"\n \n     def setUp(self):\n         self.path = '/cache/test/'\n-        self.old_cache_middleware_key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n-        self.old_cache_middleware_seconds = settings.CACHE_MIDDLEWARE_SECONDS\n-        self.orig_use_i18n = settings.USE_I18N\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = 'settingsprefix'\n-        settings.CACHE_MIDDLEWARE_SECONDS = 1\n-        settings.USE_I18N = False\n-\n-    def tearDown(self):\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = self.old_cache_middleware_key_prefix\n-        settings.CACHE_MIDDLEWARE_SECONDS = self.old_cache_middleware_seconds\n-        settings.USE_I18N = self.orig_use_i18n\n \n     def _get_request(self, path, method='GET'):\n         request = HttpRequest()\n@@ -1036,39 +1033,32 @@ def test_patch_cache_control(self):\n             parts = set(cc_delim_re.split(response['Cache-Control']))\n             self.assertEqual(parts, expected_cc)\n \n-class PrefixedCacheUtils(CacheUtils):\n-    def setUp(self):\n-        super(PrefixedCacheUtils, self).setUp()\n-        self.old_cache_key_prefix = settings.CACHES['default'].get('KEY_PREFIX', None)\n-        settings.CACHES['default']['KEY_PREFIX'] = 'cacheprefix'\n+CacheUtils = override_settings(\n+        CACHE_MIDDLEWARE_KEY_PREFIX='settingsprefix',\n+        CACHE_MIDDLEWARE_SECONDS=1,\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+            },\n+        },\n+        USE_I18N=False,\n+)(CacheUtils)\n+\n+PrefixedCacheUtils = override_settings(\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+                'KEY_PREFIX': 'cacheprefix',\n+            },\n+        },\n+)(CacheUtils)\n \n-    def tearDown(self):\n-        super(PrefixedCacheUtils, self).tearDown()\n-        if self.old_cache_key_prefix is None:\n-            del settings.CACHES['default']['KEY_PREFIX']\n-        else:\n-            settings.CACHES['default']['KEY_PREFIX'] = self.old_cache_key_prefix\n \n class CacheHEADTest(unittest.TestCase):\n \n     def setUp(self):\n-        self.orig_cache_middleware_seconds = settings.CACHE_MIDDLEWARE_SECONDS\n-        self.orig_cache_middleware_key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n-        self.orig_caches = settings.CACHES\n-        settings.CACHE_MIDDLEWARE_SECONDS = 60\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = 'test'\n-        settings.CACHES = {\n-            'default': {\n-                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache'\n-            }\n-        }\n         self.path = '/cache/test/'\n \n-    def tearDown(self):\n-        settings.CACHE_MIDDLEWARE_SECONDS = self.orig_cache_middleware_seconds\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = self.orig_cache_middleware_key_prefix\n-        settings.CACHES = self.orig_caches\n-\n     def _get_request(self, method):\n         request = HttpRequest()\n         request.META = {\n@@ -1111,29 +1101,22 @@ def test_head_with_cached_get(self):\n         self.assertNotEqual(get_cache_data, None)\n         self.assertEqual(test_content, get_cache_data.content)\n \n+CacheHEADTest = override_settings(\n+        CACHE_MIDDLEWARE_SECONDS=60,\n+        CACHE_MIDDLEWARE_KEY_PREFIX='test',\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+            },\n+        },\n+)(CacheHEADTest)\n+\n+\n class CacheI18nTest(unittest.TestCase):\n \n     def setUp(self):\n-        self.orig_cache_middleware_seconds = settings.CACHE_MIDDLEWARE_SECONDS\n-        self.orig_cache_middleware_key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n-        self.orig_caches = settings.CACHES\n-        self.orig_use_i18n = settings.USE_I18N\n-        self.orig_languages =  settings.LANGUAGES\n-        settings.LANGUAGES = (\n-                ('en', 'English'),\n-                ('es', 'Spanish'),\n-        )\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = 'settingsprefix'\n         self.path = '/cache/test/'\n \n-    def tearDown(self):\n-        settings.CACHE_MIDDLEWARE_SECONDS = self.orig_cache_middleware_seconds\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = self.orig_cache_middleware_key_prefix\n-        settings.CACHES = self.orig_caches\n-        settings.USE_I18N = self.orig_use_i18n\n-        settings.LANGUAGES = self.orig_languages\n-        translation.deactivate()\n-\n     def _get_request(self):\n         request = HttpRequest()\n         request.META = {\n@@ -1158,8 +1141,8 @@ def _get_request_cache(self, query_string=None):\n         request.session = {}\n         return request\n \n+    @override_settings(USE_I18N=True)\n     def test_cache_key_i18n(self):\n-        settings.USE_I18N = True\n         request = self._get_request()\n         lang = translation.get_language()\n         response = HttpResponse()\n@@ -1168,30 +1151,26 @@ def test_cache_key_i18n(self):\n         key2 = get_cache_key(request)\n         self.assertEqual(key, key2)\n \n+    @override_settings(USE_I18N=False)\n     def test_cache_key_no_i18n (self):\n-        settings.USE_I18N = False\n         request = self._get_request()\n         lang = translation.get_language()\n         response = HttpResponse()\n         key = learn_cache_key(request, response)\n         self.assertFalse(key.endswith(lang), \"Cache keys shouldn't include the language name when i18n is inactive\")\n \n+    @override_settings(\n+            CACHE_MIDDLEWARE_KEY_PREFIX=\"test\",\n+            CACHE_MIDDLEWARE_SECONDS=60,\n+            USE_ETAGS=True,\n+            USE_I18N=True,\n+    )\n     def test_middleware(self):\n         def set_cache(request, lang, msg):\n-            translation.activate(lang)\n-            response = HttpResponse()\n-            response.content= msg\n-            return UpdateCacheMiddleware().process_response(request, response)\n-\n-        settings.CACHE_MIDDLEWARE_SECONDS = 60\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = \"test\"\n-        settings.CACHES = {\n-            'default': {\n-                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache'\n-            }\n-        }\n-        settings.USE_ETAGS = True\n-        settings.USE_I18N = True\n+            with translation.override(lang):\n+                response = HttpResponse()\n+                response.content= msg\n+                return UpdateCacheMiddleware().process_response(request, response)\n \n         # cache with non empty request.GET\n         request = self._get_request_cache(query_string='foo=bar&other=true')\n@@ -1224,74 +1203,56 @@ def set_cache(request, lang, msg):\n         # Check that we use etags\n         self.assertTrue(get_cache_data.has_header('ETag'))\n         # Check that we can disable etags\n-        settings.USE_ETAGS = False\n-        request._cache_update_cache = True\n-        set_cache(request, 'en', en_message)\n-        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-        self.assertFalse(get_cache_data.has_header('ETag'))\n+        with self.settings(USE_ETAGS=False):\n+            request._cache_update_cache = True\n+            set_cache(request, 'en', en_message)\n+            get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+            self.assertFalse(get_cache_data.has_header('ETag'))\n         # change the session language and set content\n         request = self._get_request_cache()\n         set_cache(request, 'es', es_message)\n         # change again the language\n-        translation.activate('en')\n-        # retrieve the content from cache\n-        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-        self.assertEqual(get_cache_data.content, en_message)\n+        with translation.override('en'):\n+            # retrieve the content from cache\n+            get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+            self.assertEqual(get_cache_data.content, en_message)\n         # change again the language\n-        translation.activate('es')\n-        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-        self.assertEqual(get_cache_data.content, es_message)\n-\n-class PrefixedCacheI18nTest(CacheI18nTest):\n-    def setUp(self):\n-        super(PrefixedCacheI18nTest, self).setUp()\n-        self.old_cache_key_prefix = settings.CACHES['default'].get('KEY_PREFIX', None)\n-        settings.CACHES['default']['KEY_PREFIX'] = 'cacheprefix'\n+        with translation.override('es'):\n+            get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+            self.assertEqual(get_cache_data.content, es_message)\n \n-    def tearDown(self):\n-        super(PrefixedCacheI18nTest, self).tearDown()\n-        if self.old_cache_key_prefix is not None:\n-            del settings.CACHES['default']['KEY_PREFIX']\n-        else:\n-            settings.CACHES['default']['KEY_PREFIX'] = self.old_cache_key_prefix\n+CacheI18nTest = override_settings(\n+        CACHE_MIDDLEWARE_KEY_PREFIX='settingsprefix',\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+            },\n+        },\n+        LANGUAGES=(\n+            ('en', 'English'),\n+            ('es', 'Spanish'),\n+        ),\n+)(CacheI18nTest)\n+\n+PrefixedCacheI18nTest = override_settings(\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+                'KEY_PREFIX': 'cacheprefix'\n+            },\n+        },\n+)(CacheI18nTest)\n \n \n def hello_world_view(request, value):\n     return HttpResponse('Hello World %s' % value)\n \n+\n class CacheMiddlewareTest(unittest.TestCase):\n \n     def setUp(self):\n         self.factory = RequestFactory()\n \n-        self.orig_cache_middleware_alias = settings.CACHE_MIDDLEWARE_ALIAS\n-        self.orig_cache_middleware_key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n-        self.orig_cache_middleware_seconds = settings.CACHE_MIDDLEWARE_SECONDS\n-        self.orig_cache_middleware_anonymous_only = getattr(settings, 'CACHE_MIDDLEWARE_ANONYMOUS_ONLY', False)\n-        self.orig_caches = settings.CACHES\n-\n-        settings.CACHE_MIDDLEWARE_ALIAS = 'other'\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = 'middlewareprefix'\n-        settings.CACHE_MIDDLEWARE_SECONDS = 30\n-        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = False\n-        settings.CACHES = {\n-            'default': {\n-                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache'\n-            },\n-            'other': {\n-                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n-                'LOCATION': 'other',\n-                'TIMEOUT': '1'\n-            }\n-        }\n-\n-    def tearDown(self):\n-        settings.CACHE_MIDDLEWARE_ALIAS = self.orig_cache_middleware_alias\n-        settings.CACHE_MIDDLEWARE_KEY_PREFIX = self.orig_cache_middleware_key_prefix\n-        settings.CACHE_MIDDLEWARE_SECONDS = self.orig_cache_middleware_seconds\n-        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = self.orig_cache_middleware_anonymous_only\n-        settings.CACHES = self.orig_caches\n-\n     def test_constructor(self):\n         \"\"\"\n         Ensure the constructor is correctly distinguishing between usage of CacheMiddleware as\n@@ -1354,11 +1315,11 @@ def test_middleware(self):\n         self.assertNotEquals(result, None)\n         self.assertEqual(result.content, 'Hello World 1')\n \n+    @override_settings(CACHE_MIDDLEWARE_ANONYMOUS_ONLY=True)\n     def test_cache_middleware_anonymous_only_wont_cause_session_access(self):\n         \"\"\" The cache middleware shouldn't cause a session access due to\n         CACHE_MIDDLEWARE_ANONYMOUS_ONLY if nothing else has accessed the\n         session. Refs 13283 \"\"\"\n-        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = True\n \n         from django.contrib.sessions.middleware import SessionMiddleware\n         from django.contrib.auth.middleware import AuthenticationMiddleware\n@@ -1383,11 +1344,11 @@ def test_cache_middleware_anonymous_only_wont_cause_session_access(self):\n \n         self.assertEqual(request.session.accessed, False)\n \n+    @override_settings(CACHE_MIDDLEWARE_ANONYMOUS_ONLY=True)\n     def test_cache_middleware_anonymous_only_with_cache_page(self):\n         \"\"\"CACHE_MIDDLEWARE_ANONYMOUS_ONLY should still be effective when used\n         with the cache_page decorator: the response to a request from an\n         authenticated user should not be cached.\"\"\"\n-        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = True\n \n         request = self.factory.get('/view_anon/')\n \n@@ -1498,6 +1459,23 @@ def test_view_decorator(self):\n         response = other_with_timeout_view(request, '18')\n         self.assertEqual(response.content, 'Hello World 18')\n \n+CacheMiddlewareTest = override_settings(\n+        CACHE_MIDDLEWARE_ALIAS='other',\n+        CACHE_MIDDLEWARE_KEY_PREFIX='middlewareprefix',\n+        CACHE_MIDDLEWARE_SECONDS=30,\n+        CACHE_MIDDLEWARE_ANONYMOUS_ONLY=False,\n+        CACHES={\n+            'default': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+            },\n+            'other': {\n+                'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',\n+                'LOCATION': 'other',\n+                'TIMEOUT': '1',\n+            },\n+        },\n+)(CacheMiddlewareTest)\n+\n \n class TestWithTemplateResponse(TestCase):\n     \"\"\"\n@@ -1604,6 +1582,7 @@ def test_admin(self):\n             self.assertEqual(response.status_code, 200)\n             self.assertTrue(response.has_header('ETag'))\n \n+\n if __name__ == '__main__':\n     unittest.main()\n "
        }
    ],
    "stats": {
        "total": 229,
        "additions": 104,
        "deletions": 125
    }
}