{
    "author": "spookylukey",
    "message": "Changed a lot of internal code to use 'format_html' where appropriate/possible",
    "sha": "a92e7f37c4ae84b6b8d8016cc6783211e9047219",
    "files": [
        {
            "sha": "ac29d19469849832f5b68fee62f3c2dd24ef6b1e",
            "filename": "django/contrib/admin/helpers.py",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fhelpers.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -10,7 +10,7 @@\n from django.forms.util import flatatt\n from django.template.defaultfilters import capfirst\n from django.utils.encoding import force_unicode, smart_unicode\n-from django.utils.html import escape, conditional_escape\n+from django.utils.html import conditional_escape, format_html\n from django.utils.safestring import mark_safe\n from django.utils.translation import ugettext_lazy as _\n from django.conf import settings\n@@ -163,11 +163,9 @@ def label_tag(self):\n         if not self.is_first:\n             attrs[\"class\"] = \"inline\"\n         label = self.field['label']\n-        contents = capfirst(force_unicode(escape(label))) + \":\"\n-        return mark_safe('<label%(attrs)s>%(contents)s</label>' % {\n-            \"attrs\": flatatt(attrs),\n-            \"contents\": contents,\n-        })\n+        return format_html('<label{0}>{1}:</label>',\n+                           flatatt(attrs),\n+                           capfirst(force_unicode(label)))\n \n     def contents(self):\n         from django.contrib.admin.templatetags.admin_list import _boolean_icon"
        },
        {
            "sha": "29b5d71a161d762f10e7207b4ea8cddddb3c18bb",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 24,
            "deletions": 18,
            "changes": 42,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -10,7 +10,7 @@\n from django.core.exceptions import ObjectDoesNotExist\n from django.db import models\n from django.utils import formats\n-from django.utils.html import escape, conditional_escape\n+from django.utils.html import format_html\n from django.utils.safestring import mark_safe\n from django.utils.text import capfirst\n from django.utils.translation import ugettext as _\n@@ -31,9 +31,12 @@ def paginator_number(cl,i):\n     if i == DOT:\n         return '... '\n     elif i == cl.page_num:\n-        return mark_safe('<span class=\"this-page\">%d</span> ' % (i+1))\n+        return format_html('<span class=\"this-page\">{}</span> ', i+1)\n     else:\n-        return mark_safe('<a href=\"%s\"%s>%d</a> ' % (escape(cl.get_query_string({PAGE_VAR: i})), (i == cl.paginator.num_pages-1 and ' class=\"end\"' or ''), i+1))\n+        return format_html('<a href=\"{0}\"{1}>{2}</a> ',\n+                           cl.get_query_string({PAGE_VAR: i}),\n+                           mark_safe(' class=\"end\"' if i == cl.paginator.num_pages-1 else ''),\n+                           i+1)\n \n @register.inclusion_tag('admin/pagination.html')\n def pagination(cl):\n@@ -159,13 +162,14 @@ def result_headers(cl):\n             \"url_primary\": cl.get_query_string({ORDER_VAR: '.'.join(o_list_primary)}),\n             \"url_remove\": cl.get_query_string({ORDER_VAR: '.'.join(o_list_remove)}),\n             \"url_toggle\": cl.get_query_string({ORDER_VAR: '.'.join(o_list_toggle)}),\n-            \"class_attrib\": mark_safe(th_classes and ' class=\"%s\"' % ' '.join(th_classes) or '')\n+            \"class_attrib\": format_html(' class=\"{}\"', ' '.join(th_classes))\n+                            if th_classes else '',\n         }\n \n def _boolean_icon(field_val):\n     icon_url = static('admin/img/icon-%s.gif' %\n                       {True: 'yes', False: 'no', None: 'unknown'}[field_val])\n-    return mark_safe('<img src=\"%s\" alt=\"%s\" />' % (icon_url, field_val))\n+    return format_html('<img src=\"{0}\" alt=\"{1}\" />', icon_url, field_val)\n \n def items_for_result(cl, result, form):\n     \"\"\"\n@@ -182,31 +186,29 @@ def items_for_result(cl, result, form):\n         else:\n             if f is None:\n                 if field_name == 'action_checkbox':\n-                    row_class = ' class=\"action-checkbox\"'\n+                    row_class = mark_safe(' class=\"action-checkbox\"')\n                 allow_tags = getattr(attr, 'allow_tags', False)\n                 boolean = getattr(attr, 'boolean', False)\n                 if boolean:\n                     allow_tags = True\n                 result_repr = display_for_value(value, boolean)\n                 # Strip HTML tags in the resulting text, except if the\n                 # function has an \"allow_tags\" attribute set to True.\n-                if not allow_tags:\n-                    result_repr = escape(result_repr)\n-                else:\n+                if allow_tags:\n                     result_repr = mark_safe(result_repr)\n                 if isinstance(value, (datetime.date, datetime.time)):\n-                    row_class = ' class=\"nowrap\"'\n+                    row_class = mark_safe(' class=\"nowrap\"')\n             else:\n                 if isinstance(f.rel, models.ManyToOneRel):\n                     field_val = getattr(result, f.name)\n                     if field_val is None:\n                         result_repr = EMPTY_CHANGELIST_VALUE\n                     else:\n-                        result_repr = escape(field_val)\n+                        result_repr = field_val\n                 else:\n                     result_repr = display_for_field(value, f)\n                 if isinstance(f, (models.DateField, models.TimeField, models.ForeignKey)):\n-                    row_class = ' class=\"nowrap\"'\n+                    row_class = mark_safe(' class=\"nowrap\"')\n         if force_unicode(result_repr) == '':\n             result_repr = mark_safe('&nbsp;')\n         # If list_display_links not defined, add the link tag to the first field\n@@ -222,8 +224,14 @@ def items_for_result(cl, result, form):\n                 attr = pk\n             value = result.serializable_value(attr)\n             result_id = repr(force_unicode(value))[1:]\n-            yield mark_safe('<%s%s><a href=\"%s\"%s>%s</a></%s>' % \\\n-                (table_tag, row_class, url, (cl.is_popup and ' onclick=\"opener.dismissRelatedLookupPopup(window, %s); return false;\"' % result_id or ''), conditional_escape(result_repr), table_tag))\n+            yield format_html('<{0}{1}><a href=\"{2}\"{3}>{4}</a></{5}>',\n+                              table_tag,\n+                              row_class,\n+                              url,\n+                              format_html(' onclick=\"opener.dismissRelatedLookupPopup(window, {0}); return false;\"', result_id)\n+                                if cl.is_popup else '',\n+                              result_repr,\n+                              table_tag)\n         else:\n             # By default the fields come from ModelAdmin.list_editable, but if we pull\n             # the fields out of the form instead of list_editable custom admins\n@@ -233,11 +241,9 @@ def items_for_result(cl, result, form):\n                         form[cl.model._meta.pk.name].is_hidden)):\n                 bf = form[field_name]\n                 result_repr = mark_safe(force_unicode(bf.errors) + force_unicode(bf))\n-            else:\n-                result_repr = conditional_escape(result_repr)\n-            yield mark_safe('<td%s>%s</td>' % (row_class, result_repr))\n+            yield format_html('<td{0}>{1}</td>', row_class, result_repr)\n     if form and not form[cl.model._meta.pk.name].is_hidden:\n-        yield mark_safe('<td>%s</td>' % force_unicode(form[cl.model._meta.pk.name]))\n+        yield format_html('<td>{0}</td>', force_unicode(form[cl.model._meta.pk.name]))\n \n class ResultList(list):\n     # Wrapper class used to return items in a list_editable"
        },
        {
            "sha": "92e1c0efd5cda33a697996545e1f84b346a517c2",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -9,8 +9,7 @@\n from django.db.models.related import RelatedObject\n from django.forms.forms import pretty_name\n from django.utils import formats\n-from django.utils.html import escape\n-from django.utils.safestring import mark_safe\n+from django.utils.html import format_html\n from django.utils.text import capfirst\n from django.utils import timezone\n from django.utils.encoding import force_unicode, smart_unicode, smart_str\n@@ -124,10 +123,10 @@ def format_callback(obj):\n             if not user.has_perm(p):\n                 perms_needed.add(opts.verbose_name)\n             # Display a link to the admin page.\n-            return mark_safe('%s: <a href=\"%s\">%s</a>' %\n-                             (escape(capfirst(opts.verbose_name)),\n-                              admin_url,\n-                              escape(obj)))\n+            return format_html('{0}: <a href=\"{1}\">{2}</a>',\n+                               capfirst(opts.verbose_name),\n+                               admin_url,\n+                               obj)\n         else:\n             # Don't display link to edit, because it either has no\n             # admin or is edited inline."
        },
        {
            "sha": "37f286d0d45574638e7a5633668ae07f0f42165c",
            "filename": "django/contrib/admin/widgets.py",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fadmin%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fwidgets.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -10,7 +10,7 @@\n from django.core.urlresolvers import reverse\n from django.forms.widgets import RadioFieldRenderer\n from django.forms.util import flatatt\n-from django.utils.html import escape\n+from django.utils.html import escape, format_html, format_html_join\n from django.utils.text import Truncator\n from django.utils.translation import ugettext as _\n from django.utils.safestring import mark_safe\n@@ -85,16 +85,17 @@ def __init__(self, attrs=None):\n         forms.MultiWidget.__init__(self, widgets, attrs)\n \n     def format_output(self, rendered_widgets):\n-        return mark_safe('<p class=\"datetime\">%s %s<br />%s %s</p>' % \\\n-            (_('Date:'), rendered_widgets[0], _('Time:'), rendered_widgets[1]))\n+        return format_html('<p class=\"datetime\">{0} {1}<br />{2} {3}</p>',\n+                           _('Date:'), rendered_widgets[0],\n+                           _('Time:'), rendered_widgets[1])\n \n class AdminRadioFieldRenderer(RadioFieldRenderer):\n     def render(self):\n         \"\"\"Outputs a <ul> for this set of radio fields.\"\"\"\n-        return mark_safe('<ul%s>\\n%s\\n</ul>' % (\n-            flatatt(self.attrs),\n-            '\\n'.join(['<li>%s</li>' % force_unicode(w) for w in self]))\n-        )\n+        return format_html('<ul{0}>\\n{1}\\n</ul>',\n+                           flatatt(self.attrs),\n+                           format_html_join('\\n', '<li>{0}</li>',\n+                                            ((force_unicode(w),) for w in self)))\n \n class AdminRadioSelect(forms.RadioSelect):\n     renderer = AdminRadioFieldRenderer"
        },
        {
            "sha": "bce87476613668a8ddf825d72ba3e432280e0174",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -1,6 +1,7 @@\n from django import forms\n from django.forms.util import flatatt\n from django.template import loader\n+from django.utils.html import format_html, format_html_join\n from django.utils.http import int_to_base36\n from django.utils.safestring import mark_safe\n from django.utils.translation import ugettext, ugettext_lazy as _\n@@ -28,13 +29,15 @@ def render(self, name, value, attrs):\n         try:\n             hasher = identify_hasher(encoded)\n         except ValueError:\n-            summary = \"<strong>Invalid password format or unknown hashing algorithm.</strong>\"\n+            summary = mark_safe(\"<strong>Invalid password format or unknown hashing algorithm.</strong>\")\n         else:\n-            summary = \"\"\n-            for key, value in hasher.safe_summary(encoded).iteritems():\n-                summary += \"<strong>%(key)s</strong>: %(value)s \" % {\"key\": ugettext(key), \"value\": value}\n+            summary = format_html_join('',\n+                                       \"<strong>{0}</strong>: {1} \",\n+                                       ((ugettext(key), value)\n+                                        for key, value in hasher.safe_summary(encoded).items())\n+                                       )\n \n-        return mark_safe(\"<div%(attrs)s>%(summary)s</div>\" % {\"attrs\": flatatt(final_attrs), \"summary\": summary})\n+        return format_html(\"<div{0}>{1}</div>\", flatatt(final_attrs), summary)\n \n \n class ReadOnlyPasswordHashField(forms.Field):"
        },
        {
            "sha": "c842498934efc717e4c8afd5e74036eca76a7b18",
            "filename": "django/contrib/databrowse/plugins/calendars.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Fcalendars.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Fcalendars.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Fcalendars.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -5,6 +5,7 @@\n from django.contrib.databrowse.datastructures import EasyModel\n from django.contrib.databrowse.sites import DatabrowsePlugin\n from django.shortcuts import render_to_response\n+from django.utils.html import format_html, format_html_join\n from django.utils.text import capfirst\n from django.utils.encoding import force_unicode\n from django.utils.safestring import mark_safe\n@@ -64,8 +65,9 @@ def model_index_html(self, request, model, site):\n         fields = self.field_dict(model)\n         if not fields:\n             return ''\n-        return mark_safe('<p class=\"filter\"><strong>View calendar by:</strong> %s</p>' % \\\n-            ', '.join(['<a href=\"calendars/%s/\">%s</a>' % (f.name, force_unicode(capfirst(f.verbose_name))) for f in fields.values()]))\n+        return format_html('<p class=\"filter\"><strong>View calendar by:</strong> {0}</p>',\n+                           format_html_join(', ', '<a href=\"calendars/{0}/\">{1}</a>',\n+                                            ((f.name, force_unicode(capfirst(f.verbose_name))) for f in fields.values())))\n \n     def urls(self, plugin_name, easy_instance_field):\n         if isinstance(easy_instance_field.field, models.DateField):"
        },
        {
            "sha": "f3bd829e615e3429397e93a7d0e2a39293cd1027",
            "filename": "django/contrib/databrowse/plugins/fieldchoices.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Ffieldchoices.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Ffieldchoices.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fdatabrowse%2Fplugins%2Ffieldchoices.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -5,6 +5,7 @@\n from django.contrib.databrowse.datastructures import EasyModel\n from django.contrib.databrowse.sites import DatabrowsePlugin\n from django.shortcuts import render_to_response\n+from django.utils.html import format_html, format_html_join\n from django.utils.text import capfirst\n from django.utils.encoding import smart_str, force_unicode\n from django.utils.safestring import mark_safe\n@@ -32,8 +33,9 @@ def model_index_html(self, request, model, site):\n         fields = self.field_dict(model)\n         if not fields:\n             return ''\n-        return mark_safe('<p class=\"filter\"><strong>View by:</strong> %s</p>' % \\\n-            ', '.join(['<a href=\"fields/%s/\">%s</a>' % (f.name, force_unicode(capfirst(f.verbose_name))) for f in fields.values()]))\n+        return format_html('<p class=\"filter\"><strong>View by:</strong> {0}</p>',\n+                           format_html_join(', ', '<a href=\"fields/{0}/\">{1}</a>',\n+                                            ((f.name, force_unicode(capfirst(f.verbose_name))) for f in fields.values())))\n \n     def urls(self, plugin_name, easy_instance_field):\n         if easy_instance_field.field in self.field_dict(easy_instance_field.model.model).values():"
        },
        {
            "sha": "49515c0dce897e6864e2c6308590ed62d8fc15b3",
            "filename": "django/contrib/gis/maps/google/gmap.py",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fgis%2Fmaps%2Fgoogle%2Fgmap.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fcontrib%2Fgis%2Fmaps%2Fgoogle%2Fgmap.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fmaps%2Fgoogle%2Fgmap.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -1,5 +1,6 @@\n from django.conf import settings\n from django.template.loader import render_to_string\n+from django.utils.html import format_html\n from django.utils.safestring import mark_safe\n \n from django.contrib.gis.maps.google.overlays import GPolygon, GPolyline, GMarker\n@@ -111,17 +112,18 @@ def render(self):\n     @property\n     def body(self):\n         \"Returns HTML body tag for loading and unloading Google Maps javascript.\"\n-        return mark_safe('<body %s %s>' % (self.onload, self.onunload))\n+        return format_html('<body {0} {1}>', self.onload, self.onunload)\n \n     @property\n     def onload(self):\n         \"Returns the `onload` HTML <body> attribute.\"\n-        return mark_safe('onload=\"%s.%s_load()\"' % (self.js_module, self.dom_id))\n+        return format_html('onload=\"{0}.{1}_load()\"', self.js_module, self.dom_id)\n \n     @property\n     def api_script(self):\n         \"Returns the <script> tag for the Google Maps API javascript.\"\n-        return mark_safe('<script src=\"%s%s\" type=\"text/javascript\"></script>' % (self.api_url, self.key))\n+        return format_html('<script src=\"{0}{1}\" type=\"text/javascript\"></script>',\n+                           self.api_url, self.key)\n \n     @property\n     def js(self):\n@@ -131,17 +133,17 @@ def js(self):\n     @property\n     def scripts(self):\n         \"Returns all <script></script> tags required with Google Maps JavaScript.\"\n-        return mark_safe('%s\\n  <script type=\"text/javascript\">\\n//<![CDATA[\\n%s//]]>\\n  </script>' % (self.api_script, self.js))\n+        return format_html('%s\\n  <script type=\"text/javascript\">\\n//<![CDATA[\\n%s//]]>\\n  </script>', self.api_script, mark_safe(self.js))\n \n     @property\n     def style(self):\n         \"Returns additional CSS styling needed for Google Maps on IE.\"\n-        return mark_safe('<style type=\"text/css\">%s</style>' % self.vml_css)\n+        return format_html('<style type=\"text/css\">{0}</style>', self.vml_css)\n \n     @property\n     def xhtml(self):\n         \"Returns XHTML information needed for IE VML overlays.\"\n-        return mark_safe('<html xmlns=\"http://www.w3.org/1999/xhtml\" %s>' % self.xmlns)\n+        return format_html('<html xmlns=\"http://www.w3.org/1999/xhtml\" {0}>', self.xmlns)\n \n     @property\n     def icons(self):"
        },
        {
            "sha": "880873a273a76ae34f61cb7cae0c2db9044e93fe",
            "filename": "django/forms/forms.py",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fforms%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fforms%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fforms.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -11,7 +11,7 @@\n from django.forms.util import flatatt, ErrorDict, ErrorList\n from django.forms.widgets import Media, media_property, TextInput, Textarea\n from django.utils.datastructures import SortedDict\n-from django.utils.html import conditional_escape\n+from django.utils.html import conditional_escape, format_html\n from django.utils.encoding import StrAndUnicode, smart_unicode, force_unicode\n from django.utils.safestring import mark_safe\n \n@@ -167,7 +167,7 @@ def _html_output(self, normal_row, error_row, row_ender, help_text_html, errors_\n                     # punctuation.\n                     if self.label_suffix:\n                         if label[-1] not in ':?.!':\n-                            label += self.label_suffix\n+                            label = format_html('{}{}', label, self.label_suffix)\n                     label = bf.label_tag(label) or ''\n                 else:\n                     label = ''\n@@ -498,8 +498,8 @@ def value(self):\n     def label_tag(self, contents=None, attrs=None):\n         \"\"\"\n         Wraps the given contents in a <label>, if the field has an ID attribute.\n-        Does not HTML-escape the contents. If contents aren't given, uses the\n-        field's HTML-escaped label.\n+        contents should be 'mark_safe'd to avoid HTML escaping. If contents\n+        aren't given, uses the field's HTML-escaped label.\n \n         If attrs are given, they're used as HTML attributes on the <label> tag.\n         \"\"\"\n@@ -508,7 +508,9 @@ def label_tag(self, contents=None, attrs=None):\n         id_ = widget.attrs.get('id') or self.auto_id\n         if id_:\n             attrs = attrs and flatatt(attrs) or ''\n-            contents = '<label for=\"%s\"%s>%s</label>' % (widget.id_for_label(id_), attrs, unicode(contents))\n+            contents = format_html('<label for=\"{0}\"{1}>{2}</label>',\n+                                   widget.id_for_label(id_), attrs, contents\n+                                   )\n         return mark_safe(contents)\n \n     def css_classes(self, extra_classes=None):"
        },
        {
            "sha": "91a5686886e8e714c087c36a8c5d4293bcc80a1c",
            "filename": "django/forms/util.py",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fforms%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fforms%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Futil.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -1,7 +1,7 @@\n from __future__ import unicode_literals\n \n from django.conf import settings\n-from django.utils.html import conditional_escape\n+from django.utils.html import format_html, format_html_join\n from django.utils.encoding import StrAndUnicode, force_unicode\n from django.utils.safestring import mark_safe\n from django.utils import timezone\n@@ -17,8 +17,10 @@ def flatatt(attrs):\n     The returned string will contain a leading space followed by key=\"value\",\n     XML-style pairs.  It is assumed that the keys do not need to be XML-escaped.\n     If the passed dictionary is empty, then return an empty string.\n+\n+    The result is passed through 'mark_safe'.\n     \"\"\"\n-    return ''.join([' %s=\"%s\"' % (k, conditional_escape(v)) for k, v in attrs.items()])\n+    return format_html_join('', ' {}=\"{}\"', attrs.items())\n \n class ErrorDict(dict, StrAndUnicode):\n     \"\"\"\n@@ -31,9 +33,11 @@ def __unicode__(self):\n \n     def as_ul(self):\n         if not self: return ''\n-        return mark_safe('<ul class=\"errorlist\">%s</ul>'\n-                % ''.join(['<li>%s%s</li>' % (k, conditional_escape(force_unicode(v)))\n-                    for k, v in self.items()]))\n+        return format_html('<ul class=\"errorlist\">{}</ul>',\n+                           format_html_join('', '<li>{0}{1}</li>',\n+                                            ((k, force_unicode(v))\n+                                             for k, v in self.items())\n+                           ))\n \n     def as_text(self):\n         return '\\n'.join(['* %s\\n%s' % (k, '\\n'.join(['  * %s' % force_unicode(i) for i in v])) for k, v in self.items()])\n@@ -47,8 +51,11 @@ def __unicode__(self):\n \n     def as_ul(self):\n         if not self: return ''\n-        return mark_safe('<ul class=\"errorlist\">%s</ul>'\n-                % ''.join(['<li>%s</li>' % conditional_escape(force_unicode(e)) for e in self]))\n+        return format_html('<ul class=\"errorlist\">{}</ul>',\n+                           format_html_join('', '<li>{}</li>',\n+                                            ((force_unicode(e),) for e in self)\n+                                            )\n+                           )\n \n     def as_text(self):\n         if not self: return ''"
        },
        {
            "sha": "65caa68db2dd8ff28b79fc7a03d53f9e9e351b85",
            "filename": "django/forms/widgets.py",
            "status": "modified",
            "additions": 32,
            "deletions": 27,
            "changes": 59,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fforms%2Fwidgets.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Fforms%2Fwidgets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fwidgets.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -12,7 +12,7 @@\n from django.conf import settings\n from django.forms.util import flatatt, to_current_timezone\n from django.utils.datastructures import MultiValueDict, MergeDict\n-from django.utils.html import escape, conditional_escape\n+from django.utils.html import conditional_escape, format_html, format_html_join\n from django.utils.translation import ugettext, ugettext_lazy\n from django.utils.encoding import StrAndUnicode, force_unicode\n from django.utils.safestring import mark_safe\n@@ -53,15 +53,15 @@ def render(self):\n         return mark_safe('\\n'.join(chain(*[getattr(self, 'render_' + name)() for name in MEDIA_TYPES])))\n \n     def render_js(self):\n-        return ['<script type=\"text/javascript\" src=\"%s\"></script>' % self.absolute_path(path) for path in self._js]\n+        return [format_html('<script type=\"text/javascript\" src=\"{0}\"></script>', self.absolute_path(path)) for path in self._js]\n \n     def render_css(self):\n         # To keep rendering order consistent, we can't just iterate over items().\n         # We need to sort the keys, and iterate over the sorted list.\n         media = self._css.keys()\n         media.sort()\n         return chain(*[\n-            ['<link href=\"%s\" type=\"text/css\" media=\"%s\" rel=\"stylesheet\" />' % (self.absolute_path(path), medium)\n+                [format_html('<link href=\"{0}\" type=\"text/css\" media=\"{1}\" rel=\"stylesheet\" />', self.absolute_path(path), medium)\n                     for path in self._css[medium]]\n                 for medium in media])\n \n@@ -254,7 +254,7 @@ def render(self, name, value, attrs=None):\n         if value != '':\n             # Only add the 'value' attribute if a value is non-empty.\n             final_attrs['value'] = force_unicode(self._format_value(value))\n-        return mark_safe('<input%s />' % flatatt(final_attrs))\n+        return format_html('<input{} />', flatatt(final_attrs))\n \n class TextInput(Input):\n     input_type = 'text'\n@@ -295,7 +295,7 @@ def render(self, name, value, attrs=None, choices=()):\n                 # An ID attribute was given. Add a numeric index as a suffix\n                 # so that the inputs don't all have the same ID attribute.\n                 input_attrs['id'] = '%s_%s' % (id_, i)\n-            inputs.append('<input%s />' % flatatt(input_attrs))\n+            inputs.append(format_html('<input{} />', flatatt(input_attrs)))\n         return mark_safe('\\n'.join(inputs))\n \n     def value_from_datadict(self, data, files, name):\n@@ -355,9 +355,9 @@ def render(self, name, value, attrs=None):\n \n         if value and hasattr(value, \"url\"):\n             template = self.template_with_initial\n-            substitutions['initial'] = ('<a href=\"%s\">%s</a>'\n-                                        % (escape(value.url),\n-                                           escape(force_unicode(value))))\n+            substitutions['initial'] = format_html('<a href=\"{0}\">{1}</a>',\n+                                                   value.url,\n+                                                   force_unicode(value))\n             if not self.is_required:\n                 checkbox_name = self.clear_checkbox_name(name)\n                 checkbox_id = self.clear_checkbox_id(checkbox_name)\n@@ -392,8 +392,9 @@ def __init__(self, attrs=None):\n     def render(self, name, value, attrs=None):\n         if value is None: value = ''\n         final_attrs = self.build_attrs(attrs, name=name)\n-        return mark_safe('<textarea%s>%s</textarea>' % (flatatt(final_attrs),\n-                conditional_escape(force_unicode(value))))\n+        return format_html('<textarea{0}>{1}</textarea>',\n+                           flatatt(final_attrs),\n+                           force_unicode(value))\n \n class DateInput(Input):\n     input_type = 'text'\n@@ -511,7 +512,7 @@ def render(self, name, value, attrs=None):\n         if not (value is True or value is False or value is None or value == ''):\n             # Only add the 'value' attribute if a value is non-empty.\n             final_attrs['value'] = force_unicode(value)\n-        return mark_safe('<input%s />' % flatatt(final_attrs))\n+        return format_html('<input{} />', flatatt(final_attrs))\n \n     def value_from_datadict(self, data, files, name):\n         if name not in data:\n@@ -543,7 +544,7 @@ def __init__(self, attrs=None, choices=()):\n     def render(self, name, value, attrs=None, choices=()):\n         if value is None: value = ''\n         final_attrs = self.build_attrs(attrs, name=name)\n-        output = ['<select%s>' % flatatt(final_attrs)]\n+        output = [format_html('<select{}>', flatatt(final_attrs))]\n         options = self.render_options(choices, [value])\n         if options:\n             output.append(options)\n@@ -553,23 +554,24 @@ def render(self, name, value, attrs=None, choices=()):\n     def render_option(self, selected_choices, option_value, option_label):\n         option_value = force_unicode(option_value)\n         if option_value in selected_choices:\n-            selected_html = ' selected=\"selected\"'\n+            selected_html = mark_safe(' selected=\"selected\"')\n             if not self.allow_multiple_selected:\n                 # Only allow for a single selection.\n                 selected_choices.remove(option_value)\n         else:\n             selected_html = ''\n-        return '<option value=\"%s\"%s>%s</option>' % (\n-            escape(option_value), selected_html,\n-            conditional_escape(force_unicode(option_label)))\n+        return format_html('<option value=\"{0}\"{1}>{2}</option>',\n+                           option_value,\n+                           selected_html,\n+                           force_unicode(option_label))\n \n     def render_options(self, choices, selected_choices):\n         # Normalize to strings.\n         selected_choices = set(force_unicode(v) for v in selected_choices)\n         output = []\n         for option_value, option_label in chain(self.choices, choices):\n             if isinstance(option_label, (list, tuple)):\n-                output.append('<optgroup label=\"%s\">' % escape(force_unicode(option_value)))\n+                output.append(format_html('<optgroup label=\"{0}\">', force_unicode(option_value)))\n                 for option in option_label:\n                     output.append(self.render_option(selected_choices, *option))\n                 output.append('</optgroup>')\n@@ -618,7 +620,7 @@ class SelectMultiple(Select):\n     def render(self, name, value, attrs=None, choices=()):\n         if value is None: value = []\n         final_attrs = self.build_attrs(attrs, name=name)\n-        output = ['<select multiple=\"multiple\"%s>' % flatatt(final_attrs)]\n+        output = [format_html('<select multiple=\"multiple\"{}>', flatatt(final_attrs))]\n         options = self.render_options(choices, value)\n         if options:\n             output.append(options)\n@@ -662,11 +664,11 @@ def render(self, name=None, value=None, attrs=None, choices=()):\n         value = value or self.value\n         attrs = attrs or self.attrs\n         if 'id' in self.attrs:\n-            label_for = ' for=\"%s_%s\"' % (self.attrs['id'], self.index)\n+            label_for = format_html(' for=\"{0}_{1}\"', self.attrs['id'], self.index)\n         else:\n             label_for = ''\n-        choice_label = conditional_escape(force_unicode(self.choice_label))\n-        return mark_safe('<label%s>%s %s</label>' % (label_for, self.tag(), choice_label))\n+        choice_label = force_unicode(self.choice_label)\n+        return format_html('<label{0}>{1} {2}</label>', label_for, self.tag(), choice_label)\n \n     def is_checked(self):\n         return self.value == self.choice_value\n@@ -677,7 +679,7 @@ def tag(self):\n         final_attrs = dict(self.attrs, type='radio', name=self.name, value=self.choice_value)\n         if self.is_checked():\n             final_attrs['checked'] = 'checked'\n-        return mark_safe('<input%s />' % flatatt(final_attrs))\n+        return format_html('<input{} />', flatatt(final_attrs))\n \n class RadioFieldRenderer(StrAndUnicode):\n     \"\"\"\n@@ -701,8 +703,10 @@ def __unicode__(self):\n \n     def render(self):\n         \"\"\"Outputs a <ul> for this set of radio fields.\"\"\"\n-        return mark_safe('<ul>\\n%s\\n</ul>' % '\\n'.join(['<li>%s</li>'\n-                % force_unicode(w) for w in self]))\n+        return format_html('<ul>\\n{0}\\n</ul>',\n+                           format_html_join('\\n', '<li>{0}</li>',\n+                                            [(force_unicode(w),) for w in self]\n+                                            ))\n \n class RadioSelect(Select):\n     renderer = RadioFieldRenderer\n@@ -751,15 +755,16 @@ def render(self, name, value, attrs=None, choices=()):\n             # so that the checkboxes don't all have the same ID attribute.\n             if has_id:\n                 final_attrs = dict(final_attrs, id='%s_%s' % (attrs['id'], i))\n-                label_for = ' for=\"%s\"' % final_attrs['id']\n+                label_for = format_html(' for=\"{0}\"', final_attrs['id'])\n             else:\n                 label_for = ''\n \n             cb = CheckboxInput(final_attrs, check_test=lambda value: value in str_values)\n             option_value = force_unicode(option_value)\n             rendered_cb = cb.render(name, option_value)\n-            option_label = conditional_escape(force_unicode(option_label))\n-            output.append('<li><label%s>%s %s</label></li>' % (label_for, rendered_cb, option_label))\n+            option_label = force_unicode(option_label)\n+            output.append(format_html('<li><label{0}>{1} {2}</label></li>',\n+                                      label_for, rendered_cb, option_label))\n         output.append('</ul>')\n         return mark_safe('\\n'.join(output))\n "
        },
        {
            "sha": "d27439b3b8764d1c062959f6fc320b3ed03dfcc0",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/a92e7f37c4ae84b6b8d8016cc6783211e9047219/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=a92e7f37c4ae84b6b8d8016cc6783211e9047219",
            "patch": "@@ -16,6 +16,7 @@\n from django.template.defaultfilters import date\n from django.utils.encoding import smart_unicode\n from django.utils.safestring import mark_safe\n+from django.utils.html import format_html\n from django.utils import timezone\n \n register = Library()\n@@ -44,9 +45,9 @@ def render(self, context):\n         csrf_token = context.get('csrf_token', None)\n         if csrf_token:\n             if csrf_token == 'NOTPROVIDED':\n-                return mark_safe(\"\")\n+                return format_html(\"\")\n             else:\n-                return mark_safe(\"<div style='display:none'><input type='hidden' name='csrfmiddlewaretoken' value='%s' /></div>\" % csrf_token)\n+                return format_html(\"<div style='display:none'><input type='hidden' name='csrfmiddlewaretoken' value='{}' /></div>\", csrf_token)\n         else:\n             # It's very probable that the token is missing because of\n             # misconfiguration, so we raise a warning"
        }
    ],
    "stats": {
        "total": 214,
        "additions": 121,
        "deletions": 93
    }
}