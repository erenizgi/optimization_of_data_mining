{
    "author": "unknown",
    "message": "Fixed #14694 -- Made ``defer()`` work with reverse relations\n\nReverse o2o fields are now usable with defer.",
    "sha": "6ebf115206289bce8f3d86318871faac13d6e835",
    "files": [
        {
            "sha": "e24dc22ee70fa4af9325cc36ab09039b6c2af3a0",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/6ebf115206289bce8f3d86318871faac13d6e835/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/6ebf115206289bce8f3d86318871faac13d6e835/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=6ebf115206289bce8f3d86318871faac13d6e835",
            "patch": "@@ -599,17 +599,22 @@ def deferred_to_data(self, target, callback):\n             for name in parts[:-1]:\n                 old_model = cur_model\n                 source = opts.get_field_by_name(name)[0]\n-                cur_model = source.rel.to\n+                if is_reverse_o2o(source):\n+                    cur_model = source.model\n+                else:\n+                    cur_model = source.rel.to\n                 opts = cur_model._meta\n                 # Even if we're \"just passing through\" this model, we must add\n                 # both the current model's pk and the related reference field\n-                # to the things we select.\n-                must_include[old_model].add(source)\n+                # (if it's not a reverse relation) to the things we select.\n+                if not is_reverse_o2o(source):\n+                    must_include[old_model].add(source)\n                 add_to_dict(must_include, cur_model, opts.pk)\n             field, model, _, _ = opts.get_field_by_name(parts[-1])\n             if model is None:\n                 model = cur_model\n-            add_to_dict(seen, model, field)\n+            if not is_reverse_o2o(field):\n+                add_to_dict(seen, model, field)\n \n         if defer:\n             # We need to load all fields for each model, except those that\n@@ -1983,3 +1988,10 @@ def add_to_dict(data, key, value):\n         data[key].add(value)\n     else:\n         data[key] = set([value])\n+\n+def is_reverse_o2o(field):\n+    \"\"\"\n+    A little helper to check if the given field is reverse-o2o. The field is\n+    expected to be some sort of relation field or related object.\n+    \"\"\"\n+    return not hasattr(field, 'rel') and field.field.unique"
        },
        {
            "sha": "7528e3b2c978304975b6b771b2dfdfc5ffadf169",
            "filename": "tests/regressiontests/defer_regress/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/6ebf115206289bce8f3d86318871faac13d6e835/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/6ebf115206289bce8f3d86318871faac13d6e835/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py?ref=6ebf115206289bce8f3d86318871faac13d6e835",
            "patch": "@@ -55,6 +55,10 @@ class Feature(models.Model):\n class SpecialFeature(models.Model):\n     feature = models.ForeignKey(Feature)\n \n+class OneToOneItem(models.Model):\n+    item = models.OneToOneField(Item, related_name=\"one_to_one_item\")\n+    name = models.CharField(max_length=15)\n+\n class ItemAndSimpleItem(models.Model):\n     item = models.ForeignKey(Item)\n     simple = models.ForeignKey(SimpleItem)"
        },
        {
            "sha": "964e4dc7c7c3aab0ef80bd8484cd2c61112560f6",
            "filename": "tests/regressiontests/defer_regress/tests.py",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/6ebf115206289bce8f3d86318871faac13d6e835/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6ebf115206289bce8f3d86318871faac13d6e835/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py?ref=6ebf115206289bce8f3d86318871faac13d6e835",
            "patch": "@@ -9,7 +9,7 @@\n from django.test import TestCase\n \n from .models import (ResolveThis, Item, RelatedItem, Child, Leaf, Proxy,\n-    SimpleItem, Feature, ItemAndSimpleItem, SpecialFeature)\n+    SimpleItem, Feature, ItemAndSimpleItem, OneToOneItem, SpecialFeature)\n \n \n class DeferRegressionTest(TestCase):\n@@ -111,6 +111,7 @@ def test_basic(self):\n                 Item,\n                 ItemAndSimpleItem,\n                 Leaf,\n+                OneToOneItem,\n                 Proxy,\n                 RelatedItem,\n                 ResolveThis,\n@@ -147,6 +148,7 @@ def test_basic(self):\n                 \"Leaf_Deferred_name_value\",\n                 \"Leaf_Deferred_second_child_id_value\",\n                 \"Leaf_Deferred_value\",\n+                \"OneToOneItem\",\n                 \"Proxy\",\n                 \"RelatedItem\",\n                 \"RelatedItem_Deferred_\",\n@@ -182,6 +184,33 @@ def test_resolve_columns(self):\n         self.assertEqual(1, qs.count())\n         self.assertEqual('Foobar', qs[0].name)\n \n+    def test_reverse_one_to_one_relations(self):\n+        # Refs #14694. Test reverse relations which are known unique (reverse\n+        # side has o2ofield or unique FK) - the o2o case\n+        item = Item.objects.create(name=\"first\", value=42)\n+        o2o = OneToOneItem.objects.create(item=item, name=\"second\")\n+        self.assertEqual(len(Item.objects.defer('one_to_one_item__name')), 1)\n+        self.assertEqual(len(Item.objects.select_related('one_to_one_item')), 1)\n+        self.assertEqual(len(Item.objects.select_related(\n+            'one_to_one_item').defer('one_to_one_item__name')), 1)\n+        self.assertEqual(len(Item.objects.select_related('one_to_one_item').defer('value')), 1)\n+        # Make sure that `only()` doesn't break when we pass in a unique relation,\n+        # rather than a field on the relation.\n+        self.assertEqual(len(Item.objects.only('one_to_one_item')), 1)\n+        with self.assertNumQueries(1):\n+            i = Item.objects.select_related('one_to_one_item')[0]\n+            self.assertEquals(i.one_to_one_item.pk, o2o.pk)\n+            self.assertEquals(i.one_to_one_item.name, \"second\")\n+        with self.assertNumQueries(1):\n+            i = Item.objects.select_related('one_to_one_item').defer(\n+                'value', 'one_to_one_item__name')[0]\n+            self.assertEquals(i.one_to_one_item.pk, o2o.pk)\n+            self.assertEquals(i.name, \"first\")\n+        with self.assertNumQueries(1):\n+            self.assertEquals(i.one_to_one_item.name, \"second\")\n+        with self.assertNumQueries(1):\n+            self.assertEquals(i.value, 42)\n+\n     def test_defer_with_select_related(self):\n         item1 = Item.objects.create(name=\"first\", value=47)\n         item2 = Item.objects.create(name=\"second\", value=42)"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 50,
        "deletions": 5
    }
}