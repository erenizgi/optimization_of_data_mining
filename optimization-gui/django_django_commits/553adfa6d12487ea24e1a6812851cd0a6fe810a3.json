{
    "author": "jbronn",
    "message": "Fixed #13488 -- No longer generate unhandled exceptions that may occur when destructors of global GEOS I/O objects are called on process termination.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15378 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "553adfa6d12487ea24e1a6812851cd0a6fe810a3",
    "files": [
        {
            "sha": "2c9d25ee9f9b605f3337da26aef311bae07b2cb3",
            "filename": "django/contrib/gis/geos/prototypes/threadsafe.py",
            "status": "modified",
            "additions": 9,
            "deletions": 13,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/553adfa6d12487ea24e1a6812851cd0a6fe810a3/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fthreadsafe.py",
            "raw_url": "https://github.com/django/django/raw/553adfa6d12487ea24e1a6812851cd0a6fe810a3/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fthreadsafe.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fthreadsafe.py?ref=553adfa6d12487ea24e1a6812851cd0a6fe810a3",
            "patch": "@@ -20,18 +20,6 @@ class GEOSContext(threading.local):\n \n thread_context = GEOSContext()\n \n-def call_geos_threaded(cfunc, args):\n-    \"\"\"\n-    This module-level routine calls the specified GEOS C thread-safe\n-    function with the context for this current thread.\n-    \"\"\"\n-    # If a context handle does not exist for this thread, initialize one.\n-    if not thread_context.handle:\n-        thread_context.handle = GEOSContextHandle()\n-    # Call the threaded GEOS routine with pointer of the context handle\n-    # as the first argument.\n-    return cfunc(thread_context.handle.ptr, *args)\n-\n class GEOSFunc(object):\n     \"\"\"\n     Class that serves as a wrapper for GEOS C Functions, and will\n@@ -43,14 +31,22 @@ def __init__(self, func_name):\n             # take an additional context handle parameter.\n             self.cfunc = getattr(lgeos, func_name + '_r')\n             self.threaded = True\n+            # Create a reference here to thread_context so it's not\n+            # garbage-collected before an attempt to call this object.\n+            self.thread_context = thread_context\n         except AttributeError:\n             # Otherwise, use usual function.\n             self.cfunc = getattr(lgeos, func_name)\n             self.threaded = False\n \n     def __call__(self, *args):\n         if self.threaded:\n-            return call_geos_threaded(self.cfunc, args)\n+            # If a context handle does not exist for this thread, initialize one.\n+            if not self.thread_context.handle:\n+                self.thread_context.handle = GEOSContextHandle()\n+            # Call the threaded GEOS routine with pointer of the context handle\n+            # as the first argument.\n+            return self.cfunc(self.thread_context.handle.ptr, *args)\n         else:\n             return self.cfunc(*args)\n "
        }
    ],
    "stats": {
        "total": 22,
        "additions": 9,
        "deletions": 13
    }
}