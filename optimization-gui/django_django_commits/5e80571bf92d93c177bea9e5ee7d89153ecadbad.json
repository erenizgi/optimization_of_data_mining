{
    "author": "claudep",
    "message": "Fixed #16594 -- Added wkt 3D support for GEOS geometries\n\nThis requires GEOS >= 3.3.0 to function properly. On previous\nversions, the Z dimension will simply not appear in the wkt.\nDisabled OpenLayers editing for 3D geometries (unsupported).",
    "sha": "5e80571bf92d93c177bea9e5ee7d89153ecadbad",
    "files": [
        {
            "sha": "6bdceb7722939763f786a017f75926abdefbcc59",
            "filename": "django/contrib/gis/admin/options.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fadmin%2Foptions.py?ref=5e80571bf92d93c177bea9e5ee7d89153ecadbad",
            "patch": "@@ -51,9 +51,10 @@ def media(self):\n     def formfield_for_dbfield(self, db_field, **kwargs):\n         \"\"\"\n         Overloaded from ModelAdmin so that an OpenLayersWidget is used\n-        for viewing/editing GeometryFields.\n+        for viewing/editing 2D GeometryFields (OpenLayers 2 does not support\n+        3D editing).\n         \"\"\"\n-        if isinstance(db_field, models.GeometryField):\n+        if isinstance(db_field, models.GeometryField) and db_field.dim < 3:\n             request = kwargs.pop('request', None)\n             # Setting the widget with the newly defined widget.\n             kwargs['widget'] = self.get_map_widget(db_field)"
        },
        {
            "sha": "7ae57883e36fb8aa377db1e1d23b44b93d272613",
            "filename": "django/contrib/gis/geos/geometry.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "raw_url": "https://github.com/django/django/raw/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fgeometry.py?ref=5e80571bf92d93c177bea9e5ee7d89153ecadbad",
            "patch": "@@ -382,7 +382,7 @@ def ewkt(self):\n     @property\n     def wkt(self):\n         \"Returns the WKT (Well-Known Text) representation of this Geometry.\"\n-        return wkt_w().write(self).decode()\n+        return wkt_w(self.hasz and 3 or 2).write(self).decode()\n \n     @property\n     def hex(self):"
        },
        {
            "sha": "1e80351dbf15fa7101b76159b9a974b45b9cff69",
            "filename": "django/contrib/gis/geos/prototypes/io.py",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "raw_url": "https://github.com/django/django/raw/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Fprototypes%2Fio.py?ref=5e80571bf92d93c177bea9e5ee7d89153ecadbad",
            "patch": "@@ -45,6 +45,18 @@ class WKBWriter_st(Structure): pass\n wkt_writer_write.restype = geos_char_p\n wkt_writer_write.errcheck = check_string\n \n+try:\n+    wkt_writer_get_outdim = GEOSFunc('GEOSWKTWriter_getOutputDimension')\n+    wkt_writer_get_outdim.argtypes = [WKT_WRITE_PTR]\n+    wkt_writer_get_outdim.restype = c_int\n+    wkt_writer_set_outdim = GEOSFunc('GEOSWKTWriter_setOutputDimension')\n+    wkt_writer_set_outdim.argtypes = [WKT_WRITE_PTR, c_int]\n+except AttributeError:\n+    # GEOSWKTWriter_get/setOutputDimension has been introduced in GEOS 3.3.0\n+    # Always return 2 if not available\n+    wkt_writer_get_outdim = lambda ptr: 2\n+    wkt_writer_set_outdim = lambda ptr, dim: None\n+\n ### WKBReader routines ###\n wkb_reader_create = GEOSFunc('GEOSWKBReader_create')\n wkb_reader_create.restype = WKB_READ_PTR\n@@ -151,6 +163,17 @@ def write(self, geom):\n         \"Returns the WKT representation of the given geometry.\"\n         return wkt_writer_write(self.ptr, geom.ptr)\n \n+    @property\n+    def outdim(self):\n+        return wkt_writer_get_outdim(self.ptr)\n+\n+    @outdim.setter\n+    def outdim(self, new_dim):\n+        if not new_dim in (2, 3):\n+            raise ValueError('WKT output dimension must be 2 or 3')\n+        wkt_writer_set_outdim(self.ptr, new_dim)\n+\n+\n class WKBWriter(IOBase):\n     _constructor = wkb_writer_create\n     _destructor = wkb_writer_destroy\n@@ -217,9 +240,10 @@ def wkt_r():\n         thread_context.wkt_r = _WKTReader()\n     return thread_context.wkt_r\n \n-def wkt_w():\n+def wkt_w(dim=2):\n     if not thread_context.wkt_w:\n         thread_context.wkt_w = WKTWriter()\n+    thread_context.wkt_w.outdim = dim\n     return thread_context.wkt_w\n \n def wkb_r():"
        },
        {
            "sha": "0081c7f728fb4acaeeb7fc5a7bb2f1ad28313224",
            "filename": "django/contrib/gis/geos/tests/test_geos.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "raw_url": "https://github.com/django/django/raw/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgeos%2Ftests%2Ftest_geos.py?ref=5e80571bf92d93c177bea9e5ee7d89153ecadbad",
            "patch": "@@ -80,7 +80,8 @@ def test_wkt(self):\n         \"Testing WKT output.\"\n         for g in self.geometries.wkt_out:\n             geom = fromstr(g.wkt)\n-            self.assertEqual(g.ewkt, geom.wkt)\n+            if geom.hasz and geos_version_info()['version'] >= '3.3.0':\n+                self.assertEqual(g.ewkt, geom.wkt)\n \n     def test_hex(self):\n         \"Testing HEX output.\""
        },
        {
            "sha": "b1a6ad14bf1fc57b6b7062d00e7816757f519ba4",
            "filename": "django/contrib/gis/tests/data/geometries.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fgeometries.json",
            "raw_url": "https://github.com/django/django/raw/5e80571bf92d93c177bea9e5ee7d89153ecadbad/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fgeometries.json",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fgeometries.json?ref=5e80571bf92d93c177bea9e5ee7d89153ecadbad",
            "patch": "@@ -20,6 +20,7 @@\n   ],\n   \"wkt_out\": [\n     {\"wkt\": \"POINT (110 130)\", \"ewkt\": \"POINT (110.0000000000000000 130.0000000000000000)\", \"kml\": \"<Point><coordinates>110.0,130.0,0</coordinates></Point>\", \"gml\": \"<gml:Point><gml:coordinates>110,130</gml:coordinates></gml:Point>\"},\n+    {\"wkt\": \"POINT (110 130 85)\", \"ewkt\": \"POINT Z (110.0000000000000000 130.0000000000000000 85.0000000000000000)\", \"kml\": \"<Point><coordinates>110.0,130.0,85.0</coordinates></Point>\", \"gml\": \"<gml:Point><gml:coordinates>110,130,85</gml:coordinates></gml:Point>\"},\n     {\"wkt\": \"LINESTRING (40 40,50 130,130 130)\", \"ewkt\": \"LINESTRING (40.0000000000000000 40.0000000000000000, 50.0000000000000000 130.0000000000000000, 130.0000000000000000 130.0000000000000000)\", \"kml\": \"<LineString><coordinates>40.0,40.0,0 50.0,130.0,0 130.0,130.0,0</coordinates></LineString>\", \"gml\": \"<gml:LineString><gml:coordinates>40,40 50,130 130,130</gml:coordinates></gml:LineString>\"},\n     {\"wkt\": \"POLYGON ((150 150,410 150,280 20,20 20,150 150),(170 120,330 120,260 50,100 50,170 120))\", \"ewkt\": \"POLYGON ((150.0000000000000000 150.0000000000000000, 410.0000000000000000 150.0000000000000000, 280.0000000000000000 20.0000000000000000, 20.0000000000000000 20.0000000000000000, 150.0000000000000000 150.0000000000000000), (170.0000000000000000 120.0000000000000000, 330.0000000000000000 120.0000000000000000, 260.0000000000000000 50.0000000000000000, 100.0000000000000000 50.0000000000000000, 170.0000000000000000 120.0000000000000000))\", \"kml\": \"<Polygon><outerBoundaryIs><LinearRing><coordinates>150.0,150.0,0 410.0,150.0,0 280.0,20.0,0 20.0,20.0,0 150.0,150.0,0</coordinates></LinearRing></outerBoundaryIs><innerBoundaryIs><LinearRing><coordinates>170.0,120.0,0 330.0,120.0,0 260.0,50.0,0 100.0,50.0,0 170.0,120.0,0</coordinates></LinearRing></innerBoundaryIs></Polygon>\", \"gml\": \"<gml:Polygon><gml:outerBoundaryIs><gml:LinearRing><gml:coordinates>150,150 410,150 280,20 20,20 150,150</gml:coordinates></gml:LinearRing></gml:outerBoundaryIs><gml:innerBoundaryIs><gml:LinearRing><gml:coordinates>170,120 330,120 260,50 100,50 170,120</gml:coordinates></gml:LinearRing></gml:innerBoundaryIs></gml:Polygon>\"},\n     {\"wkt\": \"MULTIPOINT (10 80,110 170,110 120)\", \"ewkt\": \"MULTIPOINT (10.0000000000000000 80.0000000000000000, 110.0000000000000000 170.0000000000000000, 110.0000000000000000 120.0000000000000000)\", \"kml\": \"<MultiGeometry><Point><coordinates>10.0,80.0,0</coordinates></Point><Point><coordinates>110.0,170.0,0</coordinates></Point><Point><coordinates>110.0,120.0,0</coordinates></Point></MultiGeometry>\", \"gml\": \"<gml:MultiPoint><gml:pointMember><gml:Point><gml:coordinates>10,80</gml:coordinates></gml:Point></gml:pointMember><gml:pointMember><gml:Point><gml:coordinates>110,170</gml:coordinates></gml:Point></gml:pointMember><gml:pointMember><gml:Point><gml:coordinates>110,120</gml:coordinates></gml:Point></gml:pointMember></gml:MultiPoint>\"},\n@@ -29,6 +30,7 @@\n   ],\n   \"hex_wkt\": [\n     {\"wkt\": \"POINT(0 1)\", \"hex\": \"01010000000000000000000000000000000000F03F\"},\n+    {\"wkt\": \"POINT(0 1 5)\", \"hex\": \"01010000800000000000000000000000000000F03F0000000000001440\"},\n     {\"wkt\": \"LINESTRING(0 1, 2 3, 4 5)\", \"hex\": \"0102000000030000000000000000000000000000000000F03F0000000000000040000000000000084000000000000010400000000000001440\"},\n     {\"wkt\": \"POLYGON((0 0, 10 0, 10 10, 0 10, 0 0))\", \"hex\": \"010300000001000000050000000000000000000000000000000000000000000000000024400000000000000000000000000000244000000000000024400000000000000000000000000000244000000000000000000000000000000000\"},\n     {\"wkt\": \"MULTIPOINT(0 0, 10 0, 10 10, 0 10, 0 0)\", \"hex\": \"010400000005000000010100000000000000000000000000000000000000010100000000000000000024400000000000000000010100000000000000000024400000000000002440010100000000000000000000000000000000002440010100000000000000000000000000000000000000\"},\n@@ -118,4 +120,4 @@\n       {\"wkt\": \"POLYGON ((-5 0,-5 10,5 10,5 5,10 5,10 -5,0 -5,0 0,-5 0))\"},\n       {\"wkt\": \"POLYGON ((2 0, 2 15, 18 15, 18 0, 2 0))\"}\n   ]\n-}\n\\ No newline at end of file\n+}"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 34,
        "deletions": 6
    }
}