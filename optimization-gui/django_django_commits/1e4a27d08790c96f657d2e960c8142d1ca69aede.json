{
    "author": "aaugustin",
    "message": "Fixed #19468 -- Decoded request.path correctly on Python 3.\n\nThanks aliva for the report and claudep for the feedback.",
    "sha": "1e4a27d08790c96f657d2e960c8142d1ca69aede",
    "files": [
        {
            "sha": "5174586ba1e8c38440bb23c35aa6c4d425ae07f0",
            "filename": "django/contrib/staticfiles/handlers.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Fcontrib%2Fstaticfiles%2Fhandlers.py",
            "raw_url": "https://github.com/django/django/raw/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Fcontrib%2Fstaticfiles%2Fhandlers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fhandlers.py?ref=1e4a27d08790c96f657d2e960c8142d1ca69aede",
            "patch": "@@ -6,6 +6,7 @@\n     from urlparse import urlparse\n \n from django.conf import settings\n+from django.core.handlers.base import get_path_info\n from django.core.handlers.wsgi import WSGIHandler\n \n from django.contrib.staticfiles import utils\n@@ -67,6 +68,6 @@ def get_response(self, request):\n         return super(StaticFilesHandler, self).get_response(request)\n \n     def __call__(self, environ, start_response):\n-        if not self._should_handle(environ['PATH_INFO']):\n+        if not self._should_handle(get_path_info(environ)):\n             return self.application(environ, start_response)\n         return super(StaticFilesHandler, self).__call__(environ, start_response)"
        },
        {
            "sha": "023947585eb8bbb4be9e82d3b6f1cdc820546138",
            "filename": "django/core/handlers/base.py",
            "status": "modified",
            "additions": 28,
            "deletions": 15,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Fcore%2Fhandlers%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Fcore%2Fhandlers%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fbase.py?ref=1e4a27d08790c96f657d2e960c8142d1ca69aede",
            "patch": "@@ -5,10 +5,14 @@\n import types\n \n from django import http\n+from django.conf import settings\n+from django.core import exceptions\n+from django.core import urlresolvers\n from django.core import signals\n from django.utils.encoding import force_text\n from django.utils.importlib import import_module\n from django.utils import six\n+from django.views import debug\n \n logger = logging.getLogger('django.request')\n \n@@ -32,8 +36,6 @@ def load_middleware(self):\n \n         Must be called after the environment is fixed (see __call__ in subclasses).\n         \"\"\"\n-        from django.conf import settings\n-        from django.core import exceptions\n         self._view_middleware = []\n         self._template_response_middleware = []\n         self._response_middleware = []\n@@ -75,9 +77,6 @@ def load_middleware(self):\n \n     def get_response(self, request):\n         \"Returns an HttpResponse object for the given HttpRequest\"\n-        from django.core import exceptions, urlresolvers\n-        from django.conf import settings\n-\n         try:\n             # Setup default url resolver for this thread, this code is outside\n             # the try/except so we don't get a spurious \"unbound local\n@@ -147,7 +146,6 @@ def get_response(self, request):\n                                 'request': request\n                             })\n                 if settings.DEBUG:\n-                    from django.views import debug\n                     response = debug.technical_404_response(request, e)\n                 else:\n                     try:\n@@ -204,8 +202,6 @@ def handle_uncaught_exception(self, request, resolver, exc_info):\n         caused by anything, so assuming something like the database is always\n         available would be an error.\n         \"\"\"\n-        from django.conf import settings\n-\n         if settings.DEBUG_PROPAGATE_EXCEPTIONS:\n             raise\n \n@@ -218,7 +214,6 @@ def handle_uncaught_exception(self, request, resolver, exc_info):\n         )\n \n         if settings.DEBUG:\n-            from django.views import debug\n             return debug.technical_500_response(request, *exc_info)\n \n         # If Http500 handler is not installed, re-raise last exception\n@@ -238,6 +233,20 @@ def apply_response_fixes(self, request, response):\n             response = func(request, response)\n         return response\n \n+\n+def get_path_info(environ):\n+    \"\"\"\n+    Returns the HTTP request's PATH_INFO as a unicode string.\n+    \"\"\"\n+    path_info = environ.get('PATH_INFO', str('/'))\n+    # Under Python 3, strings in environ are decoded with ISO-8859-1;\n+    # re-encode to recover the original bytestring provided by the webserver.\n+    if six.PY3:\n+        path_info = path_info.encode('iso-8859-1')\n+    # It'd be better to implement URI-to-IRI decoding, see #19508.\n+    return path_info.decode('utf-8')\n+\n+\n def get_script_name(environ):\n     \"\"\"\n     Returns the equivalent of the HTTP request's SCRIPT_NAME environment\n@@ -246,7 +255,6 @@ def get_script_name(environ):\n     from the client's perspective), unless the FORCE_SCRIPT_NAME setting is\n     set (to anything).\n     \"\"\"\n-    from django.conf import settings\n     if settings.FORCE_SCRIPT_NAME is not None:\n         return force_text(settings.FORCE_SCRIPT_NAME)\n \n@@ -255,9 +263,14 @@ def get_script_name(environ):\n     # rewrites. Unfortunately not every Web server (lighttpd!) passes this\n     # information through all the time, so FORCE_SCRIPT_NAME, above, is still\n     # needed.\n-    script_url = environ.get('SCRIPT_URL', '')\n-    if not script_url:\n-        script_url = environ.get('REDIRECT_URL', '')\n+    script_url = environ.get('SCRIPT_URL', environ.get('REDIRECT_URL', str('')))\n     if script_url:\n-        return force_text(script_url[:-len(environ.get('PATH_INFO', ''))])\n-    return force_text(environ.get('SCRIPT_NAME', ''))\n+        script_name = script_url[:-len(environ.get('PATH_INFO', str('')))]\n+    else:\n+        script_name = environ.get('SCRIPT_NAME', str(''))\n+    # Under Python 3, strings in environ are decoded with ISO-8859-1;\n+    # re-encode to recover the original bytestring provided by the webserver.\n+    if six.PY3:\n+        script_name = script_name.encode('iso-8859-1')\n+    # It'd be better to implement URI-to-IRI decoding, see #19508.\n+    return script_name.decode('utf-8')"
        },
        {
            "sha": "426679ca7b9ca5acf569f5730c59ee0d77f67b5b",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=1e4a27d08790c96f657d2e960c8142d1ca69aede",
            "patch": "@@ -128,7 +128,7 @@ def readline(self, size=None):\n class WSGIRequest(http.HttpRequest):\n     def __init__(self, environ):\n         script_name = base.get_script_name(environ)\n-        path_info = force_text(environ.get('PATH_INFO', '/'))\n+        path_info = base.get_path_info(environ)\n         if not path_info or path_info == script_name:\n             # Sometimes PATH_INFO exists, but is empty (e.g. accessing\n             # the SCRIPT_NAME URL without a trailing slash). We really need to"
        },
        {
            "sha": "015ee1309a188e2cd13b546993e9739ef3cdcec1",
            "filename": "django/test/client.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Ftest%2Fclient.py",
            "raw_url": "https://github.com/django/django/raw/1e4a27d08790c96f657d2e960c8142d1ca69aede/django%2Ftest%2Fclient.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fclient.py?ref=1e4a27d08790c96f657d2e960c8142d1ca69aede",
            "patch": "@@ -245,7 +245,11 @@ def _get_path(self, parsed):\n         # If there are parameters, add them\n         if parsed[3]:\n             path += str(\";\") + force_str(parsed[3])\n-        return unquote(path)\n+        path = unquote(path)\n+        # WSGI requires latin-1 encoded strings. See get_path_info().\n+        if six.PY3:\n+            path = path.encode('utf-8').decode('iso-8859-1')\n+        return path\n \n     def get(self, path, data={}, **extra):\n         \"Construct a GET request.\""
        },
        {
            "sha": "9cd581621915346b9edd109a56560319118ef98f",
            "filename": "tests/regressiontests/handlers/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/1e4a27d08790c96f657d2e960c8142d1ca69aede/tests%2Fregressiontests%2Fhandlers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1e4a27d08790c96f657d2e960c8142d1ca69aede/tests%2Fregressiontests%2Fhandlers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhandlers%2Ftests.py?ref=1e4a27d08790c96f657d2e960c8142d1ca69aede",
            "patch": "@@ -1,6 +1,7 @@\n from django.core.handlers.wsgi import WSGIHandler\n from django.test import RequestFactory\n from django.test.utils import override_settings\n+from django.utils import six\n from django.utils import unittest\n \n class HandlerTests(unittest.TestCase):\n@@ -22,7 +23,7 @@ def test_lock_safety(self):\n     def test_bad_path_info(self):\n         \"\"\"Tests for bug #15672 ('request' referenced before assignment)\"\"\"\n         environ = RequestFactory().get('/').environ\n-        environ['PATH_INFO'] = b'\\xed'\n+        environ['PATH_INFO'] = '\\xed'\n         handler = WSGIHandler()\n         response = handler(environ, lambda *a, **k: None)\n         self.assertEqual(response.status_code, 400)"
        },
        {
            "sha": "bb7f925e8739afd2670bb6c51e2a2af98f2b02da",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/1e4a27d08790c96f657d2e960c8142d1ca69aede/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1e4a27d08790c96f657d2e960c8142d1ca69aede/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=1e4a27d08790c96f657d2e960c8142d1ca69aede",
            "patch": "@@ -11,6 +11,7 @@\n from django.http import HttpRequest, HttpResponse, parse_cookie, build_request_repr, UnreadablePostError\n from django.test.client import FakePayload\n from django.test.utils import override_settings, str_prefix\n+from django.utils import six\n from django.utils import unittest\n from django.utils.http import cookie_date, urlencode\n from django.utils.timezone import utc\n@@ -57,6 +58,16 @@ def test_wsgirequest_repr(self):\n         self.assertEqual(build_request_repr(request, path_override='/otherpath/', GET_override={'a': 'b'}, POST_override={'c': 'd'}, COOKIES_override={'e': 'f'}, META_override={'g': 'h'}),\n                          str_prefix(\"<WSGIRequest\\npath:/otherpath/,\\nGET:{%(_)s'a': %(_)s'b'},\\nPOST:{%(_)s'c': %(_)s'd'},\\nCOOKIES:{%(_)s'e': %(_)s'f'},\\nMETA:{%(_)s'g': %(_)s'h'}>\"))\n \n+    def test_wsgirequest_path_info(self):\n+        def wsgi_str(path_info):\n+            path_info = path_info.encode('utf-8')           # Actual URL sent by the browser (bytestring)\n+            if six.PY3:\n+                path_info = path_info.decode('iso-8859-1')  # Value in the WSGI environ dict (native string)\n+            return path_info\n+        # Regression for #19468\n+        request = WSGIRequest({'PATH_INFO': wsgi_str(\"/سلام/\"), 'REQUEST_METHOD': 'get', 'wsgi.input': BytesIO(b'')})\n+        self.assertEqual(request.path, \"/سلام/\")\n+\n     def test_parse_cookie(self):\n         self.assertEqual(parse_cookie('invalid@key=true'), {})\n "
        }
    ],
    "stats": {
        "total": 68,
        "additions": 49,
        "deletions": 19
    }
}