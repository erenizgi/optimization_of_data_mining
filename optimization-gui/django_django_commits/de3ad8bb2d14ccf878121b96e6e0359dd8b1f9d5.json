{
    "author": "aaugustin",
    "message": "[py3] Avoided passing a lazy string to urlparse.\n\nThis causes an exception under Python 3.\n\nFixed #18776.",
    "sha": "de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5",
    "files": [
        {
            "sha": "beeb284998cdbb2aaa78024c30c8d3e8955d34b2",
            "filename": "django/contrib/auth/decorators.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5/django%2Fcontrib%2Fauth%2Fdecorators.py",
            "raw_url": "https://github.com/django/django/raw/de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5/django%2Fcontrib%2Fauth%2Fdecorators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fdecorators.py?ref=de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5",
            "patch": "@@ -7,6 +7,7 @@\n from django.contrib.auth import REDIRECT_FIELD_NAME\n from django.core.exceptions import PermissionDenied\n from django.utils.decorators import available_attrs\n+from django.utils.encoding import force_str\n \n \n def user_passes_test(test_func, login_url=None, redirect_field_name=REDIRECT_FIELD_NAME):\n@@ -22,9 +23,11 @@ def _wrapped_view(request, *args, **kwargs):\n             if test_func(request.user):\n                 return view_func(request, *args, **kwargs)\n             path = request.build_absolute_uri()\n+            # urlparse chokes on lazy objects in Python 3\n+            login_url_as_str = force_str(login_url or settings.LOGIN_URL)\n             # If the login url is the same scheme and net location then just\n             # use the path as the \"next\" url.\n-            login_scheme, login_netloc = urlparse(login_url or settings.LOGIN_URL)[:2]\n+            login_scheme, login_netloc = urlparse(login_url_as_str)[:2]\n             current_scheme, current_netloc = urlparse(path)[:2]\n             if ((not login_scheme or login_scheme == current_scheme) and\n                 (not login_netloc or login_netloc == current_netloc)):"
        },
        {
            "sha": "f93541b4bf9266883ecc5d07056cab7671ef5e34",
            "filename": "django/contrib/auth/views.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5/django%2Fcontrib%2Fauth%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5/django%2Fcontrib%2Fauth%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fviews.py?ref=de3ad8bb2d14ccf878121b96e6e0359dd8b1f9d5",
            "patch": "@@ -7,6 +7,7 @@\n from django.core.urlresolvers import reverse\n from django.http import HttpResponseRedirect, QueryDict\n from django.template.response import TemplateResponse\n+from django.utils.encoding import force_str\n from django.utils.http import base36_to_int\n from django.utils.translation import ugettext as _\n from django.views.decorators.debug import sensitive_post_parameters\n@@ -116,10 +117,10 @@ def redirect_to_login(next, login_url=None,\n     \"\"\"\n     Redirects the user to the login page, passing the given 'next' page\n     \"\"\"\n-    if not login_url:\n-        login_url = settings.LOGIN_URL\n+    # urlparse chokes on lazy objects in Python 3\n+    login_url_as_str = force_str(login_url or settings.LOGIN_URL)\n \n-    login_url_parts = list(urlparse(login_url))\n+    login_url_parts = list(urlparse(login_url_as_str))\n     if redirect_field_name:\n         querystring = QueryDict(login_url_parts[4], mutable=True)\n         querystring[redirect_field_name] = next"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 8,
        "deletions": 4
    }
}