{
    "author": "claudep",
    "message": "Fixed #19441 -- Created PostgreSQL varchar index when unique=True\n\nThanks Dylan Verheul for the report and Anssi Kääriäinen for the\nreview.",
    "sha": "55972ee5c799c75f2d3a320a46297076aaae614a",
    "files": [
        {
            "sha": "90304aa566daa4b615c4151cf17913aec240c8f1",
            "filename": "django/db/backends/postgresql_psycopg2/creation.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/55972ee5c799c75f2d3a320a46297076aaae614a/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/55972ee5c799c75f2d3a320a46297076aaae614a/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fcreation.py?ref=55972ee5c799c75f2d3a320a46297076aaae614a",
            "patch": "@@ -41,7 +41,8 @@ def sql_table_creation_suffix(self):\n         return ''\n \n     def sql_indexes_for_field(self, model, f, style):\n-        if f.db_index and not f.unique:\n+        output = []\n+        if f.db_index:\n             qn = self.connection.ops.quote_name\n             db_table = model._meta.db_table\n             tablespace = f.db_tablespace or model._meta.db_tablespace\n@@ -60,7 +61,8 @@ def get_index_sql(index_name, opclass=''):\n                         \"(%s%s)\" % (style.SQL_FIELD(qn(f.column)), opclass) +\n                         \"%s;\" % tablespace_sql)\n \n-            output = [get_index_sql('%s_%s' % (db_table, f.column))]\n+            if not f.unique:\n+                output = [get_index_sql('%s_%s' % (db_table, f.column))]\n \n             # Fields with database column types of `varchar` and `text` need\n             # a second index that specifies their operator class, which is\n@@ -73,8 +75,6 @@ def get_index_sql(index_name, opclass=''):\n             elif db_type.startswith('text'):\n                 output.append(get_index_sql('%s_%s_like' % (db_table, f.column),\n                                             ' text_pattern_ops'))\n-        else:\n-            output = []\n         return output\n \n     def set_autocommit(self):"
        },
        {
            "sha": "47ba5896a8aef7fc4c22dc000fdb8a31e89288be",
            "filename": "tests/regressiontests/indexes/models.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/55972ee5c799c75f2d3a320a46297076aaae614a/tests%2Fregressiontests%2Findexes%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/55972ee5c799c75f2d3a320a46297076aaae614a/tests%2Fregressiontests%2Findexes%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Findexes%2Fmodels.py?ref=55972ee5c799c75f2d3a320a46297076aaae614a",
            "patch": "@@ -9,3 +9,9 @@ class Meta:\n         index_together = [\n             [\"headline\", \"pub_date\"],\n         ]\n+\n+\n+class IndexedArticle(models.Model):\n+    headline = models.CharField(max_length=100, db_index=True)\n+    body = models.TextField(db_index=True)\n+    slug = models.CharField(max_length=40, unique=True, db_index=True)"
        },
        {
            "sha": "f3a32a44bbcd5b5487cd61832e8028a0fe713524",
            "filename": "tests/regressiontests/indexes/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/55972ee5c799c75f2d3a320a46297076aaae614a/tests%2Fregressiontests%2Findexes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/55972ee5c799c75f2d3a320a46297076aaae614a/tests%2Fregressiontests%2Findexes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Findexes%2Ftests.py?ref=55972ee5c799c75f2d3a320a46297076aaae614a",
            "patch": "@@ -1,12 +1,26 @@\n from django.core.management.color import no_style\n from django.db import connections, DEFAULT_DB_ALIAS\n from django.test import TestCase\n+from django.utils.unittest import skipUnless\n \n-from .models import Article\n+from .models import Article, IndexedArticle\n \n \n class IndexesTests(TestCase):\n     def test_index_together(self):\n         connection = connections[DEFAULT_DB_ALIAS]\n         index_sql = connection.creation.sql_indexes_for_model(Article, no_style())\n         self.assertEqual(len(index_sql), 1)\n+\n+    @skipUnless(connections[DEFAULT_DB_ALIAS].vendor == 'postgresql',\n+        \"This is a postgresql-specific issue\")\n+    def test_postgresql_text_indexes(self):\n+        \"\"\"Test creation of PostgreSQL-specific text indexes (#12234)\"\"\"\n+        connection = connections[DEFAULT_DB_ALIAS]\n+        index_sql = connection.creation.sql_indexes_for_model(IndexedArticle, no_style())\n+        self.assertEqual(len(index_sql), 5)\n+        self.assertIn('(\"headline\" varchar_pattern_ops)', index_sql[1])\n+        self.assertIn('(\"body\" text_pattern_ops)', index_sql[3])\n+        # unique=True and db_index=True should only create the varchar-specific\n+        # index (#19441).\n+        self.assertIn('(\"slug\" varchar_pattern_ops)', index_sql[4])"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 25,
        "deletions": 5
    }
}