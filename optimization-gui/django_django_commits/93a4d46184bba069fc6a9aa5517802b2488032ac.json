{
    "author": "carljm",
    "message": "Fixed #14672 - Added admin handling for on_delete=PROTECT. Thanks to jtiai for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15249 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "93a4d46184bba069fc6a9aa5517802b2488032ac",
    "files": [
        {
            "sha": "6e52e34d94712a9913338b05b53a93102a07d313",
            "filename": "django/contrib/admin/actions.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Factions.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Factions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Factions.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -32,7 +32,7 @@ def delete_selected(modeladmin, request, queryset):\n \n     # Populate deletable_objects, a data structure of all related objects that\n     # will also be deleted.\n-    deletable_objects, perms_needed = get_deleted_objects(\n+    deletable_objects, perms_needed, protected = get_deleted_objects(\n         queryset, opts, request.user, modeladmin.admin_site, using)\n \n     # The user has already confirmed the deletion.\n@@ -58,6 +58,7 @@ def delete_selected(modeladmin, request, queryset):\n         \"deletable_objects\": [deletable_objects],\n         'queryset': queryset,\n         \"perms_lacking\": perms_needed,\n+        \"protected\": protected,\n         \"opts\": opts,\n         \"root_path\": modeladmin.admin_site.root_path,\n         \"app_label\": app_label,"
        },
        {
            "sha": "f51070ca67a22cdbbe38bf8b5f15240320645df4",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -1177,7 +1177,7 @@ def delete_view(self, request, object_id, extra_context=None):\n \n         # Populate deleted_objects, a data structure of all related objects that\n         # will also be deleted.\n-        (deleted_objects, perms_needed) = get_deleted_objects(\n+        (deleted_objects, perms_needed, protected) = get_deleted_objects(\n             [obj], opts, request.user, self.admin_site, using)\n \n         if request.POST: # The user has already confirmed the deletion.\n@@ -1199,6 +1199,7 @@ def delete_view(self, request, object_id, extra_context=None):\n             \"object\": obj,\n             \"deleted_objects\": deleted_objects,\n             \"perms_lacking\": perms_needed,\n+            \"protected\": protected,\n             \"opts\": opts,\n             \"root_path\": self.admin_site.root_path,\n             \"app_label\": app_label,"
        },
        {
            "sha": "db4ef627b765c65b3d2f1f385bb6944de98fe63c",
            "filename": "django/contrib/admin/templates/admin/delete_confirmation.html",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fdelete_confirmation.html",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fdelete_confirmation.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fdelete_confirmation.html?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -12,13 +12,23 @@\n {% endblock %}\n \n {% block content %}\n-{% if perms_lacking %}\n-    <p>{% blocktrans with object as escaped_object %}Deleting the {{ object_name }} '{{ escaped_object }}' would result in deleting related objects, but your account doesn't have permission to delete the following types of objects:{% endblocktrans %}</p>\n-    <ul>\n-    {% for obj in perms_lacking %}\n-        <li>{{ obj }}</li>\n-    {% endfor %}\n-    </ul>\n+{% if perms_lacking or protected %}\n+    {% if perms_lacking %}\n+        <p>{% blocktrans with object as escaped_object %}Deleting the {{ object_name }} '{{ escaped_object }}' would result in deleting related objects, but your account doesn't have permission to delete the following types of objects:{% endblocktrans %}</p>\n+        <ul>\n+        {% for obj in perms_lacking %}\n+            <li>{{ obj }}</li>\n+        {% endfor %}\n+        </ul>\n+    {% endif %}\n+    {% if protected %}\n+        <p>{% blocktrans with object as escaped_object %}Deleting the {{ object_name }} '{{ escaped_object }}' is not possible, because it would require deleting the following protected related objects:{% endblocktrans %}</p>\n+        <ul>\n+        {% for obj in protected %}\n+            <li>{{ obj }}</li>\n+        {% endfor %}\n+        </ul>\n+    {% endif %}\n {% else %}\n     <p>{% blocktrans with object as escaped_object %}Are you sure you want to delete the {{ object_name }} \"{{ escaped_object }}\"? All of the following related items will be deleted:{% endblocktrans %}</p>\n     <ul>{{ deleted_objects|unordered_list }}</ul>"
        },
        {
            "sha": "aad8b13a8a40244c23806aafcbe7df3085817c09",
            "filename": "django/contrib/admin/templates/admin/delete_selected_confirmation.html",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fdelete_selected_confirmation.html",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fdelete_selected_confirmation.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fdelete_selected_confirmation.html?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -11,13 +11,23 @@\n {% endblock %}\n \n {% block content %}\n-{% if perms_lacking %}\n-    <p>{% blocktrans %}Deleting the {{ object_name }} would result in deleting related objects, but your account doesn't have permission to delete the following types of objects:{% endblocktrans %}</p>\n-    <ul>\n-    {% for obj in perms_lacking %}\n-        <li>{{ obj }}</li>\n-    {% endfor %}\n-    </ul>\n+{% if perms_lacking or protected %}\n+    {% if perms_lacking %}\n+        <p>{% blocktrans %}Deleting the {{ object_name }} would result in deleting related objects, but your account doesn't have permission to delete the following types of objects:{% endblocktrans %}</p>\n+        <ul>\n+        {% for obj in perms_lacking %}\n+            <li>{{ obj }}</li>\n+        {% endfor %}\n+        </ul>\n+    {% endif %}\n+    {% if protected %}\n+        <p>{% blocktrans %}Deleting the {{ object_name }} is not possible, because it would require deleting the following protected related objects:{% endblocktrans %}</p>\n+        <ul>\n+        {% for obj in protected %}\n+            <li>{{ obj }}</li>\n+        {% endfor %}\n+        </ul>\n+    {% endif %}\n {% else %}\n     <p>{% blocktrans %}Are you sure you want to delete the selected {{ object_name }} objects? All of the following objects and their related items will be deleted:{% endblocktrans %}</p>\n     {% for deletable_object in deletable_objects %}"
        },
        {
            "sha": "1c39614200d31cea684c300a4b6b95cb99cf3842",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -104,13 +104,16 @@ def format_callback(obj):\n \n     to_delete = collector.nested(format_callback)\n \n-    return to_delete, perms_needed\n+    protected = [format_callback(obj) for obj in collector.protected]\n+\n+    return to_delete, perms_needed, protected\n \n \n class NestedObjects(Collector):\n     def __init__(self, *args, **kwargs):\n         super(NestedObjects, self).__init__(*args, **kwargs)\n         self.edges = {} # {from_instance: [to_instances]}\n+        self.protected = set()\n \n     def add_edge(self, source, target):\n         self.edges.setdefault(source, []).append(target)\n@@ -121,7 +124,10 @@ def collect(self, objs, source_attr=None, **kwargs):\n                 self.add_edge(getattr(obj, source_attr), obj)\n             else:\n                 self.add_edge(None, obj)\n-        return super(NestedObjects, self).collect(objs, source_attr=source_attr, **kwargs)\n+        try:\n+            return super(NestedObjects, self).collect(objs, source_attr=source_attr, **kwargs)\n+        except models.ProtectedError, e:\n+            self.protected.update(e.protected_objects)\n \n     def related_objects(self, related, objs):\n         qs = super(NestedObjects, self).related_objects(related, objs)"
        },
        {
            "sha": "9709976b192fdf0d1cf10e71041788c34314fe23",
            "filename": "django/db/models/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fdb%2Fmodels%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fdb%2Fmodels%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2F__init__.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -11,7 +11,7 @@\n from django.db.models.fields.subclassing import SubfieldBase\n from django.db.models.fields.files import FileField, ImageField\n from django.db.models.fields.related import ForeignKey, OneToOneField, ManyToManyField, ManyToOneRel, ManyToManyRel, OneToOneRel\n-from django.db.models.deletion import CASCADE, PROTECT, SET, SET_NULL, SET_DEFAULT, DO_NOTHING\n+from django.db.models.deletion import CASCADE, PROTECT, SET, SET_NULL, SET_DEFAULT, DO_NOTHING, ProtectedError\n from django.db.models import signals\n \n # Admin stages."
        },
        {
            "sha": "07f677ea6589d8191a3319669e652d4d232a06c7",
            "filename": "django/db/models/deletion.py",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fdb%2Fmodels%2Fdeletion.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/django%2Fdb%2Fmodels%2Fdeletion.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fdeletion.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -7,17 +7,27 @@\n from django.utils.functional import wraps\n \n \n+class ProtectedError(IntegrityError):\n+    def __init__(self, msg, protected_objects):\n+        self.protected_objects = protected_objects\n+        super(ProtectedError, self).__init__(msg, protected_objects)\n+\n+\n def CASCADE(collector, field, sub_objs, using):\n     collector.collect(sub_objs, source=field.rel.to,\n                       source_attr=field.name, nullable=field.null)\n     if field.null and not connections[using].features.can_defer_constraint_checks:\n         collector.add_field_update(field, None, sub_objs)\n \n+\n def PROTECT(collector, field, sub_objs, using):\n-    raise IntegrityError(\"Cannot delete some instances of model '%s' because \"\n+    raise ProtectedError(\"Cannot delete some instances of model '%s' because \"\n         \"they are referenced through a protected foreign key: '%s.%s'\" % (\n             field.rel.to.__name__, sub_objs[0].__class__.__name__, field.name\n-    ))\n+        ),\n+        sub_objs\n+    )\n+\n \n def SET(value):\n     if callable(value):\n@@ -28,14 +38,18 @@ def set_on_delete(collector, field, sub_objs, using):\n             collector.add_field_update(field, value, sub_objs)\n     return set_on_delete\n \n+\n SET_NULL = SET(None)\n \n+\n def SET_DEFAULT(collector, field, sub_objs, using):\n     collector.add_field_update(field, field.get_default(), sub_objs)\n \n+\n def DO_NOTHING(collector, field, sub_objs, using):\n     pass\n \n+\n def force_managed(func):\n     @wraps(func)\n     def decorated(self, *args, **kwargs):\n@@ -55,6 +69,7 @@ def decorated(self, *args, **kwargs):\n                 transaction.leave_transaction_management(using=self.using)\n     return decorated\n \n+\n class Collector(object):\n     def __init__(self, using):\n         self.using = using"
        },
        {
            "sha": "38a7a10f2a13c69bad8f2e4261d7bfb5bca84e09",
            "filename": "docs/ref/models/fields.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/docs%2Fref%2Fmodels%2Ffields.txt",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/docs%2Fref%2Fmodels%2Ffields.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Ffields.txt?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -971,7 +971,8 @@ define the details of how the relation works.\n     * :attr:`~django.db.models.CASCADE`: Cascade deletes; the default.\n \n     * :attr:`~django.db.models.PROTECT`: Prevent deletion of the referenced\n-      object by raising :exc:`django.db.IntegrityError`.\n+      object by raising :exc:`django.db.models.ProtectedError`, a subclass of\n+      :exc:`django.db.IntegrityError`.\n \n     * :attr:`~django.db.models.SET_NULL`: Set the :class:`ForeignKey` null;\n       this is only possible if :attr:`null` is ``True``."
        },
        {
            "sha": "e64f713b7e33c2eee53436393c05b9dbbdfb53c0",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -626,6 +626,16 @@ class WorkHourAdmin(admin.ModelAdmin):\n     list_display = ('datum', 'employee')\n     list_filter = ('employee',)\n \n+class Question(models.Model):\n+    question = models.CharField(max_length=20)\n+\n+class Answer(models.Model):\n+    question = models.ForeignKey(Question, on_delete=models.PROTECT)\n+    answer = models.CharField(max_length=20)\n+\n+    def __unicode__(self):\n+        return self.answer\n+\n admin.site.register(Article, ArticleAdmin)\n admin.site.register(CustomArticle, CustomArticleAdmin)\n admin.site.register(Section, save_as=True, inlines=[ArticleInline])\n@@ -674,3 +684,5 @@ class WorkHourAdmin(admin.ModelAdmin):\n admin.site.register(Pizza, PizzaAdmin)\n admin.site.register(Topping)\n admin.site.register(Album, AlbumAdmin)\n+admin.site.register(Question)\n+admin.site.register(Answer)"
        },
        {
            "sha": "ecc2316760ec40cab85f5098cf19ea390ce3dabd",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 37,
            "deletions": 5,
            "changes": 42,
            "blob_url": "https://github.com/django/django/blob/93a4d46184bba069fc6a9aa5517802b2488032ac/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/93a4d46184bba069fc6a9aa5517802b2488032ac/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=93a4d46184bba069fc6a9aa5517802b2488032ac",
            "patch": "@@ -29,11 +29,12 @@\n from django.utils import unittest\n \n # local test models\n-from models import Article, BarAccount, CustomArticle, EmptyModel, \\\n-    FooAccount, Gallery, ModelWithStringPrimaryKey, \\\n-    Person, Persona, Picture, Podcast, Section, Subscriber, Vodcast, \\\n-    Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit, \\\n-    Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee\n+from models import (Article, BarAccount, CustomArticle, EmptyModel,\n+    FooAccount, Gallery, ModelWithStringPrimaryKey,\n+    Person, Persona, Picture, Podcast, Section, Subscriber, Vodcast,\n+    Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit,\n+    Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee,\n+    Question, Answer)\n \n \n class AdminViewBasicTest(TestCase):\n@@ -884,6 +885,15 @@ def test_perms_needed(self):\n         self.assertContains(response, \"your account doesn't have permission to delete the following types of objects\")\n         self.assertContains(response, \"<li>plot details</li>\")\n \n+    def test_protected(self):\n+        q = Question.objects.create(question=\"Why?\")\n+        a1 = Answer.objects.create(question=q, answer=\"Because.\")\n+        a2 = Answer.objects.create(question=q, answer=\"Yes.\")\n+\n+        response = self.client.get(\"/test_admin/admin/admin_views/question/%s/delete/\" % quote(q.pk))\n+        self.assertContains(response, \"would require deleting the following protected related objects\")\n+        self.assertContains(response, '<li>Answer: <a href=\"/test_admin/admin/admin_views/answer/%s/\">Because.</a></li>' % a1.pk)\n+        self.assertContains(response, '<li>Answer: <a href=\"/test_admin/admin/admin_views/answer/%s/\">Yes.</a></li>' % a2.pk)\n \n     def test_not_registered(self):\n         should_contain = \"\"\"<li>Secret hideout: underground bunker\"\"\"\n@@ -1627,6 +1637,28 @@ def test_model_admin_default_delete_action(self):\n         response = self.client.post('/test_admin/admin/admin_views/subscriber/', delete_confirmation_data)\n         self.assertEqual(Subscriber.objects.count(), 0)\n \n+    def test_model_admin_default_delete_action_protected(self):\n+        \"\"\"\n+        Tests the default delete action defined as a ModelAdmin method in the\n+        case where some related objects are protected from deletion.\n+        \"\"\"\n+        q1 = Question.objects.create(question=\"Why?\")\n+        a1 = Answer.objects.create(question=q1, answer=\"Because.\")\n+        a2 = Answer.objects.create(question=q1, answer=\"Yes.\")\n+        q2 = Question.objects.create(question=\"Wherefore?\")\n+\n+        action_data = {\n+            ACTION_CHECKBOX_NAME: [q1.pk, q2.pk],\n+            'action' : 'delete_selected',\n+            'index': 0,\n+        }\n+\n+        response = self.client.post(\"/test_admin/admin/admin_views/question/\", action_data)\n+\n+        self.assertContains(response, \"would require deleting the following protected related objects\")\n+        self.assertContains(response, '<li>Answer: <a href=\"/test_admin/admin/admin_views/answer/%s/\">Because.</a></li>' % a1.pk)\n+        self.assertContains(response, '<li>Answer: <a href=\"/test_admin/admin/admin_views/answer/%s/\">Yes.</a></li>' % a2.pk)\n+\n     def test_custom_function_mail_action(self):\n         \"Tests a custom action defined in a function\"\n         action_data = {"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 115,
        "deletions": 27
    }
}