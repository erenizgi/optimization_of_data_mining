{
    "author": "jezdez",
    "message": "Fixed #16115 -- Added ModelAdmin.save_related method to be able to do pre- or post-save operations for objects related to the parent object currently displayed. Thanks, Julien Phalip.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16498 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "332a485567420e844887344b6429d3b4db4b260b",
    "files": [
        {
            "sha": "550f46aed381e406f007da8199eddf5ebed57d05",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/332a485567420e844887344b6429d3b4db4b260b/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/332a485567420e844887344b6429d3b4db4b260b/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=332a485567420e844887344b6429d3b4db4b260b",
            "patch": "@@ -696,6 +696,18 @@ def save_formset(self, request, form, formset, change):\n         \"\"\"\n         formset.save()\n \n+    def save_related(self, request, form, formsets, change):\n+        \"\"\"\n+        Given the ``HttpRequest``, the parent ``ModelForm`` instance, the\n+        list of inline formsets and a boolean value based on whether the\n+        parent is being added or changed, save the related objects to the\n+        database. Note that at this point save_form() and save_model() have\n+        already been called.\n+        \"\"\"\n+        form.save_m2m()\n+        for formset in formsets:\n+            self.save_formset(request, form, formset, change=change)\n+\n     def render_change_form(self, request, context, add=False, change=False, form_url='', obj=None):\n         opts = self.model._meta\n         app_label = opts.app_label\n@@ -899,11 +911,8 @@ def add_view(self, request, form_url='', extra_context=None):\n                                   prefix=prefix, queryset=inline.queryset(request))\n                 formsets.append(formset)\n             if all_valid(formsets) and form_validated:\n-                self.save_model(request, new_object, form, change=False)\n-                form.save_m2m()\n-                for formset in formsets:\n-                    self.save_formset(request, form, formset, change=False)\n-\n+                self.save_model(request, new_object, form, False)\n+                self.save_related(request, form, formsets, False)\n                 self.log_addition(request, new_object)\n                 return self.response_add(request, new_object)\n         else:\n@@ -1001,11 +1010,8 @@ def change_view(self, request, object_id, extra_context=None):\n                 formsets.append(formset)\n \n             if all_valid(formsets) and form_validated:\n-                self.save_model(request, new_object, form, change=True)\n-                form.save_m2m()\n-                for formset in formsets:\n-                    self.save_formset(request, form, formset, change=True)\n-\n+                self.save_model(request, new_object, form, True)\n+                self.save_related(request, form, formsets, True)\n                 change_message = self.construct_change_message(request, form, formsets)\n                 self.log_change(request, new_object, change_message)\n                 return self.response_change(request, new_object)"
        },
        {
            "sha": "43057a31b0515bcf1c924a82835ece4be2d12a3c",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/332a485567420e844887344b6429d3b4db4b260b/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/332a485567420e844887344b6429d3b4db4b260b/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=332a485567420e844887344b6429d3b4db4b260b",
            "patch": "@@ -978,6 +978,16 @@ templates used by the :class:`ModelAdmin` views:\n                 else:\n                     return ['name']\n \n+.. method:: ModelAdmin.save_related(self, request, form, formsets, change)\n+\n+    .. versionadded:: 1.4\n+\n+    The ``save_related`` method is given the ``HttpRequest``, the parent\n+    ``ModelForm`` instance, the list of inline formsets and a boolean value\n+    based on whether the parent is being added or changed. Here you can do any\n+    pre- or post-save operations for objects related to the parent. Note\n+    that at this point the parent object and its form have already been saved.\n+\n .. method:: ModelAdmin.get_readonly_fields(self, request, obj=None)\n \n     .. versionadded:: 1.2"
        },
        {
            "sha": "781093123c45f03a5a256ed8bfa6eda10e891580",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/332a485567420e844887344b6429d3b4db4b260b/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/332a485567420e844887344b6429d3b4db4b260b/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=332a485567420e844887344b6429d3b4db4b260b",
            "patch": "@@ -80,6 +80,13 @@ to work similarly to how desktop GUIs do it. The new hook\n :meth:`~django.contrib.admin.ModelAdmin.get_ordering` for specifying the\n ordering dynamically (e.g. depending on the request) has also been added.\n \n+``ModelAdmin.save_related()``\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+A new :meth:`~django.contrib.admin.ModelAdmin.save_related` hook was added to\n+:mod:`~django.contrib.admin.ModelAdmin` to ease the customization of how\n+related objects are saved in the admin.\n+\n Tools for cryptographic signing\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "8d79f44bb12cbb65451e3cb003d614971c2337f3",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/332a485567420e844887344b6429d3b4db4b260b/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/332a485567420e844887344b6429d3b4db4b260b/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=332a485567420e844887344b6429d3b4db4b260b",
            "patch": "@@ -391,6 +391,14 @@ class ParentAdmin(admin.ModelAdmin):\n     model = Parent\n     inlines = [ChildInline]\n \n+    def save_related(self, request, form, formsets, change):\n+        super(ParentAdmin, self).save_related(request, form, formsets, change)\n+        first_name, last_name = form.instance.name.split()\n+        for child in form.instance.child_set.all():\n+            if len(child.name.split()) < 2:\n+                child.name = child.name + ' ' + last_name\n+                child.save()\n+\n class EmptyModel(models.Model):\n     def __unicode__(self):\n         return \"Primary key = %s\" % self.id"
        },
        {
            "sha": "7128f04a64b57987db4e04ba42e2733b41239ad3",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 48,
            "deletions": 1,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/332a485567420e844887344b6429d3b4db4b260b/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/332a485567420e844887344b6429d3b4db4b260b/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=332a485567420e844887344b6429d3b4db4b260b",
            "patch": "@@ -38,7 +38,7 @@\n     Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee,\n     Question, Answer, Inquisition, Actor, FoodDelivery,\n     RowLevelChangePermissionModel, Paper, CoverLetter, Story, OtherStory,\n-    ComplexSortedPerson)\n+    ComplexSortedPerson, Parent, Child)\n \n \n class AdminViewBasicTest(TestCase):\n@@ -3113,3 +3113,50 @@ def test_multiple_years(self):\n             self.assert_non_localized_year(response, 2000)\n             self.assert_non_localized_year(response, 2003)\n             self.assert_non_localized_year(response, 2005)\n+\n+class AdminCustomSaveRelatedTests(TestCase):\n+    \"\"\"\n+    Ensure that one can easily customize the way related objects are saved.\n+    Refs #16115.\n+    \"\"\"\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def test_should_be_able_to_edit_related_objects_on_add_view(self):\n+        post = {\n+            'child_set-TOTAL_FORMS': '3',\n+            'child_set-INITIAL_FORMS': '0',\n+            'name': 'Josh Stone',\n+            'child_set-0-name': 'Paul',\n+            'child_set-1-name': 'Catherine',\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/parent/add/', post)\n+        self.assertEqual(1, Parent.objects.count())\n+        self.assertEqual(2, Child.objects.count())\n+\n+        children_names = list(Child.objects.order_by('name').values_list('name', flat=True))\n+\n+        self.assertEqual('Josh Stone', Parent.objects.latest('id').name)\n+        self.assertEqual([u'Catherine Stone', u'Paul Stone'], children_names)\n+\n+    def test_should_be_able_to_edit_related_objects_on_change_view(self):\n+        parent = Parent.objects.create(name='Josh Stone')\n+        paul = Child.objects.create(parent=parent, name='Paul')\n+        catherine = Child.objects.create(parent=parent, name='Catherine')\n+        post = {\n+            'child_set-TOTAL_FORMS': '5',\n+            'child_set-INITIAL_FORMS': '2',\n+            'name': 'Josh Stone',\n+            'child_set-0-name': 'Paul',\n+            'child_set-0-id': paul.id,\n+            'child_set-1-name': 'Catherine',\n+            'child_set-1-id': catherine.id,\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/parent/%s/' % parent.id, post)\n+\n+        children_names = list(Child.objects.order_by('name').values_list('name', flat=True))\n+\n+        self.assertEqual('Josh Stone', Parent.objects.latest('id').name)\n+        self.assertEqual([u'Catherine Stone', u'Paul Stone'], children_names)"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 89,
        "deletions": 11
    }
}