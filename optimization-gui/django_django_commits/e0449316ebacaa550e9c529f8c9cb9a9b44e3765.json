{
    "author": "aaugustin",
    "message": "Fixed #18130 -- Made the isolation level configurable on PostgreSQL.\n\nThanks limscoder for the report and niwi for the draft patch.",
    "sha": "e0449316ebacaa550e9c529f8c9cb9a9b44e3765",
    "files": [
        {
            "sha": "f9af50731144a67b68330a71d4a55e1f71957c80",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=e0449316ebacaa550e9c529f8c9cb9a9b44e3765",
            "patch": "@@ -83,7 +83,8 @@ def __init__(self, *args, **kwargs):\n         if autocommit:\n             level = psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT\n         else:\n-            level = psycopg2.extensions.ISOLATION_LEVEL_READ_COMMITTED\n+            level = self.settings_dict[\"OPTIONS\"].get('isolation_level',\n+                psycopg2.extensions.ISOLATION_LEVEL_READ_COMMITTED)\n         self._set_isolation_level(level)\n         self.ops = DatabaseOperations(self)\n         self.client = DatabaseClient(self)\n@@ -104,6 +105,8 @@ def get_connection_params(self):\n         conn_params.update(settings_dict['OPTIONS'])\n         if 'autocommit' in conn_params:\n             del conn_params['autocommit']\n+        if 'isolation_level' in conn_params:\n+            del conn_params['isolation_level']\n         if settings_dict['USER']:\n             conn_params['user'] = settings_dict['USER']\n         if settings_dict['PASSWORD']:\n@@ -170,7 +173,9 @@ def _enter_transaction_management(self, managed):\n         the same transaction is visible across all the queries.\n         \"\"\"\n         if self.features.uses_autocommit and managed and not self.isolation_level:\n-            self._set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_READ_COMMITTED)\n+            level = self.settings_dict[\"OPTIONS\"].get('isolation_level',\n+                psycopg2.extensions.ISOLATION_LEVEL_READ_COMMITTED)\n+            self._set_isolation_level(level)\n \n     def _leave_transaction_management(self, managed):\n         \"\"\""
        },
        {
            "sha": "4e435949a2573cfb28469861a4c3b7ecbe7e5ca9",
            "filename": "docs/ref/databases.txt",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/docs%2Fref%2Fdatabases.txt",
            "raw_url": "https://github.com/django/django/raw/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/docs%2Fref%2Fdatabases.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdatabases.txt?ref=e0449316ebacaa550e9c529f8c9cb9a9b44e3765",
            "patch": "@@ -143,8 +143,11 @@ autocommit behavior is enabled by setting the ``autocommit`` key in\n the :setting:`OPTIONS` part of your database configuration in\n :setting:`DATABASES`::\n \n-    'OPTIONS': {\n-        'autocommit': True,\n+    DATABASES = {\n+        # ...\n+        'OPTIONS': {\n+            'autocommit': True,\n+        },\n     }\n \n In this configuration, Django still ensures that :ref:`delete()\n@@ -168,6 +171,34 @@ You should also audit your existing code for any instances of this behavior\n before enabling this feature. It's faster, but it provides less automatic\n protection for multi-call operations.\n \n+Isolation level\n+~~~~~~~~~~~~~~~\n+\n+.. versionadded:: 1.6\n+\n+Like PostgreSQL itself, Django defaults to the ``READ COMMITTED`` `isolation\n+level <postgresql-isolation-levels>`_. If you need a higher isolation level\n+such as ``REPEATABLE READ`` or ``SERIALIZABLE``, set it in the\n+:setting:`OPTIONS` part of your database configuration in\n+:setting:`DATABASES`::\n+\n+    import psycopg2.extensions\n+\n+    DATABASES = {\n+        # ...\n+        'OPTIONS': {\n+            'isolation_level': psycopg2.extensions.ISOLATION_LEVEL_SERIALIZABLE,\n+        },\n+    }\n+\n+.. note::\n+\n+    Under higher isolation levels, your application should be prepared to\n+    handle exceptions raised on serialization failures. This option is\n+    designed for advanced uses.\n+\n+.. _postgresql-isolation-levels: http://www.postgresql.org/docs/devel/static/transaction-iso.html\n+\n Indexes for ``varchar`` and ``text`` columns\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "74941a4fb38b23cfe114c23d326ddee763d14011",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=e0449316ebacaa550e9c529f8c9cb9a9b44e3765",
            "patch": "@@ -125,6 +125,8 @@ Minor features\n * The admin list columns have a ``column-<field_name>`` class in the HTML\n   so the columns header can be styled with CSS, e.g. to set a column width.\n \n+* The isolation level can be customized under PostgreSQL.\n+\n Backwards incompatible changes in 1.6\n =====================================\n "
        },
        {
            "sha": "6ba04892cd4808627596527e6f439dd60e7a7d12",
            "filename": "tests/transactions_regress/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/tests%2Ftransactions_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e0449316ebacaa550e9c529f8c9cb9a9b44e3765/tests%2Ftransactions_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Ftransactions_regress%2Ftests.py?ref=e0449316ebacaa550e9c529f8c9cb9a9b44e3765",
            "patch": "@@ -242,17 +242,18 @@ def test_commit_unless_managed_in_managed(self):\n \n @skipUnless(connection.vendor == 'postgresql',\n             \"This test only valid for PostgreSQL\")\n-class TestPostgresAutocommit(TransactionTestCase):\n+class TestPostgresAutocommitAndIsolation(TransactionTestCase):\n     \"\"\"\n-    Tests to make sure psycopg2's autocommit mode is restored after entering\n-    and leaving transaction management. Refs #16047.\n+    Tests to make sure psycopg2's autocommit mode and isolation level\n+    is restored after entering and leaving transaction management.\n+    Refs #16047, #18130.\n     \"\"\"\n     def setUp(self):\n         from psycopg2.extensions import (ISOLATION_LEVEL_AUTOCOMMIT,\n-                                         ISOLATION_LEVEL_READ_COMMITTED,\n+                                         ISOLATION_LEVEL_SERIALIZABLE,\n                                          TRANSACTION_STATUS_IDLE)\n         self._autocommit = ISOLATION_LEVEL_AUTOCOMMIT\n-        self._read_committed = ISOLATION_LEVEL_READ_COMMITTED\n+        self._serializable = ISOLATION_LEVEL_SERIALIZABLE\n         self._idle = TRANSACTION_STATUS_IDLE\n \n         # We want a clean backend with autocommit = True, so\n@@ -261,6 +262,7 @@ def setUp(self):\n         settings = self._old_backend.settings_dict.copy()\n         opts = settings['OPTIONS'].copy()\n         opts['autocommit'] = True\n+        opts['isolation_level'] = ISOLATION_LEVEL_SERIALIZABLE\n         settings['OPTIONS'] = opts\n         new_backend = self._old_backend.__class__(settings, DEFAULT_DB_ALIAS)\n         connections[DEFAULT_DB_ALIAS] = new_backend\n@@ -279,29 +281,29 @@ def test_initial_autocommit_state(self):\n     def test_transaction_management(self):\n         transaction.enter_transaction_management()\n         transaction.managed(True)\n-        self.assertEqual(connection.isolation_level, self._read_committed)\n+        self.assertEqual(connection.isolation_level, self._serializable)\n \n         transaction.leave_transaction_management()\n         self.assertEqual(connection.isolation_level, self._autocommit)\n \n     def test_transaction_stacking(self):\n         transaction.enter_transaction_management()\n         transaction.managed(True)\n-        self.assertEqual(connection.isolation_level, self._read_committed)\n+        self.assertEqual(connection.isolation_level, self._serializable)\n \n         transaction.enter_transaction_management()\n-        self.assertEqual(connection.isolation_level, self._read_committed)\n+        self.assertEqual(connection.isolation_level, self._serializable)\n \n         transaction.leave_transaction_management()\n-        self.assertEqual(connection.isolation_level, self._read_committed)\n+        self.assertEqual(connection.isolation_level, self._serializable)\n \n         transaction.leave_transaction_management()\n         self.assertEqual(connection.isolation_level, self._autocommit)\n \n     def test_enter_autocommit(self):\n         transaction.enter_transaction_management()\n         transaction.managed(True)\n-        self.assertEqual(connection.isolation_level, self._read_committed)\n+        self.assertEqual(connection.isolation_level, self._serializable)\n         list(Mod.objects.all())\n         self.assertTrue(transaction.is_dirty())\n         # Enter autocommit mode again.\n@@ -314,7 +316,7 @@ def test_enter_autocommit(self):\n         list(Mod.objects.all())\n         self.assertFalse(transaction.is_dirty())\n         transaction.leave_transaction_management()\n-        self.assertEqual(connection.isolation_level, self._read_committed)\n+        self.assertEqual(connection.isolation_level, self._serializable)\n         transaction.leave_transaction_management()\n         self.assertEqual(connection.isolation_level, self._autocommit)\n "
        }
    ],
    "stats": {
        "total": 70,
        "additions": 55,
        "deletions": 15
    }
}