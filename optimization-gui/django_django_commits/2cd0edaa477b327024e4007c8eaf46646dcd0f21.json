{
    "author": "gnosek",
    "message": "Fixed 19895 -- Made second iteration over invalid queryset raise an exception too\n\nWhen iteration over a queryset raised an exception, the result cache\nremained initialized with an empty list, so subsequent iterations returned\nan empty list instead of raising an exception",
    "sha": "2cd0edaa477b327024e4007c8eaf46646dcd0f21",
    "files": [
        {
            "sha": "ec35f8aba31671f0867badcfb78ce40c540a485f",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/2cd0edaa477b327024e4007c8eaf46646dcd0f21/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/2cd0edaa477b327024e4007c8eaf46646dcd0f21/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=2cd0edaa477b327024e4007c8eaf46646dcd0f21",
            "patch": "@@ -104,7 +104,7 @@ def __iter__(self):\n             len(self)\n \n         if self._result_cache is None:\n-            self._iter = self.iterator()\n+            self._iter = self._safe_iterator(self.iterator())\n             self._result_cache = []\n         if self._iter:\n             return self._result_iter()\n@@ -341,6 +341,18 @@ def iterator(self):\n \n             yield obj\n \n+    def _safe_iterator(self, iterator):\n+        # ensure result cache is cleared when iterating over a queryset\n+        # raises an exception\n+        try:\n+            for item in iterator:\n+                yield item\n+        except StopIteration:\n+            raise\n+        except Exception:\n+            self._result_cache = None\n+            raise\n+\n     def aggregate(self, *args, **kwargs):\n         \"\"\"\n         Returns a dictionary containing the calculations (aggregation)"
        },
        {
            "sha": "2de87a225f3690ca3775f4891e9326aff50552f1",
            "filename": "tests/modeltests/basic/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/2cd0edaa477b327024e4007c8eaf46646dcd0f21/tests%2Fmodeltests%2Fbasic%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2cd0edaa477b327024e4007c8eaf46646dcd0f21/tests%2Fmodeltests%2Fbasic%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fbasic%2Ftests.py?ref=2cd0edaa477b327024e4007c8eaf46646dcd0f21",
            "patch": "@@ -2,7 +2,7 @@\n \n from datetime import datetime\n \n-from django.core.exceptions import ObjectDoesNotExist, MultipleObjectsReturned\n+from django.core.exceptions import ObjectDoesNotExist, MultipleObjectsReturned, FieldError\n from django.db.models.fields import Field, FieldDoesNotExist\n from django.db.models.query import QuerySet, EmptyQuerySet, ValuesListQuerySet\n from django.test import TestCase, skipIfDBFeature, skipUnlessDBFeature\n@@ -686,3 +686,8 @@ def test_emptyqs_distinct(self):\n         Article.objects.create(headline='foo', pub_date=datetime.now())\n         with self.assertNumQueries(0):\n             self.assertEqual(len(Article.objects.none().distinct('headline', 'pub_date')), 0)\n+\n+    def test_invalid_qs_list(self):\n+        qs = Article.objects.order_by('invalid_column')\n+        self.assertRaises(FieldError, list, qs)\n+        self.assertRaises(FieldError, list, qs)\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 19,
        "deletions": 2
    }
}