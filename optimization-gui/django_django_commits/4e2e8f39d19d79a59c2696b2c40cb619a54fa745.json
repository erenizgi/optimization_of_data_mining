{
    "author": "claudep",
    "message": "Fixed #4833 -- Validate email addresses with localhost as domain",
    "sha": "4e2e8f39d19d79a59c2696b2c40cb619a54fa745",
    "files": [
        {
            "sha": "cd9dba1ee805d2172fdd86d136557fc5fdb5dd25",
            "filename": "django/core/validators.py",
            "status": "modified",
            "additions": 44,
            "deletions": 21,
            "changes": 65,
            "blob_url": "https://github.com/django/django/blob/4e2e8f39d19d79a59c2696b2c40cb619a54fa745/django%2Fcore%2Fvalidators.py",
            "raw_url": "https://github.com/django/django/raw/4e2e8f39d19d79a59c2696b2c40cb619a54fa745/django%2Fcore%2Fvalidators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fvalidators.py?ref=4e2e8f39d19d79a59c2696b2c40cb619a54fa745",
            "patch": "@@ -78,30 +78,53 @@ def validate_integer(value):\n         raise ValidationError('')\n \n \n-class EmailValidator(RegexValidator):\n+class EmailValidator(object):\n+    message = _('Enter a valid e-mail address.')\n+    code = 'invalid'\n+    user_regex = re.compile(\n+        r\"(^[-!#$%&'*+/=?^_`{}|~0-9A-Z]+(\\.[-!#$%&'*+/=?^_`{}|~0-9A-Z]+)*$\"  # dot-atom\n+        r'|^\"([\\001-\\010\\013\\014\\016-\\037!#-\\[\\]-\\177]|\\\\[\\001-\\011\\013\\014\\016-\\177])*\"$)', # quoted-string\n+        re.IGNORECASE)\n+    domain_regex = re.compile(\n+        r'(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\\.)+(?:[A-Z]{2,6}\\.?|[A-Z0-9-]{2,}\\.?$)'  # domain\n+        # literal form, ipv4 address (SMTP 4.1.3)\n+        r'|^\\[(25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)(\\.(25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)){3}\\]$',\n+        re.IGNORECASE)\n+    domain_whitelist = ['localhost']\n+\n+    def __init__(self, message=None, code=None, whitelist=None):\n+        if message is not None:\n+            self.message = message\n+        if code is not None:\n+            self.code = code\n+        if whitelist is not None:\n+            self.domain_whitelist = whitelist\n \n     def __call__(self, value):\n-        try:\n-            super(EmailValidator, self).__call__(value)\n-        except ValidationError as e:\n-            # Trivial case failed. Try for possible IDN domain-part\n-            if value and '@' in value:\n-                parts = value.split('@')\n-                try:\n-                    parts[-1] = parts[-1].encode('idna').decode('ascii')\n-                except UnicodeError:\n-                    raise e\n-                super(EmailValidator, self).__call__('@'.join(parts))\n-            else:\n-                raise\n+        value = force_text(value)\n+\n+        if not value or '@' not in value:\n+            raise ValidationError(self.message, code=self.code)\n+\n+        user_part, domain_part = value.split('@', 1)\n+\n+        if not self.user_regex.match(user_part):\n+            raise ValidationError(self.message, code=self.code)\n+\n+        if (not domain_part in self.domain_whitelist and\n+                not self.domain_regex.match(domain_part)):\n+            # Try for possible IDN domain-part\n+            try:\n+                domain_part = domain_part.encode('idna').decode('ascii')\n+                if not self.domain_regex.match(domain_part):\n+                    raise ValidationError(self.message, code=self.code)\n+                else:\n+                    return\n+            except UnicodeError:\n+                pass\n+            raise ValidationError(self.message, code=self.code)\n \n-email_re = re.compile(\n-    r\"(^[-!#$%&'*+/=?^_`{}|~0-9A-Z]+(\\.[-!#$%&'*+/=?^_`{}|~0-9A-Z]+)*\"  # dot-atom\n-    # quoted-string, see also http://tools.ietf.org/html/rfc2822#section-3.2.5\n-    r'|^\"([\\001-\\010\\013\\014\\016-\\037!#-\\[\\]-\\177]|\\\\[\\001-\\011\\013\\014\\016-\\177])*\"'\n-    r')@((?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\\.)+(?:[A-Z]{2,6}\\.?|[A-Z0-9-]{2,}\\.?)$)'  # domain\n-    r'|\\[(25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)(\\.(25[0-5]|2[0-4]\\d|[0-1]?\\d?\\d)){3}\\]$', re.IGNORECASE)  # literal form, ipv4 address (SMTP 4.1.3)\n-validate_email = EmailValidator(email_re, _('Enter a valid email address.'), 'invalid')\n+validate_email = EmailValidator()\n \n slug_re = re.compile(r'^[-a-zA-Z0-9_]+$')\n validate_slug = RegexValidator(slug_re, _(\"Enter a valid 'slug' consisting of letters, numbers, underscores or hyphens.\"), 'invalid')"
        },
        {
            "sha": "92e257ca8558b58337b7573b6a4c1d43e2e8e132",
            "filename": "docs/ref/validators.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/4e2e8f39d19d79a59c2696b2c40cb619a54fa745/docs%2Fref%2Fvalidators.txt",
            "raw_url": "https://github.com/django/django/raw/4e2e8f39d19d79a59c2696b2c40cb619a54fa745/docs%2Fref%2Fvalidators.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fvalidators.txt?ref=4e2e8f39d19d79a59c2696b2c40cb619a54fa745",
            "patch": "@@ -96,7 +96,7 @@ to, or in lieu of custom ``field.clean()`` methods.\n ------------------\n .. data:: validate_email\n \n-    A :class:`RegexValidator` instance that ensures a value looks like an\n+    An ``EmailValidator`` instance that ensures a value looks like an\n     email address.\n \n ``validate_slug``"
        },
        {
            "sha": "5b562a87e6a76bab7fd6df9362132679c402b8d8",
            "filename": "tests/modeltests/validators/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/4e2e8f39d19d79a59c2696b2c40cb619a54fa745/tests%2Fmodeltests%2Fvalidators%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4e2e8f39d19d79a59c2696b2c40cb619a54fa745/tests%2Fmodeltests%2Fvalidators%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fvalidators%2Ftests.py?ref=4e2e8f39d19d79a59c2696b2c40cb619a54fa745",
            "patch": "@@ -29,6 +29,8 @@\n     (validate_email, 'example@valid-----hyphens.com', None),\n     (validate_email, 'example@valid-with-hyphens.com', None),\n     (validate_email, 'test@domain.with.idn.tld.उदाहरण.परीक्षा', None),\n+    (validate_email, 'email@localhost', None),\n+    (EmailValidator(whitelist=['localdomain']), 'email@localdomain', None),\n \n     (validate_email, None, ValidationError),\n     (validate_email, '', ValidationError),"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 47,
        "deletions": 22
    }
}