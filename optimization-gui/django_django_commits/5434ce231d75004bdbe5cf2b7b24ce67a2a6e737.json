{
    "author": "spookylukey",
    "message": "Fixed #11868 - Multiple sort in admin changelist.\n\nMany thanks to bendavis78 for the initial patch, and for input from others.\n\nAlso fixed #7309. If people were relying on the undocumented default ordering\napplied by the admin before, they will need to add 'ordering = [\"-pk\"]' to\ntheir ModelAdmin.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16316 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
    "files": [
        {
            "sha": "26e2cbf14a547c8f8ee814b63376dd46e6e28a73",
            "filename": "django/contrib/admin/media/css/base.css",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Fbase.css",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Fbase.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Fbase.css?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -326,6 +326,34 @@ table thead th.descending a {\n     background: url(../img/admin/arrow-down.gif) right .4em no-repeat;\n }\n \n+table thead th.sorted a span.text {\n+   display: block;\n+   float: left;\n+}\n+\n+table thead th.sorted a span.sortpos {\n+   display: block;\n+   float: right;\n+   font-size: .6em;\n+}\n+\n+table thead th.sorted a img {\n+   vertical-align: bottom;\n+}\n+\n+table thead th.sorted a span.clear {\n+   display: block;\n+   clear: both;\n+}\n+\n+#sorting-popup-div {\n+    position: absolute;\n+    background-color: white;\n+    border: 1px solid #ddd;\n+    z-index: 2000; /* more than filters on right */\n+    padding-right: 10px;\n+}\n+\n /* ORDERABLE TABLES */\n \n table.orderable tbody tr td:hover {"
        },
        {
            "sha": "ec2bb2a9da39d9078770bc50b853416501688577",
            "filename": "django/contrib/admin/media/css/rtl.css",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Frtl.css",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Frtl.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Frtl.css?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -91,6 +91,14 @@ table thead th.descending a {\n     background-position: left;\n }\n \n+table thead th.sorted a span.text {\n+   float: right;\n+}\n+\n+table thead th.sorted a span.sortpos {\n+   float: left;\n+}\n+\n /* dashboard styles */\n \n .dashboard .module table td a {"
        },
        {
            "sha": "d86a9a74a9ffadab986dd358307f1c6b98b9f5ce",
            "filename": "django/contrib/admin/media/img/admin/icon_cog.gif",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fmedia%2Fimg%2Fadmin%2Ficon_cog.gif",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fmedia%2Fimg%2Fadmin%2Ficon_cog.gif",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fmedia%2Fimg%2Fadmin%2Ficon_cog.gif?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737"
        },
        {
            "sha": "e916433cf2e3da4ea3046245edfe5416ad98eb90",
            "filename": "django/contrib/admin/templates/admin/change_list_results.html",
            "status": "modified",
            "additions": 63,
            "deletions": 4,
            "changes": 67,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -1,3 +1,5 @@\n+{% load adminmedia %}\n+{% load i18n %}\n {% if result_hidden_fields %}\n <div class=\"hiddenfields\">{# DIV for HTML validation #}\n {% for item in result_hidden_fields %}{{ item }}{% endfor %}\n@@ -8,10 +10,18 @@\n <table id=\"result_list\">\n <thead>\n <tr>\n-{% for header in result_headers %}<th scope=\"col\"{{ header.class_attrib }}>\n-{% if header.sortable %}<a href=\"{{ header.url }}\">{% endif %}\n-{{ header.text|capfirst }}\n-{% if header.sortable %}</a>{% endif %}</th>{% endfor %}\n+{% for header in result_headers %}\n+<th scope=\"col\" {{ header.class_attrib }}>\n+  {% if header.sortable %}<a href=\"{{ header.url }}\">{% endif %}\n+  <span class=\"text\">{{ header.text|capfirst }}</span>\n+  {% if header.sortable %}\n+    {% if header.sort_pos > 0 %}<span class=\"sortpos\">\n+      {% if header.sort_pos == 1 %}<img id=\"primary-sort-icon\" src=\"{% admin_media_prefix %}img/admin/icon_cog.gif\" alt=\"\" />&nbsp;{% endif %}\n+      {{ header.sort_pos }}</span>\n+    {% endif %}\n+    <span class=\"clear\"></span></a>\n+  {% endif %}\n+</th>{% endfor %}\n </tr>\n </thead>\n <tbody>\n@@ -24,4 +34,53 @@\n </tbody>\n </table>\n </div>\n+\n+{# Sorting popup: #}\n+<div style=\"display: none;\" id=\"sorting-popup-div\">\n+<p>{% trans \"Sorting by:\" %}</p>\n+<ol>\n+{% for header in result_headers|dictsort:\"sort_pos\" %}\n+  {% if header.sort_pos > 0 %}\n+    {% if header.ascending %}\n+      <li>{% blocktrans with fieldname=header.text %}{{ fieldname }} (ascending){% endblocktrans %}</li>\n+    {% else %}\n+      <li>{% blocktrans with fieldname=header.text %}{{ fieldname }} (descending){% endblocktrans %}</li>\n+    {% endif %}\n+  {% endif %}\n+{% endfor %}\n+</ol>\n+<p><a href=\"{{ reset_sorting_url }}\">{% trans \"Reset sorting\" %}</a></p>\n+</div>\n+<script type=\"text/javascript\">\n+<!--\n+(function($) {\n+    $(document).ready(function() {\n+        var popup = $('#sorting-popup-div');\n+        /* These next lines seems necessary to prime the popup: */\n+        popup.offset({left:-1000, top:0});\n+        popup.show();\n+        var popupWidth = popup.width();\n+        popup.hide();\n+\n+        $('#primary-sort-icon').toggle(function(ev) {\n+                                          ev.preventDefault();\n+                                          var img = $(this);\n+                                          var pos = img.offset();\n+                                          pos.top += img.height();\n+                                          if (pos.left + popupWidth >\n+                                              $(window).width()) {\n+                                              pos.left -= popupWidth;\n+                                          }\n+                                          popup.show();\n+                                          popup.offset(pos);\n+                                      },\n+                                      function(ev) {\n+                                          ev.preventDefault();\n+                                          popup.hide();\n+                                      });\n+    });\n+})(django.jQuery);\n+//-->\n+</script>\n+\n {% endif %}"
        },
        {
            "sha": "884b45051a83110817f63d5e72a655d2fc936a8e",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 73,
            "deletions": 20,
            "changes": 93,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -7,6 +7,7 @@\n from django.core.exceptions import ObjectDoesNotExist\n from django.db import models\n from django.utils import formats\n+from django.utils.datastructures import SortedDict\n from django.utils.html import escape, conditional_escape\n from django.utils.safestring import mark_safe\n from django.utils.text import capfirst\n@@ -81,43 +82,90 @@ def result_headers(cl):\n     \"\"\"\n     Generates the list column headers.\n     \"\"\"\n-    lookup_opts = cl.lookup_opts\n-\n+    # We need to know the 'ordering field' that corresponds to each\n+    # item in list_display, and we need other info, so do a pre-pass\n+    # on list_display\n+    list_display_info = SortedDict()\n     for i, field_name in enumerate(cl.list_display):\n-        header, attr = label_for_field(field_name, cl.model,\n+        admin_order_field = None\n+        text, attr = label_for_field(field_name, cl.model,\n             model_admin = cl.model_admin,\n             return_attr = True\n         )\n         if attr:\n+            admin_order_field = getattr(attr, \"admin_order_field\", None)\n+        if admin_order_field is None:\n+            ordering_field_name = field_name\n+        else:\n+            ordering_field_name = admin_order_field\n+        list_display_info[ordering_field_name] = dict(text=text,\n+                                                      attr=attr,\n+                                                      index=i,\n+                                                      admin_order_field=admin_order_field,\n+                                                      field_name=field_name)\n+\n+    del admin_order_field, text, attr\n+\n+    ordering_fields = cl.get_ordering_fields()\n+\n+    for ordering_field_name, info in list_display_info.items():\n+        if info['attr']:\n+            # Potentially not sortable\n+\n             # if the field is the action checkbox: no sorting and special class\n-            if field_name == 'action_checkbox':\n+            if info['field_name'] == 'action_checkbox':\n                 yield {\n-                    \"text\": header,\n+                    \"text\": info['text'],\n                     \"class_attrib\": mark_safe(' class=\"action-checkbox-column\"')\n                 }\n                 continue\n \n-            # It is a non-field, but perhaps one that is sortable\n-            admin_order_field = getattr(attr, \"admin_order_field\", None)\n-            if not admin_order_field:\n-                yield {\"text\": header}\n+            if not info['admin_order_field']:\n+                # Not sortable\n+                yield {\"text\": info['text']}\n                 continue\n \n-            # So this _is_ a sortable non-field.  Go to the yield\n-            # after the else clause.\n-        else:\n-            admin_order_field = None\n-\n+        # OK, it is sortable if we got this far\n         th_classes = []\n+        order_type = ''\n         new_order_type = 'asc'\n-        if field_name == cl.order_field or admin_order_field == cl.order_field:\n-            th_classes.append('sorted %sending' % cl.order_type.lower())\n-            new_order_type = {'asc': 'desc', 'desc': 'asc'}[cl.order_type.lower()]\n+        sort_pos = 0\n+        # Is it currently being sorted on?\n+        if ordering_field_name in ordering_fields:\n+            order_type = ordering_fields.get(ordering_field_name).lower()\n+            sort_pos = ordering_fields.keys().index(ordering_field_name) + 1\n+            th_classes.append('sorted %sending' % order_type)\n+            new_order_type = {'asc': 'desc', 'desc': 'asc'}[order_type]\n+\n+        # build new ordering param\n+        o_list = []\n+        make_qs_param = lambda t, n: ('-' if t == 'desc' else '') + str(n)\n+\n+        for f, ot in ordering_fields.items():\n+            try:\n+                colnum = list_display_info[f]['index']\n+            except KeyError:\n+                continue\n+\n+            if f == ordering_field_name:\n+                # We want clicking on this header to bring the ordering to the\n+                # front\n+                o_list.insert(0, make_qs_param(new_order_type, colnum))\n+            else:\n+                o_list.append(make_qs_param(ot, colnum))\n+\n+        if ordering_field_name not in ordering_fields:\n+            colnum = list_display_info[ordering_field_name]['index']\n+            o_list.insert(0, make_qs_param(new_order_type, colnum))\n+\n+        o_list = '.'.join(o_list)\n \n         yield {\n-            \"text\": header,\n+            \"text\": info['text'],\n             \"sortable\": True,\n-            \"url\": cl.get_query_string({ORDER_VAR: i, ORDER_TYPE_VAR: new_order_type}),\n+            \"ascending\": order_type == \"asc\",\n+            \"sort_pos\": sort_pos,\n+            \"url\": cl.get_query_string({ORDER_VAR: o_list}),\n             \"class_attrib\": mark_safe(th_classes and ' class=\"%s\"' % ' '.join(th_classes) or '')\n         }\n \n@@ -228,9 +276,14 @@ def result_list(cl):\n     \"\"\"\n     Displays the headers and data list together\n     \"\"\"\n+    headers = list(result_headers(cl))\n+    for h in headers:\n+        # Sorting in templates depends on sort_pos attribute\n+        h.setdefault('sort_pos', 0)\n     return {'cl': cl,\n             'result_hidden_fields': list(result_hidden_fields(cl)),\n-            'result_headers': list(result_headers(cl)),\n+            'result_headers': headers,\n+            'reset_sorting_url': cl.get_query_string(remove=[ORDER_VAR]),\n             'results': list(results(cl))}\n \n @register.inclusion_tag('admin/date_hierarchy.html')"
        },
        {
            "sha": "1d48140fc57d495f0867b6df96efd4b674a3f8d0",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 48,
            "deletions": 33,
            "changes": 81,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -3,6 +3,7 @@\n from django.core.exceptions import SuspiciousOperation\n from django.core.paginator import InvalidPage\n from django.db import models\n+from django.utils.datastructures import SortedDict\n from django.utils.encoding import force_unicode, smart_str\n from django.utils.translation import ugettext, ugettext_lazy\n from django.utils.http import urlencode\n@@ -75,7 +76,7 @@ def __init__(self, request, model, list_display, list_display_links,\n             self.list_editable = ()\n         else:\n             self.list_editable = list_editable\n-        self.order_field, self.order_type = self.get_ordering()\n+        self.ordering = self.get_ordering()\n         self.query = request.GET.get(SEARCH_VAR, '')\n         self.query_set = self.get_query_set(request)\n         self.get_results(request)\n@@ -166,40 +167,54 @@ def get_results(self, request):\n     def get_ordering(self):\n         lookup_opts, params = self.lookup_opts, self.params\n         # For ordering, first check the \"ordering\" parameter in the admin\n-        # options, then check the object's default ordering. If neither of\n-        # those exist, order descending by ID by default. Finally, look for\n-        # manually-specified ordering from the query string.\n-        ordering = self.model_admin.ordering or lookup_opts.ordering or ['-' + lookup_opts.pk.name]\n+        # options, then check the object's default ordering. Finally, a\n+        # manually-specified ordering from the query string overrides anything.\n+        ordering = []\n+        if self.model_admin.ordering:\n+            ordering = self.model_admin.ordering\n+        elif lookup_opts.ordering:\n+            ordering = lookup_opts.ordering\n \n-        if ordering[0].startswith('-'):\n-            order_field, order_type = ordering[0][1:], 'desc'\n-        else:\n-            order_field, order_type = ordering[0], 'asc'\n         if ORDER_VAR in params:\n-            try:\n-                field_name = self.list_display[int(params[ORDER_VAR])]\n+            # Clear ordering and used params\n+            ordering = []\n+            order_params = params[ORDER_VAR].split('.')\n+            for p in order_params:\n                 try:\n-                    f = lookup_opts.get_field(field_name)\n-                except models.FieldDoesNotExist:\n-                    # See whether field_name is a name of a non-field\n-                    # that allows sorting.\n+                    none, pfx, idx = p.rpartition('-')\n+                    field_name = self.list_display[int(idx)]\n                     try:\n-                        if callable(field_name):\n-                            attr = field_name\n-                        elif hasattr(self.model_admin, field_name):\n-                            attr = getattr(self.model_admin, field_name)\n-                        else:\n-                            attr = getattr(self.model, field_name)\n-                        order_field = attr.admin_order_field\n-                    except AttributeError:\n-                        pass\n-                else:\n-                    order_field = f.name\n-            except (IndexError, ValueError):\n-                pass # Invalid ordering specified. Just use the default.\n-        if ORDER_TYPE_VAR in params and params[ORDER_TYPE_VAR] in ('asc', 'desc'):\n-            order_type = params[ORDER_TYPE_VAR]\n-        return order_field, order_type\n+                        f = lookup_opts.get_field(field_name)\n+                    except models.FieldDoesNotExist:\n+                        # See whether field_name is a name of a non-field\n+                        # that allows sorting.\n+                        try:\n+                            if callable(field_name):\n+                                attr = field_name\n+                            elif hasattr(self.model_admin, field_name):\n+                                attr = getattr(self.model_admin, field_name)\n+                            else:\n+                                attr = getattr(self.model, field_name)\n+                            field_name = attr.admin_order_field\n+                        except AttributeError:\n+                            continue # No 'admin_order_field', skip it\n+                    else:\n+                        field_name = f.name\n+\n+                    ordering.append(pfx + field_name)\n+\n+                except (IndexError, ValueError):\n+                    continue # Invalid ordering specified, skip it.\n+\n+        return ordering\n+\n+    def get_ordering_fields(self):\n+        # Returns a SortedDict of ordering fields and asc/desc\n+        ordering_fields = SortedDict()\n+        for o in self.ordering:\n+            none, t, f = o.rpartition('-')\n+            ordering_fields[f] = 'desc' if t == '-' else 'asc'\n+        return ordering_fields\n \n     def get_lookup_params(self, use_distinct=False):\n         lookup_params = self.params.copy() # a dictionary of the query string\n@@ -290,8 +305,8 @@ def get_query_set(self, request):\n                             break\n \n         # Set ordering.\n-        if self.order_field:\n-            qs = qs.order_by('%s%s' % ((self.order_type == 'desc' and '-' or ''), self.order_field))\n+        if self.ordering:\n+            qs = qs.order_by(*self.ordering)\n \n         # Apply keyword searches.\n         def construct_search(field_name):"
        },
        {
            "sha": "3ba3b1b0eb0ceefd7127534463049b6f33585e4e",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -696,10 +696,10 @@ subclass::\n     If this isn't provided, the Django admin will use the model's default\n     ordering.\n \n-    .. admonition:: Note\n+    .. versionchanged:: 1.4\n \n-        Django will only honor the first element in the list/tuple; any others\n-        will be ignored.\n+    Django honors all elements in the list/tuple; before 1.4, only the first\n+    was respected.\n \n .. attribute:: ModelAdmin.paginator\n "
        },
        {
            "sha": "d0c02b00362fcd9eca6f5ac234753d04e8105ae7",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -46,6 +46,14 @@ not custom filters. This has been rectified with a simple API previously\n known as \"FilterSpec\" which was used internally. For more details, see the\n documentation for :attr:`~django.contrib.admin.ModelAdmin.list_filter`.\n \n+Multiple sort in admin interface\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+The admin change list now supports sorting on multiple columns. It respects all\n+elements of the :attr:`~django.contrib.admin.ModelAdmin.ordering` attribute, and\n+sorting on multiple columns by clicking on headers is designed to work similarly\n+to how desktop GUIs do it.\n+\n Tools for cryptographic signing\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "5095abbb9f9678ba34df3afe7cc0801d74febf8c",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -67,11 +67,11 @@ class CustomUserAdmin(UserAdmin):\n \n class BookAdmin(ModelAdmin):\n     list_filter = ('year', 'author', 'contributors', 'is_best_seller', 'date_registered', 'no')\n-    order_by = '-id'\n+    ordering = ('-id',)\n \n class DecadeFilterBookAdmin(ModelAdmin):\n     list_filter = ('author', DecadeListFilterWithTitleAndParameter)\n-    order_by = '-id'\n+    ordering = ('-id',)\n \n class DecadeFilterBookAdminWithoutTitle(ModelAdmin):\n     list_filter = (DecadeListFilterWithoutTitle,)"
        },
        {
            "sha": "98873966eb4f202f25d6d91f91df6ec9caf14a28",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -243,9 +243,6 @@ class Person(models.Model):\n     def __unicode__(self):\n         return self.name\n \n-    class Meta:\n-        ordering = [\"id\"]\n-\n class BasePersonModelFormSet(BaseModelFormSet):\n     def clean(self):\n         for person_dict in self.cleaned_data:\n@@ -259,13 +256,17 @@ class PersonAdmin(admin.ModelAdmin):\n     list_editable = ('gender', 'alive')\n     list_filter = ('gender',)\n     search_fields = ('^name',)\n-    ordering = [\"id\"]\n     save_as = True\n \n     def get_changelist_formset(self, request, **kwargs):\n         return super(PersonAdmin, self).get_changelist_formset(request,\n             formset=BasePersonModelFormSet, **kwargs)\n \n+    def queryset(self, request):\n+        # Order by a field that isn't in list display, to be able to test\n+        # whether ordering is preserved.\n+        return super(PersonAdmin, self).queryset(request).order_by('age')\n+\n \n class Persona(models.Model):\n     \"\"\"\n@@ -357,6 +358,9 @@ class Media(models.Model):\n class Podcast(Media):\n     release_date = models.DateField()\n \n+    class Meta:\n+        ordering = ('release_date',) # overridden in PodcastAdmin\n+\n class PodcastAdmin(admin.ModelAdmin):\n     list_display = ('name', 'release_date')\n     list_editable = ('release_date',)\n@@ -795,6 +799,7 @@ class StoryAdmin(admin.ModelAdmin):\n     list_display_links = ('title',) # 'id' not in list_display_links\n     list_editable = ('content', )\n     form = StoryForm\n+    ordering = [\"-pk\"]\n \n class OtherStory(models.Model):\n     title = models.CharField(max_length=100)\n@@ -804,6 +809,7 @@ class OtherStoryAdmin(admin.ModelAdmin):\n     list_display = ('id', 'title', 'content')\n     list_display_links = ('title', 'id') # 'id' in list_display_links\n     list_editable = ('content', )\n+    ordering = [\"-pk\"]\n \n admin.site.register(Article, ArticleAdmin)\n admin.site.register(CustomArticle, CustomArticleAdmin)"
        },
        {
            "sha": "4361dc992e1421b3ec0d4013dc68823c817dc2b4",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 80,
            "deletions": 5,
            "changes": 85,
            "blob_url": "https://github.com/django/django/blob/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/5434ce231d75004bdbe5cf2b7b24ce67a2a6e737/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=5434ce231d75004bdbe5cf2b7b24ce67a2a6e737",
            "patch": "@@ -32,7 +32,7 @@\n \n # local test models\n from models import (Article, BarAccount, CustomArticle, EmptyModel,\n-    FooAccount, Gallery, GalleryAdmin, ModelWithStringPrimaryKey,\n+    FooAccount, Gallery, PersonAdmin, ModelWithStringPrimaryKey,\n     Person, Persona, Picture, Podcast, Section, Subscriber, Vodcast,\n     Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit,\n     Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee,\n@@ -204,7 +204,7 @@ def testChangeListSortingCallable(self):\n         Ensure we can sort on a list_display field that is a callable\n         (column 2 is callable_year in ArticleAdmin)\n         \"\"\"\n-        response = self.client.get('/test_admin/%s/admin_views/article/' % self.urlbit, {'ot': 'asc', 'o': 2})\n+        response = self.client.get('/test_admin/%s/admin_views/article/' % self.urlbit, {'o': 2})\n         self.assertEqual(response.status_code, 200)\n         self.assertTrue(\n             response.content.index('Oldest content') < response.content.index('Middle content') and\n@@ -217,7 +217,7 @@ def testChangeListSortingModel(self):\n         Ensure we can sort on a list_display field that is a Model method\n         (colunn 3 is 'model_year' in ArticleAdmin)\n         \"\"\"\n-        response = self.client.get('/test_admin/%s/admin_views/article/' % self.urlbit, {'ot': 'dsc', 'o': 3})\n+        response = self.client.get('/test_admin/%s/admin_views/article/' % self.urlbit, {'o': '-3'})\n         self.assertEqual(response.status_code, 200)\n         self.assertTrue(\n             response.content.index('Newest content') < response.content.index('Middle content') and\n@@ -230,14 +230,89 @@ def testChangeListSortingModelAdmin(self):\n         Ensure we can sort on a list_display field that is a ModelAdmin method\n         (colunn 4 is 'modeladmin_year' in ArticleAdmin)\n         \"\"\"\n-        response = self.client.get('/test_admin/%s/admin_views/article/' % self.urlbit, {'ot': 'asc', 'o': 4})\n+        response = self.client.get('/test_admin/%s/admin_views/article/' % self.urlbit, {'o': '4'})\n         self.assertEqual(response.status_code, 200)\n         self.assertTrue(\n             response.content.index('Oldest content') < response.content.index('Middle content') and\n             response.content.index('Middle content') < response.content.index('Newest content'),\n             \"Results of sorting on ModelAdmin method are out of order.\"\n         )\n \n+    def testChangeListSortingMultiple(self):\n+        p1 = Person.objects.create(name=\"Chris\", gender=1, alive=True)\n+        p2 = Person.objects.create(name=\"Chris\", gender=2, alive=True)\n+        p3 = Person.objects.create(name=\"Bob\", gender=1, alive=True)\n+        link = '<a href=\"%s/'\n+\n+        # Sort by name, gender\n+        # This hard-codes the URL because it'll fail if it runs against the\n+        # 'admin2' custom admin (which doesn't have the Person model).\n+        response = self.client.get('/test_admin/admin/admin_views/person/', {'o': '1.2'})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % p3.id) < response.content.index(link % p1.id) and\n+            response.content.index(link % p1.id) < response.content.index(link % p2.id)\n+        )\n+\n+        # Sort by gender descending, name\n+        response = self.client.get('/test_admin/admin/admin_views/person/', {'o': '-2.1'})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % p2.id) < response.content.index(link % p3.id) and\n+            response.content.index(link % p3.id) < response.content.index(link % p1.id)\n+        )\n+\n+    def testChangeListSortingPreserveQuerySetOrdering(self):\n+        # If no ordering on ModelAdmin, or query string, the underlying order of\n+        # the queryset should not be changed.\n+\n+        p1 = Person.objects.create(name=\"Amy\", gender=1, alive=True, age=80)\n+        p2 = Person.objects.create(name=\"Bob\", gender=1, alive=True, age=70)\n+        p3 = Person.objects.create(name=\"Chris\", gender=2, alive=False, age=60)\n+        link = '<a href=\"%s/'\n+\n+        # This hard-codes the URL because it'll fail if it runs against the\n+        # 'admin2' custom admin (which doesn't have the Person model).\n+        response = self.client.get('/test_admin/admin/admin_views/person/', {})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % p3.id) < response.content.index(link % p2.id) and\n+            response.content.index(link % p2.id) < response.content.index(link % p1.id)\n+        )\n+\n+    def testChangeListSortingModelMeta(self):\n+        # Test ordering on Model Meta is respected\n+\n+        l1 = Language.objects.create(iso='ur', name='Urdu')\n+        l2 = Language.objects.create(iso='ar', name='Arabic')\n+        link = '<a href=\"%s/'\n+\n+        response = self.client.get('/test_admin/admin/admin_views/language/', {})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % l2.pk) < response.content.index(link % l1.pk)\n+        )\n+\n+        # Test we can override with query string\n+        response = self.client.get('/test_admin/admin/admin_views/language/', {'o':'-1'})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % l1.pk) < response.content.index(link % l2.pk)\n+        )\n+\n+    def testChangeListSortingModelAdmin(self):\n+        # Test ordering on Model Admin is respected, and overrides Model Meta\n+        dt = datetime.datetime.now()\n+        p1 = Podcast.objects.create(name=\"A\", release_date=dt)\n+        p2 = Podcast.objects.create(name=\"B\", release_date=dt - datetime.timedelta(10))\n+\n+        link = '<a href=\"%s/'\n+        response = self.client.get('/test_admin/admin/admin_views/podcast/', {})\n+        self.assertEqual(response.status_code, 200)\n+        self.assertTrue(\n+            response.content.index(link % p1.pk) < response.content.index(link % p2.pk)\n+        )\n+\n     def testLimitedFilter(self):\n         \"\"\"Ensure admin changelist filters do not contain objects excluded via limit_choices_to.\n         This also tests relation-spanning filters (e.g. 'color__value').\n@@ -1956,7 +2031,7 @@ def test_default_redirect(self):\n             'action' : 'external_mail',\n             'index': 0,\n         }\n-        url = '/test_admin/admin/admin_views/externalsubscriber/?ot=asc&o=1'\n+        url = '/test_admin/admin/admin_views/externalsubscriber/?o=1'\n         response = self.client.post(url, action_data)\n         self.assertRedirects(response, url)\n "
        }
    ],
    "stats": {
        "total": 394,
        "additions": 323,
        "deletions": 71
    }
}