{
    "author": "spookylukey",
    "message": "Fixed #15354 - provide method to ensure CSRF token is always available for AJAX requests\n\nThanks to sayane for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16192 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264",
    "files": [
        {
            "sha": "9b92d26e95a8ab2455a1adfbadccfc3d8c7d184f",
            "filename": "django/views/decorators/csrf.py",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264/django%2Fviews%2Fdecorators%2Fcsrf.py",
            "raw_url": "https://github.com/django/django/raw/b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264/django%2Fviews%2Fdecorators%2Fcsrf.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdecorators%2Fcsrf.py?ref=b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264",
            "patch": "@@ -1,6 +1,6 @@\n import warnings\n \n-from django.middleware.csrf import CsrfViewMiddleware\n+from django.middleware.csrf import CsrfViewMiddleware, get_token\n from django.utils.decorators import decorator_from_middleware, available_attrs\n from functools import wraps\n \n@@ -28,6 +28,26 @@ def _reject(self, request, reason):\n enforces.\n \"\"\"\n \n+\n+class _EnsureCsrfCookie(CsrfViewMiddleware):\n+    def _reject(self, request, reason):\n+        return None\n+\n+    def process_view(self, request, callback, callback_args, callback_kwargs):\n+        retval = super(_EnsureCsrfCookie, self).process_view(request, callback, callback_args, callback_kwargs)\n+        # Forces process_response to send the cookie\n+        get_token(request)\n+        return retval\n+\n+\n+ensure_csrf_cookie = decorator_from_middleware(_EnsureCsrfCookie)\n+ensure_csrf_cookie.__name__ = 'ensure_csrf_cookie'\n+ensure_csrf_cookie.__doc__ = \"\"\"\n+Use this decorator to ensure that a view sets a CSRF cookie, whether or not it\n+uses the csrf_token template tag, or the CsrfViewMiddleware is used.\n+\"\"\"\n+\n+\n def csrf_response_exempt(view_func):\n     \"\"\"\n     Modifies a view function so that its response is exempt"
        },
        {
            "sha": "7ff7d53aa0b5255699defda5c030d8965fd6a4c0",
            "filename": "docs/ref/contrib/csrf.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264/docs%2Fref%2Fcontrib%2Fcsrf.txt",
            "raw_url": "https://github.com/django/django/raw/b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264/docs%2Fref%2Fcontrib%2Fcsrf.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fcsrf.txt?ref=b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264",
            "patch": "@@ -132,6 +132,10 @@ The above code could be simplified by using the `jQuery cookie plugin\n `settings.crossDomain <http://api.jquery.com/jQuery.ajax>`_ in jQuery 1.5 and\n later to replace ``sameOrigin``.\n \n+In addition, if the CSRF cookie has not been sent to the client by use of\n+:ttag:`csrf_token`, you may need to ensure the client receives the cookie by\n+using :func:`~django.views.decorators.csrf.ensure_csrf_cookie`.\n+\n The decorator method\n --------------------\n \n@@ -328,6 +332,10 @@ Utilities\n             # ...\n             return render(request, \"a_template.html\", c)\n \n+.. function:: ensure_csrf_cookie(view)\n+\n+    This decorator forces a view to send the CSRF cookie.\n+\n Scenarios\n ---------\n \n@@ -381,6 +389,15 @@ path within it that needs protection. Example::\n         else:\n            do_something_else()\n \n+Page uses AJAX without any HTML form\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+A page makes a POST request via AJAX, and the page does not have an HTML form\n+with a :ttag:`csrf_token` that would cause the required CSRF cookie to be sent.\n+\n+Solution: use :func:`~django.views.decorators.csrf.ensure_csrf_cookie` on the\n+view that sends the page.\n+\n Contrib and reusable apps\n =========================\n "
        },
        {
            "sha": "1285c1ddacea739a76e7eba8df6fd754c279ce5c",
            "filename": "tests/regressiontests/csrf_tests/tests.py",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcsrf_tests%2Ftests.py?ref=b6c5f8060d45a7cffe42928a4b67b6a4e2ba9264",
            "patch": "@@ -4,7 +4,7 @@\n from django.test import TestCase\n from django.http import HttpRequest, HttpResponse\n from django.middleware.csrf import CsrfViewMiddleware\n-from django.views.decorators.csrf import csrf_exempt, requires_csrf_token\n+from django.views.decorators.csrf import csrf_exempt, requires_csrf_token, ensure_csrf_cookie\n from django.core.context_processors import csrf\n from django.conf import settings\n from django.template import RequestContext, Template\n@@ -249,3 +249,35 @@ def test_https_good_referer_2(self):\n         req.META['HTTP_REFERER'] = 'https://www.example.com'\n         req2 = CsrfViewMiddleware().process_view(req, post_form_view, (), {})\n         self.assertEqual(None, req2)\n+\n+    def test_ensures_csrf_cookie_no_middleware(self):\n+        \"\"\"\n+        Tests that ensures_csrf_cookie decorator fulfils its promise\n+        with no middleware\n+        \"\"\"\n+        @ensure_csrf_cookie\n+        def view(request):\n+            # Doesn't insert a token or anything\n+            return HttpResponse(content=\"\")\n+\n+        req = self._get_GET_no_csrf_cookie_request()\n+        resp = view(req)\n+        self.assertTrue(resp.cookies.get(settings.CSRF_COOKIE_NAME, False))\n+        self.assertTrue('Cookie' in resp.get('Vary',''))\n+\n+    def test_ensures_csrf_cookie_with_middleware(self):\n+        \"\"\"\n+        Tests that ensures_csrf_cookie decorator fulfils its promise\n+        with the middleware enabled.\n+        \"\"\"\n+        @ensure_csrf_cookie\n+        def view(request):\n+            # Doesn't insert a token or anything\n+            return HttpResponse(content=\"\")\n+\n+        req = self._get_GET_no_csrf_cookie_request()\n+        CsrfViewMiddleware().process_view(req, view, (), {})\n+        resp = view(req)\n+        resp2 = CsrfViewMiddleware().process_response(req, resp)\n+        self.assertTrue(resp2.cookies.get(settings.CSRF_COOKIE_NAME, False))\n+        self.assertTrue('Cookie' in resp2.get('Vary',''))"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 71,
        "deletions": 2
    }
}