{
    "author": "claudep",
    "message": "Fixed #19997 -- Added custom EMPTY_VALUES to form fields\n\nThanks Loic Bistuer for the report and the patch.",
    "sha": "4cccb85e292fea01b3459cd97d751ed35179a7b7",
    "files": [
        {
            "sha": "c6d7bf0414d5629840f928a37c891c95859e64f2",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/4cccb85e292fea01b3459cd97d751ed35179a7b7/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/4cccb85e292fea01b3459cd97d751ed35179a7b7/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=4cccb85e292fea01b3459cd97d751ed35179a7b7",
            "patch": "@@ -98,6 +98,7 @@ answer newbie questions, and generally made Django that much better:\n     Natalia Bidart <nataliabidart@gmail.com>\n     Mark Biggers <biggers@utsl.com>\n     Paul Bissex <http://e-scribe.com/>\n+    Loic Bistuer <loic.bistuer@sixmedia.com>\n     Simon Blanchard\n     Craig Blaszczyk <masterjakul@gmail.com>\n     David Blewett <david@dawninglight.net>"
        },
        {
            "sha": "bc3770150aeb8b4a1927b84dc68a180d5411f8e6",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 23,
            "deletions": 22,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/4cccb85e292fea01b3459cd97d751ed35179a7b7/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/4cccb85e292fea01b3459cd97d751ed35179a7b7/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=4cccb85e292fea01b3459cd97d751ed35179a7b7",
            "patch": "@@ -53,6 +53,7 @@ class Field(object):\n         'required': _('This field is required.'),\n         'invalid': _('Enter a valid value.'),\n     }\n+    empty_values = list(validators.EMPTY_VALUES)\n \n     # Tracks each time a Field instance is created. Used to retain order.\n     creation_counter = 0\n@@ -125,11 +126,11 @@ def to_python(self, value):\n         return value\n \n     def validate(self, value):\n-        if value in validators.EMPTY_VALUES and self.required:\n+        if value in self.empty_values and self.required:\n             raise ValidationError(self.error_messages['required'])\n \n     def run_validators(self, value):\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return\n         errors = []\n         for v in self.validators:\n@@ -210,7 +211,7 @@ def __init__(self, max_length=None, min_length=None, *args, **kwargs):\n \n     def to_python(self, value):\n         \"Returns a Unicode object.\"\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return ''\n         return smart_text(value)\n \n@@ -244,7 +245,7 @@ def to_python(self, value):\n         of int(). Returns None for empty values.\n         \"\"\"\n         value = super(IntegerField, self).to_python(value)\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         if self.localize:\n             value = formats.sanitize_separators(value)\n@@ -275,7 +276,7 @@ def to_python(self, value):\n         of float(). Returns None for empty values.\n         \"\"\"\n         value = super(IntegerField, self).to_python(value)\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         if self.localize:\n             value = formats.sanitize_separators(value)\n@@ -311,7 +312,7 @@ def to_python(self, value):\n         than max_digits in the number, and no more than decimal_places digits\n         after the decimal point.\n         \"\"\"\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         if self.localize:\n             value = formats.sanitize_separators(value)\n@@ -324,7 +325,7 @@ def to_python(self, value):\n \n     def validate(self, value):\n         super(DecimalField, self).validate(value)\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return\n         # Check for NaN, Inf and -Inf values. We can't compare directly for NaN,\n         # since it is never equal to itself. However, NaN is the only value that\n@@ -401,7 +402,7 @@ def to_python(self, value):\n         Validates that the input can be converted to a date. Returns a Python\n         datetime.date object.\n         \"\"\"\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         if isinstance(value, datetime.datetime):\n             return value.date()\n@@ -425,7 +426,7 @@ def to_python(self, value):\n         Validates that the input can be converted to a time. Returns a Python\n         datetime.time object.\n         \"\"\"\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         if isinstance(value, datetime.time):\n             return value\n@@ -451,7 +452,7 @@ def to_python(self, value):\n         Validates that the input can be converted to a datetime. Returns a\n         Python datetime.datetime object.\n         \"\"\"\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         if isinstance(value, datetime.datetime):\n             return from_current_timezone(value)\n@@ -463,7 +464,7 @@ def to_python(self, value):\n             # components: date and time.\n             if len(value) != 2:\n                 raise ValidationError(self.error_messages['invalid'])\n-            if value[0] in validators.EMPTY_VALUES and value[1] in validators.EMPTY_VALUES:\n+            if value[0] in self.empty_values and value[1] in self.empty_values:\n                 return None\n             value = '%s %s' % tuple(value)\n         result = super(DateTimeField, self).to_python(value)\n@@ -531,7 +532,7 @@ def __init__(self, *args, **kwargs):\n         super(FileField, self).__init__(*args, **kwargs)\n \n     def to_python(self, data):\n-        if data in validators.EMPTY_VALUES:\n+        if data in self.empty_values:\n             return None\n \n         # UploadedFile objects should have name and size attributes.\n@@ -562,7 +563,7 @@ def clean(self, data, initial=None):\n                 return False\n             # If the field is required, clearing is not possible (the widget\n             # shouldn't return False data in that case anyway). False is not\n-            # in validators.EMPTY_VALUES; if a False value makes it this far\n+            # in self.empty_value; if a False value makes it this far\n             # it should be validated from here on out as None (so it will be\n             # caught by the required check).\n             data = None\n@@ -763,7 +764,7 @@ def _set_choices(self, value):\n \n     def to_python(self, value):\n         \"Returns a Unicode object.\"\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return ''\n         return smart_text(value)\n \n@@ -801,7 +802,7 @@ def to_python(self, value):\n         \"\"\"\n         value = super(TypedChoiceField, self).to_python(value)\n         super(TypedChoiceField, self).validate(value)\n-        if value == self.empty_value or value in validators.EMPTY_VALUES:\n+        if value == self.empty_value or value in self.empty_values:\n             return self.empty_value\n         try:\n             value = self.coerce(value)\n@@ -864,7 +865,7 @@ def to_python(self, value):\n         \"\"\"\n         value = super(TypedMultipleChoiceField, self).to_python(value)\n         super(TypedMultipleChoiceField, self).validate(value)\n-        if value == self.empty_value or value in validators.EMPTY_VALUES:\n+        if value == self.empty_value or value in self.empty_values:\n             return self.empty_value\n         new_value = []\n         for choice in value:\n@@ -945,7 +946,7 @@ def clean(self, value):\n         clean_data = []\n         errors = ErrorList()\n         if not value or isinstance(value, (list, tuple)):\n-            if not value or not [v for v in value if v not in validators.EMPTY_VALUES]:\n+            if not value or not [v for v in value if v not in self.empty_values]:\n                 if self.required:\n                     raise ValidationError(self.error_messages['required'])\n                 else:\n@@ -957,7 +958,7 @@ def clean(self, value):\n                 field_value = value[i]\n             except IndexError:\n                 field_value = None\n-            if self.required and field_value in validators.EMPTY_VALUES:\n+            if self.required and field_value in self.empty_values:\n                 raise ValidationError(self.error_messages['required'])\n             try:\n                 clean_data.append(field.clean(field_value))\n@@ -1071,9 +1072,9 @@ def compress(self, data_list):\n         if data_list:\n             # Raise a validation error if time or date is empty\n             # (possible if SplitDateTimeField has required=False).\n-            if data_list[0] in validators.EMPTY_VALUES:\n+            if data_list[0] in self.empty_values:\n                 raise ValidationError(self.error_messages['invalid_date'])\n-            if data_list[1] in validators.EMPTY_VALUES:\n+            if data_list[1] in self.empty_values:\n                 raise ValidationError(self.error_messages['invalid_time'])\n             result = datetime.datetime.combine(*data_list)\n             return from_current_timezone(result)\n@@ -1087,7 +1088,7 @@ class IPAddressField(CharField):\n     default_validators = [validators.validate_ipv4_address]\n \n     def to_python(self, value):\n-        if value in EMPTY_VALUES:\n+        if value in self.empty_values:\n             return ''\n         return value.strip()\n \n@@ -1103,7 +1104,7 @@ def __init__(self, protocol='both', unpack_ipv4=False, *args, **kwargs):\n         super(GenericIPAddressField, self).__init__(*args, **kwargs)\n \n     def to_python(self, value):\n-        if value in validators.EMPTY_VALUES:\n+        if value in self.empty_values:\n             return ''\n         value = value.strip()\n         if value and ':' in value:"
        },
        {
            "sha": "7609bb7227e1d0a57d500922687da5bb77976cc4",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/4cccb85e292fea01b3459cd97d751ed35179a7b7/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/4cccb85e292fea01b3459cd97d751ed35179a7b7/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=4cccb85e292fea01b3459cd97d751ed35179a7b7",
            "patch": "@@ -6,7 +6,6 @@\n from __future__ import absolute_import, unicode_literals\n \n from django.core.exceptions import ValidationError, NON_FIELD_ERRORS, FieldError\n-from django.core.validators import EMPTY_VALUES\n from django.forms.fields import Field, ChoiceField\n from django.forms.forms import BaseForm, get_declared_fields\n from django.forms.formsets import BaseFormSet, formset_factory\n@@ -301,7 +300,7 @@ def _get_validation_exclusions(self):\n             else:\n                 form_field = self.fields[field]\n                 field_value = self.cleaned_data.get(field, None)\n-                if not f.blank and not form_field.required and field_value in EMPTY_VALUES:\n+                if not f.blank and not form_field.required and field_value in form_field.empty_values:\n                     exclude.append(f.name)\n         return exclude\n \n@@ -880,7 +879,7 @@ def __init__(self, parent_instance, *args, **kwargs):\n         super(InlineForeignKeyField, self).__init__(*args, **kwargs)\n \n     def clean(self, value):\n-        if value in EMPTY_VALUES:\n+        if value in self.empty_values:\n             if self.pk_field:\n                 return None\n             # if there is no value act as we did before.\n@@ -1000,7 +999,7 @@ def prepare_value(self, value):\n         return super(ModelChoiceField, self).prepare_value(value)\n \n     def to_python(self, value):\n-        if value in EMPTY_VALUES:\n+        if value in self.empty_values:\n             return None\n         try:\n             key = self.to_field_name or 'pk'"
        },
        {
            "sha": "44ddb624d6a05a7ca89ad09f04c61da25255970c",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/4cccb85e292fea01b3459cd97d751ed35179a7b7/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/4cccb85e292fea01b3459cd97d751ed35179a7b7/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=4cccb85e292fea01b3459cd97d751ed35179a7b7",
            "patch": "@@ -27,7 +27,6 @@\n from django.core.servers.basehttp import (WSGIRequestHandler, WSGIServer,\n     WSGIServerException)\n from django.core.urlresolvers import clear_url_caches\n-from django.core.validators import EMPTY_VALUES\n from django.db import connection, connections, DEFAULT_DB_ALIAS, transaction\n from django.forms.fields import CharField\n from django.http import QueryDict\n@@ -322,7 +321,7 @@ def assertFieldOutput(self, fieldclass, valid, invalid, field_args=None,\n                     raised error messages.\n             field_args: the args passed to instantiate the field\n             field_kwargs: the kwargs passed to instantiate the field\n-            empty_value: the expected clean output for inputs in EMPTY_VALUES\n+            empty_value: the expected clean output for inputs in empty_values\n \n         \"\"\"\n         if field_args is None:\n@@ -347,7 +346,7 @@ def assertFieldOutput(self, fieldclass, valid, invalid, field_args=None,\n             self.assertEqual(context_manager.exception.messages, errors)\n         # test required inputs\n         error_required = [force_text(required.error_messages['required'])]\n-        for e in EMPTY_VALUES:\n+        for e in required.empty_values:\n             with self.assertRaises(ValidationError) as context_manager:\n                 required.clean(e)\n             self.assertEqual(context_manager.exception.messages,"
        },
        {
            "sha": "b917086e0603706f0cd079ca2ddc4a4fca87bcea",
            "filename": "docs/topics/testing/overview.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/4cccb85e292fea01b3459cd97d751ed35179a7b7/docs%2Ftopics%2Ftesting%2Foverview.txt",
            "raw_url": "https://github.com/django/django/raw/4cccb85e292fea01b3459cd97d751ed35179a7b7/docs%2Ftopics%2Ftesting%2Foverview.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting%2Foverview.txt?ref=4cccb85e292fea01b3459cd97d751ed35179a7b7",
            "patch": "@@ -1480,7 +1480,7 @@ your test suite.\n         error messages.\n     :param field_args: the args passed to instantiate the field.\n     :param field_kwargs: the kwargs passed to instantiate the field.\n-    :param empty_value: the expected clean output for inputs in ``EMPTY_VALUES``.\n+    :param empty_value: the expected clean output for inputs in ``empty_values``.\n \n     For example, the following code tests that an ``EmailField`` accepts\n     \"a@a.com\" as a valid email address, but rejects \"aaa\" with a reasonable"
        },
        {
            "sha": "9cf217b86b7249a8b2cd36a87298516aa2acf12c",
            "filename": "tests/forms_tests/tests/forms.py",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/4cccb85e292fea01b3459cd97d751ed35179a7b7/tests%2Fforms_tests%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/4cccb85e292fea01b3459cd97d751ed35179a7b7/tests%2Fforms_tests%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fforms_tests%2Ftests%2Fforms.py?ref=4cccb85e292fea01b3459cd97d751ed35179a7b7",
            "patch": "@@ -1797,3 +1797,23 @@ class NameForm(Form):\n         form = NameForm(data={'name' : ['fname', 'lname']})\n         self.assertTrue(form.is_valid())\n         self.assertEqual(form.cleaned_data, {'name' : 'fname lname'})\n+\n+    def test_custom_empty_values(self):\n+        \"\"\"\n+        Test that form fields can customize what is considered as an empty value\n+        for themselves (#19997).\n+        \"\"\"\n+        class CustomJSONField(CharField):\n+            empty_values = [None, '']\n+            def to_python(self, value):\n+                # Fake json.loads\n+                if value == '{}':\n+                    return {}\n+                return super(CustomJSONField, self).to_python(value)\n+\n+        class JSONForm(forms.Form):\n+            json = CustomJSONField()\n+\n+        form = JSONForm(data={'json': '{}'});\n+        form.full_clean()\n+        self.assertEqual(form.cleaned_data, {'json' : {}})"
        }
    ],
    "stats": {
        "total": 80,
        "additions": 50,
        "deletions": 30
    }
}