{
    "author": "claudep",
    "message": "Fixed #18479 -- Stopped makemessages raising error on gettext warnings\n\nThanks Niels Busch for the initial patch.",
    "sha": "c54905b3597545dbe1a6d8cd0a60186bccf8b3e7",
    "files": [
        {
            "sha": "d8e8f6cff7a62c2e4b185df1937d700100c5928a",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 42,
            "deletions": 24,
            "changes": 66,
            "blob_url": "https://github.com/django/django/blob/c54905b3597545dbe1a6d8cd0a60186bccf8b3e7/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/c54905b3597545dbe1a6d8cd0a60186bccf8b3e7/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=c54905b3597545dbe1a6d8cd0a60186bccf8b3e7",
            "patch": "@@ -13,6 +13,7 @@\n from django.utils.jslex import prepare_js_for_gettext\n \n plural_forms_re = re.compile(r'^(?P<value>\"Plural-Forms.+?\\\\n\")\\s*$', re.MULTILINE | re.DOTALL)\n+STATUS_OK = 0\n \n def handle_extensions(extensions=('html',), ignored=('py',)):\n     \"\"\"\n@@ -43,7 +44,8 @@ def _popen(cmd):\n     Friendly wrapper around Popen for Windows\n     \"\"\"\n     p = Popen(cmd, shell=True, stdout=PIPE, stderr=PIPE, close_fds=os.name != 'nt', universal_newlines=True)\n-    return p.communicate()\n+    output, errors = p.communicate()\n+    return output, errors, p.returncode\n \n def walk(root, topdown=True, onerror=None, followlinks=False,\n          ignore_patterns=None, verbosity=0, stdout=sys.stdout):\n@@ -198,15 +200,19 @@ def process_file(file, dirpath, potfile, domain, verbosity,\n             (domain, wrap, location, work_file))\n     else:\n         return\n-    msgs, errors = _popen(cmd)\n+    msgs, errors, status = _popen(cmd)\n     if errors:\n-        if is_templatized:\n-            os.unlink(work_file)\n-        if os.path.exists(potfile):\n-            os.unlink(potfile)\n-        raise CommandError(\n-            \"errors happened while running xgettext on %s\\n%s\" %\n-            (file, errors))\n+        if status != STATUS_OK:\n+            if is_templatized:\n+                os.unlink(work_file)\n+            if os.path.exists(potfile):\n+                os.unlink(potfile)\n+            raise CommandError(\n+                \"errors happened while running xgettext on %s\\n%s\" %\n+                (file, errors))\n+        elif verbosity > 0:\n+            # Print warnings\n+            stdout.write(errors)\n     if msgs:\n         write_pot_file(potfile, msgs, orig_file, work_file, is_templatized)\n     if is_templatized:\n@@ -220,20 +226,28 @@ def write_po_file(pofile, potfile, domain, locale, verbosity, stdout,\n \n     Uses mguniq, msgmerge, and msgattrib GNU gettext utilities.\n     \"\"\"\n-    msgs, errors = _popen('msguniq %s %s --to-code=utf-8 \"%s\"' %\n-                            (wrap, location, potfile))\n+    msgs, errors, status = _popen('msguniq %s %s --to-code=utf-8 \"%s\"' %\n+                                    (wrap, location, potfile))\n     if errors:\n-        os.unlink(potfile)\n-        raise CommandError(\"errors happened while running msguniq\\n%s\" % errors)\n+        if status != STATUS_OK:\n+            os.unlink(potfile)\n+            raise CommandError(\n+                \"errors happened while running msguniq\\n%s\" % errors)\n+        elif verbosity > 0:\n+            stdout.write(errors)\n+\n     if os.path.exists(pofile):\n         with open(potfile, 'w') as fp:\n             fp.write(msgs)\n-        msgs, errors = _popen('msgmerge %s %s -q \"%s\" \"%s\"' %\n-                                (wrap, location, pofile, potfile))\n+        msgs, errors, status = _popen('msgmerge %s %s -q \"%s\" \"%s\"' %\n+                                        (wrap, location, pofile, potfile))\n         if errors:\n-            os.unlink(potfile)\n-            raise CommandError(\n-                \"errors happened while running msgmerge\\n%s\" % errors)\n+            if status != STATUS_OK:\n+                os.unlink(potfile)\n+                raise CommandError(\n+                    \"errors happened while running msgmerge\\n%s\" % errors)\n+            elif verbosity > 0:\n+                stdout.write(errors)\n     elif copy_pforms:\n         msgs = copy_plural_forms(msgs, locale, domain, verbosity, stdout)\n     msgs = msgs.replace(\n@@ -242,11 +256,15 @@ def write_po_file(pofile, potfile, domain, locale, verbosity, stdout,\n         fp.write(msgs)\n     os.unlink(potfile)\n     if no_obsolete:\n-        msgs, errors = _popen('msgattrib %s %s -o \"%s\" --no-obsolete \"%s\"' %\n-                                (wrap, location, pofile, pofile))\n+        msgs, errors, status = _popen(\n+            'msgattrib %s %s -o \"%s\" --no-obsolete \"%s\"' %\n+            (wrap, location, pofile, pofile))\n         if errors:\n-            raise CommandError(\n-                \"errors happened while running msgattrib\\n%s\" % errors)\n+            if status != STATUS_OK:\n+                raise CommandError(\n+                    \"errors happened while running msgattrib\\n%s\" % errors)\n+            elif verbosity > 0:\n+                stdout.write(errors)\n \n def make_messages(locale=None, domain='django', verbosity=1, all=False,\n         extensions=None, symlinks=False, ignore_patterns=None, no_wrap=False,\n@@ -291,8 +309,8 @@ def make_messages(locale=None, domain='django', verbosity=1, all=False,\n         raise CommandError(message)\n \n     # We require gettext version 0.15 or newer.\n-    output, errors = _popen('xgettext --version')\n-    if errors:\n+    output, errors, status = _popen('xgettext --version')\n+    if status != STATUS_OK:\n         raise CommandError(\"Error running xgettext. Note that Django \"\n                     \"internationalization requires GNU gettext 0.15 or newer.\")\n     match = re.search(r'(?P<major>\\d+)\\.(?P<minor>\\d+)', output)"
        },
        {
            "sha": "bbcb83164bacd47a100e3bea1b039f0fc8c42ef1",
            "filename": "tests/regressiontests/i18n/commands/code.sample",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/c54905b3597545dbe1a6d8cd0a60186bccf8b3e7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fcode.sample",
            "raw_url": "https://github.com/django/django/raw/c54905b3597545dbe1a6d8cd0a60186bccf8b3e7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fcode.sample",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fcode.sample?ref=c54905b3597545dbe1a6d8cd0a60186bccf8b3e7",
            "patch": "@@ -0,0 +1,4 @@\n+from django.utils.translation import ugettext\n+\n+# This will generate an xgettext warning\n+my_string = ugettext(\"This string contain two placeholders: %s and %s\" % ('a', 'b'))"
        },
        {
            "sha": "cd6d50893ac8a98511c287ba33a4e5ea35d22f76",
            "filename": "tests/regressiontests/i18n/commands/extraction.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/c54905b3597545dbe1a6d8cd0a60186bccf8b3e7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "raw_url": "https://github.com/django/django/raw/c54905b3597545dbe1a6d8cd0a60186bccf8b3e7/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fcommands%2Fextraction.py?ref=c54905b3597545dbe1a6d8cd0a60186bccf8b3e7",
            "patch": "@@ -117,6 +117,14 @@ def test_extraction_error(self):\n         # Check that the temporary file was cleaned up\n         self.assertFalse(os.path.exists('./templates/template_with_error.html.py'))\n \n+    def test_extraction_warning(self):\n+        os.chdir(self.test_dir)\n+        shutil.copyfile('./code.sample', './code_sample.py')\n+        stdout = StringIO()\n+        management.call_command('makemessages', locale=LOCALE, stdout=stdout)\n+        os.remove('./code_sample.py')\n+        self.assertIn(\"code_sample.py:4\", stdout.getvalue())\n+\n     def test_template_message_context_extractor(self):\n         \"\"\"\n         Ensure that message contexts are correctly extracted for the"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 54,
        "deletions": 24
    }
}