{
    "author": "ramiro",
    "message": "Fixed #12658 -- Fixed test discovery so ImportErrors aren't ignored when both `tests` and `models` are packages. Thanks schinckel for the report and boxm for a patch for the issue.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16382 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f0adae4c6e857cabdff790d20dff815a37645d6f",
    "files": [
        {
            "sha": "b094465bf5ba8e6005a47bc87f23b7db8ee730db",
            "filename": "django/test/simple.py",
            "status": "modified",
            "additions": 17,
            "deletions": 16,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/django%2Ftest%2Fsimple.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/django%2Ftest%2Fsimple.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsimple.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f",
            "patch": "@@ -1,11 +1,14 @@\n import unittest as real_unittest\n+\n from django.conf import settings\n from django.core.exceptions import ImproperlyConfigured\n from django.db.models import get_app, get_apps\n from django.test import _doctest as doctest\n from django.test.utils import setup_test_environment, teardown_test_environment\n from django.test.testcases import OutputChecker, DocTestRunner, TestCase\n from django.utils import unittest\n+from django.utils.importlib import import_module\n+from django.utils.module_loading import module_has_submodule\n \n __all__ = ('DjangoTestRunner', 'DjangoTestSuiteRunner', 'run_tests')\n \n@@ -24,27 +27,25 @@ def __init__(self, *args, **kwargs):\n         super(DjangoTestRunner, self).__init__(*args, **kwargs)\n \n def get_tests(app_module):\n+    parts = app_module.__name__.split('.')\n+    prefix, last = parts[:-1], parts[-1]\n     try:\n-        app_path = app_module.__name__.split('.')[:-1]\n-        test_module = __import__('.'.join(app_path + [TEST_MODULE]), {}, {}, TEST_MODULE)\n-    except ImportError, e:\n+        test_module = import_module('.'.join(prefix + [TEST_MODULE]))\n+    except ImportError:\n         # Couldn't import tests.py. Was it due to a missing file, or\n         # due to an import error in a tests.py that actually exists?\n-        import os.path\n-        from imp import find_module\n-        try:\n-            mod = find_module(TEST_MODULE, [os.path.dirname(app_module.__file__)])\n-        except ImportError:\n-            # 'tests' module doesn't exist. Move on.\n+        # app_module either points to a models.py file, or models/__init__.py\n+        # Tests are therefore either in same directory, or one level up\n+        if last == 'models':\n+            app_root = import_module('.'.join(prefix))\n+        else:\n+            app_root = app_module\n+\n+        if not module_has_submodule(app_root, TEST_MODULE):\n             test_module = None\n         else:\n-            # The module exists, so there must be an import error in the\n-            # test module itself. We don't need the module; so if the\n-            # module was a single file module (i.e., tests.py), close the file\n-            # handle returned by find_module. Otherwise, the test module\n-            # is a directory, and there is nothing to close.\n-            if mod[0]:\n-                mod[0].close()\n+            # The module exists, so there must be an import error in the test\n+            # module itself.\n             raise\n     return test_module\n "
        },
        {
            "sha": "45efd37d3e803c5ff6c648f911e80213da2727f5",
            "filename": "tests/regressiontests/test_runner/invalid_app/__init__.py",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2F__init__.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f",
            "patch": "@@ -0,0 +1,4 @@\n+# Example of app layout that causes issue #12658:\n+# * Both `models` and `tests` are packages.\n+# * The tests raise a ImportError exception.\n+# `test_runner` tests performs test discovery on this app."
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/test_runner/invalid_app/models/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2Fmodels%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2Fmodels%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2Fmodels%2F__init__.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f"
        },
        {
            "sha": "b4ed71824b7abb60af19c078ba7be876a61f5290",
            "filename": "tests/regressiontests/test_runner/invalid_app/tests/__init__.py",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Finvalid_app%2Ftests%2F__init__.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f",
            "patch": "@@ -0,0 +1,4 @@\n+# Tests that raise ImportError should not fail silently.\n+# This is a support fixture for one test case in test_runner\n+\n+raise ImportError"
        },
        {
            "sha": "cb4d27a7a17b9a56ce0bf00b429643f51eb64bf2",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f",
            "patch": "@@ -8,11 +8,18 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.core.management import call_command\n from django.test import simple\n+from django.test.simple import get_tests\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import unittest\n+from django.utils.importlib import import_module\n+\n from regressiontests.admin_scripts.tests import AdminScriptTestCase\n \n \n+TEST_APP_OK = 'regressiontests.test_runner.valid_app.models'\n+TEST_APP_ERROR = 'regressiontests.test_runner.invalid_app.models'\n+\n+\n class DjangoTestRunnerTests(unittest.TestCase):\n     def setUp(self):\n         self._warnings_state = get_warnings_state()\n@@ -203,3 +210,16 @@ def test_all_options_given(self):\n         out, err = self.run_django_admin(args)\n         self.assertNoOutput(err)\n         self.assertOutput(out, 'bar:foo:31337')\n+\n+\n+class ModulesTestsPackages(unittest.TestCase):\n+    def test_get_tests(self):\n+        \"Check that the get_tests helper function can find tests in a directory\"\n+        module = import_module(TEST_APP_OK)\n+        tests = get_tests(module)\n+        self.assertIsInstance(tests, type(module))\n+\n+    def test_import_error(self):\n+        \"Test for #12658 - Tests with ImportError's shouldn't fail silently\"\n+        module = import_module(TEST_APP_ERROR)\n+        self.assertRaises(ImportError, get_tests, module)"
        },
        {
            "sha": "8d60a80c5329bc0969375f23d7459b87aa12740f",
            "filename": "tests/regressiontests/test_runner/valid_app/__init__.py",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2F__init__.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f",
            "patch": "@@ -0,0 +1,3 @@\n+# Example of app layout to verify that the fix for #12658 doesn't break test\n+# discovery when both `models` and `tests` are packages.\n+# `test_runner` tests perform test discovery on this app."
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/test_runner/valid_app/models/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2Fmodels%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2Fmodels%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2Fmodels%2F__init__.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/test_runner/valid_app/tests/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/f0adae4c6e857cabdff790d20dff815a37645d6f/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Fvalid_app%2Ftests%2F__init__.py?ref=f0adae4c6e857cabdff790d20dff815a37645d6f"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 48,
        "deletions": 16
    }
}