{
    "author": "ramiro",
    "message": "Fixed #2986 -- Made the JavaScript code that drives related model instance addition in a popup window handle a model representation containing new lines. Also, moved the escapejs functionality yoo django.utils.html so it can be used from Python code. Thanks andrewwatts for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15131 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "0f783b7f4eac037e22875eeeb6dc85c26b2a65f4",
    "files": [
        {
            "sha": "be4c6f8e7f9ee64b8bc36480e43fd8166bc0f037",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=0f783b7f4eac037e22875eeeb6dc85c26b2a65f4",
            "patch": "@@ -19,7 +19,7 @@\n from django.utils.decorators import method_decorator\n from django.utils.datastructures import SortedDict\n from django.utils.functional import update_wrapper\n-from django.utils.html import escape\n+from django.utils.html import escape, escapejs\n from django.utils.safestring import mark_safe\n from django.utils.functional import curry\n from django.utils.text import capfirst, get_text_list\n@@ -717,7 +717,7 @@ def response_add(self, request, obj, post_url_continue='../%s/'):\n         if \"_popup\" in request.POST:\n             return HttpResponse('<script type=\"text/javascript\">opener.dismissAddAnotherPopup(window, \"%s\", \"%s\");</script>' % \\\n                 # escape() calls force_unicode.\n-                (escape(pk_value), escape(obj)))\n+                (escape(pk_value), escapejs(obj)))\n         elif \"_addanother\" in request.POST:\n             self.message_user(request, msg + ' ' + (_(\"You may add another %s below.\") % force_unicode(opts.verbose_name)))\n             return HttpResponseRedirect(request.path)"
        },
        {
            "sha": "1e00effea099a2bf9189057e4dc60e4f14e38b0d",
            "filename": "django/template/defaultfilters.py",
            "status": "modified",
            "additions": 2,
            "deletions": 22,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/django%2Ftemplate%2Fdefaultfilters.py",
            "raw_url": "https://github.com/django/django/raw/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/django%2Ftemplate%2Fdefaultfilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaultfilters.py?ref=0f783b7f4eac037e22875eeeb6dc85c26b2a65f4",
            "patch": "@@ -64,29 +64,10 @@ def capfirst(value):\n capfirst.is_safe=True\n capfirst = stringfilter(capfirst)\n \n-_base_js_escapes = (\n-    ('\\\\', r'\\u005C'),\n-    ('\\'', r'\\u0027'),\n-    ('\"', r'\\u0022'),\n-    ('>', r'\\u003E'),\n-    ('<', r'\\u003C'),\n-    ('&', r'\\u0026'),\n-    ('=', r'\\u003D'),\n-    ('-', r'\\u002D'),\n-    (';', r'\\u003B'),\n-    (u'\\u2028', r'\\u2028'),\n-    (u'\\u2029', r'\\u2029')\n-)\n-\n-# Escape every ASCII character with a value less than 32.\n-_js_escapes = (_base_js_escapes +\n-               tuple([('%c' % z, '\\\\u%04X' % z) for z in range(32)]))\n-\n def escapejs(value):\n     \"\"\"Hex encodes characters for use in JavaScript strings.\"\"\"\n-    for bad, good in _js_escapes:\n-        value = value.replace(bad, good)\n-    return value\n+    from django.utils.html import escapejs\n+    return escapejs(value)\n escapejs = stringfilter(escapejs)\n \n def fix_ampersands(value):\n@@ -745,7 +726,6 @@ def timesince(value, arg=None):\n def timeuntil(value, arg=None):\n     \"\"\"Formats a date as the time until that date (i.e. \"4 days, 6 hours\").\"\"\"\n     from django.utils.timesince import timeuntil\n-    from datetime import datetime\n     if not value:\n         return u''\n     try:"
        },
        {
            "sha": "094bc6660dae69e0bc8af8ac89c5deb194352fae",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=0f783b7f4eac037e22875eeeb6dc85c26b2a65f4",
            "patch": "@@ -34,6 +34,31 @@ def escape(html):\n     return mark_safe(force_unicode(html).replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\"', '&quot;').replace(\"'\", '&#39;'))\n escape = allow_lazy(escape, unicode)\n \n+_base_js_escapes = (\n+    ('\\\\', r'\\u005C'),\n+    ('\\'', r'\\u0027'),\n+    ('\"', r'\\u0022'),\n+    ('>', r'\\u003E'),\n+    ('<', r'\\u003C'),\n+    ('&', r'\\u0026'),\n+    ('=', r'\\u003D'),\n+    ('-', r'\\u002D'),\n+    (';', r'\\u003B'),\n+    (u'\\u2028', r'\\u2028'),\n+    (u'\\u2029', r'\\u2029')\n+)\n+\n+# Escape every ASCII character with a value less than 32.\n+_js_escapes = (_base_js_escapes +\n+               tuple([('%c' % z, '\\\\u%04X' % z) for z in range(32)]))\n+\n+def escapejs(value):\n+    \"\"\"Hex encodes characters for use in JavaScript strings.\"\"\"\n+    for bad, good in _js_escapes:\n+        value = mark_safe(force_unicode(value).replace(bad, good))\n+    return value\n+escapejs = allow_lazy(escapejs, unicode)\n+\n def conditional_escape(html):\n     \"\"\"\n     Similar to escape(), except that it doesn't operate on pre-escaped strings."
        },
        {
            "sha": "90abfa8dbb79cbd083cb40dc6a11b70ea4007bcb",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=0f783b7f4eac037e22875eeeb6dc85c26b2a65f4",
            "patch": "@@ -107,6 +107,22 @@ def testBasicAddPost(self):\n         response = self.client.post('/test_admin/%s/admin_views/section/add/' % self.urlbit, post_data)\n         self.assertEqual(response.status_code, 302) # redirect somewhere\n \n+    def testPopupAddPost(self):\n+        \"\"\"\n+        Ensure http response from a popup is properly escaped.\n+        \"\"\"\n+        post_data = {\n+            '_popup': u'1',\n+            'title': u'title with a new\\nline',\n+            'content': u'some content',\n+            'date_0': u'2010-09-10',\n+            'date_1': u'14:55:39',\n+        }\n+        response = self.client.post('/test_admin/%s/admin_views/article/add/' % self.urlbit, post_data)\n+        self.failUnlessEqual(response.status_code, 200)\n+        self.assertContains(response, 'dismissAddAnotherPopup')\n+        self.assertContains(response, 'title with a new\\u000Aline')\n+\n     # Post data for edit inline\n     inline_post_data = {\n         \"name\": u\"Test section\","
        },
        {
            "sha": "3acb218cd184c86aa82e63512aa665c20cb109d9",
            "filename": "tests/regressiontests/utils/html.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/tests%2Fregressiontests%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/0f783b7f4eac037e22875eeeb6dc85c26b2a65f4/tests%2Fregressiontests%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fhtml.py?ref=0f783b7f4eac037e22875eeeb6dc85c26b2a65f4",
            "patch": "@@ -109,3 +109,15 @@ def test_fix_ampersands(self):\n         )\n         for value, output in items:\n             self.check_output(f, value, output)\n+\n+    def test_escapejs(self):\n+        f = html.escapejs\n+        items = (\n+            (u'\"double quotes\" and \\'single quotes\\'', u'\\\\u0022double quotes\\\\u0022 and \\\\u0027single quotes\\\\u0027'),\n+            (ur'\\ : backslashes, too', u'\\\\u005C : backslashes, too'),\n+            (u'and lots of whitespace: \\r\\n\\t\\v\\f\\b', u'and lots of whitespace: \\\\u000D\\\\u000A\\\\u0009\\\\u000B\\\\u000C\\\\u0008'),\n+            (ur'<script>and this</script>', u'\\\\u003Cscript\\\\u003Eand this\\\\u003C/script\\\\u003E'),\n+            (u'paragraph separator:\\u2029and line separator:\\u2028', u'paragraph separator:\\\\u2029and line separator:\\\\u2028'),\n+        )\n+        for value, output in items:\n+            self.check_output(f, value, output)"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 57,
        "deletions": 24
    }
}