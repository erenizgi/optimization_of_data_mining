{
    "author": "jezdez",
    "message": "Fixed #16082 -- Fixed race condition in the FileSystemStorage backend with regard to creating directories. Thanks, pjdelport.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16280 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "723b620c7edab47561d6387c7db3ace2f3b7aa16",
    "files": [
        {
            "sha": "f29d16c9850e535b43fa3028e79a5e4e740f6bf4",
            "filename": "django/core/files/storage.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/723b620c7edab47561d6387c7db3ace2f3b7aa16/django%2Fcore%2Ffiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/723b620c7edab47561d6387c7db3ace2f3b7aa16/django%2Fcore%2Ffiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fstorage.py?ref=723b620c7edab47561d6387c7db3ace2f3b7aa16",
            "patch": "@@ -161,10 +161,18 @@ def _open(self, name, mode='rb'):\n     def _save(self, name, content):\n         full_path = self.path(name)\n \n+        # Create any intermediate directories that do not exist.\n+        # Note that there is a race between os.path.exists and os.makedirs:\n+        # if os.makedirs fails with EEXIST, the directory was created\n+        # concurrently, and we can continue normally. Refs #16082.\n         directory = os.path.dirname(full_path)\n         if not os.path.exists(directory):\n-            os.makedirs(directory)\n-        elif not os.path.isdir(directory):\n+            try:\n+                os.makedirs(directory)\n+            except OSError, e:\n+                if e.errno != errno.EEXIST:\n+                    raise\n+        if not os.path.isdir(directory):\n             raise IOError(\"%s exists and is not a directory.\" % directory)\n \n         # There's a potential race condition between get_available_name and"
        },
        {
            "sha": "f498f1f0e052c48050cdc266bfd6702e043d1fe8",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/django/django/blob/723b620c7edab47561d6387c7db3ace2f3b7aa16/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/723b620c7edab47561d6387c7db3ace2f3b7aa16/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=723b620c7edab47561d6387c7db3ace2f3b7aa16",
            "patch": "@@ -1,5 +1,6 @@\n # -*- coding: utf-8 -*-\n import os\n+import errno\n import shutil\n import sys\n import tempfile\n@@ -186,6 +187,23 @@ def test_file_save_without_name(self):\n \n         self.storage.delete(storage_f_name)\n \n+    def test_file_save_with_path(self):\n+        \"\"\"\n+        Saving a pathname should create intermediate directories as necessary.\n+        \"\"\"\n+        self.assertFalse(self.storage.exists('path/to'))\n+        self.storage.save('path/to/test.file',\n+            ContentFile('file saved with path'))\n+\n+        self.assertTrue(self.storage.exists('path/to'))\n+        self.assertEqual(self.storage.open('path/to/test.file').read(),\n+            'file saved with path')\n+\n+        self.assertTrue(os.path.exists(\n+            os.path.join(self.temp_dir, 'path', 'to', 'test.file')))\n+\n+        self.storage.delete('path/to/test.file')\n+\n     def test_file_path(self):\n         \"\"\"\n         File storage returns the full path of a file\n@@ -282,6 +300,44 @@ def test_file_storage_preserves_filename_case(self):\n                          temp_storage.path(mixed_case))\n         temp_storage.delete(mixed_case)\n \n+    def test_makedirs_race_handling(self):\n+        \"\"\"\n+        File storage should be robust against directory creation race conditions.\n+        \"\"\"\n+        # Monkey-patch os.makedirs, to simulate a normal call, a raced call,\n+        # and an error.\n+        def fake_makedirs(path):\n+            if path == os.path.join(self.temp_dir, 'normal'):\n+                os.mkdir(path)\n+            elif path == os.path.join(self.temp_dir, 'raced'):\n+                os.mkdir(path)\n+                raise OSError(errno.EEXIST, 'simulated EEXIST')\n+            elif path == os.path.join(self.temp_dir, 'error'):\n+                raise OSError(errno.EACCES, 'simulated EACCES')\n+            else:\n+                self.fail('unexpected argument %r' % path)\n+\n+        real_makedirs = os.makedirs\n+        try:\n+            os.makedirs = fake_makedirs\n+\n+            self.storage.save('normal/test.file',\n+                ContentFile('saved normally'))\n+            self.assertEqual(self.storage.open('normal/test.file').read(),\n+                'saved normally')\n+\n+            self.storage.save('raced/test.file',\n+                ContentFile('saved with race'))\n+            self.assertEqual(self.storage.open('raced/test.file').read(),\n+                'saved with race')\n+\n+            # Check that OSErrors aside from EEXIST are still raised.\n+            self.assertRaises(OSError,\n+                lambda: self.storage.save('error/test.file',\n+                    ContentFile('not saved')))\n+        finally:\n+            os.makedirs = real_makedirs\n+\n class CustomStorage(FileSystemStorage):\n     def get_available_name(self, name):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 68,
        "additions": 66,
        "deletions": 2
    }
}