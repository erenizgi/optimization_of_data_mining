{
    "author": "ramiro",
    "message": "Fixed #18116 -- Raised minimum MySQL version officially suported to 5.0.3.\n\nThanks Carl, Claude and Anssi for discussion and patch review.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17921 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4536359887b34eea5e7b8cf6864d9092b46c2980",
    "files": [
        {
            "sha": "c1ef625bb66b62fb04544c92d5edde074263b6cf",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/4536359887b34eea5e7b8cf6864d9092b46c2980/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/4536359887b34eea5e7b8cf6864d9092b46c2980/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=4536359887b34eea5e7b8cf6864d9092b46c2980",
            "patch": "@@ -15,11 +15,13 @@\n     from django.core.exceptions import ImproperlyConfigured\n     raise ImproperlyConfigured(\"Error loading MySQLdb module: %s\" % e)\n \n+from django.utils.functional import cached_property\n+\n # We want version (1, 2, 1, 'final', 2) or later. We can't just use\n # lexicographic ordering in this check because then (1, 2, 1, 'gamma')\n # inadvertently passes the version test.\n version = Database.version_info\n-if (version < (1,2,1) or (version[:3] == (1, 2, 1) and\n+if (version < (1, 2, 1) or (version[:3] == (1, 2, 1) and\n         (len(version) < 5 or version[3] != 'final' or version[4] < 2))):\n     from django.core.exceptions import ImproperlyConfigured\n     raise ImproperlyConfigured(\"MySQLdb-1.2.1p2 or newer is required; you have %s\" % Database.__version__)\n@@ -163,6 +165,7 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     supports_timezones = False\n     requires_explicit_null_ordering_when_grouping = True\n     allows_primary_key_0 = False\n+    uses_savepoints = True\n \n     def __init__(self, connection):\n         super(DatabaseFeatures, self).__init__(connection)\n@@ -387,8 +390,6 @@ def _cursor(self):\n             self.connection = Database.connect(**kwargs)\n             self.connection.encoders[SafeUnicode] = self.connection.encoders[unicode]\n             self.connection.encoders[SafeString] = self.connection.encoders[str]\n-            self.features.uses_savepoints = \\\n-                self.get_server_version() >= (5, 0, 3)\n             connection_created.send(sender=self.__class__, connection=self)\n         cursor = self.connection.cursor()\n         if new_connection:\n@@ -405,10 +406,11 @@ def _rollback(self):\n         except Database.NotSupportedError:\n             pass\n \n-    def get_server_version(self):\n+    @cached_property\n+    def mysql_version(self):\n         if not self.server_version:\n             if not self._valid_connection():\n-                self.cursor()\n+                self.cursor().close()\n             m = server_version_re.match(self.connection.get_server_info())\n             if not m:\n                 raise Exception('Unable to determine MySQL version from version string %r' % self.connection.get_server_info())"
        },
        {
            "sha": "bb56ae38a6adf344cfefd57b7dc8651468c2e2e1",
            "filename": "django/db/backends/mysql/introspection.py",
            "status": "modified",
            "additions": 8,
            "deletions": 21,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/4536359887b34eea5e7b8cf6864d9092b46c2980/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py",
            "raw_url": "https://github.com/django/django/raw/4536359887b34eea5e7b8cf6864d9092b46c2980/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fintrospection.py?ref=4536359887b34eea5e7b8cf6864d9092b46c2980",
            "patch": "@@ -65,27 +65,14 @@ def get_key_columns(self, cursor, table_name):\n         key columns in given table.\n         \"\"\"\n         key_columns = []\n-        try:\n-            cursor.execute(\"\"\"\n-                SELECT column_name, referenced_table_name, referenced_column_name\n-                FROM information_schema.key_column_usage\n-                WHERE table_name = %s\n-                    AND table_schema = DATABASE()\n-                    AND referenced_table_name IS NOT NULL\n-                    AND referenced_column_name IS NOT NULL\"\"\", [table_name])\n-            key_columns.extend(cursor.fetchall())\n-        except (ProgrammingError, OperationalError):\n-            # Fall back to \"SHOW CREATE TABLE\", for previous MySQL versions.\n-            # Go through all constraints and save the equal matches.\n-            cursor.execute(\"SHOW CREATE TABLE %s\" % self.connection.ops.quote_name(table_name))\n-            for row in cursor.fetchall():\n-                pos = 0\n-                while True:\n-                    match = foreign_key_re.search(row[1], pos)\n-                    if match == None:\n-                        break\n-                    pos = match.end()\n-                    key_columns.append(match.groups())\n+        cursor.execute(\"\"\"\n+            SELECT column_name, referenced_table_name, referenced_column_name\n+            FROM information_schema.key_column_usage\n+            WHERE table_name = %s\n+                AND table_schema = DATABASE()\n+                AND referenced_table_name IS NOT NULL\n+                AND referenced_column_name IS NOT NULL\"\"\", [table_name])\n+        key_columns.extend(cursor.fetchall())\n         return key_columns\n \n     def get_primary_key_column(self, cursor, table_name):"
        },
        {
            "sha": "de7474d1e54aea849c2d3194a3925f7621cf0ef9",
            "filename": "django/db/backends/mysql/validation.py",
            "status": "modified",
            "additions": 6,
            "deletions": 23,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/4536359887b34eea5e7b8cf6864d9092b46c2980/django%2Fdb%2Fbackends%2Fmysql%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/4536359887b34eea5e7b8cf6864d9092b46c2980/django%2Fdb%2Fbackends%2Fmysql%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fvalidation.py?ref=4536359887b34eea5e7b8cf6864d9092b46c2980",
            "patch": "@@ -3,30 +3,13 @@\n class DatabaseValidation(BaseDatabaseValidation):\n     def validate_field(self, errors, opts, f):\n         \"\"\"\n-        There are some field length restrictions for MySQL:\n-\n-        - Prior to version 5.0.3, character fields could not exceed 255\n-          characters in length.\n-        - No character (varchar) fields can have a length exceeding 255\n-          characters if they have a unique index on them.\n+        MySQL has the following field length restriction:\n+        No character (varchar) fields can have a length exceeding 255\n+        characters if they have a unique index on them.\n         \"\"\"\n         from django.db import models\n-        from MySQLdb import OperationalError\n-        try:\n-            db_version = self.connection.get_server_version()\n-            text_version = '.'.join([str(n) for n in db_version[:3]])\n-        except OperationalError:\n-            db_version = None\n-            text_version = ''\n         varchar_fields = (models.CharField, models.CommaSeparatedIntegerField,\n                 models.SlugField)\n-        if isinstance(f, varchar_fields) and f.max_length > 255:\n-            if db_version and db_version < (5, 0, 3):\n-                msg = '\"%(name)s\": %(cls)s cannot have a \"max_length\" greater than 255 when you are using a version of MySQL prior to 5.0.3 (you are using %(version)s).'\n-            elif f.unique == True:\n-                msg = '\"%(name)s\": %(cls)s cannot have a \"max_length\" greater than 255 when using \"unique=True\".'\n-            else:\n-                msg = None\n-\n-            if msg:\n-                errors.add(opts, msg % {'name': f.name, 'cls': f.__class__.__name__, 'version': text_version})\n+        if isinstance(f, varchar_fields) and f.max_length > 255 and f.unique:\n+            msg = '\"%(name)s\": %(cls)s cannot have a \"max_length\" greater than 255 when using \"unique=True\".'\n+            errors.add(opts, msg % {'name': f.name, 'cls': f.__class__.__name__})"
        },
        {
            "sha": "c271946bb73603df22cb12b85295d1cfb07b5e24",
            "filename": "docs/ref/databases.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 22,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/4536359887b34eea5e7b8cf6864d9092b46c2980/docs%2Fref%2Fdatabases.txt",
            "raw_url": "https://github.com/django/django/raw/4536359887b34eea5e7b8cf6864d9092b46c2980/docs%2Fref%2Fdatabases.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdatabases.txt?ref=4536359887b34eea5e7b8cf6864d9092b46c2980",
            "patch": "@@ -122,30 +122,23 @@ lookups that use the ``LIKE`` operator in their SQL, as is done with the\n MySQL notes\n ===========\n \n-Django expects the database to support transactions, referential integrity, and\n-Unicode (UTF-8 encoding). Fortunately, MySQL_ has all these features as\n-available as far back as 3.23. While it may be possible to use 3.23 or 4.0,\n-you'll probably have less trouble if you use 4.1 or 5.0.\n+Version support\n+---------------\n \n-MySQL 4.1\n----------\n+Django supports MySQL 5.0.3 and higher.\n \n-`MySQL 4.1`_ has greatly improved support for character sets. It is possible to\n-set different default character sets on the database, table, and column.\n-Previous versions have only a server-wide character set setting. It's also the\n-first version where the character set can be changed on the fly. 4.1 also has\n-support for views, but Django currently doesn't use views.\n+`MySQL 5.0`_ adds the ``information_schema`` database, which contains detailed\n+data on all database schema. Django's ``inspectdb`` feature uses this feature.\n \n-MySQL 5.0\n----------\n+.. versionchanged:: 1.5\n+    The minimum version requirement of MySQL 5.0.3 was set in Django 1.5.\n \n-`MySQL 5.0`_ adds the ``information_schema`` database, which contains detailed\n-data on all database schema. Django's ``inspectdb`` feature uses this\n-``information_schema`` if it's available. 5.0 also has support for stored\n-procedures, but Django currently doesn't use stored procedures.\n+Django expects the database to support Unicode (UTF-8 encoding) and delegates to\n+it the task of enforcing transactions and referential integrity. It is important\n+to be aware of the fact that the two latter ones aren't actually enforced by\n+MySQL when using the MyISAM storage engine, see the next section.\n \n .. _MySQL: http://www.mysql.com/\n-.. _MySQL 4.1: http://dev.mysql.com/doc/refman/4.1/en/index.html\n .. _MySQL 5.0: http://dev.mysql.com/doc/refman/5.0/en/index.html\n \n Storage engines\n@@ -381,10 +374,6 @@ for the field. This affects :class:`~django.db.models.CharField`,\n :class:`~django.db.models.SlugField` and\n :class:`~django.db.models.CommaSeparatedIntegerField`.\n \n-Furthermore, if you are using a version of MySQL prior to 5.0.3, all of those\n-column types have a maximum length restriction of 255 characters, regardless\n-of whether ``unique=True`` is specified or not.\n-\n DateTime fields\n ~~~~~~~~~~~~~~~\n "
        }
    ],
    "stats": {
        "total": 103,
        "additions": 32,
        "deletions": 71
    }
}