{
    "author": "freakboy3742",
    "message": "Fixed #15111 -- Ensured that the auth, contenttypes and sitemaps tests will run when the sites app isn't installed. Thanks to Waldemar Kornewald for the report and draft patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15418 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7a60b411305bc363ec51a096b108fa909c1b352b",
    "files": [
        {
            "sha": "a9bcd95434eb018ec9fdc02c0fe430fce34f78f3",
            "filename": "django/contrib/auth/tests/views.py",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/7a60b411305bc363ec51a096b108fa909c1b352b/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/7a60b411305bc363ec51a096b108fa909c1b352b/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fviews.py?ref=7a60b411305bc363ec51a096b108fa909c1b352b",
            "patch": "@@ -5,7 +5,7 @@\n from django.conf import settings\n from django.contrib.auth import SESSION_KEY, REDIRECT_FIELD_NAME\n from django.contrib.auth.forms import AuthenticationForm\n-from django.contrib.sites.models import Site\n+from django.contrib.sites.models import Site, RequestSite\n from django.contrib.auth.models import User\n from django.test import TestCase\n from django.core import mail\n@@ -198,9 +198,12 @@ class LoginTest(AuthViewsTestCase):\n     def test_current_site_in_context_after_login(self):\n         response = self.client.get(reverse('django.contrib.auth.views.login'))\n         self.assertEquals(response.status_code, 200)\n-        site = Site.objects.get_current()\n-        self.assertEquals(response.context['site'], site)\n-        self.assertEquals(response.context['site_name'], site.name)\n+        if Site._meta.installed:\n+            site = Site.objects.get_current()\n+            self.assertEquals(response.context['site'], site)\n+            self.assertEquals(response.context['site_name'], site.name)\n+        else:\n+            self.assertIsInstance(response.context['site'], RequestSite)\n         self.assert_(isinstance(response.context['form'], AuthenticationForm), \n                      'Login form is not an AuthenticationForm')\n "
        },
        {
            "sha": "7a1ca99d334136f9ad43df1d95c27c7e83ded815",
            "filename": "django/contrib/contenttypes/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/7a60b411305bc363ec51a096b108fa909c1b352b/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7a60b411305bc363ec51a096b108fa909c1b352b/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Ftests.py?ref=7a60b411305bc363ec51a096b108fa909c1b352b",
            "patch": "@@ -61,9 +61,11 @@ def test_shortcut_view(self):\n         from django.contrib.auth.models import User\n         user_ct = ContentType.objects.get_for_model(User)\n         obj = User.objects.create(username=\"john\")\n-        Site._meta.installed = True\n-        response = shortcut(request, user_ct.id, obj.id)\n-        self.assertEqual(\"http://example.com/users/john/\", response._headers.get(\"location\")[1])\n+\n+        if Site._meta.installed:\n+            response = shortcut(request, user_ct.id, obj.id)\n+            self.assertEqual(\"http://example.com/users/john/\", response._headers.get(\"location\")[1])\n+\n         Site._meta.installed = False\n         response = shortcut(request, user_ct.id, obj.id)\n         self.assertEqual(\"http://Example.com/users/john/\", response._headers.get(\"location\")[1])"
        },
        {
            "sha": "39d02262e9e328e769edfb51d8c7c0c2b162b093",
            "filename": "django/contrib/sitemaps/tests/basic.py",
            "status": "modified",
            "additions": 19,
            "deletions": 14,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/7a60b411305bc363ec51a096b108fa909c1b352b/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py",
            "raw_url": "https://github.com/django/django/raw/7a60b411305bc363ec51a096b108fa909c1b352b/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbasic.py?ref=7a60b411305bc363ec51a096b108fa909c1b352b",
            "patch": "@@ -15,9 +15,14 @@ class SitemapTests(TestCase):\n     urls = 'django.contrib.sitemaps.tests.urls'\n \n     def setUp(self):\n+        if Site._meta.installed:\n+            self.base_url = 'http://example.com'\n+        else:\n+            self.base_url = 'http://testserver'\n         self.old_USE_L10N = settings.USE_L10N\n         self.old_Site_meta_installed = Site._meta.installed\n         self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n+        self.old_Site_meta_installed = Site._meta.installed\n         settings.TEMPLATE_DIRS = (\n             os.path.join(os.path.dirname(__file__), 'templates'),\n         )\n@@ -28,6 +33,7 @@ def tearDown(self):\n         settings.USE_L10N = self.old_USE_L10N\n         Site._meta.installed = self.old_Site_meta_installed\n         settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n+        Site._meta.installed = self.old_Site_meta_installed\n \n     def test_simple_sitemap_index(self):\n         \"A simple sitemap index can be rendered\"\n@@ -36,9 +42,9 @@ def test_simple_sitemap_index(self):\n         # Check for all the important bits:\n         self.assertEquals(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n-<sitemap><loc>http://example.com/simple/sitemap-simple.xml</loc></sitemap>\n+<sitemap><loc>%s/simple/sitemap-simple.xml</loc></sitemap>\n </sitemapindex>\n-\"\"\")\n+\"\"\" % self.base_url)\n \n     def test_simple_sitemap_custom_index(self):\n         \"A simple sitemap index can be rendered with a custom template\"\n@@ -48,9 +54,9 @@ def test_simple_sitemap_custom_index(self):\n         self.assertEquals(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <!-- This is a customised template -->\n <sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n-<sitemap><loc>http://example.com/simple/sitemap-simple.xml</loc></sitemap>\n+<sitemap><loc>%s/simple/sitemap-simple.xml</loc></sitemap>\n </sitemapindex>\n-\"\"\")\n+\"\"\" % self.base_url)\n \n     def test_simple_sitemap(self):\n         \"A simple sitemap can be rendered\"\n@@ -59,9 +65,9 @@ def test_simple_sitemap(self):\n         # Check for all the important bits:\n         self.assertEquals(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n-<url><loc>http://example.com/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n+<url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n </urlset>\n-\"\"\" % date.today().strftime('%Y-%m-%d'))\n+\"\"\" % (self.base_url, date.today().strftime('%Y-%m-%d')))\n \n     def test_simple_custom_sitemap(self):\n         \"A simple sitemap can be rendered with a custom template\"\n@@ -71,9 +77,9 @@ def test_simple_custom_sitemap(self):\n         self.assertEquals(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <!-- This is a customised template -->\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n-<url><loc>http://example.com/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n+<url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n </urlset>\n-\"\"\" % date.today().strftime('%Y-%m-%d'))\n+\"\"\" % (self.base_url, date.today().strftime('%Y-%m-%d')))\n \n     @skipUnless(settings.USE_I18N, \"Internationalization is not enabled\")\n     def test_localized_priority(self):\n@@ -97,13 +103,13 @@ def test_generic_sitemap(self):\n \n         expected = ''\n         for username in User.objects.values_list(\"username\", flat=True):\n-            expected += \"<url><loc>http://example.com/users/%s/</loc></url>\" %username\n+            expected += \"<url><loc>%s/users/%s/</loc></url>\" % (self.base_url, username)\n         # Check for all the important bits:\n         self.assertEquals(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n %s\n </urlset>\n-\"\"\" %expected)\n+\"\"\" % expected)\n \n     @skipUnless(\"django.contrib.flatpages\" in settings.INSTALLED_APPS, \"django.contrib.flatpages app not installed.\")\n     def test_flatpage_sitemap(self):\n@@ -131,9 +137,9 @@ def test_flatpage_sitemap(self):\n         private.sites.add(settings.SITE_ID)\n         response = self.client.get('/flatpages/sitemap.xml')\n         # Public flatpage should be in the sitemap\n-        self.assertContains(response, '<loc>http://example.com%s</loc>' % public.url)\n+        self.assertContains(response, '<loc>%s%s</loc>' % (self.base_url, public.url))\n         # Private flatpage should not be in the sitemap\n-        self.assertNotContains(response, '<loc>http://example.com%s</loc>' % private.url)\n+        self.assertNotContains(response, '<loc>%s%s</loc>' % (self.base_url, private.url))\n \n     def test_requestsite_sitemap(self):\n         # Make sure hitting the flatpages sitemap without the sites framework\n@@ -148,12 +154,12 @@ def test_requestsite_sitemap(self):\n </urlset>\n \"\"\" % date.today().strftime('%Y-%m-%d'))\n \n+    @skipUnless(\"django.contrib.sites\" in settings.INSTALLED_APPS, \"django.contrib.sites app not installed.\")\n     def test_sitemap_get_urls_no_site_1(self):\n         \"\"\"\n         Check we get ImproperlyConfigured if we don't pass a site object to\n         Sitemap.get_urls and no Site objects exist\n         \"\"\"\n-        Site._meta.installed = True\n         Site.objects.all().delete()\n         self.assertRaises(ImproperlyConfigured, Sitemap().get_urls)\n \n@@ -163,6 +169,5 @@ def test_sitemap_get_urls_no_site_2(self):\n         Sitemap.get_urls if Site objects exists, but the sites framework is not\n         actually installed.\n         \"\"\"\n-        Site.objects.get_current()\n         Site._meta.installed = False\n         self.assertRaises(ImproperlyConfigured, Sitemap().get_urls)"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 31,
        "deletions": 21
    }
}