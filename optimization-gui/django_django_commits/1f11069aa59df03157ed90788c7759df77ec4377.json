{
    "author": "aaugustin",
    "message": "Fixed #18090 -- Applied filters when running prefetch_related backwards through a one-to-one relation.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17888 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1f11069aa59df03157ed90788c7759df77ec4377",
    "files": [
        {
            "sha": "7034d348675ebac5097d34ff8451b17925ab42cd",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1f11069aa59df03157ed90788c7759df77ec4377/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/1f11069aa59df03157ed90788c7759df77ec4377/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=1f11069aa59df03157ed90788c7759df77ec4377",
            "patch": "@@ -239,7 +239,7 @@ def get_query_set(self, **db_hints):\n     def get_prefetch_query_set(self, instances):\n         vals = set(instance._get_pk_val() for instance in instances)\n         params = {'%s__pk__in' % self.related.field.name: vals}\n-        return (self.get_query_set(instance=instances[0]),\n+        return (self.get_query_set(instance=instances[0]).filter(**params),\n                 attrgetter(self.related.field.attname),\n                 lambda obj: obj._get_pk_val(),\n                 True,"
        },
        {
            "sha": "035ae4aa1082a6935d8d87a95bee247abe456c5d",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/1f11069aa59df03157ed90788c7759df77ec4377/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1f11069aa59df03157ed90788c7759df77ec4377/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=1f11069aa59df03157ed90788c7759df77ec4377",
            "patch": "@@ -1,7 +1,9 @@\n from __future__ import absolute_import\n \n from django.contrib.contenttypes.models import ContentType\n+from django.db import connection\n from django.test import TestCase\n+from django.test.utils import override_settings\n \n from .models import (Author, Book, Reader, Qualification, Teacher, Department,\n     TaggedItem, Bookmark, AuthorAddress, FavoriteAuthors, AuthorWithAge,\n@@ -356,10 +358,15 @@ def test_parent_link_prefetch(self):\n         with self.assertNumQueries(2):\n             [a.author for a in AuthorWithAge.objects.prefetch_related('author')]\n \n+    @override_settings(DEBUG=True)\n     def test_child_link_prefetch(self):\n         with self.assertNumQueries(2):\n             l = [a.authorwithage for a in Author.objects.prefetch_related('authorwithage')]\n \n+        # Regression for #18090: the prefetching query must include an IN clause.\n+        self.assertIn('authorwithage', connection.queries[-1]['sql'])\n+        self.assertIn(' IN ', connection.queries[-1]['sql'])\n+\n         self.assertEqual(l, [a.authorwithage for a in Author.objects.all()])\n \n "
        }
    ],
    "stats": {
        "total": 9,
        "additions": 8,
        "deletions": 1
    }
}