{
    "author": "jezdez",
    "message": "Fixed #14262 -- Added new assignment_tag as a simple way to assign the result of a template tag to a context variable. Thanks, Julien Phalip.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16149 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "950e05c3ff5daa360c3bddb84831d40b167062f1",
    "files": [
        {
            "sha": "eacc29cfcdf6217c329a7d40ea8ca6fe7b70bf4d",
            "filename": "django/template/base.py",
            "status": "modified",
            "additions": 60,
            "deletions": 0,
            "changes": 60,
            "blob_url": "https://github.com/django/django/blob/950e05c3ff5daa360c3bddb84831d40b167062f1/django%2Ftemplate%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/950e05c3ff5daa360c3bddb84831d40b167062f1/django%2Ftemplate%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fbase.py?ref=950e05c3ff5daa360c3bddb84831d40b167062f1",
            "patch": "@@ -901,6 +901,66 @@ def render(self, context):\n         else:\n             raise TemplateSyntaxError(\"Invalid arguments provided to simple_tag\")\n \n+    def assignment_tag(self, func=None, takes_context=None):\n+        def dec(func):\n+            params, xx, xxx, defaults = getargspec(func)\n+            if takes_context:\n+                if params[0] == 'context':\n+                    params = params[1:]\n+                else:\n+                    raise TemplateSyntaxError(\"Any tag function decorated with takes_context=True must have a first argument of 'context'\")\n+\n+            class AssignmentNode(Node):\n+                def __init__(self, params_vars, target_var):\n+                    self.params_vars = map(Variable, params_vars)\n+                    self.target_var = target_var\n+\n+                def render(self, context):\n+                    resolved_vars = [var.resolve(context) for var in self.params_vars]\n+                    if takes_context:\n+                        func_args = [context] + resolved_vars\n+                    else:\n+                        func_args = resolved_vars\n+                    context[self.target_var] = func(*func_args)\n+                    return ''\n+\n+            def compile_func(parser, token):\n+                bits = token.split_contents()\n+                tag_name = bits[0]\n+                bits = bits[1:]\n+                params_max = len(params)\n+                defaults_length = defaults and len(defaults) or 0\n+                params_min = params_max - defaults_length\n+                if (len(bits) < 2 or bits[-2] != 'as'):\n+                    raise TemplateSyntaxError(\n+                        \"'%s' tag takes at least 2 arguments and the \"\n+                        \"second last argument must be 'as'\" % tag_name)\n+                params_vars = bits[:-2]\n+                target_var = bits[-1]\n+                if (len(params_vars) < params_min or\n+                        len(params_vars) > params_max):\n+                    if params_min == params_max:\n+                        raise TemplateSyntaxError(\n+                            \"%s takes %s arguments\" % (tag_name, params_min))\n+                    else:\n+                        raise TemplateSyntaxError(\n+                            \"%s takes between %s and %s arguments\"\n+                            % (tag_name, params_min, params_max))\n+                return AssignmentNode(params_vars, target_var)\n+\n+            compile_func.__doc__ = func.__doc__\n+            self.tag(getattr(func, \"_decorated_function\", func).__name__, compile_func)\n+            return func\n+\n+        if func is None:\n+            # @register.assignment_tag(...)\n+            return dec\n+        elif callable(func):\n+            # @register.assignment_tag\n+            return dec(func)\n+        else:\n+            raise TemplateSyntaxError(\"Invalid arguments provided to assignment_tag\")\n+\n     def inclusion_tag(self, file_name, context_class=Context, takes_context=False):\n         def dec(func):\n             params, xx, xxx, defaults = getargspec(func)"
        },
        {
            "sha": "16f25ae5649f60907f3b3e2c918b25e70f2554e3",
            "filename": "docs/howto/custom-template-tags.txt",
            "status": "modified",
            "additions": 64,
            "deletions": 1,
            "changes": 65,
            "blob_url": "https://github.com/django/django/blob/950e05c3ff5daa360c3bddb84831d40b167062f1/docs%2Fhowto%2Fcustom-template-tags.txt",
            "raw_url": "https://github.com/django/django/raw/950e05c3ff5daa360c3bddb84831d40b167062f1/docs%2Fhowto%2Fcustom-template-tags.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fcustom-template-tags.txt?ref=950e05c3ff5daa360c3bddb84831d40b167062f1",
            "patch": "@@ -681,7 +681,70 @@ Or, using decorator syntax::\n         return your_get_current_time_method(timezone, format_string)\n \n For more information on how the ``takes_context`` option works, see the section\n-on `inclusion tags`_.\n+on :ref:`inclusion tags<howto-custom-template-tags-inclusion-tags>`.\n+\n+.. _howto-custom-template-tags-assignment-tags:\n+\n+Assignment tags\n+~~~~~~~~~~~~~~~\n+\n+.. versionadded:: 1.4\n+\n+Another common type of template tag is the type that fetches some data and\n+stores it in a context variable. To ease the creation of this type of tags,\n+Django provides a helper function, ``assignment_tag``. This function works\n+the same way as :ref:`simple_tag<howto-custom-template-tags-simple-tags>`,\n+except that it stores the tag's result in a specified context variable instead\n+of directly outputting it.\n+\n+Our earlier ``current_time`` function could thus be written like this:\n+\n+.. code-block:: python\n+\n+    def get_current_time(format_string):\n+        return datetime.datetime.now().strftime(format_string)\n+\n+    register.assignment_tag(get_current_time)\n+\n+The decorator syntax also works:\n+\n+.. code-block:: python\n+\n+    @register.assignment_tag\n+    def get_current_time(format_string):\n+        ...\n+\n+You may then store the result in a template variable using the ``as`` argument\n+followed by the variable name, and output it yourself where you see fit:\n+\n+.. code-block:: html+django\n+\n+    {% get_current_time \"%Y-%m-%d %I:%M %p\" as the_time %}\n+    <p>The time is {{ the_time }}.</p>\n+\n+If your template tag needs to access the current context, you can use the\n+``takes_context`` argument when registering your tag:\n+\n+.. code-block:: python\n+\n+    # The first argument *must* be called \"context\" here.\n+    def get_current_time(context, format_string):\n+        timezone = context['timezone']\n+        return your_get_current_time_method(timezone, format_string)\n+\n+    register.assignment_tag(takes_context=True)(get_current_time)\n+\n+Or, using decorator syntax:\n+\n+.. code-block:: python\n+\n+    @register.assignment_tag(takes_context=True)\n+    def get_current_time(context, format_string):\n+        timezone = context['timezone']\n+        return your_get_current_time_method(timezone, format_string)\n+\n+For more information on how the ``takes_context`` option works, see the section\n+on :ref:`inclusion tags<howto-custom-template-tags-inclusion-tags>`.\n \n .. _howto-custom-template-tags-inclusion-tags:\n "
        },
        {
            "sha": "3e8225311635bf74521d3f590aef2d26787b3683",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/950e05c3ff5daa360c3bddb84831d40b167062f1/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/950e05c3ff5daa360c3bddb84831d40b167062f1/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=950e05c3ff5daa360c3bddb84831d40b167062f1",
            "patch": "@@ -52,6 +52,14 @@ documentation for :attr:`~django.contrib.admin.ModelAdmin.list_filter`.\n A lazily evaluated version of :func:`django.core.urlresolvers.reverse` was\n added to allow using URL reversals before the project's URLConf gets loaded.\n \n+Assignment template tags\n+~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+A new helper function,\n+:ref:`assignment_tag<howto-custom-template-tags-assignment-tags>`, was added to\n+``template.Library`` to ease the creation of template tags that store some\n+data in a specified context variable.\n+\n .. _backwards-incompatible-changes-1.4:\n \n Backwards incompatible changes in 1.4"
        },
        {
            "sha": "3ce4d9954779b39a473e66b316f891ed8a85ed3e",
            "filename": "tests/regressiontests/templates/custom.py",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/950e05c3ff5daa360c3bddb84831d40b167062f1/tests%2Fregressiontests%2Ftemplates%2Fcustom.py",
            "raw_url": "https://github.com/django/django/raw/950e05c3ff5daa360c3bddb84831d40b167062f1/tests%2Fregressiontests%2Ftemplates%2Fcustom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fcustom.py?ref=950e05c3ff5daa360c3bddb84831d40b167062f1",
            "patch": "@@ -1,3 +1,5 @@\n+from __future__ import with_statement\n+\n from django import template\n from django.utils.unittest import TestCase\n from templatetags import custom\n@@ -102,3 +104,54 @@ def test_15070_use_l10n(self):\n \n         c.use_l10n = True\n         self.assertEquals(t.render(c).strip(), u'True')\n+\n+    def test_assignment_tags(self):\n+        c = template.Context({'value': 42})\n+\n+        t = template.Template('{% load custom %}{% assignment_no_params as var %}The result is: {{ var }}')\n+        self.assertEqual(t.render(c), u'The result is: assignment_no_params - Expected result')\n+\n+        t = template.Template('{% load custom %}{% assignment_one_param 37 as var %}The result is: {{ var }}')\n+        self.assertEqual(t.render(c), u'The result is: assignment_one_param - Expected result: 37')\n+\n+        t = template.Template('{% load custom %}{% assignment_explicit_no_context 37 as var %}The result is: {{ var }}')\n+        self.assertEqual(t.render(c), u'The result is: assignment_explicit_no_context - Expected result: 37')\n+\n+        t = template.Template('{% load custom %}{% assignment_no_params_with_context as var %}The result is: {{ var }}')\n+        self.assertEqual(t.render(c), u'The result is: assignment_no_params_with_context - Expected result (context value: 42)')\n+\n+        t = template.Template('{% load custom %}{% assignment_params_and_context 37 as var %}The result is: {{ var }}')\n+        self.assertEqual(t.render(c), u'The result is: assignment_params_and_context - Expected result (context value: 42): 37')\n+\n+        self.assertRaisesRegexp(template.TemplateSyntaxError,\n+            \"'assignment_one_param' tag takes at least 2 arguments and the second last argument must be 'as'\",\n+            template.Template, '{% load custom %}{% assignment_one_param 37 %}The result is: {{ var }}')\n+\n+        self.assertRaisesRegexp(template.TemplateSyntaxError,\n+            \"'assignment_one_param' tag takes at least 2 arguments and the second last argument must be 'as'\",\n+            template.Template, '{% load custom %}{% assignment_one_param 37 as %}The result is: {{ var }}')\n+\n+        self.assertRaisesRegexp(template.TemplateSyntaxError,\n+            \"'assignment_one_param' tag takes at least 2 arguments and the second last argument must be 'as'\",\n+            template.Template, '{% load custom %}{% assignment_one_param 37 ass var %}The result is: {{ var }}')\n+\n+    def test_assignment_tag_registration(self):\n+        # Test that the decorators preserve the decorated function's docstring, name and attributes.\n+        self.verify_tag(custom.assignment_no_params, 'assignment_no_params')\n+        self.verify_tag(custom.assignment_one_param, 'assignment_one_param')\n+        self.verify_tag(custom.assignment_explicit_no_context, 'assignment_explicit_no_context')\n+        self.verify_tag(custom.assignment_no_params_with_context, 'assignment_no_params_with_context')\n+        self.verify_tag(custom.assignment_params_and_context, 'assignment_params_and_context')\n+\n+    def test_assignment_tag_missing_context(self):\n+        # That the 'context' parameter must be present when takes_context is True\n+        def an_assignment_tag_without_parameters(arg):\n+            \"\"\"Expected __doc__\"\"\"\n+            return \"Expected result\"\n+\n+        register = template.Library()\n+        decorator = register.assignment_tag(takes_context=True)\n+\n+        self.assertRaisesRegexp(template.TemplateSyntaxError,\n+            \"Any tag function decorated with takes_context=True must have a first argument of 'context'\",\n+            decorator, an_assignment_tag_without_parameters)"
        },
        {
            "sha": "2e281f7b0f426f6b5b23c139c0fa79e0089962a1",
            "filename": "tests/regressiontests/templates/templatetags/custom.py",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/950e05c3ff5daa360c3bddb84831d40b167062f1/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "raw_url": "https://github.com/django/django/raw/950e05c3ff5daa360c3bddb84831d40b167062f1/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplatetags%2Fcustom.py?ref=950e05c3ff5daa360c3bddb84831d40b167062f1",
            "patch": "@@ -84,3 +84,33 @@ def use_l10n(context):\n @register.inclusion_tag('test_incl_tag_use_l10n.html', takes_context=True)\n def inclusion_tag_use_l10n(context):\n     return {}\n+\n+@register.assignment_tag\n+def assignment_no_params():\n+    \"\"\"Expected assignment_no_params __doc__\"\"\"\n+    return \"assignment_no_params - Expected result\"\n+assignment_no_params.anything = \"Expected assignment_no_params __dict__\"\n+\n+@register.assignment_tag\n+def assignment_one_param(arg):\n+    \"\"\"Expected assignment_one_param __doc__\"\"\"\n+    return \"assignment_one_param - Expected result: %s\" % arg\n+assignment_one_param.anything = \"Expected assignment_one_param __dict__\"\n+\n+@register.assignment_tag(takes_context=False)\n+def assignment_explicit_no_context(arg):\n+    \"\"\"Expected assignment_explicit_no_context __doc__\"\"\"\n+    return \"assignment_explicit_no_context - Expected result: %s\" % arg\n+assignment_explicit_no_context.anything = \"Expected assignment_explicit_no_context __dict__\"\n+\n+@register.assignment_tag(takes_context=True)\n+def assignment_no_params_with_context(context):\n+    \"\"\"Expected assignment_no_params_with_context __doc__\"\"\"\n+    return \"assignment_no_params_with_context - Expected result (context value: %s)\" % context['value']\n+assignment_no_params_with_context.anything = \"Expected assignment_no_params_with_context __dict__\"\n+\n+@register.assignment_tag(takes_context=True)\n+def assignment_params_and_context(context, arg):\n+    \"\"\"Expected assignment_params_and_context __doc__\"\"\"\n+    return \"assignment_params_and_context - Expected result (context value: %s): %s\" % (context['value'], arg)\n+assignment_params_and_context.anything = \"Expected assignment_params_and_context __dict__\""
        }
    ],
    "stats": {
        "total": 216,
        "additions": 215,
        "deletions": 1
    }
}