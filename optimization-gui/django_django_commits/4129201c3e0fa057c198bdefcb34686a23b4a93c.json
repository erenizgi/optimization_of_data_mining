{
    "author": "apollo13",
    "message": "Fixed a security issue in http redirects. Disclosure and new release forthcoming.",
    "sha": "4129201c3e0fa057c198bdefcb34686a23b4a93c",
    "files": [
        {
            "sha": "19b581f5cb23d4ebc20efa2f9cadb078c84953d4",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/4129201c3e0fa057c198bdefcb34686a23b4a93c/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/4129201c3e0fa057c198bdefcb34686a23b4a93c/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=4129201c3e0fa057c198bdefcb34686a23b4a93c",
            "patch": "@@ -11,10 +11,10 @@\n from io import BytesIO\n from pprint import pformat\n try:\n-    from urllib.parse import quote, parse_qsl, urlencode, urljoin\n+    from urllib.parse import quote, parse_qsl, urlencode, urljoin, urlparse\n except ImportError:     # Python 2\n     from urllib import quote, urlencode\n-    from urlparse import parse_qsl, urljoin\n+    from urlparse import parse_qsl, urljoin, urlparse\n \n from django.utils.six.moves import http_cookies\n # Some versions of Python 2.7 and later won't need this encoding bug fix:\n@@ -80,7 +80,7 @@ def _BaseCookie__set(self, key, real_value, coded_value):\n \n from django.conf import settings\n from django.core import signing\n-from django.core.exceptions import ImproperlyConfigured\n+from django.core.exceptions import ImproperlyConfigured, SuspiciousOperation\n from django.core.files import uploadhandler\n from django.http.multipartparser import MultiPartParser\n from django.http.utils import *\n@@ -689,20 +689,22 @@ def tell(self):\n             raise Exception(\"This %s instance cannot tell its position\" % self.__class__)\n         return sum([len(chunk) for chunk in self])\n \n-class HttpResponseRedirect(HttpResponse):\n-    status_code = 302\n+class HttpResponseRedirectBase(HttpResponse):\n+    allowed_schemes = ['http', 'https', 'ftp']\n \n     def __init__(self, redirect_to):\n-        super(HttpResponseRedirect, self).__init__()\n+        parsed = urlparse(redirect_to)\n+        if parsed.scheme and parsed.scheme not in self.allowed_schemes:\n+            raise SuspiciousOperation(\"Unsafe redirect to URL with protocol '%s'\" % parsed.scheme)\n+        super(HttpResponseRedirectBase, self).__init__()\n         self['Location'] = iri_to_uri(redirect_to)\n+    \n+class HttpResponseRedirect(HttpResponseRedirectBase):\n+    status_code = 302\n \n-class HttpResponsePermanentRedirect(HttpResponse):\n+class HttpResponsePermanentRedirect(HttpResponseRedirectBase):\n     status_code = 301\n \n-    def __init__(self, redirect_to):\n-        super(HttpResponsePermanentRedirect, self).__init__()\n-        self['Location'] = iri_to_uri(redirect_to)\n-\n class HttpResponseNotModified(HttpResponse):\n     status_code = 304\n "
        },
        {
            "sha": "0f61c2d840228d45d26dea0ad6a327bf746b045d",
            "filename": "tests/regressiontests/httpwrappers/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/4129201c3e0fa057c198bdefcb34686a23b4a93c/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4129201c3e0fa057c198bdefcb34686a23b4a93c/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhttpwrappers%2Ftests.py?ref=4129201c3e0fa057c198bdefcb34686a23b4a93c",
            "patch": "@@ -4,8 +4,11 @@\n import copy\n import pickle\n \n-from django.http import (QueryDict, HttpResponse, SimpleCookie, BadHeaderError,\n-        parse_cookie)\n+from django.core.exceptions import SuspiciousOperation\n+from django.http import (QueryDict, HttpResponse, HttpResponseRedirect,\n+                         HttpResponsePermanentRedirect,\n+                         SimpleCookie, BadHeaderError,\n+                         parse_cookie)\n from django.utils import unittest\n \n \n@@ -309,6 +312,18 @@ def test_file_interface(self):\n         r = HttpResponse(['abc'])\n         self.assertRaises(Exception, r.write, 'def')\n \n+    def test_unsafe_redirect(self):\n+        bad_urls = [\n+            'data:text/html,<script>window.alert(\"xss\")</script>',\n+            'mailto:test@example.com',\n+            'file:///etc/passwd',\n+        ]\n+        for url in bad_urls:\n+            self.assertRaises(SuspiciousOperation,\n+                              HttpResponseRedirect, url)\n+            self.assertRaises(SuspiciousOperation,\n+                              HttpResponsePermanentRedirect, url)\n+\n \n class CookieTests(unittest.TestCase):\n     def test_encode(self):"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 30,
        "deletions": 13
    }
}