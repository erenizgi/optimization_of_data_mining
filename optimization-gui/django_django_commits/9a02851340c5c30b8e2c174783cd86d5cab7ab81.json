{
    "author": "claudep",
    "message": "Fixed #17744 -- Reset default file storage with setting_changed signal",
    "sha": "9a02851340c5c30b8e2c174783cd86d5cab7ab81",
    "files": [
        {
            "sha": "a96bdff3b309fc5515e4e151f6df0932b0c6ae10",
            "filename": "django/test/signals.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/9a02851340c5c30b8e2c174783cd86d5cab7ab81/django%2Ftest%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/9a02851340c5c30b8e2c174783cd86d5cab7ab81/django%2Ftest%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsignals.py?ref=9a02851340c5c30b8e2c174783cd86d5cab7ab81",
            "patch": "@@ -5,6 +5,7 @@\n from django.db import connections\n from django.dispatch import receiver, Signal\n from django.utils import timezone\n+from django.utils.functional import empty\n \n template_rendered = Signal(providing_args=[\"template\", \"context\"])\n \n@@ -72,3 +73,9 @@ def language_changed(**kwargs):\n         trans_real._default = None\n         if kwargs['setting'] == 'LOCALE_PATHS':\n             trans_real._translations = {}\n+\n+@receiver(setting_changed)\n+def file_storage_changed(**kwargs):\n+    if kwargs['setting'] in ('MEDIA_ROOT', 'DEFAULT_FILE_STORAGE'):\n+        from django.core.files.storage import default_storage\n+        default_storage._wrapped = empty"
        },
        {
            "sha": "f5fd4fe3e671b032a7929a3b323731a2fd78d4cd",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/9a02851340c5c30b8e2c174783cd86d5cab7ab81/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/9a02851340c5c30b8e2c174783cd86d5cab7ab81/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=9a02851340c5c30b8e2c174783cd86d5cab7ab81",
            "patch": "@@ -1594,15 +1594,16 @@ callbacks to clean up and otherwise reset state when settings are changed.\n \n Django itself uses this signal to reset various data:\n \n-=========================== ========================\n-Overriden settings          Data reset\n-=========================== ========================\n-USE_TZ, TIME_ZONE           Databases timezone\n-TEMPLATE_CONTEXT_PROCESSORS Context processors cache\n-TEMPLATE_LOADERS            Template loaders cache\n-SERIALIZATION_MODULES       Serializers cache\n-LOCALE_PATHS, LANGUAGE_CODE Default translation and loaded translations\n-=========================== ========================\n+================================ ========================\n+Overriden settings               Data reset\n+================================ ========================\n+USE_TZ, TIME_ZONE                Databases timezone\n+TEMPLATE_CONTEXT_PROCESSORS      Context processors cache\n+TEMPLATE_LOADERS                 Template loaders cache\n+SERIALIZATION_MODULES            Serializers cache\n+LOCALE_PATHS, LANGUAGE_CODE      Default translation and loaded translations\n+MEDIA_ROOT, DEFAULT_FILE_STORAGE Default file storage\n+================================ ========================\n \n Emptying the test outbox\n ~~~~~~~~~~~~~~~~~~~~~~~~"
        },
        {
            "sha": "69e30613a8434a31d6c13b8d8714a474099bab9f",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/9a02851340c5c30b8e2c174783cd86d5cab7ab81/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9a02851340c5c30b8e2c174783cd86d5cab7ab81/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=9a02851340c5c30b8e2c174783cd86d5cab7ab81",
            "patch": "@@ -12,7 +12,6 @@\n from django.conf import settings\n from django.core.cache.backends.base import BaseCache\n from django.core.exceptions import ImproperlyConfigured\n-from django.core.files.storage import default_storage\n from django.core.management import call_command\n from django.test import TestCase\n from django.test.utils import override_settings\n@@ -48,10 +47,9 @@ class BaseStaticFilesTestCase(object):\n     Test case with a couple utility assertions.\n     \"\"\"\n     def setUp(self):\n-        # Clear the cached default_storage out, this is because when it first\n-        # gets accessed (by some other test), it evaluates settings.MEDIA_ROOT,\n+        # Clear the cached staticfiles_storage out, this is because when it first\n+        # gets accessed (by some other test), it evaluates settings.STATIC_ROOT,\n         # since we're planning on changing that we need to clear out the cache.\n-        default_storage._wrapped = empty\n         storage.staticfiles_storage._wrapped = empty\n         # Clear the cached staticfile finders, so they are reinitialized every\n         # run and pick up changes in settings.STATICFILES_DIRS.\n@@ -709,9 +707,6 @@ class TestMiscFinder(TestCase):\n     \"\"\"\n     A few misc finder tests.\n     \"\"\"\n-    def setUp(self):\n-        default_storage._wrapped = empty\n-\n     def test_get_finder(self):\n         self.assertIsInstance(finders.get_finder(\n             'django.contrib.staticfiles.finders.FileSystemFinder'),"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 19,
        "deletions": 16
    }
}