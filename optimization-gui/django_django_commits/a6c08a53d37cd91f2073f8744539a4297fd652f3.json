{
    "author": "SmileyChris",
    "message": "Fixes #14543 -- ContentTypes tests failing if auth app is not installed. Thanks for the work on the patch, sayane and crayz_train.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16101 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a6c08a53d37cd91f2073f8744539a4297fd652f3",
    "files": [
        {
            "sha": "fd624c3377791d977d218aa711d12dbb7744c26f",
            "filename": "django/contrib/contenttypes/tests.py",
            "status": "modified",
            "additions": 42,
            "deletions": 5,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/a6c08a53d37cd91f2073f8744539a4297fd652f3/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a6c08a53d37cd91f2073f8744539a4297fd652f3/django%2Fcontrib%2Fcontenttypes%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Ftests.py?ref=a6c08a53d37cd91f2073f8744539a4297fd652f3",
            "patch": "@@ -1,11 +1,33 @@\n+import urllib\n from django import db\n from django.conf import settings\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.sites.models import Site\n from django.contrib.contenttypes.views import shortcut\n-from django.core.exceptions import ObjectDoesNotExist\n-from django.http import HttpRequest\n+from django.http import HttpRequest, Http404\n from django.test import TestCase\n+from django.db import models\n+from django.utils.encoding import smart_str\n+\n+\n+class FooWithoutUrl(models.Model):\n+    \"\"\"\n+    Fake model not defining ``get_absolute_url`` for\n+    :meth:`ContentTypesTests.test_shortcut_view_without_get_absolute_url`\"\"\"\n+    name = models.CharField(max_length=30, unique=True)\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+\n+class FooWithUrl(FooWithoutUrl):\n+    \"\"\"\n+    Fake model defining ``get_absolute_url`` for\n+    :meth:`ContentTypesTests.test_shortcut_view`\n+    \"\"\"\n+\n+    def get_absolute_url(self):\n+        return \"/users/%s/\" % urllib.quote(smart_str(self.name))\n \n \n class ContentTypesTests(TestCase):\n@@ -58,9 +80,8 @@ def test_shortcut_view(self):\n             \"SERVER_NAME\": \"Example.com\",\n             \"SERVER_PORT\": \"80\",\n         }\n-        from django.contrib.auth.models import User\n-        user_ct = ContentType.objects.get_for_model(User)\n-        obj = User.objects.create(username=\"john\")\n+        user_ct = ContentType.objects.get_for_model(FooWithUrl)\n+        obj = FooWithUrl.objects.create(name=\"john\")\n \n         if Site._meta.installed:\n             current_site = Site.objects.get_current()\n@@ -72,3 +93,19 @@ def test_shortcut_view(self):\n         response = shortcut(request, user_ct.id, obj.id)\n         self.assertEqual(\"http://Example.com/users/john/\",\n                          response._headers.get(\"location\")[1])\n+\n+    def test_shortcut_view_without_get_absolute_url(self):\n+        \"\"\"\n+        Check that the shortcut view (used for the admin \"view on site\"\n+        functionality) returns 404 when get_absolute_url is not defined.\n+        \"\"\"\n+\n+        request = HttpRequest()\n+        request.META = {\n+            \"SERVER_NAME\": \"Example.com\",\n+            \"SERVER_PORT\": \"80\",\n+        }\n+        user_ct = ContentType.objects.get_for_model(FooWithoutUrl)\n+        obj = FooWithoutUrl.objects.create(name=\"john\")\n+\n+        self.assertRaises(Http404, shortcut, request, user_ct.id, obj.id)"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 42,
        "deletions": 5
    }
}