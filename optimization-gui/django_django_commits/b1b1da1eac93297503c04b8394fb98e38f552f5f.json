{
    "author": "carljm",
    "message": "Fixed #8060 - Added permissions-checking for admin inlines. Thanks p.patruno for report and Stephan Jaensch for work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16934 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b1b1da1eac93297503c04b8394fb98e38f552f5f",
    "files": [
        {
            "sha": "6be2a64b7c2a21e6ffd665bbc386864891d9042e",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 99,
            "deletions": 50,
            "changes": 149,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -270,6 +270,41 @@ def lookup_allowed(self, lookup, value):\n             clean_lookup = LOOKUP_SEP.join(parts)\n             return clean_lookup in self.list_filter or clean_lookup == self.date_hierarchy\n \n+    def has_add_permission(self, request):\n+        \"\"\"\n+        Returns True if the given request has permission to add an object.\n+        Can be overriden by the user in subclasses.\n+        \"\"\"\n+        opts = self.opts\n+        return request.user.has_perm(opts.app_label + '.' + opts.get_add_permission())\n+\n+    def has_change_permission(self, request, obj=None):\n+        \"\"\"\n+        Returns True if the given request has permission to change the given\n+        Django model instance, the default implementation doesn't examine the\n+        `obj` parameter.\n+\n+        Can be overriden by the user in subclasses. In such case it should\n+        return True if the given request has permission to change the `obj`\n+        model instance. If `obj` is None, this should return True if the given\n+        request has permission to change *any* object of the given type.\n+        \"\"\"\n+        opts = self.opts\n+        return request.user.has_perm(opts.app_label + '.' + opts.get_change_permission())\n+\n+    def has_delete_permission(self, request, obj=None):\n+        \"\"\"\n+        Returns True if the given request has permission to change the given\n+        Django model instance, the default implementation doesn't examine the\n+        `obj` parameter.\n+\n+        Can be overriden by the user in subclasses. In such case it should\n+        return True if the given request has permission to delete the `obj`\n+        model instance. If `obj` is None, this should return True if the given\n+        request has permission to delete *any* object of the given type.\n+        \"\"\"\n+        opts = self.opts\n+        return request.user.has_perm(opts.app_label + '.' + opts.get_delete_permission())\n \n class ModelAdmin(BaseModelAdmin):\n     \"Encapsulates all admin options and functionality for a given model.\"\n@@ -307,10 +342,6 @@ def __init__(self, model, admin_site):\n         self.model = model\n         self.opts = model._meta\n         self.admin_site = admin_site\n-        self.inline_instances = []\n-        for inline_class in self.inlines:\n-            inline_instance = inline_class(self.model, self.admin_site)\n-            self.inline_instances.append(inline_instance)\n         if 'action_checkbox' not in self.list_display and self.actions is not None:\n             self.list_display = ['action_checkbox'] +  list(self.list_display)\n         if not self.list_display_links:\n@@ -320,6 +351,21 @@ def __init__(self, model, admin_site):\n                     break\n         super(ModelAdmin, self).__init__()\n \n+    def get_inline_instances(self, request):\n+        inline_instances = []\n+        for inline_class in self.inlines:\n+            inline = inline_class(self.model, self.admin_site)\n+            if request:\n+                if not (inline.has_add_permission(request) or\n+                        inline.has_change_permission(request) or\n+                        inline.has_delete_permission(request)):\n+                    continue\n+                if not inline.has_add_permission(request):\n+                    inline.max_num = 0\n+            inline_instances.append(inline)\n+\n+        return inline_instances\n+\n     def get_urls(self):\n         from django.conf.urls import patterns, url\n \n@@ -369,42 +415,6 @@ def media(self):\n             js.extend(['getElementsBySelector.js', 'dom-drag.js' , 'admin/ordering.js'])\n         return forms.Media(js=[static('admin/js/%s' % url) for url in js])\n \n-    def has_add_permission(self, request):\n-        \"\"\"\n-        Returns True if the given request has permission to add an object.\n-        Can be overriden by the user in subclasses.\n-        \"\"\"\n-        opts = self.opts\n-        return request.user.has_perm(opts.app_label + '.' + opts.get_add_permission())\n-\n-    def has_change_permission(self, request, obj=None):\n-        \"\"\"\n-        Returns True if the given request has permission to change the given\n-        Django model instance, the default implementation doesn't examine the\n-        `obj` parameter.\n-\n-        Can be overriden by the user in subclasses. In such case it should\n-        return True if the given request has permission to change the `obj`\n-        model instance. If `obj` is None, this should return True if the given\n-        request has permission to change *any* object of the given type.\n-        \"\"\"\n-        opts = self.opts\n-        return request.user.has_perm(opts.app_label + '.' + opts.get_change_permission())\n-\n-    def has_delete_permission(self, request, obj=None):\n-        \"\"\"\n-        Returns True if the given request has permission to change the given\n-        Django model instance, the default implementation doesn't examine the\n-        `obj` parameter.\n-\n-        Can be overriden by the user in subclasses. In such case it should\n-        return True if the given request has permission to delete the `obj`\n-        model instance. If `obj` is None, this should return True if the given\n-        request has permission to delete *any* object of the given type.\n-        \"\"\"\n-        opts = self.opts\n-        return request.user.has_perm(opts.app_label + '.' + opts.get_delete_permission())\n-\n     def get_model_perms(self, request):\n         \"\"\"\n         Returns a dict of all perms for this model. This dict has the keys\n@@ -500,7 +510,7 @@ def get_changelist_formset(self, request, **kwargs):\n             fields=self.list_editable, **defaults)\n \n     def get_formsets(self, request, obj=None):\n-        for inline in self.inline_instances:\n+        for inline in self.get_inline_instances(request):\n             yield inline.get_formset(request, obj)\n \n     def get_paginator(self, request, queryset, per_page, orphans=0, allow_empty_first_page=True):\n@@ -914,6 +924,7 @@ def add_view(self, request, form_url='', extra_context=None):\n \n         ModelForm = self.get_form(request)\n         formsets = []\n+        inline_instances = self.get_inline_instances(request)\n         if request.method == 'POST':\n             form = ModelForm(request.POST, request.FILES)\n             if form.is_valid():\n@@ -923,7 +934,7 @@ def add_view(self, request, form_url='', extra_context=None):\n                 form_validated = False\n                 new_object = self.model()\n             prefixes = {}\n-            for FormSet, inline in zip(self.get_formsets(request), self.inline_instances):\n+            for FormSet, inline in zip(self.get_formsets(request), inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n                 if prefixes[prefix] != 1 or not prefix:\n@@ -951,8 +962,7 @@ def add_view(self, request, form_url='', extra_context=None):\n                     initial[k] = initial[k].split(\",\")\n             form = ModelForm(initial=initial)\n             prefixes = {}\n-            for FormSet, inline in zip(self.get_formsets(request),\n-                                       self.inline_instances):\n+            for FormSet, inline in zip(self.get_formsets(request), inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n                 if prefixes[prefix] != 1 or not prefix:\n@@ -968,7 +978,7 @@ def add_view(self, request, form_url='', extra_context=None):\n         media = self.media + adminForm.media\n \n         inline_admin_formsets = []\n-        for inline, formset in zip(self.inline_instances, formsets):\n+        for inline, formset in zip(inline_instances, formsets):\n             fieldsets = list(inline.get_fieldsets(request))\n             readonly = list(inline.get_readonly_fields(request))\n             prepopulated = dict(inline.get_prepopulated_fields(request))\n@@ -1012,6 +1022,7 @@ def change_view(self, request, object_id, extra_context=None):\n \n         ModelForm = self.get_form(request, obj)\n         formsets = []\n+        inline_instances = self.get_inline_instances(request)\n         if request.method == 'POST':\n             form = ModelForm(request.POST, request.FILES, instance=obj)\n             if form.is_valid():\n@@ -1021,8 +1032,7 @@ def change_view(self, request, object_id, extra_context=None):\n                 form_validated = False\n                 new_object = obj\n             prefixes = {}\n-            for FormSet, inline in zip(self.get_formsets(request, new_object),\n-                                       self.inline_instances):\n+            for FormSet, inline in zip(self.get_formsets(request, new_object), inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n                 if prefixes[prefix] != 1 or not prefix:\n@@ -1043,7 +1053,7 @@ def change_view(self, request, object_id, extra_context=None):\n         else:\n             form = ModelForm(instance=obj)\n             prefixes = {}\n-            for FormSet, inline in zip(self.get_formsets(request, obj), self.inline_instances):\n+            for FormSet, inline in zip(self.get_formsets(request, obj), inline_instances):\n                 prefix = FormSet.get_default_prefix()\n                 prefixes[prefix] = prefixes.get(prefix, 0) + 1\n                 if prefixes[prefix] != 1 or not prefix:\n@@ -1059,7 +1069,7 @@ def change_view(self, request, object_id, extra_context=None):\n         media = self.media + adminForm.media\n \n         inline_admin_formsets = []\n-        for inline, formset in zip(self.inline_instances, formsets):\n+        for inline, formset in zip(inline_instances, formsets):\n             fieldsets = list(inline.get_fieldsets(request, obj))\n             readonly = list(inline.get_readonly_fields(request, obj))\n             prepopulated = dict(inline.get_prepopulated_fields(request, obj))\n@@ -1377,6 +1387,7 @@ def get_formset(self, request, obj=None, **kwargs):\n         # if exclude is an empty list we use None, since that's the actual\n         # default\n         exclude = exclude or None\n+        can_delete = self.can_delete and self.has_delete_permission(request, obj)\n         defaults = {\n             \"form\": self.form,\n             \"formset\": self.formset,\n@@ -1386,7 +1397,7 @@ def get_formset(self, request, obj=None, **kwargs):\n             \"formfield_callback\": partial(self.formfield_for_dbfield, request=request),\n             \"extra\": self.extra,\n             \"max_num\": self.max_num,\n-            \"can_delete\": self.can_delete,\n+            \"can_delete\": can_delete,\n         }\n         defaults.update(kwargs)\n         return inlineformset_factory(self.parent_model, self.model, **defaults)\n@@ -1398,6 +1409,44 @@ def get_fieldsets(self, request, obj=None):\n         fields = form.base_fields.keys() + list(self.get_readonly_fields(request, obj))\n         return [(None, {'fields': fields})]\n \n+    def queryset(self, request):\n+        queryset = super(InlineModelAdmin, self).queryset(request)\n+        if not self.has_change_permission(request):\n+            queryset = queryset.none()\n+        return queryset\n+\n+    def has_add_permission(self, request):\n+        if self.opts.auto_created:\n+            # We're checking the rights to an auto-created intermediate model,\n+            # which doesn't have its own individual permissions. The user needs\n+            # to have the change permission for the related model in order to\n+            # be able to do anything with the intermediate model.\n+            return self.has_change_permission(request)\n+        return request.user.has_perm(\n+            self.opts.app_label + '.' + self.opts.get_add_permission())\n+\n+    def has_change_permission(self, request, obj=None):\n+        opts = self.opts\n+        if opts.auto_created:\n+            # The model was auto-created as intermediary for a\n+            # ManyToMany-relationship, find the target model\n+            for field in opts.fields:\n+                if field.rel and field.rel.to != self.parent_model:\n+                    opts = field.rel.to._meta\n+                    break\n+        return request.user.has_perm(\n+            opts.app_label + '.' + opts.get_change_permission())\n+\n+    def has_delete_permission(self, request, obj=None):\n+        if self.opts.auto_created:\n+            # We're checking the rights to an auto-created intermediate model,\n+            # which doesn't have its own individual permissions. The user needs\n+            # to have the change permission for the related model in order to\n+            # be able to do anything with the intermediate model.\n+            return self.has_change_permission(request, obj)\n+        return request.user.has_perm(\n+            self.opts.app_label + '.' + self.opts.get_delete_permission())\n+\n class StackedInline(InlineModelAdmin):\n     template = 'admin/edit_inline/stacked.html'\n "
        },
        {
            "sha": "9c6048a7eef52c644a767d5a523d99695d09ee16",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -424,14 +424,15 @@ def get_formset(self, request, obj=None, **kwargs):\n             # GenericInlineModelAdmin doesn't define its own.\n             exclude.extend(self.form._meta.exclude)\n         exclude = exclude or None\n+        can_delete = self.can_delete and self.has_delete_permission(request, obj)\n         defaults = {\n             \"ct_field\": self.ct_field,\n             \"fk_field\": self.ct_fk_field,\n             \"form\": self.form,\n             \"formfield_callback\": partial(self.formfield_for_dbfield, request=request),\n             \"formset\": self.formset,\n             \"extra\": self.extra,\n-            \"can_delete\": self.can_delete,\n+            \"can_delete\": can_delete,\n             \"can_order\": False,\n             \"fields\": fields,\n             \"max_num\": self.max_num,"
        },
        {
            "sha": "02e539e6f2e83cf1dc9b272d017a24d893e4bcda",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -1391,11 +1391,17 @@ adds some of its own (the shared features are actually defined in the\n - :attr:`~ModelAdmin.ordering`\n - :meth:`~ModelAdmin.queryset`\n \n+.. versionadded:: 1.4\n+\n+- :meth:`~ModelAdmin.has_add_permission`\n+- :meth:`~ModelAdmin.has_change_permission`\n+- :meth:`~ModelAdmin.has_delete_permission`\n+\n The ``InlineModelAdmin`` class adds:\n \n .. attribute:: InlineModelAdmin.model\n \n-    The model in which the inline is using. This is required.\n+    The model which the inline is using. This is required.\n \n .. attribute:: InlineModelAdmin.fk_name\n "
        },
        {
            "sha": "6a97060f408e02d8fe1f67c086aa21147c338d71",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -128,6 +128,15 @@ A new :meth:`~django.contrib.admin.ModelAdmin.save_related` hook was added to\n :mod:`~django.contrib.admin.ModelAdmin` to ease the customization of how\n related objects are saved in the admin.\n \n+Admin inlines respect user permissions\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+Admin inlines will now only allow those actions for which the user has\n+permission. For ``ManyToMany`` relationships with an auto-created intermediate\n+model (which does not have its own permissions), the change permission for the\n+related model determines if the user has the permission to add, change or\n+delete relationships.\n+\n Tools for cryptographic signing\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "7ab5ba647894d7d11aa41ca3e43b30e336d9905c",
            "filename": "tests/regressiontests/admin_inlines/tests.py",
            "status": "modified",
            "additions": 181,
            "deletions": 2,
            "changes": 183,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -1,11 +1,12 @@\n from django.contrib.admin.helpers import InlineAdminForm\n+from django.contrib.auth.models import User, Permission\n from django.contrib.contenttypes.models import ContentType\n from django.test import TestCase\n \n # local test models\n from models import (Holder, Inner, Holder2, Inner2, Holder3,\n     Inner3, Person, OutfitItem, Fashionista, Teacher, Parent, Child,\n-    CapoFamiglia, Consigliere, SottoCapo)\n+    Author, Book)\n from admin import InnerInline\n \n \n@@ -141,7 +142,6 @@ def test_non_related_name_inline(self):\n                 '<input id=\"id_-2-0-name\" type=\"text\" class=\"vTextField\" '\n                 'name=\"-2-0-name\" maxlength=\"100\" />')\n \n-\n class TestInlineMedia(TestCase):\n     urls = \"regressiontests.admin_inlines.urls\"\n     fixtures = ['admin-views-users.xml']\n@@ -196,3 +196,182 @@ def test_immutable_content_type(self):\n         iaf = InlineAdminForm(None, None, {}, {}, joe)\n         parent_ct = ContentType.objects.get_for_model(Parent)\n         self.assertEqual(iaf.original.content_type, parent_ct)\n+\n+class TestInlinePermissions(TestCase):\n+    \"\"\"\n+    Make sure the admin respects permissions for objects that are edited\n+    inline. Refs #8060.\n+\n+    \"\"\"\n+    urls = \"regressiontests.admin_inlines.urls\"\n+\n+    def setUp(self):\n+        self.user = User(username='admin')\n+        self.user.is_staff = True\n+        self.user.is_active = True\n+        self.user.set_password('secret')\n+        self.user.save()\n+\n+        self.author_ct = ContentType.objects.get_for_model(Author)\n+        self.holder_ct = ContentType.objects.get_for_model(Holder2)\n+        self.book_ct = ContentType.objects.get_for_model(Book)\n+        self.inner_ct = ContentType.objects.get_for_model(Inner2)\n+\n+        # User always has permissions to add and change Authors, and Holders,\n+        # the main (parent) models of the inlines. Permissions on the inlines\n+        # vary per test.\n+        permission = Permission.objects.get(codename='add_author', content_type=self.author_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='change_author', content_type=self.author_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='add_holder2', content_type=self.holder_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='change_holder2', content_type=self.holder_ct)\n+        self.user.user_permissions.add(permission)\n+\n+        author = Author.objects.create(pk=1, name=u'The Author')\n+        author.books.create(name=u'The inline Book')\n+        self.author_change_url = '/admin/admin_inlines/author/%i/' % author.id\n+\n+        holder = Holder2.objects.create(dummy=13)\n+        Inner2.objects.create(dummy=42, holder=holder)\n+        self.holder_change_url = '/admin/admin_inlines/holder2/%i/' % holder.id\n+\n+        self.assertEqual(\n+            self.client.login(username='admin', password='secret'),\n+            True)\n+\n+    def tearDown(self):\n+        self.client.logout()\n+\n+    def test_inline_add_m2m_noperm(self):\n+        response = self.client.get('/admin/admin_inlines/author/add/')\n+        # No change permission on books, so no inline\n+        self.assertNotContains(response, '<h2>Author-book relationships</h2>')\n+        self.assertNotContains(response, 'Add another Author-Book Relationship')\n+        self.assertNotContains(response, 'id=\"id_Author_books-TOTAL_FORMS\"')\n+\n+    def test_inline_add_fk_noperm(self):\n+        response = self.client.get('/admin/admin_inlines/holder2/add/')\n+        # No permissions on Inner2s, so no inline\n+        self.assertNotContains(response, '<h2>Inner2s</h2>')\n+        self.assertNotContains(response, 'Add another Inner2')\n+        self.assertNotContains(response, 'id=\"id_inner2_set-TOTAL_FORMS\"')\n+\n+    def test_inline_change_m2m_noperm(self):\n+        response = self.client.get(self.author_change_url)\n+        # No change permission on books, so no inline\n+        self.assertNotContains(response, '<h2>Author-book relationships</h2>')\n+        self.assertNotContains(response, 'Add another Author-Book Relationship')\n+        self.assertNotContains(response, 'id=\"id_Author_books-TOTAL_FORMS\"')\n+\n+    def test_inline_change_fk_noperm(self):\n+        response = self.client.get(self.holder_change_url)\n+        # No permissions on Inner2s, so no inline\n+        self.assertNotContains(response, '<h2>Inner2s</h2>')\n+        self.assertNotContains(response, 'Add another Inner2')\n+        self.assertNotContains(response, 'id=\"id_inner2_set-TOTAL_FORMS\"')\n+\n+    def test_inline_add_m2m_add_perm(self):\n+        permission = Permission.objects.get(codename='add_book', content_type=self.book_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get('/admin/admin_inlines/author/add/')\n+        # No change permission on Books, so no inline\n+        self.assertNotContains(response, '<h2>Author-book relationships</h2>')\n+        self.assertNotContains(response, 'Add another Author-Book Relationship')\n+        self.assertNotContains(response, 'id=\"id_Author_books-TOTAL_FORMS\"')\n+\n+    def test_inline_add_fk_add_perm(self):\n+        permission = Permission.objects.get(codename='add_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get('/admin/admin_inlines/holder2/add/')\n+        # Add permission on inner2s, so we get the inline\n+        self.assertContains(response, '<h2>Inner2s</h2>')\n+        self.assertContains(response, 'Add another Inner2')\n+        self.assertContains(response, 'value=\"3\" id=\"id_inner2_set-TOTAL_FORMS\"')\n+\n+    def test_inline_change_m2m_add_perm(self):\n+        permission = Permission.objects.get(codename='add_book', content_type=self.book_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.author_change_url)\n+        # No change permission on books, so no inline\n+        self.assertNotContains(response, '<h2>Author-book relationships</h2>')\n+        self.assertNotContains(response, 'Add another Author-Book Relationship')\n+        self.assertNotContains(response, 'id=\"id_Author_books-TOTAL_FORMS\"')\n+        self.assertNotContains(response, 'id=\"id_Author_books-0-DELETE\"')\n+\n+    def test_inline_change_m2m_change_perm(self):\n+        permission = Permission.objects.get(codename='change_book', content_type=self.book_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.author_change_url)\n+        # We have change perm on books, so we can add/change/delete inlines\n+        self.assertContains(response, '<h2>Author-book relationships</h2>')\n+        self.assertContains(response, 'Add another Author-Book Relationship')\n+        self.assertContains(response, 'value=\"4\" id=\"id_Author_books-TOTAL_FORMS\"')\n+        self.assertContains(response, '<input type=\"hidden\" name=\"Author_books-0-id\" value=\"1\"')\n+        self.assertContains(response, 'id=\"id_Author_books-0-DELETE\"')\n+\n+    def test_inline_change_fk_add_perm(self):\n+        permission = Permission.objects.get(codename='add_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.holder_change_url)\n+        # Add permission on inner2s, so we can add but not modify existing\n+        self.assertContains(response, '<h2>Inner2s</h2>')\n+        self.assertContains(response, 'Add another Inner2')\n+        # 3 extra forms only, not the existing instance form\n+        self.assertContains(response, 'value=\"3\" id=\"id_inner2_set-TOTAL_FORMS\"')\n+        self.assertNotContains(response, '<input type=\"hidden\" name=\"inner2_set-0-id\" value=\"1\"')\n+\n+    def test_inline_change_fk_change_perm(self):\n+        permission = Permission.objects.get(codename='change_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.holder_change_url)\n+        # Change permission on inner2s, so we can change existing but not add new\n+        self.assertContains(response, '<h2>Inner2s</h2>')\n+        # Just the one form for existing instances\n+        self.assertContains(response, 'value=\"1\" id=\"id_inner2_set-TOTAL_FORMS\"')\n+        self.assertContains(response, '<input type=\"hidden\" name=\"inner2_set-0-id\" value=\"1\"')\n+        # max-num 0 means we can't add new ones\n+        self.assertContains(response, 'value=\"0\" id=\"id_inner2_set-MAX_NUM_FORMS\"')\n+\n+    def test_inline_change_fk_add_change_perm(self):\n+        permission = Permission.objects.get(codename='add_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='change_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.holder_change_url)\n+        # Add/change perm, so we can add new and change existing\n+        self.assertContains(response, '<h2>Inner2s</h2>')\n+        # One form for existing instance and three extra for new\n+        self.assertContains(response, 'value=\"4\" id=\"id_inner2_set-TOTAL_FORMS\"')\n+        self.assertContains(response, '<input type=\"hidden\" name=\"inner2_set-0-id\" value=\"1\"')\n+\n+\n+    def test_inline_change_fk_change_del_perm(self):\n+        permission = Permission.objects.get(codename='change_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='delete_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.holder_change_url)\n+        # Change/delete perm on inner2s, so we can change/delete existing\n+        self.assertContains(response, '<h2>Inner2s</h2>')\n+        # One form for existing instance only, no new\n+        self.assertContains(response, 'value=\"1\" id=\"id_inner2_set-TOTAL_FORMS\"')\n+        self.assertContains(response, '<input type=\"hidden\" name=\"inner2_set-0-id\" value=\"1\"')\n+        self.assertContains(response, 'id=\"id_inner2_set-0-DELETE\"')\n+\n+\n+    def test_inline_change_fk_all_perms(self):\n+        permission = Permission.objects.get(codename='add_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='change_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        permission = Permission.objects.get(codename='delete_inner2', content_type=self.inner_ct)\n+        self.user.user_permissions.add(permission)\n+        response = self.client.get(self.holder_change_url)\n+        # All perms on inner2s, so we can add/change/delete\n+        self.assertContains(response, '<h2>Inner2s</h2>')\n+        # One form for existing instance only, three for new\n+        self.assertContains(response, 'value=\"4\" id=\"id_inner2_set-TOTAL_FORMS\"')\n+        self.assertContains(response, '<input type=\"hidden\" name=\"inner2_set-0-id\" value=\"1\"')\n+        self.assertContains(response, 'id=\"id_inner2_set-0-DELETE\"')"
        },
        {
            "sha": "9c14706aa5d6d65987f84a8698df4e1301ea0480",
            "filename": "tests/regressiontests/admin_ordering/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fadmin_ordering%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fadmin_ordering%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_ordering%2Ftests.py?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -4,6 +4,18 @@\n \n from models import Band, Song, SongInlineDefaultOrdering, SongInlineNewOrdering, DynOrderingBandAdmin\n \n+\n+class MockRequest(object):\n+    pass\n+\n+class MockSuperUser(object):\n+    def has_perm(self, perm):\n+        return True\n+\n+request = MockRequest()\n+request.user = MockSuperUser()\n+\n+\n class TestAdminOrdering(TestCase):\n     \"\"\"\n     Let's make sure that ModelAdmin.queryset uses the ordering we define in\n@@ -26,7 +38,7 @@ def test_default_ordering(self):\n         class.\n         \"\"\"\n         ma = ModelAdmin(Band, None)\n-        names = [b.name for b in ma.queryset(None)]\n+        names = [b.name for b in ma.queryset(request)]\n         self.assertEqual([u'Aerosmith', u'Radiohead', u'Van Halen'], names)\n \n     def test_specified_ordering(self):\n@@ -37,7 +49,7 @@ def test_specified_ordering(self):\n         class BandAdmin(ModelAdmin):\n             ordering = ('rank',) # default ordering is ('name',)\n         ma = BandAdmin(Band, None)\n-        names = [b.name for b in ma.queryset(None)]\n+        names = [b.name for b in ma.queryset(request)]\n         self.assertEqual([u'Radiohead', u'Van Halen', u'Aerosmith'], names)\n \n     def test_dynamic_ordering(self):\n@@ -79,13 +91,13 @@ def test_default_ordering(self):\n         class.\n         \"\"\"\n         inline = SongInlineDefaultOrdering(self.b, None)\n-        names = [s.name for s in inline.queryset(None)]\n+        names = [s.name for s in inline.queryset(request)]\n         self.assertEqual([u'Dude (Looks Like a Lady)', u'Jaded', u'Pink'], names)\n \n     def test_specified_ordering(self):\n         \"\"\"\n         Let's check with ordering set to something different than the default.\n         \"\"\"\n         inline = SongInlineNewOrdering(self.b, None)\n-        names = [s.name for s in inline.queryset(None)]\n-        self.assertEqual([u'Jaded', u'Pink', u'Dude (Looks Like a Lady)'], names)\n\\ No newline at end of file\n+        names = [s.name for s in inline.queryset(request)]\n+        self.assertEqual([u'Jaded', u'Pink', u'Dude (Looks Like a Lady)'], names)"
        },
        {
            "sha": "baea85717bded90235262aaf8d9c632f7f4a4b15",
            "filename": "tests/regressiontests/generic_inline_admin/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -216,6 +216,18 @@ def test_no_deletion(self):\n         formset = inline.get_formset(fake_request)\n         self.assertFalse(formset.can_delete)\n \n+\n+class MockRequest(object):\n+    pass\n+\n+class MockSuperUser(object):\n+    def has_perm(self, perm):\n+        return True\n+\n+request = MockRequest()\n+request.user = MockSuperUser()\n+\n+\n class GenericInlineModelAdminTest(TestCase):\n     urls = \"regressiontests.generic_inline_admin.urls\"\n \n@@ -226,12 +238,12 @@ def test_get_formset_kwargs(self):\n         media_inline = MediaInline(Media, AdminSite())\n \n         # Create a formset with default arguments\n-        formset = media_inline.get_formset(None)\n+        formset = media_inline.get_formset(request)\n         self.assertEqual(formset.max_num, None)\n         self.assertEqual(formset.can_order, False)\n \n         # Create a formset with custom keyword arguments\n-        formset = media_inline.get_formset(None, max_num=100, can_order=True)\n+        formset = media_inline.get_formset(request, max_num=100, can_order=True)\n         self.assertEqual(formset.max_num, 100)\n         self.assertEqual(formset.can_order, True)\n \n@@ -241,9 +253,6 @@ def test_custom_form_meta_exclude_with_readonly(self):\n         used in conjunction with `GenericInlineModelAdmin.readonly_fields`\n         and when no `ModelAdmin.exclude` is defined.\n         \"\"\"\n-\n-        request = None\n-\n         class MediaForm(ModelForm):\n \n             class Meta:\n@@ -272,9 +281,6 @@ def test_custom_form_meta_exclude(self):\n         `ModelAdmin.exclude` or `GenericInlineModelAdmin.exclude` are defined.\n         Refs #15907.\n         \"\"\"\n-\n-        request = None\n-\n         # First with `GenericInlineModelAdmin`  -----------------\n \n         class MediaForm(ModelForm):"
        },
        {
            "sha": "1e8c12e5bcdf90daa72f1370f79f6fa1b5ec5794",
            "filename": "tests/regressiontests/modeladmin/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b1b1da1eac93297503c04b8394fb98e38f552f5f/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodeladmin%2Ftests.py?ref=b1b1da1eac93297503c04b8394fb98e38f552f5f",
            "patch": "@@ -19,9 +19,15 @@\n     ValidationTestInlineModel)\n \n \n-# None of the following tests really depend on the content of the request,\n-# so we'll just pass in None.\n-request = None\n+class MockRequest(object):\n+    pass\n+\n+class MockSuperUser(object):\n+    def has_perm(self, perm):\n+        return True\n+\n+request = MockRequest()\n+request.user = MockSuperUser()\n \n \n class ModelAdminTests(TestCase):\n@@ -357,9 +363,10 @@ class BandAdmin(ModelAdmin):\n \n         concert = Concert.objects.create(main_band=self.band, opening_band=self.band, day=1)\n         ma = BandAdmin(Band, self.site)\n-        fieldsets = list(ma.inline_instances[0].get_fieldsets(request))\n+        inline_instances = ma.get_inline_instances(request)\n+        fieldsets = list(inline_instances[0].get_fieldsets(request))\n         self.assertEqual(fieldsets[0][1]['fields'], ['main_band', 'opening_band', 'day', 'transport'])\n-        fieldsets = list(ma.inline_instances[0].get_fieldsets(request, ma.inline_instances[0].model))\n+        fieldsets = list(inline_instances[0].get_fieldsets(request, inline_instances[0].model))\n         self.assertEqual(fieldsets[0][1]['fields'], ['day'])\n \n     # radio_fields behavior ###########################################"
        }
    ],
    "stats": {
        "total": 413,
        "additions": 341,
        "deletions": 72
    }
}