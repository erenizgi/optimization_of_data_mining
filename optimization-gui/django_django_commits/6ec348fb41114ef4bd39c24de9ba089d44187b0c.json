{
    "author": "jezdez",
    "message": "Fixed #13726 -- Further refine changes made in r12384 and r13069 for using non-English source languages in JavaScript translation catalogues. Thanks, Ramiro.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14901 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6ec348fb41114ef4bd39c24de9ba089d44187b0c",
    "files": [
        {
            "sha": "bfb4bfaca12e2ad44a72ea58e1c0e0c54aede047",
            "filename": "django/views/i18n.py",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/6ec348fb41114ef4bd39c24de9ba089d44187b0c/django%2Fviews%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/6ec348fb41114ef4bd39c24de9ba089d44187b0c/django%2Fviews%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fi18n.py?ref=6ec348fb41114ef4bd39c24de9ba089d44187b0c",
            "patch": "@@ -194,7 +194,8 @@ def javascript_catalog(request, domain='djangojs', packages=None):\n     locale = to_locale(get_language())\n     t = {}\n     paths = []\n-    en_catalog_missing = False\n+    en_selected = locale.startswith('en')\n+    en_catalog_missing = True\n     # first load all english languages files for defaults\n     for package in packages:\n         p = importlib.import_module(package)\n@@ -204,13 +205,12 @@ def javascript_catalog(request, domain='djangojs', packages=None):\n             catalog = gettext_module.translation(domain, path, ['en'])\n             t.update(catalog._catalog)\n         except IOError:\n-            # 'en' catalog was missing.\n-            if locale.startswith('en'):\n-                # If 'en' is the selected language this would cause issues\n-                # later on if default_locale is something other than 'en'.\n-                en_catalog_missing = True\n-            # Otherwise it is harmless.\n             pass\n+        else:\n+            # 'en' is the selected language and at least one of the packages\n+            # listed in `packages` has an 'en' catalog\n+            if en_selected:\n+                en_catalog_missing = False\n     # next load the settings.LANGUAGE_CODE translations if it isn't english\n     if default_locale != 'en':\n         for path in paths:\n@@ -222,12 +222,11 @@ def javascript_catalog(request, domain='djangojs', packages=None):\n                 t.update(catalog._catalog)\n     # last load the currently selected language, if it isn't identical to the default.\n     if locale != default_locale:\n-        # If the flag en_catalog_missing has been set, the currently\n-        # selected language is English but it doesn't have a translation\n-        # catalog (presumably due to being the language translated from).\n-        # If that is the case, a wrong language catalog might have been\n-        # loaded in the previous step. It needs to be discarded.\n-        if en_catalog_missing:\n+        # If the currently selected language is English but it doesn't have a\n+        # translation catalog (presumably due to being the language translated\n+        # from) then a wrong language catalog might have been loaded in the\n+        # previous step. It needs to be discarded.\n+        if en_selected and en_catalog_missing:\n             t = {}\n         else:\n             locale_t = {}"
        },
        {
            "sha": "792d6005489ebee62cde02066f19c5521e620451",
            "filename": "tests/regressiontests/views/app0/__init__.py",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Fapp0%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Fapp0%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Fapp0%2F__init__.py?ref=6ec348fb41114ef4bd39c24de9ba089d44187b0c",
            "patch": "@@ -0,0 +1 @@\n+#"
        },
        {
            "sha": "662204a6d78f168ad5b0b2d4056b0ecd62e4e283",
            "filename": "tests/regressiontests/views/app0/locale/en/LC_MESSAGES/djangojs.mo",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Fapp0%2Flocale%2Fen%2FLC_MESSAGES%2Fdjangojs.mo",
            "raw_url": "https://github.com/django/django/raw/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Fapp0%2Flocale%2Fen%2FLC_MESSAGES%2Fdjangojs.mo",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Fapp0%2Flocale%2Fen%2FLC_MESSAGES%2Fdjangojs.mo?ref=6ec348fb41114ef4bd39c24de9ba089d44187b0c"
        },
        {
            "sha": "a458935f9691a6e4831682fe455fbf63e0265f6c",
            "filename": "tests/regressiontests/views/app0/locale/en/LC_MESSAGES/djangojs.po",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Fapp0%2Flocale%2Fen%2FLC_MESSAGES%2Fdjangojs.po",
            "raw_url": "https://github.com/django/django/raw/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Fapp0%2Flocale%2Fen%2FLC_MESSAGES%2Fdjangojs.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Fapp0%2Flocale%2Fen%2FLC_MESSAGES%2Fdjangojs.po?ref=6ec348fb41114ef4bd39c24de9ba089d44187b0c",
            "patch": "@@ -0,0 +1,20 @@\n+# SOME DESCRIPTIVE TITLE.\n+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER\n+# This file is distributed under the same license as the PACKAGE package.\n+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.\n+#\n+#, fuzzy\n+msgid \"\"\n+msgstr \"\"\n+\"Project-Id-Version: PACKAGE VERSION\\n\"\n+\"Report-Msgid-Bugs-To: \\n\"\n+\"POT-Creation-Date: 2007-09-15 19:15+0200\\n\"\n+\"PO-Revision-Date: 2010-05-12 12:41-0300\\n\"\n+\"Last-Translator: FULL NAME <EMAIL@ADDRESS>\\n\"\n+\"Language-Team: LANGUAGE <LL@li.org>\\n\"\n+\"MIME-Version: 1.0\\n\"\n+\"Content-Type: text/plain; charset=UTF-8\\n\"\n+\"Content-Transfer-Encoding: 8bit\\n\"\n+\n+msgid \"il faut traduire cette chaîne de caractères de app0\"\n+msgstr \"this app0 string is to be translated\""
        },
        {
            "sha": "f0b3dc57ec3340b699796b3b814e5f479e9bcdf2",
            "filename": "tests/regressiontests/views/tests/i18n.py",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Ftests%2Fi18n.py",
            "raw_url": "https://github.com/django/django/raw/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Ftests%2Fi18n.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fi18n.py?ref=6ec348fb41114ef4bd39c24de9ba089d44187b0c",
            "patch": "@@ -43,9 +43,12 @@ class JsI18NTests(TestCase):\n \n     def setUp(self):\n         self.old_language_code = settings.LANGUAGE_CODE\n+        self.old_installed_apps = settings.INSTALLED_APPS\n \n     def tearDown(self):\n+        deactivate()\n         settings.LANGUAGE_CODE = self.old_language_code\n+        settings.INSTALLED_APPS = self.old_installed_apps\n \n     def test_jsi18n_with_missing_en_files(self):\n         \"\"\"\n@@ -75,14 +78,26 @@ def test_jsi18n_fallback_language(self):\n     def testI18NLanguageNonEnglishDefault(self):\n         \"\"\"\n         Check if the Javascript i18n view returns an empty language catalog\n-        if the default language is non-English but the selected language\n-        is English. See #13388 and #3594 for more details.\n+        if the default language is non-English, the selected language\n+        is English and there is not 'en' translation available. See #13388,\n+        #3594 and #13726 for more details.\n         \"\"\"\n         settings.LANGUAGE_CODE = 'fr'\n         activate('en-us')\n         response = self.client.get('/views/jsi18n/')\n         self.assertNotContains(response, 'Choisir une heure')\n-        deactivate()\n+\n+    def test_nonenglish_default_english_userpref(self):\n+        \"\"\"\n+        Same as above with the difference that there IS an 'en' translation\n+        available. The Javascript i18n view must return a NON empty language catalog\n+        with the proper English translations. See #13726 for more details.\n+        \"\"\"\n+        settings.LANGUAGE_CODE = 'fr'\n+        settings.INSTALLED_APPS = list(settings.INSTALLED_APPS) + ['regressiontests.views.app0']\n+        activate('en-us')\n+        response = self.client.get('/views/jsi18n_english_translation/')\n+        self.assertContains(response, javascript_quote('this app0 string is to be translated'))\n \n     def testI18NLanguageNonEnglishFallback(self):\n         \"\"\"\n@@ -93,7 +108,6 @@ def testI18NLanguageNonEnglishFallback(self):\n         activate('none')\n         response = self.client.get('/views/jsi18n/')\n         self.assertContains(response, 'Choisir une heure')\n-        deactivate()\n \n \n class JsI18NTestsMultiPackage(TestCase):"
        },
        {
            "sha": "0b46d115bf1110ce6438a30febf0bf23eb615bbc",
            "filename": "tests/regressiontests/views/urls.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/6ec348fb41114ef4bd39c24de9ba089d44187b0c/tests%2Fregressiontests%2Fviews%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Furls.py?ref=6ec348fb41114ef4bd39c24de9ba089d44187b0c",
            "patch": "@@ -16,6 +16,11 @@\n     'packages': ('regressiontests.views',),\n }\n \n+js_info_dict_english_translation = {\n+    'domain': 'djangojs',\n+    'packages': ('regressiontests.views.app0',),\n+}\n+\n js_info_dict_multi_packages1 = {\n     'domain': 'djangojs',\n     'packages': ('regressiontests.views.app1', 'regressiontests.views.app2'),\n@@ -56,6 +61,7 @@\n     # i18n views\n     (r'^i18n/', include('django.conf.urls.i18n')),\n     (r'^jsi18n/$', 'django.views.i18n.javascript_catalog', js_info_dict),\n+    (r'^jsi18n_english_translation/$', 'django.views.i18n.javascript_catalog', js_info_dict_english_translation),\n     (r'^jsi18n_multi_packages1/$', 'django.views.i18n.javascript_catalog', js_info_dict_multi_packages1),\n     (r'^jsi18n_multi_packages2/$', 'django.views.i18n.javascript_catalog', js_info_dict_multi_packages2),\n "
        }
    ],
    "stats": {
        "total": 74,
        "additions": 57,
        "deletions": 17
    }
}