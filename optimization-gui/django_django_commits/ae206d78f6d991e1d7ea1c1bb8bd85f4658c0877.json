{
    "author": "jphalip",
    "message": "Fixed #17646 -- Added a get_list_filter() method to ModelAdmin. Thanks to rasca for the suggestion and to mateusgondim for the patch.",
    "sha": "ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877",
    "files": [
        {
            "sha": "c6478350579cdb34742fb8cf2c0e2b8dd001d024",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877",
            "patch": "@@ -665,6 +665,13 @@ def get_list_display_links(self, request, list_display):\n             # Use only the first item in list_display as link\n             return list(list_display)[:1]\n \n+    def get_list_filter(self, request):\n+        \"\"\"\n+        Returns a sequence containing the fields to be displayed as filters in\n+        the right sidebar of the changelist page.\n+        \"\"\"\n+        return self.list_filter\n+\n     def construct_change_message(self, request, form, formsets):\n         \"\"\"\n         Construct a change message from a changed object.\n@@ -1192,6 +1199,7 @@ def changelist_view(self, request, extra_context=None):\n \n         list_display = self.get_list_display(request)\n         list_display_links = self.get_list_display_links(request, list_display)\n+        list_filter = self.get_list_filter(request)\n \n         # Check actions to see if any are available on this changelist\n         actions = self.get_actions(request)\n@@ -1202,7 +1210,7 @@ def changelist_view(self, request, extra_context=None):\n         ChangeList = self.get_changelist(request)\n         try:\n             cl = ChangeList(request, self.model, list_display,\n-                list_display_links, self.list_filter, self.date_hierarchy,\n+                list_display_links, list_filter, self.date_hierarchy,\n                 self.search_fields, self.list_select_related,\n                 self.list_per_page, self.list_max_show_all, self.list_editable,\n                 self)"
        },
        {
            "sha": "6f79e97a3ce9f697ea558a4a096f3ce53de49def",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877",
            "patch": "@@ -570,8 +570,8 @@ subclass::\n \n     .. image:: _images/users_changelist.png\n \n-    ``list_filter`` should be a list of elements, where each element should be\n-    of one of the following types:\n+    ``list_filter`` should be a list or tuple of elements, where each element\n+    should be of one of the following types:\n \n     * a field name, where the specified field should be either a\n       ``BooleanField``, ``CharField``, ``DateField``, ``DateTimeField``,\n@@ -1076,6 +1076,14 @@ templates used by the :class:`ModelAdmin` views:\n     changelist that will be linked to the change view, as described in the\n     :attr:`ModelAdmin.list_display_links` section.\n \n+.. method:: ModelAdmin.get_list_filter(self, request)\n+\n+    .. versionadded:: 1.5\n+\n+    The ``get_list_filter`` method is given the ``HttpRequest`` and is expected\n+    to return the same kind of sequence type as for the\n+    :attr:`~ModelAdmin.list_filter` attribute.\n+\n .. method:: ModelAdmin.get_inline_instances(self, request, obj=None)\n \n     .. versionadded:: 1.5"
        },
        {
            "sha": "0595a226e2f3cf145fef335deb853992e374ca16",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877",
            "patch": "@@ -318,6 +318,9 @@ Django 1.5 also includes several smaller improvements worth noting:\n   :func:`django.contrib.messages.add_message`. This is useful for generating\n   error messages from admin actions.\n \n+* The admin's list filters can now be customized per-request thanks to the new\n+  :meth:`django.contrib.admin.ModelAdmin.get_list_filter` method.\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        },
        {
            "sha": "5751d04bce658a2fdf4fc24dd74a1e61f977d565",
            "filename": "tests/regressiontests/admin_changelist/admin.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fadmin.py?ref=ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877",
            "patch": "@@ -32,6 +32,7 @@ class ParentAdmin(admin.ModelAdmin):\n class ChildAdmin(admin.ModelAdmin):\n     list_display = ['name', 'parent']\n     list_per_page = 10\n+    list_filter = ['parent', 'age']\n \n     def queryset(self, request):\n         return super(ChildAdmin, self).queryset(request).select_related(\"parent__name\")\n@@ -90,3 +91,14 @@ class SwallowAdmin(admin.ModelAdmin):\n     list_display = ('origin', 'load', 'speed')\n \n site.register(Swallow, SwallowAdmin)\n+\n+class DynamicListFilterChildAdmin(admin.ModelAdmin):\n+    list_filter = ('parent', 'name', 'age')\n+\n+    def get_list_filter(self, request):\n+        my_list_filter = super(DynamicListFilterChildAdmin, self).get_list_filter(request)\n+        if request.user.username == 'noparents':\n+            my_list_filter = list(my_list_filter)\n+            my_list_filter.remove('parent')\n+        return my_list_filter\n+"
        },
        {
            "sha": "e8d4cbff162b337ab14807875c901968aaec2224",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=ae206d78f6d991e1d7ea1c1bb8bd85f4658c0877",
            "patch": "@@ -17,7 +17,7 @@\n     GroupAdmin, ParentAdmin, DynamicListDisplayChildAdmin,\n     DynamicListDisplayLinksChildAdmin, CustomPaginationAdmin,\n     FilteredChildAdmin, CustomPaginator, site as custom_site,\n-    SwallowAdmin)\n+    SwallowAdmin, DynamicListFilterChildAdmin)\n from .models import (Event, Child, Parent, Genre, Band, Musician, Group,\n     Quartet, Membership, ChordsMusician, ChordsBand, Invitation, Swallow,\n     UnorderedObject, OrderedObject)\n@@ -541,3 +541,26 @@ def check_results_order(ascending=False):\n         check_results_order()\n         OrderedObjectAdmin.ordering = ['id', 'bool']\n         check_results_order(ascending=True)\n+\n+    def test_dynamic_list_filter(self):\n+        \"\"\"\n+        Regression tests for ticket #17646: dynamic list_filter support.\n+        \"\"\"\n+        parent = Parent.objects.create(name='parent')\n+        for i in range(10):\n+            Child.objects.create(name='child %s' % i, parent=parent)\n+\n+        user_noparents = self._create_superuser('noparents')\n+        user_parents = self._create_superuser('parents')\n+\n+        # Test with user 'noparents'\n+        m =  DynamicListFilterChildAdmin(Child, admin.site)\n+        request = self._mocked_authenticated_request('/child/', user_noparents)\n+        response = m.changelist_view(request)\n+        self.assertEqual(response.context_data['cl'].list_filter, ['name', 'age'])\n+\n+        # Test with user 'parents'\n+        m = DynamicListFilterChildAdmin(Child, admin.site)\n+        request = self._mocked_authenticated_request('/child/', user_parents)\n+        response = m.changelist_view(request)\n+        self.assertEqual(response.context_data['cl'].list_filter, ('parent', 'name', 'age'))"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 58,
        "deletions": 4
    }
}