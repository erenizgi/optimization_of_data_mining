{
    "author": "ramiro",
    "message": "Fixed #13630 -- Made __init__ methods of all DB backends' DatabaseOperations classes take a `connection` argument. Thanks calexium for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16016 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "30b3d51599aed4cf08ccace9ba5b1277ded78439",
    "files": [
        {
            "sha": "e7ad04840efefd46264e5f88ef26555d7a146e88",
            "filename": "django/contrib/gis/db/backends/oracle/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Foracle%2Foperations.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -133,8 +133,7 @@ class OracleOperations(DatabaseOperations, BaseSpatialOperations):\n     truncate_params = {'relate' : None}\n \n     def __init__(self, connection):\n-        super(OracleOperations, self).__init__()\n-        self.connection = connection\n+        super(OracleOperations, self).__init__(connection)\n \n     def convert_extent(self, clob):\n         if clob:"
        },
        {
            "sha": "f3bf3e5a569504779acaa2f78608e047454827b1",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -110,8 +110,7 @@ class SpatiaLiteOperations(DatabaseOperations, BaseSpatialOperations):\n     geometry_functions.update(distance_functions)\n \n     def __init__(self, connection):\n-        super(DatabaseOperations, self).__init__()\n-        self.connection = connection\n+        super(DatabaseOperations, self).__init__(connection)\n \n         # Determine the version of the SpatiaLite library.\n         try:"
        },
        {
            "sha": "4b845d51357758a8e2f1962df79f6643139a316c",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -388,7 +388,8 @@ class BaseDatabaseOperations(object):\n     \"\"\"\n     compiler_module = \"django.db.models.sql.compiler\"\n \n-    def __init__(self):\n+    def __init__(self, connection):\n+        self.connection = connection\n         self._cache = None\n \n     def autoinc_sql(self, table, column):"
        },
        {
            "sha": "7de48c8b008b0179080d0f9280623c7e7e7f0c11",
            "filename": "django/db/backends/dummy/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fdummy%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fdummy%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fdummy%2Fbase.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -59,7 +59,7 @@ def __init__(self, *args, **kwargs):\n         super(DatabaseWrapper, self).__init__(*args, **kwargs)\n \n         self.features = BaseDatabaseFeatures(self)\n-        self.ops = DatabaseOperations()\n+        self.ops = DatabaseOperations(self)\n         self.client = DatabaseClient(self)\n         self.creation = BaseDatabaseCreation(self)\n         self.introspection = DatabaseIntrospection(self)"
        },
        {
            "sha": "630b9805c3de094d8785e777fae2b746ed863c6a",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -23,7 +23,7 @@\n     raise ImproperlyConfigured(\"MySQLdb-1.2.1p2 or newer is required; you have %s\" % Database.__version__)\n \n from MySQLdb.converters import conversions\n-from MySQLdb.constants import FIELD_TYPE, FLAG, CLIENT\n+from MySQLdb.constants import FIELD_TYPE, CLIENT\n \n from django.db import utils\n from django.db.backends import *\n@@ -279,7 +279,7 @@ def __init__(self, *args, **kwargs):\n \n         self.server_version = None\n         self.features = DatabaseFeatures(self)\n-        self.ops = DatabaseOperations()\n+        self.ops = DatabaseOperations(self)\n         self.client = DatabaseClient(self)\n         self.creation = DatabaseCreation(self)\n         self.introspection = DatabaseIntrospection(self)"
        },
        {
            "sha": "a477c8d9741cd2988291b2d9b2cc00b975dc3cf8",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 16,
            "deletions": 18,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -84,8 +84,8 @@ class DatabaseOperations(BaseDatabaseOperations):\n     def autoinc_sql(self, table, column):\n         # To simulate auto-incrementing primary keys in Oracle, we have to\n         # create a sequence and a trigger.\n-        sq_name = get_sequence_name(table)\n-        tr_name = get_trigger_name(table)\n+        sq_name = self._get_sequence_name(table)\n+        tr_name = self._get_trigger_name(table)\n         tbl_name = self.quote_name(table)\n         col_name = self.quote_name(column)\n         sequence_sql = \"\"\"\n@@ -197,7 +197,7 @@ def deferrable_sql(self):\n         return \" DEFERRABLE INITIALLY DEFERRED\"\n \n     def drop_sequence_sql(self, table):\n-        return \"DROP SEQUENCE %s;\" % self.quote_name(get_sequence_name(table))\n+        return \"DROP SEQUENCE %s;\" % self.quote_name(self._get_sequence_name(table))\n \n     def fetch_returned_insert_id(self, cursor):\n         return long(cursor._insert_id_var.getvalue())\n@@ -209,7 +209,7 @@ def field_cast_sql(self, db_type):\n             return \"%s\"\n \n     def last_insert_id(self, cursor, table_name, pk_name):\n-        sq_name = get_sequence_name(table_name)\n+        sq_name = self._get_sequence_name(table_name)\n         cursor.execute('SELECT \"%s\".currval FROM dual' % sq_name)\n         return cursor.fetchone()[0]\n \n@@ -285,7 +285,7 @@ def sql_flush(self, style, tables, sequences):\n             # Since we've just deleted all the rows, running our sequence\n             # ALTER code will reset the sequence to 0.\n             for sequence_info in sequences:\n-                sequence_name = get_sequence_name(sequence_info['table'])\n+                sequence_name = self._get_sequence_name(sequence_info['table'])\n                 table_name = self.quote_name(sequence_info['table'])\n                 column_name = self.quote_name(sequence_info['column'] or 'id')\n                 query = _get_sequence_reset_sql() % {'sequence': sequence_name,\n@@ -304,7 +304,7 @@ def sequence_reset_sql(self, style, model_list):\n             for f in model._meta.local_fields:\n                 if isinstance(f, models.AutoField):\n                     table_name = self.quote_name(model._meta.db_table)\n-                    sequence_name = get_sequence_name(model._meta.db_table)\n+                    sequence_name = self._get_sequence_name(model._meta.db_table)\n                     column_name = self.quote_name(f.column)\n                     output.append(query % {'sequence': sequence_name,\n                                            'table': table_name,\n@@ -315,7 +315,7 @@ def sequence_reset_sql(self, style, model_list):\n             for f in model._meta.many_to_many:\n                 if not f.rel.through:\n                     table_name = self.quote_name(f.m2m_db_table())\n-                    sequence_name = get_sequence_name(f.m2m_db_table())\n+                    sequence_name = self._get_sequence_name(f.m2m_db_table())\n                     column_name = self.quote_name('id')\n                     output.append(query % {'sequence': sequence_name,\n                                            'table': table_name,\n@@ -365,6 +365,14 @@ def combine_expression(self, connector, sub_expressions):\n             raise NotImplementedError(\"Bit-wise or is not supported in Oracle.\")\n         return super(DatabaseOperations, self).combine_expression(connector, sub_expressions)\n \n+    def _get_sequence_name(self, table):\n+        name_length = self.max_name_length() - 3\n+        return '%s_SQ' % util.truncate_name(table, name_length).upper()\n+\n+    def _get_trigger_name(self, table):\n+        name_length = self.max_name_length() - 3\n+        return '%s_TR' % util.truncate_name(table, name_length).upper()\n+\n \n class _UninitializedOperatorsDescriptor(object):\n \n@@ -415,7 +423,7 @@ def __init__(self, *args, **kwargs):\n         self.features = DatabaseFeatures(self)\n         use_returning_into = self.settings_dict[\"OPTIONS\"].get('use_returning_into', True)\n         self.features.can_return_id_from_insert = use_returning_into\n-        self.ops = DatabaseOperations()\n+        self.ops = DatabaseOperations(self)\n         self.client = DatabaseClient(self)\n         self.creation = DatabaseCreation(self)\n         self.introspection = DatabaseIntrospection(self)\n@@ -776,13 +784,3 @@ def _get_sequence_reset_sql():\n     END LOOP;\n END;\n /\"\"\"\n-\n-\n-def get_sequence_name(table):\n-    name_length = DatabaseOperations().max_name_length() - 3\n-    return '%s_SQ' % util.truncate_name(table, name_length).upper()\n-\n-\n-def get_trigger_name(table):\n-    name_length = DatabaseOperations().max_name_length() - 3\n-    return '%s_TR' % util.truncate_name(table, name_length).upper()"
        },
        {
            "sha": "4efdb8fa3e3570cba1493503bde6b6657d65ad3a",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -5,9 +5,8 @@\n \n class DatabaseOperations(BaseDatabaseOperations):\n     def __init__(self, connection):\n-        super(DatabaseOperations, self).__init__()\n+        super(DatabaseOperations, self).__init__(connection)\n         self._postgres_version = None\n-        self.connection = connection\n \n     def _get_postgres_version(self):\n         if self._postgres_version is None:"
        },
        {
            "sha": "511e5e963551fb773b0930b39004d2f607b88fa0",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -88,10 +88,10 @@ def date_interval_sql(self, sql, connector, timedelta):\n         # It would be more straightforward if we could use the sqlite strftime\n         # function, but it does not allow for keeping six digits of fractional\n         # second information, nor does it allow for formatting date and datetime\n-        # values differently. So instead we register our own function that \n-        # formats the datetime combined with the delta in a manner suitable \n+        # values differently. So instead we register our own function that\n+        # formats the datetime combined with the delta in a manner suitable\n         # for comparisons.\n-        return  u'django_format_dtdelta(%s, \"%s\", \"%d\", \"%d\", \"%d\")' % (sql, \n+        return  u'django_format_dtdelta(%s, \"%s\", \"%d\", \"%d\", \"%d\")' % (sql,\n             connector, timedelta.days, timedelta.seconds, timedelta.microseconds)\n \n     def date_trunc_sql(self, lookup_type, field_name):\n@@ -179,7 +179,7 @@ def __init__(self, *args, **kwargs):\n         super(DatabaseWrapper, self).__init__(*args, **kwargs)\n \n         self.features = DatabaseFeatures(self)\n-        self.ops = DatabaseOperations()\n+        self.ops = DatabaseOperations(self)\n         self.client = DatabaseClient(self)\n         self.creation = DatabaseCreation(self)\n         self.introspection = DatabaseIntrospection(self)"
        },
        {
            "sha": "a6bac5a009dc1a0ca2dfefd6f4753bfdf9ee789d",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/30b3d51599aed4cf08ccace9ba5b1277ded78439/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/30b3d51599aed4cf08ccace9ba5b1277ded78439/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=30b3d51599aed4cf08ccace9ba5b1277ded78439",
            "patch": "@@ -232,6 +232,12 @@ def test_unicode_fetches(self):\n         self.assertEqual(list(cursor.fetchmany(2)), [(u'Jane', u'Doe'), (u'John', u'Doe')])\n         self.assertEqual(list(cursor.fetchall()), [(u'Mary', u'Agnelline'), (u'Peter', u'Parker')])\n \n+    def test_database_operations_helper_class(self):\n+        # Ticket #13630\n+        self.assertTrue(hasattr(connection, 'ops'))\n+        self.assertTrue(hasattr(connection.ops, 'connection'))\n+        self.assertEqual(connection, connection.ops.connection)\n+\n \n # We don't make these tests conditional because that means we would need to\n # check and differentiate between:"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 34,
        "deletions": 32
    }
}