{
    "author": "spookylukey",
    "message": "Fixed #15823 - incorrect join condition when combining Q objects\n\nThanks to dcwatson for the excellent report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16159 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "db5807bdb1f242cc928e2fdf7110cb20af34790f",
    "files": [
        {
            "sha": "9a5666b143a814252ddb82a73273221c762b0115",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/db5807bdb1f242cc928e2fdf7110cb20af34790f/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/db5807bdb1f242cc928e2fdf7110cb20af34790f/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=db5807bdb1f242cc928e2fdf7110cb20af34790f",
            "patch": "@@ -457,7 +457,11 @@ def combine(self, rhs, connector):\n                 # An unused alias.\n                 continue\n             promote = (rhs.alias_map[alias][JOIN_TYPE] == self.LOUTER)\n-            new_alias = self.join(rhs.rev_join_map[alias],\n+            lhs, table, lhs_col, col = rhs.rev_join_map[alias]\n+            # If the left side of the join was already relabeled, use the\n+            # updated alias.\n+            lhs = change_map.get(lhs, lhs)\n+            new_alias = self.join((lhs, table, lhs_col, col),\n                     (conjunction and not first), used, promote, not conjunction)\n             used.add(new_alias)\n             change_map[alias] = new_alias"
        },
        {
            "sha": "d96118c5c1686e5142850263348c8657dc710580",
            "filename": "tests/regressiontests/null_fk/models.py",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/db5807bdb1f242cc928e2fdf7110cb20af34790f/tests%2Fregressiontests%2Fnull_fk%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/db5807bdb1f242cc928e2fdf7110cb20af34790f/tests%2Fregressiontests%2Fnull_fk%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fnull_fk%2Fmodels.py?ref=db5807bdb1f242cc928e2fdf7110cb20af34790f",
            "patch": "@@ -31,3 +31,16 @@ class Meta:\n \n     def __unicode__(self):\n         return self.comment_text\n+\n+# Ticket 15823\n+\n+class Item(models.Model):\n+    title = models.CharField(max_length=100)\n+\n+class PropertyValue(models.Model):\n+    label = models.CharField(max_length=100)\n+\n+class Property(models.Model):\n+    item = models.ForeignKey(Item, related_name='props')\n+    key = models.CharField(max_length=100)\n+    value = models.ForeignKey(PropertyValue, null=True)"
        },
        {
            "sha": "2825cc9c8b50690f915af0267bc64a4c55159ba1",
            "filename": "tests/regressiontests/null_fk/tests.py",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/db5807bdb1f242cc928e2fdf7110cb20af34790f/tests%2Fregressiontests%2Fnull_fk%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/db5807bdb1f242cc928e2fdf7110cb20af34790f/tests%2Fregressiontests%2Fnull_fk%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fnull_fk%2Ftests.py?ref=db5807bdb1f242cc928e2fdf7110cb20af34790f",
            "patch": "@@ -1,4 +1,5 @@\n from django.test import TestCase\n+from django.db.models import Q\n \n from regressiontests.null_fk.models import *\n \n@@ -40,3 +41,25 @@ def test_null_fk(self):\n             ],\n             transform = lambda c: (c.id, c.comment_text, repr(c.post))\n         )\n+\n+    def test_combine_isnull(self):\n+        item = Item.objects.create(title='Some Item')\n+        pv = PropertyValue.objects.create(label='Some Value')\n+        item.props.create(key='a', value=pv)\n+        item.props.create(key='b') # value=NULL\n+        q1 = Q(props__key='a', props__value=pv)\n+        q2 = Q(props__key='b', props__value__isnull=True)\n+\n+        # Each of these individually should return the item.\n+        self.assertEqual(Item.objects.get(q1), item)\n+        self.assertEqual(Item.objects.get(q2), item)\n+\n+        # Logically, qs1 and qs2, and qs3 and qs4 should be the same.\n+        qs1 = Item.objects.filter(q1) & Item.objects.filter(q2)\n+        qs2 = Item.objects.filter(q2) & Item.objects.filter(q1)\n+        qs3 = Item.objects.filter(q1) | Item.objects.filter(q2)\n+        qs4 = Item.objects.filter(q2) | Item.objects.filter(q1)\n+\n+        # Regression test for #15823.\n+        self.assertEqual(list(qs1), list(qs2))\n+        self.assertEqual(list(qs3), list(qs4))"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 41,
        "deletions": 1
    }
}