{
    "author": "aaugustin",
    "message": "Added support for savepoints in SQLite.\n\nTechnically speaking they aren't usable yet.",
    "sha": "4b31a6a9e698a26e3e359e2ccf3da1505d114cf1",
    "files": [
        {
            "sha": "f537860a531fce6a904b8bb528ff2881c30ffa92",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=4b31a6a9e698a26e3e359e2ccf3da1505d114cf1",
            "patch": "@@ -100,6 +100,10 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     has_bulk_insert = True\n     can_combine_inserts_with_and_without_auto_increment_pk = False\n \n+    @cached_property\n+    def uses_savepoints(self):\n+        return Database.sqlite_version_info >= (3, 6, 8)\n+\n     @cached_property\n     def supports_stddev(self):\n         \"\"\"Confirm support for STDDEV and related stats functions\n@@ -355,6 +359,12 @@ def close(self):\n         if self.settings_dict['NAME'] != \":memory:\":\n             BaseDatabaseWrapper.close(self)\n \n+    def _savepoint_allowed(self):\n+        # When 'isolation_level' is None, Django doesn't provide a way to\n+        # create a transaction (yet) so savepoints can't be created. When it\n+        # isn't, sqlite3 commits before each savepoint -- it's a bug.\n+        return False\n+\n     def _set_autocommit(self, autocommit):\n         if autocommit:\n             level = None"
        },
        {
            "sha": "78c1bb3dda168186800f55f86f82fa74f06af840",
            "filename": "docs/ref/databases.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/docs%2Fref%2Fdatabases.txt",
            "raw_url": "https://github.com/django/django/raw/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/docs%2Fref%2Fdatabases.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdatabases.txt?ref=4b31a6a9e698a26e3e359e2ccf3da1505d114cf1",
            "patch": "@@ -424,8 +424,7 @@ Savepoints\n \n Both the Django ORM and MySQL (when using the InnoDB :ref:`storage engine\n <mysql-storage-engines>`) support database :ref:`savepoints\n-<topics-db-transactions-savepoints>`, but this feature wasn't available in\n-Django until version 1.4 when such support was added.\n+<topics-db-transactions-savepoints>`.\n \n If you use the MyISAM storage engine please be aware of the fact that you will\n receive database-generated errors if you try to use the :ref:`savepoint-related"
        },
        {
            "sha": "e2c8e4e3f529f3fbfe468ebefa395337c8815303",
            "filename": "docs/topics/db/transactions.txt",
            "status": "modified",
            "additions": 25,
            "deletions": 10,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/docs%2Ftopics%2Fdb%2Ftransactions.txt",
            "raw_url": "https://github.com/django/django/raw/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/docs%2Ftopics%2Fdb%2Ftransactions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Ftransactions.txt?ref=4b31a6a9e698a26e3e359e2ccf3da1505d114cf1",
            "patch": "@@ -251,11 +251,11 @@ the transaction middleware, and only modify selected functions as needed.\n Savepoints\n ==========\n \n-A savepoint is a marker within a transaction that enables you to roll back part\n-of a transaction, rather than the full transaction. Savepoints are available\n-with the PostgreSQL 8, Oracle and MySQL (when using the InnoDB storage engine)\n-backends. Other backends provide the savepoint functions, but they're empty\n-operations -- they don't actually do anything.\n+A savepoint is a marker within a transaction that enables you to roll back\n+part of a transaction, rather than the full transaction. Savepoints are\n+available with the SQLite (≥ 3.6.8), PostgreSQL, Oracle and MySQL (when using\n+the InnoDB storage engine) backends. Other backends provide the savepoint\n+functions, but they're empty operations -- they don't actually do anything.\n \n Savepoints aren't especially useful if you are using the default\n ``autocommit`` behavior of Django. However, if you are using\n@@ -314,6 +314,21 @@ The following example demonstrates the use of savepoints::\n Database-specific notes\n =======================\n \n+Savepoints in SQLite\n+--------------------\n+\n+While SQLite ≥ 3.6.8 supports savepoints, a flaw in the design of the\n+:mod:`sqlite3` makes them hardly usable.\n+\n+When autocommit is enabled, savepoints don't make sense. When it's disabled,\n+:mod:`sqlite3` commits implicitly before savepoint-related statement. (It\n+commits before any statement other than ``SELECT``, ``INSERT``, ``UPDATE``,\n+``DELETE`` and ``REPLACE``.)\n+\n+As a consequence, savepoints are only usable if you start a transaction\n+manually while in autocommit mode, and Django doesn't provide an API to\n+achieve that.\n+\n Transactions in MySQL\n ---------------------\n \n@@ -363,11 +378,11 @@ itself.\n Savepoint rollback\n ~~~~~~~~~~~~~~~~~~\n \n-If you are using PostgreSQL 8 or later, you can use :ref:`savepoints\n-<topics-db-transactions-savepoints>` to control the extent of a rollback.\n-Before performing a database operation that could fail, you can set or update\n-the savepoint; that way, if the operation fails, you can roll back the single\n-offending operation, rather than the entire transaction. For example::\n+You can use :ref:`savepoints <topics-db-transactions-savepoints>` to control\n+the extent of a rollback. Before performing a database operation that could\n+fail, you can set or update the savepoint; that way, if the operation fails,\n+you can roll back the single offending operation, rather than the entire\n+transaction. For example::\n \n     a.save() # Succeeds, and never undone by savepoint rollback\n     try:"
        },
        {
            "sha": "e86db4d0aaad25b42bf812bcfdd9876ac3ccb120",
            "filename": "tests/transactions_regress/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/tests%2Ftransactions_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4b31a6a9e698a26e3e359e2ccf3da1505d114cf1/tests%2Ftransactions_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Ftransactions_regress%2Ftests.py?ref=4b31a6a9e698a26e3e359e2ccf3da1505d114cf1",
            "patch": "@@ -309,6 +309,8 @@ def test_manyrelated_add_commit(self):\n \n class SavepointTest(TransactionTestCase):\n \n+    @skipIf(connection.vendor == 'sqlite',\n+            \"SQLite doesn't support savepoints in managed mode\")\n     @skipUnlessDBFeature('uses_savepoints')\n     def test_savepoint_commit(self):\n         @commit_manually\n@@ -324,6 +326,8 @@ def work():\n \n         work()\n \n+    @skipIf(connection.vendor == 'sqlite',\n+            \"SQLite doesn't support savepoints in managed mode\")\n     @skipIf(connection.vendor == 'mysql' and\n             connection.features._mysql_storage_engine == 'MyISAM',\n             \"MyISAM MySQL storage engine doesn't support savepoints\")"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 40,
        "deletions": 12
    }
}