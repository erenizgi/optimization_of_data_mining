{
    "author": "ramiro",
    "message": "Don't use os.system() in compilemessages.\n\nFixes #19584.\n\nThis implies stop storing file path command line arguments in envvars as\na security measure to start relying on with Popen's shell=False instead,\nand addition of an 'utils' module.\n\nThanks kmichel_wgs for the report.",
    "sha": "dfa9324966ce1a38346d15e35805d042848aabf1",
    "files": [
        {
            "sha": "2ca42d1c63eb63ac1339543be795a1495ced218f",
            "filename": "django/core/management/commands/compilemessages.py",
            "status": "modified",
            "additions": 11,
            "deletions": 13,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/dfa9324966ce1a38346d15e35805d042848aabf1/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py",
            "raw_url": "https://github.com/django/django/raw/dfa9324966ce1a38346d15e35805d042848aabf1/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcompilemessages.py?ref=dfa9324966ce1a38346d15e35805d042848aabf1",
            "patch": "@@ -2,9 +2,10 @@\n \n import codecs\n import os\n-import sys\n from optparse import make_option\n+\n from django.core.management.base import BaseCommand, CommandError\n+from django.core.management.utils import popen_wrapper\n from django.utils._os import npath\n \n def has_bom(fn):\n@@ -41,18 +42,15 @@ def compile_messages(stderr, locale=None):\n                     if has_bom(fn):\n                         raise CommandError(\"The %s file has a BOM (Byte Order Mark). Django only supports .po files encoded in UTF-8 and without any BOM.\" % fn)\n                     pf = os.path.splitext(fn)[0]\n-                    # Store the names of the .mo and .po files in an environment\n-                    # variable, rather than doing a string replacement into the\n-                    # command, so that we can take advantage of shell quoting, to\n-                    # quote any malicious characters/escaping.\n-                    # See http://cyberelk.net/tim/articles/cmdline/ar01s02.html\n-                    os.environ['djangocompilemo'] = npath(pf + '.mo')\n-                    os.environ['djangocompilepo'] = npath(pf + '.po')\n-                    if sys.platform == 'win32': # Different shell-variable syntax\n-                        cmd = 'msgfmt --check-format -o \"%djangocompilemo%\" \"%djangocompilepo%\"'\n-                    else:\n-                        cmd = 'msgfmt --check-format -o \"$djangocompilemo\" \"$djangocompilepo\"'\n-                    os.system(cmd)\n+                    program = 'msgfmt'\n+                    args = [program, '--check-format', '-o', npath(pf + '.mo'), npath(pf + '.po')]\n+                    output, errors, status = popen_wrapper(args)\n+                    if status:\n+                        if errors:\n+                            msg = \"Execution of %s failed: %s\" % (program, errors)\n+                        else:\n+                            msg = \"Execution of %s failed\" % program\n+                        raise CommandError(msg)\n \n \n class Command(BaseCommand):"
        },
        {
            "sha": "4204a313bffc3b55cf4df89678d5bf286bc4b7d1",
            "filename": "django/core/management/utils.py",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/dfa9324966ce1a38346d15e35805d042848aabf1/django%2Fcore%2Fmanagement%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/dfa9324966ce1a38346d15e35805d042848aabf1/django%2Fcore%2Fmanagement%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Futils.py?ref=dfa9324966ce1a38346d15e35805d042848aabf1",
            "patch": "@@ -0,0 +1,14 @@\n+import os\n+from subprocess import PIPE, Popen\n+\n+\n+def popen_wrapper(args):\n+    \"\"\"\n+    Friendly wrapper around Popen.\n+\n+    Returns stdout output, stderr output and OS status code.\n+    \"\"\"\n+    p = Popen(args, shell=False, stdout=PIPE, stderr=PIPE,\n+              close_fds=os.name != 'nt', universal_newlines=True)\n+    output, errors = p.communicate()\n+    return output, errors, p.returncode"
        },
        {
            "sha": "705ed63de5d53a4d5b7d34bc7def21c9e9fb3c0b",
            "filename": "tests/i18n/commands/compilation.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/dfa9324966ce1a38346d15e35805d042848aabf1/tests%2Fi18n%2Fcommands%2Fcompilation.py",
            "raw_url": "https://github.com/django/django/raw/dfa9324966ce1a38346d15e35805d042848aabf1/tests%2Fi18n%2Fcommands%2Fcompilation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fi18n%2Fcommands%2Fcompilation.py?ref=dfa9324966ce1a38346d15e35805d042848aabf1",
            "patch": "@@ -99,3 +99,22 @@ def test_multiple_locales(self):\n \n         self.assertTrue(os.path.exists(self.MO_FILE_HR))\n         self.assertTrue(os.path.exists(self.MO_FILE_FR))\n+\n+\n+class CompilationErrorHandling(MessageCompilationTests):\n+\n+    LOCALE='ja'\n+    MO_FILE='locale/%s/LC_MESSAGES/django.mo' % LOCALE\n+\n+    def setUp(self):\n+        super(CompilationErrorHandling, self).setUp()\n+        self.addCleanup(self._rmfile, os.path.join(test_dir, self.MO_FILE))\n+\n+    def _rmfile(self, filepath):\n+        if os.path.exists(filepath):\n+            os.remove(filepath)\n+\n+    def test_error_reported_by_msgfmt(self):\n+        os.chdir(test_dir)\n+        with self.assertRaises(CommandError):\n+            call_command('compilemessages', locale=self.LOCALE, stderr=StringIO())"
        },
        {
            "sha": "08d6be1e63a812cc7011322c1a2f40edb801d713",
            "filename": "tests/i18n/commands/locale/ja/LC_MESSAGES/django.po",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/dfa9324966ce1a38346d15e35805d042848aabf1/tests%2Fi18n%2Fcommands%2Flocale%2Fja%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/dfa9324966ce1a38346d15e35805d042848aabf1/tests%2Fi18n%2Fcommands%2Flocale%2Fja%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fi18n%2Fcommands%2Flocale%2Fja%2FLC_MESSAGES%2Fdjango.po?ref=dfa9324966ce1a38346d15e35805d042848aabf1",
            "patch": "@@ -0,0 +1,21 @@\n+# SOME DESCRIPTIVE TITLE.\n+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER\n+# This file is distributed under the same license as the PACKAGE package.\n+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.\n+#\n+msgid \"\"\n+msgstr \"\"\n+\"Project-Id-Version: PACKAGE VERSION\\n\"\n+\"Report-Msgid-Bugs-To: \\n\"\n+\"POT-Creation-Date: 2011-12-04 04:59-0600\\n\"\n+\"PO-Revision-Date: 2013-02-26 21:29-0300\\n\"\n+\"Last-Translator: FULL NAME <EMAIL@ADDRESS>\\n\"\n+\"Language-Team: LANGUAGE <LL@li.org>\\n\"\n+\"Language: ja\\n\"\n+\"MIME-Version: 1.0\\n\"\n+\"Content-Type: text/plain; charset=UTF-8\\n\"\n+\"Content-Transfer-Encoding: 8bit\\n\"\n+\"Plural-Forms: nplurals=1; plural=0;\\n\"\n+\n+#, brainfuck-format\n+msgwhat!? \"This is an invalid PO file. GNU msgfmt should reject it.\""
        },
        {
            "sha": "4d06c85c973e1d20e8fe580a529a67c74d368c53",
            "filename": "tests/i18n/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/dfa9324966ce1a38346d15e35805d042848aabf1/tests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dfa9324966ce1a38346d15e35805d042848aabf1/tests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fi18n%2Ftests.py?ref=dfa9324966ce1a38346d15e35805d042848aabf1",
            "patch": "@@ -41,7 +41,8 @@\n         MultipleLocaleExtractionTests)\n if can_run_compilation_tests:\n     from .commands.compilation import (PoFileTests, PoFileContentsTests,\n-        PercentRenderingTests, MultipleLocaleCompilationTests)\n+        PercentRenderingTests, MultipleLocaleCompilationTests,\n+        CompilationErrorHandling)\n from .contenttypes.tests import ContentTypeTests\n from .forms import I18nForm, SelectDateForm, SelectDateWidget, CompanyForm\n from .models import Company, TestModel"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 67,
        "deletions": 14
    }
}