{
    "author": "ptone",
    "message": "Fixed #18658 -- Improved ModelAdmin.message_user API\n\nThanks to Lowe Thiderman for the patch and tests",
    "sha": "edf7ad36faab8d45aafe1f96feaf46794de22fc1",
    "files": [
        {
            "sha": "f14ca69f5e8c8382a241af0b0dfd7dd48219fe2d",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -531,6 +531,7 @@ answer newbie questions, and generally made Django that much better:\n     Terry Huang <terryh.tp@gmail.com>\n     Travis Terry <tdterry7@gmail.com>\n     thebjorn <bp@datakortet.no>\n+    Lowe Thiderman <lowe.thiderman@gmail.com>\n     Zach Thompson <zthompson47@gmail.com>\n     Michael Thornhill <michael.thornhill@gmail.com>\n     Deepak Thukral <deep.thukral@gmail.com>"
        },
        {
            "sha": "64d71fe1af21510a65017802cd692e68b00b73a0",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -691,12 +691,30 @@ def construct_change_message(self, request, form, formsets):\n         change_message = ' '.join(change_message)\n         return change_message or _('No fields changed.')\n \n-    def message_user(self, request, message):\n+    def message_user(self, request, message, level=messages.INFO, extra_tags='',\n+                     fail_silently=False):\n         \"\"\"\n         Send a message to the user. The default implementation\n         posts a message using the django.contrib.messages backend.\n+\n+        Exposes almost the same API as messages.add_message(), but accepts the\n+        positional arguments in a different order to maintain backwards\n+        compatibility. For convenience, it accepts the `level` argument as\n+        a string rather than the ususal level number.\n         \"\"\"\n-        messages.info(request, message)\n+\n+        if not isinstance(level, int):\n+            # attempt to get the level if passed a string\n+            try:\n+                level = getattr(messages.constants, level.upper())\n+            except AttributeError:\n+                levels = messages.constants.DEFAULT_TAGS.values()\n+                levels_repr = ', '.join('`%s`' % l for l in levels)\n+                raise ValueError('Bad message level string: `%s`. '\n+                        'Possible values are: %s' % (level, levels_repr))\n+\n+        messages.add_message(request, level, message, extra_tags=extra_tags,\n+                fail_silently=fail_silently)\n \n     def save_form(self, request, form, change):\n         \"\"\""
        },
        {
            "sha": "d7eef623d58b8f0037416fd22a90b6e67fa7643f",
            "filename": "docs/ref/contrib/admin/actions.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/docs%2Fref%2Fcontrib%2Fadmin%2Factions.txt",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/docs%2Fref%2Fcontrib%2Fadmin%2Factions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Factions.txt?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -140,6 +140,15 @@ That's really all there is to it! If you're itching to write your own actions,\n you now know enough to get started. The rest of this document just covers more\n advanced techniques.\n \n+Handling errors in actions\n+--------------------------\n+\n+If there are foreseeable error conditions that may occur while running your\n+action, you should gracefully inform the user of the problem. This means\n+handling exceptions and and using\n+:meth:`django.contrib.admin.ModelAdmin.message_user` to display a user friendly\n+description of the problem in the response.\n+\n Advanced action techniques\n ==========================\n "
        },
        {
            "sha": "38668a0a2cdcfd10b9782169366e4bb2c90fdb5c",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -1303,11 +1303,19 @@ templates used by the :class:`ModelAdmin` views:\n                     return qs\n                 return qs.filter(author=request.user)\n \n-.. method:: ModelAdmin.message_user(request, message)\n+.. method:: ModelAdmin.message_user(request, message, level=messages.INFO, extra_tags='', fail_silently=False)\n \n-    Sends a message to the user. The default implementation creates a message\n-    using the :mod:`django.contrib.messages` backend. See the\n-    :ref:`custom ModelAdmin example <custom-admin-action>`.\n+    Sends a message to the user using the :mod:`django.contrib.messages`\n+    backend.  See the :ref:`custom ModelAdmin example <custom-admin-action>`.\n+\n+    .. versionadded:: 1.5\n+\n+    Keyword arguments allow you to change the message level, add extra CSS\n+    tags, or fail silently if the ``contrib.messages`` framework is not\n+    installed. These keyword arguments match those for\n+    :func:`django.contrib.messages.add_message`, see that function's\n+    documentation for more details. One difference is that the level may be\n+    passed as a string label in addition to integer/constant.\n \n .. method:: ModelAdmin.get_paginator(queryset, per_page, orphans=0, allow_empty_first_page=True)\n "
        },
        {
            "sha": "b73bb041e9e98bd438d50c82eca7ec96fb8c160b",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -313,6 +313,11 @@ Django 1.5 also includes several smaller improvements worth noting:\n   DeprecationWarnings should be printed to the console in development\n   environments the way they have been in Python versions < 2.7.\n \n+* The API for :meth:`django.contrib.admin.ModelAdmin.message_user` method has\n+  been modified to accept additional arguments adding capabilities similar to\n+  :func:`django.contrib.messages.add_message`. This is useful for generating\n+  error messages from admin actions.\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        },
        {
            "sha": "40e800419e5fa6948129e05a15fb0d695d69a221",
            "filename": "tests/regressiontests/admin_views/admin.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -27,7 +27,7 @@\n     Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug,\n     AdminOrderedField, AdminOrderedModelMethod, AdminOrderedAdminMethod,\n     AdminOrderedCallable, Report, Color2, UnorderedObject, MainPrepopulated,\n-    RelatedPrepopulated, UndeletableObject, Simple)\n+    RelatedPrepopulated, UndeletableObject, UserMessenger, Simple)\n \n \n def callable_year(dt_value):\n@@ -592,6 +592,28 @@ def callable_on_unknown(obj):\n class AttributeErrorRaisingAdmin(admin.ModelAdmin):\n     list_display = [callable_on_unknown, ]\n \n+class MessageTestingAdmin(admin.ModelAdmin):\n+    actions = [\"message_debug\", \"message_info\", \"message_success\",\n+               \"message_warning\", \"message_error\", \"message_extra_tags\"]\n+\n+    def message_debug(self, request, selected):\n+        self.message_user(request, \"Test debug\", level=\"debug\")\n+\n+    def message_info(self, request, selected):\n+        self.message_user(request, \"Test info\", level=\"info\")\n+\n+    def message_success(self, request, selected):\n+        self.message_user(request, \"Test success\", level=\"success\")\n+\n+    def message_warning(self, request, selected):\n+        self.message_user(request, \"Test warning\", level=\"warning\")\n+\n+    def message_error(self, request, selected):\n+        self.message_user(request, \"Test error\", level=\"error\")\n+\n+    def message_extra_tags(self, request, selected):\n+        self.message_user(request, \"Test tags\", extra_tags=\"extra_tag\")\n+\n \n site = admin.AdminSite(name=\"admin\")\n site.register(Article, ArticleAdmin)\n@@ -667,6 +689,7 @@ class AttributeErrorRaisingAdmin(admin.ModelAdmin):\n site.register(AdminOrderedCallable, AdminOrderedCallableAdmin)\n site.register(Color2, CustomTemplateFilterColorAdmin)\n site.register(Simple, AttributeErrorRaisingAdmin)\n+site.register(UserMessenger, MessageTestingAdmin)\n \n # Register core models we need in our tests\n from django.contrib.auth.models import User, Group"
        },
        {
            "sha": "6f2ddc23a2a677f4ffa29abeb74613c526ea0025",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -651,6 +651,10 @@ class UndeletableObject(models.Model):\n     \"\"\"\n     name = models.CharField(max_length=255)\n \n+class UserMessenger(models.Model):\n+    \"\"\"\n+    Dummy class for testing message_user functions on ModelAdmin\n+    \"\"\"\n \n class Simple(models.Model):\n     \"\"\""
        },
        {
            "sha": "313809ec1c4885e690421e02533387a14cef3cd0",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/django/django/blob/edf7ad36faab8d45aafe1f96feaf46794de22fc1/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/edf7ad36faab8d45aafe1f96feaf46794de22fc1/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=edf7ad36faab8d45aafe1f96feaf46794de22fc1",
            "patch": "@@ -3697,3 +3697,61 @@ def test_client_logout_url_can_be_used_to_login(self):\n         self.assertEqual(response.template_name, 'admin/login.html')\n         self.assertEqual(response.request['PATH_INFO'], '/test_admin/admin/')\n         self.assertContains(response, '<input type=\"hidden\" name=\"next\" value=\"/test_admin/admin/\" />')\n+\n+\n+@override_settings(PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))\n+class AdminUserMessageTest(TestCase):\n+    urls = \"regressiontests.admin_views.urls\"\n+    fixtures = ['admin-views-users.xml']\n+\n+    def setUp(self):\n+        self.client.login(username='super', password='secret')\n+\n+    def tearDown(self):\n+        self.client.logout()\n+\n+    def send_message(self, level):\n+        \"\"\"\n+        Helper that sends a post to the dummy test methods and asserts that a\n+        message with the level has appeared in the response.\n+        \"\"\"\n+        action_data = {\n+            ACTION_CHECKBOX_NAME: [1],\n+            'action': 'message_%s' % level,\n+            'index': 0,\n+        }\n+\n+        response = self.client.post('/test_admin/admin/admin_views/usermessenger/',\n+                                    action_data, follow=True)\n+        self.assertContains(response,\n+                            '<li class=\"%s\">Test %s</li>' % (level, level),\n+                            html=True)\n+\n+    @override_settings(MESSAGE_LEVEL=10)  # Set to DEBUG for this request\n+    def test_message_debug(self):\n+        self.send_message('debug')\n+\n+    def test_message_info(self):\n+        self.send_message('info')\n+\n+    def test_message_success(self):\n+        self.send_message('success')\n+\n+    def test_message_warning(self):\n+        self.send_message('warning')\n+\n+    def test_message_error(self):\n+        self.send_message('error')\n+\n+    def test_message_extra_tags(self):\n+        action_data = {\n+            ACTION_CHECKBOX_NAME: [1],\n+            'action': 'message_extra_tags',\n+            'index': 0,\n+        }\n+\n+        response = self.client.post('/test_admin/admin/admin_views/usermessenger/',\n+                                    action_data, follow=True)\n+        self.assertContains(response,\n+                            '<li class=\"extra_tag info\">Test tags</li>',\n+                            html=True)"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 133,
        "deletions": 7
    }
}