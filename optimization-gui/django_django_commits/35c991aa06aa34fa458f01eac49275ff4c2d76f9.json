{
    "author": "aaugustin",
    "message": "Added a default limit to the maximum number of forms in a formset.\n\nThis is a security fix. Disclosure and advisory coming shortly.",
    "sha": "35c991aa06aa34fa458f01eac49275ff4c2d76f9",
    "files": [
        {
            "sha": "81b75f27960aa2c69d182160deb2c82672e05928",
            "filename": "django/forms/formsets.py",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/35c991aa06aa34fa458f01eac49275ff4c2d76f9/django%2Fforms%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/35c991aa06aa34fa458f01eac49275ff4c2d76f9/django%2Fforms%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fformsets.py?ref=35c991aa06aa34fa458f01eac49275ff4c2d76f9",
            "patch": "@@ -21,6 +21,9 @@\n ORDERING_FIELD_NAME = 'ORDER'\n DELETION_FIELD_NAME = 'DELETE'\n \n+# default maximum number of forms in a formset, to prevent memory exhaustion\n+DEFAULT_MAX_NUM = 1000\n+\n class ManagementForm(Form):\n     \"\"\"\n     ``ManagementForm`` is used to keep track of how many form instances\n@@ -97,11 +100,10 @@ def total_form_count(self):\n             total_forms = initial_forms + self.extra\n             # Allow all existing related objects/inlines to be displayed,\n             # but don't allow extra beyond max_num.\n-            if self.max_num is not None:\n-                if initial_forms > self.max_num >= 0:\n-                    total_forms = initial_forms\n-                elif total_forms > self.max_num >= 0:\n-                    total_forms = self.max_num\n+            if initial_forms > self.max_num >= 0:\n+                total_forms = initial_forms\n+            elif total_forms > self.max_num >= 0:\n+                total_forms = self.max_num\n         return total_forms\n \n     def initial_form_count(self):\n@@ -111,14 +113,14 @@ def initial_form_count(self):\n         else:\n             # Use the length of the inital data if it's there, 0 otherwise.\n             initial_forms = self.initial and len(self.initial) or 0\n-            if self.max_num is not None and (initial_forms > self.max_num >= 0):\n+            if initial_forms > self.max_num >= 0:\n                 initial_forms = self.max_num\n         return initial_forms\n \n     def _construct_forms(self):\n         # instantiate all the forms and put them in self.forms\n         self.forms = []\n-        for i in xrange(self.total_form_count()):\n+        for i in xrange(min(self.total_form_count(), self.absolute_max)):\n             self.forms.append(self._construct_form(i))\n \n     def _construct_form(self, i, **kwargs):\n@@ -367,9 +369,14 @@ def as_ul(self):\n def formset_factory(form, formset=BaseFormSet, extra=1, can_order=False,\n                     can_delete=False, max_num=None):\n     \"\"\"Return a FormSet for the given form class.\"\"\"\n+    if max_num is None:\n+        max_num = DEFAULT_MAX_NUM\n+    # hard limit on forms instantiated, to prevent memory-exhaustion attacks\n+    # limit defaults to DEFAULT_MAX_NUM, but developer can increase it via max_num\n+    absolute_max = max(DEFAULT_MAX_NUM, max_num)\n     attrs = {'form': form, 'extra': extra,\n              'can_order': can_order, 'can_delete': can_delete,\n-             'max_num': max_num}\n+             'max_num': max_num, 'absolute_max': absolute_max}\n     return type(form.__name__ + str('FormSet'), (formset,), attrs)\n \n def all_valid(formsets):"
        },
        {
            "sha": "d2d102b5d6eaec33df7381157290492343932b45",
            "filename": "docs/topics/forms/formsets.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/35c991aa06aa34fa458f01eac49275ff4c2d76f9/docs%2Ftopics%2Fforms%2Fformsets.txt",
            "raw_url": "https://github.com/django/django/raw/35c991aa06aa34fa458f01eac49275ff4c2d76f9/docs%2Ftopics%2Fforms%2Fformsets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fforms%2Fformsets.txt?ref=35c991aa06aa34fa458f01eac49275ff4c2d76f9",
            "patch": "@@ -98,8 +98,8 @@ If the value of ``max_num`` is greater than the number of existing\n objects, up to ``extra`` additional blank forms will be added to the formset,\n so long as the total number of forms does not exceed ``max_num``.\n \n-A ``max_num`` value of ``None`` (the default) puts no limit on the number of\n-forms displayed.\n+A ``max_num`` value of ``None`` (the default) puts a high limit on the number\n+of forms displayed (1000). In practice this is equivalent to no limit.\n \n Formset validation\n ------------------"
        },
        {
            "sha": "62020e461e9f7aa77581aec3e1e8201335cacaac",
            "filename": "docs/topics/forms/modelforms.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/35c991aa06aa34fa458f01eac49275ff4c2d76f9/docs%2Ftopics%2Fforms%2Fmodelforms.txt",
            "raw_url": "https://github.com/django/django/raw/35c991aa06aa34fa458f01eac49275ff4c2d76f9/docs%2Ftopics%2Fforms%2Fmodelforms.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fforms%2Fmodelforms.txt?ref=35c991aa06aa34fa458f01eac49275ff4c2d76f9",
            "patch": "@@ -738,8 +738,8 @@ so long as the total number of forms does not exceed ``max_num``::\n     <tr><th><label for=\"id_form-2-name\">Name:</label></th><td><input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" value=\"Walt Whitman\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-2-id\" value=\"2\" id=\"id_form-2-id\" /></td></tr>\n     <tr><th><label for=\"id_form-3-name\">Name:</label></th><td><input id=\"id_form-3-name\" type=\"text\" name=\"form-3-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-3-id\" id=\"id_form-3-id\" /></td></tr>\n \n-A ``max_num`` value of ``None`` (the default) puts no limit on the number of\n-forms displayed.\n+A ``max_num`` value of ``None`` (the default) puts a high limit on the number\n+of forms displayed (1000). In practice this is equivalent to no limit.\n \n Using a model formset in a view\n -------------------------------"
        },
        {
            "sha": "573a8f6a6d361943e093e4241cb91a1d51358ac5",
            "filename": "tests/regressiontests/forms/tests/formsets.py",
            "status": "modified",
            "additions": 64,
            "deletions": 6,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/35c991aa06aa34fa458f01eac49275ff4c2d76f9/tests%2Fregressiontests%2Fforms%2Ftests%2Fformsets.py",
            "raw_url": "https://github.com/django/django/raw/35c991aa06aa34fa458f01eac49275ff4c2d76f9/tests%2Fregressiontests%2Fforms%2Ftests%2Fformsets.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Fformsets.py?ref=35c991aa06aa34fa458f01eac49275ff4c2d76f9",
            "patch": "@@ -2,7 +2,7 @@\n from __future__ import unicode_literals\n \n from django.forms import (CharField, DateField, FileField, Form, IntegerField,\n-    ValidationError)\n+    ValidationError, formsets)\n from django.forms.formsets import BaseFormSet, formset_factory\n from django.forms.util import ErrorList\n from django.test import TestCase\n@@ -51,7 +51,7 @@ def test_basic_formset(self):\n         # for adding data. By default, it displays 1 blank form. It can display more,\n         # but we'll look at how to do so later.\n         formset = ChoiceFormSet(auto_id=False, prefix='choices')\n-        self.assertHTMLEqual(str(formset), \"\"\"<input type=\"hidden\" name=\"choices-TOTAL_FORMS\" value=\"1\" /><input type=\"hidden\" name=\"choices-INITIAL_FORMS\" value=\"0\" /><input type=\"hidden\" name=\"choices-MAX_NUM_FORMS\" />\n+        self.assertHTMLEqual(str(formset), \"\"\"<input type=\"hidden\" name=\"choices-TOTAL_FORMS\" value=\"1\" /><input type=\"hidden\" name=\"choices-INITIAL_FORMS\" value=\"0\" /><input type=\"hidden\" name=\"choices-MAX_NUM_FORMS\" value=\"1000\" />\n <tr><th>Choice:</th><td><input type=\"text\" name=\"choices-0-choice\" /></td></tr>\n <tr><th>Votes:</th><td><input type=\"text\" name=\"choices-0-votes\" /></td></tr>\"\"\")\n \n@@ -654,8 +654,8 @@ def test_limiting_max_forms(self):\n         # Limiting the maximum number of forms ########################################\n         # Base case for max_num.\n \n-        # When not passed, max_num will take its default value of None, i.e. unlimited\n-        # number of forms, only controlled by the value of the extra parameter.\n+        # When not passed, max_num will take a high default value, leaving the\n+        # number of forms only controlled by the value of the extra parameter.\n \n         LimitedFavoriteDrinkFormSet = formset_factory(FavoriteDrinkForm, extra=3)\n         formset = LimitedFavoriteDrinkFormSet()\n@@ -702,8 +702,8 @@ def test_limiting_max_forms(self):\n     def test_max_num_with_initial_data(self):\n         # max_num with initial data\n \n-        # When not passed, max_num will take its default value of None, i.e. unlimited\n-        # number of forms, only controlled by the values of the initial and extra\n+        # When not passed, max_num will take a high default value, leaving the\n+        # number of forms only controlled by the value of the initial and extra\n         # parameters.\n \n         initial = [\n@@ -878,6 +878,64 @@ def is_valid(self):\n         self.assertTrue(formset.is_valid())\n         self.assertTrue(all([form.is_valid_called for form in formset.forms]))\n \n+    def test_hard_limit_on_instantiated_forms(self):\n+        \"\"\"A formset has a hard limit on the number of forms instantiated.\"\"\"\n+        # reduce the default limit of 1000 temporarily for testing\n+        _old_DEFAULT_MAX_NUM = formsets.DEFAULT_MAX_NUM\n+        try:\n+            formsets.DEFAULT_MAX_NUM = 3\n+            ChoiceFormSet = formset_factory(Choice)\n+            # someone fiddles with the mgmt form data...\n+            formset = ChoiceFormSet(\n+                {\n+                    'choices-TOTAL_FORMS': '4',\n+                    'choices-INITIAL_FORMS': '0',\n+                    'choices-MAX_NUM_FORMS': '4',\n+                    'choices-0-choice': 'Zero',\n+                    'choices-0-votes': '0',\n+                    'choices-1-choice': 'One',\n+                    'choices-1-votes': '1',\n+                    'choices-2-choice': 'Two',\n+                    'choices-2-votes': '2',\n+                    'choices-3-choice': 'Three',\n+                    'choices-3-votes': '3',\n+                    },\n+                prefix='choices',\n+                )\n+            # But we still only instantiate 3 forms\n+            self.assertEqual(len(formset.forms), 3)\n+        finally:\n+            formsets.DEFAULT_MAX_NUM = _old_DEFAULT_MAX_NUM\n+\n+    def test_increase_hard_limit(self):\n+        \"\"\"Can increase the built-in forms limit via a higher max_num.\"\"\"\n+        # reduce the default limit of 1000 temporarily for testing\n+        _old_DEFAULT_MAX_NUM = formsets.DEFAULT_MAX_NUM\n+        try:\n+            formsets.DEFAULT_MAX_NUM = 3\n+            # for this form, we want a limit of 4\n+            ChoiceFormSet = formset_factory(Choice, max_num=4)\n+            formset = ChoiceFormSet(\n+                {\n+                    'choices-TOTAL_FORMS': '4',\n+                    'choices-INITIAL_FORMS': '0',\n+                    'choices-MAX_NUM_FORMS': '4',\n+                    'choices-0-choice': 'Zero',\n+                    'choices-0-votes': '0',\n+                    'choices-1-choice': 'One',\n+                    'choices-1-votes': '1',\n+                    'choices-2-choice': 'Two',\n+                    'choices-2-votes': '2',\n+                    'choices-3-choice': 'Three',\n+                    'choices-3-votes': '3',\n+                    },\n+                prefix='choices',\n+                )\n+            # This time four forms are instantiated\n+            self.assertEqual(len(formset.forms), 4)\n+        finally:\n+            formsets.DEFAULT_MAX_NUM = _old_DEFAULT_MAX_NUM\n+\n \n data = {\n     'choices-TOTAL_FORMS': '1', # the number of forms rendered"
        },
        {
            "sha": "8ba1700c765611a6036380b14ebf6bc0ebd8111a",
            "filename": "tests/regressiontests/generic_inline_admin/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/35c991aa06aa34fa458f01eac49275ff4c2d76f9/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/35c991aa06aa34fa458f01eac49275ff4c2d76f9/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_inline_admin%2Ftests.py?ref=35c991aa06aa34fa458f01eac49275ff4c2d76f9",
            "patch": "@@ -6,6 +6,7 @@\n from django.contrib.admin.sites import AdminSite\n from django.contrib.contenttypes.generic import (\n     generic_inlineformset_factory, GenericTabularInline)\n+from django.forms.formsets import DEFAULT_MAX_NUM\n from django.forms.models import ModelForm\n from django.test import TestCase\n from django.test.utils import override_settings\n@@ -244,7 +245,7 @@ def test_get_formset_kwargs(self):\n \n         # Create a formset with default arguments\n         formset = media_inline.get_formset(request)\n-        self.assertEqual(formset.max_num, None)\n+        self.assertEqual(formset.max_num, DEFAULT_MAX_NUM)\n         self.assertEqual(formset.can_order, False)\n \n         # Create a formset with custom keyword arguments"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 85,
        "deletions": 19
    }
}