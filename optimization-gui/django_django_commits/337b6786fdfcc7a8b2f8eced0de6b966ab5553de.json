{
    "author": "ramiro",
    "message": "Fixed #13902 -- Fixed admin list_filter so it doesn't show duplicate results when it includes a field spec that involves m2m relationships with an intermediate model. Thanks Iv√°n Raskovsky for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15526 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "337b6786fdfcc7a8b2f8eced0de6b966ab5553de",
    "files": [
        {
            "sha": "d0f03504074e25daaec449653aad3e0017c1485e",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/337b6786fdfcc7a8b2f8eced0de6b966ab5553de/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/337b6786fdfcc7a8b2f8eced0de6b966ab5553de/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=337b6786fdfcc7a8b2f8eced0de6b966ab5553de",
            "patch": "@@ -169,6 +169,8 @@ def get_ordering(self):\n         return order_field, order_type\n \n     def get_query_set(self):\n+        use_distinct = False\n+\n         qs = self.root_query_set\n         lookup_params = self.params.copy() # a dictionary of the query string\n         for i in (ALL_VAR, ORDER_VAR, ORDER_TYPE_VAR, SEARCH_VAR, IS_POPUP_VAR):\n@@ -181,6 +183,17 @@ def get_query_set(self):\n                 del lookup_params[key]\n                 lookup_params[smart_str(key)] = value\n \n+            if not use_distinct:\n+                # Check if it's a relationship that might return more than one\n+                # instance\n+                field_name = key.split('__', 1)[0]\n+                try:\n+                    f = self.lookup_opts.get_field_by_name(field_name)[0]\n+                except models.FieldDoesNotExist:\n+                    raise IncorrectLookupParameters\n+                if hasattr(f, 'rel') and isinstance(f.rel, models.ManyToManyRel):\n+                    use_distinct = True\n+\n             # if key ends with __in, split parameter into separate values\n             if key.endswith('__in'):\n                 value = value.split(',')\n@@ -246,12 +259,18 @@ def construct_search(field_name):\n             for bit in self.query.split():\n                 or_queries = [models.Q(**{construct_search(str(field_name)): bit}) for field_name in self.search_fields]\n                 qs = qs.filter(reduce(operator.or_, or_queries))\n-            for field_name in self.search_fields:\n-                if '__' in field_name:\n-                    qs = qs.distinct()\n-                    break\n+            if not use_distinct:\n+                for search_field in self.search_fields:\n+                    field_name = search_field.split('__', 1)[0]\n+                    f = self.lookup_opts.get_field_by_name(field_name)[0]\n+                    if hasattr(f, 'rel') and isinstance(f.rel, models.ManyToManyRel):\n+                        use_distinct = True\n+                        break\n \n-        return qs\n+        if use_distinct:\n+            return qs.distinct()\n+        else:\n+            return qs\n \n     def url_for_result(self, result):\n         return \"%s/\" % quote(getattr(result, self.pk_attname))"
        },
        {
            "sha": "509d37cc8c0363b35b5847051c0b6e8668b6b47b",
            "filename": "tests/regressiontests/admin_changelist/models.py",
            "status": "modified",
            "additions": 41,
            "deletions": 1,
            "changes": 42,
            "blob_url": "https://github.com/django/django/blob/337b6786fdfcc7a8b2f8eced0de6b966ab5553de/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/337b6786fdfcc7a8b2f8eced0de6b966ab5553de/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py?ref=337b6786fdfcc7a8b2f8eced0de6b966ab5553de",
            "patch": "@@ -1,9 +1,49 @@\n from django.db import models\n-from django.contrib import admin\n \n class Parent(models.Model):\n     name = models.CharField(max_length=128)\n \n class Child(models.Model):\n     parent = models.ForeignKey(Parent, editable=False, null=True)\n     name = models.CharField(max_length=30, blank=True)\n+\n+class Genre(models.Model):\n+    name = models.CharField(max_length=20)\n+\n+class Band(models.Model):\n+    name = models.CharField(max_length=20)\n+    nr_of_members = models.PositiveIntegerField()\n+    genres = models.ManyToManyField(Genre)\n+\n+class Musician(models.Model):\n+    name = models.CharField(max_length=30)\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class Group(models.Model):\n+    name = models.CharField(max_length=30)\n+    members = models.ManyToManyField(Musician, through='Membership')\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class Membership(models.Model):\n+    music = models.ForeignKey(Musician)\n+    group = models.ForeignKey(Group)\n+    role = models.CharField(max_length=15)\n+\n+class Quartet(Group):\n+    pass\n+\n+class ChordsMusician(Musician):\n+    pass\n+\n+class ChordsBand(models.Model):\n+    name = models.CharField(max_length=30)\n+    members = models.ManyToManyField(ChordsMusician, through='Invitation')\n+\n+class Invitation(models.Model):\n+    player = models.ForeignKey(ChordsMusician)\n+    band = models.ForeignKey(ChordsBand)\n+    instrument = models.CharField(max_length=15)"
        },
        {
            "sha": "87ffd6731fb02444167947d75509fd989b624f59",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 108,
            "deletions": 3,
            "changes": 111,
            "blob_url": "https://github.com/django/django/blob/337b6786fdfcc7a8b2f8eced0de6b966ab5553de/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/337b6786fdfcc7a8b2f8eced0de6b966ab5553de/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=337b6786fdfcc7a8b2f8eced0de6b966ab5553de",
            "patch": "@@ -5,7 +5,8 @@\n from django.template import Context, Template\n from django.test import TransactionTestCase\n \n-from regressiontests.admin_changelist.models import Child, Parent\n+from models import (Child, Parent, Genre, Band, Musician, Group, Quartet,\n+    Membership, ChordsMusician, ChordsBand, Invitation)\n \n \n class ChangeListTests(TransactionTestCase):\n@@ -135,18 +136,122 @@ def test_custom_paginator(self):\n         cl.get_results(request)\n         self.assertIsInstance(cl.paginator, CustomPaginator)\n \n+    def test_distinct_for_m2m_in_list_filter(self):\n+        \"\"\"\n+        Regression test for #13902: When using a ManyToMany in list_filter,\n+        results shouldn't apper more than once. Basic ManyToMany.\n+        \"\"\"\n+        blues = Genre.objects.create(name='Blues')\n+        band = Band.objects.create(name='B.B. King Review', nr_of_members=11)\n+\n+        band.genres.add(blues)\n+        band.genres.add(blues)\n+\n+        m = BandAdmin(Band, admin.site)\n+        cl = ChangeList(MockFilteredRequestA(), Band, m.list_display,\n+                m.list_display_links, m.list_filter, m.date_hierarchy,\n+                m.search_fields, m.list_select_related, m.list_per_page,\n+                m.list_editable, m)\n+\n+        cl.get_results(MockFilteredRequestA())\n+\n+        # There's only one Group instance\n+        self.assertEqual(cl.result_count, 1)\n+\n+    def test_distinct_for_through_m2m_in_list_filter(self):\n+        \"\"\"\n+        Regression test for #13902: When using a ManyToMany in list_filter,\n+        results shouldn't apper more than once. With an intermediate model.\n+        \"\"\"\n+        lead = Musician.objects.create(name='Vox')\n+        band = Group.objects.create(name='The Hype')\n+        Membership.objects.create(group=band, music=lead, role='lead voice')\n+        Membership.objects.create(group=band, music=lead, role='bass player')\n+\n+        m = GroupAdmin(Group, admin.site)\n+        cl = ChangeList(MockFilteredRequestB(), Group, m.list_display,\n+                m.list_display_links, m.list_filter, m.date_hierarchy,\n+                m.search_fields, m.list_select_related, m.list_per_page,\n+                m.list_editable, m)\n+\n+        cl.get_results(MockFilteredRequestB())\n+\n+        # There's only one Group instance\n+        self.assertEqual(cl.result_count, 1)\n+\n+    def test_distinct_for_inherited_m2m_in_list_filter(self):\n+        \"\"\"\n+        Regression test for #13902: When using a ManyToMany in list_filter,\n+        results shouldn't apper more than once. Model managed in the\n+        admin inherits from the one that defins the relationship.\n+        \"\"\"\n+        lead = Musician.objects.create(name='John')\n+        four = Quartet.objects.create(name='The Beatles')\n+        Membership.objects.create(group=four, music=lead, role='lead voice')\n+        Membership.objects.create(group=four, music=lead, role='guitar player')\n+\n+        m = QuartetAdmin(Quartet, admin.site)\n+        cl = ChangeList(MockFilteredRequestB(), Quartet, m.list_display,\n+                m.list_display_links, m.list_filter, m.date_hierarchy,\n+                m.search_fields, m.list_select_related, m.list_per_page,\n+                m.list_editable, m)\n+\n+        cl.get_results(MockFilteredRequestB())\n+\n+        # There's only one Quartet instance\n+        self.assertEqual(cl.result_count, 1)\n+\n+    def test_distinct_for_m2m_to_inherited_in_list_filter(self):\n+        \"\"\"\n+        Regression test for #13902: When using a ManyToMany in list_filter,\n+        results shouldn't apper more than once. Target of the relationship\n+        inherits from another.\n+        \"\"\"\n+        lead = ChordsMusician.objects.create(name='Player A')\n+        three = ChordsBand.objects.create(name='The Chords Trio')\n+        Invitation.objects.create(band=three, player=lead, instrument='guitar')\n+        Invitation.objects.create(band=three, player=lead, instrument='bass')\n+\n+        m = ChordsBandAdmin(ChordsBand, admin.site)\n+        cl = ChangeList(MockFilteredRequestB(), ChordsBand, m.list_display,\n+                m.list_display_links, m.list_filter, m.date_hierarchy,\n+                m.search_fields, m.list_select_related, m.list_per_page,\n+                m.list_editable, m)\n+\n+        cl.get_results(MockFilteredRequestB())\n+\n+        # There's only one ChordsBand instance\n+        self.assertEqual(cl.result_count, 1)\n+\n \n class ChildAdmin(admin.ModelAdmin):\n     list_display = ['name', 'parent']\n     def queryset(self, request):\n         return super(ChildAdmin, self).queryset(request).select_related(\"parent__name\")\n \n-\n class MockRequest(object):\n     GET = {}\n \n-\n class CustomPaginator(Paginator):\n     def __init__(self, queryset, page_size, orphans=0, allow_empty_first_page=True):\n         super(CustomPaginator, self).__init__(queryset, 5, orphans=2,\n             allow_empty_first_page=allow_empty_first_page)\n+\n+\n+class BandAdmin(admin.ModelAdmin):\n+    list_filter = ['genres']\n+\n+class GroupAdmin(admin.ModelAdmin):\n+    list_filter = ['members']\n+\n+class QuartetAdmin(admin.ModelAdmin):\n+    list_filter = ['members']\n+\n+class ChordsBandAdmin(admin.ModelAdmin):\n+    list_filter = ['members']\n+\n+class MockFilteredRequestA(object):\n+    GET = { 'genres': 1 }\n+\n+class MockFilteredRequestB(object):\n+    GET = { 'members': 1 }"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 173,
        "deletions": 9
    }
}