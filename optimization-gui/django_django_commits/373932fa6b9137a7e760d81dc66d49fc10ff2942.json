{
    "author": "ptone",
    "message": "fixed #10809 -- add a mod_wsgi authentication handler\n\nThanks to baumer1122 for the suggestion and initial \npatch and David Fischer for the contributions and\nlong term patch maintenance and docs.",
    "sha": "373932fa6b9137a7e760d81dc66d49fc10ff2942",
    "files": [
        {
            "sha": "0e543ef36874d3fcdb78bfa9c63f57300355881f",
            "filename": "django/contrib/auth/handlers/modwsgi.py",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhandlers%2Fmodwsgi.py?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -0,0 +1,43 @@\n+from django.contrib.auth.models import User\n+from django import db\n+from django.utils.encoding import force_bytes\n+\n+\n+def check_password(environ, username, password):\n+    \"\"\"\n+    Authenticates against Django's auth database\n+\n+    mod_wsgi docs specify None, True, False as return value depending\n+    on whether the user exists and authenticates.\n+    \"\"\"\n+\n+    # db connection state is managed similarly to the wsgi handler\n+    # as mod_wsgi may call these functions outside of a request/response cycle\n+    db.reset_queries()\n+\n+    try:\n+        try:\n+            user = User.objects.get(username=username, is_active=True)\n+        except User.DoesNotExist:\n+            return None\n+        return user.check_password(password)\n+    finally:\n+        db.close_connection()\n+\n+\n+def groups_for_user(environ, username):\n+    \"\"\"\n+    Authorizes a user based on groups\n+    \"\"\"\n+\n+    db.reset_queries()\n+\n+    try:\n+        try:\n+            user = User.objects.get(username=username, is_active=True)\n+        except User.DoesNotExist:\n+            return []\n+\n+        return [force_bytes(group.name) for group in user.groups.all()]\n+    finally:\n+        db.close_connection()"
        },
        {
            "sha": "b3007ea484b99c68333a0c591b0ae9a36be05b19",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -7,6 +7,7 @@\n from django.contrib.auth.tests.remote_user import *\n from django.contrib.auth.tests.management import *\n from django.contrib.auth.tests.models import *\n+from django.contrib.auth.tests.handlers import *\n from django.contrib.auth.tests.hashers import *\n from django.contrib.auth.tests.signals import *\n from django.contrib.auth.tests.tokens import *"
        },
        {
            "sha": "f061042ce3d771ff593abd24181dcea5ac758c44",
            "filename": "django/contrib/auth/tests/handlers.py",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhandlers.py?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -0,0 +1,45 @@\n+from __future__ import unicode_literals\n+\n+from django.contrib.auth.handlers.modwsgi import check_password, groups_for_user\n+from django.contrib.auth.models import User, Group\n+from django.test import TestCase\n+\n+\n+class ModWsgiHandlerTestCase(TestCase):\n+    \"\"\"\n+    Tests for the mod_wsgi authentication handler\n+    \"\"\"\n+\n+    def setUp(self):\n+        user1 = User.objects.create_user('test', 'test@example.com', 'test')\n+        User.objects.create_user('test1', 'test1@example.com', 'test1')\n+\n+        group = Group.objects.create(name='test_group')\n+        user1.groups.add(group)\n+\n+    def test_check_password(self):\n+        \"\"\"\n+        Verify that check_password returns the correct values as per\n+        http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms#Apache_Authentication_Provider\n+        \"\"\"\n+\n+        # User not in database\n+        self.assertTrue(check_password({}, 'unknown', '') is None)\n+\n+        # Valid user with correct password\n+        self.assertTrue(check_password({}, 'test', 'test'))\n+\n+        # Valid user with incorrect password\n+        self.assertFalse(check_password({}, 'test', 'incorrect'))\n+\n+    def test_groups_for_user(self):\n+        \"\"\"\n+        Check that groups_for_user returns correct values as per\n+        http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms#Apache_Group_Authorisation\n+        \"\"\"\n+\n+        # User not in database\n+        self.assertEqual(groups_for_user({}, 'unknown'), [])\n+\n+        self.assertEqual(groups_for_user({}, 'test'), [b'test_group'])\n+        self.assertEqual(groups_for_user({}, 'test1'), [])"
        },
        {
            "sha": "719fbc176949ed4bf6e9017b34e1cb44c64ae8d6",
            "filename": "docs/howto/apache-auth.txt",
            "status": "removed",
            "additions": 0,
            "deletions": 45,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/01362745ba72286309ff1955219a5ffc32c760b0/docs%2Fhowto%2Fapache-auth.txt",
            "raw_url": "https://github.com/django/django/raw/01362745ba72286309ff1955219a5ffc32c760b0/docs%2Fhowto%2Fapache-auth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fapache-auth.txt?ref=01362745ba72286309ff1955219a5ffc32c760b0",
            "patch": "@@ -1,45 +0,0 @@\n-=========================================================\n-Authenticating against Django's user database from Apache\n-=========================================================\n-\n-Since keeping multiple authentication databases in sync is a common problem when\n-dealing with Apache, you can configuring Apache to authenticate against Django's\n-:doc:`authentication system </topics/auth>` directly. This requires Apache\n-version >= 2.2 and mod_wsgi >= 2.0. For example, you could:\n-\n-* Serve static/media files directly from Apache only to authenticated users.\n-\n-* Authenticate access to a Subversion_ repository against Django users with\n-  a certain permission.\n-\n-* Allow certain users to connect to a WebDAV share created with mod_dav_.\n-\n-.. _Subversion: http://subversion.tigris.org/\n-.. _mod_dav: http://httpd.apache.org/docs/2.2/mod/mod_dav.html\n-\n-Configuring Apache\n-==================\n-\n-To check against Django's authorization database from a Apache configuration\n-file, you'll need to set 'wsgi' as the value of ``AuthBasicProvider`` or\n-``AuthDigestProvider`` directive and then use the ``WSGIAuthUserScript``\n-directive to set the path to your authentification script:\n-\n-.. code-block:: apache\n-\n-    <Location /example/>\n-        AuthType Basic\n-        AuthName \"example.com\"\n-        AuthBasicProvider wsgi\n-        WSGIAuthUserScript /usr/local/wsgi/scripts/auth.wsgi\n-        Require valid-user\n-    </Location>\n-\n-Your auth.wsgi script will have to implement either a\n-``check_password(environ, user, password)`` function (for ``AuthBasicProvider``)\n-or a ``get_realm_hash(environ, user, realm)`` function (for ``AuthDigestProvider``).\n-\n-See the `mod_wsgi documentation`_ for more details about the implementation\n-of such a solution.\n-\n-.. _mod_wsgi documentation: http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms#Apache_Authentication_Provider"
        },
        {
            "sha": "36e3d0233c8d81183e26bbad08f6d10c894b6639",
            "filename": "docs/howto/deployment/wsgi/apache-auth.txt",
            "status": "added",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fapache-auth.txt",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fapache-auth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fapache-auth.txt?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -0,0 +1,122 @@\n+=========================================================\n+Authenticating against Django's user database from Apache\n+=========================================================\n+\n+Since keeping multiple authentication databases in sync is a common problem when\n+dealing with Apache, you can configure Apache to authenticate against Django's\n+:doc:`authentication system </topics/auth>` directly. This requires Apache\n+version >= 2.2 and mod_wsgi >= 2.0. For example, you could:\n+\n+* Serve static/media files directly from Apache only to authenticated users.\n+\n+* Authenticate access to a Subversion_ repository against Django users with\n+  a certain permission.\n+\n+* Allow certain users to connect to a WebDAV share created with mod_dav_.\n+\n+.. _Subversion: http://subversion.tigris.org/\n+.. _mod_dav: http://httpd.apache.org/docs/2.2/mod/mod_dav.html\n+\n+Authentication with mod_wsgi\n+============================\n+\n+Make sure that mod_wsgi is installed and activated and that you have\n+followed the steps to setup\n+:doc:`Apache with mod_wsgi </howto/deployment/wsgi/modwsgi>`\n+\n+Next, edit your Apache configuration to add a location that you want\n+only authenticated users to be able to view:\n+\n+.. code-block:: apache\n+\n+    WSGIScriptAlias / /path/to/mysite/config/mysite.wsgi\n+\n+    WSGIProcessGroup %{GLOBAL}\n+    WSGIApplicationGroup django\n+\n+    <Location \"/secret\">\n+        AuthType Basic\n+        AuthName \"Top Secret\"\n+        Require valid-user\n+        AuthBasicProvider wsgi\n+        WSGIAuthUserScript /path/to/mysite/config/mysite.wsgi\n+    </Location>\n+\n+The ``WSGIAuthUserScript`` directive tells mod_wsgi to execute the\n+``check_password`` function in specified wsgi script, passing the user name and\n+password that it receives from the prompt. In this example, the\n+``WSGIAuthUserScript`` is the same as the ``WSGIScriptAlias`` that defines your\n+application :doc:`that is created by django-admin.py startproject\n+</howto/deployment/wsgi/index>`.\n+\n+.. admonition:: Using Apache 2.2 with authentication\n+\n+    Make sure that ``mod_auth_basic`` and ``mod_authz_user`` are loaded.\n+\n+    These might be compiled statically into Apache, or you might need to use\n+    LoadModule to load them dynamically in your ``httpd.conf``:\n+\n+    .. code-block:: apache\n+\n+        LoadModule auth_basic_module modules/mod_auth_basic.so\n+        LoadModule authz_user_module modules/mod_authz_user.so\n+\n+Finally, edit your WSGI script ``mysite.wsgi`` to tie Apache's\n+authentication to your site's authentication mechanisms by importing the\n+check_user function:\n+\n+.. code-block:: python\n+\n+    import os\n+    import sys\n+\n+    os.environ['DJANGO_SETTINGS_MODULE'] = 'mysite.settings'\n+\n+    from django.contrib.auth.handlers.modwsgi import check_user\n+\n+    from django.core.handlers.wsgi import WSGIHandler\n+    application = WSGIHandler()\n+\n+\n+Requests beginning with ``/secret/`` will now require a user to authenticate.\n+\n+The mod_wsgi `access control mechanisms documentation`_ provides additional\n+details and information about alternative methods of authentication.\n+\n+.. _access control mechanisms documentation: http://code.google.com/p/modwsgi/wiki/AccessControlMechanisms\n+\n+Authorization with mod_wsgi and Django groups\n+---------------------------------------------\n+\n+mod_wsgi also provides functionality to restrict a particular location to\n+members of a group.\n+\n+In this case, the Apache configuration should look like this:\n+\n+.. code-block:: apache\n+\n+    WSGIScriptAlias / /path/to/mysite/config/mysite.wsgi\n+\n+    WSGIProcessGroup %{GLOBAL}\n+    WSGIApplicationGroup django\n+\n+    <Location \"/secret\">\n+        AuthType Basic\n+        AuthName \"Top Secret\"\n+        AuthBasicProvider wsgi\n+        WSGIAuthUserScript /path/to/mysite/config/mysite.wsgi\n+        WSGIAuthGroupScript /path/to/mysite/config/mysite.wsgi\n+        Require group secret-agents\n+        Require valid-user\n+    </Location>\n+\n+To support the ``WSGIAuthGroupScript`` directive, the same WSGI script\n+``mysite.wsgi`` must also import the ``groups_for_user`` function which\n+returns a list groups the given user belongs to.\n+\n+.. code-block:: python\n+\n+    from django.contrib.auth.handlers.modwsgi import check_user, groups_for_user\n+\n+Requests for ``/secret/`` will now also require user to be a member of the\n+\"secret-agents\" group."
        },
        {
            "sha": "769d406b1b9a7a3a47d549f7c16955db6c6c2a98",
            "filename": "docs/howto/deployment/wsgi/index.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Fdeployment%2Fwsgi%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Fdeployment%2Fwsgi%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fdeployment%2Fwsgi%2Findex.txt?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -16,6 +16,7 @@ documentation for the following WSGI servers:\n    :maxdepth: 1\n \n    modwsgi\n+   apache-auth\n    gunicorn\n    uwsgi\n "
        },
        {
            "sha": "b525255dbdaeb384289677bb8b07cb2ac218c497",
            "filename": "docs/howto/deployment/wsgi/modwsgi.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fmodwsgi.txt",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fmodwsgi.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fdeployment%2Fwsgi%2Fmodwsgi.txt?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -177,6 +177,13 @@ other approaches:\n 3. Copy the admin static files so that they live within your Apache\n    document root.\n \n+Authenticating against Django's user database from Apache\n+=========================================================\n+\n+Django provides a handler to allow Apache to authenticate users directly\n+against Django's authentication backends. See the :doc:`mod_wsgi authentication\n+documentation </howto/deployment/wsgi/apache-auth>`.\n+\n If you get a UnicodeEncodeError\n ===============================\n "
        },
        {
            "sha": "d39222be26f158c7acd173588cc9cbf700ab6199",
            "filename": "docs/howto/index.txt",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Fhowto%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Findex.txt?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -9,7 +9,6 @@ you quickly accomplish common tasks.\n .. toctree::\n    :maxdepth: 1\n \n-   apache-auth\n    auth-remote-user\n    custom-management-commands\n    custom-model-fields"
        },
        {
            "sha": "fddd03d4213d2c88be7f61653fcb42ee9345d55c",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/373932fa6b9137a7e760d81dc66d49fc10ff2942/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=373932fa6b9137a7e760d81dc66d49fc10ff2942",
            "patch": "@@ -146,6 +146,9 @@ Django 1.5 also includes several smaller improvements worth noting:\n   configuration duplication. More information can be found in the\n   :func:`~django.contrib.auth.decorators.login_required` documentation.\n \n+* Django now provides a mod_wsgi :doc:`auth handler\n+  </howto/deployment/wsgi/apache-auth>`\n+\n Backwards incompatible changes in 1.5\n =====================================\n "
        }
    ],
    "stats": {
        "total": 268,
        "additions": 222,
        "deletions": 46
    }
}