{
    "author": "alex",
    "message": "Fixed #12687 -- fixed an issue with aggregates and counts in conjunction with annotations where the QuerySet was provably empty.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14586 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4276b5197b2acc2c15ef719b1f1308c41f704725",
    "files": [
        {
            "sha": "207bc0c6c86afef2011e127b4c6999996bdaf531",
            "filename": "django/db/models/sql/aggregates.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/4276b5197b2acc2c15ef719b1f1308c41f704725/django%2Fdb%2Fmodels%2Fsql%2Faggregates.py",
            "raw_url": "https://github.com/django/django/raw/4276b5197b2acc2c15ef719b1f1308c41f704725/django%2Fdb%2Fmodels%2Fsql%2Faggregates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Faggregates.py?ref=4276b5197b2acc2c15ef719b1f1308c41f704725",
            "patch": "@@ -8,6 +8,7 @@ class AggregateField(object):\n     \"\"\"\n     def __init__(self, internal_type):\n         self.internal_type = internal_type\n+\n     def get_internal_type(self):\n         return self.internal_type\n "
        },
        {
            "sha": "c0449e7047a09a55d1dfb0b0b81bec460bfce63f",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/4276b5197b2acc2c15ef719b1f1308c41f704725/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/4276b5197b2acc2c15ef719b1f1308c41f704725/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=4276b5197b2acc2c15ef719b1f1308c41f704725",
            "patch": "@@ -337,7 +337,7 @@ def get_aggregation(self, using):\n         # information but retrieves only the first row. Aggregate\n         # over the subquery instead.\n         if self.group_by is not None:\n-            from subqueries import AggregateQuery\n+            from django.db.models.sql.subqueries import AggregateQuery\n             query = AggregateQuery(self.model)\n \n             obj = self.clone()\n@@ -349,7 +349,13 @@ def get_aggregation(self, using):\n                     query.aggregate_select[alias] = aggregate\n                     del obj.aggregate_select[alias]\n \n-            query.add_subquery(obj, using)\n+            try:\n+                query.add_subquery(obj, using)\n+            except EmptyResultSet:\n+                return dict(\n+                    (alias, None)\n+                    for alias in query.aggregate_select\n+                )\n         else:\n             query = self\n             self.select = []\n@@ -382,13 +388,19 @@ def get_count(self, using):\n             # If a select clause exists, then the query has already started to\n             # specify the columns that are to be returned.\n             # In this case, we need to use a subquery to evaluate the count.\n-            from subqueries import AggregateQuery\n+            from django.db.models.sql.subqueries import AggregateQuery\n             subquery = obj\n             subquery.clear_ordering(True)\n             subquery.clear_limits()\n \n             obj = AggregateQuery(obj.model)\n-            obj.add_subquery(subquery, using=using)\n+            try:\n+                obj.add_subquery(subquery, using=using)\n+            except EmptyResultSet:\n+                # add_subquery evaluates the query, if it's an EmptyResultSet\n+                # then there are can be no results, and therefore there the\n+                # count is obviously 0\n+                return 0\n \n         obj.add_count_column()\n         number = obj.get_aggregation(using=using)[None]"
        },
        {
            "sha": "003bf432c0140651db0fc9195648fb58a02553a0",
            "filename": "django/db/models/sql/subqueries.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/4276b5197b2acc2c15ef719b1f1308c41f704725/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "raw_url": "https://github.com/django/django/raw/4276b5197b2acc2c15ef719b1f1308c41f704725/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py?ref=4276b5197b2acc2c15ef719b1f1308c41f704725",
            "patch": "@@ -11,6 +11,7 @@\n from django.db.models.sql.query import Query\n from django.db.models.sql.where import AND, Constraint\n \n+\n __all__ = ['DeleteQuery', 'UpdateQuery', 'InsertQuery', 'DateQuery',\n         'AggregateQuery']\n "
        },
        {
            "sha": "813cc4839d63370c2584c26f960250d2281e6174",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/4276b5197b2acc2c15ef719b1f1308c41f704725/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/4276b5197b2acc2c15ef719b1f1308c41f704725/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=4276b5197b2acc2c15ef719b1f1308c41f704725",
            "patch": "@@ -622,6 +622,24 @@ def test_more_more_more(self):\n             lambda: Book.objects.annotate(mean_age=Avg('authors__age')).annotate(Avg('mean_age'))\n         )\n \n+    def test_empty_filter_count(self):\n+        self.assertEqual(\n+            Author.objects.filter(id__in=[]).annotate(Count(\"friends\")).count(),\n+            0\n+        )\n+\n+    def test_empty_filter_aggregate(self):\n+        self.assertEqual(\n+            Author.objects.filter(id__in=[]).annotate(Count(\"friends\")).aggregate(Count(\"pk\")),\n+            {\"pk__count\": None}\n+        )\n+\n+    def test_annotate_and_join(self):\n+        self.assertEqual(\n+            Author.objects.annotate(c=Count(\"friends__name\")).exclude(friends__name=\"Joe\").count(),\n+            Author.objects.count()\n+        )\n+\n     @skipUnlessDBFeature('supports_stddev')\n     def test_stddev(self):\n         self.assertEqual("
        }
    ],
    "stats": {
        "total": 40,
        "additions": 36,
        "deletions": 4
    }
}