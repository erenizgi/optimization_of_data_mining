{
    "author": "aaugustin",
    "message": "Fixed #17882 (again) -- Updated the database connections' time zone when time-zone-related settings are changed in tests.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17709 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec",
    "files": [
        {
            "sha": "6f1f4b96183466c2366e88c5b4940eb79014d8fa",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec",
            "patch": "@@ -710,6 +710,14 @@ def savepoint_rollback_sql(self, sid):\n         \"\"\"\n         raise NotImplementedError\n \n+    def set_time_zone_sql(self):\n+        \"\"\"\n+        Returns the SQL that will set the connection's time zone.\n+\n+        Returns '' if the backend doesn't support time zones.\n+        \"\"\"\n+        return ''\n+\n     def sql_flush(self, style, tables, sequences):\n         \"\"\"\n         Returns a list of SQL statements required to remove all data from"
        },
        {
            "sha": "0d25129313e1ee2f159ed94a8ba799bfb17543ad",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec",
            "patch": "@@ -190,7 +190,8 @@ def _cursor(self):\n                     # Set the time zone in autocommit mode (see #17062)\n                     self.connection.set_isolation_level(\n                             psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)\n-                    self.connection.cursor().execute(\"SET TIME ZONE %s\", [tz])\n+                    self.connection.cursor().execute(\n+                            self.ops.set_time_zone_sql(), [tz])\n             self.connection.set_isolation_level(self.isolation_level)\n             self._get_pg_version()\n             connection_created.send(sender=self.__class__, connection=self)"
        },
        {
            "sha": "395cd92047ff6e94a1888f7ea56a00eb45caaf86",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec",
            "patch": "@@ -71,6 +71,9 @@ def quote_name(self, name):\n             return name # Quoting once is enough.\n         return '\"%s\"' % name\n \n+    def set_time_zone_sql(self):\n+        return \"SET TIME ZONE %s\"\n+\n     def sql_flush(self, style, tables, sequences):\n         if tables:\n             # Perform a single SQL 'TRUNCATE x, y, z...;' statement.  It allows"
        },
        {
            "sha": "01d55817a2f7278c7340c00ffa69a1bbd8cdd0a7",
            "filename": "django/test/signals.py",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Ftest%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec/django%2Ftest%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsignals.py?ref=3ef55dfaa03b3f5be3ee3632dfc59b8f752d2dec",
            "patch": "@@ -1,14 +1,23 @@\n from django.conf import settings\n-from django.db import close_connection\n+from django.db import connections\n from django.dispatch import Signal\n \n template_rendered = Signal(providing_args=[\"template\", \"context\"])\n \n setting_changed = Signal(providing_args=[\"setting\", \"value\"])\n \n-# Close the database connection to re-establish it with the proper time zone.\n-def close_connection_on_time_zone_change(**kwargs):\n-    if (kwargs['setting'] == 'USE_TZ'\n-        or (kwargs['setting'] == 'TIME_ZONE' and not settings.USE_TZ)):\n-        close_connection()\n-setting_changed.connect(close_connection_on_time_zone_change)\n+def update_connections_time_zone(**kwargs):\n+    if kwargs['setting'] == 'USE_TZ' and settings.TIME_ZONE != 'UTC':\n+        USE_TZ, TIME_ZONE = kwargs['value'], settings.TIME_ZONE\n+    elif kwargs['setting'] == 'TIME_ZONE' and not settings.USE_TZ:\n+        USE_TZ, TIME_ZONE = settings.USE_TZ, kwargs['value']\n+    else:   # no need to change the database connnections' time zones\n+        return\n+\n+    tz = 'UTC' if USE_TZ else TIME_ZONE\n+    for conn in connections.all():\n+        tz_sql = conn.ops.set_time_zone_sql()\n+        if tz_sql:\n+            conn.cursor().execute(tz_sql, [tz])\n+\n+setting_changed.connect(update_connections_time_zone)"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 29,
        "deletions": 8
    }
}