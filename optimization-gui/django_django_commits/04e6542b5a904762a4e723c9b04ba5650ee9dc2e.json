{
    "author": "claudep",
    "message": "Fixed #19423 -- Prevented ModelAdmin sharing widgets due to formfield_overrides\n\nThanks joebuyer at manycycles.com for the report and Simon Charette\nfor the review.",
    "sha": "04e6542b5a904762a4e723c9b04ba5650ee9dc2e",
    "files": [
        {
            "sha": "f4c27511d3aae43537c305512fbc50ccc08a2d7b",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/04e6542b5a904762a4e723c9b04ba5650ee9dc2e/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/04e6542b5a904762a4e723c9b04ba5650ee9dc2e/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=04e6542b5a904762a4e723c9b04ba5650ee9dc2e",
            "patch": "@@ -1,3 +1,4 @@\n+import copy\n from functools import update_wrapper, partial\n import warnings\n \n@@ -130,7 +131,7 @@ def formfield_for_dbfield(self, db_field, **kwargs):\n         # passed to formfield_for_dbfield override the defaults.\n         for klass in db_field.__class__.mro():\n             if klass in self.formfield_overrides:\n-                kwargs = dict(self.formfield_overrides[klass], **kwargs)\n+                kwargs = dict(copy.deepcopy(self.formfield_overrides[klass]), **kwargs)\n                 return db_field.formfield(**kwargs)\n \n         # For any other type of field, just call its formfield() method."
        },
        {
            "sha": "2977b86f3ea0044d6283e0614555067de28cf4ce",
            "filename": "tests/regressiontests/admin_widgets/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/04e6542b5a904762a4e723c9b04ba5650ee9dc2e/tests%2Fregressiontests%2Fadmin_widgets%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/04e6542b5a904762a4e723c9b04ba5650ee9dc2e/tests%2Fregressiontests%2Fadmin_widgets%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_widgets%2Fmodels.py?ref=04e6542b5a904762a4e723c9b04ba5650ee9dc2e",
            "patch": "@@ -20,6 +20,7 @@ def __str__(self):\n @python_2_unicode_compatible\n class Band(models.Model):\n     name = models.CharField(max_length=100)\n+    style = models.CharField(max_length=20)\n     members = models.ManyToManyField(Member)\n \n     def __str__(self):"
        },
        {
            "sha": "76aa9f448f5cfeb447cf157ec0888649700930e4",
            "filename": "tests/regressiontests/admin_widgets/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/04e6542b5a904762a4e723c9b04ba5650ee9dc2e/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/04e6542b5a904762a4e723c9b04ba5650ee9dc2e/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_widgets%2Ftests.py?ref=04e6542b5a904762a4e723c9b04ba5650ee9dc2e",
            "patch": "@@ -10,7 +10,7 @@\n from django.contrib.admin.tests import AdminSeleniumWebDriverTestCase\n from django.core.files.storage import default_storage\n from django.core.files.uploadedfile import SimpleUploadedFile\n-from django.db.models import DateField\n+from django.db.models import CharField, DateField\n from django.test import TestCase as DjangoTestCase\n from django.test.utils import override_settings\n from django.utils import translation\n@@ -112,6 +112,23 @@ def testFormfieldOverrides(self):\n         self.assertFormfield(models.Event, 'start_date', forms.TextInput,\n                              formfield_overrides={DateField: {'widget': forms.TextInput}})\n \n+    def testFormfieldOverridesWidgetInstances(self):\n+        \"\"\"\n+        Test that widget instances in formfield_overrides are not shared between\n+        different fields. (#19423)\n+        \"\"\"\n+        class BandAdmin(admin.ModelAdmin):\n+            formfield_overrides = {\n+                CharField: {'widget': forms.TextInput(attrs={'size':'10'})}\n+            }\n+        ma = BandAdmin(models.Band, admin.site)\n+        f1 = ma.formfield_for_dbfield(models.Band._meta.get_field('name'), request=None)\n+        f2 = ma.formfield_for_dbfield(models.Band._meta.get_field('style'), request=None)\n+        self.assertNotEqual(f1.widget, f2.widget)\n+        self.assertEqual(f1.widget.attrs['maxlength'], '100')\n+        self.assertEqual(f2.widget.attrs['maxlength'], '20')\n+        self.assertEqual(f2.widget.attrs['size'], '10')\n+\n     def testFieldWithChoices(self):\n         self.assertFormfield(models.Member, 'gender', forms.Select)\n "
        }
    ],
    "stats": {
        "total": 23,
        "additions": 21,
        "deletions": 2
    }
}