{
    "author": "fcurella",
    "message": "Fixed #16455 -- Added support for PostGIS 2.0\n\nThanks ckarrie for the report and the initial patches, Flavio Curella\nfor updating the patch, and Anssi Kääriäinen for testing. See ticket\nfor other valuable contributors.",
    "sha": "92b5341b19e9b35083ee671afc2afb2f252c662d",
    "files": [
        {
            "sha": "06b60117f69291b51201bd469885a281a3db293d",
            "filename": "django/contrib/gis/db/backends/postgis/creation.py",
            "status": "modified",
            "additions": 23,
            "deletions": 4,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/92b5341b19e9b35083ee671afc2afb2f252c662d/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/92b5341b19e9b35083ee671afc2afb2f252c662d/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fpostgis%2Fcreation.py?ref=92b5341b19e9b35083ee671afc2afb2f252c662d",
            "patch": "@@ -1,4 +1,5 @@\n from django.conf import settings\n+from django.core.exceptions import ImproperlyConfigured\n from django.db.backends.postgresql_psycopg2.creation import DatabaseCreation\n \n class PostGISCreation(DatabaseCreation):\n@@ -38,12 +39,20 @@ def sql_indexes_for_field(self, model, f, style):\n                                   style.SQL_FIELD(qn(f.column)) +\n                                   style.SQL_KEYWORD(' SET NOT NULL') + ';')\n \n-\n             if f.spatial_index:\n                 # Spatial indexes created the same way for both Geometry and\n-                # Geography columns\n+                # Geography columns.\n+                # PostGIS 2.0 does not support GIST_GEOMETRY_OPS. So, on 1.5\n+                # we use GIST_GEOMETRY_OPS, on 2.0 we use either \"nd\" ops\n+                # which are fast on multidimensional cases, or just plain\n+                # gist index for the 2d case.\n                 if f.geography:\n                     index_opts = ''\n+                elif self.connection.ops.spatial_version >= (2, 0):\n+                    if f.dim > 2:\n+                        index_opts = ' ' + style.SQL_KEYWORD('gist_geometry_ops_nd')\n+                    else:\n+                        index_opts = ''\n                 else:\n                     index_opts = ' ' + style.SQL_KEYWORD(self.geom_index_opts)\n                 output.append(style.SQL_KEYWORD('CREATE INDEX ') +\n@@ -56,5 +65,15 @@ def sql_indexes_for_field(self, model, f, style):\n         return output\n \n     def sql_table_creation_suffix(self):\n-        qn = self.connection.ops.quote_name\n-        return ' TEMPLATE %s' % qn(getattr(settings, 'POSTGIS_TEMPLATE', 'template_postgis'))\n+        cursor = self.connection.cursor()\n+        cursor.execute('SELECT datname FROM pg_database;')\n+        db_names = [row[0] for row in cursor.fetchall()]\n+        postgis_template = getattr(settings, 'POSTGIS_TEMPLATE', 'template_postgis')\n+\n+        if postgis_template in db_names:\n+            qn = self.connection.ops.quote_name\n+            return ' TEMPLATE %s' % qn(postgis_template)\n+        elif self.connection.ops.spatial_version < (2, 0):\n+            raise ImproperlyConfigured(\"Template database '%s' does not exist.\" % postgis_template)\n+        else:\n+            return ''"
        },
        {
            "sha": "952ac9d45b3c59d16e535322b6113f20607b2877",
            "filename": "django/contrib/gis/tests/geoapp/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/92b5341b19e9b35083ee671afc2afb2f252c662d/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/92b5341b19e9b35083ee671afc2afb2f252c662d/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py?ref=92b5341b19e9b35083ee671afc2afb2f252c662d",
            "patch": "@@ -576,8 +576,8 @@ def test_num_geom(self):\n         for c in City.objects.filter(point__isnull=False).num_geom():\n             # Oracle will return 1 for the number of geometries on non-collections,\n             # whereas PostGIS will return None.\n-            if postgis:\n-                self.assertEqual(None, c.num_geom)\n+            if postgis and connection.ops.spatial_version < (2, 0, 0):\n+                self.assertIsNone(c.num_geom)\n             else:\n                 self.assertEqual(1, c.num_geom)\n "
        },
        {
            "sha": "d66fd7ab7726724be5f3261f328d877ff18b1f84",
            "filename": "docs/ref/contrib/gis/install.txt",
            "status": "modified",
            "additions": 66,
            "deletions": 46,
            "changes": 112,
            "blob_url": "https://github.com/django/django/blob/92b5341b19e9b35083ee671afc2afb2f252c662d/docs%2Fref%2Fcontrib%2Fgis%2Finstall.txt",
            "raw_url": "https://github.com/django/django/raw/92b5341b19e9b35083ee671afc2afb2f252c662d/docs%2Fref%2Fcontrib%2Fgis%2Finstall.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Finstall.txt?ref=92b5341b19e9b35083ee671afc2afb2f252c662d",
            "patch": "@@ -63,7 +63,7 @@ supported versions, and any notes for each of the supported database backends:\n ==================  ==============================  ==================  =========================================\n Database            Library Requirements            Supported Versions  Notes\n ==================  ==============================  ==================  =========================================\n-PostgreSQL          GEOS, PROJ.4, PostGIS           8.1+                Requires PostGIS.\n+PostgreSQL          GEOS, PROJ.4, PostGIS           8.2+                Requires PostGIS.\n MySQL               GEOS                            5.x                 Not OGC-compliant; limited functionality.\n Oracle              GEOS                            10.2, 11            XE not supported; not tested with 9.\n SQLite              GEOS, GDAL, PROJ.4, SpatiaLite  3.6.+               Requires SpatiaLite 2.3+, pysqlite2 2.5+\n@@ -88,7 +88,7 @@ Program                   Description                           Required\n `PROJ.4`_                 Cartographic Projections library      Yes (PostgreSQL and SQLite only)  4.8, 4.7, 4.6, 4.5, 4.4\n :ref:`GDAL <ref-gdal>`    Geospatial Data Abstraction Library   No (but, required for SQLite)     1.9, 1.8, 1.7, 1.6, 1.5\n :ref:`GeoIP <ref-geoip>`  IP-based geolocation library          No                                1.4\n-`PostGIS`__               Spatial extensions for PostgreSQL     Yes (PostgreSQL only)             1.5, 1.4, 1.3\n+`PostGIS`__               Spatial extensions for PostgreSQL     Yes (PostgreSQL only)             2.0, 1.5, 1.4, 1.3\n `SpatiaLite`__            Spatial extensions for SQLite         Yes (SQLite only)                 3.0, 2.4, 2.3\n ========================  ====================================  ================================  ==========================\n \n@@ -226,45 +226,6 @@ Finally, configure, make and install PROJ.4::\n     $ sudo make install\n     $ cd ..\n \n-.. _postgis:\n-\n-PostGIS\n--------\n-\n-`PostGIS`__ adds geographic object support to PostgreSQL, turning it\n-into a spatial database. :ref:`geosbuild` and :ref:`proj4` should be\n-installed prior to building PostGIS.\n-\n-.. note::\n-\n-    The `psycopg2`_ module is required for use as the database adaptor\n-    when using GeoDjango with PostGIS.\n-\n-.. _psycopg2: http://initd.org/psycopg/\n-\n-First download the source archive, and extract::\n-\n-    $ wget http://postgis.refractions.net/download/postgis-1.5.5.tar.gz\n-    $ tar xzf postgis-1.5.5.tar.gz\n-    $ cd postgis-1.5.5\n-\n-Next, configure, make and install PostGIS::\n-\n-    $ ./configure\n-\n-Finally, make and install::\n-\n-    $ make\n-    $ sudo make install\n-    $ cd ..\n-\n-.. note::\n-\n-    GeoDjango does not automatically create a spatial database.  Please\n-    consult the section on :ref:`spatialdb_template` for more information.\n-\n-__ http://postgis.refractions.net/\n-\n .. _gdalbuild:\n \n GDAL\n@@ -364,6 +325,48 @@ file:\n \n     SetEnv GDAL_DATA /usr/local/share\n \n+.. _postgis:\n+\n+PostGIS\n+-------\n+\n+`PostGIS`__ adds geographic object support to PostgreSQL, turning it\n+into a spatial database. :ref:`geosbuild`, :ref:`proj4` and\n+:ref:`gdalbuild` should be installed prior to building PostGIS. You\n+might also need additional libraries, see `PostGIS requirements`_.\n+\n+.. note::\n+\n+    The `psycopg2`_ module is required for use as the database adaptor\n+    when using GeoDjango with PostGIS.\n+\n+.. _psycopg2: http://initd.org/psycopg/\n+.. _PostGIS requirements: http://www.postgis.org/documentation/manual-2.0/postgis_installation.html#id2711662\n+\n+First download the source archive, and extract::\n+\n+    $ wget http://postgis.refractions.net/download/postgis-2.0.1.tar.gz\n+    $ tar xzf postgis-2.0.1.tar.gz\n+    $ cd postgis-2.0.1\n+\n+Next, configure, make and install PostGIS::\n+\n+    $ ./configure\n+\n+Finally, make and install::\n+\n+    $ make\n+    $ sudo make install\n+    $ cd ..\n+\n+.. note::\n+\n+    GeoDjango does not automatically create a spatial database.  Please consult\n+    the section on :ref:`spatialdb_template91` or\n+    :ref:`spatialdb_template_earlier` for more information.\n+\n+__ http://postgis.refractions.net/\n+\n .. _spatialite:\n \n SpatiaLite\n@@ -507,10 +510,27 @@ to build and install::\n Post-installation\n =================\n \n-.. _spatialdb_template:\n+.. _spatialdb_template91:\n+\n+Creating a spatial database with PostGIS 2.0 and PostgreSQL 9.1\n+---------------------------------------------------------------\n+\n+PostGIS 2 includes an extension for Postgres 9.1 that can be used to enable\n+spatial functionality::\n+\n+    $ createdb  <db name>\n+    $ psql <db name>\n+    > CREATE EXTENSION postgis;\n+    > CREATE EXTENSION postgis_topology;\n+\n+.. _spatialdb_template_earlier:\n+\n+Creating a spatial database template for earlier versions\n+---------------------------------------------------------\n \n-Creating a spatial database template for PostGIS\n-------------------------------------------------\n+If you have an earlier version of PostGIS or PostgreSQL, the CREATE\n+EXTENSION isn't available and you need to create the spatial database\n+using the following instructions.\n \n Creating a spatial database with PostGIS is different than normal because\n additional SQL must be loaded to enable spatial functionality.  Because of\n@@ -540,7 +560,7 @@ user.  For example, you can use the following to become the ``postgres`` user::\n Once you're a database super user, then you may execute the following commands\n to create a PostGIS spatial database template::\n \n-    $ POSTGIS_SQL_PATH=`pg_config --sharedir`/contrib/postgis-1.5\n+    $ POSTGIS_SQL_PATH=`pg_config --sharedir`/contrib/postgis-2.0\n     # Creating the template spatial database.\n     $ createdb -E UTF8 template_postgis\n     $ createlang -d template_postgis plpgsql # Adding PLPGSQL language support.\n@@ -1083,7 +1103,7 @@ Afterwards, the ``/etc/init.d/postgresql-8.3`` script should be used to manage\n the starting and stopping of PostgreSQL.\n \n In addition, the SQL files for PostGIS are placed in a different location on\n-Debian 5.0 . Thus when :ref:`spatialdb_template` either:\n+Debian 5.0 . Thus when :ref:`spatialdb_template_earlier` either:\n \n * Create a symbolic link to these files:\n "
        },
        {
            "sha": "41fb2882a7028a9a2e0d71c2794587c5955e6064",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/92b5341b19e9b35083ee671afc2afb2f252c662d/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/92b5341b19e9b35083ee671afc2afb2f252c662d/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=92b5341b19e9b35083ee671afc2afb2f252c662d",
            "patch": "@@ -119,7 +119,8 @@ GeoDjango\n \n * The wkb and hex properties of `GEOSGeometry` objects preserve the Z dimension.\n \n-* Support for GDAL < 1.5 has been dropped.\n+* Support for PostGIS 2.0 has been added and support for GDAL < 1.5 has been\n+  dropped.\n \n Minor features\n ~~~~~~~~~~~~~~"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 93,
        "deletions": 53
    }
}