{
    "author": "carljm",
    "message": "Fixed #15260 -- Ensured that CACHE_MIDDLEWARE_ANONYMOUS_ONLY is effective with the cache_page decorator, not only the middleware. Thanks to brodie for report and draft patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15559 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "969217d45566e6853a2358088002e80b4afb9708",
    "files": [
        {
            "sha": "6302a172c75749e52ebf0878451c89ec37efa98c",
            "filename": "django/middleware/cache.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/969217d45566e6853a2358088002e80b4afb9708/django%2Fmiddleware%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/969217d45566e6853a2358088002e80b4afb9708/django%2Fmiddleware%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcache.py?ref=969217d45566e6853a2358088002e80b4afb9708",
            "patch": "@@ -50,7 +50,7 @@\n \n from django.conf import settings\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n-from django.utils.cache import get_cache_key, learn_cache_key, patch_response_headers, get_max_age, has_vary_header\n+from django.utils.cache import get_cache_key, learn_cache_key, patch_response_headers, get_max_age\n \n \n class UpdateCacheMiddleware(object):\n@@ -69,10 +69,19 @@ def __init__(self):\n         self.cache_alias = settings.CACHE_MIDDLEWARE_ALIAS\n         self.cache = get_cache(self.cache_alias)\n \n+    def _session_accessed(self, request):\n+        try:\n+            return request.session.accessed\n+        except AttributeError:\n+            return False\n+\n     def _should_update_cache(self, request, response):\n         if not hasattr(request, '_cache_update_cache') or not request._cache_update_cache:\n             return False\n-        if self.cache_anonymous_only and has_vary_header(response, 'Cookie'):\n+        # If the session has not been accessed otherwise, we don't want to\n+        # cause it to be accessed here. If it hasn't been accessed, then the\n+        # user's logged-in status has not affected the response anyway.\n+        if self.cache_anonymous_only and self._session_accessed(request):\n             assert hasattr(request, 'user'), \"The Django cache middleware with CACHE_MIDDLEWARE_ANONYMOUS_ONLY=True requires authentication middleware to be installed. Edit your MIDDLEWARE_CLASSES setting to insert 'django.contrib.auth.middleware.AuthenticationMiddleware' before the CacheMiddleware.\"\n             if request.user.is_authenticated():\n                 # Don't cache user-variable requests from authenticated users."
        },
        {
            "sha": "b31f9a4c55ff684ae2cd3e6a9adc41caea732e81",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/969217d45566e6853a2358088002e80b4afb9708/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/969217d45566e6853a2358088002e80b4afb9708/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=969217d45566e6853a2358088002e80b4afb9708",
            "patch": "@@ -1256,6 +1256,28 @@ def test_cache_middleware_anonymous_only_wont_cause_session_access(self):\n \n         self.assertEqual(request.session.accessed, False)\n \n+    def test_cache_middleware_anonymous_only_with_cache_page(self):\n+        \"\"\"CACHE_MIDDLEWARE_ANONYMOUS_ONLY should still be effective when used\n+        with the cache_page decorator: the response to a request from an\n+        authenticated user should not be cached.\"\"\"\n+        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = True\n+\n+        request = self.factory.get('/view_anon/')\n+\n+        class MockAuthenticatedUser(object):\n+            def is_authenticated(self):\n+                return True\n+\n+        class MockAccessedSession(object):\n+            accessed = True\n+\n+        request.user = MockAuthenticatedUser()\n+        request.session = MockAccessedSession()\n+\n+        response = cache_page(hello_world_view)(request, '1')\n+\n+        self.assertFalse(\"Cache-Control\" in response)\n+\n     def test_view_decorator(self):\n         # decorate the same view with different cache decorators\n         default_view = cache_page(hello_world_view)"
        },
        {
            "sha": "b98447bfa3dd11897b86b6bd40d8af2bf82751b4",
            "filename": "tests/regressiontests/cache/urls.py",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f/tests%2Fregressiontests%2Fcache%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f/tests%2Fregressiontests%2Fcache%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Furls.py?ref=ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f",
            "patch": "@@ -1,5 +0,0 @@\n-from django.conf.urls.defaults import patterns\n-\n-urlpatterns = patterns('regressiontests.cache.views',\n-    (r'^$', 'home'),\n-)"
        },
        {
            "sha": "9b72f03f5633ca72f2d91260830b35c7f1affbfc",
            "filename": "tests/regressiontests/cache/views.py",
            "status": "removed",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f/tests%2Fregressiontests%2Fcache%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f/tests%2Fregressiontests%2Fcache%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Fviews.py?ref=ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f",
            "patch": "@@ -1,4 +0,0 @@\n-from django.http import HttpResponse\n-\n-def home(request):\n-    return HttpResponse('Hello World!')"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 33,
        "deletions": 11
    }
}