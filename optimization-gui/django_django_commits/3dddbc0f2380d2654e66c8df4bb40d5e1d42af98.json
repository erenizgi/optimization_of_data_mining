{
    "author": "oinopion",
    "message": "Fixed #19816: pre-evaluate queryset on m2m set\n\nIn ReverseManyRelatedObjectsDescriptor.__set__, evaluate possible\nqueryset to avoid problems when clear() would touch data this queryset\nreturns.",
    "sha": "3dddbc0f2380d2654e66c8df4bb40d5e1d42af98",
    "files": [
        {
            "sha": "01b8a550d17175c42071b45852c7b3206df22586",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/3dddbc0f2380d2654e66c8df4bb40d5e1d42af98/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/3dddbc0f2380d2654e66c8df4bb40d5e1d42af98/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=3dddbc0f2380d2654e66c8df4bb40d5e1d42af98",
            "patch": "@@ -904,6 +904,9 @@ def __set__(self, instance, value):\n             raise AttributeError(\"Cannot set values on a ManyToManyField which specifies an intermediary model.  Use %s.%s's Manager instead.\" % (opts.app_label, opts.object_name))\n \n         manager = self.__get__(instance)\n+        # clear() can change expected output of 'value' queryset, we force evaluation\n+        # of queryset before clear; ticket #19816\n+        value = tuple(value)\n         manager.clear()\n         manager.add(*value)\n "
        },
        {
            "sha": "90aab5e2a57d930222012b32cc04d4bc5fd7d854",
            "filename": "tests/regressiontests/m2m_regress/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/3dddbc0f2380d2654e66c8df4bb40d5e1d42af98/tests%2Fregressiontests%2Fm2m_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3dddbc0f2380d2654e66c8df4bb40d5e1d42af98/tests%2Fregressiontests%2Fm2m_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fm2m_regress%2Ftests.py?ref=3dddbc0f2380d2654e66c8df4bb40d5e1d42af98",
            "patch": "@@ -5,7 +5,7 @@\n from django.utils import six\n \n from .models import (SelfRefer, Tag, TagCollection, Entry, SelfReferChild,\n-    SelfReferChildSibling, Worksheet, RegressionModelSplit)\n+    SelfReferChildSibling, Worksheet, RegressionModelSplit, Line)\n \n \n class M2MRegressionTests(TestCase):\n@@ -96,3 +96,16 @@ def test_m2m_abstract_split(self):\n         # causes a TypeError in add_lazy_relation\n         m1 = RegressionModelSplit(name='1')\n         m1.save()\n+\n+    def test_m2m_filter(self):\n+        worksheet = Worksheet.objects.create(id=1)\n+        line_hi = Line.objects.create(name=\"hi\")\n+        line_bye = Line.objects.create(name=\"bye\")\n+\n+        worksheet.lines = [line_hi, line_bye]\n+        hi = worksheet.lines.filter(name=\"hi\")\n+\n+        worksheet.lines = hi\n+        self.assertEquals(1, worksheet.lines.count())\n+        self.assertEquals(1, hi.count())\n+"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 17,
        "deletions": 1
    }
}