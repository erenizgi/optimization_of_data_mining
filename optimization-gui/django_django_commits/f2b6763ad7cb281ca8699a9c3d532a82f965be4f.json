{
    "author": "claudep",
    "message": "Fixed #18387 -- Do not call sys.exit during call_command.\n\nMoved sys.exit(1) so as failing management commands reach it\nonly when running from command line.",
    "sha": "f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
    "files": [
        {
            "sha": "81ab0aa05299a0af7816b3080b64dfaa62966f73",
            "filename": "django/contrib/auth/tests/management.py",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -2,6 +2,7 @@\n \n from django.contrib.auth import models, management\n from django.contrib.auth.management.commands import changepassword\n+from django.core.management.base import CommandError\n from django.test import TestCase\n \n \n@@ -56,16 +57,10 @@ def test_that_changepassword_command_changes_joes_password(self):\n     def test_that_max_tries_exits_1(self):\n         \"\"\"\n         A CommandError should be thrown by handle() if the user enters in\n-        mismatched passwords three times. This should be caught by execute() and\n-        converted to a SystemExit\n+        mismatched passwords three times.\n         \"\"\"\n         command = changepassword.Command()\n         command._get_pass = lambda *args: args or 'foo'\n \n-        self.assertRaises(\n-            SystemExit,\n-            command.execute,\n-            \"joe\",\n-            stdout=self.stdout,\n-            stderr=self.stderr\n-        )\n+        with self.assertRaises(CommandError):\n+            command.execute(\"joe\", stdout=self.stdout, stderr=self.stderr)"
        },
        {
            "sha": "a204f6f0bcb894da2f971f0a0495dea0a7fe32ca",
            "filename": "django/core/management/base.py",
            "status": "modified",
            "additions": 17,
            "deletions": 27,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/django%2Fcore%2Fmanagement%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/django%2Fcore%2Fmanagement%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fbase.py?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -97,8 +97,9 @@ class BaseCommand(object):\n        output and, if the command is intended to produce a block of\n        SQL statements, will be wrapped in ``BEGIN`` and ``COMMIT``.\n \n-    4. If ``handle()`` raised a ``CommandError``, ``execute()`` will\n-       instead print an error message to ``stderr``.\n+    4. If ``handle()`` or ``execute()`` raised any exception (e.g.\n+       ``CommandError``), ``run_from_argv()`` will  instead print an error\n+       message to ``stderr``.\n \n     Thus, the ``handle()`` method is typically the starting point for\n     subclasses; many built-in commands and command types either place\n@@ -210,23 +211,27 @@ def print_help(self, prog_name, subcommand):\n     def run_from_argv(self, argv):\n         \"\"\"\n         Set up any environment changes requested (e.g., Python path\n-        and Django settings), then run this command.\n-\n+        and Django settings), then run this command. If the\n+        command raises a ``CommandError``, intercept it and print it sensibly\n+        to stderr.\n         \"\"\"\n         parser = self.create_parser(argv[0], argv[1])\n         options, args = parser.parse_args(argv[2:])\n         handle_default_options(options)\n-        self.execute(*args, **options.__dict__)\n+        try:\n+            self.execute(*args, **options.__dict__)\n+        except Exception as e:\n+            if options.traceback:\n+                self.stderr.write(traceback.format_exc())\n+            self.stderr.write('%s: %s' % (e.__class__.__name__, e))\n+            sys.exit(1)\n \n     def execute(self, *args, **options):\n         \"\"\"\n         Try to execute this command, performing model validation if\n         needed (as controlled by the attribute\n-        ``self.requires_model_validation``, except if force-skipped). If the\n-        command raises a ``CommandError``, intercept it and print it sensibly\n-        to stderr.\n+        ``self.requires_model_validation``, except if force-skipped).\n         \"\"\"\n-        show_traceback = options.get('traceback', False)\n \n         # Switch to English, because django-admin.py creates database content\n         # like permissions, and those shouldn't contain any translations.\n@@ -237,18 +242,9 @@ def execute(self, *args, **options):\n         self.stderr = OutputWrapper(options.get('stderr', sys.stderr), self.style.ERROR)\n \n         if self.can_import_settings:\n-            try:\n-                from django.utils import translation\n-                saved_lang = translation.get_language()\n-                translation.activate('en-us')\n-            except ImportError as e:\n-                # If settings should be available, but aren't,\n-                # raise the error and quit.\n-                if show_traceback:\n-                    traceback.print_exc()\n-                else:\n-                    self.stderr.write('Error: %s' % e)\n-                sys.exit(1)\n+            from django.utils import translation\n+            saved_lang = translation.get_language()\n+            translation.activate('en-us')\n \n         try:\n             if self.requires_model_validation and not options.get('skip_validation'):\n@@ -265,12 +261,6 @@ def execute(self, *args, **options):\n                 self.stdout.write(output)\n                 if self.output_transaction:\n                     self.stdout.write('\\n' + self.style.SQL_KEYWORD(\"COMMIT;\"))\n-        except CommandError as e:\n-            if show_traceback:\n-                traceback.print_exc()\n-            else:\n-                self.stderr.write('Error: %s' % e)\n-            sys.exit(1)\n         finally:\n             if saved_lang is not None:\n                 translation.activate(saved_lang)"
        },
        {
            "sha": "4a27bdf7a90b3d66392aecfb14113ec259616314",
            "filename": "docs/howto/custom-management-commands.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/docs%2Fhowto%2Fcustom-management-commands.txt",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/docs%2Fhowto%2Fcustom-management-commands.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fhowto%2Fcustom-management-commands.txt?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -317,8 +317,12 @@ Exception class indicating a problem while executing a management\n command.\n \n If this exception is raised during the execution of a management\n-command, it will be caught and turned into a nicely-printed error\n-message to the appropriate output stream (i.e., stderr); as a\n-result, raising this exception (with a sensible description of the\n+command from a command line console, it will be caught and turned into a\n+nicely-printed error message to the appropriate output stream (i.e., stderr);\n+as a result, raising this exception (with a sensible description of the\n error) is the preferred way to indicate that something has gone\n wrong in the execution of a command.\n+\n+If a management command is called from code through\n+:ref:`call_command <call-command>`, it's up to you to catch the exception\n+when needed."
        },
        {
            "sha": "0d86a52670162b31007807e579e079caca3fea64",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -75,6 +75,10 @@ Django 1.5 also includes several smaller improvements worth noting:\n \n * The generic views support OPTIONS requests.\n \n+* Management commands do not raise ``SystemExit`` any more when called by code\n+  from :ref:`call_command <call-command>`. Any exception raised by the command\n+  (mostly :ref:`CommandError <ref-command-exceptions>`) is propagated.\n+\n * The dumpdata management command outputs one row at a time, preventing\n   out-of-memory errors when dumping large datasets.\n "
        },
        {
            "sha": "478bbe912988f6b87044c405c9a2b523d227ef7b",
            "filename": "tests/modeltests/fixtures/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/tests%2Fmodeltests%2Ffixtures%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/tests%2Fmodeltests%2Ffixtures%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ffixtures%2Ftests.py?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -185,14 +185,14 @@ def test_dumpdata_with_excludes(self):\n             exclude_list=['fixtures.Article', 'fixtures.Book', 'sites'])\n \n         # Excluding a bogus app should throw an error\n-        self.assertRaises(SystemExit,\n+        self.assertRaises(management.CommandError,\n                           self._dumpdata_assert,\n                           ['fixtures', 'sites'],\n                           '',\n                           exclude_list=['foo_app'])\n \n         # Excluding a bogus model should throw an error\n-        self.assertRaises(SystemExit,\n+        self.assertRaises(management.CommandError,\n                           self._dumpdata_assert,\n                           ['fixtures', 'sites'],\n                           '',"
        },
        {
            "sha": "911530d223d85523cbb6027a3e03cc0cb1c23b26",
            "filename": "tests/modeltests/user_commands/management/commands/dance.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fdance.py",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fdance.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fuser_commands%2Fmanagement%2Fcommands%2Fdance.py?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -1,18 +1,20 @@\n from optparse import make_option\n \n-from django.core.management.base import BaseCommand\n+from django.core.management.base import BaseCommand, CommandError\n \n \n class Command(BaseCommand):\n     help = \"Dance around like a madman.\"\n     args = ''\n     requires_model_validation = True\n \n-    option_list =[\n+    option_list = BaseCommand.option_list + (\n         make_option(\"-s\", \"--style\", default=\"Rock'n'Roll\"),\n         make_option(\"-x\", \"--example\")\n-    ]\n+    )\n \n     def handle(self, *args, **options):\n         example = options[\"example\"]\n+        if example == \"raise\":\n+            raise CommandError()\n         self.stdout.write(\"I don't feel like dancing %s.\" % options[\"style\"])"
        },
        {
            "sha": "509f13f62f33aa0b55768ca0605d623046c2993b",
            "filename": "tests/modeltests/user_commands/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/tests%2Fmodeltests%2Fuser_commands%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f2b6763ad7cb281ca8699a9c3d532a82f965be4f/tests%2Fmodeltests%2Fuser_commands%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fuser_commands%2Ftests.py?ref=f2b6763ad7cb281ca8699a9c3d532a82f965be4f",
            "patch": "@@ -1,3 +1,4 @@\n+import sys\n from StringIO import StringIO\n \n from django.core import management\n@@ -26,4 +27,20 @@ def test_language_preserved(self):\n             self.assertEqual(translation.get_language(), 'fr')\n \n     def test_explode(self):\n+        \"\"\" Test that an unknown command raises CommandError \"\"\"\n         self.assertRaises(CommandError, management.call_command, ('explode',))\n+\n+    def test_system_exit(self):\n+        \"\"\" Exception raised in a command should raise CommandError with\n+            call_command, but SystemExit when run from command line\n+        \"\"\"\n+        with self.assertRaises(CommandError):\n+            management.call_command('dance', example=\"raise\")\n+        old_stderr = sys.stderr\n+        sys.stderr = err = StringIO()\n+        try:\n+            with self.assertRaises(SystemExit):\n+                management.ManagementUtility(['manage.py', 'dance', '--example=raise']).execute()\n+        finally:\n+            sys.stderr = old_stderr\n+        self.assertIn(\"CommandError\", err.getvalue())"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 56,
        "deletions": 44
    }
}