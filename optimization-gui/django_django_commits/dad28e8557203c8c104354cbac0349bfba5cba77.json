{
    "author": "jezdez",
    "message": "Fixed #14103 -- Take USE_ETAGS setting into account when patching the response headers. Thanks, trbs and Eric Holscher.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14885 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "dad28e8557203c8c104354cbac0349bfba5cba77",
    "files": [
        {
            "sha": "04beccaef2d96ab083c9ab56ef6228171ceafada",
            "filename": "django/utils/cache.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/dad28e8557203c8c104354cbac0349bfba5cba77/django%2Futils%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/dad28e8557203c8c104354cbac0349bfba5cba77/django%2Futils%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fcache.py?ref=dad28e8557203c8c104354cbac0349bfba5cba77",
            "patch": "@@ -101,7 +101,7 @@ def patch_response_headers(response, cache_timeout=None):\n         cache_timeout = settings.CACHE_MIDDLEWARE_SECONDS\n     if cache_timeout < 0:\n         cache_timeout = 0 # Can't have max-age negative\n-    if not response.has_header('ETag'):\n+    if settings.USE_ETAGS and not response.has_header('ETag'):\n         response['ETag'] = '\"%s\"' % md5_constructor(response.content).hexdigest()\n     if not response.has_header('Last-Modified'):\n         response['Last-Modified'] = http_date()"
        },
        {
            "sha": "3a7d987d4402b2b5751557b5f03c157c7a4e9d1b",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/dad28e8557203c8c104354cbac0349bfba5cba77/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/dad28e8557203c8c104354cbac0349bfba5cba77/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=dad28e8557203c8c104354cbac0349bfba5cba77",
            "patch": "@@ -1825,8 +1825,9 @@ USE_ETAGS\n Default: ``False``\n \n A boolean that specifies whether to output the \"Etag\" header. This saves\n-bandwidth but slows down performance. This is only used if ``CommonMiddleware``\n-is installed (see :doc:`/topics/http/middleware`).\n+bandwidth but slows down performance. This is used by the ``CommonMiddleware``\n+(see :doc:`/topics/http/middleware`) and in the``Cache Framework``\n+(see :doc:`/topics/cache`).\n \n .. setting:: USE_I18N\n "
        },
        {
            "sha": "941ab70b8a691bb1308dda5c21d19d178f897aa9",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/dad28e8557203c8c104354cbac0349bfba5cba77/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/dad28e8557203c8c104354cbac0349bfba5cba77/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=dad28e8557203c8c104354cbac0349bfba5cba77",
            "patch": "@@ -1048,6 +1048,7 @@ def set_cache(request, lang, msg):\n         settings.CACHE_MIDDLEWARE_SECONDS = 60\n         settings.CACHE_MIDDLEWARE_KEY_PREFIX=\"test\"\n         settings.CACHE_BACKEND='locmem:///'\n+        settings.USE_ETAGS = True\n         settings.USE_I18N = True\n         en_message =\"Hello world!\"\n         es_message =\"Hola mundo!\"\n@@ -1058,6 +1059,14 @@ def set_cache(request, lang, msg):\n         # Check that we can recover the cache\n         self.assertNotEqual(get_cache_data.content, None)\n         self.assertEqual(en_message, get_cache_data.content)\n+        # Check that we use etags\n+        self.assertTrue(get_cache_data.has_header('ETag'))\n+        # Check that we can disable etags\n+        settings.USE_ETAGS = False\n+        request._cache_update_cache = True\n+        set_cache(request, 'en', en_message)\n+        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+        self.assertFalse(get_cache_data.has_header('ETag'))\n         # change the session language and set content\n         request = self._get_request_cache()\n         set_cache(request, 'es', es_message)"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 13,
        "deletions": 3
    }
}