{
    "author": "jezdez",
    "message": "Rolled back r16510, r16513 and r16514 because it wasn't ready.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16515 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "89c302cf3f63f35161bdb2c09c849b30f35136e2",
    "files": [
        {
            "sha": "41baf53e7f23d95b6eaba080f16cf44bea009815",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/89c302cf3f63f35161bdb2c09c849b30f35136e2/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/89c302cf3f63f35161bdb2c09c849b30f35136e2/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=89c302cf3f63f35161bdb2c09c849b30f35136e2",
            "patch": "@@ -33,7 +33,9 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n-                call_command('createcachetable', cache._table, database=self.connection.alias)\n+                from django.db import router\n+                if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n+                    call_command('createcachetable', cache._table, database=self.connection.alias)\n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database.\n         cursor = self.connection.cursor()"
        },
        {
            "sha": "90172b6ca312fc6fd1da4349b35428164a1a023f",
            "filename": "django/core/management/commands/createcachetable.py",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/89c302cf3f63f35161bdb2c09c849b30f35136e2/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "raw_url": "https://github.com/django/django/raw/89c302cf3f63f35161bdb2c09c849b30f35136e2/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py?ref=89c302cf3f63f35161bdb2c09c849b30f35136e2",
            "patch": "@@ -1,8 +1,7 @@\n from optparse import make_option\n \n from django.core.management.base import LabelCommand\n-from django.core.cache.backends.db import BaseDatabaseCache\n-from django.db import connections, router, transaction, models, DEFAULT_DB_ALIAS\n+from django.db import connections, transaction, models, DEFAULT_DB_ALIAS\n \n class Command(LabelCommand):\n     help = \"Creates the table needed to use the SQL cache backend.\"\n@@ -19,11 +18,8 @@ class Command(LabelCommand):\n     requires_model_validation = False\n \n     def handle_label(self, tablename, **options):\n-        db = options.get('database', DEFAULT_DB_ALIAS)\n-        cache = BaseDatabaseCache(tablename, {})\n-        if not router.allow_syncdb(db, cache.cache_model_class):\n-            return\n-        connection = connections[db]\n+        alias = options.get('database', DEFAULT_DB_ALIAS)\n+        connection = connections[alias]\n         fields = (\n             # \"key\" is a reserved word in MySQL, so use \"cache_key\" instead.\n             models.CharField(name='cache_key', max_length=255, unique=True, primary_key=True),\n@@ -54,4 +50,4 @@ def handle_label(self, tablename, **options):\n         curs.execute(\"\\n\".join(full_statement))\n         for statement in index_output:\n             curs.execute(statement)\n-        transaction.commit_unless_managed(using=db)\n+        transaction.commit_unless_managed(using=alias)"
        },
        {
            "sha": "437a4297afa587f51a9d71404508a0d7b51d326c",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/89c302cf3f63f35161bdb2c09c849b30f35136e2/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/89c302cf3f63f35161bdb2c09c849b30f35136e2/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=89c302cf3f63f35161bdb2c09c849b30f35136e2",
            "patch": "@@ -261,7 +261,9 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n-                call_command('createcachetable', cache._table, database=self.connection.alias)\n+                from django.db import router\n+                if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n+                    call_command('createcachetable', cache._table, database=self.connection.alias)\n \n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database."
        },
        {
            "sha": "d206b462bcff9d4e4a2c8f869093d1b446eca849",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 39,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/89c302cf3f63f35161bdb2c09c849b30f35136e2/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/89c302cf3f63f35161bdb2c09c849b30f35136e2/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=89c302cf3f63f35161bdb2c09c849b30f35136e2",
            "patch": "@@ -14,11 +14,10 @@\n from django.core import management\n from django.core.cache import get_cache, DEFAULT_CACHE_ALIAS\n from django.core.cache.backends.base import CacheKeyWarning, InvalidCacheBackendError\n-from django.db import router\n from django.http import HttpResponse, HttpRequest, QueryDict\n from django.middleware.cache import FetchFromCacheMiddleware, UpdateCacheMiddleware, CacheMiddleware\n-from django.test import RequestFactory, TestCase\n-from django.test.utils import get_warnings_state, restore_warnings_state, override_settings\n+from django.test import RequestFactory\n+from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import translation\n from django.utils import unittest\n from django.utils.cache import patch_vary_headers, get_cache_key, learn_cache_key\n@@ -759,42 +758,6 @@ def test_old_initialization(self):\n         self.cache = get_cache('db://%s?max_entries=30&cull_frequency=0' % self._table_name)\n         self.perform_cull_test(50, 18)\n \n-class DBCacheRouter(object):\n-    \"\"\"A router that puts the cache table on the 'other' database.\"\"\"\n-\n-    def db_for_read(self, model, **hints):\n-        if model._meta.app_label == 'django_cache':\n-            return 'other'\n-\n-    def db_for_write(self, model, **hints):\n-        if model._meta.app_label == 'django_cache':\n-            return 'other'\n-\n-    def allow_syncdb(self, db, model):\n-        if model._meta.app_label == 'django_cache':\n-            return db == 'other'\n-\n-\n-class CreateCacheTableForDBCacheTests(TestCase):\n-    multi_db = True\n-\n-    def test_createcachetable_observes_database_router(self):\n-        old_routers = router.routers\n-        try:\n-            router.routers = [DBCacheRouter()]\n-            # cache table should not be created on 'default'\n-            with self.assertNumQueries(0):\n-                management.call_command('createcachetable', 'cache_table',\n-                                        database='default',\n-                                        verbosity=0, interactive=False)\n-            # cache table should be created on 'other'\n-            with self.assertNumQueries(1):\n-                management.call_command('createcachetable', 'cache_table',\n-                                        database='other',\n-                                        verbosity=0, interactive=False)\n-        finally:\n-            router.routers = old_routers\n-\n \n class LocMemCacheTests(unittest.TestCase, BaseCacheTests):\n     backend_name = 'django.core.cache.backends.locmem.LocMemCache'"
        }
    ],
    "stats": {
        "total": 61,
        "additions": 12,
        "deletions": 49
    }
}