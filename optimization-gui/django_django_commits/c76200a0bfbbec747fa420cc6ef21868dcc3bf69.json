{
    "author": "jezdez",
    "message": "Fixed #17819 -- Convinced the NamedUrlWizardView to stop dropping files when stepping through the forms.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17634 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c76200a0bfbbec747fa420cc6ef21868dcc3bf69",
    "files": [
        {
            "sha": "39e914d05d147538575668fd82be00cee1ab544e",
            "filename": "django/contrib/formtools/tests/wizard/namedwizardtests/forms.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/c76200a0bfbbec747fa420cc6ef21868dcc3bf69/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fnamedwizardtests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/c76200a0bfbbec747fa420cc6ef21868dcc3bf69/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fnamedwizardtests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fnamedwizardtests%2Fforms.py?ref=c76200a0bfbbec747fa420cc6ef21868dcc3bf69",
            "patch": "@@ -1,4 +1,8 @@\n+import os\n+import tempfile\n+\n from django import forms\n+from django.core.files.storage import FileSystemStorage\n from django.forms.formsets import formset_factory\n from django.http import HttpResponse\n from django.template import Template, Context\n@@ -7,6 +11,9 @@\n \n from django.contrib.formtools.wizard.views import NamedUrlWizardView\n \n+temp_storage_location = tempfile.mkdtemp(dir=os.environ.get('DJANGO_TEST_TEMP_DIR'))\n+temp_storage = FileSystemStorage(location=temp_storage_location)\n+\n class Page1(forms.Form):\n     name = forms.CharField(max_length=100)\n     user = forms.ModelChoiceField(queryset=User.objects.all())\n@@ -15,13 +22,16 @@ class Page1(forms.Form):\n class Page2(forms.Form):\n     address1 = forms.CharField(max_length=100)\n     address2 = forms.CharField(max_length=100)\n+    file1 = forms.FileField()\n \n class Page3(forms.Form):\n     random_crap = forms.CharField(max_length=100)\n \n Page4 = formset_factory(Page3, extra=2)\n \n class ContactWizard(NamedUrlWizardView):\n+    file_storage = temp_storage\n+\n     def done(self, form_list, **kwargs):\n         c = Context({\n             'form_list': [x.cleaned_data for x in form_list],"
        },
        {
            "sha": "550622180fe626ae43697730302355382aeafcfb",
            "filename": "django/contrib/formtools/tests/wizard/namedwizardtests/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 6,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/c76200a0bfbbec747fa420cc6ef21868dcc3bf69/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fnamedwizardtests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c76200a0bfbbec747fa420cc6ef21868dcc3bf69/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fnamedwizardtests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Fwizard%2Fnamedwizardtests%2Ftests.py?ref=c76200a0bfbbec747fa420cc6ef21868dcc3bf69",
            "patch": "@@ -8,6 +8,7 @@\n                                                    NamedUrlCookieWizardView)\n from django.contrib.formtools.tests.wizard.forms import get_request, Step1, Step2\n \n+\n class NamedWizardTests(object):\n     urls = 'django.contrib.formtools.tests.wizard.namedwizardtests.urls'\n \n@@ -30,7 +31,6 @@ def test_initial_call(self):\n         self.assertEqual(wizard['steps'].count, 4)\n         self.assertEqual(wizard['url_name'], self.wizard_urlname)\n \n-\n     def test_initial_call_with_params(self):\n         get_params = {'getvar1': 'getval1', 'getvar2': 'getval2'}\n         response = self.client.get(reverse('%s_start' % self.wizard_urlname),\n@@ -119,10 +119,12 @@ def test_form_finish(self):\n         self.assertEqual(response.status_code, 200)\n         self.assertEqual(response.context['wizard']['steps'].current, 'form2')\n \n+        post_data = self.wizard_step_data[1]\n+        post_data['form2-file1'] = open(__file__)\n         response = self.client.post(\n             reverse(self.wizard_urlname,\n                     kwargs={'step': response.context['wizard']['steps'].current}),\n-            self.wizard_step_data[1])\n+            post_data)\n         response = self.client.get(response['Location'])\n \n         self.assertEqual(response.status_code, 200)\n@@ -144,7 +146,10 @@ def test_form_finish(self):\n         response = self.client.get(response['Location'])\n         self.assertEqual(response.status_code, 200)\n \n-        self.assertEqual(response.context['form_list'], [\n+        all_data = response.context['form_list']\n+        self.assertEqual(all_data[1]['file1'].read(), open(__file__).read())\n+        del all_data[1]['file1']\n+        self.assertEqual(all_data, [\n             {'name': u'Pony', 'thirsty': True, 'user': self.testuser},\n             {'address1': u'123 Main St', 'address2': u'Djangoland'},\n             {'random_crap': u'blah blah'},\n@@ -162,13 +167,21 @@ def test_cleaned_data(self):\n         response = self.client.get(response['Location'])\n         self.assertEqual(response.status_code, 200)\n \n+        post_data = self.wizard_step_data[1]\n+        post_data['form2-file1'] = open(__file__)\n         response = self.client.post(\n             reverse(self.wizard_urlname,\n                     kwargs={'step': response.context['wizard']['steps'].current}),\n-            self.wizard_step_data[1])\n+            post_data)\n         response = self.client.get(response['Location'])\n         self.assertEqual(response.status_code, 200)\n \n+        step2_url = reverse(self.wizard_urlname, kwargs={'step': 'form2'})\n+        response = self.client.get(step2_url)\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.context['wizard']['steps'].current, 'form2')\n+        self.assertEqual(response.context['wizard']['form'].files['form2-file1'].read(), open(__file__).read())\n+\n         response = self.client.post(\n             reverse(self.wizard_urlname,\n                     kwargs={'step': response.context['wizard']['steps'].current}),\n@@ -183,8 +196,11 @@ def test_cleaned_data(self):\n         response = self.client.get(response['Location'])\n         self.assertEqual(response.status_code, 200)\n \n+        all_data = response.context['all_cleaned_data']\n+        self.assertEqual(all_data['file1'].read(), open(__file__).read())\n+        del all_data['file1']\n         self.assertEqual(\n-            response.context['all_cleaned_data'],\n+            all_data,\n             {'name': u'Pony', 'thirsty': True, 'user': self.testuser,\n              'address1': u'123 Main St', 'address2': u'Djangoland',\n              'random_crap': u'blah blah', 'formset-form4': [\n@@ -204,10 +220,12 @@ def test_manipulated_data(self):\n         response = self.client.get(response['Location'])\n         self.assertEqual(response.status_code, 200)\n \n+        post_data = self.wizard_step_data[1]\n+        post_data['form2-file1'] = open(__file__)\n         response = self.client.post(\n             reverse(self.wizard_urlname,\n                     kwargs={'step': response.context['wizard']['steps'].current}),\n-            self.wizard_step_data[1])\n+            post_data)\n         response = self.client.get(response['Location'])\n         self.assertEqual(response.status_code, 200)\n \n@@ -246,6 +264,7 @@ def test_form_reset(self):\n         self.assertEqual(response.status_code, 200)\n         self.assertEqual(response.context['wizard']['steps'].current, 'form1')\n \n+\n class NamedSessionWizardTests(NamedWizardTests, TestCase):\n     wizard_urlname = 'nwiz_session'\n     wizard_step_1_data = {\n@@ -276,6 +295,7 @@ class NamedSessionWizardTests(NamedWizardTests, TestCase):\n         }\n     )\n \n+\n class NamedCookieWizardTests(NamedWizardTests, TestCase):\n     wizard_urlname = 'nwiz_cookie'\n     wizard_step_1_data = {\n@@ -321,12 +341,14 @@ def test_revalidation(self):\n         instance.render_done(None)\n         self.assertEqual(instance.storage.current_step, 'start')\n \n+\n class TestNamedUrlSessionWizardView(NamedUrlSessionWizardView):\n \n     def dispatch(self, request, *args, **kwargs):\n         response = super(TestNamedUrlSessionWizardView, self).dispatch(request, *args, **kwargs)\n         return response, self\n \n+\n class TestNamedUrlCookieWizardView(NamedUrlCookieWizardView):\n \n     def dispatch(self, request, *args, **kwargs):"
        },
        {
            "sha": "06a03984a70522e5acfab6e7941cd3a4cbeb8cb0",
            "filename": "django/contrib/formtools/wizard/views.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/c76200a0bfbbec747fa420cc6ef21868dcc3bf69/django%2Fcontrib%2Fformtools%2Fwizard%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/c76200a0bfbbec747fa420cc6ef21868dcc3bf69/django%2Fcontrib%2Fformtools%2Fwizard%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Fwizard%2Fviews.py?ref=c76200a0bfbbec747fa420cc6ef21868dcc3bf69",
            "patch": "@@ -624,14 +624,14 @@ def get(self, *args, **kwargs):\n             # URL step name and storage step name are equal, render!\n             return self.render(self.get_form(\n                 data=self.storage.current_step_data,\n-                files=self.storage.current_step_data,\n+                files=self.storage.current_step_files,\n             ), **kwargs)\n \n         elif step_url in self.get_form_list():\n             self.storage.current_step = step_url\n             return self.render(self.get_form(\n                 data=self.storage.current_step_data,\n-                files=self.storage.current_step_data,\n+                files=self.storage.current_step_files,\n             ), **kwargs)\n \n         # invalid step name, reset to first and redirect."
        }
    ],
    "stats": {
        "total": 48,
        "additions": 40,
        "deletions": 8
    }
}