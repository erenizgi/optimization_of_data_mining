{
    "author": "spookylukey",
    "message": "Fixed #15863 - SimpleCookies are not correctly serialized with the file or database cache backends\n\nThanks to rakuco for the report and for the tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17200 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a935d436e9e11e1801ca5e9421a055e1f04eb125",
    "files": [
        {
            "sha": "476a62501c1a45556ed955f168e4c071fbef7410",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/a935d436e9e11e1801ca5e9421a055e1f04eb125/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a935d436e9e11e1801ca5e9421a055e1f04eb125/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=a935d436e9e11e1801ca5e9421a055e1f04eb125",
            "patch": "@@ -587,6 +587,17 @@ def __delitem__(self, header):\n     def __getitem__(self, header):\n         return self._headers[header.lower()][1]\n \n+    def __getstate__(self):\n+        # SimpleCookie is not pickeable with pickle.HIGHEST_PROTOCOL, so we\n+        # serialise to a string instead\n+        state = self.__dict__.copy()\n+        state['cookies'] = str(state['cookies'])\n+        return state\n+\n+    def __setstate__(self, state):\n+        self.__dict__.update(state)\n+        self.cookies = SimpleCookie(self.cookies)\n+\n     def has_header(self, header):\n         \"\"\"Case-insensitive check for a header.\"\"\"\n         return header.lower() in self._headers"
        },
        {
            "sha": "779e3fedf8a63334015c9f51eb6bc8341086e387",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/a935d436e9e11e1801ca5e9421a055e1f04eb125/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a935d436e9e11e1801ca5e9421a055e1f04eb125/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=a935d436e9e11e1801ca5e9421a055e1f04eb125",
            "patch": "@@ -176,6 +176,17 @@ def test_decr_version(self):\n class BaseCacheTests(object):\n     # A common set of tests to apply to all cache backends\n \n+    def _get_request_cache(self, path):\n+        request = HttpRequest()\n+        request.META = {\n+            'SERVER_NAME': 'testserver',\n+            'SERVER_PORT': 80,\n+        }\n+        request.path = request.path_info = path\n+        request._cache_update_cache = True\n+        request.method = 'GET'\n+        return request\n+\n     def test_simple(self):\n         # Simple cache set/get works\n         self.cache.set(\"key\", \"value\")\n@@ -741,6 +752,35 @@ def test_custom_key_func(self):\n         self.assertEqual(self.custom_key_cache2.get('answer2'), 42)\n \n \n+    def test_cache_write_unpickable_object(self):\n+        update_middleware = UpdateCacheMiddleware()\n+        update_middleware.cache = self.cache\n+\n+        fetch_middleware = FetchFromCacheMiddleware()\n+        fetch_middleware.cache = self.cache\n+\n+        request = self._get_request_cache('/cache/test')\n+        get_cache_data = FetchFromCacheMiddleware().process_request(request)\n+        self.assertEqual(get_cache_data, None)\n+\n+        response = HttpResponse()\n+        content = 'Testing cookie serialization.'\n+        response.content = content\n+        response.set_cookie('foo', 'bar')\n+\n+        update_middleware.process_response(request, response)\n+\n+        get_cache_data = fetch_middleware.process_request(request)\n+        self.assertNotEqual(get_cache_data, None)\n+        self.assertEqual(get_cache_data.content, content)\n+        self.assertEqual(get_cache_data.cookies, response.cookies)\n+\n+        update_middleware.process_response(request, get_cache_data)\n+        get_cache_data = fetch_middleware.process_request(request)\n+        self.assertNotEqual(get_cache_data, None)\n+        self.assertEqual(get_cache_data.content, content)\n+        self.assertEqual(get_cache_data.cookies, response.cookies)\n+\n def custom_key_func(key, key_prefix, version):\n     \"A customized cache key function\"\n     return 'CUSTOM-' + '-'.join([key_prefix, str(version), key])"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 51,
        "deletions": 0
    }
}