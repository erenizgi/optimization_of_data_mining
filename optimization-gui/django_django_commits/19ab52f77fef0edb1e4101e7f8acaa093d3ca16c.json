{
    "author": "jezdez",
    "message": "Fixed #15035 -- Fixed collectstatic management command to work with non-local storage backends correctly. Also refactored a bit code smell.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15154 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "19ab52f77fef0edb1e4101e7f8acaa093d3ca16c",
    "files": [
        {
            "sha": "50b4d55f06d4b704853717b329554491b328539d",
            "filename": "django/contrib/staticfiles/management/commands/collectstatic.py",
            "status": "modified",
            "additions": 38,
            "deletions": 44,
            "changes": 82,
            "blob_url": "https://github.com/django/django/blob/19ab52f77fef0edb1e4101e7f8acaa093d3ca16c/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "raw_url": "https://github.com/django/django/raw/19ab52f77fef0edb1e4101e7f8acaa093d3ca16c/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fmanagement%2Fcommands%2Fcollectstatic.py?ref=19ab52f77fef0edb1e4101e7f8acaa093d3ca16c",
            "patch": "@@ -32,23 +32,27 @@ class Command(NoArgsCommand):\n     )\n     help = \"Collect static files from apps and other locations in a single location.\"\n \n-    def handle_noargs(self, **options):\n-        symlink = options['link']\n-        ignore_patterns = options['ignore_patterns']\n-        if options['use_default_ignore_patterns']:\n-            ignore_patterns += ['CVS', '.*', '*~']\n-        ignore_patterns = list(set(ignore_patterns))\n+    def __init__(self, *args, **kwargs):\n         self.copied_files = set()\n         self.symlinked_files = set()\n         self.unmodified_files = set()\n         self.destination_storage = get_storage_class(settings.STATICFILES_STORAGE)()\n-\n         try:\n             self.destination_storage.path('')\n         except NotImplementedError:\n             self.destination_local = False\n         else:\n             self.destination_local = True\n+        # Use ints for file times (ticket #14665)\n+        os.stat_float_times(False)\n+\n+    def handle_noargs(self, **options):\n+        symlink = options['link']\n+        ignore_patterns = options['ignore_patterns']\n+        if options['use_default_ignore_patterns']:\n+            ignore_patterns += ['CVS', '.*', '*~']\n+        ignore_patterns = list(set(ignore_patterns))\n+        self.verbosity = int(options.get('verbosity', 1))\n \n         if symlink:\n             if sys.platform == 'win32':\n@@ -70,24 +74,29 @@ def handle_noargs(self, **options):\n             if confirm != 'yes':\n                 raise CommandError(\"Collecting static files cancelled.\")\n \n-        # Use ints for file times (ticket #14665)\n-        os.stat_float_times(False)\n-\n         for finder in finders.get_finders():\n             for source, prefix, storage in finder.list(ignore_patterns):\n                 self.copy_file(source, prefix, storage, **options)\n \n-        verbosity = int(options.get('verbosity', 1))\n         actual_count = len(self.copied_files) + len(self.symlinked_files)\n         unmodified_count = len(self.unmodified_files)\n-        if verbosity >= 1:\n+        if self.verbosity >= 1:\n             self.stdout.write(\"\\n%s static file%s %s to '%s'%s.\\n\"\n                               % (actual_count, actual_count != 1 and 's' or '',\n                                  symlink and 'symlinked' or 'copied',\n                                  settings.STATIC_ROOT,\n                                  unmodified_count and ' (%s unmodified)'\n                                  % unmodified_count or ''))\n \n+    def log(self, msg, level=2):\n+        \"\"\"\n+        Small log helper\n+        \"\"\"\n+        if not msg.endswith(\"\\n\"):\n+            msg += \"\\n\"\n+        if self.verbosity >= level:\n+            self.stdout.write(msg)\n+\n     def copy_file(self, source, prefix, source_storage, **options):\n         \"\"\"\n         Attempt to copy (or symlink) ``source`` to ``destination``,\n@@ -104,18 +113,13 @@ def copy_file(self, source, prefix, source_storage, **options):\n             destination = source\n         symlink = options['link']\n         dry_run = options['dry_run']\n-        verbosity = int(options.get('verbosity', 1))\n \n         if destination in self.copied_files:\n-            if verbosity >= 2:\n-                self.stdout.write(\"Skipping '%s' (already copied earlier)\\n\"\n-                                  % destination)\n+            self.log(\"Skipping '%s' (already copied earlier)\" % destination)\n             return False\n \n         if destination in self.symlinked_files:\n-            if verbosity >= 2:\n-                self.stdout.write(\"Skipping '%s' (already linked earlier)\\n\"\n-                                  % destination)\n+            self.log(\"Skipping '%s' (already linked earlier)\" % destination)\n             return False\n \n         if self.destination_storage.exists(destination):\n@@ -126,34 +130,27 @@ def copy_file(self, source, prefix, source_storage, **options):\n                 # storage doesn't support ``modified_time`` or failed.\n                 pass\n             else:\n-                destination_is_link = os.path.islink(\n-                    self.destination_storage.path(destination))\n+                destination_is_link = (self.destination_local and\n+                    os.path.islink(self.destination_storage.path(destination)))\n                 if destination_last_modified >= source_last_modified:\n                     if (not symlink and not destination_is_link):\n-                        if verbosity >= 2:\n-                            self.stdout.write(\"Skipping '%s' (not modified)\\n\"\n-                                              % destination)\n+                        self.log(\"Skipping '%s' (not modified)\" % destination)\n                         self.unmodified_files.add(destination)\n                         return False\n             if dry_run:\n-                if verbosity >= 2:\n-                    self.stdout.write(\"Pretending to delete '%s'\\n\"\n-                                      % destination)\n+                self.log(\"Pretending to delete '%s'\" % destination)\n             else:\n-                if verbosity >= 2:\n-                    self.stdout.write(\"Deleting '%s'\\n\" % destination)\n+                self.log(\"Deleting '%s'\" % destination)\n                 self.destination_storage.delete(destination)\n \n         if symlink:\n             destination_path = self.destination_storage.path(destination)\n             if dry_run:\n-                if verbosity >= 1:\n-                    self.stdout.write(\"Pretending to symlink '%s' to '%s'\\n\"\n-                                      % (source_path, destination_path))\n+                self.log(\"Pretending to link '%s' to '%s'\" %\n+                         (source_path, destination_path), level=1)\n             else:\n-                if verbosity >= 1:\n-                    self.stdout.write(\"Symlinking '%s' to '%s'\\n\"\n-                                      % (source_path, destination_path))\n+                self.log(\"Linking '%s' to '%s'\" %\n+                         (source_path, destination_path), level=1)\n                 try:\n                     os.makedirs(os.path.dirname(destination_path))\n                 except OSError:\n@@ -162,9 +159,8 @@ def copy_file(self, source, prefix, source_storage, **options):\n             self.symlinked_files.add(destination)\n         else:\n             if dry_run:\n-                if verbosity >= 1:\n-                    self.stdout.write(\"Pretending to copy '%s' to '%s'\\n\"\n-                                      % (source_path, destination))\n+                self.log(\"Pretending to copy '%s' to '%s'\" %\n+                         (source_path, destination), level=1)\n             else:\n                 if self.destination_local:\n                     destination_path = self.destination_storage.path(destination)\n@@ -173,14 +169,12 @@ def copy_file(self, source, prefix, source_storage, **options):\n                     except OSError:\n                         pass\n                     shutil.copy2(source_path, destination_path)\n-                    if verbosity >= 1:\n-                        self.stdout.write(\"Copying '%s' to '%s'\\n\"\n-                                          % (source_path, destination_path))\n+                    self.log(\"Copying '%s' to '%s'\" %\n+                             (source_path, destination_path), level=1)\n                 else:\n                     source_file = source_storage.open(source)\n                     self.destination_storage.save(destination, source_file)\n-                    if verbosity >= 1:\n-                        self.stdout.write(\"Copying %s to %s\\n\"\n-                                          % (source_path, destination))\n+                    self.log(\"Copying %s to %s\" %\n+                             (source_path, destination), level=1)\n             self.copied_files.add(destination)\n         return True"
        },
        {
            "sha": "cfe1e13bdb0a971f6602615c070c5b2c3bf8dda9",
            "filename": "tests/regressiontests/staticfiles_tests/storage.py",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/19ab52f77fef0edb1e4101e7f8acaa093d3ca16c/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/19ab52f77fef0edb1e4101e7f8acaa093d3ca16c/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py?ref=19ab52f77fef0edb1e4101e7f8acaa093d3ca16c",
            "patch": "@@ -0,0 +1,19 @@\n+from datetime import datetime\n+from django.core.files import storage\n+\n+class DummyStorage(storage.Storage):\n+    \"\"\"\n+    A storage class that does implement modified_time() but raises\n+    NotImplementedError when calling \n+    \"\"\"\n+    def _save(self, name, content):\n+        return 'dummy'\n+\n+    def delete(self, name):\n+        pass\n+\n+    def exists(self, name):\n+        pass\n+\n+    def modified_time(self, name):\n+        return datetime.date(1970, 1, 1)"
        },
        {
            "sha": "62286c726758d10aa70331f8f8a67bad84e85e43",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 23,
            "deletions": 7,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/19ab52f77fef0edb1e4101e7f8acaa093d3ca16c/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/19ab52f77fef0edb1e4101e7f8acaa093d3ca16c/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=19ab52f77fef0edb1e4101e7f8acaa093d3ca16c",
            "patch": "@@ -92,7 +92,6 @@ class BuildStaticTestCase(StaticFilesTestCase):\n     \"\"\"\n     def setUp(self):\n         super(BuildStaticTestCase, self).setUp()\n-        self.old_staticfiles_storage = settings.STATICFILES_STORAGE\n         self.old_root = settings.STATIC_ROOT\n         settings.STATIC_ROOT = tempfile.mkdtemp()\n         self.run_collectstatic()\n@@ -220,18 +219,35 @@ def test_no_common_ignore_patterns(self):\n         self.assertFileContains('test/CVS', 'should be ignored')\n \n \n-class TestBuildStaticDryRun(BuildStaticTestCase):\n+class TestNoFilesCreated(object):\n+\n+    def test_no_files_created(self):\n+        \"\"\"\n+        Make sure no files were create in the destination directory.\n+        \"\"\"\n+        self.assertEquals(os.listdir(settings.STATIC_ROOT), [])\n+\n+\n+class TestBuildStaticDryRun(BuildStaticTestCase, TestNoFilesCreated):\n     \"\"\"\n     Test ``--dry-run`` option for ``collectstatic`` management command.\n     \"\"\"\n     def run_collectstatic(self):\n         super(TestBuildStaticDryRun, self).run_collectstatic(dry_run=True)\n \n-    def test_no_files_created(self):\n-        \"\"\"\n-        With --dry-run, no files created in destination dir.\n-        \"\"\"\n-        self.assertEquals(os.listdir(settings.STATIC_ROOT), [])\n+\n+class TestBuildStaticNonLocalStorage(BuildStaticTestCase, TestNoFilesCreated):\n+    \"\"\"\n+    Tests for #15035\n+    \"\"\"\n+    def setUp(self):\n+        self.old_staticfiles_storage = settings.STATICFILES_STORAGE\n+        settings.STATICFILES_STORAGE = 'regressiontests.staticfiles_tests.storage.DummyStorage'\n+        super(TestBuildStaticNonLocalStorage, self).setUp()\n+\n+    def tearDown(self):\n+        super(TestBuildStaticNonLocalStorage, self).tearDown()\n+        settings.STATICFILES_STORAGE = self.old_staticfiles_storage\n \n \n if sys.platform != 'win32':"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 80,
        "deletions": 51
    }
}