{
    "author": "aaugustin",
    "message": "Fixed #16899 -- Backported the fix for http://bugs.python.org/issue9063 and added a test.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16980 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f830166167833cfb7c990764f72373a9f4494259",
    "files": [
        {
            "sha": "daffffb49625277731082859511e4f92f14b7f17",
            "filename": "django/utils/tzinfo.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/f830166167833cfb7c990764f72373a9f4494259/django%2Futils%2Ftzinfo.py",
            "raw_url": "https://github.com/django/django/raw/f830166167833cfb7c990764f72373a9f4494259/django%2Futils%2Ftzinfo.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftzinfo.py?ref=f830166167833cfb7c990764f72373a9f4494259",
            "patch": "@@ -57,7 +57,9 @@ def tzname(self, dt):\n             return None\n \n     def _isdst(self, dt):\n-        tt = (dt.year, dt.month, dt.day, dt.hour, dt.minute, dt.second, dt.weekday(), 0, -1)\n+        tt = (dt.year, dt.month, dt.day,\n+              dt.hour, dt.minute, dt.second,\n+              dt.weekday(), 0, 0)\n         try:\n             stamp = time.mktime(tt)\n         except (OverflowError, ValueError):"
        },
        {
            "sha": "a60a4574dea339c10dbd11110ec88fa032b0bade",
            "filename": "tests/regressiontests/utils/tzinfo.py",
            "status": "modified",
            "additions": 47,
            "deletions": 3,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/f830166167833cfb7c990764f72373a9f4494259/tests%2Fregressiontests%2Futils%2Ftzinfo.py",
            "raw_url": "https://github.com/django/django/raw/f830166167833cfb7c990764f72373a9f4494259/tests%2Fregressiontests%2Futils%2Ftzinfo.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Ftzinfo.py?ref=f830166167833cfb7c990764f72373a9f4494259",
            "patch": "@@ -1,9 +1,35 @@\n-import unittest\n-\n-from django.utils.tzinfo import FixedOffset\n+import datetime\n+import os\n+import time\n+from django.utils.tzinfo import FixedOffset, LocalTimezone\n+from django.utils import unittest\n \n class TzinfoTests(unittest.TestCase):\n \n+    @classmethod\n+    def setUpClass(cls):\n+        cls.old_TZ = os.environ.get('TZ')\n+        os.environ['TZ'] = 'US/Eastern'\n+\n+        try:\n+            # Check if a timezone has been set\n+            time.tzset()\n+            cls.tz_tests = True\n+        except AttributeError:\n+            # No timezone available. Don't run the tests that require a TZ\n+            cls.tz_tests = False\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        if cls.old_TZ is None:\n+            del os.environ['TZ']\n+        else:\n+            os.environ['TZ'] = cls.old_TZ\n+\n+        # Cleanup - force re-evaluation of TZ environment variable.\n+        if cls.tz_tests:\n+            time.tzset()\n+\n     def test_fixedoffset(self):\n         self.assertEqual(repr(FixedOffset(0)), '+0000')\n         self.assertEqual(repr(FixedOffset(60)), '+0100')\n@@ -16,3 +42,21 @@ def test_fixedoffset(self):\n         self.assertEqual(repr(FixedOffset(5.5*60)), '+0530')\n         self.assertEqual(repr(FixedOffset(-.5*60)), '-0030')\n         self.assertEqual(repr(FixedOffset(.5*60)), '+0030')\n+\n+    def test_16899(self):\n+        if not self.tz_tests:\n+            return\n+        ts = 1289106000\n+        # Midnight at the end of DST in US/Eastern: 2010-11-07T05:00:00Z\n+        dt = datetime.datetime.utcfromtimestamp(ts)\n+        # US/Eastern -- we force its representation to \"EST\"\n+        tz = LocalTimezone(dt + datetime.timedelta(days=1))\n+        self.assertEqual(\n+                repr(datetime.datetime.fromtimestamp(ts - 3600, tz)),\n+                'datetime.datetime(2010, 11, 7, 0, 0, tzinfo=EST)')\n+        self.assertEqual(\n+                repr(datetime.datetime.fromtimestamp(ts, tz)),\n+                'datetime.datetime(2010, 11, 7, 1, 0, tzinfo=EST)')\n+        self.assertEqual(\n+                repr(datetime.datetime.fromtimestamp(ts + 3600, tz)),\n+                'datetime.datetime(2010, 11, 7, 1, 0, tzinfo=EST)')"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 50,
        "deletions": 4
    }
}