{
    "author": "aaugustin",
    "message": "Fixed #18353 -- Inconsistency in date-based CBVs.",
    "sha": "3b2993ed04f200a89c2d49590131c97c8974e9ac",
    "files": [
        {
            "sha": "3e6ab0fa0ca048184d97f1854fbfba2b39c927a5",
            "filename": "django/views/generic/dates.py",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/3b2993ed04f200a89c2d49590131c97c8974e9ac/django%2Fviews%2Fgeneric%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/3b2993ed04f200a89c2d49590131c97c8974e9ac/django%2Fviews%2Fgeneric%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Fdates.py?ref=3b2993ed04f200a89c2d49590131c97c8974e9ac",
            "patch": "@@ -37,6 +37,18 @@ def get_year(self):\n                     raise Http404(_(u\"No year specified\"))\n         return year\n \n+    def get_next_year(self, date):\n+        \"\"\"\n+        Get the next valid year.\n+        \"\"\"\n+        return _get_next_prev(self, date, is_previous=False, period='year')\n+\n+    def get_previous_year(self, date):\n+        \"\"\"\n+        Get the previous valid year.\n+        \"\"\"\n+        return _get_next_prev(self, date, is_previous=True, period='year')\n+\n     def _get_next_year(self, date):\n         \"\"\"\n         Return the start date of the next interval.\n@@ -419,7 +431,11 @@ def get_dated_items(self):\n             # to find information about the model.\n             qs = qs.none()\n \n-        return (date_list, qs, {'year': year})\n+        return (date_list, qs, {\n+            'year': date,\n+            'next_year': self.get_next_year(date),\n+            'previous_year': self.get_previous_year(date),\n+        })\n \n     def get_make_object_list(self):\n         \"\"\""
        },
        {
            "sha": "acd9db2d6650e07033e9ef5361c5b457aeadfbcc",
            "filename": "docs/ref/class-based-views.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/3b2993ed04f200a89c2d49590131c97c8974e9ac/docs%2Fref%2Fclass-based-views.txt",
            "raw_url": "https://github.com/django/django/raw/3b2993ed04f200a89c2d49590131c97c8974e9ac/docs%2Fref%2Fclass-based-views.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fclass-based-views.txt?ref=3b2993ed04f200a89c2d49590131c97c8974e9ac",
            "patch": "@@ -1171,7 +1171,15 @@ YearArchiveView\n       have objects available according to ``queryset``, represented as\n       ``datetime.datetime`` objects, in ascending order.\n \n-    * ``year``: The given year, as a four-character string.\n+    * ``year``: A ``datetime.date`` object representing the given year.\n+\n+    * ``next_year``: A ``datetime.date`` object representing the first day\n+      of the next year. If the next year is in the future, this will be\n+      ``None``.\n+\n+    * ``previous_year``: A ``datetime.date`` object representing the first\n+      day of the previous year. Unlike ``next_year``, this will never be\n+      ``None``.\n \n     **Notes**\n "
        },
        {
            "sha": "e11991b257a1853a35635d2e1c22eeef7da70712",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/3b2993ed04f200a89c2d49590131c97c8974e9ac/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/3b2993ed04f200a89c2d49590131c97c8974e9ac/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=3b2993ed04f200a89c2d49590131c97c8974e9ac",
            "patch": "@@ -71,6 +71,18 @@ Backwards incompatible changes in 1.5\n     deprecation timeline for a given feature, its removal may appear as a\n     backwards incompatible change.\n \n+Context in year archive class-based views\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+For consistency with the other date-based generic views,\n+:class:`~django.views.generic.dates.YearArchiveView` now passes ``year`` in\n+the context as a :class:`datetime.date` rather than a string.  If you are\n+using ``{{ year }}`` in your templates, you must replace it with ``{{\n+year|date:\"Y\" }}``.\n+\n+``next_year`` and ``previous_year`` were also added in the context. They are\n+calculated according to ``allow_empty`` and ``allow_future``.\n+\n Features deprecated in 1.5\n ==========================\n \n@@ -86,4 +98,4 @@ our own copy of ``simplejson``. You can safely change any use of\n ~~~~~~~~~~~~~~~~~~~~~~\n \n The :func:`~django.utils.itercompat.product` function has been deprecated. Use\n-the built-in `itertools.product` instead.\n+the built-in :func:`itertools.product` instead."
        },
        {
            "sha": "ad65fd9f10f042c72db85bf2e841e496564ced28",
            "filename": "tests/regressiontests/generic_views/dates.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/3b2993ed04f200a89c2d49590131c97c8974e9ac/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/3b2993ed04f200a89c2d49590131c97c8974e9ac/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Fdates.py?ref=3b2993ed04f200a89c2d49590131c97c8974e9ac",
            "patch": "@@ -115,9 +115,13 @@ def test_year_view(self):\n         res = self.client.get('/dates/books/2008/')\n         self.assertEqual(res.status_code, 200)\n         self.assertEqual(list(res.context['date_list']), [datetime.datetime(2008, 10, 1)])\n-        self.assertEqual(res.context['year'], '2008')\n+        self.assertEqual(res.context['year'], datetime.date(2008, 1, 1))\n         self.assertTemplateUsed(res, 'generic_views/book_archive_year.html')\n \n+        # Since allow_empty=False, next/prev years must be valid (#7164)\n+        self.assertEqual(res.context['next_year'], None)\n+        self.assertEqual(res.context['previous_year'], datetime.date(2006, 1, 1))\n+\n     def test_year_view_make_object_list(self):\n         res = self.client.get('/dates/books/2006/make_object_list/')\n         self.assertEqual(res.status_code, 200)\n@@ -134,6 +138,10 @@ def test_year_view_empty(self):\n         self.assertEqual(list(res.context['date_list']), [])\n         self.assertEqual(list(res.context['book_list']), [])\n \n+        # Since allow_empty=True, next/prev are allowed to be empty years (#7164)\n+        self.assertEqual(res.context['next_year'], datetime.date(2000, 1, 1))\n+        self.assertEqual(res.context['previous_year'], datetime.date(1998, 1, 1))\n+\n     def test_year_view_allow_future(self):\n         # Create a new book in the future\n         year = datetime.date.today().year + 1\n@@ -162,7 +170,7 @@ def test_year_view_invalid_pattern(self):\n \n     def test_no_duplicate_query(self):\n         # Regression test for #18354\n-        with self.assertNumQueries(2):\n+        with self.assertNumQueries(4):\n             self.client.get('/dates/books/2008/reverse/')\n \n     def test_datetime_year_view(self):"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 49,
        "deletions": 5
    }
}