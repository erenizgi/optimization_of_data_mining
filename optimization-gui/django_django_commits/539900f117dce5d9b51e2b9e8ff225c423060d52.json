{
    "author": "ambv",
    "message": "Fixes #17866: Vary: Accept-Language header when language prefix used",
    "sha": "539900f117dce5d9b51e2b9e8ff225c423060d52",
    "files": [
        {
            "sha": "be0e5494956e62aa68f05114d0a9f612181195f2",
            "filename": "django/middleware/locale.py",
            "status": "modified",
            "additions": 17,
            "deletions": 9,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/539900f117dce5d9b51e2b9e8ff225c423060d52/django%2Fmiddleware%2Flocale.py",
            "raw_url": "https://github.com/django/django/raw/539900f117dce5d9b51e2b9e8ff225c423060d52/django%2Fmiddleware%2Flocale.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Flocale.py?ref=539900f117dce5d9b51e2b9e8ff225c423060d52",
            "patch": "@@ -17,6 +17,14 @@ class LocaleMiddleware(object):\n     is available, of course).\n     \"\"\"\n \n+    def __init__(self):\n+        self._supported_languages = dict(settings.LANGUAGES)\n+        self._is_language_prefix_patterns_used = False\n+        for url_pattern in get_resolver(None).url_patterns:\n+            if isinstance(url_pattern, LocaleRegexURLResolver):\n+                self._is_language_prefix_patterns_used = True\n+                break\n+\n     def process_request(self, request):\n         check_path = self.is_language_prefix_patterns_used()\n         language = translation.get_language_from_request(\n@@ -26,9 +34,11 @@ def process_request(self, request):\n \n     def process_response(self, request, response):\n         language = translation.get_language()\n-        if (response.status_code == 404 and\n-                not translation.get_language_from_path(request.path_info)\n-                    and self.is_language_prefix_patterns_used()):\n+        language_from_path = translation.get_language_from_path(\n+                request.path_info, supported=self._supported_languages\n+        )\n+        if (response.status_code == 404 and not language_from_path\n+                and self.is_language_prefix_patterns_used()):\n             urlconf = getattr(request, 'urlconf', None)\n             language_path = '/%s%s' % (language, request.path_info)\n             path_valid = is_valid_path(language_path, urlconf)\n@@ -42,8 +52,9 @@ def process_response(self, request, response):\n                     request.get_host(), language, request.get_full_path())\n                 return HttpResponseRedirect(language_url)\n         translation.deactivate()\n-\n-        patch_vary_headers(response, ('Accept-Language',))\n+        if not (self.is_language_prefix_patterns_used()\n+                and language_from_path):\n+            patch_vary_headers(response, ('Accept-Language',))\n         if 'Content-Language' not in response:\n             response['Content-Language'] = language\n         return response\n@@ -53,7 +64,4 @@ def is_language_prefix_patterns_used(self):\n         Returns `True` if the `LocaleRegexURLResolver` is used\n         at root level of the urlpatterns, else it returns `False`.\n         \"\"\"\n-        for url_pattern in get_resolver(None).url_patterns:\n-            if isinstance(url_pattern, LocaleRegexURLResolver):\n-                return True\n-        return False\n+        return self._is_language_prefix_patterns_used"
        },
        {
            "sha": "ace87fab4b5db35c2d80bd5c76d763470f47e19f",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/539900f117dce5d9b51e2b9e8ff225c423060d52/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/539900f117dce5d9b51e2b9e8ff225c423060d52/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=539900f117dce5d9b51e2b9e8ff225c423060d52",
            "patch": "@@ -165,8 +165,8 @@ def to_locale(language):\n def get_language_from_request(request, check_path=False):\n     return _trans.get_language_from_request(request, check_path)\n \n-def get_language_from_path(path):\n-    return _trans.get_language_from_path(path)\n+def get_language_from_path(path, supported=None):\n+    return _trans.get_language_from_path(path, supported=supported)\n \n def templatize(src, origin=None):\n     return _trans.templatize(src, origin)"
        },
        {
            "sha": "7ef07793a42903b1bfe3d4f830349ffd2c9e793b",
            "filename": "django/utils/translation/trans_null.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/539900f117dce5d9b51e2b9e8ff225c423060d52/django%2Futils%2Ftranslation%2Ftrans_null.py",
            "raw_url": "https://github.com/django/django/raw/539900f117dce5d9b51e2b9e8ff225c423060d52/django%2Futils%2Ftranslation%2Ftrans_null.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2Ftrans_null.py?ref=539900f117dce5d9b51e2b9e8ff225c423060d52",
            "patch": "@@ -58,6 +58,6 @@ def to_locale(language):\n def get_language_from_request(request, check_path=False):\n     return settings.LANGUAGE_CODE\n \n-def get_language_from_path(request):\n+def get_language_from_path(request, supported=None):\n     return None\n "
        },
        {
            "sha": "0a785ab1d61385048e986b873c68ab44e023a2d2",
            "filename": "tests/regressiontests/i18n/patterns/tests.py",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/539900f117dce5d9b51e2b9e8ff225c423060d52/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/539900f117dce5d9b51e2b9e8ff225c423060d52/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fpatterns%2Ftests.py?ref=539900f117dce5d9b51e2b9e8ff225c423060d52",
            "patch": "@@ -172,6 +172,26 @@ def test_pt_br_redirect(self):\n         self.assertEqual(response.status_code, 200)\n \n \n+class URLVaryAcceptLanguageTests(URLTestCaseBase):\n+    \"\"\"\n+    Tests that 'Accept-Language' is not added to the Vary header when using\n+    prefixed URLs. \n+    \"\"\"\n+    def test_no_prefix_response(self):\n+        response = self.client.get('/not-prefixed/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.get('Vary'), 'Accept-Language')\n+\n+    def test_en_redirect(self):\n+        response = self.client.get('/account/register/', HTTP_ACCEPT_LANGUAGE='en')\n+        self.assertRedirects(response, '/en/account/register/')\n+        self.assertFalse(response.get('Vary'))\n+\n+        response = self.client.get(response['location'])\n+        self.assertEqual(response.status_code, 200)\n+        self.assertFalse(response.get('Vary'))\n+\n+\n class URLRedirectWithoutTrailingSlashTests(URLTestCaseBase):\n     \"\"\"\n     Tests the redirect when the requested URL doesn't end with a slash"
        },
        {
            "sha": "aaa9b12c3b519993e1c266b1edc06f6677312753",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/539900f117dce5d9b51e2b9e8ff225c423060d52/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/539900f117dce5d9b51e2b9e8ff225c423060d52/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=539900f117dce5d9b51e2b9e8ff225c423060d52",
            "patch": "@@ -48,7 +48,8 @@\n from .patterns.tests import (URLRedirectWithoutTrailingSlashTests,\n     URLTranslationTests, URLDisabledTests, URLTagTests, URLTestCaseBase,\n     URLRedirectWithoutTrailingSlashSettingTests, URLNamespaceTests,\n-    URLPrefixTests, URLResponseTests, URLRedirectTests, PathUnusedTests)\n+    URLPrefixTests, URLResponseTests, URLRedirectTests, PathUnusedTests,\n+    URLVaryAcceptLanguageTests)\n \n \n here = os.path.dirname(os.path.abspath(upath(__file__)))"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 42,
        "deletions": 13
    }
}