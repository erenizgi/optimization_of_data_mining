{
    "author": "aaugustin",
    "message": "Fixed #11911 -- Made the urlize filter smarter with closing punctuation.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17362 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "15d10a5210378bba88c7dfa1f45a4d3528ddfc3f",
    "files": [
        {
            "sha": "d04e75f856f7d17e52e25e5f6bcdef6dc80e7ad4",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/15d10a5210378bba88c7dfa1f45a4d3528ddfc3f/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/15d10a5210378bba88c7dfa1f45a4d3528ddfc3f/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=15d10a5210378bba88c7dfa1f45a4d3528ddfc3f",
            "patch": "@@ -11,18 +11,15 @@\n from django.utils.text import normalize_newlines\n \n # Configuration for urlize() function.\n-LEADING_PUNCTUATION  = ['(', '<', '&lt;']\n-TRAILING_PUNCTUATION = ['.', ',', ')', '>', '\\n', '&gt;']\n+TRAILING_PUNCTUATION = ['.', ',', ':', ';']\n+WRAPPING_PUNCTUATION = [('(', ')'), ('<', '>'), ('&lt;', '&gt;')]\n \n # List of possible strings used for bullets in bulleted lists.\n DOTS = [u'&middot;', u'*', u'\\u2022', u'&#149;', u'&bull;', u'&#8226;']\n \n unencoded_ampersands_re = re.compile(r'&(?!(\\w+|#\\d+);)')\n unquoted_percents_re = re.compile(r'%(?![0-9A-Fa-f]{2})')\n word_split_re = re.compile(r'(\\s+)')\n-punctuation_re = re.compile('^(?P<lead>(?:%s)*)(?P<middle>.*?)(?P<trail>(?:%s)*)$' % \\\n-    ('|'.join([re.escape(x) for x in LEADING_PUNCTUATION]),\n-    '|'.join([re.escape(x) for x in TRAILING_PUNCTUATION])))\n simple_url_re = re.compile(r'^https?://\\w')\n simple_url_2_re = re.compile(r'^www\\.|^(?!http)\\w[^@]+\\.(com|edu|gov|int|mil|net|org|[a-z]{2})$')\n simple_email_re = re.compile(r'^\\S+@\\S+\\.\\S+$')\n@@ -147,9 +144,22 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n     for i, word in enumerate(words):\n         match = None\n         if '.' in word or '@' in word or ':' in word:\n-            match = punctuation_re.match(word)\n-        if match:\n-            lead, middle, trail = match.groups()\n+            # Deal with punctuation.\n+            lead, middle, trail = '', word, ''\n+            for punctuation in TRAILING_PUNCTUATION:\n+                if middle.endswith(punctuation):\n+                    middle = middle[:-len(punctuation)]\n+                    trail = punctuation + trail\n+            for opening, closing in WRAPPING_PUNCTUATION:\n+                if middle.startswith(opening):\n+                    middle = middle[len(opening):]\n+                    lead = lead + opening\n+                # Keep parentheses at the end only if they're balanced.\n+                if (middle.endswith(closing)\n+                    and middle.count(closing) == middle.count(opening) + 1):\n+                    middle = middle[:-len(closing)]\n+                    trail = closing + trail\n+\n             # Make URL we want to point to.\n             url = None\n             nofollow_attr = ' rel=\"nofollow\"' if nofollow else ''\n@@ -162,6 +172,7 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n                 domain = domain.encode('idna')\n                 url = 'mailto:%s@%s' % (local, domain)\n                 nofollow_attr = ''\n+\n             # Make link.\n             if url:\n                 trimmed = trim_url(middle)"
        },
        {
            "sha": "00807b0360fb4f3c9a6ebe938c1a57ac4b51e106",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/15d10a5210378bba88c7dfa1f45a4d3528ddfc3f/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/15d10a5210378bba88c7dfa1f45a4d3528ddfc3f/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=15d10a5210378bba88c7dfa1f45a4d3528ddfc3f",
            "patch": "@@ -253,6 +253,14 @@ def test_urlize(self):\n             u'<a href=\"http://en.wikipedia.org/wiki/Caf%C3%A9\" rel=\"nofollow\">'\n             u'http://en.wikipedia.org/wiki/Caf√©</a>')\n \n+        # Check urlize keeps balanced parentheses - see #11911\n+        self.assertEqual(urlize('http://en.wikipedia.org/wiki/Django_(web_framework)'),\n+            u'<a href=\"http://en.wikipedia.org/wiki/Django_(web_framework)\" rel=\"nofollow\">'\n+            u'http://en.wikipedia.org/wiki/Django_(web_framework)</a>')\n+        self.assertEqual(urlize('(see http://en.wikipedia.org/wiki/Django_(web_framework))'),\n+            u'(see <a href=\"http://en.wikipedia.org/wiki/Django_(web_framework)\" rel=\"nofollow\">'\n+            u'http://en.wikipedia.org/wiki/Django_(web_framework)</a>)')\n+\n         # Check urlize adds nofollow properly - see #12183\n         self.assertEqual(urlize('foo@bar.com or www.bar.com'),\n             u'<a href=\"mailto:foo@bar.com\">foo@bar.com</a> or '"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 27,
        "deletions": 8
    }
}