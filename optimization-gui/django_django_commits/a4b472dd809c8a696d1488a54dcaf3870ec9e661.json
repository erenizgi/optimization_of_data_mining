{
    "author": "aaugustin",
    "message": "Fixed #8995 -- Added support for HTTPS in sitemaps.\n\nModularized tests and did a bit of cleanup while I was in the area.\n\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17409 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a4b472dd809c8a696d1488a54dcaf3870ec9e661",
    "files": [
        {
            "sha": "747cd1d6af3bce7620f67e2281205d373077bf50",
            "filename": "django/contrib/sitemaps/__init__.py",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2F__init__.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -40,6 +40,10 @@ class Sitemap(object):\n     # http://sitemaps.org/protocol.php#index.\n     limit = 50000\n \n+    # If protocol is None, the URLs in the sitemap will use the protocol\n+    # with which the sitemap was requested.\n+    protocol = None\n+\n     def __get(self, name, obj, default=None):\n         try:\n             attr = getattr(self, name)\n@@ -61,19 +65,30 @@ def _get_paginator(self):\n         return self._paginator\n     paginator = property(_get_paginator)\n \n-    def get_urls(self, page=1, site=None):\n+    def get_urls(self, page=1, site=None, protocol=None):\n+        # Determine protocol\n+        if self.protocol is not None:\n+            protocol = self.protocol\n+        if protocol is None:\n+            protocol = 'http'\n+\n+        # Determine domain\n         if site is None:\n             if Site._meta.installed:\n                 try:\n                     site = Site.objects.get_current()\n                 except Site.DoesNotExist:\n                     pass\n             if site is None:\n-                raise ImproperlyConfigured(\"In order to use Sitemaps you must either use the sites framework or pass in a Site or RequestSite object in your view code.\")\n+                raise ImproperlyConfigured(\"In order to use Sitemaps \"\n+                        \"you must either use the sites framework \"\n+                        \"or pass in a Site or RequestSite object \"\n+                        \"in your view code.\")\n+        domain = site.domain\n \n         urls = []\n         for item in self.paginator.page(page).object_list:\n-            loc = \"http://%s%s\" % (site.domain, self.__get('location', item))\n+            loc = \"%s://%s%s\" % (protocol, domain, self.__get('location', item))\n             priority = self.__get('priority', item, None)\n             url_info = {\n                 'item':       item,"
        },
        {
            "sha": "b9cf5f7a7fb851fa14565b8b9b79a6be1b773395",
            "filename": "django/contrib/sitemaps/tests/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2F__init__.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -1 +1,4 @@\n-from django.contrib.sitemaps.tests.basic import *\n+from .flatpages import FlatpagesSitemapTests\n+from .generic import GenericViewsSitemapTests\n+from .http import HTTPSitemapTests\n+from .https import HTTPSSitemapTests, HTTPSDetectionSitemapTests"
        },
        {
            "sha": "f1d6753b3ad9e9fd586ddad30ce9fad5c611bceb",
            "filename": "django/contrib/sitemaps/tests/base.py",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fbase.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -0,0 +1,28 @@\n+import os\n+\n+from django.conf import settings\n+from django.contrib.auth.models import User\n+from django.contrib.sites.models import Site\n+from django.test import TestCase\n+\n+\n+class SitemapTestsBase(TestCase):\n+    protocol = 'http'\n+    domain = 'example.com' if Site._meta.installed else 'testserver'\n+    urls = 'django.contrib.sitemaps.tests.urls.http'\n+\n+    def setUp(self):\n+        self.base_url = '%s://%s' % (self.protocol, self.domain)\n+        self.old_USE_L10N = settings.USE_L10N\n+        self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n+        settings.TEMPLATE_DIRS = (\n+            os.path.join(os.path.dirname(__file__), 'templates'),\n+        )\n+        self.old_Site_meta_installed = Site._meta.installed\n+        # Create a user that will double as sitemap content\n+        User.objects.create_user('testuser', 'test@example.com', 's3krit')\n+\n+    def tearDown(self):\n+        settings.USE_L10N = self.old_USE_L10N\n+        settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n+        Site._meta.installed = self.old_Site_meta_installed"
        },
        {
            "sha": "a40876e8596dc1525137371a60a1755dbf6fe1ab",
            "filename": "django/contrib/sitemaps/tests/flatpages.py",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fflatpages.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fflatpages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fflatpages.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -0,0 +1,37 @@\n+from django.conf import settings\n+from django.utils.unittest import skipUnless\n+\n+from .base import SitemapTestsBase\n+\n+class FlatpagesSitemapTests(SitemapTestsBase):\n+\n+    @skipUnless(\"django.contrib.flatpages\" in settings.INSTALLED_APPS,\n+                \"django.contrib.flatpages app not installed.\")\n+    def test_flatpage_sitemap(self):\n+        \"Basic FlatPage sitemap test\"\n+\n+        # Import FlatPage inside the test so that when django.contrib.flatpages\n+        # is not installed we don't get problems trying to delete Site\n+        # objects (FlatPage has an M2M to Site, Site.delete() tries to\n+        # delete related objects, but the M2M table doesn't exist.\n+        from django.contrib.flatpages.models import FlatPage\n+\n+        public = FlatPage.objects.create(\n+            url=u'/public/',\n+            title=u'Public Page',\n+            enable_comments=True,\n+            registration_required=False,\n+        )\n+        public.sites.add(settings.SITE_ID)\n+        private = FlatPage.objects.create(\n+            url=u'/private/',\n+            title=u'Private Page',\n+            enable_comments=True,\n+            registration_required=True\n+        )\n+        private.sites.add(settings.SITE_ID)\n+        response = self.client.get('/flatpages/sitemap.xml')\n+        # Public flatpage should be in the sitemap\n+        self.assertContains(response, '<loc>%s%s</loc>' % (self.base_url, public.url))\n+        # Private flatpage should not be in the sitemap\n+        self.assertNotContains(response, '<loc>%s%s</loc>' % (self.base_url, private.url))"
        },
        {
            "sha": "5f8b6b8be06d6337ac87ff2228899f7a50f9ba07",
            "filename": "django/contrib/sitemaps/tests/generic.py",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fgeneric.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -0,0 +1,17 @@\n+from django.contrib.auth.models import User\n+\n+from .base import SitemapTestsBase\n+\n+class GenericViewsSitemapTests(SitemapTestsBase):\n+\n+    def test_generic_sitemap(self):\n+        \"A minimal generic sitemap can be rendered\"\n+        response = self.client.get('/generic/sitemap.xml')\n+        expected = ''\n+        for username in User.objects.values_list(\"username\", flat=True):\n+            expected += \"<url><loc>%s/users/%s/</loc></url>\" % (self.base_url, username)\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+%s\n+</urlset>\n+\"\"\" % expected)"
        },
        {
            "sha": "3b56aa8d53e6e3363b583c26f8b46e3dc57c73e9",
            "filename": "django/contrib/sitemaps/tests/http.py",
            "status": "renamed",
            "additions": 13,
            "deletions": 68,
            "changes": 81,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fhttp.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -1,39 +1,16 @@\n-import os\n from datetime import date\n from django.conf import settings\n from django.contrib.auth.models import User\n from django.contrib.sitemaps import Sitemap, GenericSitemap\n from django.contrib.sites.models import Site\n from django.core.exceptions import ImproperlyConfigured\n-from django.test import TestCase\n from django.utils.unittest import skipUnless\n from django.utils.formats import localize\n from django.utils.translation import activate, deactivate\n \n+from .base import SitemapTestsBase\n \n-class SitemapTests(TestCase):\n-    urls = 'django.contrib.sitemaps.tests.urls'\n-\n-    def setUp(self):\n-        if Site._meta.installed:\n-            self.base_url = 'http://example.com'\n-        else:\n-            self.base_url = 'http://testserver'\n-        self.old_USE_L10N = settings.USE_L10N\n-        self.old_Site_meta_installed = Site._meta.installed\n-        self.old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n-        self.old_Site_meta_installed = Site._meta.installed\n-        settings.TEMPLATE_DIRS = (\n-            os.path.join(os.path.dirname(__file__), 'templates'),\n-        )\n-        # Create a user that will double as sitemap content\n-        User.objects.create_user('testuser', 'test@example.com', 's3krit')\n-\n-    def tearDown(self):\n-        settings.USE_L10N = self.old_USE_L10N\n-        Site._meta.installed = self.old_Site_meta_installed\n-        settings.TEMPLATE_DIRS = self.old_TEMPLATE_DIRS\n-        Site._meta.installed = self.old_Site_meta_installed\n+class HTTPSitemapTests(SitemapTestsBase):\n \n     def test_simple_sitemap_index(self):\n         \"A simple sitemap index can be rendered\"\n@@ -54,6 +31,15 @@ def test_simple_sitemap_custom_index(self):\n </sitemapindex>\n \"\"\" % self.base_url)\n \n+    def test_simple_sitemap_section(self):\n+        \"A simple sitemap section can be rendered\"\n+        response = self.client.get('/simple/sitemap-simple.xml')\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+<url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n+</urlset>\n+\"\"\" % (self.base_url, date.today()))\n+\n     def test_simple_sitemap(self):\n         \"A simple sitemap can be rendered\"\n         response = self.client.get('/simple/sitemap.xml')\n@@ -88,48 +74,6 @@ def test_localized_priority(self):\n         self.assertContains(response, '<lastmod>%s</lastmod>' % date.today())\n         deactivate()\n \n-    def test_generic_sitemap(self):\n-        \"A minimal generic sitemap can be rendered\"\n-        response = self.client.get('/generic/sitemap.xml')\n-        expected = ''\n-        for username in User.objects.values_list(\"username\", flat=True):\n-            expected += \"<url><loc>%s/users/%s/</loc></url>\" % (self.base_url, username)\n-        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n-%s\n-</urlset>\n-\"\"\" % expected)\n-\n-    @skipUnless(\"django.contrib.flatpages\" in settings.INSTALLED_APPS, \"django.contrib.flatpages app not installed.\")\n-    def test_flatpage_sitemap(self):\n-        \"Basic FlatPage sitemap test\"\n-\n-        # Import FlatPage inside the test so that when django.contrib.flatpages\n-        # is not installed we don't get problems trying to delete Site\n-        # objects (FlatPage has an M2M to Site, Site.delete() tries to\n-        # delete related objects, but the M2M table doesn't exist.\n-        from django.contrib.flatpages.models import FlatPage\n-\n-        public = FlatPage.objects.create(\n-            url=u'/public/',\n-            title=u'Public Page',\n-            enable_comments=True,\n-            registration_required=False,\n-        )\n-        public.sites.add(settings.SITE_ID)\n-        private = FlatPage.objects.create(\n-            url=u'/private/',\n-            title=u'Private Page',\n-            enable_comments=True,\n-            registration_required=True\n-        )\n-        private.sites.add(settings.SITE_ID)\n-        response = self.client.get('/flatpages/sitemap.xml')\n-        # Public flatpage should be in the sitemap\n-        self.assertContains(response, '<loc>%s%s</loc>' % (self.base_url, public.url))\n-        # Private flatpage should not be in the sitemap\n-        self.assertNotContains(response, '<loc>%s%s</loc>' % (self.base_url, private.url))\n-\n     def test_requestsite_sitemap(self):\n         # Make sure hitting the flatpages sitemap without the sites framework\n         # installed doesn't raise an exception\n@@ -141,7 +85,8 @@ def test_requestsite_sitemap(self):\n </urlset>\n \"\"\" % date.today())\n \n-    @skipUnless(\"django.contrib.sites\" in settings.INSTALLED_APPS, \"django.contrib.sites app not installed.\")\n+    @skipUnless(\"django.contrib.sites\" in settings.INSTALLED_APPS,\n+                \"django.contrib.sites app not installed.\")\n     def test_sitemap_get_urls_no_site_1(self):\n         \"\"\"\n         Check we get ImproperlyConfigured if we don't pass a site object to",
            "previous_filename": "django/contrib/sitemaps/tests/basic.py"
        },
        {
            "sha": "b590bf221577350dc62651b635115f9cded40065",
            "filename": "django/contrib/sitemaps/tests/https.py",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fhttps.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Fhttps.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Fhttps.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -0,0 +1,51 @@\n+from datetime import date\n+\n+from django.test.utils import override_settings\n+\n+from .base import SitemapTestsBase\n+\n+class HTTPSSitemapTests(SitemapTestsBase):\n+    protocol = 'https'\n+    urls = 'django.contrib.sitemaps.tests.urls.https'\n+\n+    def test_secure_sitemap_index(self):\n+        \"A secure sitemap index can be rendered\"\n+        response = self.client.get('/secure/index.xml')\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+<sitemap><loc>%s/secure/sitemap-simple.xml</loc></sitemap>\n+</sitemapindex>\n+\"\"\" % self.base_url)\n+\n+    def test_secure_sitemap_section(self):\n+        \"A secure sitemap section can be rendered\"\n+        response = self.client.get('/secure/sitemap-simple.xml')\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+<url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n+</urlset>\n+\"\"\" % (self.base_url, date.today()))\n+\n+#@override_settings(SECURE_PROXY_SSL_HEADER=False)\n+class HTTPSDetectionSitemapTests(SitemapTestsBase):\n+    extra = {'wsgi.url_scheme': 'https'}\n+\n+    def test_sitemap_index_with_https_request(self):\n+        \"A sitemap index requested in HTTPS is rendered with HTTPS links\"\n+        response = self.client.get('/simple/index.xml', **self.extra)\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<sitemapindex xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+<sitemap><loc>%s/simple/sitemap-simple.xml</loc></sitemap>\n+</sitemapindex>\n+\"\"\" % self.base_url.replace('http://', 'https://'))\n+\n+    def test_sitemap_section_with_https_request(self):\n+        \"A sitemap section requested in HTTPS is rendered with HTTPS links\"\n+        response = self.client.get('/simple/sitemap-simple.xml', **self.extra)\n+        self.assertEqual(response.content, \"\"\"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n+<url><loc>%s/location/</loc><lastmod>%s</lastmod><changefreq>never</changefreq><priority>0.5</priority></url>\n+</urlset>\n+\"\"\" % (self.base_url.replace('http://', 'https://'), date.today()))\n+\n+HTTPSDetectionSitemapTests = override_settings(SECURE_PROXY_SSL_HEADER=False)(HTTPSDetectionSitemapTests)"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "django/contrib/sitemaps/tests/urls/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2F__init__.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661"
        },
        {
            "sha": "018e46a482ebed0033a4d3355289448dd14cfe27",
            "filename": "django/contrib/sitemaps/tests/urls/http.py",
            "status": "renamed",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2Fhttp.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2Fhttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2Fhttp.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -18,9 +18,7 @@ def items(self):\n }\n \n generic_sitemaps = {\n-    'generic': GenericSitemap({\n-        'queryset': User.objects.all()\n-    }),\n+    'generic': GenericSitemap({'queryset': User.objects.all()}),\n }\n \n flatpage_sitemaps = {",
            "previous_filename": "django/contrib/sitemaps/tests/urls.py"
        },
        {
            "sha": "a1b4b939ae6fc9e9340cf0f3b9015f908fc0019c",
            "filename": "django/contrib/sitemaps/tests/urls/https.py",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2Fhttps.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2Fhttps.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Ftests%2Furls%2Fhttps.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -0,0 +1,16 @@\n+from django.conf.urls import patterns\n+\n+from .http import SimpleSitemap\n+\n+class HTTPSSitemap(SimpleSitemap):\n+    protocol = 'https'\n+\n+secure_sitemaps = {\n+    'simple': HTTPSSitemap,\n+}\n+\n+urlpatterns = patterns('django.contrib.sitemaps.views',\n+    (r'^secure/index\\.xml$', 'index', {'sitemaps': secure_sitemaps}),\n+    (r'^secure/sitemap-(?P<section>.+)\\.xml$', 'sitemap',\n+        {'sitemaps': secure_sitemaps}),\n+)"
        },
        {
            "sha": "b90a39e95440c09173c88a6ea3fbbd1439dfb94d",
            "filename": "django/contrib/sitemaps/views.py",
            "status": "modified",
            "additions": 24,
            "deletions": 17,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/django%2Fcontrib%2Fsitemaps%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsitemaps%2Fviews.py?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -7,40 +7,47 @@\n def index(request, sitemaps,\n           template_name='sitemap_index.xml', mimetype='application/xml',\n           sitemap_url_name='django.contrib.sitemaps.views.sitemap'):\n-    current_site = get_current_site(request)\n+    req_protocol = 'https' if request.is_secure() else 'http'\n+    req_site = get_current_site(request)\n+\n     sites = []\n-    protocol = request.is_secure() and 'https' or 'http'\n     for section, site in sitemaps.items():\n-        site.request = request\n         if callable(site):\n-            pages = site().paginator.num_pages\n-        else:\n-            pages = site.paginator.num_pages\n-        sitemap_url = urlresolvers.reverse(sitemap_url_name, kwargs={'section': section})\n-        sites.append('%s://%s%s' % (protocol, current_site.domain, sitemap_url))\n-        if pages > 1:\n-            for page in range(2, pages+1):\n-                sites.append('%s://%s%s?p=%s' % (protocol, current_site.domain, sitemap_url, page))\n-    return TemplateResponse(request, template_name, {'sitemaps': sites}, content_type=mimetype)\n+            site = site()\n+        protocol = req_protocol if site.protocol is None else site.protocol\n+        sitemap_url = urlresolvers.reverse(\n+                sitemap_url_name, kwargs={'section': section})\n+        absolute_url = '%s://%s%s' % (protocol, req_site.domain, sitemap_url)\n+        sites.append(absolute_url)\n+        for page in range(2, site.paginator.num_pages + 1):\n+            sites.append('%s?p=%s' % (absolute_url, page))\n+\n+    return TemplateResponse(request, template_name, {'sitemaps': sites},\n+                            content_type=mimetype)\n \n def sitemap(request, sitemaps, section=None,\n             template_name='sitemap.xml', mimetype='application/xml'):\n-    maps, urls = [], []\n+    req_protocol = 'https' if request.is_secure() else 'http'\n+    req_site = get_current_site(request)\n+\n     if section is not None:\n         if section not in sitemaps:\n             raise Http404(\"No sitemap available for section: %r\" % section)\n-        maps.append(sitemaps[section])\n+        maps = [sitemaps[section]]\n     else:\n         maps = sitemaps.values()\n     page = request.GET.get(\"p\", 1)\n-    current_site = get_current_site(request)\n+\n+    urls = []\n     for site in maps:\n         try:\n             if callable(site):\n                 site = site()\n-            urls.extend(site.get_urls(page=page, site=current_site))\n+            urls.extend(site.get_urls(page=page, site=req_site,\n+                                      protocol=req_protocol))\n         except EmptyPage:\n             raise Http404(\"Page %s empty\" % page)\n         except PageNotAnInteger:\n             raise Http404(\"No page '%s'\" % page)\n-    return TemplateResponse(request, template_name, {'urlset': urls}, content_type=mimetype)\n+    return TemplateResponse(request, template_name, {'urlset': urls},\n+                            content_type=mimetype)"
        },
        {
            "sha": "ac9f8abac4217ef005acae5292f399798f8cb03e",
            "filename": "docs/ref/contrib/sitemaps.txt",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/docs%2Fref%2Fcontrib%2Fsitemaps.txt",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/docs%2Fref%2Fcontrib%2Fsitemaps.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fsitemaps.txt?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -161,6 +161,9 @@ Sitemap class reference\n         the ``get_absolute_url()`` method on each object as returned by\n         :attr:`~Sitemap.items()`.\n \n+        To specify a protocol other than ``'http'``, use\n+        :attr:`~Sitemap.protocol`.\n+\n     .. attribute:: Sitemap.lastmod\n \n         **Optional.** Either a method or attribute.\n@@ -193,7 +196,7 @@ Sitemap class reference\n         * ``'yearly'``\n         * ``'never'``\n \n-    .. method:: Sitemap.priority\n+    .. attribute:: Sitemap.priority\n \n         **Optional.** Either a method or attribute.\n \n@@ -208,6 +211,18 @@ Sitemap class reference\n \n         .. _sitemaps.org documentation: http://www.sitemaps.org/protocol.html#prioritydef\n \n+    .. attribute:: Sitemap.protocol\n+\n+        .. versionadded:: 1.4\n+\n+        **Optional.**\n+\n+        This attribute defines the protocol (``'http'`` or ``'https'``) of the\n+        URLs in the sitemap. If it isn't set, the protocol with which the\n+        sitemap was requested is used. If the sitemap is built outside the\n+        context of a request, the default is ``'http'``.\n+\n+\n Shortcuts\n =========\n "
        },
        {
            "sha": "c5128b10f20dd25f176ee223bba71e7ce5478574",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/a4b472dd809c8a696d1488a54dcaf3870ec9e661/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/a4b472dd809c8a696d1488a54dcaf3870ec9e661/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=a4b472dd809c8a696d1488a54dcaf3870ec9e661",
            "patch": "@@ -562,6 +562,10 @@ Django 1.4 also includes several smaller improvements worth noting:\n   just like with regular formsets. However, initial values only apply to extra\n   forms i.e. those which are not bound to an existing model instance.\n \n+* The sitemaps framework can now handle HTTPS links using the new\n+  :attr:`Sitemap.protocol <django.contrib.sitemaps.Sitemap.protocol>` class\n+  attribute.\n+\n Backwards incompatible changes in 1.4\n =====================================\n "
        }
    ],
    "stats": {
        "total": 322,
        "additions": 229,
        "deletions": 93
    }
}