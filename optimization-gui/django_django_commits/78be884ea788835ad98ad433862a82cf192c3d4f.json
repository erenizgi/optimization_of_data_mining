{
    "author": "freakboy3742",
    "message": "Fixed #3304 -- Added support for HTTPOnly cookies. Thanks to arvin for the suggestion, and rodolfo for the draft patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14707 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "78be884ea788835ad98ad433862a82cf192c3d4f",
    "files": [
        {
            "sha": "f23c55d20d281f95c8930e8eafe96bb982bbdc2b",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -421,6 +421,7 @@\n SESSION_COOKIE_DOMAIN = None                            # A string like \".lawrence.com\", or None for standard domain cookie.\n SESSION_COOKIE_SECURE = False                           # Whether the session cookie should be secure (https:// only).\n SESSION_COOKIE_PATH = '/'                               # The path of the session cookie.\n+SESSION_COOKIE_HTTPONLY = False                         # Whether to use the non-RFC standard httpOnly flag (IE, FF3+, others)\n SESSION_SAVE_EVERY_REQUEST = False                      # Whether to save the session data on every request.\n SESSION_EXPIRE_AT_BROWSER_CLOSE = False                 # Whether a user's session cookie expires when the Web browser is closed.\n SESSION_ENGINE = 'django.contrib.sessions.backends.db'  # The module to store session data"
        },
        {
            "sha": "68cb77f7e1a1686ace1453a95a8fb282bec36236",
            "filename": "django/contrib/sessions/middleware.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fcontrib%2Fsessions%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fcontrib%2Fsessions%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fmiddleware.py?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -38,5 +38,6 @@ def process_response(self, request, response):\n                         request.session.session_key, max_age=max_age,\n                         expires=expires, domain=settings.SESSION_COOKIE_DOMAIN,\n                         path=settings.SESSION_COOKIE_PATH,\n-                        secure=settings.SESSION_COOKIE_SECURE or None)\n+                        secure=settings.SESSION_COOKIE_SECURE or None,\n+                        httponly=settings.SESSION_COOKIE_HTTPONLY or None)\n         return response"
        },
        {
            "sha": "e8aad0f05fdf53b2a15ff06b1fe91b8b03c33782",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 43,
            "deletions": 1,
            "changes": 44,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -11,8 +11,10 @@\n from django.contrib.sessions.backends.file import SessionStore as FileSession\n from django.contrib.sessions.backends.base import SessionBase\n from django.contrib.sessions.models import Session\n+from django.contrib.sessions.middleware import SessionMiddleware\n from django.core.exceptions import ImproperlyConfigured\n-from django.test import TestCase\n+from django.http import HttpResponse\n+from django.test import TestCase, RequestFactory\n from django.utils import unittest\n from django.utils.hashcompat import md5_constructor\n \n@@ -320,3 +322,43 @@ def test_configuration_check(self):\n class CacheSessionTests(SessionTestsMixin, unittest.TestCase):\n \n     backend = CacheSession\n+\n+\n+class SessionMiddlewareTests(unittest.TestCase):\n+    def setUp(self):\n+        self.old_SESSION_COOKIE_SECURE = settings.SESSION_COOKIE_SECURE\n+        self.old_SESSION_COOKIE_HTTPONLY = settings.SESSION_COOKIE_HTTPONLY\n+\n+    def tearDown(self):\n+        settings.SESSION_COOKIE_SECURE = self.old_SESSION_COOKIE_SECURE\n+        settings.SESSION_COOKIE_HTTPONLY = self.old_SESSION_COOKIE_HTTPONLY\n+\n+    def test_secure_session_cookie(self):\n+        settings.SESSION_COOKIE_SECURE = True\n+\n+        request = RequestFactory().get('/')\n+        response = HttpResponse('Session test')\n+        middleware = SessionMiddleware()\n+\n+        # Simulate a request the modifies the session\n+        middleware.process_request(request)\n+        request.session['hello'] = 'world'\n+\n+        # Handle the response through the middleware\n+        response = middleware.process_response(request, response)\n+        self.assertTrue(response.cookies[settings.SESSION_COOKIE_NAME]['secure'])\n+\n+    def test_httponly_session_cookie(self):\n+        settings.SESSION_COOKIE_HTTPONLY = True\n+\n+        request = RequestFactory().get('/')\n+        response = HttpResponse('Session test')\n+        middleware = SessionMiddleware()\n+\n+        # Simulate a request the modifies the session\n+        middleware.process_request(request)\n+        request.session['hello'] = 'world'\n+\n+        # Handle the response through the middleware\n+        response = middleware.process_response(request, response)\n+        self.assertTrue(response.cookies[settings.SESSION_COOKIE_NAME]['httponly'])"
        },
        {
            "sha": "42027f0bebcb92a0ea047e64730782f8075fb1e6",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 38,
            "deletions": 4,
            "changes": 42,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -2,7 +2,6 @@\n import os\n import re\n import time\n-from Cookie import BaseCookie, SimpleCookie, CookieError\n from pprint import pformat\n from urllib import urlencode\n from urlparse import urljoin\n@@ -22,6 +21,39 @@\n         # PendingDeprecationWarning\n         from cgi import parse_qsl\n \n+# httponly support exists in Python 2.6's Cookie library,\n+# but not in Python 2.4 or 2.5.\n+import Cookie\n+if Cookie.Morsel._reserved.has_key('httponly'):\n+    SimpleCookie = Cookie.SimpleCookie\n+else:\n+    class Morsel(Cookie.Morsel):\n+        def __setitem__(self, K, V):\n+            K = K.lower()\n+            if K == \"httponly\":\n+                if V:\n+                    # The superclass rejects httponly as a key,\n+                    # so we jump to the grandparent.\n+                    super(Cookie.Morsel, self).__setitem__(K, V)\n+            else:\n+                super(Morsel, self).__setitem__(K, V)\n+\n+        def OutputString(self, attrs=None):\n+            output = super(Morsel, self).OutputString(attrs)\n+            if \"httponly\" in self:\n+                output += \"; httponly\"\n+            return output\n+\n+    class SimpleCookie(Cookie.SimpleCookie):\n+        def __set(self, key, real_value, coded_value):\n+            M = self.get(key, Morsel())\n+            M.set(key, real_value, coded_value)\n+            dict.__setitem__(self, key, M)\n+\n+        def __setitem__(self, key, value):\n+            rval, cval = self.value_encode(value)\n+            self.__set(key, rval, cval)\n+\n from django.utils.datastructures import MultiValueDict, ImmutableList\n from django.utils.encoding import smart_str, iri_to_uri, force_unicode\n from django.utils.http import cookie_date\n@@ -369,11 +401,11 @@ def value_encode(self, val):\n def parse_cookie(cookie):\n     if cookie == '':\n         return {}\n-    if not isinstance(cookie, BaseCookie):\n+    if not isinstance(cookie, Cookie.BaseCookie):\n         try:\n             c = CompatCookie()\n             c.load(cookie)\n-        except CookieError:\n+        except Cookie.CookieError:\n             # Invalid cookie\n             return {}\n     else:\n@@ -462,7 +494,7 @@ def get(self, header, alternate):\n         return self._headers.get(header.lower(), (None, alternate))[1]\n \n     def set_cookie(self, key, value='', max_age=None, expires=None, path='/',\n-                   domain=None, secure=False):\n+                   domain=None, secure=False, httponly=False):\n         \"\"\"\n         Sets a cookie.\n \n@@ -495,6 +527,8 @@ def set_cookie(self, key, value='', max_age=None, expires=None, path='/',\n             self.cookies[key]['domain'] = domain\n         if secure:\n             self.cookies[key]['secure'] = True\n+        if httponly:\n+            self.cookies[key]['httponly'] = True\n \n     def delete_cookie(self, key, path='/', domain=None):\n         self.set_cookie(key, max_age=0, path=path, domain=domain,"
        },
        {
            "sha": "cc892297258e71f95302aa0a61063580e27fffaf",
            "filename": "docs/ref/request-response.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 7,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Fref%2Frequest-response.txt",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Fref%2Frequest-response.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Frequest-response.txt?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -566,7 +566,13 @@ Methods\n     Returns ``True`` or ``False`` based on a case-insensitive check for a\n     header with the given name.\n \n-.. method:: HttpResponse.set_cookie(key, value='', max_age=None, expires=None, path='/', domain=None, secure=None)\n+.. method:: HttpResponse.set_cookie(key, value='', max_age=None, expires=None, path='/', domain=None, secure=None, httponly=False)\n+\n+    .. versionchanged:: 1.3\n+\n+    The possibility of specifying a ``datetime.datetime`` object in\n+    ``expires``, and the auto-calculation of ``max_age`` in such case\n+    was added. The ``httponly`` argument was also added.\n \n     Sets a cookie. The parameters are the same as in the `cookie Morsel`_\n     object in the Python standard library.\n@@ -583,14 +589,18 @@ Methods\n           the domains www.lawrence.com, blogs.lawrence.com and\n           calendars.lawrence.com. Otherwise, a cookie will only be readable by\n           the domain that set it.\n+        * Use ``http_only=True`` if you want to prevent client-side\n+          JavaScript from having access to the cookie.\n \n-    .. _`cookie Morsel`: http://docs.python.org/library/cookie.html#Cookie.Morsel\n+          HTTPOnly_ is a flag included in a Set-Cookie HTTP response\n+          header. It is not part of the RFC2109 standard for cookies,\n+          and it isn't honored consistently by all browsers. However,\n+          when it is honored, it can be a useful way to mitigate the\n+          risk of client side script accessing the protected cookie\n+          data.\n \n-    .. versionchanged:: 1.3\n-\n-    Both the possibility of specifying a ``datetime.datetime`` object in\n-    ``expires`` and the auto-calculation of ``max_age`` in such case were added\n-    in Django 1.3.\n+    .. _`cookie Morsel`: http://docs.python.org/library/cookie.html#Cookie.Morsel\n+    .. _HTTPOnly: http://www.owasp.org/index.php/HTTPOnly\n \n .. method:: HttpResponse.delete_cookie(key, path='/', domain=None)\n "
        },
        {
            "sha": "3577ab0cebad0060b3c225beef329481226a03b6",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -1392,6 +1392,25 @@ The domain to use for session cookies. Set this to a string such as\n ``\".lawrence.com\"`` for cross-domain cookies, or use ``None`` for a standard\n domain cookie. See the :doc:`/topics/http/sessions`.\n \n+.. setting:: SESSION_COOKIE_HTTPONLY\n+\n+SESSION_COOKIE_HTTPONLY\n+-----------------------\n+\n+Default: ``False``\n+\n+Whether to use HTTPOnly flag on the session cookie. If this is set to\n+``True``, client-side JavaScript will not to be able to access the\n+session cookie.\n+\n+HTTPOnly_ is a flag included in a Set-Cookie HTTP response header. It\n+is not part of the RFC2109 standard for cookies, and it isn't honored\n+consistently by all browsers. However, when it is honored, it can be a\n+useful way to mitigate the risk of client side script accessing the\n+protected cookie data.\n+\n+.. _HTTPOnly: http://www.owasp.org/index.php/HTTPOnly\n+\n .. setting:: SESSION_COOKIE_NAME\n \n SESSION_COOKIE_NAME"
        },
        {
            "sha": "1dc687049690f6e8821d19fa90d922001e729410",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -161,6 +161,10 @@ requests. These include:\n \n     * Support for lookups spanning relations in admin's ``list_filter``.\n \n+    * Support for _HTTPOnly cookies.\n+\n+.. _HTTPOnly: http://www.owasp.org/index.php/HTTPOnly\n+\n .. _backwards-incompatible-changes-1.3:\n \n Backwards-incompatible changes in 1.3"
        },
        {
            "sha": "dd48c72a2327e4381ca6d3bb346441054745c2c5",
            "filename": "docs/topics/http/sessions.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Ftopics%2Fhttp%2Fsessions.txt",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/docs%2Ftopics%2Fhttp%2Fsessions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fhttp%2Fsessions.txt?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -457,6 +457,23 @@ The domain to use for session cookies. Set this to a string such as\n ``\".lawrence.com\"`` (note the leading dot!) for cross-domain cookies, or use\n ``None`` for a standard domain cookie.\n \n+SESSION_COOKIE_HTTPONLY\n+-----------------------\n+\n+Default: ``False``\n+\n+Whether to use HTTPOnly flag on the session cookie. If this is set to\n+``True``, client-side JavaScript will not to be able to access the\n+session cookie.\n+\n+HTTPOnly_ is a flag included in a Set-Cookie HTTP response header. It\n+is not part of the RFC2109 standard for cookies, and it isn't honored\n+consistently by all browsers. However, when it is honored, it can be a\n+useful way to mitigate the risk of client side script accessing the\n+protected cookie data.\n+\n+.. _HTTPOnly: http://www.owasp.org/index.php/HTTPOnly\n+\n SESSION_COOKIE_NAME\n -------------------\n "
        },
        {
            "sha": "b1d80fe30e5ea65b3e6c60377026e7cfd533571a",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/78be884ea788835ad98ad433862a82cf192c3d4f/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/78be884ea788835ad98ad433862a82cf192c3d4f/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=78be884ea788835ad98ad433862a82cf192c3d4f",
            "patch": "@@ -89,6 +89,15 @@ def test_max_age_expiration(self):\n         self.assertEqual(max_age_cookie['max-age'], 10)\n         self.assertEqual(max_age_cookie['expires'], cookie_date(time.time()+10))\n \n+    def test_httponly_cookie(self):\n+        response = HttpResponse()\n+        response.set_cookie('example', httponly=True)\n+        example_cookie = response.cookies['example']\n+        # A compat cookie may be in use -- check that it has worked\n+        # both as an output string, and using the cookie attributes\n+        self.assertTrue('; httponly' in str(example_cookie))\n+        self.assertTrue(example_cookie['httponly'])\n+\n     def test_limited_stream(self):\n         # Read all of a limited stream\n         stream = LimitedStream(StringIO('test'), 2)"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 150,
        "deletions": 13
    }
}