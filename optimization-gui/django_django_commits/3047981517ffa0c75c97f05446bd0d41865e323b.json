{
    "author": "jezdez",
    "message": "Fixed #18050 -- Fixed a rather glaring bug in the handling of @import statements when using the cached staticfiles storage.",
    "sha": "3047981517ffa0c75c97f05446bd0d41865e323b",
    "files": [
        {
            "sha": "4a6650b193f3759b13c7e5f3ef7ac74948b3c1c2",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/3047981517ffa0c75c97f05446bd0d41865e323b/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/3047981517ffa0c75c97f05446bd0d41865e323b/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=3047981517ffa0c75c97f05446bd0d41865e323b",
            "patch": "@@ -45,10 +45,11 @@ def path(self, name):\n \n \n class CachedFilesMixin(object):\n+    default_template = \"\"\"url(\"%s\")\"\"\"\n     patterns = (\n         (\"*.css\", (\n             br\"\"\"(url\\(['\"]{0,1}\\s*(.*?)[\"']{0,1}\\))\"\"\",\n-            br\"\"\"(@import\\s*[\"']\\s*(.*?)[\"'])\"\"\",\n+            (br\"\"\"(@import\\s*[\"']\\s*(.*?)[\"'])\"\"\", \"\"\"@import url(\"%s\")\"\"\"),\n         )),\n     )\n \n@@ -62,8 +63,12 @@ def __init__(self, *args, **kwargs):\n         self._patterns = SortedDict()\n         for extension, patterns in self.patterns:\n             for pattern in patterns:\n+                if isinstance(pattern, (tuple, list)):\n+                    pattern, template = pattern\n+                else:\n+                    template = self.default_template\n                 compiled = re.compile(pattern)\n-                self._patterns.setdefault(extension, []).append(compiled)\n+                self._patterns.setdefault(extension, []).append((compiled, template))\n \n     def file_hash(self, name, content=None):\n         \"\"\"\n@@ -140,10 +145,13 @@ def url(self, name, force=False):\n \n         return unquote(final_url)\n \n-    def url_converter(self, name):\n+    def url_converter(self, name, template=None):\n         \"\"\"\n         Returns the custom URL converter for the given file name.\n         \"\"\"\n+        if template is None:\n+            template = self.default_template\n+\n         def converter(matchobj):\n             \"\"\"\n             Converts the matched URL depending on the parent level (`..`)\n@@ -178,7 +186,8 @@ def converter(matchobj):\n             relative_url = '/'.join(url.split('/')[:-1] + file_name)\n \n             # Return the hashed version to the file\n-            return 'url(\"%s\")' % unquote(relative_url)\n+            return template % unquote(relative_url)\n+\n         return converter\n \n     def post_process(self, paths, dry_run=False, **options):\n@@ -229,9 +238,9 @@ def post_process(self, paths, dry_run=False, **options):\n                 # ..to apply each replacement pattern to the content\n                 if name in adjustable_paths:\n                     content = original_file.read().decode(settings.FILE_CHARSET)\n-                    converter = self.url_converter(name)\n                     for patterns in self._patterns.values():\n-                        for pattern in patterns:\n+                        for pattern, template in patterns:\n+                            converter = self.url_converter(name, template)\n                             content = pattern.sub(converter, content)\n                     if hashed_file_exists:\n                         self.delete(hashed_name)"
        },
        {
            "sha": "6bc7ce04c48bfa036a425e9f62110ef5b48d65e0",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/import.css",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/3047981517ffa0c75c97f05446bd0d41865e323b/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fimport.css",
            "raw_url": "https://github.com/django/django/raw/3047981517ffa0c75c97f05446bd0d41865e323b/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fimport.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fimport.css?ref=3047981517ffa0c75c97f05446bd0d41865e323b",
            "patch": "@@ -0,0 +1 @@\n+@import 'styles.css';"
        },
        {
            "sha": "9b14c78dc529f09d5017f9fa0b8f15a8d33c0d4c",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/3047981517ffa0c75c97f05446bd0d41865e323b/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3047981517ffa0c75c97f05446bd0d41865e323b/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=3047981517ffa0c75c97f05446bd0d41865e323b",
            "patch": "@@ -446,6 +446,13 @@ def test_template_tag_relative(self):\n             self.assertIn(b'url(\"img/relative.acae32e4532b.png\")', content)\n             self.assertIn(b\"../cached/styles.93b1147e8552.css\", content)\n \n+    def test_import_replacement(self):\n+        \"See #18050\"\n+        relpath = self.cached_file_path(\"cached/import.css\")\n+        self.assertEqual(relpath, \"cached/import.2b1d40b0bbd4.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            self.assertIn(b\"\"\"import url(\"styles.93b1147e8552.css\")\"\"\", relfile.read())\n+\n     def test_template_tag_deep_relative(self):\n         relpath = self.cached_file_path(\"cached/css/window.css\")\n         self.assertEqual(relpath, \"cached/css/window.9db38d5169f3.css\")"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 23,
        "deletions": 6
    }
}