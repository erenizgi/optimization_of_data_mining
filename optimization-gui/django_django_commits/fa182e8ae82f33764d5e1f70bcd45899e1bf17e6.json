{
    "author": "jarshwah",
    "message": "Fixed #18465 -- Set date formats correctly on Oracle\n\nCorrectly configure NLS_SESSION_PARAMETERS to format Date and DateTime\non Oracle backend.\n\nThanks to Josh Smeaton for report & patch.",
    "sha": "fa182e8ae82f33764d5e1f70bcd45899e1bf17e6",
    "files": [
        {
            "sha": "b90f6ea1550611cd9768dfa2f63dad7a7ace5575",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/fa182e8ae82f33764d5e1f70bcd45899e1bf17e6/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/fa182e8ae82f33764d5e1f70bcd45899e1bf17e6/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=fa182e8ae82f33764d5e1f70bcd45899e1bf17e6",
            "patch": "@@ -479,13 +479,19 @@ def _cursor(self):\n                 del conn_params['use_returning_into']\n             self.connection = Database.connect(conn_string, **conn_params)\n             cursor = FormatStylePlaceholderCursor(self.connection)\n+            # Set the territory first. The territory overrides NLS_DATE_FORMAT\n+            # and NLS_TIMESTAMP_FORMAT to the territory default. When all of\n+            # these are set in single statement it isn't clear what is supposed\n+            # to happen.\n+            cursor.execute(\"ALTER SESSION SET NLS_TERRITORY = 'AMERICA'\")\n             # Set oracle date to ansi date format.  This only needs to execute\n             # once when we create a new connection. We also set the Territory\n-            # to 'AMERICA' which forces Sunday to evaluate to a '1' in TO_CHAR().\n-            cursor.execute(\"ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD HH24:MI:SS'\"\n-                           \" NLS_TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS.FF'\"\n-                           \" NLS_TERRITORY = 'AMERICA'\"\n-                           + (\" TIME_ZONE = 'UTC'\" if settings.USE_TZ else ''))\n+            # to 'AMERICA' which forces Sunday to evaluate to a '1' in\n+            # TO_CHAR().\n+            cursor.execute(\n+                \"ALTER SESSION SET NLS_DATE_FORMAT = 'YYYY-MM-DD HH24:MI:SS'\"\n+                \" NLS_TIMESTAMP_FORMAT = 'YYYY-MM-DD HH24:MI:SS.FF'\"\n+                + (\" TIME_ZONE = 'UTC'\" if settings.USE_TZ else ''))\n \n             if 'operators' not in self.__dict__:\n                 # Ticket #14149: Check whether our LIKE implementation will"
        },
        {
            "sha": "cb25ac0a323e53ba08d5f0973a5125bef9793fa5",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/fa182e8ae82f33764d5e1f70bcd45899e1bf17e6/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fa182e8ae82f33764d5e1f70bcd45899e1bf17e6/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=fa182e8ae82f33764d5e1f70bcd45899e1bf17e6",
            "patch": "@@ -66,6 +66,18 @@ def test_client_encoding(self):\n         self.assertEqual(connection.connection.encoding, \"UTF-8\")\n         self.assertEqual(connection.connection.nencoding, \"UTF-8\")\n \n+    @unittest.skipUnless(connection.vendor == 'oracle',\n+                         \"No need to check Oracle connection semantics\")\n+    def test_order_of_nls_parameters(self):\n+        # an 'almost right' datetime should work with configured\n+        # NLS parameters as per #18465.\n+        c = connection.cursor()\n+        query = \"select 1 from dual where '1936-12-29 00:00' < sysdate\"\n+        # Test that the query succeeds without errors - pre #18465 this\n+        # wasn't the case.\n+        c.execute(query)\n+        self.assertEqual(c.fetchone()[0], 1)\n+\n class MySQLTests(TestCase):\n     @unittest.skipUnless(connection.vendor == 'mysql',\n                         \"Test valid only for MySQL\")"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 23,
        "deletions": 5
    }
}