{
    "author": "carljm",
    "message": "Fixed #14678 -- Added validation to catch flatpages with the same URL on the same site. Thanks seler for the report, and joni, graham_king, and j4nu5 for work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16937 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "3f3010014b33451553c62b005c2ec09a16a9f9ce",
    "files": [
        {
            "sha": "13294262f1bf8912cb781200a642ff1143fb2107",
            "filename": "django/contrib/flatpages/admin.py",
            "status": "modified",
            "additions": 1,
            "deletions": 13,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/3f3010014b33451553c62b005c2ec09a16a9f9ce/django%2Fcontrib%2Fflatpages%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/3f3010014b33451553c62b005c2ec09a16a9f9ce/django%2Fcontrib%2Fflatpages%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Fadmin.py?ref=3f3010014b33451553c62b005c2ec09a16a9f9ce",
            "patch": "@@ -1,19 +1,7 @@\n-from django import forms\n from django.contrib import admin\n from django.contrib.flatpages.models import FlatPage\n from django.utils.translation import ugettext_lazy as _\n-\n-\n-class FlatpageForm(forms.ModelForm):\n-    url = forms.RegexField(label=_(\"URL\"), max_length=100, regex=r'^[-\\w/\\.~]+$',\n-        help_text = _(\"Example: '/about/contact/'. Make sure to have leading\"\n-                      \" and trailing slashes.\"),\n-        error_message = _(\"This value must contain only letters, numbers,\"\n-                          \" dots, underscores, dashes, slashes or tildes.\"))\n-\n-    class Meta:\n-        model = FlatPage\n-\n+from django.contrib.flatpages.forms import FlatpageForm\n \n class FlatPageAdmin(admin.ModelAdmin):\n     form = FlatpageForm"
        },
        {
            "sha": "b2811ff618aa2a93e2643e7684f44f1aad6539e7",
            "filename": "django/contrib/flatpages/forms.py",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/3f3010014b33451553c62b005c2ec09a16a9f9ce/django%2Fcontrib%2Fflatpages%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/3f3010014b33451553c62b005c2ec09a16a9f9ce/django%2Fcontrib%2Fflatpages%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Fforms.py?ref=3f3010014b33451553c62b005c2ec09a16a9f9ce",
            "patch": "@@ -0,0 +1,28 @@\n+from django import forms\n+from django.utils.translation import ugettext_lazy as _\n+from django.contrib.flatpages.models import FlatPage\n+\n+class FlatpageForm(forms.ModelForm):\n+    url = forms.RegexField(label=_(\"URL\"), max_length=100, regex=r'^[-\\w/\\.~]+$',\n+        help_text = _(\"Example: '/about/contact/'. Make sure to have leading\"\n+                      \" and trailing slashes.\"),\n+        error_message = _(\"This value must contain only letters, numbers,\"\n+                          \" dots, underscores, dashes, slashes or tildes.\"))\n+\n+    class Meta:\n+        model = FlatPage\n+\n+    def clean(self):\n+        url = self.cleaned_data.get('url', None)\n+        sites = self.cleaned_data.get('sites', None)\n+\n+        flatpages_with_same_url = FlatPage.objects.filter(url=url)\n+\n+        if flatpages_with_same_url.filter(sites__in=sites).exists():\n+            for site in sites:\n+                if flatpages_with_same_url.filter(sites=site).exists():\n+                    raise forms.ValidationError(\n+                        _('Flatpage with url %s already exists for site %s'\n+                          % (url, site)))\n+\n+        return super(FlatpageForm, self).clean()"
        },
        {
            "sha": "83437ba733d08b416fdd642659c8110cadf27950",
            "filename": "django/contrib/flatpages/tests/forms.py",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/3f3010014b33451553c62b005c2ec09a16a9f9ce/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/3f3010014b33451553c62b005c2ec09a16a9f9ce/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fflatpages%2Ftests%2Fforms.py?ref=3f3010014b33451553c62b005c2ec09a16a9f9ce",
            "patch": "@@ -1,5 +1,5 @@\n from django.conf import settings\n-from django.contrib.flatpages.admin import FlatpageForm\n+from django.contrib.flatpages.forms import FlatpageForm\n from django.test import TestCase\n \n class FlatpageAdminFormTests(TestCase):\n@@ -11,7 +11,7 @@ def setUp(self):\n         }\n \n     def test_flatpage_admin_form_url_validation(self):\n-        \"The flatpage admin form validates correctly validates urls\"\n+        \"The flatpage admin form correctly validates urls\"\n         self.assertTrue(FlatpageForm(data=dict(url='/new_flatpage/', **self.form_data)).is_valid())\n         self.assertTrue(FlatpageForm(data=dict(url='/some.special~chars/', **self.form_data)).is_valid())\n         self.assertTrue(FlatpageForm(data=dict(url='/some.very_special~chars-here/', **self.form_data)).is_valid())\n@@ -21,3 +21,17 @@ def test_flatpage_admin_form_url_validation(self):\n         self.assertFalse(FlatpageForm(data=dict(url='/a ! char/', **self.form_data)).is_valid())\n         self.assertFalse(FlatpageForm(data=dict(url='/a & char/', **self.form_data)).is_valid())\n         self.assertFalse(FlatpageForm(data=dict(url='/a ? char/', **self.form_data)).is_valid())\n+\n+    def test_flatpage_admin_form_url_uniqueness_validation(self):\n+        \"The flatpage admin form correctly enforces url uniqueness among flatpages of the same site\"\n+        data = dict(url='/myflatpage1', **self.form_data)\n+\n+        FlatpageForm(data=data).save()\n+\n+        f = FlatpageForm(data=data)\n+\n+        self.assertFalse(f.is_valid())\n+\n+        self.assertEqual(\n+            f.errors,\n+            {'__all__': [u'Flatpage with url /myflatpage1 already exists for site example.com']})"
        },
        {
            "sha": "4a1f2970cb7af0f91a4649d2fa66aa50b7eae907",
            "filename": "docs/ref/contrib/flatpages.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/3f3010014b33451553c62b005c2ec09a16a9f9ce/docs%2Fref%2Fcontrib%2Fflatpages.txt",
            "raw_url": "https://github.com/django/django/raw/3f3010014b33451553c62b005c2ec09a16a9f9ce/docs%2Fref%2Fcontrib%2Fflatpages.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fflatpages.txt?ref=3f3010014b33451553c62b005c2ec09a16a9f9ce",
            "patch": "@@ -148,6 +148,14 @@ Via the Python API\n \n .. currentmodule:: django.contrib.flatpages\n \n+.. admonition:: Check for duplicate flatpage URLs.\n+\n+    If you add or modify flatpages via your own code, you will likely want to\n+    check for duplicate flatpage URLs within the same site. The flatpage form\n+    used in the admin performs this validation check, and can be imported from\n+    :class:`django.contrib.flatpages.forms.FlatPageForm` and used in your own\n+    views.\n+\n Flatpage templates\n ==================\n "
        }
    ],
    "stats": {
        "total": 68,
        "additions": 53,
        "deletions": 15
    }
}