{
    "author": "charettes",
    "message": "Added a context manager to capture queries while testing.\n\nAlso made some import cleanups while I was there.\n\nRefs #10399.",
    "sha": "952ba5237ea62e7647cdd5214b1df79c0e7cea38",
    "files": [
        {
            "sha": "345e4b191b503d0d21bde0415abd13b4a5b10728",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 11,
            "deletions": 24,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/952ba5237ea62e7647cdd5214b1df79c0e7cea38/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/952ba5237ea62e7647cdd5214b1df79c0e7cea38/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=952ba5237ea62e7647cdd5214b1df79c0e7cea38",
            "patch": "@@ -24,31 +24,30 @@\n from django.core.handlers.wsgi import WSGIHandler\n from django.core.management import call_command\n from django.core.management.color import no_style\n-from django.core.signals import request_started\n from django.core.servers.basehttp import (WSGIRequestHandler, WSGIServer,\n     WSGIServerException)\n from django.core.urlresolvers import clear_url_caches\n from django.core.validators import EMPTY_VALUES\n-from django.db import (transaction, connection, connections, DEFAULT_DB_ALIAS,\n-    reset_queries)\n+from django.db import connection, connections, DEFAULT_DB_ALIAS, transaction\n from django.forms.fields import CharField\n from django.http import QueryDict\n from django.test import _doctest as doctest\n from django.test.client import Client\n from django.test.html import HTMLParseError, parse_html\n from django.test.signals import template_rendered\n-from django.test.utils import (override_settings, compare_xml, strip_quotes)\n-from django.test.utils import ContextList\n-from django.utils import unittest as ut2\n+from django.test.utils import (CaptureQueriesContext, ContextList,\n+    override_settings, compare_xml, strip_quotes)\n+from django.utils import six, unittest as ut2\n from django.utils.encoding import force_text\n-from django.utils import six\n+from django.utils.unittest import skipIf # Imported here for backward compatibility\n from django.utils.unittest.util import safe_repr\n-from django.utils.unittest import skipIf\n from django.views.static import serve\n \n+\n __all__ = ('DocTestRunner', 'OutputChecker', 'TestCase', 'TransactionTestCase',\n            'SimpleTestCase', 'skipIfDBFeature', 'skipUnlessDBFeature')\n \n+\n normalize_long_ints = lambda s: re.sub(r'(?<![\\w])(\\d+)L(?![\\w])', '\\\\1', s)\n normalize_decimals = lambda s: re.sub(r\"Decimal\\('(\\d+(\\.\\d*)?)'\\)\",\n                                 lambda m: \"Decimal(\\\"%s\\\")\" % m.groups()[0], s)\n@@ -168,28 +167,17 @@ def report_unexpected_exception(self, out, test, example, exc_info):\n             transaction.rollback_unless_managed(using=conn)\n \n \n-class _AssertNumQueriesContext(object):\n+class _AssertNumQueriesContext(CaptureQueriesContext):\n     def __init__(self, test_case, num, connection):\n         self.test_case = test_case\n         self.num = num\n-        self.connection = connection\n-\n-    def __enter__(self):\n-        self.old_debug_cursor = self.connection.use_debug_cursor\n-        self.connection.use_debug_cursor = True\n-        self.starting_queries = len(self.connection.queries)\n-        request_started.disconnect(reset_queries)\n-        return self\n+        super(_AssertNumQueriesContext, self).__init__(connection)\n \n     def __exit__(self, exc_type, exc_value, traceback):\n-        self.connection.use_debug_cursor = self.old_debug_cursor\n-        request_started.connect(reset_queries)\n         if exc_type is not None:\n             return\n-\n-        final_queries = len(self.connection.queries)\n-        executed = final_queries - self.starting_queries\n-\n+        super(_AssertNumQueriesContext, self).__exit__(exc_type, exc_value, traceback)\n+        executed = len(self)\n         self.test_case.assertEqual(\n             executed, self.num, \"%d queries executed, %d expected\" % (\n                 executed, self.num\n@@ -1051,7 +1039,6 @@ def run(self):\n         http requests.\n         \"\"\"\n         if self.connections_override:\n-            from django.db import connections\n             # Override this thread's database connections with the ones\n             # provided by the main thread.\n             for alias, conn in self.connections_override.items():"
        },
        {
            "sha": "d839c0403c7f7d67c1b2e79282145dae135c68e9",
            "filename": "django/test/utils.py",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/952ba5237ea62e7647cdd5214b1df79c0e7cea38/django%2Ftest%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/952ba5237ea62e7647cdd5214b1df79c0e7cea38/django%2Ftest%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Futils.py?ref=952ba5237ea62e7647cdd5214b1df79c0e7cea38",
            "patch": "@@ -4,6 +4,8 @@\n \n from django.conf import settings, UserSettingsHolder\n from django.core import mail\n+from django.core.signals import request_started\n+from django.db import reset_queries\n from django.template import Template, loader, TemplateDoesNotExist\n from django.template.loaders import cached\n from django.test.signals import template_rendered, setting_changed\n@@ -339,5 +341,42 @@ def is_quoted_unicode(s):\n         got = got.strip()[2:-1]\n     return want, got\n \n+\n def str_prefix(s):\n     return s % {'_': '' if six.PY3 else 'u'}\n+\n+\n+class CaptureQueriesContext(object):\n+    \"\"\"\n+    Context manager that captures queries executed by the specified connection.\n+    \"\"\"\n+    def __init__(self, connection):\n+        self.connection = connection\n+\n+    def __iter__(self):\n+        return iter(self.captured_queries)\n+\n+    def __getitem__(self, index):\n+        return self.captured_queries[index]\n+\n+    def __len__(self):\n+        return len(self.captured_queries)\n+\n+    @property\n+    def captured_queries(self):\n+        return self.connection.queries[self.initial_queries:self.final_queries]\n+\n+    def __enter__(self):\n+        self.use_debug_cursor = self.connection.use_debug_cursor\n+        self.connection.use_debug_cursor = True\n+        self.initial_queries = len(self.connection.queries)\n+        self.final_queries = None\n+        request_started.disconnect(reset_queries)\n+        return self\n+\n+    def __exit__(self, exc_type, exc_value, traceback):\n+        self.connection.use_debug_cursor = self.use_debug_cursor\n+        request_started.connect(reset_queries)\n+        if exc_type is not None:\n+            return\n+        self.final_queries = len(self.connection.queries)"
        },
        {
            "sha": "f0cfac75941d14a2a3b7a150d3110b70bb9971d0",
            "filename": "tests/test_utils/tests.py",
            "status": "modified",
            "additions": 58,
            "deletions": 9,
            "changes": 67,
            "blob_url": "https://github.com/django/django/blob/952ba5237ea62e7647cdd5214b1df79c0e7cea38/tests%2Ftest_utils%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/952ba5237ea62e7647cdd5214b1df79c0e7cea38/tests%2Ftest_utils%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Ftest_utils%2Ftests.py?ref=952ba5237ea62e7647cdd5214b1df79c0e7cea38",
            "patch": "@@ -1,10 +1,14 @@\n # -*- coding: utf-8 -*-\n from __future__ import absolute_import, unicode_literals\n+import warnings\n \n+from django.db import connection\n from django.forms import EmailField, IntegerField\n from django.http import HttpResponse\n from django.template.loader import render_to_string\n from django.test import SimpleTestCase, TestCase, skipUnlessDBFeature\n+from django.test.html import HTMLParseError, parse_html\n+from django.test.utils import CaptureQueriesContext\n from django.utils import six\n from django.utils.unittest import skip\n \n@@ -94,6 +98,60 @@ def test_undefined_order(self):\n         )\n \n \n+class CaptureQueriesContextManagerTests(TestCase):\n+    urls = 'test_utils.urls'\n+\n+    def setUp(self):\n+        self.person_pk = six.text_type(Person.objects.create(name='test').pk)\n+\n+    def test_simple(self):\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            Person.objects.get(pk=self.person_pk)\n+        self.assertEqual(len(captured_queries), 1)\n+        self.assertIn(self.person_pk, captured_queries[0]['sql'])\n+\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            pass\n+        self.assertEqual(0, len(captured_queries))\n+\n+    def test_within(self):\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            Person.objects.get(pk=self.person_pk)\n+            self.assertEqual(len(captured_queries), 1)\n+            self.assertIn(self.person_pk, captured_queries[0]['sql'])\n+\n+    def test_nested(self):\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            Person.objects.count()\n+            with CaptureQueriesContext(connection) as nested_captured_queries:\n+                Person.objects.count()\n+        self.assertEqual(1, len(nested_captured_queries))\n+        self.assertEqual(2, len(captured_queries))\n+\n+    def test_failure(self):\n+        with self.assertRaises(TypeError):\n+            with CaptureQueriesContext(connection):\n+                raise TypeError\n+\n+    def test_with_client(self):\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            self.client.get(\"/test_utils/get_person/%s/\" % self.person_pk)\n+        self.assertEqual(len(captured_queries), 1)\n+        self.assertIn(self.person_pk, captured_queries[0]['sql'])\n+\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            self.client.get(\"/test_utils/get_person/%s/\" % self.person_pk)\n+        self.assertEqual(len(captured_queries), 1)\n+        self.assertIn(self.person_pk, captured_queries[0]['sql'])\n+\n+        with CaptureQueriesContext(connection) as captured_queries:\n+            self.client.get(\"/test_utils/get_person/%s/\" % self.person_pk)\n+            self.client.get(\"/test_utils/get_person/%s/\" % self.person_pk)\n+        self.assertEqual(len(captured_queries), 2)\n+        self.assertIn(self.person_pk, captured_queries[0]['sql'])\n+        self.assertIn(self.person_pk, captured_queries[1]['sql'])\n+\n+\n class AssertNumQueriesContextManagerTests(TestCase):\n     urls = 'test_utils.urls'\n \n@@ -219,7 +277,6 @@ def test_save_restore_warnings_state(self):\n         # In reality this test could be satisfied by many broken implementations\n         # of save_warnings_state/restore_warnings_state (e.g. just\n         # warnings.resetwarnings()) , but it is difficult to test more.\n-        import warnings\n         with warnings.catch_warnings():\n             warnings.simplefilter(\"ignore\", DeprecationWarning)\n \n@@ -245,7 +302,6 @@ class MyWarning(Warning):\n \n class HTMLEqualTests(TestCase):\n     def test_html_parser(self):\n-        from django.test.html import parse_html\n         element = parse_html('<div><p>Hello</p></div>')\n         self.assertEqual(len(element.children), 1)\n         self.assertEqual(element.children[0].name, 'p')\n@@ -259,7 +315,6 @@ def test_html_parser(self):\n         self.assertEqual(dom[0], 'foo')\n \n     def test_parse_html_in_script(self):\n-        from django.test.html import parse_html\n         parse_html('<script>var a = \"<p\" + \">\";</script>');\n         parse_html('''\n             <script>\n@@ -275,8 +330,6 @@ def test_parse_html_in_script(self):\n         self.assertEqual(dom.children[0], \"<p>foo</p> '</scr'+'ipt>' <span>bar</span>\")\n \n     def test_self_closing_tags(self):\n-        from django.test.html import parse_html\n-\n         self_closing_tags = ('br' , 'hr', 'input', 'img', 'meta', 'spacer',\n             'link', 'frame', 'base', 'col')\n         for tag in self_closing_tags:\n@@ -400,7 +453,6 @@ def test_complex_examples(self):\n         </html>\"\"\")\n \n     def test_html_contain(self):\n-        from django.test.html import parse_html\n         # equal html contains each other\n         dom1 = parse_html('<p>foo')\n         dom2 = parse_html('<p>foo</p>')\n@@ -424,7 +476,6 @@ def test_html_contain(self):\n         self.assertTrue(dom1 in dom2)\n \n     def test_count(self):\n-        from django.test.html import parse_html\n         # equal html contains each other one time\n         dom1 = parse_html('<p>foo')\n         dom2 = parse_html('<p>foo</p>')\n@@ -459,7 +510,6 @@ def test_count(self):\n         self.assertEqual(dom2.count(dom1), 0)\n \n     def test_parsing_errors(self):\n-        from django.test.html import HTMLParseError, parse_html\n         with self.assertRaises(AssertionError):\n             self.assertHTMLEqual('<p>', '')\n         with self.assertRaises(AssertionError):\n@@ -488,7 +538,6 @@ def test_contains_html(self):\n             self.assertContains(response, '<p \"whats\" that>')\n \n     def test_unicode_handling(self):\n-        from django.http import HttpResponse\n         response = HttpResponse('<p class=\"help\">Some help text for the title (with unicode ŠĐĆŽćžšđ)</p>')\n         self.assertContains(response, '<p class=\"help\">Some help text for the title (with unicode ŠĐĆŽćžšđ)</p>', html=True)\n "
        }
    ],
    "stats": {
        "total": 141,
        "additions": 108,
        "deletions": 33
    }
}