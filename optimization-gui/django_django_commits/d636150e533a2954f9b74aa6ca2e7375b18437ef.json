{
    "author": "jphalip",
    "message": "Fixed #17198 -- Ensured that a deterministic order is used across all database backends for displaying the admin change list's results. Many thanks to Luke Plant for the report and general approach, to everyone involved in the design discussions, and to Carl Meyer for the patch review. Refs #16819.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17635 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d636150e533a2954f9b74aa6ca2e7375b18437ef",
    "files": [
        {
            "sha": "56f13f8099a46fab1e32d22a357d6dd7e2cba6af",
            "filename": "django/contrib/admin/views/main.py",
            "status": "modified",
            "additions": 26,
            "deletions": 9,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/d636150e533a2954f9b74aa6ca2e7375b18437ef/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "raw_url": "https://github.com/django/django/raw/d636150e533a2954f9b74aa6ca2e7375b18437ef/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fmain.py?ref=d636150e533a2954f9b74aa6ca2e7375b18437ef",
            "patch": "@@ -66,7 +66,6 @@ def __init__(self, request, model, list_display, list_display_links,\n             self.list_editable = ()\n         else:\n             self.list_editable = list_editable\n-        self.ordering = self.get_ordering(request)\n         self.query = request.GET.get(SEARCH_VAR, '')\n         self.query_set = self.get_query_set(request)\n         self.get_results(request)\n@@ -218,13 +217,18 @@ def get_ordering_field(self, field_name):\n                 attr = getattr(self.model, field_name)\n             return getattr(attr, 'admin_order_field', None)\n \n-    def get_ordering(self, request):\n+    def get_ordering(self, request, queryset):\n+        \"\"\"\n+        Returns the list of ordering fields for the change list.\n+        First we check the get_ordering() method in model admin, then we check\n+        the object's default ordering. Then, any manually-specified ordering\n+        from the query string overrides anything. Finally, a deterministic\n+        order is guaranteed by ensuring the primary key is used as the last\n+        ordering field.\n+        \"\"\"\n         params = self.params\n-        # For ordering, first check the if exists the \"get_ordering\" method\n-        # in model admin, then check \"ordering\" parameter in the admin\n-        # options, then check the object's default ordering. Finally, a\n-        # manually-specified ordering from the query string overrides anything.\n-        ordering = self.model_admin.get_ordering(request) or self._get_default_ordering()\n+        ordering = list(self.model_admin.get_ordering(request)\n+                        or self._get_default_ordering())\n         if ORDER_VAR in params:\n             # Clear ordering and used params\n             ordering = []\n@@ -239,6 +243,19 @@ def get_ordering(self, request):\n                     ordering.append(pfx + order_field)\n                 except (IndexError, ValueError):\n                     continue # Invalid ordering specified, skip it.\n+\n+        # Add the given query's ordering fields, if any.\n+        ordering.extend(queryset.query.order_by)\n+\n+        # Ensure that the primary key is systematically present in the list of\n+        # ordering fields so we can guarantee a deterministic order across all\n+        # database backends.\n+        pk_name = self.lookup_opts.pk.name\n+        if not (set(ordering) & set(['pk', '-pk', pk_name, '-' + pk_name])):\n+            # The two sets do not intersect, meaning the pk isn't present. So\n+            # we add it.\n+            ordering.append('pk')\n+\n         return ordering\n \n     def get_ordering_field_columns(self):\n@@ -322,8 +339,8 @@ def get_query_set(self, request):\n                             break\n \n         # Set ordering.\n-        if self.ordering:\n-            qs = qs.order_by(*self.ordering)\n+        ordering = self.get_ordering(request, qs)\n+        qs = qs.order_by(*ordering)\n \n         # Apply keyword searches.\n         def construct_search(field_name):"
        },
        {
            "sha": "6b443bf53650bcadca37b2f0bb5d998dc31e4daf",
            "filename": "tests/regressiontests/admin_changelist/models.py",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Fmodels.py?ref=d636150e533a2954f9b74aa6ca2e7375b18437ef",
            "patch": "@@ -57,3 +57,27 @@ class Swallow(models.Model):\n \n     class Meta:\n         ordering = ('speed', 'load')\n+\n+\n+class UnorderedObject(models.Model):\n+    \"\"\"\n+    Model without any defined `Meta.ordering`.\n+    Refs #17198.\n+    \"\"\"\n+    bool = models.BooleanField(default=True)\n+\n+\n+class OrderedObjectManager(models.Manager):\n+    def get_query_set(self):\n+        return super(OrderedObjectManager, self).get_query_set().order_by('-number')\n+\n+class OrderedObject(models.Model):\n+    \"\"\"\n+    Model with Manager that defines a default order.\n+    Refs #17198.\n+    \"\"\"\n+    name = models.CharField(max_length=255)\n+    bool = models.BooleanField(default=True)\n+    number = models.IntegerField(default=0)\n+\n+    objects = OrderedObjectManager()\n\\ No newline at end of file"
        },
        {
            "sha": "d2b017b258b6843570bdc37da850f68a6d76af53",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 91,
            "deletions": 1,
            "changes": 92,
            "blob_url": "https://github.com/django/django/blob/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=d636150e533a2954f9b74aa6ca2e7375b18437ef",
            "patch": "@@ -14,7 +14,8 @@\n     FilteredChildAdmin, CustomPaginator, site as custom_site,\n     SwallowAdmin)\n from .models import (Child, Parent, Genre, Band, Musician, Group, Quartet,\n-    Membership, ChordsMusician, ChordsBand, Invitation, Swallow)\n+    Membership, ChordsMusician, ChordsBand, Invitation, Swallow,\n+    UnorderedObject, OrderedObject)\n \n \n class ChangeListTests(TestCase):\n@@ -430,3 +431,92 @@ def test_tuple_list_display(self):\n         self.assertContains(response, unicode(swallow.load))\n         self.assertContains(response, unicode(swallow.speed))\n \n+    def test_deterministic_order_for_unordered_model(self):\n+        \"\"\"\n+        Ensure that the primary key is systematically used in the ordering of\n+        the changelist's results to guarantee a deterministic order, even\n+        when the Model doesn't have any default ordering defined.\n+        Refs #17198.\n+        \"\"\"\n+        superuser = self._create_superuser('superuser')\n+\n+        for counter in range(1, 51):\n+            UnorderedObject.objects.create(id=counter, bool=True)\n+\n+        class UnorderedObjectAdmin(admin.ModelAdmin):\n+            list_per_page = 10\n+\n+        def check_results_order(reverse=False):\n+            admin.site.register(UnorderedObject, UnorderedObjectAdmin)\n+            model_admin = UnorderedObjectAdmin(UnorderedObject, admin.site)\n+            counter = 51 if reverse else 0\n+            for page in range (0, 5):\n+                request = self._mocked_authenticated_request('/unorderedobject/?p=%s' % page, superuser)\n+                response = model_admin.changelist_view(request)\n+                for result in response.context_data['cl'].result_list:\n+                    counter += -1 if reverse else 1\n+                    self.assertEqual(result.id, counter)\n+            admin.site.unregister(UnorderedObject)\n+\n+        # When no order is defined at all, everything is ordered by 'pk'.\n+        check_results_order()\n+\n+        # When an order field is defined but multiple records have the same\n+        # value for that field, make sure everything gets ordered by pk as well.\n+        UnorderedObjectAdmin.ordering = ['bool']\n+        check_results_order()\n+\n+        # When order fields are defined, including the pk itself, use them.\n+        UnorderedObjectAdmin.ordering = ['bool', '-pk']\n+        check_results_order(reverse=True)\n+        UnorderedObjectAdmin.ordering = ['bool', 'pk']\n+        check_results_order()\n+        UnorderedObjectAdmin.ordering = ['-id', 'bool']\n+        check_results_order(reverse=True)\n+        UnorderedObjectAdmin.ordering = ['id', 'bool']\n+        check_results_order()\n+\n+    def test_deterministic_order_for_model_ordered_by_its_manager(self):\n+        \"\"\"\n+        Ensure that the primary key is systematically used in the ordering of\n+        the changelist's results to guarantee a deterministic order, even\n+        when the Model has a manager that defines a default ordering.\n+        Refs #17198.\n+        \"\"\"\n+        superuser = self._create_superuser('superuser')\n+\n+        for counter in range(1, 51):\n+            OrderedObject.objects.create(id=counter, bool=True, number=counter)\n+\n+        class OrderedObjectAdmin(admin.ModelAdmin):\n+            list_per_page = 10\n+\n+        def check_results_order(reverse=False):\n+            admin.site.register(OrderedObject, OrderedObjectAdmin)\n+            model_admin = OrderedObjectAdmin(OrderedObject, admin.site)\n+            counter = 51 if reverse else 0\n+            for page in range (0, 5):\n+                request = self._mocked_authenticated_request('/orderedobject/?p=%s' % page, superuser)\n+                response = model_admin.changelist_view(request)\n+                for result in response.context_data['cl'].result_list:\n+                    counter += -1 if reverse else 1\n+                    self.assertEqual(result.id, counter)\n+            admin.site.unregister(OrderedObject)\n+\n+        # When no order is defined at all, use the model's default ordering (i.e. '-number')\n+        check_results_order(reverse=True)\n+\n+        # When an order field is defined but multiple records have the same\n+        # value for that field, make sure everything gets ordered by pk as well.\n+        OrderedObjectAdmin.ordering = ['bool']\n+        check_results_order()\n+\n+        # When order fields are defined, including the pk itself, use them.\n+        OrderedObjectAdmin.ordering = ['bool', '-pk']\n+        check_results_order(reverse=True)\n+        OrderedObjectAdmin.ordering = ['bool', 'pk']\n+        check_results_order()\n+        OrderedObjectAdmin.ordering = ['-id', 'bool']\n+        check_results_order(reverse=True)\n+        OrderedObjectAdmin.ordering = ['id', 'bool']\n+        check_results_order()\n\\ No newline at end of file"
        },
        {
            "sha": "d9607496c3b28fc9dd9148415fd2932aebf8e20a",
            "filename": "tests/regressiontests/admin_views/admin.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fadmin.py?ref=d636150e533a2954f9b74aa6ca2e7375b18437ef",
            "patch": "@@ -26,7 +26,8 @@\n     CoverLetter, Story, OtherStory, Book, Promo, ChapterXtra1, Pizza, Topping,\n     Album, Question, Answer, ComplexSortedPerson, PrePopulatedPostLargeSlug,\n     AdminOrderedField, AdminOrderedModelMethod, AdminOrderedAdminMethod,\n-    AdminOrderedCallable, Report, Color2, MainPrepopulated, RelatedPrepopulated)\n+    AdminOrderedCallable, Report, Color2, UnorderedObject, MainPrepopulated,\n+    RelatedPrepopulated)\n \n \n def callable_year(dt_value):\n@@ -562,6 +563,11 @@ class MainPrepopulatedAdmin(admin.ModelAdmin):\n                            'slug2': ['status', 'name']}\n \n \n+class UnorderedObjectAdmin(admin.ModelAdmin):\n+    list_display = ['name']\n+    list_editable = ['name']\n+    list_per_page = 2\n+\n \n \n site = admin.AdminSite(name=\"admin\")\n@@ -609,6 +615,7 @@ class MainPrepopulatedAdmin(admin.ModelAdmin):\n site.register(OtherStory, OtherStoryAdmin)\n site.register(Report, ReportAdmin)\n site.register(MainPrepopulated, MainPrepopulatedAdmin)\n+site.register(UnorderedObject, UnorderedObjectAdmin)\n \n # We intentionally register Promo and ChapterXtra1 but not Chapter nor ChapterXtra2.\n # That way we cover all four cases:"
        },
        {
            "sha": "17533f9f800dd46ac963f93c60c9cf1db6f1f493",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=d636150e533a2954f9b74aa6ca2e7375b18437ef",
            "patch": "@@ -596,4 +596,13 @@ class RelatedPrepopulated(models.Model):\n         choices=(('option one', 'Option One'),\n                  ('option two', 'Option Two')))\n     slug1 = models.SlugField(max_length=50)\n-    slug2 = models.SlugField(max_length=60)\n\\ No newline at end of file\n+    slug2 = models.SlugField(max_length=60)\n+\n+\n+class UnorderedObject(models.Model):\n+    \"\"\"\n+    Model without any defined `Meta.ordering`.\n+    Refs #16819.\n+    \"\"\"\n+    name = models.CharField(max_length=255)\n+    bool = models.BooleanField(default=True)"
        },
        {
            "sha": "5241d263a7fac4870b345d5cad878686fc01e77a",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 4,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d636150e533a2954f9b74aa6ca2e7375b18437ef/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=d636150e533a2954f9b74aa6ca2e7375b18437ef",
            "patch": "@@ -12,6 +12,7 @@\n from django.core.files import temp as tempfile\n from django.core.urlresolvers import reverse\n # Register auth models with the admin.\n+from django.contrib import admin\n from django.contrib.admin.helpers import ACTION_CHECKBOX_NAME\n from django.contrib.admin.models import LogEntry, DELETION\n from django.contrib.admin.sites import LOGIN_FORM_KEY\n@@ -41,7 +42,7 @@\n     FoodDelivery, RowLevelChangePermissionModel, Paper, CoverLetter, Story,\n     OtherStory, ComplexSortedPerson, Parent, Child, AdminOrderedField,\n     AdminOrderedModelMethod, AdminOrderedAdminMethod, AdminOrderedCallable,\n-    Report, MainPrepopulated, RelatedPrepopulated)\n+    Report, MainPrepopulated, RelatedPrepopulated, UnorderedObject)\n \n \n ERROR_MESSAGE = \"Please enter the correct username and password \\\n@@ -272,9 +273,12 @@ def testChangeListSortingMultiple(self):\n         )\n \n     def testChangeListSortingPreserveQuerySetOrdering(self):\n-        # If no ordering on ModelAdmin, or query string, the underlying order of\n-        # the queryset should not be changed.\n-\n+        \"\"\"\n+        If no ordering is defined in `ModelAdmin.ordering` or in the query\n+        string, then the underlying order of the queryset should not be\n+        changed, even if it is defined in `Modeladmin.queryset()`.\n+        Refs #11868, #7309.\n+        \"\"\"\n         p1 = Person.objects.create(name=\"Amy\", gender=1, alive=True, age=80)\n         p2 = Person.objects.create(name=\"Bob\", gender=1, alive=True, age=70)\n         p3 = Person.objects.create(name=\"Chris\", gender=2, alive=False, age=60)\n@@ -1881,6 +1885,23 @@ def test_list_editable_ordering(self):\n         self.assertEqual(Category.objects.get(id=3).order, 1)\n         self.assertEqual(Category.objects.get(id=4).order, 0)\n \n+    def test_list_editable_pagination(self):\n+        \"\"\"\n+        Ensure that pagination works for list_editable items.\n+        Refs #16819.\n+        \"\"\"\n+        UnorderedObject.objects.create(id=1, name='Unordered object #1')\n+        UnorderedObject.objects.create(id=2, name='Unordered object #2')\n+        UnorderedObject.objects.create(id=3, name='Unordered object #3')\n+        response = self.client.get('/test_admin/admin/admin_views/unorderedobject/')\n+        self.assertContains(response, 'Unordered object #1')\n+        self.assertContains(response, 'Unordered object #2')\n+        self.assertNotContains(response, 'Unordered object #3')\n+        response = self.client.get('/test_admin/admin/admin_views/unorderedobject/?p=1')\n+        self.assertNotContains(response, 'Unordered object #1')\n+        self.assertNotContains(response, 'Unordered object #2')\n+        self.assertContains(response, 'Unordered object #3')\n+\n     def test_list_editable_action_submit(self):\n         # List editable changes should not be executed if the action \"Go\" button is\n         # used to submit the form."
        }
    ],
    "stats": {
        "total": 200,
        "additions": 184,
        "deletions": 16
    }
}