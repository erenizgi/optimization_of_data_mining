{
    "author": "aaugustin",
    "message": "Fixed multiple database tests that broke foreign keys constraints. Refs #17055.\n\nThe problem was masked by the rollback at the end of each transactional test on backends that deferred constraints checks; it appeared only on MySQL + InnoDB.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16995 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8fb7a9002669fb7ba7bec7df90b465b92e1ed3c2",
    "files": [
        {
            "sha": "d5bf8479bba1cd75e33e8fc2967425c5b0e950ee",
            "filename": "tests/regressiontests/multiple_database/tests.py",
            "status": "modified",
            "additions": 42,
            "deletions": 3,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/8fb7a9002669fb7ba7bec7df90b465b92e1ed3c2/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/8fb7a9002669fb7ba7bec7df90b465b92e1ed3c2/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py?ref=8fb7a9002669fb7ba7bec7df90b465b92e1ed3c2",
            "patch": "@@ -6,6 +6,7 @@\n \n from django.conf import settings\n from django.contrib.auth.models import User\n+from django.contrib.contenttypes.models import ContentType\n from django.core import management\n from django.db import connections, router, DEFAULT_DB_ALIAS\n from django.db.models import signals\n@@ -14,6 +15,16 @@\n from .models import Book, Person, Pet, Review, UserProfile\n \n \n+def copy_content_types_from_default_to_other():\n+    # On post_syncdb, content types are created in the 'default' database.\n+    # However, tests of generic foreign keys require them in 'other' too.\n+    # The problem is masked on backends that defer constraints checks: at the\n+    # end of each test, there's a rollback, and constraints are never checked.\n+    # It only appears on MySQL + InnoDB.\n+    for ct in ContentType.objects.using('default').all():\n+        ct.save(using='other')\n+\n+\n class QueryTestCase(TestCase):\n     multi_db = True\n \n@@ -692,6 +703,8 @@ def test_o2o_cross_database_protection(self):\n \n     def test_generic_key_separation(self):\n         \"Generic fields are constrained to a single database\"\n+        copy_content_types_from_default_to_other()\n+\n         # Create a book and author on the default database\n         pro = Book.objects.create(title=\"Pro Django\",\n                                   published=datetime.date(2008, 12, 16))\n@@ -719,6 +732,8 @@ def test_generic_key_separation(self):\n \n     def test_generic_key_reverse_operations(self):\n         \"Generic reverse manipulations are all constrained to a single DB\"\n+        copy_content_types_from_default_to_other()\n+\n         dive = Book.objects.using('other').create(title=\"Dive into Python\",\n                                                   published=datetime.date(2009, 5, 4))\n \n@@ -763,6 +778,8 @@ def test_generic_key_reverse_operations(self):\n \n     def test_generic_key_cross_database_protection(self):\n         \"Operations that involve sharing generic key objects across databases raise an error\"\n+        copy_content_types_from_default_to_other()\n+\n         # Create a book and author on the default database\n         pro = Book.objects.create(title=\"Pro Django\",\n                                   published=datetime.date(2008, 12, 16))\n@@ -814,6 +831,8 @@ def test_generic_key_cross_database_protection(self):\n \n     def test_generic_key_deletion(self):\n         \"Cascaded deletions of Generic Key relations issue queries on the right database\"\n+        copy_content_types_from_default_to_other()\n+\n         dive = Book.objects.using('other').create(title=\"Dive into Python\",\n                                                   published=datetime.date(2009, 5, 4))\n         review = Review.objects.using('other').create(source=\"Python Weekly\", content_object=dive)\n@@ -1217,6 +1236,15 @@ def test_foreign_key_cross_database_protection(self):\n         water = Book(title=\"Dive into Water\", published=datetime.date(2001, 1, 1), editor=mark)\n         self.assertEqual(water._state.db, 'default')\n \n+        # For the remainder of this test, create a copy of 'mark' in the\n+        # 'default' database to prevent integrity errors on backends that\n+        # don't defer constraints checks until the end of the transaction\n+        mark.save(using='default')\n+\n+        # This moved 'mark' in the 'default' database, move it back in 'other'\n+        mark.save(using='other')\n+        self.assertEqual(mark._state.db, 'other')\n+\n         # If you create an object through a FK relation, it will be\n         # written to the write database, even if the original object\n         # was on the read database\n@@ -1372,6 +1400,8 @@ def test_o2o_cross_database_protection(self):\n \n     def test_generic_key_cross_database_protection(self):\n         \"Generic Key operations can span databases if they share a source\"\n+        copy_content_types_from_default_to_other()\n+\n         # Create a book and author on the default database\n         pro = Book.objects.using('default'\n                 ).create(title=\"Pro Django\", published=datetime.date(2008, 12, 16))\n@@ -1459,7 +1489,8 @@ def test_m2m_managers(self):\n                                                  published=datetime.date(2008, 12, 16))\n \n         marty = Person.objects.using('other').create(pk=1, name=\"Marty Alchin\")\n-        pro.authors = [marty]\n+        pro_authors = pro.authors.using('other')\n+        authors = [marty]\n \n         self.assertEqual(pro.authors.db, 'other')\n         self.assertEqual(pro.authors.db_manager('default').db, 'default')\n@@ -1482,6 +1513,8 @@ def test_foreign_key_managers(self):\n \n     def test_generic_key_managers(self):\n         \"Generic key relations are represented by managers, and can be controlled like managers\"\n+        copy_content_types_from_default_to_other()\n+\n         pro = Book.objects.using('other').create(title=\"Pro Django\",\n                                                  published=datetime.date(2008, 12, 16))\n \n@@ -1745,14 +1778,20 @@ def test_database_arg_m2m(self):\n         \"\"\"\n         # Make a receiver\n         receiver = DatabaseReceiver()\n-        # Connect it, and make the models\n+        # Connect it\n         signals.m2m_changed.connect(receiver=receiver)\n \n+        # Create the models that will be used for the tests\n         b = Book.objects.create(title=\"Pro Django\",\n                                 published=datetime.date(2008, 12, 16))\n-\n         p = Person.objects.create(name=\"Marty Alchin\")\n \n+        # Create a copy of the models on the 'other' database to prevent\n+        # integrity errors on backends that don't defer constraints checks\n+        Book.objects.using('other').create(pk=b.pk, title=b.title,\n+                                           published=b.published)\n+        Person.objects.using('other').create(pk=p.pk, name=p.name)\n+\n         # Test addition\n         b.authors.add(p)\n         self.assertEqual(receiver._database, DEFAULT_DB_ALIAS)"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 42,
        "deletions": 3
    }
}