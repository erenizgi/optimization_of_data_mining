{
    "author": "spookylukey",
    "message": "Improved UI for advanced sorting controls.\n\nNow allows individual fields to be removed/toggled.\n\nRefs #11868\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16320 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "74b16162902864c59c63fcb7936f604a738aecee",
    "files": [
        {
            "sha": "0aab2b3f8ac4cb7ac946a623bf6670bdd88b3248",
            "filename": "django/contrib/admin/media/css/base.css",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/74b16162902864c59c63fcb7936f604a738aecee/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Fbase.css",
            "raw_url": "https://github.com/django/django/raw/74b16162902864c59c63fcb7936f604a738aecee/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Fbase.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fmedia%2Fcss%2Fbase.css?ref=74b16162902864c59c63fcb7936f604a738aecee",
            "patch": "@@ -351,7 +351,27 @@ table thead th.sorted a span.clear {\n     background-color: white;\n     border: 1px solid #ddd;\n     z-index: 2000; /* more than filters on right */\n-    padding-right: 10px;\n+}\n+\n+#sorting-popup-div table {\n+    border-right: 0px;\n+    border-left: 0px;\n+}\n+\n+#sorting-popup-div .reset {\n+    text-align: center;\n+}\n+\n+#sorting-popup-div .cancel {\n+    font-size: 10px;\n+    background: #e1e1e1 url(../img/admin/nav-bg.gif) 0 50% repeat-x;\n+    border-top: 1px solid #ddd;\n+    text-align: center;\n+}\n+\n+#sorting-popup-div .cancel a {\n+    width: 100%;\n+    display: block;\n }\n \n /* ORDERABLE TABLES */"
        },
        {
            "sha": "ae62ce85484354192ce988045887bae977655172",
            "filename": "django/contrib/admin/templates/admin/change_list_results.html",
            "status": "modified",
            "additions": 59,
            "deletions": 29,
            "changes": 88,
            "blob_url": "https://github.com/django/django/blob/74b16162902864c59c63fcb7936f604a738aecee/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html",
            "raw_url": "https://github.com/django/django/raw/74b16162902864c59c63fcb7936f604a738aecee/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Fchange_list_results.html?ref=74b16162902864c59c63fcb7936f604a738aecee",
            "patch": "@@ -12,7 +12,7 @@\n <tr>\n {% for header in result_headers %}\n <th scope=\"col\" {{ header.class_attrib }}>\n-  {% if header.sortable %}<a href=\"{{ header.url }}\">{% endif %}\n+  {% if header.sortable %}<a href=\"{{ header.url_primary }}\">{% endif %}\n   <span class=\"text\">{{ header.text|capfirst }}</span>\n   {% if header.sortable %}\n     {% if header.sort_pos > 0 %}<span class=\"sortpos\">\n@@ -37,47 +37,77 @@\n \n {# Sorting popup: #}\n <div style=\"display: none;\" id=\"sorting-popup-div\">\n-<p>{% trans \"Sorting by:\" %}</p>\n-<ol>\n-{% for header in result_headers|dictsort:\"sort_pos\" %}\n-  {% if header.sort_pos > 0 %}\n-    {% if header.ascending %}\n-      <li>{% blocktrans with fieldname=header.text %}{{ fieldname }} (ascending){% endblocktrans %}</li>\n-    {% else %}\n-      <li>{% blocktrans with fieldname=header.text %}{{ fieldname }} (descending){% endblocktrans %}</li>\n+<table>\n+  <caption>\n+   {% trans \"Sorting by:\" %}\n+  </caption>\n+  <tbody>\n+  {% for header in result_headers|dictsort:\"sort_pos\" %}\n+    {% if header.sort_pos > 0 %}\n+    <tr>\n+      <td>{{ header.sort_pos }}</td>\n+      <td>{{ header.text|capfirst }}</td>\n+      <td>{% if header.ascending %}{% trans \"ascending\" %}{% else %}{% trans \"descending\" %}{% endif %}</td>\n+      <td><a href=\"{{ header.url_toggle }}\">{% trans \"toggle\" %}</a></td>\n+      <td><a href=\"{{ header.url_remove }}\">{% trans \"remove\" %}</a></td>\n+    </tr>\n     {% endif %}\n-  {% endif %}\n-{% endfor %}\n-</ol>\n-<p><a href=\"{{ reset_sorting_url }}\">{% trans \"Reset sorting\" %}</a></p>\n+  {% endfor %}\n+  </tbody>\n+</table>\n+<div class=\"reset\"><a href=\"{{ reset_sorting_url }}\">{% trans \"Reset sorting\" %}</a></div>\n+<div class=\"cancel\"><a href=\"javascript:void\" id=\"sorting-popup-dismiss\">{% trans \"Cancel\" %}</a></div>\n </div>\n <script type=\"text/javascript\">\n <!--\n (function($) {\n     $(document).ready(function() {\n         var popup = $('#sorting-popup-div');\n+        var img = $('#primary-sort-icon');\n         /* These next lines seems necessary to prime the popup: */\n         popup.offset({left:-1000, top:0});\n         popup.show();\n         var popupWidth = popup.width();\n         popup.hide();\n \n-        $('#primary-sort-icon').toggle(function(ev) {\n-                                          ev.preventDefault();\n-                                          var img = $(this);\n-                                          var pos = img.offset();\n-                                          pos.top += img.height();\n-                                          if (pos.left + popupWidth >\n-                                              $(window).width()) {\n-                                              pos.left -= popupWidth;\n-                                          }\n-                                          popup.show();\n-                                          popup.offset(pos);\n-                                      },\n-                                      function(ev) {\n-                                          ev.preventDefault();\n-                                          popup.hide();\n-                                      });\n+        var visible = false;\n+\n+        var escHandler = function(ev) {\n+            if (ev.which == 27) {\n+                hidePopup();\n+                ev.preventDefault();\n+            }\n+        };\n+\n+        var showPopup = function() {\n+            var pos = img.offset();\n+            pos.top += img.height();\n+            if (pos.left + popupWidth >\n+                $(window).width()) {\n+                pos.left -= popupWidth;\n+            }\n+            popup.show();\n+            popup.offset(pos);\n+            visible = true;\n+            $(document).bind('keyup', escHandler);\n+        };\n+\n+        var hidePopup = function() {\n+            popup.hide();\n+            visible = false;\n+            $(document).unbind('keyup', escHandler);\n+        };\n+\n+        $('#primary-sort-icon').click(function(ev) {\n+            ev.preventDefault();\n+            if (visible) {\n+                hidePopup();\n+            } else {\n+                showPopup();\n+            }\n+        });\n+\n+        $('#sorting-popup-dismiss').click(hidePopup);\n     });\n })(django.jQuery);\n //-->"
        },
        {
            "sha": "12efcd6cc0383a104c2eb1e8aeecaf8672bc76aa",
            "filename": "django/contrib/admin/templatetags/admin_list.py",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/74b16162902864c59c63fcb7936f604a738aecee/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "raw_url": "https://github.com/django/django/raw/74b16162902864c59c63fcb7936f604a738aecee/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplatetags%2Fadmin_list.py?ref=74b16162902864c59c63fcb7936f604a738aecee",
            "patch": "@@ -122,28 +122,37 @@ def result_headers(cl):\n             new_order_type = {'asc': 'desc', 'desc': 'asc'}[order_type]\n \n         # build new ordering param\n-        o_list = []\n+        o_list_primary = [] # URL for making this field the primary sort\n+        o_list_remove  = [] # URL for removing this field from sort\n+        o_list_toggle  = [] # URL for toggling order type for this field\n         make_qs_param = lambda t, n: ('-' if t == 'desc' else '') + str(n)\n \n         for j, ot in ordering_field_columns.items():\n             if j == i: # Same column\n+                param = make_qs_param(new_order_type, j)\n                 # We want clicking on this header to bring the ordering to the\n                 # front\n-                o_list.insert(0, make_qs_param(new_order_type, j))\n+                o_list_primary.insert(0, param)\n+                o_list_toggle.append(param)\n+                # o_list_remove - omit\n             else:\n-                o_list.append(make_qs_param(ot, j))\n+                param = make_qs_param(ot, j)\n+                o_list_primary.append(param)\n+                o_list_toggle.append(param)\n+                o_list_remove.append(param)\n \n         if i not in ordering_field_columns:\n-            o_list.insert(0, make_qs_param(new_order_type, i))\n+            o_list_primary.insert(0, make_qs_param(new_order_type, i))\n \n-        o_list = '.'.join(o_list)\n \n         yield {\n             \"text\": text,\n             \"sortable\": True,\n             \"ascending\": order_type == \"asc\",\n             \"sort_pos\": sort_pos,\n-            \"url\": cl.get_query_string({ORDER_VAR: o_list}),\n+            \"url_primary\": cl.get_query_string({ORDER_VAR: '.'.join(o_list_primary)}),\n+            \"url_remove\": cl.get_query_string({ORDER_VAR: '.'.join(o_list_remove)}),\n+            \"url_toggle\": cl.get_query_string({ORDER_VAR: '.'.join(o_list_toggle)}),\n             \"class_attrib\": mark_safe(th_classes and ' class=\"%s\"' % ' '.join(th_classes) or '')\n         }\n "
        }
    ],
    "stats": {
        "total": 131,
        "additions": 95,
        "deletions": 36
    }
}