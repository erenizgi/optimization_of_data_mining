{
    "author": "freakboy3742",
    "message": "Migrated model_formsets doctests. Thanks to Gregor MÃ¼llegger for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14590 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "9b45f6cd5444423693715cc2a04d91a0de75060b",
    "files": [
        {
            "sha": "3eca6964d154dd7bd6a5a80b531040d46228b9e6",
            "filename": "tests/modeltests/model_formsets/models.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1037,
            "changes": 1037,
            "blob_url": "https://github.com/django/django/blob/9b45f6cd5444423693715cc2a04d91a0de75060b/tests%2Fmodeltests%2Fmodel_formsets%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/9b45f6cd5444423693715cc2a04d91a0de75060b/tests%2Fmodeltests%2Fmodel_formsets%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_formsets%2Fmodels.py?ref=9b45f6cd5444423693715cc2a04d91a0de75060b",
            "patch": "@@ -1,5 +1,4 @@\n import datetime\n-from django import forms\n from django.db import models\n \n class Author(models.Model):\n@@ -192,1039 +191,3 @@ class Post(models.Model):\n \n     def __unicode__(self):\n         return self.name\n-\n-__test__ = {'API_TESTS': \"\"\"\n-\n->>> from datetime import date\n-\n->>> from django.forms.models import modelformset_factory\n-\n->>> qs = Author.objects.all()\n->>> AuthorFormSet = modelformset_factory(Author, extra=3)\n-\n->>> formset = AuthorFormSet(queryset=qs)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-0-id\" id=\"id_form-0-id\" /></p>\n-<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-1-id\" id=\"id_form-1-id\" /></p>\n-<p><label for=\"id_form-2-name\">Name:</label> <input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-2-id\" id=\"id_form-2-id\" /></p>\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-name': 'Charles Baudelaire',\n-...     'form-1-name': 'Arthur Rimbaud',\n-...     'form-2-name': '',\n-... }\n-\n->>> formset = AuthorFormSet(data=data, queryset=qs)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<Author: Charles Baudelaire>, <Author: Arthur Rimbaud>]\n-\n->>> for author in Author.objects.order_by('name'):\n-...     print author.name\n-Arthur Rimbaud\n-Charles Baudelaire\n-\n-\n-Gah! We forgot Paul Verlaine. Let's create a formset to edit the existing\n-authors with an extra form to add him. We *could* pass in a queryset to\n-restrict the Author objects we edit, but in this case we'll use it to display\n-them in alphabetical order by name.\n-\n->>> qs = Author.objects.order_by('name')\n->>> AuthorFormSet = modelformset_factory(Author, extra=1, can_delete=False)\n-\n->>> formset = AuthorFormSet(queryset=qs)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" value=\"Arthur Rimbaud\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-0-id\" value=\"2\" id=\"id_form-0-id\" /></p>\n-<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" value=\"Charles Baudelaire\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-1-id\" value=\"1\" id=\"id_form-1-id\" /></p>\n-<p><label for=\"id_form-2-name\">Name:</label> <input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-2-id\" id=\"id_form-2-id\" /></p>\n-\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '2', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-id': '2',\n-...     'form-0-name': 'Arthur Rimbaud',\n-...     'form-1-id': '1',\n-...     'form-1-name': 'Charles Baudelaire',\n-...     'form-2-name': 'Paul Verlaine',\n-... }\n-\n->>> formset = AuthorFormSet(data=data, queryset=qs)\n->>> formset.is_valid()\n-True\n-\n-# Only changed or new objects are returned from formset.save()\n->>> formset.save()\n-[<Author: Paul Verlaine>]\n-\n->>> for author in Author.objects.order_by('name'):\n-...     print author.name\n-Arthur Rimbaud\n-Charles Baudelaire\n-Paul Verlaine\n-\n-\n-This probably shouldn't happen, but it will. If an add form was marked for\n-deltetion, make sure we don't save that form.\n-\n->>> qs = Author.objects.order_by('name')\n->>> AuthorFormSet = modelformset_factory(Author, extra=1, can_delete=True)\n-\n->>> formset = AuthorFormSet(queryset=qs)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" value=\"Arthur Rimbaud\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-0-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-0-DELETE\" id=\"id_form-0-DELETE\" /><input type=\"hidden\" name=\"form-0-id\" value=\"2\" id=\"id_form-0-id\" /></p>\n-<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" value=\"Charles Baudelaire\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-1-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-1-DELETE\" id=\"id_form-1-DELETE\" /><input type=\"hidden\" name=\"form-1-id\" value=\"1\" id=\"id_form-1-id\" /></p>\n-<p><label for=\"id_form-2-name\">Name:</label> <input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" value=\"Paul Verlaine\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-2-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-2-DELETE\" id=\"id_form-2-DELETE\" /><input type=\"hidden\" name=\"form-2-id\" value=\"3\" id=\"id_form-2-id\" /></p>\n-<p><label for=\"id_form-3-name\">Name:</label> <input id=\"id_form-3-name\" type=\"text\" name=\"form-3-name\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-3-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-3-DELETE\" id=\"id_form-3-DELETE\" /><input type=\"hidden\" name=\"form-3-id\" id=\"id_form-3-id\" /></p>\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '4', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '3', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-id': '2',\n-...     'form-0-name': 'Arthur Rimbaud',\n-...     'form-1-id': '1',\n-...     'form-1-name': 'Charles Baudelaire',\n-...     'form-2-id': '3',\n-...     'form-2-name': 'Paul Verlaine',\n-...     'form-3-name': 'Walt Whitman',\n-...     'form-3-DELETE': 'on',\n-... }\n-\n->>> formset = AuthorFormSet(data=data, queryset=qs)\n->>> formset.is_valid()\n-True\n-\n-# No objects were changed or saved so nothing will come back.\n->>> formset.save()\n-[]\n-\n->>> for author in Author.objects.order_by('name'):\n-...     print author.name\n-Arthur Rimbaud\n-Charles Baudelaire\n-Paul Verlaine\n-\n-Let's edit a record to ensure save only returns that one record.\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '4', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '3', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-id': '2',\n-...     'form-0-name': 'Walt Whitman',\n-...     'form-1-id': '1',\n-...     'form-1-name': 'Charles Baudelaire',\n-...     'form-2-id': '3',\n-...     'form-2-name': 'Paul Verlaine',\n-...     'form-3-name': '',\n-...     'form-3-DELETE': '',\n-... }\n-\n->>> formset = AuthorFormSet(data=data, queryset=qs)\n->>> formset.is_valid()\n-True\n-\n-# One record has changed.\n->>> formset.save()\n-[<Author: Walt Whitman>]\n-\n-Test the behavior of commit=False and save_m2m\n-\n->>> meeting = AuthorMeeting.objects.create(created=date.today())\n->>> meeting.authors = Author.objects.all()\n-\n-# create an Author instance to add to the meeting.\n->>> new_author = Author.objects.create(name=u'John Steinbeck')\n-\n->>> AuthorMeetingFormSet = modelformset_factory(AuthorMeeting, extra=1, can_delete=True)\n->>> data = {\n-...     'form-TOTAL_FORMS': '2', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '1', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-id': '1',\n-...     'form-0-name': '2nd Tuesday of the Week Meeting',\n-...     'form-0-authors': [2, 1, 3, 4],\n-...     'form-1-name': '',\n-...     'form-1-authors': '',\n-...     'form-1-DELETE': '',\n-... }\n->>> formset = AuthorMeetingFormSet(data=data, queryset=AuthorMeeting.objects.all())\n->>> formset.is_valid()\n-True\n->>> instances = formset.save(commit=False)\n->>> for instance in instances:\n-...     instance.created = date.today()\n-...     instance.save()\n->>> formset.save_m2m()\n->>> instances[0].authors.all()\n-[<Author: Charles Baudelaire>, <Author: John Steinbeck>, <Author: Paul Verlaine>, <Author: Walt Whitman>]\n-\n-# delete the author we created to allow later tests to continue working.\n->>> new_author.delete()\n-\n-Test the behavior of max_num with model formsets. It should allow all existing\n-related objects/inlines for a given object to be displayed, but not allow\n-the creation of new inlines beyond max_num.\n-\n->>> qs = Author.objects.order_by('name')\n-\n->>> AuthorFormSet = modelformset_factory(Author, max_num=None, extra=3)\n->>> formset = AuthorFormSet(queryset=qs)\n->>> len(formset.forms)\n-6\n->>> len(formset.extra_forms)\n-3\n-\n->>> AuthorFormSet = modelformset_factory(Author, max_num=4, extra=3)\n->>> formset = AuthorFormSet(queryset=qs)\n->>> len(formset.forms)\n-4\n->>> len(formset.extra_forms)\n-1\n-\n->>> AuthorFormSet = modelformset_factory(Author, max_num=0, extra=3)\n->>> formset = AuthorFormSet(queryset=qs)\n->>> len(formset.forms)\n-3\n->>> len(formset.extra_forms)\n-0\n-\n->>> AuthorFormSet = modelformset_factory(Author, max_num=None)\n->>> formset = AuthorFormSet(queryset=qs)\n->>> [x.name for x in formset.get_queryset()]\n-[u'Charles Baudelaire', u'Paul Verlaine', u'Walt Whitman']\n-\n->>> AuthorFormSet = modelformset_factory(Author, max_num=0)\n->>> formset = AuthorFormSet(queryset=qs)\n->>> [x.name for x in formset.get_queryset()]\n-[u'Charles Baudelaire', u'Paul Verlaine', u'Walt Whitman']\n-\n->>> AuthorFormSet = modelformset_factory(Author, max_num=4)\n->>> formset = AuthorFormSet(queryset=qs)\n->>> [x.name for x in formset.get_queryset()]\n-[u'Charles Baudelaire', u'Paul Verlaine', u'Walt Whitman']\n-\n-\n-# ModelForm with a custom save method in a formset ###########################\n-\n->>> class PoetForm(forms.ModelForm):\n-...     def save(self, commit=True):\n-...         # change the name to \"Vladimir Mayakovsky\" just to be a jerk.\n-...         author = super(PoetForm, self).save(commit=False)\n-...         author.name = u\"Vladimir Mayakovsky\"\n-...         if commit:\n-...             author.save()\n-...         return author\n-\n->>> PoetFormSet = modelformset_factory(Poet, form=PoetForm)\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-name': 'Walt Whitman',\n-...     'form-1-name': 'Charles Baudelaire',\n-...     'form-2-name': '',\n-... }\n-\n->>> qs = Poet.objects.all()\n->>> formset = PoetFormSet(data=data, queryset=qs)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<Poet: Vladimir Mayakovsky>, <Poet: Vladimir Mayakovsky>]\n-\n-\n-# Model inheritance in model formsets ########################################\n-\n->>> BetterAuthorFormSet = modelformset_factory(BetterAuthor)\n->>> formset = BetterAuthorFormSet()\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-0-write_speed\">Write speed:</label> <input type=\"text\" name=\"form-0-write_speed\" id=\"id_form-0-write_speed\" /><input type=\"hidden\" name=\"form-0-author_ptr\" id=\"id_form-0-author_ptr\" /></p>\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '1', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-author_ptr': '',\n-...     'form-0-name': 'Ernest Hemingway',\n-...     'form-0-write_speed': '10',\n-... }\n-\n->>> formset = BetterAuthorFormSet(data)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<BetterAuthor: Ernest Hemingway>]\n->>> hemingway_id = BetterAuthor.objects.get(name=\"Ernest Hemingway\").pk\n-\n->>> formset = BetterAuthorFormSet()\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" value=\"Ernest Hemingway\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-0-write_speed\">Write speed:</label> <input type=\"text\" name=\"form-0-write_speed\" value=\"10\" id=\"id_form-0-write_speed\" /><input type=\"hidden\" name=\"form-0-author_ptr\" value=\"...\" id=\"id_form-0-author_ptr\" /></p>\n-<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" maxlength=\"100\" /></p>\n-<p><label for=\"id_form-1-write_speed\">Write speed:</label> <input type=\"text\" name=\"form-1-write_speed\" id=\"id_form-1-write_speed\" /><input type=\"hidden\" name=\"form-1-author_ptr\" id=\"id_form-1-author_ptr\" /></p>\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '2', # the number of forms rendered\n-...     'form-INITIAL_FORMS': '1', # the number of forms with initial data\n-...     'form-MAX_NUM_FORMS': '', # the max number of forms\n-...     'form-0-author_ptr': hemingway_id,\n-...     'form-0-name': 'Ernest Hemingway',\n-...     'form-0-write_speed': '10',\n-...     'form-1-author_ptr': '',\n-...     'form-1-name': '',\n-...     'form-1-write_speed': '',\n-... }\n-\n->>> formset = BetterAuthorFormSet(data)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[]\n-\n-# Inline Formsets ############################################################\n-\n-We can also create a formset that is tied to a parent model. This is how the\n-admin system's edit inline functionality works.\n-\n->>> from django.forms.models import inlineformset_factory\n-\n->>> AuthorBooksFormSet = inlineformset_factory(Author, Book, can_delete=False, extra=3)\n->>> author = Author.objects.get(name='Charles Baudelaire')\n-\n->>> formset = AuthorBooksFormSet(instance=author)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"1\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" id=\"id_book_set-0-id\" /></p>\n-<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"1\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" id=\"id_book_set-1-id\" /></p>\n-<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"1\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" id=\"id_book_set-2-id\" /></p>\n-\n->>> data = {\n-...     'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'book_set-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'book_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'book_set-0-title': 'Les Fleurs du Mal',\n-...     'book_set-1-title': '',\n-...     'book_set-2-title': '',\n-... }\n-\n->>> formset = AuthorBooksFormSet(data, instance=author)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<Book: Les Fleurs du Mal>]\n-\n->>> for book in author.book_set.all():\n-...     print book.title\n-Les Fleurs du Mal\n-\n-\n-Now that we've added a book to Charles Baudelaire, let's try adding another\n-one. This time though, an edit form will be available for every existing\n-book.\n-\n->>> AuthorBooksFormSet = inlineformset_factory(Author, Book, can_delete=False, extra=2)\n->>> author = Author.objects.get(name='Charles Baudelaire')\n-\n->>> formset = AuthorBooksFormSet(instance=author)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" value=\"Les Fleurs du Mal\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"1\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" value=\"1\" id=\"id_book_set-0-id\" /></p>\n-<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"1\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" id=\"id_book_set-1-id\" /></p>\n-<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"1\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" id=\"id_book_set-2-id\" /></p>\n-\n->>> data = {\n-...     'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'book_set-INITIAL_FORMS': '1', # the number of forms with initial data\n-...     'book_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'book_set-0-id': '1',\n-...     'book_set-0-title': 'Les Fleurs du Mal',\n-...     'book_set-1-title': 'Les Paradis Artificiels',\n-...     'book_set-2-title': '',\n-... }\n-\n->>> formset = AuthorBooksFormSet(data, instance=author)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<Book: Les Paradis Artificiels>]\n-\n-As you can see, 'Les Paradis Artificiels' is now a book belonging to Charles Baudelaire.\n-\n->>> for book in author.book_set.order_by('id'):\n-...     print book.title\n-Les Fleurs du Mal\n-Les Paradis Artificiels\n-\n-The save_as_new parameter lets you re-associate the data to a new instance.\n-This is used in the admin for save_as functionality.\n-\n->>> data = {\n-...     'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'book_set-INITIAL_FORMS': '2', # the number of forms with initial data\n-...     'book_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'book_set-0-id': '1',\n-...     'book_set-0-title': 'Les Fleurs du Mal',\n-...     'book_set-1-id': '2',\n-...     'book_set-1-title': 'Les Paradis Artificiels',\n-...     'book_set-2-title': '',\n-... }\n-\n->>> formset = AuthorBooksFormSet(data, instance=Author(), save_as_new=True)\n->>> formset.is_valid()\n-True\n-\n->>> new_author = Author.objects.create(name='Charles Baudelaire')\n->>> formset = AuthorBooksFormSet(data, instance=new_author, save_as_new=True)\n->>> [book for book in formset.save() if book.author.pk == new_author.pk]\n-[<Book: Les Fleurs du Mal>, <Book: Les Paradis Artificiels>]\n-\n-Test using a custom prefix on an inline formset.\n-\n->>> formset = AuthorBooksFormSet(prefix=\"test\")\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_test-0-title\">Title:</label> <input id=\"id_test-0-title\" type=\"text\" name=\"test-0-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"test-0-author\" id=\"id_test-0-author\" /><input type=\"hidden\" name=\"test-0-id\" id=\"id_test-0-id\" /></p>\n-<p><label for=\"id_test-1-title\">Title:</label> <input id=\"id_test-1-title\" type=\"text\" name=\"test-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"test-1-author\" id=\"id_test-1-author\" /><input type=\"hidden\" name=\"test-1-id\" id=\"id_test-1-id\" /></p>\n-\n-Test inline formsets where the inline-edited object has a custom primary key that is not the fk to the parent object.\n-\n->>> AuthorBooksFormSet2 = inlineformset_factory(Author, BookWithCustomPK, can_delete=False, extra=1)\n-\n->>> formset = AuthorBooksFormSet2(instance=author)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_bookwithcustompk_set-0-my_pk\">My pk:</label> <input type=\"text\" name=\"bookwithcustompk_set-0-my_pk\" id=\"id_bookwithcustompk_set-0-my_pk\" /></p>\n-    <p><label for=\"id_bookwithcustompk_set-0-title\">Title:</label> <input id=\"id_bookwithcustompk_set-0-title\" type=\"text\" name=\"bookwithcustompk_set-0-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"bookwithcustompk_set-0-author\" value=\"1\" id=\"id_bookwithcustompk_set-0-author\" /></p>\n-\n->>> data = {\n-...     'bookwithcustompk_set-TOTAL_FORMS': '1', # the number of forms rendered\n-...     'bookwithcustompk_set-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'bookwithcustompk_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'bookwithcustompk_set-0-my_pk': '77777',\n-...     'bookwithcustompk_set-0-title': 'Les Fleurs du Mal',\n-... }\n-\n->>> formset = AuthorBooksFormSet2(data, instance=author)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<BookWithCustomPK: 77777: Les Fleurs du Mal>]\n-\n->>> for book in author.bookwithcustompk_set.all():\n-...     print book.title\n-Les Fleurs du Mal\n-\n-Test inline formsets where the inline-edited object uses multi-table inheritance, thus\n-has a non AutoField yet auto-created primary key.\n-\n->>> AuthorBooksFormSet3 = inlineformset_factory(Author, AlternateBook, can_delete=False, extra=1)\n-\n->>> formset = AuthorBooksFormSet3(instance=author)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_alternatebook_set-0-title\">Title:</label> <input id=\"id_alternatebook_set-0-title\" type=\"text\" name=\"alternatebook_set-0-title\" maxlength=\"100\" /></p>\n-    <p><label for=\"id_alternatebook_set-0-notes\">Notes:</label> <input id=\"id_alternatebook_set-0-notes\" type=\"text\" name=\"alternatebook_set-0-notes\" maxlength=\"100\" /><input type=\"hidden\" name=\"alternatebook_set-0-author\" value=\"1\" id=\"id_alternatebook_set-0-author\" /><input type=\"hidden\" name=\"alternatebook_set-0-book_ptr\" id=\"id_alternatebook_set-0-book_ptr\" /></p>\n-\n-\n->>> data = {\n-...     'alternatebook_set-TOTAL_FORMS': '1', # the number of forms rendered\n-...     'alternatebook_set-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'alternatebook_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'alternatebook_set-0-title': 'Flowers of Evil',\n-...     'alternatebook_set-0-notes': 'English translation of Les Fleurs du Mal'\n-... }\n-\n->>> formset = AuthorBooksFormSet3(data, instance=author)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<AlternateBook: Flowers of Evil - English translation of Les Fleurs du Mal>]\n-\n-Test inline formsets where the inline-edited object has a unique_together constraint with a nullable member\n-\n->>> AuthorBooksFormSet4 = inlineformset_factory(Author, BookWithOptionalAltEditor, can_delete=False, extra=2)\n-\n->>> data = {\n-...     'bookwithoptionalalteditor_set-TOTAL_FORMS': '2', # the number of forms rendered\n-...     'bookwithoptionalalteditor_set-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'bookwithoptionalalteditor_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'bookwithoptionalalteditor_set-0-author': '1',\n-...     'bookwithoptionalalteditor_set-0-title': 'Les Fleurs du Mal',\n-...     'bookwithoptionalalteditor_set-1-author': '1',\n-...     'bookwithoptionalalteditor_set-1-title': 'Les Fleurs du Mal',\n-... }\n->>> formset = AuthorBooksFormSet4(data, instance=author)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<BookWithOptionalAltEditor: Les Fleurs du Mal>, <BookWithOptionalAltEditor: Les Fleurs du Mal>]\n-\n-\n-# ModelForm with a custom save method in an inline formset ###################\n-\n->>> class PoemForm(forms.ModelForm):\n-...     def save(self, commit=True):\n-...         # change the name to \"Brooklyn Bridge\" just to be a jerk.\n-...         poem = super(PoemForm, self).save(commit=False)\n-...         poem.name = u\"Brooklyn Bridge\"\n-...         if commit:\n-...             poem.save()\n-...         return poem\n-\n->>> PoemFormSet = inlineformset_factory(Poet, Poem, form=PoemForm)\n-\n->>> data = {\n-...     'poem_set-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'poem_set-INITIAL_FORMS': '0', # the number of forms with initial data\n-...     'poem_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'poem_set-0-name': 'The Cloud in Trousers',\n-...     'poem_set-1-name': 'I',\n-...     'poem_set-2-name': '',\n-... }\n-\n->>> poet = Poet.objects.create(name='Vladimir Mayakovsky')\n->>> formset = PoemFormSet(data=data, instance=poet)\n->>> formset.is_valid()\n-True\n-\n->>> formset.save()\n-[<Poem: Brooklyn Bridge>, <Poem: Brooklyn Bridge>]\n-\n-We can provide a custom queryset to our InlineFormSet:\n-\n->>> custom_qs = Book.objects.order_by('-title')\n->>> formset = AuthorBooksFormSet(instance=author, queryset=custom_qs)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" value=\"Les Paradis Artificiels\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"1\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" value=\"2\" id=\"id_book_set-0-id\" /></p>\n-<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" value=\"Les Fleurs du Mal\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"1\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" value=\"1\" id=\"id_book_set-1-id\" /></p>\n-<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" value=\"Flowers of Evil\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"1\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" value=\"5\" id=\"id_book_set-2-id\" /></p>\n-<p><label for=\"id_book_set-3-title\">Title:</label> <input id=\"id_book_set-3-title\" type=\"text\" name=\"book_set-3-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-3-author\" value=\"1\" id=\"id_book_set-3-author\" /><input type=\"hidden\" name=\"book_set-3-id\" id=\"id_book_set-3-id\" /></p>\n-<p><label for=\"id_book_set-4-title\">Title:</label> <input id=\"id_book_set-4-title\" type=\"text\" name=\"book_set-4-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-4-author\" value=\"1\" id=\"id_book_set-4-author\" /><input type=\"hidden\" name=\"book_set-4-id\" id=\"id_book_set-4-id\" /></p>\n-\n->>> data = {\n-...     'book_set-TOTAL_FORMS': '5', # the number of forms rendered\n-...     'book_set-INITIAL_FORMS': '3', # the number of forms with initial data\n-...     'book_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'book_set-0-id': '1',\n-...     'book_set-0-title': 'Les Fleurs du Mal',\n-...     'book_set-1-id': '2',\n-...     'book_set-1-title': 'Les Paradis Artificiels',\n-...     'book_set-2-id': '5',\n-...     'book_set-2-title': 'Flowers of Evil',\n-...     'book_set-3-title': 'Revue des deux mondes',\n-...     'book_set-4-title': '',\n-... }\n->>> formset = AuthorBooksFormSet(data, instance=author, queryset=custom_qs)\n->>> formset.is_valid()\n-True\n-\n->>> custom_qs = Book.objects.filter(title__startswith='F')\n->>> formset = AuthorBooksFormSet(instance=author, queryset=custom_qs)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" value=\"Flowers of Evil\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"1\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" value=\"5\" id=\"id_book_set-0-id\" /></p>\n-<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"1\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" id=\"id_book_set-1-id\" /></p>\n-<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"1\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" id=\"id_book_set-2-id\" /></p>\n->>> data = {\n-...     'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n-...     'book_set-INITIAL_FORMS': '1', # the number of forms with initial data\n-...     'book_set-MAX_NUM_FORMS': '', # the max number of forms\n-...     'book_set-0-id': '5',\n-...     'book_set-0-title': 'Flowers of Evil',\n-...     'book_set-1-title': 'Revue des deux mondes',\n-...     'book_set-2-title': '',\n-... }\n->>> formset = AuthorBooksFormSet(data, instance=author, queryset=custom_qs)\n->>> formset.is_valid()\n-True\n-\n-\n-# Test a custom primary key ###################################################\n-\n-We need to ensure that it is displayed\n-\n->>> CustomPrimaryKeyFormSet = modelformset_factory(CustomPrimaryKey)\n->>> formset = CustomPrimaryKeyFormSet()\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-my_pk\">My pk:</label> <input id=\"id_form-0-my_pk\" type=\"text\" name=\"form-0-my_pk\" maxlength=\"10\" /></p>\n-<p><label for=\"id_form-0-some_field\">Some field:</label> <input id=\"id_form-0-some_field\" type=\"text\" name=\"form-0-some_field\" maxlength=\"100\" /></p>\n-\n-# Custom primary keys with ForeignKey, OneToOneField and AutoField ############\n-\n->>> place = Place(name=u'Giordanos', city=u'Chicago')\n->>> place.save()\n-\n->>> FormSet = inlineformset_factory(Place, Owner, extra=2, can_delete=False)\n->>> formset = FormSet(instance=place)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_owner_set-0-name\">Name:</label> <input id=\"id_owner_set-0-name\" type=\"text\" name=\"owner_set-0-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-0-place\" value=\"1\" id=\"id_owner_set-0-place\" /><input type=\"hidden\" name=\"owner_set-0-auto_id\" id=\"id_owner_set-0-auto_id\" /></p>\n-<p><label for=\"id_owner_set-1-name\">Name:</label> <input id=\"id_owner_set-1-name\" type=\"text\" name=\"owner_set-1-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-1-place\" value=\"1\" id=\"id_owner_set-1-place\" /><input type=\"hidden\" name=\"owner_set-1-auto_id\" id=\"id_owner_set-1-auto_id\" /></p>\n-\n->>> data = {\n-...     'owner_set-TOTAL_FORMS': '2',\n-...     'owner_set-INITIAL_FORMS': '0',\n-...     'owner_set-MAX_NUM_FORMS': '',\n-...     'owner_set-0-auto_id': '',\n-...     'owner_set-0-name': u'Joe Perry',\n-...     'owner_set-1-auto_id': '',\n-...     'owner_set-1-name': '',\n-... }\n->>> formset = FormSet(data, instance=place)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<Owner: Joe Perry at Giordanos>]\n-\n->>> formset = FormSet(instance=place)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_owner_set-0-name\">Name:</label> <input id=\"id_owner_set-0-name\" type=\"text\" name=\"owner_set-0-name\" value=\"Joe Perry\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-0-place\" value=\"1\" id=\"id_owner_set-0-place\" /><input type=\"hidden\" name=\"owner_set-0-auto_id\" value=\"1\" id=\"id_owner_set-0-auto_id\" /></p>\n-<p><label for=\"id_owner_set-1-name\">Name:</label> <input id=\"id_owner_set-1-name\" type=\"text\" name=\"owner_set-1-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-1-place\" value=\"1\" id=\"id_owner_set-1-place\" /><input type=\"hidden\" name=\"owner_set-1-auto_id\" id=\"id_owner_set-1-auto_id\" /></p>\n-<p><label for=\"id_owner_set-2-name\">Name:</label> <input id=\"id_owner_set-2-name\" type=\"text\" name=\"owner_set-2-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-2-place\" value=\"1\" id=\"id_owner_set-2-place\" /><input type=\"hidden\" name=\"owner_set-2-auto_id\" id=\"id_owner_set-2-auto_id\" /></p>\n-\n->>> data = {\n-...     'owner_set-TOTAL_FORMS': '3',\n-...     'owner_set-INITIAL_FORMS': '1',\n-...     'owner_set-MAX_NUM_FORMS': '',\n-...     'owner_set-0-auto_id': u'1',\n-...     'owner_set-0-name': u'Joe Perry',\n-...     'owner_set-1-auto_id': '',\n-...     'owner_set-1-name': u'Jack Berry',\n-...     'owner_set-2-auto_id': '',\n-...     'owner_set-2-name': '',\n-... }\n->>> formset = FormSet(data, instance=place)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<Owner: Jack Berry at Giordanos>]\n-\n-# Ensure a custom primary key that is a ForeignKey or OneToOneField get rendered for the user to choose.\n-\n->>> FormSet = modelformset_factory(OwnerProfile)\n->>> formset = FormSet()\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_form-0-owner\">Owner:</label> <select name=\"form-0-owner\" id=\"id_form-0-owner\">\n-<option value=\"\" selected=\"selected\">---------</option>\n-<option value=\"1\">Joe Perry at Giordanos</option>\n-<option value=\"2\">Jack Berry at Giordanos</option>\n-</select></p>\n-<p><label for=\"id_form-0-age\">Age:</label> <input type=\"text\" name=\"form-0-age\" id=\"id_form-0-age\" /></p>\n-\n->>> owner = Owner.objects.get(name=u'Joe Perry')\n->>> FormSet = inlineformset_factory(Owner, OwnerProfile, max_num=1, can_delete=False)\n->>> FormSet.max_num\n-1\n->>> formset = FormSet(instance=owner)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_ownerprofile-0-age\">Age:</label> <input type=\"text\" name=\"ownerprofile-0-age\" id=\"id_ownerprofile-0-age\" /><input type=\"hidden\" name=\"ownerprofile-0-owner\" value=\"1\" id=\"id_ownerprofile-0-owner\" /></p>\n-\n->>> data = {\n-...     'ownerprofile-TOTAL_FORMS': '1',\n-...     'ownerprofile-INITIAL_FORMS': '0',\n-...     'ownerprofile-MAX_NUM_FORMS': '1',\n-...     'ownerprofile-0-owner': '',\n-...     'ownerprofile-0-age': u'54',\n-... }\n->>> formset = FormSet(data, instance=owner)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<OwnerProfile: Joe Perry is 54>]\n->>> formset = FormSet(instance=owner)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_ownerprofile-0-age\">Age:</label> <input type=\"text\" name=\"ownerprofile-0-age\" value=\"54\" id=\"id_ownerprofile-0-age\" /><input type=\"hidden\" name=\"ownerprofile-0-owner\" value=\"1\" id=\"id_ownerprofile-0-owner\" /></p>\n-\n->>> data = {\n-...     'ownerprofile-TOTAL_FORMS': '1',\n-...     'ownerprofile-INITIAL_FORMS': '1',\n-...     'ownerprofile-MAX_NUM_FORMS': '1',\n-...     'ownerprofile-0-owner': u'1',\n-...     'ownerprofile-0-age': u'55',\n-... }\n->>> formset = FormSet(data, instance=owner)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<OwnerProfile: Joe Perry is 55>]\n-\n-# ForeignKey with unique=True should enforce max_num=1\n-\n->>> FormSet = inlineformset_factory(Place, Location, can_delete=False)\n->>> FormSet.max_num\n-1\n->>> formset = FormSet(instance=place)\n->>> for form in formset.forms:\n-...     print form.as_p()\n-<p><label for=\"id_location_set-0-lat\">Lat:</label> <input id=\"id_location_set-0-lat\" type=\"text\" name=\"location_set-0-lat\" maxlength=\"100\" /></p>\n-<p><label for=\"id_location_set-0-lon\">Lon:</label> <input id=\"id_location_set-0-lon\" type=\"text\" name=\"location_set-0-lon\" maxlength=\"100\" /><input type=\"hidden\" name=\"location_set-0-place\" value=\"1\" id=\"id_location_set-0-place\" /><input type=\"hidden\" name=\"location_set-0-id\" id=\"id_location_set-0-id\" /></p>\n-\n-# Foreign keys in parents ########################################\n-\n->>> from django.forms.models import _get_foreign_key\n-\n->>> type(_get_foreign_key(Restaurant, Owner))\n-<class 'django.db.models.fields.related.ForeignKey'>\n->>> type(_get_foreign_key(MexicanRestaurant, Owner))\n-<class 'django.db.models.fields.related.ForeignKey'>\n-\n-# unique/unique_together validation ###########################################\n-\n->>> FormSet = modelformset_factory(Product, extra=1)\n->>> data = {\n-...     'form-TOTAL_FORMS': '1',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-slug': 'car-red',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<Product: car-red>]\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '1',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-slug': 'car-red',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset.errors\n-[{'slug': [u'Product with this Slug already exists.']}]\n-\n-# unique_together\n-\n->>> FormSet = modelformset_factory(Price, extra=1)\n->>> data = {\n-...     'form-TOTAL_FORMS': '1',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-price': u'12.00',\n-...     'form-0-quantity': '1',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<Price: 1 for 12.00>]\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '1',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-price': u'12.00',\n-...     'form-0-quantity': '1',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset.errors\n-[{'__all__': [u'Price with this Price and Quantity already exists.']}]\n-\n-# unique_together with inlineformset_factory\n-# Also see bug #8882.\n-\n->>> repository = Repository.objects.create(name=u'Test Repo')\n->>> FormSet = inlineformset_factory(Repository, Revision, extra=1)\n->>> data = {\n-...     'revision_set-TOTAL_FORMS': '1',\n-...     'revision_set-INITIAL_FORMS': '0',\n-...     'revision_set-MAX_NUM_FORMS': '',\n-...     'revision_set-0-repository': repository.pk,\n-...     'revision_set-0-revision': '146239817507f148d448db38840db7c3cbf47c76',\n-...     'revision_set-0-DELETE': '',\n-... }\n->>> formset = FormSet(data, instance=repository)\n->>> formset.is_valid()\n-True\n->>> formset.save()\n-[<Revision: 146239817507f148d448db38840db7c3cbf47c76 (Test Repo)>]\n-\n-# attempt to save the same revision against against the same repo.\n->>> data = {\n-...     'revision_set-TOTAL_FORMS': '1',\n-...     'revision_set-INITIAL_FORMS': '0',\n-...     'revision_set-MAX_NUM_FORMS': '',\n-...     'revision_set-0-repository': repository.pk,\n-...     'revision_set-0-revision': '146239817507f148d448db38840db7c3cbf47c76',\n-...     'revision_set-0-DELETE': '',\n-... }\n->>> formset = FormSet(data, instance=repository)\n->>> formset.is_valid()\n-False\n->>> formset.errors\n-[{'__all__': [u'Revision with this Repository and Revision already exists.']}]\n-\n-# unique_together with inlineformset_factory with overridden form fields\n-# Also see #9494\n-\n->>> FormSet = inlineformset_factory(Repository, Revision, fields=('revision',), extra=1)\n->>> data = {\n-...     'revision_set-TOTAL_FORMS': '1',\n-...     'revision_set-INITIAL_FORMS': '0',\n-...     'revision_set-MAX_NUM_FORMS': '',\n-...     'revision_set-0-repository': repository.pk,\n-...     'revision_set-0-revision': '146239817507f148d448db38840db7c3cbf47c76',\n-...     'revision_set-0-DELETE': '',\n-... }\n->>> formset = FormSet(data, instance=repository)\n->>> formset.is_valid()\n-False\n-\n-# Use of callable defaults (see bug #7975).\n-\n->>> person = Person.objects.create(name='Ringo')\n->>> FormSet = inlineformset_factory(Person, Membership, can_delete=False, extra=1)\n->>> formset = FormSet(instance=person)\n-\n-# Django will render a hidden field for model fields that have a callable\n-# default. This is required to ensure the value is tested for change correctly\n-# when determine what extra forms have changed to save.\n-\n->>> form = formset.forms[0] # this formset only has one form\n->>> now = form.fields['date_joined'].initial()\n->>> print form.as_p()\n-<p><label for=\"id_membership_set-0-date_joined\">Date joined:</label> <input type=\"text\" name=\"membership_set-0-date_joined\" value=\"...\" id=\"id_membership_set-0-date_joined\" /><input type=\"hidden\" name=\"initial-membership_set-0-date_joined\" value=\"...\" id=\"initial-membership_set-0-id_membership_set-0-date_joined\" /></p>\n-<p><label for=\"id_membership_set-0-karma\">Karma:</label> <input type=\"text\" name=\"membership_set-0-karma\" id=\"id_membership_set-0-karma\" /><input type=\"hidden\" name=\"membership_set-0-person\" value=\"1\" id=\"id_membership_set-0-person\" /><input type=\"hidden\" name=\"membership_set-0-id\" id=\"id_membership_set-0-id\" /></p>\n-\n-# test for validation with callable defaults. Validations rely on hidden fields\n-\n->>> data = {\n-...     'membership_set-TOTAL_FORMS': '1',\n-...     'membership_set-INITIAL_FORMS': '0',\n-...     'membership_set-MAX_NUM_FORMS': '',\n-...     'membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n-...     'initial-membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n-...     'membership_set-0-karma': '',\n-... }\n->>> formset = FormSet(data, instance=person)\n->>> formset.is_valid()\n-True\n-\n-# now test for when the data changes\n-\n->>> one_day_later = now + datetime.timedelta(days=1)\n->>> filled_data = {\n-...     'membership_set-TOTAL_FORMS': '1',\n-...     'membership_set-INITIAL_FORMS': '0',\n-...     'membership_set-MAX_NUM_FORMS': '',\n-...     'membership_set-0-date_joined': unicode(one_day_later.strftime('%Y-%m-%d %H:%M:%S')),\n-...     'initial-membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n-...     'membership_set-0-karma': '',\n-... }\n->>> formset = FormSet(filled_data, instance=person)\n->>> formset.is_valid()\n-False\n-\n-# now test with split datetime fields\n-\n->>> class MembershipForm(forms.ModelForm):\n-...     date_joined = forms.SplitDateTimeField(initial=now)\n-...     class Meta:\n-...         model = Membership\n-...     def __init__(self, **kwargs):\n-...         super(MembershipForm, self).__init__(**kwargs)\n-...         self.fields['date_joined'].widget = forms.SplitDateTimeWidget()\n-\n->>> FormSet = inlineformset_factory(Person, Membership, form=MembershipForm, can_delete=False, extra=1)\n->>> data = {\n-...     'membership_set-TOTAL_FORMS': '1',\n-...     'membership_set-INITIAL_FORMS': '0',\n-...     'membership_set-MAX_NUM_FORMS': '',\n-...     'membership_set-0-date_joined_0': unicode(now.strftime('%Y-%m-%d')),\n-...     'membership_set-0-date_joined_1': unicode(now.strftime('%H:%M:%S')),\n-...     'initial-membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n-...     'membership_set-0-karma': '',\n-... }\n->>> formset = FormSet(data, instance=person)\n->>> formset.is_valid()\n-True\n-\n-# inlineformset_factory tests with fk having null=True. see #9462.\n-# create some data that will exbit the issue\n->>> team = Team.objects.create(name=u\"Red Vipers\")\n->>> Player(name=\"Timmy\").save()\n->>> Player(name=\"Bobby\", team=team).save()\n-\n->>> PlayerInlineFormSet = inlineformset_factory(Team, Player)\n->>> formset = PlayerInlineFormSet()\n->>> formset.get_queryset()\n-[]\n-\n->>> formset = PlayerInlineFormSet(instance=team)\n->>> formset.get_queryset()\n-[<Player: Bobby>]\n-\n-# a formset for a Model that has a custom primary key that still needs to be\n-# added to the formset automatically\n->>> FormSet = modelformset_factory(ClassyMexicanRestaurant, fields=[\"tacos_are_yummy\"])\n->>> sorted(FormSet().forms[0].fields.keys())\n-['restaurant', 'tacos_are_yummy']\n-\n-# Prevent duplicates from within the same formset\n->>> FormSet = modelformset_factory(Product, extra=2)\n->>> data = {\n-...     'form-TOTAL_FORMS': 2,\n-...     'form-INITIAL_FORMS': 0,\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-slug': 'red_car',\n-...     'form-1-slug': 'red_car',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset._non_form_errors\n-[u'Please correct the duplicate data for slug.']\n-\n->>> FormSet = modelformset_factory(Price, extra=2)\n->>> data = {\n-...     'form-TOTAL_FORMS': 2,\n-...     'form-INITIAL_FORMS': 0,\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-price': '25',\n-...     'form-0-quantity': '7',\n-...     'form-1-price': '25',\n-...     'form-1-quantity': '7',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset._non_form_errors\n-[u'Please correct the duplicate data for price and quantity, which must be unique.']\n-\n-# Only the price field is specified, this should skip any unique checks since\n-# the unique_together is not fulfilled. This will fail with a KeyError if broken.\n->>> FormSet = modelformset_factory(Price, fields=(\"price\",), extra=2)\n->>> data = {\n-...     'form-TOTAL_FORMS': '2',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...     'form-0-price': '24',\n-...     'form-1-price': '24',\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-True\n-\n->>> FormSet = inlineformset_factory(Author, Book, extra=0)\n->>> author = Author.objects.order_by('id')[0]\n->>> book_ids = author.book_set.values_list('id', flat=True)\n->>> data = {\n-...     'book_set-TOTAL_FORMS': '2',\n-...     'book_set-INITIAL_FORMS': '2',\n-...     'book_set-MAX_NUM_FORMS': '',\n-...\n-...     'book_set-0-title': 'The 2008 Election',\n-...     'book_set-0-author': str(author.id),\n-...     'book_set-0-id': str(book_ids[0]),\n-...\n-...     'book_set-1-title': 'The 2008 Election',\n-...     'book_set-1-author': str(author.id),\n-...     'book_set-1-id': str(book_ids[1]),\n-... }\n->>> formset = FormSet(data=data, instance=author)\n->>> formset.is_valid()\n-False\n->>> formset._non_form_errors\n-[u'Please correct the duplicate data for title.']\n->>> formset.errors\n-[{}, {'__all__': u'Please correct the duplicate values below.'}]\n-\n->>> FormSet = modelformset_factory(Post, extra=2)\n->>> data = {\n-...     'form-TOTAL_FORMS': '2',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...\n-...     'form-0-title': 'blah',\n-...     'form-0-slug': 'Morning',\n-...     'form-0-subtitle': 'foo',\n-...     'form-0-posted': '2009-01-01',\n-...     'form-1-title': 'blah',\n-...     'form-1-slug': 'Morning in Prague',\n-...     'form-1-subtitle': 'rawr',\n-...     'form-1-posted': '2009-01-01'\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset._non_form_errors\n-[u'Please correct the duplicate data for title which must be unique for the date in posted.']\n->>> formset.errors\n-[{}, {'__all__': u'Please correct the duplicate values below.'}]\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '2',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...\n-...     'form-0-title': 'foo',\n-...     'form-0-slug': 'Morning in Prague',\n-...     'form-0-subtitle': 'foo',\n-...     'form-0-posted': '2009-01-01',\n-...     'form-1-title': 'blah',\n-...     'form-1-slug': 'Morning in Prague',\n-...     'form-1-subtitle': 'rawr',\n-...     'form-1-posted': '2009-08-02'\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset._non_form_errors\n-[u'Please correct the duplicate data for slug which must be unique for the year in posted.']\n-\n->>> data = {\n-...     'form-TOTAL_FORMS': '2',\n-...     'form-INITIAL_FORMS': '0',\n-...     'form-MAX_NUM_FORMS': '',\n-...\n-...     'form-0-title': 'foo',\n-...     'form-0-slug': 'Morning in Prague',\n-...     'form-0-subtitle': 'rawr',\n-...     'form-0-posted': '2008-08-01',\n-...     'form-1-title': 'blah',\n-...     'form-1-slug': 'Prague',\n-...     'form-1-subtitle': 'rawr',\n-...     'form-1-posted': '2009-08-02'\n-... }\n->>> formset = FormSet(data)\n->>> formset.is_valid()\n-False\n->>> formset._non_form_errors\n-[u'Please correct the duplicate data for subtitle which must be unique for the month in posted.']\n-\"\"\"}"
        },
        {
            "sha": "396f1bd58233928a2c2a8b96b241afbc56dabae3",
            "filename": "tests/modeltests/model_formsets/tests.py",
            "status": "modified",
            "additions": 1088,
            "deletions": 2,
            "changes": 1090,
            "blob_url": "https://github.com/django/django/blob/9b45f6cd5444423693715cc2a04d91a0de75060b/tests%2Fmodeltests%2Fmodel_formsets%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9b45f6cd5444423693715cc2a04d91a0de75060b/tests%2Fmodeltests%2Fmodel_formsets%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fmodel_formsets%2Ftests.py?ref=9b45f6cd5444423693715cc2a04d91a0de75060b",
            "patch": "@@ -1,6 +1,20 @@\n-from django.test import TestCase\n+import datetime\n+import re\n+from datetime import date\n+from decimal import Decimal\n+from django import forms\n+from django.db import models\n+from django.forms.models import _get_foreign_key\n+from django.forms.models import inlineformset_factory\n+from django.forms.models import modelformset_factory\n from django.forms.models import modelformset_factory\n-from modeltests.model_formsets.models import Poet, Poem\n+from django.test import TestCase\n+from modeltests.model_formsets.models import (\n+    Author, BetterAuthor, Book, BookWithCustomPK, Editor,\n+    BookWithOptionalAltEditor, AlternateBook, AuthorMeeting, CustomPrimaryKey,\n+    Place, Owner, Location, OwnerProfile, Restaurant, Product, Price,\n+    MexicanRestaurant, ClassyMexicanRestaurant, Repository, Revision,\n+    Person, Membership, Team, Player, Poet, Poem, Post)\n \n class DeletionTests(TestCase):\n     def test_deletion(self):\n@@ -71,3 +85,1075 @@ def test_change_form_deletion_when_invalid(self):\n         self.assertEqual(formset.is_valid(), True)\n         formset.save()\n         self.assertEqual(Poet.objects.count(), 0)\n+\n+class ModelFormsetTest(TestCase):\n+    def test_simple_save(self):\n+        qs = Author.objects.all()\n+        AuthorFormSet = modelformset_factory(Author, extra=3)\n+\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertEqual(len(formset.forms), 3)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-0-id\" id=\"id_form-0-id\" /></p>')\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-1-id\" id=\"id_form-1-id\" /></p>')\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_form-2-name\">Name:</label> <input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-2-id\" id=\"id_form-2-id\" /></p>')\n+\n+        data = {\n+            'form-TOTAL_FORMS': '3', # the number of forms rendered\n+            'form-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-name': 'Charles Baudelaire',\n+            'form-1-name': 'Arthur Rimbaud',\n+            'form-2-name': '',\n+        }\n+\n+        formset = AuthorFormSet(data=data, queryset=qs)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 2)\n+        author1, author2 = saved\n+        self.assertEqual(author1, Author.objects.get(name='Charles Baudelaire'))\n+        self.assertEqual(author2, Author.objects.get(name='Arthur Rimbaud'))\n+\n+        authors = list(Author.objects.order_by('name'))\n+        self.assertEqual(authors, [author2, author1])\n+\n+        # Gah! We forgot Paul Verlaine. Let's create a formset to edit the\n+        # existing authors with an extra form to add him. We *could* pass in a\n+        # queryset to restrict the Author objects we edit, but in this case\n+        # we'll use it to display them in alphabetical order by name.\n+\n+        qs = Author.objects.order_by('name')\n+        AuthorFormSet = modelformset_factory(Author, extra=1, can_delete=False)\n+\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertEqual(len(formset.forms), 3)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" value=\"Arthur Rimbaud\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-0-id\" value=\"%d\" id=\"id_form-0-id\" /></p>' % author2.id)\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" value=\"Charles Baudelaire\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-1-id\" value=\"%d\" id=\"id_form-1-id\" /></p>' % author1.id)\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_form-2-name\">Name:</label> <input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"form-2-id\" id=\"id_form-2-id\" /></p>')\n+\n+        data = {\n+            'form-TOTAL_FORMS': '3', # the number of forms rendered\n+            'form-INITIAL_FORMS': '2', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-id': str(author2.id),\n+            'form-0-name': 'Arthur Rimbaud',\n+            'form-1-id': str(author1.id),\n+            'form-1-name': 'Charles Baudelaire',\n+            'form-2-name': 'Paul Verlaine',\n+        }\n+\n+        formset = AuthorFormSet(data=data, queryset=qs)\n+        self.assertTrue(formset.is_valid())\n+\n+        # Only changed or new objects are returned from formset.save()\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        author3 = saved[0]\n+        self.assertEqual(author3, Author.objects.get(name='Paul Verlaine'))\n+\n+        authors = list(Author.objects.order_by('name'))\n+        self.assertEqual(authors, [author2, author1, author3])\n+\n+        # This probably shouldn't happen, but it will. If an add form was\n+        # marked for deletion, make sure we don't save that form.\n+\n+        qs = Author.objects.order_by('name')\n+        AuthorFormSet = modelformset_factory(Author, extra=1, can_delete=True)\n+\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertEqual(len(formset.forms), 4)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" value=\"Arthur Rimbaud\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-0-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-0-DELETE\" id=\"id_form-0-DELETE\" /><input type=\"hidden\" name=\"form-0-id\" value=\"%d\" id=\"id_form-0-id\" /></p>' % author2.id)\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" value=\"Charles Baudelaire\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-1-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-1-DELETE\" id=\"id_form-1-DELETE\" /><input type=\"hidden\" name=\"form-1-id\" value=\"%d\" id=\"id_form-1-id\" /></p>' % author1.id)\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_form-2-name\">Name:</label> <input id=\"id_form-2-name\" type=\"text\" name=\"form-2-name\" value=\"Paul Verlaine\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-2-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-2-DELETE\" id=\"id_form-2-DELETE\" /><input type=\"hidden\" name=\"form-2-id\" value=\"%d\" id=\"id_form-2-id\" /></p>' % author3.id)\n+        self.assertEqual(formset.forms[3].as_p(),\n+            '<p><label for=\"id_form-3-name\">Name:</label> <input id=\"id_form-3-name\" type=\"text\" name=\"form-3-name\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-3-DELETE\">Delete:</label> <input type=\"checkbox\" name=\"form-3-DELETE\" id=\"id_form-3-DELETE\" /><input type=\"hidden\" name=\"form-3-id\" id=\"id_form-3-id\" /></p>')\n+\n+        data = {\n+            'form-TOTAL_FORMS': '4', # the number of forms rendered\n+            'form-INITIAL_FORMS': '3', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-id': str(author2.id),\n+            'form-0-name': 'Arthur Rimbaud',\n+            'form-1-id': str(author1.id),\n+            'form-1-name': 'Charles Baudelaire',\n+            'form-2-id': str(author3.id),\n+            'form-2-name': 'Paul Verlaine',\n+            'form-3-name': 'Walt Whitman',\n+            'form-3-DELETE': 'on',\n+        }\n+\n+        formset = AuthorFormSet(data=data, queryset=qs)\n+        self.assertTrue(formset.is_valid())\n+\n+        # No objects were changed or saved so nothing will come back.\n+\n+        self.assertEqual(formset.save(), [])\n+\n+        authors = list(Author.objects.order_by('name'))\n+        self.assertEqual(authors, [author2, author1, author3])\n+\n+        # Let's edit a record to ensure save only returns that one record.\n+\n+        data = {\n+            'form-TOTAL_FORMS': '4', # the number of forms rendered\n+            'form-INITIAL_FORMS': '3', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-id': str(author2.id),\n+            'form-0-name': 'Walt Whitman',\n+            'form-1-id': str(author1.id),\n+            'form-1-name': 'Charles Baudelaire',\n+            'form-2-id': str(author3.id),\n+            'form-2-name': 'Paul Verlaine',\n+            'form-3-name': '',\n+            'form-3-DELETE': '',\n+        }\n+\n+        formset = AuthorFormSet(data=data, queryset=qs)\n+        self.assertTrue(formset.is_valid())\n+\n+        # One record has changed.\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        self.assertEqual(saved[0], Author.objects.get(name='Walt Whitman'))\n+\n+    def test_commit_false(self):\n+        # Test the behavior of commit=False and save_m2m\n+\n+        author1 = Author.objects.create(name='Charles Baudelaire')\n+        author2 = Author.objects.create(name='Paul Verlaine')\n+        author3 = Author.objects.create(name='Walt Whitman')\n+\n+        meeting = AuthorMeeting.objects.create(created=date.today())\n+        meeting.authors = Author.objects.all()\n+\n+        # create an Author instance to add to the meeting.\n+\n+        author4 = Author.objects.create(name=u'John Steinbeck')\n+\n+        AuthorMeetingFormSet = modelformset_factory(AuthorMeeting, extra=1, can_delete=True)\n+        data = {\n+            'form-TOTAL_FORMS': '2', # the number of forms rendered\n+            'form-INITIAL_FORMS': '1', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-id': '1',\n+            'form-0-name': '2nd Tuesday of the Week Meeting',\n+            'form-0-authors': [2, 1, 3, 4],\n+            'form-1-name': '',\n+            'form-1-authors': '',\n+            'form-1-DELETE': '',\n+        }\n+        formset = AuthorMeetingFormSet(data=data, queryset=AuthorMeeting.objects.all())\n+        self.assertTrue(formset.is_valid())\n+\n+        instances = formset.save(commit=False)\n+        for instance in instances:\n+            instance.created = date.today()\n+            instance.save()\n+        formset.save_m2m()\n+        self.assertQuerysetEqual(instances[0].authors.all(), [\n+            '<Author: Charles Baudelaire>',\n+            '<Author: John Steinbeck>',\n+            '<Author: Paul Verlaine>',\n+            '<Author: Walt Whitman>',\n+        ])\n+\n+    def test_max_num(self):\n+        # Test the behavior of max_num with model formsets. It should allow\n+        # all existing related objects/inlines for a given object to be\n+        # displayed, but not allow the creation of new inlines beyond max_num.\n+\n+        author1 = Author.objects.create(name='Charles Baudelaire')\n+        author2 = Author.objects.create(name='Paul Verlaine')\n+        author3 = Author.objects.create(name='Walt Whitman')\n+\n+        qs = Author.objects.order_by('name')\n+\n+        AuthorFormSet = modelformset_factory(Author, max_num=None, extra=3)\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertEqual(len(formset.forms), 6)\n+        self.assertEqual(len(formset.extra_forms), 3)\n+\n+        AuthorFormSet = modelformset_factory(Author, max_num=4, extra=3)\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertEqual(len(formset.forms), 4)\n+        self.assertEqual(len(formset.extra_forms), 1)\n+\n+        AuthorFormSet = modelformset_factory(Author, max_num=0, extra=3)\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertEqual(len(formset.forms), 3)\n+        self.assertEqual(len(formset.extra_forms), 0)\n+\n+        AuthorFormSet = modelformset_factory(Author, max_num=None)\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertQuerysetEqual(formset.get_queryset(), [\n+            '<Author: Charles Baudelaire>',\n+            '<Author: Paul Verlaine>',\n+            '<Author: Walt Whitman>',\n+        ])\n+\n+        AuthorFormSet = modelformset_factory(Author, max_num=0)\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertQuerysetEqual(formset.get_queryset(), [\n+            '<Author: Charles Baudelaire>',\n+            '<Author: Paul Verlaine>',\n+            '<Author: Walt Whitman>',\n+        ])\n+\n+        AuthorFormSet = modelformset_factory(Author, max_num=4)\n+        formset = AuthorFormSet(queryset=qs)\n+        self.assertQuerysetEqual(formset.get_queryset(), [\n+            '<Author: Charles Baudelaire>',\n+            '<Author: Paul Verlaine>',\n+            '<Author: Walt Whitman>',\n+        ])\n+\n+    def test_custom_save_method(self):\n+        class PoetForm(forms.ModelForm):\n+            def save(self, commit=True):\n+                # change the name to \"Vladimir Mayakovsky\" just to be a jerk.\n+                author = super(PoetForm, self).save(commit=False)\n+                author.name = u\"Vladimir Mayakovsky\"\n+                if commit:\n+                    author.save()\n+                return author\n+\n+        PoetFormSet = modelformset_factory(Poet, form=PoetForm)\n+\n+        data = {\n+            'form-TOTAL_FORMS': '3', # the number of forms rendered\n+            'form-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-name': 'Walt Whitman',\n+            'form-1-name': 'Charles Baudelaire',\n+            'form-2-name': '',\n+        }\n+\n+        qs = Poet.objects.all()\n+        formset = PoetFormSet(data=data, queryset=qs)\n+        self.assertTrue(formset.is_valid())\n+\n+        poets = formset.save()\n+        self.assertEqual(len(poets), 2)\n+        poet1, poet2 = poets\n+        self.assertEqual(poet1.name, 'Vladimir Mayakovsky')\n+        self.assertEqual(poet2.name, 'Vladimir Mayakovsky')\n+\n+    def test_model_inheritance(self):\n+        BetterAuthorFormSet = modelformset_factory(BetterAuthor)\n+        formset = BetterAuthorFormSet()\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-0-write_speed\">Write speed:</label> <input type=\"text\" name=\"form-0-write_speed\" id=\"id_form-0-write_speed\" /><input type=\"hidden\" name=\"form-0-author_ptr\" id=\"id_form-0-author_ptr\" /></p>')\n+\n+        data = {\n+            'form-TOTAL_FORMS': '1', # the number of forms rendered\n+            'form-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-author_ptr': '',\n+            'form-0-name': 'Ernest Hemingway',\n+            'form-0-write_speed': '10',\n+        }\n+\n+        formset = BetterAuthorFormSet(data)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        author1, = saved\n+        self.assertEqual(author1, BetterAuthor.objects.get(name='Ernest Hemingway'))\n+        hemingway_id = BetterAuthor.objects.get(name=\"Ernest Hemingway\").pk\n+\n+        formset = BetterAuthorFormSet()\n+        self.assertEqual(len(formset.forms), 2)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-name\">Name:</label> <input id=\"id_form-0-name\" type=\"text\" name=\"form-0-name\" value=\"Ernest Hemingway\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-0-write_speed\">Write speed:</label> <input type=\"text\" name=\"form-0-write_speed\" value=\"10\" id=\"id_form-0-write_speed\" /><input type=\"hidden\" name=\"form-0-author_ptr\" value=\"%d\" id=\"id_form-0-author_ptr\" /></p>' % hemingway_id)\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_form-1-name\">Name:</label> <input id=\"id_form-1-name\" type=\"text\" name=\"form-1-name\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_form-1-write_speed\">Write speed:</label> <input type=\"text\" name=\"form-1-write_speed\" id=\"id_form-1-write_speed\" /><input type=\"hidden\" name=\"form-1-author_ptr\" id=\"id_form-1-author_ptr\" /></p>')\n+\n+        data = {\n+            'form-TOTAL_FORMS': '2', # the number of forms rendered\n+            'form-INITIAL_FORMS': '1', # the number of forms with initial data\n+            'form-MAX_NUM_FORMS': '', # the max number of forms\n+            'form-0-author_ptr': hemingway_id,\n+            'form-0-name': 'Ernest Hemingway',\n+            'form-0-write_speed': '10',\n+            'form-1-author_ptr': '',\n+            'form-1-name': '',\n+            'form-1-write_speed': '',\n+        }\n+\n+        formset = BetterAuthorFormSet(data)\n+        self.assertTrue(formset.is_valid())\n+        self.assertEqual(formset.save(), [])\n+\n+    def test_inline_formsets(self):\n+        # We can also create a formset that is tied to a parent model. This is\n+        # how the admin system's edit inline functionality works.\n+\n+        AuthorBooksFormSet = inlineformset_factory(Author, Book, can_delete=False, extra=3)\n+        author = Author.objects.create(name='Charles Baudelaire')\n+\n+        formset = AuthorBooksFormSet(instance=author)\n+        self.assertEqual(len(formset.forms), 3)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"%d\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" id=\"id_book_set-0-id\" /></p>'  % author.id)\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"%d\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" id=\"id_book_set-1-id\" /></p>' % author.id)\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"%d\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" id=\"id_book_set-2-id\" /></p>' % author.id)\n+\n+        data = {\n+            'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n+            'book_set-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'book_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'book_set-0-title': 'Les Fleurs du Mal',\n+            'book_set-1-title': '',\n+            'book_set-2-title': '',\n+        }\n+\n+        formset = AuthorBooksFormSet(data, instance=author)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        book1, = saved\n+        self.assertEqual(book1, Book.objects.get(title='Les Fleurs du Mal'))\n+        self.assertQuerysetEqual(author.book_set.all(), ['<Book: Les Fleurs du Mal>'])\n+\n+        # Now that we've added a book to Charles Baudelaire, let's try adding\n+        # another one. This time though, an edit form will be available for\n+        # every existing book.\n+\n+        AuthorBooksFormSet = inlineformset_factory(Author, Book, can_delete=False, extra=2)\n+        author = Author.objects.get(name='Charles Baudelaire')\n+\n+        formset = AuthorBooksFormSet(instance=author)\n+        self.assertEqual(len(formset.forms), 3)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" value=\"Les Fleurs du Mal\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"%d\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" value=\"%d\" id=\"id_book_set-0-id\" /></p>' % (author.id, book1.id))\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"%d\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" id=\"id_book_set-1-id\" /></p>' % author.id)\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"%d\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" id=\"id_book_set-2-id\" /></p>' % author.id)\n+\n+        data = {\n+            'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n+            'book_set-INITIAL_FORMS': '1', # the number of forms with initial data\n+            'book_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'book_set-0-id': '1',\n+            'book_set-0-title': 'Les Fleurs du Mal',\n+            'book_set-1-title': 'Les Paradis Artificiels',\n+            'book_set-2-title': '',\n+        }\n+\n+        formset = AuthorBooksFormSet(data, instance=author)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        book2, = saved\n+        self.assertEqual(book2, Book.objects.get(title='Les Paradis Artificiels'))\n+\n+        # As you can see, 'Les Paradis Artificiels' is now a book belonging to\n+        # Charles Baudelaire.\n+        self.assertQuerysetEqual(author.book_set.order_by('title'), [\n+            '<Book: Les Fleurs du Mal>',\n+            '<Book: Les Paradis Artificiels>',\n+        ])\n+\n+    def test_inline_formsets_save_as_new(self):\n+        # The save_as_new parameter lets you re-associate the data to a new\n+        # instance.  This is used in the admin for save_as functionality.\n+        AuthorBooksFormSet = inlineformset_factory(Author, Book, can_delete=False, extra=2)\n+        author = Author.objects.create(name='Charles Baudelaire')\n+\n+        data = {\n+            'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n+            'book_set-INITIAL_FORMS': '2', # the number of forms with initial data\n+            'book_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'book_set-0-id': '1',\n+            'book_set-0-title': 'Les Fleurs du Mal',\n+            'book_set-1-id': '2',\n+            'book_set-1-title': 'Les Paradis Artificiels',\n+            'book_set-2-title': '',\n+        }\n+\n+        formset = AuthorBooksFormSet(data, instance=Author(), save_as_new=True)\n+        self.assertTrue(formset.is_valid())\n+\n+        new_author = Author.objects.create(name='Charles Baudelaire')\n+        formset = AuthorBooksFormSet(data, instance=new_author, save_as_new=True)\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 2)\n+        book1, book2 = saved\n+        self.assertEqual(book1.title, 'Les Fleurs du Mal')\n+        self.assertEqual(book2.title, 'Les Paradis Artificiels')\n+\n+        # Test using a custom prefix on an inline formset.\n+\n+        formset = AuthorBooksFormSet(prefix=\"test\")\n+        self.assertEqual(len(formset.forms), 2)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_test-0-title\">Title:</label> <input id=\"id_test-0-title\" type=\"text\" name=\"test-0-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"test-0-author\" id=\"id_test-0-author\" /><input type=\"hidden\" name=\"test-0-id\" id=\"id_test-0-id\" /></p>')\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_test-1-title\">Title:</label> <input id=\"id_test-1-title\" type=\"text\" name=\"test-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"test-1-author\" id=\"id_test-1-author\" /><input type=\"hidden\" name=\"test-1-id\" id=\"id_test-1-id\" /></p>')\n+\n+    def test_inline_formsets_with_custom_pk(self):\n+        # Test inline formsets where the inline-edited object has a custom\n+        # primary key that is not the fk to the parent object.\n+\n+        AuthorBooksFormSet2 = inlineformset_factory(Author, BookWithCustomPK, can_delete=False, extra=1)\n+        author = Author.objects.create(pk=1, name='Charles Baudelaire')\n+\n+        formset = AuthorBooksFormSet2(instance=author)\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_bookwithcustompk_set-0-my_pk\">My pk:</label> <input type=\"text\" name=\"bookwithcustompk_set-0-my_pk\" id=\"id_bookwithcustompk_set-0-my_pk\" /></p>\\n'\n+            '<p><label for=\"id_bookwithcustompk_set-0-title\">Title:</label> <input id=\"id_bookwithcustompk_set-0-title\" type=\"text\" name=\"bookwithcustompk_set-0-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"bookwithcustompk_set-0-author\" value=\"1\" id=\"id_bookwithcustompk_set-0-author\" /></p>')\n+\n+        data = {\n+            'bookwithcustompk_set-TOTAL_FORMS': '1', # the number of forms rendered\n+            'bookwithcustompk_set-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'bookwithcustompk_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'bookwithcustompk_set-0-my_pk': '77777',\n+            'bookwithcustompk_set-0-title': 'Les Fleurs du Mal',\n+        }\n+\n+        formset = AuthorBooksFormSet2(data, instance=author)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        book1, = saved\n+        self.assertEqual(book1.pk, 77777)\n+\n+        book1 = author.bookwithcustompk_set.get()\n+        self.assertEqual(book1.title, 'Les Fleurs du Mal')\n+\n+    def test_inline_formsets_with_multi_table_inheritance(self):\n+        # Test inline formsets where the inline-edited object uses multi-table\n+        # inheritance, thus has a non AutoField yet auto-created primary key.\n+\n+        AuthorBooksFormSet3 = inlineformset_factory(Author, AlternateBook, can_delete=False, extra=1)\n+        author = Author.objects.create(pk=1, name='Charles Baudelaire')\n+\n+        formset = AuthorBooksFormSet3(instance=author)\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_alternatebook_set-0-title\">Title:</label> <input id=\"id_alternatebook_set-0-title\" type=\"text\" name=\"alternatebook_set-0-title\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_alternatebook_set-0-notes\">Notes:</label> <input id=\"id_alternatebook_set-0-notes\" type=\"text\" name=\"alternatebook_set-0-notes\" maxlength=\"100\" /><input type=\"hidden\" name=\"alternatebook_set-0-author\" value=\"1\" id=\"id_alternatebook_set-0-author\" /><input type=\"hidden\" name=\"alternatebook_set-0-book_ptr\" id=\"id_alternatebook_set-0-book_ptr\" /></p>')\n+\n+        data = {\n+            'alternatebook_set-TOTAL_FORMS': '1', # the number of forms rendered\n+            'alternatebook_set-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'alternatebook_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'alternatebook_set-0-title': 'Flowers of Evil',\n+            'alternatebook_set-0-notes': 'English translation of Les Fleurs du Mal'\n+        }\n+\n+        formset = AuthorBooksFormSet3(data, instance=author)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        book1, = saved\n+        self.assertEqual(book1.title, 'Flowers of Evil')\n+        self.assertEqual(book1.notes, 'English translation of Les Fleurs du Mal')\n+\n+        # Test inline formsets where the inline-edited object has a\n+        # unique_together constraint with a nullable member\n+\n+        AuthorBooksFormSet4 = inlineformset_factory(Author, BookWithOptionalAltEditor, can_delete=False, extra=2)\n+\n+        data = {\n+            'bookwithoptionalalteditor_set-TOTAL_FORMS': '2', # the number of forms rendered\n+            'bookwithoptionalalteditor_set-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'bookwithoptionalalteditor_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'bookwithoptionalalteditor_set-0-author': '1',\n+            'bookwithoptionalalteditor_set-0-title': 'Les Fleurs du Mal',\n+            'bookwithoptionalalteditor_set-1-author': '1',\n+            'bookwithoptionalalteditor_set-1-title': 'Les Fleurs du Mal',\n+        }\n+        formset = AuthorBooksFormSet4(data, instance=author)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 2)\n+        book1, book2 = saved\n+        self.assertEqual(book1.author_id, 1)\n+        self.assertEqual(book1.title, 'Les Fleurs du Mal')\n+        self.assertEqual(book2.author_id, 1)\n+        self.assertEqual(book2.title, 'Les Fleurs du Mal')\n+\n+    def test_inline_formsets_with_custom_save_method(self):\n+        AuthorBooksFormSet = inlineformset_factory(Author, Book, can_delete=False, extra=2)\n+        author = Author.objects.create(pk=1, name='Charles Baudelaire')\n+        book1 = Book.objects.create(pk=1, author=author, title='Les Paradis Artificiels')\n+        book2 = Book.objects.create(pk=2, author=author, title='Les Fleurs du Mal')\n+        book3 = Book.objects.create(pk=3, author=author, title='Flowers of Evil')\n+\n+        class PoemForm(forms.ModelForm):\n+            def save(self, commit=True):\n+                # change the name to \"Brooklyn Bridge\" just to be a jerk.\n+                poem = super(PoemForm, self).save(commit=False)\n+                poem.name = u\"Brooklyn Bridge\"\n+                if commit:\n+                    poem.save()\n+                return poem\n+\n+        PoemFormSet = inlineformset_factory(Poet, Poem, form=PoemForm)\n+\n+        data = {\n+            'poem_set-TOTAL_FORMS': '3', # the number of forms rendered\n+            'poem_set-INITIAL_FORMS': '0', # the number of forms with initial data\n+            'poem_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'poem_set-0-name': 'The Cloud in Trousers',\n+            'poem_set-1-name': 'I',\n+            'poem_set-2-name': '',\n+        }\n+\n+        poet = Poet.objects.create(name='Vladimir Mayakovsky')\n+        formset = PoemFormSet(data=data, instance=poet)\n+        self.assertTrue(formset.is_valid())\n+\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 2)\n+        poem1, poem2 = saved\n+        self.assertEqual(poem1.name, 'Brooklyn Bridge')\n+        self.assertEqual(poem2.name, 'Brooklyn Bridge')\n+\n+        # We can provide a custom queryset to our InlineFormSet:\n+\n+        custom_qs = Book.objects.order_by('-title')\n+        formset = AuthorBooksFormSet(instance=author, queryset=custom_qs)\n+        self.assertEqual(len(formset.forms), 5)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" value=\"Les Paradis Artificiels\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"1\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" value=\"1\" id=\"id_book_set-0-id\" /></p>')\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" value=\"Les Fleurs du Mal\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"1\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" value=\"2\" id=\"id_book_set-1-id\" /></p>')\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" value=\"Flowers of Evil\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"1\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" value=\"3\" id=\"id_book_set-2-id\" /></p>')\n+        self.assertEqual(formset.forms[3].as_p(),\n+            '<p><label for=\"id_book_set-3-title\">Title:</label> <input id=\"id_book_set-3-title\" type=\"text\" name=\"book_set-3-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-3-author\" value=\"1\" id=\"id_book_set-3-author\" /><input type=\"hidden\" name=\"book_set-3-id\" id=\"id_book_set-3-id\" /></p>')\n+        self.assertEqual(formset.forms[4].as_p(),\n+            '<p><label for=\"id_book_set-4-title\">Title:</label> <input id=\"id_book_set-4-title\" type=\"text\" name=\"book_set-4-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-4-author\" value=\"1\" id=\"id_book_set-4-author\" /><input type=\"hidden\" name=\"book_set-4-id\" id=\"id_book_set-4-id\" /></p>')\n+\n+        data = {\n+            'book_set-TOTAL_FORMS': '5', # the number of forms rendered\n+            'book_set-INITIAL_FORMS': '3', # the number of forms with initial data\n+            'book_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'book_set-0-id': str(book1.id),\n+            'book_set-0-title': 'Les Paradis Artificiels',\n+            'book_set-1-id': str(book2.id),\n+            'book_set-1-title': 'Les Fleurs du Mal',\n+            'book_set-2-id': str(book3.id),\n+            'book_set-2-title': 'Flowers of Evil',\n+            'book_set-3-title': 'Revue des deux mondes',\n+            'book_set-4-title': '',\n+        }\n+        formset = AuthorBooksFormSet(data, instance=author, queryset=custom_qs)\n+        self.assertTrue(formset.is_valid())\n+\n+        custom_qs = Book.objects.filter(title__startswith='F')\n+        formset = AuthorBooksFormSet(instance=author, queryset=custom_qs)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_book_set-0-title\">Title:</label> <input id=\"id_book_set-0-title\" type=\"text\" name=\"book_set-0-title\" value=\"Flowers of Evil\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-0-author\" value=\"1\" id=\"id_book_set-0-author\" /><input type=\"hidden\" name=\"book_set-0-id\" value=\"3\" id=\"id_book_set-0-id\" /></p>')\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_book_set-1-title\">Title:</label> <input id=\"id_book_set-1-title\" type=\"text\" name=\"book_set-1-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-1-author\" value=\"1\" id=\"id_book_set-1-author\" /><input type=\"hidden\" name=\"book_set-1-id\" id=\"id_book_set-1-id\" /></p>')\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_book_set-2-title\">Title:</label> <input id=\"id_book_set-2-title\" type=\"text\" name=\"book_set-2-title\" maxlength=\"100\" /><input type=\"hidden\" name=\"book_set-2-author\" value=\"1\" id=\"id_book_set-2-author\" /><input type=\"hidden\" name=\"book_set-2-id\" id=\"id_book_set-2-id\" /></p>')\n+\n+        data = {\n+            'book_set-TOTAL_FORMS': '3', # the number of forms rendered\n+            'book_set-INITIAL_FORMS': '1', # the number of forms with initial data\n+            'book_set-MAX_NUM_FORMS': '', # the max number of forms\n+            'book_set-0-id': str(book3.id),\n+            'book_set-0-title': 'Flowers of Evil',\n+            'book_set-1-title': 'Revue des deux mondes',\n+            'book_set-2-title': '',\n+        }\n+        formset = AuthorBooksFormSet(data, instance=author, queryset=custom_qs)\n+        self.assertTrue(formset.is_valid())\n+\n+    def test_custom_pk(self):\n+        # We need to ensure that it is displayed\n+\n+        CustomPrimaryKeyFormSet = modelformset_factory(CustomPrimaryKey)\n+        formset = CustomPrimaryKeyFormSet()\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-my_pk\">My pk:</label> <input id=\"id_form-0-my_pk\" type=\"text\" name=\"form-0-my_pk\" maxlength=\"10\" /></p>\\n'\n+            '<p><label for=\"id_form-0-some_field\">Some field:</label> <input id=\"id_form-0-some_field\" type=\"text\" name=\"form-0-some_field\" maxlength=\"100\" /></p>')\n+\n+        # Custom primary keys with ForeignKey, OneToOneField and AutoField ############\n+\n+        place = Place.objects.create(pk=1, name=u'Giordanos', city=u'Chicago')\n+\n+        FormSet = inlineformset_factory(Place, Owner, extra=2, can_delete=False)\n+        formset = FormSet(instance=place)\n+        self.assertEqual(len(formset.forms), 2)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_owner_set-0-name\">Name:</label> <input id=\"id_owner_set-0-name\" type=\"text\" name=\"owner_set-0-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-0-place\" value=\"1\" id=\"id_owner_set-0-place\" /><input type=\"hidden\" name=\"owner_set-0-auto_id\" id=\"id_owner_set-0-auto_id\" /></p>')\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_owner_set-1-name\">Name:</label> <input id=\"id_owner_set-1-name\" type=\"text\" name=\"owner_set-1-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-1-place\" value=\"1\" id=\"id_owner_set-1-place\" /><input type=\"hidden\" name=\"owner_set-1-auto_id\" id=\"id_owner_set-1-auto_id\" /></p>')\n+\n+        data = {\n+            'owner_set-TOTAL_FORMS': '2',\n+            'owner_set-INITIAL_FORMS': '0',\n+            'owner_set-MAX_NUM_FORMS': '',\n+            'owner_set-0-auto_id': '',\n+            'owner_set-0-name': u'Joe Perry',\n+            'owner_set-1-auto_id': '',\n+            'owner_set-1-name': '',\n+        }\n+        formset = FormSet(data, instance=place)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        owner, = saved\n+        self.assertEqual(owner.name, 'Joe Perry')\n+        self.assertEqual(owner.place.name, 'Giordanos')\n+\n+        formset = FormSet(instance=place)\n+        self.assertEqual(len(formset.forms), 3)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_owner_set-0-name\">Name:</label> <input id=\"id_owner_set-0-name\" type=\"text\" name=\"owner_set-0-name\" value=\"Joe Perry\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-0-place\" value=\"1\" id=\"id_owner_set-0-place\" /><input type=\"hidden\" name=\"owner_set-0-auto_id\" value=\"1\" id=\"id_owner_set-0-auto_id\" /></p>')\n+        self.assertEqual(formset.forms[1].as_p(),\n+            '<p><label for=\"id_owner_set-1-name\">Name:</label> <input id=\"id_owner_set-1-name\" type=\"text\" name=\"owner_set-1-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-1-place\" value=\"1\" id=\"id_owner_set-1-place\" /><input type=\"hidden\" name=\"owner_set-1-auto_id\" id=\"id_owner_set-1-auto_id\" /></p>')\n+        self.assertEqual(formset.forms[2].as_p(),\n+            '<p><label for=\"id_owner_set-2-name\">Name:</label> <input id=\"id_owner_set-2-name\" type=\"text\" name=\"owner_set-2-name\" maxlength=\"100\" /><input type=\"hidden\" name=\"owner_set-2-place\" value=\"1\" id=\"id_owner_set-2-place\" /><input type=\"hidden\" name=\"owner_set-2-auto_id\" id=\"id_owner_set-2-auto_id\" /></p>')\n+\n+        data = {\n+            'owner_set-TOTAL_FORMS': '3',\n+            'owner_set-INITIAL_FORMS': '1',\n+            'owner_set-MAX_NUM_FORMS': '',\n+            'owner_set-0-auto_id': u'1',\n+            'owner_set-0-name': u'Joe Perry',\n+            'owner_set-1-auto_id': '',\n+            'owner_set-1-name': u'Jack Berry',\n+            'owner_set-2-auto_id': '',\n+            'owner_set-2-name': '',\n+        }\n+        formset = FormSet(data, instance=place)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        owner, = saved\n+        self.assertEqual(owner.name, 'Jack Berry')\n+        self.assertEqual(owner.place.name, 'Giordanos')\n+\n+        # Ensure a custom primary key that is a ForeignKey or OneToOneField get rendered for the user to choose.\n+\n+        FormSet = modelformset_factory(OwnerProfile)\n+        formset = FormSet()\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_form-0-owner\">Owner:</label> <select name=\"form-0-owner\" id=\"id_form-0-owner\">\\n'\n+            '<option value=\"\" selected=\"selected\">---------</option>\\n'\n+            '<option value=\"1\">Joe Perry at Giordanos</option>\\n'\n+            '<option value=\"2\">Jack Berry at Giordanos</option>\\n'\n+            '</select></p>\\n'\n+            '<p><label for=\"id_form-0-age\">Age:</label> <input type=\"text\" name=\"form-0-age\" id=\"id_form-0-age\" /></p>')\n+\n+        owner = Owner.objects.get(name=u'Joe Perry')\n+        FormSet = inlineformset_factory(Owner, OwnerProfile, max_num=1, can_delete=False)\n+        self.assertEqual(FormSet.max_num, 1)\n+\n+        formset = FormSet(instance=owner)\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_ownerprofile-0-age\">Age:</label> <input type=\"text\" name=\"ownerprofile-0-age\" id=\"id_ownerprofile-0-age\" /><input type=\"hidden\" name=\"ownerprofile-0-owner\" value=\"1\" id=\"id_ownerprofile-0-owner\" /></p>')\n+\n+        data = {\n+            'ownerprofile-TOTAL_FORMS': '1',\n+            'ownerprofile-INITIAL_FORMS': '0',\n+            'ownerprofile-MAX_NUM_FORMS': '1',\n+            'ownerprofile-0-owner': '',\n+            'ownerprofile-0-age': u'54',\n+        }\n+        formset = FormSet(data, instance=owner)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        profile1, = saved\n+        self.assertEqual(profile1.owner, owner)\n+        self.assertEqual(profile1.age, 54)\n+\n+        formset = FormSet(instance=owner)\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_ownerprofile-0-age\">Age:</label> <input type=\"text\" name=\"ownerprofile-0-age\" value=\"54\" id=\"id_ownerprofile-0-age\" /><input type=\"hidden\" name=\"ownerprofile-0-owner\" value=\"1\" id=\"id_ownerprofile-0-owner\" /></p>')\n+\n+        data = {\n+            'ownerprofile-TOTAL_FORMS': '1',\n+            'ownerprofile-INITIAL_FORMS': '1',\n+            'ownerprofile-MAX_NUM_FORMS': '1',\n+            'ownerprofile-0-owner': u'1',\n+            'ownerprofile-0-age': u'55',\n+        }\n+        formset = FormSet(data, instance=owner)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        profile1, = saved\n+        self.assertEqual(profile1.owner, owner)\n+        self.assertEqual(profile1.age, 55)\n+\n+    def test_unique_true_enforces_max_num_one(self):\n+        # ForeignKey with unique=True should enforce max_num=1\n+\n+        place = Place.objects.create(pk=1, name=u'Giordanos', city=u'Chicago')\n+\n+        FormSet = inlineformset_factory(Place, Location, can_delete=False)\n+        self.assertEqual(FormSet.max_num, 1)\n+\n+        formset = FormSet(instance=place)\n+        self.assertEqual(len(formset.forms), 1)\n+        self.assertEqual(formset.forms[0].as_p(),\n+            '<p><label for=\"id_location_set-0-lat\">Lat:</label> <input id=\"id_location_set-0-lat\" type=\"text\" name=\"location_set-0-lat\" maxlength=\"100\" /></p>\\n'\n+            '<p><label for=\"id_location_set-0-lon\">Lon:</label> <input id=\"id_location_set-0-lon\" type=\"text\" name=\"location_set-0-lon\" maxlength=\"100\" /><input type=\"hidden\" name=\"location_set-0-place\" value=\"1\" id=\"id_location_set-0-place\" /><input type=\"hidden\" name=\"location_set-0-id\" id=\"id_location_set-0-id\" /></p>')\n+\n+    def test_foreign_keys_in_parents(self):\n+        self.assertEqual(type(_get_foreign_key(Restaurant, Owner)), models.ForeignKey)\n+        self.assertEqual(type(_get_foreign_key(MexicanRestaurant, Owner)), models.ForeignKey)\n+\n+    def test_unique_validation(self):\n+        FormSet = modelformset_factory(Product, extra=1)\n+        data = {\n+            'form-TOTAL_FORMS': '1',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-slug': 'car-red',\n+        }\n+        formset = FormSet(data)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        product1, = saved\n+        self.assertEqual(product1.slug, 'car-red')\n+\n+        data = {\n+            'form-TOTAL_FORMS': '1',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-slug': 'car-red',\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset.errors, [{'slug': [u'Product with this Slug already exists.']}])\n+\n+    def test_unique_together_validation(self):\n+        FormSet = modelformset_factory(Price, extra=1)\n+        data = {\n+            'form-TOTAL_FORMS': '1',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-price': u'12.00',\n+            'form-0-quantity': '1',\n+        }\n+        formset = FormSet(data)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        price1, = saved\n+        self.assertEqual(price1.price, Decimal('12.00'))\n+        self.assertEqual(price1.quantity, 1)\n+\n+        data = {\n+            'form-TOTAL_FORMS': '1',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-price': u'12.00',\n+            'form-0-quantity': '1',\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset.errors, [{'__all__': [u'Price with this Price and Quantity already exists.']}])\n+\n+    def test_unique_together_with_inlineformset_factory(self):\n+        # Also see bug #8882.\n+\n+        repository = Repository.objects.create(name=u'Test Repo')\n+        FormSet = inlineformset_factory(Repository, Revision, extra=1)\n+        data = {\n+            'revision_set-TOTAL_FORMS': '1',\n+            'revision_set-INITIAL_FORMS': '0',\n+            'revision_set-MAX_NUM_FORMS': '',\n+            'revision_set-0-repository': repository.pk,\n+            'revision_set-0-revision': '146239817507f148d448db38840db7c3cbf47c76',\n+            'revision_set-0-DELETE': '',\n+        }\n+        formset = FormSet(data, instance=repository)\n+        self.assertTrue(formset.is_valid())\n+        saved = formset.save()\n+        self.assertEqual(len(saved), 1)\n+        revision1, = saved\n+        self.assertEqual(revision1.repository, repository)\n+        self.assertEqual(revision1.revision, '146239817507f148d448db38840db7c3cbf47c76')\n+\n+        # attempt to save the same revision against against the same repo.\n+        data = {\n+            'revision_set-TOTAL_FORMS': '1',\n+            'revision_set-INITIAL_FORMS': '0',\n+            'revision_set-MAX_NUM_FORMS': '',\n+            'revision_set-0-repository': repository.pk,\n+            'revision_set-0-revision': '146239817507f148d448db38840db7c3cbf47c76',\n+            'revision_set-0-DELETE': '',\n+        }\n+        formset = FormSet(data, instance=repository)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset.errors, [{'__all__': [u'Revision with this Repository and Revision already exists.']}])\n+\n+        # unique_together with inlineformset_factory with overridden form fields\n+        # Also see #9494\n+\n+        FormSet = inlineformset_factory(Repository, Revision, fields=('revision',), extra=1)\n+        data = {\n+            'revision_set-TOTAL_FORMS': '1',\n+            'revision_set-INITIAL_FORMS': '0',\n+            'revision_set-MAX_NUM_FORMS': '',\n+            'revision_set-0-repository': repository.pk,\n+            'revision_set-0-revision': '146239817507f148d448db38840db7c3cbf47c76',\n+            'revision_set-0-DELETE': '',\n+        }\n+        formset = FormSet(data, instance=repository)\n+        self.assertFalse(formset.is_valid())\n+\n+    def test_callable_defaults(self):\n+        # Use of callable defaults (see bug #7975).\n+\n+        person = Person.objects.create(name='Ringo')\n+        FormSet = inlineformset_factory(Person, Membership, can_delete=False, extra=1)\n+        formset = FormSet(instance=person)\n+\n+        # Django will render a hidden field for model fields that have a callable\n+        # default. This is required to ensure the value is tested for change correctly\n+        # when determine what extra forms have changed to save.\n+\n+        self.assertEquals(len(formset.forms), 1) # this formset only has one form\n+        form = formset.forms[0]\n+        now = form.fields['date_joined'].initial()\n+        result = form.as_p()\n+        result = re.sub(r'\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}(?:\\.\\d+)?', '__DATETIME__', result)\n+        self.assertEqual(result,\n+            '<p><label for=\"id_membership_set-0-date_joined\">Date joined:</label> <input type=\"text\" name=\"membership_set-0-date_joined\" value=\"__DATETIME__\" id=\"id_membership_set-0-date_joined\" /><input type=\"hidden\" name=\"initial-membership_set-0-date_joined\" value=\"__DATETIME__\" id=\"initial-membership_set-0-id_membership_set-0-date_joined\" /></p>\\n'\n+            '<p><label for=\"id_membership_set-0-karma\">Karma:</label> <input type=\"text\" name=\"membership_set-0-karma\" id=\"id_membership_set-0-karma\" /><input type=\"hidden\" name=\"membership_set-0-person\" value=\"1\" id=\"id_membership_set-0-person\" /><input type=\"hidden\" name=\"membership_set-0-id\" id=\"id_membership_set-0-id\" /></p>')\n+\n+        # test for validation with callable defaults. Validations rely on hidden fields\n+\n+        data = {\n+            'membership_set-TOTAL_FORMS': '1',\n+            'membership_set-INITIAL_FORMS': '0',\n+            'membership_set-MAX_NUM_FORMS': '',\n+            'membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n+            'initial-membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n+            'membership_set-0-karma': '',\n+        }\n+        formset = FormSet(data, instance=person)\n+        self.assertTrue(formset.is_valid())\n+\n+        # now test for when the data changes\n+\n+        one_day_later = now + datetime.timedelta(days=1)\n+        filled_data = {\n+            'membership_set-TOTAL_FORMS': '1',\n+            'membership_set-INITIAL_FORMS': '0',\n+            'membership_set-MAX_NUM_FORMS': '',\n+            'membership_set-0-date_joined': unicode(one_day_later.strftime('%Y-%m-%d %H:%M:%S')),\n+            'initial-membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n+            'membership_set-0-karma': '',\n+        }\n+        formset = FormSet(filled_data, instance=person)\n+        self.assertFalse(formset.is_valid())\n+\n+        # now test with split datetime fields\n+\n+        class MembershipForm(forms.ModelForm):\n+            date_joined = forms.SplitDateTimeField(initial=now)\n+            class Meta:\n+                model = Membership\n+            def __init__(self, **kwargs):\n+                super(MembershipForm, self).__init__(**kwargs)\n+                self.fields['date_joined'].widget = forms.SplitDateTimeWidget()\n+\n+        FormSet = inlineformset_factory(Person, Membership, form=MembershipForm, can_delete=False, extra=1)\n+        data = {\n+            'membership_set-TOTAL_FORMS': '1',\n+            'membership_set-INITIAL_FORMS': '0',\n+            'membership_set-MAX_NUM_FORMS': '',\n+            'membership_set-0-date_joined_0': unicode(now.strftime('%Y-%m-%d')),\n+            'membership_set-0-date_joined_1': unicode(now.strftime('%H:%M:%S')),\n+            'initial-membership_set-0-date_joined': unicode(now.strftime('%Y-%m-%d %H:%M:%S')),\n+            'membership_set-0-karma': '',\n+        }\n+        formset = FormSet(data, instance=person)\n+        self.assertTrue(formset.is_valid())\n+\n+    def test_inlineformset_factory_with_null_fk(self):\n+        # inlineformset_factory tests with fk having null=True. see #9462.\n+        # create some data that will exbit the issue\n+        team = Team.objects.create(name=u\"Red Vipers\")\n+        Player(name=\"Timmy\").save()\n+        Player(name=\"Bobby\", team=team).save()\n+\n+        PlayerInlineFormSet = inlineformset_factory(Team, Player)\n+        formset = PlayerInlineFormSet()\n+        self.assertQuerysetEqual(formset.get_queryset(), [])\n+\n+        formset = PlayerInlineFormSet(instance=team)\n+        players = formset.get_queryset()\n+        self.assertEqual(len(players), 1)\n+        player1, = players\n+        self.assertEqual(player1.team, team)\n+        self.assertEqual(player1.name, 'Bobby')\n+\n+    def test_model_formset_with_custom_pk(self):\n+        # a formset for a Model that has a custom primary key that still needs to be\n+        # added to the formset automatically\n+        FormSet = modelformset_factory(ClassyMexicanRestaurant, fields=[\"tacos_are_yummy\"])\n+        self.assertEqual(sorted(FormSet().forms[0].fields.keys()), ['restaurant', 'tacos_are_yummy'])\n+\n+    def test_prevent_duplicates_from_with_the_same_formset(self):\n+        FormSet = modelformset_factory(Product, extra=2)\n+        data = {\n+            'form-TOTAL_FORMS': 2,\n+            'form-INITIAL_FORMS': 0,\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-slug': 'red_car',\n+            'form-1-slug': 'red_car',\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset._non_form_errors,\n+            [u'Please correct the duplicate data for slug.'])\n+\n+        FormSet = modelformset_factory(Price, extra=2)\n+        data = {\n+            'form-TOTAL_FORMS': 2,\n+            'form-INITIAL_FORMS': 0,\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-price': '25',\n+            'form-0-quantity': '7',\n+            'form-1-price': '25',\n+            'form-1-quantity': '7',\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset._non_form_errors,\n+            [u'Please correct the duplicate data for price and quantity, which must be unique.'])\n+\n+        # Only the price field is specified, this should skip any unique checks since\n+        # the unique_together is not fulfilled. This will fail with a KeyError if broken.\n+        FormSet = modelformset_factory(Price, fields=(\"price\",), extra=2)\n+        data = {\n+            'form-TOTAL_FORMS': '2',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+            'form-0-price': '24',\n+            'form-1-price': '24',\n+        }\n+        formset = FormSet(data)\n+        self.assertTrue(formset.is_valid())\n+\n+        FormSet = inlineformset_factory(Author, Book, extra=0)\n+        author = Author.objects.create(pk=1, name='Charles Baudelaire')\n+        book1 = Book.objects.create(pk=1, author=author, title='Les Paradis Artificiels')\n+        book2 = Book.objects.create(pk=2, author=author, title='Les Fleurs du Mal')\n+        book3 = Book.objects.create(pk=3, author=author, title='Flowers of Evil')\n+\n+        book_ids = author.book_set.order_by('id').values_list('id', flat=True)\n+        data = {\n+            'book_set-TOTAL_FORMS': '2',\n+            'book_set-INITIAL_FORMS': '2',\n+            'book_set-MAX_NUM_FORMS': '',\n+\n+            'book_set-0-title': 'The 2008 Election',\n+            'book_set-0-author': str(author.id),\n+            'book_set-0-id': str(book_ids[0]),\n+\n+            'book_set-1-title': 'The 2008 Election',\n+            'book_set-1-author': str(author.id),\n+            'book_set-1-id': str(book_ids[1]),\n+        }\n+        formset = FormSet(data=data, instance=author)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset._non_form_errors,\n+            [u'Please correct the duplicate data for title.'])\n+        self.assertEqual(formset.errors,\n+            [{}, {'__all__': u'Please correct the duplicate values below.'}])\n+\n+        FormSet = modelformset_factory(Post, extra=2)\n+        data = {\n+            'form-TOTAL_FORMS': '2',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+\n+            'form-0-title': 'blah',\n+            'form-0-slug': 'Morning',\n+            'form-0-subtitle': 'foo',\n+            'form-0-posted': '2009-01-01',\n+            'form-1-title': 'blah',\n+            'form-1-slug': 'Morning in Prague',\n+            'form-1-subtitle': 'rawr',\n+            'form-1-posted': '2009-01-01'\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset._non_form_errors,\n+            [u'Please correct the duplicate data for title which must be unique for the date in posted.'])\n+        self.assertEqual(formset.errors,\n+            [{}, {'__all__': u'Please correct the duplicate values below.'}])\n+\n+        data = {\n+            'form-TOTAL_FORMS': '2',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+\n+            'form-0-title': 'foo',\n+            'form-0-slug': 'Morning in Prague',\n+            'form-0-subtitle': 'foo',\n+            'form-0-posted': '2009-01-01',\n+            'form-1-title': 'blah',\n+            'form-1-slug': 'Morning in Prague',\n+            'form-1-subtitle': 'rawr',\n+            'form-1-posted': '2009-08-02'\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset._non_form_errors,\n+            [u'Please correct the duplicate data for slug which must be unique for the year in posted.'])\n+\n+        data = {\n+            'form-TOTAL_FORMS': '2',\n+            'form-INITIAL_FORMS': '0',\n+            'form-MAX_NUM_FORMS': '',\n+\n+            'form-0-title': 'foo',\n+            'form-0-slug': 'Morning in Prague',\n+            'form-0-subtitle': 'rawr',\n+            'form-0-posted': '2008-08-01',\n+            'form-1-title': 'blah',\n+            'form-1-slug': 'Prague',\n+            'form-1-subtitle': 'rawr',\n+            'form-1-posted': '2009-08-02'\n+        }\n+        formset = FormSet(data)\n+        self.assertFalse(formset.is_valid())\n+        self.assertEqual(formset._non_form_errors,\n+            [u'Please correct the duplicate data for subtitle which must be unique for the month in posted.'])"
        }
    ],
    "stats": {
        "total": 2127,
        "additions": 1088,
        "deletions": 1039
    }
}