{
    "author": "jezdez",
    "message": "Fixed #16703 -- Raise an exception if the storage location of the DefaultStorageFinder is empty.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16863 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c4cc8756437de2c9b508910ebe84f75a8d98d699",
    "files": [
        {
            "sha": "7b4c7c8178611a74063cb77f391274344d063e18",
            "filename": "django/contrib/staticfiles/finders.py",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/c4cc8756437de2c9b508910ebe84f75a8d98d699/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "raw_url": "https://github.com/django/django/raw/c4cc8756437de2c9b508910ebe84f75a8d98d699/django%2Fcontrib%2Fstaticfiles%2Ffinders.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Ffinders.py?ref=c4cc8756437de2c9b508910ebe84f75a8d98d699",
            "patch": "@@ -3,7 +3,7 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.core.files.storage import default_storage, Storage, FileSystemStorage\n from django.utils.datastructures import SortedDict\n-from django.utils.functional import memoize, LazyObject\n+from django.utils.functional import empty, memoize, LazyObject\n from django.utils.importlib import import_module\n from django.utils._os import safe_join\n \n@@ -133,7 +133,7 @@ def list(self, ignore_patterns):\n         List all files in all app storages.\n         \"\"\"\n         for storage in self.storages.itervalues():\n-            if storage.exists(''): # check if storage location exists\n+            if storage.exists(''):  # check if storage location exists\n                 for path in utils.get_files(storage, ignore_patterns):\n                     yield path, storage\n \n@@ -210,12 +210,21 @@ def list(self, ignore_patterns):\n         for path in utils.get_files(self.storage, ignore_patterns):\n             yield path, self.storage\n \n+\n class DefaultStorageFinder(BaseStorageFinder):\n     \"\"\"\n     A static files finder that uses the default storage backend.\n     \"\"\"\n     storage = default_storage\n \n+    def __init__(self, *args, **kwargs):\n+        super(DefaultStorageFinder, self).__init__(*args, **kwargs)\n+        base_location = getattr(self.storage, 'base_location', empty)\n+        if not base_location:\n+            raise ImproperlyConfigured(\"The storage backend of the \"\n+                                       \"staticfiles finder %r doesn't have \"\n+                                       \"a valid location.\" % self.__class__)\n+\n \n def find(path, all=False):\n     \"\"\"\n@@ -237,10 +246,12 @@ def find(path, all=False):\n     # No match.\n     return all and [] or None\n \n+\n def get_finders():\n     for finder_path in settings.STATICFILES_FINDERS:\n         yield get_finder(finder_path)\n \n+\n def _get_finder(import_path):\n     \"\"\"\n     Imports the staticfiles finder class described by import_path, where"
        },
        {
            "sha": "aa62175819fe3730843bbd9beb840699cb469916",
            "filename": "django/core/files/storage.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/c4cc8756437de2c9b508910ebe84f75a8d98d699/django%2Fcore%2Ffiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/c4cc8756437de2c9b508910ebe84f75a8d98d699/django%2Fcore%2Ffiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fstorage.py?ref=c4cc8756437de2c9b508910ebe84f75a8d98d699",
            "patch": "@@ -12,7 +12,8 @@\n from django.utils.functional import LazyObject\n from django.utils.importlib import import_module\n from django.utils.text import get_valid_filename\n-from django.utils._os import safe_join\n+from django.utils._os import safe_join, abspathu\n+\n \n __all__ = ('Storage', 'FileSystemStorage', 'DefaultStorage', 'default_storage')\n \n@@ -145,9 +146,10 @@ class FileSystemStorage(Storage):\n     def __init__(self, location=None, base_url=None):\n         if location is None:\n             location = settings.MEDIA_ROOT\n+        self.base_location = location\n+        self.location = abspathu(self.base_location)\n         if base_url is None:\n             base_url = settings.MEDIA_URL\n-        self.location = os.path.abspath(location)\n         self.base_url = base_url\n \n     def _open(self, name, mode='rb'):"
        },
        {
            "sha": "6a7a46af21bfe85fb0c642122c32eeb31e215ba0",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/c4cc8756437de2c9b508910ebe84f75a8d98d699/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c4cc8756437de2c9b508910ebe84f75a8d98d699/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=c4cc8756437de2c9b508910ebe84f75a8d98d699",
            "patch": "@@ -96,6 +96,14 @@ def tearDown(self):\n         shutil.rmtree(self.temp_dir)\n         shutil.rmtree(self.temp_dir2)\n \n+    def test_emtpy_location(self):\n+        \"\"\"\n+        Makes sure an exception is raised if the location is empty\n+        \"\"\"\n+        storage = self.storage_class(location='')\n+        self.assertEqual(storage.base_location, '')\n+        self.assertEqual(storage.location, os.getcwd())\n+\n     def test_file_access_options(self):\n         \"\"\"\n         Standard file access options are available, and work as expected."
        },
        {
            "sha": "5c141f695a968aec7fb2e6739388b07170f3858c",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/c4cc8756437de2c9b508910ebe84f75a8d98d699/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c4cc8756437de2c9b508910ebe84f75a8d98d699/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=c4cc8756437de2c9b508910ebe84f75a8d98d699",
            "patch": "@@ -496,6 +496,9 @@ class TestMiscFinder(TestCase):\n     \"\"\"\n     A few misc finder tests.\n     \"\"\"\n+    def setUp(self):\n+        default_storage._wrapped = empty\n+\n     def test_get_finder(self):\n         self.assertTrue(isinstance(finders.get_finder(\n             'django.contrib.staticfiles.finders.FileSystemFinder'),\n@@ -509,13 +512,17 @@ def test_get_finder_bad_module(self):\n         self.assertRaises(ImproperlyConfigured,\n             finders.get_finder, 'foo.bar.FooBarFinder')\n \n+    @override_settings(STATICFILES_DIRS='a string')\n     def test_non_tuple_raises_exception(self):\n         \"\"\"\n         We can't determine if STATICFILES_DIRS is set correctly just by\n         looking at the type, but we can determine if it's definitely wrong.\n         \"\"\"\n-        with self.settings(STATICFILES_DIRS='a string'):\n-            self.assertRaises(ImproperlyConfigured, finders.FileSystemFinder)\n+        self.assertRaises(ImproperlyConfigured, finders.FileSystemFinder)\n+\n+    @override_settings(MEDIA_ROOT='')\n+    def test_location_empty(self):\n+        self.assertRaises(ImproperlyConfigured, finders.DefaultStorageFinder)\n \n \n class TestTemplateTag(StaticFilesTestCase):"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 34,
        "deletions": 6
    }
}