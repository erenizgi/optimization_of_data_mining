{
    "author": "jezdez",
    "message": "Fixed #14390 and #16262 -- Moved password related functions from auth models to utils module and stopped check_password from throwing an exception. Thanks, subsume and lrekucki.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16456 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4a1033898636f8c2cafc74c7934fdf7411716fdf",
    "files": [
        {
            "sha": "e9a6cd2e47edfad2345f0a96d166c64e0792a8cd",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 9,
            "deletions": 63,
            "changes": 72,
            "blob_url": "https://github.com/django/django/blob/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=4a1033898636f8c2cafc74c7934fdf7411716fdf",
            "patch": "@@ -1,63 +1,19 @@\n import datetime\n-import hashlib\n-import random\n import urllib\n \n-from django.contrib import auth\n-from django.contrib.auth.signals import user_logged_in\n from django.core.exceptions import ImproperlyConfigured\n from django.core.mail import send_mail\n from django.db import models\n from django.db.models.manager import EmptyManager\n-from django.contrib.contenttypes.models import ContentType\n from django.utils.encoding import smart_str\n from django.utils.translation import ugettext_lazy as _\n-from django.utils.crypto import constant_time_compare\n \n-\n-UNUSABLE_PASSWORD = '!' # This will never be a valid hash\n-\n-def get_hexdigest(algorithm, salt, raw_password):\n-    \"\"\"\n-    Returns a string of the hexdigest of the given plaintext password and salt\n-    using the given algorithm ('md5', 'sha1' or 'crypt').\n-    \"\"\"\n-    raw_password, salt = smart_str(raw_password), smart_str(salt)\n-    if algorithm == 'crypt':\n-        try:\n-            import crypt\n-        except ImportError:\n-            raise ValueError('\"crypt\" password algorithm not supported in this environment')\n-        return crypt.crypt(raw_password, salt)\n-\n-    if algorithm == 'md5':\n-        return hashlib.md5(salt + raw_password).hexdigest()\n-    elif algorithm == 'sha1':\n-        return hashlib.sha1(salt + raw_password).hexdigest()\n-    raise ValueError(\"Got unknown password algorithm type in password.\")\n-\n-def get_random_string(length=12, allowed_chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'):\n-    \"\"\"\n-    Returns a random string of length characters from the set of a-z, A-Z, 0-9\n-    for use as a salt.\n-\n-    The default length of 12 with the a-z, A-Z, 0-9 character set returns\n-    a 71-bit salt. log_2((26+26+10)^12) =~ 71 bits\n-    \"\"\"\n-    import random\n-    try:\n-        random = random.SystemRandom()\n-    except NotImplementedError:\n-        pass\n-    return ''.join([random.choice(allowed_chars) for i in range(length)])\n-\n-def check_password(raw_password, enc_password):\n-    \"\"\"\n-    Returns a boolean of whether the raw_password was correct. Handles\n-    encryption formats behind the scenes.\n-    \"\"\"\n-    algo, salt, hsh = enc_password.split('$')\n-    return constant_time_compare(hsh, get_hexdigest(algo, salt, raw_password))\n+from django.contrib import auth\n+from django.contrib.auth.signals import user_logged_in\n+from django.contrib.auth.utils import (get_hexdigest, make_password,\n+                                       check_password, is_password_usable,\n+                                       get_random_string, UNUSABLE_PASSWORD)\n+from django.contrib.contenttypes.models import ContentType\n \n def update_last_login(sender, user, **kwargs):\n     \"\"\"\n@@ -270,13 +226,7 @@ def get_full_name(self):\n         return full_name.strip()\n \n     def set_password(self, raw_password):\n-        if raw_password is None:\n-            self.set_unusable_password()\n-        else:\n-            algo = 'sha1'\n-            salt = get_random_string()\n-            hsh = get_hexdigest(algo, salt, raw_password)\n-            self.password = '%s$%s$%s' % (algo, salt, hsh)\n+        self.password = make_password('sha1', raw_password)\n \n     def check_password(self, raw_password):\n         \"\"\"\n@@ -296,14 +246,10 @@ def check_password(self, raw_password):\n \n     def set_unusable_password(self):\n         # Sets a value that will never be a valid hash\n-        self.password = UNUSABLE_PASSWORD\n+        self.password = make_password('sha1', None)\n \n     def has_usable_password(self):\n-        if self.password is None \\\n-            or self.password == UNUSABLE_PASSWORD:\n-            return False\n-        else:\n-            return True\n+        return is_password_usable(self.password)\n \n     def get_group_permissions(self, obj=None):\n         \"\"\""
        },
        {
            "sha": "ca1ee0f50bd90bba56d77642403600eae8eb8a9f",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=4a1033898636f8c2cafc74c7934fdf7411716fdf",
            "patch": "@@ -1,7 +1,7 @@\n from django.contrib.auth.tests.auth_backends import (BackendTest,\n     RowlevelBackendTest, AnonymousUserBackendTest, NoAnonymousUserBackendTest,\n     NoBackendsTest, InActiveUserBackendTest, NoInActiveUserBackendTest)\n-from django.contrib.auth.tests.basic import BasicTestCase\n+from django.contrib.auth.tests.basic import BasicTestCase, PasswordUtilsTestCase\n from django.contrib.auth.tests.context_processors import AuthContextProcessorTests\n from django.contrib.auth.tests.decorators import LoginRequiredTestCase\n from django.contrib.auth.tests.forms import (UserCreationFormTest,"
        },
        {
            "sha": "44738f7d07449a146c5befeb0822c29fe816df7f",
            "filename": "django/contrib/auth/tests/basic.py",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py",
            "raw_url": "https://github.com/django/django/raw/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fbasic.py?ref=4a1033898636f8c2cafc74c7934fdf7411716fdf",
            "patch": "@@ -1,8 +1,16 @@\n from django.test import TestCase\n+from django.utils.unittest import skipUnless\n from django.contrib.auth.models import User, AnonymousUser\n+from django.contrib.auth import utils\n from django.core.management import call_command\n from StringIO import StringIO\n \n+try:\n+    import crypt as crypt_module\n+except ImportError:\n+    crypt_module = None\n+\n+\n class BasicTestCase(TestCase):\n     def test_user(self):\n         \"Check that users can be created and can set their password\"\n@@ -93,3 +101,29 @@ def test_createsuperuser_management_command(self):\n         self.assertEqual(u.email, 'joe@somewhere.org')\n         self.assertFalse(u.has_usable_password())\n \n+\n+class PasswordUtilsTestCase(TestCase):\n+\n+    def _test_make_password(self, algo):\n+        password = utils.make_password(algo, \"foobar\")\n+        self.assertTrue(utils.is_password_usable(password))\n+        self.assertTrue(utils.check_password(\"foobar\", password))\n+\n+    def test_make_unusable(self):\n+        \"Check that you can create an unusable password.\"\n+        password = utils.make_password(\"any\", None)\n+        self.assertFalse(utils.is_password_usable(password))\n+        self.assertFalse(utils.check_password(\"foobar\", password))\n+\n+    def test_make_password_sha1(self):\n+        \"Check creating passwords with SHA1 algorithm.\"\n+        self._test_make_password(\"sha1\")\n+\n+    def test_make_password_md5(self):\n+        \"Check creating passwords with MD5 algorithm.\"\n+        self._test_make_password(\"md5\")\n+\n+    @skipUnless(crypt_module, \"no crypt module to generate password.\")\n+    def test_make_password_crypt(self):\n+        \"Check creating passwords with CRYPT algorithm.\"\n+        self._test_make_password(\"crypt\")"
        },
        {
            "sha": "57c693f87987a877aaa8b4b6bbc821f476a653e1",
            "filename": "django/contrib/auth/utils.py",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/django/django/blob/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/4a1033898636f8c2cafc74c7934fdf7411716fdf/django%2Fcontrib%2Fauth%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Futils.py?ref=4a1033898636f8c2cafc74c7934fdf7411716fdf",
            "patch": "@@ -0,0 +1,63 @@\n+import hashlib\n+from django.utils.encoding import smart_str\n+from django.utils.crypto import constant_time_compare\n+\n+UNUSABLE_PASSWORD = '!' # This will never be a valid hash\n+\n+def get_hexdigest(algorithm, salt, raw_password):\n+    \"\"\"\n+    Returns a string of the hexdigest of the given plaintext password and salt\n+    using the given algorithm ('md5', 'sha1' or 'crypt').\n+    \"\"\"\n+    raw_password, salt = smart_str(raw_password), smart_str(salt)\n+    if algorithm == 'crypt':\n+        try:\n+            import crypt\n+        except ImportError:\n+            raise ValueError('\"crypt\" password algorithm not supported in this environment')\n+        return crypt.crypt(raw_password, salt)\n+\n+    if algorithm == 'md5':\n+        return hashlib.md5(salt + raw_password).hexdigest()\n+    elif algorithm == 'sha1':\n+        return hashlib.sha1(salt + raw_password).hexdigest()\n+    raise ValueError(\"Got unknown password algorithm type in password.\")\n+\n+def get_random_string(length=12, allowed_chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'):\n+    \"\"\"\n+    Returns a random string of length characters from the set of a-z, A-Z, 0-9\n+    for use as a salt.\n+\n+    The default length of 12 with the a-z, A-Z, 0-9 character set returns\n+    a 71-bit salt. log_2((26+26+10)^12) =~ 71 bits\n+    \"\"\"\n+    import random\n+    try:\n+        random = random.SystemRandom()\n+    except NotImplementedError:\n+        pass\n+    return ''.join([random.choice(allowed_chars) for i in range(length)])\n+\n+def check_password(raw_password, enc_password):\n+    \"\"\"\n+    Returns a boolean of whether the raw_password was correct. Handles\n+    encryption formats behind the scenes.\n+    \"\"\"\n+    parts = enc_password.split('$')\n+    if len(parts) != 3:\n+        return False\n+    algo, salt, hsh = parts\n+    return constant_time_compare(hsh, get_hexdigest(algo, salt, raw_password))\n+\n+def is_password_usable(encoded_password):\n+    return encoded_password is not None and encoded_password != UNUSABLE_PASSWORD\n+\n+def make_password(algo, raw_password):\n+    \"\"\"\n+    Produce a new password string in this format: algorithm$salt$hash\n+    \"\"\"\n+    if raw_password is None:\n+        return UNUSABLE_PASSWORD\n+    salt = get_random_string()\n+    hsh = get_hexdigest(algo, salt, raw_password)\n+    return '%s$%s$%s' % (algo, salt, hsh)"
        },
        {
            "sha": "acaf3bf5f3898bc10c1bbb1cb9cae182711998a9",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/4a1033898636f8c2cafc74c7934fdf7411716fdf/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/4a1033898636f8c2cafc74c7934fdf7411716fdf/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=4a1033898636f8c2cafc74c7934fdf7411716fdf",
            "patch": "@@ -192,6 +192,11 @@ Django 1.4 also includes several smaller improvements worth noting:\n * In the documentation, a helpful :doc:`security overview </topics/security>`\n   page.\n \n+* Function :func:`django.contrib.auth.models.check_password` has been moved\n+  to the :mod:`django.contrib.auth.utils` module. Importing it from the old\n+  location will still work, but you should update your imports.\n+\n+\n .. _backwards-incompatible-changes-1.4:\n \n Backwards incompatible changes in 1.4"
        },
        {
            "sha": "c1947f61e19ae02e763754f65c392d0bab2dcdc5",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/4a1033898636f8c2cafc74c7934fdf7411716fdf/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/4a1033898636f8c2cafc74c7934fdf7411716fdf/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=4a1033898636f8c2cafc74c7934fdf7411716fdf",
            "patch": "@@ -627,19 +627,44 @@ Django provides two functions in :mod:`django.contrib.auth`:\n \n .. _backends documentation: #other-authentication-sources\n \n-Manually checking a user's password\n+Manually managing a user's password\n -----------------------------------\n \n-.. currentmodule:: django.contrib.auth.models\n+.. currentmodule:: django.contrib.auth.utils\n+\n+.. versionadded:: 1.4\n+\n+    The :mod:`django.contrib.auth.utils` module provides a set of functions\n+    to create and validate hashed password. You can use them independently\n+    from the ``User`` model.\n \n .. function:: check_password()\n \n     If you'd like to manually authenticate a user by comparing a plain-text\n     password to the hashed password in the database, use the convenience\n-    function :func:`django.contrib.auth.models.check_password`. It takes two\n-    arguments: the plain-text password to check, and the full value of a user's\n-    ``password`` field in the database to check against, and returns ``True``\n-    if they match, ``False`` otherwise.\n+    function :func:`django.contrib.auth.utils.check_password`. It takes two\n+    arguments: the plain-text password to check, and the full value of a\n+    user's ``password`` field in the database to check against, and returns\n+    ``True`` if they match, ``False`` otherwise.\n+\n+.. function:: make_password()\n+\n+    .. versionadded:: 1.4\n+\n+    Creates a hashed password in the format used by this application. It takes\n+    two arguments: hashing algorithm to use and the password in plain-text.\n+    Currently supported algorithms are: ``'sha1'``, ``'md5'`` and ``'crypt'``\n+    if you have the ``crypt`` library installed. If the second argument is\n+    ``None``, an unusable password is returned (a one that will be never\n+    accepted by :func:`django.contrib.auth.utils.check_password`).\n+\n+.. function:: is_password_usable()\n+\n+    .. versionadded:: 1.4\n+\n+   Checks if the given string is a hashed password that has a chance\n+   of being verified against :func:`django.contrib.auth.utils.check_password`.\n+\n \n How to log a user out\n ---------------------"
        }
    ],
    "stats": {
        "total": 213,
        "additions": 143,
        "deletions": 70
    }
}