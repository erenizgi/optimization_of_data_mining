{
    "author": "aaugustin",
    "message": "Fixed #19160 -- Made lazy plural translations usable.\n\nMany thanks to Alexey Boriskin, Claude Paroz and Julien Phalip.",
    "sha": "3f1a0c0040b9a950584f4b309a1b670b0e709de5",
    "files": [
        {
            "sha": "1b5200c98c84a3561056fd288c7ee58f38958f26",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5",
            "patch": "@@ -157,8 +157,7 @@ def __mod__(self, rhs):\n                 return bytes(self) % rhs\n             elif self._delegate_text:\n                 return six.text_type(self) % rhs\n-            else:\n-                raise AssertionError('__mod__ not supported for non-string types')\n+            return self.__cast() % rhs\n \n         def __deepcopy__(self, memo):\n             # Instances of this class are effectively immutable. It's just a"
        },
        {
            "sha": "7a48376a52d0c8eade57dcf2f86d1c5251b4ab62",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 32,
            "deletions": 3,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5",
            "patch": "@@ -85,11 +85,40 @@ def npgettext(context, singular, plural, number):\n     return _trans.npgettext(context, singular, plural, number)\n \n gettext_lazy = lazy(gettext, str)\n-ngettext_lazy = lazy(ngettext, str)\n ugettext_lazy = lazy(ugettext, six.text_type)\n-ungettext_lazy = lazy(ungettext, six.text_type)\n pgettext_lazy = lazy(pgettext, six.text_type)\n-npgettext_lazy = lazy(npgettext, six.text_type)\n+\n+def lazy_number(func, resultclass, number=None, **kwargs):\n+    if isinstance(number, int):\n+        kwargs['number'] = number\n+        proxy = lazy(func, resultclass)(**kwargs)\n+    else:\n+        class NumberAwareString(resultclass):\n+            def __mod__(self, rhs):\n+                if isinstance(rhs, dict) and number:\n+                    try:\n+                        number_value = rhs[number]\n+                    except KeyError:\n+                        raise KeyError('Your dictionary lacks key \\'%s\\'. '\n+                            'Please provide it, because it is required to '\n+                            'determine whether string is singular or plural.'\n+                            % number)\n+                else:\n+                    number_value = rhs\n+                kwargs['number'] = number_value\n+                return func(**kwargs) % rhs\n+\n+        proxy = lazy(lambda **kwargs: NumberAwareString(), NumberAwareString)(**kwargs)\n+    return proxy\n+\n+def ngettext_lazy(singular, plural, number=None):\n+    return lazy_number(ngettext, str, singular=singular, plural=plural, number=number)\n+\n+def ungettext_lazy(singular, plural, number=None):\n+    return lazy_number(ungettext, six.text_type, singular=singular, plural=plural, number=number)\n+\n+def npgettext_lazy(context, singular, plural, number=None):\n+    return lazy_number(npgettext, six.text_type, context=context, singular=singular, plural=plural, number=number)\n \n def activate(language):\n     return _trans.activate(language)"
        },
        {
            "sha": "5e1d959f60ec4365adfbe4a13588f9bf6005200a",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5",
            "patch": "@@ -35,6 +35,10 @@ Minor features\n   :class:`~django.forms.URLField` use the new type attributes available in\n   HTML5 (type='email', type='url').\n \n+* The ``number`` argument for :ref:`lazy plural translations\n+  <lazy-plural-translations>` can be provided at translation time rather than\n+  at definition time.\n+\n Backwards incompatible changes in 1.6\n =====================================\n "
        },
        {
            "sha": "f45be3c63dac5227d19621e769f56df1fc1108fd",
            "filename": "docs/topics/i18n/translation.txt",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/docs%2Ftopics%2Fi18n%2Ftranslation.txt",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/docs%2Ftopics%2Fi18n%2Ftranslation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fi18n%2Ftranslation.txt?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5",
            "patch": "@@ -414,6 +414,41 @@ convert them to strings, because they should be converted as late as possible\n (so that the correct locale is in effect). This necessitates the use of the\n helper function described next.\n \n+.. _lazy-plural-translations:\n+\n+Lazy translations and plural\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+.. versionadded:: 1.6\n+\n+When using lazy translation for a plural string (``[u]n[p]gettext_lazy``), you\n+generally don't know the ``number`` argument at the time of the string\n+definition. Therefore, you are authorized to pass a key name instead of an\n+integer as the ``number`` argument. Then ``number`` will be looked up in the\n+dictionary under that key during string interpolation. Here's example::\n+\n+    class MyForm(forms.Form):\n+        error_message = ungettext_lazy(\"You only provided %(num)d argument\",\n+            \"You only provided %(num)d arguments\", 'num')\n+\n+        def clean(self):\n+            # ...\n+            if error:\n+                raise forms.ValidationError(self.error_message % {'num': number})\n+\n+If the string contains exactly one unnamed placeholder, you can interpolate\n+directly with the ``number`` argument::\n+\n+    class MyForm(forms.Form):\n+        error_message = ungettext_lazy(\"You provided %d argument\",\n+            \"You provided %d arguments\")\n+\n+        def clean(self):\n+            # ...\n+            if error:\n+                raise forms.ValidationError(self.error_message % number)\n+\n+\n Joining strings: string_concat()\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        },
        {
            "sha": "e208c8249f6b334e54e8a1f8061f9f60383d8874",
            "filename": "tests/regressiontests/i18n/other/locale/de/LC_MESSAGES/django.mo",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/tests%2Fregressiontests%2Fi18n%2Fother%2Flocale%2Fde%2FLC_MESSAGES%2Fdjango.mo",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/tests%2Fregressiontests%2Fi18n%2Fother%2Flocale%2Fde%2FLC_MESSAGES%2Fdjango.mo",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fother%2Flocale%2Fde%2FLC_MESSAGES%2Fdjango.mo?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5"
        },
        {
            "sha": "3676893ca308535205064e0aefe60a7e70c623ad",
            "filename": "tests/regressiontests/i18n/other/locale/de/LC_MESSAGES/django.po",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/tests%2Fregressiontests%2Fi18n%2Fother%2Flocale%2Fde%2FLC_MESSAGES%2Fdjango.po",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/tests%2Fregressiontests%2Fi18n%2Fother%2Flocale%2Fde%2FLC_MESSAGES%2Fdjango.po",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Fother%2Flocale%2Fde%2FLC_MESSAGES%2Fdjango.po?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5",
            "patch": "@@ -41,6 +41,32 @@ msgid_plural \"%d results\"\n msgstr[0] \"%d Resultat\"\n msgstr[1] \"%d Resultate\"\n \n+#: models.py:11\n+msgid \"%d good result\"\n+msgid_plural \"%d good results\"\n+msgstr[0] \"%d gutes Resultat\"\n+msgstr[1] \"%d guten Resultate\"\n+\n+#: models.py:11\n+msgctxt \"Exclamation\"\n+msgid \"%d good result\"\n+msgid_plural \"%d good results\"\n+msgstr[0] \"%d gutes Resultat!\"\n+msgstr[1] \"%d guten Resultate!\"\n+\n+#: models.py:11\n+msgid \"Hi %(name)s, %(num)d good result\"\n+msgid_plural \"Hi %(name)s, %(num)d good results\"\n+msgstr[0] \"Hallo %(name)s, %(num)d gutes Resultat\"\n+msgstr[1] \"Hallo %(name)s, %(num)d guten Resultate\"\n+\n+#: models.py:11\n+msgctxt \"Greeting\"\n+msgid \"Hi %(name)s, %(num)d good result\"\n+msgid_plural \"Hi %(name)s, %(num)d good results\"\n+msgstr[0] \"Willkommen %(name)s, %(num)d gutes Resultat\"\n+msgstr[1] \"Willkommen %(name)s, %(num)d guten Resultate\"\n+\n #: models.py:13\n #, python-format\n msgid \"The result was %(percent)s%%\""
        },
        {
            "sha": "fc1a832b8969e35baf78bcc0f53d79644cb3b202",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 45,
            "deletions": 4,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/3f1a0c0040b9a950584f4b309a1b670b0e709de5/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3f1a0c0040b9a950584f4b309a1b670b0e709de5/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=3f1a0c0040b9a950584f4b309a1b670b0e709de5",
            "patch": "@@ -22,10 +22,15 @@\n from django.utils.safestring import mark_safe, SafeBytes, SafeString, SafeText\n from django.utils import six\n from django.utils.six import PY3\n-from django.utils.translation import (ugettext, ugettext_lazy, activate,\n-    deactivate, gettext_lazy, pgettext, npgettext, to_locale,\n-    get_language_info, get_language, get_language_from_request, trans_real)\n-\n+from django.utils.translation import (activate, deactivate,\n+    get_language,  get_language_from_request, get_language_info,\n+    to_locale, trans_real,\n+    gettext, gettext_lazy,\n+    ugettext, ugettext_lazy,\n+    ngettext, ngettext_lazy,\n+    ungettext, ungettext_lazy,\n+    pgettext, pgettext_lazy,\n+    npgettext, npgettext_lazy)\n \n from .commands.tests import can_run_extraction_tests, can_run_compilation_tests\n if can_run_extraction_tests:\n@@ -95,6 +100,42 @@ def test_lazy_pickle(self):\n         s2 = pickle.loads(pickle.dumps(s1))\n         self.assertEqual(six.text_type(s2), \"test\")\n \n+    @override_settings(LOCALE_PATHS=extended_locale_paths)\n+    def test_ungettext_lazy(self):\n+        s0 = ungettext_lazy(\"%d good result\", \"%d good results\")\n+        s1 = ngettext_lazy(str(\"%d good result\"), str(\"%d good results\"))\n+        s2 = npgettext_lazy('Exclamation', '%d good result', '%d good results')\n+        with translation.override('de'):\n+            self.assertEqual(s0 % 1, \"1 gutes Resultat\")\n+            self.assertEqual(s0 % 4, \"4 guten Resultate\")\n+            self.assertEqual(s1 % 1, str(\"1 gutes Resultat\"))\n+            self.assertEqual(s1 % 4, str(\"4 guten Resultate\"))\n+            self.assertEqual(s2 % 1, \"1 gutes Resultat!\")\n+            self.assertEqual(s2 % 4, \"4 guten Resultate!\")\n+\n+        s3 = ungettext_lazy(\"Hi %(name)s, %(num)d good result\", \"Hi %(name)s, %(num)d good results\", 4)\n+        s4 = ungettext_lazy(\"Hi %(name)s, %(num)d good result\", \"Hi %(name)s, %(num)d good results\", 'num')\n+        s5 = ngettext_lazy(str(\"Hi %(name)s, %(num)d good result\"), str(\"Hi %(name)s, %(num)d good results\"), 4)\n+        s6 = ngettext_lazy(str(\"Hi %(name)s, %(num)d good result\"), str(\"Hi %(name)s, %(num)d good results\"), 'num')\n+        s7 = npgettext_lazy('Greeting', \"Hi %(name)s, %(num)d good result\", \"Hi %(name)s, %(num)d good results\", 4)\n+        s8 = npgettext_lazy('Greeting', \"Hi %(name)s, %(num)d good result\", \"Hi %(name)s, %(num)d good results\", 'num')\n+        with translation.override('de'):\n+            self.assertEqual(s3 % {'num': 4, 'name': 'Jim'}, \"Hallo Jim, 4 guten Resultate\")\n+            self.assertEqual(s4 % {'name': 'Jim', 'num': 1}, \"Hallo Jim, 1 gutes Resultat\")\n+            self.assertEqual(s4 % {'name': 'Jim', 'num': 5}, \"Hallo Jim, 5 guten Resultate\")\n+            with six.assertRaisesRegex(self, KeyError, 'Your dictionary lacks key.*'):\n+                s4 % {'name': 'Jim'}\n+            self.assertEqual(s5 % {'num': 4, 'name': 'Jim'}, str(\"Hallo Jim, 4 guten Resultate\"))\n+            self.assertEqual(s6 % {'name': 'Jim', 'num': 1}, str(\"Hallo Jim, 1 gutes Resultat\"))\n+            self.assertEqual(s6 % {'name': 'Jim', 'num': 5}, str(\"Hallo Jim, 5 guten Resultate\"))\n+            with six.assertRaisesRegex(self, KeyError, 'Your dictionary lacks key.*'):\n+                s6 % {'name': 'Jim'}\n+            self.assertEqual(s7 % {'num': 4, 'name': 'Jim'}, \"Willkommen Jim, 4 guten Resultate\")\n+            self.assertEqual(s8 % {'name': 'Jim', 'num': 1}, \"Willkommen Jim, 1 gutes Resultat\")\n+            self.assertEqual(s8 % {'name': 'Jim', 'num': 5}, \"Willkommen Jim, 5 guten Resultate\")\n+            with six.assertRaisesRegex(self, KeyError, 'Your dictionary lacks key.*'):\n+                s8 % {'name': 'Jim'}\n+\n     @override_settings(LOCALE_PATHS=extended_locale_paths)\n     def test_pgettext(self):\n         trans_real._active = local()"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 143,
        "deletions": 9
    }
}