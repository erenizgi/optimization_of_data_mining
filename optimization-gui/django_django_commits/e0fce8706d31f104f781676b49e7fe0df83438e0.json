{
    "author": "alex",
    "message": "Switch to using context managers for acquiring and releasing locks.",
    "sha": "e0fce8706d31f104f781676b49e7fe0df83438e0",
    "files": [
        {
            "sha": "617068a21caaa59cafb9196801914ea0a5db8cc9",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=e0fce8706d31f104f781676b49e7fe0df83438e0",
            "patch": "@@ -210,8 +210,7 @@ def __call__(self, environ, start_response):\n         # Set up middleware if needed. We couldn't do this earlier, because\n         # settings weren't available.\n         if self._request_middleware is None:\n-            self.initLock.acquire()\n-            try:\n+            with self.initLock:\n                 try:\n                     # Check that middleware is still uninitialised.\n                     if self._request_middleware is None:\n@@ -220,8 +219,6 @@ def __call__(self, environ, start_response):\n                     # Unload whatever middleware we got\n                     self._request_middleware = None\n                     raise\n-            finally:\n-                self.initLock.release()\n \n         set_script_prefix(base.get_script_name(environ))\n         signals.request_started.send(sender=self.__class__)"
        },
        {
            "sha": "0baae0c01e8cc0f5af7d67354290d9085db80c11",
            "filename": "django/core/mail/backends/console.py",
            "status": "modified",
            "additions": 13,
            "deletions": 15,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fcore%2Fmail%2Fbackends%2Fconsole.py",
            "raw_url": "https://github.com/django/django/raw/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fcore%2Fmail%2Fbackends%2Fconsole.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fbackends%2Fconsole.py?ref=e0fce8706d31f104f781676b49e7fe0df83438e0",
            "patch": "@@ -16,19 +16,17 @@ def send_messages(self, email_messages):\n         \"\"\"Write all messages to the stream in a thread-safe way.\"\"\"\n         if not email_messages:\n             return\n-        self._lock.acquire()\n-        try:\n-            stream_created = self.open()\n-            for message in email_messages:\n-                self.stream.write('%s\\n' % message.message().as_string())\n-                self.stream.write('-'*79)\n-                self.stream.write('\\n')\n-                self.stream.flush()  # flush after each message\n-            if stream_created:\n-                self.close()\n-        except:\n-            if not self.fail_silently:\n-                raise\n-        finally:\n-            self._lock.release()\n+        with self._lock:\n+            try:\n+                stream_created = self.open()\n+                for message in email_messages:\n+                    self.stream.write('%s\\n' % message.message().as_string())\n+                    self.stream.write('-'*79)\n+                    self.stream.write('\\n')\n+                    self.stream.flush()  # flush after each message\n+                if stream_created:\n+                    self.close()\n+            except:\n+                if not self.fail_silently:\n+                    raise\n         return len(email_messages)"
        },
        {
            "sha": "18437c62828044f93e0b76e13d4bea22e5aa1810",
            "filename": "django/core/mail/backends/smtp.py",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "raw_url": "https://github.com/django/django/raw/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py?ref=e0fce8706d31f104f781676b49e7fe0df83438e0",
            "patch": "@@ -80,8 +80,7 @@ def send_messages(self, email_messages):\n         \"\"\"\n         if not email_messages:\n             return\n-        self._lock.acquire()\n-        try:\n+        with self._lock:\n             new_conn_created = self.open()\n             if not self.connection:\n                 # We failed silently on open().\n@@ -94,8 +93,6 @@ def send_messages(self, email_messages):\n                     num_sent += 1\n             if new_conn_created:\n                 self.close()\n-        finally:\n-            self._lock.release()\n         return num_sent\n \n     def _send(self, email_message):"
        },
        {
            "sha": "cbf62602d287c2d1f17d2bff11e7b5ab93d6c3ed",
            "filename": "django/db/models/loading.py",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fdb%2Fmodels%2Floading.py",
            "raw_url": "https://github.com/django/django/raw/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fdb%2Fmodels%2Floading.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Floading.py?ref=e0fce8706d31f104f781676b49e7fe0df83438e0",
            "patch": "@@ -54,8 +54,7 @@ def _populate(self):\n         \"\"\"\n         if self.loaded:\n             return\n-        self.write_lock.acquire()\n-        try:\n+        with self.write_lock:\n             if self.loaded:\n                 return\n             for app_name in settings.INSTALLED_APPS:\n@@ -66,8 +65,6 @@ def _populate(self):\n                 for app_name in self.postponed:\n                     self.load_app(app_name)\n                 self.loaded = True\n-        finally:\n-            self.write_lock.release()\n \n     def _label_for(self, app_mod):\n         \"\"\"\n@@ -138,8 +135,7 @@ def get_app(self, app_label, emptyOK=False):\n         the app has no models in it and 'emptyOK' is True, returns None.\n         \"\"\"\n         self._populate()\n-        self.write_lock.acquire()\n-        try:\n+        with self.write_lock:\n             for app_name in settings.INSTALLED_APPS:\n                 if app_label == app_name.split('.')[-1]:\n                     mod = self.load_app(app_name, False)\n@@ -150,8 +146,6 @@ def get_app(self, app_label, emptyOK=False):\n                     else:\n                         return mod\n             raise ImproperlyConfigured(\"App with label %s could not be found\" % app_label)\n-        finally:\n-            self.write_lock.release()\n \n     def get_app_errors(self):\n         \"Returns the map of known problems with the INSTALLED_APPS.\""
        },
        {
            "sha": "e7f440a7c2f6c0075e06f1f5569028a0b2f28383",
            "filename": "django/dispatch/dispatcher.py",
            "status": "modified",
            "additions": 4,
            "deletions": 13,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fdispatch%2Fdispatcher.py",
            "raw_url": "https://github.com/django/django/raw/e0fce8706d31f104f781676b49e7fe0df83438e0/django%2Fdispatch%2Fdispatcher.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdispatch%2Fdispatcher.py?ref=e0fce8706d31f104f781676b49e7fe0df83438e0",
            "patch": "@@ -99,15 +99,12 @@ def connect(self, receiver, sender=None, weak=True, dispatch_uid=None):\n         if weak:\n             receiver = saferef.safeRef(receiver, onDelete=self._remove_receiver)\n \n-        self.lock.acquire()\n-        try:\n+        with self.lock:\n             for r_key, _ in self.receivers:\n                 if r_key == lookup_key:\n                     break\n             else:\n                 self.receivers.append((lookup_key, receiver))\n-        finally:\n-            self.lock.release()\n \n     def disconnect(self, receiver=None, sender=None, weak=True, dispatch_uid=None):\n         \"\"\"\n@@ -135,16 +132,13 @@ def disconnect(self, receiver=None, sender=None, weak=True, dispatch_uid=None):\n             lookup_key = (dispatch_uid, _make_id(sender))\n         else:\n             lookup_key = (_make_id(receiver), _make_id(sender))\n-        \n-        self.lock.acquire()\n-        try:\n+\n+        with self.lock:\n             for index in xrange(len(self.receivers)):\n                 (r_key, _) = self.receivers[index]\n                 if r_key == lookup_key:\n                     del self.receivers[index]\n                     break\n-        finally:\n-            self.lock.release()\n \n     def send(self, sender, **named):\n         \"\"\"\n@@ -237,8 +231,7 @@ def _remove_receiver(self, receiver):\n         Remove dead receivers from connections.\n         \"\"\"\n \n-        self.lock.acquire()\n-        try:\n+        with self.lock:\n             to_remove = []\n             for key, connected_receiver in self.receivers:\n                 if connected_receiver == receiver:\n@@ -250,8 +243,6 @@ def _remove_receiver(self, receiver):\n                 for idx, (r_key, _) in enumerate(reversed(self.receivers)):\n                     if r_key == key:\n                         del self.receivers[last_idx-idx]\n-        finally:\n-            self.lock.release()\n \n \n def receiver(signal, **kwargs):"
        },
        {
            "sha": "2215f5652378fa927e21a10788469c8822013612",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/e0fce8706d31f104f781676b49e7fe0df83438e0/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e0fce8706d31f104f781676b49e7fe0df83438e0/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=e0fce8706d31f104f781676b49e7fe0df83438e0",
            "patch": "@@ -603,21 +603,16 @@ def process_message(self, peer, mailfrom, rcpttos, data):\n         maddr = email.Utils.parseaddr(m.get('from'))[1]\n         if mailfrom != maddr:\n             return \"553 '%s' != '%s'\" % (mailfrom, maddr)\n-        self.sink_lock.acquire()\n-        self._sink.append(m)\n-        self.sink_lock.release()\n+        with self.sink_lock:\n+            self._sink.append(m)\n \n     def get_sink(self):\n-        self.sink_lock.acquire()\n-        try:\n+        with self.sink_lock:\n             return self._sink[:]\n-        finally:\n-            self.sink_lock.release()\n \n     def flush_sink(self):\n-        self.sink_lock.acquire()\n-        self._sink[:] = []\n-        self.sink_lock.release()\n+        with self.sink_lock:\n+            self._sink[:] = []\n \n     def start(self):\n         assert not self.active\n@@ -629,9 +624,8 @@ def run(self):\n         self.active = True\n         self.__flag.set()\n         while self.active and asyncore.socket_map:\n-            self.active_lock.acquire()\n-            asyncore.loop(timeout=0.1, count=1)\n-            self.active_lock.release()\n+            with self.active_lock:\n+                asyncore.loop(timeout=0.1, count=1)\n         asyncore.close_all()\n \n     def stop(self):"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 28,
        "deletions": 57
    }
}