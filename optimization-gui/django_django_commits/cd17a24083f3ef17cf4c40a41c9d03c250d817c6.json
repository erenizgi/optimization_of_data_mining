{
    "author": "aaugustin",
    "message": "Added optional kwargs to get_expiry_age/date.\n\nThis change allows for cleaner tests: we can test the exact output.\n\nRefs #18194: this change makes it possible to compute session expiry\ndates at times other than when the session is saved.\n\nFixed #18458: the existence of the `modification` kwarg implies that you\nmust pass it to get_expiry_age/date if you call these functions outside\nof a short request - response cycle (the intended use case).",
    "sha": "cd17a24083f3ef17cf4c40a41c9d03c250d817c6",
    "files": [
        {
            "sha": "1f63c3b45a992e2b9915a6953f5ce6ee9ad1008b",
            "filename": "django/contrib/sessions/backends/base.py",
            "status": "modified",
            "additions": 32,
            "deletions": 8,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py?ref=cd17a24083f3ef17cf4c40a41c9d03c250d817c6",
            "patch": "@@ -170,28 +170,52 @@ def _get_session(self, no_load=False):\n \n     _session = property(_get_session)\n \n-    def get_expiry_age(self, expiry=None):\n+    def get_expiry_age(self, **kwargs):\n         \"\"\"Get the number of seconds until the session expires.\n \n-        expiry is an optional parameter specifying the datetime of expiry.\n+        Optionally, this function accepts `modification` and `expiry` keyword\n+        arguments specifying the modification and expiry of the session.\n         \"\"\"\n-        if expiry is None:\n+        try:\n+            modification = kwargs['modification']\n+        except KeyError:\n+            modification = timezone.now()\n+        # Make the difference between \"expiry=None passed in kwargs\" and\n+        # \"expiry not passed in kwargs\", in order to guarantee not to trigger\n+        # self.load() when expiry is provided.\n+        try:\n+            expiry = kwargs['expiry']\n+        except KeyError:\n             expiry = self.get('_session_expiry')\n+\n         if not expiry:   # Checks both None and 0 cases\n             return settings.SESSION_COOKIE_AGE\n         if not isinstance(expiry, datetime):\n             return expiry\n-        delta = expiry - timezone.now()\n+        delta = expiry - modification\n         return delta.days * 86400 + delta.seconds\n \n-    def get_expiry_date(self):\n-        \"\"\"Get session the expiry date (as a datetime object).\"\"\"\n-        expiry = self.get('_session_expiry')\n+    def get_expiry_date(self, **kwargs):\n+        \"\"\"Get session the expiry date (as a datetime object).\n+\n+        Optionally, this function accepts `modification` and `expiry` keyword\n+        arguments specifying the modification and expiry of the session.\n+        \"\"\"\n+        try:\n+            modification = kwargs['modification']\n+        except KeyError:\n+            modification = timezone.now()\n+        # Same comment as in get_expiry_age\n+        try:\n+            expiry = kwargs['expiry']\n+        except KeyError:\n+            expiry = self.get('_session_expiry')\n+\n         if isinstance(expiry, datetime):\n             return expiry\n         if not expiry:   # Checks both None and 0 cases\n             expiry = settings.SESSION_COOKIE_AGE\n-        return timezone.now() + timedelta(seconds=expiry)\n+        return modification + timedelta(seconds=expiry)\n \n     def set_expiry(self, value):\n         \"\"\""
        },
        {
            "sha": "31c6fbfce30770ea6e19f758cddd9c774829e80b",
            "filename": "django/contrib/sessions/backends/cached_db.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "raw_url": "https://github.com/django/django/raw/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fcached_db.py?ref=cd17a24083f3ef17cf4c40a41c9d03c250d817c6",
            "patch": "@@ -40,7 +40,7 @@ def load(self):\n                 )\n                 data = self.decode(s.session_data)\n                 cache.set(self.cache_key, data,\n-                    self.get_expiry_age(s.expire_date))\n+                    self.get_expiry_age(expiry=s.expire_date))\n             except (Session.DoesNotExist, SuspiciousOperation):\n                 self.create()\n                 data = {}"
        },
        {
            "sha": "44c3b485e962b6b2b24e03823de3650e02ffd25e",
            "filename": "django/contrib/sessions/tests.py",
            "status": "modified",
            "additions": 29,
            "deletions": 17,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/django%2Fcontrib%2Fsessions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/django%2Fcontrib%2Fsessions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Ftests.py?ref=cd17a24083f3ef17cf4c40a41c9d03c250d817c6",
            "patch": "@@ -197,31 +197,43 @@ def test_default_expiry(self):\n         self.assertEqual(self.session.get_expiry_age(), settings.SESSION_COOKIE_AGE)\n \n     def test_custom_expiry_seconds(self):\n-        # Using seconds\n+        modification = timezone.now()\n+\n         self.session.set_expiry(10)\n-        delta = self.session.get_expiry_date() - timezone.now()\n-        self.assertIn(delta.seconds, (9, 10))\n \n-        age = self.session.get_expiry_age()\n-        self.assertIn(age, (9, 10))\n+        date = self.session.get_expiry_date(modification=modification)\n+        self.assertEqual(date, modification + timedelta(seconds=10))\n+\n+        age = self.session.get_expiry_age(modification=modification)\n+        self.assertEqual(age, 10)\n \n     def test_custom_expiry_timedelta(self):\n-        # Using timedelta\n-        self.session.set_expiry(timedelta(seconds=10))\n-        delta = self.session.get_expiry_date() - timezone.now()\n-        self.assertIn(delta.seconds, (9, 10))\n+        modification = timezone.now()\n+\n+        # Mock timezone.now, because set_expiry calls it on this code path.\n+        original_now = timezone.now\n+        try:\n+            timezone.now = lambda: modification\n+            self.session.set_expiry(timedelta(seconds=10))\n+        finally:\n+            timezone.now = original_now\n+\n+        date = self.session.get_expiry_date(modification=modification)\n+        self.assertEqual(date, modification + timedelta(seconds=10))\n \n-        age = self.session.get_expiry_age()\n-        self.assertIn(age, (9, 10))\n+        age = self.session.get_expiry_age(modification=modification)\n+        self.assertEqual(age, 10)\n \n     def test_custom_expiry_datetime(self):\n-        # Using fixed datetime\n-        self.session.set_expiry(timezone.now() + timedelta(seconds=10))\n-        delta = self.session.get_expiry_date() - timezone.now()\n-        self.assertIn(delta.seconds, (9, 10))\n+        modification = timezone.now()\n+\n+        self.session.set_expiry(modification + timedelta(seconds=10))\n+\n+        date = self.session.get_expiry_date(modification=modification)\n+        self.assertEqual(date, modification + timedelta(seconds=10))\n \n-        age = self.session.get_expiry_age()\n-        self.assertIn(age, (9, 10))\n+        age = self.session.get_expiry_age(modification=modification)\n+        self.assertEqual(age, 10)\n \n     def test_custom_expiry_reset(self):\n         self.session.set_expiry(None)"
        },
        {
            "sha": "1e043405f4b91ac83b47b73cafaab71786a04718",
            "filename": "docs/topics/http/sessions.txt",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/docs%2Ftopics%2Fhttp%2Fsessions.txt",
            "raw_url": "https://github.com/django/django/raw/cd17a24083f3ef17cf4c40a41c9d03c250d817c6/docs%2Ftopics%2Fhttp%2Fsessions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fhttp%2Fsessions.txt?ref=cd17a24083f3ef17cf4c40a41c9d03c250d817c6",
            "patch": "@@ -250,12 +250,23 @@ You can edit it multiple times.\n       with no custom expiration (or those set to expire at browser close), this\n       will equal :setting:`SESSION_COOKIE_AGE`.\n \n+      This function accepts two optional keyword arguments:\n+\n+      - ``modification``: last modification of the session, as a\n+        :class:`~datetime.datetime` object. Defaults to the current time.\n+      - ``expiry``: expiry information for the session, as a\n+        :class:`~datetime.datetime` object, an :class:`int` (in seconds), or\n+        ``None``. Defaults to the value stored in the session by\n+        :meth:`set_expiry`, if there is one, or ``None``.\n+\n     .. method:: get_expiry_date\n \n       Returns the date this session will expire. For sessions with no custom\n       expiration (or those set to expire at browser close), this will equal the\n       date :setting:`SESSION_COOKIE_AGE` seconds from now.\n \n+      This function accepts the same keyword argumets as :meth:`get_expiry_age`.\n+\n     .. method:: get_expire_at_browser_close\n \n       Returns either ``True`` or ``False``, depending on whether the user's"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 73,
        "deletions": 26
    }
}