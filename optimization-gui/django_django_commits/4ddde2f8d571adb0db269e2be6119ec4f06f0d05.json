{
    "author": "freakboy3742",
    "message": "Fixed #14415 -- Corrected the process of creating and destroying test databases to prevent accidental deletion of the source database. Also improves the mirroring process to prevent some cross-connection effects. Thanks to Shai Berger for the help diagnosing and testing.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14696 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "4ddde2f8d571adb0db269e2be6119ec4f06f0d05",
    "files": [
        {
            "sha": "cf51768e9565cd7eabb1246e05689c226bec0389",
            "filename": "django/test/simple.py",
            "status": "modified",
            "additions": 49,
            "deletions": 13,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/4ddde2f8d571adb0db269e2be6119ec4f06f0d05/django%2Ftest%2Fsimple.py",
            "raw_url": "https://github.com/django/django/raw/4ddde2f8d571adb0db269e2be6119ec4f06f0d05/django%2Ftest%2Fsimple.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsimple.py?ref=4ddde2f8d571adb0db269e2be6119ec4f06f0d05",
            "patch": "@@ -217,19 +217,52 @@ def build_suite(self, test_labels, extra_tests=None, **kwargs):\n \n     def setup_databases(self, **kwargs):\n         from django.db import connections\n-        old_names = []\n-        mirrors = []\n+\n+        # First pass -- work out which databases actually need to be created,\n+        # and which ones are test mirrors or duplicate entries in DATABASES\n+        mirrored_aliases = {}\n+        test_databases = {}\n         for alias in connections:\n             connection = connections[alias]\n-            # If the database is a test mirror, redirect it's connection\n-            # instead of creating a test database.\n             if connection.settings_dict['TEST_MIRROR']:\n-                mirrors.append((alias, connection))\n-                mirror_alias = connection.settings_dict['TEST_MIRROR']\n-                connections._connections[alias] = connections[mirror_alias]\n+                # If the database is marked as a test mirror, save\n+                # the alias.\n+                mirrored_aliases[alias] = connection.settings_dict['TEST_MIRROR']\n             else:\n-                old_names.append((connection, connection.settings_dict['NAME']))\n-                connection.creation.create_test_db(self.verbosity, autoclobber=not self.interactive)\n+                # Store the (engine, name) pair. If we have two aliases\n+                # with the same pair, we only need to create the test database\n+                # once.\n+                test_databases.setdefault((\n+                        connection.settings_dict['HOST'],\n+                        connection.settings_dict['PORT'],\n+                        connection.settings_dict['ENGINE'],\n+                        connection.settings_dict['NAME'],\n+                    ), []).append(alias)\n+\n+        # Second pass -- actually create the databases.\n+        old_names = []\n+        mirrors = []\n+        for (host, port, engine, db_name), aliases in test_databases.items():\n+            # Actually create the database for the first connection\n+            connection = connections[aliases[0]]\n+            old_names.append((connection, db_name, True))\n+            test_db_name = connection.creation.create_test_db(self.verbosity, autoclobber=not self.interactive)\n+            for alias in aliases[1:]:\n+                connection = connections[alias]\n+                if db_name:\n+                    old_names.append((connection, db_name, False))\n+                    connection.settings_dict['NAME'] = test_db_name\n+                else:\n+                    # If settings_dict['NAME'] isn't defined, we have a backend where\n+                    # the name isn't important -- e.g., SQLite, which uses :memory:.\n+                    # Force create the database instead of assuming it's a duplicate.\n+                    old_names.append((connection, db_name, True))\n+                    connection.creation.create_test_db(self.verbosity, autoclobber=not self.interactive)\n+\n+        for alias, mirror_alias in mirrored_aliases.items():\n+            mirrors.append((alias, connections[alias].settings_dict['NAME']))\n+            connections[alias].settings_dict['NAME'] = connections[mirror_alias].settings_dict['NAME']\n+\n         return old_names, mirrors\n \n     def run_suite(self, suite, **kwargs):\n@@ -239,11 +272,14 @@ def teardown_databases(self, old_config, **kwargs):\n         from django.db import connections\n         old_names, mirrors = old_config\n         # Point all the mirrors back to the originals\n-        for alias, connection in mirrors:\n-            connections._connections[alias] = connection\n+        for alias, old_name in mirrors:\n+            connections[alias].settings_dict['NAME'] = old_name\n         # Destroy all the non-mirror databases\n-        for connection, old_name in old_names:\n-            connection.creation.destroy_test_db(old_name, self.verbosity)\n+        for connection, old_name, destroy in old_names:\n+            if destroy:\n+                connection.creation.destroy_test_db(old_name, self.verbosity)\n+            else:\n+                connection.settings_dict['NAME'] = old_name\n \n     def teardown_test_environment(self, **kwargs):\n         unittest.removeHandler()"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 49,
        "deletions": 13
    }
}