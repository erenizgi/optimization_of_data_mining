{
    "author": "jezdez",
    "message": "Fixed #15286 -- Don't show deprecation warning if project locale dir is included in LOCALE_PATHS. Thanks to Claude and Ramiro.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15508 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa",
    "files": [
        {
            "sha": "992e1c9664606555bfcb75f13454a7f23027b7a5",
            "filename": "django/utils/translation/__init__.py",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa/django%2Futils%2Ftranslation%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa/django%2Futils%2Ftranslation%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftranslation%2F__init__.py?ref=179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa",
            "patch": "@@ -1,6 +1,7 @@\n \"\"\"\n Internationalization support.\n \"\"\"\n+import warnings\n from os import path\n \n from django.utils.encoding import force_unicode\n@@ -41,17 +42,20 @@ def __getattr__(self, real_name):\n         from django.conf import settings\n         if settings.USE_I18N:\n             from django.utils.translation import trans_real as trans\n-\n+            # Make sure the project's locale dir isn't in LOCALE_PATHS\n             if settings.SETTINGS_MODULE is not None:\n-                import warnings\n                 parts = settings.SETTINGS_MODULE.split('.')\n                 project = import_module(parts[0])\n-                if path.isdir(path.join(path.dirname(project.__file__), 'locale')):\n-                    warnings.warn(\n-                        \"Translations in the project directory aren't supported anymore. Use the LOCALE_PATHS setting instead.\",\n-                        PendingDeprecationWarning\n-                    )\n-\n+                project_locale_path = path.normpath(\n+                    path.join(path.dirname(project.__file__), 'locale'))\n+                normalized_locale_paths = [path.normpath(locale_path)\n+                    for locale_path in settings.LOCALE_PATHS]\n+                if (path.isdir(project_locale_path) and\n+                        not project_locale_path in normalized_locale_paths):\n+                    warnings.warn(\"Translations in the project directory \"\n+                                  \"aren't supported anymore. Use the \"\n+                                  \"LOCALE_PATHS setting instead.\",\n+                                  PendingDeprecationWarning)\n         else:\n             from django.utils.translation import trans_null as trans\n         setattr(self, real_name, getattr(trans, real_name))"
        },
        {
            "sha": "519749252f86163933a694a5ad3d30f4088d9b2b",
            "filename": "tests/regressiontests/i18n/test_warnings.py",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa/tests%2Fregressiontests%2Fi18n%2Ftest_warnings.py",
            "raw_url": "https://github.com/django/django/raw/179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa/tests%2Fregressiontests%2Fi18n%2Ftest_warnings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftest_warnings.py?ref=179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa",
            "patch": "@@ -0,0 +1,32 @@\n+from os.path import join, normpath, abspath, dirname\n+import warnings\n+\n+import django\n+from django.conf import settings\n+from django.test.utils import get_warnings_state, restore_warnings_state\n+from django.utils.unittest import TestCase\n+\n+\n+class DeprecationWarningTests(TestCase):\n+\n+    def setUp(self):\n+        self.warning_state = get_warnings_state()\n+        self.old_settings_module = settings.SETTINGS_MODULE\n+        settings.SETTINGS_MODULE = 'regressiontests'\n+        self.old_locale_paths = settings.LOCALE_PATHS\n+\n+    def tearDown(self):\n+        restore_warnings_state(self.warning_state)\n+        settings.SETTINGS_MODULE = self.old_settings_module\n+        settings.LOCALE_PATHS = self.old_locale_paths\n+\n+    def test_no_warn_if_project_and_locale_paths_overlap(self):\n+        \"\"\"Test that PendingDeprecationWarning isn't generated when a deprecated project level locale/ subdir is also included in LOCALE_PATHS.\"\"\"\n+        project_path = join(dirname(abspath(__file__)), '..')\n+        settings.LOCALE_PATHS += (normpath(join(project_path, 'locale')),)\n+        warnings.filterwarnings('error', \"Translations in the project directory aren't supported anymore\\. Use the LOCALE_PATHS setting instead\\.\", PendingDeprecationWarning)\n+        reload(django.utils.translation)\n+        try:\n+            django.utils.translation.ugettext('Time')\n+        except PendingDeprecationWarning:\n+            self.fail(\"PendingDeprecationWarning shouldn't be raised when settings/project locale and a LOCALE_PATHS member point to the same file system location.\")"
        },
        {
            "sha": "9a51b4139f1b5090f0ff0e9932f5df61ca83e3b3",
            "filename": "tests/regressiontests/i18n/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa/tests%2Fregressiontests%2Fi18n%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fi18n%2Ftests.py?ref=179fefcf7c1e9c6f0a4db5b31a4444bee24e73fa",
            "patch": "@@ -24,6 +24,7 @@\n \n from commands.tests import *\n \n+from test_warnings import DeprecationWarningTests\n \n class TranslationTests(TestCase):\n "
        }
    ],
    "stats": {
        "total": 53,
        "additions": 45,
        "deletions": 8
    }
}