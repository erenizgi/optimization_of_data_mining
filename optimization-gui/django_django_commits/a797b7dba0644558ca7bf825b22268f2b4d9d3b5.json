{
    "author": "ramiro",
    "message": "Fixed #14130 -- Made manage.py error reporting more useful when the settings.py file triggers import errors (in new projects). Thanks Setok for the report, mk and steph for their work.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15522 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a797b7dba0644558ca7bf825b22268f2b4d9d3b5",
    "files": [
        {
            "sha": "3e4eedc9ff5862c99e999b544a5b34c4e9af877a",
            "filename": "django/conf/project_template/manage.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/a797b7dba0644558ca7bf825b22268f2b4d9d3b5/django%2Fconf%2Fproject_template%2Fmanage.py",
            "raw_url": "https://github.com/django/django/raw/a797b7dba0644558ca7bf825b22268f2b4d9d3b5/django%2Fconf%2Fproject_template%2Fmanage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fproject_template%2Fmanage.py?ref=a797b7dba0644558ca7bf825b22268f2b4d9d3b5",
            "patch": "@@ -1,11 +1,14 @@\n #!/usr/bin/env python\n from django.core.management import execute_manager\n+import imp\n try:\n-    import settings # Assumed to be in the same directory.\n+    imp.find_module('settings') # Assumed to be in the same directory.\n except ImportError:\n     import sys\n-    sys.stderr.write(\"Error: Can't find the file 'settings.py' in the directory containing %r. It appears you've customized things.\\nYou'll have to run django-admin.py, passing it your settings module.\\n(If the file settings.py does indeed exist, it's causing an ImportError somehow.)\\n\" % __file__)\n+    sys.stderr.write(\"Error: Can't find the file 'settings.py' in the directory containing %r. It appears you've customized things.\\nYou'll have to run django-admin.py, passing it your settings module.\\n\" % __file__)\n     sys.exit(1)\n \n+import settings\n+\n if __name__ == \"__main__\":\n     execute_manager(settings)"
        },
        {
            "sha": "5c2f5d7fb6ecdffb0bb1c26db3cfab97269f7528",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/a797b7dba0644558ca7bf825b22268f2b4d9d3b5/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a797b7dba0644558ca7bf825b22268f2b4d9d3b5/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=a797b7dba0644558ca7bf825b22268f2b4d9d3b5",
            "patch": "@@ -958,6 +958,35 @@ def test_custom_command_with_environment(self):\n         self.assertNoOutput(out)\n         self.assertOutput(err, \"Unknown command: 'noargs_command'\")\n \n+class ManageSettingsWithImportError(AdminScriptTestCase):\n+    \"\"\"Tests for manage.py when using the default settings.py file\n+    with an import error. Ticket #14130.\n+    \"\"\"\n+    def setUp(self):\n+        self.write_settings_with_import_error('settings.py')\n+\n+    def tearDown(self):\n+        self.remove_settings('settings.py')\n+\n+    def write_settings_with_import_error(self, filename, apps=None, is_dir=False, sdict=None):\n+        test_dir = os.path.dirname(os.path.dirname(__file__))\n+        if is_dir:\n+            settings_dir = os.path.join(test_dir,filename)\n+            os.mkdir(settings_dir)\n+            settings_file = open(os.path.join(settings_dir,'__init__.py'), 'w')\n+        else:\n+            settings_file = open(os.path.join(test_dir, filename), 'w')\n+        settings_file.write('# Settings file automatically generated by regressiontests.admin_scripts test case\\n')\n+        settings_file.write('# The next line will cause an import error:\\nimport foo42bar\\n')\n+\n+        settings_file.close()\n+\n+    def test_builtin_command(self):\n+        \"import error: manage.py builtin commands shows useful diagnostic info when settings with import errors is provided\"\n+        args = ['sqlall','admin_scripts']\n+        out, err = self.run_manage(args)\n+        self.assertNoOutput(out)\n+        self.assertOutput(err, \"ImportError: No module named foo42bar\")\n \n class ManageValidate(AdminScriptTestCase):\n     def tearDown(self):"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 34,
        "deletions": 2
    }
}