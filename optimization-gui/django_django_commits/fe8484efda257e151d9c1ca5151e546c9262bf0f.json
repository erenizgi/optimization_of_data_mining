{
    "author": "aaugustin",
    "message": "[py3] Ported django.utils.functional.",
    "sha": "fe8484efda257e151d9c1ca5151e546c9262bf0f",
    "files": [
        {
            "sha": "085ec40b638c09c9a012f4407987b900eb949ac0",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 37,
            "deletions": 21,
            "changes": 58,
            "blob_url": "https://github.com/django/django/blob/fe8484efda257e151d9c1ca5151e546c9262bf0f/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/fe8484efda257e151d9c1ca5151e546c9262bf0f/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=fe8484efda257e151d9c1ca5151e546c9262bf0f",
            "patch": "@@ -93,13 +93,19 @@ def __prepare_class__(cls):\n                         if hasattr(cls, k):\n                             continue\n                         setattr(cls, k, meth)\n-            cls._delegate_str = bytes in resultclasses\n-            cls._delegate_unicode = six.text_type in resultclasses\n-            assert not (cls._delegate_str and cls._delegate_unicode), \"Cannot call lazy() with both str and unicode return types.\"\n-            if cls._delegate_unicode:\n-                cls.__unicode__ = cls.__unicode_cast\n-            elif cls._delegate_str:\n-                cls.__str__ = cls.__str_cast\n+            cls._delegate_bytes = bytes in resultclasses\n+            cls._delegate_text = six.text_type in resultclasses\n+            assert not (cls._delegate_bytes and cls._delegate_text), \"Cannot call lazy() with both bytes and text return types.\"\n+            if cls._delegate_text:\n+                if six.PY3:\n+                    cls.__str__ = cls.__text_cast\n+                else:\n+                    cls.__unicode__ = cls.__text_cast\n+            elif cls._delegate_bytes:\n+                if six.PY3:\n+                    cls.__bytes__ = cls.__bytes_cast\n+                else:\n+                    cls.__str__ = cls.__bytes_cast\n         __prepare_class__ = classmethod(__prepare_class__)\n \n         def __promise__(cls, klass, funcname, method):\n@@ -120,17 +126,17 @@ def __wrapper__(self, *args, **kw):\n             return __wrapper__\n         __promise__ = classmethod(__promise__)\n \n-        def __unicode_cast(self):\n+        def __text_cast(self):\n             return func(*self.__args, **self.__kw)\n \n-        def __str_cast(self):\n-            return str(func(*self.__args, **self.__kw))\n+        def __bytes_cast(self):\n+            return bytes(func(*self.__args, **self.__kw))\n \n         def __cast(self):\n-            if self._delegate_str:\n-                return self.__str_cast()\n-            elif self._delegate_unicode:\n-                return self.__unicode_cast()\n+            if self._delegate_bytes:\n+                return self.__bytes_cast()\n+            elif self._delegate_text:\n+                return self.__text_cast()\n             else:\n                 return func(*self.__args, **self.__kw)\n \n@@ -144,10 +150,12 @@ def __lt__(self, other):\n                 other = other.__cast()\n             return self.__cast() < other\n \n+        __hash__ = object.__hash__\n+\n         def __mod__(self, rhs):\n-            if self._delegate_str:\n-                return str(self) % rhs\n-            elif self._delegate_unicode:\n+            if self._delegate_bytes and not six.PY3:\n+                return bytes(self) % rhs\n+            elif self._delegate_text:\n                 return six.text_type(self) % rhs\n             else:\n                 raise AssertionError('__mod__ not supported for non-string types')\n@@ -234,6 +242,9 @@ def _setup(self):\n     __dir__ = new_method_proxy(dir)\n \n \n+# Workaround for http://bugs.python.org/issue12370\n+_super = super\n+\n class SimpleLazyObject(LazyObject):\n     \"\"\"\n     A lazy object initialised from any function.\n@@ -251,13 +262,17 @@ def __init__(self, func):\n         value.\n         \"\"\"\n         self.__dict__['_setupfunc'] = func\n-        super(SimpleLazyObject, self).__init__()\n+        _super(SimpleLazyObject, self).__init__()\n \n     def _setup(self):\n         self._wrapped = self._setupfunc()\n \n-    __str__ = new_method_proxy(bytes)\n-    __unicode__ = new_method_proxy(six.text_type)\n+    if six.PY3:\n+        __bytes__ = new_method_proxy(bytes)\n+        __str__ = new_method_proxy(str)\n+    else:\n+        __str__ = new_method_proxy(str)\n+        __unicode__ = new_method_proxy(unicode)\n \n     def __deepcopy__(self, memo):\n         if self._wrapped is empty:\n@@ -284,7 +299,8 @@ def __getstate__(self):\n     __class__ = property(new_method_proxy(operator.attrgetter(\"__class__\")))\n     __eq__ = new_method_proxy(operator.eq)\n     __hash__ = new_method_proxy(hash)\n-    __nonzero__ = new_method_proxy(bool)\n+    __bool__ = new_method_proxy(bool)       # Python 3\n+    __nonzero__ = __bool__                  # Python 2\n \n \n class lazy_property(property):"
        },
        {
            "sha": "bfaefd07eea1e2d6a4593d6fcc1aa7b9d4ea9a89",
            "filename": "django/utils/safestring.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/fe8484efda257e151d9c1ca5151e546c9262bf0f/django%2Futils%2Fsafestring.py",
            "raw_url": "https://github.com/django/django/raw/fe8484efda257e151d9c1ca5151e546c9262bf0f/django%2Futils%2Fsafestring.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fsafestring.py?ref=fe8484efda257e151d9c1ca5151e546c9262bf0f",
            "patch": "@@ -96,7 +96,7 @@ def mark_safe(s):\n     \"\"\"\n     if isinstance(s, SafeData):\n         return s\n-    if isinstance(s, bytes) or (isinstance(s, Promise) and s._delegate_str):\n+    if isinstance(s, bytes) or (isinstance(s, Promise) and s._delegate_bytes):\n         return SafeString(s)\n     if isinstance(s, (six.text_type, Promise)):\n         return SafeUnicode(s)\n@@ -112,7 +112,7 @@ def mark_for_escaping(s):\n     \"\"\"\n     if isinstance(s, (SafeData, EscapeData)):\n         return s\n-    if isinstance(s, bytes) or (isinstance(s, Promise) and s._delegate_str):\n+    if isinstance(s, bytes) or (isinstance(s, Promise) and s._delegate_bytes):\n         return EscapeString(s)\n     if isinstance(s, (six.text_type, Promise)):\n         return EscapeUnicode(s)"
        },
        {
            "sha": "3f81e8f6081cd082b2dc832941ca36ea6507b465",
            "filename": "tests/regressiontests/utils/simplelazyobject.py",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/fe8484efda257e151d9c1ca5151e546c9262bf0f/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py",
            "raw_url": "https://github.com/django/django/raw/fe8484efda257e151d9c1ca5151e546c9262bf0f/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py?ref=fe8484efda257e151d9c1ca5151e546c9262bf0f",
            "patch": "@@ -19,17 +19,27 @@ def __eq__(self, other):\n     def __hash__(self):\n         return hash(self.name)\n \n-    def __str__(self):\n-        return \"I am _ComplexObject(%r)\" % self.name\n+    if six.PY3:\n+        def __bytes__(self):\n+            return (\"I am _ComplexObject(%r)\" % self.name).encode(\"utf-8\")\n \n-    def __unicode__(self):\n-        return six.text_type(self.name)\n+        def __str__(self):\n+            return self.name\n+\n+    else:\n+        def __str__(self):\n+            return b\"I am _ComplexObject(%r)\" % str(self.name)\n+\n+        def __unicode__(self):\n+            return self.name\n \n     def __repr__(self):\n         return \"_ComplexObject(%r)\" % self.name\n \n+\n complex_object = lambda: _ComplexObject(\"joe\")\n \n+\n class TestUtilsSimpleLazyObject(TestCase):\n     \"\"\"\n     Tests for SimpleLazyObject\n@@ -54,11 +64,11 @@ def test_repr(self):\n         # proxy __repr__\n         self.assertTrue(\"SimpleLazyObject\" in repr(SimpleLazyObject(complex_object)))\n \n-    def test_str(self):\n-        self.assertEqual(str_prefix(\"I am _ComplexObject(%(_)s'joe')\"),\n-            str(SimpleLazyObject(complex_object)))\n+    def test_bytes(self):\n+        self.assertEqual(b\"I am _ComplexObject('joe')\",\n+                bytes(SimpleLazyObject(complex_object)))\n \n-    def test_unicode(self):\n+    def test_text(self):\n         self.assertEqual(\"joe\", six.text_type(SimpleLazyObject(complex_object)))\n \n     def test_class(self):"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 57,
        "deletions": 31
    }
}