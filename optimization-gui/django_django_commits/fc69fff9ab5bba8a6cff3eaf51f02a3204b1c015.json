{
    "author": "claudep",
    "message": "Fixed #14861 -- Moved logging config outside of Settings.__init__\n\nThanks donspaulding for the report and simonpercivall for the\ninitial patch.",
    "sha": "fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015",
    "files": [
        {
            "sha": "d636ff0b6cbf869ad722edd20c0878dfdbfd1d09",
            "filename": "django/conf/__init__.py",
            "status": "modified",
            "additions": 16,
            "deletions": 14,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/django%2Fconf%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/django%2Fconf%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2F__init__.py?ref=fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015",
            "patch": "@@ -43,13 +43,28 @@ def _setup(self, name):\n                 % (name, ENVIRONMENT_VARIABLE))\n \n         self._wrapped = Settings(settings_module)\n-\n+        self._configure_logging()\n \n     def __getattr__(self, name):\n         if self._wrapped is empty:\n             self._setup(name)\n         return getattr(self._wrapped, name)\n \n+    def _configure_logging(self):\n+        \"\"\"\n+        Setup logging from LOGGING_CONFIG and LOGGING settings.\n+        \"\"\"\n+        if self.LOGGING_CONFIG:\n+            # First find the logging configuration function ...\n+            logging_config_path, logging_config_func_name = self.LOGGING_CONFIG.rsplit('.', 1)\n+            logging_config_module = importlib.import_module(logging_config_path)\n+            logging_config_func = getattr(logging_config_module, logging_config_func_name)\n+\n+            # Backwards-compatibility shim for #16288 fix\n+            compat_patch_logging_config(self.LOGGING)\n+\n+            # ... then invoke it with the logging settings\n+            logging_config_func(self.LOGGING)\n \n     def configure(self, default_settings=global_settings, **options):\n         \"\"\"\n@@ -133,19 +148,6 @@ def __init__(self, settings_module):\n             os.environ['TZ'] = self.TIME_ZONE\n             time.tzset()\n \n-        # Settings are configured, so we can set up the logger if required\n-        if self.LOGGING_CONFIG:\n-            # First find the logging configuration function ...\n-            logging_config_path, logging_config_func_name = self.LOGGING_CONFIG.rsplit('.', 1)\n-            logging_config_module = importlib.import_module(logging_config_path)\n-            logging_config_func = getattr(logging_config_module, logging_config_func_name)\n-\n-            # Backwards-compatibility shim for #16288 fix\n-            compat_patch_logging_config(self.LOGGING)\n-\n-            # ... then invoke it with the logging settings\n-            logging_config_func(self.LOGGING)\n-\n \n class UserSettingsHolder(BaseSettings):\n     \"\"\""
        },
        {
            "sha": "a4aae0bc029a643bb9e865ad4d9798440d808154",
            "filename": "docs/topics/logging.txt",
            "status": "modified",
            "additions": 0,
            "deletions": 30,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/docs%2Ftopics%2Flogging.txt",
            "raw_url": "https://github.com/django/django/raw/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/docs%2Ftopics%2Flogging.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Flogging.txt?ref=fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015",
            "patch": "@@ -345,36 +345,6 @@ This logging configuration does the following things:\n     printed to the console; ``ERROR`` and ``CRITICAL``\n     messages will also be output via email.\n \n-.. admonition:: Custom handlers and circular imports\n-\n-    If your ``settings.py`` specifies a custom handler class and the file\n-    defining that class also imports ``settings.py`` a circular import will\n-    occur.\n-\n-    For example, if ``settings.py`` contains the following config for\n-    :setting:`LOGGING`::\n-\n-        LOGGING = {\n-          'version': 1,\n-          'handlers': {\n-            'custom_handler': {\n-              'level': 'INFO',\n-              'class': 'myproject.logconfig.MyHandler',\n-            }\n-          }\n-        }\n-\n-    and ``myproject/logconfig.py`` has the following line before the\n-    ``MyHandler`` definition::\n-\n-        from django.conf import settings\n-\n-    then the ``dictconfig`` module will raise an exception like the following::\n-\n-        ValueError: Unable to configure handler 'custom_handler':\n-        Unable to configure handler 'custom_handler':\n-        'module' object has no attribute 'logconfig'\n-\n .. _formatter documentation: http://docs.python.org/library/logging.html#formatter-objects\n \n Custom logging configuration"
        },
        {
            "sha": "8524aa2c24427494b7db223a43f925d2083e2458",
            "filename": "tests/regressiontests/logging_tests/logconfig.py",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/tests%2Fregressiontests%2Flogging_tests%2Flogconfig.py",
            "raw_url": "https://github.com/django/django/raw/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/tests%2Fregressiontests%2Flogging_tests%2Flogconfig.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Flogconfig.py?ref=fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015",
            "patch": "@@ -0,0 +1,7 @@\n+import logging\n+\n+from django.conf import settings\n+\n+class MyHandler(logging.Handler):\n+    def __init__(self, *args, **kwargs):\n+        self.config = settings.LOGGING"
        },
        {
            "sha": "a54b425f67fc4602af9748c6a91c9afcc5ba2c24",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=fc69fff9ab5bba8a6cff3eaf51f02a3204b1c015",
            "patch": "@@ -10,6 +10,8 @@\n from django.test.utils import override_settings\n from django.utils.log import CallbackFilter, RequireDebugFalse\n \n+from ..admin_scripts.tests import AdminScriptTestCase\n+\n \n # logging config prior to using filter with mail_admins\n OLD_LOGGING = {\n@@ -253,3 +255,30 @@ def test_truncate_subject(self):\n \n         self.assertEqual(len(mail.outbox), 1)\n         self.assertEqual(mail.outbox[0].subject, expected_subject)\n+\n+\n+class SettingsConfigTest(AdminScriptTestCase):\n+    \"\"\"\n+    Test that accessing settings in a custom logging handler does not trigger\n+    a circular import error.\n+    \"\"\"\n+    def setUp(self):\n+        log_config = \"\"\"{\n+    'version': 1,\n+    'handlers': {\n+        'custom_handler': {\n+            'level': 'INFO',\n+            'class': 'logging_tests.logconfig.MyHandler',\n+        }\n+    }\n+}\"\"\"\n+        self.write_settings('settings.py', sdict={'LOGGING': log_config})\n+\n+    def tearDown(self):\n+        self.remove_settings('settings.py')\n+\n+    def test_circular_dependency(self):\n+        # validate is just an example command to trigger settings configuration\n+        out, err = self.run_manage(['validate'])\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, \"0 errors found\")"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 52,
        "deletions": 44
    }
}