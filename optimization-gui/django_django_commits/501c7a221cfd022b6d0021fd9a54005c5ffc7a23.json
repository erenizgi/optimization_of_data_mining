{
    "author": "andrewgodwin",
    "message": "Merge pull request #573 from tominsam/master\n\nFixed #19070: urlize template filter raises exception in some cases",
    "sha": "501c7a221cfd022b6d0021fd9a54005c5ffc7a23",
    "files": [
        {
            "sha": "25605bea0448a5a07c129f26563016b8c11d8094",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/501c7a221cfd022b6d0021fd9a54005c5ffc7a23/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/501c7a221cfd022b6d0021fd9a54005c5ffc7a23/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=501c7a221cfd022b6d0021fd9a54005c5ffc7a23",
            "patch": "@@ -150,13 +150,17 @@ def fix_ampersands(value):\n def smart_urlquote(url):\n     \"Quotes a URL if it isn't already quoted.\"\n     # Handle IDN before quoting.\n-    scheme, netloc, path, query, fragment = urlsplit(url)\n     try:\n-        netloc = netloc.encode('idna').decode('ascii') # IDN -> ACE\n-    except UnicodeError: # invalid domain part\n+        scheme, netloc, path, query, fragment = urlsplit(url)\n+        try:\n+            netloc = netloc.encode('idna').decode('ascii') # IDN -> ACE\n+        except UnicodeError: # invalid domain part\n+            pass\n+        else:\n+            url = urlunsplit((scheme, netloc, path, query, fragment))\n+    except ValueError:\n+        # invalid IPv6 URL (normally square brackets in hostname part).\n         pass\n-    else:\n-        url = urlunsplit((scheme, netloc, path, query, fragment))\n \n     # An URL is considered unquoted if it contains no % characters or\n     # contains a % not followed by two hexadecimal digits. See #9655."
        },
        {
            "sha": "8596f8c8014df5af964ed10fdba4cf732ec27d3c",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/501c7a221cfd022b6d0021fd9a54005c5ffc7a23/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/501c7a221cfd022b6d0021fd9a54005c5ffc7a23/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=501c7a221cfd022b6d0021fd9a54005c5ffc7a23",
            "patch": "@@ -310,6 +310,10 @@ def test_urlize(self):\n         self.assertEqual(urlize('[see www.example.com]'),\n             '[see <a href=\"http://www.example.com\" rel=\"nofollow\">www.example.com</a>]' )\n \n+        # Check urlize doesn't crash when square bracket is prepended to url (#19070)\n+        self.assertEqual(urlize('see test[at[example.com'),\n+            'see <a href=\"http://test[at[example.com\" rel=\"nofollow\">test[at[example.com</a>' )\n+\n \n     def test_wordcount(self):\n         self.assertEqual(wordcount(''), 0)"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 13,
        "deletions": 5
    }
}