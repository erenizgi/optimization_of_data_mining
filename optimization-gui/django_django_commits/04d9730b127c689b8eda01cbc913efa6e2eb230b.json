{
    "author": "ramiro",
    "message": "Fixed #13085 -- Don't fail on creation of model with GFK to a model with __len__() returning zero.\n\nAlso, according to the comments on the ticket and its duplicates, added\ntests execising saving an instance of a model with a GFK to:\n\n* An unsaved object -- This actually doesn't generate the same failure\n  but another ORM-level exception. The test verifies it's the case.\n\n* An instance of a model with a __nonzero__() method thant returns False\n  for it. This doesn't fail because that code path isn't executed.\n\n* An instance of a model with a CharField PK and an empty value for it.\n  This doesn't fail.",
    "sha": "04d9730b127c689b8eda01cbc913efa6e2eb230b",
    "files": [
        {
            "sha": "20ff7042bc6e11f6eaa0c12f37fc08a55baa933d",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/04d9730b127c689b8eda01cbc913efa6e2eb230b/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/04d9730b127c689b8eda01cbc913efa6e2eb230b/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=04d9730b127c689b8eda01cbc913efa6e2eb230b",
            "patch": "@@ -43,7 +43,7 @@ def contribute_to_class(self, cls, name):\n \n     def instance_pre_init(self, signal, sender, args, kwargs, **_kwargs):\n         \"\"\"\n-        Handles initializing an object with the generic FK instaed of\n+        Handles initializing an object with the generic FK instead of\n         content-type/object-id fields.\n         \"\"\"\n         if self.name in kwargs:\n@@ -52,7 +52,7 @@ def instance_pre_init(self, signal, sender, args, kwargs, **_kwargs):\n             kwargs[self.fk_field] = value._get_pk_val()\n \n     def get_content_type(self, obj=None, id=None, using=None):\n-        if obj:\n+        if obj is not None:\n             return ContentType.objects.db_manager(obj._state.db).get_for_model(obj)\n         elif id:\n             return ContentType.objects.db_manager(using).get_for_id(id)"
        },
        {
            "sha": "2795471f7fb07532bfe25114f2b890879ada7952",
            "filename": "tests/regressiontests/generic_relations_regress/models.py",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/04d9730b127c689b8eda01cbc913efa6e2eb230b/tests%2Fregressiontests%2Fgeneric_relations_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/04d9730b127c689b8eda01cbc913efa6e2eb230b/tests%2Fregressiontests%2Fgeneric_relations_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_relations_regress%2Fmodels.py?ref=04d9730b127c689b8eda01cbc913efa6e2eb230b",
            "patch": "@@ -91,3 +91,34 @@ class Company(models.Model):\n \n     def __str__(self):\n         return \"Company: %s\" % self.name\n+\n+# For testing #13085 fix, we also use Note model defined above\n+class Developer(models.Model):\n+    name = models.CharField(max_length=15)\n+\n+@python_2_unicode_compatible\n+class Team(models.Model):\n+    name = models.CharField(max_length=15)\n+    members = models.ManyToManyField(Developer)\n+\n+    def __str__(self):\n+        return \"%s team\" % self.name\n+\n+    def __len__(self):\n+        return self.members.count()\n+\n+class Guild(models.Model):\n+    name = models.CharField(max_length=15)\n+    members = models.ManyToManyField(Developer)\n+\n+    def __nonzero__(self):\n+        return self.members.count()\n+\n+class Tag(models.Model):\n+    content_type = models.ForeignKey(ContentType, related_name='g_r_r_tags')\n+    object_id = models.CharField(max_length=15)\n+    content_object = generic.GenericForeignKey()\n+    label = models.CharField(max_length=15)\n+\n+class Board(models.Model):\n+    name = models.CharField(primary_key=True, max_length=15)"
        },
        {
            "sha": "b53129aa122e9440ce2093eae33409032bea3a02",
            "filename": "tests/regressiontests/generic_relations_regress/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/04d9730b127c689b8eda01cbc913efa6e2eb230b/tests%2Fregressiontests%2Fgeneric_relations_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/04d9730b127c689b8eda01cbc913efa6e2eb230b/tests%2Fregressiontests%2Fgeneric_relations_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_relations_regress%2Ftests.py?ref=04d9730b127c689b8eda01cbc913efa6e2eb230b",
            "patch": "@@ -1,8 +1,10 @@\n from django.db.models import Q\n+from django.db.utils import IntegrityError\n from django.test import TestCase\n \n from .models import (Address, Place, Restaurant, Link, CharLink, TextLink,\n-    Person, Contact, Note, Organization, OddRelation1, OddRelation2, Company)\n+    Person, Contact, Note, Organization, OddRelation1, OddRelation2, Company,\n+    Developer, Team, Guild, Tag, Board)\n \n \n class GenericRelationTests(TestCase):\n@@ -98,3 +100,39 @@ def count_places(place):\n         self.assertEqual(len(places), 2)\n         self.assertEqual(count_places(p1), 1)\n         self.assertEqual(count_places(p2), 1)\n+\n+    def test_target_model_is_unsaved(self):\n+        \"\"\"Test related to #13085\"\"\"\n+        # Fails with another, ORM-level error\n+        dev1 = Developer(name='Joe')\n+        note = Note(note='Deserves promotion', content_object=dev1)\n+        self.assertRaisesMessage(IntegrityError,\n+                \"generic_relations_regress_note.object_id may not be NULL\",\n+                note.save)\n+\n+    def test_target_model_len_zero(self):\n+        \"\"\"Test for #13085 -- __len__() returns 0\"\"\"\n+        team1 = Team.objects.create(name='Backend devs')\n+        try:\n+            note = Note(note='Deserve a bonus', content_object=team1)\n+        except Exception as e:\n+            if issubclass(type(e), Exception) and str(e) == 'Impossible arguments to GFK.get_content_type!':\n+                self.fail(\"Saving model with GenericForeignKey to model instance whose __len__ method returns 0 shouldn't fail.\")\n+            raise e\n+        note.save()\n+\n+    def test_target_model_nonzero_false(self):\n+        \"\"\"Test related to #13085\"\"\"\n+        # __nonzero__() returns False -- This actually doesn't currently fail.\n+        # This test validates that\n+        g1 = Guild.objects.create(name='First guild')\n+        note = Note(note='Note for guild', content_object=g1)\n+        note.save()\n+\n+    def test_gfk_to_model_with_empty_pk(self):\n+        \"\"\"Test related to #13085\"\"\"\n+        # Saving model with GenericForeignKey to model instance with an\n+        # empty CharField PK\n+        b1 = Board.objects.create(name='')\n+        tag = Tag(label='VP', content_object=b1)\n+        tag.save()"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 72,
        "deletions": 3
    }
}