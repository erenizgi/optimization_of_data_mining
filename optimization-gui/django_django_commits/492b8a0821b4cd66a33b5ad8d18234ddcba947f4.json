{
    "author": "freakboy3742",
    "message": "Fixed #13987 -- Ensure that the primary key is set correctly for all models that have concrete-abstract-concrete inheritance, not just the first model. Thanks to Aramgutang for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15498 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "492b8a0821b4cd66a33b5ad8d18234ddcba947f4",
    "files": [
        {
            "sha": "10617dc9e99bad0b6cd8e3736a40a37c53cd0d8d",
            "filename": "django/db/models/options.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/492b8a0821b4cd66a33b5ad8d18234ddcba947f4/django%2Fdb%2Fmodels%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/492b8a0821b4cd66a33b5ad8d18234ddcba947f4/django%2Fdb%2Fmodels%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Foptions.py?ref=492b8a0821b4cd66a33b5ad8d18234ddcba947f4",
            "patch": "@@ -123,6 +123,12 @@ def _prepare(self, model):\n                 # Promote the first parent link in lieu of adding yet another\n                 # field.\n                 field = self.parents.value_for_index(0)\n+                # Look for a local field with the same name as the\n+                # first parent link. If a local field has already been\n+                # created, use it instead of promoting the parent\n+                already_created = [fld for fld in self.local_fields if fld.name == field.name]\n+                if already_created:\n+                    field = already_created[0]\n                 field.primary_key = True\n                 self.setup_pk(field)\n             else:"
        },
        {
            "sha": "bb5d77c51fce5a13832109994d4dbe420eb0e314",
            "filename": "tests/regressiontests/model_inheritance_regress/models.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/492b8a0821b4cd66a33b5ad8d18234ddcba947f4/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/492b8a0821b4cd66a33b5ad8d18234ddcba947f4/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Fmodels.py?ref=492b8a0821b4cd66a33b5ad8d18234ddcba947f4",
            "patch": "@@ -146,3 +146,20 @@ class BachelorParty(AbstractEvent):\n \n class MessyBachelorParty(BachelorParty):\n     pass\n+\n+# Check concrete -> abstract -> concrete inheritance\n+class SearchableLocation(models.Model):\n+    keywords = models.CharField(max_length=256)\n+\n+class Station(SearchableLocation):\n+    name = models.CharField(max_length=128)\n+\n+    class Meta:\n+        abstract = True\n+\n+class BusStation(Station):\n+    bus_routes = models.CommaSeparatedIntegerField(max_length=128)\n+    inbound = models.BooleanField()\n+\n+class TrainStation(Station):\n+    zone = models.IntegerField()"
        },
        {
            "sha": "1bb147e17c1a3c37137076c03f074cbb4f5791c3",
            "filename": "tests/regressiontests/model_inheritance_regress/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/492b8a0821b4cd66a33b5ad8d18234ddcba947f4/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/492b8a0821b4cd66a33b5ad8d18234ddcba947f4/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_inheritance_regress%2Ftests.py?ref=492b8a0821b4cd66a33b5ad8d18234ddcba947f4",
            "patch": "@@ -11,7 +11,7 @@\n     ParkingLot2, ParkingLot3, Supplier, Wholesaler, Child, SelfRefParent,\n     SelfRefChild, ArticleWithAuthor, M2MChild, QualityControl, DerivedM,\n     Person, BirthdayParty, BachelorParty, MessyBachelorParty,\n-    InternalCertificationAudit)\n+    InternalCertificationAudit, BusStation, TrainStation)\n \n \n class ModelInheritanceTest(TestCase):\n@@ -358,7 +358,7 @@ def test_abstract_base_class_m2m_relation_inheritance(self):\n         parties = list(p4.bachelorparty_set.all())\n         self.assertEqual(parties, [bachelor, messy_parent])\n \n-    def test_11369(self):\n+    def test_abstract_verbose_name_plural_inheritance(self):\n         \"\"\"\n         verbose_name_plural correctly inherited from ABC if inheritance chain\n         includes an abstract model.\n@@ -386,3 +386,23 @@ def test_inherited_nullable_exclude(self):\n             ],\n             attrgetter(\"pk\")\n         )\n+\n+    def test_concrete_abstract_concrete_pk(self):\n+        \"\"\"\n+        Primary key set correctly with concrete->abstract->concrete inheritance.\n+        \"\"\"\n+        # Regression test for #13987: Primary key is incorrectly determined\n+        # when more than one model has a concrete->abstract->concrete\n+        # inheritance hierarchy.\n+        self.assertEquals(\n+            len([field for field in BusStation._meta.local_fields\n+                       if field.primary_key]),\n+            1\n+        )\n+        self.assertEquals(\n+            len([field for field in TrainStation._meta.local_fields\n+                       if field.primary_key]),\n+            1\n+        )\n+        self.assertIs(BusStation._meta.pk.model, BusStation)\n+        self.assertIs(TrainStation._meta.pk.model, TrainStation)"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 45,
        "deletions": 2
    }
}