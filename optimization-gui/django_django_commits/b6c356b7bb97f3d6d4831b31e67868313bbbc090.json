{
    "author": "akaariai",
    "message": "Fixed #17485 -- Made defer work with select_related\n\nThis commit tackles a couple of issues. First, in certain cases there\nwere some mixups if field.attname or field.name should be deferred.\nField.attname is now always used.\n\nAnother issue tackled is a case where field is both deferred by\n.only(), and selected by select_related. This case is now an error.\n\nA lot of thanks to koniiiik (Michal Petrucha) for the patch, and\nto Andrei Antoukh for review.",
    "sha": "b6c356b7bb97f3d6d4831b31e67868313bbbc090",
    "files": [
        {
            "sha": "0f1d87c642690900e0a28710f6be195d6e5d655e",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -1296,7 +1296,7 @@ def get_klass_info(klass, max_depth=0, cur_depth=0, requested=None,\n         # Build the list of fields that *haven't* been requested\n         for field, model in klass._meta.get_fields_with_model():\n             if field.name not in load_fields:\n-                skip.add(field.name)\n+                skip.add(field.attname)\n             elif local_only and model is not None:\n                 continue\n             else:\n@@ -1327,7 +1327,7 @@ def get_klass_info(klass, max_depth=0, cur_depth=0, requested=None,\n \n     related_fields = []\n     for f in klass._meta.fields:\n-        if select_related_descend(f, restricted, requested):\n+        if select_related_descend(f, restricted, requested, load_fields):\n             if restricted:\n                 next = requested[f.name]\n             else:\n@@ -1339,7 +1339,8 @@ def get_klass_info(klass, max_depth=0, cur_depth=0, requested=None,\n     reverse_related_fields = []\n     if restricted:\n         for o in klass._meta.get_all_related_objects():\n-            if o.field.unique and select_related_descend(o.field, restricted, requested, reverse=True):\n+            if o.field.unique and select_related_descend(o.field, restricted, requested,\n+                                                         only_load.get(o.model), reverse=True):\n                 next = requested[o.field.related_query_name()]\n                 klass_info = get_klass_info(o.model, max_depth=max_depth, cur_depth=cur_depth+1,\n                                             requested=next, only_load=only_load, local_only=True)"
        },
        {
            "sha": "60bdb2bcb4dbfe813cd68eb943347b905d2bbe04",
            "filename": "django/db/models/query_utils.py",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fquery_utils.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fquery_utils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery_utils.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -126,18 +126,19 @@ def _check_parent_chain(self, instance, name):\n         return None\n \n \n-def select_related_descend(field, restricted, requested, reverse=False):\n+def select_related_descend(field, restricted, requested, load_fields, reverse=False):\n     \"\"\"\n     Returns True if this field should be used to descend deeper for\n     select_related() purposes. Used by both the query construction code\n     (sql.query.fill_related_selections()) and the model instance creation code\n-    (query.get_cached_row()).\n+    (query.get_klass_info()).\n \n     Arguments:\n      * field - the field to be checked\n      * restricted - a boolean field, indicating if the field list has been\n        manually restricted using a requested clause)\n      * requested - The select_related() dictionary.\n+     * load_fields - the set of fields to be loaded on this model\n      * reverse - boolean, True if we are checking a reverse select related\n     \"\"\"\n     if not field.rel:\n@@ -151,6 +152,14 @@ def select_related_descend(field, restricted, requested, reverse=False):\n             return False\n     if not restricted and field.null:\n         return False\n+    if load_fields:\n+        if field.name not in load_fields:\n+            if restricted and field.name in requested:\n+                raise InvalidQuery(\"Field %s.%s cannot be both deferred\"\n+                                   \" and traversed using select_related\"\n+                                   \" at the same time.\" %\n+                                   (field.model._meta.object_name, field.name))\n+            return False\n     return True\n \n # This function is needed because data descriptors must be defined on a class"
        },
        {
            "sha": "d44cdfe4a4418d6ce3c8ed5de7ec4a1fb3421c34",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -596,6 +596,7 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n         if avoid_set is None:\n             avoid_set = set()\n         orig_dupe_set = dupe_set\n+        only_load = self.query.get_loaded_field_names()\n \n         # Setup for the case when only particular related fields should be\n         # included in the related selection.\n@@ -607,7 +608,8 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                 restricted = False\n \n         for f, model in opts.get_fields_with_model():\n-            if not select_related_descend(f, restricted, requested):\n+            if not select_related_descend(f, restricted, requested,\n+                                          only_load.get(model or self.query.model)):\n                 continue\n             # The \"avoid\" set is aliases we want to avoid just for this\n             # particular branch of the recursion. They aren't permanently\n@@ -680,7 +682,8 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                 if o.field.unique\n             ]\n             for f, model in related_fields:\n-                if not select_related_descend(f, restricted, requested, reverse=True):\n+                if not select_related_descend(f, restricted, requested,\n+                                              only_load.get(model), reverse=True):\n                     continue\n                 # The \"avoid\" set is aliases we want to avoid just for this\n                 # particular branch of the recursion. They aren't permanently"
        },
        {
            "sha": "8fbba3dbc954c5610e724a631064074a09bc5ce4",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -1845,9 +1845,15 @@ def get_loaded_field_names(self):\n \n         If no fields are marked for deferral, returns an empty dictionary.\n         \"\"\"\n-        collection = {}\n-        self.deferred_to_data(collection, self.get_loaded_field_names_cb)\n-        return collection\n+        # We cache this because we call this function multiple times\n+        # (compiler.fill_related_selections, query.iterator)\n+        try:\n+            return self._loaded_field_names_cache\n+        except AttributeError:\n+            collection = {}\n+            self.deferred_to_data(collection, self.get_loaded_field_names_cb)\n+            self._loaded_field_names_cache = collection\n+            return collection\n \n     def get_loaded_field_names_cb(self, target, model, fields):\n         \"\"\""
        },
        {
            "sha": "2876f1474d907a4ecd9f4e7af7901440f54cb045",
            "filename": "docs/ref/models/querysets.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/docs%2Fref%2Fmodels%2Fquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fmodels%2Fquerysets.txt?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -1081,11 +1081,13 @@ to ``defer()``::\n     # Load all fields immediately.\n     my_queryset.defer(None)\n \n+.. versionchanged:: 1.5\n+\n Some fields in a model won't be deferred, even if you ask for them. You can\n never defer the loading of the primary key. If you are using\n :meth:`select_related()` to retrieve related models, you shouldn't defer the\n-loading of the field that connects from the primary model to the related one\n-(at the moment, that doesn't raise an error, but it will eventually).\n+loading of the field that connects from the primary model to the related\n+one, doing so will result in an error.\n \n .. note::\n \n@@ -1145,9 +1147,12 @@ logically::\n     # existing set of fields).\n     Entry.objects.defer(\"body\").only(\"headline\", \"body\")\n \n+.. versionchanged:: 1.5\n+\n All of the cautions in the note for the :meth:`defer` documentation apply to\n ``only()`` as well. Use it cautiously and only after exhausting your other\n-options.\n+options. Also note that using :meth:`only` and omitting a field requested\n+using :meth:`select_related` is an error as well.\n \n using\n ~~~~~"
        },
        {
            "sha": "50db5a76b40ab4005939b6e84e58c61d6ce273cf",
            "filename": "tests/modeltests/defer/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fmodeltests%2Fdefer%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fmodeltests%2Fdefer%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fdefer%2Ftests.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -1,6 +1,6 @@\n from __future__ import absolute_import\n \n-from django.db.models.query_utils import DeferredAttribute\n+from django.db.models.query_utils import DeferredAttribute, InvalidQuery\n from django.test import TestCase\n \n from .models import Secondary, Primary, Child, BigChild, ChildProxy\n@@ -73,9 +73,19 @@ def test_defer(self):\n         self.assert_delayed(qs.defer(\"name\").get(pk=p1.pk), 1)\n         self.assert_delayed(qs.only(\"name\").get(pk=p1.pk), 2)\n \n-        # DOES THIS WORK?\n-        self.assert_delayed(qs.only(\"name\").select_related(\"related\")[0], 1)\n-        self.assert_delayed(qs.defer(\"related\").select_related(\"related\")[0], 0)\n+        # When we defer a field and also select_related it, the query is\n+        # invalid and raises an exception.\n+        with self.assertRaises(InvalidQuery):\n+            qs.only(\"name\").select_related(\"related\")[0]\n+        with self.assertRaises(InvalidQuery):\n+            qs.defer(\"related\").select_related(\"related\")[0]\n+\n+        # With a depth-based select_related, all deferred ForeignKeys are\n+        # deferred instead of traversed.\n+        with self.assertNumQueries(3):\n+            obj = qs.defer(\"related\").select_related()[0]\n+            self.assert_delayed(obj, 1)\n+            self.assertEqual(obj.related.id, s1.pk)\n \n         # Saving models with deferred fields is possible (but inefficient,\n         # since every field has to be retrieved first).\n@@ -155,7 +165,7 @@ def test_defer_proxy(self):\n         children = ChildProxy.objects.all().select_related().only('id', 'name')\n         self.assertEqual(len(children), 1)\n         child = children[0]\n-        self.assert_delayed(child, 1)\n+        self.assert_delayed(child, 2)\n         self.assertEqual(child.name, 'p1')\n         self.assertEqual(child.value, 'xx')\n "
        },
        {
            "sha": "bd4f845f276c30e975ff24f49ffd03c0082c3e56",
            "filename": "tests/regressiontests/defer_regress/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -47,3 +47,7 @@ def __unicode__(self):\n \n class Feature(models.Model):\n     item = models.ForeignKey(SimpleItem)\n+\n+class ItemAndSimpleItem(models.Model):\n+    item = models.ForeignKey(Item)\n+    simple = models.ForeignKey(SimpleItem)"
        },
        {
            "sha": "53bb59f5b35db6481a4880646fac8eff782e33fe",
            "filename": "tests/regressiontests/defer_regress/tests.py",
            "status": "modified",
            "additions": 24,
            "deletions": 2,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -9,7 +9,7 @@\n from django.test import TestCase\n \n from .models import (ResolveThis, Item, RelatedItem, Child, Leaf, Proxy,\n-    SimpleItem, Feature)\n+    SimpleItem, Feature, ItemAndSimpleItem)\n \n \n class DeferRegressionTest(TestCase):\n@@ -109,6 +109,7 @@ def test_basic(self):\n                 Child,\n                 Feature,\n                 Item,\n+                ItemAndSimpleItem,\n                 Leaf,\n                 Proxy,\n                 RelatedItem,\n@@ -125,12 +126,16 @@ def test_basic(self):\n                 ),\n             )\n         )\n+        # FIXME: This is dependent on the order in which tests are run --\n+        # this test case has to be the first, otherwise a LOT more classes\n+        # appear.\n         self.assertEqual(\n             klasses, [\n                 \"Child\",\n                 \"Child_Deferred_value\",\n                 \"Feature\",\n                 \"Item\",\n+                \"ItemAndSimpleItem\",\n                 \"Item_Deferred_name\",\n                 \"Item_Deferred_name_other_value_text\",\n                 \"Item_Deferred_name_other_value_value\",\n@@ -139,7 +144,7 @@ def test_basic(self):\n                 \"Leaf\",\n                 \"Leaf_Deferred_child_id_second_child_id_value\",\n                 \"Leaf_Deferred_name_value\",\n-                \"Leaf_Deferred_second_child_value\",\n+                \"Leaf_Deferred_second_child_id_value\",\n                 \"Leaf_Deferred_value\",\n                 \"Proxy\",\n                 \"RelatedItem\",\n@@ -175,6 +180,23 @@ def test_resolve_columns(self):\n         self.assertEqual(1, qs.count())\n         self.assertEqual('Foobar', qs[0].name)\n \n+    def test_defer_with_select_related(self):\n+        item1 = Item.objects.create(name=\"first\", value=47)\n+        item2 = Item.objects.create(name=\"second\", value=42)\n+        simple = SimpleItem.objects.create(name=\"simple\", value=\"23\")\n+        related = ItemAndSimpleItem.objects.create(item=item1, simple=simple)\n+\n+        obj = ItemAndSimpleItem.objects.defer('item').select_related('simple').get()\n+        self.assertEqual(obj.item, item1)\n+        self.assertEqual(obj.item_id, item1.id)\n+\n+        obj.item = item2\n+        obj.save()\n+\n+        obj = ItemAndSimpleItem.objects.defer('item').select_related('simple').get()\n+        self.assertEqual(obj.item, item2)\n+        self.assertEqual(obj.item_id, item2.id)\n+\n     def test_deferred_class_factory(self):\n         from django.db.models.query_utils import deferred_class_factory\n         new_class = deferred_class_factory(Item,"
        },
        {
            "sha": "73b0a8a8758d6a7a038726f40ddb916a730b2776",
            "filename": "tests/regressiontests/select_related_regress/tests.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fregressiontests%2Fselect_related_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b6c356b7bb97f3d6d4831b31e67868313bbbc090/tests%2Fregressiontests%2Fselect_related_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fselect_related_regress%2Ftests.py?ref=b6c356b7bb97f3d6d4831b31e67868313bbbc090",
            "patch": "@@ -133,7 +133,7 @@ def test_regression_12851(self):\n         self.assertEqual(troy.state.name, 'Western Australia')\n \n         # Also works if you use only, rather than defer\n-        troy = SpecialClient.objects.select_related('state').only('name').get(name='Troy Buswell')\n+        troy = SpecialClient.objects.select_related('state').only('name', 'state').get(name='Troy Buswell')\n \n         self.assertEqual(troy.name, 'Troy Buswell')\n         self.assertEqual(troy.value, 42)"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 81,
        "deletions": 21
    }
}