{
    "author": "ramiro",
    "message": "Refactored the internals of makemessages management command for better readability.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17261 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7c6e265a9f5e084f383532abef7624cca08c8071",
    "files": [
        {
            "sha": "95c1da04b5f606693e5f2dc296e591e40ee55391",
            "filename": "django/core/management/commands/makemessages.py",
            "status": "modified",
            "additions": 165,
            "deletions": 143,
            "changes": 308,
            "blob_url": "https://github.com/django/django/blob/7c6e265a9f5e084f383532abef7624cca08c8071/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "raw_url": "https://github.com/django/django/raw/7c6e265a9f5e084f383532abef7624cca08c8071/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fmakemessages.py?ref=7c6e265a9f5e084f383532abef7624cca08c8071",
            "patch": "@@ -112,14 +112,149 @@ def copy_plural_forms(msgs, locale, domain, verbosity):\n                 break\n     return msgs\n \n+def write_pot_file(potfile, msgs, file, work_file, is_templatized):\n+    \"\"\"\n+    Write the :param potfile: POT file with the :param msgs: contents,\n+    previously making sure its format is valid.\n+    \"\"\"\n+    if is_templatized:\n+        old = '#: ' + work_file[2:]\n+        new = '#: ' + file[2:]\n+        msgs = msgs.replace(old, new)\n+    if os.path.exists(potfile):\n+        # Strip the header\n+        msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n+    else:\n+        msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n+    f = open(potfile, 'ab')\n+    try:\n+        f.write(msgs)\n+    finally:\n+        f.close()\n+\n+def process_file(file, dirpath, potfile, domain, verbosity, extensions, wrap,\n+        location):\n+    \"\"\"\n+    Extract translatable literals from :param file: for :param domain:\n+    creating or updating the :param potfile: POT file.\n+\n+    Uses the xgettext GNU gettext utility.\n+    \"\"\"\n+\n+    from django.utils.translation import templatize\n+\n+    if verbosity > 1:\n+        sys.stdout.write('processing file %s in %s\\n' % (file, dirpath))\n+    _, file_ext = os.path.splitext(file)\n+    if domain == 'djangojs' and file_ext in extensions:\n+        is_templatized = True\n+        orig_file = os.path.join(dirpath, file)\n+        src_data = open(orig_file).read()\n+        src_data = prepare_js_for_gettext(src_data)\n+        thefile = '%s.c' % file\n+        work_file = os.path.join(dirpath, thefile)\n+        f = open(work_file, \"w\")\n+        try:\n+            f.write(src_data)\n+        finally:\n+            f.close()\n+        cmd = (\n+            'xgettext -d %s -L C %s %s --keyword=gettext_noop '\n+            '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n+            '--keyword=pgettext:1c,2 --keyword=npgettext:1c,2,3 '\n+            '--from-code UTF-8 --add-comments=Translators -o - \"%s\"' % (\n+                domain, wrap, location, work_file\n+            )\n+        )\n+    elif domain == 'django' and (file_ext == '.py' or file_ext in extensions):\n+        thefile = file\n+        orig_file = os.path.join(dirpath, file)\n+        is_templatized = file_ext in extensions\n+        if is_templatized:\n+            src_data = open(orig_file, \"rU\").read()\n+            thefile = '%s.py' % file\n+            content = templatize(src_data, orig_file[2:])\n+            f = open(os.path.join(dirpath, thefile), \"w\")\n+            try:\n+                f.write(content)\n+            finally:\n+                f.close()\n+        work_file = os.path.join(dirpath, thefile)\n+        cmd = (\n+            'xgettext -d %s -L Python %s %s --keyword=gettext_noop '\n+            '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n+            '--keyword=ugettext_noop --keyword=ugettext_lazy '\n+            '--keyword=ungettext_lazy:1,2 --keyword=pgettext:1c,2 '\n+            '--keyword=npgettext:1c,2,3 --keyword=pgettext_lazy:1c,2 '\n+            '--keyword=npgettext_lazy:1c,2,3 --from-code UTF-8 '\n+            '--add-comments=Translators -o - \"%s\"' % (\n+                domain, wrap, location, work_file)\n+        )\n+    else:\n+        return\n+    msgs, errors = _popen(cmd)\n+    if errors:\n+        if is_templatized:\n+            os.unlink(work_file)\n+        if os.path.exists(potfile):\n+            os.unlink(potfile)\n+        raise CommandError(\n+            \"errors happened while running xgettext on %s\\n%s\" %\n+            (file, errors))\n+    if msgs:\n+        write_pot_file(potfile, msgs, orig_file, work_file, is_templatized)\n+    if is_templatized:\n+        os.unlink(work_file)\n+\n+def write_po_file(pofile, potfile, domain, locale, verbosity,\n+        copy_pforms, wrap, location, no_obsolete):\n+    \"\"\"\n+    Creates of updates the :param pofile: PO file for :param domain: and :param\n+    locale:.  Uses contents of the existing :param potfile:.\n+\n+    Uses mguniq, msgmerge, and msgattrib GNU gettext utilities.\n+    \"\"\"\n+    msgs, errors = _popen('msguniq %s %s --to-code=utf-8 \"%s\"' %\n+                            (wrap, location, potfile))\n+    if errors:\n+        os.unlink(potfile)\n+        raise CommandError(\"errors happened while running msguniq\\n%s\" % errors)\n+    if os.path.exists(pofile):\n+        f = open(potfile, 'w')\n+        try:\n+            f.write(msgs)\n+        finally:\n+            f.close()\n+        msgs, errors = _popen('msgmerge %s %s -q \"%s\" \"%s\"' %\n+                                (wrap, location, pofile, potfile))\n+        if errors:\n+            os.unlink(potfile)\n+            raise CommandError(\n+                \"errors happened while running msgmerge\\n%s\" % errors)\n+    elif copy_pforms:\n+        msgs = copy_plural_forms(msgs, locale, domain, verbosity)\n+    msgs = msgs.replace(\n+        \"#. #-#-#-#-#  %s.pot (PACKAGE VERSION)  #-#-#-#-#\\n\" % domain, \"\")\n+    f = open(pofile, 'wb')\n+    try:\n+        f.write(msgs)\n+    finally:\n+        f.close()\n+    os.unlink(potfile)\n+    if no_obsolete:\n+        msgs, errors = _popen('msgattrib %s %s -o \"%s\" --no-obsolete \"%s\"' %\n+                                (wrap, location, pofile, pofile))\n+        if errors:\n+            raise CommandError(\n+                \"errors happened while running msgattrib\\n%s\" % errors)\n \n-def make_messages(locale=None, domain='django', verbosity='1', all=False,\n-        extensions=None, symlinks=False, ignore_patterns=[], no_wrap=False,\n-        no_location=False,\n-        no_obsolete=False):\n+def make_messages(locale=None, domain='django', verbosity=1, all=False,\n+        extensions=None, symlinks=False, ignore_patterns=None, no_wrap=False,\n+        no_location=False, no_obsolete=False):\n     \"\"\"\n-    Uses the locale directory from the Django SVN tree or an application/\n-    project to process all\n+    Uses the ``locale/`` directory from the Django SVN tree or an\n+    application/project to process all files with translatable literals for\n+    the :param domain: domain and :param locale: locale.\n     \"\"\"\n     # Need to ensure that the i18n framework is enabled\n     from django.conf import settings\n@@ -128,7 +263,8 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n     else:\n         settings.configure(USE_I18N = True)\n \n-    from django.utils.translation import templatize\n+    if ignore_patterns is None:\n+        ignore_patterns = []\n \n     invoked_for_django = False\n     if os.path.isdir(os.path.join('conf', 'locale')):\n@@ -139,7 +275,13 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n     elif os.path.isdir('locale'):\n         localedir = os.path.abspath('locale')\n     else:\n-        raise CommandError(\"This script should be run from the Django SVN tree or your project or app tree. If you did indeed run it from the SVN checkout or your project or application, maybe you are just missing the conf/locale (in the django tree) or locale (for project and application) directory? It is not created automatically, you have to create it by hand if you want to enable i18n for your project or application.\")\n+        raise CommandError(\"This script should be run from the Django SVN \"\n+                \"tree or your project or app tree. If you did indeed run it \"\n+                \"from the SVN checkout or your project or application, \"\n+                \"maybe you are just missing the conf/locale (in the django \"\n+                \"tree) or locale (for project and application) directory? It \"\n+                \"is not created automatically, you have to create it by hand \"\n+                \"if you want to enable i18n for your project or application.\")\n \n     if domain not in ('django', 'djangojs'):\n         raise CommandError(\"currently makemessages only supports domains 'django' and 'djangojs'\")\n@@ -154,19 +296,21 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n     if match:\n         xversion = (int(match.group('major')), int(match.group('minor')))\n         if xversion < (0, 15):\n-            raise CommandError(\"Django internationalization requires GNU gettext 0.15 or newer. You are using version %s, please upgrade your gettext toolset.\" % match.group())\n+            raise CommandError(\"Django internationalization requires GNU \"\n+                    \"gettext 0.15 or newer. You are using version %s, please \"\n+                    \"upgrade your gettext toolset.\" % match.group())\n \n-    languages = []\n+    locales = []\n     if locale is not None:\n-        languages.append(locale)\n+        locales.append(locale)\n     elif all:\n         locale_dirs = filter(os.path.isdir, glob.glob('%s/*' % localedir))\n-        languages = [os.path.basename(l) for l in locale_dirs]\n+        locales = [os.path.basename(l) for l in locale_dirs]\n \n-    wrap = no_wrap and '--no-wrap' or ''\n-    location = no_location and '--no-location' or ''\n+    wrap = '--no-wrap' if no_wrap else ''\n+    location = '--no-location' if no_location else ''\n \n-    for locale in languages:\n+    for locale in locales:\n         if verbosity > 0:\n             print \"processing language\", locale\n         basedir = os.path.join(localedir, locale, 'LC_MESSAGES')\n@@ -179,136 +323,14 @@ def make_messages(locale=None, domain='django', verbosity='1', all=False,\n         if os.path.exists(potfile):\n             os.unlink(potfile)\n \n-        for dirpath, file in find_files(\".\", ignore_patterns, verbosity, symlinks=symlinks):\n-            file_base, file_ext = os.path.splitext(file)\n-            if domain == 'djangojs' and file_ext in extensions:\n-                if verbosity > 1:\n-                    sys.stdout.write('processing file %s in %s\\n' % (file, dirpath))\n-                src = open(os.path.join(dirpath, file), \"rU\").read()\n-                src = prepare_js_for_gettext(src)\n-                thefile = '%s.c' % file\n-                f = open(os.path.join(dirpath, thefile), \"w\")\n-                try:\n-                    f.write(src)\n-                finally:\n-                    f.close()\n-                cmd = (\n-                    'xgettext -d %s -L C %s %s --keyword=gettext_noop '\n-                    '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n-                    '--keyword=pgettext:1c,2 --keyword=npgettext:1c,2,3 '\n-                    '--from-code UTF-8 --add-comments=Translators -o - \"%s\"' % (\n-                        domain, wrap, location, os.path.join(dirpath, thefile)\n-                    )\n-                )\n-                msgs, errors = _popen(cmd)\n-                if errors:\n-                    os.unlink(os.path.join(dirpath, thefile))\n-                    if os.path.exists(potfile):\n-                        os.unlink(potfile)\n-                    raise CommandError(\n-                        \"errors happened while running xgettext on %s\\n%s\" %\n-                        (file, errors))\n-                if msgs:\n-                    old = '#: ' + os.path.join(dirpath, thefile)[2:]\n-                    new = '#: ' + os.path.join(dirpath, file)[2:]\n-                    msgs = msgs.replace(old, new)\n-                    if os.path.exists(potfile):\n-                        # Strip the header\n-                        msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n-                    else:\n-                        msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n-                    f = open(potfile, 'ab')\n-                    try:\n-                        f.write(msgs)\n-                    finally:\n-                        f.close()\n-                os.unlink(os.path.join(dirpath, thefile))\n-            elif domain == 'django' and (file_ext == '.py' or file_ext in extensions):\n-                thefile = file\n-                orig_file = os.path.join(dirpath, file)\n-                if file_ext in extensions:\n-                    src = open(orig_file, \"rU\").read()\n-                    thefile = '%s.py' % file\n-                    content = templatize(src, orig_file[2:])\n-                    f = open(os.path.join(dirpath, thefile), \"w\")\n-                    try:\n-                        f.write(content)\n-                    finally:\n-                        f.close()\n-                if verbosity > 1:\n-                    sys.stdout.write('processing file %s in %s\\n' % (file, dirpath))\n-                cmd = (\n-                    'xgettext -d %s -L Python %s %s --keyword=gettext_noop '\n-                    '--keyword=gettext_lazy --keyword=ngettext_lazy:1,2 '\n-                    '--keyword=ugettext_noop --keyword=ugettext_lazy '\n-                    '--keyword=ungettext_lazy:1,2 --keyword=pgettext:1c,2 '\n-                    '--keyword=npgettext:1c,2,3 --keyword=pgettext_lazy:1c,2 '\n-                    '--keyword=npgettext_lazy:1c,2,3 --from-code UTF-8 '\n-                    '--add-comments=Translators -o - \"%s\"' % (\n-                        domain, wrap, location, os.path.join(dirpath, thefile))\n-                )\n-                msgs, errors = _popen(cmd)\n-                if errors:\n-                    if thefile != file:\n-                        os.unlink(os.path.join(dirpath, thefile))\n-                    if os.path.exists(potfile):\n-                        os.unlink(potfile)\n-                    raise CommandError(\n-                        \"errors happened while running xgettext on %s\\n%s\" %\n-                        (file, errors))\n-                if msgs:\n-                    if thefile != file:\n-                        old = '#: ' + os.path.join(dirpath, thefile)[2:]\n-                        new = '#: ' + orig_file[2:]\n-                        msgs = msgs.replace(old, new)\n-                    if os.path.exists(potfile):\n-                        # Strip the header\n-                        msgs = '\\n'.join(dropwhile(len, msgs.split('\\n')))\n-                    else:\n-                        msgs = msgs.replace('charset=CHARSET', 'charset=UTF-8')\n-                    f = open(potfile, 'ab')\n-                    try:\n-                        f.write(msgs)\n-                    finally:\n-                        f.close()\n-                if thefile != file:\n-                    os.unlink(os.path.join(dirpath, thefile))\n+        for dirpath, file in find_files(\".\", ignore_patterns, verbosity,\n+                symlinks=symlinks):\n+            process_file(file, dirpath, potfile, domain, verbosity, extensions,\n+                    wrap, location)\n \n         if os.path.exists(potfile):\n-            msgs, errors = _popen('msguniq %s %s --to-code=utf-8 \"%s\"' %\n-                                  (wrap, location, potfile))\n-            if errors:\n-                os.unlink(potfile)\n-                raise CommandError(\n-                    \"errors happened while running msguniq\\n%s\" % errors)\n-            if os.path.exists(pofile):\n-                f = open(potfile, 'w')\n-                try:\n-                    f.write(msgs)\n-                finally:\n-                    f.close()\n-                msgs, errors = _popen('msgmerge %s %s -q \"%s\" \"%s\"' %\n-                                      (wrap, location, pofile, potfile))\n-                if errors:\n-                    os.unlink(potfile)\n-                    raise CommandError(\n-                        \"errors happened while running msgmerge\\n%s\" % errors)\n-            elif not invoked_for_django:\n-                msgs = copy_plural_forms(msgs, locale, domain, verbosity)\n-            msgs = msgs.replace(\n-                \"#. #-#-#-#-#  %s.pot (PACKAGE VERSION)  #-#-#-#-#\\n\" % domain, \"\")\n-            f = open(pofile, 'wb')\n-            try:\n-                f.write(msgs)\n-            finally:\n-                f.close()\n-            os.unlink(potfile)\n-            if no_obsolete:\n-                msgs, errors = _popen('msgattrib %s %s -o \"%s\" --no-obsolete \"%s\"' %\n-                                      (wrap, location, pofile, pofile))\n-                if errors:\n-                    raise CommandError(\n-                        \"errors happened while running msgattrib\\n%s\" % errors)\n+            write_po_file(pofile, potfile, domain, locale, verbosity,\n+                    not invoked_for_django, wrap, location, no_obsolete)\n \n \n class Command(NoArgsCommand):"
        }
    ],
    "stats": {
        "total": 308,
        "additions": 165,
        "deletions": 143
    }
}