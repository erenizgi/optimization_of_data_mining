{
    "author": "ramiro",
    "message": "Fixed #13668 -- Corrected database router methods invocation for ManyToMany fields without through models. Thanks craig.kimerer for the report and David Gouldin for the fix.\n\nThis also adds tests for r14857.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15185 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e1ede214e6dd0fc988fa572d8be45231c275970c",
    "files": [
        {
            "sha": "f2adc7af0c53c3815ddab864d2313cafb8a23307",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/e1ede214e6dd0fc988fa572d8be45231c275970c/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/e1ede214e6dd0fc988fa572d8be45231c275970c/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=e1ede214e6dd0fc988fa572d8be45231c275970c",
            "patch": "@@ -555,7 +555,7 @@ def _add_items(self, source_field_name, target_field_name, *objs):\n                         raise TypeError(\"'%s' instance expected\" % self.model._meta.object_name)\n                     else:\n                         new_ids.add(obj)\n-                db = router.db_for_write(self.through.__class__, instance=self.instance)\n+                db = router.db_for_write(self.through, instance=self.instance)\n                 vals = self.through._default_manager.using(db).values_list(target_field_name, flat=True)\n                 vals = vals.filter(**{\n                     source_field_name: self._pk_val,\n@@ -597,7 +597,7 @@ def _remove_items(self, source_field_name, target_field_name, *objs):\n                     else:\n                         old_ids.add(obj)\n                 # Work out what DB we're operating on\n-                db = router.db_for_write(self.through.__class__, instance=self.instance)\n+                db = router.db_for_write(self.through, instance=self.instance)\n                 # Send a signal to the other end if need be.\n                 if self.reverse or source_field_name == self.source_field_name:\n                     # Don't send the signal when we are deleting the\n@@ -618,7 +618,7 @@ def _remove_items(self, source_field_name, target_field_name, *objs):\n                         model=self.model, pk_set=old_ids, using=db)\n \n         def _clear_items(self, source_field_name):\n-            db = router.db_for_write(self.through.__class__, instance=self.instance)\n+            db = router.db_for_write(self.through, instance=self.instance)\n             # source_col_name: the PK colname in join_table for the source object\n             if self.reverse or source_field_name == self.source_field_name:\n                 # Don't send the signal when we are clearing the"
        },
        {
            "sha": "69bb7efd85a68b2064e3b99cf935714e8c4cfb3c",
            "filename": "tests/regressiontests/multiple_database/tests.py",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/django/django/blob/e1ede214e6dd0fc988fa572d8be45231c275970c/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e1ede214e6dd0fc988fa572d8be45231c275970c/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py?ref=e1ede214e6dd0fc988fa572d8be45231c275970c",
            "patch": "@@ -1791,3 +1791,56 @@ def test_database_arg_m2m(self):\n         b.authors.clear()\n         self._write_to_default()\n         self.assertEqual(receiver._database, \"other\")\n+\n+class AttributeErrorRouter(object):\n+    \"A router to test the exception handling of ConnectionRouter\"\n+    def db_for_read(self, model, **hints):\n+        raise AttributeError\n+\n+    def db_for_write(self, model, **hints):\n+        raise AttributeError\n+\n+class RouterAttributeErrorTestCase(TestCase):\n+    multi_db = True\n+\n+    def setUp(self):\n+        self.old_routers = router.routers\n+        router.routers = [AttributeErrorRouter()]\n+\n+    def tearDown(self):\n+        router.routers = self.old_routers\n+\n+    def test_attribute_error(self):\n+        \"Check that the AttributeError from AttributeErrorRouter bubbles up\"\n+        dive = Book()\n+        dive.title=\"Dive into Python\"\n+        dive.published = datetime.date(2009, 5, 4)\n+        self.assertRaises(AttributeError, dive.save)\n+\n+class ModelMetaRouter(object):\n+    \"A router to ensure model arguments are real model classes\"\n+    def db_for_write(self, model, **hints):\n+        if not hasattr(model, '_meta'):\n+            raise ValueError\n+\n+class RouterM2MThroughTestCase(TestCase):\n+    multi_db = True\n+\n+    def setUp(self):\n+        self.old_routers = router.routers\n+        router.routers = [ModelMetaRouter()]\n+\n+    def tearDown(self):\n+        router.routers = self.old_routers\n+\n+    def test_m2m_through(self):\n+        b = Book.objects.create(title=\"Pro Django\",\n+                                published=datetime.date(2008, 12, 16))\n+\n+        p = Person.objects.create(name=\"Marty Alchin\")\n+        # test add\n+        b.authors.add(p)\n+        # test remove\n+        b.authors.remove(p)\n+        # test clear\n+        b.authors.clear()"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 56,
        "deletions": 3
    }
}