{
    "author": "spookylukey",
    "message": "Fixed #15709 - Duplicated group_by condition\n\nThanks to ziangsong for report, and to mk for the patch\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16180 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "385ae343fbd2355a09ba0f459445bf04406db60b",
    "files": [
        {
            "sha": "841ec12f2d59e27224e1559e5afb7f482aa56057",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/385ae343fbd2355a09ba0f459445bf04406db60b/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/385ae343fbd2355a09ba0f459445bf04406db60b/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=385ae343fbd2355a09ba0f459445bf04406db60b",
            "patch": "@@ -493,7 +493,11 @@ def get_grouping(self):\n                 params.extend(extra_params)\n             cols = (group_by + self.query.select +\n                 self.query.related_select_cols + extra_selects)\n+            seen = set()\n             for col in cols:\n+                if col in seen:\n+                    continue\n+                seen.add(col)\n                 if isinstance(col, (list, tuple)):\n                     result.append('%s.%s' % (qn(col[0]), qn(col[1])))\n                 elif hasattr(col, 'as_sql'):"
        },
        {
            "sha": "14104210afbf211c5effcbd886fe5d34e0299bb6",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/385ae343fbd2355a09ba0f459445bf04406db60b/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/385ae343fbd2355a09ba0f459445bf04406db60b/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=385ae343fbd2355a09ba0f459445bf04406db60b",
            "patch": "@@ -462,6 +462,12 @@ def test_more_more(self):\n             lambda b: b.name\n         )\n \n+        # Regression for #15709 - Ensure each group_by field only exists once\n+        # per query\n+        qs = Book.objects.values('publisher').annotate(max_pages=Max('pages')).order_by()\n+        grouping, gb_params = qs.query.get_compiler(qs.db).get_grouping()\n+        self.assertEqual(len(grouping), 1)\n+\n     def test_duplicate_alias(self):\n         # Regression for #11256 - duplicating a default alias raises ValueError.\n         self.assertRaises(ValueError, Book.objects.all().annotate, Avg('authors__age'), authors__age__avg=Avg('authors__age'))"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 10,
        "deletions": 0
    }
}