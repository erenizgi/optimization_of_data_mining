{
    "author": "SmileyChris",
    "message": "Fixes #8593 -- better handling of safe_join case sensitivity on windows. Thanks for the initial patch, ramiro.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16267 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "fcf7fbc68cadb7efd8bc779c0e189389d6475463",
    "files": [
        {
            "sha": "2c7b88e2c3da04316e3111a608cda7f2176e81de",
            "filename": "django/utils/_os.py",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/fcf7fbc68cadb7efd8bc779c0e189389d6475463/django%2Futils%2F_os.py",
            "raw_url": "https://github.com/django/django/raw/fcf7fbc68cadb7efd8bc779c0e189389d6475463/django%2Futils%2F_os.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2F_os.py?ref=fcf7fbc68cadb7efd8bc779c0e189389d6475463",
            "patch": "@@ -30,17 +30,16 @@ def safe_join(base, *paths):\n     The final path must be located inside of the base path component (otherwise\n     a ValueError is raised).\n     \"\"\"\n-    # We need to use normcase to ensure we don't false-negative on case\n-    # insensitive operating systems (like Windows).\n     base = force_unicode(base)\n     paths = [force_unicode(p) for p in paths]\n-    final_path = normcase(abspathu(join(base, *paths)))\n-    base_path = normcase(abspathu(base))\n+    final_path = abspathu(join(base, *paths))\n+    base_path = abspathu(base)\n     base_path_len = len(base_path)\n-    # Ensure final_path starts with base_path and that the next character after\n-    # the final path is os.sep (or nothing, in which case final_path must be\n-    # equal to base_path).\n-    if not final_path.startswith(base_path) \\\n+    # Ensure final_path starts with base_path (using normcase to ensure we\n+    # don't false-negative on case insensitive operating systems like Windows)\n+    # and that the next character after the final path is os.sep (or nothing,\n+    # in which case final_path must be equal to base_path).\n+    if not normcase(final_path).startswith(normcase(base_path)) \\\n        or final_path[base_path_len:base_path_len+1] not in ('', sep):\n         raise ValueError('The joined path (%s) is located outside of the base '\n                          'path component (%s)' % (final_path, base_path))"
        },
        {
            "sha": "cdec1879eae1ace6ad9994026969ecec705799c4",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=fcf7fbc68cadb7efd8bc779c0e189389d6475463",
            "patch": "@@ -90,13 +90,16 @@ class FileStorageTests(unittest.TestCase):\n     storage_class = FileSystemStorage\n \n     def setUp(self):\n-        self.temp_dir = tempfile.mktemp()\n-        os.makedirs(self.temp_dir)\n+        self.temp_dir = tempfile.mkdtemp()\n         self.storage = self.storage_class(location=self.temp_dir,\n             base_url='/test_media_url/')\n+        # Set up a second temporary directory which is ensured to have a mixed\n+        # case name.\n+        self.temp_dir2 = tempfile.mkdtemp(suffix='aBc')\n \n     def tearDown(self):\n         shutil.rmtree(self.temp_dir)\n+        shutil.rmtree(self.temp_dir2)\n \n     def test_file_access_options(self):\n         \"\"\"\n@@ -265,6 +268,20 @@ def test_file_storage_prevents_directory_traversal(self):\n         self.assertRaises(SuspiciousOperation, self.storage.exists, '..')\n         self.assertRaises(SuspiciousOperation, self.storage.exists, '/etc/passwd')\n \n+    def test_file_storage_preserves_filename_case(self):\n+        \"\"\"The storage backend should preserve case of filenames.\"\"\"\n+        # Create a storage backend associated with the mixed case name\n+        # directory.\n+        temp_storage = self.storage_class(location=self.temp_dir2)\n+        # Ask that storage backend to store a file with a mixed case filename.\n+        mixed_case = 'CaSe_SeNsItIvE'\n+        file = temp_storage.open(mixed_case, 'w')\n+        file.write('storage contents')\n+        file.close()\n+        self.assertEqual(os.path.join(self.temp_dir2, mixed_case),\n+                         temp_storage.path(mixed_case))\n+        temp_storage.delete(mixed_case)\n+\n class CustomStorage(FileSystemStorage):\n     def get_available_name(self, name):\n         \"\"\""
        },
        {
            "sha": "d42e0279a74058ee1b1ee1d3766e47a36e3eae16",
            "filename": "tests/regressiontests/file_uploads/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py?ref=fcf7fbc68cadb7efd8bc779c0e189389d6475463",
            "patch": "@@ -278,6 +278,37 @@ def handle_uncaught_exception(self, request, resolver, exc_info):\n             # CustomUploadError is the error that should have been raised\n             self.assertEqual(err.__class__, uploadhandler.CustomUploadError)\n \n+    def test_filename_case_preservation(self):\n+        \"\"\"\n+        The storage backend shouldn't mess with the case of the filenames\n+        uploaded.\n+        \"\"\"\n+        # Synthesize the contents of a file upload with a mixed case filename\n+        # so we don't have to carry such a file in the Django tests source code\n+        # tree.\n+        vars = {'boundary': 'oUrBoUnDaRyStRiNg'}\n+        post_data = [\n+            '--%(boundary)s',\n+            'Content-Disposition: form-data; name=\"file_field\"; '\n+                'filename=\"MiXeD_cAsE.txt\"',\n+            'Content-Type: application/octet-stream',\n+            '',\n+            'file contents\\n'\n+            '',\n+            '--%(boundary)s--\\r\\n',\n+        ]\n+        response = self.client.post(\n+            '/file_uploads/filename_case/',\n+            '\\r\\n'.join(post_data) % vars,\n+            'multipart/form-data; boundary=%(boundary)s' % vars\n+        )\n+        self.assertEqual(response.status_code, 200)\n+        id = int(response.content)\n+        obj = FileModel.objects.get(pk=id)\n+        # The name of the file uploaded and the file stored in the server-side\n+        # shouldn't differ.\n+        self.assertEqual(os.path.basename(obj.testfile.path), 'MiXeD_cAsE.txt')\n+\n class DirectoryCreationTests(unittest.TestCase):\n     \"\"\"\n     Tests for error handling during directory creation"
        },
        {
            "sha": "a5c2702311eb9b10f45eed43c187c66f80878c41",
            "filename": "tests/regressiontests/file_uploads/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_uploads%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_uploads%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Furls.py?ref=fcf7fbc68cadb7efd8bc779c0e189389d6475463",
            "patch": "@@ -11,4 +11,5 @@\n     (r'^quota/broken/$',    views.file_upload_quota_broken),\n     (r'^getlist_count/$',   views.file_upload_getlist_count),\n     (r'^upload_errors/$',   views.file_upload_errors),\n+    (r'^filename_case/$',   views.file_upload_filename_case_view),\n )"
        },
        {
            "sha": "c88c77548a9ad66ee9a172bc9be80bc6691200df",
            "filename": "tests/regressiontests/file_uploads/views.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py?ref=fcf7fbc68cadb7efd8bc779c0e189389d6475463",
            "patch": "@@ -120,3 +120,12 @@ def file_upload_getlist_count(request):\n def file_upload_errors(request):\n     request.upload_handlers.insert(0, ErroringUploadHandler())\n     return file_upload_echo(request)\n+\n+def file_upload_filename_case_view(request):\n+    \"\"\"\n+    Check adding the file to the database will preserve the filename case.\n+    \"\"\"\n+    file = request.FILES['file_field']\n+    obj = FileModel()\n+    obj.testfile.save(file.name, file)\n+    return HttpResponse('%d' % obj.pk)"
        },
        {
            "sha": "5237bb6ba0565a22a67443544c4d5aeb42e227fb",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/fcf7fbc68cadb7efd8bc779c0e189389d6475463/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=fcf7fbc68cadb7efd8bc779c0e189389d6475463",
            "patch": "@@ -161,8 +161,8 @@ def test_loaders_security(self):\n         fs_loader = filesystem.Loader()\n         def test_template_sources(path, template_dirs, expected_sources):\n             if isinstance(expected_sources, list):\n-                # Fix expected sources so they are normcased and abspathed\n-                expected_sources = [os.path.normcase(os.path.abspath(s)) for s in expected_sources]\n+                # Fix expected sources so they are abspathed\n+                expected_sources = [os.path.abspath(s) for s in expected_sources]\n             # Test the two loaders (app_directores and filesystem).\n             func1 = lambda p, t: list(ad_loader.get_template_sources(p, t))\n             func2 = lambda p, t: list(fs_loader.get_template_sources(p, t))\n@@ -205,9 +205,9 @@ def test_template_sources(path, template_dirs, expected_sources):\n         if os.path.normcase('/TEST') == os.path.normpath('/test'):\n             template_dirs = ['/dir1', '/DIR2']\n             test_template_sources('index.html', template_dirs,\n-                                  ['/dir1/index.html', '/dir2/index.html'])\n+                                  ['/dir1/index.html', '/DIR2/index.html'])\n             test_template_sources('/DIR1/index.HTML', template_dirs,\n-                                  ['/dir1/index.html'])\n+                                  ['/DIR1/index.HTML'])\n \n     def test_loader_debug_origin(self):\n         # Turn TEMPLATE_DEBUG on, so that the origin file name will be kept with"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 71,
        "deletions": 14
    }
}