{
    "author": "aaugustin",
    "message": "Fixed #16395 -- Prevented urlize from highlighting some malformed URLs. Thanks BernhardEssl for the report and initial patch.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17358 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8",
    "files": [
        {
            "sha": "207620ed86c34a53c433050704d34a0fe05695d2",
            "filename": "django/utils/html.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8/django%2Futils%2Fhtml.py",
            "raw_url": "https://github.com/django/django/raw/27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8/django%2Futils%2Fhtml.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fhtml.py?ref=27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8",
            "patch": "@@ -23,6 +23,8 @@\n punctuation_re = re.compile('^(?P<lead>(?:%s)*)(?P<middle>.*?)(?P<trail>(?:%s)*)$' % \\\n     ('|'.join([re.escape(x) for x in LEADING_PUNCTUATION]),\n     '|'.join([re.escape(x) for x in TRAILING_PUNCTUATION])))\n+simple_url_re = re.compile(r'^https?://\\w')\n+simple_url_2_re = re.compile(r'^www\\.|^(?!http)\\w[^@]+\\.(com|net|org)$')\n simple_email_re = re.compile(r'^\\S+@\\S+\\.\\S+$')\n link_target_attribute_re = re.compile(r'(<a [^>]*?)target=[^\\s>]+')\n html_gunk_re = re.compile(r'(?:<br clear=\"all\">|<i><\\/i>|<b><\\/b>|<em><\\/em>|<strong><\\/strong>|<\\/?smallcaps>|<\\/?uppercase>)', re.IGNORECASE)\n@@ -150,11 +152,9 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             # Make URL we want to point to.\n             url = None\n             nofollow_attr = ' rel=\"nofollow\"' if nofollow else ''\n-            if middle.startswith('http://') or middle.startswith('https://'):\n+            if simple_url_re.match(middle):\n                 url = smart_urlquote(middle)\n-            elif middle.startswith('www.') or ('@' not in middle and \\\n-                    middle and middle[0] in string.ascii_letters + string.digits and \\\n-                    (middle.endswith('.org') or middle.endswith('.net') or middle.endswith('.com'))):\n+            elif simple_url_2_re.match(middle):\n                 url = smart_urlquote('http://%s' % middle)\n             elif not ':' in middle and simple_email_re.match(middle):\n                 local, domain = middle.rsplit('@', 1)"
        },
        {
            "sha": "2f3d012346fc3267880c10ae282614d9c613cda3",
            "filename": "tests/regressiontests/defaultfilters/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefaultfilters%2Ftests.py?ref=27508918fbbbfda6f5e3b697bbea6bf2c4a6b8b8",
            "patch": "@@ -268,6 +268,14 @@ def test_urlize(self):\n         self.assertEqual(urlize('info@c✶.org'),\n             u'<a href=\"mailto:info@xn--c-lgq.org\">info@c✶.org</a>')\n \n+        # Check urlize doesn't highlight malformed URIs - see #16395\n+        self.assertEqual(urlize('http:///www.google.com'),\n+           u'http:///www.google.com')\n+        self.assertEqual(urlize('http://.google.com'),\n+            u'http://.google.com')\n+        self.assertEqual(urlize('http://@foo.com'),\n+            u'http://@foo.com')\n+\n     def test_wordcount(self):\n         self.assertEqual(wordcount(''), 0)\n         self.assertEqual(wordcount(u'oneword'), 1)"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 12,
        "deletions": 4
    }
}