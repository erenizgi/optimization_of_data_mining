{
    "author": "jezdez",
    "message": "Fixed #13743 -- Fixed CommentsAdmin to not blow up if the delete_selected action is disabled. Thanks, Daniel Lindsley.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14996 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7655cd8eac4d745d791feb4349bbbcf69e892948",
    "files": [
        {
            "sha": "4cb90663a0e3b174436aec5942cc4a635eaebd1f",
            "filename": "django/contrib/comments/admin.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/7655cd8eac4d745d791feb4349bbbcf69e892948/django%2Fcontrib%2Fcomments%2Fadmin.py",
            "raw_url": "https://github.com/django/django/raw/7655cd8eac4d745d791feb4349bbbcf69e892948/django%2Fcontrib%2Fcomments%2Fadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcomments%2Fadmin.py?ref=7655cd8eac4d745d791feb4349bbbcf69e892948",
            "patch": "@@ -28,11 +28,13 @@ class CommentsAdmin(admin.ModelAdmin):\n     def get_actions(self, request):\n         actions = super(CommentsAdmin, self).get_actions(request)\n         # Only superusers should be able to delete the comments from the DB.\n-        if not request.user.is_superuser:\n+        if not request.user.is_superuser and 'delete_selected' in actions:\n             actions.pop('delete_selected')\n         if not request.user.has_perm('comments.can_moderate'):\n-            actions.pop('approve_comments')\n-            actions.pop('remove_comments')\n+            if 'approve_comments' in actions:\n+                actions.pop('approve_comments')\n+            if 'remove_comments' in actions:\n+                actions.pop('remove_comments')\n         return actions\n \n     def flag_comments(self, request, queryset):"
        },
        {
            "sha": "e5094ab0cce9cf19a1bdf480b20b526965e5410d",
            "filename": "tests/regressiontests/comment_tests/tests/moderation_view_tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/7655cd8eac4d745d791feb4349bbbcf69e892948/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fmoderation_view_tests.py",
            "raw_url": "https://github.com/django/django/raw/7655cd8eac4d745d791feb4349bbbcf69e892948/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fmoderation_view_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fmoderation_view_tests.py?ref=7655cd8eac4d745d791feb4349bbbcf69e892948",
            "patch": "@@ -190,3 +190,14 @@ def testActionsModerator(self):\n         self.client.login(username=\"normaluser\", password=\"normaluser\")\n         response = self.client.get(\"/admin/comments/comment/\")\n         self.assertEquals(\"approve_comments\" in response.content, True)\n+\n+    def testActionsDisabledDelete(self):\n+        \"Tests a CommentAdmin where 'delete_selected' has been disabled.\"\n+        comments = self.createSomeComments()\n+        self.client.login(username=\"normaluser\", password=\"normaluser\")\n+        response = self.client.get('/admin2/comments/comment/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assert_(\n+            '<option value=\"delete_selected\">' not in response.content,\n+            \"Found an unexpected delete_selected in response\"\n+        )"
        },
        {
            "sha": "d7e1a4e916b1c30976db9765f83dbcb901a4cb81",
            "filename": "tests/regressiontests/comment_tests/urls_admin.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/7655cd8eac4d745d791feb4349bbbcf69e892948/tests%2Fregressiontests%2Fcomment_tests%2Furls_admin.py",
            "raw_url": "https://github.com/django/django/raw/7655cd8eac4d745d791feb4349bbbcf69e892948/tests%2Fregressiontests%2Fcomment_tests%2Furls_admin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Furls_admin.py?ref=7655cd8eac4d745d791feb4349bbbcf69e892948",
            "patch": "@@ -8,6 +8,12 @@\n admin_site = admin.AdminSite()\n admin_site.register(Comment, CommentsAdmin)\n \n+# To demonstrate proper functionality even when ``delete_selected`` is removed.\n+admin_site2 = admin.AdminSite()\n+admin_site2.disable_action('delete_selected')\n+admin_site2.register(Comment, CommentsAdmin)\n+\n urlpatterns = patterns('',\n     (r'^admin/', include(admin_site.urls)),\n+    (r'^admin2/', include(admin_site2.urls)),\n )"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 22,
        "deletions": 3
    }
}