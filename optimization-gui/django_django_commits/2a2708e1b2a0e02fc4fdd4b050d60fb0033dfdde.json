{
    "author": "akaariai",
    "message": "Fixed #17502 -- Made joining in inheritance cases consistent\n\nThe original problem was that when filtering two levels up in\ninheritance chain, Django optimized the join generation so that the\nmiddle model was skipped. But then Django generated joins from top\nto middle to bottom for SELECT clause, and thus there was one extra\njoin (top->middle->bottom + top -> bottom).\n\nThis case is fixed in master as the filtering optimization is gone.\nThis has the side effect that in some cases there is still extra join\nif the SELECT clause doesn't contain anything from middle or bottom.",
    "sha": "2a2708e1b2a0e02fc4fdd4b050d60fb0033dfdde",
    "files": [
        {
            "sha": "98216dbc8422651946ccdb376d0d39391fa72f29",
            "filename": "tests/model_inheritance_regress/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/2a2708e1b2a0e02fc4fdd4b050d60fb0033dfdde/tests%2Fmodel_inheritance_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2a2708e1b2a0e02fc4fdd4b050d60fb0033dfdde/tests%2Fmodel_inheritance_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodel_inheritance_regress%2Ftests.py?ref=2a2708e1b2a0e02fc4fdd4b050d60fb0033dfdde",
            "patch": "@@ -8,6 +8,7 @@\n from django import forms\n \n from django.test import TestCase\n+from django.utils.unittest import expectedFailure\n \n from .models import (Place, Restaurant, ItalianRestaurant, ParkingLot,\n     ParkingLot2, ParkingLot3, Supplier, Wholesaler, Child, SelfRefParent,\n@@ -422,3 +423,19 @@ class Meta:\n         form = ProfileForm({'username': \"user_with_profile\", 'extra': \"hello\"},\n                            instance=p)\n         self.assertTrue(form.is_valid())\n+\n+    def test_inheritance_joins(self):\n+        # Test for #17502 - check that filtering through two levels of\n+        # inheritance chain doesn't generate extra joins.\n+        qs = ItalianRestaurant.objects.all()\n+        self.assertEqual(str(qs.query).count('JOIN'), 2)\n+        qs = ItalianRestaurant.objects.filter(name='foo')\n+        self.assertEqual(str(qs.query).count('JOIN'), 2)\n+\n+    @expectedFailure\n+    def test_inheritance_values_joins(self):\n+        # It would be nice (but not too important) to skip the middle join in\n+        # this case. Skipping is possible as nothing from the middle model is\n+        # used in the qs and top contains direct pointer to the bottom model.\n+        qs = ItalianRestaurant.objects.values_list('serves_gnocchi').filter(name='foo')\n+        self.assertEqual(str(qs.query).count('JOIN'), 1)"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 17,
        "deletions": 0
    }
}