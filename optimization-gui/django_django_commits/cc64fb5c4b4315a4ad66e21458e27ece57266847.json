{
    "author": "jezdez",
    "message": "Fixed #8342 -- Removed code from the admin that assumed that you can't login with an email address (nixed by r12634). Also refactored login code slightly to be DRY by using more of auth app's forms and views.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14769 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "cc64fb5c4b4315a4ad66e21458e27ece57266847",
    "files": [
        {
            "sha": "5a245a39afa702c326b8b97d90f73d2e66373373",
            "filename": "django/contrib/admin/forms.py",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fforms.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -0,0 +1,43 @@\n+from django import forms\n+\n+from django.contrib.auth import authenticate\n+from django.contrib.auth.forms import AuthenticationForm\n+from django.contrib.auth.models import User\n+\n+from django.utils.translation import ugettext_lazy, ugettext as _\n+\n+ERROR_MESSAGE = ugettext_lazy(\"Please enter a correct username and password. \"\n+                              \"Note that both fields are case-sensitive.\")\n+\n+class AdminAuthenticationForm(AuthenticationForm):\n+    \"\"\"\n+    A custom authentication form used in the admin app.\n+\n+    \"\"\"\n+    this_is_the_login_form = forms.BooleanField(widget=forms.HiddenInput, initial=1,\n+        error_messages={'required': ugettext_lazy(\"Please log in again, because your session has expired.\")})\n+\n+    def clean(self):\n+        username = self.cleaned_data.get('username')\n+        password = self.cleaned_data.get('password')\n+        message = ERROR_MESSAGE\n+\n+        if username and password:\n+            self.user_cache = authenticate(username=username, password=password)\n+            if self.user_cache is None:\n+                if username is not None and u'@' in username:\n+                    # Mistakenly entered e-mail address instead of username? Look it up.\n+                    try:\n+                        user = User.objects.get(email=username)\n+                    except (User.DoesNotExist, User.MultipleObjectsReturned):\n+                        # Nothing to do here, moving along.\n+                        pass\n+                    else:\n+                        if user.check_password(password):\n+                            message = _(\"Your e-mail address is not your username.\"\n+                                        \" Try '%s' instead.\") % user.username\n+                raise forms.ValidationError(message)\n+            elif not self.user_cache.is_active or not self.user_cache.is_staff:\n+                raise forms.ValidationError(message)\n+        self.check_for_test_cookie()\n+        return self.cleaned_data"
        },
        {
            "sha": "0aa730f79e78f22cd15d4095c606fdbfd0fa2c76",
            "filename": "django/contrib/admin/sites.py",
            "status": "modified",
            "additions": 36,
            "deletions": 73,
            "changes": 109,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Fsites.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Fsites.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fsites.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -1,8 +1,8 @@\n import re\n from django import http, template\n-from django.contrib.admin import ModelAdmin\n-from django.contrib.admin import actions\n-from django.contrib.auth import authenticate, login\n+from django.contrib.admin import ModelAdmin, actions\n+from django.contrib.admin.forms import AdminAuthenticationForm, ERROR_MESSAGE\n+from django.contrib.auth import REDIRECT_FIELD_NAME, authenticate, login\n from django.views.decorators.csrf import csrf_protect\n from django.db.models.base import ModelBase\n from django.core.exceptions import ImproperlyConfigured\n@@ -15,7 +15,6 @@\n from django.views.decorators.cache import never_cache\n from django.conf import settings\n \n-ERROR_MESSAGE = ugettext_lazy(\"Please enter a correct username and password. Note that both fields are case-sensitive.\")\n LOGIN_FORM_KEY = 'this_is_the_login_form'\n \n class AlreadyRegistered(Exception):\n@@ -32,7 +31,7 @@ class AdminSite(object):\n     functions that present a full admin interface for the collection of registered\n     models.\n     \"\"\"\n-\n+    login_form = None\n     index_template = None\n     app_index_template = None\n     login_template = None\n@@ -127,12 +126,12 @@ def get_action(self, name):\n         \"\"\"\n         return self._global_actions[name]\n \n+    @property\n     def actions(self):\n         \"\"\"\n         Get all the enabled actions as an iterable of (name, func).\n         \"\"\"\n         return self._actions.iteritems()\n-    actions = property(actions)\n \n     def has_permission(self, request):\n         \"\"\"\n@@ -240,9 +239,9 @@ def wrapper(*args, **kwargs):\n             )\n         return urlpatterns\n \n+    @property\n     def urls(self):\n         return self.get_urls(), self.app_name, self.name\n-    urls = property(urls)\n \n     def password_change(self, request):\n         \"\"\"\n@@ -254,18 +253,22 @@ def password_change(self, request):\n         else:\n             url = reverse('admin:password_change_done', current_app=self.name)\n         defaults = {\n+            'current_app': self.name,\n             'post_change_redirect': url\n         }\n         if self.password_change_template is not None:\n             defaults['template_name'] = self.password_change_template\n         return password_change(request, **defaults)\n \n-    def password_change_done(self, request):\n+    def password_change_done(self, request, extra_context=None):\n         \"\"\"\n         Displays the \"success\" page after a password change.\n         \"\"\"\n         from django.contrib.auth.views import password_change_done\n-        defaults = {}\n+        defaults = {\n+            'current_app': self.name,\n+            'extra_context': extra_context or {},\n+        }\n         if self.password_change_done_template is not None:\n             defaults['template_name'] = self.password_change_done_template\n         return password_change_done(request, **defaults)\n@@ -283,69 +286,44 @@ def i18n_javascript(self, request):\n             from django.views.i18n import null_javascript_catalog as javascript_catalog\n         return javascript_catalog(request, packages='django.conf')\n \n-    def logout(self, request):\n+    @never_cache\n+    def logout(self, request, extra_context=None):\n         \"\"\"\n         Logs out the user for the given HttpRequest.\n \n         This should *not* assume the user is already logged in.\n         \"\"\"\n         from django.contrib.auth.views import logout\n-        defaults = {}\n+        defaults = {\n+            'current_app': self.name,\n+            'extra_context': extra_context or {},\n+        }\n         if self.logout_template is not None:\n             defaults['template_name'] = self.logout_template\n         return logout(request, **defaults)\n-    logout = never_cache(logout)\n \n-    def login(self, request):\n+    @never_cache\n+    def login(self, request, extra_context=None):\n         \"\"\"\n         Displays the login form for the given HttpRequest.\n         \"\"\"\n-        from django.contrib.auth.models import User\n-\n-        # If this isn't already the login page, display it.\n-        if LOGIN_FORM_KEY not in request.POST:\n-            if request.POST:\n-                message = _(\"Please log in again, because your session has expired.\")\n-            else:\n-                message = \"\"\n-            return self.display_login_form(request, message)\n-\n-        # Check that the user accepts cookies.\n-        if not request.session.test_cookie_worked():\n-            message = _(\"Looks like your browser isn't configured to accept cookies. Please enable cookies, reload this page, and try again.\")\n-            return self.display_login_form(request, message)\n-        else:\n-            request.session.delete_test_cookie()\n-\n-        # Check the password.\n-        username = request.POST.get('username', None)\n-        password = request.POST.get('password', None)\n-        user = authenticate(username=username, password=password)\n-        if user is None:\n-            message = ERROR_MESSAGE\n-            if username is not None and u'@' in username:\n-                # Mistakenly entered e-mail address instead of username? Look it up.\n-                try:\n-                    user = User.objects.get(email=username)\n-                except (User.DoesNotExist, User.MultipleObjectsReturned):\n-                    message = _(\"Usernames cannot contain the '@' character.\")\n-                else:\n-                    if user.check_password(password):\n-                        message = _(\"Your e-mail address is not your username.\"\n-                                    \" Try '%s' instead.\") % user.username\n-                    else:\n-                        message = _(\"Usernames cannot contain the '@' character.\")\n-            return self.display_login_form(request, message)\n-\n-        # The user data is correct; log in the user in and continue.\n-        else:\n-            if user.is_active and user.is_staff:\n-                login(request, user)\n-                return http.HttpResponseRedirect(request.get_full_path())\n-            else:\n-                return self.display_login_form(request, ERROR_MESSAGE)\n-    login = never_cache(login)\n+        from django.contrib.auth.views import login\n+        context = {\n+            'title': _('Log in'),\n+            'root_path': self.root_path,\n+            'app_path': request.get_full_path(),\n+            REDIRECT_FIELD_NAME: request.get_full_path(),\n+        }\n+        context.update(extra_context or {})\n+        defaults = {\n+            'extra_context': context,\n+            'current_app': self.name,\n+            'authentication_form': self.login_form or AdminAuthenticationForm,\n+            'template_name': self.login_template or 'admin/login.html',\n+        }\n+        return login(request, **defaults)\n \n+    @never_cache\n     def index(self, request, extra_context=None):\n         \"\"\"\n         Displays the main admin index page, which lists all of the installed\n@@ -396,21 +374,6 @@ def index(self, request, extra_context=None):\n         return render_to_response(self.index_template or 'admin/index.html', context,\n             context_instance=context_instance\n         )\n-    index = never_cache(index)\n-\n-    def display_login_form(self, request, error_message='', extra_context=None):\n-        request.session.set_test_cookie()\n-        context = {\n-            'title': _('Log in'),\n-            'app_path': request.get_full_path(),\n-            'error_message': error_message,\n-            'root_path': self.root_path,\n-        }\n-        context.update(extra_context or {})\n-        context_instance = template.RequestContext(request, current_app=self.name)\n-        return render_to_response(self.login_template or 'admin/login.html', context,\n-            context_instance=context_instance\n-        )\n \n     def app_index(self, request, app_label, extra_context=None):\n         user = request.user"
        },
        {
            "sha": "ad7b14e96545f7a6b8f4b6b07c1db8ba580b4b69",
            "filename": "django/contrib/admin/templates/admin/login.html",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Flogin.html",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Flogin.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ftemplates%2Fadmin%2Flogin.html?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -12,17 +12,31 @@\n {% block breadcrumbs %}{% endblock %}\n \n {% block content %}\n-{% if error_message %}\n-<p class=\"errornote\">{{ error_message }}</p>\n+{% if form.errors and not form.non_field_errors and not form.this_is_the_login_form.errors %}\n+<p class=\"errornote\">\n+{% blocktrans count form.errors.items|length as counter %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktrans %}\n+</p>\n {% endif %}\n+\n+{% if form.non_field_errors or form.this_is_the_login_form.errors %}\n+{% for error in form.non_field_errors|add:form.this_is_the_login_form.errors %}\n+<p class=\"errornote\">\n+    {{ error }}\n+</p>\n+{% endfor %}\n+{% endif %}\n+\n <div id=\"content-main\">\n <form action=\"{{ app_path }}\" method=\"post\" id=\"login-form\">{% csrf_token %}\n   <div class=\"form-row\">\n-    <label for=\"id_username\">{% trans 'Username:' %}</label> <input type=\"text\" name=\"username\" id=\"id_username\" />\n+    {% if not form.this_is_the_login_form.errors %}{{ form.username.errors }}{% endif %}\n+    <label for=\"id_username\" class=\"required\">{% trans 'Username:' %}</label> {{ form.username }}\n   </div>\n   <div class=\"form-row\">\n-    <label for=\"id_password\">{% trans 'Password:' %}</label> <input type=\"password\" name=\"password\" id=\"id_password\" />\n+    {% if not form.this_is_the_login_form.errors %}{{ form.password.errors }}{% endif %}\n+    <label for=\"id_password\" class=\"required\">{% trans 'Password:' %}</label> {{ form.password }}\n     <input type=\"hidden\" name=\"this_is_the_login_form\" value=\"1\" />\n+    <input type=\"hidden\" name=\"next\" value=\"{{ next }}\" />\n   </div>\n   <div class=\"submit-row\">\n     <label>&nbsp;</label><input type=\"submit\" value=\"{% trans 'Log in' %}\" />"
        },
        {
            "sha": "1f5f20d605cd0fe3edbf2a57f70cc06290d4cb23",
            "filename": "django/contrib/admin/views/decorators.py",
            "status": "modified",
            "additions": 15,
            "deletions": 55,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Fviews%2Fdecorators.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fadmin%2Fviews%2Fdecorators.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fviews%2Fdecorators.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -3,22 +3,13 @@\n except ImportError:\n     from django.utils.functional import wraps  # Python 2.4 fallback.\n \n-from django import http, template\n-from django.contrib.auth.models import User\n-from django.contrib.auth import authenticate, login\n+from django import template\n from django.shortcuts import render_to_response\n-from django.utils.translation import ugettext_lazy, ugettext as _\n+from django.utils.translation import ugettext as _\n \n-ERROR_MESSAGE = ugettext_lazy(\"Please enter a correct username and password. Note that both fields are case-sensitive.\")\n-LOGIN_FORM_KEY = 'this_is_the_login_form'\n-\n-def _display_login_form(request, error_message=''):\n-    request.session.set_test_cookie()\n-    return render_to_response('admin/login.html', {\n-        'title': _('Log in'),\n-        'app_path': request.get_full_path(),\n-        'error_message': error_message\n-    }, context_instance=template.RequestContext(request))\n+from django.contrib.admin.forms import AdminAuthenticationForm\n+from django.contrib.auth.views import login\n+from django.contrib.auth import REDIRECT_FIELD_NAME\n \n def staff_member_required(view_func):\n     \"\"\"\n@@ -31,45 +22,14 @@ def _checklogin(request, *args, **kwargs):\n             return view_func(request, *args, **kwargs)\n \n         assert hasattr(request, 'session'), \"The Django admin requires session middleware to be installed. Edit your MIDDLEWARE_CLASSES setting to insert 'django.contrib.sessions.middleware.SessionMiddleware'.\"\n-\n-        # If this isn't already the login page, display it.\n-        if LOGIN_FORM_KEY not in request.POST:\n-            if request.POST:\n-                message = _(\"Please log in again, because your session has expired.\")\n-            else:\n-                message = \"\"\n-            return _display_login_form(request, message)\n-\n-        # Check that the user accepts cookies.\n-        if not request.session.test_cookie_worked():\n-            message = _(\"Looks like your browser isn't configured to accept cookies. Please enable cookies, reload this page, and try again.\")\n-            return _display_login_form(request, message)\n-        else:\n-            request.session.delete_test_cookie()\n-\n-        # Check the password.\n-        username = request.POST.get('username', None)\n-        password = request.POST.get('password', None)\n-        user = authenticate(username=username, password=password)\n-        if user is None:\n-            message = ERROR_MESSAGE\n-            if '@' in username:\n-                # Mistakenly entered e-mail address instead of username? Look it up.\n-                users = list(User.objects.filter(email=username))\n-                if len(users) == 1 and users[0].check_password(password):\n-                    message = _(\"Your e-mail address is not your username. Try '%s' instead.\") % users[0].username\n-                else:\n-                    # Either we cannot find the user, or if more than 1\n-                    # we cannot guess which user is the correct one.\n-                    message = _(\"Usernames cannot contain the '@' character.\")\n-            return _display_login_form(request, message)\n-\n-        # The user data is correct; log in the user in and continue.\n-        else:\n-            if user.is_active and user.is_staff:\n-                login(request, user)\n-                return http.HttpResponseRedirect(request.get_full_path())\n-            else:\n-                return _display_login_form(request, ERROR_MESSAGE)\n-\n+        defaults = {\n+            'template_name': 'admin/login.html',\n+            'authentication_form': AdminAuthenticationForm,\n+            'extra_context': {\n+                'title': _('Log in'),\n+                'app_path': request.get_full_path(),\n+                REDIRECT_FIELD_NAME: request.get_full_path(),\n+            },\n+        }\n+        return login(request, **defaults)\n     return wraps(view_func)(_checklogin)"
        },
        {
            "sha": "74732799e79e7cc914b59a49535efa75033981ec",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -87,14 +87,15 @@ def clean(self):\n                 raise forms.ValidationError(_(\"Please enter a correct username and password. Note that both fields are case-sensitive.\"))\n             elif not self.user_cache.is_active:\n                 raise forms.ValidationError(_(\"This account is inactive.\"))\n-\n-        # TODO: determine whether this should move to its own method.\n-        if self.request:\n-            if not self.request.session.test_cookie_worked():\n-                raise forms.ValidationError(_(\"Your Web browser doesn't appear to have cookies enabled. Cookies are required for logging in.\"))\n-\n+        self.check_for_test_cookie()\n         return self.cleaned_data\n \n+    def check_for_test_cookie(self):\n+        if self.request and not self.request.session.test_cookie_worked():\n+            raise forms.ValidationError(\n+                _(\"Your Web browser doesn't appear to have cookies enabled. \"\n+                  \"Cookies are required for logging in.\"))\n+\n     def get_user_id(self):\n         if self.user_cache:\n             return self.user_cache.id"
        },
        {
            "sha": "7e4b1f33dc043698a32903e14148e26f9132ba0c",
            "filename": "django/contrib/auth/views.py",
            "status": "modified",
            "additions": 18,
            "deletions": 17,
            "changes": 35,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fauth%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/django%2Fcontrib%2Fauth%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fviews.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -24,7 +24,7 @@\n def login(request, template_name='registration/login.html',\n           redirect_field_name=REDIRECT_FIELD_NAME,\n           authentication_form=AuthenticationForm,\n-          extra_context=None):\n+          current_app=None, extra_context=None):\n     \"\"\"Displays the login form and handles the login action.\"\"\"\n \n     redirect_to = request.REQUEST.get(redirect_field_name, '')\n@@ -65,12 +65,12 @@ def login(request, template_name='registration/login.html',\n     }\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))\n \n def logout(request, next_page=None,\n            template_name='registration/logged_out.html',\n            redirect_field_name=REDIRECT_FIELD_NAME,\n-           extra_context=None):\n+           current_app=None, extra_context=None):\n     \"Logs out the user and displays 'You are logged out' message.\"\n     from django.contrib.auth import logout\n     logout(request)\n@@ -87,16 +87,16 @@ def logout(request, next_page=None,\n             }\n             context.update(extra_context or {})\n             return render_to_response(template_name, context,\n-                                      context_instance=RequestContext(request))\n+                                      context_instance=RequestContext(request, current_app=current_app))\n     else:\n         # Redirect to this page until the session has been cleared.\n         return HttpResponseRedirect(next_page or request.path)\n \n-def logout_then_login(request, login_url=None, extra_context=None):\n+def logout_then_login(request, login_url=None, current_app=None, extra_context=None):\n     \"Logs out the user if he is logged in. Then redirects to the log-in page.\"\n     if not login_url:\n         login_url = settings.LOGIN_URL\n-    return logout(request, login_url, extra_context=extra_context)\n+    return logout(request, login_url, current_app=current_app, extra_context=extra_context)\n \n def redirect_to_login(next, login_url=None,\n                       redirect_field_name=REDIRECT_FIELD_NAME):\n@@ -127,6 +127,7 @@ def password_reset(request, is_admin_site=False,\n                    token_generator=default_token_generator,\n                    post_reset_redirect=None,\n                    from_email=None,\n+                   current_app=None,\n                    extra_context=None):\n     if post_reset_redirect is None:\n         post_reset_redirect = reverse('django.contrib.auth.views.password_reset_done')\n@@ -151,23 +152,23 @@ def password_reset(request, is_admin_site=False,\n     }\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))\n \n def password_reset_done(request,\n                         template_name='registration/password_reset_done.html',\n-                        extra_context=None):\n+                        current_app=None, extra_context=None):\n     context = {}\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))\n \n # Doesn't need csrf_protect since no-one can guess the URL\n def password_reset_confirm(request, uidb36=None, token=None,\n                            template_name='registration/password_reset_confirm.html',\n                            token_generator=default_token_generator,\n                            set_password_form=SetPasswordForm,\n                            post_reset_redirect=None,\n-                           extra_context=None):\n+                           current_app=None, extra_context=None):\n     \"\"\"\n     View that checks the hash in a password reset link and presents a\n     form for entering a new password.\n@@ -199,25 +200,25 @@ def password_reset_confirm(request, uidb36=None, token=None,\n     }\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))\n \n def password_reset_complete(request,\n                             template_name='registration/password_reset_complete.html',\n-                            extra_context=None):\n+                            current_app=None, extra_context=None):\n     context = {\n         'login_url': settings.LOGIN_URL\n     }\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))\n \n @csrf_protect\n @login_required\n def password_change(request,\n                     template_name='registration/password_change_form.html',\n                     post_change_redirect=None,\n                     password_change_form=PasswordChangeForm,\n-                    extra_context=None):\n+                    current_app=None, extra_context=None):\n     if post_change_redirect is None:\n         post_change_redirect = reverse('django.contrib.auth.views.password_change_done')\n     if request.method == \"POST\":\n@@ -232,12 +233,12 @@ def password_change(request,\n     }\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))\n \n def password_change_done(request,\n                          template_name='registration/password_change_done.html',\n-                         extra_context=None):\n+                         current_app=None, extra_context=None):\n     context = {}\n     context.update(extra_context or {})\n     return render_to_response(template_name, context,\n-                              context_instance=RequestContext(request))\n+                              context_instance=RequestContext(request, current_app=current_app))"
        },
        {
            "sha": "15a5ba2c550f063416482ed3a9bdfeeb2e0b5815",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -1459,6 +1459,13 @@ Path to a custom template that will be used by the admin site main index view.\n \n Path to a custom template that will be used by the admin site login view.\n \n+.. versionadded:: 1.3\n+\n+.. attribute:: AdminSite.login_form\n+\n+Subclass of :class:`~django.contrib.auth.forms.AuthenticationForm` that will\n+be used by the admin site login view.\n+\n .. attribute:: AdminSite.logout_template\n \n .. versionadded:: 1.2"
        },
        {
            "sha": "0572bc14df06f8250e797e34f02591c039dfeb0d",
            "filename": "docs/releases/1.3-alpha-2.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/docs%2Freleases%2F1.3-alpha-2.txt",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/docs%2Freleases%2F1.3-alpha-2.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3-alpha-2.txt?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -95,6 +95,23 @@ As a result, we took the following steps to rectify the issue:\n     **if the value is not None**, and falls back to the previously used\n     :setting:`MEDIA_URL` setting otherwise.\n \n+Changes to the login methods of the admin\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+In previous version the admin app defined login methods in multiple locations\n+and ignored the almost identical implementation in the already used auth app.\n+A side effect of this duplication was the missing adoption of the changes made\n+in r12634_ to support a broader set of characters for usernames.\n+\n+This release refactores the admin's login mechanism to use a subclass of the\n+:class:`~django.contrib.auth.forms.AuthenticationForm` instead of a manual\n+form validation. The previously undocumented method\n+``'django.contrib.admin.sites.AdminSite.display_login_form'`` has been removed\n+in favor of a new :attr:`~django.contrib.admin.AdminSite.login_form`\n+attribute.\n+\n+.. _r12634: http://code.djangoproject.com/changeset/12634\n+\n The Django 1.3 roadmap\n ======================\n "
        },
        {
            "sha": "4e01fca97224b512104e4b08525f2ed91c3a2987",
            "filename": "docs/releases/1.3.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/docs%2Freleases%2F1.3.txt",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/docs%2Freleases%2F1.3.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.3.txt?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -424,3 +424,20 @@ Django 1.5, the old behavior will be replaced with the new behavior.\n To ensure compatibility with future versions of Django, existing\n templates should be modified to use the new ``future`` libraries and\n syntax.\n+\n+Changes to the login methods of the admin\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+In previous version the admin app defined login methods in multiple locations\n+and ignored the almost identical implementation in the already used auth app.\n+A side effect of this duplication was the missing adoption of the changes made\n+in r12634_ to support a broader set of characters for usernames.\n+\n+This release refactores the admin's login mechanism to use a subclass of the\n+:class:`~django.contrib.auth.forms.AuthenticationForm` instead of a manual\n+form validation. The previously undocumented method\n+``'django.contrib.admin.sites.AdminSite.display_login_form'`` has been removed\n+in favor of a new :attr:`~django.contrib.admin.AdminSite.login_form`\n+attribute.\n+\n+.. _r12634: http://code.djangoproject.com/changeset/12634"
        },
        {
            "sha": "c31d3794cdd2b40d2e284e81c05b9226fe536ad6",
            "filename": "tests/regressiontests/admin_views/customadmin.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fcustomadmin.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -5,9 +5,10 @@\n from django.contrib import admin\n from django.http import HttpResponse\n \n-import models\n+import models, forms\n \n class Admin2(admin.AdminSite):\n+    login_form = forms.CustomAdminAuthenticationForm\n     login_template = 'custom_admin/login.html'\n     logout_template = 'custom_admin/logout.html'\n     index_template = 'custom_admin/index.html'"
        },
        {
            "sha": "a030c2a8d09adfa90bbfe2a792cf39aa0ae1991a",
            "filename": "tests/regressiontests/admin_views/forms.py",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/tests%2Fregressiontests%2Fadmin_views%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/tests%2Fregressiontests%2Fadmin_views%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fforms.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -0,0 +1,10 @@\n+from django import forms\n+from django.contrib.admin.forms import AdminAuthenticationForm\n+\n+class CustomAdminAuthenticationForm(AdminAuthenticationForm):\n+\n+    def clean_username(self):\n+        username = self.cleaned_data.get('username')\n+        if username == 'customform':\n+            raise forms.ValidationError('custom form error')\n+        return username"
        },
        {
            "sha": "6b4f65b497a1ae98a58f7edc757d07fa3cc19b21",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 106,
            "deletions": 60,
            "changes": 166,
            "blob_url": "https://github.com/django/django/blob/cc64fb5c4b4315a4ad66e21458e27ece57266847/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cc64fb5c4b4315a4ad66e21458e27ece57266847/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=cc64fb5c4b4315a4ad66e21458e27ece57266847",
            "patch": "@@ -5,7 +5,7 @@\n from django.conf import settings\n from django.core import mail\n from django.core.files import temp as tempfile\n-from django.contrib.auth import admin # Register auth models with the admin.\n+from django.contrib.auth import REDIRECT_FIELD_NAME, admin # Register auth models with the admin.\n from django.contrib.auth.models import User, Permission, UNUSABLE_PASSWORD\n from django.contrib.contenttypes.models import ContentType\n from django.contrib.admin.models import LogEntry, DELETION\n@@ -377,6 +377,19 @@ def test_save_as_display(self):\n class CustomModelAdminTest(AdminViewBasicTest):\n     urlbit = \"admin2\"\n \n+    def testCustomAdminSiteLoginForm(self):\n+        self.client.logout()\n+        request = self.client.get('/test_admin/admin2/')\n+        self.failUnlessEqual(request.status_code, 200)\n+        login = self.client.post('/test_admin/admin2/', {\n+            REDIRECT_FIELD_NAME: '/test_admin/admin2/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'customform',\n+            'password': 'secret',\n+        })\n+        self.failUnlessEqual(login.status_code, 200)\n+        self.assertContains(login, 'custom form error')\n+\n     def testCustomAdminSiteLoginTemplate(self):\n         self.client.logout()\n         request = self.client.get('/test_admin/admin2/')\n@@ -446,36 +459,52 @@ def setUp(self):\n \n         # login POST dicts\n         self.super_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'super',\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'super',\n+            'password': 'secret',\n+        }\n         self.super_email_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'super@example.com',\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'super@example.com',\n+            'password': 'secret',\n+        }\n         self.super_email_bad_login = {\n-                      LOGIN_FORM_KEY: 1,\n-                      'username': 'super@example.com',\n-                      'password': 'notsecret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'super@example.com',\n+            'password': 'notsecret',\n+        }\n         self.adduser_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'adduser',\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'adduser',\n+            'password': 'secret',\n+        }\n         self.changeuser_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'changeuser',\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'changeuser',\n+            'password': 'secret',\n+        }\n         self.deleteuser_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'deleteuser',\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'deleteuser',\n+            'password': 'secret',\n+        }\n         self.joepublic_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'joepublic',\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'username': 'joepublic',\n+            'password': 'secret',\n+        }\n         self.no_username_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'password': 'secret'}\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/',\n+            LOGIN_FORM_KEY: 1,\n+            'password': 'secret',\n+        }\n \n     def testLogin(self):\n         \"\"\"\n@@ -500,12 +529,12 @@ def testLogin(self):\n         self.assertContains(login, \"Your e-mail address is not your username\")\n         # only correct passwords get a username hint\n         login = self.client.post('/test_admin/admin/', self.super_email_bad_login)\n-        self.assertContains(login, \"Usernames cannot contain the &#39;@&#39; character\")\n+        self.assertContains(login, \"Please enter a correct username and password.\")\n         new_user = User(username='jondoe', password='secret', email='super@example.com')\n         new_user.save()\n         # check to ensure if there are multiple e-mail addresses a user doesn't get a 500\n         login = self.client.post('/test_admin/admin/', self.super_email_login)\n-        self.assertContains(login, \"Usernames cannot contain the &#39;@&#39; character\")\n+        self.assertContains(login, \"Please enter a correct username and password.\")\n \n         # Add User\n         request = self.client.get('/test_admin/admin/')\n@@ -536,23 +565,24 @@ def testLogin(self):\n         self.failUnlessEqual(request.status_code, 200)\n         login = self.client.post('/test_admin/admin/', self.joepublic_login)\n         self.failUnlessEqual(login.status_code, 200)\n-        # Login.context is a list of context dicts we just need to check the first one.\n-        self.assert_(login.context[0].get('error_message'))\n+        self.assertContains(login, \"Please enter a correct username and password.\")\n \n         # Requests without username should not return 500 errors.\n         request = self.client.get('/test_admin/admin/')\n         self.failUnlessEqual(request.status_code, 200)\n         login = self.client.post('/test_admin/admin/', self.no_username_login)\n         self.failUnlessEqual(login.status_code, 200)\n-        # Login.context is a list of context dicts we just need to check the first one.\n-        self.assert_(login.context[0].get('error_message'))\n+        form = login.context[0].get('form')\n+        self.failUnlessEqual(form.errors['username'][0], 'This field is required.')\n \n     def testLoginSuccessfullyRedirectsToOriginalUrl(self):\n         request = self.client.get('/test_admin/admin/')\n         self.failUnlessEqual(request.status_code, 200)\n-        query_string = \"the-answer=42\"\n-        login = self.client.post('/test_admin/admin/', self.super_login, QUERY_STRING = query_string )\n-        self.assertRedirects(login, '/test_admin/admin/?%s' % query_string)\n+        query_string = 'the-answer=42'\n+        redirect_url = '/test_admin/admin/?%s' % query_string\n+        new_next = {REDIRECT_FIELD_NAME: redirect_url}\n+        login = self.client.post('/test_admin/admin/', dict(self.super_login, **new_next), QUERY_STRING=query_string)\n+        self.assertRedirects(login, redirect_url)\n \n     def testAddView(self):\n         \"\"\"Test add view restricts access and actually adds items.\"\"\"\n@@ -967,33 +997,47 @@ class SecureViewTest(TestCase):\n     def setUp(self):\n         # login POST dicts\n         self.super_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'super',\n-                     'password': 'secret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'super',\n+            'password': 'secret',\n+        }\n         self.super_email_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'super@example.com',\n-                     'password': 'secret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'super@example.com',\n+            'password': 'secret',\n+        }\n         self.super_email_bad_login = {\n-                      LOGIN_FORM_KEY: 1,\n-                      'username': 'super@example.com',\n-                      'password': 'notsecret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'super@example.com',\n+            'password': 'notsecret',\n+        }\n         self.adduser_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'adduser',\n-                     'password': 'secret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'adduser',\n+            'password': 'secret',\n+        }\n         self.changeuser_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'changeuser',\n-                     'password': 'secret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'changeuser',\n+            'password': 'secret',\n+        }\n         self.deleteuser_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'deleteuser',\n-                     'password': 'secret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'deleteuser',\n+            'password': 'secret',\n+        }\n         self.joepublic_login = {\n-                     LOGIN_FORM_KEY: 1,\n-                     'username': 'joepublic',\n-                     'password': 'secret'}\n+            LOGIN_FORM_KEY: 1,\n+            REDIRECT_FIELD_NAME: '/test_admin/admin/secure-view/',\n+            'username': 'joepublic',\n+            'password': 'secret',\n+        }\n \n     def tearDown(self):\n         self.client.logout()\n@@ -1006,9 +1050,11 @@ def test_secure_view_shows_login_if_not_logged_in(self):\n     def test_secure_view_login_successfully_redirects_to_original_url(self):\n         request = self.client.get('/test_admin/admin/secure-view/')\n         self.failUnlessEqual(request.status_code, 200)\n-        query_string = \"the-answer=42\"\n-        login = self.client.post('/test_admin/admin/secure-view/', self.super_login, QUERY_STRING = query_string )\n-        self.assertRedirects(login, '/test_admin/admin/secure-view/?%s' % query_string)\n+        query_string = 'the-answer=42'\n+        redirect_url = '/test_admin/admin/secure-view/?%s' % query_string\n+        new_next = {REDIRECT_FIELD_NAME: redirect_url}\n+        login = self.client.post('/test_admin/admin/secure-view/', dict(self.super_login, **new_next), QUERY_STRING=query_string)\n+        self.assertRedirects(login, redirect_url)\n \n     def test_staff_member_required_decorator_works_as_per_admin_login(self):\n         \"\"\"\n@@ -1035,12 +1081,12 @@ def test_staff_member_required_decorator_works_as_per_admin_login(self):\n         self.assertContains(login, \"Your e-mail address is not your username\")\n         # only correct passwords get a username hint\n         login = self.client.post('/test_admin/admin/secure-view/', self.super_email_bad_login)\n-        self.assertContains(login, \"Usernames cannot contain the &#39;@&#39; character\")\n+        self.assertContains(login, \"Please enter a correct username and password.\")\n         new_user = User(username='jondoe', password='secret', email='super@example.com')\n         new_user.save()\n         # check to ensure if there are multiple e-mail addresses a user doesn't get a 500\n         login = self.client.post('/test_admin/admin/secure-view/', self.super_email_login)\n-        self.assertContains(login, \"Usernames cannot contain the &#39;@&#39; character\")\n+        self.assertContains(login, \"Please enter a correct username and password.\")\n \n         # Add User\n         request = self.client.get('/test_admin/admin/secure-view/')\n@@ -1072,7 +1118,7 @@ def test_staff_member_required_decorator_works_as_per_admin_login(self):\n         login = self.client.post('/test_admin/admin/secure-view/', self.joepublic_login)\n         self.failUnlessEqual(login.status_code, 200)\n         # Login.context is a list of context dicts we just need to check the first one.\n-        self.assert_(login.context[0].get('error_message'))\n+        self.assertContains(login, \"Please enter a correct username and password.\")\n \n         # 8509 - if a normal user is already logged in, it is possible\n         # to change user into the superuser without error"
        }
    ],
    "stats": {
        "total": 512,
        "additions": 296,
        "deletions": 216
    }
}