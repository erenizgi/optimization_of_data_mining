{
    "author": "freakboy3742",
    "message": "Fixed #19822 -- Added validation for uniqueness on USERNAME_FIELD on custom User models.\n\nThanks to Claude Peroz for the draft patch.",
    "sha": "f5e4a699ca0f58818acbdf9081164060cee910fa",
    "files": [
        {
            "sha": "0d324f095392c64b63629911917d5e1bbff6af1a",
            "filename": "django/contrib/auth/tests/custom_user.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/f5e4a699ca0f58818acbdf9081164060cee910fa/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "raw_url": "https://github.com/django/django/raw/f5e4a699ca0f58818acbdf9081164060cee910fa/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py?ref=f5e4a699ca0f58818acbdf9081164060cee910fa",
            "patch": "@@ -144,3 +144,25 @@ class Meta:\n         app_label = 'auth'\n \n     # the is_active attr is provided by AbstractBaseUser\n+\n+\n+class CustomUserNonUniqueUsername(AbstractBaseUser):\n+    \"A user with a non-unique username\"\n+    username = models.CharField(max_length=30)\n+\n+    USERNAME_FIELD = 'username'\n+\n+    class Meta:\n+        app_label = 'auth'\n+\n+\n+class CustomUserBadRequiredFields(AbstractBaseUser):\n+    \"A user with a non-unique username\"\n+    username = models.CharField(max_length=30, unique=True)\n+    date_of_birth = models.DateField()\n+\n+    USERNAME_FIELD = 'username'\n+    REQUIRED_FIELDS = ['username', 'date_of_birth']\n+\n+    class Meta:\n+        app_label = 'auth'"
        },
        {
            "sha": "687a5c31cbf2e5795c8b194c13b6c8fad9b2354a",
            "filename": "django/contrib/auth/tests/management.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/f5e4a699ca0f58818acbdf9081164060cee910fa/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/f5e4a699ca0f58818acbdf9081164060cee910fa/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py?ref=f5e4a699ca0f58818acbdf9081164060cee910fa",
            "patch": "@@ -9,6 +9,8 @@\n from django.contrib.auth.tests.utils import skipIfCustomUser\n from django.core.management import call_command\n from django.core.management.base import CommandError\n+from django.core.management.validation import get_validation_errors\n+from django.db.models.loading import get_app\n from django.test import TestCase\n from django.test.utils import override_settings\n from django.utils import six\n@@ -170,6 +172,22 @@ def test_swappable_user_missing_required_field(self):\n         self.assertEqual(CustomUser._default_manager.count(), 0)\n \n \n+class CustomUserModelValidationTestCase(TestCase):\n+    @override_settings(AUTH_USER_MODEL='auth.CustomUserBadRequiredFields')\n+    def test_username_not_in_required_fields(self):\n+        \"USERNAME_FIELD should not appear in REQUIRED_FIELDS.\"\n+        new_io = StringIO()\n+        get_validation_errors(new_io, get_app('auth'))\n+        self.assertIn(\"The field named as the USERNAME_FIELD should not be included in REQUIRED_FIELDS on a swappable User model.\", new_io.getvalue())\n+\n+    @override_settings(AUTH_USER_MODEL='auth.CustomUserNonUniqueUsername')\n+    def test_username_non_unique(self):\n+        \"A non-unique USERNAME_FIELD should raise a model validation error.\"\n+        new_io = StringIO()\n+        get_validation_errors(new_io, get_app('auth'))\n+        self.assertIn(\"The USERNAME_FIELD must be unique. Add unique=True to the field parameters.\", new_io.getvalue())\n+\n+\n class PermissionDuplicationTestCase(TestCase):\n \n     def setUp(self):"
        },
        {
            "sha": "587d3a0ad7c180474c232c5232b9b3966f632a23",
            "filename": "django/core/management/validation.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f5e4a699ca0f58818acbdf9081164060cee910fa/django%2Fcore%2Fmanagement%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/f5e4a699ca0f58818acbdf9081164060cee910fa/django%2Fcore%2Fmanagement%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fvalidation.py?ref=f5e4a699ca0f58818acbdf9081164060cee910fa",
            "patch": "@@ -49,12 +49,16 @@ def get_validation_errors(outfile, app=None):\n             # No need to perform any other validation checks on a swapped model.\n             continue\n \n-        # This is the current User model. Check known validation problems with User models\n+        # If this is the current User model, check known validation problems with User models\n         if settings.AUTH_USER_MODEL == '%s.%s' % (opts.app_label, opts.object_name):\n             # Check that the USERNAME FIELD isn't included in REQUIRED_FIELDS.\n             if cls.USERNAME_FIELD in cls.REQUIRED_FIELDS:\n                 e.add(opts, 'The field named as the USERNAME_FIELD should not be included in REQUIRED_FIELDS on a swappable User model.')\n \n+            # Check that the username field is unique\n+            if not opts.get_field(cls.USERNAME_FIELD).unique:\n+                e.add(opts, 'The USERNAME_FIELD must be unique. Add unique=True to the field parameters.')\n+\n         # Model isn't swapped; do field-specific validation.\n         for f in opts.local_fields:\n             if f.name == 'id' and not f.primary_key and opts.pk.name == 'id':"
        },
        {
            "sha": "d1ce6eb7dcb45d86217759201ac8fd64e3863009",
            "filename": "docs/topics/auth/customizing.txt",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/f5e4a699ca0f58818acbdf9081164060cee910fa/docs%2Ftopics%2Fauth%2Fcustomizing.txt",
            "raw_url": "https://github.com/django/django/raw/f5e4a699ca0f58818acbdf9081164060cee910fa/docs%2Ftopics%2Fauth%2Fcustomizing.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth%2Fcustomizing.txt?ref=f5e4a699ca0f58818acbdf9081164060cee910fa",
            "patch": "@@ -492,7 +492,10 @@ password resets. You must then provide some key implementation details:\n         A string describing the name of the field on the User model that is\n         used as the unique identifier. This will usually be a username of\n         some kind, but it can also be an email address, or any other unique\n-        identifier. In the following example, the field `identifier` is used\n+        identifier. The field *must* be unique (i.e., have ``unique=True``\n+        set in it's definition).\n+\n+        In the following example, the field `identifier` is used\n         as the identifying field::\n \n             class MyUser(AbstractBaseUser):"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 49,
        "deletions": 2
    }
}