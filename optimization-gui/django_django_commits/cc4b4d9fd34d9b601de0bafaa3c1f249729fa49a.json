{
    "author": "claudep",
    "message": "Used CommandError in createcachetable command.\n\nRaising CommandError whenever a management command meets an error\ncondition is the standard way to handle errors in commands.",
    "sha": "cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a",
    "files": [
        {
            "sha": "bcc47e17c80ad84ad7124137c1794d451caaac5d",
            "filename": "django/core/management/commands/createcachetable.py",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "raw_url": "https://github.com/django/django/raw/cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Fcreatecachetable.py?ref=cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a",
            "patch": "@@ -1,7 +1,7 @@\n from optparse import make_option\n \n from django.core.cache.backends.db import BaseDatabaseCache\n-from django.core.management.base import LabelCommand\n+from django.core.management.base import LabelCommand, CommandError\n from django.db import connections, router, transaction, models, DEFAULT_DB_ALIAS\n from django.db.utils import DatabaseError\n \n@@ -55,11 +55,10 @@ def handle_label(self, tablename, **options):\n         try:\n             curs.execute(\"\\n\".join(full_statement))\n         except DatabaseError as e:\n-            self.stderr.write(\n+            transaction.rollback_unless_managed(using=db)\n+            raise CommandError(\n                 \"Cache table '%s' could not be created.\\nThe error was: %s.\" %\n                     (tablename, e))\n-            transaction.rollback_unless_managed(using=db)\n-        else:\n-            for statement in index_output:\n-                curs.execute(statement)\n-            transaction.commit_unless_managed(using=db)\n+        for statement in index_output:\n+            curs.execute(statement)\n+        transaction.commit_unless_managed(using=db)"
        },
        {
            "sha": "88fe5471cf2d8c28321a29eba506cb2958618700",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=cc4b4d9fd34d9b601de0bafaa3c1f249729fa49a",
            "patch": "@@ -7,7 +7,6 @@\n import hashlib\n import os\n import re\n-import StringIO\n import tempfile\n import time\n import warnings\n@@ -820,9 +819,14 @@ def test_old_initialization(self):\n         self.perform_cull_test(50, 18)\n \n     def test_second_call_doesnt_crash(self):\n-        err = StringIO.StringIO()\n-        management.call_command('createcachetable', self._table_name, verbosity=0, interactive=False, stderr=err)\n-        self.assertTrue(b\"Cache table 'test cache table' could not be created\" in err.getvalue())\n+        with self.assertRaisesRegexp(management.CommandError,\n+                \"Cache table 'test cache table' could not be created\"):\n+            management.call_command(\n+               'createcachetable',\n+                self._table_name,\n+                verbosity=0,\n+                interactive=False\n+            )\n \n \n @override_settings(USE_TZ=True)"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 14,
        "deletions": 11
    }
}