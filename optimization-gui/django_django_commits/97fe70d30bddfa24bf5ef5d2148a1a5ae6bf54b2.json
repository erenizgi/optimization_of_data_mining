{
    "author": "claudep",
    "message": "[py3] Used BytesIO to test request streams",
    "sha": "97fe70d30bddfa24bf5ef5d2148a1a5ae6bf54b2",
    "files": [
        {
            "sha": "f9e1112b2e9859f4067be8be409681ab8f9a8895",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 28,
            "deletions": 28,
            "changes": 56,
            "blob_url": "https://github.com/django/django/blob/97fe70d30bddfa24bf5ef5d2148a1a5ae6bf54b2/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/97fe70d30bddfa24bf5ef5d2148a1a5ae6bf54b2/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=97fe70d30bddfa24bf5ef5d2148a1a5ae6bf54b2",
            "patch": "@@ -3,24 +3,24 @@\n import time\n import warnings\n from datetime import datetime, timedelta\n+from io import BytesIO\n \n from django.conf import settings\n from django.core.handlers.wsgi import WSGIRequest, LimitedStream\n from django.http import HttpRequest, HttpResponse, parse_cookie, build_request_repr, UnreadablePostError\n from django.test.utils import str_prefix\n from django.utils import unittest\n from django.utils.http import cookie_date\n-from django.utils.six import StringIO\n from django.utils.timezone import utc\n \n \n class RequestsTests(unittest.TestCase):\n     def test_httprequest(self):\n         request = HttpRequest()\n-        self.assertEqual(request.GET.keys(), [])\n-        self.assertEqual(request.POST.keys(), [])\n-        self.assertEqual(request.COOKIES.keys(), [])\n-        self.assertEqual(request.META.keys(), [])\n+        self.assertEqual(list(request.GET.keys()), [])\n+        self.assertEqual(list(request.POST.keys()), [])\n+        self.assertEqual(list(request.COOKIES.keys()), [])\n+        self.assertEqual(list(request.META.keys()), [])\n \n     def test_httprequest_repr(self):\n         request = HttpRequest()\n@@ -35,17 +35,17 @@ def test_httprequest_repr(self):\n                          str_prefix(\"<HttpRequest\\npath:/otherpath/,\\nGET:{%(_)s'a': %(_)s'b'},\\nPOST:{%(_)s'c': %(_)s'd'},\\nCOOKIES:{%(_)s'e': %(_)s'f'},\\nMETA:{%(_)s'g': %(_)s'h'}>\"))\n \n     def test_wsgirequest(self):\n-        request = WSGIRequest({'PATH_INFO': 'bogus', 'REQUEST_METHOD': 'bogus', 'wsgi.input': StringIO('')})\n-        self.assertEqual(request.GET.keys(), [])\n-        self.assertEqual(request.POST.keys(), [])\n-        self.assertEqual(request.COOKIES.keys(), [])\n+        request = WSGIRequest({'PATH_INFO': 'bogus', 'REQUEST_METHOD': 'bogus', 'wsgi.input': BytesIO(b'')})\n+        self.assertEqual(list(request.GET.keys()), [])\n+        self.assertEqual(list(request.POST.keys()), [])\n+        self.assertEqual(list(request.COOKIES.keys()), [])\n         self.assertEqual(set(request.META.keys()), set(['PATH_INFO', 'REQUEST_METHOD', 'SCRIPT_NAME', 'wsgi.input']))\n         self.assertEqual(request.META['PATH_INFO'], 'bogus')\n         self.assertEqual(request.META['REQUEST_METHOD'], 'bogus')\n         self.assertEqual(request.META['SCRIPT_NAME'], '')\n \n     def test_wsgirequest_repr(self):\n-        request = WSGIRequest({'PATH_INFO': '/somepath/', 'REQUEST_METHOD': 'get', 'wsgi.input': StringIO('')})\n+        request = WSGIRequest({'PATH_INFO': '/somepath/', 'REQUEST_METHOD': 'get', 'wsgi.input': BytesIO(b'')})\n         request.GET = {'get-key': 'get-value'}\n         request.POST = {'post-key': 'post-value'}\n         request.COOKIES = {'post-key': 'post-value'}\n@@ -207,26 +207,26 @@ def test_httponly_cookie(self):\n \n     def test_limited_stream(self):\n         # Read all of a limited stream\n-        stream = LimitedStream(StringIO(b'test'), 2)\n+        stream = LimitedStream(BytesIO(b'test'), 2)\n         self.assertEqual(stream.read(), b'te')\n         # Reading again returns nothing.\n         self.assertEqual(stream.read(), b'')\n \n         # Read a number of characters greater than the stream has to offer\n-        stream = LimitedStream(StringIO(b'test'), 2)\n+        stream = LimitedStream(BytesIO(b'test'), 2)\n         self.assertEqual(stream.read(5), b'te')\n         # Reading again returns nothing.\n         self.assertEqual(stream.readline(5), b'')\n \n         # Read sequentially from a stream\n-        stream = LimitedStream(StringIO(b'12345678'), 8)\n+        stream = LimitedStream(BytesIO(b'12345678'), 8)\n         self.assertEqual(stream.read(5), b'12345')\n         self.assertEqual(stream.read(5), b'678')\n         # Reading again returns nothing.\n         self.assertEqual(stream.readline(5), b'')\n \n         # Read lines from a stream\n-        stream = LimitedStream(StringIO(b'1234\\n5678\\nabcd\\nefgh\\nijkl'), 24)\n+        stream = LimitedStream(BytesIO(b'1234\\n5678\\nabcd\\nefgh\\nijkl'), 24)\n         # Read a full line, unconditionally\n         self.assertEqual(stream.readline(), b'1234\\n')\n         # Read a number of characters less than a line\n@@ -246,7 +246,7 @@ def test_limited_stream(self):\n         # If a stream contains a newline, but the provided length\n         # is less than the number of provided characters, the newline\n         # doesn't reset the available character count\n-        stream = LimitedStream(StringIO(b'1234\\nabcdef'), 9)\n+        stream = LimitedStream(BytesIO(b'1234\\nabcdef'), 9)\n         self.assertEqual(stream.readline(10), b'1234\\n')\n         self.assertEqual(stream.readline(3), b'abc')\n         # Now expire the available characters\n@@ -255,7 +255,7 @@ def test_limited_stream(self):\n         self.assertEqual(stream.readline(2), b'')\n \n         # Same test, but with read, not readline.\n-        stream = LimitedStream(StringIO(b'1234\\nabcdef'), 9)\n+        stream = LimitedStream(BytesIO(b'1234\\nabcdef'), 9)\n         self.assertEqual(stream.read(6), b'1234\\na')\n         self.assertEqual(stream.read(2), b'bc')\n         self.assertEqual(stream.read(2), b'd')\n@@ -266,7 +266,7 @@ def test_stream(self):\n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         self.assertEqual(request.read(), b'name=value')\n \n     def test_read_after_value(self):\n@@ -277,7 +277,7 @@ def test_read_after_value(self):\n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         self.assertEqual(request.POST, {'name': ['value']})\n         self.assertEqual(request.body, b'name=value')\n         self.assertEqual(request.read(), b'name=value')\n@@ -290,7 +290,7 @@ def test_value_after_read(self):\n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         self.assertEqual(request.read(2), b'na')\n         self.assertRaises(Exception, lambda: request.body)\n         self.assertEqual(request.POST, {})\n@@ -312,7 +312,7 @@ def test_body_after_POST_multipart(self):\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_TYPE': 'multipart/form-data; boundary=boundary',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         self.assertEqual(request.POST, {'name': ['value']})\n         self.assertRaises(Exception, lambda: request.body)\n \n@@ -334,14 +334,14 @@ def test_POST_multipart_with_content_length_zero(self):\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_TYPE': 'multipart/form-data; boundary=boundary',\n                                'CONTENT_LENGTH': 0,\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         self.assertEqual(request.POST, {})\n \n     def test_read_by_lines(self):\n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         self.assertEqual(list(request), [b'name=value'])\n \n     def test_POST_after_body_read(self):\n@@ -351,7 +351,7 @@ def test_POST_after_body_read(self):\n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         raw_data = request.body\n         self.assertEqual(request.POST, {'name': ['value']})\n \n@@ -363,7 +363,7 @@ def test_POST_after_body_read_and_stream_read(self):\n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         raw_data = request.body\n         self.assertEqual(request.read(1), b'n')\n         self.assertEqual(request.POST, {'name': ['value']})\n@@ -383,7 +383,7 @@ def test_POST_after_body_read_and_stream_read_multipart(self):\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_TYPE': 'multipart/form-data; boundary=boundary',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': StringIO(payload)})\n+                               'wsgi.input': BytesIO(payload)})\n         raw_data = request.body\n         # Consume enough data to mess up the parsing:\n         self.assertEqual(request.read(13), b'--boundary\\r\\nC')\n@@ -397,7 +397,7 @@ def test_raw_post_data_returns_body(self):\n         request = WSGIRequest({\n             'REQUEST_METHOD': 'POST',\n             'CONTENT_LENGTH': len(payload),\n-            'wsgi.input': StringIO(payload)\n+            'wsgi.input': BytesIO(payload)\n         })\n \n         with warnings.catch_warnings(record=True):\n@@ -408,14 +408,14 @@ def test_POST_connection_error(self):\n         If wsgi.input.read() raises an exception while trying to read() the\n         POST, the exception should be identifiable (not a generic IOError).\n         \"\"\"\n-        class ExplodingStringIO(StringIO):\n+        class ExplodingBytesIO(BytesIO):\n             def read(self, len=0):\n                 raise IOError(\"kaboom!\")\n \n         payload = b'name=value'\n         request = WSGIRequest({'REQUEST_METHOD': 'POST',\n                                'CONTENT_LENGTH': len(payload),\n-                               'wsgi.input': ExplodingStringIO(payload)})\n+                               'wsgi.input': ExplodingBytesIO(payload)})\n \n         with warnings.catch_warnings(record=True) as w:\n             warnings.simplefilter(\"always\")"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 28,
        "deletions": 28
    }
}