{
    "author": "carljm",
    "message": "Reduced code duplication in cache middleware tests.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15557 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f",
    "files": [
        {
            "sha": "ac85f2de747babb3f655b97bab146cbe8e8d5830",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 47,
            "deletions": 41,
            "changes": 88,
            "blob_url": "https://github.com/django/django/blob/ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=ed7a30782b7bf0e30fd47fc407e3b9c22bd80d2f",
            "patch": "@@ -14,13 +14,14 @@\n from django.core.cache.backends.base import CacheKeyWarning\n from django.http import HttpResponse, HttpRequest\n from django.middleware.cache import FetchFromCacheMiddleware, UpdateCacheMiddleware, CacheMiddleware\n-from django.test import RequestFactory, TestCase\n+from django.test import RequestFactory\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import translation\n from django.utils import unittest\n from django.utils.cache import patch_vary_headers, get_cache_key, learn_cache_key\n from django.utils.hashcompat import md5_constructor\n from django.views.decorators.cache import cache_page\n+\n from regressiontests.cache.models import Poll, expensive_calculation\n \n # functions/classes for complex data type tests\n@@ -1127,9 +1128,15 @@ def tearDown(self):\n         else:\n             settings.CACHES['default']['KEY_PREFIX'] = self.old_cache_key_prefix\n \n+\n+def hello_world_view(request, value):\n+    return HttpResponse('Hello World %s' % value)\n+\n class CacheMiddlewareTest(unittest.TestCase):\n \n     def setUp(self):\n+        self.factory = RequestFactory()\n+\n         self.orig_cache_middleware_alias = settings.CACHE_MIDDLEWARE_ALIAS\n         self.orig_cache_middleware_key_prefix = settings.CACHE_MIDDLEWARE_KEY_PREFIX\n         self.orig_cache_middleware_seconds = settings.CACHE_MIDDLEWARE_SECONDS\n@@ -1191,22 +1198,17 @@ def test_constructor(self):\n         self.assertEquals(as_view_decorator_with_custom.cache_anonymous_only, True)\n \n     def test_middleware(self):\n-        def view(request, value):\n-            return HttpResponse('Hello World %s' % value)\n-\n-        factory = RequestFactory()\n-\n         middleware = CacheMiddleware()\n         prefix_middleware = CacheMiddleware(key_prefix='prefix1')\n         timeout_middleware = CacheMiddleware(cache_timeout=1)\n \n-        request = factory.get('/view/')\n+        request = self.factory.get('/view/')\n \n         # Put the request through the request middleware\n         result = middleware.process_request(request)\n         self.assertEquals(result, None)\n \n-        response = view(request, '1')\n+        response = hello_world_view(request, '1')\n \n         # Now put the response through the response middleware\n         response = middleware.process_response(request, response)\n@@ -1225,23 +1227,48 @@ def view(request, value):\n         self.assertNotEquals(result, None)\n         self.assertEquals(result.content, 'Hello World 1')\n \n-    def test_view_decorator(self):\n-        def view(request, value):\n-            return HttpResponse('Hello World %s' % value)\n+    def test_cache_middleware_anonymous_only_wont_cause_session_access(self):\n+        \"\"\" The cache middleware shouldn't cause a session access due to\n+        CACHE_MIDDLEWARE_ANONYMOUS_ONLY if nothing else has accessed the\n+        session. Refs 13283 \"\"\"\n+        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = True\n+\n+        from django.contrib.sessions.middleware import SessionMiddleware\n+        from django.contrib.auth.middleware import AuthenticationMiddleware\n+\n+        middleware = CacheMiddleware()\n+        session_middleware = SessionMiddleware()\n+        auth_middleware = AuthenticationMiddleware()\n+\n+        request = self.factory.get('/view_anon/')\n+\n+        # Put the request through the request middleware\n+        session_middleware.process_request(request)\n+        auth_middleware.process_request(request)\n+        result = middleware.process_request(request)\n+        self.assertEquals(result, None)\n+\n+        response = hello_world_view(request, '1')\n+\n+        # Now put the response through the response middleware\n+        session_middleware.process_response(request, response)\n+        response = middleware.process_response(request, response)\n+\n+        self.assertEqual(request.session.accessed, False)\n \n+    def test_view_decorator(self):\n         # decorate the same view with different cache decorators\n-        default_view = cache_page(view)\n-        default_with_prefix_view = cache_page(key_prefix='prefix1')(view)\n+        default_view = cache_page(hello_world_view)\n+        default_with_prefix_view = cache_page(key_prefix='prefix1')(hello_world_view)\n \n-        explicit_default_view = cache_page(cache='default')(view)\n-        explicit_default_with_prefix_view = cache_page(cache='default', key_prefix='prefix1')(view)\n+        explicit_default_view = cache_page(cache='default')(hello_world_view)\n+        explicit_default_with_prefix_view = cache_page(cache='default', key_prefix='prefix1')(hello_world_view)\n \n-        other_view = cache_page(cache='other')(view)\n-        other_with_prefix_view = cache_page(cache='other', key_prefix='prefix2')(view)\n-        other_with_timeout_view = cache_page(4, cache='other', key_prefix='prefix3')(view)\n+        other_view = cache_page(cache='other')(hello_world_view)\n+        other_with_prefix_view = cache_page(cache='other', key_prefix='prefix2')(hello_world_view)\n+        other_with_timeout_view = cache_page(4, cache='other', key_prefix='prefix3')(hello_world_view)\n \n-        factory = RequestFactory()\n-        request = factory.get('/view/')\n+        request = self.factory.get('/view/')\n \n         # Request the view once\n         response = default_view(request, '1')\n@@ -1322,26 +1349,5 @@ def view(request, value):\n         response = other_with_timeout_view(request, '18')\n         self.assertEquals(response.content, 'Hello World 18')\n \n-class CacheMiddlewareAnonymousOnlyTests(TestCase):\n-    urls = 'regressiontests.cache.urls'\n-\n-    def setUp(self):\n-        self._orig_cache_middleware_anonymous_only = \\\n-            getattr(settings, 'CACHE_MIDDLEWARE_ANONYMOUS_ONLY', False)\n-        self._orig_middleware_classes = settings.MIDDLEWARE_CLASSES\n-\n-        settings.MIDDLEWARE_CLASSES = list(settings.MIDDLEWARE_CLASSES)\n-        settings.MIDDLEWARE_CLASSES.insert(0, 'django.middleware.cache.UpdateCacheMiddleware')\n-        settings.MIDDLEWARE_CLASSES += ['django.middleware.cache.FetchFromCacheMiddleware']\n-\n-    def tearDown(self):\n-        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = self._orig_cache_middleware_anonymous_only\n-        settings.MIDDLEWARE_CLASSES = self._orig_middleware_classes\n-\n-    def test_cache_middleware_anonymous_only_does_not_cause_vary_cookie(self):\n-        settings.CACHE_MIDDLEWARE_ANONYMOUS_ONLY = True\n-        response = self.client.get('/')\n-        self.failIf('Cookie' in response.get('Vary', ''))\n-\n if __name__ == '__main__':\n     unittest.main()"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 47,
        "deletions": 41
    }
}