{
    "author": "claudep",
    "message": "Fixed #18182 -- Made is_usable_password check if hashing algorithm is correct\n\nThe display of the ReadOnlyPasswordHashWidget has also been improved to\ndistinguish empty/unusable password from erroneous password.\nFixed #18453 also.\nThanks danielr and Leo for the reports and Moritz Sichert for the\ninitial patch.",
    "sha": "703c266682be39f7153498ad0d8031231f12ee79",
    "files": [
        {
            "sha": "08488237c79a7377f046619702cf51f9f8dfc140",
            "filename": "django/contrib/auth/forms.py",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/django/django/blob/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fforms.py?ref=703c266682be39f7153498ad0d8031231f12ee79",
            "patch": "@@ -11,7 +11,7 @@\n \n from django.contrib.auth import authenticate\n from django.contrib.auth.models import User\n-from django.contrib.auth.hashers import UNUSABLE_PASSWORD, is_password_usable, identify_hasher\n+from django.contrib.auth.hashers import UNUSABLE_PASSWORD, identify_hasher\n from django.contrib.auth.tokens import default_token_generator\n from django.contrib.sites.models import get_current_site\n \n@@ -24,22 +24,22 @@\n class ReadOnlyPasswordHashWidget(forms.Widget):\n     def render(self, name, value, attrs):\n         encoded = value\n-\n-        if not is_password_usable(encoded):\n-            return \"None\"\n-\n         final_attrs = self.build_attrs(attrs)\n \n-        try:\n-            hasher = identify_hasher(encoded)\n-        except ValueError:\n-            summary = mark_safe(\"<strong>Invalid password format or unknown hashing algorithm.</strong>\")\n+        if encoded == '' or encoded == UNUSABLE_PASSWORD:\n+            summary = mark_safe(\"<strong>%s</strong>\" % ugettext(\"No password set.\"))\n         else:\n-            summary = format_html_join('',\n-                                       \"<strong>{0}</strong>: {1} \",\n-                                       ((ugettext(key), value)\n-                                        for key, value in hasher.safe_summary(encoded).items())\n-                                       )\n+            try:\n+                hasher = identify_hasher(encoded)\n+            except ValueError:\n+                summary = mark_safe(\"<strong>%s</strong>\" % ugettext(\n+                    \"Invalid password format or unknown hashing algorithm.\"))\n+            else:\n+                summary = format_html_join('',\n+                                           \"<strong>{0}</strong>: {1} \",\n+                                           ((ugettext(key), value)\n+                                            for key, value in hasher.safe_summary(encoded).items())\n+                                           )\n \n         return format_html(\"<div{0}>{1}</div>\", flatatt(final_attrs), summary)\n "
        },
        {
            "sha": "c628059d34da0ed334ffdbaccd14966e9606f50a",
            "filename": "django/contrib/auth/hashers.py",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhashers.py?ref=703c266682be39f7153498ad0d8031231f12ee79",
            "patch": "@@ -28,7 +28,13 @@ def reset_hashers(**kwargs):\n \n \n def is_password_usable(encoded):\n-    return (encoded is not None and encoded != UNUSABLE_PASSWORD)\n+    if encoded is None or encoded == UNUSABLE_PASSWORD:\n+        return False\n+    try:\n+        hasher = identify_hasher(encoded)\n+    except ValueError:\n+        return False\n+    return True\n \n \n def check_password(password, encoded, setter=None, preferred='default'):"
        },
        {
            "sha": "8fee3501c5de51c789829506235f74552850aab6",
            "filename": "django/contrib/auth/tests/forms.py",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fforms.py?ref=703c266682be39f7153498ad0d8031231f12ee79",
            "patch": "@@ -236,23 +236,30 @@ class Meta(UserChangeForm.Meta):\n         # Just check we can create it\n         form = MyUserForm({})\n \n+    def test_unsuable_password(self):\n+        user = User.objects.get(username='empty_password')\n+        user.set_unusable_password()\n+        user.save()\n+        form = UserChangeForm(instance=user)\n+        self.assertIn(_(\"No password set.\"), form.as_table())\n+\n     def test_bug_17944_empty_password(self):\n         user = User.objects.get(username='empty_password')\n         form = UserChangeForm(instance=user)\n-        # Just check that no error is raised.\n-        form.as_table()\n+        self.assertIn(_(\"Invalid password format or unknown hashing algorithm.\"),\n+            form.as_table())\n \n     def test_bug_17944_unmanageable_password(self):\n         user = User.objects.get(username='unmanageable_password')\n         form = UserChangeForm(instance=user)\n-        # Just check that no error is raised.\n-        form.as_table()\n+        self.assertIn(_(\"Invalid password format or unknown hashing algorithm.\"),\n+            form.as_table())\n \n     def test_bug_17944_unknown_password_algorithm(self):\n         user = User.objects.get(username='unknown_password')\n         form = UserChangeForm(instance=user)\n-        # Just check that no error is raised.\n-        form.as_table()\n+        self.assertIn(_(\"Invalid password format or unknown hashing algorithm.\"),\n+            form.as_table())\n \n \n @override_settings(USE_TZ=False, PASSWORD_HASHERS=('django.contrib.auth.hashers.SHA1PasswordHasher',))"
        },
        {
            "sha": "d867a57d985ebc047940083a55c4227a14269228",
            "filename": "django/contrib/auth/tests/hashers.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/703c266682be39f7153498ad0d8031231f12ee79/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py?ref=703c266682be39f7153498ad0d8031231f12ee79",
            "patch": "@@ -100,6 +100,10 @@ def doit():\n         self.assertRaises(ValueError, doit)\n         self.assertRaises(ValueError, identify_hasher, \"lolcat$salt$hash\")\n \n+    def test_bad_encoded(self):\n+        self.assertFalse(is_password_usable('letmein_badencoded'))\n+        self.assertFalse(is_password_usable(''))\n+\n     def test_low_level_pkbdf2(self):\n         hasher = PBKDF2PasswordHasher()\n         encoded = hasher.encode('letmein', 'seasalt')"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 38,
        "deletions": 21
    }
}