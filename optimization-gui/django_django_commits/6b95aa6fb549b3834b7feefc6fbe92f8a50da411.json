{
    "author": "jezdez",
    "message": "Fixed #15531 -- Partially reverted [15701] due to compatibility issues with middlewares that modify content of responses. Thanks for the report, schinckel. Refs #15281.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15703 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6b95aa6fb549b3834b7feefc6fbe92f8a50da411",
    "files": [
        {
            "sha": "4e179dc7c0d5a2e5471857cce64a1f273f25132f",
            "filename": "django/core/servers/basehttp.py",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/6b95aa6fb549b3834b7feefc6fbe92f8a50da411/django%2Fcore%2Fservers%2Fbasehttp.py",
            "raw_url": "https://github.com/django/django/raw/6b95aa6fb549b3834b7feefc6fbe92f8a50da411/django%2Fcore%2Fservers%2Fbasehttp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fservers%2Fbasehttp.py?ref=6b95aa6fb549b3834b7feefc6fbe92f8a50da411",
            "patch": "@@ -19,7 +19,6 @@\n from django.utils.http import http_date\n from django.utils._os import safe_join\n from django.views import static\n-from django.views.static import FileWrapper # for backwards compatibility, #15281\n \n from django.contrib.staticfiles import handlers\n \n@@ -33,6 +32,30 @@\n class WSGIServerException(Exception):\n     pass\n \n+class FileWrapper(object):\n+    \"\"\"Wrapper to convert file-like objects to iterables\"\"\"\n+\n+    def __init__(self, filelike, blksize=8192):\n+        self.filelike = filelike\n+        self.blksize = blksize\n+        if hasattr(filelike,'close'):\n+            self.close = filelike.close\n+\n+    def __getitem__(self,key):\n+        data = self.filelike.read(self.blksize)\n+        if data:\n+            return data\n+        raise IndexError\n+\n+    def __iter__(self):\n+        return self\n+\n+    def next(self):\n+        data = self.filelike.read(self.blksize)\n+        if data:\n+            return data\n+        raise StopIteration\n+\n # Regular expression that matches `special' characters in parameters, the\n # existence of which force quoting of the parameter value.\n tspecials = re.compile(r'[ \\(\\)<>@,;:\\\\\"/\\[\\]\\?=]')"
        },
        {
            "sha": "c058cd3ff80ba8594270eece84bea5a40dd325cf",
            "filename": "django/views/static.py",
            "status": "modified",
            "additions": 2,
            "deletions": 31,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/6b95aa6fb549b3834b7feefc6fbe92f8a50da411/django%2Fviews%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/6b95aa6fb549b3834b7feefc6fbe92f8a50da411/django%2Fviews%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fstatic.py?ref=6b95aa6fb549b3834b7feefc6fbe92f8a50da411",
            "patch": "@@ -9,39 +9,10 @@\n import re\n import urllib\n \n-from django.template import loader\n from django.http import Http404, HttpResponse, HttpResponseRedirect, HttpResponseNotModified\n-\n-from django.template import Template, Context, TemplateDoesNotExist\n+from django.template import loader, Template, Context, TemplateDoesNotExist\n from django.utils.http import http_date, parse_http_date\n \n-\n-class FileWrapper(object):\n-    \"\"\"\n-    Wrapper to convert file-like objects to iterables\n-    \"\"\"\n-    def __init__(self, filelike, blksize=8192):\n-        self.filelike = filelike\n-        self.blksize = blksize\n-        if hasattr(filelike,'close'):\n-            self.close = filelike.close\n-\n-    def __getitem__(self,key):\n-        data = self.filelike.read(self.blksize)\n-        if data:\n-            return data\n-        raise IndexError\n-\n-    def __iter__(self):\n-        return self\n-\n-    def next(self):\n-        data = self.filelike.read(self.blksize)\n-        if data:\n-            return data\n-        raise StopIteration\n-\n-\n def serve(request, path, document_root=None, show_indexes=False):\n     \"\"\"\n     Serve static files below a given point in the directory structure.\n@@ -85,7 +56,7 @@ def serve(request, path, document_root=None, show_indexes=False):\n     if not was_modified_since(request.META.get('HTTP_IF_MODIFIED_SINCE'),\n                               statobj.st_mtime, statobj.st_size):\n         return HttpResponseNotModified(mimetype=mimetype)\n-    response = HttpResponse(FileWrapper(open(fullpath, 'rb')), mimetype=mimetype)\n+    response = HttpResponse(open(fullpath, 'rb').read(), mimetype=mimetype)\n     response[\"Last-Modified\"] = http_date(statobj.st_mtime)\n     response[\"Content-Length\"] = statobj.st_size\n     if encoding:"
        },
        {
            "sha": "e3bc1643c512ab5b81a3a0551412716f7f6d0108",
            "filename": "tests/regressiontests/views/tests/static.py",
            "status": "modified",
            "additions": 8,
            "deletions": 16,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/6b95aa6fb549b3834b7feefc6fbe92f8a50da411/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py",
            "raw_url": "https://github.com/django/django/raw/6b95aa6fb549b3834b7feefc6fbe92f8a50da411/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fstatic.py?ref=6b95aa6fb549b3834b7feefc6fbe92f8a50da411",
            "patch": "@@ -26,18 +26,10 @@ def test_serve(self):\n         for filename in media_files:\n             response = self.client.get('/views/%s/%s' % (self.prefix, filename))\n             file_path = path.join(media_dir, filename)\n-            content = str(response.content)\n-            self.assertEquals(open(file_path).read(), content)\n-            self.assertEquals(len(content), int(response['Content-Length']))\n+            self.assertEquals(open(file_path).read(), response.content)\n+            self.assertEquals(len(response.content), int(response['Content-Length']))\n             self.assertEquals(mimetypes.guess_type(file_path)[1], response.get('Content-Encoding', None))\n \n-    def test_serve_does_not_buffer_files(self):\n-        \"The static view uses an iterator - see #15281\"\n-        response = self.client.get('/views/%s/file.txt' % self.prefix)\n-        # response objects can't be used as file-like objects when they are\n-        # initialized with an iterator\n-        self.assertRaises(Exception, response.write, 'more text')\n-\n     def test_unknown_mime_type(self):\n         response = self.client.get('/views/%s/file.unknown' % self.prefix)\n         self.assertEquals('application/octet-stream', response['Content-Type'])\n@@ -76,9 +68,9 @@ def test_invalid_if_modified_since(self):\n         response = self.client.get('/views/%s/%s' % (self.prefix, file_name),\n                                    HTTP_IF_MODIFIED_SINCE=invalid_date)\n         file = open(path.join(media_dir, file_name))\n-        content = str(response.content)\n-        self.assertEquals(file.read(), content)\n-        self.assertEquals(len(content), int(response['Content-Length']))\n+        self.assertEquals(file.read(), response.content)\n+        self.assertEquals(len(response.content),\n+                          int(response['Content-Length']))\n \n     def test_invalid_if_modified_since2(self):\n         \"\"\"Handle even more bogus If-Modified-Since values gracefully\n@@ -90,10 +82,10 @@ def test_invalid_if_modified_since2(self):\n         invalid_date = ': 1291108438, Wed, 20 Oct 2010 14:05:00 GMT'\n         response = self.client.get('/views/%s/%s' % (self.prefix, file_name),\n                                    HTTP_IF_MODIFIED_SINCE=invalid_date)\n-        content = str(response.content)\n         file = open(path.join(media_dir, file_name))\n-        self.assertEquals(file.read(), content)\n-        self.assertEquals(len(content), int(response['Content-Length']))\n+        self.assertEquals(file.read(), response.content)\n+        self.assertEquals(len(response.content),\n+                          int(response['Content-Length']))\n \n \n class StaticHelperTest(StaticTests):"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 34,
        "deletions": 48
    }
}