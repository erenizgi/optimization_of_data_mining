{
    "author": "SmileyChris",
    "message": "Fixes #17327 -- Add --database option to createsuperuser and change password management commands\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17665 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8c9b032ea03911185622ea4ef12ccea5ee7e3455",
    "files": [
        {
            "sha": "e2815ed117f8e2a038f8857a2d7f0f690029d24c",
            "filename": "django/contrib/auth/management/commands/changepassword.py",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py",
            "raw_url": "https://github.com/django/django/raw/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fchangepassword.py?ref=8c9b032ea03911185622ea4ef12ccea5ee7e3455",
            "patch": "@@ -1,8 +1,17 @@\n+import getpass\n+from optparse import make_option\n+\n from django.core.management.base import BaseCommand, CommandError\n from django.contrib.auth.models import User\n-import getpass\n+from django.db import DEFAULT_DB_ALIAS\n+\n \n class Command(BaseCommand):\n+    option_list = BaseCommand.option_list + (\n+        make_option('--database', action='store', dest='database',\n+            default=DEFAULT_DB_ALIAS, help='Nominates a database to query for the user. '\n+                    'Defaults to the \"default\" database.'),\n+    )\n     help = \"Change a user's password for django.contrib.auth.\"\n \n     requires_model_validation = False\n@@ -23,11 +32,11 @@ def handle(self, *args, **options):\n             username = getpass.getuser()\n \n         try:\n-            u = User.objects.get(username=username)\n+            u = User.objects.using(options.get('database')).get(username=username)\n         except User.DoesNotExist:\n             raise CommandError(\"user '%s' does not exist\" % username)\n \n-        print \"Changing password for user '%s'\" % u.username\n+        self.stdout.write(\"Changing password for user '%s'\\n\" % u.username)\n \n         MAX_TRIES = 3\n         count = 0\n@@ -36,7 +45,7 @@ def handle(self, *args, **options):\n             p1 = self._get_pass()\n             p2 = self._get_pass(\"Password (again): \")\n             if p1 != p2:\n-                print \"Passwords do not match. Please try again.\"\n+                self.stdout.write(\"Passwords do not match. Please try again.\\n\")\n                 count = count + 1\n \n         if count == MAX_TRIES:"
        },
        {
            "sha": "89a76b3279982f7f5e8d62ac09d24d9aff332cec",
            "filename": "django/contrib/auth/management/commands/createsuperuser.py",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "raw_url": "https://github.com/django/django/raw/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2Fcommands%2Fcreatesuperuser.py?ref=8c9b032ea03911185622ea4ef12ccea5ee7e3455",
            "patch": "@@ -6,10 +6,12 @@\n import re\n import sys\n from optparse import make_option\n+\n from django.contrib.auth.models import User\n from django.contrib.auth.management import get_default_username\n from django.core import exceptions\n from django.core.management.base import BaseCommand, CommandError\n+from django.db import DEFAULT_DB_ALIAS\n from django.utils.translation import ugettext as _\n \n RE_VALID_USERNAME = re.compile('[\\w.@+-]+$')\n@@ -19,10 +21,12 @@\n     r'|^\"([\\001-\\010\\013\\014\\016-\\037!#-\\[\\]-\\177]|\\\\[\\001-\\011\\013\\014\\016-\\177])*\"' # quoted-string\n     r')@(?:[A-Z0-9-]+\\.)+[A-Z]{2,6}$', re.IGNORECASE)  # domain\n \n+\n def is_valid_email(value):\n     if not EMAIL_RE.search(value):\n         raise exceptions.ValidationError(_('Enter a valid e-mail address.'))\n \n+\n class Command(BaseCommand):\n     option_list = BaseCommand.option_list + (\n         make_option('--username', dest='username', default=None,\n@@ -34,6 +38,9 @@ class Command(BaseCommand):\n                   'You must use --username and --email with --noinput, and '\n                   'superusers created with --noinput will not be able to log '\n                   'in until they\\'re given a valid password.')),\n+        make_option('--database', action='store', dest='database',\n+            default=DEFAULT_DB_ALIAS, help='Nominates a database to save the user to. '\n+                    'Defaults to the \"default\" database.'),\n     )\n     help = 'Used to create a superuser.'\n \n@@ -42,6 +49,7 @@ def handle(self, *args, **options):\n         email = options.get('email', None)\n         interactive = options.get('interactive')\n         verbosity = int(options.get('verbosity', 1))\n+        database = options.get('database')\n \n         # Do quick and dirty validation if --noinput\n         if not interactive:\n@@ -77,7 +85,7 @@ def handle(self, *args, **options):\n                         username = None\n                         continue\n                     try:\n-                        User.objects.get(username=username)\n+                        User.objects.using(database).get(username=username)\n                     except User.DoesNotExist:\n                         break\n                     else:\n@@ -114,7 +122,7 @@ def handle(self, *args, **options):\n                 sys.stderr.write(\"\\nOperation cancelled.\\n\")\n                 sys.exit(1)\n \n-        User.objects.create_superuser(username, email, password)\n+        User.objects.db_manager(database).create_superuser(username, email, password)\n         if verbosity >= 1:\n           self.stdout.write(\"Superuser created successfully.\\n\")\n "
        },
        {
            "sha": "cd314f6050a6dcf523f8366c10fa2f6993806422",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=8c9b032ea03911185622ea4ef12ccea5ee7e3455",
            "patch": "@@ -9,7 +9,12 @@\n     UserChangeFormTest, PasswordResetFormTest)\n from django.contrib.auth.tests.remote_user import (RemoteUserTest,\n     RemoteUserNoCreateTest, RemoteUserCustomTest)\n-from django.contrib.auth.tests.management import GetDefaultUsernameTestCase\n+from django.contrib.auth.tests.management import (\n+    GetDefaultUsernameTestCase,\n+    ChangepasswordManagementCommandTestCase,\n+    MultiDBChangepasswordManagementCommandTestCase,\n+    MultiDBCreatesuperuserTestCase,\n+)\n from django.contrib.auth.tests.models import (ProfileTestCase, NaturalKeysTestCase,\n     LoadDataWithoutNaturalKeysTestCase, LoadDataWithNaturalKeysTestCase,\n     UserManagerTestCase)"
        },
        {
            "sha": "2287ab91adafe153954cfa877de7a428ddac14b6",
            "filename": "django/contrib/auth/tests/management.py",
            "status": "modified",
            "additions": 96,
            "deletions": 1,
            "changes": 97,
            "blob_url": "https://github.com/django/django/blob/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/8c9b032ea03911185622ea4ef12ccea5ee7e3455/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fmanagement.py?ref=8c9b032ea03911185622ea4ef12ccea5ee7e3455",
            "patch": "@@ -1,5 +1,9 @@\n-from django.test import TestCase\n+from StringIO import StringIO\n+\n from django.contrib.auth import models, management\n+from django.contrib.auth.management.commands import changepassword\n+from django.core.management import call_command\n+from django.test import TestCase\n \n \n class GetDefaultUsernameTestCase(TestCase):\n@@ -25,3 +29,94 @@ def test_i18n(self):\n         # 'Julia' with accented 'u':\n         management.get_system_username = lambda: u'J\\xfalia'\n         self.assertEqual(management.get_default_username(), 'julia')\n+\n+\n+class ChangepasswordManagementCommandTestCase(TestCase):\n+\n+    def setUp(self):\n+        self.user = models.User.objects.create_user(username='joe', password='qwerty')\n+        self.stdout = StringIO()\n+        self.stderr = StringIO()\n+\n+    def tearDown(self):\n+        self.stdout.close()\n+        self.stderr.close()\n+\n+    def test_that_changepassword_command_changes_joes_password(self):\n+        \" Executing the changepassword management command should change joe's password \"\n+        self.assertTrue(self.user.check_password('qwerty'))\n+        command = changepassword.Command()\n+        command._get_pass = lambda *args: 'not qwerty'\n+\n+        command.execute(\"joe\", stdout=self.stdout)\n+        command_output = self.stdout.getvalue().strip()\n+\n+        self.assertEquals(command_output, \"Changing password for user 'joe'\\nPassword changed successfully for user 'joe'\")\n+        self.assertTrue(models.User.objects.get(username=\"joe\").check_password(\"not qwerty\"))\n+\n+    def test_that_max_tries_exits_1(self):\n+        \"\"\"\n+        A CommandError should be thrown by handle() if the user enters in\n+        mismatched passwords three times. This should be caught by execute() and\n+        converted to a SystemExit\n+        \"\"\"\n+        command = changepassword.Command()\n+        command._get_pass = lambda *args: args or 'foo'\n+\n+        self.assertRaises(\n+            SystemExit,\n+            command.execute,\n+            \"joe\",\n+            stdout=self.stdout,\n+            stderr=self.stderr\n+        )\n+\n+\n+class MultiDBChangepasswordManagementCommandTestCase(TestCase):\n+    multi_db = True\n+\n+    def setUp(self):\n+        self.user = models.User.objects.db_manager('other').create_user(username='joe', password='qwerty')\n+        self.stdout = StringIO()\n+\n+    def tearDown(self):\n+        self.stdout.close()\n+\n+    def test_that_changepassword_command_with_database_option_uses_given_db(self):\n+        \"\"\"\n+        Executing the changepassword management command with a database option\n+        should operate on the specified DB\n+        \"\"\"\n+        self.assertTrue(self.user.check_password('qwerty'))\n+        command = changepassword.Command()\n+        command._get_pass = lambda *args: 'not qwerty'\n+\n+        command.execute(\"joe\", database='other', stdout=self.stdout)\n+        command_output = self.stdout.getvalue().strip()\n+\n+        self.assertEquals(command_output, \"Changing password for user 'joe'\\nPassword changed successfully for user 'joe'\")\n+        self.assertTrue(models.User.objects.using('other').get(username=\"joe\").check_password(\"not qwerty\"))\n+\n+\n+class MultiDBCreatesuperuserTestCase(TestCase):\n+    multi_db = True\n+\n+    def test_createsuperuser_command_with_database_option(self):\n+        \" createsuperuser command should operate on specified DB\"\n+        new_io = StringIO()\n+\n+        call_command(\"createsuperuser\",\n+            interactive=False,\n+            username=\"joe\",\n+            email=\"joe@somewhere.org\",\n+            database='other',\n+            stdout=new_io\n+        )\n+        command_output = new_io.getvalue().strip()\n+\n+        self.assertEqual(command_output, 'Superuser created successfully.')\n+\n+        u = models.User.objects.using('other').get(username=\"joe\")\n+        self.assertEqual(u.email, 'joe@somewhere.org')\n+\n+        new_io.close()"
        },
        {
            "sha": "5af56fa248daa59eae5d44a8b6bef190d5bbe014",
            "filename": "docs/ref/django-admin.txt",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/8c9b032ea03911185622ea4ef12ccea5ee7e3455/docs%2Fref%2Fdjango-admin.txt",
            "raw_url": "https://github.com/django/django/raw/8c9b032ea03911185622ea4ef12ccea5ee7e3455/docs%2Fref%2Fdjango-admin.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdjango-admin.txt?ref=8c9b032ea03911185622ea4ef12ccea5ee7e3455",
            "patch": "@@ -1197,6 +1197,12 @@ the user given as parameter. If they both match, the new password will be\n changed immediately. If you do not supply a user, the command will attempt to\n change the password whose username matches the current user.\n \n+.. versionadded:: 1.4\n+.. django-admin-option:: --database\n+\n+The ``--database`` option can be used to specify the database to query for the\n+user. If it is not supplied the ``default`` database will be used.\n+\n Example usage::\n \n     django-admin.py changepassword ringo\n@@ -1227,6 +1233,12 @@ using the ``--username`` and ``--email`` arguments on the command\n line. If either of those is not supplied, ``createsuperuser`` will prompt for\n it when running interactively.\n \n+.. versionadded:: 1.4\n+.. django-admin-option:: --database\n+\n+The ``--database`` option can be used to specify the database into which the \n+superuser object will be saved.\n+\n ``django.contrib.gis``\n ----------------------\n "
        }
    ],
    "stats": {
        "total": 145,
        "additions": 137,
        "deletions": 8
    }
}