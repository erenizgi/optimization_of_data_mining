{
    "author": "claudep",
    "message": "[py3] Fix encoding issues in contrib.sessions",
    "sha": "8a1f439d3aca3a021a43ba6c4235c3ac68908657",
    "files": [
        {
            "sha": "4515edbb17ef1e3ef6d0518a22e78af73207a655",
            "filename": "django/contrib/sessions/backends/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/8a1f439d3aca3a021a43ba6c4235c3ac68908657/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/8a1f439d3aca3a021a43ba6c4235c3ac68908657/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fbase.py?ref=8a1f439d3aca3a021a43ba6c4235c3ac68908657",
            "patch": "@@ -1,3 +1,5 @@\n+from __future__ import unicode_literals\n+\n import base64\n import time\n from datetime import datetime, timedelta\n@@ -12,6 +14,7 @@\n from django.utils.crypto import get_random_string\n from django.utils.crypto import salted_hmac\n from django.utils import timezone\n+from django.utils.encoding import smart_bytes\n \n class CreateError(Exception):\n     \"\"\"\n@@ -78,15 +81,15 @@ def encode(self, session_dict):\n         \"Returns the given session dictionary pickled and encoded as a string.\"\n         pickled = pickle.dumps(session_dict, pickle.HIGHEST_PROTOCOL)\n         hash = self._hash(pickled)\n-        return base64.encodestring(hash + \":\" + pickled)\n+        return base64.encodestring(hash.encode() + b\":\" + pickled)\n \n     def decode(self, session_data):\n-        encoded_data = base64.decodestring(session_data)\n+        encoded_data = base64.decodestring(smart_bytes(session_data))\n         try:\n             # could produce ValueError if there is no ':'\n-            hash, pickled = encoded_data.split(':', 1)\n+            hash, pickled = encoded_data.split(b':', 1)\n             expected_hash = self._hash(pickled)\n-            if not constant_time_compare(hash, expected_hash):\n+            if not constant_time_compare(hash.decode(), expected_hash):\n                 raise SuspiciousOperation(\"Session data corrupted\")\n             else:\n                 return pickle.loads(pickled)"
        },
        {
            "sha": "babdb72c27b7add267b790c069dbb324d8f0c001",
            "filename": "django/contrib/sessions/backends/db.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/8a1f439d3aca3a021a43ba6c4235c3ac68908657/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/8a1f439d3aca3a021a43ba6c4235c3ac68908657/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsessions%2Fbackends%2Fdb.py?ref=8a1f439d3aca3a021a43ba6c4235c3ac68908657",
            "patch": "@@ -1,7 +1,6 @@\n from django.contrib.sessions.backends.base import SessionBase, CreateError\n from django.core.exceptions import SuspiciousOperation\n from django.db import IntegrityError, transaction, router\n-from django.utils.encoding import force_text\n from django.utils import timezone\n \n \n@@ -18,7 +17,7 @@ def load(self):\n                 session_key = self.session_key,\n                 expire_date__gt=timezone.now()\n             )\n-            return self.decode(force_text(s.session_data))\n+            return self.decode(s.session_data)\n         except (Session.DoesNotExist, SuspiciousOperation):\n             self.create()\n             return {}"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 8,
        "deletions": 6
    }
}