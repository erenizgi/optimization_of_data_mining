{
    "author": "claudep",
    "message": "Fixed #18845 -- Do not swallow AttributeErrors when running commands",
    "sha": "bb7da7844ff9f11286509c22a2549bbd4553d58d",
    "files": [
        {
            "sha": "c61ab2b663db85203246f160e793b4290c16bd9c",
            "filename": "django/core/management/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/bb7da7844ff9f11286509c22a2549bbd4553d58d/django%2Fcore%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/bb7da7844ff9f11286509c22a2549bbd4553d58d/django%2Fcore%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2F__init__.py?ref=bb7da7844ff9f11286509c22a2549bbd4553d58d",
            "patch": "@@ -103,10 +103,12 @@ def get_commands():\n         _commands = dict([(name, 'django.core') for name in find_commands(__path__[0])])\n \n         # Find the installed apps\n+        from django.conf import settings\n         try:\n-            from django.conf import settings\n             apps = settings.INSTALLED_APPS\n-        except (AttributeError, ImproperlyConfigured):\n+        except ImproperlyConfigured:\n+            # Still useful for commands that do not require functional settings,\n+            # like startproject or help\n             apps = []\n \n         # Find and load the management module for each installed app."
        },
        {
            "sha": "6f524bea29e160b9877ae4cfbd4c076750c4a474",
            "filename": "tests/regressiontests/admin_scripts/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/bb7da7844ff9f11286509c22a2549bbd4553d58d/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bb7da7844ff9f11286509c22a2549bbd4553d58d/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_scripts%2Ftests.py?ref=bb7da7844ff9f11286509c22a2549bbd4553d58d",
            "patch": "@@ -982,13 +982,11 @@ def test_custom_command_with_environment(self):\n         self.assertNoOutput(err)\n         self.assertOutput(out, \"EXECUTE:NoArgsCommand\")\n \n+\n class ManageSettingsWithImportError(AdminScriptTestCase):\n     \"\"\"Tests for manage.py when using the default settings.py file\n     with an import error. Ticket #14130.\n     \"\"\"\n-    def setUp(self):\n-        self.write_settings_with_import_error('settings.py')\n-\n     def tearDown(self):\n         self.remove_settings('settings.py')\n \n@@ -1004,12 +1002,27 @@ def write_settings_with_import_error(self, filename, apps=None, is_dir=False, sd\n             settings_file.write('# The next line will cause an import error:\\nimport foo42bar\\n')\n \n     def test_builtin_command(self):\n-        \"import error: manage.py builtin commands shows useful diagnostic info when settings with import errors is provided\"\n+        \"\"\"\n+        import error: manage.py builtin commands shows useful diagnostic info\n+        when settings with import errors is provided\n+        \"\"\"\n+        self.write_settings_with_import_error('settings.py')\n         args = ['sqlall', 'admin_scripts']\n         out, err = self.run_manage(args)\n         self.assertNoOutput(out)\n         self.assertOutput(err, \"No module named foo42bar\")\n \n+    def test_builtin_command_with_attribute_error(self):\n+        \"\"\"\n+        manage.py builtin commands does not swallow attribute errors from bad settings (#18845)\n+        \"\"\"\n+        self.write_settings('settings.py', sdict={'BAD_VAR': 'INSTALLED_APPS.crash'})\n+        args = ['collectstatic', 'admin_scripts']\n+        out, err = self.run_manage(args)\n+        self.assertNoOutput(out)\n+        self.assertOutput(err, \"AttributeError: 'list' object has no attribute 'crash'\")\n+\n+\n class ManageValidate(AdminScriptTestCase):\n     def tearDown(self):\n         self.remove_settings('settings.py')"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 21,
        "deletions": 6
    }
}