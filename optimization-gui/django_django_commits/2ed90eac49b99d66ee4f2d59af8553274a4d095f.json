{
    "author": "claudep",
    "message": "Fixed #19779 -- Checked contrib.sites presence in RedirectFallbackMiddleware\n\nThanks Aymeric Augustin for the report and directions for the patch.",
    "sha": "2ed90eac49b99d66ee4f2d59af8553274a4d095f",
    "files": [
        {
            "sha": "03c9d97c0ddded42d1522ef18103aa0eeba97c29",
            "filename": "django/contrib/redirects/middleware.py",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/2ed90eac49b99d66ee4f2d59af8553274a4d095f/django%2Fcontrib%2Fredirects%2Fmiddleware.py",
            "raw_url": "https://github.com/django/django/raw/2ed90eac49b99d66ee4f2d59af8553274a4d095f/django%2Fcontrib%2Fredirects%2Fmiddleware.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fredirects%2Fmiddleware.py?ref=2ed90eac49b99d66ee4f2d59af8553274a4d095f",
            "patch": "@@ -1,11 +1,20 @@\n from __future__ import unicode_literals\n \n+from django.conf import settings\n from django.contrib.redirects.models import Redirect\n from django.contrib.sites.models import get_current_site\n+from django.core.exceptions import ImproperlyConfigured\n from django import http\n-from django.conf import settings\n+\n \n class RedirectFallbackMiddleware(object):\n+    def __init__(self):\n+        if 'django.contrib.sites' not in settings.INSTALLED_APPS:\n+            raise ImproperlyConfigured(\n+                \"You cannot use RedirectFallbackMiddleware when \"\n+                \"django.contrib.sites is not installed.\"\n+            )\n+\n     def process_response(self, request, response):\n         if response.status_code != 404:\n             return response # No need to check for a redirect for non-404 responses."
        },
        {
            "sha": "bdcdf4a9e147b97c13e3a4071dd6eb9cd5b07836",
            "filename": "django/contrib/redirects/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/2ed90eac49b99d66ee4f2d59af8553274a4d095f/django%2Fcontrib%2Fredirects%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/2ed90eac49b99d66ee4f2d59af8553274a4d095f/django%2Fcontrib%2Fredirects%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fredirects%2Ftests.py?ref=2ed90eac49b99d66ee4f2d59af8553274a4d095f",
            "patch": "@@ -1,9 +1,11 @@\n from django.conf import settings\n from django.contrib.sites.models import Site\n+from django.core.exceptions import ImproperlyConfigured\n from django.test import TestCase\n from django.test.utils import override_settings\n from django.utils import six\n \n+from .middleware import RedirectFallbackMiddleware\n from .models import Redirect\n \n \n@@ -52,3 +54,10 @@ def test_response_gone(self):\n             site=self.site, old_path='/initial', new_path='')\n         response = self.client.get('/initial')\n         self.assertEqual(response.status_code, 410)\n+\n+    @override_settings(\n+        INSTALLED_APPS=[app for app in settings.INSTALLED_APPS\n+                        if app != 'django.contrib.sites'])\n+    def test_sites_not_installed(self):\n+        with self.assertRaises(ImproperlyConfigured):\n+            RedirectFallbackMiddleware()"
        },
        {
            "sha": "0c0cb2a3c2cce9cc93512eabcce4026c1abe1039",
            "filename": "docs/ref/contrib/redirects.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/2ed90eac49b99d66ee4f2d59af8553274a4d095f/docs%2Fref%2Fcontrib%2Fredirects.txt",
            "raw_url": "https://github.com/django/django/raw/2ed90eac49b99d66ee4f2d59af8553274a4d095f/docs%2Fref%2Fcontrib%2Fredirects.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fredirects.txt?ref=2ed90eac49b99d66ee4f2d59af8553274a4d095f",
            "patch": "@@ -13,11 +13,12 @@ Installation\n \n To install the redirects app, follow these steps:\n \n-1. Add ``'django.contrib.redirects'`` to your :setting:`INSTALLED_APPS`\n-   setting.\n-2. Add ``'django.contrib.redirects.middleware.RedirectFallbackMiddleware'``\n+1. Ensure that the ``django.contrib.sites`` framework\n+   :ref:`is installed <enabling-the-sites-framework>`.\n+2. Add ``'django.contrib.redirects'`` to your :setting:`INSTALLED_APPS` setting.\n+3. Add ``'django.contrib.redirects.middleware.RedirectFallbackMiddleware'``\n    to your :setting:`MIDDLEWARE_CLASSES` setting.\n-3. Run the command :djadmin:`manage.py syncdb <syncdb>`.\n+4. Run the command :djadmin:`manage.py syncdb <syncdb>`.\n \n How it works\n ============"
        },
        {
            "sha": "139a9b377fd0db1c5cdd5c56ee38c15ff5ddf37f",
            "filename": "docs/ref/contrib/sites.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/2ed90eac49b99d66ee4f2d59af8553274a4d095f/docs%2Fref%2Fcontrib%2Fsites.txt",
            "raw_url": "https://github.com/django/django/raw/2ed90eac49b99d66ee4f2d59af8553274a4d095f/docs%2Fref%2Fcontrib%2Fsites.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fsites.txt?ref=2ed90eac49b99d66ee4f2d59af8553274a4d095f",
            "patch": "@@ -246,6 +246,7 @@ To do this, you can use the sites framework. A simple example::\n     >>> 'http://%s%s' % (Site.objects.get_current().domain, obj.get_absolute_url())\n     'http://example.com/mymodel/objects/3/'\n \n+.. _enabling-the-sites-framework:\n \n Enabling the sites framework\n ============================"
        },
        {
            "sha": "33dcb0e794f771c4a52e8c1a1e144989486fd22f",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/2ed90eac49b99d66ee4f2d59af8553274a4d095f/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/2ed90eac49b99d66ee4f2d59af8553274a4d095f/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=2ed90eac49b99d66ee4f2d59af8553274a4d095f",
            "patch": "@@ -653,6 +653,12 @@ Miscellaneous\n   Attempting to load it with ``{% load adminmedia %}`` will fail. If your\n   templates still contain that line you must remove it.\n \n+* Because of an implementation oversight, it was possible to use\n+  :doc:`django.contrib.redirects </ref/contrib/redirects>` without enabling\n+  :doc:`django.contrib.sites </ref/contrib/sites>`. This isn't allowed any\n+  longer. If you're using ``django.contrib.redirects``, make sure\n+  :setting:``INSTALLED_APPS`` contains ``django.contrib.sites``.\n+\n Features deprecated in 1.5\n ==========================\n "
        }
    ],
    "stats": {
        "total": 36,
        "additions": 31,
        "deletions": 5
    }
}