{
    "author": "carljm",
    "message": "Fixed #11319 - Added lookup support for ForeignKey.to_field. Also reverted no-longer-needed model formsets workaround for lack of such support from r10756. Thanks Russell and Alex for review.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15303 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
    "files": [
        {
            "sha": "b9ffcbd238b11ffd1a5a13de1863a84ae3d80093",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -178,9 +178,20 @@ def _pk_trace(self, value, prep_func, lookup_type, **kwargs):\n         # the primary key may itself be an object - so we need to keep drilling\n         # down until we hit a value that can be used for a comparison.\n         v = value\n+\n+        # In the case of an FK to 'self', this check allows to_field to be used\n+        # for both forwards and reverse lookups across the FK. (For normal FKs,\n+        # it's only relevant for forward lookups).\n+        if isinstance(v, self.rel.to):\n+            field_name = getattr(self.rel, \"field_name\", None)\n+        else:\n+            field_name = None\n         try:\n             while True:\n-                v = getattr(v, v._meta.pk.name)\n+                if field_name is None:\n+                    field_name = v._meta.pk.name\n+                v = getattr(v, field_name)\n+                field_name = None\n         except AttributeError:\n             pass\n         except exceptions.ObjectDoesNotExist:"
        },
        {
            "sha": "e028800d72712d3d7451f485cb8c054886dd3653",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -1364,7 +1364,12 @@ def setup_joins(self, names, opts, alias, dupe_multis, allow_many=True,\n                         table = opts.db_table\n                         from_col = local_field.column\n                         to_col = field.column\n-                        target = opts.pk\n+                        # In case of a recursive FK, use the to_field for\n+                        # reverse lookups as well\n+                        if orig_field.model is local_field.model:\n+                            target = opts.get_field(field.rel.field_name)\n+                        else:\n+                            target = opts.pk\n                         orig_opts._join_cache[name] = (table, from_col, to_col,\n                                 opts, target)\n "
        },
        {
            "sha": "6babebbe36cf4adbe1177c0834eee5688943bb42",
            "filename": "django/forms/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/django%2Fforms%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/django%2Fforms%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Fmodels.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -700,13 +700,9 @@ def __init__(self, data=None, files=None, instance=None,\n         self.save_as_new = save_as_new\n         # is there a better way to get the object descriptor?\n         self.rel_name = RelatedObject(self.fk.rel.to, self.model, self.fk).get_accessor_name()\n-        if self.fk.rel.field_name == self.fk.rel.to._meta.pk.name:\n-            backlink_value = self.instance\n-        else:\n-            backlink_value = getattr(self.instance, self.fk.rel.field_name)\n         if queryset is None:\n             queryset = self.model._default_manager\n-        qs = queryset.filter(**{self.fk.name: backlink_value})\n+        qs = queryset.filter(**{self.fk.name: self.instance})\n         super(BaseInlineFormSet, self).__init__(data, files, prefix=prefix,\n                                                 queryset=qs)\n "
        },
        {
            "sha": "c410ad17e327c946a75a4afc8f0e0af505797fd5",
            "filename": "tests/modeltests/custom_pk/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fmodeltests%2Fcustom_pk%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fmodeltests%2Fcustom_pk%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fcustom_pk%2Ftests.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -158,11 +158,9 @@ def test_custom_field_pk(self):\n         new_bar = Bar.objects.create()\n         new_foo = Foo.objects.create(bar=new_bar)\n \n-        # FIXME: This still doesn't work, but will require some changes in\n-        # get_db_prep_lookup to fix it.\n-        # f = Foo.objects.get(bar=new_bar.pk)\n-        # self.assertEqual(f, new_foo)\n-        # self.assertEqual(f.bar, new_bar)\n+        f = Foo.objects.get(bar=new_bar.pk)\n+        self.assertEqual(f, new_foo)\n+        self.assertEqual(f.bar, new_bar)\n \n         f = Foo.objects.get(bar=new_bar)\n         self.assertEqual(f, new_foo),"
        },
        {
            "sha": "5c77117719a086acadca68eb6ac9a4ebca364b4f",
            "filename": "tests/regressiontests/delete_regress/models.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -44,3 +44,10 @@ class Email(Contact):\n \n class Researcher(models.Model):\n     contacts = models.ManyToManyField(Contact, related_name=\"research_contacts\")\n+\n+class Food(models.Model):\n+    name = models.CharField(max_length=20, unique=True)\n+\n+class Eaten(models.Model):\n+    food = models.ForeignKey(Food, to_field=\"name\")\n+    meal = models.CharField(max_length=20)"
        },
        {
            "sha": "06f3b5c86608436afcff61afde8f12fa3bb615aa",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -5,7 +5,7 @@\n from django.test import TestCase, TransactionTestCase, skipUnlessDBFeature\n \n from models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n-    PlayedWithNote, Contact, Email, Researcher)\n+    PlayedWithNote, Contact, Email, Researcher, Food, Eaten)\n \n \n # Can't run this test under SQLite, because you can't\n@@ -119,6 +119,16 @@ def test_inheritance(self):\n \n         email.delete()\n \n+    def test_to_field(self):\n+        \"\"\"\n+        Cascade deletion works with ForeignKey.to_field set to non-PK.\n+\n+        \"\"\"\n+        apple = Food.objects.create(name=\"apple\")\n+        eaten = Eaten.objects.create(food=apple, meal=\"lunch\")\n+\n+        apple.delete()\n+\n class LargeDeleteTests(TestCase):\n     def test_large_deletes(self):\n         \"Regression for #13309 -- if the number of objects > chunk size, deletion still occurs\""
        },
        {
            "sha": "3b7a08aba2ebc3a2fb224fe5cce9969004169a02",
            "filename": "tests/regressiontests/queries/models.py",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Fmodels.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -274,3 +274,23 @@ def __unicode__(self):\n class Article(models.Model):\n     name = models.CharField(max_length=20)\n     created = models.DateTimeField()\n+\n+class Food(models.Model):\n+    name = models.CharField(max_length=20, unique=True)\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class Eaten(models.Model):\n+    food = models.ForeignKey(Food, to_field=\"name\")\n+    meal = models.CharField(max_length=20)\n+\n+    def __unicode__(self):\n+        return u\"%s at %s\" % (self.food, self.meal)\n+\n+class Node(models.Model):\n+    num = models.IntegerField(unique=True)\n+    parent = models.ForeignKey(\"self\", to_field=\"num\", null=True)\n+\n+    def __unicode__(self):\n+        return u\"%s\" % self.num"
        },
        {
            "sha": "4099fb6dad0c9c6ef7988318d0d1a7f703c46946",
            "filename": "tests/regressiontests/queries/tests.py",
            "status": "modified",
            "additions": 62,
            "deletions": 1,
            "changes": 63,
            "blob_url": "https://github.com/django/django/blob/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/227c5e80dbff2b731a1cba8c4dd94c00526a3e76/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Ftests.py?ref=227c5e80dbff2b731a1cba8c4dd94c00526a3e76",
            "patch": "@@ -14,7 +14,7 @@\n from models import (Annotation, Article, Author, Celebrity, Child, Cover, Detail,\n     DumbCategory, ExtraInfo, Fan, Item, LeafA, LoopX, LoopZ, ManagedModel,\n     Member, NamedCategory, Note, Number, Plaything, PointerA, Ranking, Related,\n-    Report, ReservedName, Tag, TvChef, Valid, X)\n+    Report, ReservedName, Tag, TvChef, Valid, X, Food, Eaten, Node)\n \n \n class BaseQuerysetTest(TestCase):\n@@ -1515,6 +1515,67 @@ def test_ticket_7302(self):\n         )\n \n \n+class ToFieldTests(TestCase):\n+    def test_in_query(self):\n+        apple = Food.objects.create(name=\"apple\")\n+        pear = Food.objects.create(name=\"pear\")\n+        lunch = Eaten.objects.create(food=apple, meal=\"lunch\")\n+        dinner = Eaten.objects.create(food=pear, meal=\"dinner\")\n+\n+        self.assertEqual(\n+            set(Eaten.objects.filter(food__in=[apple, pear])),\n+            set([lunch, dinner]),\n+        )\n+\n+    def test_reverse_in(self):\n+        apple = Food.objects.create(name=\"apple\")\n+        pear = Food.objects.create(name=\"pear\")\n+        lunch_apple = Eaten.objects.create(food=apple, meal=\"lunch\")\n+        lunch_pear = Eaten.objects.create(food=pear, meal=\"dinner\")\n+\n+        self.assertEqual(\n+            set(Food.objects.filter(eaten__in=[lunch_apple, lunch_pear])),\n+            set([apple, pear])\n+        )\n+\n+    def test_single_object(self):\n+        apple = Food.objects.create(name=\"apple\")\n+        lunch = Eaten.objects.create(food=apple, meal=\"lunch\")\n+        dinner = Eaten.objects.create(food=apple, meal=\"dinner\")\n+\n+        self.assertEqual(\n+            set(Eaten.objects.filter(food=apple)),\n+            set([lunch, dinner])\n+        )\n+\n+    def test_single_object_reverse(self):\n+        apple = Food.objects.create(name=\"apple\")\n+        lunch = Eaten.objects.create(food=apple, meal=\"lunch\")\n+\n+        self.assertEqual(\n+            set(Food.objects.filter(eaten=lunch)),\n+            set([apple])\n+        )\n+\n+    def test_recursive_fk(self):\n+        node1 = Node.objects.create(num=42)\n+        node2 = Node.objects.create(num=1, parent=node1)\n+\n+        self.assertEqual(\n+            list(Node.objects.filter(parent=node1)),\n+            [node2]\n+        )\n+\n+    def test_recursive_fk_reverse(self):\n+        node1 = Node.objects.create(num=42)\n+        node2 = Node.objects.create(num=1, parent=node1)\n+\n+        self.assertEqual(\n+            list(Node.objects.filter(node=node2)),\n+            [node1]\n+        )\n+\n+\n class ConditionalTests(BaseQuerysetTest):\n     \"\"\"Tests whose execution depend on dfferent environment conditions like\n     Python version or DB backend features\"\"\""
        }
    ],
    "stats": {
        "total": 136,
        "additions": 122,
        "deletions": 14
    }
}