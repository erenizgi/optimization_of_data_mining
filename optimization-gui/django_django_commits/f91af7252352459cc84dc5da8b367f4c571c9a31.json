{
    "author": "carljm",
    "message": "Fixed #16353 -- don't try to create Site objects on all databases. Refs #15573, #15346. Thanks Aymeric Augustin for the report and the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16868 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f91af7252352459cc84dc5da8b367f4c571c9a31",
    "files": [
        {
            "sha": "ee5f9db3361681208df4fe4125399fea7e86d985",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f91af7252352459cc84dc5da8b367f4c571c9a31/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f91af7252352459cc84dc5da8b367f4c571c9a31/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=f91af7252352459cc84dc5da8b367f4c571c9a31",
            "patch": "@@ -56,14 +56,6 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n             interactive=False,\n             database=self.connection.alias)\n \n-        # One effect of calling syncdb followed by flush is that the id of the\n-        # default site may or may not be 1, depending on how the sequence was\n-        # reset.  If the sites app is loaded, then we coerce it.\n-        from django.db.models import get_model\n-        Site = get_model('sites', 'Site')\n-        if Site is not None and Site.objects.using(self.connection.alias).count() == 1:\n-            Site.objects.using(self.connection.alias).update(id=settings.SITE_ID)\n-\n         from django.core.cache import get_cache\n         from django.core.cache.backends.db import BaseDatabaseCache\n         for cache_alias in settings.CACHES:"
        },
        {
            "sha": "daec3d9eec2e49ee74443e3880cccfee16d53bea",
            "filename": "django/contrib/sites/management.py",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/f91af7252352459cc84dc5da8b367f4c571c9a31/django%2Fcontrib%2Fsites%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/f91af7252352459cc84dc5da8b367f4c571c9a31/django%2Fcontrib%2Fsites%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fsites%2Fmanagement.py?ref=f91af7252352459cc84dc5da8b367f4c571c9a31",
            "patch": "@@ -3,14 +3,21 @@\n \"\"\"\n \n from django.db.models import signals\n+from django.db import router\n from django.contrib.sites.models import Site\n from django.contrib.sites import models as site_app\n \n def create_default_site(app, created_models, verbosity, db, **kwargs):\n-    if Site in created_models:\n+    # Only create the default sites in databases where Django created the table\n+    if Site in created_models and router.allow_syncdb(db, Site) :\n         if verbosity >= 2:\n             print \"Creating example.com Site object\"\n-        s = Site(domain=\"example.com\", name=\"example.com\")\n+        # The default settings set SITE_ID = 1, and some tests in Django's test\n+        # suite rely on this value. However, if database sequences are reused\n+        # (e.g. in the test suite after flush/syncdb), it isn't guaranteed that\n+        # the next id will be 1, so we coerce it. See #15573 and #16353. This\n+        # can also crop up outside of tests - see #15346.\n+        s = Site(pk=1, domain=\"example.com\", name=\"example.com\")\n         s.save(using=db)\n     Site.objects.clear_cache()\n "
        },
        {
            "sha": "fa0feffeac2703fe666a5b6a80b6a65015755a45",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f91af7252352459cc84dc5da8b367f4c571c9a31/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f91af7252352459cc84dc5da8b367f4c571c9a31/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=f91af7252352459cc84dc5da8b367f4c571c9a31",
            "patch": "@@ -248,14 +248,6 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n             interactive=False,\n             database=self.connection.alias)\n \n-        # One effect of calling syncdb followed by flush is that the id of the\n-        # default site may or may not be 1, depending on how the sequence was\n-        # reset.  If the sites app is loaded, then we coerce it.\n-        from django.db.models import get_model\n-        Site = get_model('sites', 'Site')\n-        if Site is not None and Site.objects.using(self.connection.alias).count() == 1:\n-            Site.objects.using(self.connection.alias).update(id=settings.SITE_ID)\n-\n         from django.core.cache import get_cache\n         from django.core.cache.backends.db import BaseDatabaseCache\n         for cache_alias in settings.CACHES:"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 9,
        "deletions": 18
    }
}