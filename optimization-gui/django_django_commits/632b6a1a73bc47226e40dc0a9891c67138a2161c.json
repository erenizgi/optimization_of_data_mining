{
    "author": "aaugustin",
    "message": "Fixed #17439 -- Prevented spurious queries for missing objects after prefetch_related has run.\n\nThat affects nullable foreign key, nullable one-to-one, and reverse one-to-one relations.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17899 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "632b6a1a73bc47226e40dc0a9891c67138a2161c",
    "files": [
        {
            "sha": "efa3e45e9f6f672254e3613b089d0fadab1880b1",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/632b6a1a73bc47226e40dc0a9891c67138a2161c/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/632b6a1a73bc47226e40dc0a9891c67138a2161c/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=632b6a1a73bc47226e40dc0a9891c67138a2161c",
            "patch": "@@ -6,6 +6,7 @@\n import itertools\n import sys\n \n+from django.core import exceptions\n from django.db import connections, router, transaction, IntegrityError\n from django.db.models.fields import AutoField\n from django.db.models.query_utils import (Q, select_related_descend,\n@@ -1677,12 +1678,19 @@ def prefetch_related_objects(result_cache, related_lookups):\n                 # (e.g. via select_related), or hopefully some other property\n                 # that doesn't support prefetching but needs to be traversed.\n \n-                # We replace the current list of parent objects with that list.\n-                obj_list = [getattr(obj, attr) for obj in obj_list]\n-\n-                # Filter out 'None' so that we can continue with nullable\n-                # relations.\n-                obj_list = [obj for obj in obj_list if obj is not None]\n+                # We replace the current list of parent objects with the list\n+                # of related objects, filtering out empty or missing values so\n+                # that we can continue with nullable or reverse relations.\n+                new_obj_list = []\n+                for obj in obj_list:\n+                    try:\n+                        new_obj = getattr(obj, attr)\n+                    except exceptions.ObjectDoesNotExist:\n+                        continue\n+                    if new_obj is None:\n+                        continue\n+                    new_obj_list.append(new_obj)\n+                obj_list = new_obj_list\n \n \n def get_prefetcher(instance, attr):\n@@ -1778,8 +1786,7 @@ def prefetch_one_level(instances, prefetcher, attname):\n         vals = rel_obj_cache.get(instance_attr_val, [])\n         if single:\n             # Need to assign to single cache on instance\n-            if vals:\n-                setattr(obj, cache_name, vals[0])\n+            setattr(obj, cache_name, vals[0] if vals else None)\n         else:\n             # Multi, attribute represents a manager with an .all() method that\n             # returns a QuerySet"
        },
        {
            "sha": "c15294af1d39ec996e6ed184900cadf3ef418e26",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/632b6a1a73bc47226e40dc0a9891c67138a2161c/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/632b6a1a73bc47226e40dc0a9891c67138a2161c/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=632b6a1a73bc47226e40dc0a9891c67138a2161c",
            "patch": "@@ -68,6 +68,14 @@ def test_foreignkey_reverse(self):\n \n         self.assertQuerysetEqual(self.book2.authors.all(), [u\"<Author: Charlotte>\"])\n \n+    def test_onetoone_reverse_no_match(self):\n+        # Regression for #17439\n+        with self.assertNumQueries(2):\n+            book = Book.objects.prefetch_related('bookwithyear').all()[0]\n+        with self.assertNumQueries(0):\n+            with self.assertRaises(BookWithYear.DoesNotExist):\n+                book.bookwithyear\n+\n     def test_survives_clone(self):\n         with self.assertNumQueries(2):\n             lists = [list(b.first_time_authors.all())"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 23,
        "deletions": 8
    }
}