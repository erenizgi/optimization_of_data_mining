{
    "author": "akaariai",
    "message": "Fixed #17485 regression -- only + select_related interaction\n\nWhen doing deeper than one level select_related() + only queries(), the\ncode introduced in b6c356b7bb97f3d6d4831b31e67868313bbbc090 errored\nincorrectly.\n\nThanks to mrmachine for report & test case.",
    "sha": "f399a804c9436a5d3ef9e2b73c337904af2c753d",
    "files": [
        {
            "sha": "f06d6b11a4c3b023c6ded5c604b41cf52595a3df",
            "filename": "django/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f399a804c9436a5d3ef9e2b73c337904af2c753d/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/f399a804c9436a5d3ef9e2b73c337904af2c753d/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=f399a804c9436a5d3ef9e2b73c337904af2c753d",
            "patch": "@@ -609,8 +609,12 @@ def fill_related_selections(self, opts=None, root_alias=None, cur_depth=1,\n                 restricted = False\n \n         for f, model in opts.get_fields_with_model():\n+            # The get_fields_with_model() returns None for fields that live\n+            # in the field's local model. So, for those fields we want to use\n+            # the f.model - that is the field's local model.\n+            field_model = model or f.model\n             if not select_related_descend(f, restricted, requested,\n-                                          only_load.get(model or self.query.model)):\n+                                          only_load.get(field_model)):\n                 continue\n             # The \"avoid\" set is aliases we want to avoid just for this\n             # particular branch of the recursion. They aren't permanently"
        },
        {
            "sha": "444649ac92199a97e5abb7b29d803cfe88e4a0c0",
            "filename": "tests/regressiontests/defer_regress/models.py",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/f399a804c9436a5d3ef9e2b73c337904af2c753d/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f399a804c9436a5d3ef9e2b73c337904af2c753d/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py?ref=f399a804c9436a5d3ef9e2b73c337904af2c753d",
            "patch": "@@ -52,6 +52,9 @@ def __str__(self):\n class Feature(models.Model):\n     item = models.ForeignKey(SimpleItem)\n \n+class SpecialFeature(models.Model):\n+    feature = models.ForeignKey(Feature)\n+\n class ItemAndSimpleItem(models.Model):\n     item = models.ForeignKey(Item)\n     simple = models.ForeignKey(SimpleItem)"
        },
        {
            "sha": "c77ca32135d8663bef32707833495235d8c4681c",
            "filename": "tests/regressiontests/defer_regress/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/f399a804c9436a5d3ef9e2b73c337904af2c753d/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f399a804c9436a5d3ef9e2b73c337904af2c753d/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py?ref=f399a804c9436a5d3ef9e2b73c337904af2c753d",
            "patch": "@@ -9,7 +9,7 @@\n from django.test import TestCase\n \n from .models import (ResolveThis, Item, RelatedItem, Child, Leaf, Proxy,\n-    SimpleItem, Feature, ItemAndSimpleItem)\n+    SimpleItem, Feature, ItemAndSimpleItem, SpecialFeature)\n \n \n class DeferRegressionTest(TestCase):\n@@ -115,6 +115,7 @@ def test_basic(self):\n                 RelatedItem,\n                 ResolveThis,\n                 SimpleItem,\n+                SpecialFeature,\n             ]\n         )\n \n@@ -152,6 +153,7 @@ def test_basic(self):\n                 \"RelatedItem_Deferred_item_id\",\n                 \"ResolveThis\",\n                 \"SimpleItem\",\n+                \"SpecialFeature\",\n             ]\n         )\n \n@@ -197,6 +199,18 @@ def test_defer_with_select_related(self):\n         self.assertEqual(obj.item, item2)\n         self.assertEqual(obj.item_id, item2.id)\n \n+    def test_only_with_select_related(self):\n+        # Test for #17485.\n+        item = SimpleItem.objects.create(name='first', value=47)\n+        feature = Feature.objects.create(item=item)\n+        SpecialFeature.objects.create(feature=feature)\n+\n+        qs = Feature.objects.only('item__name').select_related('item')\n+        self.assertEqual(len(qs), 1)\n+\n+        qs = SpecialFeature.objects.only('feature__item__name').select_related('feature__item')\n+        self.assertEqual(len(qs), 1)\n+\n     def test_deferred_class_factory(self):\n         from django.db.models.query_utils import deferred_class_factory\n         new_class = deferred_class_factory(Item,"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 23,
        "deletions": 2
    }
}