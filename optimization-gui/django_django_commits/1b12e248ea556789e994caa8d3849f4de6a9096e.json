{
    "author": "aaugustin",
    "message": "Fixed #11569 -- Wrapped DatabaseCache._base_set in an atomic block.\n\nThe atomic block provides a clean rollback to a savepoint on failed writes.\n\nThe ticket reported a race condition which I don't know how to test.",
    "sha": "1b12e248ea556789e994caa8d3849f4de6a9096e",
    "files": [
        {
            "sha": "f18b05db2fc40a9474ec0557a0f8c5d8a56b9a87",
            "filename": "django/core/cache/backends/db.py",
            "status": "modified",
            "additions": 15,
            "deletions": 14,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/1b12e248ea556789e994caa8d3849f4de6a9096e/django%2Fcore%2Fcache%2Fbackends%2Fdb.py",
            "raw_url": "https://github.com/django/django/raw/1b12e248ea556789e994caa8d3849f4de6a9096e/django%2Fcore%2Fcache%2Fbackends%2Fdb.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcache%2Fbackends%2Fdb.py?ref=1b12e248ea556789e994caa8d3849f4de6a9096e",
            "patch": "@@ -10,7 +10,7 @@\n \n from django.conf import settings\n from django.core.cache.backends.base import BaseCache\n-from django.db import connections, router, DatabaseError\n+from django.db import connections, transaction, router, DatabaseError\n from django.utils import timezone, six\n from django.utils.encoding import force_bytes\n \n@@ -26,7 +26,7 @@ def __init__(self, table):\n         self.model_name = 'cacheentry'\n         self.verbose_name = 'cache entry'\n         self.verbose_name_plural = 'cache entries'\n-        self.object_name =  'CacheEntry'\n+        self.object_name = 'CacheEntry'\n         self.abstract = False\n         self.managed = True\n         self.proxy = False\n@@ -108,19 +108,20 @@ def _base_set(self, mode, key, value, timeout=None):\n         # string, not bytes. Refs #19274.\n         if six.PY3:\n             b64encoded = b64encoded.decode('latin1')\n-        cursor.execute(\"SELECT cache_key, expires FROM %s \"\n-                       \"WHERE cache_key = %%s\" % table, [key])\n         try:\n-            result = cursor.fetchone()\n-            if result and (mode == 'set' or\n-                    (mode == 'add' and result[1] < now)):\n-                cursor.execute(\"UPDATE %s SET value = %%s, expires = %%s \"\n-                               \"WHERE cache_key = %%s\" % table,\n-                               [b64encoded, connections[db].ops.value_to_db_datetime(exp), key])\n-            else:\n-                cursor.execute(\"INSERT INTO %s (cache_key, value, expires) \"\n-                               \"VALUES (%%s, %%s, %%s)\" % table,\n-                               [key, b64encoded, connections[db].ops.value_to_db_datetime(exp)])\n+            with transaction.atomic_if_autocommit(using=db):\n+                cursor.execute(\"SELECT cache_key, expires FROM %s \"\n+                               \"WHERE cache_key = %%s\" % table, [key])\n+                result = cursor.fetchone()\n+                exp = connections[db].ops.value_to_db_datetime(exp)\n+                if result and (mode == 'set' or (mode == 'add' and result[1] < now)):\n+                    cursor.execute(\"UPDATE %s SET value = %%s, expires = %%s \"\n+                                   \"WHERE cache_key = %%s\" % table,\n+                                   [b64encoded, exp, key])\n+                else:\n+                    cursor.execute(\"INSERT INTO %s (cache_key, value, expires) \"\n+                                   \"VALUES (%%s, %%s, %%s)\" % table,\n+                                   [key, b64encoded, exp])\n         except DatabaseError:\n             # To be threadsafe, updates/inserts are allowed to fail silently\n             return False"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 15,
        "deletions": 14
    }
}