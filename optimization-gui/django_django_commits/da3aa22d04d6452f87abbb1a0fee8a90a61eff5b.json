{
    "author": "jezdez",
    "message": "Fixed #5714 -- Strip whitespaces around date and time form field values before converting it to a native type. Thanks to SmileyChris for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16137 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "da3aa22d04d6452f87abbb1a0fee8a90a61eff5b",
    "files": [
        {
            "sha": "e3299c07aa1e69e8782af3985545c87df01c8c6a",
            "filename": "django/forms/fields.py",
            "status": "modified",
            "additions": 43,
            "deletions": 34,
            "changes": 77,
            "blob_url": "https://github.com/django/django/blob/da3aa22d04d6452f87abbb1a0fee8a90a61eff5b/django%2Fforms%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/da3aa22d04d6452f87abbb1a0fee8a90a61eff5b/django%2Fforms%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fforms%2Ffields.py?ref=da3aa22d04d6452f87abbb1a0fee8a90a61eff5b",
            "patch": "@@ -19,7 +19,7 @@\n from django.core import validators\n from django.utils import formats\n from django.utils.translation import ugettext_lazy as _\n-from django.utils.encoding import smart_unicode, smart_str\n+from django.utils.encoding import smart_unicode, smart_str, force_unicode\n from django.utils.functional import lazy\n \n # Provide this import for backwards compatibility.\n@@ -320,16 +320,37 @@ def validate(self, value):\n             raise ValidationError(self.error_messages['max_whole_digits'] % (self.max_digits - self.decimal_places))\n         return value\n \n-class DateField(Field):\n+class BaseTemporalField(Field):\n+\n+    def __init__(self, input_formats=None, *args, **kwargs):\n+        super(BaseTemporalField, self).__init__(*args, **kwargs)\n+        if input_formats is not None:\n+            self.input_formats = input_formats\n+\n+    def to_python(self, value):\n+        # Try to coerce the value to unicode.\n+        unicode_value = force_unicode(value, strings_only=True)\n+        if isinstance(unicode_value, unicode):\n+            value = unicode_value.strip()\n+        # If unicode, try to strptime against each input format.\n+        if isinstance(value, unicode):\n+            for format in self.input_formats:\n+                try:\n+                    return self.strptime(value, format)\n+                except ValueError:\n+                    continue\n+        raise ValidationError(self.error_messages['invalid'])\n+\n+    def strptime(self, value, format):\n+        raise NotImplementedError('Subclasses must define this method.')\n+\n+class DateField(BaseTemporalField):\n     widget = DateInput\n+    input_formats = formats.get_format_lazy('DATE_INPUT_FORMATS')\n     default_error_messages = {\n         'invalid': _(u'Enter a valid date.'),\n     }\n \n-    def __init__(self, input_formats=None, *args, **kwargs):\n-        super(DateField, self).__init__(*args, **kwargs)\n-        self.input_formats = input_formats\n-\n     def to_python(self, value):\n         \"\"\"\n         Validates that the input can be converted to a date. Returns a Python\n@@ -341,23 +362,18 @@ def to_python(self, value):\n             return value.date()\n         if isinstance(value, datetime.date):\n             return value\n-        for format in self.input_formats or formats.get_format('DATE_INPUT_FORMATS'):\n-            try:\n-                return datetime.date(*time.strptime(value, format)[:3])\n-            except ValueError:\n-                continue\n-        raise ValidationError(self.error_messages['invalid'])\n+        return super(DateField, self).to_python(value)\n \n-class TimeField(Field):\n+    def strptime(self, value, format):\n+        return datetime.date(*time.strptime(value, format)[:3])\n+\n+class TimeField(BaseTemporalField):\n     widget = TimeInput\n+    input_formats = formats.get_format_lazy('TIME_INPUT_FORMATS')\n     default_error_messages = {\n         'invalid': _(u'Enter a valid time.')\n     }\n \n-    def __init__(self, input_formats=None, *args, **kwargs):\n-        super(TimeField, self).__init__(*args, **kwargs)\n-        self.input_formats = input_formats\n-\n     def to_python(self, value):\n         \"\"\"\n         Validates that the input can be converted to a time. Returns a Python\n@@ -367,23 +383,18 @@ def to_python(self, value):\n             return None\n         if isinstance(value, datetime.time):\n             return value\n-        for format in self.input_formats or formats.get_format('TIME_INPUT_FORMATS'):\n-            try:\n-                return datetime.time(*time.strptime(value, format)[3:6])\n-            except ValueError:\n-                continue\n-        raise ValidationError(self.error_messages['invalid'])\n+        return super(TimeField, self).to_python(value)\n+\n+    def strptime(self, value, format):\n+        return datetime.time(*time.strptime(value, format)[3:6])\n \n-class DateTimeField(Field):\n+class DateTimeField(BaseTemporalField):\n     widget = DateTimeInput\n+    input_formats = formats.get_format_lazy('DATETIME_INPUT_FORMATS')\n     default_error_messages = {\n         'invalid': _(u'Enter a valid date/time.'),\n     }\n \n-    def __init__(self, input_formats=None, *args, **kwargs):\n-        super(DateTimeField, self).__init__(*args, **kwargs)\n-        self.input_formats = input_formats\n-\n     def to_python(self, value):\n         \"\"\"\n         Validates that the input can be converted to a datetime. Returns a\n@@ -403,12 +414,10 @@ def to_python(self, value):\n             if value[0] in validators.EMPTY_VALUES and value[1] in validators.EMPTY_VALUES:\n                 return None\n             value = '%s %s' % tuple(value)\n-        for format in self.input_formats or formats.get_format('DATETIME_INPUT_FORMATS'):\n-            try:\n-                return datetime.datetime(*time.strptime(value, format)[:6])\n-            except ValueError:\n-                continue\n-        raise ValidationError(self.error_messages['invalid'])\n+        return super(DateTimeField, self).to_python(value)\n+\n+    def strptime(self, value, format):\n+        return datetime.datetime(*time.strptime(value, format)[:6])\n \n class RegexField(CharField):\n     def __init__(self, regex, max_length=None, min_length=None, error_message=None, *args, **kwargs):"
        },
        {
            "sha": "e176985791c0accb29787d710ef33c1ea90d9a43",
            "filename": "django/utils/formats.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/da3aa22d04d6452f87abbb1a0fee8a90a61eff5b/django%2Futils%2Fformats.py",
            "raw_url": "https://github.com/django/django/raw/da3aa22d04d6452f87abbb1a0fee8a90a61eff5b/django%2Futils%2Fformats.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fformats.py?ref=da3aa22d04d6452f87abbb1a0fee8a90a61eff5b",
            "patch": "@@ -2,11 +2,12 @@\n import datetime\n \n from django.conf import settings\n-from django.utils.translation import get_language, to_locale, check_for_language\n+from django.utils import dateformat, numberformat, datetime_safe\n from django.utils.importlib import import_module\n from django.utils.encoding import smart_str\n-from django.utils import dateformat, numberformat, datetime_safe\n+from django.utils.functional import lazy\n from django.utils.safestring import mark_safe\n+from django.utils.translation import get_language, to_locale, check_for_language\n \n # format_cache is a mapping from (format_type, lang) to the format string.\n # By using the cache, it is possible to avoid running get_format_modules\n@@ -81,6 +82,8 @@ def get_format(format_type, lang=None, use_l10n=None):\n             _format_cache[cache_key] = None\n     return getattr(settings, format_type)\n \n+get_format_lazy = lazy(get_format, unicode, list, tuple)\n+\n def date_format(value, format=None, use_l10n=None):\n     \"\"\"\n     Formats a datetime.date or datetime.datetime object using a"
        },
        {
            "sha": "59c761c76d0266ed601c8f944b230a879973cce3",
            "filename": "tests/regressiontests/forms/tests/fields.py",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/django/django/blob/da3aa22d04d6452f87abbb1a0fee8a90a61eff5b/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "raw_url": "https://github.com/django/django/raw/da3aa22d04d6452f87abbb1a0fee8a90a61eff5b/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fforms%2Ftests%2Ffields.py?ref=da3aa22d04d6452f87abbb1a0fee8a90a61eff5b",
            "patch": "@@ -334,6 +334,17 @@ def test_datefield_3(self):\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid date.']\", f.clean, '10/25/2006')\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid date.']\", f.clean, '10/25/06')\n \n+    def test_datefield_4(self):\n+        # Test whitespace stripping behavior (#5714)\n+        f = DateField()\n+        self.assertEqual(datetime.date(2006, 10, 25), f.clean(' 10/25/2006 '))\n+        self.assertEqual(datetime.date(2006, 10, 25), f.clean(' 10/25/06 '))\n+        self.assertEqual(datetime.date(2006, 10, 25), f.clean(' Oct 25   2006 '))\n+        self.assertEqual(datetime.date(2006, 10, 25), f.clean(' October  25 2006 '))\n+        self.assertEqual(datetime.date(2006, 10, 25), f.clean(' October 25, 2006 '))\n+        self.assertEqual(datetime.date(2006, 10, 25), f.clean(' 25 October 2006 '))\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid date.']\", f.clean, '   ')\n+\n     # TimeField ###################################################################\n \n     def test_timefield_1(self):\n@@ -353,6 +364,13 @@ def test_timefield_2(self):\n         self.assertEqual(datetime.time(16, 25), f.clean('4:25 PM'))\n         self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid time.']\", f.clean, '14:30:45')\n \n+    def test_timefield_3(self):\n+        f = TimeField()\n+        # Test whitespace stripping behavior (#5714)\n+        self.assertEqual(datetime.time(14, 25), f.clean(' 14:25 '))\n+        self.assertEqual(datetime.time(14, 25, 59), f.clean(' 14:25:59 '))\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid time.']\", f.clean, '   ')\n+\n     # DateTimeField ###############################################################\n \n     def test_datetimefield_1(self):\n@@ -392,6 +410,18 @@ def test_datetimefield_3(self):\n         self.assertEqual(None, f.clean(''))\n         self.assertEqual('None', repr(f.clean('')))\n \n+    def test_datetimefield_4(self):\n+        f = DateTimeField()\n+        # Test whitespace stripping behavior (#5714)\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 14, 30, 45), f.clean(' 2006-10-25   14:30:45 '))\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 0, 0), f.clean(' 2006-10-25 '))\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 14, 30, 45), f.clean(' 10/25/2006 14:30:45 '))\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 14, 30), f.clean(' 10/25/2006 14:30 '))\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 0, 0), f.clean(' 10/25/2006 '))\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 14, 30, 45), f.clean(' 10/25/06 14:30:45 '))\n+        self.assertEqual(datetime.datetime(2006, 10, 25, 0, 0), f.clean(' 10/25/06 '))\n+        self.assertRaisesErrorWithMessage(ValidationError, \"[u'Enter a valid date/time.']\", f.clean, '   ')\n+\n     # RegexField ##################################################################\n \n     def test_regexfield_1(self):"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 78,
        "deletions": 36
    }
}