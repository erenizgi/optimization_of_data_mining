{
    "author": "ramiro",
    "message": "Added support for savepoints to the MySQL DB backend.\n\nMySQL provides the savepoint functionality starting with version 5.0.3\nwhen using the MyISAM storage engine.\n\nThanks lamby for the report and patch.\n\nFixes #15507.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17341 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac",
    "files": [
        {
            "sha": "8ce2c113441e0619dbafa8767fc1b9ee31425e87",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 31,
            "deletions": 10,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac",
            "patch": "@@ -150,18 +150,28 @@ class DatabaseFeatures(BaseDatabaseFeatures):\n     requires_explicit_null_ordering_when_grouping = True\n     allows_primary_key_0 = False\n \n+    def __init__(self, connection):\n+        super(DatabaseFeatures, self).__init__(connection)\n+        self._storage_engine = None\n+\n+    def _mysql_storage_engine(self):\n+        \"Internal method used in Django tests. Don't rely on this from your code\"\n+        if self._storage_engine is None:\n+            cursor = self.connection.cursor()\n+            cursor.execute('CREATE TABLE INTROSPECT_TEST (X INT)')\n+            # This command is MySQL specific; the second column\n+            # will tell you the default table type of the created\n+            # table. Since all Django's test tables will have the same\n+            # table type, that's enough to evaluate the feature.\n+            cursor.execute(\"SHOW TABLE STATUS WHERE Name='INTROSPECT_TEST'\")\n+            result = cursor.fetchone()\n+            cursor.execute('DROP TABLE INTROSPECT_TEST')\n+            self._storage_engine = result[1]\n+        return self._storage_engine\n+\n     def _can_introspect_foreign_keys(self):\n         \"Confirm support for introspected foreign keys\"\n-        cursor = self.connection.cursor()\n-        cursor.execute('CREATE TABLE INTROSPECT_TEST (X INT)')\n-        # This command is MySQL specific; the second column\n-        # will tell you the default table type of the created\n-        # table. Since all Django's test tables will have the same\n-        # table type, that's enough to evaluate the feature.\n-        cursor.execute(\"SHOW TABLE STATUS WHERE Name='INTROSPECT_TEST'\")\n-        result = cursor.fetchone()\n-        cursor.execute('DROP TABLE INTROSPECT_TEST')\n-        return result[1] != 'MyISAM'\n+        return self._mysql_storage_engine() != 'MyISAM'\n \n class DatabaseOperations(BaseDatabaseOperations):\n     compiler_module = \"django.db.backends.mysql.compiler\"\n@@ -285,6 +295,15 @@ def bulk_insert_sql(self, fields, num_values):\n         items_sql = \"(%s)\" % \", \".join([\"%s\"] * len(fields))\n         return \"VALUES \" + \", \".join([items_sql] * num_values)\n \n+    def savepoint_create_sql(self, sid):\n+        return \"SAVEPOINT %s\" % sid\n+\n+    def savepoint_commit_sql(self, sid):\n+        return \"RELEASE SAVEPOINT %s\" % sid\n+\n+    def savepoint_rollback_sql(self, sid):\n+        return \"ROLLBACK TO SAVEPOINT %s\" % sid\n+\n class DatabaseWrapper(BaseDatabaseWrapper):\n     vendor = 'mysql'\n     operators = {\n@@ -354,6 +373,8 @@ def _cursor(self):\n             self.connection = Database.connect(**kwargs)\n             self.connection.encoders[SafeUnicode] = self.connection.encoders[unicode]\n             self.connection.encoders[SafeString] = self.connection.encoders[str]\n+            self.features.uses_savepoints = \\\n+                self.get_server_version() >= (5, 0, 3)\n             connection_created.send(sender=self.__class__, connection=self)\n         cursor = self.connection.cursor()\n         if new_connection:"
        },
        {
            "sha": "de7afc83c3dbac3eb2e4b1da2f128cd10fa68a5b",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac",
            "patch": "@@ -553,6 +553,9 @@ Django 1.4 also includes several smaller improvements worth noting:\n   password reset mechanism and making it available is now much easier. For\n   details, see :ref:`auth_password_reset`.\n \n+* The MySQL database backend can now make use of the savepoint feature\n+  implemented by MySQL version 5.0.3 or newer with the InnoDB storage engine.\n+\n Backwards incompatible changes in 1.4\n =====================================\n "
        },
        {
            "sha": "6e6754a9d845e65fa1e9df924aad907e769c9773",
            "filename": "docs/topics/db/transactions.txt",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/docs%2Ftopics%2Fdb%2Ftransactions.txt",
            "raw_url": "https://github.com/django/django/raw/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/docs%2Ftopics%2Fdb%2Ftransactions.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Ftransactions.txt?ref=8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac",
            "patch": "@@ -225,11 +225,14 @@ transaction middleware, and only modify selected functions as needed.\n Savepoints\n ==========\n \n-A savepoint is a marker within a transaction that enables you to roll back\n-part of a transaction, rather than the full transaction. Savepoints are\n-available to the PostgreSQL 8 and Oracle backends. Other backends will\n-provide the savepoint functions, but they are empty operations - they won't\n-actually do anything.\n+A savepoint is a marker within a transaction that enables you to roll back part\n+of a transaction, rather than the full transaction. Savepoints are available to\n+the PostgreSQL 8, Oracle and MySQL (version 5.0.3 and newer, when using the\n+InnoDB storage engine) backends. Other backends will provide the savepoint\n+functions, but they are empty operations - they won't actually do anything.\n+\n+.. versionchanged:: 1.4\n+   Savepoint support when using the MySQL backend was added in Django 1.4\n \n Savepoints aren't especially useful if you are using the default\n ``autocommit`` behavior of Django. However, if you are using"
        },
        {
            "sha": "22f1b0f911c9601ef9aefac1dc84d38c3c9846ae",
            "filename": "tests/regressiontests/transactions_regress/tests.py",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftransactions_regress%2Ftests.py?ref=8312b85c979c8ddd314abe0a7edb6cb37fe3e3ac",
            "patch": "@@ -4,6 +4,7 @@\n from django.db import connection, transaction\n from django.db.transaction import commit_on_success, commit_manually, TransactionManagementError\n from django.test import TransactionTestCase, skipUnlessDBFeature\n+from django.utils.unittest import skipIf\n \n from .models import Mod, M2mA, M2mB\n \n@@ -165,6 +166,7 @@ def create_system_user():\n         except:\n             self.fail(\"A transaction consisting of a failed operation was not closed.\")\n \n+\n class TestManyToManyAddTransaction(TransactionTestCase):\n     def test_manyrelated_add_commit(self):\n         \"Test for https://code.djangoproject.com/ticket/16818\"\n@@ -178,3 +180,39 @@ def test_manyrelated_add_commit(self):\n         # that the bulk insert was not auto-committed.\n         transaction.rollback()\n         self.assertEqual(a.others.count(), 1)\n+\n+\n+class SavepointTest(TransactionTestCase):\n+\n+    @skipUnlessDBFeature('uses_savepoints')\n+    def test_savepoint_commit(self):\n+        @commit_manually\n+        def work():\n+            mod = Mod.objects.create(fld=1)\n+            pk = mod.pk\n+            sid = transaction.savepoint()\n+            mod1 = Mod.objects.filter(pk=pk).update(fld=10)\n+            transaction.savepoint_commit(sid)\n+            mod2 = Mod.objects.get(pk=pk)\n+            transaction.commit()\n+            self.assertEqual(mod2.fld, 10)\n+\n+        work()\n+\n+    @skipIf(connection.vendor == 'mysql' and \\\n+            connection.features._mysql_storage_engine() == 'MyISAM',\n+            \"MyISAM MySQL storage engine doesn't support savepoints\")\n+    @skipUnlessDBFeature('uses_savepoints')\n+    def test_savepoint_rollback(self):\n+        @commit_manually\n+        def work():\n+            mod = Mod.objects.create(fld=1)\n+            pk = mod.pk\n+            sid = transaction.savepoint()\n+            mod1 = Mod.objects.filter(pk=pk).update(fld=20)\n+            transaction.savepoint_rollback(sid)\n+            mod2 = Mod.objects.get(pk=pk)\n+            transaction.commit()\n+            self.assertEqual(mod2.fld, 1)\n+\n+        work()"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 80,
        "deletions": 15
    }
}