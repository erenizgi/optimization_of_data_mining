{
    "author": "claudep",
    "message": "Added a helper script for managing django translations",
    "sha": "739724ff825fc0a37f31a28607256bd09e008f0a",
    "files": [
        {
            "sha": "b90b26e1f8fe1a49abebc4dc5155c05a3c73aad1",
            "filename": "scripts/manage_translations.py",
            "status": "added",
            "additions": 164,
            "deletions": 0,
            "changes": 164,
            "blob_url": "https://github.com/django/django/blob/739724ff825fc0a37f31a28607256bd09e008f0a/scripts%2Fmanage_translations.py",
            "raw_url": "https://github.com/django/django/raw/739724ff825fc0a37f31a28607256bd09e008f0a/scripts%2Fmanage_translations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/scripts%2Fmanage_translations.py?ref=739724ff825fc0a37f31a28607256bd09e008f0a",
            "patch": "@@ -0,0 +1,164 @@\n+#!/usr/bin/env python\n+#\n+# This python file contains utility scripts to manage Django translations.\n+# It has to be run inside the django git root directory.\n+#\n+# The following commands are available:\n+#\n+# * update_catalogs: check for new strings in core and contrib catalogs, and\n+#                    output how much strings are new/changed.\n+#\n+# * lang_stats: output statistics for each catalog/language combination\n+#\n+# * fetch: fetch translations from transifex.com\n+#\n+# Each command support the --languages and --resources options to limit their\n+# operation to the specified language or resource. For example, to get stats\n+# for Spanish in contrib.admin, run:\n+#\n+#  $ python scripts/manage_translations.py lang_stats --language=es --resources=admin\n+\n+import os\n+from optparse import OptionParser\n+from subprocess import call, Popen, PIPE\n+\n+from django.core.management import call_command\n+\n+\n+HAVE_JS = ['admin']\n+\n+def _get_locale_dirs(include_core=True):\n+    \"\"\"\n+    Return a tuple (contrib name, absolute path) for all locale directories,\n+    optionally including the django core catalog.\n+    \"\"\"\n+    contrib_dir = os.path.join(os.getcwd(), 'django', 'contrib')\n+    dirs = []\n+    for contrib_name in os.listdir(contrib_dir):\n+        path = os.path.join(contrib_dir, contrib_name, 'locale')\n+        if os.path.isdir(path):\n+            dirs.append((contrib_name, path))\n+            if contrib_name in HAVE_JS:\n+                dirs.append((\"%s-js\" % contrib_name, path))\n+    if include_core:\n+        dirs.insert(0, ('core', os.path.join(os.getcwd(), 'django', 'conf', 'locale')))\n+    return dirs\n+\n+def _tx_resource_for_name(name):\n+    \"\"\" Return the Transifex resource name \"\"\"\n+    if name == 'core':\n+        return \"django.core\"\n+    else:\n+        return \"django.contrib-%s\" % name\n+\n+def _check_diff(cat_name, base_path):\n+    \"\"\"\n+    Output the approximate number of changed/added strings in the en catalog.\n+    \"\"\"\n+    po_path = '%(path)s/en/LC_MESSAGES/django%(ext)s.po' % {\n+        'path': base_path, 'ext': 'js' if cat_name.endswith('-js') else ''}\n+    p = Popen(\"git diff -U0 %s | egrep -v '^@@|^[-+]#|^..POT-Creation' | wc -l\" % po_path,\n+              stdout=PIPE, stderr=PIPE, shell=True)\n+    output, errors = p.communicate()\n+    num_changes = int(output.strip()) - 4\n+    print(\"%d changed/added messages in '%s' catalog.\" % (num_changes, cat_name))\n+\n+\n+def update_catalogs(resources=None, languages=None):\n+    \"\"\"\n+    Update the en/LC_MESSAGES/django.po (main and contrib) files with\n+    new/updated translatable strings.\n+    \"\"\"\n+    contrib_dirs = _get_locale_dirs(include_core=False)\n+\n+    os.chdir(os.path.join(os.getcwd(), 'django'))\n+    print(\"Updating main en catalog\")\n+    call_command('makemessages', locale='en')\n+    _check_diff('core', os.path.join(os.getcwd(), 'conf', 'locale'))\n+\n+    # Contrib catalogs\n+    for name, dir_ in contrib_dirs:\n+        if resources and not name in resources:\n+            continue\n+        os.chdir(os.path.join(dir_, '..'))\n+        print(\"Updating en catalog in %s\" % dir_)\n+        if name.endswith('-js'):\n+            call_command('makemessages', locale='en', domain='djangojs')\n+        else:\n+            call_command('makemessages', locale='en')\n+        _check_diff(name, dir_)\n+\n+\n+def lang_stats(resources=None, languages=None):\n+    \"\"\"\n+    Output language statistics of committed translation files for each\n+    Django catalog.\n+    If resources is provided, it should be a list of translation resource to\n+    limit the output (e.g. ['core', 'gis']).\n+    \"\"\"\n+    locale_dirs = _get_locale_dirs()\n+\n+    for name, dir_ in locale_dirs:\n+        if resources and not name in resources:\n+            continue\n+        print(\"\\nShowing translations stats for '%s':\" % name) \n+        langs = sorted([d for d in os.listdir(dir_) if not d.startswith('_')])\n+        for lang in langs:\n+            if languages and not lang in languages:\n+                continue\n+            # TODO: merge first with the latest en catalog\n+            p = Popen(\"msgfmt -vc -o /dev/null %(path)s/%(lang)s/LC_MESSAGES/django%(ext)s.po\" % {\n+                'path': dir_, 'lang': lang, 'ext': 'js' if name.endswith('-js') else ''},\n+                stdout=PIPE, stderr=PIPE, shell=True)\n+            output, errors = p.communicate()\n+            if p.returncode == 0:\n+                # msgfmt output stats on stderr\n+                print(\"%s: %s\" % (lang, errors.strip()))\n+\n+\n+def fetch(resources=None, languages=None):\n+    \"\"\"\n+    Fetch translations from Transifex, wrap long lines, generate mo files.\n+    \"\"\"\n+    locale_dirs = _get_locale_dirs()\n+\n+    for name, dir_ in locale_dirs:\n+        if resources and not name in resources:\n+            continue\n+\n+        # Transifex pull\n+        if languages is None:\n+            call('tx pull -r %(res)s -a -f' % {'res': _tx_resource_for_name(name)}, shell=True)\n+            languages = sorted([d for d in os.listdir(dir_) if not d.startswith('_')])\n+        else:\n+            for lang in languages:\n+                call('tx pull -r %(res)s -f -l %(lang)s' % {\n+                    'res': _tx_resource_for_name(name), 'lang': lang}, shell=True)\n+\n+        # msgcat to wrap lines and msgfmt for compilation of .mo file\n+        for lang in languages:\n+            po_path = '%(path)s/%(lang)s/LC_MESSAGES/django%(ext)s.po' % {\n+                'path': dir_, 'lang': lang, 'ext': 'js' if name.endswith('-js') else ''}\n+            call('msgcat -o %s %s' % (po_path, po_path), shell=True)\n+            mo_path = '%s.mo' % po_path[:-3]\n+            call('msgfmt -o %s %s' % (mo_path, po_path), shell=True)\n+\n+\n+if __name__ == \"__main__\":\n+    RUNABLE_SCRIPTS = ('update_catalogs', 'lang_stats', 'fetch')\n+\n+    parser = OptionParser(usage=\"usage: %prog [options] cmd\")\n+    parser.add_option(\"-r\", \"--resources\", action='append',\n+        help=\"limit operation to the specified resources\")\n+    parser.add_option(\"-l\", \"--languages\", action='append',\n+        help=\"limit operation to the specified languages\")\n+    options, args = parser.parse_args()\n+\n+    if not args:\n+        parser.print_usage()\n+        exit(1)\n+\n+    if args[0] in RUNABLE_SCRIPTS:\n+        eval(args[0])(options.resources, options.languages)\n+    else:\n+        print(\"Available commands are: %s\" % \", \".join(RUNABLE_SCRIPTS))"
        }
    ],
    "stats": {
        "total": 164,
        "additions": 164,
        "deletions": 0
    }
}