{
    "author": "carljm",
    "message": "Fixed #16288 -- Enabled django.request exception logger regardless of DEBUG setting.\n\nThanks Matt Bennett for report and draft patch; Vinay Sajip and Russell Keith-Magee for review.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16444 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "43503b093a35ca4707c16d865f10929960bfa0b8",
    "files": [
        {
            "sha": "c99b307c6d1d9a67c36c63b2a0ecb5360cfaac5d",
            "filename": "django/conf/__init__.py",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fconf%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fconf%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2F__init__.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -135,6 +135,9 @@ def __init__(self, settings_module):\n             logging_config_module = importlib.import_module(logging_config_path)\n             logging_config_func = getattr(logging_config_module, logging_config_func_name)\n \n+            # Backwards-compatibility shim for #16288 fix\n+            compat_patch_logging_config(self.LOGGING)\n+\n             # ... then invoke it with the logging settings\n             logging_config_func(self.LOGGING)\n \n@@ -165,3 +168,41 @@ def __dir__(self):\n \n settings = LazySettings()\n \n+\n+\n+def compat_patch_logging_config(logging_config):\n+    \"\"\"\n+    Backwards-compatibility shim for #16288 fix. Takes initial value of\n+    ``LOGGING`` setting and patches it in-place (issuing deprecation warning)\n+    if \"mail_admins\" logging handler is configured but has no filters.\n+\n+    \"\"\"\n+    #  Shim only if LOGGING[\"handlers\"][\"mail_admins\"] exists,\n+    #  but has no \"filters\" key\n+    if \"filters\" not in logging_config.get(\n+        \"handlers\", {}).get(\n+        \"mail_admins\", {\"filters\": []}):\n+\n+        warnings.warn(\n+            \"You have no filters defined on the 'mail_admins' logging \"\n+            \"handler: adding implicit debug-false-only filter. \"\n+            \"See http://docs.djangoproject.com/en/dev/releases/1.4/\"\n+            \"#request-exceptions-are-now-always-logged\",\n+            PendingDeprecationWarning)\n+\n+        filter_name = \"require_debug_false\"\n+\n+        filters = logging_config.setdefault(\"filters\", {})\n+        while filter_name in filters:\n+            filter_name = filter_name + \"_\"\n+\n+        def _callback(record):\n+            from django.conf import settings\n+            return not settings.DEBUG\n+\n+        filters[filter_name] = {\n+            \"()\": \"django.utils.log.CallbackFilter\",\n+            \"callback\": _callback\n+            }\n+\n+        logging_config[\"handlers\"][\"mail_admins\"][\"filters\"] = [filter_name]"
        },
        {
            "sha": "fedea55bac496e187fd2b1b19b4462a76d7ed7dc",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -525,9 +525,16 @@\n LOGGING = {\n     'version': 1,\n     'disable_existing_loggers': False,\n+    'filters': {\n+        'require_debug_false': {\n+            '()': 'django.utils.log.CallbackFilter',\n+            'callback': lambda r: not DEBUG\n+        }\n+    },\n     'handlers': {\n         'mail_admins': {\n             'level': 'ERROR',\n+            'filters': ['require_debug_false'],\n             'class': 'django.utils.log.AdminEmailHandler'\n         }\n     },"
        },
        {
            "sha": "794522b202f6b9300290f0584898bff493661ece",
            "filename": "django/conf/project_template/settings.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fconf%2Fproject_template%2Fsettings.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fconf%2Fproject_template%2Fsettings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fproject_template%2Fsettings.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -125,15 +125,22 @@\n \n # A sample logging configuration. The only tangible logging\n # performed by this configuration is to send an email to\n-# the site admins on every HTTP 500 error.\n+# the site admins on every HTTP 500 error when DEBUG=False.\n # See http://docs.djangoproject.com/en/dev/topics/logging for\n # more details on how to customize your logging configuration.\n LOGGING = {\n     'version': 1,\n     'disable_existing_loggers': False,\n+    'filters': {\n+        'require_debug_false': {\n+            '()': 'django.utils.log.CallbackFilter',\n+            'callback': lambda r: not DEBUG\n+        }\n+    },\n     'handlers': {\n         'mail_admins': {\n             'level': 'ERROR',\n+            'filters': ['require_debug_false'],\n             'class': 'django.utils.log.AdminEmailHandler'\n         }\n     },"
        },
        {
            "sha": "55290973c373c19cead2f6278d2945c37101f889",
            "filename": "django/core/handlers/base.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fcore%2Fhandlers%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Fcore%2Fhandlers%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fbase.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -198,10 +198,6 @@ def handle_uncaught_exception(self, request, resolver, exc_info):\n         if settings.DEBUG_PROPAGATE_EXCEPTIONS:\n             raise\n \n-        if settings.DEBUG:\n-            from django.views import debug\n-            return debug.technical_500_response(request, *exc_info)\n-\n         logger.error('Internal Server Error: %s' % request.path,\n             exc_info=exc_info,\n             extra={\n@@ -210,6 +206,10 @@ def handle_uncaught_exception(self, request, resolver, exc_info):\n             }\n         )\n \n+        if settings.DEBUG:\n+            from django.views import debug\n+            return debug.technical_500_response(request, *exc_info)\n+\n         # If Http500 handler is not installed, re-raise last exception\n         if resolver.urlconf_module is None:\n             raise exc_info[1], None, exc_info[2]"
        },
        {
            "sha": "d0f5109e85cec88f446e936f15aa1fbcbbc21056",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -70,3 +70,20 @@ def emit(self, record):\n         reporter = ExceptionReporter(request, is_email=True, *exc_info)\n         html_message = self.include_html and reporter.get_traceback_html() or None\n         mail.mail_admins(subject, message, fail_silently=True, html_message=html_message)\n+\n+\n+class CallbackFilter(logging.Filter):\n+    \"\"\"\n+    A logging filter that checks the return value of a given callable (which\n+    takes the record-to-be-logged as its only parameter) to decide whether to\n+    log a record.\n+\n+    \"\"\"\n+    def __init__(self, callback):\n+        self.callback = callback\n+\n+\n+    def filter(self, record):\n+        if self.callback(record):\n+            return 1\n+        return 0"
        },
        {
            "sha": "cd65a89e22735582ce6a702ec5d92df499d9035e",
            "filename": "docs/internals/deprecation.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/docs%2Finternals%2Fdeprecation.txt",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/docs%2Finternals%2Fdeprecation.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Finternals%2Fdeprecation.txt?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -210,6 +210,11 @@ their deprecation, as per the :ref:`Django deprecation policy\n         * Legacy ways of calling\n           :func:`~django.views.decorators.cache.cache_page` will be removed.\n \n+        * The backward-compatibility shim to automatically add a debug-false\n+          filter to the ``'mail_admins'`` logging handler will be removed. The\n+          :setting:`LOGGING` setting should include this filter explicitly if\n+          it is desired.\n+\n     * 2.0\n         * ``django.views.defaults.shortcut()``. This function has been moved\n           to ``django.contrib.contenttypes.views.shortcut()`` as part of the"
        },
        {
            "sha": "0635ecefee58588e93ea56bb804f724e1cfd69d8",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -387,3 +387,44 @@ releases 8.0 and 8.1 was near (November 2010.)\n \n Django 1.4 takes that policy further and sets 8.2 as the minimum PostgreSQL\n version it officially supports.\n+\n+Request exceptions are now always logged\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+When :doc:`logging support </topics/logging/>` was added to Django in 1.3, the\n+admin error email support was moved into the\n+:class:`django.utils.log.AdminEmailHandler`, attached to the\n+``'django.request'`` logger. In order to maintain the established behavior of\n+error emails, the ``'django.request'`` logger was called only when\n+:setting:`DEBUG` was `False`.\n+\n+To increase the flexibility of request-error logging, the ``'django.request'``\n+logger is now called regardless of the value of :setting:`DEBUG`, and the\n+default settings file for new projects now includes a separate filter attached\n+to :class:`django.utils.log.AdminEmailHandler` to prevent admin error emails in\n+`DEBUG` mode::\n+\n+   'filters': {\n+        'require_debug_false': {\n+            '()': 'django.utils.log.CallbackFilter',\n+            'callback': lambda r: not DEBUG\n+        }\n+    },\n+    'handlers': {\n+        'mail_admins': {\n+            'level': 'ERROR',\n+            'filters': ['require_debug_false'],\n+            'class': 'django.utils.log.AdminEmailHandler'\n+        }\n+    },\n+\n+If your project was created prior to this change, your :setting:`LOGGING`\n+setting will not include this new filter. In order to maintain\n+backwards-compatibility, Django will detect that your ``'mail_admins'`` handler\n+configuration includes no ``'filters'`` section, and will automatically add\n+this filter for you and issue a pending-deprecation warning. This will become a\n+deprecation warning in Django 1.5, and in Django 1.6 the\n+backwards-compatibility shim will be removed entirely.\n+\n+The existence of any ``'filters'`` key under the ``'mail_admins'`` handler will\n+disable this backward-compatibility shim and deprecation warning."
        },
        {
            "sha": "91370382146dbd582c2a42084c8a9f6543dd753c",
            "filename": "docs/topics/logging.txt",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/docs%2Ftopics%2Flogging.txt",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/docs%2Ftopics%2Flogging.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Flogging.txt?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -501,3 +501,37 @@ Python logging module.\n     :ref:`Filtering error reports<filtering-error-reports>`.\n \n .. _django-sentry: http://pypi.python.org/pypi/django-sentry\n+\n+\n+Filters\n+-------\n+\n+Django provides one log filter in addition to those provided by the\n+Python logging module.\n+\n+.. class:: CallbackFilter(callback)\n+\n+   .. versionadded:: 1.4\n+\n+   This filter accepts a callback function (which should accept a single\n+   argument, the record to be logged), and calls it for each record that passes\n+   through the filter. Handling of that record will not proceed if the callback\n+   returns False.\n+\n+   This filter is used as follows in the default :setting:`LOGGING`\n+   configuration to ensure that the :class:`AdminEmailHandler` only sends error\n+   emails to admins when :setting:`DEBUG` is `False`::\n+\n+       'filters': {\n+            'require_debug_false': {\n+                '()': 'django.utils.log.CallbackFilter',\n+                'callback': lambda r: not DEBUG\n+            }\n+        },\n+        'handlers': {\n+            'mail_admins': {\n+                'level': 'ERROR',\n+                'filters': ['require_debug_false'],\n+                'class': 'django.utils.log.AdminEmailHandler'\n+            }\n+        },"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/logging_tests/__init__.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Flogging_tests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Flogging_tests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2F__init__.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "tests/regressiontests/logging_tests/models.py",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Flogging_tests%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Flogging_tests%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Fmodels.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8"
        },
        {
            "sha": "fe8b1694214d32e3044b44f95131fed756647f4c",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "added",
            "additions": 117,
            "deletions": 0,
            "changes": 117,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -0,0 +1,117 @@\n+from __future__ import with_statement\n+\n+import copy\n+\n+from django.conf import compat_patch_logging_config\n+from django.test import TestCase\n+from django.utils.log import CallbackFilter\n+\n+\n+# logging config prior to using filter with mail_admins\n+OLD_LOGGING = {\n+    'version': 1,\n+    'disable_existing_loggers': False,\n+    'handlers': {\n+        'mail_admins': {\n+            'level': 'ERROR',\n+            'class': 'django.utils.log.AdminEmailHandler'\n+        }\n+    },\n+    'loggers': {\n+        'django.request': {\n+            'handlers': ['mail_admins'],\n+            'level': 'ERROR',\n+            'propagate': True,\n+        },\n+    }\n+}\n+\n+\n+\n+class PatchLoggingConfigTest(TestCase):\n+    \"\"\"\n+    Tests for backward-compat shim for #16288. These tests should be removed in\n+    Django 1.6 when that shim and DeprecationWarning are removed.\n+\n+    \"\"\"\n+    def test_filter_added(self):\n+        \"\"\"\n+        Test that debug-false filter is added to mail_admins handler if it has\n+        no filters.\n+\n+        \"\"\"\n+        config = copy.deepcopy(OLD_LOGGING)\n+        compat_patch_logging_config(config)\n+\n+        self.assertEqual(\n+            config[\"handlers\"][\"mail_admins\"][\"filters\"],\n+            ['require_debug_false'])\n+\n+\n+    def test_filter_configuration(self):\n+        \"\"\"\n+        Test that the debug-false filter is a CallbackFilter with a callback\n+        that works as expected (returns ``not DEBUG``).\n+\n+        \"\"\"\n+        config = copy.deepcopy(OLD_LOGGING)\n+        compat_patch_logging_config(config)\n+\n+        flt = config[\"filters\"][\"require_debug_false\"]\n+\n+        self.assertEqual(flt[\"()\"], \"django.utils.log.CallbackFilter\")\n+\n+        callback = flt[\"callback\"]\n+\n+        with self.settings(DEBUG=True):\n+            self.assertEqual(callback(\"record is not used\"), False)\n+\n+        with self.settings(DEBUG=False):\n+            self.assertEqual(callback(\"record is not used\"), True)\n+\n+\n+    def test_no_patch_if_filters_key_exists(self):\n+        \"\"\"\n+        Test that the logging configuration is not modified if the mail_admins\n+        handler already has a \"filters\" key.\n+\n+        \"\"\"\n+        config = copy.deepcopy(OLD_LOGGING)\n+        config[\"handlers\"][\"mail_admins\"][\"filters\"] = []\n+        new_config = copy.deepcopy(config)\n+        compat_patch_logging_config(new_config)\n+\n+        self.assertEqual(config, new_config)\n+\n+    def test_no_patch_if_no_mail_admins_handler(self):\n+        \"\"\"\n+        Test that the logging configuration is not modified if the mail_admins\n+        handler is not present.\n+\n+        \"\"\"\n+        config = copy.deepcopy(OLD_LOGGING)\n+        config[\"handlers\"].pop(\"mail_admins\")\n+        new_config = copy.deepcopy(config)\n+        compat_patch_logging_config(new_config)\n+\n+        self.assertEqual(config, new_config)\n+\n+\n+class CallbackFilterTest(TestCase):\n+    def test_sense(self):\n+        f_false = CallbackFilter(lambda r: False)\n+        f_true = CallbackFilter(lambda r: True)\n+\n+        self.assertEqual(f_false.filter(\"record\"), False)\n+        self.assertEqual(f_true.filter(\"record\"), True)\n+\n+    def test_passes_on_record(self):\n+        collector = []\n+        def _callback(record):\n+            collector.append(record)\n+            return True\n+        f = CallbackFilter(_callback)\n+\n+        f.filter(\"a record\")\n+\n+        self.assertEqual(collector, [\"a record\"])"
        },
        {
            "sha": "7d59257ef77270ac0127d5754b39477a0068cc64",
            "filename": "tests/regressiontests/views/views.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Fviews%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/43503b093a35ca4707c16d865f10929960bfa0b8/tests%2Fregressiontests%2Fviews%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Fviews.py?ref=43503b093a35ca4707c16d865f10929960bfa0b8",
            "patch": "@@ -134,13 +134,24 @@ def raises_template_does_not_exist(request):\n \n def send_log(request, exc_info):\n     logger = getLogger('django.request')\n+    # The default logging config has a logging filter to ensure admin emails are\n+    # only sent with DEBUG=False, but since someone might choose to remove that\n+    # filter, we still want to be able to test the behavior of error emails\n+    # with DEBUG=True. So we need to remove the filter temporarily.\n+    admin_email_handler = [\n+        h for h in logger.handlers\n+        if h.__class__.__name__ == \"AdminEmailHandler\"\n+        ][0]\n+    orig_filters = admin_email_handler.filters\n+    admin_email_handler.filters = []\n     logger.error('Internal Server Error: %s' % request.path,\n         exc_info=exc_info,\n         extra={\n             'status_code': 500,\n             'request': request\n         }\n     )\n+    admin_email_handler.filters = orig_filters\n \n def non_sensitive_view(request):\n     # Do not just use plain strings for the variables' values in the code"
        }
    ],
    "stats": {
        "total": 290,
        "additions": 285,
        "deletions": 5
    }
}