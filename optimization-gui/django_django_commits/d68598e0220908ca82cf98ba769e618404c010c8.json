{
    "author": "alex",
    "message": "Fixed #14700 -- ensure that a raw query is only executed once per iteration.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14785 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d68598e0220908ca82cf98ba769e618404c010c8",
    "files": [
        {
            "sha": "2323c7d74407991c157d598503f1a86753f5e770",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/d68598e0220908ca82cf98ba769e618404c010c8/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/d68598e0220908ca82cf98ba769e618404c010c8/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=d68598e0220908ca82cf98ba769e618404c010c8",
            "patch": "@@ -1310,9 +1310,13 @@ def __iter__(self):\n \n         # Cache some things for performance reasons outside the loop.\n         db = self.db\n-        compiler = connections[db].ops.compiler('SQLCompiler')(self.query, connections[db], db)\n+        compiler = connections[db].ops.compiler('SQLCompiler')(\n+            self.query, connections[db], db\n+        )\n         need_resolv_columns = hasattr(compiler, 'resolve_columns')\n \n+        query = iter(self.query)\n+\n         # Find out which columns are model's fields, and which ones should be\n         # annotated to the model.\n         for pos, column in enumerate(self.columns):\n@@ -1341,7 +1345,7 @@ def __iter__(self):\n         if need_resolv_columns:\n             fields = [self.model_fields.get(c, None) for c in self.columns]\n         # Begin looping through the query values.\n-        for values in self.query:\n+        for values in query:\n             if need_resolv_columns:\n                 values = compiler.resolve_columns(values, fields)\n             # Associate fields to values"
        },
        {
            "sha": "e7cadfae8cfbff1e1d7707c7a3aca19c58c35a75",
            "filename": "tests/modeltests/raw_query/tests.py",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/d68598e0220908ca82cf98ba769e618404c010c8/tests%2Fmodeltests%2Fraw_query%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d68598e0220908ca82cf98ba769e618404c010c8/tests%2Fmodeltests%2Fraw_query%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fraw_query%2Ftests.py?ref=d68598e0220908ca82cf98ba769e618404c010c8",
            "patch": "@@ -217,3 +217,8 @@ def test_inheritance(self):\n         self.assertEqual(\n             [o.pk for o in FriendlyAuthor.objects.raw(query)], [f.pk]\n         )\n+\n+    def test_query_count(self):\n+        self.assertNumQueries(1,\n+            list, Author.objects.raw(\"SELECT * FROM raw_query_author\")\n+        )"
        }
    ],
    "stats": {
        "total": 13,
        "additions": 11,
        "deletions": 2
    }
}