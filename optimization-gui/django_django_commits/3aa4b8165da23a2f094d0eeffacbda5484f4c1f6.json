{
    "author": "bak1an",
    "message": "Fixed #19457 -- ImageField size detection failed for some files.\n\nThis was caused by PIL raising a zlib truncated stream error since we fed\nthe parser with chunks instead of the whole image.",
    "sha": "3aa4b8165da23a2f094d0eeffacbda5484f4c1f6",
    "files": [
        {
            "sha": "a8d3d8018b18e618f68bcd251991065deeff0e91",
            "filename": "django/core/files/images.py",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/3aa4b8165da23a2f094d0eeffacbda5484f4c1f6/django%2Fcore%2Ffiles%2Fimages.py",
            "raw_url": "https://github.com/django/django/raw/3aa4b8165da23a2f094d0eeffacbda5484f4c1f6/django%2Fcore%2Ffiles%2Fimages.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fimages.py?ref=3aa4b8165da23a2f094d0eeffacbda5484f4c1f6",
            "patch": "@@ -4,7 +4,11 @@\n Requires PIL, as you might imagine.\n \"\"\"\n \n+import zlib\n+import sys\n+\n from django.core.files import File\n+from django.utils import six\n \n class ImageFile(File):\n     \"\"\"\n@@ -55,7 +59,15 @@ def get_image_dimensions(file_or_path, close=False):\n             data = file.read(chunk_size)\n             if not data:\n                 break\n-            p.feed(data)\n+            try:\n+                p.feed(data)\n+            except zlib.error as e:\n+                # ignore zlib complaining on truncated stream, just feed more\n+                # data to parser (ticket #19457).\n+                if e.message.startswith(\"Error -5\"):\n+                    pass\n+                else:\n+                    six.reraise(*sys.exc_info())\n             if p.image:\n                 return p.image.size\n             chunk_size = chunk_size*2"
        },
        {
            "sha": "a06449f9e9795a3bea688f47fa79110e2762fd9c",
            "filename": "tests/regressiontests/file_storage/magic.png",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/3aa4b8165da23a2f094d0eeffacbda5484f4c1f6/tests%2Fregressiontests%2Ffile_storage%2Fmagic.png",
            "raw_url": "https://github.com/django/django/raw/3aa4b8165da23a2f094d0eeffacbda5484f4c1f6/tests%2Fregressiontests%2Ffile_storage%2Fmagic.png",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Fmagic.png?ref=3aa4b8165da23a2f094d0eeffacbda5484f4c1f6"
        },
        {
            "sha": "4872ce87b9569b3f25e7d4f01a71bf817cb8f53d",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/3aa4b8165da23a2f094d0eeffacbda5484f4c1f6/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3aa4b8165da23a2f094d0eeffacbda5484f4c1f6/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=3aa4b8165da23a2f094d0eeffacbda5484f4c1f6",
            "patch": "@@ -7,6 +7,7 @@\n import sys\n import tempfile\n import time\n+import zlib\n from datetime import datetime, timedelta\n from io import BytesIO\n \n@@ -559,6 +560,20 @@ def test_multiple_calls(self):\n         self.assertEqual(image_pil.size, size_1)\n         self.assertEqual(size_1, size_2)\n \n+    @unittest.skipUnless(Image, \"PIL not installed\")\n+    def test_bug_19457(self):\n+        \"\"\"\n+        Regression test for #19457\n+        get_image_dimensions fails on some pngs, while Image.size is working good on them\n+        \"\"\"\n+        img_path = os.path.join(os.path.dirname(upath(__file__)), \"magic.png\")\n+        try:\n+            size = get_image_dimensions(img_path)\n+        except zlib.error:\n+            self.fail(\"Exception raised from get_image_dimensions().\")\n+        self.assertEqual(size, Image.open(img_path).size)\n+\n+\n class ContentFileTestCase(unittest.TestCase):\n \n     def setUp(self):"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 28,
        "deletions": 1
    }
}