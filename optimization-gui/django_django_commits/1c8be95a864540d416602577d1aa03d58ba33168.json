{
    "author": "aaugustin",
    "message": "Prevented caching of streaming responses.\n\nThe test introduced in 4b278131 accidentally passed because of a\nlimitation of Python < 3.3.\n\nRefs #17758, #7581.",
    "sha": "1c8be95a864540d416602577d1aa03d58ba33168",
    "files": [
        {
            "sha": "83860e15f3e1b2040ef6d7a1a7600acc71fb5bcb",
            "filename": "django/middleware/cache.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1c8be95a864540d416602577d1aa03d58ba33168/django%2Fmiddleware%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/1c8be95a864540d416602577d1aa03d58ba33168/django%2Fmiddleware%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fmiddleware%2Fcache.py?ref=1c8be95a864540d416602577d1aa03d58ba33168",
            "patch": "@@ -93,7 +93,7 @@ def process_response(self, request, response):\n         if not self._should_update_cache(request, response):\n             # We don't need to update the cache, just return.\n             return response\n-        if not response.status_code == 200:\n+        if response.streaming or response.status_code != 200:\n             return response\n         # Try to get the timeout from the \"max-age\" section of the \"Cache-\n         # Control\" header before reverting to using the default cache_timeout"
        },
        {
            "sha": "4d6dc8fcd02aab4000fc7dbc5ff08866cb42b285",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 12,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/1c8be95a864540d416602577d1aa03d58ba33168/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1c8be95a864540d416602577d1aa03d58ba33168/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=1c8be95a864540d416602577d1aa03d58ba33168",
            "patch": "@@ -1428,24 +1428,21 @@ def set_cache(request, lang, msg):\n             CACHE_MIDDLEWARE_SECONDS=60,\n             USE_ETAGS=True,\n     )\n-    def test_middleware_with_streaming_response(self):\n-        # cache with non empty request.GET\n-        request = self._get_request_cache(query_string='foo=baz&other=true')\n-\n-        # first access, cache must return None\n+    def test_middleware_doesnt_cache_streaming_response(self):\n+        request = self._get_request()\n         get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-        self.assertEqual(get_cache_data, None)\n+        self.assertIsNone(get_cache_data)\n \n-        # pass streaming response through UpdateCacheMiddleware.\n-        content = 'Check for cache with QUERY_STRING and streaming content'\n+        # This test passes on Python < 3.3 even without the corresponding code\n+        # in UpdateCacheMiddleware, because pickling a StreamingHttpResponse\n+        # fails (http://bugs.python.org/issue14288). LocMemCache silently\n+        # swallows the exception and doesn't store the response in cache.\n+        content = ['Check for cache with streaming content.']\n         response = StreamingHttpResponse(content)\n         UpdateCacheMiddleware().process_response(request, response)\n \n-        # second access, cache must still return None, because we can't cache\n-        # streaming response.\n         get_cache_data = FetchFromCacheMiddleware().process_request(request)\n-        self.assertEqual(get_cache_data, None)\n-\n+        self.assertIsNone(get_cache_data)\n \n @override_settings(\n         CACHES={"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 10,
        "deletions": 13
    }
}