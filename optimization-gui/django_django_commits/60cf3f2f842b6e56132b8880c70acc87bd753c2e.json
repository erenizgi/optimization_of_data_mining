{
    "author": "alex",
    "message": "Allow SimpleLazyObjects to return None without constantly being reevaluated, also proxy ``__nonzero__``, and do some codecleanup as well.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16308 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "60cf3f2f842b6e56132b8880c70acc87bd753c2e",
    "files": [
        {
            "sha": "c8f8ee33c7f4f7e54402c0f6be854e8816103553",
            "filename": "django/utils/functional.py",
            "status": "modified",
            "additions": 24,
            "deletions": 34,
            "changes": 58,
            "blob_url": "https://github.com/django/django/blob/60cf3f2f842b6e56132b8880c70acc87bd753c2e/django%2Futils%2Ffunctional.py",
            "raw_url": "https://github.com/django/django/raw/60cf3f2f842b6e56132b8880c70acc87bd753c2e/django%2Futils%2Ffunctional.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ffunctional.py?ref=60cf3f2f842b6e56132b8880c70acc87bd753c2e",
            "patch": "@@ -1,3 +1,4 @@\n+import operator\n from functools import wraps, update_wrapper\n \n \n@@ -164,6 +165,14 @@ def wrapper(*args, **kwargs):\n         return lazy(func, *resultclasses)(*args, **kwargs)\n     return wrapper\n \n+empty = object()\n+def new_method_proxy(func):\n+    def inner(self, *args):\n+        if self._wrapped is empty:\n+            self._setup()\n+        return func(self._wrapped, *args)\n+    return inner\n+\n class LazyObject(object):\n     \"\"\"\n     A wrapper for another class that can be used to delay instantiation of the\n@@ -173,26 +182,23 @@ class LazyObject(object):\n     instantiation. If you don't need to do that, use SimpleLazyObject.\n     \"\"\"\n     def __init__(self):\n-        self._wrapped = None\n+        self._wrapped = empty\n \n-    def __getattr__(self, name):\n-        if self._wrapped is None:\n-            self._setup()\n-        return getattr(self._wrapped, name)\n+    __getattr__ = new_method_proxy(getattr)\n \n     def __setattr__(self, name, value):\n         if name == \"_wrapped\":\n             # Assign to __dict__ to avoid infinite __setattr__ loops.\n             self.__dict__[\"_wrapped\"] = value\n         else:\n-            if self._wrapped is None:\n+            if self._wrapped is empty:\n                 self._setup()\n             setattr(self._wrapped, name, value)\n \n     def __delattr__(self, name):\n         if name == \"_wrapped\":\n             raise TypeError(\"can't delete _wrapped.\")\n-        if self._wrapped is None:\n+        if self._wrapped is empty:\n             self._setup()\n         delattr(self._wrapped, name)\n \n@@ -204,11 +210,8 @@ def _setup(self):\n \n     # introspection support:\n     __members__ = property(lambda self: self.__dir__())\n+    __dir__ = new_method_proxy(dir)\n \n-    def __dir__(self):\n-        if self._wrapped is None:\n-            self._setup()\n-        return dir(self._wrapped)\n \n class SimpleLazyObject(LazyObject):\n     \"\"\"\n@@ -229,16 +232,14 @@ def __init__(self, func):\n         self.__dict__['_setupfunc'] = func\n         super(SimpleLazyObject, self).__init__()\n \n-    def __str__(self):\n-        if self._wrapped is None: self._setup()\n-        return str(self._wrapped)\n+    def _setup(self):\n+        self._wrapped = self._setupfunc()\n \n-    def __unicode__(self):\n-        if self._wrapped is None: self._setup()\n-        return unicode(self._wrapped)\n+    __str__ = new_method_proxy(str)\n+    __unicode__ = new_method_proxy(unicode)\n \n     def __deepcopy__(self, memo):\n-        if self._wrapped is None:\n+        if self._wrapped is empty:\n             # We have to use SimpleLazyObject, not self.__class__, because the\n             # latter is proxied.\n             result = SimpleLazyObject(self._setupfunc)\n@@ -250,21 +251,10 @@ def __deepcopy__(self, memo):\n \n     # Need to pretend to be the wrapped class, for the sake of objects that care\n     # about this (especially in equality tests)\n-    def __get_class(self):\n-        if self._wrapped is None: self._setup()\n-        return self._wrapped.__class__\n-    __class__ = property(__get_class)\n-\n-    def __eq__(self, other):\n-        if self._wrapped is None: self._setup()\n-        return self._wrapped == other\n-\n-    def __hash__(self):\n-        if self._wrapped is None: self._setup()\n-        return hash(self._wrapped)\n-\n-    def _setup(self):\n-        self._wrapped = self._setupfunc()\n+    __class__ = property(new_method_proxy(operator.attrgetter(\"__class__\")))\n+    __eq__ = new_method_proxy(operator.eq)\n+    __hash__ = new_method_proxy(hash)\n+    __nonzero__ = new_method_proxy(bool)\n \n \n class lazy_property(property):\n@@ -285,4 +275,4 @@ def fset(instance, value, name=fset.__name__):\n             @wraps(fdel)\n             def fdel(instance, name=fdel.__name__):\n                 return getattr(instance, name)()\n-        return property(fget, fset, fdel, doc)\n+        return property(fget, fset, fdel, doc)\n\\ No newline at end of file"
        },
        {
            "sha": "e84752a5cc18b86b7416cbc960b2c566c87271a8",
            "filename": "tests/regressiontests/utils/simplelazyobject.py",
            "status": "modified",
            "additions": 25,
            "deletions": 4,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/60cf3f2f842b6e56132b8880c70acc87bd753c2e/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py",
            "raw_url": "https://github.com/django/django/raw/60cf3f2f842b6e56132b8880c70acc87bd753c2e/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fsimplelazyobject.py?ref=60cf3f2f842b6e56132b8880c70acc87bd753c2e",
            "patch": "@@ -1,7 +1,8 @@\n import copy\n import unittest\n \n-from django.utils.functional import SimpleLazyObject\n+from django.utils.functional import SimpleLazyObject, empty\n+\n \n class _ComplexObject(object):\n     def __init__(self, name):\n@@ -65,13 +66,33 @@ def test_deepcopy(self):\n \n         # First, for an unevaluated SimpleLazyObject\n         s = SimpleLazyObject(complex_object)\n-        assert s._wrapped is None\n+        self.assertIs(s._wrapped, empty)\n         s2 = copy.deepcopy(s)\n-        assert s._wrapped is None # something has gone wrong is s is evaluated\n+        # something has gone wrong is s is evaluated\n+        self.assertIs(s._wrapped, empty)\n         self.assertEqual(s2, complex_object())\n \n         # Second, for an evaluated SimpleLazyObject\n         name = s.name # evaluate\n-        assert s._wrapped is not None\n+        self.assertIsNot(s._wrapped, empty)\n         s3 = copy.deepcopy(s)\n         self.assertEqual(s3, complex_object())\n+\n+\n+    def test_none(self):\n+        i = [0]\n+        def f():\n+            i[0] += 1\n+            return None\n+\n+        x = SimpleLazyObject(f)\n+        self.assertEqual(str(x), \"None\")\n+        self.assertEqual(i, [1])\n+        self.assertEqual(str(x), \"None\")\n+        self.assertEqual(i, [1])\n+\n+    def test_bool(self):\n+        x = SimpleLazyObject(lambda: 3)\n+        self.assertTrue(x)\n+        x = SimpleLazyObject(lambda: 0)\n+        self.assertFalse(x)\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 49,
        "deletions": 38
    }
}