{
    "author": "aaugustin",
    "message": "Fixed #19519 again -- Regression in LiveServerTestCase after fd1279a4.",
    "sha": "bacb097ac31af2479c43934747b34fad7c91f55c",
    "files": [
        {
            "sha": "6bdc1cf3d3778b331f3160527077f2bcda975314",
            "filename": "django/test/client.py",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/bacb097ac31af2479c43934747b34fad7c91f55c/django%2Ftest%2Fclient.py",
            "raw_url": "https://github.com/django/django/raw/bacb097ac31af2479c43934747b34fad7c91f55c/django%2Ftest%2Fclient.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fclient.py?ref=bacb097ac31af2479c43934747b34fad7c91f55c",
            "patch": "@@ -16,7 +16,9 @@\n from django.contrib.auth import authenticate, login\n from django.core.handlers.base import BaseHandler\n from django.core.handlers.wsgi import WSGIRequest\n-from django.core.signals import got_request_exception\n+from django.core.signals import (request_started, request_finished,\n+    got_request_exception)\n+from django.db import close_connection\n from django.http import SimpleCookie, HttpRequest, QueryDict\n from django.template import TemplateDoesNotExist\n from django.test import signals\n@@ -76,7 +78,9 @@ def closing_iterator_wrapper(iterable, close):\n         for item in iterable:\n             yield item\n     finally:\n-        close()\n+        request_finished.disconnect(close_connection)\n+        close()                                 # will fire request_finished\n+        request_finished.connect(close_connection)\n \n \n class ClientHandler(BaseHandler):\n@@ -91,14 +95,13 @@ def __init__(self, enforce_csrf_checks=True, *args, **kwargs):\n \n     def __call__(self, environ):\n         from django.conf import settings\n-        from django.core import signals\n \n         # Set up middleware if needed. We couldn't do this earlier, because\n         # settings weren't available.\n         if self._request_middleware is None:\n             self.load_middleware()\n \n-        signals.request_started.send(sender=self.__class__)\n+        request_started.send(sender=self.__class__)\n         request = WSGIRequest(environ)\n         # sneaky little hack so that we can easily get round\n         # CsrfViewMiddleware.  This makes life easier, and is probably\n@@ -112,7 +115,9 @@ def __call__(self, environ):\n             response.streaming_content = closing_iterator_wrapper(\n                 response.streaming_content, response.close)\n         else:\n-            response.close()\n+            request_finished.disconnect(close_connection)\n+            response.close()                    # will fire request_finished\n+            request_finished.connect(close_connection)\n \n         return response\n "
        },
        {
            "sha": "c311540fc362ef9e7d0ccbaa5cca1d8a9b8eaa22",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/bacb097ac31af2479c43934747b34fad7c91f55c/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/bacb097ac31af2479c43934747b34fad7c91f55c/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=bacb097ac31af2479c43934747b34fad7c91f55c",
            "patch": "@@ -641,8 +641,6 @@ def assertContains(self, response, text, count=None, status_code=200,\n         else:\n             content = response.content\n         content = content.decode(response._charset)\n-        # Avoid ResourceWarning about unclosed files.\n-        response.close()\n         if html:\n             content = assert_and_parse_html(self, content, None,\n                 \"Response's content is not valid HTML:\")"
        },
        {
            "sha": "8114ae0e6a07ef84952d46e434b4b449f1ffacfb",
            "filename": "django/test/utils.py",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/bacb097ac31af2479c43934747b34fad7c91f55c/django%2Ftest%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/bacb097ac31af2479c43934747b34fad7c91f55c/django%2Ftest%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Futils.py?ref=bacb097ac31af2479c43934747b34fad7c91f55c",
            "patch": "@@ -4,8 +4,6 @@\n \n from django.conf import settings, UserSettingsHolder\n from django.core import mail\n-from django.core.signals import request_finished\n-from django.db import close_connection\n from django.test.signals import template_rendered, setting_changed\n from django.template import Template, loader, TemplateDoesNotExist\n from django.template.loaders import cached\n@@ -70,10 +68,8 @@ def setup_test_environment():\n     \"\"\"Perform any global pre-test setup. This involves:\n \n         - Installing the instrumented test renderer\n-        - Setting the email backend to the locmem email backend.\n+        - Set the email backend to the locmem email backend.\n         - Setting the active locale to match the LANGUAGE_CODE setting.\n-        - Disconnecting the request_finished signal to avoid closing\n-          the database connection within tests.\n     \"\"\"\n     Template.original_render = Template._render\n     Template._render = instrumented_test_render\n@@ -85,8 +81,6 @@ def setup_test_environment():\n \n     deactivate()\n \n-    request_finished.disconnect(close_connection)\n-\n \n def teardown_test_environment():\n     \"\"\"Perform any global post-test teardown. This involves:"
        },
        {
            "sha": "3557a63fd5029b67f71c9483161f02b09cbdfe7c",
            "filename": "tests/regressiontests/handlers/tests.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/bacb097ac31af2479c43934747b34fad7c91f55c/tests%2Fregressiontests%2Fhandlers%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bacb097ac31af2479c43934747b34fad7c91f55c/tests%2Fregressiontests%2Fhandlers%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fhandlers%2Ftests.py?ref=bacb097ac31af2479c43934747b34fad7c91f55c",
            "patch": "@@ -56,6 +56,5 @@ def test_request_signals(self):\n     def test_request_signals_streaming_response(self):\n         response = self.client.get('/streaming/')\n         self.assertEqual(self.signals, ['started'])\n-        # Avoid self.assertContains, because it explicitly calls response.close()\n         self.assertEqual(b''.join(response.streaming_content), b\"streaming content\")\n         self.assertEqual(self.signals, ['started', 'finished'])"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 11,
        "deletions": 15
    }
}