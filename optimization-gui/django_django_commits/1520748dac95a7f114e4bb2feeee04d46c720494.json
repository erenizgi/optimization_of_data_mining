{
    "author": "jezdez",
    "message": "Fixed #2550 -- Allow the auth backends to raise the PermissionDenied exception to completely stop the authentication chain. Many thanks to namn, danielr, Dan Julius, ≈Åukasz Rekucki, Aashu Dwivedi and umbrae for working this over the years.",
    "sha": "1520748dac95a7f114e4bb2feeee04d46c720494",
    "files": [
        {
            "sha": "5dbda44501de28c8fb8b7b61e415612970652043",
            "filename": "django/contrib/auth/__init__.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/1520748dac95a7f114e4bb2feeee04d46c720494/django%2Fcontrib%2Fauth%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/1520748dac95a7f114e4bb2feeee04d46c720494/django%2Fcontrib%2Fauth%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2F__init__.py?ref=1520748dac95a7f114e4bb2feeee04d46c720494",
            "patch": "@@ -1,6 +1,6 @@\n import re\n \n-from django.core.exceptions import ImproperlyConfigured\n+from django.core.exceptions import ImproperlyConfigured, PermissionDenied\n from django.utils.importlib import import_module\n from django.contrib.auth.signals import user_logged_in, user_logged_out, user_login_failed\n \n@@ -60,6 +60,9 @@ def authenticate(**credentials):\n         except TypeError:\n             # This backend doesn't accept these credentials as arguments. Try the next one.\n             continue\n+        except PermissionDenied:\n+            # This backend says to stop in our tracks - this user should not be allowed in at all.\n+            return None\n         if user is None:\n             continue\n         # Annotate the user object with the path of the backend."
        },
        {
            "sha": "2ab0bd0efa3c47210e14ef297e7c5c333c0fdea7",
            "filename": "django/contrib/auth/tests/auth_backends.py",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/django/django/blob/1520748dac95a7f114e4bb2feeee04d46c720494/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "raw_url": "https://github.com/django/django/raw/1520748dac95a7f114e4bb2feeee04d46c720494/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py?ref=1520748dac95a7f114e4bb2feeee04d46c720494",
            "patch": "@@ -6,7 +6,8 @@\n from django.contrib.auth.tests.utils import skipIfCustomUser\n from django.contrib.auth.tests.custom_user import ExtensionUser\n from django.contrib.contenttypes.models import ContentType\n-from django.core.exceptions import ImproperlyConfigured\n+from django.core.exceptions import ImproperlyConfigured, PermissionDenied\n+from django.contrib.auth import authenticate\n from django.test import TestCase\n from django.test.utils import override_settings\n \n@@ -323,3 +324,37 @@ def test_has_perm(self):\n     def test_has_module_perms(self):\n         self.assertEqual(self.user1.has_module_perms(\"app1\"), False)\n         self.assertEqual(self.user1.has_module_perms(\"app2\"), False)\n+\n+\n+class PermissionDeniedBackend(object):\n+    \"\"\"\n+    Always raises PermissionDenied.\n+    \"\"\"\n+    supports_object_permissions = True\n+    supports_anonymous_user = True\n+    supports_inactive_user = True\n+\n+    def authenticate(self, username=None, password=None):\n+        raise PermissionDenied\n+\n+\n+class PermissionDeniedBackendTest(TestCase):\n+    \"\"\"\n+    Tests that other backends are not checked once a backend raises PermissionDenied\n+    \"\"\"\n+    backend = 'django.contrib.auth.tests.auth_backends.PermissionDeniedBackend'\n+\n+    def setUp(self):\n+        self.user1 = User.objects.create_user('test', 'test@example.com', 'test')\n+        self.user1.save()\n+\n+    @override_settings(AUTHENTICATION_BACKENDS=(backend, ) +\n+            tuple(settings.AUTHENTICATION_BACKENDS))\n+    def test_permission_denied(self):\n+        \"user is not authenticated after a backend raises permission denied #2550\"\n+        self.assertEqual(authenticate(username='test', password='test'), None)\n+\n+    @override_settings(AUTHENTICATION_BACKENDS=tuple(\n+            settings.AUTHENTICATION_BACKENDS) + (backend, ))\n+    def test_authenticates(self):\n+        self.assertEqual(authenticate(username='test', password='test'), self.user1)"
        },
        {
            "sha": "49649bc6b89ad61279789edab7aada76966ae741",
            "filename": "docs/releases/1.6.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/1520748dac95a7f114e4bb2feeee04d46c720494/docs%2Freleases%2F1.6.txt",
            "raw_url": "https://github.com/django/django/raw/1520748dac95a7f114e4bb2feeee04d46c720494/docs%2Freleases%2F1.6.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.6.txt?ref=1520748dac95a7f114e4bb2feeee04d46c720494",
            "patch": "@@ -17,6 +17,12 @@ deprecation process for some features`_.\n What's new in Django 1.6\n ========================\n \n+Minor features\n+~~~~~~~~~~~~~~\n+\n+* Authentication backends can raise ``PermissionDenied`` to immediately fail\n+  the authentication chain.\n+\n Backwards incompatible changes in 1.6\n =====================================\n "
        },
        {
            "sha": "6d8e3c66c3c1c9b641a299d4d179e1dc6e5c5427",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/1520748dac95a7f114e4bb2feeee04d46c720494/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/1520748dac95a7f114e4bb2feeee04d46c720494/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=1520748dac95a7f114e4bb2feeee04d46c720494",
            "patch": "@@ -2391,6 +2391,12 @@ processing at the first positive match.\n     you need to force users to re-authenticate using different methods. A simple\n     way to do that is simply to execute ``Session.objects.all().delete()``.\n \n+.. versionadded:: 1.6\n+\n+If a backend raises a :class:`~django.core.exceptions.PermissionDenied`\n+exception, authentication will immediately fail. Django won't check the\n+backends that follow.\n+\n Writing an authentication backend\n ---------------------------------\n "
        }
    ],
    "stats": {
        "total": 54,
        "additions": 52,
        "deletions": 2
    }
}