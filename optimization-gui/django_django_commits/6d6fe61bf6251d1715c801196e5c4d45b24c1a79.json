{
    "author": "spookylukey",
    "message": "Cleanups to related manager code, especially in use of closures.\n\nThe related manager classes are defined within functions, and the methods\nhad inconsistent and confusing usage of closures vs. parameters on self to\nretrieve needed information. Everything is stored on self now.\n\nAlso some methods were not using super() where they should have been.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16913 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "6d6fe61bf6251d1715c801196e5c4d45b24c1a79",
    "files": [
        {
            "sha": "2e7317ca0d5af4dfa6b6623e59695a1f9b3cee78",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/6d6fe61bf6251d1715c801196e5c4d45b24c1a79/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/6d6fe61bf6251d1715c801196e5c4d45b24c1a79/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=6d6fe61bf6251d1715c801196e5c4d45b24c1a79",
            "patch": "@@ -266,7 +266,7 @@ def get_query_set(self):\n                 '%s__pk' % self.content_type_field_name : self.content_type.id,\n                 '%s__exact' % self.object_id_field_name : self.pk_val,\n             }\n-            return superclass.get_query_set(self).using(db).filter(**query)\n+            return super(GenericRelatedObjectManager, self).get_query_set().using(db).filter(**query)\n \n         def add(self, *objs):\n             for obj in objs:"
        },
        {
            "sha": "eee2ecf4d64ac5ee7f9258db230b556dcc98f582",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 36,
            "deletions": 32,
            "changes": 68,
            "blob_url": "https://github.com/django/django/blob/6d6fe61bf6251d1715c801196e5c4d45b24c1a79/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/6d6fe61bf6251d1715c801196e5c4d45b24c1a79/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=6d6fe61bf6251d1715c801196e5c4d45b24c1a79",
            "patch": "@@ -414,88 +414,90 @@ def create_manager(self, instance, superclass):\n         Creates the managers used by other methods (__get__() and delete()).\n         \"\"\"\n         rel_field = self.related.field\n-        rel_model = self.related.model\n-\n         class RelatedManager(superclass):\n-            def __init__(self, model=None, core_filters=None, instance=None):\n+            def __init__(self, model=None, core_filters=None, instance=None,\n+                         rel_field=None):\n                 super(RelatedManager, self).__init__()\n                 self.model = model\n                 self.core_filters = core_filters\n                 self.instance = instance\n+                self.rel_field = rel_field\n \n             def get_query_set(self):\n-                db = self._db or router.db_for_read(rel_model, instance=self.instance)\n-                return superclass.get_query_set(self).using(db).filter(**(self.core_filters))\n+                db = self._db or router.db_for_read(self.model, instance=self.instance)\n+                return super(RelatedManager, self).get_query_set().using(db).filter(**(self.core_filters))\n \n             def add(self, *objs):\n                 for obj in objs:\n                     if not isinstance(obj, self.model):\n                         raise TypeError(\"'%s' instance expected\" % self.model._meta.object_name)\n-                    setattr(obj, rel_field.name, self.instance)\n+                    setattr(obj, self.rel_field.name, self.instance)\n                     obj.save()\n             add.alters_data = True\n \n             def create(self, **kwargs):\n-                kwargs[rel_field.name] = self.instance\n-                db = router.db_for_write(rel_model, instance=self.instance)\n+                kwargs[self.rel_field.name] = self.instance\n+                db = router.db_for_write(self.model, instance=self.instance)\n                 return super(RelatedManager, self.db_manager(db)).create(**kwargs)\n             create.alters_data = True\n \n             def get_or_create(self, **kwargs):\n                 # Update kwargs with the related object that this\n                 # ForeignRelatedObjectsDescriptor knows about.\n-                kwargs[rel_field.name] = self.instance\n-                db = router.db_for_write(rel_model, instance=self.instance)\n+                kwargs[self.rel_field.name] = self.instance\n+                db = router.db_for_write(self.model, instance=self.instance)\n                 return super(RelatedManager, self.db_manager(db)).get_or_create(**kwargs)\n             get_or_create.alters_data = True\n \n             # remove() and clear() are only provided if the ForeignKey can have a value of null.\n             if rel_field.null:\n                 def remove(self, *objs):\n-                    val = getattr(self.instance, rel_field.rel.get_related_field().attname)\n+                    val = getattr(self.instance, self.rel_field.rel.get_related_field().attname)\n                     for obj in objs:\n                         # Is obj actually part of this descriptor set?\n-                        if getattr(obj, rel_field.attname) == val:\n-                            setattr(obj, rel_field.name, None)\n+                        if getattr(obj, self.rel_field.attname) == val:\n+                            setattr(obj, self.rel_field.name, None)\n                             obj.save()\n                         else:\n-                            raise rel_field.rel.to.DoesNotExist(\"%r is not related to %r.\" % (obj, self.instance))\n+                            raise self.rel_field.rel.to.DoesNotExist(\"%r is not related to %r.\" % (obj, self.instance))\n                 remove.alters_data = True\n \n                 def clear(self):\n-                    self.update(**{rel_field.name: None})\n+                    self.update(**{self.rel_field.name: None})\n                 clear.alters_data = True\n \n         attname = rel_field.rel.get_related_field().name\n         return RelatedManager(model=self.related.model,\n                               core_filters = {'%s__%s' % (rel_field.name, attname):\n                                                   getattr(instance, attname)},\n-                              instance=instance\n+                              instance=instance,\n+                              rel_field=rel_field,\n                               )\n \n+\n def create_many_related_manager(superclass, rel):\n     \"\"\"Creates a manager that subclasses 'superclass' (which is a Manager)\n     and adds behavior for many-to-many related objects.\"\"\"\n-    through = rel.through\n     class ManyRelatedManager(superclass):\n         def __init__(self, model=None, core_filters=None, instance=None, symmetrical=None,\n-                     source_field_name=None, target_field_name=None, reverse=False):\n+                     source_field_name=None, target_field_name=None, reverse=False,\n+                     through=None):\n             super(ManyRelatedManager, self).__init__()\n-            self.core_filters = core_filters\n             self.model = model\n-            self.symmetrical = symmetrical\n+            self.core_filters = core_filters\n             self.instance = instance\n+            self.symmetrical = symmetrical\n             self.source_field_name = source_field_name\n             self.target_field_name = target_field_name\n+            self.reverse = reverse\n             self.through = through\n             self._pk_val = self.instance.pk\n-            self.reverse = reverse\n             if self._pk_val is None:\n                 raise ValueError(\"%r instance needs to have a primary key value before a many-to-many relationship can be used.\" % instance.__class__.__name__)\n \n         def get_query_set(self):\n             db = self._db or router.db_for_read(self.instance.__class__, instance=self.instance)\n-            return superclass.get_query_set(self).using(db)._next_is_sticky().filter(**(self.core_filters))\n+            return super(ManyRelatedManager, self).get_query_set().using(db)._next_is_sticky().filter(**(self.core_filters))\n \n         # If the ManyToMany relation has an intermediary model,\n         # the add and remove methods do not exist.\n@@ -527,8 +529,8 @@ def clear(self):\n         def create(self, **kwargs):\n             # This check needs to be done here, since we can't later remove this\n             # from the method lookup table, as we do with add and remove.\n-            if not rel.through._meta.auto_created:\n-                opts = through._meta\n+            if not self.through._meta.auto_created:\n+                opts = self.through._meta\n                 raise AttributeError(\"Cannot use create() on a ManyToManyField which specifies an intermediary model. Use %s.%s's Manager instead.\" % (opts.app_label, opts.object_name))\n             db = router.db_for_write(self.instance.__class__, instance=self.instance)\n             new_obj = super(ManyRelatedManager, self.db_manager(db)).create(**kwargs)\n@@ -577,7 +579,7 @@ def _add_items(self, source_field_name, target_field_name, *objs):\n                 if self.reverse or source_field_name == self.source_field_name:\n                     # Don't send the signal when we are inserting the\n                     # duplicate data row for symmetrical reverse entries.\n-                    signals.m2m_changed.send(sender=rel.through, action='pre_add',\n+                    signals.m2m_changed.send(sender=self.through, action='pre_add',\n                         instance=self.instance, reverse=self.reverse,\n                         model=self.model, pk_set=new_ids, using=db)\n                 # Add the ones that aren't there already\n@@ -591,7 +593,7 @@ def _add_items(self, source_field_name, target_field_name, *objs):\n                 if self.reverse or source_field_name == self.source_field_name:\n                     # Don't send the signal when we are inserting the\n                     # duplicate data row for symmetrical reverse entries.\n-                    signals.m2m_changed.send(sender=rel.through, action='post_add',\n+                    signals.m2m_changed.send(sender=self.through, action='post_add',\n                         instance=self.instance, reverse=self.reverse,\n                         model=self.model, pk_set=new_ids, using=db)\n \n@@ -615,7 +617,7 @@ def _remove_items(self, source_field_name, target_field_name, *objs):\n                 if self.reverse or source_field_name == self.source_field_name:\n                     # Don't send the signal when we are deleting the\n                     # duplicate data row for symmetrical reverse entries.\n-                    signals.m2m_changed.send(sender=rel.through, action=\"pre_remove\",\n+                    signals.m2m_changed.send(sender=self.through, action=\"pre_remove\",\n                         instance=self.instance, reverse=self.reverse,\n                         model=self.model, pk_set=old_ids, using=db)\n                 # Remove the specified objects from the join table\n@@ -626,7 +628,7 @@ def _remove_items(self, source_field_name, target_field_name, *objs):\n                 if self.reverse or source_field_name == self.source_field_name:\n                     # Don't send the signal when we are deleting the\n                     # duplicate data row for symmetrical reverse entries.\n-                    signals.m2m_changed.send(sender=rel.through, action=\"post_remove\",\n+                    signals.m2m_changed.send(sender=self.through, action=\"post_remove\",\n                         instance=self.instance, reverse=self.reverse,\n                         model=self.model, pk_set=old_ids, using=db)\n \n@@ -636,7 +638,7 @@ def _clear_items(self, source_field_name):\n             if self.reverse or source_field_name == self.source_field_name:\n                 # Don't send the signal when we are clearing the\n                 # duplicate data rows for symmetrical reverse entries.\n-                signals.m2m_changed.send(sender=rel.through, action=\"pre_clear\",\n+                signals.m2m_changed.send(sender=self.through, action=\"pre_clear\",\n                     instance=self.instance, reverse=self.reverse,\n                     model=self.model, pk_set=None, using=db)\n             self.through._default_manager.using(db).filter(**{\n@@ -645,7 +647,7 @@ def _clear_items(self, source_field_name):\n             if self.reverse or source_field_name == self.source_field_name:\n                 # Don't send the signal when we are clearing the\n                 # duplicate data rows for symmetrical reverse entries.\n-                signals.m2m_changed.send(sender=rel.through, action=\"post_clear\",\n+                signals.m2m_changed.send(sender=self.through, action=\"post_clear\",\n                     instance=self.instance, reverse=self.reverse,\n                     model=self.model, pk_set=None, using=db)\n \n@@ -678,7 +680,8 @@ def __get__(self, instance, instance_type=None):\n             symmetrical=False,\n             source_field_name=self.related.field.m2m_reverse_field_name(),\n             target_field_name=self.related.field.m2m_field_name(),\n-            reverse=True\n+            reverse=True,\n+            through=self.related.field.rel.through,\n         )\n \n         return manager\n@@ -730,7 +733,8 @@ def __get__(self, instance, instance_type=None):\n             symmetrical=self.field.rel.symmetrical,\n             source_field_name=self.field.m2m_field_name(),\n             target_field_name=self.field.m2m_reverse_field_name(),\n-            reverse=False\n+            reverse=False,\n+            through=self.field.rel.through,\n         )\n \n         return manager"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 37,
        "deletions": 33
    }
}