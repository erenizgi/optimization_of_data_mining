{
    "author": "aaugustin",
    "message": "Fixed #17634 -- Optimized the performance of MultiValueDict by using append instead of copy and by minimizing the number of dict lookups. Refs #736.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17464 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "bd5861251490758e189d6d657de4683897024c70",
    "files": [
        {
            "sha": "09d37518e0b8564f3c730d9ad98b8b9c143d0b07",
            "filename": "django/utils/datastructures.py",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/django/django/blob/bd5861251490758e189d6d657de4683897024c70/django%2Futils%2Fdatastructures.py",
            "raw_url": "https://github.com/django/django/raw/bd5861251490758e189d6d657de4683897024c70/django%2Futils%2Fdatastructures.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Fdatastructures.py?ref=bd5861251490758e189d6d657de4683897024c70",
            "patch": "@@ -312,27 +312,30 @@ def getlist(self, key, default=None):\n         try:\n             return super(MultiValueDict, self).__getitem__(key)\n         except KeyError:\n-            if default is not None:\n-                return default\n-            return []\n+            if default is None:\n+                return []\n+            return default\n \n     def setlist(self, key, list_):\n         super(MultiValueDict, self).__setitem__(key, list_)\n \n     def setdefault(self, key, default=None):\n         if key not in self:\n             self[key] = default\n+            return default\n         return self[key]\n \n-    def setlistdefault(self, key, default_list=()):\n+    def setlistdefault(self, key, default_list=None):\n         if key not in self:\n+            if default_list is None:\n+                default_list = []\n             self.setlist(key, default_list)\n+            return default_list\n         return self.getlist(key)\n \n     def appendlist(self, key, value):\n         \"\"\"Appends an item to the internal list associated with key.\"\"\"\n-        self.setlistdefault(key, [])\n-        super(MultiValueDict, self).__setitem__(key, self.getlist(key) + [value])\n+        self.setlistdefault(key).append(value)\n \n     def items(self):\n         \"\"\"\n@@ -381,15 +384,15 @@ def update(self, *args, **kwargs):\n             other_dict = args[0]\n             if isinstance(other_dict, MultiValueDict):\n                 for key, value_list in other_dict.lists():\n-                    self.setlistdefault(key, []).extend(value_list)\n+                    self.setlistdefault(key).extend(value_list)\n             else:\n                 try:\n                     for key, value in other_dict.items():\n-                        self.setlistdefault(key, []).append(value)\n+                        self.setlistdefault(key).append(value)\n                 except TypeError:\n                     raise ValueError(\"MultiValueDict.update() takes either a MultiValueDict or dictionary\")\n         for key, value in kwargs.iteritems():\n-            self.setlistdefault(key, []).append(value)\n+            self.setlistdefault(key).append(value)\n \n     def dict(self):\n         \"\"\""
        },
        {
            "sha": "d6db99100794794b824c2df3fb96eb90861e61e6",
            "filename": "tests/regressiontests/utils/datastructures.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/bd5861251490758e189d6d657de4683897024c70/tests%2Fregressiontests%2Futils%2Fdatastructures.py",
            "raw_url": "https://github.com/django/django/raw/bd5861251490758e189d6d657de4683897024c70/tests%2Fregressiontests%2Futils%2Fdatastructures.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Futils%2Fdatastructures.py?ref=bd5861251490758e189d6d657de4683897024c70",
            "patch": "@@ -206,6 +206,12 @@ def test_multivaluedict(self):\n         self.assertEqual(list(d.itervalues()),\n                           ['Developer', 'Simon', 'Willison'])\n \n+    def test_appendlist(self):\n+        d = MultiValueDict()\n+        d.appendlist('name', 'Adrian')\n+        d.appendlist('name', 'Simon')\n+        self.assertEqual(d.getlist('name'), ['Adrian', 'Simon'])\n+\n     def test_copy(self):\n         for copy_func in [copy.copy, lambda d: d.copy()]:\n             d1 = MultiValueDict({"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 18,
        "deletions": 9
    }
}