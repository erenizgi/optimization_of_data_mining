{
    "author": "spookylukey",
    "message": "More efficient IN clauses for prefetch_related queries by use of sets to eliminate duplicates\n\nThis simply reduces the size of the IN clause in the SQL, which can be\nsignificant in some cases.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16944 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d5803bb5fb1a301a014bb681fedc09e2bcc6967b",
    "files": [
        {
            "sha": "c5137877cba3416aecb95003b5c3ed6eff5c93fa",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/d5803bb5fb1a301a014bb681fedc09e2bcc6967b/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/d5803bb5fb1a301a014bb681fedc09e2bcc6967b/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=d5803bb5fb1a301a014bb681fedc09e2bcc6967b",
            "patch": "@@ -65,7 +65,7 @@ def get_content_type(self, obj=None, id=None, using=None):\n     def get_prefetch_query_set(self, instances):\n         # For efficiency, group the instances by content type and then do one\n         # query per model\n-        fk_dict = defaultdict(list)\n+        fk_dict = defaultdict(set)\n         # We need one instance for each group in order to get the right db:\n         instance_dict = {}\n         ct_attname = self.model._meta.get_field(self.ct_field).get_attname()\n@@ -75,7 +75,7 @@ def get_prefetch_query_set(self, instances):\n             if ct_id is not None:\n                 fk_val = getattr(instance, self.fk_field)\n                 if fk_val is not None:\n-                    fk_dict[ct_id].append(fk_val)\n+                    fk_dict[ct_id].add(fk_val)\n                     instance_dict[ct_id] = instance\n \n         ret_val = []\n@@ -325,7 +325,7 @@ def get_prefetch_query_set(self, instances):\n             query = {\n                 '%s__pk' % self.content_type_field_name: self.content_type.id,\n                 '%s__in' % self.object_id_field_name:\n-                    [obj._get_pk_val() for obj in instances]\n+                    set(obj._get_pk_val() for obj in instances)\n                 }\n             qs = super(GenericRelatedObjectManager, self).get_query_set().using(db).filter(**query)\n             return (qs,"
        },
        {
            "sha": "8c054e7303ac7f57388a0f4e51795889fe6a89ed",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/d5803bb5fb1a301a014bb681fedc09e2bcc6967b/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/d5803bb5fb1a301a014bb681fedc09e2bcc6967b/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=d5803bb5fb1a301a014bb681fedc09e2bcc6967b",
            "patch": "@@ -237,7 +237,7 @@ def get_query_set(self, **db_hints):\n         return self.related.model._base_manager.using(db)\n \n     def get_prefetch_query_set(self, instances):\n-        vals = [instance._get_pk_val() for instance in instances]\n+        vals = set(instance._get_pk_val() for instance in instances)\n         params = {'%s__pk__in' % self.related.field.name: vals}\n         return (self.get_query_set(),\n                 attrgetter(self.related.field.attname),\n@@ -316,7 +316,7 @@ def get_query_set(self, **db_hints):\n             return QuerySet(self.field.rel.to).using(db)\n \n     def get_prefetch_query_set(self, instances):\n-        vals = [getattr(instance, self.field.attname) for instance in instances]\n+        vals = set(getattr(instance, self.field.attname) for instance in instances)\n         other_field = self.field.rel.get_related_field()\n         if other_field.rel:\n             params = {'%s__pk__in' % self.field.rel.field_name: vals}\n@@ -463,7 +463,7 @@ def get_query_set(self):\n             def get_prefetch_query_set(self, instances):\n                 db = self._db or router.db_for_read(self.model)\n                 query = {'%s__%s__in' % (rel_field.name, attname):\n-                             [getattr(obj, attname) for obj in instances]}\n+                             set(getattr(obj, attname) for obj in instances)}\n                 qs = super(RelatedManager, self).get_query_set().using(db).filter(**query)\n                 return (qs,\n                         attrgetter(rel_field.get_attname()),\n@@ -546,7 +546,7 @@ def get_prefetch_query_set(self, instances):\n             from django.db import connections\n             db = self._db or router.db_for_read(self.model)\n             query = {'%s__pk__in' % self.query_field_name:\n-                         [obj._get_pk_val() for obj in instances]}\n+                         set(obj._get_pk_val() for obj in instances)}\n             qs = super(ManyRelatedManager, self).get_query_set().using(db)._next_is_sticky().filter(**query)\n \n             # M2M: need to annotate the query in order to get the primary model"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 7,
        "deletions": 7
    }
}