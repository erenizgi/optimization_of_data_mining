{
    "author": "freakboy3742",
    "message": "Fixed #19412 -- Added PermissionsMixin to the auth.User heirarchy.\n\nThis makes it easier to make a ModelBackend-compliant (with regards to\npermissions) User model.\n\nThanks to cdestigter for the report about the relationship between\nModelBackend and permissions, and to the many users on django-dev that\ncontributed to the discussion about mixins.",
    "sha": "47e1df896b17aaaa97b73ef64010a7df4ea3d8d6",
    "files": [
        {
            "sha": "7d62810923eb3b92c3b47a84c77392949cd195f9",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 84,
            "deletions": 74,
            "changes": 158,
            "blob_url": "https://github.com/django/django/blob/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=47e1df896b17aaaa97b73ef64010a7df4ea3d8d6",
            "patch": "@@ -195,38 +195,6 @@ def create_superuser(self, username, email, password, **extra_fields):\n         return u\n \n \n-# A few helper functions for common logic between User and AnonymousUser.\n-def _user_get_all_permissions(user, obj):\n-    permissions = set()\n-    for backend in auth.get_backends():\n-        if hasattr(backend, \"get_all_permissions\"):\n-            if obj is not None:\n-                permissions.update(backend.get_all_permissions(user, obj))\n-            else:\n-                permissions.update(backend.get_all_permissions(user))\n-    return permissions\n-\n-\n-def _user_has_perm(user, perm, obj):\n-    for backend in auth.get_backends():\n-        if hasattr(backend, \"has_perm\"):\n-            if obj is not None:\n-                if backend.has_perm(user, perm, obj):\n-                    return True\n-            else:\n-                if backend.has_perm(user, perm):\n-                    return True\n-    return False\n-\n-\n-def _user_has_module_perms(user, app_label):\n-    for backend in auth.get_backends():\n-        if hasattr(backend, \"has_module_perms\"):\n-            if backend.has_module_perms(user, app_label):\n-                return True\n-    return False\n-\n-\n @python_2_unicode_compatible\n class AbstractBaseUser(models.Model):\n     password = models.CharField(_('password'), max_length=128)\n@@ -290,32 +258,46 @@ def get_short_name(self):\n         raise NotImplementedError()\n \n \n-class AbstractUser(AbstractBaseUser):\n-    \"\"\"\n-    An abstract base class implementing a fully featured User model with\n-    admin-compliant permissions.\n+# A few helper functions for common logic between User and AnonymousUser.\n+def _user_get_all_permissions(user, obj):\n+    permissions = set()\n+    for backend in auth.get_backends():\n+        if hasattr(backend, \"get_all_permissions\"):\n+            if obj is not None:\n+                permissions.update(backend.get_all_permissions(user, obj))\n+            else:\n+                permissions.update(backend.get_all_permissions(user))\n+    return permissions\n \n-    Username, password and email are required. Other fields are optional.\n+\n+def _user_has_perm(user, perm, obj):\n+    for backend in auth.get_backends():\n+        if hasattr(backend, \"has_perm\"):\n+            if obj is not None:\n+                if backend.has_perm(user, perm, obj):\n+                    return True\n+            else:\n+                if backend.has_perm(user, perm):\n+                    return True\n+    return False\n+\n+\n+def _user_has_module_perms(user, app_label):\n+    for backend in auth.get_backends():\n+        if hasattr(backend, \"has_module_perms\"):\n+            if backend.has_module_perms(user, app_label):\n+                return True\n+    return False\n+\n+\n+class PermissionsMixin(models.Model):\n+    \"\"\"\n+    A mixin class that adds the fields and methods necessary to support\n+    Django's Group and Permission model using the ModelBackend.\n     \"\"\"\n-    username = models.CharField(_('username'), max_length=30, unique=True,\n-        help_text=_('Required. 30 characters or fewer. Letters, numbers and '\n-                    '@/./+/-/_ characters'),\n-        validators=[\n-            validators.RegexValidator(re.compile('^[\\w.@+-]+$'), _('Enter a valid username.'), 'invalid')\n-        ])\n-    first_name = models.CharField(_('first name'), max_length=30, blank=True)\n-    last_name = models.CharField(_('last name'), max_length=30, blank=True)\n-    email = models.EmailField(_('email address'), blank=True)\n-    is_staff = models.BooleanField(_('staff status'), default=False,\n-        help_text=_('Designates whether the user can log into this admin '\n-                    'site.'))\n-    is_active = models.BooleanField(_('active'), default=True,\n-        help_text=_('Designates whether this user should be treated as '\n-                    'active. Unselect this instead of deleting accounts.'))\n     is_superuser = models.BooleanField(_('superuser status'), default=False,\n         help_text=_('Designates that this user has all permissions without '\n                     'explicitly assigning them.'))\n-    date_joined = models.DateTimeField(_('date joined'), default=timezone.now)\n     groups = models.ManyToManyField(Group, verbose_name=_('groups'),\n         blank=True, help_text=_('The groups this user belongs to. A user will '\n                                 'get all permissions granted to each of '\n@@ -324,30 +306,9 @@ class AbstractUser(AbstractBaseUser):\n         verbose_name=_('user permissions'), blank=True,\n         help_text='Specific permissions for this user.')\n \n-    objects = UserManager()\n-\n-    USERNAME_FIELD = 'username'\n-    REQUIRED_FIELDS = ['email']\n-\n     class Meta:\n-        verbose_name = _('user')\n-        verbose_name_plural = _('users')\n         abstract = True\n \n-    def get_absolute_url(self):\n-        return \"/users/%s/\" % urlquote(self.username)\n-\n-    def get_full_name(self):\n-        \"\"\"\n-        Returns the first_name plus the last_name, with a space in between.\n-        \"\"\"\n-        full_name = '%s %s' % (self.first_name, self.last_name)\n-        return full_name.strip()\n-\n-    def get_short_name(self):\n-        \"Returns the short name for the user.\"\n-        return self.first_name\n-\n     def get_group_permissions(self, obj=None):\n         \"\"\"\n         Returns a list of permission strings that this user has through his/her\n@@ -405,6 +366,55 @@ def has_module_perms(self, app_label):\n \n         return _user_has_module_perms(self, app_label)\n \n+\n+class AbstractUser(AbstractBaseUser, PermissionsMixin):\n+    \"\"\"\n+    An abstract base class implementing a fully featured User model with\n+    admin-compliant permissions.\n+\n+    Username, password and email are required. Other fields are optional.\n+    \"\"\"\n+    username = models.CharField(_('username'), max_length=30, unique=True,\n+        help_text=_('Required. 30 characters or fewer. Letters, numbers and '\n+                    '@/./+/-/_ characters'),\n+        validators=[\n+            validators.RegexValidator(re.compile('^[\\w.@+-]+$'), _('Enter a valid username.'), 'invalid')\n+        ])\n+    first_name = models.CharField(_('first name'), max_length=30, blank=True)\n+    last_name = models.CharField(_('last name'), max_length=30, blank=True)\n+    email = models.EmailField(_('email address'), blank=True)\n+    is_staff = models.BooleanField(_('staff status'), default=False,\n+        help_text=_('Designates whether the user can log into this admin '\n+                    'site.'))\n+    is_active = models.BooleanField(_('active'), default=True,\n+        help_text=_('Designates whether this user should be treated as '\n+                    'active. Unselect this instead of deleting accounts.'))\n+    date_joined = models.DateTimeField(_('date joined'), default=timezone.now)\n+\n+    objects = UserManager()\n+\n+    USERNAME_FIELD = 'username'\n+    REQUIRED_FIELDS = ['email']\n+\n+    class Meta:\n+        verbose_name = _('user')\n+        verbose_name_plural = _('users')\n+        abstract = True\n+\n+    def get_absolute_url(self):\n+        return \"/users/%s/\" % urlquote(self.username)\n+\n+    def get_full_name(self):\n+        \"\"\"\n+        Returns the first_name plus the last_name, with a space in between.\n+        \"\"\"\n+        full_name = '%s %s' % (self.first_name, self.last_name)\n+        return full_name.strip()\n+\n+    def get_short_name(self):\n+        \"Returns the short name for the user.\"\n+        return self.first_name\n+\n     def email_user(self, subject, message, from_email=None):\n         \"\"\"\n         Sends an email to this User."
        },
        {
            "sha": "71f18d32cfffb1fca7fe032250881e1bcc68e30e",
            "filename": "django/contrib/auth/tests/auth_backends.py",
            "status": "modified",
            "additions": 37,
            "deletions": 12,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "raw_url": "https://github.com/django/django/raw/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fauth_backends.py?ref=47e1df896b17aaaa97b73ef64010a7df4ea3d8d6",
            "patch": "@@ -4,7 +4,7 @@\n from django.conf import settings\n from django.contrib.auth.models import User, Group, Permission, AnonymousUser\n from django.contrib.auth.tests.utils import skipIfCustomUser\n-from django.contrib.auth.tests.custom_user import ExtensionUser\n+from django.contrib.auth.tests.custom_user import ExtensionUser, CustomPermissionsUser\n from django.contrib.contenttypes.models import ContentType\n from django.core.exceptions import ImproperlyConfigured, PermissionDenied\n from django.contrib.auth import authenticate\n@@ -34,7 +34,7 @@ def tearDown(self):\n         ContentType.objects.clear_cache()\n \n     def test_has_perm(self):\n-        user = self.UserModel.objects.get(username='test')\n+        user = self.UserModel.objects.get(pk=self.user.pk)\n         self.assertEqual(user.has_perm('auth.test'), False)\n         user.is_staff = True\n         user.save()\n@@ -53,14 +53,14 @@ def test_has_perm(self):\n         self.assertEqual(user.has_perm('auth.test'), False)\n \n     def test_custom_perms(self):\n-        user = self.UserModel.objects.get(username='test')\n+        user = self.UserModel.objects.get(pk=self.user.pk)\n         content_type = ContentType.objects.get_for_model(Group)\n         perm = Permission.objects.create(name='test', content_type=content_type, codename='test')\n         user.user_permissions.add(perm)\n         user.save()\n \n         # reloading user to purge the _perm_cache\n-        user = self.UserModel.objects.get(username='test')\n+        user = self.UserModel.objects.get(pk=self.user.pk)\n         self.assertEqual(user.get_all_permissions() == set(['auth.test']), True)\n         self.assertEqual(user.get_group_permissions(), set([]))\n         self.assertEqual(user.has_module_perms('Group'), False)\n@@ -71,7 +71,7 @@ def test_custom_perms(self):\n         perm = Permission.objects.create(name='test3', content_type=content_type, codename='test3')\n         user.user_permissions.add(perm)\n         user.save()\n-        user = self.UserModel.objects.get(username='test')\n+        user = self.UserModel.objects.get(pk=self.user.pk)\n         self.assertEqual(user.get_all_permissions(), set(['auth.test2', 'auth.test', 'auth.test3']))\n         self.assertEqual(user.has_perm('test'), False)\n         self.assertEqual(user.has_perm('auth.test'), True)\n@@ -81,7 +81,7 @@ def test_custom_perms(self):\n         group.permissions.add(perm)\n         group.save()\n         user.groups.add(group)\n-        user = self.UserModel.objects.get(username='test')\n+        user = self.UserModel.objects.get(pk=self.user.pk)\n         exp = set(['auth.test2', 'auth.test', 'auth.test3', 'auth.test_group'])\n         self.assertEqual(user.get_all_permissions(), exp)\n         self.assertEqual(user.get_group_permissions(), set(['auth.test_group']))\n@@ -93,7 +93,7 @@ def test_custom_perms(self):\n \n     def test_has_no_object_perm(self):\n         \"\"\"Regressiontest for #12462\"\"\"\n-        user = self.UserModel.objects.get(username='test')\n+        user = self.UserModel.objects.get(pk=self.user.pk)\n         content_type = ContentType.objects.get_for_model(Group)\n         perm = Permission.objects.create(name='test', content_type=content_type, codename='test')\n         user.user_permissions.add(perm)\n@@ -106,7 +106,7 @@ def test_has_no_object_perm(self):\n \n     def test_get_all_superuser_permissions(self):\n         \"A superuser has all permissions. Refs #14795\"\n-        user = self.UserModel.objects.get(username='test2')\n+        user = self.UserModel.objects.get(pk=self.superuser.pk)\n         self.assertEqual(len(user.get_all_permissions()), len(Permission.objects.all()))\n \n \n@@ -118,12 +118,12 @@ class ModelBackendTest(BaseModelBackendTest, TestCase):\n     UserModel = User\n \n     def create_users(self):\n-        User.objects.create_user(\n+        self.user = User.objects.create_user(\n             username='test',\n             email='test@example.com',\n             password='test',\n         )\n-        User.objects.create_superuser(\n+        self.superuser = User.objects.create_superuser(\n             username='test2',\n             email='test2@example.com',\n             password='test',\n@@ -151,20 +151,45 @@ class ExtensionUserModelBackendTest(BaseModelBackendTest, TestCase):\n     UserModel = ExtensionUser\n \n     def create_users(self):\n-        ExtensionUser.objects.create_user(\n+        self.user = ExtensionUser.objects.create_user(\n             username='test',\n             email='test@example.com',\n             password='test',\n             date_of_birth=date(2006, 4, 25)\n         )\n-        ExtensionUser.objects.create_superuser(\n+        self.superuser = ExtensionUser.objects.create_superuser(\n             username='test2',\n             email='test2@example.com',\n             password='test',\n             date_of_birth=date(1976, 11, 8)\n         )\n \n \n+@override_settings(AUTH_USER_MODEL='auth.CustomPermissionsUser')\n+class CustomPermissionsUserModelBackendTest(BaseModelBackendTest, TestCase):\n+    \"\"\"\n+    Tests for the ModelBackend using the CustomPermissionsUser model.\n+\n+    As with the ExtensionUser test, this isn't a perfect test, because both\n+    the User and CustomPermissionsUser are synchronized to the database,\n+    which wouldn't ordinary happen in production.\n+    \"\"\"\n+\n+    UserModel = CustomPermissionsUser\n+\n+    def create_users(self):\n+        self.user = CustomPermissionsUser.objects.create_user(\n+            email='test@example.com',\n+            password='test',\n+            date_of_birth=date(2006, 4, 25)\n+        )\n+        self.superuser = CustomPermissionsUser.objects.create_superuser(\n+            email='test2@example.com',\n+            password='test',\n+            date_of_birth=date(1976, 11, 8)\n+        )\n+\n+\n class TestObj(object):\n     pass\n "
        },
        {
            "sha": "7e042e4895c0ee1d568bd5dcbf06382f84bc9ed1",
            "filename": "django/contrib/auth/tests/custom_user.py",
            "status": "modified",
            "additions": 41,
            "deletions": 2,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "raw_url": "https://github.com/django/django/raw/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fcustom_user.py?ref=47e1df896b17aaaa97b73ef64010a7df4ea3d8d6",
            "patch": "@@ -1,5 +1,11 @@\n from django.db import models\n-from django.contrib.auth.models import BaseUserManager, AbstractBaseUser, AbstractUser, UserManager\n+from django.contrib.auth.models import (\n+    BaseUserManager,\n+    AbstractBaseUser,\n+    AbstractUser,\n+    UserManager,\n+    PermissionsMixin\n+)\n \n \n # The custom User uses email as the unique identifier, and requires\n@@ -90,6 +96,40 @@ class Meta:\n         app_label = 'auth'\n \n \n+# The CustomPermissionsUser users email as the identifier, but uses the normal\n+# Django permissions model. This allows us to check that the PermissionsMixin\n+# includes everything that is needed to interact with the ModelBackend.\n+\n+class CustomPermissionsUserManager(CustomUserManager):\n+    def create_superuser(self, email, password, date_of_birth):\n+        u = self.create_user(email, password=password, date_of_birth=date_of_birth)\n+        u.is_superuser = True\n+        u.save(using=self._db)\n+        return u\n+\n+\n+class CustomPermissionsUser(AbstractBaseUser, PermissionsMixin):\n+    email = models.EmailField(verbose_name='email address', max_length=255, unique=True)\n+    date_of_birth = models.DateField()\n+\n+    objects = CustomPermissionsUserManager()\n+\n+    USERNAME_FIELD = 'email'\n+    REQUIRED_FIELDS = ['date_of_birth']\n+\n+    class Meta:\n+        app_label = 'auth'\n+\n+    def get_full_name(self):\n+        return self.email\n+\n+    def get_short_name(self):\n+        return self.email\n+\n+    def __unicode__(self):\n+        return self.email\n+\n+\n class IsActiveTestUser1(AbstractBaseUser):\n     \"\"\"\n     This test user class and derivatives test the default is_active behavior\n@@ -104,4 +144,3 @@ class Meta:\n         app_label = 'auth'\n \n     # the is_active attr is provided by AbstractBaseUser\n-"
        },
        {
            "sha": "3e2b6bbdbf42297233b528e40ac55cccde29a4a0",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/django/django/blob/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/47e1df896b17aaaa97b73ef64010a7df4ea3d8d6/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=47e1df896b17aaaa97b73ef64010a7df4ea3d8d6",
            "patch": "@@ -2136,6 +2136,76 @@ override any of the definitions that refer to fields on\n :class:`~django.contrib.auth.models.AbstractUser` that aren't on your\n custom User class.\n \n+Custom users and permissions\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+To make it easy to include Django's permission framework into your own User\n+class, Django provides :class:`~django.contrib.auth.model.PermissionsMixin`.\n+This is an abstract model you can include in the class heirarchy for your User\n+model, giving you all the methods and database fields necessary to support\n+Django's permission model.\n+\n+:class:`~django.contrib.auth.model.PermissionsMixin` provides the following\n+methods and attributes:\n+\n+.. class:: models.PermissionsMixin\n+\n+    .. attribute:: models.PermissionsMixin.is_superuser\n+\n+        Boolean. Designates that this user has all permissions without\n+        explicitly assigning them.\n+\n+    .. method:: models.PermissionsMixin.get_group_permissions(obj=None)\n+\n+        Returns a set of permission strings that the user has, through his/her\n+        groups.\n+\n+        If ``obj`` is passed in, only returns the group permissions for\n+        this specific object.\n+\n+    .. method:: models.PermissionsMixin.get_all_permissions(obj=None)\n+\n+        Returns a set of permission strings that the user has, both through\n+        group and user permissions.\n+\n+        If ``obj`` is passed in, only returns the permissions for this\n+        specific object.\n+\n+    .. method:: models.PermissionsMixin.has_perm(perm, obj=None)\n+\n+        Returns ``True`` if the user has the specified permission, where perm is\n+        in the format ``\"<app label>.<permission codename>\"`` (see\n+        `permissions`_). If the user is inactive, this method will\n+        always return ``False``.\n+\n+        If ``obj`` is passed in, this method won't check for a permission for\n+        the model, but for this specific object.\n+\n+    .. method:: models.PermissionsMixin.has_perms(perm_list, obj=None)\n+\n+        Returns ``True`` if the user has each of the specified permissions,\n+        where each perm is in the format\n+        ``\"<app label>.<permission codename>\"``. If the user is inactive,\n+        this method will always return ``False``.\n+\n+        If ``obj`` is passed in, this method won't check for permissions for\n+        the model, but for the specific object.\n+\n+    .. method:: models.PermissionsMixin.has_module_perms(package_name)\n+\n+        Returns ``True`` if the user has any permissions in the given package\n+        (the Django app label). If the user is inactive, this method will\n+        always return ``False``.\n+\n+.. admonition:: ModelBackend\n+\n+    If you don't include the\n+    :class:`~django.contrib.auth.model.PermissionsMixin`, you must ensure you\n+    don't invoke the permissions methods on ``ModelBackend``. ``ModelBackend``\n+    assumes that certain fields are available on your user model. If your User\n+    model doesn't provide  those fields, you will receive database errors when\n+    you check permissions.\n+\n Custom users and Proxy models\n ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n "
        }
    ],
    "stats": {
        "total": 320,
        "additions": 232,
        "deletions": 88
    }
}