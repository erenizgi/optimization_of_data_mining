{
    "author": "aaugustin",
    "message": "Fixed #19677 -- Introspection of recursive foreign keys under SQLite.\n\nThanks Simon Charette.",
    "sha": "f46d7314b50d71a75f51ebae9c5957cb96b11bd9",
    "files": [
        {
            "sha": "7304ebb192db3be393180dcf4e2e4f6f6ae412a1",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=f46d7314b50d71a75f51ebae9c5957cb96b11bd9",
            "patch": "@@ -77,7 +77,7 @@ def sql_create_model(self, model, style, known_models=set()):\n                     field_output.append(tablespace_sql)\n             if f.rel:\n                 ref_output, pending = self.sql_for_inline_foreign_key_references(\n-                    f, known_models, style)\n+                    model, f, known_models, style)\n                 if pending:\n                     pending_references.setdefault(f.rel.to, []).append(\n                         (model, f))\n@@ -116,15 +116,16 @@ def sql_create_model(self, model, style, known_models=set()):\n \n         return final_output, pending_references\n \n-    def sql_for_inline_foreign_key_references(self, field, known_models, style):\n+    def sql_for_inline_foreign_key_references(self, model, field, known_models, style):\n         \"\"\"\n         Return the SQL snippet defining the foreign key reference for a field.\n         \"\"\"\n         qn = self.connection.ops.quote_name\n-        if field.rel.to in known_models:\n+        rel_to = field.rel.to\n+        if rel_to in known_models or rel_to == model:\n             output = [style.SQL_KEYWORD('REFERENCES') + ' ' +\n-                style.SQL_TABLE(qn(field.rel.to._meta.db_table)) + ' (' +\n-                style.SQL_FIELD(qn(field.rel.to._meta.get_field(\n+                style.SQL_TABLE(qn(rel_to._meta.db_table)) + ' (' +\n+                style.SQL_FIELD(qn(rel_to._meta.get_field(\n                     field.rel.field_name).column)) + ')' +\n                 self.connection.ops.deferrable_sql()\n             ]"
        },
        {
            "sha": "eb31dc66d1c4332bc6ea12dca98cffd875733c53",
            "filename": "django/db/backends/mysql/creation.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/django%2Fdb%2Fbackends%2Fmysql%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/django%2Fdb%2Fbackends%2Fmysql%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fcreation.py?ref=f46d7314b50d71a75f51ebae9c5957cb96b11bd9",
            "patch": "@@ -38,7 +38,7 @@ def sql_table_creation_suffix(self):\n             suffix.append('COLLATE %s' % self.connection.settings_dict['TEST_COLLATION'])\n         return ' '.join(suffix)\n \n-    def sql_for_inline_foreign_key_references(self, field, known_models, style):\n+    def sql_for_inline_foreign_key_references(self, model, field, known_models, style):\n         \"All inline references are pending under MySQL\"\n         return [], True\n "
        },
        {
            "sha": "cfa72c99214aaf0497b951c5888cb8784e7b8e4f",
            "filename": "tests/regressiontests/introspection/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/tests%2Fregressiontests%2Fintrospection%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/tests%2Fregressiontests%2Fintrospection%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fintrospection%2Fmodels.py?ref=f46d7314b50d71a75f51ebae9c5957cb96b11bd9",
            "patch": "@@ -23,6 +23,7 @@ class Article(models.Model):\n     headline = models.CharField(max_length=100)\n     pub_date = models.DateField()\n     reporter = models.ForeignKey(Reporter)\n+    response_to = models.ForeignKey('self', null=True)\n \n     def __str__(self):\n         return self.headline"
        },
        {
            "sha": "0b4c49077d0877ac0eec8aa89683982d5b4f9019",
            "filename": "tests/regressiontests/introspection/tests.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f46d7314b50d71a75f51ebae9c5957cb96b11bd9/tests%2Fregressiontests%2Fintrospection%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fintrospection%2Ftests.py?ref=f46d7314b50d71a75f51ebae9c5957cb96b11bd9",
            "patch": "@@ -106,13 +106,17 @@ def test_get_relations(self):\n         # should test that the response is correct.\n         if relations:\n             # That's {field_index: (field_index_other_table, other_table)}\n-            self.assertEqual(relations, {3: (0, Reporter._meta.db_table)})\n+            self.assertEqual(relations, {3: (0, Reporter._meta.db_table),\n+                                         4: (0, Article._meta.db_table)})\n \n     @skipUnlessDBFeature('can_introspect_foreign_keys')\n     def test_get_key_columns(self):\n         cursor = connection.cursor()\n         key_columns = connection.introspection.get_key_columns(cursor, Article._meta.db_table)\n-        self.assertEqual(key_columns, [('reporter_id', Reporter._meta.db_table, 'id')])\n+        self.assertEqual(\n+            set(key_columns),\n+            set([('reporter_id', Reporter._meta.db_table, 'id'),\n+                 ('response_to_id', Article._meta.db_table, 'id')]))\n \n     def test_get_primary_key_column(self):\n         cursor = connection.cursor()"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 14,
        "deletions": 8
    }
}