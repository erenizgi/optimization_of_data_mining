{
    "author": "jezdez",
    "message": "Fixed #14301 -- Further refine changes made in r14216 to support non-ASCII characters in email addresses. Thanks, Claude Peroz and Andi Albrecht.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15006 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d4ef8414957e8e5db43d396eeb77bac4cf654bf8",
    "files": [
        {
            "sha": "3b2962f7d8a201bfee3bd8dd8f82c012c6b77a84",
            "filename": "django/core/mail/backends/smtp.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/d4ef8414957e8e5db43d396eeb77bac4cf654bf8/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "raw_url": "https://github.com/django/django/raw/d4ef8414957e8e5db43d396eeb77bac4cf654bf8/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmail%2Fbackends%2Fsmtp.py?ref=d4ef8414957e8e5db43d396eeb77bac4cf654bf8",
            "patch": "@@ -91,13 +91,19 @@ def send_messages(self, email_messages):\n             self._lock.release()\n         return num_sent\n \n+    def _sanitize(self, email):\n+        name, domain = email.split('@', 1)\n+        email = '@'.join([name, domain.encode('idna')])\n+        return email\n+\n     def _send(self, email_message):\n         \"\"\"A helper method that does the actual sending.\"\"\"\n         if not email_message.recipients():\n             return False\n+        from_email = self._sanitize(email_message.from_email)\n+        recipients = map(self._sanitize, email_message.recipients())\n         try:\n-            self.connection.sendmail(email_message.from_email,\n-                    email_message.recipients(),\n+            self.connection.sendmail(from_email, recipients,\n                     email_message.message().as_string())\n         except:\n             if not self.fail_silently:"
        },
        {
            "sha": "a6cd60e2ac1059fd6bc6bdd035c3f67f238624f4",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/d4ef8414957e8e5db43d396eeb77bac4cf654bf8/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d4ef8414957e8e5db43d396eeb77bac4cf654bf8/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=d4ef8414957e8e5db43d396eeb77bac4cf654bf8",
            "patch": "@@ -408,3 +408,25 @@ def test_idn_validation(self):\n         self.assertEqual(message.from_email, from_email)\n         self.assertEqual(message.to, [to_email])\n         self.assertTrue(message.message().as_string().startswith('Content-Type: text/plain; charset=\"utf-8\"\\nMIME-Version: 1.0\\nContent-Transfer-Encoding: quoted-printable\\nSubject: Subject\\nFrom: =?utf-8?b?ZnLDtm1Aw7bDpMO8LmNvbQ==?=\\nTo: =?utf-8?b?dMO2QMO2w6TDvC5jb20=?='))\n+\n+    def test_idn_smtp_send(self):\n+        import smtplib\n+        smtplib.SMTP = MockSMTP\n+        from_email = u'fröm@öäü.com'\n+        to_email = u'tö@öäü.com'\n+        connection = mail.get_connection('django.core.mail.backends.smtp.EmailBackend')\n+        self.assertTrue(send_mail('Subject', 'Content', from_email, [to_email], connection=connection))\n+\n+class MockSMTP(object):\n+    def __init__(self, host='', port=0, local_hostname=None,\n+                 timeout=1):\n+        pass\n+\n+    def sendmail(self, from_addr, to_addrs, msg, mail_options=[],\n+                 rcpt_options=[]):\n+        for addr in to_addrs:\n+            str(addr.split('@', 1)[-1])\n+        return {}\n+\n+    def quit(self):\n+        return 0"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 30,
        "deletions": 2
    }
}