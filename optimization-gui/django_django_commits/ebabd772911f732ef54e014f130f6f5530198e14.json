{
    "author": "aaugustin",
    "message": "Ensured a connection is established when checking the database version.\n\nFixed a test broken by 21765c0a. Refs #18135.",
    "sha": "ebabd772911f732ef54e014f130f6f5530198e14",
    "files": [
        {
            "sha": "2a7a206c3b8e00b5a28e14a3d2284e6c915ce604",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=ebabd772911f732ef54e014f130f6f5530198e14",
            "patch": "@@ -352,6 +352,18 @@ def cursor(self):\n     def make_debug_cursor(self, cursor):\n         return util.CursorDebugWrapper(cursor, self)\n \n+    @contextmanager\n+    def temporary_connection(self):\n+        # Ensure a connection is established, and avoid leaving a dangling\n+        # connection, for operations outside of the request-response cycle.\n+        must_close = self.connection is None\n+        cursor = self.cursor()\n+        try:\n+            yield\n+        finally:\n+            cursor.close()\n+            if must_close:\n+                self.close()\n \n class BaseDatabaseFeatures(object):\n     allows_group_by_pk = False"
        },
        {
            "sha": "fc2ff3158131c96de1c09c2ffd96095066295ceb",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=ebabd772911f732ef54e014f130f6f5530198e14",
            "patch": "@@ -453,7 +453,8 @@ def _rollback(self):\n \n     @cached_property\n     def mysql_version(self):\n-        server_info = self.connection.get_server_info()\n+        with self.temporary_connection():\n+            server_info = self.connection.get_server_info()\n         match = server_version_re.match(server_info)\n         if not match:\n             raise Exception('Unable to determine MySQL version from version string %r' % server_info)"
        },
        {
            "sha": "a9ae02514670631bc6615bc4c2058ef610db7789",
            "filename": "django/db/backends/oracle/base.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Foracle%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fbase.py?ref=ebabd772911f732ef54e014f130f6f5530198e14",
            "patch": "@@ -623,8 +623,10 @@ def _commit(self):\n \n     @cached_property\n     def oracle_version(self):\n+        with self.temporary_connection():\n+            version = self.connection.version\n         try:\n-            return int(self.connection.version.split('.')[0])\n+            return int(version.split('.')[0])\n         except ValueError:\n             return None\n "
        },
        {
            "sha": "85a0991402c49a9d909b6a5f4690e7cfc14cee45",
            "filename": "django/db/backends/postgresql_psycopg2/base.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Fbase.py?ref=ebabd772911f732ef54e014f130f6f5530198e14",
            "patch": "@@ -152,7 +152,8 @@ def close(self):\n \n     @cached_property\n     def pg_version(self):\n-        return get_version(self.connection)\n+        with self.temporary_connection():\n+            return get_version(self.connection)\n \n     def get_connection_params(self):\n         settings_dict = self.settings_dict"
        },
        {
            "sha": "56535e08650255e7f6b963d7fb45de38aeb8c11a",
            "filename": "django/db/backends/postgresql_psycopg2/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/ebabd772911f732ef54e014f130f6f5530198e14/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fpostgresql_psycopg2%2Foperations.py?ref=ebabd772911f732ef54e014f130f6f5530198e14",
            "patch": "@@ -195,8 +195,7 @@ def check_aggregate_support(self, aggregate):\n         NotImplementedError if this is the database in use.\n         \"\"\"\n         if aggregate.sql_function in ('STDDEV_POP', 'VAR_POP'):\n-            pg_version = self.connection.pg_version\n-            if pg_version >= 80200 and pg_version <= 80204:\n+            if 80200 <= self.connection.pg_version <= 80204:\n                 raise NotImplementedError('PostgreSQL 8.2 to 8.2.4 is known to have a faulty implementation of %s. Please upgrade your version of PostgreSQL.' % aggregate.sql_function)\n \n     def max_name_length(self):"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 20,
        "deletions": 5
    }
}