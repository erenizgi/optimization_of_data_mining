{
    "author": "freakboy3742",
    "message": "Fixed #16185, #15675 -- Added the ability for test runners to define custom options, and to specify a custom test runner at the command line. Thanks to Dmitry Jemerov and Mikołaj Siedlarek for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16352 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "046ffa483ed63faae7b31e7e2cf618f88a3312ba",
    "files": [
        {
            "sha": "1a79d26297ee9de55030a454b64e274975455aa5",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/046ffa483ed63faae7b31e7e2cf618f88a3312ba/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/046ffa483ed63faae7b31e7e2cf618f88a3312ba/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=046ffa483ed63faae7b31e7e2cf618f88a3312ba",
            "patch": "@@ -252,6 +252,7 @@ answer newbie questions, and generally made Django that much better:\n     james_027@yahoo.com\n     jcrasta@gmail.com\n     jdetaeye\n+    Dmitry Jemerov <intelliyole@gmail.com>\n     jhenry <jhenry@theonion.com>\n     john@calixto.net\n     Zak Johnson <zakj@nox.cx>\n@@ -338,6 +339,7 @@ answer newbie questions, and generally made Django that much better:\n     mark@junklight.com\n     Orestis Markou <orestis@orestis.gr>\n     Takashi Matsuo <matsuo.takashi@gmail.com>\n+    Zlatko Mašek <zlatko.masek@gmail.com>\n     Yasushi Masuda <whosaysni@gmail.com>\n     mattycakes@gmail.com\n     Glenn Maynard <glenn@zewt.org>\n@@ -369,6 +371,7 @@ answer newbie questions, and generally made Django that much better:\n     Gopal Narayanan <gopastro@gmail.com>\n     Fraser Nevett <mail@nevett.org>\n     Sam Newman <http://www.magpiebrain.com/>\n+    Ryan Niemeyer <https://profiles.google.com/ryan.niemeyer/about>\n     Filip Noetzel <http://filip.noetzel.co.uk/>\n     Afonso Fernández Nogueira <fonzzo.django@gmail.com>\n     Neal Norwitz <nnorwitz@google.com>\n@@ -443,6 +446,7 @@ answer newbie questions, and generally made Django that much better:\n     Pete Shinners <pete@shinners.org>\n     Leo Shklovskii\n     jason.sidabras@gmail.com\n+    Mikołaj Siedlarek <mikolaj.siedlarek@gmail.com>\n     Brenton Simpson <http://theillustratedlife.com>\n     Jozko Skrablin <jozko.skrablin@gmail.com>\n     Ben Slavin <benjamin.slavin@gmail.com>\n@@ -533,8 +537,6 @@ answer newbie questions, and generally made Django that much better:\n     Gasper Zejn <zejn@kiberpipa.org>\n     Jarek Zgoda <jarek.zgoda@gmail.com>\n     Cheng Zhang\n-    Zlatko Mašek <zlatko.masek@gmail.com>\n-    Ryan Niemeyer <https://profiles.google.com/ryan.niemeyer/about>\n \n A big THANK YOU goes to:\n "
        },
        {
            "sha": "1b3f2beadae4bcd285c3f1fbb0a75d389b2d4784",
            "filename": "django/core/management/commands/test.py",
            "status": "modified",
            "additions": 34,
            "deletions": 7,
            "changes": 41,
            "blob_url": "https://github.com/django/django/blob/046ffa483ed63faae7b31e7e2cf618f88a3312ba/django%2Fcore%2Fmanagement%2Fcommands%2Ftest.py",
            "raw_url": "https://github.com/django/django/raw/046ffa483ed63faae7b31e7e2cf618f88a3312ba/django%2Fcore%2Fmanagement%2Fcommands%2Ftest.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Ftest.py?ref=046ffa483ed63faae7b31e7e2cf618f88a3312ba",
            "patch": "@@ -1,29 +1,56 @@\n+from django.conf import settings\n from django.core.management.base import BaseCommand\n-from optparse import make_option\n+from optparse import make_option, OptionParser\n import sys\n+from django.test.utils import get_runner\n \n class Command(BaseCommand):\n     option_list = BaseCommand.option_list + (\n         make_option('--noinput', action='store_false', dest='interactive', default=True,\n             help='Tells Django to NOT prompt the user for input of any kind.'),\n         make_option('--failfast', action='store_true', dest='failfast', default=False,\n-            help='Tells Django to stop running the test suite after first failed test.')\n+            help='Tells Django to stop running the test suite after first failed test.'),\n+        make_option('--testrunner', action='store', dest='testrunner',\n+            help='Tells Django to use specified test runner class instead of the one '+\n+                 'specified by the TEST_RUNNER setting.')\n     )\n     help = 'Runs the test suite for the specified applications, or the entire site if no apps are specified.'\n     args = '[appname ...]'\n \n     requires_model_validation = False\n \n+    def run_from_argv(self, argv):\n+        \"\"\"\n+        Pre-parse the command line to extract the value of the --testrunner\n+        option. This allows a test runner to define additional command line\n+        arguments.\n+        \"\"\"\n+        self.test_runner = None\n+        option = '--testrunner='\n+        for arg in argv[2:]:\n+            if arg.startswith(option):\n+                self.test_runner = arg[len(option):]\n+                break\n+        super(Command, self).run_from_argv(argv)\n+\n+    def create_parser(self, prog_name, subcommand):\n+        test_runner_class = get_runner(settings, self.test_runner)\n+        options = self.option_list + getattr(test_runner_class, 'option_list', ())\n+        return OptionParser(prog=prog_name,\n+                            usage=self.usage(subcommand),\n+                            version=self.get_version(),\n+                            option_list=options)\n+\n     def handle(self, *test_labels, **options):\n         from django.conf import settings\n         from django.test.utils import get_runner\n \n-        verbosity = int(options.get('verbosity', 1))\n-        interactive = options.get('interactive', True)\n-        failfast = options.get('failfast', False)\n-        TestRunner = get_runner(settings)\n+        TestRunner = get_runner(settings, options.get('testrunner'))\n+        options['verbosity'] = int(options.get('verbosity', 1))\n+        options.setdefault('interactive', True)\n+        options.setdefault('failfast', False)\n \n-        test_runner = TestRunner(verbosity=verbosity, interactive=interactive, failfast=failfast)\n+        test_runner = TestRunner(**options)\n         failures = test_runner.run_tests(test_labels)\n \n         if failures:"
        },
        {
            "sha": "b9f4743a34fcc83905f75d995f1754bf1efeea0c",
            "filename": "django/test/utils.py",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/046ffa483ed63faae7b31e7e2cf618f88a3312ba/django%2Ftest%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/046ffa483ed63faae7b31e7e2cf618f88a3312ba/django%2Ftest%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Futils.py?ref=046ffa483ed63faae7b31e7e2cf618f88a3312ba",
            "patch": "@@ -118,8 +118,11 @@ def restore_warnings_state(state):\n     warnings.filters = state[:]\n \n \n-def get_runner(settings):\n-    test_path = settings.TEST_RUNNER.split('.')\n+def get_runner(settings, test_runner_class=None):\n+    if not test_runner_class:\n+        test_runner_class = settings.TEST_RUNNER\n+\n+    test_path = test_runner_class.split('.')\n     # Allow for Python 2.5 relative paths\n     if len(test_path) > 1:\n         test_module_name = '.'.join(test_path[:-1])"
        },
        {
            "sha": "46b73076139681d13233f10cfc14119cd25233d5",
            "filename": "docs/ref/django-admin.txt",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/046ffa483ed63faae7b31e7e2cf618f88a3312ba/docs%2Fref%2Fdjango-admin.txt",
            "raw_url": "https://github.com/django/django/raw/046ffa483ed63faae7b31e7e2cf618f88a3312ba/docs%2Fref%2Fdjango-admin.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fdjango-admin.txt?ref=046ffa483ed63faae7b31e7e2cf618f88a3312ba",
            "patch": "@@ -964,6 +964,13 @@ information.\n Use the :djadminopt:`--failfast` option to stop running tests and report the failure\n immediately after a test fails.\n \n+.. versionadded:: 1.4\n+.. django-admin-option:: --testrunner\n+\n+The :djandminopt:`--testrunner` option can be used to control the test runner\n+class that is used to execute tests. If this value is provided, it overrides\n+the value provided by the :setting:`TEST_RUNNER` setting.\n+\n testserver <fixture fixture ...>\n --------------------------------\n "
        },
        {
            "sha": "6595c5195734bc8a47dccaf5d5a8981a1f1b0e4b",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/046ffa483ed63faae7b31e7e2cf618f88a3312ba/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/046ffa483ed63faae7b31e7e2cf618f88a3312ba/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=046ffa483ed63faae7b31e7e2cf618f88a3312ba",
            "patch": "@@ -1744,6 +1744,29 @@ set up, execute and tear down the test suite.\n     write your own test runner, ensure accept and handle the ``**kwargs``\n     parameter.\n \n+    .. versionadded:: 1.4\n+\n+    Your test runner may also define additional command-line options.\n+    If you add an ``option_list`` attribute to a subclassed test runner,\n+    those options will be added to the list of command-line options that\n+    the :djadmin:`test` command can use.\n+\n+\n+Attributes\n+~~~~~~~~~~\n+\n+\n+.. attribute:: DjangoTestSuiteRunner.option_list\n+\n+    .. versionadded:: 1.4\n+\n+    This is the tuple of ``optparse`` options which will be fed into the\n+    management command's ``OptionParser`` for parsing arguments. See the\n+    documentation for Python's ``optparse`` module for more details.\n+\n+Methods\n+~~~~~~~\n+\n .. method:: DjangoTestSuiteRunner.run_tests(test_labels, extra_tests=None, **kwargs)\n \n     Run the test suite."
        },
        {
            "sha": "4261e44d7f4e1f7c7e3c2b95f6428874160af5f0",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/django/django/blob/046ffa483ed63faae7b31e7e2cf618f88a3312ba/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/046ffa483ed63faae7b31e7e2cf618f88a3312ba/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=046ffa483ed63faae7b31e7e2cf618f88a3312ba",
            "patch": "@@ -2,12 +2,15 @@\n Tests for django test runner\n \"\"\"\n import StringIO\n+from optparse import make_option\n import warnings\n \n from django.core.exceptions import ImproperlyConfigured\n+from django.core.management import call_command\n from django.test import simple\n from django.test.utils import get_warnings_state, restore_warnings_state\n from django.utils import unittest\n+from regressiontests.admin_scripts.tests import AdminScriptTestCase\n \n \n class DjangoTestRunnerTests(unittest.TestCase):\n@@ -128,3 +131,75 @@ def test_circular_dependencies(self):\n \n         self.assertRaises(ImproperlyConfigured, simple.dependency_ordered, raw, dependencies=dependencies)\n \n+\n+class MockTestRunner(object):\n+    invoked = False\n+\n+    def __init__(self, *args, **kwargs):\n+        pass\n+\n+    def run_tests(self, test_labels, extra_tests=None, **kwargs):\n+        MockTestRunner.invoked = True\n+\n+\n+class ManageCommandTests(unittest.TestCase):\n+\n+    def test_custom_test_runner(self):\n+        call_command('test', 'sites',\n+                     testrunner='regressiontests.test_runner.tests.MockTestRunner')\n+        self.assertTrue(MockTestRunner.invoked,\n+                        \"The custom test runner has not been invoked\")\n+\n+\n+class CustomOptionsTestRunner(simple.DjangoTestSuiteRunner):\n+    option_list = (\n+        make_option('--option_a','-a', action='store', dest='option_a', default='1'),\n+        make_option('--option_b','-b', action='store', dest='option_b', default='2'),\n+        make_option('--option_c','-c', action='store', dest='option_c', default='3'),\n+    )\n+\n+    def __init__(self, verbosity=1, interactive=True, failfast=True, option_a=None, option_b=None, option_c=None, **kwargs):\n+        super(CustomOptionsTestRunner, self).__init__(verbosity=verbosity, interactive=interactive,\n+                                                      failfast=failfast)\n+        self.option_a = option_a\n+        self.option_b = option_b\n+        self.option_c = option_c\n+\n+    def run_tests(self, test_labels, extra_tests=None, **kwargs):\n+        print \"%s:%s:%s\" % (self.option_a, self.option_b, self.option_c)\n+\n+\n+class CustomTestRunnerOptionsTests(AdminScriptTestCase):\n+\n+    def setUp(self):\n+        settings = {\n+            'TEST_RUNNER': '\\'regressiontests.test_runner.tests.CustomOptionsTestRunner\\'',\n+        }\n+        self.write_settings('settings.py', sdict=settings)\n+\n+    def tearDown(self):\n+        self.remove_settings('settings.py')\n+\n+    def test_default_options(self):\n+        args = ['test', '--settings=settings']\n+        out, err = self.run_django_admin(args)\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, '1:2:3')\n+\n+    def test_default_and_given_options(self):\n+        args = ['test', '--settings=settings', '--option_b=foo']\n+        out, err = self.run_django_admin(args)\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, '1:foo:3')\n+\n+    def test_option_name_and_value_separated(self):\n+        args = ['test', '--settings=settings', '--option_b', 'foo']\n+        out, err = self.run_django_admin(args)\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, '1:foo:3')\n+\n+    def test_all_options_given(self):\n+        args = ['test', '--settings=settings', '--option_a=bar', '--option_b=foo', '--option_c=31337']\n+        out, err = self.run_django_admin(args)\n+        self.assertNoOutput(err)\n+        self.assertOutput(out, 'bar:foo:31337')"
        }
    ],
    "stats": {
        "total": 159,
        "additions": 148,
        "deletions": 11
    }
}