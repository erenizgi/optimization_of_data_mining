{
    "author": "malcolmt",
    "message": "Allow \"pk\" as a field alias in QuerySet.only() calls.\n\nThanks to GDorn for the patch. Fixed #15494.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16668 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "7182cd2284a15cd5094ab6567ae14c6ad3cd901a",
    "files": [
        {
            "sha": "b55de3d7665369503312b97a6055585304406917",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/7182cd2284a15cd5094ab6567ae14c6ad3cd901a/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/7182cd2284a15cd5094ab6567ae14c6ad3cd901a/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=7182cd2284a15cd5094ab6567ae14c6ad3cd901a",
            "patch": "@@ -1791,13 +1791,18 @@ def add_immediate_loading(self, field_names):\n         existing immediate values, but respects existing deferrals.)\n         \"\"\"\n         existing, defer = self.deferred_loading\n+        field_names = set(field_names)\n+        if 'pk' in field_names:\n+            field_names.remove('pk')\n+            field_names.add(self.model._meta.pk.name)\n+\n         if defer:\n             # Remove any existing deferred names from the current set before\n             # setting the new names.\n-            self.deferred_loading = set(field_names).difference(existing), False\n+            self.deferred_loading = field_names.difference(existing), False\n         else:\n             # Replace any existing \"immediate load\" field names.\n-            self.deferred_loading = set(field_names), False\n+            self.deferred_loading = field_names, False\n \n     def get_loaded_field_names(self):\n         \"\"\""
        },
        {
            "sha": "ccf19fd5ae7e51975b9d6962e6fa111b12ebb21a",
            "filename": "tests/modeltests/defer/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/7182cd2284a15cd5094ab6567ae14c6ad3cd901a/tests%2Fmodeltests%2Fdefer%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/7182cd2284a15cd5094ab6567ae14c6ad3cd901a/tests%2Fmodeltests%2Fdefer%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fdefer%2Ftests.py?ref=7182cd2284a15cd5094ab6567ae14c6ad3cd901a",
            "patch": "@@ -28,11 +28,18 @@ def test_defer(self):\n         self.assert_delayed(qs.only(\"name\")[0], 2)\n         self.assert_delayed(qs.defer(\"related__first\")[0], 0)\n \n+        # Using 'pk' with only() should result in 3 deferred fields, namely all\n+        # of them except the model's primary key see #15494\n+        self.assert_delayed(qs.only(\"pk\")[0], 3)\n+\n         obj = qs.select_related().only(\"related__first\")[0]\n         self.assert_delayed(obj, 2)\n \n         self.assertEqual(obj.related_id, s1.pk)\n \n+        # You can use 'pk' with reverse foreign key lookups.\n+        self.assert_delayed(s1.primary_set.all().only('pk')[0], 3)\n+\n         self.assert_delayed(qs.defer(\"name\").extra(select={\"a\": 1})[0], 1)\n         self.assert_delayed(qs.extra(select={\"a\": 1}).defer(\"name\")[0], 1)\n         self.assert_delayed(qs.defer(\"name\").defer(\"value\")[0], 2)\n@@ -135,3 +142,4 @@ def test_defer(self):\n         self.assertEqual(obj.other, \"bar\")\n         obj.name = \"bb\"\n         obj.save()\n+"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 15,
        "deletions": 2
    }
}