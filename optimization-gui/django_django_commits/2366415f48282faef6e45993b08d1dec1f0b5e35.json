{
    "author": "spookylukey",
    "message": "Fixed #15368 - test failures due to regression with RequestContext\n\nThanks to cyberdelia for the reports on this.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15660 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "2366415f48282faef6e45993b08d1dec1f0b5e35",
    "files": [
        {
            "sha": "1c8b7dacd909bad270cc834efcf715740bbd150a",
            "filename": "django/template/context.py",
            "status": "modified",
            "additions": 9,
            "deletions": 15,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/2366415f48282faef6e45993b08d1dec1f0b5e35/django%2Ftemplate%2Fcontext.py",
            "raw_url": "https://github.com/django/django/raw/2366415f48282faef6e45993b08d1dec1f0b5e35/django%2Ftemplate%2Fcontext.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fcontext.py?ref=2366415f48282faef6e45993b08d1dec1f0b5e35",
            "patch": "@@ -14,14 +14,21 @@ class ContextPopException(Exception):\n     \"pop() has been called more times than push()\"\n     pass\n \n+class EmptyClass(object):\n+    # No-op class which takes no args to its __init__ method, to help implement\n+    # __copy__\n+    pass\n+\n class BaseContext(object):\n     def __init__(self, dict_=None):\n         dict_ = dict_ or {}\n         self.dicts = [dict_]\n \n     def __copy__(self):\n-        duplicate = self._new()\n-        duplicate.dicts = [dict_ for dict_ in self.dicts]\n+        duplicate = EmptyClass()\n+        duplicate.__class__ = self.__class__\n+        duplicate.__dict__ = self.__dict__.copy()\n+        duplicate.dicts = duplicate.dicts[:]\n         return duplicate\n \n     def __repr__(self):\n@@ -31,9 +38,6 @@ def __iter__(self):\n         for d in reversed(self.dicts):\n             yield d\n \n-    def _new(self):\n-        return self.__class__()\n-\n     def push(self):\n         d = {}\n         self.dicts.append(d)\n@@ -88,11 +92,6 @@ def __copy__(self):\n         duplicate.render_context = copy(self.render_context)\n         return duplicate\n \n-    def _new(self):\n-        return self.__class__(autoescape=self.autoescape,\n-                              current_app=self.current_app,\n-                              use_l10n=self.use_l10n)\n-\n     def update(self, other_dict):\n         \"Pushes other_dict to the stack of dictionaries in the Context\"\n         if not hasattr(other_dict, '__getitem__'):\n@@ -168,8 +167,3 @@ def __init__(self, request, dict=None, processors=None, current_app=None, use_l1\n             processors = tuple(processors)\n         for processor in get_standard_processors() + processors:\n             self.update(processor(request))\n-\n-    def _new(self):\n-        return self.__class__(request=HttpRequest(),\n-                              current_app=self.current_app,\n-                              use_l10n=self.use_l10n)"
        },
        {
            "sha": "4fbcc0dc151c738dad05d3446acfb3acd0965fa4",
            "filename": "tests/regressiontests/test_client_regress/models.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Fmodels.py?ref=2366415f48282faef6e45993b08d1dec1f0b5e35",
            "patch": "@@ -9,6 +9,7 @@\n from django.core.urlresolvers import reverse\n from django.template import (TemplateDoesNotExist, TemplateSyntaxError,\n     Context, Template, loader)\n+import django.template.context\n from django.test import Client, TestCase\n from django.test.client import encode_file\n from django.test.utils import ContextList\n@@ -648,6 +649,17 @@ def test_inherited_context(self):\n         except KeyError, e:\n             self.assertEquals(e.args[0], 'does-not-exist')\n \n+    def test_15368(self):\n+        # Need to insert a context processor that assumes certain things about\n+        # the request instance. This triggers a bug caused by some ways of\n+        # copying RequestContext.\n+        try:\n+            django.template.context._standard_context_processors = (lambda request: {'path': request.special_path},)\n+            response = self.client.get(\"/test_client_regress/request_context_view/\")\n+            self.assertContains(response, 'Path: /test_client_regress/request_context_view/')\n+        finally:\n+            django.template.context._standard_context_processors = None\n+\n \n class SessionTests(TestCase):\n     fixtures = ['testdata.json']"
        },
        {
            "sha": "37a2425c098aeb7f96f6ec8321defc6f0a8bfed9",
            "filename": "tests/regressiontests/test_client_regress/templates/request_context.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Ftemplates%2Frequest_context.html",
            "raw_url": "https://github.com/django/django/raw/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Ftemplates%2Frequest_context.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Ftemplates%2Frequest_context.html?ref=2366415f48282faef6e45993b08d1dec1f0b5e35",
            "patch": "@@ -0,0 +1 @@\n+Path: {{ path }}"
        },
        {
            "sha": "162befe73e4e4e1329aa3cae0a201d0d07d326ac",
            "filename": "tests/regressiontests/test_client_regress/urls.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Furls.py?ref=2366415f48282faef6e45993b08d1dec1f0b5e35",
            "patch": "@@ -27,4 +27,5 @@\n     (r'^check_headers/$', views.check_headers),\n     (r'^check_headers_redirect/$', redirect_to, {'url': '/test_client_regress/check_headers/'}),\n     (r'^raw_post_data/$', views.raw_post_data),\n+    (r'^request_context_view/$', views.request_context_view),\n )"
        },
        {
            "sha": "c40f34fe563a797d6d3a7c364eeb614697b044db",
            "filename": "tests/regressiontests/test_client_regress/views.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/2366415f48282faef6e45993b08d1dec1f0b5e35/tests%2Fregressiontests%2Ftest_client_regress%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_client_regress%2Fviews.py?ref=2366415f48282faef6e45993b08d1dec1f0b5e35",
            "patch": "@@ -7,6 +7,7 @@\n from django.utils.encoding import smart_str\n from django.core.serializers.json import DjangoJSONEncoder\n from django.test.client import CONTENT_TYPE_RE\n+from django.template import RequestContext\n \n def no_template_view(request):\n     \"A simple view that expects a GET request, and returns a rendered template\"\n@@ -94,3 +95,8 @@ def check_headers(request):\n def raw_post_data(request):\n     \"A view that is requested with GET and accesses request.raw_post_data. Refs #14753.\"\n     return HttpResponse(request.raw_post_data)\n+\n+def request_context_view(request):\n+    # Special attribute that won't be present on a plain HttpRequest\n+    request.special_path = request.path\n+    return render_to_response('request_context.html', context_instance=RequestContext(request, {}))"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 29,
        "deletions": 15
    }
}