{
    "author": "SmileyChris",
    "message": "Ensure render_to_string leaves the context instance stack in the state it was originally passed in.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15591 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1073a83f2ceb330c80da275c0709786a7a84c513",
    "files": [
        {
            "sha": "e58dc3231d26d6b53017ed231bf24f9a0f1c524b",
            "filename": "django/template/loader.py",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/1073a83f2ceb330c80da275c0709786a7a84c513/django%2Ftemplate%2Floader.py",
            "raw_url": "https://github.com/django/django/raw/1073a83f2ceb330c80da275c0709786a7a84c513/django%2Ftemplate%2Floader.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Floader.py?ref=1073a83f2ceb330c80da275c0709786a7a84c513",
            "patch": "@@ -179,11 +179,15 @@ def render_to_string(template_name, dictionary=None, context_instance=None):\n         t = select_template(template_name)\n     else:\n         t = get_template(template_name)\n-    if context_instance:\n-        context_instance.update(dictionary)\n-    else:\n-        context_instance = Context(dictionary)\n-    return t.render(context_instance)\n+    if not context_instance:\n+        return t.render(Context(dictionary))\n+    # Add the dictionary to the context stack, ensuring it gets removed again\n+    # to keep the context_instance in the same state it started in.\n+    context_instance.update(dictionary)\n+    try:\n+        return t.render(context_instance)\n+    finally:\n+        context_instance.pop()\n \n def select_template(template_name_list):\n     \"Given a list of template names, returns the first that can be loaded.\""
        },
        {
            "sha": "6c740339446d3120b18f2290d74eac0e626c92b2",
            "filename": "tests/regressiontests/templates/loaders.py",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/1073a83f2ceb330c80da275c0709786a7a84c513/tests%2Fregressiontests%2Ftemplates%2Floaders.py",
            "raw_url": "https://github.com/django/django/raw/1073a83f2ceb330c80da275c0709786a7a84c513/tests%2Fregressiontests%2Ftemplates%2Floaders.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Floaders.py?ref=1073a83f2ceb330c80da275c0709786a7a84c513",
            "patch": "@@ -148,5 +148,30 @@ def test_templatedir_caching(self):\n         # The two templates should not have the same content\n         self.assertNotEqual(t1.render(Context({})), t2.render(Context({})))\n \n+class RenderToStringTest(unittest.TestCase):\n+\n+    def setUp(self):\n+        self._old_TEMPLATE_DIRS = settings.TEMPLATE_DIRS\n+        settings.TEMPLATE_DIRS = (\n+            os.path.join(os.path.dirname(__file__), 'templates'),\n+        )\n+\n+    def tearDown(self):\n+        settings.TEMPLATE_DIRS = self._old_TEMPLATE_DIRS\n+\n+    def test_basic(self):\n+        self.assertEqual(loader.render_to_string('test_context.html'), 'obj:')\n+\n+    def test_basic_context(self):\n+        self.assertEqual(loader.render_to_string('test_context.html',\n+                                                 {'obj': 'test'}), 'obj:test')\n+\n+    def test_existing_context_kept_clean(self):\n+        context = Context({'obj': 'before'})\n+        output = loader.render_to_string('test_context.html', {'obj': 'after'},\n+                                         context_instance=context)\n+        self.assertEqual(output, 'obj:after')\n+        self.assertEqual(context['obj'], 'before')\n+\n if __name__ == \"__main__\":\n     unittest.main()"
        },
        {
            "sha": "a100f03de6506f4844ccecee2731ad41e0a61407",
            "filename": "tests/regressiontests/templates/templates/test_context.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/1073a83f2ceb330c80da275c0709786a7a84c513/tests%2Fregressiontests%2Ftemplates%2Ftemplates%2Ftest_context.html",
            "raw_url": "https://github.com/django/django/raw/1073a83f2ceb330c80da275c0709786a7a84c513/tests%2Fregressiontests%2Ftemplates%2Ftemplates%2Ftest_context.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplates%2Ftest_context.html?ref=1073a83f2ceb330c80da275c0709786a7a84c513",
            "patch": "@@ -0,0 +1 @@\n+obj:{{ obj }}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 35,
        "deletions": 5
    }
}