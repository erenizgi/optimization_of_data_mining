{
    "author": "ptone",
    "message": "Merge pull request #832 from chrismedrela/ticket19890\n\nFixed #19890 -- ifchanged templatetag rendered its content twice",
    "sha": "e369dc28075b4331c125494fe7bd73855d73a0ce",
    "files": [
        {
            "sha": "dbb5b5a0cb47d7f90a74f105dae108f4b8a3ef2e",
            "filename": "django/template/defaulttags.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/e369dc28075b4331c125494fe7bd73855d73a0ce/django%2Ftemplate%2Fdefaulttags.py",
            "raw_url": "https://github.com/django/django/raw/e369dc28075b4331c125494fe7bd73855d73a0ce/django%2Ftemplate%2Fdefaulttags.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fdefaulttags.py?ref=e369dc28075b4331c125494fe7bd73855d73a0ce",
            "patch": "@@ -223,20 +223,21 @@ def render(self, context):\n         if self not in state_frame:\n             state_frame[self] = None\n \n+        nodelist_true_output = None\n         try:\n             if self._varlist:\n                 # Consider multiple parameters.  This automatically behaves\n                 # like an OR evaluation of the multiple variables.\n                 compare_to = [var.resolve(context, True) for var in self._varlist]\n             else:\n                 # The \"{% ifchanged %}\" syntax (without any variables) compares the rendered output.\n-                compare_to = self.nodelist_true.render(context)\n+                compare_to = nodelist_true_output = self.nodelist_true.render(context)\n         except VariableDoesNotExist:\n             compare_to = None\n \n         if compare_to != state_frame[self]:\n             state_frame[self] = compare_to\n-            return self.nodelist_true.render(context)\n+            return nodelist_true_output or self.nodelist_true.render(context)  # render true block if not already rendered\n         elif self.nodelist_false:\n             return self.nodelist_false.render(context)\n         return ''"
        },
        {
            "sha": "e1e448acbacd4838f7f3ed37829490ff25686573",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/e369dc28075b4331c125494fe7bd73855d73a0ce/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/e369dc28075b4331c125494fe7bd73855d73a0ce/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=e369dc28075b4331c125494fe7bd73855d73a0ce",
            "patch": "@@ -441,6 +441,18 @@ def gen():\n         output1 = template.render(Context({'foo': range(3), 'get_value': lambda: next(gen1)}))\n         self.assertEqual(output1, '[0,1,2,3]', 'Expected [0,1,2,3] in first template, got {0}'.format(output1))\n \n+    def test_ifchanged_render_once(self):\n+        \"\"\" Test for ticket #19890. The content of ifchanged template tag was\n+        rendered twice.\"\"\"\n+\n+        template = Template('{% ifchanged %}{{ gen.next }}{% endifchanged %}')\n+        def gen():\n+            for i in xrange(1,10):\n+                yield 'iteration no %d' % i\n+\n+        output = template.render(Context({'gen': gen()}))\n+        self.assertEqual(output, 'iteration no 1')\n+\n     def test_templates(self):\n         template_tests = self.get_template_tests()\n         filter_tests = filters.get_filter_tests()"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 15,
        "deletions": 2
    }
}