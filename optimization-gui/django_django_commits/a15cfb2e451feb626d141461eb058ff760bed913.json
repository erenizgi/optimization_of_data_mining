{
    "author": "aaugustin",
    "message": "Simplified timezones tests with settings_changed.\n\nAll relevant state is now properly reset whenever TIME_ZONE or USE_TZ\nare changed in tests.",
    "sha": "a15cfb2e451feb626d141461eb058ff760bed913",
    "files": [
        {
            "sha": "81808dfa3c0f7e0df48a568cfef05217000ddabe",
            "filename": "django/test/signals.py",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/a15cfb2e451feb626d141461eb058ff760bed913/django%2Ftest%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/a15cfb2e451feb626d141461eb058ff760bed913/django%2Ftest%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsignals.py?ref=a15cfb2e451feb626d141461eb058ff760bed913",
            "patch": "@@ -1,27 +1,47 @@\n+import os\n+import time\n+\n from django.conf import settings\n from django.db import connections\n from django.dispatch import receiver, Signal\n from django.template import context\n+from django.utils import timezone\n \n template_rendered = Signal(providing_args=[\"template\", \"context\"])\n \n setting_changed = Signal(providing_args=[\"setting\", \"value\"])\n \n+\n @receiver(setting_changed)\n def update_connections_time_zone(**kwargs):\n+    if kwargs['setting'] == 'TIME_ZONE':\n+        # Reset process time zone\n+        if hasattr(time, 'tzset'):\n+            if kwargs['value']:\n+                os.environ['TZ'] = kwargs['value']\n+            else:\n+                os.environ.pop('TZ', None)\n+            time.tzset()\n+\n+        # Reset local time zone cache\n+        timezone._localtime = None\n+\n+    # Reset the database connections' time zone\n     if kwargs['setting'] == 'USE_TZ' and settings.TIME_ZONE != 'UTC':\n         USE_TZ, TIME_ZONE = kwargs['value'], settings.TIME_ZONE\n     elif kwargs['setting'] == 'TIME_ZONE' and not settings.USE_TZ:\n         USE_TZ, TIME_ZONE = settings.USE_TZ, kwargs['value']\n-    else:   # no need to change the database connnections' time zones\n+    else:\n+        # no need to change the database connnections' time zones\n         return\n-\n     tz = 'UTC' if USE_TZ else TIME_ZONE\n     for conn in connections.all():\n+        conn.settings_dict['TIME_ZONE'] = tz\n         tz_sql = conn.ops.set_time_zone_sql()\n         if tz_sql:\n             conn.cursor().execute(tz_sql, [tz])\n \n+\n @receiver(setting_changed)\n def clear_context_processors_cache(**kwargs):\n     if kwargs['setting'] == 'TEMPLATE_CONTEXT_PROCESSORS':"
        },
        {
            "sha": "d9d96360237e53141cd11d1271cee29b6140650f",
            "filename": "django/utils/timezone.py",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/a15cfb2e451feb626d141461eb058ff760bed913/django%2Futils%2Ftimezone.py",
            "raw_url": "https://github.com/django/django/raw/a15cfb2e451feb626d141461eb058ff760bed913/django%2Futils%2Ftimezone.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Ftimezone.py?ref=a15cfb2e451feb626d141461eb058ff760bed913",
            "patch": "@@ -95,7 +95,6 @@ def _isdst(self, dt):\n \n # In order to avoid accessing the settings at compile time,\n # wrap the expression in a function and cache the result.\n-# If you change settings.TIME_ZONE in tests, reset _localtime to None.\n _localtime = None\n \n def get_default_timezone():"
        },
        {
            "sha": "90bc1f3a184dd23129acb4205044a275e3886ee5",
            "filename": "tests/modeltests/timezones/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 42,
            "changes": 59,
            "blob_url": "https://github.com/django/django/blob/a15cfb2e451feb626d141461eb058ff760bed913/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a15cfb2e451feb626d141461eb058ff760bed913/tests%2Fmodeltests%2Ftimezones%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ftimezones%2Ftests.py?ref=a15cfb2e451feb626d141461eb058ff760bed913",
            "patch": "@@ -50,32 +50,8 @@\n         \"time zone, but your operating system isn't able to do that.\")\n \n \n-class BaseDateTimeTests(TestCase):\n-\n-    @classmethod\n-    def setUpClass(self):\n-        self._old_time_zone = settings.TIME_ZONE\n-        settings.TIME_ZONE = connection.settings_dict['TIME_ZONE'] = 'Africa/Nairobi'\n-        timezone._localtime = None\n-        if TZ_SUPPORT:\n-            self._old_tz = os.environ.get('TZ')\n-            os.environ['TZ'] = 'Africa/Nairobi'\n-            time.tzset()\n-\n-    @classmethod\n-    def tearDownClass(self):\n-        settings.TIME_ZONE = connection.settings_dict['TIME_ZONE'] = self._old_time_zone\n-        timezone._localtime = None\n-        if TZ_SUPPORT:\n-            if self._old_tz is None:\n-                del os.environ['TZ']\n-            else:\n-                os.environ['TZ'] = self._old_tz\n-            time.tzset()\n-\n-\n-@override_settings(USE_TZ=False)\n-class LegacyDatabaseTests(BaseDateTimeTests):\n+@override_settings(TIME_ZONE='Africa/Nairobi', USE_TZ=False)\n+class LegacyDatabaseTests(TestCase):\n \n     def test_naive_datetime(self):\n         dt = datetime.datetime(2011, 9, 1, 13, 20, 30)\n@@ -269,8 +245,8 @@ def test_raw_sql(self):\n                 transform=lambda d: d)\n \n \n-@override_settings(USE_TZ=True)\n-class NewDatabaseTests(BaseDateTimeTests):\n+@override_settings(TIME_ZONE='Africa/Nairobi', USE_TZ=True)\n+class NewDatabaseTests(TestCase):\n \n     @requires_tz_support\n     def test_naive_datetime(self):\n@@ -486,7 +462,8 @@ def test_null_datetime(self):\n         self.assertEqual(e.dt, None)\n \n \n-class SerializationTests(BaseDateTimeTests):\n+@override_settings(TIME_ZONE='Africa/Nairobi')\n+class SerializationTests(TestCase):\n \n     # Backend-specific notes:\n     # - JSON supports only milliseconds, microseconds will be truncated.\n@@ -639,8 +616,9 @@ def test_aware_datetime_in_other_timezone(self):\n             obj = serializers.deserialize('yaml', data).next().object\n             self.assertEqual(obj.dt.replace(tzinfo=UTC), dt)\n \n-@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n-class TemplateTests(BaseDateTimeTests):\n+\n+@override_settings(DATETIME_FORMAT='c', TIME_ZONE='Africa/Nairobi', USE_L10N=False, USE_TZ=True)\n+class TemplateTests(TestCase):\n \n     @requires_tz_support\n     def test_localtime_templatetag_and_filters(self):\n@@ -723,10 +701,8 @@ def test_localtime_filters_with_pytz(self):\n         tpl = Template(\"{% load tz %}{{ dt|localtime }}|{{ dt|utc }}\")\n         ctx = Context({'dt': datetime.datetime(2011, 9, 1, 12, 20, 30)})\n \n-        timezone._localtime = None\n         with self.settings(TIME_ZONE='Europe/Paris'):\n             self.assertEqual(tpl.render(ctx), \"2011-09-01T12:20:30+02:00|2011-09-01T10:20:30+00:00\")\n-        timezone._localtime = None\n \n         # Use a pytz timezone as argument\n         tpl = Template(\"{% load tz %}{{ dt|timezone:tz }}\")\n@@ -864,11 +840,9 @@ def test_localtime_with_time_zone_setting_set_to_none(self):\n         tpl = Template(\"{% load tz %}{{ dt }}\")\n         ctx = Context({'dt': datetime.datetime(2011, 9, 1, 12, 20, 30, tzinfo=EAT)})\n \n-        timezone._localtime = None\n         with self.settings(TIME_ZONE=None):\n             # the actual value depends on the system time zone of the host\n             self.assertTrue(tpl.render(ctx).startswith(\"2011\"))\n-        timezone._localtime = None\n \n     @requires_tz_support\n     def test_now_template_tag_uses_current_time_zone(self):\n@@ -879,8 +853,8 @@ def test_now_template_tag_uses_current_time_zone(self):\n             self.assertEqual(tpl.render(Context({})), \"+0700\")\n \n \n-@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=False)\n-class LegacyFormsTests(BaseDateTimeTests):\n+@override_settings(DATETIME_FORMAT='c', TIME_ZONE='Africa/Nairobi', USE_L10N=False, USE_TZ=False)\n+class LegacyFormsTests(TestCase):\n \n     def test_form(self):\n         form = EventForm({'dt': u'2011-09-01 13:20:30'})\n@@ -914,8 +888,8 @@ def test_model_form(self):\n         self.assertEqual(e.dt, datetime.datetime(2011, 9, 1, 13, 20, 30))\n \n \n-@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n-class NewFormsTests(BaseDateTimeTests):\n+@override_settings(DATETIME_FORMAT='c', TIME_ZONE='Africa/Nairobi', USE_L10N=False, USE_TZ=True)\n+class NewFormsTests(TestCase):\n \n     @requires_tz_support\n     def test_form(self):\n@@ -960,8 +934,8 @@ def test_model_form(self):\n         self.assertEqual(e.dt, datetime.datetime(2011, 9, 1, 10, 20, 30, tzinfo=UTC))\n \n \n-@override_settings(DATETIME_FORMAT='c', USE_L10N=False, USE_TZ=True)\n-class AdminTests(BaseDateTimeTests):\n+@override_settings(DATETIME_FORMAT='c', TIME_ZONE='Africa/Nairobi', USE_L10N=False, USE_TZ=True)\n+class AdminTests(TestCase):\n \n     urls = 'modeltests.timezones.urls'\n     fixtures = ['tz_users.xml']\n@@ -1012,7 +986,8 @@ def test_change_readonly_in_other_timezone(self):\n         self.assertContains(response, t.created.astimezone(ICT).isoformat())\n \n \n-class UtilitiesTests(BaseDateTimeTests):\n+@override_settings(TIME_ZONE='Africa/Nairobi')\n+class UtilitiesTests(TestCase):\n \n     def test_make_aware(self):\n         self.assertEqual("
        }
    ],
    "stats": {
        "total": 84,
        "additions": 39,
        "deletions": 45
    }
}