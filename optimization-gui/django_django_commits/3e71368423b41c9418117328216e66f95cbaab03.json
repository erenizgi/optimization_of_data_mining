{
    "author": "fhahn",
    "message": "Fixed #10870 -- Added aggreation + generic reverse relation test",
    "sha": "3e71368423b41c9418117328216e66f95cbaab03",
    "files": [
        {
            "sha": "b857ba62ac7ef9893b65f32c8c0a2ed7b9704173",
            "filename": "tests/regressiontests/aggregation_regress/models.py",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/3e71368423b41c9418117328216e66f95cbaab03/tests%2Fregressiontests%2Faggregation_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/3e71368423b41c9418117328216e66f95cbaab03/tests%2Fregressiontests%2Faggregation_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Fmodels.py?ref=3e71368423b41c9418117328216e66f95cbaab03",
            "patch": "@@ -1,4 +1,6 @@\n # coding: utf-8\n+from django.contrib.contenttypes import generic\n+from django.contrib.contenttypes.models import ContentType\n from django.db import models\n from django.utils.encoding import python_2_unicode_compatible\n \n@@ -22,6 +24,13 @@ def __str__(self):\n         return self.name\n \n \n+class TaggedItem(models.Model):\n+    tag = models.CharField(max_length=100)\n+    content_type = models.ForeignKey(ContentType)\n+    object_id = models.PositiveIntegerField()\n+    content_object = generic.GenericForeignKey('content_type', 'object_id')\n+\n+\n @python_2_unicode_compatible\n class Book(models.Model):\n     isbn = models.CharField(max_length=9)\n@@ -33,6 +42,7 @@ class Book(models.Model):\n     contact = models.ForeignKey(Author, related_name='book_contact_set')\n     publisher = models.ForeignKey(Publisher)\n     pubdate = models.DateField()\n+    tags = generic.GenericRelation(TaggedItem)\n \n     class Meta:\n         ordering = ('name',)\n@@ -63,6 +73,14 @@ class Clues(models.Model):\n     Clue = models.CharField(max_length=150)\n \n \n+class WithManualPK(models.Model):\n+    # The generic relations regression test needs two different model\n+    # classes with the same PK value, and there are some (external)\n+    # DB backends that don't work nicely when assigning integer to AutoField\n+    # column (MSSQL at least).\n+    id = models.IntegerField(primary_key=True)\n+\n+\n @python_2_unicode_compatible\n class HardbackBook(Book):\n     weight = models.FloatField()"
        },
        {
            "sha": "94a02cf3b5cd4fe42ee42ff16158712027b820c1",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/3e71368423b41c9418117328216e66f95cbaab03/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/3e71368423b41c9418117328216e66f95cbaab03/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=3e71368423b41c9418117328216e66f95cbaab03",
            "patch": "@@ -6,11 +6,13 @@\n from operator import attrgetter\n \n from django.core.exceptions import FieldError\n+from django.contrib.contenttypes.models import ContentType\n from django.db.models import Count, Max, Avg, Sum, StdDev, Variance, F, Q\n from django.test import TestCase, Approximate, skipUnlessDBFeature\n from django.utils import six\n \n-from .models import Author, Book, Publisher, Clues, Entries, HardbackBook\n+from .models import (Author, Book, Publisher, Clues, Entries, HardbackBook,\n+        TaggedItem, WithManualPK)\n \n \n class AggregationTests(TestCase):\n@@ -982,3 +984,39 @@ def test_aggregate_duplicate_columns_select_related(self):\n     def test_reverse_join_trimming(self):\n         qs = Author.objects.annotate(Count('book_contact_set__contact'))\n         self.assertIn(' JOIN ', str(qs.query))\n+\n+    def test_aggregation_with_generic_reverse_relation(self):\n+        \"\"\"\n+        Regression test for #10870:  Aggregates with joins ignore extra\n+        filters provided by setup_joins\n+\n+        tests aggregations with generic reverse relations\n+        \"\"\"\n+        b = Book.objects.get(name='Practical Django Projects')\n+        TaggedItem.objects.create(object_id=b.id, tag='intermediate',\n+                content_type=ContentType.objects.get_for_model(b))\n+        TaggedItem.objects.create(object_id=b.id, tag='django',\n+                content_type=ContentType.objects.get_for_model(b))\n+        # Assign a tag to model with same PK as the book above. If the JOIN\n+        # used in aggregation doesn't have content type as part of the\n+        # condition the annotation will also count the 'hi mom' tag for b.\n+        wmpk = WithManualPK.objects.create(id=b.pk)\n+        TaggedItem.objects.create(object_id=wmpk.id, tag='hi mom',\n+                content_type=ContentType.objects.get_for_model(wmpk))\n+        b = Book.objects.get(name__startswith='Paradigms of Artificial Intelligence')\n+        TaggedItem.objects.create(object_id=b.id, tag='intermediate',\n+                content_type=ContentType.objects.get_for_model(b))\n+\n+        self.assertEqual(Book.objects.aggregate(Count('tags')), {'tags__count': 3})\n+        results = Book.objects.annotate(Count('tags')).order_by('-tags__count', 'name')\n+        self.assertEqual(\n+            [(b.name, b.tags__count) for b in results],\n+            [\n+                ('Practical Django Projects', 2),\n+                ('Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp', 1),\n+                ('Artificial Intelligence: A Modern Approach', 0),\n+                ('Python Web Development with Django', 0),\n+                ('Sams Teach Yourself Django in 24 Hours', 0),\n+                ('The Definitive Guide to Django: Web Development Done Right', 0)\n+            ]\n+        )"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 57,
        "deletions": 1
    }
}