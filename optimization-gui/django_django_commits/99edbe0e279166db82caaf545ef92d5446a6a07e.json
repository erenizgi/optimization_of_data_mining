{
    "author": "oinopion",
    "message": "Fixed #19253 -- Extracted template cache key building logic\n\nIntroduced a public function\ndjango.core.cache.utils.make_template_fragment_key\nThanks @chrismedrela for fruitful cooperation.",
    "sha": "99edbe0e279166db82caaf545ef92d5446a6a07e",
    "files": [
        {
            "sha": "5f9cb980c6970098ad754eabc8453e6d122d2898",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/99edbe0e279166db82caaf545ef92d5446a6a07e/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/99edbe0e279166db82caaf545ef92d5446a6a07e/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=99edbe0e279166db82caaf545ef92d5446a6a07e",
            "patch": "@@ -382,6 +382,7 @@ answer newbie questions, and generally made Django that much better:\n     Paul McLanahan <paul@mclanahan.net>\n     Tobias McNulty <http://www.caktusgroup.com/blog>\n     Andrews Medina <andrewsmedina@gmail.com>\n+    Christoph MÄ™drela <chris.medrela@gmail.com>\n     Zain Memon\n     Christian Metts\n     michal@plovarna.cz\n@@ -418,6 +419,7 @@ answer newbie questions, and generally made Django that much better:\n     Christian Oudard <christian.oudard@gmail.com>\n     oggie rob <oz.robharvey@gmail.com>\n     oggy <ognjen.maric@gmail.com>\n+    Tomek Paczkowski <tomek@hauru.eu>\n     Jens Page\n     Jay Parlar <parlar@gmail.com>\n     Carlos Eduardo de Paula <carlosedp@gmail.com>"
        },
        {
            "sha": "4310825ad48fe45a2952e0d644b6cceb8047b9fa",
            "filename": "django/core/cache/utils.py",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/99edbe0e279166db82caaf545ef92d5446a6a07e/django%2Fcore%2Fcache%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/99edbe0e279166db82caaf545ef92d5446a6a07e/django%2Fcore%2Fcache%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fcache%2Futils.py?ref=99edbe0e279166db82caaf545ef92d5446a6a07e",
            "patch": "@@ -0,0 +1,15 @@\n+from __future__ import absolute_import, unicode_literals\n+\n+import hashlib\n+from django.utils.encoding import force_bytes\n+from django.utils.http import urlquote\n+\n+TEMPLATE_FRAGMENT_KEY_TEMPLATE = 'template.cache.%s.%s'\n+\n+\n+def make_template_fragment_key(fragment_name, vary_on=None):\n+    if vary_on is None:\n+        vary_on = ()\n+    key = ':'.join([urlquote(var) for var in vary_on])\n+    args = hashlib.md5(force_bytes(key))\n+    return TEMPLATE_FRAGMENT_KEY_TEMPLATE % (fragment_name, args.hexdigest())"
        },
        {
            "sha": "8c061ca4c61ff77e493d163f742b5f1e42540e64",
            "filename": "django/templatetags/cache.py",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/99edbe0e279166db82caaf545ef92d5446a6a07e/django%2Ftemplatetags%2Fcache.py",
            "raw_url": "https://github.com/django/django/raw/99edbe0e279166db82caaf545ef92d5446a6a07e/django%2Ftemplatetags%2Fcache.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplatetags%2Fcache.py?ref=99edbe0e279166db82caaf545ef92d5446a6a07e",
            "patch": "@@ -1,10 +1,8 @@\n from __future__ import unicode_literals\n \n-import hashlib\n+from django.core.cache.utils import make_template_fragment_key\n from django.template import Library, Node, TemplateSyntaxError, VariableDoesNotExist\n from django.core.cache import cache\n-from django.utils.encoding import force_bytes\n-from django.utils.http import urlquote\n \n register = Library()\n \n@@ -24,10 +22,8 @@ def render(self, context):\n             expire_time = int(expire_time)\n         except (ValueError, TypeError):\n             raise TemplateSyntaxError('\"cache\" tag got a non-integer timeout value: %r' % expire_time)\n-        # Build a key for this fragment and all vary-on's.\n-        key = ':'.join([urlquote(var.resolve(context)) for var in self.vary_on])\n-        args = hashlib.md5(force_bytes(key))\n-        cache_key = 'template.cache.%s.%s' % (self.fragment_name, args.hexdigest())\n+        vary_on = [var.resolve(context) for var in self.vary_on]\n+        cache_key = make_template_fragment_key(self.fragment_name, vary_on)\n         value = cache.get(cache_key)\n         if value is None:\n             value = self.nodelist.render(context)"
        },
        {
            "sha": "6b6d57511a328524b302e2b94ccbd13ec9d16dc0",
            "filename": "docs/topics/cache.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/99edbe0e279166db82caaf545ef92d5446a6a07e/docs%2Ftopics%2Fcache.txt",
            "raw_url": "https://github.com/django/django/raw/99edbe0e279166db82caaf545ef92d5446a6a07e/docs%2Ftopics%2Fcache.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fcache.txt?ref=99edbe0e279166db82caaf545ef92d5446a6a07e",
            "patch": "@@ -639,6 +639,23 @@ equivalent:\n This feature is useful in avoiding repetition in templates. You can set the\n timeout in a variable, in one place, and just reuse that value.\n \n+.. function:: django.core.cache.utils.make_template_fragment_key(fragment_name, vary_on=None)\n+\n+If you want to obtain the cache key used for a cached fragment, you can use\n+``make_template_fragment_key``. ``fragment_name`` is the same as second argument\n+to the ``cache`` template tag; ``vary_on`` is a list of all additional arguments\n+passed to the tag. This function can be useful for invalidating or overwriting\n+a cached item, for example:\n+\n+.. code-block:: python\n+\n+    >>> from django.core.cache import cache\n+    >>> from django.core.cache.utils import make_template_fragment_key\n+    # cache key for {% cache 500 sidebar username %}\n+    >>> key = make_template_fragment_key('sidebar', [username])\n+    >>> cache.delete(key) # invalidates cached template fragment\n+\n+\n The low-level cache API\n =======================\n "
        },
        {
            "sha": "d5d538319a7036e9e999b591834c522c0c97746f",
            "filename": "tests/regressiontests/cache/tests.py",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/99edbe0e279166db82caaf545ef92d5446a6a07e/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/99edbe0e279166db82caaf545ef92d5446a6a07e/tests%2Fregressiontests%2Fcache%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcache%2Ftests.py?ref=99edbe0e279166db82caaf545ef92d5446a6a07e",
            "patch": "@@ -20,6 +20,7 @@\n from django.core.cache.backends.base import (CacheKeyWarning,\n     InvalidCacheBackendError)\n from django.db import router, transaction\n+from django.core.cache.utils import make_template_fragment_key\n from django.http import (HttpResponse, HttpRequest, StreamingHttpResponse,\n     QueryDict)\n from django.middleware.cache import (FetchFromCacheMiddleware,\n@@ -1809,3 +1810,25 @@ def test_admin(self):\n             response = self.client.get('/test_admin/admin/')\n             self.assertEqual(response.status_code, 200)\n             self.assertTrue(response.has_header('ETag'))\n+\n+\n+class TestMakeTemplateFragmentKey(TestCase):\n+    def test_without_vary_on(self):\n+        key = make_template_fragment_key('a.fragment')\n+        self.assertEqual(key, 'template.cache.a.fragment.d41d8cd98f00b204e9800998ecf8427e')\n+\n+    def test_with_one_vary_on(self):\n+        key = make_template_fragment_key('foo', ['abc'])\n+        self.assertEqual(key,\n+            'template.cache.foo.900150983cd24fb0d6963f7d28e17f72')\n+\n+    def test_with_many_vary_on(self):\n+        key = make_template_fragment_key('bar', ['abc', 'def'])\n+        self.assertEqual(key,\n+            'template.cache.bar.4b35f12ab03cec09beec4c21b2d2fa88')\n+\n+    def test_proper_escaping(self):\n+        key = make_template_fragment_key('spam', ['abc:def%'])\n+        self.assertEqual(key,\n+            'template.cache.spam.f27688177baec990cdf3fbd9d9c3f469')\n+"
        }
    ],
    "stats": {
        "total": 67,
        "additions": 60,
        "deletions": 7
    }
}