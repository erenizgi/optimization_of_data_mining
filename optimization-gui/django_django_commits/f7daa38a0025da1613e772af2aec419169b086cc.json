{
    "author": "jezdez",
    "message": "Fixed #10498 (again) -- Made sure the improvements done in r17641 have a smaller impact on speed. Thanks to Anssi Kääriäinen for the patch and Jonas Obrist for reviewing.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17698 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f7daa38a0025da1613e772af2aec419169b086cc",
    "files": [
        {
            "sha": "fc38224345f0c79c17dc7610d4705cb00574c1ee",
            "filename": "django/db/models/base.py",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/f7daa38a0025da1613e772af2aec419169b086cc/django%2Fdb%2Fmodels%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f7daa38a0025da1613e772af2aec419169b086cc/django%2Fdb%2Fmodels%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fbase.py?ref=f7daa38a0025da1613e772af2aec419169b086cc",
            "patch": "@@ -20,7 +20,7 @@\n from django.db.models import signals\n from django.db.models.loading import register_models, get_model\n from django.utils.translation import ugettext_lazy as _\n-from django.utils.functional import curry, Promise\n+from django.utils.functional import curry\n from django.utils.encoding import smart_str, force_unicode\n from django.utils.text import get_text_list, capfirst\n \n@@ -297,14 +297,10 @@ def __init__(self, *args, **kwargs):\n             # is *not* consumed. We rely on this, so don't change the order\n             # without changing the logic.\n             for val, field in izip(args, fields_iter):\n-                if isinstance(val, Promise):\n-                    val = force_unicode(val)\n                 setattr(self, field.attname, val)\n         else:\n             # Slower, kwargs-ready version.\n             for val, field in izip(args, fields_iter):\n-                if isinstance(val, Promise):\n-                    val = force_unicode(val)\n                 setattr(self, field.attname, val)\n                 kwargs.pop(field.name, None)\n                 # Maintain compatibility with existing calls.\n@@ -358,8 +354,6 @@ def __init__(self, *args, **kwargs):\n                 # checked) by the RelatedObjectDescriptor.\n                 setattr(self, field.name, rel_obj)\n             else:\n-                if isinstance(val, Promise):\n-                    val = force_unicode(val)\n                 setattr(self, field.attname, val)\n \n         if kwargs:"
        },
        {
            "sha": "5cfc98477076f2b4a20f73c7258b3482c0674dc7",
            "filename": "django/db/models/sql/subqueries.py",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/f7daa38a0025da1613e772af2aec419169b086cc/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "raw_url": "https://github.com/django/django/raw/f7daa38a0025da1613e772af2aec419169b086cc/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fsubqueries.py?ref=f7daa38a0025da1613e772af2aec419169b086cc",
            "patch": "@@ -8,6 +8,8 @@\n from django.db.models.sql.datastructures import Date\n from django.db.models.sql.query import Query\n from django.db.models.sql.where import AND, Constraint\n+from django.utils.functional import Promise\n+from django.utils.encoding import force_unicode\n \n \n __all__ = ['DeleteQuery', 'UpdateQuery', 'InsertQuery', 'DateQuery',\n@@ -38,7 +40,7 @@ def delete_batch(self, pk_list, using, field=None):\n         for offset in range(0, len(pk_list), GET_ITERATOR_CHUNK_SIZE):\n             where = self.where_class()\n             where.add((Constraint(None, field.column, field), 'in',\n-                    pk_list[offset : offset + GET_ITERATOR_CHUNK_SIZE]), AND)\n+                    pk_list[offset:offset + GET_ITERATOR_CHUNK_SIZE]), AND)\n             self.do_query(self.model._meta.db_table, where, using=using)\n \n class UpdateQuery(Query):\n@@ -67,14 +69,13 @@ def clone(self, klass=None, **kwargs):\n         return super(UpdateQuery, self).clone(klass,\n                 related_updates=self.related_updates.copy(), **kwargs)\n \n-\n     def update_batch(self, pk_list, values, using):\n         pk_field = self.model._meta.pk\n         self.add_update_values(values)\n         for offset in range(0, len(pk_list), GET_ITERATOR_CHUNK_SIZE):\n             self.where = self.where_class()\n             self.where.add((Constraint(None, pk_field.column, pk_field), 'in',\n-                    pk_list[offset : offset + GET_ITERATOR_CHUNK_SIZE]),\n+                    pk_list[offset:offset + GET_ITERATOR_CHUNK_SIZE]),\n                     AND)\n             self.get_compiler(using).execute_sql(None)\n \n@@ -101,6 +102,10 @@ def add_update_fields(self, values_seq):\n         Used by add_update_values() as well as the \"fast\" update path when\n         saving models.\n         \"\"\"\n+        # Check that no Promise object passes to the query. Refs #10498.\n+        values_seq = [(value[0], value[1], force_unicode(value[2]))\n+                      if isinstance(value[2], Promise) else value\n+                      for value in values_seq]\n         self.values.extend(values_seq)\n \n     def add_related_update(self, model, field, value):\n@@ -159,6 +164,12 @@ def insert_values(self, fields, objs, raw=False):\n         into the query, for example.\n         \"\"\"\n         self.fields = fields\n+        # Check that no Promise object reaches the DB. Refs #10498.\n+        for field in fields:\n+            for obj in objs:\n+                value = getattr(obj, field.attname)\n+                if isinstance(value, Promise):\n+                    setattr(obj, field.attname, force_unicode(value))\n         self.objs = objs\n         self.raw = raw\n "
        },
        {
            "sha": "f9141dc69286a9ec98b83d87525fc535cfac0f75",
            "filename": "tests/modeltests/basic/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/django/django/blob/f7daa38a0025da1613e772af2aec419169b086cc/tests%2Fmodeltests%2Fbasic%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f7daa38a0025da1613e772af2aec419169b086cc/tests%2Fmodeltests%2Fbasic%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fbasic%2Ftests.py?ref=f7daa38a0025da1613e772af2aec419169b086cc",
            "patch": "@@ -5,6 +5,7 @@\n from django.core.exceptions import ObjectDoesNotExist\n from django.db.models.fields import FieldDoesNotExist\n from django.test import TestCase, skipIfDBFeature, skipUnlessDBFeature\n+from django.utils.translation import ugettext_lazy\n \n from .models import Article\n \n@@ -553,3 +554,27 @@ def test_extra_method_select_argument_with_dashes(self):\n             pub_date__year=2008).extra(\n                 select={'dashed-value': '1', 'undashedvalue': '2'})\n         self.assertEqual(articles[0].undashedvalue, 2)\n+\n+    def test_create_relation_with_ugettext_lazy(self):\n+        \"\"\"\n+        Test that ugettext_lazy objects work when saving model instances\n+        through various methods. Refs #10498.\n+        \"\"\"\n+        notlazy = u'test'\n+        lazy = ugettext_lazy(notlazy)\n+        reporter = Article.objects.create(headline=lazy, pub_date=datetime.now())\n+        article = Article.objects.get()\n+        self.assertEqual(article.headline, notlazy)\n+        # test that assign + save works with Promise objecs\n+        article.headline = lazy\n+        article.save()\n+        self.assertEqual(article.headline, notlazy)\n+        # test .update()\n+        Article.objects.update(headline=lazy)\n+        article = Article.objects.get()\n+        self.assertEqual(article.headline, notlazy)\n+        # still test bulk_create()\n+        Article.objects.all().delete()\n+        Article.objects.bulk_create([Article(headline=lazy, pub_date=datetime.now())])\n+        article = Article.objects.get()\n+        self.assertEqual(article.headline, notlazy)"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 40,
        "deletions": 10
    }
}