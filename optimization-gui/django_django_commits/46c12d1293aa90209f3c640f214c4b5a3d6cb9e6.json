{
    "author": "jezdez",
    "message": "Fixed #17455 -- Extended `CachedStaticFilesStorage` slightly to handle some URLs better that are used to add support for webfonts to IE 6-8. Also ignore `data:` URLs and fragment-only URLs (e.g. `#default#VML`).\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17282 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
    "files": [
        {
            "sha": "1b2060de133b1c1f2bc06f2baee6ef9eea5b6ed3",
            "filename": "django/contrib/staticfiles/storage.py",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/django%2Fcontrib%2Fstaticfiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fstaticfiles%2Fstorage.py?ref=46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
            "patch": "@@ -12,7 +12,7 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.core.files.base import ContentFile\n from django.core.files.storage import FileSystemStorage, get_storage_class\n-from django.utils.encoding import force_unicode\n+from django.utils.encoding import force_unicode, smart_str\n from django.utils.functional import LazyObject\n from django.utils.importlib import import_module\n from django.utils.datastructures import SortedDict\n@@ -84,9 +84,14 @@ def hashed_name(self, name, content=None):\n         for chunk in content.chunks():\n             md5.update(chunk)\n         md5sum = md5.hexdigest()[:12]\n-        hashed_name = os.path.join(path, u\"%s.%s%s\" % (root, md5sum, ext))\n+        hashed_name = os.path.join(path, u\"%s.%s%s\" %\n+                                   (root, md5sum, ext))\n         unparsed_name = list(parsed_name)\n         unparsed_name[2] = hashed_name\n+        # Special casing for a @font-face hack, like url(myfont.eot?#iefix\")\n+        # http://www.fontspring.com/blog/the-new-bulletproof-font-face-syntax\n+        if '?#' in name and not unparsed_name[3]:\n+            unparsed_name[2] += '?'\n         return urlunsplit(unparsed_name)\n \n     def cache_key(self, name):\n@@ -103,7 +108,8 @@ def url(self, name, force=False):\n             hashed_name = self.cache.get(cache_key)\n             if hashed_name is None:\n                 hashed_name = self.hashed_name(name).replace('\\\\', '/')\n-                # set the cache if there was a miss (e.g. if cache server goes down)\n+                # set the cache if there was a miss\n+                # (e.g. if cache server goes down)\n                 self.cache.set(cache_key, hashed_name)\n         return unquote(super(CachedFilesMixin, self).url(hashed_name))\n \n@@ -119,7 +125,7 @@ def converter(matchobj):\n             \"\"\"\n             matched, url = matchobj.groups()\n             # Completely ignore http(s) prefixed URLs\n-            if url.startswith(('http', 'https')):\n+            if url.startswith(('#', 'http', 'https', 'data:')):\n                 return matched\n             name_parts = name.split(os.sep)\n             # Using posix normpath here to remove duplicates\n@@ -182,7 +188,8 @@ def post_process(self, paths, dry_run=False, **options):\n                 if self.exists(hashed_name):\n                     self.delete(hashed_name)\n \n-                saved_name = self._save(hashed_name, ContentFile(content))\n+                content_file = ContentFile(smart_str(content))\n+                saved_name = self._save(hashed_name, content_file)\n                 hashed_name = force_unicode(saved_name.replace('\\\\', '/'))\n                 processed_files.append(hashed_name)\n "
        },
        {
            "sha": "7c58b2e62269cfddee660660d189c862dacb1f80",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/css/fonts/font.eot",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffonts%2Ffont.eot",
            "raw_url": "https://github.com/django/django/raw/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffonts%2Ffont.eot",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffonts%2Ffont.eot?ref=46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
            "patch": "@@ -0,0 +1 @@\n+not really a EOT ;)\n\\ No newline at end of file"
        },
        {
            "sha": "028237591530971e3adb0f9fddafeedb65a8dbe6",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/css/fonts/font.svg",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffonts%2Ffont.svg",
            "raw_url": "https://github.com/django/django/raw/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffonts%2Ffont.svg",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffonts%2Ffont.svg?ref=46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
            "patch": "@@ -0,0 +1 @@\n+not really a SVG ;)\n\\ No newline at end of file"
        },
        {
            "sha": "540d54b88db3494bc893bd214ed4f1720cf8d237",
            "filename": "tests/regressiontests/staticfiles_tests/project/documents/cached/css/fragments.css",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffragments.css",
            "raw_url": "https://github.com/django/django/raw/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffragments.css",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fproject%2Fdocuments%2Fcached%2Fcss%2Ffragments.css?ref=46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
            "patch": "@@ -0,0 +1,8 @@\n+@font-face {\n+    src: url('fonts/font.eot?#iefix') format('embedded-opentype'),\n+         url('fonts/font.svg#webfontIyfZbseF') format('svg');\n+         url('data:font/woff;charset=utf-8;base64,d09GRgABAAAAADJoAA0AAAAAR2QAAQAAAAAAAAAAAAA');\n+}\n+div {\n+    behavior: url(\"#default#VML\");\n+}"
        },
        {
            "sha": "8358f833c8f9d8d792516a6ea1417577c3e67f32",
            "filename": "tests/regressiontests/staticfiles_tests/storage.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Fstorage.py?ref=46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
            "patch": "@@ -4,7 +4,7 @@\n class DummyStorage(storage.Storage):\n     \"\"\"\n     A storage class that does implement modified_time() but raises\n-    NotImplementedError when calling \n+    NotImplementedError when calling\n     \"\"\"\n     def _save(self, name, content):\n         return 'dummy'"
        },
        {
            "sha": "bd22ea9f3e2c4c8b8ca9a7bde7be4f2e8dc73f9d",
            "filename": "tests/regressiontests/staticfiles_tests/tests.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/46c12d1293aa90209f3c640f214c4b5a3d6cb9e6/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fstaticfiles_tests%2Ftests.py?ref=46c12d1293aa90209f3c640f214c4b5a3d6cb9e6",
            "patch": "@@ -331,6 +331,16 @@ def test_path_with_fragment(self):\n             self.assertNotIn(\"cached/other.css\", content)\n             self.assertIn(\"/static/cached/other.d41d8cd98f00.css\", content)\n \n+    def test_path_with_querystring_and_fragment(self):\n+        relpath = self.cached_file_path(\"cached/css/fragments.css\")\n+        self.assertEqual(relpath, \"cached/css/fragments.75433540b096.css\")\n+        with storage.staticfiles_storage.open(relpath) as relfile:\n+            content = relfile.read()\n+            self.assertIn('/static/cached/css/fonts/font.a4b0478549d0.eot?#iefix', content)\n+            self.assertIn('/static/cached/css/fonts/font.b8d603e42714.svg#webfontIyfZbseF', content)\n+            self.assertIn('data:font/woff;charset=utf-8;base64,d09GRgABAAAAADJoAA0AAAAAR2QAAQAAAAAAAAAAAAA', content)\n+            self.assertIn('#default#VML', content)\n+\n     def test_template_tag_absolute(self):\n         relpath = self.cached_file_path(\"cached/absolute.css\")\n         self.assertEqual(relpath, \"cached/absolute.cc80cb5e2eb1.css\")"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 33,
        "deletions": 6
    }
}