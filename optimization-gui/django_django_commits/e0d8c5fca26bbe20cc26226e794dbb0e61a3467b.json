{
    "author": "ramiro",
    "message": "Fixed error introduced in r14666 that results in the message reporting the test DB name to be created being shown actually after the real action when the operation fails.\nImplemented that by factoring out calculation of test DB name to an internal method.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14861 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "e0d8c5fca26bbe20cc26226e794dbb0e61a3467b",
    "files": [
        {
            "sha": "b6379df4c15f255fc550b1904ed7c0132cd116e7",
            "filename": "django/db/backends/creation.py",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/e0d8c5fca26bbe20cc26226e794dbb0e61a3467b/django%2Fdb%2Fbackends%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/e0d8c5fca26bbe20cc26226e794dbb0e61a3467b/django%2Fdb%2Fbackends%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fcreation.py?ref=e0d8c5fca26bbe20cc26226e794dbb0e61a3467b",
            "patch": "@@ -32,8 +32,6 @@ def sql_create_model(self, model, style, known_models=set()):\n         Returns the SQL required to create a single model, as a tuple of:\n             (list_of_sql, pending_references_dict)\n         \"\"\"\n-        from django.db import models\n-\n         opts = model._meta\n         if not opts.managed or opts.proxy:\n             return [], {}\n@@ -340,14 +338,16 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         Creates a test database, prompting the user for confirmation if the\n         database already exists. Returns the name of the test database created.\n         \"\"\"\n-        test_database_name = self._create_test_db(verbosity, autoclobber)\n+        test_database_name = self._get_test_db_name()\n \n         if verbosity >= 1:\n             test_db_repr = ''\n             if verbosity >= 2:\n                 test_db_repr = \" ('%s')\" % test_database_name\n             print \"Creating test database for alias '%s'%s...\" % (self.connection.alias, test_db_repr)\n \n+        self._create_test_db(verbosity, autoclobber)\n+\n         self.connection.close()\n         self.connection.settings_dict[\"NAME\"] = test_database_name\n \n@@ -372,14 +372,22 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n \n         return test_database_name\n \n+    def _get_test_db_name(self):\n+        \"\"\"\n+        Internal implementation - returns the name of the test DB that wll be\n+        created. Only useful when called from create_test_db() and\n+        _create_test_db() and when no external munging is done with the 'NAME'\n+        or 'TEST_NAME' settings.\n+        \"\"\"\n+        if self.connection.settings_dict['TEST_NAME']:\n+            return self.connection.settings_dict['TEST_NAME']\n+        return TEST_DATABASE_PREFIX + self.connection.settings_dict['NAME']\n+\n     def _create_test_db(self, verbosity, autoclobber):\n         \"Internal implementation - creates the test db tables.\"\n         suffix = self.sql_table_creation_suffix()\n \n-        if self.connection.settings_dict['TEST_NAME']:\n-            test_database_name = self.connection.settings_dict['TEST_NAME']\n-        else:\n-            test_database_name = TEST_DATABASE_PREFIX + self.connection.settings_dict['NAME']\n+        test_database_name = self._get_test_db_name()\n \n         qn = self.connection.ops.quote_name\n "
        },
        {
            "sha": "8a4458b310eea2cfba1d7893e0989fe0d18a7316",
            "filename": "django/db/backends/oracle/creation.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/e0d8c5fca26bbe20cc26226e794dbb0e61a3467b/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/e0d8c5fca26bbe20cc26226e794dbb0e61a3467b/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Foracle%2Fcreation.py?ref=e0d8c5fca26bbe20cc26226e794dbb0e61a3467b",
            "patch": "@@ -43,7 +43,7 @@ def __init__(self, connection):\n         super(DatabaseCreation, self).__init__(connection)\n \n     def _create_test_db(self, verbosity=1, autoclobber=False):\n-        TEST_NAME = self._test_database_name()\n+        TEST_NAME = self._get_test_db_name()\n         TEST_USER = self._test_database_user()\n         TEST_PASSWD = self._test_database_passwd()\n         TEST_TBLSPACE = self._test_database_tblspace()\n@@ -201,7 +201,7 @@ def _execute_statements(self, cursor, statements, parameters, verbosity):\n                 sys.stderr.write(\"Failed (%s)\\n\" % (err))\n                 raise\n \n-    def _test_database_name(self):\n+    def _get_test_db_name(self):\n         name = TEST_DATABASE_PREFIX + self.connection.settings_dict['NAME']\n         try:\n             if self.connection.settings_dict['TEST_NAME']:"
        },
        {
            "sha": "f32bd0a75d2042206aa3f8ba2511b387f82f02a9",
            "filename": "django/db/backends/sqlite3/creation.py",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/e0d8c5fca26bbe20cc26226e794dbb0e61a3467b/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/e0d8c5fca26bbe20cc26226e794dbb0e61a3467b/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fcreation.py?ref=e0d8c5fca26bbe20cc26226e794dbb0e61a3467b",
            "patch": "@@ -38,9 +38,15 @@ def sql_remove_table_constraints(self, model, references_to_delete, style):\n         \"SQLite3 doesn't support constraints\"\n         return []\n \n-    def _create_test_db(self, verbosity, autoclobber):\n+    def _get_test_db_name(self):\n         test_database_name = self.connection.settings_dict['TEST_NAME']\n-        if test_database_name and test_database_name != \":memory:\":\n+        if test_database_name and test_database_name != ':memory:':\n+            return test_database_name\n+        return ':memory:'\n+\n+    def _create_test_db(self, verbosity, autoclobber):\n+        test_database_name = self._get_test_db_name()\n+        if test_database_name != ':memory:':\n             # Erase the old test database\n             if verbosity >= 1:\n                 print \"Destroying old test database '%s'...\" % self.connection.alias\n@@ -56,8 +62,6 @@ def _create_test_db(self, verbosity, autoclobber):\n                 else:\n                     print \"Tests cancelled.\"\n                     sys.exit(1)\n-        else:\n-            test_database_name = \":memory:\"\n         return test_database_name\n \n     def _destroy_test_db(self, test_database_name, verbosity):"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 25,
        "deletions": 13
    }
}