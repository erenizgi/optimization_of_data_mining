{
    "author": "ramiro",
    "message": "Fixed #15790 -- Fixed QuerySet only() and defer() methods behavior with proxy models. Thanks Michal Modzelewzki for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16228 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd",
    "files": [
        {
            "sha": "27c6859c61433bf919729038fcb519b38e1cde83",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd",
            "patch": "@@ -553,7 +553,10 @@ def deferred_to_data(self, target, callback):\n         columns = set()\n         orig_opts = self.model._meta\n         seen = {}\n-        must_include = {self.model: set([orig_opts.pk])}\n+        if orig_opts.proxy:\n+            must_include = {orig_opts.proxy_for_model: set([orig_opts.pk])}\n+        else:\n+            must_include = {self.model: set([orig_opts.pk])}\n         for field_name in field_names:\n             parts = field_name.split(LOOKUP_SEP)\n             cur_model = self.model"
        },
        {
            "sha": "4e4ab0a51528c6712fe7b3031193b3d6098a1580",
            "filename": "tests/regressiontests/defer_regress/models.py",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Fmodels.py?ref=07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd",
            "patch": "@@ -34,3 +34,7 @@ def __unicode__(self):\n class ResolveThis(models.Model):\n     num = models.FloatField()\n     name = models.CharField(max_length=16)\n+\n+class Proxy(Item):\n+    class Meta:\n+        proxy = True"
        },
        {
            "sha": "fbcf85e0785f2556db642cecfb8d6147563c7a02",
            "filename": "tests/regressiontests/defer_regress/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdefer_regress%2Ftests.py?ref=07bfc76ecf22bfcd0cdbabe6af8639db2a0253dd",
            "patch": "@@ -7,7 +7,7 @@\n from django.db.models.loading import cache\n from django.test import TestCase\n \n-from models import ResolveThis, Item, RelatedItem, Child, Leaf\n+from models import ResolveThis, Item, RelatedItem, Child, Leaf, Proxy\n \n \n class DeferRegressionTest(TestCase):\n@@ -111,6 +111,7 @@ def test():\n                 Child,\n                 Item,\n                 Leaf,\n+                Proxy,\n                 RelatedItem,\n                 ResolveThis,\n             ]\n@@ -139,13 +140,29 @@ def test():\n                 \"Leaf_Deferred_name_value\",\n                 \"Leaf_Deferred_second_child_value\",\n                 \"Leaf_Deferred_value\",\n+                \"Proxy\",\n                 \"RelatedItem\",\n                 \"RelatedItem_Deferred_\",\n                 \"RelatedItem_Deferred_item_id\",\n                 \"ResolveThis\",\n             ]\n         )\n \n+    def test_only_and_defer_usage_on_proxy_models(self):\n+        # Regression for #15790 - only() broken for proxy models\n+        proxy = Proxy.objects.create(name=\"proxy\", value=42)\n+\n+        msg = 'QuerySet.only() return bogus results with proxy models'\n+        dp = Proxy.objects.only('other_value').get(pk=proxy.pk)\n+        self.assertEqual(dp.name, proxy.name, msg=msg)\n+        self.assertEqual(dp.value, proxy.value, msg=msg)\n+\n+        # also test things with .defer()\n+        msg = 'QuerySet.defer() return bogus results with proxy models'\n+        dp = Proxy.objects.defer('name', 'text', 'value').get(pk=proxy.pk)\n+        self.assertEqual(dp.name, proxy.name, msg=msg)\n+        self.assertEqual(dp.value, proxy.value, msg=msg)\n+\n     def test_resolve_columns(self):\n         rt = ResolveThis.objects.create(num=5.0, name='Foobar')\n         qs = ResolveThis.objects.defer('num')"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 26,
        "deletions": 2
    }
}