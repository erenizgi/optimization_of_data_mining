{
    "author": "freakboy3742",
    "message": "Fixed #13815 -- Ensure that reverse exclude lookups on nullable foreign keys exclude null values. Thanks to bpeschier for the report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15458 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d3b38d578f41240442cb043012b0035a20eebd67",
    "files": [
        {
            "sha": "341765c60839042cd0b9e98f6a1572c71ea2295d",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/d3b38d578f41240442cb043012b0035a20eebd67/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/d3b38d578f41240442cb043012b0035a20eebd67/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=d3b38d578f41240442cb043012b0035a20eebd67",
            "patch": "@@ -1475,6 +1475,13 @@ def split_exclude(self, filter_expr, prefix, can_reuse):\n         query.bump_prefix()\n         query.clear_ordering(True)\n         query.set_start(prefix)\n+        # Adding extra check to make sure the selected field will not be null\n+        # since we are adding a IN <subquery> clause. This prevents the\n+        # database from tripping over IN (...,NULL,...) selects and returning\n+        # nothing\n+        alias, col = query.select[0]\n+        query.where.add((Constraint(alias, col, None), 'isnull', False), AND)\n+\n         self.add_filter(('%s__in' % prefix, query), negate=True, trim=True,\n                 can_reuse=can_reuse)\n "
        },
        {
            "sha": "8392c588e4c716db1615304f204bc90f787f3898",
            "filename": "tests/regressiontests/null_queries/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/d3b38d578f41240442cb043012b0035a20eebd67/tests%2Fregressiontests%2Fnull_queries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d3b38d578f41240442cb043012b0035a20eebd67/tests%2Fregressiontests%2Fnull_queries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fnull_queries%2Ftests.py?ref=d3b38d578f41240442cb043012b0035a20eebd67",
            "patch": "@@ -67,3 +67,15 @@ def test_reverse_relations(self):\n             ['<Inner: Inner object>']\n         )\n \n+        # Ticket #13815: check if <reverse>_isnull=False does not produce\n+        # faulty empty lists\n+        objB = OuterB.objects.create(data=\"reverse\")\n+        self.assertQuerysetEqual(\n+            OuterB.objects.filter(inner__isnull=False),\n+            []\n+        )\n+        Inner.objects.create(first=obj)\n+        self.assertQuerysetEqual(\n+            OuterB.objects.exclude(inner__isnull=False),\n+            ['<OuterB: OuterB object>']\n+        )"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 19,
        "deletions": 0
    }
}