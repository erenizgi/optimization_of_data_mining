{
    "author": "carljm",
    "message": "Fixed #16568 -- Added RequireDebugFalse filter to prevent sending 500 error emails when DEBUG is True in projects with no explicit LOGGING setting. Thanks to Andreas Pelme for report and patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16840 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "343004c4de332bfec09e8a57de775a46fecb18f9",
    "files": [
        {
            "sha": "3b829ce75b7f6df6807fc050e0894d542aa4110a",
            "filename": "django/conf/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Fconf%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Fconf%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2F__init__.py?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -199,13 +199,8 @@ def compat_patch_logging_config(logging_config):\n         while filter_name in filters:\n             filter_name = filter_name + \"_\"\n \n-        def _callback(record):\n-            from django.conf import settings\n-            return not settings.DEBUG\n-\n         filters[filter_name] = {\n-            \"()\": \"django.utils.log.CallbackFilter\",\n-            \"callback\": _callback\n-            }\n+            \"()\": \"django.utils.log.RequireDebugFalse\",\n+        }\n \n         logging_config[\"handlers\"][\"mail_admins\"][\"filters\"] = [filter_name]"
        },
        {
            "sha": "29c9812be508dee55d07652e73c1438be1b77dfc",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -514,13 +514,13 @@\n # The default logging configuration. This sends an email to\n # the site admins on every HTTP 500 error. All other log\n # records are sent to the bit bucket.\n+\n LOGGING = {\n     'version': 1,\n     'disable_existing_loggers': False,\n     'filters': {\n         'require_debug_false': {\n-            '()': 'django.utils.log.CallbackFilter',\n-            'callback': lambda r: not DEBUG\n+            '()': 'django.utils.log.RequireDebugFalse',\n         }\n     },\n     'handlers': {"
        },
        {
            "sha": "b92c1163c39b928c1bcba665a2e147603d1591e2",
            "filename": "django/conf/project_template/settings.py",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Fconf%2Fproject_template%2Fsettings.py",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Fconf%2Fproject_template%2Fsettings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fproject_template%2Fsettings.py?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -128,8 +128,7 @@\n     'disable_existing_loggers': False,\n     'filters': {\n         'require_debug_false': {\n-            '()': 'django.utils.log.CallbackFilter',\n-            'callback': lambda r: not DEBUG\n+            '()': 'django.utils.log.RequireDebugFalse'\n         }\n     },\n     'handlers': {"
        },
        {
            "sha": "8ce37f53096d74303215f48bf6d4e4ec0ec9f401",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -30,6 +30,7 @@ def emit(self, record):\n if not logger.handlers:\n     logger.addHandler(NullHandler())\n \n+\n class AdminEmailHandler(logging.Handler):\n     \"\"\"An exception log handler that emails log entries to site admins.\n \n@@ -82,8 +83,12 @@ class CallbackFilter(logging.Filter):\n     def __init__(self, callback):\n         self.callback = callback\n \n-\n     def filter(self, record):\n         if self.callback(record):\n             return 1\n         return 0\n+\n+\n+class RequireDebugFalse(logging.Filter):\n+    def filter(self, record):\n+        return not settings.DEBUG"
        },
        {
            "sha": "f12db2817b42606c476efdc2f00195a0bdd662dd",
            "filename": "docs/releases/1.4.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/docs%2Freleases%2F1.4.txt",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/docs%2Freleases%2F1.4.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.4.txt?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -593,8 +593,7 @@ to :class:`django.utils.log.AdminEmailHandler` to prevent admin error emails in\n \n    'filters': {\n         'require_debug_false': {\n-            '()': 'django.utils.log.CallbackFilter',\n-            'callback': lambda r: not DEBUG\n+            '()': 'django.utils.log.RequireDebugFalse'\n         }\n     },\n     'handlers': {"
        },
        {
            "sha": "0175e8576fff0bc0525003de7064658a0a89851b",
            "filename": "docs/topics/logging.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/docs%2Ftopics%2Flogging.txt",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/docs%2Ftopics%2Flogging.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Flogging.txt?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -504,8 +504,8 @@ Python logging module.\n Filters\n -------\n \n-Django provides one log filter in addition to those provided by the\n-Python logging module.\n+Django provides two log filters in addition to those provided by the Python\n+logging module.\n \n .. class:: CallbackFilter(callback)\n \n@@ -516,14 +516,19 @@ Python logging module.\n    through the filter. Handling of that record will not proceed if the callback\n    returns False.\n \n+.. class:: RequireDebugFalse()\n+\n+   .. versionadded:: 1.4\n+\n+   This filter will only pass on records when settings.DEBUG is False.\n+\n    This filter is used as follows in the default :setting:`LOGGING`\n    configuration to ensure that the :class:`AdminEmailHandler` only sends error\n    emails to admins when :setting:`DEBUG` is `False`::\n \n        'filters': {\n             'require_debug_false': {\n-                '()': 'django.utils.log.CallbackFilter',\n-                'callback': lambda r: not DEBUG\n+                '()': 'django.utils.log.RequireDebugFalse',\n             }\n         },\n         'handlers': {"
        },
        {
            "sha": "a21373995161627fb8b22fc8a5fd7ae99e195d61",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/django/django/blob/343004c4de332bfec09e8a57de775a46fecb18f9/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/343004c4de332bfec09e8a57de775a46fecb18f9/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=343004c4de332bfec09e8a57de775a46fecb18f9",
            "patch": "@@ -4,12 +4,12 @@\n \n from django.conf import compat_patch_logging_config\n from django.test import TestCase\n+\n+from django.utils.log import CallbackFilter, RequireDebugFalse, getLogger\n from django.test.utils import override_settings\n-from django.utils.log import CallbackFilter, getLogger\n from django.core import mail\n \n \n-\n # logging config prior to using filter with mail_admins\n OLD_LOGGING = {\n     'version': 1,\n@@ -30,7 +30,6 @@\n }\n \n \n-\n class PatchLoggingConfigTest(TestCase):\n     \"\"\"\n     Tests for backward-compat shim for #16288. These tests should be removed in\n@@ -50,28 +49,30 @@ def test_filter_added(self):\n             config[\"handlers\"][\"mail_admins\"][\"filters\"],\n             ['require_debug_false'])\n \n-\n     def test_filter_configuration(self):\n         \"\"\"\n-        Test that the debug-false filter is a CallbackFilter with a callback\n-        that works as expected (returns ``not DEBUG``).\n+        Test that the auto-added require_debug_false filter is an instance of\n+        `RequireDebugFalse` filter class.\n \n         \"\"\"\n         config = copy.deepcopy(OLD_LOGGING)\n         compat_patch_logging_config(config)\n \n         flt = config[\"filters\"][\"require_debug_false\"]\n+        self.assertEqual(flt[\"()\"], \"django.utils.log.RequireDebugFalse\")\n \n-        self.assertEqual(flt[\"()\"], \"django.utils.log.CallbackFilter\")\n+    def test_require_debug_false_filter(self):\n+        \"\"\"\n+        Test the RequireDebugFalse filter class.\n \n-        callback = flt[\"callback\"]\n+        \"\"\"\n+        filter_ = RequireDebugFalse()\n \n         with self.settings(DEBUG=True):\n-            self.assertEqual(callback(\"record is not used\"), False)\n+            self.assertEqual(filter_.filter(\"record is not used\"), False)\n \n         with self.settings(DEBUG=False):\n-            self.assertEqual(callback(\"record is not used\"), True)\n-\n+            self.assertEqual(filter_.filter(\"record is not used\"), True)\n \n     def test_no_patch_if_filters_key_exists(self):\n         \"\"\"\n@@ -110,6 +111,7 @@ def test_sense(self):\n \n     def test_passes_on_record(self):\n         collector = []\n+\n         def _callback(record):\n             collector.append(record)\n             return True"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 34,
        "deletions": 29
    }
}