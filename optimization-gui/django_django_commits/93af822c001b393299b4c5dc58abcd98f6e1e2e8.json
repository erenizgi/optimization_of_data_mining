{
    "author": "aaugustin",
    "message": "Improved recovery when the connection is closed in an atomic block.",
    "sha": "93af822c001b393299b4c5dc58abcd98f6e1e2e8",
    "files": [
        {
            "sha": "b713b4c97af9bb83f2d4a2a933a9f6bda332ad02",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/93af822c001b393299b4c5dc58abcd98f6e1e2e8/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/93af822c001b393299b4c5dc58abcd98f6e1e2e8/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=93af822c001b393299b4c5dc58abcd98f6e1e2e8",
            "patch": "@@ -52,14 +52,14 @@ def __init__(self, settings_dict, alias=DEFAULT_DB_ALIAS,\n         self._dirty = False\n         # Tracks if the connection is in a transaction managed by 'atomic'.\n         self.in_atomic_block = False\n+        # List of savepoints created by 'atomic'\n+        self.savepoint_ids = []\n         # Tracks if the outermost 'atomic' block should commit on exit,\n         # ie. if autocommit was active on entry.\n         self.commit_on_exit = True\n         # Tracks if the transaction should be rolled back to the next\n         # available savepoint because of an exception in an inner block.\n         self.needs_rollback = False\n-        # List of savepoints created by 'atomic'\n-        self.savepoint_ids = []\n \n         # Connection termination related attributes\n         self.close_at = None\n@@ -100,6 +100,9 @@ def create_cursor(self):\n \n     def connect(self):\n         \"\"\"Connects to the database. Assumes that the connection is closed.\"\"\"\n+        # In case the previous connection was closed while in an atomic block\n+        self.in_atomic_block = False\n+        self.savepoint_ids = []\n         # Reset parameters defining when to close the connection\n         max_age = self.settings_dict['CONN_MAX_AGE']\n         self.close_at = None if max_age is None else time.time() + max_age\n@@ -179,6 +182,9 @@ def close(self):\n         Closes the connection to the database.\n         \"\"\"\n         self.validate_thread_sharing()\n+        # Don't call validate_no_atomic_block() to avoid making it difficult\n+        # to get rid of a connection in an invalid state. The next connect()\n+        # will reset the transaction state anyway.\n         try:\n             self._close()\n         finally:"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 8,
        "deletions": 2
    }
}