{
    "author": "andrewgodwin",
    "message": "Add db_table and db_tablespace handling",
    "sha": "60873ea2ade8bed909b9f2dabb0f8a499226e10d",
    "files": [
        {
            "sha": "bae0b1d71d49264ba9187c46824c0af068f624d2",
            "filename": "django/db/backends/schema.py",
            "status": "modified",
            "additions": 26,
            "deletions": 6,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/60873ea2ade8bed909b9f2dabb0f8a499226e10d/django%2Fdb%2Fbackends%2Fschema.py",
            "raw_url": "https://github.com/django/django/raw/60873ea2ade8bed909b9f2dabb0f8a499226e10d/django%2Fdb%2Fbackends%2Fschema.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fschema.py?ref=60873ea2ade8bed909b9f2dabb0f8a499226e10d",
            "patch": "@@ -1,9 +1,3 @@\n-import sys\n-import time\n-\n-from django.conf import settings\n-from django.db import transaction\n-from django.db.utils import load_backend\n from django.db.backends.creation import BaseDatabaseCreation\n from django.db.backends.util import truncate_name\n from django.utils.log import getLogger\n@@ -25,12 +19,19 @@ class BaseDatabaseSchemaEditor(object):\n     then the relevant actions, and then commit(). This is necessary to allow\n     things like circular foreign key references - FKs will only be created once\n     commit() is called.\n+\n+    TODO:\n+        - Repointing of FKs\n+        - Repointing of M2Ms\n+        - Check constraints (PosIntField)\n+        - PK changing\n     \"\"\"\n \n     # Overrideable SQL templates\n     sql_create_table = \"CREATE TABLE %(table)s (%(definition)s)\"\n     sql_create_table_unique = \"UNIQUE (%(columns)s)\"\n     sql_rename_table = \"ALTER TABLE %(old_table)s RENAME TO %(new_table)s\"\n+    sql_retablespace_table = \"ALTER TABLE %(table)s SET TABLESPACE %(new_tablespace)s\"\n     sql_delete_table = \"DROP TABLE %(table)s CASCADE\"\n \n     sql_create_column = \"ALTER TABLE %(table)s ADD COLUMN %(column)s %(definition)s\"\n@@ -261,6 +262,25 @@ def alter_unique_together(self, model, old_unique_together, new_unique_together)\n                 \"columns\": \", \".join(self.quote_name(column) for column in columns),\n             })\n \n+    def alter_db_table(self, model, old_db_table, new_db_table):\n+        \"\"\"\n+        Renames the table a model points to.\n+        \"\"\"\n+        self.execute(self.sql_rename_table % {\n+            \"old_table\": self.quote_name(old_db_table),\n+            \"new_table\": self.quote_name(new_db_table),\n+        })\n+\n+    def alter_db_tablespace(self, model, old_db_tablespace, new_db_tablespace):\n+        \"\"\"\n+        Moves a model's table between tablespaces\n+        \"\"\"\n+        self.execute(self.sql_rename_table % {\n+            \"table\": self.quote_name(model._meta.db_table),\n+            \"old_tablespace\": self.quote_name(old_db_tablespace),\n+            \"new_tablespace\": self.quote_name(new_db_tablespace),\n+        })\n+\n     def create_field(self, model, field, keep_default=False):\n         \"\"\"\n         Creates a field on a model."
        },
        {
            "sha": "8813d3ca236da92a0e471a419bbb0e29a1b49702",
            "filename": "tests/modeltests/schema/tests.py",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/django/django/blob/60873ea2ade8bed909b9f2dabb0f8a499226e10d/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/60873ea2ade8bed909b9f2dabb0f8a499226e10d/tests%2Fmodeltests%2Fschema%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fschema%2Ftests.py?ref=60873ea2ade8bed909b9f2dabb0f8a499226e10d",
            "patch": "@@ -342,3 +342,42 @@ def test_unique_together(self):\n         UniqueTest.objects.create(year=2012, slug=\"foo\")\n         self.assertRaises(IntegrityError, UniqueTest.objects.create, year=2012, slug=\"foo\")\n         connection.rollback()\n+\n+    def test_db_table(self):\n+        \"\"\"\n+        Tests renaming of the table\n+        \"\"\"\n+        # Create the table\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.create_model(Author)\n+        editor.commit()\n+        # Ensure the table is there to begin with\n+        columns = self.column_classes(Author)\n+        self.assertEqual(columns['name'][0], \"CharField\")\n+        # Alter the table\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.alter_db_table(\n+            Author,\n+            \"schema_author\",\n+            \"schema_otherauthor\",\n+        )\n+        editor.commit()\n+        # Ensure the table is there afterwards\n+        Author._meta.db_table = \"schema_otherauthor\"\n+        columns = self.column_classes(Author)\n+        self.assertEqual(columns['name'][0], \"CharField\")\n+        # Alter the table again\n+        editor = connection.schema_editor()\n+        editor.start()\n+        editor.alter_db_table(\n+            Author,\n+            \"schema_otherauthor\",\n+            \"schema_author\",\n+        )\n+        editor.commit()\n+        # Ensure the table is still there\n+        Author._meta.db_table = \"schema_author\"\n+        columns = self.column_classes(Author)\n+        self.assertEqual(columns['name'][0], \"CharField\")"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 65,
        "deletions": 6
    }
}