{
    "author": "jezdez",
    "message": "Fixed #5612 -- Added login and logout signals to contrib auth app. Thanks SmileyChris and pterk.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14710 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "132afbf8eee837b6fe2d051f7eced4889e19de88",
    "files": [
        {
            "sha": "1f88adb49b75edad97988ee20783a2ccf9487029",
            "filename": "django/contrib/auth/__init__.py",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2F__init__.py?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -2,6 +2,7 @@\n from warnings import warn\n from django.core.exceptions import ImproperlyConfigured\n from django.utils.importlib import import_module\n+from django.contrib.auth.signals import user_logged_in, user_logged_out\n \n SESSION_KEY = '_auth_user_id'\n BACKEND_SESSION_KEY = '_auth_user_backend'\n@@ -62,8 +63,7 @@ def login(request, user):\n     if user is None:\n         user = request.user\n     # TODO: It would be nice to support different login methods, like signed cookies.\n-    user.last_login = datetime.datetime.now()\n-    user.save()\n+    user_logged_in.send(sender=user.__class__, request=request, user=user)\n \n     if SESSION_KEY in request.session:\n         if request.session[SESSION_KEY] != user.id:\n@@ -83,6 +83,13 @@ def logout(request):\n     Removes the authenticated user's ID from the request and flushes their\n     session data.\n     \"\"\"\n+    # Dispatch the signal before the user is logged out so the receivers have a\n+    # chance to find out *who* logged out.\n+    user = getattr(request, 'user', None)\n+    if hasattr(user, 'is_authenticated') and not user.is_authenticated():\n+        user = None\n+    user_logged_out.send(sender=user.__class__, request=request, user=user)\n+\n     request.session.flush()\n     if hasattr(request, 'user'):\n         from django.contrib.auth.models import AnonymousUser"
        },
        {
            "sha": "ebf9a8d2164b06f8c10050bb69a9820656271787",
            "filename": "django/contrib/auth/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmodels.py?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -2,6 +2,7 @@\n import urllib\n \n from django.contrib import auth\n+from django.contrib.auth.signals import user_logged_in\n from django.core.exceptions import ImproperlyConfigured\n from django.db import models\n from django.db.models.manager import EmptyManager\n@@ -40,6 +41,15 @@ def check_password(raw_password, enc_password):\n     algo, salt, hsh = enc_password.split('$')\n     return hsh == get_hexdigest(algo, salt, raw_password)\n \n+def update_last_login(sender, user, **kwargs):\n+    \"\"\"\n+    A signal receiver which updates the last_login date for\n+    the user logging in.\n+    \"\"\"\n+    user.last_login = datetime.datetime.now()\n+    user.save()\n+user_logged_in.connect(update_last_login)\n+\n class SiteProfileNotAvailable(Exception):\n     pass\n "
        },
        {
            "sha": "4f0b2c235c3ae74c39c1d3cbe67d7ddb45754c56",
            "filename": "django/contrib/auth/signals.py",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fsignals.py?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -0,0 +1,4 @@\n+from django.dispatch import Signal\n+\n+user_logged_in = Signal(providing_args=['request', 'user'])\n+user_logged_out = Signal(providing_args=['request', 'user'])"
        },
        {
            "sha": "9f8b49f400266f163ae1c103d798b94553d3ce8c",
            "filename": "django/contrib/auth/tests/__init__.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2F__init__.py?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -5,6 +5,7 @@\n from django.contrib.auth.tests.remote_user \\\n         import RemoteUserTest, RemoteUserNoCreateTest, RemoteUserCustomTest\n from django.contrib.auth.tests.models import ProfileTestCase\n+from django.contrib.auth.tests.signals import SignalTestCase\n from django.contrib.auth.tests.tokens import TokenGeneratorTest\n from django.contrib.auth.tests.views \\\n         import PasswordResetTest, ChangePasswordTest, LoginTest, LogoutTest"
        },
        {
            "sha": "3806021dcc22044d03421374cde66106d6224724",
            "filename": "django/contrib/auth/tests/signals.py",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Ftests%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/django%2Fcontrib%2Fauth%2Ftests%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fsignals.py?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -0,0 +1,47 @@\n+from django.test import TestCase\n+from django.contrib.auth import signals\n+\n+\n+class SignalTestCase(TestCase):\n+    urls = 'django.contrib.auth.tests.urls'\n+    fixtures = ['authtestdata.json']\n+\n+    def listener_login(self, user, **kwargs):\n+        self.logged_in.append(user)\n+\n+    def listener_logout(self, user, **kwargs):\n+        self.logged_out.append(user)\n+\n+    def setUp(self):\n+        \"\"\"Set up the listeners and reset the logged in/logged out counters\"\"\"\n+        self.logged_in = []\n+        self.logged_out = []\n+        signals.user_logged_in.connect(self.listener_login)\n+        signals.user_logged_out.connect(self.listener_logout)\n+\n+    def tearDown(self):\n+        \"\"\"Disconnect the listeners\"\"\"\n+        signals.user_logged_in.disconnect(self.listener_login)\n+        signals.user_logged_out.disconnect(self.listener_logout)\n+\n+    def test_login(self):\n+        # Only a successful login will trigger the signal.\n+        self.client.login(username='testclient', password='bad')\n+        self.assertEqual(len(self.logged_in), 0)\n+        # Like this:\n+        self.client.login(username='testclient', password='password')\n+        self.assertEqual(len(self.logged_in), 1)\n+        self.assertEqual(self.logged_in[0].username, 'testclient')\n+\n+    def test_logout_anonymous(self):\n+        # The log_out function will still trigger the signal for anonymous\n+        # users.\n+        self.client.get('/logout/next_page/')\n+        self.assertEqual(len(self.logged_out), 1)\n+        self.assertEqual(self.logged_out[0], None)\n+\n+    def test_logout(self):\n+        self.client.login(username='testclient', password='password')\n+        self.client.get('/logout/next_page/')\n+        self.assertEqual(len(self.logged_out), 1)\n+        self.assertEqual(self.logged_out[0].username, 'testclient')"
        },
        {
            "sha": "36ad071a757260010d1e1101b7f1d4b8b5ceae8d",
            "filename": "docs/ref/signals.txt",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/docs%2Fref%2Fsignals.txt",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/docs%2Fref%2Fsignals.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsignals.txt?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -12,6 +12,9 @@ A list of all the signals that Django sends.\n     The :doc:`comment framework </ref/contrib/comments/index>` sends a :doc:`set\n     of comment-related signals </ref/contrib/comments/signals>`.\n \n+    The :ref:`authentication framework <topics-auth>` sends :ref:`signals when\n+    a user is logged in / out <topics-auth-signals>`.\n+\n Model signals\n =============\n "
        },
        {
            "sha": "748fb894198d402a5cdd5446dec97efdf37871f5",
            "filename": "docs/topics/auth.txt",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/django/django/blob/132afbf8eee837b6fe2d051f7eced4889e19de88/docs%2Ftopics%2Fauth.txt",
            "raw_url": "https://github.com/django/django/raw/132afbf8eee837b6fe2d051f7eced4889e19de88/docs%2Ftopics%2Fauth.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fauth.txt?ref=132afbf8eee837b6fe2d051f7eced4889e19de88",
            "patch": "@@ -665,6 +665,44 @@ How to log a user out\n     immediately after logging out, do that *after* calling\n     :func:`django.contrib.auth.logout()`.\n \n+.. _topics-auth-signals:\n+\n+Login and logout signals\n+------------------------\n+\n+The auth framework uses two :ref:`signals <topic-signals>` that can be used for\n+notification when a user logs in or out.\n+\n+**:data:`django.contrib.auth.signals.user_logged_in`**\n+\n+Sent when a user logs in successfully.\n+\n+Arguments sent with this signal:\n+\n+    ``sender``\n+        As above: the class of the user that just logged in.\n+\n+    ``request``\n+        The current :class:`~django.http.HttpRequest` instance.\n+\n+    ``user``\n+        The user instance that just logged in.\n+\n+**:data:`django.contrib.auth.signals.user_logged_out`**\n+\n+Sent when the logout method is called.\n+\n+    ``sender``\n+        As above: the class of the user that just logged out or ``None``\n+        if the user was not authenticated.\n+\n+    ``request``\n+        The current :class:`~django.http.HttpRequest` instance.\n+\n+    ``user``\n+        The user instance that just logged out or ``None`` if the\n+        user was not authenticated.\n+\n Limiting access to logged-in users\n ----------------------------------\n "
        }
    ],
    "stats": {
        "total": 114,
        "additions": 112,
        "deletions": 2
    }
}