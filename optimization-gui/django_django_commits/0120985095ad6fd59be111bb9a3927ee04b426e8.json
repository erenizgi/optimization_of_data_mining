{
    "author": "claudep",
    "message": "[py3] Fixed file_uploads tests",
    "sha": "0120985095ad6fd59be111bb9a3927ee04b426e8",
    "files": [
        {
            "sha": "e76a4f4208cc0e602661caa6eafe16dbc1c74890",
            "filename": "django/http/multipartparser.py",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/0120985095ad6fd59be111bb9a3927ee04b426e8/django%2Fhttp%2Fmultipartparser.py",
            "raw_url": "https://github.com/django/django/raw/0120985095ad6fd59be111bb9a3927ee04b426e8/django%2Fhttp%2Fmultipartparser.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2Fmultipartparser.py?ref=0120985095ad6fd59be111bb9a3927ee04b426e8",
            "patch": "@@ -6,7 +6,9 @@\n \"\"\"\n from __future__ import unicode_literals\n \n+import base64\n import cgi\n+\n from django.conf import settings\n from django.core.exceptions import SuspiciousOperation\n from django.utils.datastructures import MultiValueDict\n@@ -199,7 +201,7 @@ def parse(self):\n                             if transfer_encoding == 'base64':\n                                 # We only special-case base64 transfer encoding\n                                 try:\n-                                    chunk = str(chunk).decode('base64')\n+                                    chunk = base64.b64decode(chunk)\n                                 except Exception as e:\n                                     # Since this is only a chunk, any error is an unfixable error.\n                                     raise MultiPartParserError(\"Could not decode base64 data: %r\" % e)"
        },
        {
            "sha": "19af992a36d2270ad8f161cf0c5e947b945dcf40",
            "filename": "tests/regressiontests/file_uploads/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/django/django/blob/0120985095ad6fd59be111bb9a3927ee04b426e8/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0120985095ad6fd59be111bb9a3927ee04b426e8/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py?ref=0120985095ad6fd59be111bb9a3927ee04b426e8",
            "patch": "@@ -12,6 +12,7 @@\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.http.multipartparser import MultiPartParser\n from django.test import TestCase, client\n+from django.utils.encoding import smart_bytes\n from django.utils.six import StringIO\n from django.utils import unittest\n \n@@ -48,12 +49,12 @@ def test_large_upload(self):\n             'file_field2': file2,\n             }\n \n-        for key in post_data.keys():\n+        for key in list(post_data):\n             try:\n                 post_data[key + '_hash'] = hashlib.sha1(post_data[key].read()).hexdigest()\n                 post_data[key].seek(0)\n             except AttributeError:\n-                post_data[key + '_hash'] = hashlib.sha1(post_data[key]).hexdigest()\n+                post_data[key + '_hash'] = hashlib.sha1(smart_bytes(post_data[key])).hexdigest()\n \n         response = self.client.post('/file_uploads/verify/', post_data)\n \n@@ -67,7 +68,7 @@ def test_base64_upload(self):\n             'Content-Type: application/octet-stream',\n             'Content-Transfer-Encoding: base64',\n             '',\n-            base64.b64encode(test_string),\n+            base64.b64encode(smart_bytes(test_string)).decode('ascii'),\n             '--' + client.BOUNDARY + '--',\n             '',\n         ]).encode('utf-8')\n@@ -79,7 +80,7 @@ def test_base64_upload(self):\n             'wsgi.input':     client.FakePayload(payload),\n         }\n         response = self.client.request(**r)\n-        received = json.loads(response.content)\n+        received = json.loads(response.content.decode('utf-8'))\n \n         self.assertEqual(received['file'], test_string)\n \n@@ -150,7 +151,7 @@ def test_dangerous_file_names(self):\n         response = self.client.request(**r)\n \n         # The filenames should have been sanitized by the time it got to the view.\n-        recieved = json.loads(response.content)\n+        recieved = json.loads(response.content.decode('utf-8'))\n         for i, name in enumerate(scary_file_names):\n             got = recieved[\"file%s\" % i]\n             self.assertEqual(got, \"hax0rd.txt\")\n@@ -174,7 +175,7 @@ def test_filename_overflow(self):\n             'REQUEST_METHOD': 'POST',\n             'wsgi.input':     client.FakePayload(payload),\n         }\n-        got = json.loads(self.client.request(**r).content)\n+        got = json.loads(self.client.request(**r).content.decode('utf-8'))\n         self.assertTrue(len(got['file']) < 256, \"Got a long file name (%s characters).\" % len(got['file']))\n \n     def test_truncated_multipart_handled_gracefully(self):\n@@ -200,7 +201,7 @@ def test_truncated_multipart_handled_gracefully(self):\n             'REQUEST_METHOD': 'POST',\n             'wsgi.input': client.FakePayload(payload),\n         }\n-        got = json.loads(self.client.request(**r).content)\n+        got = json.loads(self.client.request(**r).content.decode('utf-8'))\n         self.assertEqual(got, {})\n \n     def test_empty_multipart_handled_gracefully(self):\n@@ -215,7 +216,7 @@ def test_empty_multipart_handled_gracefully(self):\n             'REQUEST_METHOD': 'POST',\n             'wsgi.input': client.FakePayload(b''),\n         }\n-        got = json.loads(self.client.request(**r).content)\n+        got = json.loads(self.client.request(**r).content.decode('utf-8'))\n         self.assertEqual(got, {})\n \n     def test_custom_upload_handler(self):\n@@ -231,12 +232,12 @@ def test_custom_upload_handler(self):\n \n         # Small file posting should work.\n         response = self.client.post('/file_uploads/quota/', {'f': smallfile})\n-        got = json.loads(response.content)\n+        got = json.loads(response.content.decode('utf-8'))\n         self.assertTrue('f' in got)\n \n         # Large files don't go through.\n         response = self.client.post(\"/file_uploads/quota/\", {'f': bigfile})\n-        got = json.loads(response.content)\n+        got = json.loads(response.content.decode('utf-8'))\n         self.assertTrue('f' not in got)\n \n     def test_broken_custom_upload_handler(self):\n@@ -274,7 +275,7 @@ def test_fileupload_getlist(self):\n             'field5': 'test7',\n             'file2': (file2, file2a)\n         })\n-        got = json.loads(response.content)\n+        got = json.loads(response.content.decode('utf-8'))\n \n         self.assertEqual(got.get('file1'), 1)\n         self.assertEqual(got.get('file2'), 2)\n@@ -299,8 +300,8 @@ def handle_uncaught_exception(self, request, resolver, exc_info):\n         # it raises when there is an attempt to read more than the available bytes:\n         try:\n             client.FakePayload(b'a').read(2)\n-        except Exception as reference_error:\n-            pass\n+        except Exception as err:\n+            reference_error = err\n \n         # install the custom handler that tries to access request.POST\n         self.client.handler = POSTAccessingHandler()"
        },
        {
            "sha": "95b2124fd9967ad7ad9977b01b34e067db4fe957",
            "filename": "tests/regressiontests/file_uploads/views.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/0120985095ad6fd59be111bb9a3927ee04b426e8/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/0120985095ad6fd59be111bb9a3927ee04b426e8/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py?ref=0120985095ad6fd59be111bb9a3927ee04b426e8",
            "patch": "@@ -7,6 +7,7 @@\n from django.core.files.uploadedfile import UploadedFile\n from django.http import HttpResponse, HttpResponseServerError\n from django.utils import six\n+from django.utils.encoding import smart_bytes\n \n from .models import FileModel, UPLOAD_TO\n from .tests import UNICODE_FILENAME\n@@ -45,7 +46,7 @@ def file_upload_view_verify(request):\n         if isinstance(value, UploadedFile):\n             new_hash = hashlib.sha1(value.read()).hexdigest()\n         else:\n-            new_hash = hashlib.sha1(value).hexdigest()\n+            new_hash = hashlib.sha1(smart_bytes(value)).hexdigest()\n         if new_hash != submitted_hash:\n             return HttpResponseServerError()\n \n@@ -95,7 +96,7 @@ def file_upload_echo_content(request):\n     \"\"\"\n     Simple view to echo back the content of uploaded files for tests.\n     \"\"\"\n-    r = dict([(k, f.read()) for k, f in request.FILES.items()])\n+    r = dict([(k, f.read().decode('utf-8')) for k, f in request.FILES.items()])\n     return HttpResponse(json.dumps(r))\n \n def file_upload_quota(request):"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 20,
        "deletions": 16
    }
}