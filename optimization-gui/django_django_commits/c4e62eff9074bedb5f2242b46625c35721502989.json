{
    "author": "akaariai",
    "message": "Fixed #17653 -- Changed MySQL backend to raise a ValueError if zero is used as an AutoField value.\n\nThanks to Sylvain Lebon for the report, krzysiumed for the patch and charettes and claudep for reviews.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17933 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "c4e62eff9074bedb5f2242b46625c35721502989",
    "files": [
        {
            "sha": "0d664d452a71f4ded8fe752a13f407ac8468bdfd",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/c4e62eff9074bedb5f2242b46625c35721502989/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/c4e62eff9074bedb5f2242b46625c35721502989/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=c4e62eff9074bedb5f2242b46625c35721502989",
            "patch": "@@ -770,6 +770,14 @@ def prep_for_like_query(self, x):\n     # need not necessarily be implemented using \"LIKE\" in the backend.\n     prep_for_iexact_query = prep_for_like_query\n \n+    def validate_autopk_value(self, value):\n+        \"\"\"\n+        Certain backends do not accept some values for \"serial\" fields\n+        (for example zero in MySQL). This method will raise a ValueError\n+        if the value is invalid, otherwise returns validated value.\n+        \"\"\"\n+        return value\n+\n     def value_to_db_date(self, value):\n         \"\"\"\n         Transform a date value to an object compatible with what is expected"
        },
        {
            "sha": "6397a0972c2199f9aedb732935a97ace90d84fcd",
            "filename": "django/db/backends/mysql/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/c4e62eff9074bedb5f2242b46625c35721502989/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/c4e62eff9074bedb5f2242b46625c35721502989/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fmysql%2Fbase.py?ref=c4e62eff9074bedb5f2242b46625c35721502989",
            "patch": "@@ -276,6 +276,13 @@ def sql_flush(self, style, tables, sequences):\n         else:\n             return []\n \n+    def validate_autopk_value(self, value):\n+        # MySQLism: zero in AUTO_INCREMENT field does not work. Refs #17653.\n+        if value == 0:\n+            raise ValueError('The database backend does not accept 0 as a '\n+                             'value for AutoField.')\n+        return value\n+\n     def value_to_db_datetime(self, value):\n         if value is None:\n             return None"
        },
        {
            "sha": "dc4495390a639707bca5db47100e0ebc0281e6b2",
            "filename": "django/db/models/fields/__init__.py",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/c4e62eff9074bedb5f2242b46625c35721502989/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/c4e62eff9074bedb5f2242b46625c35721502989/django%2Fdb%2Fmodels%2Ffields%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2F__init__.py?ref=c4e62eff9074bedb5f2242b46625c35721502989",
            "patch": "@@ -531,6 +531,12 @@ def to_python(self, value):\n     def validate(self, value, model_instance):\n         pass\n \n+    def get_db_prep_value(self, value, connection, prepared=False):\n+        if not prepared:\n+            value = self.get_prep_value(value)\n+            value = connection.ops.validate_autopk_value(value)\n+        return value\n+\n     def get_prep_value(self, value):\n         if value is None:\n             return None"
        },
        {
            "sha": "3e675cc1ea13befc73bc3804d2a2ce8515f9dd66",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/c4e62eff9074bedb5f2242b46625c35721502989/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c4e62eff9074bedb5f2242b46625c35721502989/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=c4e62eff9074bedb5f2242b46625c35721502989",
            "patch": "@@ -13,7 +13,8 @@\n from django.db.backends.signals import connection_created\n from django.db.backends.postgresql_psycopg2 import version as pg_version\n from django.db.utils import ConnectionHandler, DatabaseError, load_backend\n-from django.test import TestCase, skipUnlessDBFeature, TransactionTestCase\n+from django.test import (TestCase, skipUnlessDBFeature, skipIfDBFeature,\n+    TransactionTestCase)\n from django.test.utils import override_settings\n from django.utils import unittest\n \n@@ -642,3 +643,15 @@ def test_old_style_backends_raise_useful_exception(self):\n         self.assertRaisesRegexp(ImproperlyConfigured,\n             \"Try using django.db.backends.sqlite3 instead\",\n             load_backend, 'sqlite3')\n+\n+\n+class MySQLPKZeroTests(TestCase):\n+    \"\"\"\n+    Zero as id for AutoField should raise exception in MySQL, because MySQL\n+    does not allow zero for automatic primary key.\n+    \"\"\"\n+\n+    @skipIfDBFeature('allows_primary_key_0')\n+    def test_zero_as_autoval(self):\n+        with self.assertRaises(ValueError):\n+            models.Square.objects.create(id=0, root=0, square=1)"
        },
        {
            "sha": "0b55f637a456336d599f5f8db2dd05961735ad8e",
            "filename": "tests/regressiontests/bulk_create/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/c4e62eff9074bedb5f2242b46625c35721502989/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/c4e62eff9074bedb5f2242b46625c35721502989/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbulk_create%2Ftests.py?ref=c4e62eff9074bedb5f2242b46625c35721502989",
            "patch": "@@ -2,7 +2,7 @@\n \n from operator import attrgetter\n \n-from django.test import TestCase, skipUnlessDBFeature\n+from django.test import TestCase, skipIfDBFeature, skipUnlessDBFeature\n \n from .models import Country, Restaurant, Pizzeria, State\n \n@@ -56,4 +56,16 @@ def test_non_auto_increment_pk(self):\n             ])\n         self.assertQuerysetEqual(State.objects.order_by(\"two_letter_code\"), [\n             \"CA\", \"IL\", \"ME\", \"NY\",\n-        ], attrgetter(\"two_letter_code\"))\n\\ No newline at end of file\n+        ], attrgetter(\"two_letter_code\"))\n+\n+    @skipIfDBFeature('allows_primary_key_0')\n+    def test_zero_as_autoval(self):\n+        \"\"\"\n+        Zero as id for AutoField should raise exception in MySQL, because MySQL\n+        does not allow zero for automatic primary key.\n+        \"\"\"\n+\n+        valid_country = Country(name='Germany', iso_two_letter='DE')\n+        invalid_country = Country(id=0, name='Poland', iso_two_letter='PL')\n+        with self.assertRaises(ValueError):\n+            Country.objects.bulk_create([valid_country, invalid_country])"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 49,
        "deletions": 3
    }
}