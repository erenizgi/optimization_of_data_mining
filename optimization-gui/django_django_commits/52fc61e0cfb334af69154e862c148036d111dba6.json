{
    "author": "ramiro",
    "message": "Fixed #14529 -- Fixed representation of model names in admin messages after model object changes when the ModelAdmin queryset() uses defer() or only(). Thanks rlaager for report and initial patch, to rasca an julien for help in tracking the problem.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15596 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "52fc61e0cfb334af69154e862c148036d111dba6",
    "files": [
        {
            "sha": "77c7705a10d3d5c07e651b3a56e0ebed3ed01171",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/52fc61e0cfb334af69154e862c148036d111dba6/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/52fc61e0cfb334af69154e862c148036d111dba6/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=52fc61e0cfb334af69154e862c148036d111dba6",
            "patch": "@@ -748,21 +748,28 @@ def response_change(self, request, obj):\n         Determines the HttpResponse for the change_view stage.\n         \"\"\"\n         opts = obj._meta\n+\n+        # Handle proxy models automatically created by .only() or .defer()\n+        verbose_name = opts.verbose_name\n+        if obj._deferred:\n+            opts_ = opts.proxy_for_model._meta\n+            verbose_name = opts_.verbose_name\n+\n         pk_value = obj._get_pk_val()\n \n-        msg = _('The %(name)s \"%(obj)s\" was changed successfully.') % {'name': force_unicode(opts.verbose_name), 'obj': force_unicode(obj)}\n+        msg = _('The %(name)s \"%(obj)s\" was changed successfully.') % {'name': force_unicode(verbose_name), 'obj': force_unicode(obj)}\n         if \"_continue\" in request.POST:\n             self.message_user(request, msg + ' ' + _(\"You may edit it again below.\"))\n             if \"_popup\" in request.REQUEST:\n                 return HttpResponseRedirect(request.path + \"?_popup=1\")\n             else:\n                 return HttpResponseRedirect(request.path)\n         elif \"_saveasnew\" in request.POST:\n-            msg = _('The %(name)s \"%(obj)s\" was added successfully. You may edit it again below.') % {'name': force_unicode(opts.verbose_name), 'obj': obj}\n+            msg = _('The %(name)s \"%(obj)s\" was added successfully. You may edit it again below.') % {'name': force_unicode(verbose_name), 'obj': obj}\n             self.message_user(request, msg)\n             return HttpResponseRedirect(\"../%s/\" % pk_value)\n         elif \"_addanother\" in request.POST:\n-            self.message_user(request, msg + ' ' + (_(\"You may add another %s below.\") % force_unicode(opts.verbose_name)))\n+            self.message_user(request, msg + ' ' + (_(\"You may add another %s below.\") % force_unicode(verbose_name)))\n             return HttpResponseRedirect(\"../add/\")\n         else:\n             self.message_user(request, msg)"
        },
        {
            "sha": "9ac99cc9efb66840ad7af6d2da202a6498d9f9b1",
            "filename": "tests/regressiontests/admin_views/models.py",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/52fc61e0cfb334af69154e862c148036d111dba6/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/52fc61e0cfb334af69154e862c148036d111dba6/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Fmodels.py?ref=52fc61e0cfb334af69154e862c148036d111dba6",
            "patch": "@@ -704,6 +704,37 @@ class FoodDeliveryAdmin(admin.ModelAdmin):\n     list_display=('reference', 'driver', 'restaurant')\n     list_editable = ('driver', 'restaurant')\n \n+class Paper(models.Model):\n+    title = models.CharField(max_length=30)\n+    author = models.CharField(max_length=30, blank=True, null=True)\n+\n+class CoverLetter(models.Model):\n+    author = models.CharField(max_length=30)\n+    date = models.DateField(null=True, blank=True)\n+\n+    def __unicode__(self):\n+        return self.author\n+\n+class PaperAdmin(admin.ModelAdmin):\n+    \"\"\"\n+    A ModelAdin with a custom queryset() method that uses only(), to test\n+    verbose_name display in messages shown after adding Paper instances.\n+    \"\"\"\n+\n+    def queryset(self, request):\n+        return super(PaperAdmin, self).queryset(request).only('title')\n+\n+class CoverLetterAdmin(admin.ModelAdmin):\n+    \"\"\"\n+    A ModelAdin with a custom queryset() method that uses only(), to test\n+    verbose_name display in messages shown after adding CoverLetter instances.\n+    Note that the CoverLetter model defines a __unicode__ method.\n+    \"\"\"\n+\n+    def queryset(self, request):\n+        #return super(CoverLetterAdmin, self).queryset(request).only('author')\n+        return super(CoverLetterAdmin, self).queryset(request).defer('date')\n+\n \n admin.site.register(Article, ArticleAdmin)\n admin.site.register(CustomArticle, CustomArticleAdmin)\n@@ -743,6 +774,8 @@ class FoodDeliveryAdmin(admin.ModelAdmin):\n admin.site.register(Reservation)\n admin.site.register(FoodDelivery, FoodDeliveryAdmin)\n admin.site.register(RowLevelChangePermissionModel, RowLevelChangePermissionModelAdmin)\n+admin.site.register(Paper, PaperAdmin)\n+admin.site.register(CoverLetter, CoverLetterAdmin)\n \n # We intentionally register Promo and ChapterXtra1 but not Chapter nor ChapterXtra2.\n # That way we cover all four cases:"
        },
        {
            "sha": "bbef907aac27ff19508f5c2b389698a021d6278b",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 32,
            "deletions": 1,
            "changes": 33,
            "blob_url": "https://github.com/django/django/blob/52fc61e0cfb334af69154e862c148036d111dba6/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/52fc61e0cfb334af69154e862c148036d111dba6/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=52fc61e0cfb334af69154e862c148036d111dba6",
            "patch": "@@ -36,7 +36,7 @@\n     Language, Collector, Widget, Grommet, DooHickey, FancyDoodad, Whatsit,\n     Category, Post, Plot, FunkyTag, Chapter, Book, Promo, WorkHour, Employee,\n     Question, Answer, Inquisition, Actor, FoodDelivery,\n-    RowLevelChangePermissionModel)\n+    RowLevelChangePermissionModel, Paper, CoverLetter)\n \n \n class AdminViewBasicTest(TestCase):\n@@ -2029,6 +2029,37 @@ def test_change_view(self):\n             else:\n                 self.assertEqual(response.status_code, 404)\n \n+    def test_add_model_modeladmin_only_qs(self):\n+        # only() is used in ModelAdmin.queryset()\n+        p = Paper.objects.create(title=u\"My Paper Title\")\n+        self.assertEqual(Paper.objects.count(), 1)\n+        response = self.client.get('/test_admin/admin/admin_views/paper/%s/' % p.pk)\n+        self.assertEqual(response.status_code, 200)\n+        post_data = {\n+            \"title\": u\"My Modified Paper Title\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/paper/%s/' % p.pk,\n+                post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        # Message should contain non-ugly model name. Instance representation is set by unicode() (ugly)\n+        self.assertContains(response, '<li class=\"info\">The paper &quot;Paper_Deferred_author object&quot; was changed successfully.</li>')\n+\n+        # defer() is used in ModelAdmin.queryset()\n+        cl = CoverLetter.objects.create(author=u\"John Doe\")\n+        self.assertEqual(CoverLetter.objects.count(), 1)\n+        response = self.client.get('/test_admin/admin/admin_views/coverletter/%s/' % cl.pk)\n+        self.assertEqual(response.status_code, 200)\n+        post_data = {\n+            \"author\": u\"John Doe II\",\n+            \"_save\": \"Save\",\n+        }\n+        response = self.client.post('/test_admin/admin/admin_views/coverletter/%s/' % cl.pk,\n+                post_data, follow=True)\n+        self.assertEqual(response.status_code, 200)\n+        # Message should contain non-ugly model name. Instance representation is set by model's __unicode__()\n+        self.assertContains(response, '<li class=\"info\">The cover letter &quot;John Doe II&quot; was changed successfully.</li>')\n+\n class AdminInlineFileUploadTest(TestCase):\n     fixtures = ['admin-views-users.xml', 'admin-views-actions.xml']\n     urlbit = 'admin'"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 75,
        "deletions": 4
    }
}