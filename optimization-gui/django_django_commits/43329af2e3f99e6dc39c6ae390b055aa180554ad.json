{
    "author": "jbronn",
    "message": "Fixed #16408 -- Fixed conversion of dates, and other problems with the SpatiaLite backend.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16749 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "43329af2e3f99e6dc39c6ae390b055aa180554ad",
    "files": [
        {
            "sha": "f23ec53cf826f9dbea7e4526ba3635508fa899b8",
            "filename": "django/contrib/gis/db/backends/spatialite/base.py",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fbase.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -2,16 +2,16 @@\n from django.conf import settings\n \n from django.core.exceptions import ImproperlyConfigured\n-from django.db.backends.sqlite3.base import *\n from django.db.backends.sqlite3.base import (\n-    _sqlite_extract, _sqlite_date_trunc, _sqlite_regexp,\n-    DatabaseWrapper as SqliteDatabaseWrapper)\n+    _sqlite_extract, _sqlite_date_trunc, _sqlite_regexp, _sqlite_format_dtdelta,\n+    connection_created, Database, DatabaseWrapper as SQLiteDatabaseWrapper,\n+    SQLiteCursorWrapper)\n from django.contrib.gis.db.backends.spatialite.client import SpatiaLiteClient\n from django.contrib.gis.db.backends.spatialite.creation import SpatiaLiteCreation\n from django.contrib.gis.db.backends.spatialite.introspection import SpatiaLiteIntrospection\n from django.contrib.gis.db.backends.spatialite.operations import SpatiaLiteOperations\n \n-class DatabaseWrapper(SqliteDatabaseWrapper):\n+class DatabaseWrapper(SQLiteDatabaseWrapper):\n     def __init__(self, *args, **kwargs):\n         # Before we get too far, make sure pysqlite 2.5+ is installed.\n         if Database.version_info < (2, 5, 0):\n@@ -52,6 +52,7 @@ def _cursor(self):\n             self.connection.create_function(\"django_extract\", 2, _sqlite_extract)\n             self.connection.create_function(\"django_date_trunc\", 2, _sqlite_date_trunc)\n             self.connection.create_function(\"regexp\", 2, _sqlite_regexp)\n+            self.connection.create_function(\"django_format_dtdelta\", 5, _sqlite_format_dtdelta)\n             connection_created.send(sender=self.__class__, connection=self)\n \n             ## From here on, customized for GeoDjango ##"
        },
        {
            "sha": "3f81ae68a13d876bda07422b82211ba480323b35",
            "filename": "django/contrib/gis/db/backends/spatialite/compiler.py",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcompiler.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -0,0 +1,32 @@\n+from django.db.backends.util import typecast_timestamp\n+from django.db.models.sql import compiler\n+from django.db.models.sql.constants import MULTI\n+from django.contrib.gis.db.models.sql.compiler import GeoSQLCompiler as BaseGeoSQLCompiler\n+\n+SQLCompiler = compiler.SQLCompiler\n+\n+class GeoSQLCompiler(BaseGeoSQLCompiler, SQLCompiler):\n+    pass\n+\n+class SQLInsertCompiler(compiler.SQLInsertCompiler, GeoSQLCompiler):\n+    pass\n+\n+class SQLDeleteCompiler(compiler.SQLDeleteCompiler, GeoSQLCompiler):\n+    pass\n+\n+class SQLUpdateCompiler(compiler.SQLUpdateCompiler, GeoSQLCompiler):\n+    pass\n+\n+class SQLAggregateCompiler(compiler.SQLAggregateCompiler, GeoSQLCompiler):\n+    pass\n+\n+class SQLDateCompiler(compiler.SQLDateCompiler, GeoSQLCompiler):\n+    \"\"\"\n+    This is overridden for GeoDjango to properly cast date columns, see #16757.\n+    \"\"\"\n+    def results_iter(self):\n+        offset = len(self.query.extra_select)\n+        for rows in self.execute_sql(MULTI):\n+            for row in rows:\n+                date = typecast_timestamp(str(row[offset]))\n+                yield date"
        },
        {
            "sha": "db96f46ef0bd7221b981a5a59518d2d16c455cf6",
            "filename": "django/contrib/gis/db/backends/spatialite/creation.py",
            "status": "modified",
            "additions": 42,
            "deletions": 4,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Fcreation.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -3,7 +3,6 @@\n from django.core.cache import get_cache\n from django.core.cache.backends.db import BaseDatabaseCache\n from django.core.exceptions import ImproperlyConfigured\n-from django.core.management import call_command\n from django.db.backends.sqlite3.creation import DatabaseCreation\n \n class SpatiaLiteCreation(DatabaseCreation):\n@@ -16,26 +15,65 @@ def create_test_db(self, verbosity=1, autoclobber=False):\n         This method is overloaded to load up the SpatiaLite initialization\n         SQL prior to calling the `syncdb` command.\n         \"\"\"\n+        # Don't import django.core.management if it isn't needed.\n+        from django.core.management import call_command\n+\n+        test_database_name = self._get_test_db_name()\n+\n         if verbosity >= 1:\n-            print \"Creating test database '%s'...\" % self.connection.alias\n+            test_db_repr = ''\n+            if verbosity >= 2:\n+                test_db_repr = \" ('%s')\" % test_database_name\n+            print \"Creating test database for alias '%s'%s...\" % (self.connection.alias, test_db_repr)\n \n-        test_database_name = self._create_test_db(verbosity, autoclobber)\n+        self._create_test_db(verbosity, autoclobber)\n \n         self.connection.close()\n-\n         self.connection.settings_dict[\"NAME\"] = test_database_name\n+\n         # Confirm the feature set of the test database\n         self.connection.features.confirm()\n+\n         # Need to load the SpatiaLite initialization SQL before running `syncdb`.\n         self.load_spatialite_sql()\n         call_command('syncdb', verbosity=verbosity, interactive=False, database=self.connection.alias)\n \n+        # Report syncdb messages at one level lower than that requested.\n+        # This ensures we don't get flooded with messages during testing\n+        # (unless you really ask to be flooded)\n+        call_command('syncdb',\n+            verbosity=max(verbosity - 1, 0),\n+            interactive=False,\n+            database=self.connection.alias,\n+            load_initial_data=False)\n+\n+        # We need to then do a flush to ensure that any data installed by\n+        # custom SQL has been removed. The only test data should come from\n+        # test fixtures, or autogenerated from post_syncdb triggers.\n+        # This has the side effect of loading initial data (which was\n+        # intentionally skipped in the syncdb).\n+        call_command('flush',\n+            verbosity=max(verbosity - 1, 0),\n+            interactive=False,\n+            database=self.connection.alias)\n+\n+        # One effect of calling syncdb followed by flush is that the id of the\n+        # default site may or may not be 1, depending on how the sequence was\n+        # reset.  If the sites app is loaded, then we coerce it.\n+        from django.db.models import get_model\n+        Site = get_model('sites', 'Site')\n+        if Site is not None and Site.objects.using(self.connection.alias).count() == 1:\n+            Site.objects.using(self.connection.alias).update(id=settings.SITE_ID)\n+\n+        from django.core.cache import get_cache\n+        from django.core.cache.backends.db import BaseDatabaseCache\n         for cache_alias in settings.CACHES:\n             cache = get_cache(cache_alias)\n             if isinstance(cache, BaseDatabaseCache):\n                 from django.db import router\n                 if router.allow_syncdb(self.connection.alias, cache.cache_model_class):\n                     call_command('createcachetable', cache._table, database=self.connection.alias)\n+\n         # Get a cursor (even though we don't need one yet). This has\n         # the side effect of initializing the test database.\n         cursor = self.connection.cursor()"
        },
        {
            "sha": "2ba54e5228cc5b685c94e4d410b42be6ce94e3c6",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -48,7 +48,7 @@ def get_dist_ops(operator):\n     return (SpatiaLiteDistance(operator),)\n \n class SpatiaLiteOperations(DatabaseOperations, BaseSpatialOperations):\n-    compiler_module = 'django.contrib.gis.db.models.sql.compiler'\n+    compiler_module = 'django.contrib.gis.db.backends.spatialite.compiler'\n     name = 'spatialite'\n     spatialite = True\n     version_regex = re.compile(r'^(?P<major>\\d)\\.(?P<minor1>\\d)\\.(?P<minor2>\\d+)')"
        },
        {
            "sha": "782ce78368451bb8a8ba019d99c17544592432ac",
            "filename": "django/contrib/gis/db/models/sql/compiler.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fsql%2Fcompiler.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -202,7 +202,7 @@ def resolve_columns(self, row, fields=()):\n     #### Routines unique to GeoQuery ####\n     def get_extra_select_format(self, alias):\n         sel_fmt = '%s'\n-        if alias in self.query.custom_select:\n+        if hasattr(self.query, 'custom_select') and alias in self.query.custom_select:\n             sel_fmt = sel_fmt % self.query.custom_select[alias]\n         return sel_fmt\n "
        },
        {
            "sha": "1ac830953a7687e8f2caec7b67a262b85e176610",
            "filename": "django/contrib/gis/tests/geoapp/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Fmodels.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -19,6 +19,7 @@ def __unicode__(self): return self.name\n # This is an inherited model from City\n class PennsylvaniaCity(City):\n     county = models.CharField(max_length=30)\n+    founded = models.DateTimeField(null=True)\n     objects = models.GeoManager() # TODO: This should be implicitly inherited.\n \n class State(models.Model):"
        },
        {
            "sha": "02b1ff08eb61c617c816f6349cd9aee46b05317c",
            "filename": "django/contrib/gis/tests/geoapp/test_regress.py",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftest_regress.py",
            "raw_url": "https://github.com/django/django/raw/43329af2e3f99e6dc39c6ae390b055aa180554ad/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftest_regress.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftest_regress.py?ref=43329af2e3f99e6dc39c6ae390b055aa180554ad",
            "patch": "@@ -1,9 +1,10 @@\n-import unittest\n+from datetime import datetime\n from django.contrib.gis.tests.utils import no_mysql, no_spatialite\n from django.contrib.gis.shortcuts import render_to_kmz\n-from models import City\n+from django.test import TestCase\n+from models import City, PennsylvaniaCity\n \n-class GeoRegressionTests(unittest.TestCase):\n+class GeoRegressionTests(TestCase):\n \n     def test01_update(self):\n         \"Testing GeoQuerySet.update(), see #10411.\"\n@@ -35,3 +36,10 @@ def test03_extent(self):\n         extent = City.objects.filter(name='Pueblo').extent()\n         for ref_val, val in zip(ref_ext, extent):\n             self.assertAlmostEqual(ref_val, val, 4)\n+\n+    def test04_unicode_date(self):\n+        \"Testing dates are converted properly, even on SpatiaLite, see #16408.\"\n+        founded = datetime(1857, 5, 23)\n+        mansfield = PennsylvaniaCity.objects.create(name='Mansfield', county='Tioga', point='POINT(-77.071445 41.823881)',\n+                                                    founded=founded)\n+        self.assertEqual(founded, PennsylvaniaCity.objects.dates('founded', 'day')[0])"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 93,
        "deletions": 13
    }
}