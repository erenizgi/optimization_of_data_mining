{
    "author": "aaugustin",
    "message": "Fixed #17535 -- Optimized list generic views.\n\nWhen allow_empty is False, prevented the view from loading\nthe entire queryset in memory when pagination is enabled.",
    "sha": "009e237cf0c25ce13e73d58feb54ef4f86e47e4e",
    "files": [
        {
            "sha": "00eadb71d517dc3823f78702df32b29d882ffdb2",
            "filename": "django/views/generic/dates.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/django%2Fviews%2Fgeneric%2Fdates.py",
            "raw_url": "https://github.com/django/django/raw/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/django%2Fviews%2Fgeneric%2Fdates.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Fdates.py?ref=009e237cf0c25ce13e73d58feb54ef4f86e47e4e",
            "patch": "@@ -273,7 +273,7 @@ def get_dated_queryset(self, **lookup):\n         if not allow_empty:\n             # When pagination is enabled, it's better to do a cheap query\n             # than to load the unpaginated queryset in memory.\n-            is_empty = not bool(qs) if paginate_by is None else not qs.exists()\n+            is_empty = len(qs) == 0 if paginate_by is None else not qs.exists()\n             if is_empty:\n                 raise Http404(_(u\"No %(verbose_name_plural)s available\") % {\n                         'verbose_name_plural': force_unicode(qs.model._meta.verbose_name_plural)"
        },
        {
            "sha": "50127066a1a78201f55c08a306096c74d91cf05c",
            "filename": "django/views/generic/list.py",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/django%2Fviews%2Fgeneric%2Flist.py",
            "raw_url": "https://github.com/django/django/raw/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/django%2Fviews%2Fgeneric%2Flist.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fgeneric%2Flist.py?ref=009e237cf0c25ce13e73d58feb54ef4f86e47e4e",
            "patch": "@@ -16,7 +16,7 @@ class MultipleObjectMixin(ContextMixin):\n \n     def get_queryset(self):\n         \"\"\"\n-        Get the list of items for this view. This must be an interable, and may\n+        Get the list of items for this view. This must be an iterable, and may\n         be a queryset (in which qs-specific behavior will be enabled).\n         \"\"\"\n         if self.queryset is not None:\n@@ -113,9 +113,19 @@ class BaseListView(MultipleObjectMixin, View):\n     def get(self, request, *args, **kwargs):\n         self.object_list = self.get_queryset()\n         allow_empty = self.get_allow_empty()\n-        if not allow_empty and len(self.object_list) == 0:\n-            raise Http404(_(u\"Empty list and '%(class_name)s.allow_empty' is False.\")\n-                          % {'class_name': self.__class__.__name__})\n+\n+        if not allow_empty:\n+            # When pagination is enabled and object_list is a queryset,\n+            # it's better to do a cheap query than to load the unpaginated\n+            # queryset in memory.\n+            if (self.get_paginate_by(self.object_list) is not None\n+                and hasattr(self.object_list, 'exists')):\n+                is_empty = not self.object_list.exists()\n+            else:\n+                is_empty = len(self.object_list) == 0\n+            if is_empty:\n+                raise Http404(_(u\"Empty list and '%(class_name)s.allow_empty' is False.\")\n+                        % {'class_name': self.__class__.__name__})\n         context = self.get_context_data(object_list=self.object_list)\n         return self.render_to_response(context)\n "
        },
        {
            "sha": "b925758524f8849df2d9a6c9499cd95a56ee98a4",
            "filename": "tests/regressiontests/generic_views/list.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/tests%2Fregressiontests%2Fgeneric_views%2Flist.py",
            "raw_url": "https://github.com/django/django/raw/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/tests%2Fregressiontests%2Fgeneric_views%2Flist.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Flist.py?ref=009e237cf0c25ce13e73d58feb54ef4f86e47e4e",
            "patch": "@@ -159,6 +159,16 @@ def test_duplicate_context_object_name(self):\n     def test_missing_items(self):\n         self.assertRaises(ImproperlyConfigured, self.client.get, '/list/authors/invalid/')\n \n+    def test_paginated_list_view_does_not_load_entire_table(self):\n+        # Regression test for #17535\n+        self._make_authors(3)\n+        # 1 query for authors\n+        with self.assertNumQueries(1):\n+            self.client.get('/list/authors/notempty/')\n+        # same as above + 1 query to test if authors exist + 1 query for pagination\n+        with self.assertNumQueries(3):\n+            self.client.get('/list/authors/notempty/paginated/')\n+\n     def _make_authors(self, n):\n         Author.objects.all().delete()\n         for i in range(n):"
        },
        {
            "sha": "20432f9b6a76d8b1cfdc1da7b17e4e86e36ad7a2",
            "filename": "tests/regressiontests/generic_views/urls.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/tests%2Fregressiontests%2Fgeneric_views%2Furls.py",
            "raw_url": "https://github.com/django/django/raw/009e237cf0c25ce13e73d58feb54ef4f86e47e4e/tests%2Fregressiontests%2Fgeneric_views%2Furls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fgeneric_views%2Furls.py?ref=009e237cf0c25ce13e73d58feb54ef4f86e47e4e",
            "patch": "@@ -128,6 +128,8 @@\n         views.AuthorList.as_view(paginate_by=30)),\n     (r'^list/authors/notempty/$',\n         views.AuthorList.as_view(allow_empty=False)),\n+    (r'^list/authors/notempty/paginated/$',\n+        views.AuthorList.as_view(allow_empty=False, paginate_by=2)),\n     (r'^list/authors/template_name/$',\n         views.AuthorList.as_view(template_name='generic_views/list.html')),\n     (r'^list/authors/template_name_suffix/$',"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 27,
        "deletions": 5
    }
}