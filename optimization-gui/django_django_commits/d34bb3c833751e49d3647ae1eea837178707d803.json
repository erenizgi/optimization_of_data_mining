{
    "author": "jezdez",
    "message": "Fixed #16108 -- Fixed another race condition in the FileSystemStorage backend with regard to deleting a file. Refs #16082, too. Thanks, Aymeric Augustin.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16287 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d34bb3c833751e49d3647ae1eea837178707d803",
    "files": [
        {
            "sha": "75901712592e34c24cfefc65b86f7c7a889e34d1",
            "filename": "django/core/files/storage.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/d34bb3c833751e49d3647ae1eea837178707d803/django%2Fcore%2Ffiles%2Fstorage.py",
            "raw_url": "https://github.com/django/django/raw/d34bb3c833751e49d3647ae1eea837178707d803/django%2Fcore%2Ffiles%2Fstorage.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Ffiles%2Fstorage.py?ref=d34bb3c833751e49d3647ae1eea837178707d803",
            "patch": "@@ -219,8 +219,15 @@ def _save(self, name, content):\n     def delete(self, name):\n         name = self.path(name)\n         # If the file exists, delete it from the filesystem.\n+        # Note that there is a race between os.path.exists and os.remove:\n+        # if os.remove fails with ENOENT, the file was removed\n+        # concurrently, and we can continue normally.\n         if os.path.exists(name):\n-            os.remove(name)\n+            try:\n+                os.remove(name)\n+            except OSError, e:\n+                if e.errno != errno.ENOENT:\n+                    raise\n \n     def exists(self, name):\n         return os.path.exists(self.path(name))"
        },
        {
            "sha": "917d2f36fcbc0a4dc97b7cb5c83de5d0148b3742",
            "filename": "tests/regressiontests/file_storage/tests.py",
            "status": "modified",
            "additions": 42,
            "deletions": 5,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/d34bb3c833751e49d3647ae1eea837178707d803/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d34bb3c833751e49d3647ae1eea837178707d803/tests%2Fregressiontests%2Ffile_storage%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_storage%2Ftests.py?ref=d34bb3c833751e49d3647ae1eea837178707d803",
            "patch": "@@ -304,20 +304,21 @@ def test_makedirs_race_handling(self):\n         \"\"\"\n         File storage should be robust against directory creation race conditions.\n         \"\"\"\n+        real_makedirs = os.makedirs\n+\n         # Monkey-patch os.makedirs, to simulate a normal call, a raced call,\n         # and an error.\n         def fake_makedirs(path):\n             if path == os.path.join(self.temp_dir, 'normal'):\n-                os.mkdir(path)\n+                real_makedirs(path)\n             elif path == os.path.join(self.temp_dir, 'raced'):\n-                os.mkdir(path)\n+                real_makedirs(path)\n                 raise OSError(errno.EEXIST, 'simulated EEXIST')\n             elif path == os.path.join(self.temp_dir, 'error'):\n                 raise OSError(errno.EACCES, 'simulated EACCES')\n             else:\n                 self.fail('unexpected argument %r' % path)\n \n-        real_makedirs = os.makedirs\n         try:\n             os.makedirs = fake_makedirs\n \n@@ -333,11 +334,47 @@ def fake_makedirs(path):\n \n             # Check that OSErrors aside from EEXIST are still raised.\n             self.assertRaises(OSError,\n-                lambda: self.storage.save('error/test.file',\n-                    ContentFile('not saved')))\n+                self.storage.save, 'error/test.file', ContentFile('not saved'))\n         finally:\n             os.makedirs = real_makedirs\n \n+    def test_remove_race_handling(self):\n+        \"\"\"\n+        File storage should be robust against file removal race conditions.\n+        \"\"\"\n+        real_remove = os.remove\n+\n+        # Monkey-patch os.remove, to simulate a normal call, a raced call,\n+        # and an error.\n+        def fake_remove(path):\n+            if path == os.path.join(self.temp_dir, 'normal.file'):\n+                real_remove(path)\n+            elif path == os.path.join(self.temp_dir, 'raced.file'):\n+                real_remove(path)\n+                raise OSError(errno.ENOENT, 'simulated ENOENT')\n+            elif path == os.path.join(self.temp_dir, 'error.file'):\n+                raise OSError(errno.EACCES, 'simulated EACCES')\n+            else:\n+                self.fail('unexpected argument %r' % path)\n+\n+        try:\n+            os.remove = fake_remove\n+\n+            self.storage.save('normal.file', ContentFile('delete normally'))\n+            self.storage.delete('normal.file')\n+            self.assertFalse(self.storage.exists('normal.file'))\n+\n+            self.storage.save('raced.file', ContentFile('delete with race'))\n+            self.storage.delete('raced.file')\n+            self.assertFalse(self.storage.exists('normal.file'))\n+\n+            # Check that OSErrors aside from ENOENT are still raised.\n+            self.storage.save('error.file', ContentFile('delete with error'))\n+            self.assertRaises(OSError, self.storage.delete, 'error.file')\n+        finally:\n+            os.remove = real_remove\n+\n+\n class CustomStorage(FileSystemStorage):\n     def get_available_name(self, name):\n         \"\"\""
        }
    ],
    "stats": {
        "total": 56,
        "additions": 50,
        "deletions": 6
    }
}