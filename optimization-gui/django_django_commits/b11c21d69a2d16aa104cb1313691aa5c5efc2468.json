{
    "author": "freakboy3742",
    "message": "Fixed #14799 -- Provided a full solution for test database creation order problems.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14822 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b11c21d69a2d16aa104cb1313691aa5c5efc2468",
    "files": [
        {
            "sha": "3c94ebc64e8f19e871d35e0bfa9752c790d9d359",
            "filename": "django/test/simple.py",
            "status": "modified",
            "additions": 53,
            "deletions": 13,
            "changes": 66,
            "blob_url": "https://github.com/django/django/blob/b11c21d69a2d16aa104cb1313691aa5c5efc2468/django%2Ftest%2Fsimple.py",
            "raw_url": "https://github.com/django/django/raw/b11c21d69a2d16aa104cb1313691aa5c5efc2468/django%2Ftest%2Fsimple.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsimple.py?ref=b11c21d69a2d16aa104cb1313691aa5c5efc2468",
            "patch": "@@ -2,12 +2,21 @@\n import signal\n \n from django.conf import settings\n+from django.core.exceptions import ImproperlyConfigured\n from django.db.models import get_app, get_apps\n from django.test import _doctest as doctest\n from django.test.utils import setup_test_environment, teardown_test_environment\n from django.test.testcases import OutputChecker, DocTestRunner, TestCase\n from django.utils import unittest\n \n+try:\n+    all\n+except NameError:\n+    from django.utils.itercompat import all\n+\n+\n+__all__ = ('DjangoTestRunner', 'DjangoTestSuiteRunner', 'run_tests')\n+\n # The module name for tests outside models.py\n TEST_MODULE = 'tests'\n \n@@ -183,6 +192,40 @@ def reorder_suite(suite, classes):\n         bins[0].addTests(bins[i+1])\n     return bins[0]\n \n+def dependency_ordered(test_databases, dependencies):\n+    \"\"\"Reorder test_databases into an order that honors the dependencies\n+    described in TEST_DEPENDENCIES.\n+    \"\"\"\n+    ordered_test_databases = []\n+    resolved_databases = set()\n+    while test_databases:\n+        changed = False\n+        deferred = []\n+\n+        while test_databases:\n+            signature, aliases = test_databases.pop()\n+            dependencies_satisfied = True\n+            for alias in aliases:\n+                if alias in dependencies:\n+                    if all(a in resolved_databases for a in dependencies[alias]):\n+                        # all dependencies for this alias are satisfied\n+                        dependencies.pop(alias)\n+                        resolved_databases.add(alias)\n+                    else:\n+                        dependencies_satisfied = False\n+                else:\n+                    resolved_databases.add(alias)\n+\n+            if dependencies_satisfied:\n+                ordered_test_databases.append((signature, aliases))\n+                changed = True\n+            else:\n+                deferred.append((signature, aliases))\n+\n+        if not changed:\n+            raise ImproperlyConfigured(\"Circular dependency in TEST_DEPENDENCIES\")\n+        test_databases = deferred\n+    return ordered_test_databases\n \n class DjangoTestSuiteRunner(object):\n     def __init__(self, verbosity=1, interactive=True, failfast=True, **kwargs):\n@@ -222,6 +265,7 @@ def setup_databases(self, **kwargs):\n         # and which ones are test mirrors or duplicate entries in DATABASES\n         mirrored_aliases = {}\n         test_databases = {}\n+        dependencies = {}\n         for alias in connections:\n             connection = connections[alias]\n             if connection.settings_dict['TEST_MIRROR']:\n@@ -238,21 +282,17 @@ def setup_databases(self, **kwargs):\n                         connection.settings_dict['ENGINE'],\n                         connection.settings_dict['NAME'],\n                     ), []).append(alias)\n-        \n-        # Re-order the list of databases to create, making sure the default\n-        # database is first. Otherwise, creation order is semi-random (i.e. \n-        # dict ordering dependent).\n-        dbs_to_create = []\n-        for dbinfo, aliases in test_databases.items():\n-            if DEFAULT_DB_ALIAS in aliases:\n-                dbs_to_create.insert(0, (dbinfo, aliases))\n-            else:\n-                dbs_to_create.append((dbinfo, aliases))\n-                \n-        # Final pass -- actually create the databases.\n+\n+                if 'TEST_DEPENDENCIES' in connection.settings_dict:\n+                    dependencies[alias] = connection.settings_dict['TEST_DEPENDENCIES']\n+                else:\n+                    if alias != 'default':\n+                        dependencies[alias] = connection.settings_dict.get('TEST_DEPENDENCIES', ['default'])\n+\n+        # Second pass -- actually create the databases.\n         old_names = []\n         mirrors = []\n-        for (host, port, engine, db_name), aliases in dbs_to_create:\n+        for (host, port, engine, db_name), aliases in dependency_ordered(test_databases.items(), dependencies):\n             # Actually create the database for the first connection\n             connection = connections[aliases[0]]\n             old_names.append((connection, db_name, True))"
        },
        {
            "sha": "e56e577f3bf09aee63740f3c3cec39ce440517a6",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/b11c21d69a2d16aa104cb1313691aa5c5efc2468/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/b11c21d69a2d16aa104cb1313691aa5c5efc2468/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=b11c21d69a2d16aa104cb1313691aa5c5efc2468",
            "patch": "@@ -454,6 +454,53 @@ will be redirected to point at ``default``. As a result, writes to\n the same database, not because there is data replication between the\n two databases.\n \n+.. _topics-testing-creation-dependencies:\n+\n+Controlling creation order for test databases\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+.. versionadded:: 1.3\n+\n+By default, Django will always create the ``default`` database first.\n+However, no guarantees are made on the creation order of any other\n+databases in your test setup.\n+\n+If your database configuration requires a specific creation order, you\n+can specify the dependencies that exist using the\n+:setting:`TEST_DEPENDENCIES` setting. Consider the following\n+(simplified) example database configuration::\n+\n+    DATABASES = {\n+        'default': {\n+             # ... db settings\n+             TEST_DEPENDENCIES = ['diamonds']\n+        },\n+        'diamonds': {\n+            # ... db settings\n+        }\n+        'clubs': {\n+            # ... db settings\n+            TEST_DEPENDENCIES = ['diamonds']\n+        }\n+        'spades': {\n+            # ... db settings\n+            TEST_DEPENDENCIES = ['diamonds','hearts']\n+        }\n+        'hearts': {\n+            # ... db settings\n+            TEST_DEPENDENCIES = ['diamonds','clubs']\n+        }\n+    }\n+\n+Under this configuration, the ``diamonds`` database will be created first,\n+as it is the only database alias without dependencies. The ``default``` and\n+``clubs`` alias will be created next (although the order of creation of this\n+pair is not guaranteed); then ``hearts``; and finally ``spades``.\n+\n+If there are any circular dependencies in the\n+:setting:`TEST_DEPENDENCIES` definition, an ``ImproperlyConfigured``\n+exception will be raised.\n+\n Other test conditions\n ---------------------\n "
        },
        {
            "sha": "b34c455a31edb5e958ff2687688fa6558976527c",
            "filename": "tests/regressiontests/test_runner/tests.py",
            "status": "modified",
            "additions": 91,
            "deletions": 0,
            "changes": 91,
            "blob_url": "https://github.com/django/django/blob/b11c21d69a2d16aa104cb1313691aa5c5efc2468/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b11c21d69a2d16aa104cb1313691aa5c5efc2468/tests%2Fregressiontests%2Ftest_runner%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftest_runner%2Ftests.py?ref=b11c21d69a2d16aa104cb1313691aa5c5efc2468",
            "patch": "@@ -3,6 +3,7 @@\n \"\"\"\n import StringIO\n \n+from django.core.exceptions import ImproperlyConfigured\n from django.test import simple\n from django.utils import unittest\n \n@@ -27,3 +28,93 @@ def runTest(self):\n         result = dtr.run(suite)\n         self.assertEqual(1, result.testsRun)\n         self.assertEqual(1, len(result.failures))\n+\n+class DependencyOrderingTests(unittest.TestCase):\n+\n+    def test_simple_dependencies(self):\n+        raw = [\n+            ('s1', ['alpha']),\n+            ('s2', ['bravo']),\n+            ('s3', ['charlie']),\n+        ]\n+        dependencies = {\n+            'alpha': ['charlie'],\n+            'bravo': ['charlie'],\n+        }\n+\n+        ordered = simple.dependency_ordered(raw, dependencies=dependencies)\n+        ordered_sigs = [sig for sig,aliases in ordered]\n+\n+        self.assertIn('s1', ordered_sigs)\n+        self.assertIn('s2', ordered_sigs)\n+        self.assertIn('s3', ordered_sigs)\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s1'))\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s2'))\n+\n+    def test_chained_dependencies(self):\n+        raw = [\n+            ('s1', ['alpha']),\n+            ('s2', ['bravo']),\n+            ('s3', ['charlie']),\n+        ]\n+        dependencies = {\n+            'alpha': ['bravo'],\n+            'bravo': ['charlie'],\n+        }\n+\n+        ordered = simple.dependency_ordered(raw, dependencies=dependencies)\n+        ordered_sigs = [sig for sig,aliases in ordered]\n+\n+        self.assertIn('s1', ordered_sigs)\n+        self.assertIn('s2', ordered_sigs)\n+        self.assertIn('s3', ordered_sigs)\n+\n+        # Explicit dependencies\n+        self.assertLess(ordered_sigs.index('s2'), ordered_sigs.index('s1'))\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s2'))\n+\n+        # Implied dependencies\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s1'))\n+\n+    def test_multiple_dependencies(self):\n+        raw = [\n+            ('s1', ['alpha']),\n+            ('s2', ['bravo']),\n+            ('s3', ['charlie']),\n+            ('s4', ['delta']),\n+        ]\n+        dependencies = {\n+            'alpha': ['bravo','delta'],\n+            'bravo': ['charlie'],\n+            'delta': ['charlie'],\n+        }\n+\n+        ordered = simple.dependency_ordered(raw, dependencies=dependencies)\n+        ordered_sigs = [sig for sig,aliases in ordered]\n+\n+        self.assertIn('s1', ordered_sigs)\n+        self.assertIn('s2', ordered_sigs)\n+        self.assertIn('s3', ordered_sigs)\n+        self.assertIn('s4', ordered_sigs)\n+\n+        # Explicit dependencies\n+        self.assertLess(ordered_sigs.index('s2'), ordered_sigs.index('s1'))\n+        self.assertLess(ordered_sigs.index('s4'), ordered_sigs.index('s1'))\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s2'))\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s4'))\n+\n+        # Implicit dependencies\n+        self.assertLess(ordered_sigs.index('s3'), ordered_sigs.index('s1'))\n+\n+    def test_circular_dependencies(self):\n+        raw = [\n+            ('s1', ['alpha']),\n+            ('s2', ['bravo']),\n+        ]\n+        dependencies = {\n+            'bravo': ['alpha'],\n+            'alpha': ['bravo'],\n+        }\n+\n+        self.assertRaises(ImproperlyConfigured, simple.dependency_ordered, raw, dependencies=dependencies)\n+"
        }
    ],
    "stats": {
        "total": 204,
        "additions": 191,
        "deletions": 13
    }
}