{
    "author": "andrewgodwin",
    "message": "Fixed #16182: Increase timestamp precision on TimestampSigner. Thanks to Eric Florenzano.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16356 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "44a2cbad35c9b43569ad3dcf43a3dd74dcd71953",
    "files": [
        {
            "sha": "3165cf8a381c0c7d7e4ccc18432b141f449ed4a1",
            "filename": "django/core/signing.py",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/44a2cbad35c9b43569ad3dcf43a3dd74dcd71953/django%2Fcore%2Fsigning.py",
            "raw_url": "https://github.com/django/django/raw/44a2cbad35c9b43569ad3dcf43a3dd74dcd71953/django%2Fcore%2Fsigning.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fsigning.py?ref=44a2cbad35c9b43569ad3dcf43a3dd74dcd71953",
            "patch": "@@ -158,8 +158,12 @@ def unsign(self, signed_value):\n \n \n class TimestampSigner(Signer):\n+    def __init__(self, *args, **kwargs):\n+        self.time_func = kwargs.pop('time', time.time)\n+        super(TimestampSigner, self).__init__(*args, **kwargs)\n+    \n     def timestamp(self):\n-        return baseconv.base62.encode(int(time.time()))\n+        return baseconv.base62.encode(int(self.time_func() * 10000))\n \n     def sign(self, value):\n         value = smart_str('%s%s%s' % (value, self.sep, self.timestamp()))\n@@ -168,10 +172,10 @@ def sign(self, value):\n     def unsign(self, value, max_age=None):\n         result =  super(TimestampSigner, self).unsign(value)\n         value, timestamp = result.rsplit(self.sep, 1)\n-        timestamp = baseconv.base62.decode(timestamp)\n+        timestamp = baseconv.base62.decode(timestamp) / 10000.0\n         if max_age is not None:\n             # Check timestamp is not older than max_age\n-            age = time.time() - timestamp\n+            age = self.time_func() - timestamp\n             if age > max_age:\n                 raise SignatureExpired(\n                     'Signature age %s > %s seconds' % (age, max_age))"
        },
        {
            "sha": "bc162146004d51c33837888cd20d1fa104e616e5",
            "filename": "tests/regressiontests/signing/tests.py",
            "status": "modified",
            "additions": 17,
            "deletions": 17,
            "changes": 34,
            "blob_url": "https://github.com/django/django/blob/44a2cbad35c9b43569ad3dcf43a3dd74dcd71953/tests%2Fregressiontests%2Fsigning%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/44a2cbad35c9b43569ad3dcf43a3dd74dcd71953/tests%2Fregressiontests%2Fsigning%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsigning%2Ftests.py?ref=44a2cbad35c9b43569ad3dcf43a3dd74dcd71953",
            "patch": "@@ -1,5 +1,3 @@\n-import time\n-\n from django.core import signing\n from django.test import TestCase\n from django.utils.encoding import force_unicode\n@@ -98,19 +96,21 @@ class TestTimestampSigner(TestCase):\n \n     def test_timestamp_signer(self):\n         value = u'hello'\n-        _time = time.time\n-        time.time = lambda: 123456789\n-        try:\n-            signer = signing.TimestampSigner('predictable-key')\n-            ts = signer.sign(value)\n-            self.assertNotEqual(ts,\n-                signing.Signer('predictable-key').sign(value))\n+        signer = signing.TimestampSigner('predictable-key',\n+            time=lambda: 123456789)\n+        ts = signer.sign(value)\n+        self.assertNotEqual(ts,\n+            signing.Signer('predictable-key').sign(value))\n \n-            self.assertEqual(signer.unsign(ts), value)\n-            time.time = lambda: 123456800\n-            self.assertEqual(signer.unsign(ts, max_age=12), value)\n-            self.assertEqual(signer.unsign(ts, max_age=11), value)\n-            self.assertRaises(\n-                signing.SignatureExpired, signer.unsign, ts, max_age=10)\n-        finally:\n-            time.time = _time\n+        self.assertEqual(signer.unsign(ts), value)\n+        signer = signing.TimestampSigner('predictable-key',\n+            time=lambda: 123456800)\n+        self.assertEqual(signer.unsign(ts, max_age=12), value)\n+        self.assertEqual(signer.unsign(ts, max_age=11), value)\n+        self.assertRaises(\n+            signing.SignatureExpired, signer.unsign, ts, max_age=10)\n+    \n+    def test_timestamp_precision(self):\n+        one = signing.TimestampSigner('key', time=lambda: 123.4567).sign('v')\n+        two = signing.TimestampSigner('key', time=lambda: 123.4568).sign('v')\n+        self.assertNotEqual(one, two)"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 24,
        "deletions": 20
    }
}