{
    "author": "freakboy3742",
    "message": "Added protection against spoofing of X_FORWARDED_HOST headers. A security announcement will be made shortly.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16758 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "893cea211ae88c6f68a6c2c281890d6f63541286",
    "files": [
        {
            "sha": "637b5f4d65e28cad127f183ab85b39624a39f7b3",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/893cea211ae88c6f68a6c2c281890d6f63541286/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/893cea211ae88c6f68a6c2c281890d6f63541286/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=893cea211ae88c6f68a6c2c281890d6f63541286",
            "patch": "@@ -402,6 +402,8 @@\n # Default X-Frame-Options header value\n X_FRAME_OPTIONS = 'SAMEORIGIN'\n \n+USE_X_FORWARDED_HOST = False\n+\n ##############\n # MIDDLEWARE #\n ##############"
        },
        {
            "sha": "5a68e03d9dcfb50c04942cc51fa0c6ffc2eeee3d",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/893cea211ae88c6f68a6c2c281890d6f63541286/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/893cea211ae88c6f68a6c2c281890d6f63541286/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=893cea211ae88c6f68a6c2c281890d6f63541286",
            "patch": "@@ -194,7 +194,8 @@ def __repr__(self):\n     def get_host(self):\n         \"\"\"Returns the HTTP host using the environment or request headers.\"\"\"\n         # We try three options, in order of decreasing preference.\n-        if 'HTTP_X_FORWARDED_HOST' in self.META:\n+        if settings.USE_X_FORWARDED_HOST and (\n+            'HTTP_X_FORWARDED_HOST' in self.META):\n             host = self.META['HTTP_X_FORWARDED_HOST']\n         elif 'HTTP_HOST' in self.META:\n             host = self.META['HTTP_HOST']"
        },
        {
            "sha": "88b3d771ef2dc080b151b42d896039f1e7fe00d1",
            "filename": "docs/ref/request-response.txt",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/893cea211ae88c6f68a6c2c281890d6f63541286/docs%2Fref%2Frequest-response.txt",
            "raw_url": "https://github.com/django/django/raw/893cea211ae88c6f68a6c2c281890d6f63541286/docs%2Fref%2Frequest-response.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Frequest-response.txt?ref=893cea211ae88c6f68a6c2c281890d6f63541286",
            "patch": "@@ -193,10 +193,11 @@ Methods\n \n .. method:: HttpRequest.get_host()\n \n-    Returns the originating host of the request using information from the\n-    ``HTTP_X_FORWARDED_HOST`` and ``HTTP_HOST`` headers (in that order). If\n-    they don't provide a value, the method uses a combination of\n-    ``SERVER_NAME`` and ``SERVER_PORT`` as detailed in :pep:`3333`.\n+    Returns the originating host of the request using information from\n+    the ``HTTP_X_FORWARDED_HOST`` (if enabled in the settings) and ``HTTP_HOST``\n+    headers (in that order). If they don't provide a value, the method\n+    uses a combination of ``SERVER_NAME`` and ``SERVER_PORT`` as\n+    detailed in :pep:`3333`.\n \n     Example: ``\"127.0.0.1:8000\"``\n "
        },
        {
            "sha": "756799114d7a44799d635de88962ee343ac1d6b2",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/893cea211ae88c6f68a6c2c281890d6f63541286/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/893cea211ae88c6f68a6c2c281890d6f63541286/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=893cea211ae88c6f68a6c2c281890d6f63541286",
            "patch": "@@ -2078,6 +2078,19 @@ When :setting:`USE_L10N` is set to ``True`` and if this is also set to\n See also :setting:`DECIMAL_SEPARATOR`, :setting:`NUMBER_GROUPING` and\n :setting:`THOUSAND_SEPARATOR`.\n \n+.. setting:: USE_X_FORWARDED_HOST\n+\n+USE_X_FORWARDED_HOST\n+--------------------\n+\n+.. versionadded:: 1.3.1\n+\n+Default: ``False``\n+\n+A boolean that specifies whether to use the X-Forwarded-Host header in\n+preference to the Host header. This should only be enabled if a proxy\n+which sets this header is in use.\n+\n .. setting:: YEAR_MONTH_FORMAT\n \n YEAR_MONTH_FORMAT\n@@ -2135,4 +2148,4 @@ IGNORABLE_404_STARTS\n --------------------\n \n .. deprecated:: 1.4\n-   This setting has been superseded by :setting:`IGNORABLE_404_URLS`.\n\\ No newline at end of file\n+   This setting has been superseded by :setting:`IGNORABLE_404_URLS`."
        },
        {
            "sha": "a7cfa02ee2a89ecc4f66c8b8213258a41c9700c3",
            "filename": "docs/topics/security.txt",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/893cea211ae88c6f68a6c2c281890d6f63541286/docs%2Ftopics%2Fsecurity.txt",
            "raw_url": "https://github.com/django/django/raw/893cea211ae88c6f68a6c2c281890d6f63541286/docs%2Ftopics%2Fsecurity.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fsecurity.txt?ref=893cea211ae88c6f68a6c2c281890d6f63541286",
            "patch": "@@ -145,6 +145,23 @@ information is not leaked:\n \n .. _additional-security-topics:\n \n+Host Headers and Virtual Hosting\n+================================\n+\n+Django uses the Host header provided by the client to construct URLs\n+in certain cases. While these values are sanitized to prevent Cross\n+Site Scripting attacks, they can be used for Cross-Site Request\n+Forgery and cache poisoning attacks in some circumstances. We\n+recommend that users of Django ensure their web-server configuration\n+always validates incoming HTTP Host headers against the expected host\n+name, disallows requests with no Host header, and that the web server\n+not be configured with a catch-all virtual host which forwards\n+requests to a Django application.\n+\n+Additionally, as of 1.3.1, Django requires users to explicitly enable\n+support for the X-Forwarded-Host header if their configuration\n+requires it.\n+\n Additional security topics\n ==========================\n "
        },
        {
            "sha": "e96f3129be1312c70f2f874716dc7721348bf219",
            "filename": "tests/regressiontests/requests/tests.py",
            "status": "modified",
            "additions": 90,
            "deletions": 0,
            "changes": 90,
            "blob_url": "https://github.com/django/django/blob/893cea211ae88c6f68a6c2c281890d6f63541286/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/893cea211ae88c6f68a6c2c281890d6f63541286/tests%2Fregressiontests%2Frequests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Frequests%2Ftests.py?ref=893cea211ae88c6f68a6c2c281890d6f63541286",
            "patch": "@@ -2,12 +2,14 @@\n from datetime import datetime, timedelta\n from StringIO import StringIO\n \n+from django.conf import settings\n from django.core.handlers.modpython import ModPythonRequest\n from django.core.handlers.wsgi import WSGIRequest, LimitedStream\n from django.http import HttpRequest, HttpResponse, parse_cookie, build_request_repr\n from django.utils import unittest\n from django.utils.http import cookie_date\n \n+\n class RequestsTests(unittest.TestCase):\n     def test_httprequest(self):\n         request = HttpRequest()\n@@ -97,6 +99,94 @@ def test_httprequest_location(self):\n         self.assertEqual(request.build_absolute_uri(location=\"/path/with:colons\"),\n             'http://www.example.com/path/with:colons')\n \n+    def test_http_get_host(self):\n+        old_USE_X_FORWARDED_HOST = settings.USE_X_FORWARDED_HOST\n+        try:\n+            settings.USE_X_FORWARDED_HOST = False\n+\n+            # Check if X_FORWARDED_HOST is provided.\n+            request = HttpRequest()\n+            request.META = {\n+                u'HTTP_X_FORWARDED_HOST': u'forward.com',\n+                u'HTTP_HOST': u'example.com',\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 80,\n+            }\n+            # X_FORWARDED_HOST is ignored.\n+            self.assertEqual(request.get_host(), 'example.com')\n+\n+            # Check if X_FORWARDED_HOST isn't provided.\n+            request = HttpRequest()\n+            request.META = {\n+                u'HTTP_HOST': u'example.com',\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 80,\n+            }\n+            self.assertEqual(request.get_host(), 'example.com')\n+\n+            # Check if HTTP_HOST isn't provided.\n+            request = HttpRequest()\n+            request.META = {\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 80,\n+            }\n+            self.assertEqual(request.get_host(), 'internal.com')\n+\n+            # Check if HTTP_HOST isn't provided, and we're on a nonstandard port\n+            request = HttpRequest()\n+            request.META = {\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 8042,\n+            }\n+            self.assertEqual(request.get_host(), 'internal.com:8042')\n+\n+        finally:\n+            settings.USE_X_FORWARDED_HOST = old_USE_X_FORWARDED_HOST\n+\n+    def test_http_get_host_with_x_forwarded_host(self):\n+        old_USE_X_FORWARDED_HOST = settings.USE_X_FORWARDED_HOST\n+        try:\n+            settings.USE_X_FORWARDED_HOST = True\n+\n+            # Check if X_FORWARDED_HOST is provided.\n+            request = HttpRequest()\n+            request.META = {\n+                u'HTTP_X_FORWARDED_HOST': u'forward.com',\n+                u'HTTP_HOST': u'example.com',\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 80,\n+            }\n+            # X_FORWARDED_HOST is obeyed.\n+            self.assertEqual(request.get_host(), 'forward.com')\n+\n+            # Check if X_FORWARDED_HOST isn't provided.\n+            request = HttpRequest()\n+            request.META = {\n+                u'HTTP_HOST': u'example.com',\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 80,\n+            }\n+            self.assertEqual(request.get_host(), 'example.com')\n+\n+            # Check if HTTP_HOST isn't provided.\n+            request = HttpRequest()\n+            request.META = {\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 80,\n+            }\n+            self.assertEqual(request.get_host(), 'internal.com')\n+\n+            # Check if HTTP_HOST isn't provided, and we're on a nonstandard port\n+            request = HttpRequest()\n+            request.META = {\n+                u'SERVER_NAME': u'internal.com',\n+                u'SERVER_PORT': 8042,\n+            }\n+            self.assertEqual(request.get_host(), 'internal.com:8042')\n+\n+        finally:\n+            settings.USE_X_FORWARDED_HOST = old_USE_X_FORWARDED_HOST\n+\n     def test_near_expiration(self):\n         \"Cookie will expire when an near expiration time is provided\"\n         response = HttpResponse()"
        }
    ],
    "stats": {
        "total": 136,
        "additions": 130,
        "deletions": 6
    }
}