{
    "author": "aaugustin",
    "message": "Fixed #17158 -- Used a non-ambiguous representation of SQL queries\n\nwhen a correct representation cannot be obtained.",
    "sha": "6605ac331a9e03fa41c301d122c5727c0d98b970",
    "files": [
        {
            "sha": "7dc545682751009c68699b718b54925e10b657f5",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/6605ac331a9e03fa41c301d122c5727c0d98b970/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/6605ac331a9e03fa41c301d122c5727c0d98b970/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=6605ac331a9e03fa41c301d122c5727c0d98b970",
            "patch": "@@ -614,11 +614,11 @@ def last_executed_query(self, cursor, sql, params):\n         # Convert params to contain Unicode values.\n         to_unicode = lambda s: force_text(s, strings_only=True, errors='replace')\n         if isinstance(params, (list, tuple)):\n-            u_params = tuple([to_unicode(val) for val in params])\n+            u_params = tuple(to_unicode(val) for val in params)\n         else:\n-            u_params = dict([(to_unicode(k), to_unicode(v)) for k, v in params.items()])\n+            u_params = dict((to_unicode(k), to_unicode(v)) for k, v in params.items())\n \n-        return force_text(sql) % u_params\n+        return six.text_type(\"QUERY = %r - PARAMS = %r\") % (sql, u_params)\n \n     def last_insert_id(self, cursor, table_name, pk_name):\n         \"\"\""
        },
        {
            "sha": "313fdc83513b30f45dc5efdeae2e9d25d8fc40d3",
            "filename": "tests/regressiontests/backends/tests.py",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/6605ac331a9e03fa41c301d122c5727c0d98b970/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/6605ac331a9e03fa41c301d122c5727c0d98b970/tests%2Fregressiontests%2Fbackends%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbackends%2Ftests.py?ref=6605ac331a9e03fa41c301d122c5727c0d98b970",
            "patch": "@@ -16,7 +16,7 @@\n from django.db.utils import ConnectionHandler, DatabaseError, load_backend\n from django.test import (TestCase, skipUnlessDBFeature, skipIfDBFeature,\n     TransactionTestCase)\n-from django.test.utils import override_settings\n+from django.test.utils import override_settings, str_prefix\n from django.utils import six\n from django.utils.six.moves import xrange\n from django.utils import unittest\n@@ -160,24 +160,34 @@ def test_django_extract(self):\n         self.assertEqual(len(classes), 1)\n \n \n+@override_settings(DEBUG=True)\n class LastExecutedQueryTest(TestCase):\n-    @override_settings(DEBUG=True)\n+\n     def test_debug_sql(self):\n         list(models.Tag.objects.filter(name=\"test\"))\n         sql = connection.queries[-1]['sql'].lower()\n-        self.assertTrue(sql.startswith(\"select\"))\n+        self.assertIn(\"select\", sql)\n         self.assertIn(models.Tag._meta.db_table, sql)\n \n     def test_query_encoding(self):\n         \"\"\"\n         Test that last_executed_query() returns an Unicode string\n         \"\"\"\n-        tags = models.Tag.objects.extra(select={'föö':1})\n+        tags = models.Tag.objects.extra(select={'föö': 1})\n         sql, params = tags.query.sql_with_params()\n         cursor = tags.query.get_compiler('default').execute_sql(None)\n         last_sql = cursor.db.ops.last_executed_query(cursor, sql, params)\n         self.assertTrue(isinstance(last_sql, six.text_type))\n \n+    @unittest.skipUnless(connection.vendor == 'sqlite',\n+                         \"This test is specific to SQLite.\")\n+    def test_no_interpolation_on_sqlite(self):\n+        # Regression for #17158\n+        # This shouldn't raise an exception\n+        query = \"SELECT strftime('%Y', 'now');\"\n+        connection.cursor().execute(query)\n+        self.assertEqual(connection.queries[-1]['sql'],\n+            str_prefix(\"QUERY = %(_)s\\\"SELECT strftime('%%Y', 'now');\\\" - PARAMS = ()\"))\n \n class ParameterHandlingTest(TestCase):\n     def test_bad_parameter_count(self):"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 17,
        "deletions": 7
    }
}