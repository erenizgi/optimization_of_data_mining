{
    "author": "SmileyChris",
    "message": "Fixes #15721 -- Make {% include %} and RequestContext work together again.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16031 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "d59baa07f056b60942052b4809d71eecd323837a",
    "files": [
        {
            "sha": "acc5758f75e04b774277a6b4877dd36245109e7a",
            "filename": "django/template/context.py",
            "status": "modified",
            "additions": 16,
            "deletions": 20,
            "changes": 36,
            "blob_url": "https://github.com/django/django/blob/d59baa07f056b60942052b4809d71eecd323837a/django%2Ftemplate%2Fcontext.py",
            "raw_url": "https://github.com/django/django/raw/d59baa07f056b60942052b4809d71eecd323837a/django%2Ftemplate%2Fcontext.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftemplate%2Fcontext.py?ref=d59baa07f056b60942052b4809d71eecd323837a",
            "patch": "@@ -14,21 +14,16 @@ class ContextPopException(Exception):\n     \"pop() has been called more times than push()\"\n     pass\n \n-class EmptyClass(object):\n-    # No-op class which takes no args to its __init__ method, to help implement\n-    # __copy__\n-    pass\n-\n class BaseContext(object):\n     def __init__(self, dict_=None):\n-        dict_ = dict_ or {}\n-        self.dicts = [dict_]\n+        self._reset_dicts(dict_)\n+\n+    def _reset_dicts(self, value=None):\n+        self.dicts = [value or {}]\n \n     def __copy__(self):\n-        duplicate = EmptyClass()\n-        duplicate.__class__ = self.__class__\n-        duplicate.__dict__ = self.__dict__.copy()\n-        duplicate.dicts = duplicate.dicts[:]\n+        duplicate = copy(super(BaseContext, self))\n+        duplicate.dicts = self.dicts[:]\n         return duplicate\n \n     def __repr__(self):\n@@ -78,6 +73,15 @@ def get(self, key, otherwise=None):\n                 return d[key]\n         return otherwise\n \n+    def new(self, values=None):\n+        \"\"\"\n+        Returns a new context with the same properties, but with only the\n+        values given in 'values' stored.\n+        \"\"\"\n+        new_context = copy(self)\n+        new_context._reset_dicts(values)\n+        return new_context\n+\n class Context(BaseContext):\n     \"A stack container for variable context\"\n     def __init__(self, dict_=None, autoescape=True, current_app=None, use_l10n=None):\n@@ -88,7 +92,7 @@ def __init__(self, dict_=None, autoescape=True, current_app=None, use_l10n=None)\n         super(Context, self).__init__(dict_)\n \n     def __copy__(self):\n-        duplicate = super(Context, self).__copy__()\n+        duplicate = copy(super(Context, self))\n         duplicate.render_context = copy(self.render_context)\n         return duplicate\n \n@@ -99,14 +103,6 @@ def update(self, other_dict):\n         self.dicts.append(other_dict)\n         return other_dict\n \n-    def new(self, values=None):\n-        \"\"\"\n-        Returns a new Context with the same 'autoescape' value etc, but with\n-        only the values given in 'values' stored.\n-        \"\"\"\n-        return self.__class__(dict_=values, autoescape=self.autoescape,\n-                              current_app=self.current_app, use_l10n=self.use_l10n)\n-\n class RenderContext(BaseContext):\n     \"\"\"\n     A stack container for storing Template state."
        },
        {
            "sha": "dedd7d5c920520e087b2adbbae692a3c3ecb9613",
            "filename": "tests/regressiontests/templates/tests.py",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/d59baa07f056b60942052b4809d71eecd323837a/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/d59baa07f056b60942052b4809d71eecd323837a/tests%2Fregressiontests%2Ftemplates%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftests.py?ref=d59baa07f056b60942052b4809d71eecd323837a",
            "patch": "@@ -1639,5 +1639,34 @@ def test_load_working_egg(self):\n         settings.INSTALLED_APPS = ('tagsegg',)\n         t = template.Template(ttext)\n \n+\n+class RequestContextTests(BaseTemplateResponseTest):\n+\n+    def setUp(self):\n+        templates = {\n+            'child': Template('{{ var|default:\"none\" }}'),\n+        }\n+        setup_test_template_loader(templates)\n+        self.fake_request = RequestFactory().get('/')\n+\n+    def tearDown(self):\n+        restore_template_loaders()\n+\n+    def test_include_only(self):\n+        \"\"\"\n+        Regression test for #15721, ``{% include %}`` and ``RequestContext``\n+        not playing together nicely.\n+        \"\"\"\n+        ctx = RequestContext(self.fake_request, {'var': 'parent'})\n+        self.assertEqual(\n+            template.Template('{% include \"child\" %}').render(ctx),\n+            'parent'\n+        )\n+        self.assertEqual(\n+            template.Template('{% include \"child\" only %}').render(ctx),\n+            'none'\n+        )\n+\n+\n if __name__ == \"__main__\":\n     unittest.main()"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 45,
        "deletions": 20
    }
}