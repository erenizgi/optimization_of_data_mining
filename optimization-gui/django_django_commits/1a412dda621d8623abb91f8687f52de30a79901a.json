{
    "author": "JannKleen",
    "message": "Fixed #18432 -- Prevented the ForeignKey field from creating an invalid query when chained. Thanks, Jann Kleen.",
    "sha": "1a412dda621d8623abb91f8687f52de30a79901a",
    "files": [
        {
            "sha": "96d1438282e478a5a07542356a5b0d8a97901dce",
            "filename": "django/db/models/fields/related.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1a412dda621d8623abb91f8687f52de30a79901a/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "raw_url": "https://github.com/django/django/raw/1a412dda621d8623abb91f8687f52de30a79901a/django%2Fdb%2Fmodels%2Ffields%2Frelated.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Ffields%2Frelated.py?ref=1a412dda621d8623abb91f8687f52de30a79901a",
            "patch": "@@ -359,7 +359,7 @@ def __get__(self, instance, instance_type=None):\n             else:\n                 other_field = self.field.rel.get_related_field()\n                 if other_field.rel:\n-                    params = {'%s__pk' % self.field.rel.field_name: val}\n+                    params = {'%s__%s' % (self.field.rel.field_name, other_field.rel.field_name): val}\n                 else:\n                     params = {'%s__exact' % self.field.rel.field_name: val}\n                 qs = self.get_query_set(instance=instance)"
        },
        {
            "sha": "aca6d448374dd93cddcfafc604065a5b60004176",
            "filename": "tests/regressiontests/model_regress/models.py",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/1a412dda621d8623abb91f8687f52de30a79901a/tests%2Fregressiontests%2Fmodel_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/1a412dda621d8623abb91f8687f52de30a79901a/tests%2Fregressiontests%2Fmodel_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_regress%2Fmodels.py?ref=1a412dda621d8623abb91f8687f52de30a79901a",
            "patch": "@@ -7,6 +7,7 @@\n     (2, 'second'),\n )\n \n+\n class Article(models.Model):\n     headline = models.CharField(max_length=100, default='Default headline')\n     pub_date = models.DateTimeField()\n@@ -15,38 +16,44 @@ class Article(models.Model):\n     article_text = models.TextField()\n \n     class Meta:\n-        ordering = ('pub_date','headline')\n+        ordering = ('pub_date', 'headline')\n         # A utf-8 verbose name (Ångström's Articles) to test they are valid.\n         verbose_name = \"\\xc3\\x85ngstr\\xc3\\xb6m's Articles\"\n \n     def __unicode__(self):\n         return self.headline\n \n+\n class Movie(models.Model):\n     #5218: Test models with non-default primary keys / AutoFields\n     movie_id = models.AutoField(primary_key=True)\n     name = models.CharField(max_length=60)\n \n+\n class Party(models.Model):\n     when = models.DateField(null=True)\n \n+\n class Event(models.Model):\n     when = models.DateTimeField()\n \n+\n class Department(models.Model):\n     id = models.PositiveIntegerField(primary_key=True)\n     name = models.CharField(max_length=200)\n \n     def __unicode__(self):\n         return self.name\n \n+\n class Worker(models.Model):\n     department = models.ForeignKey(Department)\n     name = models.CharField(max_length=200)\n \n     def __unicode__(self):\n         return self.name\n \n+\n class BrokenUnicodeMethod(models.Model):\n     name = models.CharField(max_length=7)\n \n@@ -55,5 +62,19 @@ def __unicode__(self):\n         # object).\n         return 'Názov: %s' % self.name\n \n+\n class NonAutoPK(models.Model):\n     name = models.CharField(max_length=10, primary_key=True)\n+\n+\n+#18432: Chained foreign keys with to_field produce incorrect query\n+class Model1(models.Model):\n+    pkey = models.IntegerField(unique=True, db_index=True)\n+\n+\n+class Model2(models.Model):\n+    model1 = models.ForeignKey(Model1, unique=True, to_field='pkey')\n+\n+\n+class Model3(models.Model):\n+    model2 = models.ForeignKey(Model2, unique=True, to_field='model1')"
        },
        {
            "sha": "7f9f514c7ab6771c7a4ab81e168adb19b4426f91",
            "filename": "tests/regressiontests/model_regress/tests.py",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/1a412dda621d8623abb91f8687f52de30a79901a/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1a412dda621d8623abb91f8687f52de30a79901a/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmodel_regress%2Ftests.py?ref=1a412dda621d8623abb91f8687f52de30a79901a",
            "patch": "@@ -8,8 +8,7 @@\n from django.utils import tzinfo\n \n from .models import (Worker, Article, Party, Event, Department,\n-    BrokenUnicodeMethod, NonAutoPK)\n-\n+    BrokenUnicodeMethod, NonAutoPK, Model1, Model2, Model3)\n \n \n class ModelTests(TestCase):\n@@ -47,7 +46,7 @@ def test_long_textfield(self):\n         a = Article.objects.create(\n             headline=\"Really, really big\",\n             pub_date=datetime.datetime.now(),\n-            article_text = \"ABCDE\" * 1000\n+            article_text=\"ABCDE\" * 1000\n         )\n         a = Article.objects.get(pk=a.pk)\n         self.assertEqual(len(a.article_text), 5000)\n@@ -164,6 +163,19 @@ def test_timezones(self):\n             1\n         )\n \n+    def test_chained_fks(self):\n+        \"\"\"\n+        Regression for #18432: Chained foreign keys with to_field produce incorrect query\n+        \"\"\"\n+\n+        m1 = Model1.objects.create(pkey=1000)\n+        m2 = Model2.objects.create(model1=m1)\n+        m3 = Model3.objects.create(model2=m2)\n+\n+        # this is the actual test for #18432\n+        m3 = Model3.objects.get(model2=1000)\n+        m3.model2\n+\n \n class ModelValidationTest(TestCase):\n     def test_pk_validation(self):"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 38,
        "deletions": 5
    }
}