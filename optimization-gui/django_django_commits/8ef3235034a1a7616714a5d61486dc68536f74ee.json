{
    "author": "akaariai",
    "message": "Fixed #19720 -- Oracle ordering related delete regression\n\nWhen a query had a complex where condition (a condition targeting more\nthan the base table) a subquery was used for deletion. However, the\nquery had default ordering from the model's meta and Oracle doesn't\nwork with ordered subqueries.\n\nThe regression was caused by fast-path deletion code introduced in\n1cd6e04cd4f768bcd4385b75de433d497d938f82 for fixing #18676.\n\nThanks to Dylan Klomparens for the report.",
    "sha": "8ef3235034a1a7616714a5d61486dc68536f74ee",
    "files": [
        {
            "sha": "81a8b67ceca1c3f8e291e2b15be1d57b2fee3350",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/8ef3235034a1a7616714a5d61486dc68536f74ee/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/8ef3235034a1a7616714a5d61486dc68536f74ee/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=8ef3235034a1a7616714a5d61486dc68536f74ee",
            "patch": "@@ -539,7 +539,7 @@ def delete(self):\n         # Disable non-supported fields.\n         del_query.query.select_for_update = False\n         del_query.query.select_related = False\n-        del_query.query.clear_ordering()\n+        del_query.query.clear_ordering(force_empty=True)\n \n         collector = Collector(using=del_query.db)\n         collector.collect(del_query)"
        },
        {
            "sha": "3632a7dbc11b955372522dc081daf423c414434b",
            "filename": "tests/regressiontests/delete_regress/models.py",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/8ef3235034a1a7616714a5d61486dc68536f74ee/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/8ef3235034a1a7616714a5d61486dc68536f74ee/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Fmodels.py?ref=8ef3235034a1a7616714a5d61486dc68536f74ee",
            "patch": "@@ -99,3 +99,13 @@ class OrgUnit(models.Model):\n class Login(models.Model):\n     description = models.CharField(max_length=32)\n     orgunit = models.ForeignKey(OrgUnit)\n+\n+class House(models.Model):\n+    address = models.CharField(max_length=32)\n+\n+class OrderedPerson(models.Model):\n+    name = models.CharField(max_length=32)\n+    lives_in = models.ForeignKey(House)\n+\n+    class Meta:\n+        ordering = ['name']"
        },
        {
            "sha": "e007ebdd76a3ee5de6685cf530cbc2ec898d0a17",
            "filename": "tests/regressiontests/delete_regress/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/django/django/blob/8ef3235034a1a7616714a5d61486dc68536f74ee/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/8ef3235034a1a7616714a5d61486dc68536f74ee/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fdelete_regress%2Ftests.py?ref=8ef3235034a1a7616714a5d61486dc68536f74ee",
            "patch": "@@ -10,7 +10,7 @@\n from .models import (Book, Award, AwardNote, Person, Child, Toy, PlayedWith,\n     PlayedWithNote, Email, Researcher, Food, Eaten, Policy, Version, Location,\n     Item, Image, File, Photo, FooFile, FooImage, FooPhoto, FooFileProxy, Login,\n-    OrgUnit)\n+    OrgUnit, OrderedPerson, House)\n \n \n # Can't run this test under SQLite, because you can't\n@@ -347,3 +347,14 @@ def test_ticket_19102_defer(self):\n         self.assertFalse(Login.objects.filter(pk=self.l1.pk).exists())\n         self.assertTrue(Login.objects.filter(pk=self.l2.pk).exists())\n \n+\n+class OrderedDeleteTests(TestCase):\n+    def test_meta_ordered_delete(self):\n+        # When a subquery is performed by deletion code, the subquery must be\n+        # cleared of all ordering. There was a but that caused _meta ordering\n+        # to be used. Refs #19720.\n+        h = House.objects.create(address='Foo')\n+        OrderedPerson.objects.create(name='Jack', lives_in=h)\n+        OrderedPerson.objects.create(name='Bob', lives_in=h)\n+        OrderedPerson.objects.filter(lives_in__address='Foo').delete()\n+        self.assertEqual(OrderedPerson.objects.count(), 0)"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 23,
        "deletions": 2
    }
}