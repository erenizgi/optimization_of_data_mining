{
    "author": "claudep",
    "message": "Prevented file_upload tests to leave files behind\n\nRefs #19206.",
    "sha": "73245b3285f63694d2c63c9b197165dc6d9cfd4e",
    "files": [
        {
            "sha": "3336cc9d908c03c2a4e44b6e8644750adda3b626",
            "filename": "tests/regressiontests/file_uploads/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 8,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/73245b3285f63694d2c63c9b197165dc6d9cfd4e/tests%2Fregressiontests%2Ffile_uploads%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/73245b3285f63694d2c63c9b197165dc6d9cfd4e/tests%2Fregressiontests%2Ffile_uploads%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Fmodels.py?ref=73245b3285f63694d2c63c9b197165dc6d9cfd4e",
            "patch": "@@ -1,12 +1,5 @@\n-import tempfile\n-import os\n-\n-from django.core.files.storage import FileSystemStorage\n from django.db import models\n \n \n-temp_storage = FileSystemStorage(tempfile.mkdtemp())\n-UPLOAD_TO = os.path.join(temp_storage.location, 'test_upload')\n-\n class FileModel(models.Model):\n-    testfile = models.FileField(storage=temp_storage, upload_to='test_upload')\n+    testfile = models.FileField(upload_to='test_upload')"
        },
        {
            "sha": "8fa140bc1844c3ce7d1a20aa32f9bd3d82a1db7f",
            "filename": "tests/regressiontests/file_uploads/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 18,
            "changes": 49,
            "blob_url": "https://github.com/django/django/blob/73245b3285f63694d2c63c9b197165dc6d9cfd4e/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/73245b3285f63694d2c63c9b197165dc6d9cfd4e/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Ftests.py?ref=73245b3285f63694d2c63c9b197165dc6d9cfd4e",
            "patch": "@@ -7,22 +7,36 @@\n import json\n import os\n import shutil\n+import tempfile as sys_tempfile\n \n from django.core.files import temp as tempfile\n from django.core.files.uploadedfile import SimpleUploadedFile\n from django.http.multipartparser import MultiPartParser\n from django.test import TestCase, client\n+from django.test.utils import override_settings\n from django.utils.encoding import force_bytes\n from django.utils.six import StringIO\n from django.utils import unittest\n \n from . import uploadhandler\n-from .models import FileModel, temp_storage, UPLOAD_TO\n+from .models import FileModel\n \n \n UNICODE_FILENAME = 'test-0123456789_中文_Orléans.jpg'\n+MEDIA_ROOT = sys_tempfile.mkdtemp()\n+UPLOAD_TO = os.path.join(MEDIA_ROOT, 'test_upload')\n \n+@override_settings(MEDIA_ROOT=MEDIA_ROOT)\n class FileUploadTests(TestCase):\n+    @classmethod\n+    def setUpClass(cls):\n+        if not os.path.isdir(MEDIA_ROOT):\n+            os.makedirs(MEDIA_ROOT)\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        shutil.rmtree(MEDIA_ROOT)\n+\n     def test_simple_upload(self):\n         with open(__file__, 'rb') as fp:\n             post_data = {\n@@ -83,7 +97,8 @@ def test_base64_upload(self):\n         self.assertEqual(received['file'], test_string)\n \n     def test_unicode_file_name(self):\n-        tdir = tempfile.gettempdir()\n+        tdir = sys_tempfile.mkdtemp()\n+        self.addCleanup(shutil.rmtree, tdir, True)\n \n         # This file contains chinese symbols and an accented char in the name.\n         with open(os.path.join(tdir, UNICODE_FILENAME), 'w+b') as file1:\n@@ -96,11 +111,6 @@ def test_unicode_file_name(self):\n \n             response = self.client.post('/file_uploads/unicode_name/', post_data)\n \n-        try:\n-            os.unlink(file1.name)\n-        except OSError:\n-            pass\n-\n         self.assertEqual(response.status_code, 200)\n \n     def test_dangerous_file_names(self):\n@@ -347,26 +357,28 @@ def test_filename_case_preservation(self):\n         # shouldn't differ.\n         self.assertEqual(os.path.basename(obj.testfile.path), 'MiXeD_cAsE.txt')\n \n-class DirectoryCreationTests(unittest.TestCase):\n+@override_settings(MEDIA_ROOT=MEDIA_ROOT)\n+class DirectoryCreationTests(TestCase):\n     \"\"\"\n     Tests for error handling during directory creation\n     via _save_FIELD_file (ticket #6450)\n     \"\"\"\n+    @classmethod\n+    def setUpClass(cls):\n+        if not os.path.isdir(MEDIA_ROOT):\n+            os.makedirs(MEDIA_ROOT)\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        shutil.rmtree(MEDIA_ROOT)\n+\n     def setUp(self):\n         self.obj = FileModel()\n-        if not os.path.isdir(temp_storage.location):\n-            os.makedirs(temp_storage.location)\n-        if os.path.isdir(UPLOAD_TO):\n-            os.chmod(UPLOAD_TO, 0o700)\n-            shutil.rmtree(UPLOAD_TO)\n-\n-    def tearDown(self):\n-        os.chmod(temp_storage.location, 0o700)\n-        shutil.rmtree(temp_storage.location)\n \n     def test_readonly_root(self):\n         \"\"\"Permission errors are not swallowed\"\"\"\n-        os.chmod(temp_storage.location, 0o500)\n+        os.chmod(MEDIA_ROOT, 0o500)\n+        self.addCleanup(os.chmod, MEDIA_ROOT, 0o700)\n         try:\n             self.obj.testfile.save('foo.txt', SimpleUploadedFile('foo.txt', b'x'))\n         except OSError as err:\n@@ -378,6 +390,7 @@ def test_not_a_directory(self):\n         \"\"\"The correct IOError is raised when the upload directory name exists but isn't a directory\"\"\"\n         # Create a file with the upload directory name\n         open(UPLOAD_TO, 'wb').close()\n+        self.addCleanup(os.remove, UPLOAD_TO)\n         with self.assertRaises(IOError) as exc_info:\n             self.obj.testfile.save('foo.txt', SimpleUploadedFile('foo.txt', b'x'))\n         # The test needs to be done on a specific string as IOError"
        },
        {
            "sha": "eb7b654c09fd51f8c7482b4f3404a356f9c38ff9",
            "filename": "tests/regressiontests/file_uploads/views.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/73245b3285f63694d2c63c9b197165dc6d9cfd4e/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/73245b3285f63694d2c63c9b197165dc6d9cfd4e/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ffile_uploads%2Fviews.py?ref=73245b3285f63694d2c63c9b197165dc6d9cfd4e",
            "patch": "@@ -9,8 +9,8 @@\n from django.utils import six\n from django.utils.encoding import force_bytes\n \n-from .models import FileModel, UPLOAD_TO\n-from .tests import UNICODE_FILENAME\n+from .models import FileModel\n+from .tests import UNICODE_FILENAME, UPLOAD_TO\n from .uploadhandler import QuotaUploadHandler, ErroringUploadHandler\n \n "
        }
    ],
    "stats": {
        "total": 62,
        "additions": 34,
        "deletions": 28
    }
}