{
    "author": "claudep",
    "message": "Reverted pickle-json replacement form_hmac calculation\n\nThis reverts commit b109ff8062f4bb225181ec462d69c9dd79339567 and\ncomplement test cases. The change was too hasty, as some form\nvalues cannot be json-serialized as is.",
    "sha": "0df0cf70d43a642393d118523b7efdc04dae6105",
    "files": [
        {
            "sha": "36c7a6d0a294323d0ebbaa7da943f17996faa9fd",
            "filename": "django/contrib/formtools/tests/__init__.py",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/0df0cf70d43a642393d118523b7efdc04dae6105/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/0df0cf70d43a642393d118523b7efdc04dae6105/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2F__init__.py?ref=0df0cf70d43a642393d118523b7efdc04dae6105",
            "patch": "@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n from __future__ import unicode_literals\n \n+import datetime\n import os\n import re\n import warnings\n@@ -80,7 +81,7 @@ def test_form_preview(self):\n         \"\"\"\n         # Pass strings for form submittal and add stage variable to\n         # show we previously saw first stage of the form.\n-        self.test_data.update({'stage': 1})\n+        self.test_data.update({'stage': 1, 'date1': datetime.date(2006, 10, 25)})\n         response = self.client.post('/preview/', self.test_data)\n         # Check to confirm stage is set to 2 in output form.\n         stage = self.input % 2\n@@ -98,7 +99,7 @@ def test_form_submit(self):\n         \"\"\"\n         # Pass strings for form submittal and add stage variable to\n         # show we previously saw first stage of the form.\n-        self.test_data.update({'stage':2})\n+        self.test_data.update({'stage': 2, 'date1': datetime.date(2006, 10, 25)})\n         response = self.client.post('/preview/', self.test_data)\n         self.assertNotEqual(response.content, success_string_encoded)\n         hash = self.preview.security_hash(None, TestForm(self.test_data))\n@@ -272,7 +273,7 @@ def test_good_hash(self):\n         \"\"\"\n         data = {\"0-field\": \"test\",\n                 \"1-field\": \"test2\",\n-                \"hash_0\": \"09a53d8de15fc155bad33423e1d2ee2d82484d8a\",\n+                \"hash_0\": \"cd13b1db3e8f55174bc5745a1b1a53408d4fd1ca\",\n                 \"wizard_step\": \"1\"}\n         response = self.client.post('/wizard1/', data)\n         self.assertEqual(2, response.context['step0'])\n@@ -297,15 +298,15 @@ def process_step(self, request, form, step):\n         wizard = WizardWithProcessStep([WizardPageOneForm])\n         data = {\"0-field\": \"test\",\n                 \"1-field\": \"test2\",\n-                \"hash_0\": \"09a53d8de15fc155bad33423e1d2ee2d82484d8a\",\n+                \"hash_0\": \"cd13b1db3e8f55174bc5745a1b1a53408d4fd1ca\",\n                 \"wizard_step\": \"1\"}\n         wizard(DummyRequest(POST=data))\n         self.assertTrue(reached[0])\n \n         data = {\"0-field\": \"test\",\n                 \"1-field\": \"test2\",\n-                \"hash_0\": \"09a53d8de15fc155bad33423e1d2ee2d82484d8a\",\n-                \"hash_1\": \"4c352938f08b0e6467bef3cda578a1d4a82edc66\",\n+                \"hash_0\": \"cd13b1db3e8f55174bc5745a1b1a53408d4fd1ca\",\n+                \"hash_1\": \"1e6f6315da42e62f33a30640ec7e007ad3fbf1a1\",\n                 \"wizard_step\": \"2\"}\n         self.assertRaises(http.Http404, wizard, DummyRequest(POST=data))\n \n@@ -327,7 +328,7 @@ def process_step(self, request, form, step):\n                                         WizardPageThreeForm])\n         data = {\"0-field\": \"test\",\n                 \"1-field\": \"test2\",\n-                \"hash_0\": \"09a53d8de15fc155bad33423e1d2ee2d82484d8a\",\n+                \"hash_0\": \"cd13b1db3e8f55174bc5745a1b1a53408d4fd1ca\",\n                 \"wizard_step\": \"1\"}\n         wizard(DummyRequest(POST=data))\n         self.assertTrue(reached[0])\n@@ -351,7 +352,7 @@ def done(self, request, form_list):\n \n         data = {\"0-field\": \"test\",\n                 \"1-field\": \"test2\",\n-                \"hash_0\": \"09a53d8de15fc155bad33423e1d2ee2d82484d8a\",\n+                \"hash_0\": \"cd13b1db3e8f55174bc5745a1b1a53408d4fd1ca\",\n                 \"wizard_step\": \"1\"}\n         wizard(DummyRequest(POST=data))\n         self.assertTrue(reached[0])\n@@ -377,7 +378,7 @@ def process_step(self, request, form, step):\n                                         WizardPageThreeForm])\n         data = {\"0-field\": \"test\",\n                 \"1-field\": \"test2\",\n-                \"hash_0\": \"09a53d8de15fc155bad33423e1d2ee2d82484d8a\",\n+                \"hash_0\": \"cd13b1db3e8f55174bc5745a1b1a53408d4fd1ca\",\n                 \"wizard_step\": \"1\"}\n         wizard(DummyRequest(POST=data))\n         self.assertTrue(reached[0])"
        },
        {
            "sha": "1ed2ab48bb98959ec8ebb4883971d85508987d89",
            "filename": "django/contrib/formtools/tests/forms.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/0df0cf70d43a642393d118523b7efdc04dae6105/django%2Fcontrib%2Fformtools%2Ftests%2Fforms.py",
            "raw_url": "https://github.com/django/django/raw/0df0cf70d43a642393d118523b7efdc04dae6105/django%2Fcontrib%2Fformtools%2Ftests%2Fforms.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Ftests%2Fforms.py?ref=0df0cf70d43a642393d118523b7efdc04dae6105",
            "patch": "@@ -21,6 +21,7 @@ class TestForm(forms.Form):\n     field1 = forms.CharField()\n     field1_ = forms.CharField()\n     bool1 = forms.BooleanField(required=False)\n+    date1 = forms.DateField(required=False)\n \n class HashTestForm(forms.Form):\n     name = forms.CharField()"
        },
        {
            "sha": "76277c6b49e9b638dcbfa2f14f01f4bf15f1d6fa",
            "filename": "django/contrib/formtools/utils.py",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/0df0cf70d43a642393d118523b7efdc04dae6105/django%2Fcontrib%2Fformtools%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/0df0cf70d43a642393d118523b7efdc04dae6105/django%2Fcontrib%2Fformtools%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fformtools%2Futils.py?ref=0df0cf70d43a642393d118523b7efdc04dae6105",
            "patch": "@@ -1,6 +1,7 @@\n from __future__ import unicode_literals\n \n-import json\n+# Do not try cPickle here (see #18340)\n+import pickle\n \n from django.utils.crypto import salted_hmac\n from django.utils import six\n@@ -22,5 +23,6 @@ def form_hmac(form):\n             value = value.strip()\n         data.append((bf.name, value))\n \n+    pickled = pickle.dumps(data, pickle.HIGHEST_PROTOCOL)\n     key_salt = 'django.contrib.formtools'\n-    return salted_hmac(key_salt, json.dumps(data)).hexdigest()\n+    return salted_hmac(key_salt, pickled).hexdigest()"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 15,
        "deletions": 11
    }
}