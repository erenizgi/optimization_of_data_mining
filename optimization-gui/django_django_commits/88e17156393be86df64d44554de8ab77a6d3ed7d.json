{
    "author": "sebasmagri",
    "message": "Fixed #19318 -- Ensured that the admin's SimpleListFilter options can be displayed as selected even if the lookup's first element is not a string.",
    "sha": "88e17156393be86df64d44554de8ab77a6d3ed7d",
    "files": [
        {
            "sha": "ff66d3e3f30f7bb8ad1c0bb3f1742c9d040031b6",
            "filename": "django/contrib/admin/filters.py",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/django/django/blob/88e17156393be86df64d44554de8ab77a6d3ed7d/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "raw_url": "https://github.com/django/django/raw/88e17156393be86df64d44554de8ab77a6d3ed7d/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilters.py?ref=88e17156393be86df64d44554de8ab77a6d3ed7d",
            "patch": "@@ -9,7 +9,7 @@\n \n from django.db import models\n from django.core.exceptions import ImproperlyConfigured, ValidationError\n-from django.utils.encoding import smart_text\n+from django.utils.encoding import smart_text, force_text\n from django.utils.translation import ugettext_lazy as _\n from django.utils import timezone\n from django.contrib.admin.util import (get_model_from_relation,\n@@ -102,7 +102,7 @@ def choices(self, cl):\n         }\n         for lookup, title in self.lookup_choices:\n             yield {\n-                'selected': self.value() == lookup,\n+                'selected': self.value() == force_text(lookup),\n                 'query_string': cl.get_query_string({\n                     self.parameter_name: lookup,\n                 }, []),"
        },
        {
            "sha": "d00490038d40263aa9425f5bc861624d1ead9636",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 51,
            "deletions": 7,
            "changes": 58,
            "blob_url": "https://github.com/django/django/blob/88e17156393be86df64d44554de8ab77a6d3ed7d/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/88e17156393be86df64d44554de8ab77a6d3ed7d/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=88e17156393be86df64d44554de8ab77a6d3ed7d",
            "patch": "@@ -78,6 +78,21 @@ class DecadeListFilterParameterEndsWith__Isnull(DecadeListFilter):\n     parameter_name = 'decade__isnull' # Ends with '__isnull\"\n \n \n+class DepartmentListFilterLookupWithNonStringValue(SimpleListFilter):\n+    title = 'department'\n+    parameter_name = 'department'\n+\n+    def lookups(self, request, model_admin):\n+        return set([\n+            (employee.department.id,  # Intentionally not a string (Refs #19318)\n+             employee.department.code)\n+            for employee in model_admin.queryset(request).all()\n+        ])\n+\n+    def queryset(self, request, queryset):\n+        if self.value():\n+            return queryset.filter(department__id=self.value())\n+\n class CustomUserAdmin(UserAdmin):\n     list_filter = ('books_authored', 'books_contributed')\n \n@@ -118,6 +133,10 @@ class EmployeeAdmin(ModelAdmin):\n     list_filter = ['department']\n \n \n+class DepartmentFilterEmployeeAdmin(EmployeeAdmin):\n+    list_filter = [DepartmentListFilterLookupWithNonStringValue, ]\n+\n+\n class ListFiltersTests(TestCase):\n \n     def setUp(self):\n@@ -140,6 +159,14 @@ def setUp(self):\n         self.gipsy_book.contributors = [self.bob, self.lisa]\n         self.gipsy_book.save()\n \n+        # Departments\n+        self.dev = Department.objects.create(code='DEV', description='Development')\n+        self.design = Department.objects.create(code='DSN', description='Design')\n+\n+        # Employees\n+        self.john = Employee.objects.create(name='John Blue', department=self.dev)\n+        self.jack = Employee.objects.create(name='Jack Red', department=self.design)\n+\n     def get_changelist(self, request, model, modeladmin):\n         return ChangeList(request, model, modeladmin.list_display, modeladmin.list_display_links,\n             modeladmin.list_filter, modeladmin.date_hierarchy, modeladmin.search_fields,\n@@ -638,24 +665,41 @@ def test_parameter_ends_with__in__or__isnull(self):\n         self.assertEqual(choices[2]['selected'], True)\n         self.assertEqual(choices[2]['query_string'], '?decade__isnull=the+90s')\n \n+    def test_lookup_with_non_string_value(self):\n+        \"\"\"\n+        Ensure choices are set the selected class when using non-string values\n+        for lookups in SimpleListFilters.\n+        Refs #19318\n+        \"\"\"\n+\n+        modeladmin = DepartmentFilterEmployeeAdmin(Employee, site)\n+        request = self.request_factory.get('/', {'department': '1'})\n+        changelist = self.get_changelist(request, Employee, modeladmin)\n+\n+        queryset = changelist.get_query_set(request)\n+\n+        self.assertEqual(list(queryset), [self.john])\n+\n+        filterspec = changelist.get_filters(request)[0][-1]\n+        self.assertEqual(force_text(filterspec.title), 'department')\n+        choices = list(filterspec.choices(changelist))\n+        self.assertEqual(choices[2]['display'], 'DEV')\n+        self.assertEqual(choices[2]['selected'], True)\n+        self.assertEqual(choices[2]['query_string'], '?department=1')\n+\n     def test_fk_with_to_field(self):\n         \"\"\"\n         Ensure that a filter on a FK respects the FK's to_field attribute.\n         Refs #17972.\n         \"\"\"\n         modeladmin = EmployeeAdmin(Employee, site)\n \n-        dev = Department.objects.create(code='DEV', description='Development')\n-        design = Department.objects.create(code='DSN', description='Design')\n-        john = Employee.objects.create(name='John Blue', department=dev)\n-        jack = Employee.objects.create(name='Jack Red', department=design)\n-\n         request = self.request_factory.get('/', {})\n         changelist = self.get_changelist(request, Employee, modeladmin)\n \n         # Make sure the correct queryset is returned\n         queryset = changelist.get_query_set(request)\n-        self.assertEqual(list(queryset), [jack, john])\n+        self.assertEqual(list(queryset), [self.jack, self.john])\n \n         filterspec = changelist.get_filters(request)[0][-1]\n         self.assertEqual(force_text(filterspec.title), 'department')\n@@ -680,7 +724,7 @@ def test_fk_with_to_field(self):\n \n         # Make sure the correct queryset is returned\n         queryset = changelist.get_query_set(request)\n-        self.assertEqual(list(queryset), [john])\n+        self.assertEqual(list(queryset), [self.john])\n \n         filterspec = changelist.get_filters(request)[0][-1]\n         self.assertEqual(force_text(filterspec.title), 'department')"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 53,
        "deletions": 9
    }
}