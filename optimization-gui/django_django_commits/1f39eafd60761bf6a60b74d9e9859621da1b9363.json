{
    "author": "carljm",
    "message": "Checked object permissions on admin history view.\n\nThis is a security fix. Disclosure and advisory coming shortly.\n\nPatch by Russell Keith-Magee.",
    "sha": "1f39eafd60761bf6a60b74d9e9859621da1b9363",
    "files": [
        {
            "sha": "ff7873b40c6df7d1ea2ccb27f229115703d69a47",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/1f39eafd60761bf6a60b74d9e9859621da1b9363/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/1f39eafd60761bf6a60b74d9e9859621da1b9363/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=1f39eafd60761bf6a60b74d9e9859621da1b9363",
            "patch": "@@ -1354,15 +1354,21 @@ def delete_view(self, request, object_id, extra_context=None):\n     def history_view(self, request, object_id, extra_context=None):\n         \"The 'history' admin view for this model.\"\n         from django.contrib.admin.models import LogEntry\n+        # First check if the user can see this history.\n         model = self.model\n+        obj = get_object_or_404(model, pk=unquote(object_id))\n+\n+        if not self.has_change_permission(request, obj):\n+            raise PermissionDenied\n+\n+        # Then get the history for this object.\n         opts = model._meta\n         app_label = opts.app_label\n         action_list = LogEntry.objects.filter(\n-            object_id = unquote(object_id),\n-            content_type__id__exact = ContentType.objects.get_for_model(model).id\n+            object_id=unquote(object_id),\n+            content_type__id__exact=ContentType.objects.get_for_model(model).id\n         ).select_related().order_by('action_time')\n-        # If no history was found, see whether this object even exists.\n-        obj = get_object_or_404(model, pk=unquote(object_id))\n+\n         context = {\n             'title': _('Change history: %s') % force_text(obj),\n             'action_list': action_list,"
        },
        {
            "sha": "3d07f857210d05c522986d00203cebe0b619f5e3",
            "filename": "tests/regressiontests/admin_views/tests.py",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/1f39eafd60761bf6a60b74d9e9859621da1b9363/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1f39eafd60761bf6a60b74d9e9859621da1b9363/tests%2Fregressiontests%2Fadmin_views%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_views%2Ftests.py?ref=1f39eafd60761bf6a60b74d9e9859621da1b9363",
            "patch": "@@ -1103,6 +1103,46 @@ def testChangeView(self):\n             self.assertContains(response, 'login-form')\n             self.client.get('/test_admin/admin/logout/')\n \n+    def testHistoryView(self):\n+        \"\"\"History view should restrict access.\"\"\"\n+\n+        # add user shoud not be able to view the list of article or change any of them\n+        self.client.get('/test_admin/admin/')\n+        self.client.post('/test_admin/admin/', self.adduser_login)\n+        response = self.client.get('/test_admin/admin/admin_views/article/1/history/')\n+        self.assertEqual(response.status_code, 403)\n+        self.client.get('/test_admin/admin/logout/')\n+\n+        # change user can view all items and edit them\n+        self.client.get('/test_admin/admin/')\n+        self.client.post('/test_admin/admin/', self.changeuser_login)\n+        response = self.client.get('/test_admin/admin/admin_views/article/1/history/')\n+        self.assertEqual(response.status_code, 200)\n+\n+        # Test redirection when using row-level change permissions. Refs #11513.\n+        RowLevelChangePermissionModel.objects.create(id=1, name=\"odd id\")\n+        RowLevelChangePermissionModel.objects.create(id=2, name=\"even id\")\n+        for login_dict in [self.super_login, self.changeuser_login, self.adduser_login, self.deleteuser_login]:\n+            self.client.post('/test_admin/admin/', login_dict)\n+            response = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/1/history/')\n+            self.assertEqual(response.status_code, 403)\n+\n+            response = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/2/history/')\n+            self.assertEqual(response.status_code, 200)\n+\n+            self.client.get('/test_admin/admin/logout/')\n+\n+        for login_dict in [self.joepublic_login, self.no_username_login]:\n+            self.client.post('/test_admin/admin/', login_dict)\n+            response = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/1/history/')\n+            self.assertEqual(response.status_code, 200)\n+            self.assertContains(response, 'login-form')\n+            response = self.client.get('/test_admin/admin/admin_views/rowlevelchangepermissionmodel/2/history/')\n+            self.assertEqual(response.status_code, 200)\n+            self.assertContains(response, 'login-form')\n+\n+            self.client.get('/test_admin/admin/logout/')\n+\n     def testConditionallyShowAddSectionLink(self):\n         \"\"\"\n         The foreign key widget should only show the \"add related\" button if the"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 50,
        "deletions": 4
    }
}