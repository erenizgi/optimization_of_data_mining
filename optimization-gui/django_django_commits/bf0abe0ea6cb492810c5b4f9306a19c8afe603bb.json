{
    "author": "aaugustin",
    "message": "Fixed #17830 -- Modified list_filter on DateTimeFields to account for the new time zone support. Thanks Glenn Washburn for the report and Jannis Leidel for the review.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17670 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "bf0abe0ea6cb492810c5b4f9306a19c8afe603bb",
    "files": [
        {
            "sha": "b64445ebfde11694521f30792881939b347f6fa5",
            "filename": "django/contrib/admin/filters.py",
            "status": "modified",
            "additions": 28,
            "deletions": 22,
            "changes": 50,
            "blob_url": "https://github.com/django/django/blob/bf0abe0ea6cb492810c5b4f9306a19c8afe603bb/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "raw_url": "https://github.com/django/django/raw/bf0abe0ea6cb492810c5b4f9306a19c8afe603bb/django%2Fcontrib%2Fadmin%2Ffilters.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Ffilters.py?ref=bf0abe0ea6cb492810c5b4f9306a19c8afe603bb",
            "patch": "@@ -11,6 +11,7 @@\n from django.core.exceptions import ImproperlyConfigured\n from django.utils.encoding import smart_unicode\n from django.utils.translation import ugettext_lazy as _\n+from django.utils import timezone\n \n from django.contrib.admin.util import (get_model_from_relation,\n     reverse_field_path, get_limit_choices_to_from_path, prepare_lookup_value)\n@@ -282,44 +283,49 @@ def __init__(self, field, request, params, model, model_admin, field_path):\n         self.field_generic = '%s__' % field_path\n         self.date_params = dict([(k, v) for k, v in params.items()\n                                  if k.startswith(self.field_generic)])\n-        today = datetime.date.today()\n-        one_week_ago = today - datetime.timedelta(days=7)\n-        today_str = str(today)\n+\n+        now = timezone.now()\n+        # When time zone support is enabled, convert \"now\" to the user's time\n+        # zone so Django's definition of \"Today\" matches what the user expects.\n+        if now.tzinfo is not None:\n+            current_tz = timezone.get_current_timezone()\n+            now = now.astimezone(current_tz)\n+            if hasattr(current_tz, 'normalize'):\n+                # available for pytz time zones\n+                now = current_tz.normalize(now)\n+\n         if isinstance(field, models.DateTimeField):\n-            today_str += ' 23:59:59'\n-        self.lookup_kwarg_year = '%s__year' % field_path\n-        self.lookup_kwarg_month = '%s__month' % field_path\n-        self.lookup_kwarg_day = '%s__day' % field_path\n-        self.lookup_kwarg_past_7_days_gte = '%s__gte' % field_path\n-        self.lookup_kwarg_past_7_days_lte = '%s__lte' % field_path\n+            today = now.replace(hour=0, minute=0, second=0, microsecond=0)\n+        else:       # field is a models.DateField\n+            today = now.date()\n+        tomorrow = today + datetime.timedelta(days=1)\n+    \n+        self.lookup_kwarg_since = '%s__gte' % field_path\n+        self.lookup_kwarg_until = '%s__lt' % field_path\n         self.links = (\n             (_('Any date'), {}),\n             (_('Today'), {\n-                self.lookup_kwarg_year: str(today.year),\n-                self.lookup_kwarg_month: str(today.month),\n-                self.lookup_kwarg_day: str(today.day),\n+                self.lookup_kwarg_since: str(today),\n+                self.lookup_kwarg_until: str(tomorrow),\n             }),\n             (_('Past 7 days'), {\n-                self.lookup_kwarg_past_7_days_gte: str(one_week_ago),\n-                self.lookup_kwarg_past_7_days_lte: today_str,\n+                self.lookup_kwarg_since: str(today - datetime.timedelta(days=7)),\n+                self.lookup_kwarg_until: str(tomorrow),\n             }),\n             (_('This month'), {\n-                self.lookup_kwarg_year: str(today.year),\n-                self.lookup_kwarg_month: str(today.month),\n+                self.lookup_kwarg_since: str(today.replace(day=1)),\n+                self.lookup_kwarg_until: str(tomorrow),\n             }),\n             (_('This year'), {\n-                self.lookup_kwarg_year: str(today.year),\n+                self.lookup_kwarg_since: str(today.replace(month=1, day=1)),\n+                self.lookup_kwarg_until: str(tomorrow),\n             }),\n         )\n         super(DateFieldListFilter, self).__init__(\n             field, request, params, model, model_admin, field_path)\n \n     def expected_parameters(self):\n-        return [\n-            self.lookup_kwarg_year, self.lookup_kwarg_month,\n-            self.lookup_kwarg_day, self.lookup_kwarg_past_7_days_gte,\n-            self.lookup_kwarg_past_7_days_lte\n-        ]\n+        return [self.lookup_kwarg_since, self.lookup_kwarg_until]\n \n     def choices(self, cl):\n         for title, param_dict in self.links:"
        },
        {
            "sha": "539bb0cc7abd34d49ce9119e8f03344c600a0d8c",
            "filename": "tests/regressiontests/admin_filters/tests.py",
            "status": "modified",
            "additions": 25,
            "deletions": 18,
            "changes": 43,
            "blob_url": "https://github.com/django/django/blob/bf0abe0ea6cb492810c5b4f9306a19c8afe603bb/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/bf0abe0ea6cb492810c5b4f9306a19c8afe603bb/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_filters%2Ftests.py?ref=bf0abe0ea6cb492810c5b4f9306a19c8afe603bb",
            "patch": "@@ -10,6 +10,7 @@\n from django.contrib.auth.models import User\n from django.core.exceptions import ImproperlyConfigured\n from django.test import TestCase, RequestFactory\n+from django.test.utils import override_settings\n from django.utils.encoding import force_unicode\n \n from .models import Book\n@@ -115,6 +116,7 @@ class ListFiltersTests(TestCase):\n \n     def setUp(self):\n         self.today = datetime.date.today()\n+        self.tomorrow = self.today + datetime.timedelta(days=1)\n         self.one_week_ago = self.today - datetime.timedelta(days=7)\n \n         self.request_factory = RequestFactory()\n@@ -143,9 +145,8 @@ def test_datefieldlistfilter(self):\n         request = self.request_factory.get('/')\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n-        request = self.request_factory.get('/', {'date_registered__year': self.today.year,\n-                                                 'date_registered__month': self.today.month,\n-                                                 'date_registered__day': self.today.day})\n+        request = self.request_factory.get('/', {'date_registered__gte': self.today,\n+                                                 'date_registered__lt': self.tomorrow})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct queryset is returned\n@@ -157,13 +158,12 @@ def test_datefieldlistfilter(self):\n         self.assertEqual(force_unicode(filterspec.title), u'date registered')\n         choice = select_by(filterspec.choices(changelist), \"display\", \"Today\")\n         self.assertEqual(choice['selected'], True)\n-        self.assertEqual(choice['query_string'], '?date_registered__day=%s'\n-                                                 '&date_registered__month=%s'\n-                                                 '&date_registered__year=%s'\n-                                                % (self.today.day, self.today.month, self.today.year))\n+        self.assertEqual(choice['query_string'], '?date_registered__gte=%s'\n+                                                 '&date_registered__lt=%s'\n+                                                % (self.today, self.tomorrow))\n \n-        request = self.request_factory.get('/', {'date_registered__year': self.today.year,\n-                                                 'date_registered__month': self.today.month})\n+        request = self.request_factory.get('/', {'date_registered__gte': self.today.replace(day=1),\n+                                                 'date_registered__lt': self.tomorrow})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct queryset is returned\n@@ -179,11 +179,12 @@ def test_datefieldlistfilter(self):\n         self.assertEqual(force_unicode(filterspec.title), u'date registered')\n         choice = select_by(filterspec.choices(changelist), \"display\", \"This month\")\n         self.assertEqual(choice['selected'], True)\n-        self.assertEqual(choice['query_string'], '?date_registered__month=%s'\n-                                                 '&date_registered__year=%s'\n-                                                % (self.today.month, self.today.year))\n+        self.assertEqual(choice['query_string'], '?date_registered__gte=%s'\n+                                                 '&date_registered__lt=%s'\n+                                                % (self.today.replace(day=1), self.tomorrow))\n \n-        request = self.request_factory.get('/', {'date_registered__year': self.today.year})\n+        request = self.request_factory.get('/', {'date_registered__gte': self.today.replace(month=1, day=1),\n+                                                 'date_registered__lt': self.tomorrow})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct queryset is returned\n@@ -199,11 +200,12 @@ def test_datefieldlistfilter(self):\n         self.assertEqual(force_unicode(filterspec.title), u'date registered')\n         choice = select_by(filterspec.choices(changelist), \"display\", \"This year\")\n         self.assertEqual(choice['selected'], True)\n-        self.assertEqual(choice['query_string'], '?date_registered__year=%s'\n-                                                % (self.today.year))\n+        self.assertEqual(choice['query_string'], '?date_registered__gte=%s'\n+                                                 '&date_registered__lt=%s'\n+                                                % (self.today.replace(month=1, day=1), self.tomorrow))\n \n         request = self.request_factory.get('/', {'date_registered__gte': str(self.one_week_ago),\n-                                                 'date_registered__lte': str(self.today)})\n+                                                 'date_registered__lt': str(self.tomorrow)})\n         changelist = self.get_changelist(request, Book, modeladmin)\n \n         # Make sure the correct queryset is returned\n@@ -216,8 +218,13 @@ def test_datefieldlistfilter(self):\n         choice = select_by(filterspec.choices(changelist), \"display\", \"Past 7 days\")\n         self.assertEqual(choice['selected'], True)\n         self.assertEqual(choice['query_string'], '?date_registered__gte=%s'\n-                                                 '&date_registered__lte=%s'\n-                                                % (str(self.one_week_ago), str(self.today)))\n+                                                 '&date_registered__lt=%s'\n+                                                % (str(self.one_week_ago), str(self.tomorrow)))\n+\n+    @override_settings(USE_TZ=True)\n+    def test_datefieldlistfilter_with_time_zone_support(self):\n+        # Regression for #17830\n+        self.test_datefieldlistfilter()\n \n     def test_allvaluesfieldlistfilter(self):\n         modeladmin = BookAdmin(Book, site)"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 53,
        "deletions": 40
    }
}