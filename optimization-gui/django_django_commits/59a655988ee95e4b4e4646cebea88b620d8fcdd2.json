{
    "author": "akaariai",
    "message": "Fixed #13844 -- Avoid converting unknown db values to float\n\nThis patch removes an unconditional float(value) conversion from db\nbackend default convert_values() method. This can cause problems when\naggregating over character fields for example. In addition, Oracle\nand SQLite already return the bare value from their convert_values().\n\nIn the long term the converting should be done by fields, and the\nfields should then call database backend specific converters when\nneeded. The current setup is inflexible for 3rd party fields.\n\nThanks to Merlijn van Deen for the original patch.",
    "sha": "59a655988ee95e4b4e4646cebea88b620d8fcdd2",
    "files": [
        {
            "sha": "9f64cfc5f0582cf8862b7013e5dae2736718f81d",
            "filename": "django/db/backends/__init__.py",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/59a655988ee95e4b4e4646cebea88b620d8fcdd2/django%2Fdb%2Fbackends%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/59a655988ee95e4b4e4646cebea88b620d8fcdd2/django%2Fdb%2Fbackends%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2F__init__.py?ref=59a655988ee95e4b4e4646cebea88b620d8fcdd2",
            "patch": "@@ -878,19 +878,19 @@ def year_lookup_bounds_for_date_field(self, value):\n         return self.year_lookup_bounds(value)\n \n     def convert_values(self, value, field):\n-        \"\"\"Coerce the value returned by the database backend into a consistent type that\n-        is compatible with the field type.\n+        \"\"\"\n+        Coerce the value returned by the database backend into a consistent type\n+        that is compatible with the field type.\n         \"\"\"\n         internal_type = field.get_internal_type()\n         if internal_type == 'DecimalField':\n             return value\n-        elif internal_type and internal_type.endswith('IntegerField') or internal_type == 'AutoField':\n+        elif (internal_type and (internal_type.endswith('IntegerField')\n+                                 or internal_type == 'AutoField')):\n             return int(value)\n         elif internal_type in ('DateField', 'DateTimeField', 'TimeField'):\n             return value\n-        # No field, or the field isn't known to be a decimal or integer\n-        # Default to a float\n-        return float(value)\n+        return value\n \n     def check_aggregate_support(self, aggregate_func):\n         \"\"\"Check that the backend supports the provided aggregate"
        },
        {
            "sha": "b9f3ab27eb93bb90fd8cb57f62021c11319f3304",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/django/django/blob/59a655988ee95e4b4e4646cebea88b620d8fcdd2/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/59a655988ee95e4b4e4646cebea88b620d8fcdd2/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=59a655988ee95e4b4e4646cebea88b620d8fcdd2",
            "patch": "@@ -866,3 +866,15 @@ def test_filtering_by_annotation_name(self):\n             ['Peter Norvig'],\n             lambda b: b.name\n         )\n+\n+    def test_type_conversion(self):\n+        # The database backend convert_values function should not try to covert\n+        # CharFields to float. Refs #13844.\n+        from django.db.models import CharField\n+        from django.db import connection\n+        testData = 'not_a_float_value'\n+        testField = CharField()\n+        self.assertEqual(\n+            connection.ops.convert_values(testData, testField),\n+            testData\n+        )"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 18,
        "deletions": 6
    }
}