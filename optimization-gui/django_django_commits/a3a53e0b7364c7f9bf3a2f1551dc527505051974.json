{
    "author": "jezdez",
    "message": "Fixed #15561 -- Extended test setting override code added in r16165 with a decorator and a signal for setting changes.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16237 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "a3a53e0b7364c7f9bf3a2f1551dc527505051974",
    "files": [
        {
            "sha": "e29f4704bb358707172384d31976d0ceb637da68",
            "filename": "django/test/signals.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/django%2Ftest%2Fsignals.py",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/django%2Ftest%2Fsignals.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Fsignals.py?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -1,3 +1,5 @@\n from django.dispatch import Signal\n \n template_rendered = Signal(providing_args=[\"template\", \"context\"])\n+\n+setting_changed = Signal(providing_args=[\"setting\", \"value\"])"
        },
        {
            "sha": "bfa1aeb21928c98cf06d4a8a6433bacffb075847",
            "filename": "django/test/testcases.py",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/django%2Ftest%2Ftestcases.py",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/django%2Ftest%2Ftestcases.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Ftestcases.py?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -2,7 +2,6 @@\n \n import re\n import sys\n-from contextlib import contextmanager\n from functools import wraps\n from urlparse import urlsplit, urlunsplit\n from xml.dom.minidom import parseString, Node\n@@ -17,7 +16,7 @@\n from django.http import QueryDict\n from django.test import _doctest as doctest\n from django.test.client import Client\n-from django.test.utils import get_warnings_state, restore_warnings_state\n+from django.test.utils import get_warnings_state, restore_warnings_state, override_settings\n from django.utils import simplejson, unittest as ut2\n from django.utils.encoding import smart_str\n \n@@ -342,21 +341,12 @@ def restore_warnings_state(self):\n         \"\"\"\n         restore_warnings_state(self._warnings_state)\n \n-    @contextmanager\n-    def settings(self, **options):\n+    def settings(self, **kwargs):\n         \"\"\"\n         A context manager that temporarily sets a setting and reverts\n         back to the original value when exiting the context.\n         \"\"\"\n-        old_wrapped = settings._wrapped\n-        override = UserSettingsHolder(settings._wrapped)\n-        try:\n-            for key, new_value in options.items():\n-                setattr(override, key, new_value)\n-            settings._wrapped = override\n-            yield\n-        finally:\n-            settings._wrapped = old_wrapped\n+        return override_settings(**kwargs)\n \n     def assertRedirects(self, response, expected_url, status_code=302,\n                         target_status_code=200, host=None, msg_prefix=''):"
        },
        {
            "sha": "c394dacfd61eb4a0f8e4f308978b0c29db412b92",
            "filename": "django/test/utils.py",
            "status": "modified",
            "additions": 54,
            "deletions": 5,
            "changes": 59,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/django%2Ftest%2Futils.py",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/django%2Ftest%2Futils.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Ftest%2Futils.py?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -1,17 +1,23 @@\n+from __future__ import with_statement\n+\n import sys\n import time\n import os\n import warnings\n-from django.conf import settings\n+from django.conf import settings, UserSettingsHolder\n from django.core import mail\n from django.core.mail.backends import locmem\n-from django.test import signals\n+from django.test.signals import template_rendered, setting_changed\n from django.template import Template, loader, TemplateDoesNotExist\n from django.template.loaders import cached\n from django.utils.translation import deactivate\n+from django.utils.functional import wraps\n+\n \n-__all__ = ('Approximate', 'ContextList', 'setup_test_environment',\n-       'teardown_test_environment', 'get_runner')\n+__all__ = (\n+    'Approximate', 'ContextList',  'get_runner', 'override_settings',\n+    'setup_test_environment', 'teardown_test_environment',\n+)\n \n RESTORE_LOADERS_ATTR = '_original_template_source_loaders'\n \n@@ -56,7 +62,7 @@ def instrumented_test_render(self, context):\n     An instrumented Template render method, providing a signal\n     that can be intercepted by the test system Client\n     \"\"\"\n-    signals.template_rendered.send(sender=self, template=self, context=context)\n+    template_rendered.send(sender=self, template=self, context=context)\n     return self.nodelist.render(context)\n \n \n@@ -160,3 +166,46 @@ def restore_template_loaders():\n     \"\"\"\n     loader.template_source_loaders = getattr(loader, RESTORE_LOADERS_ATTR)\n     delattr(loader, RESTORE_LOADERS_ATTR)\n+\n+\n+class OverrideSettingsHolder(UserSettingsHolder):\n+    \"\"\"\n+    A custom setting holder that sends a signal upon change.\n+    \"\"\"\n+    def __setattr__(self, name, value):\n+        UserSettingsHolder.__setattr__(self, name, value)\n+        setting_changed.send(sender=name, setting=name, value=value)\n+\n+\n+class override_settings(object):\n+    \"\"\"\n+    Acts as either a decorator, or a context manager. If it's a decorator it\n+    takes a function and returns a wrapped function. If it's a contextmanager\n+    it's used with the ``with`` statement. In either event entering/exiting\n+    are called before and after, respectively, the function/block is executed.\n+    \"\"\"\n+    def __init__(self, **kwargs):\n+        self.options = kwargs\n+        self.wrapped = settings._wrapped\n+\n+    def __enter__(self):\n+        self.enable()\n+\n+    def __exit__(self, exc_type, exc_value, traceback):\n+        self.disable()\n+\n+    def __call__(self, func):\n+        @wraps(func)\n+        def inner(*args, **kwargs):\n+            with self:\n+                return func(*args, **kwargs)\n+        return inner\n+\n+    def enable(self):\n+        override = OverrideSettingsHolder(settings._wrapped)\n+        for key, new_value in self.options.items():\n+            setattr(override, key, new_value)\n+        settings._wrapped = override\n+\n+    def disable(self):\n+        settings._wrapped = self.wrapped"
        },
        {
            "sha": "67476a072f90529a5a7e0b40ef49404b25fc83c0",
            "filename": "docs/ref/signals.txt",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/docs%2Fref%2Fsignals.txt",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/docs%2Fref%2Fsignals.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsignals.txt?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -460,6 +460,29 @@ Test signals\n \n Signals only sent when :doc:`running tests </topics/testing>`.\n \n+setting_changed\n+---------------\n+\n+.. versionadded:: 1.4\n+\n+.. data:: django.test.signals.setting_changed\n+   :module:\n+\n+Sent when some :ref:`settings are overridden <overriding-setting>` with the\n+:meth:`django.test.TestCase.setting` context manager or the\n+:func:`django.test.utils.override_settings` decorator/context manager.\n+\n+Arguments sent with this signal:\n+\n+``sender``\n+    The setting name (string).\n+\n+``setting``\n+    Same as sender\n+\n+``value``\n+    The new setting value.\n+\n template_rendered\n -----------------\n "
        },
        {
            "sha": "36045d2fd7e36dd716aca56628bed7715d2b17f9",
            "filename": "docs/topics/testing.txt",
            "status": "modified",
            "additions": 61,
            "deletions": 1,
            "changes": 62,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/docs%2Ftopics%2Ftesting.txt",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/docs%2Ftopics%2Ftesting.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Ftesting.txt?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -1361,6 +1361,8 @@ For example::\n This test case will flush *all* the test databases before running\n ``testIndexPageView``.\n \n+.. _overriding-setting:\n+\n Overriding settings\n ~~~~~~~~~~~~~~~~~~~\n \n@@ -1376,15 +1378,73 @@ this use case Django provides a standard `Python context manager`_\n     from django.test import TestCase\n \n     class LoginTestCase(TestCase):\n-        def test_overriding_settings(self):\n+\n+        def test_login(self):\n+\n+            # First check for the default behavior\n+            response = self.client.get('/sekrit/')\n+            self.assertRedirects(response, '/accounts/login/?next=/sekrit/')\n+\n+            # Then override the LOGING_URL setting\n             with self.settings(LOGIN_URL='/other/login/'):\n                 response = self.client.get('/sekrit/')\n                 self.assertRedirects(response, '/other/login/?next=/sekrit/')\n \n This example will override the :setting:`LOGIN_URL` setting for the code\n in the ``with`` block and reset its value to the previous state afterwards.\n \n+.. function:: utils.override_settings\n+\n+In case you want to override a setting for just one test method or even the\n+whole TestCase class, Django provides the\n+:func:`django.test.utils.override_settings` decorator_. It's used like this::\n+\n+    from django.test import TestCase\n+    from django.test.utils import override_settings\n+\n+    class LoginTestCase(TestCase):\n+\n+        @override_settings(LOGIN_URL='/other/login/')\n+        def test_login(self):\n+            response = self.client.get('/sekrit/')\n+            self.assertRedirects(response, '/other/login/?next=/sekrit/')\n+\n+The decorator can also be applied to test case classes::\n+\n+    from django.test import TestCase\n+    from django.test.utils import override_settings\n+\n+    class LoginTestCase(TestCase):\n+\n+        def test_login(self):\n+            response = self.client.get('/sekrit/')\n+            self.assertRedirects(response, '/other/login/?next=/sekrit/')\n+\n+    LoginTestCase = override_settings(LOGIN_URL='/other/login/')(LoginTestCase)\n+\n+On Python 2.6 and higher you can also use the well known decorator syntax to\n+decorate the class::\n+\n+    from django.test import TestCase\n+    from django.test.utils import override_settings\n+\n+    @override_settings(LOGIN_URL='/other/login/')\n+    class LoginTestCase(TestCase):\n+\n+        def test_login(self):\n+            response = self.client.get('/sekrit/')\n+            self.assertRedirects(response, '/other/login/?next=/sekrit/')\n+\n+.. note::\n+\n+    When overriding settings make sure to also handle the cases in which\n+    Django or your app's code use a cache or another feature that retain\n+    state even if the setting is changed. Django provides the\n+    :data:`django.test.signals.setting_changed` signal to connect cleanup\n+    and other state resetting callbacks to.\n+\n .. _`Python context manager`: http://www.python.org/dev/peps/pep-0343/\n+.. _`decorator`: http://www.python.org/dev/peps/pep-0318/\n \n Emptying the test outbox\n ~~~~~~~~~~~~~~~~~~~~~~~~"
        },
        {
            "sha": "5d5f52b6cdc68c4c3600c6627dcc7506158e9b82",
            "filename": "tests/regressiontests/mail/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 48,
            "changes": 67,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/tests%2Fregressiontests%2Fmail%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmail%2Ftests.py?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -9,48 +9,14 @@\n import tempfile\n import threading\n \n-from django.conf import settings\n from django.core import mail\n from django.core.mail import (EmailMessage, mail_admins, mail_managers,\n         EmailMultiAlternatives, send_mail, send_mass_mail)\n from django.core.mail.backends import console, dummy, locmem, filebased, smtp\n from django.core.mail.message import BadHeaderError\n from django.test import TestCase\n+from django.test.utils import override_settings\n from django.utils.translation import ugettext_lazy\n-from django.utils.functional import wraps\n-\n-\n-def alter_django_settings(**kwargs):\n-    oldvalues = {}\n-    nonexistant = []\n-    for setting, newvalue in kwargs.iteritems():\n-        try:\n-            oldvalues[setting] = getattr(settings, setting)\n-        except AttributeError:\n-            nonexistant.append(setting)\n-        setattr(settings, setting, newvalue)\n-    return oldvalues, nonexistant\n-\n-\n-def restore_django_settings(state):\n-    oldvalues, nonexistant = state\n-    for setting, oldvalue in oldvalues.iteritems():\n-        setattr(settings, setting, oldvalue)\n-    for setting in nonexistant:\n-        delattr(settings, setting)\n-\n-\n-def with_django_settings(**kwargs):\n-    def decorator(test):\n-        @wraps(test)\n-        def decorated_test(self):\n-            state = alter_django_settings(**kwargs)\n-            try:\n-                return test(self)\n-            finally:\n-                restore_django_settings(state)\n-        return decorated_test\n-    return decorator\n \n \n class MailTests(TestCase):\n@@ -251,7 +217,7 @@ def test_backend_arg(self):\n             shutil.rmtree(tmp_dir)\n         self.assertTrue(isinstance(mail.get_connection(), locmem.EmailBackend))\n \n-    @with_django_settings(\n+    @override_settings(\n         EMAIL_BACKEND='django.core.mail.backends.locmem.EmailBackend',\n         ADMINS=[('nobody', 'nobody@example.com')],\n         MANAGERS=[('nobody', 'nobody@example.com')])\n@@ -323,10 +289,11 @@ class BaseEmailBackendTests(object):\n     email_backend = None\n \n     def setUp(self):\n-        self.__settings_state = alter_django_settings(EMAIL_BACKEND=self.email_backend)\n+        self.settings_override = override_settings(EMAIL_BACKEND=self.email_backend)\n+        self.settings_override.enable()\n \n     def tearDown(self):\n-        restore_django_settings(self.__settings_state)\n+        self.settings_override.disable()\n \n     def assertStartsWith(self, first, second):\n         if not first.startswith(second):\n@@ -375,7 +342,7 @@ def test_send_verbose_name(self):\n         self.assertEqual(message.get_payload(), \"Content\")\n         self.assertEqual(message[\"from\"], \"=?utf-8?q?Firstname_S=C3=BCrname?= <from@example.com>\")\n \n-    @with_django_settings(MANAGERS=[('nobody', 'nobody@example.com')])\n+    @override_settings(MANAGERS=[('nobody', 'nobody@example.com')])\n     def test_html_mail_managers(self):\n         \"\"\"Test html_message argument to mail_managers\"\"\"\n         mail_managers('Subject', 'Content', html_message='HTML Content')\n@@ -390,7 +357,7 @@ def test_html_mail_managers(self):\n         self.assertEqual(message.get_payload(1).get_payload(), 'HTML Content')\n         self.assertEqual(message.get_payload(1).get_content_type(), 'text/html')\n \n-    @with_django_settings(ADMINS=[('nobody', 'nobody@example.com')])\n+    @override_settings(ADMINS=[('nobody', 'nobody@example.com')])\n     def test_html_mail_admins(self):\n         \"\"\"Test html_message argument to mail_admins \"\"\"\n         mail_admins('Subject', 'Content', html_message='HTML Content')\n@@ -405,8 +372,9 @@ def test_html_mail_admins(self):\n         self.assertEqual(message.get_payload(1).get_payload(), 'HTML Content')\n         self.assertEqual(message.get_payload(1).get_content_type(), 'text/html')\n \n-    @with_django_settings(ADMINS=[('nobody', 'nobody+admin@example.com')],\n-                         MANAGERS=[('nobody', 'nobody+manager@example.com')])\n+    @override_settings(\n+        ADMINS=[('nobody', 'nobody+admin@example.com')],\n+        MANAGERS=[('nobody', 'nobody+manager@example.com')])\n     def test_manager_and_admin_mail_prefix(self):\n         \"\"\"\n         String prefix + lazy translated subject = bad output\n@@ -421,7 +389,7 @@ def test_manager_and_admin_mail_prefix(self):\n         message = self.get_the_message()\n         self.assertEqual(message.get('subject'), '[Django] Subject')\n \n-    @with_django_settings(ADMINS=(), MANAGERS=())\n+    @override_settings(ADMINS=(), MANAGERS=())\n     def test_empty_admins(self):\n         \"\"\"\n         Test that mail_admins/mail_managers doesn't connect to the mail server\n@@ -501,13 +469,14 @@ class FileBackendTests(BaseEmailBackendTests, TestCase):\n     email_backend = 'django.core.mail.backends.filebased.EmailBackend'\n \n     def setUp(self):\n-        super(FileBackendTests, self).setUp()\n         self.tmp_dir = tempfile.mkdtemp()\n-        self.__settings_state = alter_django_settings(EMAIL_FILE_PATH=self.tmp_dir)\n+        self.addCleanup(shutil.rmtree, self.tmp_dir)\n+        self.settings_override = override_settings(EMAIL_FILE_PATH=self.tmp_dir)\n+        self.settings_override.enable()\n+        super(FileBackendTests, self).setUp()\n \n     def tearDown(self):\n-        restore_django_settings(self.__settings_state)\n-        shutil.rmtree(self.tmp_dir)\n+        self.settings_override.disable()\n         super(FileBackendTests, self).tearDown()\n \n     def flush_mailbox(self):\n@@ -642,13 +611,15 @@ class SMTPBackendTests(BaseEmailBackendTests, TestCase):\n     @classmethod\n     def setUpClass(cls):\n         cls.server = FakeSMTPServer(('127.0.0.1', 0), None)\n-        cls.settings = alter_django_settings(\n+        cls.settings_override = override_settings(\n             EMAIL_HOST=\"127.0.0.1\",\n             EMAIL_PORT=cls.server.socket.getsockname()[1])\n+        cls.settings_override.enable()\n         cls.server.start()\n \n     @classmethod\n     def tearDownClass(cls):\n+        cls.settings_override.disable()\n         cls.server.stop()\n \n     def setUp(self):"
        },
        {
            "sha": "cb2f9e0f1a5f3cfc40376fde295a5205eeee9bb4",
            "filename": "tests/regressiontests/settings_tests/tests.py",
            "status": "modified",
            "additions": 54,
            "deletions": 2,
            "changes": 56,
            "blob_url": "https://github.com/django/django/blob/a3a53e0b7364c7f9bf3a2f1551dc527505051974/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a3a53e0b7364c7f9bf3a2f1551dc527505051974/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py?ref=a3a53e0b7364c7f9bf3a2f1551dc527505051974",
            "patch": "@@ -1,7 +1,22 @@\n from __future__ import with_statement\n-import os\n+import os, sys\n from django.conf import settings, global_settings\n-from django.test import TestCase\n+from django.test import TestCase, signals\n+from django.test.utils import override_settings\n+from django.utils.unittest import skipIf\n+\n+\n+class SettingGetter(object):\n+    def __init__(self):\n+        self.test = getattr(settings, 'TEST', 'undefined')\n+\n+testvalue = None\n+\n+def signal_callback(sender, setting, value, **kwargs):\n+    global testvalue\n+    testvalue = value\n+\n+signals.setting_changed.connect(signal_callback, sender='TEST')\n \n class SettingsTests(TestCase):\n \n@@ -29,6 +44,43 @@ def test_override_doesnt_leak(self):\n             settings.TEST = 'test'\n         self.assertRaises(AttributeError, getattr, settings, 'TEST')\n \n+    @override_settings(TEST='override')\n+    def test_decorator(self):\n+        self.assertEqual('override', settings.TEST)\n+\n+    def test_context_manager(self):\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+        override = override_settings(TEST='override')\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+        override.enable()\n+        self.assertEqual('override', settings.TEST)\n+        override.disable()\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+\n+    def test_class_decorator(self):\n+        self.assertEqual(SettingGetter().test, 'undefined')\n+        DecoratedSettingGetter = override_settings(TEST='override')(SettingGetter)\n+        self.assertEqual(DecoratedSettingGetter().test, 'override')\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+\n+    @skipIf(sys.version_info[:2] < (2, 6), \"Python version is lower than 2.6\")\n+    def test_new_class_decorator(self):\n+        self.assertEqual(SettingGetter().test, 'undefined')\n+        @override_settings(TEST='override')\n+        class DecoratedSettingGetter(SettingGetter):\n+            pass\n+        self.assertEqual(DecoratedSettingGetter().test, 'override')\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+\n+    def test_signal_callback_context_manager(self):\n+        self.assertRaises(AttributeError, getattr, settings, 'TEST')\n+        with self.settings(TEST='override'):\n+            self.assertEqual(testvalue, 'override')\n+\n+    @override_settings(TEST='override')\n+    def test_signal_callback_decorator(self):\n+        self.assertEqual(testvalue, 'override')\n+\n     #\n     # Regression tests for #10130: deleting settings.\n     #"
        }
    ],
    "stats": {
        "total": 285,
        "additions": 216,
        "deletions": 69
    }
}