{
    "author": "akaariai",
    "message": "Fixed #19351 -- SQLite bulk_insert of more than 500 single-field objs",
    "sha": "0a0a0d66b316598f7c296e8bf75749a14ce3ac49",
    "files": [
        {
            "sha": "6b6c6b67d9110d6295ea0167cc5624d80294e80d",
            "filename": "django/db/backends/sqlite3/base.py",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/0a0a0d66b316598f7c296e8bf75749a14ce3ac49/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/0a0a0d66b316598f7c296e8bf75749a14ce3ac49/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fbackends%2Fsqlite3%2Fbase.py?ref=0a0a0d66b316598f7c296e8bf75749a14ce3ac49",
            "patch": "@@ -120,8 +120,12 @@ def bulk_batch_size(self, fields, objs):\n         \"\"\"\n         SQLite has a compile-time default (SQLITE_LIMIT_VARIABLE_NUMBER) of\n         999 variables per query.\n+\n+        If there is just single field to insert, then we can hit another\n+        limit, SQLITE_MAX_COMPOUND_SELECT which defaults to 500.\n         \"\"\"\n-        return (999 // len(fields)) if len(fields) > 0 else len(objs)\n+        limit = 999 if len(fields) > 1 else 500\n+        return (limit // len(fields)) if len(fields) > 0 else len(objs)\n \n     def date_extract_sql(self, lookup_type, field_name):\n         # sqlite doesn't support extract, so we fake it with the user-defined"
        },
        {
            "sha": "d4772934a10dbe6d1d159f33d4aa24f487ebe789",
            "filename": "tests/regressiontests/bulk_create/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/0a0a0d66b316598f7c296e8bf75749a14ce3ac49/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0a0a0d66b316598f7c296e8bf75749a14ce3ac49/tests%2Fregressiontests%2Fbulk_create%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fbulk_create%2Ftests.py?ref=0a0a0d66b316598f7c296e8bf75749a14ce3ac49",
            "patch": "@@ -102,6 +102,14 @@ def test_large_batch(self):\n             101)\n         self.assertEqual(TwoFields.objects.filter(f2__gte=901).count(), 101)\n \n+    @skipUnlessDBFeature('has_bulk_insert')\n+    def test_large_single_field_batch(self):\n+        # SQLite had a problem with more than 500 UNIONed selects in single\n+        # query.\n+        Restaurant.objects.bulk_create([\n+            Restaurant() for i in range(0, 501)\n+        ])\n+\n     @skipUnlessDBFeature('has_bulk_insert')\n     def test_large_batch_efficiency(self):\n         with override_settings(DEBUG=True):"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 13,
        "deletions": 1
    }
}