{
    "author": "spookylukey",
    "message": "Fixed #17838 - prefetch_related fails for GenericForeignKeys when related object id is not a CharField/TextField\n\nThanks to mkai for the report and debugging, and tmitchell and Przemek\nLewandowski for their work on the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17744 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b018128ea5f9ad494afb0007c597bc61630dc087",
    "files": [
        {
            "sha": "a6732d7a2e33376a60fa36b93f4b2a642c125509",
            "filename": "django/contrib/contenttypes/generic.py",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/b018128ea5f9ad494afb0007c597bc61630dc087/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "raw_url": "https://github.com/django/django/raw/b018128ea5f9ad494afb0007c597bc61630dc087/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fgeneric.py?ref=b018128ea5f9ad494afb0007c597bc61630dc087",
            "patch": "@@ -85,16 +85,16 @@ def get_prefetch_query_set(self, instances):\n             ret_val.extend(ct.get_all_objects_for_this_type(pk__in=fkeys))\n \n         # For doing the join in Python, we have to match both the FK val and the\n-        # content type, so the 'attr' vals we return need to be callables that\n-        # will return a (fk, class) pair.\n+        # content type, so we use a callable that returns a (fk, class) pair.\n         def gfk_key(obj):\n             ct_id = getattr(obj, ct_attname)\n             if ct_id is None:\n                 return None\n             else:\n-                return (getattr(obj, self.fk_field),\n-                        self.get_content_type(id=ct_id,\n-                                              using=obj._state.db).model_class())\n+                model = self.get_content_type(id=ct_id,\n+                                              using=obj._state.db).model_class()\n+                return (model._meta.pk.get_prep_value(getattr(obj, self.fk_field)),\n+                        model)\n \n         return (ret_val,\n                 lambda obj: (obj._get_pk_val(), obj.__class__),"
        },
        {
            "sha": "1dc034fa6c5991689518b3ff0abfc5a582d67136",
            "filename": "tests/modeltests/prefetch_related/models.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/b018128ea5f9ad494afb0007c597bc61630dc087/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/b018128ea5f9ad494afb0007c597bc61630dc087/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Fmodels.py?ref=b018128ea5f9ad494afb0007c597bc61630dc087",
            "patch": "@@ -125,6 +125,15 @@ class Bookmark(models.Model):\n     tags = generic.GenericRelation(TaggedItem)\n \n \n+class Comment(models.Model):\n+    comment = models.TextField()\n+\n+    # Content-object field\n+    content_type   = models.ForeignKey(ContentType)\n+    object_pk      = models.TextField()\n+    content_object = generic.GenericForeignKey(ct_field=\"content_type\", fk_field=\"object_pk\")\n+\n+\n ## Models for lookup ordering tests\n \n "
        },
        {
            "sha": "b0bc4359415b04970e7c712a4e93fac99e36c3e4",
            "filename": "tests/modeltests/prefetch_related/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/b018128ea5f9ad494afb0007c597bc61630dc087/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b018128ea5f9ad494afb0007c597bc61630dc087/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Fprefetch_related%2Ftests.py?ref=b018128ea5f9ad494afb0007c597bc61630dc087",
            "patch": "@@ -5,7 +5,7 @@\n \n from .models import (Author, Book, Reader, Qualification, Teacher, Department,\n     TaggedItem, Bookmark, AuthorAddress, FavoriteAuthors, AuthorWithAge,\n-    BookWithYear, Person, House, Room, Employee)\n+    BookWithYear, Person, House, Room, Employee, Comment)\n \n \n class PrefetchRelatedTests(TestCase):\n@@ -254,6 +254,14 @@ def test_prefetch_GFK(self):\n             qs = TaggedItem.objects.prefetch_related('content_object')\n             list(qs)\n \n+    def test_prefetch_GFK_nonint_pk(self):\n+        Comment.objects.create(comment=\"awesome\", content_object=self.book1)\n+\n+        # 1 for Comment table, 1 for Book table\n+        with self.assertNumQueries(2):\n+            qs = Comment.objects.prefetch_related('content_object')\n+            [c.content_object for c in qs]\n+\n     def test_traverse_GFK(self):\n         \"\"\"\n         Test that we can traverse a 'content_object' with prefetch_related() and"
        },
        {
            "sha": "69c1a8118f3bb3852a4a37410b1eceaa0ae72d26",
            "filename": "tests/regressiontests/comment_tests/tests/model_tests.py",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/django/django/blob/b018128ea5f9ad494afb0007c597bc61630dc087/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fmodel_tests.py",
            "raw_url": "https://github.com/django/django/raw/b018128ea5f9ad494afb0007c597bc61630dc087/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fmodel_tests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fcomment_tests%2Ftests%2Fmodel_tests.py?ref=b018128ea5f9ad494afb0007c597bc61630dc087",
            "patch": "@@ -49,3 +49,10 @@ def testForModel(self):\n         author_comments = list(Comment.objects.for_model(Author.objects.get(pk=1)))\n         self.assertEqual(article_comments, [c1, c3])\n         self.assertEqual(author_comments, [c2])\n+\n+    def testPrefetchRelated(self):\n+        c1, c2, c3, c4 = self.createSomeComments()\n+        # one for comments, one for Articles, one for Author\n+        with self.assertNumQueries(3):\n+            qs = Comment.objects.prefetch_related('content_object')\n+            [c.content_object for c in qs]"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 30,
        "deletions": 6
    }
}