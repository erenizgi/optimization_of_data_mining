{
    "author": "adrianholovaty",
    "message": "Fixed #14597 -- Added a SECURE_PROXY_SSL_HEADER setting for cases when you're behind a proxy that 'swallows' the fact that a request is HTTPS\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17209 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "61f0aff811aa596fa62136852c59d47f988d1185",
    "files": [
        {
            "sha": "6932340daf7e87c92e4b9e9258fec3b8a9dcf7c9",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=61f0aff811aa596fa62136852c59d47f988d1185",
            "patch": "@@ -419,6 +419,15 @@\n # actual WSGI application object.\n WSGI_APPLICATION = None\n \n+# If your Django app is behind a proxy that sets a header to specify secure\n+# connections, AND that proxy ensures that user-submitted headers with the\n+# same name are ignored (so that people can't spoof it), set this value to\n+# a tuple of (header_name, header_value). For any requests that come in with\n+# that header/value, request.is_secure() will return True.\n+# WARNING! Only set this if you fully understand what you're doing. Otherwise,\n+# you may be opening yourself up to a security risk.\n+SECURE_PROXY_SSL_HEADER = None\n+\n ##############\n # MIDDLEWARE #\n ##############"
        },
        {
            "sha": "fb23fb497a7a5dbd1b67bbc835964abd0096aa2c",
            "filename": "django/core/handlers/modpython.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fcore%2Fhandlers%2Fmodpython.py",
            "raw_url": "https://github.com/django/django/raw/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fcore%2Fhandlers%2Fmodpython.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fmodpython.py?ref=61f0aff811aa596fa62136852c59d47f988d1185",
            "patch": "@@ -44,7 +44,7 @@ def get_full_path(self):\n         # doesn't always happen, so rather than crash, we defensively encode it.\n         return '%s%s' % (self.path, self._req.args and ('?' + iri_to_uri(self._req.args)) or '')\n \n-    def is_secure(self):\n+    def _is_secure(self):\n         try:\n             return self._req.is_https()\n         except AttributeError:"
        },
        {
            "sha": "2898703a959db21b03457f881f9f9febb06f5e43",
            "filename": "django/core/handlers/wsgi.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "raw_url": "https://github.com/django/django/raw/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fcore%2Fhandlers%2Fwsgi.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fwsgi.py?ref=61f0aff811aa596fa62136852c59d47f988d1185",
            "patch": "@@ -158,9 +158,8 @@ def get_full_path(self):\n         # Rather than crash if this doesn't happen, we encode defensively.\n         return '%s%s' % (self.path, self.environ.get('QUERY_STRING', '') and ('?' + iri_to_uri(self.environ.get('QUERY_STRING', ''))) or '')\n \n-    def is_secure(self):\n-        return 'wsgi.url_scheme' in self.environ \\\n-            and self.environ['wsgi.url_scheme'] == 'https'\n+    def _is_secure(self):\n+        return 'wsgi.url_scheme' in self.environ and self.environ['wsgi.url_scheme'] == 'https'\n \n     def _get_request(self):\n         if not hasattr(self, '_request'):"
        },
        {
            "sha": "414440b9d9f1cbcf24bbed9be09dfb15f12f4993",
            "filename": "django/http/__init__.py",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fhttp%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/61f0aff811aa596fa62136852c59d47f988d1185/django%2Fhttp%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fhttp%2F__init__.py?ref=61f0aff811aa596fa62136852c59d47f988d1185",
            "patch": "@@ -113,6 +113,7 @@ def __init__(self, *args, **kwargs):\n \n from django.conf import settings\n from django.core import signing\n+from django.core.exceptions import ImproperlyConfigured\n from django.core.files import uploadhandler\n from django.http.multipartparser import MultiPartParser\n from django.http.utils import *\n@@ -251,9 +252,23 @@ def build_absolute_uri(self, location=None):\n             location = urljoin(current_uri, location)\n         return iri_to_uri(location)\n \n-    def is_secure(self):\n+    def _is_secure(self):\n         return os.environ.get(\"HTTPS\") == \"on\"\n \n+    def is_secure(self):\n+        # First, check the SECURE_PROXY_SSL_HEADER setting.\n+        if settings.SECURE_PROXY_SSL_HEADER:\n+            try:\n+                header, value = settings.SECURE_PROXY_SSL_HEADER\n+            except ValueError:\n+                raise ImproperlyConfigured('The SECURE_PROXY_SSL_HEADER setting must be a tuple containing two values.')\n+            if self.META.get(header, None) == value:\n+                return True\n+\n+        # Failing that, fall back to _is_secure(), which is a hook for\n+        # subclasses to implement.\n+        return self._is_secure()\n+\n     def is_ajax(self):\n         return self.META.get('HTTP_X_REQUESTED_WITH') == 'XMLHttpRequest'\n "
        },
        {
            "sha": "cb659a21fda983482c730f151d407aee65e24fa3",
            "filename": "docs/ref/settings.txt",
            "status": "modified",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/django/django/blob/61f0aff811aa596fa62136852c59d47f988d1185/docs%2Fref%2Fsettings.txt",
            "raw_url": "https://github.com/django/django/raw/61f0aff811aa596fa62136852c59d47f988d1185/docs%2Fref%2Fsettings.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fsettings.txt?ref=61f0aff811aa596fa62136852c59d47f988d1185",
            "patch": "@@ -1530,6 +1530,64 @@ better. ``django-admin.py startproject`` creates one automatically.\n \n .. setting:: SEND_BROKEN_LINK_EMAILS\n \n+SECURE_PROXY_SSL_HEADER\n+-----------------------\n+\n+.. versionadded:: 1.4\n+\n+Default: ``None``\n+\n+A tuple representing a HTTP header/value combination that signifies a request\n+is secure. This controls the behavior of the request object's ``is_secure()``\n+method.\n+\n+This takes some explanation. By default, ``is_secure()`` is able to determine\n+whether a request is secure by looking at whether the requested URL uses\n+\"https://\".\n+\n+If your Django app is behind a proxy, though, the proxy may be \"swallowing\" the\n+fact that a request is HTTPS, using a non-HTTPS connection between the proxy\n+and Django. In this case, ``is_secure()`` would always return ``False`` -- even\n+for requests that were made via HTTPS by the end user.\n+\n+In this situation, you'll want to configure your proxy to set a custom HTTP\n+header that tells Django whether the request came in via HTTPS, and you'll want\n+to set ``SECURE_PROXY_SSL_HEADER`` so that Django knows what header to look\n+for.\n+\n+You'll need to set a tuple with two elements -- the name of the header to look\n+for and the required value. For example::\n+\n+    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTOCOL', 'https')\n+\n+Here, we're telling Django that we trust the ``X-Forwarded-Protocol`` header\n+that comes from our proxy, and any time its value is ``'https'``, then the\n+request is guaranteed to be secure (i.e., it originally came in via HTTPS).\n+Obviously, you should *only* set this setting if you control your proxy or\n+have some other guarantee that it sets/strips this header appropriately.\n+\n+Note that the header needs to be in the format as used by ``request.META`` --\n+all caps and likely starting with ``HTTP_``. (Remember, Django automatically\n+adds ``'HTTP_'`` to the start of x-header names before making the header\n+available in ``request.META``.)\n+\n+.. warning::\n+\n+    **You will probably open security holes in your site if you set this without knowing what you're doing. Seriously.**\n+\n+    Make sure ALL of the following are true before setting this (assuming the\n+    values from the example above):\n+\n+    * Your Django app is behind a proxy.\n+    * Your proxy strips the 'X-Forwarded-Protocol' header from all incoming\n+      requests. In other words, if end users include that header in their\n+      requests, the proxy will discard it.\n+    * Your proxy sets the 'X-Forwarded-Protocol' header and sends it to Django,\n+      but only for requests that originally come in via HTTPS.\n+\n+    If any of those are not true, you should keep this setting set to ``None``\n+    and find another way of determining HTTPS, perhaps via custom middleware.\n+\n SEND_BROKEN_LINK_EMAILS\n -----------------------\n "
        },
        {
            "sha": "c250aea1ace85eb80c8fcaefa4ce7e850b1b8243",
            "filename": "tests/regressiontests/settings_tests/tests.py",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/django/django/blob/61f0aff811aa596fa62136852c59d47f988d1185/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/61f0aff811aa596fa62136852c59d47f988d1185/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fsettings_tests%2Ftests.py?ref=61f0aff811aa596fa62136852c59d47f988d1185",
            "patch": "@@ -3,6 +3,7 @@\n import os\n \n from django.conf import settings, global_settings\n+from django.http import HttpRequest\n from django.test import TransactionTestCase, TestCase, signals\n from django.test.utils import override_settings\n \n@@ -209,6 +210,36 @@ def test_double_slash(self):\n         self.assertEqual('http://media.foo.com/stupid//',\n                          self.settings_module.MEDIA_URL)\n \n+class SecureProxySslHeaderTest(TestCase):\n+    settings_module = settings\n+\n+    def setUp(self):\n+        self._original_setting = self.settings_module.SECURE_PROXY_SSL_HEADER\n+\n+    def tearDown(self):\n+        self.settings_module.SECURE_PROXY_SSL_HEADER = self._original_setting\n+\n+    def test_none(self):\n+        self.settings_module.SECURE_PROXY_SSL_HEADER = None\n+        req = HttpRequest()\n+        self.assertEqual(req.is_secure(), False)\n+\n+    def test_set_without_xheader(self):\n+        self.settings_module.SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTOCOL', 'https')\n+        req = HttpRequest()\n+        self.assertEqual(req.is_secure(), False)\n+\n+    def test_set_with_xheader_wrong(self):\n+        self.settings_module.SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTOCOL', 'https')\n+        req = HttpRequest()\n+        req.META['HTTP_X_FORWARDED_PROTOCOL'] = 'wrongvalue'\n+        self.assertEqual(req.is_secure(), False)\n+\n+    def test_set_with_xheader_right(self):\n+        self.settings_module.SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTOCOL', 'https')\n+        req = HttpRequest()\n+        req.META['HTTP_X_FORWARDED_PROTOCOL'] = 'https'\n+        self.assertEqual(req.is_secure(), True)\n \n class EnvironmentVariableTest(TestCase):\n     \"\"\""
        }
    ],
    "stats": {
        "total": 122,
        "additions": 117,
        "deletions": 5
    }
}