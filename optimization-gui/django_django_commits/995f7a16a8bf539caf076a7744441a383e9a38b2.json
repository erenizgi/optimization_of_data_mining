{
    "author": "jphalip",
    "message": "Fixed #17281 -- Prevented `AdminErrorHandler` from silently failing if the log message contains newlines. Thanks to Russell Keith-Magee for the report and to Bartolome Sanchez Salado and Marcin Wróbel for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17501 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "995f7a16a8bf539caf076a7744441a383e9a38b2",
    "files": [
        {
            "sha": "5fa21d3f8ec06c1ded22b7d787897154c91b0ed0",
            "filename": "AUTHORS",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/995f7a16a8bf539caf076a7744441a383e9a38b2/AUTHORS",
            "raw_url": "https://github.com/django/django/raw/995f7a16a8bf539caf076a7744441a383e9a38b2/AUTHORS",
            "contents_url": "https://api.github.com/repos/django/django/contents/AUTHORS?ref=995f7a16a8bf539caf076a7744441a383e9a38b2",
            "patch": "@@ -450,6 +450,7 @@ answer newbie questions, and generally made Django that much better:\n     Manuel Saelices <msaelices@yaco.es>\n     Ivan Sagalaev (Maniac) <http://www.softwaremaniacs.org/>\n     Vinay Sajip <vinay_sajip@yahoo.co.uk>\n+    Bartolome Sanchez Salado <i42sasab@uco.es>\n     Kadesarin Sanjek\n     Massimo Scamarcia <massimo.scamarcia@gmail.com>\n     Paulo Scardine <paulo@scardine.com.br>\n@@ -548,6 +549,7 @@ answer newbie questions, and generally made Django that much better:\n     Jakub Wiśniowski <restless.being@gmail.com>\n     Maciej Wiśniowski <pigletto@gmail.com>\n     wojtek\n+    Marcin Wróbel\n     Jason Yan <tailofthesun@gmail.com>\n     Lars Yencken <lars.yencken@gmail.com>\n     ye7cakf02@sneakemail.com"
        },
        {
            "sha": "16ad5f05de2d162c790d892f49da46efe5d6ea31",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/django/django/blob/995f7a16a8bf539caf076a7744441a383e9a38b2/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/995f7a16a8bf539caf076a7744441a383e9a38b2/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=995f7a16a8bf539caf076a7744441a383e9a38b2",
            "patch": "@@ -47,18 +47,20 @@ def emit(self, record):\n             request = record.request\n             subject = '%s (%s IP): %s' % (\n                 record.levelname,\n-                (request.META.get('REMOTE_ADDR') in settings.INTERNAL_IPS and 'internal' or 'EXTERNAL'),\n+                (request.META.get('REMOTE_ADDR') in settings.INTERNAL_IPS\n+                 and 'internal' or 'EXTERNAL'),\n                 record.msg\n             )\n             filter = get_exception_reporter_filter(request)\n             request_repr = filter.get_request_repr(request)\n-        except:\n+        except Exception:\n             subject = '%s: %s' % (\n                 record.levelname,\n                 record.getMessage()\n             )\n             request = None\n             request_repr = \"Request repr() unavailable.\"\n+        subject = self.format_subject(subject)\n \n         if record.exc_info:\n             exc_info = record.exc_info\n@@ -72,6 +74,15 @@ def emit(self, record):\n         html_message = self.include_html and reporter.get_traceback_html() or None\n         mail.mail_admins(subject, message, fail_silently=True, html_message=html_message)\n \n+    def format_subject(self, subject):\n+        \"\"\"\n+        Escape CR and LF characters, and limit length.\n+        RFC 2822's hard limit is 998 characters per line. So, minus \"Subject: \"\n+        the actual subject must be no longer than 989 characters.\n+        \"\"\"\n+        formatted_subject = subject.replace('\\n', '\\\\n').replace('\\r', '\\\\r')\n+        return formatted_subject[:989]\n+\n \n class CallbackFilter(logging.Filter):\n     \"\"\""
        },
        {
            "sha": "8eba44bf770ebd44dcddfdc4e9736aa1ca1418c6",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/django/django/blob/995f7a16a8bf539caf076a7744441a383e9a38b2/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/995f7a16a8bf539caf076a7744441a383e9a38b2/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=995f7a16a8bf539caf076a7744441a383e9a38b2",
            "patch": "@@ -160,3 +160,50 @@ def test_accepts_args(self):\n \n         # Restore original filters\n         admin_email_handler.filters = orig_filters\n+\n+    @override_settings(\n+            ADMINS=(('admin', 'admin@example.com'),),\n+            EMAIL_SUBJECT_PREFIX='',\n+            DEBUG=False,\n+        )\n+    def test_subject_accepts_newlines(self):\n+        \"\"\"\n+        Ensure that newlines in email reports' subjects are escaped to avoid\n+        AdminErrorHandler to fail.\n+        Refs #17281.\n+        \"\"\"\n+        message = u'Message \\r\\n with newlines'\n+        expected_subject = u'ERROR: Message \\\\r\\\\n with newlines'\n+\n+        self.assertEqual(len(mail.outbox), 0)\n+\n+        logger = getLogger('django.request')\n+        logger.error(message)\n+\n+        self.assertEqual(len(mail.outbox), 1)\n+        self.assertFalse('\\n' in mail.outbox[0].subject)\n+        self.assertFalse('\\r' in mail.outbox[0].subject)\n+        self.assertEqual(mail.outbox[0].subject, expected_subject)\n+\n+    @override_settings(\n+            ADMINS=(('admin', 'admin@example.com'),),\n+            EMAIL_SUBJECT_PREFIX='',\n+            DEBUG=False,\n+        )\n+    def test_truncate_subject(self):\n+        \"\"\"\n+        RFC 2822's hard limit is 998 characters per line.\n+        So, minus \"Subject: \", the actual subject must be no longer than 989\n+        characters.\n+        Refs #17281.\n+        \"\"\"\n+        message = 'a' * 1000\n+        expected_subject = 'ERROR: aa' + 'a' * 980\n+\n+        self.assertEqual(len(mail.outbox), 0)\n+\n+        logger = getLogger('django.request')\n+        logger.error(message)\n+\n+        self.assertEqual(len(mail.outbox), 1)\n+        self.assertEqual(mail.outbox[0].subject, expected_subject)"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 62,
        "deletions": 2
    }
}