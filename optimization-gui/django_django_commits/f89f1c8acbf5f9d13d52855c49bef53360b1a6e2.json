{
    "author": "freakboy3742",
    "message": "Fixed #15083 -- Corrected the order of TemplateResponse middleware handling, ensuring that custom URLConfs are valid, and that ResponseMiddleware is invoked if the TemplateResponseMiddleware causes errors. Thanks to Sayane for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15226 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
    "files": [
        {
            "sha": "f216886d56173cc3c0676fb66eaf262d7baf9e98",
            "filename": "django/core/handlers/base.py",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/django%2Fcore%2Fhandlers%2Fbase.py",
            "raw_url": "https://github.com/django/django/raw/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/django%2Fcore%2Fhandlers%2Fbase.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fhandlers%2Fbase.py?ref=f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
            "patch": "@@ -128,6 +128,13 @@ def get_response(self, request):\n                         view_name = callback.__class__.__name__ + '.__call__' # If it's a class\n                     raise ValueError(\"The view %s.%s didn't return an HttpResponse object.\" % (callback.__module__, view_name))\n \n+                # If the response supports deferred rendering, apply template\n+                # response middleware and the render the response\n+                if hasattr(response, 'render') and callable(response.render):\n+                    for middleware_method in self._template_response_middleware:\n+                        response = middleware_method(request, response)\n+                    response.render()\n+\n             except http.Http404, e:\n                 logger.warning('Not Found: %s' % request.path,\n                             extra={\n@@ -166,13 +173,6 @@ def get_response(self, request):\n             urlresolvers.set_urlconf(None)\n \n         try:\n-            # If the response supports deferred rendering, apply template\n-            # response middleware and the render the response\n-            if hasattr(response, 'render') and callable(response.render):\n-                for middleware_method in self._template_response_middleware:\n-                    response = middleware_method(request, response)\n-                response.render()\n-\n             # Apply response middleware, regardless of the response\n             for middleware_method in self._response_middleware:\n                 response = middleware_method(request, response)"
        },
        {
            "sha": "e0617076a38e850d69c060f9c0b779f028782292",
            "filename": "tests/regressiontests/middleware_exceptions/tests.py",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Fmiddleware_exceptions%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Fmiddleware_exceptions%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmiddleware_exceptions%2Ftests.py?ref=f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
            "patch": "@@ -503,9 +503,9 @@ def test_process_template_response_bad_middleware(self):\n         self.assert_exceptions_handled('/middleware_exceptions/template_response/', ['Test Template Response Exception'])\n \n         # Check that the right middleware methods have been invoked\n-        self.assert_middleware_usage(pre_middleware,  True, True, False, False, False)\n-        self.assert_middleware_usage(bad_middleware,  True, True, True,  False, False)\n-        self.assert_middleware_usage(post_middleware, True, True, True,  False, False)\n+        self.assert_middleware_usage(pre_middleware,  True, True, False, True, False)\n+        self.assert_middleware_usage(bad_middleware,  True, True, True,  True, False)\n+        self.assert_middleware_usage(post_middleware, True, True, True,  True, False)\n \n     def test_process_response_bad_middleware(self):\n         pre_middleware = TestMiddleware()"
        },
        {
            "sha": "31590a5dbcc7dc0c32e9df147549119df3ebe009",
            "filename": "tests/regressiontests/templates/alternate_urls.py",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Falternate_urls.py",
            "raw_url": "https://github.com/django/django/raw/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Falternate_urls.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Falternate_urls.py?ref=f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
            "patch": "@@ -0,0 +1,11 @@\n+# coding: utf-8\n+from django.conf.urls.defaults import *\n+from regressiontests.templates import views\n+\n+urlpatterns = patterns('',\n+    # View returning a template response\n+    (r'^template_response_view/', views.template_response_view),\n+\n+    # A view that can be hard to find...\n+    url(r'^snark/', views.snark, name='snark'),\n+)"
        },
        {
            "sha": "f658b35ac38b309a5c7b61f62f565fa6242d3bc5",
            "filename": "tests/regressiontests/templates/response.py",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/django/django/blob/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "raw_url": "https://github.com/django/django/raw/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Fresponse.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fresponse.py?ref=f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
            "patch": "@@ -1,6 +1,6 @@\n import os\n from django.utils import unittest\n-from django.test import RequestFactory\n+from django.test import RequestFactory, TestCase\n from django.conf import settings\n import django.template.context\n from django.template import Template, Context, RequestContext\n@@ -11,6 +11,13 @@ def test_processor(request):\n     return {'processors': 'yes'}\n test_processor_name = 'regressiontests.templates.response.test_processor'\n \n+\n+# A test middleware that installs a temporary URLConf\n+class CustomURLConfMiddleware(object):\n+    def process_request(self, request):\n+        request.urlconf = 'regressiontests.templates.alternate_urls'\n+\n+\n class BaseTemplateResponseTest(unittest.TestCase):\n     # tests rely on fact that global context\n     # processors should only work when RequestContext is used.\n@@ -179,3 +186,23 @@ def test_custom_app(self):\n         rc = response.resolve_context(response.context_data)\n \n         self.assertEqual(rc.current_app, 'foobar')\n+\n+\n+class CustomURLConfTest(TestCase):\n+    urls = 'regressiontests.templates.urls'\n+\n+    def setUp(self):\n+        self.old_MIDDLEWARE_CLASSES = settings.MIDDLEWARE_CLASSES\n+        settings.MIDDLEWARE_CLASSES = list(settings.MIDDLEWARE_CLASSES) + [\n+            'regressiontests.templates.response.CustomURLConfMiddleware'\n+        ]\n+\n+    def tearDown(self):\n+        settings.MIDDLEWARE_CLASSES = self.old_MIDDLEWARE_CLASSES\n+\n+    def test_custom_urlconf(self):\n+        response = self.client.get('/template_response_view/')\n+        self.assertEqual(response.status_code, 200)\n+        self.assertEqual(response.content, 'This is where you can find the snark: /snark/')\n+\n+"
        },
        {
            "sha": "7c442fb45367d6e609ea956305d566b2460aa57b",
            "filename": "tests/regressiontests/templates/templates/response.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Ftemplates%2Fresponse.html",
            "raw_url": "https://github.com/django/django/raw/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Ftemplates%2Fresponse.html",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Ftemplates%2Fresponse.html?ref=f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
            "patch": "@@ -0,0 +1 @@\n+{% load url from future %}This is where you can find the snark: {% url \"snark\" %}\n\\ No newline at end of file"
        },
        {
            "sha": "ed15893239f75b9f85a0266b670270d16c064572",
            "filename": "tests/regressiontests/templates/views.py",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Fviews.py",
            "raw_url": "https://github.com/django/django/raw/f89f1c8acbf5f9d13d52855c49bef53360b1a6e2/tests%2Fregressiontests%2Ftemplates%2Fviews.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Ftemplates%2Fviews.py?ref=f89f1c8acbf5f9d13d52855c49bef53360b1a6e2",
            "patch": "@@ -1,4 +1,7 @@\n # Fake views for testing url reverse lookup\n+from django.http import HttpResponse\n+from django.template.response import TemplateResponse\n+\n \n def index(request):\n     pass\n@@ -11,3 +14,9 @@ def client_action(request, id, action):\n \n def client2(request, tag):\n     pass\n+\n+def template_response_view(request):\n+    return TemplateResponse(request, 'response.html', {})\n+\n+def snark(request):\n+    return HttpResponse('Found him!')"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 59,
        "deletions": 11
    }
}