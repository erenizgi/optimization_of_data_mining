{
    "author": "akaariai",
    "message": "Fixed #19087 -- Ensured query's base table is never LOUTER joined\n\nThis fixes a regression created by join promotion logic refactoring:\n01b9c3d5193fe61b82ae8b26242a13fdec22f211\n\nThanks to Ivan Virabyan for the report.",
    "sha": "a62d53c03252bdf82b21b64874efe053160cbdb7",
    "files": [
        {
            "sha": "ad82b167a6807a530998716e11a46d1821cadb34",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/a62d53c03252bdf82b21b64874efe053160cbdb7/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/a62d53c03252bdf82b21b64874efe053160cbdb7/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=a62d53c03252bdf82b21b64874efe053160cbdb7",
            "patch": "@@ -702,6 +702,11 @@ def promote_joins(self, aliases, unconditional=False):\n         aliases = list(aliases)\n         while aliases:\n             alias = aliases.pop(0)\n+            if self.alias_map[alias].rhs_join_col is None:\n+                # This is the base table (first FROM entry) - this table\n+                # isn't really joined at all in the query, so we should not\n+                # alter its join type.\n+                continue\n             parent_alias = self.alias_map[alias].lhs_alias\n             parent_louter = (parent_alias\n                 and self.alias_map[parent_alias].join_type == self.LOUTER)\n@@ -1188,6 +1193,9 @@ def add_filter(self, filter_expr, connector=AND, negate=False, trim=False,\n                     for alias in join_list:\n                         if self.alias_map[alias].join_type == self.LOUTER:\n                             j_col = self.alias_map[alias].rhs_join_col\n+                            # The join promotion logic should never produce\n+                            # a LOUTER join for the base join - assert that.\n+                            assert j_col is not None\n                             entry = self.where_class()\n                             entry.add(\n                                 (Constraint(alias, j_col, None), 'isnull', True),"
        },
        {
            "sha": "af0f421502e360992964275a11e50ba0d5995d61",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/a62d53c03252bdf82b21b64874efe053160cbdb7/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a62d53c03252bdf82b21b64874efe053160cbdb7/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=a62d53c03252bdf82b21b64874efe053160cbdb7",
            "patch": "@@ -878,3 +878,14 @@ def test_type_conversion(self):\n             connection.ops.convert_values(testData, testField),\n             testData\n         )\n+\n+    def test_annotate_joins(self):\n+        \"\"\"\n+        Test that the base table's join isn't promoted to LOUTER. This could\n+        cause the query generation to fail if there is an exclude() for fk-field\n+        in the query, too. Refs #19087.\n+        \"\"\"\n+        qs = Book.objects.annotate(n=Count('pk'))\n+        self.assertIs(qs.query.alias_map['aggregation_regress_book'].join_type, None)\n+        # Check that the query executes without problems.\n+        self.assertEqual(len(qs.exclude(publisher=-1)), 6)"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 19,
        "deletions": 0
    }
}