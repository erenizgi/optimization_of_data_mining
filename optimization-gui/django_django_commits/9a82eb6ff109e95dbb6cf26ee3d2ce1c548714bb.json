{
    "author": "freakboy3742",
    "message": "Fixed #14972 -- Ensure that the HTML email logger always produces useful output, regardless of whether it has been given an exception or a request. Thanks to jamstooks for the report, and bpeschier for the initial patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15383 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb",
    "files": [
        {
            "sha": "784035b3cf8e2a49915ae40e915e3ab0a8081cbf",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb",
            "patch": "@@ -83,7 +83,7 @@ def emit(self, record):\n             exc_info = record.exc_info\n             stack_trace = '\\n'.join(traceback.format_exception(*record.exc_info))\n         else:\n-            exc_info = ()\n+            exc_info = (None, record.msg, None)\n             stack_trace = 'No stack trace available'\n \n         message = \"%s\\n\\n%s\" % (stack_trace, request_repr)"
        },
        {
            "sha": "569cec18df5c40d9730f55deca5c9a7dea3c19f7",
            "filename": "django/views/debug.py",
            "status": "modified",
            "additions": 27,
            "deletions": 18,
            "changes": 45,
            "blob_url": "https://github.com/django/django/blob/9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb/django%2Fviews%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb/django%2Fviews%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fviews%2Fdebug.py?ref=9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb",
            "patch": "@@ -59,7 +59,7 @@ def technical_500_response(request, exc_type, exc_value, tb):\n     html = reporter.get_traceback_html()\n     return HttpResponseServerError(html, mimetype='text/html')\n \n-class ExceptionReporter:\n+class ExceptionReporter(object):\n     \"\"\"\n     A class to organize and coordinate reporting on exceptions.\n     \"\"\"\n@@ -82,7 +82,7 @@ def __init__(self, request, exc_type, exc_value, tb, is_email=False):\n     def get_traceback_html(self):\n         \"Return HTML code for traceback.\"\n \n-        if issubclass(self.exc_type, TemplateDoesNotExist):\n+        if self.exc_type and issubclass(self.exc_type, TemplateDoesNotExist):\n             from django.template.loader import template_source_loaders\n             self.template_does_not_exist = True\n             self.loader_debug_info = []\n@@ -113,11 +113,12 @@ def get_traceback_html(self):\n \n         frames = self.get_traceback_frames()\n         for i, frame in enumerate(frames):\n-            frame['vars'] = [(k, force_escape(pprint(v))) for k, v in frame['vars']]\n+            if 'vars' in frame:\n+                frame['vars'] = [(k, force_escape(pprint(v))) for k, v in frame['vars']]\n             frames[i] = frame\n \n         unicode_hint = ''\n-        if issubclass(self.exc_type, UnicodeError):\n+        if self.exc_type and issubclass(self.exc_type, UnicodeError):\n             start = getattr(self.exc_value, 'start', None)\n             end = getattr(self.exc_value, 'end', None)\n             if start is not None and end is not None:\n@@ -127,11 +128,8 @@ def get_traceback_html(self):\n         t = Template(TECHNICAL_500_TEMPLATE, name='Technical 500 template')\n         c = Context({\n             'is_email': self.is_email,\n-            'exception_type': self.exc_type.__name__,\n-            'exception_value': smart_unicode(self.exc_value, errors='replace'),\n             'unicode_hint': unicode_hint,\n             'frames': frames,\n-            'lastframe': frames[-1],\n             'request': self.request,\n             'settings': get_safe_settings(),\n             'sys_executable': sys.executable,\n@@ -143,6 +141,13 @@ def get_traceback_html(self):\n             'template_does_not_exist': self.template_does_not_exist,\n             'loader_debug_info': self.loader_debug_info,\n         })\n+        # Check whether exception info is available\n+        if self.exc_type:\n+            c['exception_type'] = self.exc_type.__name__\n+        if self.exc_value:\n+            c['exception_value'] = smart_unicode(self.exc_value, errors='replace')\n+        if frames:\n+            c['lastframe'] = frames[-1]\n         return t.render(c)\n \n     def get_template_exception_info(self):\n@@ -250,14 +255,6 @@ def get_traceback_frames(self):\n                 })\n             tb = tb.tb_next\n \n-        if not frames:\n-            frames = [{\n-                'filename': '&lt;unknown&gt;',\n-                'function': '?',\n-                'lineno': '?',\n-                'context_line': '???',\n-            }]\n-\n         return frames\n \n     def format_exception(self):\n@@ -319,7 +316,7 @@ def empty_urlconf(request):\n <head>\n   <meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\">\n   <meta name=\"robots\" content=\"NONE,NOARCHIVE\">\n-  <title>{{ exception_type }} at {{ request.path_info|escape }}</title>\n+  <title>{% if exception_type %}{{ exception_type }}{% else %}Report{% endif %}{% if request %} at {{ request.path_info|escape }}{% endif %}</title>\n   <style type=\"text/css\">\n     html * { padding:0; margin:0; }\n     body * { padding:10px 20px; }\n@@ -429,9 +426,10 @@ def empty_urlconf(request):\n </head>\n <body>\n <div id=\"summary\">\n-  <h1>{{ exception_type }}{% if request %} at {{ request.path_info|escape }}{% endif %}</h1>\n-  <pre class=\"exception_value\">{{ exception_value|force_escape }}</pre>\n+  <h1>{% if exception_type %}{{ exception_type }}{% else %}Report{% endif %}{% if request %} at {{ request.path_info|escape }}{% endif %}</h1>\n+  <pre class=\"exception_value\">{% if exception_value %}{{ exception_value|force_escape }}{% else %}No exception supplied{% endif %}</pre>\n   <table class=\"meta\">\n+{% if request %}\n     <tr>\n       <th>Request Method:</th>\n       <td>{{ request.META.REQUEST_METHOD }}</td>\n@@ -440,22 +438,29 @@ def empty_urlconf(request):\n       <th>Request URL:</th>\n       <td>{{ request.build_absolute_uri|escape }}</td>\n     </tr>\n+{% endif %}\n     <tr>\n       <th>Django Version:</th>\n       <td>{{ django_version_info }}</td>\n     </tr>\n+{% if exception_type %}\n     <tr>\n       <th>Exception Type:</th>\n       <td>{{ exception_type }}</td>\n     </tr>\n+{% endif %}\n+{% if exception_type and exception_value %}\n     <tr>\n       <th>Exception Value:</th>\n       <td><pre>{{ exception_value|force_escape }}</pre></td>\n     </tr>\n+{% endif %}\n+{% if lastframe %}\n     <tr>\n       <th>Exception Location:</th>\n       <td>{{ lastframe.filename|escape }} in {{ lastframe.function|escape }}, line {{ lastframe.lineno }}</td>\n     </tr>\n+{% endif %}\n     <tr>\n       <th>Python Executable:</th>\n       <td>{{ sys_executable|escape }}</td>\n@@ -515,6 +520,7 @@ def empty_urlconf(request):\n    </table>\n </div>\n {% endif %}\n+{% if frames %}\n <div id=\"traceback\">\n   <h2>Traceback <span class=\"commands\">{% if not is_email %}<a href=\"#\" onclick=\"return switchPastebinFriendly(this);\">Switch to copy-and-paste view</a></span>{% endif %}</h2>\n   {% autoescape off %}\n@@ -615,6 +621,7 @@ def empty_urlconf(request):\n </form>\n </div>\n {% endif %}\n+{% endif %}\n \n <div id=\"requestinfo\">\n   <h2>Request information</h2>\n@@ -725,6 +732,8 @@ def empty_urlconf(request):\n       {% endfor %}\n     </tbody>\n   </table>\n+{% else %}\n+  <p>Request data not supplied</p>\n {% endif %}\n \n   <h3 id=\"settings-info\">Settings</h3>"
        },
        {
            "sha": "0b07b406d0c15dde907aa11649819d04ffa8273d",
            "filename": "tests/regressiontests/views/tests/debug.py",
            "status": "modified",
            "additions": 88,
            "deletions": 1,
            "changes": 89,
            "blob_url": "https://github.com/django/django/blob/9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "raw_url": "https://github.com/django/django/raw/9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fviews%2Ftests%2Fdebug.py?ref=9a82eb6ff109e95dbb6cf26ee3d2ce1c548714bb",
            "patch": "@@ -1,13 +1,16 @@\n import inspect\n+import sys\n \n from django.conf import settings\n from django.core.files.uploadedfile import SimpleUploadedFile\n-from django.test import TestCase\n+from django.test import TestCase, RequestFactory\n from django.core.urlresolvers import reverse\n from django.template import TemplateSyntaxError\n+from django.views.debug import ExceptionReporter\n \n from regressiontests.views import BrokenException, except_args\n \n+\n class DebugViewTests(TestCase):\n     def setUp(self):\n         self.old_debug = settings.DEBUG\n@@ -52,3 +55,87 @@ def test_template_exceptions(self):\n     def test_template_loader_postmortem(self):\n         response = self.client.get(reverse('raises_template_does_not_exist'))\n         self.assertContains(response, 'templates/i_dont_exist.html</code> (File does not exist)</li>', status_code=500)\n+\n+\n+class ExceptionReporterTests(TestCase):\n+    rf = RequestFactory()\n+\n+    def test_request_and_exception(self):\n+        \"A simple exception report can be generated\"\n+        try:\n+            request = self.rf.get('/test_view/')\n+            raise KeyError(\"Can't find my keys\")\n+        except KeyError:\n+            exc_type, exc_value, tb = sys.exc_info()\n+        reporter = ExceptionReporter(request, exc_type, exc_value, tb)\n+        html = reporter.get_traceback_html()\n+        self.assertIn('<h1>KeyError at /test_view/</h1>', html)\n+        self.assertIn('<pre class=\"exception_value\">Can&#39;t find my keys</pre>', html)\n+        self.assertIn('<th>Request Method:</th>', html)\n+        self.assertIn('<th>Request URL:</th>', html)\n+        self.assertIn('<th>Exception Type:</th>', html)\n+        self.assertIn('<th>Exception Value:</th>', html)\n+        self.assertIn('<h2>Traceback ', html)\n+        self.assertIn('<h2>Request information</h2>', html)\n+        self.assertNotIn('<p>Request data not supplied</p>', html)\n+\n+    def test_no_request(self):\n+        \"An exception report can be generated without request\"\n+        try:\n+            raise KeyError(\"Can't find my keys\")\n+        except KeyError:\n+            exc_type, exc_value, tb = sys.exc_info()\n+        reporter = ExceptionReporter(None, exc_type, exc_value, tb)\n+        html = reporter.get_traceback_html()\n+        self.assertIn('<h1>KeyError</h1>', html)\n+        self.assertIn('<pre class=\"exception_value\">Can&#39;t find my keys</pre>', html)\n+        self.assertNotIn('<th>Request Method:</th>', html)\n+        self.assertNotIn('<th>Request URL:</th>', html)\n+        self.assertIn('<th>Exception Type:</th>', html)\n+        self.assertIn('<th>Exception Value:</th>', html)\n+        self.assertIn('<h2>Traceback ', html)\n+        self.assertIn('<h2>Request information</h2>', html)\n+        self.assertIn('<p>Request data not supplied</p>', html)\n+\n+    def test_no_exception(self):\n+        \"An exception report can be generated for just a request\"\n+        request = self.rf.get('/test_view/')\n+        reporter = ExceptionReporter(request, None, None, None)\n+        html = reporter.get_traceback_html()\n+        self.assertIn('<h1>Report at /test_view/</h1>', html)\n+        self.assertIn('<pre class=\"exception_value\">No exception supplied</pre>', html)\n+        self.assertIn('<th>Request Method:</th>', html)\n+        self.assertIn('<th>Request URL:</th>', html)\n+        self.assertNotIn('<th>Exception Type:</th>', html)\n+        self.assertNotIn('<th>Exception Value:</th>', html)\n+        self.assertNotIn('<h2>Traceback ', html)\n+        self.assertIn('<h2>Request information</h2>', html)\n+        self.assertNotIn('<p>Request data not supplied</p>', html)\n+\n+    def test_request_and_message(self):\n+        \"A message can be provided in addition to a request\"\n+        request = self.rf.get('/test_view/')\n+        reporter = ExceptionReporter(request, None, \"I'm a little teapot\", None)\n+        html = reporter.get_traceback_html()\n+        self.assertIn('<h1>Report at /test_view/</h1>', html)\n+        self.assertIn('<pre class=\"exception_value\">I&#39;m a little teapot</pre>', html)\n+        self.assertIn('<th>Request Method:</th>', html)\n+        self.assertIn('<th>Request URL:</th>', html)\n+        self.assertNotIn('<th>Exception Type:</th>', html)\n+        self.assertNotIn('<th>Exception Value:</th>', html)\n+        self.assertNotIn('<h2>Traceback ', html)\n+        self.assertIn('<h2>Request information</h2>', html)\n+        self.assertNotIn('<p>Request data not supplied</p>', html)\n+\n+    def test_message_only(self):\n+        reporter = ExceptionReporter(None, None, \"I'm a little teapot\", None)\n+        html = reporter.get_traceback_html()\n+        self.assertIn('<h1>Report</h1>', html)\n+        self.assertIn('<pre class=\"exception_value\">I&#39;m a little teapot</pre>', html)\n+        self.assertNotIn('<th>Request Method:</th>', html)\n+        self.assertNotIn('<th>Request URL:</th>', html)\n+        self.assertNotIn('<th>Exception Type:</th>', html)\n+        self.assertNotIn('<th>Exception Value:</th>', html)\n+        self.assertNotIn('<h2>Traceback ', html)\n+        self.assertIn('<h2>Request information</h2>', html)\n+        self.assertIn('<p>Request data not supplied</p>', html)"
        }
    ],
    "stats": {
        "total": 136,
        "additions": 116,
        "deletions": 20
    }
}