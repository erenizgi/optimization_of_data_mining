{
    "author": "PaulMcMillan",
    "message": "Fixed #16026 -- loaddata now identifies which object triggered an error.\n\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16873 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1d96d886e7f36fcee918b7fa5c32b677bed83b0d",
    "files": [
        {
            "sha": "7b0e30fbb47c771af9c5bd5924bcc1ae4c0905dd",
            "filename": "django/core/management/commands/loaddata.py",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/1d96d886e7f36fcee918b7fa5c32b677bed83b0d/django%2Fcore%2Fmanagement%2Fcommands%2Floaddata.py",
            "raw_url": "https://github.com/django/django/raw/1d96d886e7f36fcee918b7fa5c32b677bed83b0d/django%2Fcore%2Fmanagement%2Fcommands%2Floaddata.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcore%2Fmanagement%2Fcommands%2Floaddata.py?ref=1d96d886e7f36fcee918b7fa5c32b677bed83b0d",
            "patch": "@@ -12,7 +12,8 @@\n from django.core import serializers\n from django.core.management.base import BaseCommand\n from django.core.management.color import no_style\n-from django.db import connections, router, transaction, DEFAULT_DB_ALIAS\n+from django.db import (connections, router, transaction, DEFAULT_DB_ALIAS,\n+      IntegrityError, DatabaseError)\n from django.db.models import get_apps\n from django.utils.itercompat import product\n \n@@ -177,7 +178,16 @@ def read(self):\n                                         if router.allow_syncdb(using, obj.object.__class__):\n                                             loaded_objects_in_fixture += 1\n                                             models.add(obj.object.__class__)\n-                                            obj.save(using=using)\n+                                            try:\n+                                                obj.save(using=using)\n+                                            except (DatabaseError, IntegrityError), e:\n+                                                msg = \"Could not load %(app_label)s.%(object_name)s(pk=%(pk)s): %(error_msg)s\" % {\n+                                                        'app_label': obj.object._meta.app_label,\n+                                                        'object_name': obj.object._meta.object_name,\n+                                                        'pk': obj.object.pk,\n+                                                        'error_msg': e\n+                                                    }\n+                                                raise e.__class__, e.__class__(msg), sys.exc_info()[2]\n \n                                 # Since we disabled constraint checks, we must manually check for\n                                 # any invalid keys that might have been added"
        },
        {
            "sha": "de78d0b4fdfb130e5a458c7990c6cfd0fec70c54",
            "filename": "tests/modeltests/fixtures/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/django/django/blob/1d96d886e7f36fcee918b7fa5c32b677bed83b0d/tests%2Fmodeltests%2Ffixtures%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1d96d886e7f36fcee918b7fa5c32b677bed83b0d/tests%2Fmodeltests%2Ffixtures%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fmodeltests%2Ffixtures%2Ftests.py?ref=1d96d886e7f36fcee918b7fa5c32b677bed83b0d",
            "patch": "@@ -252,6 +252,17 @@ def test_db_loading(self):\n             '<Article: Python program becomes self aware>'\n         ])\n \n+    def test_loaddata_error_message(self):\n+        \"\"\"\n+        Verifies that loading a fixture which contains an invalid object\n+        outputs an error message which contains the pk of the object\n+        that triggered the error.\n+        \"\"\"\n+        new_io = StringIO.StringIO()\n+        management.call_command('loaddata', 'invalid.json', verbosity=0, stderr=new_io, commit=False)\n+        output = new_io.getvalue().strip().split('\\n')\n+        self.assertRegexpMatches(output[-1], \"IntegrityError: Could not load fixtures.Article\\(pk=1\\): .*$\")\n+\n     def test_loading_using(self):\n         # Load db fixtures 1 and 2. These will load using the 'default' database identifier explicitly\n         management.call_command('loaddata', 'db_fixture_1', verbosity=0, using='default', commit=False)"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 23,
        "deletions": 2
    }
}