{
    "author": "freakboy3742",
    "message": "Fixed #14707 -- Relax the protections on aggregate naming collisions when a ValuesQuerySet removes the colliding name. Thanks to Andy McKay for the report.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15223 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "ae8ff5f476973d5623675460d36a2f3c6853f6d0",
    "files": [
        {
            "sha": "3c43a57d4abbe55a3134d485a21d9a1acb21b598",
            "filename": "django/db/models/query.py",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/ae8ff5f476973d5623675460d36a2f3c6853f6d0/django%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/ae8ff5f476973d5623675460d36a2f3c6853f6d0/django%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fquery.py?ref=ae8ff5f476973d5623675460d36a2f3c6853f6d0",
            "patch": "@@ -620,18 +620,19 @@ def annotate(self, *args, **kwargs):\n         \"\"\"\n         for arg in args:\n             if arg.default_alias in kwargs:\n-                raise ValueError(\"The %s named annotation conflicts with the \"\n+                raise ValueError(\"The named annotation '%s' conflicts with the \"\n                                  \"default name for another annotation.\"\n                                  % arg.default_alias)\n             kwargs[arg.default_alias] = arg\n \n-        names = set(self.model._meta.get_all_field_names())\n+        names = getattr(self, '_fields', None)\n+        if names is None:\n+            names = set(self.model._meta.get_all_field_names())\n         for aggregate in kwargs:\n             if aggregate in names:\n-                raise ValueError(\"The %s annotation conflicts with a field on \"\n+                raise ValueError(\"The annotation '%s' conflicts with a field on \"\n                     \"the model.\" % aggregate)\n \n-\n         obj = self._clone()\n \n         obj._setup_aggregate_query(kwargs.keys())"
        },
        {
            "sha": "989c4c3d90338d4cac3889197294cc5d200e0a60",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/ae8ff5f476973d5623675460d36a2f3c6853f6d0/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/ae8ff5f476973d5623675460d36a2f3c6853f6d0/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=ae8ff5f476973d5623675460d36a2f3c6853f6d0",
            "patch": "@@ -474,6 +474,28 @@ def test_m2m_name_conflict(self):\n         # Regression for #11256 - providing an aggregate name that conflicts with an m2m name on the model raises ValueError\n         self.assertRaises(ValueError, Author.objects.annotate, friends=Count('friends'))\n \n+    def test_values_queryset_non_conflict(self):\n+        # Regression for #14707 -- If you're using a values query set, some potential conflicts are avoided.\n+\n+        # age is a field on Author, so it shouldn't be allowed as an aggregate.\n+        # But age isn't included in the ValuesQuerySet, so it is.\n+        results = Author.objects.values('name').annotate(age=Count('book_contact_set'))\n+        self.assertEquals(len(results), 9)\n+        self.assertEquals(results[0]['name'], u'Adrian Holovaty')\n+        self.assertEquals(results[0]['age'], 1)\n+\n+        # Same problem, but aggregating over m2m fields\n+        results = Author.objects.values('name').annotate(age=Avg('friends__age'))\n+        self.assertEquals(len(results), 9)\n+        self.assertEquals(results[0]['name'], u'Adrian Holovaty')\n+        self.assertEquals(results[0]['age'], 32.0)\n+\n+        # Same problem, but colliding with an m2m field\n+        results = Author.objects.values('name').annotate(friends=Count('friends'))\n+        self.assertEquals(len(results), 9)\n+        self.assertEquals(results[0]['name'], u'Adrian Holovaty')\n+        self.assertEquals(results[0]['friends'], 2)\n+\n     def test_reverse_relation_name_conflict(self):\n         # Regression for #11256 - providing an aggregate name that conflicts with a reverse-related name on the model raises ValueError\n         self.assertRaises(ValueError, Author.objects.annotate, book_contact_set=Avg('friends__age'))"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 27,
        "deletions": 4
    }
}