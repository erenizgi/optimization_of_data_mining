{
    "author": "jezdez",
    "message": "Fixed AdminEmailHandler to format the subject message correctly when arguments are passed.\n\nThis bug was hidden before r17480 as it basically didn't take the arguments into account. Refs #14973.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@17512 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "1c9c29b5b2a3b9b8375a32534dd60c486042b5a3",
    "files": [
        {
            "sha": "df2089f9242ac652bfd360ef130a15cf4d72d473",
            "filename": "django/utils/log.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/1c9c29b5b2a3b9b8375a32534dd60c486042b5a3/django%2Futils%2Flog.py",
            "raw_url": "https://github.com/django/django/raw/1c9c29b5b2a3b9b8375a32534dd60c486042b5a3/django%2Futils%2Flog.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Futils%2Flog.py?ref=1c9c29b5b2a3b9b8375a32534dd60c486042b5a3",
            "patch": "@@ -49,7 +49,7 @@ def emit(self, record):\n                 record.levelname,\n                 (request.META.get('REMOTE_ADDR') in settings.INTERNAL_IPS\n                  and 'internal' or 'EXTERNAL'),\n-                record.msg\n+                record.getMessage()\n             )\n             filter = get_exception_reporter_filter(request)\n             request_repr = filter.get_request_repr(request)"
        },
        {
            "sha": "4e29e25d9934fc2fb44e400bfabe0ed007887c0b",
            "filename": "tests/regressiontests/logging_tests/tests.py",
            "status": "modified",
            "additions": 57,
            "deletions": 17,
            "changes": 74,
            "blob_url": "https://github.com/django/django/blob/1c9c29b5b2a3b9b8375a32534dd60c486042b5a3/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/1c9c29b5b2a3b9b8375a32534dd60c486042b5a3/tests%2Fregressiontests%2Flogging_tests%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Flogging_tests%2Ftests.py?ref=1c9c29b5b2a3b9b8375a32534dd60c486042b5a3",
            "patch": "@@ -4,7 +4,7 @@\n \n from django.conf import compat_patch_logging_config\n from django.core import mail\n-from django.test import TestCase\n+from django.test import TestCase, RequestFactory\n from django.test.utils import override_settings\n from django.utils.log import CallbackFilter, RequireDebugFalse, getLogger\n \n@@ -124,6 +124,16 @@ def _callback(record):\n \n class AdminEmailHandlerTest(TestCase):\n \n+    def get_admin_email_handler(self, logger):\n+        # Inspired from regressiontests/views/views.py: send_log()\n+        # ensuring the AdminEmailHandler does not get filtered out\n+        # even with DEBUG=True.\n+        admin_email_handler = [\n+            h for h in logger.handlers\n+            if h.__class__.__name__ == \"AdminEmailHandler\"\n+            ][0]\n+        return admin_email_handler\n+\n     @override_settings(\n             ADMINS=(('whatever admin', 'admin@example.com'),),\n             EMAIL_SUBJECT_PREFIX='-SuperAwesomeSubject-'\n@@ -134,32 +144,62 @@ def test_accepts_args(self):\n         setting are used to compose the email subject.\n         Refs #16736.\n         \"\"\"\n-\n         message = \"Custom message that says '%s' and '%s'\"\n         token1 = 'ping'\n         token2 = 'pong'\n \n         logger = getLogger('django.request')\n-        # Inspired from regressiontests/views/views.py: send_log()\n-        # ensuring the AdminEmailHandler does not get filtered out\n-        # even with DEBUG=True.\n-        admin_email_handler = [\n-            h for h in logger.handlers\n-            if h.__class__.__name__ == \"AdminEmailHandler\"\n-            ][0]\n+        admin_email_handler = self.get_admin_email_handler(logger)\n         # Backup then override original filters\n         orig_filters = admin_email_handler.filters\n-        admin_email_handler.filters = []\n+        try:\n+            admin_email_handler.filters = []\n \n-        logger.error(message, token1, token2)\n+            logger.error(message, token1, token2)\n \n-        self.assertEqual(len(mail.outbox), 1)\n-        self.assertEqual(mail.outbox[0].to, ['admin@example.com'])\n-        self.assertEqual(mail.outbox[0].subject,\n-                         \"-SuperAwesomeSubject-ERROR: Custom message that says 'ping' and 'pong'\")\n+            self.assertEqual(len(mail.outbox), 1)\n+            self.assertEqual(mail.outbox[0].to, ['admin@example.com'])\n+            self.assertEqual(mail.outbox[0].subject,\n+                             \"-SuperAwesomeSubject-ERROR: Custom message that says 'ping' and 'pong'\")\n+        finally:\n+            # Restore original filters\n+            admin_email_handler.filters = orig_filters\n+\n+    @override_settings(\n+            ADMINS=(('whatever admin', 'admin@example.com'),),\n+            EMAIL_SUBJECT_PREFIX='-SuperAwesomeSubject-',\n+            INTERNAL_IPS=('127.0.0.1',),\n+        )\n+    def test_accepts_args_and_request(self):\n+        \"\"\"\n+        Ensure that the subject is also handled if being\n+        passed a request object.\n+        \"\"\"\n+        message = \"Custom message that says '%s' and '%s'\"\n+        token1 = 'ping'\n+        token2 = 'pong'\n \n-        # Restore original filters\n-        admin_email_handler.filters = orig_filters\n+        logger = getLogger('django.request')\n+        admin_email_handler = self.get_admin_email_handler(logger)\n+        # Backup then override original filters\n+        orig_filters = admin_email_handler.filters\n+        try:\n+            admin_email_handler.filters = []\n+            rf = RequestFactory()\n+            request = rf.get('/')\n+            logger.error(message, token1, token2,\n+                extra={\n+                    'status_code': 403,\n+                    'request': request,\n+                }\n+            )\n+            self.assertEqual(len(mail.outbox), 1)\n+            self.assertEqual(mail.outbox[0].to, ['admin@example.com'])\n+            self.assertEqual(mail.outbox[0].subject,\n+                             \"-SuperAwesomeSubject-ERROR (internal IP): Custom message that says 'ping' and 'pong'\")\n+        finally:\n+            # Restore original filters\n+            admin_email_handler.filters = orig_filters\n \n     @override_settings(\n             ADMINS=(('admin', 'admin@example.com'),),"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 58,
        "deletions": 18
    }
}