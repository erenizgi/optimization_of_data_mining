{
    "author": "spookylukey",
    "message": "Fixed #14206 - dynamic list_display support in admin\n\nThanks to gabejackson for the suggestion, and to cyrus for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@16340 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "207e3ed9d58fabe68477aa62f7ef41464f1761e9",
    "files": [
        {
            "sha": "e9064bb68cc4f5da6320e036ba2a7c1c7501045f",
            "filename": "django/contrib/admin/options.py",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/207e3ed9d58fabe68477aa62f7ef41464f1761e9/django%2Fcontrib%2Fadmin%2Foptions.py",
            "raw_url": "https://github.com/django/django/raw/207e3ed9d58fabe68477aa62f7ef41464f1761e9/django%2Fcontrib%2Fadmin%2Foptions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Foptions.py?ref=207e3ed9d58fabe68477aa62f7ef41464f1761e9",
            "patch": "@@ -625,6 +625,13 @@ def get_action(self, action):\n             description = capfirst(action.replace('_', ' '))\n         return func, action, description\n \n+    def get_list_display(self, request):\n+        \"\"\"\n+        Return a sequence containing the fields to be displayed on the\n+        changelist.\n+        \"\"\"\n+        return self.list_display\n+\n     def construct_change_message(self, request, form, formsets):\n         \"\"\"\n         Construct a change message from a changed object.\n@@ -1053,7 +1060,7 @@ def changelist_view(self, request, extra_context=None):\n         actions = self.get_actions(request)\n \n         # Remove action checkboxes if there aren't any actions available.\n-        list_display = list(self.list_display)\n+        list_display = list(self.get_list_display(request))\n         if not actions:\n             try:\n                 list_display.remove('action_checkbox')"
        },
        {
            "sha": "e0ddd4ae854d9237aa61c13e028c4927cde4788c",
            "filename": "docs/ref/contrib/admin/index.txt",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/207e3ed9d58fabe68477aa62f7ef41464f1761e9/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "raw_url": "https://github.com/django/django/raw/207e3ed9d58fabe68477aa62f7ef41464f1761e9/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fadmin%2Findex.txt?ref=207e3ed9d58fabe68477aa62f7ef41464f1761e9",
            "patch": "@@ -967,6 +967,15 @@ templates used by the :class:`ModelAdmin` views:\n     a ``dictionary``, as described above in the :attr:`ModelAdmin.prepopulated_fields`\n     section.\n \n+.. method:: ModelAdmin.get_list_display(self, request)\n+\n+    .. versionadded:: 1.4\n+\n+    The ``get_list_display`` method is given the ``HttpRequest`` and is\n+    expected to return a ``list`` or ``tuple`` of field names that will be\n+    displayed on the changelist view as described above in the\n+    :attr:`ModelAdmin.list_display` section.\n+\n .. method:: ModelAdmin.get_urls(self)\n \n     The ``get_urls`` method on a ``ModelAdmin`` returns the URLs to be used for"
        },
        {
            "sha": "bc7fce2025a1eacbc07051493b843014ee66361a",
            "filename": "tests/regressiontests/admin_changelist/tests.py",
            "status": "modified",
            "additions": 79,
            "deletions": 23,
            "changes": 102,
            "blob_url": "https://github.com/django/django/blob/207e3ed9d58fabe68477aa62f7ef41464f1761e9/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/207e3ed9d58fabe68477aa62f7ef41464f1761e9/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_changelist%2Ftests.py?ref=207e3ed9d58fabe68477aa62f7ef41464f1761e9",
            "patch": "@@ -4,19 +4,25 @@\n from django.core.paginator import Paginator\n from django.template import Context, Template\n from django.test import TransactionTestCase\n+from django.test.client import RequestFactory\n+from django.contrib.auth.models import User\n \n from models import (Child, Parent, Genre, Band, Musician, Group, Quartet,\n     Membership, ChordsMusician, ChordsBand, Invitation)\n \n \n class ChangeListTests(TransactionTestCase):\n+    def setUp(self):\n+        self.factory = RequestFactory()\n+\n     def test_select_related_preserved(self):\n         \"\"\"\n         Regression test for #10348: ChangeList.get_query_set() shouldn't\n         overwrite a custom select_related provided by ModelAdmin.queryset().\n         \"\"\"\n         m = ChildAdmin(Child, admin.site)\n-        cl = ChangeList(MockRequest(), Child, m.list_display, m.list_display_links,\n+        request = self.factory.get('/child/')\n+        cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n                 m.list_select_related, m.list_per_page, m.list_editable, m)\n         self.assertEqual(cl.query_set.query.select_related, {'parent': {'name': {}}})\n@@ -27,7 +33,7 @@ def test_result_list_empty_changelist_value(self):\n         for relationship fields\n         \"\"\"\n         new_child = Child.objects.create(name='name', parent=None)\n-        request = MockRequest()\n+        request = self.factory.get('/child/')\n         m = ChildAdmin(Child, admin.site)\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n@@ -40,15 +46,14 @@ def test_result_list_empty_changelist_value(self):\n         self.assertFalse(table_output.find(row_html) == -1,\n             'Failed to find expected row element: %s' % table_output)\n \n-\n     def test_result_list_html(self):\n         \"\"\"\n         Verifies that inclusion tag result_list generates a table when with\n         default ModelAdmin settings.\n         \"\"\"\n         new_parent = Parent.objects.create(name='parent')\n         new_child = Child.objects.create(name='name', parent=new_parent)\n-        request = MockRequest()\n+        request = self.factory.get('/child/')\n         m = ChildAdmin(Child, admin.site)\n         cl = ChangeList(request, Child, m.list_display, m.list_display_links,\n                 m.list_filter, m.date_hierarchy, m.search_fields,\n@@ -72,7 +77,7 @@ def test_result_list_editable_html(self):\n         \"\"\"\n         new_parent = Parent.objects.create(name='parent')\n         new_child = Child.objects.create(name='name', parent=new_parent)\n-        request = MockRequest()\n+        request = self.factory.get('/child/')\n         m = ChildAdmin(Child, admin.site)\n \n         # Test with list_editable fields\n@@ -104,8 +109,7 @@ def test_result_list_editable(self):\n         new_parent = Parent.objects.create(name='parent')\n         for i in range(200):\n             new_child = Child.objects.create(name='name %s' % i, parent=new_parent)\n-        request = MockRequest()\n-        request.GET['p'] = -1 # Anything outside range\n+        request = self.factory.get('/child/', data={'p': -1})  # Anything outside range\n         m = ChildAdmin(Child, admin.site)\n \n         # Test with list_editable fields\n@@ -122,7 +126,7 @@ def test_custom_paginator(self):\n         for i in range(200):\n             new_child = Child.objects.create(name='name %s' % i, parent=new_parent)\n \n-        request = MockRequest()\n+        request = self.factory.get('/child/')\n         m = ChildAdmin(Child, admin.site)\n         m.list_display = ['id', 'name', 'parent']\n         m.list_display_links = ['id']\n@@ -148,7 +152,7 @@ def test_distinct_for_m2m_in_list_filter(self):\n         band.genres.add(blues)\n \n         m = BandAdmin(Band, admin.site)\n-        request = MockFilterRequest('genres', blues.pk)\n+        request = self.factory.get('/band/', data={'genres': blues.pk})\n \n         cl = ChangeList(request, Band, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n@@ -171,7 +175,7 @@ def test_distinct_for_through_m2m_in_list_filter(self):\n         Membership.objects.create(group=band, music=lead, role='bass player')\n \n         m = GroupAdmin(Group, admin.site)\n-        request = MockFilterRequest('members', lead.pk)\n+        request = self.factory.get('/group/', data={'members': lead.pk})\n \n         cl = ChangeList(request, Group, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n@@ -195,7 +199,7 @@ def test_distinct_for_inherited_m2m_in_list_filter(self):\n         Membership.objects.create(group=four, music=lead, role='guitar player')\n \n         m = QuartetAdmin(Quartet, admin.site)\n-        request = MockFilterRequest('members', lead.pk)\n+        request = self.factory.get('/quartet/', data={'members': lead.pk})\n \n         cl = ChangeList(request, Quartet, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n@@ -219,7 +223,7 @@ def test_distinct_for_m2m_to_inherited_in_list_filter(self):\n         Invitation.objects.create(band=three, player=lead, instrument='bass')\n \n         m = ChordsBandAdmin(ChordsBand, admin.site)\n-        request = MockFilterRequest('members', lead.pk)\n+        request = self.factory.get('/chordsband/', data={'members': lead.pk})\n \n         cl = ChangeList(request, ChordsBand, m.list_display,\n                 m.list_display_links, m.list_filter, m.date_hierarchy,\n@@ -242,7 +246,7 @@ def test_distinct_for_non_unique_related_object_in_list_filter(self):\n         Child.objects.create(parent=parent, name='Daniel')\n \n         m = ParentAdmin(Parent, admin.site)\n-        request = MockFilterRequest('child__name', 'Daniel')\n+        request = self.factory.get('/parent/', data={'child__name': 'Daniel'})\n \n         cl = ChangeList(request, Parent, m.list_display, m.list_display_links,\n                         m.list_filter, m.date_hierarchy, m.search_fields,\n@@ -262,7 +266,7 @@ def test_distinct_for_non_unique_related_object_in_search_fields(self):\n         Child.objects.create(parent=parent, name='Daniel')\n \n         m = ParentAdmin(Parent, admin.site)\n-        request = MockSearchRequest('daniel')\n+        request = self.factory.get('/parent/', data={SEARCH_VAR: 'daniel'})\n \n         cl = ChangeList(request, Parent, m.list_display, m.list_display_links,\n                         m.list_filter, m.date_hierarchy, m.search_fields,\n@@ -282,7 +286,7 @@ def test_pagination(self):\n             Child.objects.create(name='name %s' % i, parent=parent)\n             Child.objects.create(name='filtered %s' % i, parent=parent)\n \n-        request = MockRequest()\n+        request = self.factory.get('/child/')\n \n         # Test default queryset\n         m = ChildAdmin(Child, admin.site)\n@@ -302,6 +306,51 @@ def test_pagination(self):\n         self.assertEqual(cl.paginator.count, 30)\n         self.assertEqual(cl.paginator.page_range, [1, 2, 3])\n \n+    def test_dynamic_list_display(self):\n+        \"\"\"\n+        Regression tests for #14206: dynamic list_display support.\n+        \"\"\"\n+        parent = Parent.objects.create(name='parent')\n+        for i in range(10):\n+            Child.objects.create(name='child %s' % i, parent=parent)\n+\n+        user_noparents = User.objects.create(\n+            username='noparents',\n+            is_superuser=True)\n+        user_parents = User.objects.create(\n+            username='parents',\n+            is_superuser=True)\n+\n+        def _mocked_authenticated_request(user):\n+            request = self.factory.get('/child/')\n+            request.user = user\n+            return request\n+\n+        # Test with user 'noparents'\n+        m = DynamicListDisplayChildAdmin(Child, admin.site)\n+        request = _mocked_authenticated_request(user_noparents)\n+        response = m.changelist_view(request)\n+        # XXX - Calling render here to avoid ContentNotRenderedError to be\n+        # raised. Ticket #15826 should fix this but it's not yet integrated.\n+        response.render()\n+        self.assertNotContains(response, 'Parent object')\n+\n+        # Test with user 'parents'\n+        m = DynamicListDisplayChildAdmin(Child, admin.site)\n+        request = _mocked_authenticated_request(user_parents)\n+        response = m.changelist_view(request)\n+        # XXX - #15826\n+        response.render()\n+        self.assertContains(response, 'Parent object')\n+\n+        # Test default implementation\n+        m = ChildAdmin(Child, admin.site)\n+        request = _mocked_authenticated_request(user_noparents)\n+        response = m.changelist_view(request)\n+        # XXX - #15826\n+        response.render()\n+        self.assertContains(response, 'Parent object')\n+\n \n class ParentAdmin(admin.ModelAdmin):\n     list_filter = ['child__name']\n@@ -311,18 +360,19 @@ class ParentAdmin(admin.ModelAdmin):\n class ChildAdmin(admin.ModelAdmin):\n     list_display = ['name', 'parent']\n     list_per_page = 10\n+\n     def queryset(self, request):\n         return super(ChildAdmin, self).queryset(request).select_related(\"parent__name\")\n \n+\n class FilteredChildAdmin(admin.ModelAdmin):\n     list_display = ['name', 'parent']\n     list_per_page = 10\n+\n     def queryset(self, request):\n         return super(FilteredChildAdmin, self).queryset(request).filter(\n             name__contains='filtered')\n \n-class MockRequest(object):\n-    GET = {}\n \n class CustomPaginator(Paginator):\n     def __init__(self, queryset, page_size, orphans=0, allow_empty_first_page=True):\n@@ -333,19 +383,25 @@ def __init__(self, queryset, page_size, orphans=0, allow_empty_first_page=True):\n class BandAdmin(admin.ModelAdmin):\n     list_filter = ['genres']\n \n+\n class GroupAdmin(admin.ModelAdmin):\n     list_filter = ['members']\n \n+\n class QuartetAdmin(admin.ModelAdmin):\n     list_filter = ['members']\n \n+\n class ChordsBandAdmin(admin.ModelAdmin):\n     list_filter = ['members']\n \n-class MockFilterRequest(object):\n-    def __init__(self, filter, q):\n-        self.GET = {filter: q}\n \n-class MockSearchRequest(object):\n-    def __init__(self, q):\n-        self.GET = {SEARCH_VAR: q}\n+class DynamicListDisplayChildAdmin(admin.ModelAdmin):\n+    list_display = ('name', 'parent')\n+\n+    def get_list_display(self, request):\n+        my_list_display = list(self.list_display)\n+        if request.user.username == 'noparents':\n+            my_list_display.remove('parent')\n+\n+        return my_list_display"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 96,
        "deletions": 24
    }
}