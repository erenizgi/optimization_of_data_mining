{
    "author": "ramiro",
    "message": "Fixed #15424 -- Corrected lookup of callables listed in admin inlines' `readonly_fields` by passing the right ModelAdmin (sub)class instance when instantiating inline forms admin wrappers. Also, added early validation of its elements. Thanks kmike for the report and Karen for the patch fixing the issue.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15650 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "0a9b5d7adee86def16972debf6441deb96135ce2",
    "files": [
        {
            "sha": "a0eda384f09290295e32207dc835fe10ae9c6fb0",
            "filename": "django/contrib/admin/helpers.py",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/django%2Fcontrib%2Fadmin%2Fhelpers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fhelpers.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -206,14 +206,14 @@ def __iter__(self):\n         for form, original in zip(self.formset.initial_forms, self.formset.get_queryset()):\n             yield InlineAdminForm(self.formset, form, self.fieldsets,\n                 self.opts.prepopulated_fields, original, self.readonly_fields,\n-                model_admin=self.model_admin)\n+                model_admin=self.opts)\n         for form in self.formset.extra_forms:\n             yield InlineAdminForm(self.formset, form, self.fieldsets,\n                 self.opts.prepopulated_fields, None, self.readonly_fields,\n-                model_admin=self.model_admin)\n+                model_admin=self.opts)\n         yield InlineAdminForm(self.formset, self.formset.empty_form,\n             self.fieldsets, self.opts.prepopulated_fields, None,\n-            self.readonly_fields, model_admin=self.model_admin)\n+            self.readonly_fields, model_admin=self.opts)\n \n     def fields(self):\n         fk = getattr(self.formset, \"fk\", None)\n@@ -222,7 +222,7 @@ def fields(self):\n                 continue\n             if field in self.readonly_fields:\n                 yield {\n-                    'label': label_for_field(field, self.opts.model, self.model_admin),\n+                    'label': label_for_field(field, self.opts.model, self.opts),\n                     'widget': {\n                         'is_hidden': False\n                     },"
        },
        {
            "sha": "d0a52932109b86e45fbdb2e02a57fe9131d08f0d",
            "filename": "django/contrib/admin/util.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/django%2Fcontrib%2Fadmin%2Futil.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/django%2Fcontrib%2Fadmin%2Futil.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Futil.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -249,7 +249,7 @@ def label_for_field(name, model, model_admin=None, return_attr=False):\n             else:\n                 message = \"Unable to lookup '%s' on %s\" % (name, model._meta.object_name)\n                 if model_admin:\n-                    message += \" or %s\" % (model_admin.__name__,)\n+                    message += \" or %s\" % (model_admin.__class__.__name__,)\n                 raise AttributeError(message)\n \n             if hasattr(attr, \"short_description\"):"
        },
        {
            "sha": "e0db936df4090c923a5d458f4e9c2732089e87d1",
            "filename": "django/contrib/admin/validation.py",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/django%2Fcontrib%2Fadmin%2Fvalidation.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fadmin%2Fvalidation.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -129,16 +129,7 @@ def validate(cls, model):\n             get_field(cls, model, opts, 'ordering[%d]' % idx, field)\n \n     if hasattr(cls, \"readonly_fields\"):\n-        check_isseq(cls, \"readonly_fields\", cls.readonly_fields)\n-        for idx, field in enumerate(cls.readonly_fields):\n-            if not callable(field):\n-                if not hasattr(cls, field):\n-                    if not hasattr(model, field):\n-                        try:\n-                            opts.get_field(field)\n-                        except models.FieldDoesNotExist:\n-                            raise ImproperlyConfigured(\"%s.readonly_fields[%d], %r is not a callable or an attribute of %r or found in the model %r.\"\n-                                % (cls.__name__, idx, field, cls.__name__, model._meta.object_name))\n+        check_readonly_fields(cls, model, opts)\n \n     # list_select_related = False\n     # save_as = False\n@@ -199,6 +190,9 @@ def validate_inline(cls, parent, parent_model):\n                     \"'%s' - this is the foreign key to the parent model \"\n                     \"%s.\" % (cls.__name__, fk.name, parent_model.__name__))\n \n+    if hasattr(cls, \"readonly_fields\"):\n+        check_readonly_fields(cls, cls.model, cls.model._meta)\n+\n def validate_base(cls, model):\n     opts = model._meta\n \n@@ -384,3 +378,15 @@ def fetch_attr(cls, model, opts, label, field):\n     except AttributeError:\n         raise ImproperlyConfigured(\"'%s.%s' refers to '%s' that is neither a field, method or property of model '%s'.\"\n             % (cls.__name__, label, field, model.__name__))\n+\n+def check_readonly_fields(cls, model, opts):\n+    check_isseq(cls, \"readonly_fields\", cls.readonly_fields)\n+    for idx, field in enumerate(cls.readonly_fields):\n+        if not callable(field):\n+            if not hasattr(cls, field):\n+                if not hasattr(model, field):\n+                    try:\n+                        opts.get_field(field)\n+                    except models.FieldDoesNotExist:\n+                        raise ImproperlyConfigured(\"%s.readonly_fields[%d], %r is not a callable or an attribute of %r or found in the model %r.\"\n+                            % (cls.__name__, idx, field, cls.__name__, model._meta.object_name))"
        },
        {
            "sha": "ee0abd1d3d4e1962da3e8ba2b791819be850dc9d",
            "filename": "tests/regressiontests/admin_inlines/models.py",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Fmodels.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -151,3 +151,43 @@ class TitleInline(admin.TabularInline):\n     extra = 1\n \n admin.site.register(TitleCollection, inlines=[TitleInline])\n+\n+# Models for #15424\n+\n+class Poll(models.Model):\n+    name = models.CharField(max_length=40)\n+\n+class Question(models.Model):\n+    poll = models.ForeignKey(Poll)\n+\n+class QuestionInline(admin.TabularInline):\n+    model = Question\n+    readonly_fields=['call_me']\n+\n+    def call_me(self, obj):\n+        return 'Callable in QuestionInline'\n+\n+class PollAdmin(admin.ModelAdmin):\n+    inlines = [QuestionInline]\n+\n+    def call_me(self, obj):\n+        return 'Callable in PollAdmin'\n+\n+class Novel(models.Model):\n+    name = models.CharField(max_length=40)\n+\n+class Chapter(models.Model):\n+    novel = models.ForeignKey(Novel)\n+\n+class ChapterInline(admin.TabularInline):\n+    model = Chapter\n+    readonly_fields=['call_me']\n+\n+    def call_me(self, obj):\n+        return 'Callable in ChapterInline'\n+\n+class NovelAdmin(admin.ModelAdmin):\n+    inlines = [ChapterInline]\n+\n+admin.site.register(Poll, PollAdmin)\n+admin.site.register(Novel, NovelAdmin)"
        },
        {
            "sha": "067b3c5eaf26d9676866e33024247a9604aa8c36",
            "filename": "tests/regressiontests/admin_inlines/tests.py",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_inlines%2Ftests.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -84,6 +84,25 @@ def test_tabular_non_field_errors(self):\n         # Here colspan is \"4\": two fields (title1 and title2), one hidden field and the delete checkbock.\n         self.assertContains(response, '<tr><td colspan=\"4\"><ul class=\"errorlist\"><li>The two titles must be the same</li></ul></td></tr>')\n \n+    def test_no_parent_callable_lookup(self):\n+        \"\"\"Admin inline `readonly_field` shouldn't invoke parent ModelAdmin callable\"\"\"\n+        # Identically named callable isn't present in the parent ModelAdmin,\n+        # rendering of the add view shouldn't explode\n+        response = self.client.get('/test_admin/admin/admin_inlines/novel/add/')\n+        self.assertEqual(response.status_code, 200)\n+        # View should have the child inlines section\n+        self.assertContains(response, '<div class=\"inline-group\" id=\"chapter_set-group\">')\n+\n+    def test_callable_lookup(self):\n+        \"\"\"Admin inline should invoke local callable when its name is listed in readonly_fields\"\"\"\n+        response = self.client.get('/test_admin/admin/admin_inlines/poll/add/')\n+        self.assertEqual(response.status_code, 200)\n+        # Add parent object view should have the child inlines section\n+        self.assertContains(response, '<div class=\"inline-group\" id=\"question_set-group\">')\n+        # The right callabe should be used for the inline readonly_fields\n+        # column cells\n+        self.assertContains(response, '<p>Callable in QuestionInline</p>')\n+\n class TestInlineMedia(TestCase):\n     fixtures = ['admin-views-users.xml']\n "
        },
        {
            "sha": "5e080a92325d18c7f2d49795a3d2d1d780396e48",
            "filename": "tests/regressiontests/admin_validation/models.py",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_validation%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_validation%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_validation%2Fmodels.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -45,3 +45,11 @@ class Book(models.Model):\n class AuthorsBooks(models.Model):\n     author = models.ForeignKey(Author)\n     book = models.ForeignKey(Book)\n+\n+\n+class State(models.Model):\n+    name = models.CharField(max_length=15)\n+\n+\n+class City(models.Model):\n+    state = models.ForeignKey(State)"
        },
        {
            "sha": "6fbdc8040e4f0803a18911ddca71246398316d13",
            "filename": "tests/regressiontests/admin_validation/tests.py",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_validation%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/0a9b5d7adee86def16972debf6441deb96135ce2/tests%2Fregressiontests%2Fadmin_validation%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fadmin_validation%2Ftests.py?ref=0a9b5d7adee86def16972debf6441deb96135ce2",
            "patch": "@@ -4,7 +4,7 @@\n                                             ImproperlyConfigured\n from django.test import TestCase\n \n-from models import Song, Book, Album, TwoAlbumFKAndAnE\n+from models import Song, Book, Album, TwoAlbumFKAndAnE, State, City\n \n class SongForm(forms.ModelForm):\n     pass\n@@ -162,6 +162,16 @@ class SongAdmin(admin.ModelAdmin):\n             validate,\n             SongAdmin, Song)\n \n+    def test_nonexistant_field_on_inline(self):\n+        class CityInline(admin.TabularInline):\n+            model = City\n+            readonly_fields=['i_dont_exist'] # Missing attribute\n+\n+        self.assertRaisesMessage(ImproperlyConfigured,\n+            \"CityInline.readonly_fields[0], 'i_dont_exist' is not a callable or an attribute of 'CityInline' or found in the model 'City'.\",\n+            validate_inline,\n+            CityInline, None, State)\n+\n     def test_extra(self):\n         class SongAdmin(admin.ModelAdmin):\n             def awesome_song(self, instance):\n@@ -241,7 +251,3 @@ class FieldsOnFormOnlyAdmin(admin.ModelAdmin):\n             fields = ['title', 'extra_data']\n \n         validate(FieldsOnFormOnlyAdmin, Song)\n-\n-\n-\n-"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 99,
        "deletions": 20
    }
}