{
    "author": "aaugustin",
    "message": "Fixed #16039 -- Made post_syncdb handlers multi-db aware.\n\nAlso reverted 8fb7a9002669fb7ba7bec7df90b465b92e1ed3c2. Refs #17055.",
    "sha": "a026e480da89cb99c9dc6c954fb5a37ded0f9315",
    "files": [
        {
            "sha": "ce5d57fa7903d5f2446818435c34e421d005aab1",
            "filename": "django/contrib/auth/management/__init__.py",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/django/django/blob/a026e480da89cb99c9dc6c954fb5a37ded0f9315/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "raw_url": "https://github.com/django/django/raw/a026e480da89cb99c9dc6c954fb5a37ded0f9315/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fmanagement%2F__init__.py?ref=a026e480da89cb99c9dc6c954fb5a37ded0f9315",
            "patch": "@@ -10,6 +10,7 @@\n from django.contrib.auth import models as auth_app, get_user_model\n from django.core import exceptions\n from django.core.management.base import CommandError\n+from django.db import DEFAULT_DB_ALIAS, router\n from django.db.models import get_models, signals\n from django.utils import six\n from django.utils.six.moves import input\n@@ -57,7 +58,10 @@ def _check_permission_clashing(custom, builtin, ctype):\n                 (codename, ctype.app_label, ctype.model_class().__name__))\n         pool.add(codename)\n \n-def create_permissions(app, created_models, verbosity, **kwargs):\n+def create_permissions(app, created_models, verbosity, db=DEFAULT_DB_ALIAS, **kwargs):\n+    if not router.allow_syncdb(db, auth_app.Permission):\n+        return\n+\n     from django.contrib.contenttypes.models import ContentType\n \n     app_models = get_models(app)\n@@ -68,29 +72,31 @@ def create_permissions(app, created_models, verbosity, **kwargs):\n     # The codenames and ctypes that should exist.\n     ctypes = set()\n     for klass in app_models:\n-        ctype = ContentType.objects.get_for_model(klass)\n+        # Force looking up the content types in the current database\n+        # before creating foreign keys to them.\n+        ctype = ContentType.objects.db_manager(db).get_for_model(klass)\n         ctypes.add(ctype)\n         for perm in _get_all_permissions(klass._meta, ctype):\n             searched_perms.append((ctype, perm))\n \n     # Find all the Permissions that have a context_type for a model we're\n     # looking for.  We don't need to check for codenames since we already have\n     # a list of the ones we're going to create.\n-    all_perms = set(auth_app.Permission.objects.filter(\n+    all_perms = set(auth_app.Permission.objects.using(db).filter(\n         content_type__in=ctypes,\n     ).values_list(\n         \"content_type\", \"codename\"\n     ))\n \n-    objs = [\n+    perms = [\n         auth_app.Permission(codename=codename, name=name, content_type=ctype)\n         for ctype, (codename, name) in searched_perms\n         if (ctype.pk, codename) not in all_perms\n     ]\n-    auth_app.Permission.objects.bulk_create(objs)\n+    auth_app.Permission.objects.using(db).bulk_create(perms)\n     if verbosity >= 2:\n-        for obj in objs:\n-            print(\"Adding permission '%s'\" % obj)\n+        for perm in perms:\n+            print(\"Adding permission '%s'\" % perm)\n \n \n def create_superuser(app, created_models, verbosity, db, **kwargs):"
        },
        {
            "sha": "85f76bac77befaaf7d2ad4ec3cd03f5f98b689d1",
            "filename": "django/contrib/contenttypes/management.py",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/a026e480da89cb99c9dc6c954fb5a37ded0f9315/django%2Fcontrib%2Fcontenttypes%2Fmanagement.py",
            "raw_url": "https://github.com/django/django/raw/a026e480da89cb99c9dc6c954fb5a37ded0f9315/django%2Fcontrib%2Fcontenttypes%2Fmanagement.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fcontenttypes%2Fmanagement.py?ref=a026e480da89cb99c9dc6c954fb5a37ded0f9315",
            "patch": "@@ -1,14 +1,18 @@\n from django.contrib.contenttypes.models import ContentType\n+from django.db import DEFAULT_DB_ALIAS, router\n from django.db.models import get_apps, get_models, signals\n from django.utils.encoding import smart_text\n from django.utils import six\n from django.utils.six.moves import input\n \n-def update_contenttypes(app, created_models, verbosity=2, **kwargs):\n+def update_contenttypes(app, created_models, verbosity=2, db=DEFAULT_DB_ALIAS, **kwargs):\n     \"\"\"\n     Creates content types for models in the given app, removing any model\n     entries that no longer have a matching model class.\n     \"\"\"\n+    if not router.allow_syncdb(db, ContentType):\n+        return\n+\n     ContentType.objects.clear_cache()\n     app_models = get_models(app)\n     if not app_models:\n@@ -19,26 +23,28 @@ def update_contenttypes(app, created_models, verbosity=2, **kwargs):\n         (model._meta.object_name.lower(), model)\n         for model in app_models\n     )\n+\n     # Get all the content types\n     content_types = dict(\n         (ct.model, ct)\n-        for ct in ContentType.objects.filter(app_label=app_label)\n+        for ct in ContentType.objects.using(db).filter(app_label=app_label)\n     )\n     to_remove = [\n         ct\n         for (model_name, ct) in six.iteritems(content_types)\n         if model_name not in app_models\n     ]\n \n-    cts = ContentType.objects.bulk_create([\n+    cts = [\n         ContentType(\n             name=smart_text(model._meta.verbose_name_raw),\n             app_label=app_label,\n             model=model_name,\n         )\n         for (model_name, model) in six.iteritems(app_models)\n         if model_name not in content_types\n-    ])\n+    ]\n+    ContentType.objects.using(db).bulk_create(cts)\n     if verbosity >= 2:\n         for ct in cts:\n             print(\"Adding content type '%s | %s'\" % (ct.app_label, ct.model))"
        },
        {
            "sha": "e26b927ae7962def52de7ebb0c14a34ee09bbfeb",
            "filename": "docs/releases/1.5.txt",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/a026e480da89cb99c9dc6c954fb5a37ded0f9315/docs%2Freleases%2F1.5.txt",
            "raw_url": "https://github.com/django/django/raw/a026e480da89cb99c9dc6c954fb5a37ded0f9315/docs%2Freleases%2F1.5.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Freleases%2F1.5.txt?ref=a026e480da89cb99c9dc6c954fb5a37ded0f9315",
            "patch": "@@ -551,6 +551,20 @@ with the :meth:`~django.forms.Form.is_valid()` method and not with the\n presence or absence of the :attr:`~django.forms.Form.cleaned_data` attribute\n on the form.\n \n+Behavior of :djadmin:`syncdb` with multiple databases\n+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+\n+:djadmin:`syncdb` now queries the database routers to determine if content\n+types (when :mod:`~django.contrib.contenttypes` is enabled) and permissions\n+(when :mod:`~django.contrib.auth` is enabled) should be created in the target\n+database. Previously, it created them in the default database, even when\n+another database was specified with the :djadminopt:`--database` option.\n+\n+If you use :djadmin:`syncdb` on multiple databases, you should ensure that\n+your routers allow synchronizing content types and permissions to only one of\n+them. See the docs on the :ref:`behavior of contrib apps with multiple\n+databases <contrib_app_multiple_databases>` for more information.\n+\n Miscellaneous\n ~~~~~~~~~~~~~\n "
        },
        {
            "sha": "8a02305376f4ca16c3d37967bfa7519631c5090b",
            "filename": "docs/topics/db/multi-db.txt",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/django/django/blob/a026e480da89cb99c9dc6c954fb5a37ded0f9315/docs%2Ftopics%2Fdb%2Fmulti-db.txt",
            "raw_url": "https://github.com/django/django/raw/a026e480da89cb99c9dc6c954fb5a37ded0f9315/docs%2Ftopics%2Fdb%2Fmulti-db.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Ftopics%2Fdb%2Fmulti-db.txt?ref=a026e480da89cb99c9dc6c954fb5a37ded0f9315",
            "patch": "@@ -630,3 +630,49 @@ However, if you're using SQLite or MySQL with MyISAM tables, there is\n no enforced referential integrity; as a result, you may be able to\n 'fake' cross database foreign keys. However, this configuration is not\n officially supported by Django.\n+\n+.. _contrib_app_multiple_databases:\n+\n+Behavior of contrib apps\n+------------------------\n+\n+Several contrib apps include models, and some apps depend on others. Since\n+cross-database relationships are impossible, this creates some restrictions on\n+how you can split these models across databases:\n+\n+- each one of ``contenttypes.ContentType``, ``sessions.Session`` and\n+  ``sites.Site`` can be stored in any database, given a suitable router.\n+- ``auth`` models — ``User``, ``Group`` and ``Permission`` — are linked\n+  together and linked to ``ContentType``, so they must be stored in the same\n+  database as ``ContentType``.\n+- ``admin`` and ``comments`` depend on ``auth``, so their models must be in\n+  the same database as ``auth``.\n+- ``flatpages`` and ``redirects`` depend on ``sites``, so their models must be\n+  in the same database as ``sites``.\n+\n+In addition, some objects are automatically created just after\n+:djadmin:`syncdb` creates a table to hold them in a database:\n+\n+- a default ``Site``,\n+- a ``ContentType`` for each model (including those not stored in that\n+  database),\n+- three ``Permission`` for each model (including those not stored in that\n+  database).\n+\n+.. versionchanged:: 1.5\n+    Previously, ``ContentType`` and ``Permission`` instances were created only\n+    in the default database.\n+\n+For common setups with multiple databases, it isn't useful to have these\n+objects in more than one database. Common setups include master / slave and\n+connecting to external databases. Therefore, it's recommended:\n+\n+- either to run :djadmin:`syncdb` only for the default database;\n+- or to write :ref:`database router<topics-db-multi-db-routing>` that allows\n+  synchronizing these three models only to one database.\n+\n+.. warning::\n+\n+    If you're synchronizing content types to more that one database, be aware\n+    that their primary keys may not match across databases. This may result in\n+    data corruption or data loss."
        },
        {
            "sha": "a1d9e93524f73b18ca0640b9ae611b1acf209c37",
            "filename": "tests/regressiontests/multiple_database/tests.py",
            "status": "modified",
            "additions": 33,
            "deletions": 22,
            "changes": 55,
            "blob_url": "https://github.com/django/django/blob/a026e480da89cb99c9dc6c954fb5a37ded0f9315/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/a026e480da89cb99c9dc6c954fb5a37ded0f9315/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fmultiple_database%2Ftests.py?ref=a026e480da89cb99c9dc6c954fb5a37ded0f9315",
            "patch": "@@ -16,16 +16,6 @@\n from .models import Book, Person, Pet, Review, UserProfile\n \n \n-def copy_content_types_from_default_to_other():\n-    # On post_syncdb, content types are created in the 'default' database.\n-    # However, tests of generic foreign keys require them in 'other' too.\n-    # The problem is masked on backends that defer constraints checks: at the\n-    # end of each test, there's a rollback, and constraints are never checked.\n-    # It only appears on MySQL + InnoDB.\n-    for ct in ContentType.objects.using('default').all():\n-        ct.save(using='other')\n-\n-\n class QueryTestCase(TestCase):\n     multi_db = True\n \n@@ -705,8 +695,6 @@ def test_o2o_cross_database_protection(self):\n \n     def test_generic_key_separation(self):\n         \"Generic fields are constrained to a single database\"\n-        copy_content_types_from_default_to_other()\n-\n         # Create a book and author on the default database\n         pro = Book.objects.create(title=\"Pro Django\",\n                                   published=datetime.date(2008, 12, 16))\n@@ -734,8 +722,6 @@ def test_generic_key_separation(self):\n \n     def test_generic_key_reverse_operations(self):\n         \"Generic reverse manipulations are all constrained to a single DB\"\n-        copy_content_types_from_default_to_other()\n-\n         dive = Book.objects.using('other').create(title=\"Dive into Python\",\n                                                   published=datetime.date(2009, 5, 4))\n \n@@ -780,8 +766,6 @@ def test_generic_key_reverse_operations(self):\n \n     def test_generic_key_cross_database_protection(self):\n         \"Operations that involve sharing generic key objects across databases raise an error\"\n-        copy_content_types_from_default_to_other()\n-\n         # Create a book and author on the default database\n         pro = Book.objects.create(title=\"Pro Django\",\n                                   published=datetime.date(2008, 12, 16))\n@@ -833,8 +817,6 @@ def test_generic_key_cross_database_protection(self):\n \n     def test_generic_key_deletion(self):\n         \"Cascaded deletions of Generic Key relations issue queries on the right database\"\n-        copy_content_types_from_default_to_other()\n-\n         dive = Book.objects.using('other').create(title=\"Dive into Python\",\n                                                   published=datetime.date(2009, 5, 4))\n         review = Review.objects.using('other').create(source=\"Python Weekly\", content_object=dive)\n@@ -1402,8 +1384,6 @@ def test_o2o_cross_database_protection(self):\n \n     def test_generic_key_cross_database_protection(self):\n         \"Generic Key operations can span databases if they share a source\"\n-        copy_content_types_from_default_to_other()\n-\n         # Create a book and author on the default database\n         pro = Book.objects.using('default'\n                 ).create(title=\"Pro Django\", published=datetime.date(2008, 12, 16))\n@@ -1515,8 +1495,6 @@ def test_foreign_key_managers(self):\n \n     def test_generic_key_managers(self):\n         \"Generic key relations are represented by managers, and can be controlled like managers\"\n-        copy_content_types_from_default_to_other()\n-\n         pro = Book.objects.using('other').create(title=\"Pro Django\",\n                                                  published=datetime.date(2008, 12, 16))\n \n@@ -1922,3 +1900,36 @@ def test_foreignkey_collection(self):\n         pet = Pet.objects.create(owner=person, name='Wart')\n         # test related FK collection\n         person.delete()\n+\n+\n+class SyncOnlyDefaultDatabaseRouter(object):\n+    def allow_syncdb(self, db, model):\n+        return db == DEFAULT_DB_ALIAS\n+\n+\n+class SyncDBTestCase(TestCase):\n+    multi_db = True\n+\n+    def test_syncdb_to_other_database(self):\n+        \"\"\"Regression test for #16039: syncdb with --database option.\"\"\"\n+        count = ContentType.objects.count()\n+        self.assertGreater(count, 0)\n+\n+        ContentType.objects.using('other').delete()\n+        management.call_command('syncdb', verbosity=0, interactive=False,\n+            load_initial_data=False, database='other')\n+\n+        self.assertEqual(ContentType.objects.using(\"other\").count(), count)\n+\n+    def test_syncdb_to_other_database_with_router(self):\n+        \"\"\"Regression test for #16039: syncdb with --database option.\"\"\"\n+        ContentType.objects.using('other').delete()\n+        try:\n+            old_routers = router.routers\n+            router.routers = [SyncOnlyDefaultDatabaseRouter()]\n+            management.call_command('syncdb', verbosity=0, interactive=False,\n+                load_initial_data=False, database='other')\n+        finally:\n+            router.routers = old_routers\n+\n+        self.assertEqual(ContentType.objects.using(\"other\").count(), 0)"
        }
    ],
    "stats": {
        "total": 149,
        "additions": 116,
        "deletions": 33
    }
}