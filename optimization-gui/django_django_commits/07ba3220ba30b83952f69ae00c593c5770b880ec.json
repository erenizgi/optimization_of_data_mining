{
    "author": "alex",
    "message": "Fixed #14754 -- corrected using an aggregate in an F expressions when that queryset is later used in a subquery.  Thanks to master for the patch.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@14681 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "07ba3220ba30b83952f69ae00c593c5770b880ec",
    "files": [
        {
            "sha": "fffbba085c33afd2acf497bd433cf54d4d3b802a",
            "filename": "django/db/models/sql/expressions.py",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/07ba3220ba30b83952f69ae00c593c5770b880ec/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py",
            "raw_url": "https://github.com/django/django/raw/07ba3220ba30b83952f69ae00c593c5770b880ec/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fexpressions.py?ref=07ba3220ba30b83952f69ae00c593c5770b880ec",
            "patch": "@@ -19,7 +19,10 @@ def as_sql(self, qn, connection):\n \n     def relabel_aliases(self, change_map):\n         for node, col in self.cols.items():\n-            self.cols[node] = (change_map.get(col[0], col[0]), col[1])\n+            if hasattr(col, \"relabel_aliases\"):\n+                col.relabel_aliases(change_map)\n+            else:\n+                self.cols[node] = (change_map.get(col[0], col[0]), col[1])\n \n     #####################################################\n     # Vistor methods for initial expression preparation #"
        },
        {
            "sha": "ccef9a5fc89d5d0e91372b604110f9473a5bff9b",
            "filename": "tests/regressiontests/aggregation_regress/models.py",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/django/django/blob/07ba3220ba30b83952f69ae00c593c5770b880ec/tests%2Fregressiontests%2Faggregation_regress%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/07ba3220ba30b83952f69ae00c593c5770b880ec/tests%2Fregressiontests%2Faggregation_regress%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Fmodels.py?ref=07ba3220ba30b83952f69ae00c593c5770b880ec",
            "patch": "@@ -1,8 +1,5 @@\n # coding: utf-8\n-import pickle\n-\n-from django.db import connection, models, DEFAULT_DB_ALIAS\n-from django.conf import settings\n+from django.db import models\n \n \n class Author(models.Model):\n@@ -49,7 +46,6 @@ class Store(models.Model):\n     def __unicode__(self):\n         return self.name\n \n-\n class Entries(models.Model):\n     EntryID = models.AutoField(primary_key=True, db_column='Entry ID')\n     Entry = models.CharField(unique=True, max_length=50)"
        },
        {
            "sha": "9b9d5d4be8235b0828d107903cddf349354480af",
            "filename": "tests/regressiontests/aggregation_regress/tests.py",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/django/django/blob/07ba3220ba30b83952f69ae00c593c5770b880ec/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/07ba3220ba30b83952f69ae00c593c5770b880ec/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Faggregation_regress%2Ftests.py?ref=07ba3220ba30b83952f69ae00c593c5770b880ec",
            "patch": "@@ -1,13 +1,13 @@\n import datetime\n+import pickle\n from decimal import Decimal\n+from operator import attrgetter\n \n from django.core.exceptions import FieldError\n-from django.conf import settings\n from django.test import TestCase, Approximate, skipUnlessDBFeature\n-from django.db import DEFAULT_DB_ALIAS\n from django.db.models import Count, Max, Avg, Sum, StdDev, Variance, F\n \n-from regressiontests.aggregation_regress.models import *\n+from models import Author, Book, Publisher, Clues, Entries, HardbackBook\n \n \n class AggregationTests(TestCase):\n@@ -482,7 +482,7 @@ def test_pickle(self):\n         # Regression for #10197 -- Queries with aggregates can be pickled.\n         # First check that pickling is possible at all. No crash = success\n         qs = Book.objects.annotate(num_authors=Count('authors'))\n-        out = pickle.dumps(qs)\n+        pickle.dumps(qs)\n \n         # Then check that the round trip works.\n         query = qs.query.get_compiler(qs.db).as_sql()[0]\n@@ -640,6 +640,20 @@ def test_annotate_and_join(self):\n             Author.objects.count()\n         )\n \n+    def test_f_expression_annotation(self):\n+        # Books with less than 200 pages per author.\n+        qs = Book.objects.values(\"name\").annotate(\n+            n_authors=Count(\"authors\")\n+        ).filter(\n+            pages__lt=F(\"n_authors\") * 200\n+        ).values_list(\"pk\")\n+        self.assertQuerysetEqual(\n+            Book.objects.filter(pk__in=qs), [\n+                \"Python Web Development with Django\"\n+            ],\n+            attrgetter(\"name\")\n+        )\n+\n     @skipUnlessDBFeature('supports_stddev')\n     def test_stddev(self):\n         self.assertEqual("
        }
    ],
    "stats": {
        "total": 33,
        "additions": 23,
        "deletions": 10
    }
}