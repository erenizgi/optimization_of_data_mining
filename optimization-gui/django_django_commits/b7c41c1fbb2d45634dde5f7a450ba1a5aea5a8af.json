{
    "author": "freakboy3742",
    "message": "Fixed #12252 -- Ensure that queryset unions are commutative. Thanks to benreynwar for the report, and draft patch, and to Karen and Ramiro for the review eyeballs and patch updates.\n\ngit-svn-id: http://code.djangoproject.com/svn/django/trunk@15726 bcc190cf-cafb-0310-a4f2-bffc1f526a37",
    "sha": "b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af",
    "files": [
        {
            "sha": "8fa3419059f2c4e506b960b840d9bae420608699",
            "filename": "django/db/models/sql/query.py",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/django/django/blob/b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af/django%2Fdb%2Fmodels%2Fsql%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fdb%2Fmodels%2Fsql%2Fquery.py?ref=b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af",
            "patch": "@@ -446,6 +446,8 @@ def combine(self, rhs, connector):\n             \"Cannot combine a unique query with a non-unique query.\"\n \n         self.remove_inherited_models()\n+        l_tables = set([a for a in self.tables if self.alias_refcount[a]])\n+        r_tables = set([a for a in rhs.tables if rhs.alias_refcount[a]])\n         # Work out how to relabel the rhs aliases, if necessary.\n         change_map = {}\n         used = set()\n@@ -463,13 +465,19 @@ def combine(self, rhs, connector):\n             first = False\n \n         # So that we don't exclude valid results in an \"or\" query combination,\n-        # the first join that is exclusive to the lhs (self) must be converted\n+        # all joins exclusive to either the lhs or the rhs must be converted\n         # to an outer join.\n         if not conjunction:\n-            for alias in self.tables[1:]:\n-                if self.alias_refcount[alias] == 1:\n-                    self.promote_alias(alias, True)\n-                    break\n+            # Update r_tables aliases.\n+            for alias in change_map:\n+                if alias in r_tables:\n+                    r_tables.remove(alias)\n+                    r_tables.add(change_map[alias])\n+            # Find aliases that are exclusive to rhs or lhs.\n+            # These are promoted to outer joins.\n+            outer_aliases = (l_tables | r_tables) - (l_tables & r_tables)\n+            for alias in outer_aliases:\n+                self.promote_alias(alias, True)\n \n         # Now relabel a copy of the rhs where-clause and add it to the current\n         # one."
        },
        {
            "sha": "d441433ba149aa3a2de681fc427927aeb967be2e",
            "filename": "tests/regressiontests/queries/models.py",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/django/django/blob/b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "raw_url": "https://github.com/django/django/raw/b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af/tests%2Fregressiontests%2Fqueries%2Fmodels.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Fmodels.py?ref=b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af",
            "patch": "@@ -294,3 +294,26 @@ class Node(models.Model):\n \n     def __unicode__(self):\n         return u\"%s\" % self.num\n+\n+# Bug #12252\n+class ObjectA(models.Model):\n+    name = models.CharField(max_length=50)\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class ObjectB(models.Model):\n+    name = models.CharField(max_length=50)\n+    objecta = models.ForeignKey(ObjectA)\n+    number = models.PositiveSmallIntegerField()\n+\n+    def __unicode__(self):\n+        return self.name\n+\n+class ObjectC(models.Model):\n+    name = models.CharField(max_length=50)\n+    objecta = models.ForeignKey(ObjectA)\n+    objectb = models.ForeignKey(ObjectB)\n+\n+    def __unicode__(self):\n+       return self.name"
        },
        {
            "sha": "f6643f6614e4d59bf713452561de08e5cf3bd9a2",
            "filename": "tests/regressiontests/queries/tests.py",
            "status": "modified",
            "additions": 62,
            "deletions": 1,
            "changes": 63,
            "blob_url": "https://github.com/django/django/blob/b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af/tests%2Fregressiontests%2Fqueries%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/tests%2Fregressiontests%2Fqueries%2Ftests.py?ref=b7c41c1fbb2d45634dde5f7a450ba1a5aea5a8af",
            "patch": "@@ -14,7 +14,8 @@\n from models import (Annotation, Article, Author, Celebrity, Child, Cover, Detail,\n     DumbCategory, ExtraInfo, Fan, Item, LeafA, LoopX, LoopZ, ManagedModel,\n     Member, NamedCategory, Note, Number, Plaything, PointerA, Ranking, Related,\n-    Report, ReservedName, Tag, TvChef, Valid, X, Food, Eaten, Node)\n+    Report, ReservedName, Tag, TvChef, Valid, X, Food, Eaten, Node, ObjectA, ObjectB,\n+    ObjectC)\n \n \n class BaseQuerysetTest(TestCase):\n@@ -1658,3 +1659,63 @@ def test_ticket14244(self):\n             Number.objects.filter(num__in=numbers).count(),\n             2500\n         )\n+\n+class UnionTests(unittest.TestCase):\n+    \"\"\"\n+    Tests for the union of two querysets. Bug #12252.\n+    \"\"\"\n+    def setUp(self):\n+        objectas = []\n+        objectbs = []\n+        objectcs = []\n+        a_info = ['one', 'two', 'three']\n+        for name in a_info:\n+            o = ObjectA(name=name)\n+            o.save()\n+            objectas.append(o)\n+        b_info = [('un', 1, objectas[0]), ('deux', 2, objectas[0]), ('trois', 3, objectas[2])]\n+        for name, number, objecta in b_info:\n+            o = ObjectB(name=name, number=number, objecta=objecta)\n+            o.save()\n+            objectbs.append(o)\n+        c_info = [('ein', objectas[2], objectbs[2]), ('zwei', objectas[1], objectbs[1])]\n+        for name, objecta, objectb in c_info:\n+            o = ObjectC(name=name, objecta=objecta, objectb=objectb)\n+            o.save()\n+            objectcs.append(o)\n+\n+    def check_union(self, model, Q1, Q2):\n+        filter = model.objects.filter\n+        self.assertEqual(set(filter(Q1) | filter(Q2)), set(filter(Q1 | Q2)))\n+        self.assertEqual(set(filter(Q2) | filter(Q1)), set(filter(Q1 | Q2)))\n+\n+    def test_A_AB(self):\n+        Q1 = Q(name='two')\n+        Q2 = Q(objectb__name='deux')\n+        self.check_union(ObjectA, Q1, Q2)\n+\n+    def test_A_AB2(self):\n+        Q1 = Q(name='two')\n+        Q2 = Q(objectb__name='deux', objectb__number=2)\n+        self.check_union(ObjectA, Q1, Q2)\n+\n+    def test_AB_ACB(self):\n+        Q1 = Q(objectb__name='deux')\n+        Q2 = Q(objectc__objectb__name='deux')\n+        self.check_union(ObjectA, Q1, Q2)\n+\n+    def test_BAB_BAC(self):\n+        Q1 = Q(objecta__objectb__name='deux')\n+        Q2 = Q(objecta__objectc__name='ein')\n+        self.check_union(ObjectB, Q1, Q2)\n+\n+    def test_BAB_BACB(self):\n+        Q1 = Q(objecta__objectb__name='deux')\n+        Q2 = Q(objecta__objectc__objectb__name='trois')\n+        self.check_union(ObjectB, Q1, Q2)\n+\n+    def test_BA_BCA__BAB_BAC_BCA(self):\n+        Q1 = Q(objecta__name='one', objectc__objecta__name='two')\n+        Q2 = Q(objecta__objectc__name='ein', objectc__objecta__name='three', objecta__objectb__name='trois')\n+        self.check_union(ObjectB, Q1, Q2)\n+"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 98,
        "deletions": 6
    }
}