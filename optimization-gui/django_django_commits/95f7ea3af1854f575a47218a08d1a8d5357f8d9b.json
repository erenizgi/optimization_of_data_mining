{
    "author": "bkg",
    "message": "Fixed #19028 -- Support GeoJSON output with SpatiaLite 3.0+",
    "sha": "95f7ea3af1854f575a47218a08d1a8d5357f8d9b",
    "files": [
        {
            "sha": "5eaa77843c93cfb217f86b23c8af32561a4cfe5b",
            "filename": "django/contrib/gis/db/backends/spatialite/operations.py",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "raw_url": "https://github.com/django/django/raw/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fbackends%2Fspatialite%2Foperations.py?ref=95f7ea3af1854f575a47218a08d1a8d5357f8d9b",
            "patch": "@@ -146,6 +146,8 @@ def confirm_spatial_components_versions(self):\n             except DatabaseError:\n                 # we are using < 2.4.0-RC4\n                 pass\n+        if version >= (3, 0, 0):\n+            self.geojson = 'AsGeoJSON'\n \n     def check_aggregate_support(self, aggregate):\n         \"\"\""
        },
        {
            "sha": "2ffbd2021b32487151188a0c5c0c7579a9f85af5",
            "filename": "django/contrib/gis/db/models/query.py",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fquery.py",
            "raw_url": "https://github.com/django/django/raw/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fquery.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fdb%2Fmodels%2Fquery.py?ref=95f7ea3af1854f575a47218a08d1a8d5357f8d9b",
            "patch": "@@ -146,13 +146,14 @@ def geojson(self, precision=8, crs=False, bbox=False, **kwargs):\n         \"\"\"\n         backend = connections[self.db].ops\n         if not backend.geojson:\n-            raise NotImplementedError('Only PostGIS 1.3.4+ supports GeoJSON serialization.')\n+            raise NotImplementedError('Only PostGIS 1.3.4+ and SpatiaLite 3.0+ '\n+                                      'support GeoJSON serialization.')\n \n         if not isinstance(precision, six.integer_types):\n             raise TypeError('Precision keyword must be set with an integer.')\n \n         # Setting the options flag -- which depends on which version of\n-        # PostGIS we're using.\n+        # PostGIS we're using. SpatiaLite only uses the first group of options.\n         if backend.spatial_version >= (1, 4, 0):\n             options = 0\n             if crs and bbox: options = 3"
        },
        {
            "sha": "8f2c22e841b33842285a0f2a3b7758fe3f4593a5",
            "filename": "django/contrib/gis/tests/geoapp/tests.py",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/django/django/blob/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fgeoapp%2Ftests.py?ref=95f7ea3af1854f575a47218a08d1a8d5357f8d9b",
            "patch": "@@ -474,21 +474,21 @@ def test_geohash(self):\n \n     def test_geojson(self):\n         \"Testing GeoJSON output from the database using GeoQuerySet.geojson().\"\n-        # Only PostGIS 1.3.4+ supports GeoJSON.\n+        # Only PostGIS 1.3.4+ and SpatiaLite 3.0+ support GeoJSON.\n         if not connection.ops.geojson:\n             self.assertRaises(NotImplementedError, Country.objects.all().geojson, field_name='mpoly')\n             return\n \n-        if connection.ops.spatial_version >= (1, 4, 0):\n-            pueblo_json = '{\"type\":\"Point\",\"coordinates\":[-104.609252,38.255001]}'\n-            houston_json = '{\"type\":\"Point\",\"crs\":{\"type\":\"name\",\"properties\":{\"name\":\"EPSG:4326\"}},\"coordinates\":[-95.363151,29.763374]}'\n-            victoria_json = '{\"type\":\"Point\",\"bbox\":[-123.30519600,48.46261100,-123.30519600,48.46261100],\"coordinates\":[-123.305196,48.462611]}'\n-            chicago_json = '{\"type\":\"Point\",\"crs\":{\"type\":\"name\",\"properties\":{\"name\":\"EPSG:4326\"}},\"bbox\":[-87.65018,41.85039,-87.65018,41.85039],\"coordinates\":[-87.65018,41.85039]}'\n-        else:\n+        pueblo_json = '{\"type\":\"Point\",\"coordinates\":[-104.609252,38.255001]}'\n+        houston_json = '{\"type\":\"Point\",\"crs\":{\"type\":\"name\",\"properties\":{\"name\":\"EPSG:4326\"}},\"coordinates\":[-95.363151,29.763374]}'\n+        victoria_json = '{\"type\":\"Point\",\"bbox\":[-123.30519600,48.46261100,-123.30519600,48.46261100],\"coordinates\":[-123.305196,48.462611]}'\n+        chicago_json = '{\"type\":\"Point\",\"crs\":{\"type\":\"name\",\"properties\":{\"name\":\"EPSG:4326\"}},\"bbox\":[-87.65018,41.85039,-87.65018,41.85039],\"coordinates\":[-87.65018,41.85039]}'\n+        if postgis and connection.ops.spatial_version < (1, 4, 0):\n             pueblo_json = '{\"type\":\"Point\",\"coordinates\":[-104.60925200,38.25500100]}'\n             houston_json = '{\"type\":\"Point\",\"crs\":{\"type\":\"EPSG\",\"properties\":{\"EPSG\":4326}},\"coordinates\":[-95.36315100,29.76337400]}'\n             victoria_json = '{\"type\":\"Point\",\"bbox\":[-123.30519600,48.46261100,-123.30519600,48.46261100],\"coordinates\":[-123.30519600,48.46261100]}'\n-            chicago_json = '{\"type\":\"Point\",\"crs\":{\"type\":\"EPSG\",\"properties\":{\"EPSG\":4326}},\"bbox\":[-87.65018,41.85039,-87.65018,41.85039],\"coordinates\":[-87.65018,41.85039]}'\n+        elif spatialite:\n+            victoria_json = '{\"type\":\"Point\",\"bbox\":[-123.305196,48.462611,-123.305196,48.462611],\"coordinates\":[-123.305196,48.462611]}'\n \n         # Precision argument should only be an integer\n         self.assertRaises(TypeError, City.objects.geojson, precision='foo')"
        },
        {
            "sha": "519f79f0d48901a8aa5377b8fcd0f3d325f0d2f8",
            "filename": "docs/ref/contrib/gis/db-api.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/docs%2Fref%2Fcontrib%2Fgis%2Fdb-api.txt",
            "raw_url": "https://github.com/django/django/raw/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/docs%2Fref%2Fcontrib%2Fgis%2Fdb-api.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Fdb-api.txt?ref=95f7ea3af1854f575a47218a08d1a8d5357f8d9b",
            "patch": "@@ -282,7 +282,7 @@ Method                                PostGIS  Oracle  SpatiaLite\n :meth:`GeoQuerySet.extent3d`          X\n :meth:`GeoQuerySet.force_rhr`         X\n :meth:`GeoQuerySet.geohash`           X\n-:meth:`GeoQuerySet.geojson`           X\n+:meth:`GeoQuerySet.geojson`           X                X\n :meth:`GeoQuerySet.gml`               X        X       X\n :meth:`GeoQuerySet.intersection`      X        X       X\n :meth:`GeoQuerySet.kml`               X                X"
        },
        {
            "sha": "69280dc0286ab4998a9c85f3f88bb840af60cf85",
            "filename": "docs/ref/contrib/gis/geoquerysets.txt",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/docs%2Fref%2Fcontrib%2Fgis%2Fgeoquerysets.txt",
            "raw_url": "https://github.com/django/django/raw/95f7ea3af1854f575a47218a08d1a8d5357f8d9b/docs%2Fref%2Fcontrib%2Fgis%2Fgeoquerysets.txt",
            "contents_url": "https://api.github.com/repos/django/django/contents/docs%2Fref%2Fcontrib%2Fgis%2Fgeoquerysets.txt?ref=95f7ea3af1854f575a47218a08d1a8d5357f8d9b",
            "patch": "@@ -947,7 +947,7 @@ __ http://geohash.org/\n \n .. method:: GeoQuerySet.geojson(**kwargs)\n \n-*Availability*: PostGIS\n+*Availability*: PostGIS, SpatiaLite\n \n Attaches a ``geojson`` attribute to every model in the queryset that contains the\n `GeoJSON`__ representation of the geometry."
        }
    ],
    "stats": {
        "total": 27,
        "additions": 15,
        "deletions": 12
    }
}