{
    "author": "claudep",
    "message": "Use smarter string decoding in GeoDjango\n\nThe first try to solve the Python 3 GIS encoding/decoding issue\nwas too naive. Using decode() on all read strings is bound to fail\nas soon as a non-ascii string is concerned.\nThis patch is a little more clever, leaving ascii decoding when\nplain ascii strings are expected, and allowing to specify a custom\nencoding in DataSource hierarchy.",
    "sha": "9a2bceed1aab52f65820c378f5ae1f608322b55c",
    "files": [
        {
            "sha": "c92b2e170b88ff69f906d0e277f5fbb6a50af344",
            "filename": "django/contrib/gis/gdal/datasource.py",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fdatasource.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fdatasource.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fdatasource.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -45,7 +45,7 @@\n # Getting the ctypes prototypes for the DataSource.\n from django.contrib.gis.gdal.prototypes import ds as capi\n \n-from django.utils.encoding import force_bytes\n+from django.utils.encoding import force_bytes, force_text\n from django.utils import six\n from django.utils.six.moves import xrange\n \n@@ -57,12 +57,14 @@ class DataSource(GDALBase):\n     \"Wraps an OGR Data Source object.\"\n \n     #### Python 'magic' routines ####\n-    def __init__(self, ds_input, ds_driver=False, write=False):\n+    def __init__(self, ds_input, ds_driver=False, write=False, encoding='utf-8'):\n         # The write flag.\n         if write:\n             self._write = 1\n         else:\n             self._write = 0\n+        # See also http://trac.osgeo.org/gdal/wiki/rfc23_ogr_unicode\n+        self.encoding = encoding\n \n         # Registering all the drivers, this needs to be done\n         #  _before_ we try to open up a data source.\n@@ -129,4 +131,5 @@ def layer_count(self):\n     @property\n     def name(self):\n         \"Returns the name of the data source.\"\n-        return capi.get_ds_name(self._ptr)\n+        name = capi.get_ds_name(self._ptr)\n+        return force_text(name, self.encoding, strings_only=True)"
        },
        {
            "sha": "a11a6873c5f97dfba2f7adcb81221c505721d9a4",
            "filename": "django/contrib/gis/gdal/feature.py",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ffeature.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -7,7 +7,7 @@\n # ctypes function prototypes\n from django.contrib.gis.gdal.prototypes import ds as capi, geom as geom_api\n \n-from django.utils.encoding import force_bytes\n+from django.utils.encoding import force_bytes, force_text\n from django.utils import six\n from django.utils.six.moves import xrange\n \n@@ -68,6 +68,10 @@ def __eq__(self, other):\n         return bool(capi.feature_equal(self.ptr, other._ptr))\n \n     #### Feature Properties ####\n+    @property\n+    def encoding(self):\n+        return self._layer._ds.encoding\n+\n     @property\n     def fid(self):\n         \"Returns the feature identifier.\"\n@@ -76,7 +80,8 @@ def fid(self):\n     @property\n     def layer_name(self):\n         \"Returns the name of the layer for the feature.\"\n-        return capi.get_feat_name(self._layer._ldefn)\n+        name = capi.get_feat_name(self._layer._ldefn)\n+        return force_text(name, self.encoding, strings_only=True)\n \n     @property\n     def num_fields(self):"
        },
        {
            "sha": "2415f32b26b911aa9673dd38bd707d9e71efbf68",
            "filename": "django/contrib/gis/gdal/field.py",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ffield.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -3,6 +3,8 @@\n from django.contrib.gis.gdal.base import GDALBase\n from django.contrib.gis.gdal.error import OGRException\n from django.contrib.gis.gdal.prototypes import ds as capi\n+from django.utils.encoding import force_text\n+\n \n # For more information, see the OGR C API source code:\n #  http://www.gdal.org/ogr/ogr__api_8h.html\n@@ -53,7 +55,8 @@ def as_int(self):\n \n     def as_string(self):\n         \"Retrieves the Field's value as a string.\"\n-        return capi.get_field_as_string(self._feat.ptr, self._index)\n+        string = capi.get_field_as_string(self._feat.ptr, self._index)\n+        return force_text(string, encoding=self._feat.encoding, strings_only=True)\n \n     def as_datetime(self):\n         \"Retrieves the Field's value as a tuple of date & time components.\"\n@@ -70,7 +73,8 @@ def as_datetime(self):\n     @property\n     def name(self):\n         \"Returns the name of this Field.\"\n-        return capi.get_field_name(self.ptr)\n+        name = capi.get_field_name(self.ptr)\n+        return force_text(name, encoding=self._feat.encoding, strings_only=True)\n \n     @property\n     def precision(self):"
        },
        {
            "sha": "7f935cd114455ba500d2c8cbfbb7c7b941a709d9",
            "filename": "django/contrib/gis/gdal/layer.py",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Flayer.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -14,7 +14,7 @@\n # GDAL ctypes function prototypes.\n from django.contrib.gis.gdal.prototypes import ds as capi, geom as geom_api, srs as srs_api\n \n-from django.utils.encoding import force_bytes\n+from django.utils.encoding import force_bytes, force_text\n from django.utils import six\n from django.utils.six.moves import xrange\n \n@@ -103,7 +103,8 @@ def extent(self):\n     @property\n     def name(self):\n         \"Returns the name of this layer in the Data Source.\"\n-        return capi.get_fd_name(self._ldefn)\n+        name = capi.get_fd_name(self._ldefn)\n+        return force_text(name, self._ds.encoding, strings_only=True)\n \n     @property\n     def num_feat(self, force=1):\n@@ -135,8 +136,9 @@ def fields(self):\n         Returns a list of string names corresponding to each of the Fields\n         available in this Layer.\n         \"\"\"\n-        return [capi.get_field_name(capi.get_field_defn(self._ldefn, i))\n-                for i in xrange(self.num_fields) ]\n+        return [force_text(capi.get_field_name(capi.get_field_defn(self._ldefn, i)),\n+                           self._ds.encoding, strings_only=True)\n+                for i in xrange(self.num_fields)]\n \n     @property\n     def field_types(self):"
        },
        {
            "sha": "f798069fd02ba12184a3845e5ee974931500972b",
            "filename": "django/contrib/gis/gdal/prototypes/ds.py",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fds.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fds.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -17,7 +17,7 @@\n get_driver = voidptr_output(lgdal.OGRGetDriver, [c_int])\n get_driver_by_name = voidptr_output(lgdal.OGRGetDriverByName, [c_char_p])\n get_driver_count = int_output(lgdal.OGRGetDriverCount, [])\n-get_driver_name = const_string_output(lgdal.OGR_Dr_GetName, [c_void_p])\n+get_driver_name = const_string_output(lgdal.OGR_Dr_GetName, [c_void_p], decoding='ascii')\n \n ### DataSource ###\n open_ds = voidptr_output(lgdal.OGROpen, [c_char_p, c_int, POINTER(c_void_p)])"
        },
        {
            "sha": "2d2791124cb8f1074bf54a4f58c4e22bd0dafd80",
            "filename": "django/contrib/gis/gdal/prototypes/errcheck.py",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Ferrcheck.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Ferrcheck.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Ferrcheck.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -30,10 +30,9 @@ def check_const_string(result, func, cargs, offset=None):\n     if offset:\n         check_err(result)\n         ptr = ptr_byref(cargs, offset)\n-        return ptr.value.decode()\n+        return ptr.value\n     else:\n-        if result is not None:\n-            return result.decode()\n+        return result\n \n def check_string(result, func, cargs, offset=-1, str_result=False):\n     \"\"\"\n@@ -48,13 +47,13 @@ def check_string(result, func, cargs, offset=-1, str_result=False):\n         # For routines that return a string.\n         ptr = result\n         if not ptr: s = None\n-        else: s = string_at(result).decode()\n+        else: s = string_at(result)\n     else:\n         # Error-code return specified.\n         check_err(result)\n         ptr = ptr_byref(cargs, offset)\n         # Getting the string value\n-        s = ptr.value.decode()\n+        s = ptr.value\n     # Correctly freeing the allocated memory beind GDAL pointer\n     # w/the VSIFree routine.\n     if ptr: lgdal.VSIFree(ptr)"
        },
        {
            "sha": "577d29bbaa009a2c225e6635be64172fc76d2e72",
            "filename": "django/contrib/gis/gdal/prototypes/generation.py",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fgeneration.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fgeneration.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fgeneration.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -57,20 +57,23 @@ def srs_output(func, argtypes):\n     func.errcheck = check_srs\n     return func\n \n-def const_string_output(func, argtypes, offset=None):\n+def const_string_output(func, argtypes, offset=None, decoding=None):\n     func.argtypes = argtypes\n     if offset:\n         func.restype = c_int\n     else:\n         func.restype = c_char_p\n \n     def _check_const(result, func, cargs):\n-        return check_const_string(result, func, cargs, offset=offset)\n+        res = check_const_string(result, func, cargs, offset=offset)\n+        if res and decoding:\n+            res = res.decode(decoding)\n+        return res\n     func.errcheck = _check_const\n \n     return func\n \n-def string_output(func, argtypes, offset=-1, str_result=False):\n+def string_output(func, argtypes, offset=-1, str_result=False, decoding=None):\n     \"\"\"\n     Generates a ctypes prototype for the given function with the\n     given argument types that returns a string from a GDAL pointer.\n@@ -90,8 +93,11 @@ def string_output(func, argtypes, offset=-1, str_result=False):\n     # Dynamically defining our error-checking function with the\n     # given offset.\n     def _check_str(result, func, cargs):\n-        return check_string(result, func, cargs,\n+        res = check_string(result, func, cargs,\n                             offset=offset, str_result=str_result)\n+        if res and decoding:\n+            res = res.decode(decoding)\n+        return res\n     func.errcheck = _check_str\n     return func\n "
        },
        {
            "sha": "fa0b503c65509303087a6858ce12cc6ddc13c5c8",
            "filename": "django/contrib/gis/gdal/prototypes/geom.py",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fgeom.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fgeom.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fgeom.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -27,8 +27,8 @@ def topology_func(f):\n \n # GeoJSON routines.\n from_json = geom_output(lgdal.OGR_G_CreateGeometryFromJson, [c_char_p])\n-to_json = string_output(lgdal.OGR_G_ExportToJson, [c_void_p], str_result=True)\n-to_kml = string_output(lgdal.OGR_G_ExportToKML, [c_void_p, c_char_p], str_result=True)\n+to_json = string_output(lgdal.OGR_G_ExportToJson, [c_void_p], str_result=True, decoding='ascii')\n+to_kml = string_output(lgdal.OGR_G_ExportToKML, [c_void_p, c_char_p], str_result=True, decoding='ascii')\n \n # GetX, GetY, GetZ all return doubles.\n getx = pnt_func(lgdal.OGR_G_GetX)\n@@ -57,8 +57,8 @@ def topology_func(f):\n \n # Geometry export routines.\n to_wkb = void_output(lgdal.OGR_G_ExportToWkb, None, errcheck=True) # special handling for WKB.\n-to_wkt = string_output(lgdal.OGR_G_ExportToWkt, [c_void_p, POINTER(c_char_p)])\n-to_gml = string_output(lgdal.OGR_G_ExportToGML, [c_void_p], str_result=True)\n+to_wkt = string_output(lgdal.OGR_G_ExportToWkt, [c_void_p, POINTER(c_char_p)], decoding='ascii')\n+to_gml = string_output(lgdal.OGR_G_ExportToGML, [c_void_p], str_result=True, decoding='ascii')\n get_wkbsize = int_output(lgdal.OGR_G_WkbSize, [c_void_p])\n \n # Geometry spatial-reference related routines.\n@@ -73,7 +73,7 @@ def topology_func(f):\n set_coord_dim = void_output(lgdal.OGR_G_SetCoordinateDimension, [c_void_p, c_int], errcheck=False)\n \n get_geom_count = int_output(lgdal.OGR_G_GetGeometryCount, [c_void_p])\n-get_geom_name = const_string_output(lgdal.OGR_G_GetGeometryName, [c_void_p])\n+get_geom_name = const_string_output(lgdal.OGR_G_GetGeometryName, [c_void_p], decoding='ascii')\n get_geom_type = int_output(lgdal.OGR_G_GetGeometryType, [c_void_p])\n get_point_count = int_output(lgdal.OGR_G_GetPointCount, [c_void_p])\n get_point = void_output(lgdal.OGR_G_GetPoint, [c_void_p, c_int, POINTER(c_double), POINTER(c_double), POINTER(c_double)], errcheck=False)"
        },
        {
            "sha": "58ceb754562b29697ed3c9ef9708fa0269f132a4",
            "filename": "django/contrib/gis/gdal/prototypes/srs.py",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fsrs.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fsrs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fprototypes%2Fsrs.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -49,17 +49,17 @@ def units_func(f):\n angular_units = units_func(lgdal.OSRGetAngularUnits)\n \n # For exporting to WKT, PROJ.4, \"Pretty\" WKT, and XML.\n-to_wkt = string_output(std_call('OSRExportToWkt'), [c_void_p, POINTER(c_char_p)])\n-to_proj = string_output(std_call('OSRExportToProj4'), [c_void_p, POINTER(c_char_p)])\n-to_pretty_wkt = string_output(std_call('OSRExportToPrettyWkt'), [c_void_p, POINTER(c_char_p), c_int], offset=-2)\n+to_wkt = string_output(std_call('OSRExportToWkt'), [c_void_p, POINTER(c_char_p)], decoding='ascii')\n+to_proj = string_output(std_call('OSRExportToProj4'), [c_void_p, POINTER(c_char_p)], decoding='ascii')\n+to_pretty_wkt = string_output(std_call('OSRExportToPrettyWkt'), [c_void_p, POINTER(c_char_p), c_int], offset=-2, decoding='ascii')\n \n # Memory leak fixed in GDAL 1.5; still exists in 1.4.\n-to_xml = string_output(lgdal.OSRExportToXML, [c_void_p, POINTER(c_char_p), c_char_p], offset=-2)\n+to_xml = string_output(lgdal.OSRExportToXML, [c_void_p, POINTER(c_char_p), c_char_p], offset=-2, decoding='ascii')\n \n # String attribute retrival routines.\n-get_attr_value = const_string_output(std_call('OSRGetAttrValue'), [c_void_p, c_char_p, c_int])\n-get_auth_name = const_string_output(lgdal.OSRGetAuthorityName, [c_void_p, c_char_p])\n-get_auth_code = const_string_output(lgdal.OSRGetAuthorityCode, [c_void_p, c_char_p])\n+get_attr_value = const_string_output(std_call('OSRGetAttrValue'), [c_void_p, c_char_p, c_int], decoding='ascii')\n+get_auth_name = const_string_output(lgdal.OSRGetAuthorityName, [c_void_p, c_char_p], decoding='ascii')\n+get_auth_code = const_string_output(lgdal.OSRGetAuthorityCode, [c_void_p, c_char_p], decoding='ascii')\n \n # SRS Properties\n isgeographic = int_output(lgdal.OSRIsGeographic, [c_void_p])"
        },
        {
            "sha": "66a8d4ec932a3fde1a0a739f9bd762e83dcd7b4d",
            "filename": "django/contrib/gis/gdal/srs.py",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fsrs.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Fsrs.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Fsrs.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -34,7 +34,7 @@\n from django.contrib.gis.gdal.prototypes import srs as capi\n \n from django.utils import six\n-from django.utils.encoding import force_bytes, force_text\n+from django.utils.encoding import force_bytes\n \n \n #### Spatial Reference class. ####\n@@ -139,8 +139,7 @@ def attr_value(self, target, index=0):\n         \"\"\"\n         if not isinstance(target, six.string_types) or not isinstance(index, int):\n             raise TypeError\n-        value = capi.get_attr_value(self.ptr, force_bytes(target), index)\n-        return force_text(value, 'ascii', strings_only=True)\n+        return capi.get_attr_value(self.ptr, force_bytes(target), index)\n \n     def auth_name(self, target):\n         \"Returns the authority name for the given string target node.\""
        },
        {
            "sha": "a87a1c6c353b350ccd9e3ad9acc339b998991539",
            "filename": "django/contrib/gis/gdal/tests/test_ds.py",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Fgdal%2Ftests%2Ftest_ds.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -167,7 +167,8 @@ def test04_features(self):\n                         self.assertEqual(True, isinstance(feat[k], v))\n \n                     # Testing Feature.__iter__\n-                    for fld in feat: self.assertEqual(True, fld.name in source.fields.keys())\n+                    for fld in feat:\n+                        self.assertEqual(True, fld.name in source.fields.keys())\n \n     def test05_geometries(self):\n         \"Testing Geometries from Data Source Features.\""
        },
        {
            "sha": "6ba9d698f71d22173e926533d44b0bbcf43b3122",
            "filename": "django/contrib/gis/tests/data/ch-city/ch-city.dbf",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.dbf",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.dbf",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.dbf?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c"
        },
        {
            "sha": "a30c00a55de19be195abf9e942f6cff93bf0a825",
            "filename": "django/contrib/gis/tests/data/ch-city/ch-city.prj",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.prj",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.prj",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.prj?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -0,0 +1 @@\n+GEOGCS[\"GCS_WGS_1984\",DATUM[\"D_WGS_1984\",SPHEROID[\"WGS_1984\",6378137,298.257223563]],PRIMEM[\"Greenwich\",0],UNIT[\"Degree\",0.017453292519943295]]\n\\ No newline at end of file"
        },
        {
            "sha": "e430020de09066c7bff31e952196cf556b5156c7",
            "filename": "django/contrib/gis/tests/data/ch-city/ch-city.shp",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.shp",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.shp",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.shp?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c"
        },
        {
            "sha": "a1487ad82911e9af570d3a04af7163aa8976d89b",
            "filename": "django/contrib/gis/tests/data/ch-city/ch-city.shx",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.shx",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.shx",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Fdata%2Fch-city%2Fch-city.shx?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c"
        },
        {
            "sha": "a976954d25254de72299ad4c096093becdf1cb63",
            "filename": "django/contrib/gis/tests/layermap/tests.py",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Ftests%2Flayermap%2Ftests.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -1,4 +1,5 @@\n-from __future__ import absolute_import\n+# coding: utf-8\n+from __future__ import absolute_import, unicode_literals\n \n import os\n from copy import copy\n@@ -286,6 +287,13 @@ def test_textfield(self):\n         self.assertEqual(City.objects.count(), 3)\n         self.assertEqual(City.objects.all().order_by('name_txt')[0].name_txt, \"Houston\")\n \n+    def test_encoded_name(self):\n+        \"\"\" Test a layer containing utf-8-encoded name \"\"\"\n+        city_shp = os.path.join(shp_path, 'ch-city', 'ch-city.shp')\n+        lm = LayerMapping(City, city_shp, city_mapping)\n+        lm.save(silent=True, strict=True)\n+        self.assertEqual(City.objects.count(), 1)\n+        self.assertEqual(City.objects.all()[0].name, \"ZÃ¼rich\")\n \n class OtherRouter(object):\n     def db_for_read(self, model, **hints):"
        },
        {
            "sha": "8a793b96c3ab8c6553bfe22733a25864230fa650",
            "filename": "django/contrib/gis/utils/layermapping.py",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/django/django/blob/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "raw_url": "https://github.com/django/django/raw/9a2bceed1aab52f65820c378f5ae1f608322b55c/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fgis%2Futils%2Flayermapping.py?ref=9a2bceed1aab52f65820c378f5ae1f608322b55c",
            "patch": "@@ -18,6 +18,8 @@\n from django.db import models, transaction\n from django.contrib.localflavor.us.models import USStateField\n from django.utils import six\n+from django.utils.encoding import force_text\n+\n \n # LayerMapping exceptions.\n class LayerMapError(Exception): pass\n@@ -65,7 +67,7 @@ class LayerMapping(object):\n                          }\n \n     def __init__(self, model, data, mapping, layer=0,\n-                 source_srs=None, encoding=None,\n+                 source_srs=None, encoding='utf-8',\n                  transaction_mode='commit_on_success',\n                  transform=True, unique=None, using=None):\n         \"\"\"\n@@ -76,7 +78,7 @@ def __init__(self, model, data, mapping, layer=0,\n         \"\"\"\n         # Getting the DataSource and the associated Layer.\n         if isinstance(data, six.string_types):\n-            self.ds = DataSource(data)\n+            self.ds = DataSource(data, encoding=encoding)\n         else:\n             self.ds = data\n         self.layer = self.ds[layer]\n@@ -330,7 +332,7 @@ def verify_ogr_field(self, ogr_field, model_field):\n             if self.encoding:\n                 # The encoding for OGR data sources may be specified here\n                 # (e.g., 'cp437' for Census Bureau boundary files).\n-                val = six.text_type(ogr_field.value, self.encoding)\n+                val = force_text(ogr_field.value, self.encoding)\n             else:\n                 val = ogr_field.value\n                 if model_field.max_length and len(val) > model_field.max_length:"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 71,
        "deletions": 41
    }
}