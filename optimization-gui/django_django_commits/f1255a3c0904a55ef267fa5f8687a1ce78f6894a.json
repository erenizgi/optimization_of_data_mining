{
    "author": "aaugustin",
    "message": "Fixed #18144 -- Restored compatibility with SHA1 hashes with empty salt.\n\nThanks dahool for the report and initial version of the patch.",
    "sha": "f1255a3c0904a55ef267fa5f8687a1ce78f6894a",
    "files": [
        {
            "sha": "eaa8a9911ce23e5309aa6c82b1a62c0203a2d027",
            "filename": "django/conf/global_settings.py",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/django/django/blob/f1255a3c0904a55ef267fa5f8687a1ce78f6894a/django%2Fconf%2Fglobal_settings.py",
            "raw_url": "https://github.com/django/django/raw/f1255a3c0904a55ef267fa5f8687a1ce78f6894a/django%2Fconf%2Fglobal_settings.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fconf%2Fglobal_settings.py?ref=f1255a3c0904a55ef267fa5f8687a1ce78f6894a",
            "patch": "@@ -510,6 +510,7 @@\n     'django.contrib.auth.hashers.BCryptPasswordHasher',\n     'django.contrib.auth.hashers.SHA1PasswordHasher',\n     'django.contrib.auth.hashers.MD5PasswordHasher',\n+    'django.contrib.auth.hashers.UnsaltedSHA1PasswordHasher',\n     'django.contrib.auth.hashers.UnsaltedMD5PasswordHasher',\n     'django.contrib.auth.hashers.CryptPasswordHasher',\n )"
        },
        {
            "sha": "480fde69ce0af3c41b92826dabd38f19ced27a75",
            "filename": "django/contrib/auth/hashers.py",
            "status": "modified",
            "additions": 46,
            "deletions": 6,
            "changes": 52,
            "blob_url": "https://github.com/django/django/blob/f1255a3c0904a55ef267fa5f8687a1ce78f6894a/django%2Fcontrib%2Fauth%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/f1255a3c0904a55ef267fa5f8687a1ce78f6894a/django%2Fcontrib%2Fauth%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Fhashers.py?ref=f1255a3c0904a55ef267fa5f8687a1ce78f6894a",
            "patch": "@@ -127,9 +127,14 @@ def identify_hasher(encoded):\n     get_hasher() to return hasher. Raises ValueError if\n     algorithm cannot be identified, or if hasher is not loaded.\n     \"\"\"\n+    # Ancient versions of Django created plain MD5 passwords and accepted\n+    # MD5 passwords with an empty salt.\n     if ((len(encoded) == 32 and '$' not in encoded) or\n             (len(encoded) == 37 and encoded.startswith('md5$$'))):\n         algorithm = 'unsalted_md5'\n+    # Ancient versions of Django accepted SHA1 passwords with an empty salt.\n+    elif len(encoded) == 46 and encoded.startswith('sha1$$'):\n+        algorithm = 'unsalted_sha1'\n     else:\n         algorithm = encoded.split('$', 1)[0]\n     return get_hasher(algorithm)\n@@ -350,21 +355,56 @@ def safe_summary(self, encoded):\n         ])\n \n \n-class UnsaltedMD5PasswordHasher(BasePasswordHasher):\n+class UnsaltedSHA1PasswordHasher(BasePasswordHasher):\n+    \"\"\"\n+    Very insecure algorithm that you should *never* use; stores SHA1 hashes\n+    with an empty salt.\n+\n+    This class is implemented because Django used to accept such password\n+    hashes. Some older Django installs still have these values lingering\n+    around so we need to handle and upgrade them properly.\n     \"\"\"\n-    I am an incredibly insecure algorithm you should *never* use;\n-    stores unsalted MD5 hashes without the algorithm prefix.\n+    algorithm = \"unsalted_sha1\"\n+\n+    def salt(self):\n+        return ''\n \n-    This class is implemented because Django used to store passwords\n-    this way. Some older Django installs still have these values\n-    lingering around so we need to handle and upgrade them properly.\n+    def encode(self, password, salt):\n+        assert salt == ''\n+        hash = hashlib.sha1(force_bytes(password)).hexdigest()\n+        return 'sha1$$%s' % hash\n+\n+    def verify(self, password, encoded):\n+        encoded_2 = self.encode(password, '')\n+        return constant_time_compare(encoded, encoded_2)\n+\n+    def safe_summary(self, encoded):\n+        assert encoded.startswith('sha1$$')\n+        hash = encoded[6:]\n+        return SortedDict([\n+            (_('algorithm'), self.algorithm),\n+            (_('hash'), mask_hash(hash)),\n+        ])\n+\n+\n+class UnsaltedMD5PasswordHasher(BasePasswordHasher):\n+    \"\"\"\n+    Incredibly insecure algorithm that you should *never* use; stores unsalted\n+    MD5 hashes without the algorithm prefix, also accepts MD5 hashes with an\n+    empty salt.\n+\n+    This class is implemented because Django used to store passwords this way\n+    and to accept such password hashes. Some older Django installs still have\n+    these values lingering around so we need to handle and upgrade them\n+    properly.\n     \"\"\"\n     algorithm = \"unsalted_md5\"\n \n     def salt(self):\n         return ''\n \n     def encode(self, password, salt):\n+        assert salt == ''\n         return hashlib.md5(force_bytes(password)).hexdigest()\n \n     def verify(self, password, encoded):"
        },
        {
            "sha": "2b2243cb0ce38dd8e9256af2a38f04b41ddd69fa",
            "filename": "django/contrib/auth/tests/hashers.py",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/django/django/blob/f1255a3c0904a55ef267fa5f8687a1ce78f6894a/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "raw_url": "https://github.com/django/django/raw/f1255a3c0904a55ef267fa5f8687a1ce78f6894a/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py",
            "contents_url": "https://api.github.com/repos/django/django/contents/django%2Fcontrib%2Fauth%2Ftests%2Fhashers.py?ref=f1255a3c0904a55ef267fa5f8687a1ce78f6894a",
            "patch": "@@ -2,7 +2,7 @@\n from __future__ import unicode_literals\n \n from django.conf.global_settings import PASSWORD_HASHERS as default_hashers\n-from django.contrib.auth.hashers import (is_password_usable, \n+from django.contrib.auth.hashers import (is_password_usable,\n     check_password, make_password, PBKDF2PasswordHasher, load_hashers,\n     PBKDF2SHA1PasswordHasher, get_hasher, identify_hasher, UNUSABLE_PASSWORD)\n from django.utils import unittest\n@@ -52,15 +52,15 @@ def test_sha1(self):\n \n     def test_md5(self):\n         encoded = make_password('lètmein', 'seasalt', 'md5')\n-        self.assertEqual(encoded, \n+        self.assertEqual(encoded,\n                          'md5$seasalt$3f86d0d3d465b7b458c231bf3555c0e3')\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password('lètmein', encoded))\n         self.assertFalse(check_password('lètmeinz', encoded))\n         self.assertEqual(identify_hasher(encoded).algorithm, \"md5\")\n \n     def test_unsalted_md5(self):\n-        encoded = make_password('lètmein', 'seasalt', 'unsalted_md5')\n+        encoded = make_password('lètmein', '', 'unsalted_md5')\n         self.assertEqual(encoded, '88a434c88cca4e900f7874cd98123f43')\n         self.assertTrue(is_password_usable(encoded))\n         self.assertTrue(check_password('lètmein', encoded))\n@@ -72,6 +72,17 @@ def test_unsalted_md5(self):\n         self.assertTrue(check_password('lètmein', alt_encoded))\n         self.assertFalse(check_password('lètmeinz', alt_encoded))\n \n+    def test_unsalted_sha1(self):\n+        encoded = make_password('lètmein', '', 'unsalted_sha1')\n+        self.assertEqual(encoded, 'sha1$$6d138ca3ae545631b3abd71a4f076ce759c5700b')\n+        self.assertTrue(is_password_usable(encoded))\n+        self.assertTrue(check_password('lètmein', encoded))\n+        self.assertFalse(check_password('lètmeinz', encoded))\n+        self.assertEqual(identify_hasher(encoded).algorithm, \"unsalted_sha1\")\n+        # Raw SHA1 isn't acceptable\n+        alt_encoded = encoded[6:]\n+        self.assertFalse(check_password('lètmein', alt_encoded))\n+\n     @skipUnless(crypt, \"no crypt module to generate password.\")\n     def test_crypt(self):\n         encoded = make_password('lètmei', 'ab', 'crypt')"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 61,
        "deletions": 9
    }
}