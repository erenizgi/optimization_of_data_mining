{
    "author": "josephperrott",
    "message": "feat(dev-infra): save invalid commit message attempts to be restored on next commit attempt (#38304)\n\nWhen a commit message fails validation, rather than throwing out the commit message entirely\nthe commit message is saved into a draft file and restored on the next commit attempt.\n\nPR Close #38304",
    "sha": "f4ced74e3a617267051ce423e58101457bc1e99a",
    "files": [
        {
            "sha": "c8e7898a4b3b773b64926658f792144196bfb2dd",
            "filename": "dev-infra/commit-message/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2FBUILD.bazel?ref=f4ced74e3a617267051ce423e58101457bc1e99a",
            "patch": "@@ -5,8 +5,10 @@ ts_library(\n     name = \"commit-message\",\n     srcs = [\n         \"cli.ts\",\n+        \"commit-message-draft.ts\",\n         \"config.ts\",\n         \"parse.ts\",\n+        \"restore-commit-message.ts\",\n         \"validate.ts\",\n         \"validate-file.ts\",\n         \"validate-range.ts\","
        },
        {
            "sha": "ebdde827e4cbf0cc551e84931a33df5e64bd45b7",
            "filename": "dev-infra/commit-message/cli.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fcli.ts?ref=f4ced74e3a617267051ce423e58101457bc1e99a",
            "patch": "@@ -9,13 +9,36 @@ import * as yargs from 'yargs';\n \n import {info} from '../utils/console';\n \n+import {restoreCommitMessage} from './restore-commit-message';\n import {validateFile} from './validate-file';\n import {validateCommitRange} from './validate-range';\n \n /** Build the parser for the commit-message commands. */\n export function buildCommitMessageParser(localYargs: yargs.Argv) {\n   return localYargs.help()\n       .strict()\n+      .command(\n+          'restore-commit-message-draft', false, {\n+            'file-env-variable': {\n+              type: 'string',\n+              conflicts: ['file'],\n+              required: true,\n+              description:\n+                  'The key for the environment variable which holds the arguments for the ' +\n+                  'prepare-commit-msg hook as described here: ' +\n+                  'https://git-scm.com/docs/githooks#_prepare_commit_msg',\n+              coerce: arg => {\n+                const [file, source] = (process.env[arg] || '').split(' ');\n+                if (!file) {\n+                  throw new Error(`Provided environment variable \"${arg}\" was not found.`);\n+                }\n+                return [file, source];\n+              },\n+            }\n+          },\n+          args => {\n+            restoreCommitMessage(args.fileEnvVariable[0], args.fileEnvVariable[1]);\n+          })\n       .command(\n           'pre-commit-validate', 'Validate the most recent commit message', {\n             'file': {"
        },
        {
            "sha": "86a5655fd09b092a372351aa696224f0857ea05f",
            "filename": "dev-infra/commit-message/commit-message-draft.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Fcommit-message-draft.ts",
            "raw_url": "https://github.com/angular/angular/raw/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Fcommit-message-draft.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fcommit-message-draft.ts?ref=f4ced74e3a617267051ce423e58101457bc1e99a",
            "patch": "@@ -0,0 +1,30 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {existsSync, readFileSync, unlinkSync, writeFileSync} from 'fs';\n+\n+/** Load the commit message draft from the file system if it exists. */\n+export function loadCommitMessageDraft(basePath: string) {\n+  const commitMessageDraftPath = `${basePath}.ngDevSave`;\n+  if (existsSync(commitMessageDraftPath)) {\n+    return readFileSync(commitMessageDraftPath).toString();\n+  }\n+  return '';\n+}\n+\n+/** Remove the commit message draft from the file system. */\n+export function deleteCommitMessageDraft(basePath: string) {\n+  const commitMessageDraftPath = `${basePath}.ngDevSave`;\n+  if (existsSync(commitMessageDraftPath)) {\n+    unlinkSync(commitMessageDraftPath);\n+  }\n+}\n+\n+/** Save the commit message draft to the file system for later retrieval. */\n+export function saveCommitMessageDraft(basePath: string, commitMessage: string) {\n+  writeFileSync(`${basePath}.ngDevSave`, commitMessage);\n+}"
        },
        {
            "sha": "bcbf302b983ca9d79fb5747d6fa0f673c1bdce8a",
            "filename": "dev-infra/commit-message/restore-commit-message.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Frestore-commit-message.ts",
            "raw_url": "https://github.com/angular/angular/raw/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Frestore-commit-message.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Frestore-commit-message.ts?ref=f4ced74e3a617267051ce423e58101457bc1e99a",
            "patch": "@@ -0,0 +1,48 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {info} from 'console';\n+import {writeFileSync} from 'fs';\n+\n+import {loadCommitMessageDraft} from './commit-message-draft';\n+\n+/**\n+ * Restore the commit message draft to the git to be used as the default commit message.\n+ *\n+ * The source provided may be one of the sources described in\n+ *   https://git-scm.com/docs/githooks#_prepare_commit_msg\n+ */\n+export function restoreCommitMessage(\n+    filePath: string, source?: 'message'|'template'|'squash'|'commit') {\n+  if (!!source) {\n+    info('Skipping commit message restoration attempt');\n+    if (source === 'message') {\n+      info('A commit message was already provided via the command with a -m or -F flag');\n+    }\n+    if (source === 'template') {\n+      info('A commit message was already provided via the -t flag or config.template setting');\n+    }\n+    if (source === 'squash') {\n+      info('A commit message was already provided as a merge action or via .git/MERGE_MSG');\n+    }\n+    if (source === 'commit') {\n+      info('A commit message was already provided through a revision specified via --fixup, -c,');\n+      info('-C or --amend flag');\n+    }\n+    process.exit(0);\n+  }\n+  /** A draft of a commit message. */\n+  const commitMessage = loadCommitMessageDraft(filePath);\n+\n+  // If the commit message draft has content, restore it into the provided filepath.\n+  if (commitMessage) {\n+    writeFileSync(filePath, commitMessage);\n+  }\n+  // Exit the process\n+  process.exit(0);\n+}"
        },
        {
            "sha": "50b8b72afc402d55528430847e4c0327916523fb",
            "filename": "dev-infra/commit-message/validate-file.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Fvalidate-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/f4ced74e3a617267051ce423e58101457bc1e99a/dev-infra%2Fcommit-message%2Fvalidate-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-file.ts?ref=f4ced74e3a617267051ce423e58101457bc1e99a",
            "patch": "@@ -11,15 +11,20 @@ import {resolve} from 'path';\n import {getRepoBaseDir} from '../utils/config';\n import {info} from '../utils/console';\n \n+import {deleteCommitMessageDraft, saveCommitMessageDraft} from './commit-message-draft';\n import {validateCommitMessage} from './validate';\n \n /** Validate commit message at the provided file path. */\n export function validateFile(filePath: string) {\n   const commitMessage = readFileSync(resolve(getRepoBaseDir(), filePath), 'utf8');\n   if (validateCommitMessage(commitMessage)) {\n     info('âˆš  Valid commit message');\n+    deleteCommitMessageDraft(filePath);\n     return;\n   }\n+  // On all invalid commit messages, the commit message should be saved as a draft to be\n+  // restored on the next commit attempt.\n+  saveCommitMessageDraft(filePath, commitMessage);\n   // If the validation did not return true, exit as a failure.\n   process.exit(1);\n }"
        },
        {
            "sha": "f57e005bbef4d8bbc226db9a8905944ba84e3001",
            "filename": "package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/f4ced74e3a617267051ce423e58101457bc1e99a/package.json",
            "raw_url": "https://github.com/angular/angular/raw/f4ced74e3a617267051ce423e58101457bc1e99a/package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/package.json?ref=f4ced74e3a617267051ce423e58101457bc1e99a",
            "patch": "@@ -210,7 +210,8 @@\n   \"husky\": {\n     \"hooks\": {\n       \"pre-commit\": \"yarn -s ng-dev format staged\",\n-      \"commit-msg\": \"yarn -s ng-dev commit-message pre-commit-validate --file-env-variable HUSKY_GIT_PARAMS\"\n+      \"commit-msg\": \"yarn -s ng-dev commit-message pre-commit-validate --file-env-variable HUSKY_GIT_PARAMS\",\n+      \"prepare-commit-msg\": \"yarn -s ng-dev commit-message restore-commit-message-draft --file-env-variable HUSKY_GIT_PARAMS\"\n     }\n   }\n }"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 110,
        "deletions": 1
    }
}