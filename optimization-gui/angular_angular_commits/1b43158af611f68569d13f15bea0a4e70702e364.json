{
    "author": "clydin",
    "message": "fix(compiler-cli): do not error with prepocessing if component has no inline styles (#41602)\n\nThe asynchronous preprocessing check was not accounting for components that did not have any inline styles. In that case, the cache did not have an entry which then allowed the asynchronous check to run and fail the compilation. The caching during the asynchronous analysis phase now handles components without inline styles.\n\nPR Close #41602",
    "sha": "1b43158af611f68569d13f15bea0a4e70702e364",
    "files": [
        {
            "sha": "553e4ca2737a835bbe31322c304855b6cd129e0c",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1b43158af611f68569d13f15bea0a4e70702e364/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/1b43158af611f68569d13f15bea0a4e70702e364/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=1b43158af611f68569d13f15bea0a4e70702e364",
            "patch": "@@ -302,6 +302,8 @@ export class ComponentDecoratorHandler implements\n                              this.preanalyzeStylesCache.set(node, styles);\n                            });\n       }\n+    } else {\n+      this.preanalyzeStylesCache.set(node, null);\n     }\n \n     // Wait for both the template and all styleUrl resources to resolve."
        },
        {
            "sha": "d94519770e4c31da6a5481952ac360927545302a",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/1b43158af611f68569d13f15bea0a4e70702e364/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1b43158af611f68569d13f15bea0a4e70702e364/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=1b43158af611f68569d13f15bea0a4e70702e364",
            "patch": "@@ -302,6 +302,74 @@ runInEachFileSystem(() => {\n       const {analysis} = handler.analyze(TestCmp, detected.metadata);\n       expect(analysis?.inlineStyles).toEqual(jasmine.arrayWithExactContents(['.xyz {}']));\n     });\n+\n+    it('should error if canPreprocess is true and async analyze is not used', async () => {\n+      const {program, options, host} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Component: any;',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: `\n+          import {Component} from '@angular/core';\n+\n+          @Component({\n+            template: '',\n+            styles: ['.abc {}']\n+          }) class TestCmp {}\n+      `\n+        },\n+      ]);\n+      const {reflectionHost, handler, resourceLoader} = setup(program, options, host);\n+      resourceLoader.canPreload = true;\n+      resourceLoader.canPreprocess = true;\n+\n+      const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n+      const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n+      if (detected === undefined) {\n+        return fail('Failed to recognize @Component');\n+      }\n+\n+      expect(() => handler.analyze(TestCmp, detected.metadata))\n+          .toThrowError('Inline resource processing requires asynchronous preanalyze.');\n+    });\n+\n+    it('should not error if component has no inline styles and canPreprocess is true', async () => {\n+      const {program, options, host} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Component: any;',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: `\n+          import {Component} from '@angular/core';\n+\n+          @Component({\n+            template: '',\n+          }) class TestCmp {}\n+      `\n+        },\n+      ]);\n+      const {reflectionHost, handler, resourceLoader} = setup(program, options, host);\n+      resourceLoader.canPreload = true;\n+      resourceLoader.canPreprocess = true;\n+      resourceLoader.preprocessInline = async function(data, context) {\n+        fail('preprocessInline should not have been called.');\n+        return data;\n+      };\n+\n+      const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n+      const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n+      if (detected === undefined) {\n+        return fail('Failed to recognize @Component');\n+      }\n+\n+      await handler.preanalyze(TestCmp, detected.metadata);\n+\n+      expect(() => handler.analyze(TestCmp, detected.metadata)).not.toThrow();\n+    });\n   });\n \n   function ivyCode(code: ErrorCode): number {"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 70,
        "deletions": 0
    }
}