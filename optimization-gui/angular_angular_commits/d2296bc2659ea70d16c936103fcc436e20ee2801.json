{
    "author": "alan-agius4",
    "message": "test: refactor test to work with latest @types/jasmine (#41956)\n\nIn some cases we are using private APIs. This change adds casting were needed to make the build successful.\n\nPR Close #41956",
    "sha": "d2296bc2659ea70d16c936103fcc436e20ee2801",
    "files": [
        {
            "sha": "5639ec7393f2756f99333ea61aaa553900530643",
            "filename": "packages/platform-browser-dynamic/test/testing_public_browser_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 44,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/d2296bc2659ea70d16c936103fcc436e20ee2801/packages%2Fplatform-browser-dynamic%2Ftest%2Ftesting_public_browser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2296bc2659ea70d16c936103fcc436e20ee2801/packages%2Fplatform-browser-dynamic%2Ftest%2Ftesting_public_browser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser-dynamic%2Ftest%2Ftesting_public_browser_spec.ts?ref=d2296bc2659ea70d16c936103fcc436e20ee2801",
            "patch": "@@ -11,8 +11,6 @@ import {Compiler, Component, NgModule} from '@angular/core';\n import {fakeAsync, inject, TestBed, tick, waitForAsync} from '@angular/core/testing';\n import {ResourceLoaderImpl} from '@angular/platform-browser-dynamic/src/resource_loader/resource_loader_impl';\n \n-\n-\n // Components for the tests.\n class FancyService {\n   value: string = 'real value';\n@@ -106,48 +104,13 @@ if (isBrowser) {\n     });\n \n     describe('errors', () => {\n-      let originalJasmineIt: any;\n-\n-      const patchJasmineIt = () => {\n-        let resolve: (result: any) => void;\n-        let reject: (error: any) => void;\n-        const promise = new Promise((res, rej) => {\n-          resolve = res;\n-          reject = rej;\n-        });\n-        originalJasmineIt = jasmine.getEnv().it;\n-        jasmine.getEnv().it = (description: string, fn: (done: DoneFn) => void): any => {\n-          const done = (() => resolve(null)) as DoneFn;\n-          done.fail = reject;\n-          fn(done);\n-          return null;\n-        };\n-        return promise;\n-      };\n-\n-      const restoreJasmineIt = () => {\n-        jasmine.getEnv().it = originalJasmineIt;\n-      };\n-\n-      it('should fail when an ResourceLoader fails', done => {\n-        const itPromise = patchJasmineIt();\n-\n-        it('should fail with an error from a promise', waitForAsync(() => {\n-             TestBed.configureTestingModule({declarations: [BadTemplateUrl]});\n-             TestBed.compileComponents();\n-           }));\n-\n-        itPromise.then(\n-            () => {\n-              done.fail('Expected test to fail, but it did not');\n-            },\n-            (err: any) => {\n-              expect(err.message)\n-                  .toEqual('Uncaught (in promise): Failed to load non-existent.html');\n-              done();\n-            });\n-        restoreJasmineIt();\n-      }, 10000);\n+      describe('should fail when an ResourceLoader fails', () => {\n+        it('should fail with an error from a promise', async () => {\n+          TestBed.configureTestingModule({declarations: [BadTemplateUrl]});\n+          await expectAsync(TestBed.compileComponents())\n+              .toBeRejectedWith('Failed to load non-existent.html');\n+        }, 10000);\n+      });\n     });\n \n     describe('TestBed createComponent', function() {"
        },
        {
            "sha": "f1e5c8430ff7681697567eb812a418c88c96f660",
            "filename": "packages/platform-browser/test/testing_public_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 44,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/d2296bc2659ea70d16c936103fcc436e20ee2801/packages%2Fplatform-browser%2Ftest%2Ftesting_public_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d2296bc2659ea70d16c936103fcc436e20ee2801/packages%2Fplatform-browser%2Ftest%2Ftesting_public_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Ftest%2Ftesting_public_spec.ts?ref=d2296bc2659ea70d16c936103fcc436e20ee2801",
            "patch": "@@ -836,7 +836,6 @@ const bTok = new InjectionToken<string>('b');\n \n     describe('errors', () => {\n       let originalJasmineIt: (description: string, func: () => void) => jasmine.Spec;\n-      let originalJasmineBeforeEach: (beforeEachFunction: (done: DoneFn) => void) => void;\n \n       const patchJasmineIt = () => {\n         let resolve: (result: any) => void;\n@@ -845,8 +844,9 @@ const bTok = new InjectionToken<string>('b');\n           resolve = res;\n           reject = rej;\n         });\n-        originalJasmineIt = jasmine.getEnv().it;\n-        jasmine.getEnv().it = (description: string, fn: (done: DoneFn) => void): any => {\n+        const jasmineEnv = jasmine.getEnv() as any;\n+        originalJasmineIt = jasmineEnv.it;\n+        jasmineEnv.it = (description: string, fn: (done: DoneFn) => void): any => {\n           const done = <DoneFn>(() => resolve(null));\n           done.fail = (err) => reject(err);\n           fn(done);\n@@ -855,26 +855,7 @@ const bTok = new InjectionToken<string>('b');\n         return promise;\n       };\n \n-      const restoreJasmineIt = () => jasmine.getEnv().it = originalJasmineIt;\n-\n-      const patchJasmineBeforeEach = () => {\n-        let resolve: (result: any) => void;\n-        let reject: (error: any) => void;\n-        const promise = new Promise((res, rej) => {\n-          resolve = res;\n-          reject = rej;\n-        });\n-        originalJasmineBeforeEach = jasmine.getEnv().beforeEach;\n-        jasmine.getEnv().beforeEach = (fn: (done: DoneFn) => void) => {\n-          const done = <DoneFn>(() => resolve(null));\n-          done.fail = (err) => reject(err);\n-          fn(done);\n-        };\n-        return promise;\n-      };\n-\n-      const restoreJasmineBeforeEach = () => jasmine.getEnv().beforeEach =\n-          originalJasmineBeforeEach;\n+      const restoreJasmineIt = () => ((jasmine.getEnv() as any).it = originalJasmineIt);\n \n       it('should fail when an asynchronous error is thrown', (done) => {\n         const itPromise = patchJasmineIt();\n@@ -921,21 +902,16 @@ const bTok = new InjectionToken<string>('b');\n \n         it('should report an error for declared components with templateUrl which never call TestBed.compileComponents',\n            () => {\n-             const itPromise = patchJasmineIt();\n-\n              @Component({\n                selector: 'comp',\n-               templateUrl: '/base/angular/packages/platform-browser/test/static_assets/test.html'\n+               templateUrl: '/base/angular/packages/platform-browser/test/static_assets/test.html',\n              })\n              class InlineCompWithUrlTemplate {\n              }\n \n-             expect(\n-                 () =>\n-                     it('should fail',\n-                        withModule(\n-                            {declarations: [InlineCompWithUrlTemplate]},\n-                            () => TestBed.createComponent(InlineCompWithUrlTemplate))))\n+             expect(withModule(\n+                        {declarations: [InlineCompWithUrlTemplate]},\n+                        () => TestBed.createComponent(InlineCompWithUrlTemplate)))\n                  .toThrowError(\n                      ivyEnabled ?\n                          `Component 'InlineCompWithUrlTemplate' is not resolved:\n@@ -945,29 +921,20 @@ Did you run and wait for 'resolveComponentResources()'?` :\n                              stringify(\n                                  InlineCompWithUrlTemplate)} which is using a \"templateUrl\" or \"styleUrls\", but they were never compiled. ` +\n                              `Please call \"TestBed.compileComponents\" before your test.`);\n-\n-             restoreJasmineIt();\n            });\n       });\n \n-\n       modifiedInIvy(`Unknown property error thrown instead of logging a message`)\n           .it('should error on unknown bound properties on custom elements by default', () => {\n             @Component({template: '<some-element [someUnknownProp]=\"true\"></some-element>'})\n             class ComponentUsingInvalidProperty {\n             }\n \n-            const itPromise = patchJasmineIt();\n-\n             expect(\n-                () =>\n-                    it('should fail',\n-                       withModule(\n-                           {declarations: [ComponentUsingInvalidProperty]},\n-                           () => TestBed.createComponent(ComponentUsingInvalidProperty))))\n+                () => withModule(\n+                    {declarations: [ComponentUsingInvalidProperty]},\n+                    () => TestBed.createComponent(ComponentUsingInvalidProperty))())\n                 .toThrowError(/Can't bind to 'someUnknownProp'/);\n-\n-            restoreJasmineIt();\n           });\n \n       onlyInIvy(`Unknown property error logged instead of throwing`)"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 18,
        "deletions": 88
    }
}