{
    "author": "aleesaan",
    "message": "refactor(common): use getElementById in ViewportScroller.scrollToAnchor (#30143)\n\nThis commit uses getElementById and getElementsByName when an anchor scroll happens,\nto avoid escaping the anchor and wrapping the code in a try/catch block.\n\nRelated to #28960\n\nPR Close #30143",
    "sha": "354e66efad728b39026fe1664903b55b65fc6786",
    "files": [
        {
            "sha": "9a036944cf2a8a0bcce0cc88c83dee1d6b6829b9",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/354e66efad728b39026fe1664903b55b65fc6786/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/354e66efad728b39026fe1664903b55b65fc6786/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=354e66efad728b39026fe1664903b55b65fc6786",
            "patch": "@@ -49,9 +49,9 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 2289,\n-        \"main-es2015\": 221897,\n-        \"polyfills-es2015\": 36938,\n-        \"5-es2015\": 779\n+        \"main-es2015\": 221939,\n+        \"polyfills-es2015\": 36723,\n+        \"5-es2015\": 781\n       }\n     }\n   },\n@@ -66,4 +66,4 @@\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "355b90ecc79d63971f8fe3c8ed4df877b68e9b85",
            "filename": "packages/common/src/viewport_scroller.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 20,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/354e66efad728b39026fe1664903b55b65fc6786/packages%2Fcommon%2Fsrc%2Fviewport_scroller.ts",
            "raw_url": "https://github.com/angular/angular/raw/354e66efad728b39026fe1664903b55b65fc6786/packages%2Fcommon%2Fsrc%2Fviewport_scroller.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Fviewport_scroller.ts?ref=354e66efad728b39026fe1664903b55b65fc6786",
            "patch": "@@ -111,26 +111,10 @@ export class BrowserViewportScroller implements ViewportScroller {\n    */\n   scrollToAnchor(anchor: string): void {\n     if (this.supportScrollRestoration()) {\n-      // Escape anything passed to `querySelector` as it can throw errors and stop the application\n-      // from working if invalid values are passed.\n-      if (this.window.CSS && this.window.CSS.escape) {\n-        anchor = this.window.CSS.escape(anchor);\n-      } else {\n-        anchor = anchor.replace(/(\\\"|\\'\\ |:|\\.|\\[|\\]|,|=)/g, '\\\\$1');\n-      }\n-      try {\n-        const elSelectedById = this.document.querySelector(`#${anchor}`);\n-        if (elSelectedById) {\n-          this.scrollToElement(elSelectedById);\n-          return;\n-        }\n-        const elSelectedByName = this.document.querySelector(`[name='${anchor}']`);\n-        if (elSelectedByName) {\n-          this.scrollToElement(elSelectedByName);\n-          return;\n-        }\n-      } catch (e) {\n-        this.errorHandler.handleError(e);\n+      const elSelected =\n+          this.document.getElementById(anchor) || this.document.getElementsByName(anchor)[0];\n+      if (elSelected) {\n+        this.scrollToElement(elSelected);\n       }\n     }\n   }"
        },
        {
            "sha": "510a24bad5b7f8078f14907d3c5453e39e72e007",
            "filename": "packages/common/test/viewport_scroller_spec.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 32,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/354e66efad728b39026fe1664903b55b65fc6786/packages%2Fcommon%2Ftest%2Fviewport_scroller_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/354e66efad728b39026fe1664903b55b65fc6786/packages%2Fcommon%2Ftest%2Fviewport_scroller_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftest%2Fviewport_scroller_spec.ts?ref=354e66efad728b39026fe1664903b55b65fc6786",
            "patch": "@@ -6,50 +6,61 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-\n-\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n import {describe, expect, it} from '@angular/core/testing/src/testing_internal';\n import {BrowserViewportScroller, ViewportScroller} from '../src/viewport_scroller';\n \n-{\n-  describe('BrowserViewportScroller', () => {\n-    let scroller: ViewportScroller;\n-    let documentSpy: any;\n-    let windowSpy: any;\n+describe('BrowserViewportScroller', () => {\n+  let scroller: ViewportScroller;\n+  let documentSpy: any;\n+  let windowSpy: any;\n \n-    beforeEach(() => {\n-      windowSpy = jasmine.createSpyObj('window', ['history']);\n-      windowSpy.scrollTo = 1;\n-      windowSpy.history.scrollRestoration = 'auto';\n-\n-      documentSpy = jasmine.createSpyObj('document', ['querySelector']);\n-      scroller = new BrowserViewportScroller(documentSpy, windowSpy, null!);\n-    });\n+  beforeEach(() => {\n+    windowSpy = jasmine.createSpyObj('window', ['history']);\n+    windowSpy.scrollTo = 1;\n+    windowSpy.history.scrollRestoration = 'auto';\n+    documentSpy = jasmine.createSpyObj('document', ['getElementById', 'getElementsByName']);\n+    scroller = new BrowserViewportScroller(documentSpy, windowSpy, null!);\n+  });\n \n+  describe('setHistoryScrollRestoration', () => {\n     it('should not crash when scrollRestoration is not writable', () => {\n       Object.defineProperty(windowSpy.history, 'scrollRestoration', {\n         value: 'auto',\n         configurable: true,\n       });\n       expect(() => scroller.setHistoryScrollRestoration('manual')).not.toThrow();\n     });\n+  });\n+\n+  describe('scrollToAnchor', () => {\n+    const anchor = 'anchor';\n+    const el = document.createElement('a');\n+\n+    it('should only call getElementById when an element is found by id', () => {\n+      documentSpy.getElementById.and.returnValue(el);\n+      spyOn<any>(scroller, 'scrollToElement');\n+      scroller.scrollToAnchor(anchor);\n+      expect(documentSpy.getElementById).toHaveBeenCalledWith(anchor);\n+      expect(documentSpy.getElementsByName).not.toHaveBeenCalled();\n+      expect((scroller as any).scrollToElement).toHaveBeenCalledWith(el);\n+    });\n+\n+    it('should call getElementById and getElementsByName when an element is found by name', () => {\n+      documentSpy.getElementsByName.and.returnValue([el]);\n+      spyOn<any>(scroller, 'scrollToElement');\n+      scroller.scrollToAnchor(anchor);\n+      expect(documentSpy.getElementById).toHaveBeenCalledWith(anchor);\n+      expect(documentSpy.getElementsByName).toHaveBeenCalledWith(anchor);\n+      expect((scroller as any).scrollToElement).toHaveBeenCalledWith(el);\n+    });\n \n-    it('escapes invalid characters selectors', () => {\n-      const invalidSelectorChars = `\"' :.[],=`;\n-      // Double escaped to make sure we match the actual value passed to `querySelector`\n-      const escapedInvalids = `\\\\\"\\\\' \\\\:\\\\.\\\\[\\\\]\\\\,\\\\=`;\n-      scroller.scrollToAnchor(`specials=${invalidSelectorChars}`);\n-      expect(documentSpy.querySelector).toHaveBeenCalledWith(`#specials\\\\=${escapedInvalids}`);\n-      expect(documentSpy.querySelector)\n-          .toHaveBeenCalledWith(`[name='specials\\\\=${escapedInvalids}']`);\n+    it('should not call scrollToElement when an element is not found by its id or its name', () => {\n+      documentSpy.getElementsByName.and.returnValue([]);\n+      spyOn<any>(scroller, 'scrollToElement');\n+      scroller.scrollToAnchor(anchor);\n+      expect(documentSpy.getElementById).toHaveBeenCalledWith(anchor);\n+      expect(documentSpy.getElementsByName).toHaveBeenCalledWith(anchor);\n+      expect((scroller as any).scrollToElement).not.toHaveBeenCalled();\n     });\n   });\n-}\n+});"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 51,
        "deletions": 56
    }
}