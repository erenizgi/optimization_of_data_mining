{
    "author": "alxhub",
    "message": "fix(compiler): correct spans when parsing bindings with comments (#44678)\n\nWhen parsing a binding with a comment at the end of the expression, the\nparser previously had logic to offset the parsed spans by the length of the\ncomment. This logic seemed not to serve any useful purpose, and instead\nresulted in the corruption of the spans. For example, in the expression\n`{{foo // comment}}`, the parser would map the parsed `foo` `PropertyRead`\nnode at the location of the characters 'ent' from the comment suffix.\n\nThis commit removes that logic, correcting the parsed spans of such nodes in\nthe presence of comments. Removing this logic does not seem to have caused\nany tests to fail.\n\nPR Close #44678",
    "sha": "b8ed03b5ad91a2dd62d600240e9056a360b89b90",
    "files": [
        {
            "sha": "574385e6fc6a171595a15de3e0fb9e5466d1a5c7",
            "filename": "packages/compiler-cli/src/ngtsc/indexer/test/template_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/b8ed03b5ad91a2dd62d600240e9056a360b89b90/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8ed03b5ad91a2dd62d600240e9056a360b89b90/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts?ref=b8ed03b5ad91a2dd62d600240e9056a360b89b90",
            "patch": "@@ -21,6 +21,19 @@ function bind(template: string) {\n \n runInEachFileSystem(() => {\n   describe('getTemplateIdentifiers', () => {\n+    it('should handle comments in interpolations', () => {\n+      const template = '{{foo // comment}}';\n+      const refs = getTemplateIdentifiers(bind(template));\n+\n+      const [ref] = Array.from(refs);\n+      expect(ref).toEqual({\n+        name: 'foo',\n+        kind: IdentifierKind.Property,\n+        span: new AbsoluteSourceSpan(2, 5),\n+        target: null,\n+      });\n+    });\n+\n     it('should generate nothing in empty template', () => {\n       const template = '';\n       const refs = getTemplateIdentifiers(bind(template));"
        },
        {
            "sha": "4a168c9be669f09534a5181baec6cf08cc4410c4",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/b8ed03b5ad91a2dd62d600240e9056a360b89b90/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8ed03b5ad91a2dd62d600240e9056a360b89b90/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=b8ed03b5ad91a2dd62d600240e9056a360b89b90",
            "patch": "@@ -39,11 +39,11 @@ export class Parser {\n       interpolationConfig: InterpolationConfig = DEFAULT_INTERPOLATION_CONFIG): ASTWithSource {\n     this._checkNoInterpolation(input, location, interpolationConfig);\n     const sourceToLex = this._stripComments(input);\n-    const tokens = this._lexer.tokenize(this._stripComments(input));\n-    const ast = new _ParseAST(\n-                    input, location, absoluteOffset, tokens, sourceToLex.length, true, this.errors,\n-                    input.length - sourceToLex.length)\n-                    .parseChain();\n+    const tokens = this._lexer.tokenize(sourceToLex);\n+    const ast =\n+        new _ParseAST(\n+            input, location, absoluteOffset, tokens, sourceToLex.length, true, this.errors, 0)\n+            .parseChain();\n     return new ASTWithSource(ast, input, location, absoluteOffset, this.errors);\n   }\n \n@@ -91,8 +91,7 @@ export class Parser {\n     const sourceToLex = this._stripComments(input);\n     const tokens = this._lexer.tokenize(sourceToLex);\n     return new _ParseAST(\n-               input, location, absoluteOffset, tokens, sourceToLex.length, false, this.errors,\n-               input.length - sourceToLex.length)\n+               input, location, absoluteOffset, tokens, sourceToLex.length, false, this.errors, 0)\n         .parseChain();\n   }\n \n@@ -162,7 +161,7 @@ export class Parser {\n       const tokens = this._lexer.tokenize(sourceToLex);\n       const ast = new _ParseAST(\n                       input, location, absoluteOffset, tokens, sourceToLex.length, false,\n-                      this.errors, offsets[i] + (expressionText.length - sourceToLex.length))\n+                      this.errors, offsets[i])\n                       .parseChain();\n       expressionNodes.push(ast);\n     }"
        },
        {
            "sha": "df707989260f7738c83230b29983316d4ddbc9ed",
            "filename": "packages/compiler/test/render3/r3_ast_absolute_span_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/b8ed03b5ad91a2dd62d600240e9056a360b89b90/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_absolute_span_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b8ed03b5ad91a2dd62d600240e9056a360b89b90/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_absolute_span_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_absolute_span_spec.ts?ref=b8ed03b5ad91a2dd62d600240e9056a360b89b90",
            "patch": "@@ -7,10 +7,23 @@\n  */\n \n import {AbsoluteSourceSpan} from '@angular/compiler';\n+\n import {humanizeExpressionSource} from './util/expression';\n import {parseR3 as parse} from './view/util';\n \n describe('expression AST absolute source spans', () => {\n+  it('should handle comment in interpolation', () => {\n+    expect(humanizeExpressionSource(parse('{{foo // comment}}', {preserveWhitespaces: true}).nodes))\n+        .toContain(['foo', new AbsoluteSourceSpan(2, 5)]);\n+  });\n+\n+  it('should handle comment in an action binding', () => {\n+    expect(humanizeExpressionSource(parse('<button (click)=\"foo = true // comment\">Save</button>', {\n+                                      preserveWhitespaces: true\n+                                    }).nodes))\n+        .toContain(['foo = true', new AbsoluteSourceSpan(17, 27)]);\n+  });\n+\n   // TODO(ayazhafiz): duplicate this test without `preserveWhitespaces` once whitespace rewriting is\n   // moved to post-R3AST generation.\n   it('should provide absolute offsets with arbitrary whitespace', () => {"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 33,
        "deletions": 8
    }
}