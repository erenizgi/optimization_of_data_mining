{
    "author": "JoostK",
    "message": "fix(compiler-cli): use correct module resolution context for absolute imports in .d.ts files (#42879)\n\nThe compiler keeps track of how a declaration has been referenced\nusing absolute module imports and from which path the absolute module\nshould be resolved from. There was a bug in how the .d.ts metadata\nextraction would incorrectly use the .d.ts file itself as resolution\ncontext for symbols that had been imported using a relative module\nspecifier. This could result in module resolution failures.\n\nFor example, when extracting NgModule metadata from\n`/node_modules/lib/index.d.ts` that looks like\n\n```\nimport {LibDirective} from './dir';\n\n@NgModule({\n  declarations: [LibDirective],\n  exports: [LibDirective],\n})\nexport class LibModule {}\n```\n\nand `/app.module.ts` that contains\n\n```\nimport {LibModule} from 'lib';\n\n@NgModule({\n  imports: [LibModule],\n})\nexport class AppModule {}\n```\n\nthen `AppModule` would have recorded a reference to `LibModule` using\nthe `'lib'` module specifier. When extracting the NgModule metadata from\nthe `/node_modules/lib/index.d.ts` file the relative import into `./dir`\nshould also be assumed to be importable from `'lib'` (according to APF\nwhere symbols need to be exported from a single entry-point)\nso the reference to `LibDirective` should have `'lib'` as absolute\nmodule specifier, but it would incorrectly have\n`/node_modules/lib/index.d.ts` as resolution context path. The latter is\nincorrect as `'lib'` needs to be resolved from `/app.module.ts` and not\nfrom within the library itself.\n\nFixes #42810\n\nPR Close #42879",
    "sha": "ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5",
    "files": [
        {
            "sha": "2ea11b0c8e563a935f350fc77cf7c61cf9c07697",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/dts.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts",
            "raw_url": "https://github.com/angular/angular/raw/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts?ref=ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5",
            "patch": "@@ -30,7 +30,7 @@ export class DtsMetadataReader implements MetadataReader {\n    */\n   getNgModuleMetadata(ref: Reference<ClassDeclaration>): NgModuleMeta|null {\n     const clazz = ref.node;\n-    const resolutionContext = clazz.getSourceFile().fileName;\n+\n     // This operation is explicitly not memoized, as it depends on `ref.ownedByModuleGuess`.\n     // TODO(alxhub): investigate caching of .d.ts module metadata.\n     const ngModuleDef = this.reflector.getMembersOfClass(clazz).find(\n@@ -49,12 +49,10 @@ export class DtsMetadataReader implements MetadataReader {\n     const [_, declarationMetadata, importMetadata, exportMetadata] = ngModuleDef.type.typeArguments;\n     return {\n       ref,\n-      declarations: extractReferencesFromType(\n-          this.checker, declarationMetadata, ref.ownedByModuleGuess, resolutionContext),\n-      exports: extractReferencesFromType(\n-          this.checker, exportMetadata, ref.ownedByModuleGuess, resolutionContext),\n-      imports: extractReferencesFromType(\n-          this.checker, importMetadata, ref.ownedByModuleGuess, resolutionContext),\n+      declarations:\n+          extractReferencesFromType(this.checker, declarationMetadata, ref.bestGuessOwningModule),\n+      exports: extractReferencesFromType(this.checker, exportMetadata, ref.bestGuessOwningModule),\n+      imports: extractReferencesFromType(this.checker, importMetadata, ref.bestGuessOwningModule),\n       schemas: [],\n       rawDeclarations: null,\n     };"
        },
        {
            "sha": "597417440f60dcd44290492f0f9d6674716f6b91",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/util.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Futil.ts?ref=ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5",
            "patch": "@@ -8,16 +8,16 @@\n \n import * as ts from 'typescript';\n \n-import {Reference} from '../../imports';\n+import {OwningModule, Reference} from '../../imports';\n import {ClassDeclaration, ClassMember, ClassMemberKind, isNamedClassDeclaration, ReflectionHost, reflectTypeEntityToDeclaration} from '../../reflection';\n import {nodeDebugInfo} from '../../util/src/typescript';\n \n import {DirectiveMeta, DirectiveTypeCheckMeta, MetadataReader, NgModuleMeta, PipeMeta, TemplateGuardMeta} from './api';\n import {ClassPropertyMapping, ClassPropertyName} from './property_mapping';\n \n export function extractReferencesFromType(\n-    checker: ts.TypeChecker, def: ts.TypeNode, ngModuleImportedFrom: string|null,\n-    resolutionContext: string): Reference<ClassDeclaration>[] {\n+    checker: ts.TypeChecker, def: ts.TypeNode,\n+    bestGuessOwningModule: OwningModule|null): Reference<ClassDeclaration>[] {\n   if (!ts.isTupleTypeNode(def)) {\n     return [];\n   }\n@@ -31,11 +31,15 @@ export function extractReferencesFromType(\n     if (!isNamedClassDeclaration(node)) {\n       throw new Error(`Expected named ClassDeclaration: ${nodeDebugInfo(node)}`);\n     }\n-    const specifier = (from !== null && !from.startsWith('.') ? from : ngModuleImportedFrom);\n-    if (specifier !== null) {\n-      return new Reference(node, {specifier, resolutionContext});\n+    if (from !== null && !from.startsWith('.')) {\n+      // The symbol was imported using an absolute module specifier so return a reference that\n+      // uses that absolute module specifier as its best guess owning module.\n+      return new Reference(\n+          node, {specifier: from, resolutionContext: def.getSourceFile().fileName});\n     } else {\n-      return new Reference(node);\n+      // For local symbols or symbols that were imported using a relative module import it is\n+      // assumed that the symbol is exported from the provided best guess owning module.\n+      return new Reference(node, bestGuessOwningModule);\n     }\n   });\n }"
        },
        {
            "sha": "f3acf1e4798a45052cf40f33fb8d3c77557cfffc",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/test/dts_spec.ts",
            "status": "modified",
            "additions": 89,
            "deletions": 1,
            "changes": 90,
            "blob_url": "https://github.com/angular/angular/blob/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2Fdts_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2Fdts_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Ftest%2Fdts_spec.ts?ref=ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5",
            "patch": "@@ -10,7 +10,7 @@ import * as ts from 'typescript';\n \n import {absoluteFrom, getFileSystem, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n-import {Reference} from '../../imports';\n+import {OwningModule, Reference} from '../../imports';\n import {isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {loadFakeCore, makeProgram} from '../../testing';\n \n@@ -89,5 +89,93 @@ runInEachFileSystem(() => {\n       const meta = dtsReader.getDirectiveMetadata(new Reference(clazz))!;\n       expect(meta.isStructural).toBeTrue();\n     });\n+\n+    it('should retain an absolute owning module for relative imports', () => {\n+      const externalPath = absoluteFrom('/external.d.ts');\n+      const {program} = makeProgram(\n+          [\n+            {\n+              name: externalPath,\n+              contents: `\n+          import * as i0 from '@angular/core';\n+          import * as i1 from 'absolute';\n+          import * as i2 from './relative';\n+\n+          export declare class ExternalModule {\n+            static ɵmod: i0.ɵɵNgModuleDeclaration<RelativeModule, [typeof i2.RelativeDir], never, [typeof i1.AbsoluteDir, typeof i2.RelativeDir]>;\n+          }\n+        `\n+            },\n+            {\n+              name: absoluteFrom('/relative.d.ts'),\n+              contents: `\n+          import * as i0 from '@angular/core';\n+\n+          export declare class RelativeDir {\n+            static ɵdir: i0.ɵɵDirectiveDeclaration<RelativeDir, '[dir]', never, never, never, never>;\n+          }\n+        `\n+            },\n+            {\n+              name: absoluteFrom('/node_modules/absolute.d.ts'),\n+              contents: `\n+          import * as i0 from '@angular/core';\n+\n+          export declare class AbsoluteDir {\n+            static ɵdir: i0.ɵɵDirectiveDeclaration<ExternalDir, '[dir]', never, never, never, never>;\n+          }\n+        `\n+            }\n+          ],\n+          {\n+            skipLibCheck: true,\n+            lib: ['es6', 'dom'],\n+          });\n+\n+      const externalSf = getSourceFileOrError(program, externalPath);\n+      const clazz = externalSf.statements[3];\n+      if (!isNamedClassDeclaration(clazz)) {\n+        return fail('Expected class declaration');\n+      }\n+\n+      const typeChecker = program.getTypeChecker();\n+      const dtsReader =\n+          new DtsMetadataReader(typeChecker, new TypeScriptReflectionHost(typeChecker));\n+\n+      const withoutOwningModule = dtsReader.getNgModuleMetadata(new Reference(clazz))!;\n+      expect(withoutOwningModule.exports.length).toBe(2);\n+\n+      // `AbsoluteDir` was imported from an absolute module so the export Reference should have\n+      // a corresponding best guess owning module.\n+      expect(withoutOwningModule.exports[0].bestGuessOwningModule).toEqual({\n+        specifier: 'absolute',\n+        resolutionContext: externalSf.fileName,\n+      });\n+\n+      // `RelativeDir` was imported from a relative module specifier so the original reference's\n+      // best guess owning module should have been retained, which was null.\n+      expect(withoutOwningModule.exports[1].bestGuessOwningModule).toBeNull();\n+\n+      const owningModule: OwningModule = {\n+        specifier: 'module',\n+        resolutionContext: absoluteFrom('/context.ts'),\n+      };\n+      const withOwningModule = dtsReader.getNgModuleMetadata(new Reference(clazz, owningModule))!;\n+      expect(withOwningModule.exports.length).toBe(2);\n+\n+      // Again, `AbsoluteDir` was imported from an absolute module so the export Reference should\n+      // have a corresponding best guess owning module; the owning module of the incoming reference\n+      // is irrelevant here.\n+      expect(withOwningModule.exports[0].bestGuessOwningModule).toEqual({\n+        specifier: 'absolute',\n+        resolutionContext: externalSf.fileName,\n+      });\n+\n+      // As `RelativeDir` was imported from a relative module specifier, the export Reference should\n+      // continue to have the owning module of the incoming reference as the relatively imported\n+      // symbol is assumed to also be exported from the absolute module specifier as captured in the\n+      // best guess owning module.\n+      expect(withOwningModule.exports[1].bestGuessOwningModule).toEqual(owningModule);\n+    });\n   });\n });"
        },
        {
            "sha": "8298910a4d22bbc2216b429a19f0e7c0d915677b",
            "filename": "packages/compiler-cli/src/ngtsc/scope/test/dependency_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Fdependency_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Fdependency_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Fdependency_spec.ts?ref=ed9cfb674f8e52b416ccdaf9aa9c46955b8448f5",
            "patch": "@@ -68,8 +68,7 @@ function makeTestEnv(\n       const exportedSymbol = symbol.exports!.get(name as ts.__String);\n       if (exportedSymbol !== undefined) {\n         const decl = exportedSymbol.valueDeclaration as ts.ClassDeclaration;\n-        const specifier = MODULE_FROM_NODE_MODULES_PATH.exec(sf.fileName)![1];\n-        return new Reference(decl, {specifier, resolutionContext: sf.fileName});\n+        return new Reference(decl);\n       }\n     }\n     throw new Error('Class not found: ' + name);\n@@ -143,10 +142,13 @@ runInEachFileSystem(() => {\n       });\n       const {Dir, ModuleB} = refs;\n       const scope = resolver.resolve(ModuleB)!;\n-      expect(scopeToRefs(scope)).toEqual([Dir]);\n+      expect(scopeToRefs(scope).map(ref => ref.node)).toEqual([Dir.node]);\n \n       // Explicitly verify that the directive has the correct owning module.\n-      expect(scope.exported.directives[0].ref.ownedByModuleGuess).toBe('declaration');\n+      expect(scope.exported.directives[0].ref.bestGuessOwningModule).toEqual({\n+        specifier: 'declaration',\n+        resolutionContext: ModuleB.node.getSourceFile().fileName,\n+      });\n     });\n \n     it('should write correct aliases for deep dependencies', () => {"
        }
    ],
    "stats": {
        "total": 130,
        "additions": 111,
        "deletions": 19
    }
}