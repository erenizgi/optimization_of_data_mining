{
    "author": "dimakuba",
    "message": "fix(router): Only retrieve stored route when reuse strategy indicates it should reattach (#30263)\n\nWhen creating the router state, the `RouteReuseStrategy#retrieve` should\nonly be called when `RouteReuseStrategy#shouldAttach` returns `true`.\nThat is, we should only retrieve a stored route when the reuse strategy\nindicates that there is one stored and that it should be reattached.\n\nThis now matches the behavior in the route activation:\nhttps://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages/router/src/operators/activate_routes.ts#L170-L172\n\nFixes #23162\n\nPR Close #30263",
    "sha": "6bceb709dfc0349f93d34594f766e5930811666a",
    "files": [
        {
            "sha": "8532faa045cae751f7237172141ffadb40e0e93a",
            "filename": "packages/router/src/create_router_state.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/6bceb709dfc0349f93d34594f766e5930811666a/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts",
            "raw_url": "https://github.com/angular/angular/raw/6bceb709dfc0349f93d34594f766e5930811666a/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts?ref=6bceb709dfc0349f93d34594f766e5930811666a",
            "patch": "@@ -28,21 +28,20 @@ function createNode(\n     value._futureSnapshot = curr.value;\n     const children = createOrReuseChildren(routeReuseStrategy, curr, prevState);\n     return new TreeNode<ActivatedRoute>(value, children);\n-\n-    // retrieve an activated route that is used to be displayed, but is not currently displayed\n   } else {\n-    const detachedRouteHandle =\n-        <DetachedRouteHandleInternal>routeReuseStrategy.retrieve(curr.value);\n-    if (detachedRouteHandle) {\n-      const tree: TreeNode<ActivatedRoute> = detachedRouteHandle.route;\n-      setFutureSnapshotsOfActivatedRoutes(curr, tree);\n-      return tree;\n-\n-    } else {\n-      const value = createActivatedRoute(curr.value);\n-      const children = curr.children.map(c => createNode(routeReuseStrategy, c));\n-      return new TreeNode<ActivatedRoute>(value, children);\n+    if (routeReuseStrategy.shouldAttach(curr.value)) {\n+      // retrieve an activated route that is used to be displayed, but is not currently displayed\n+      const detachedRouteHandle = routeReuseStrategy.retrieve(curr.value);\n+      if (detachedRouteHandle !== null) {\n+        const tree = (detachedRouteHandle as DetachedRouteHandleInternal).route;\n+        setFutureSnapshotsOfActivatedRoutes(curr, tree);\n+        return tree;\n+      }\n     }\n+\n+    const value = createActivatedRoute(curr.value);\n+    const children = curr.children.map(c => createNode(routeReuseStrategy, c));\n+    return new TreeNode<ActivatedRoute>(value, children);\n   }\n }\n "
        },
        {
            "sha": "98ecd2a7c3fab7ebd0a5f3b4064ef6bc8824374c",
            "filename": "packages/router/test/create_router_state.spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 11,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/6bceb709dfc0349f93d34594f766e5930811666a/packages%2Frouter%2Ftest%2Fcreate_router_state.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6bceb709dfc0349f93d34594f766e5930811666a/packages%2Frouter%2Ftest%2Fcreate_router_state.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fcreate_router_state.spec.ts?ref=6bceb709dfc0349f93d34594f766e5930811666a",
            "patch": "@@ -92,25 +92,18 @@ describe('create router state', () => {\n     checkActivatedRoute(currC[1], ComponentB, 'right');\n   });\n \n-  it('should cache the retrieved routeReuseStrategy', () => {\n+  it('should not retrieve routes when `shouldAttach` is always false', () => {\n     const config = [\n       {path: 'a', component: ComponentA}, {path: 'b', component: ComponentB, outlet: 'left'},\n       {path: 'c', component: ComponentC, outlet: 'left'}\n     ];\n-    spyOn(reuseStrategy, 'retrieve').and.callThrough();\n+    spyOn(reuseStrategy, 'retrieve');\n \n     const prevState =\n         createRouterState(reuseStrategy, createState(config, 'a(left:b)'), emptyState());\n     advanceState(prevState);\n-\n-    // Expect 2 calls as the baseline setup\n-    expect(reuseStrategy.retrieve).toHaveBeenCalledTimes(2);\n-\n-    // This call should produce a reused activated route\n-    const state = createRouterState(reuseStrategy, createState(config, 'a(left:c)'), prevState);\n-\n-    // Verify the retrieve method has been called one more time\n-    expect(reuseStrategy.retrieve).toHaveBeenCalledTimes(3);\n+    createRouterState(reuseStrategy, createState(config, 'a(left:c)'), prevState);\n+    expect(reuseStrategy.retrieve).not.toHaveBeenCalled();\n   });\n \n   it('should consistently represent future and current state', () => {"
        },
        {
            "sha": "094c4de6684dfedf2d92798b50c5d98117c531db",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/6bceb709dfc0349f93d34594f766e5930811666a/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6bceb709dfc0349f93d34594f766e5930811666a/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=6bceb709dfc0349f93d34594f766e5930811666a",
            "patch": "@@ -5807,6 +5807,7 @@ describe('Integration', () => {\n          const fixture = createRoot(router, RootCmp);\n \n          router.routeReuseStrategy = new AttachDetachReuseStrategy();\n+         spyOn(router.routeReuseStrategy, 'retrieve').and.callThrough();\n \n          router.resetConfig([\n            {\n@@ -5824,14 +5825,19 @@ describe('Integration', () => {\n          expect(location.path()).toEqual('/a/b');\n          expect(teamCmp).toBeDefined();\n          expect(simpleCmp).toBeDefined();\n+         expect(router.routeReuseStrategy.retrieve).not.toHaveBeenCalled();\n \n          router.navigateByUrl('/c');\n          advance(fixture);\n          expect(location.path()).toEqual('/c');\n          expect(fixture.debugElement.children[1].componentInstance).toBeAnInstanceOf(UserCmp);\n+         // We have still not encountered a route that should be reattached\n+         expect(router.routeReuseStrategy.retrieve).not.toHaveBeenCalled();\n \n          router.navigateByUrl('/a;p=1/b;p=2');\n          advance(fixture);\n+         // We retrieve both the stored route snapshots\n+         expect(router.routeReuseStrategy.retrieve).toHaveBeenCalledTimes(2);\n          const teamCmp2 = fixture.debugElement.children[1].componentInstance;\n          const simpleCmp2 = fixture.debugElement.children[1].children[1].componentInstance;\n          expect(location.path()).toEqual('/a;p=1/b;p=2');"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 22,
        "deletions": 24
    }
}