{
    "author": "alxhub",
    "message": "refactor(compiler-cli): add getTemplateOfComponent to TemplateTypeChecker (#38355)\n\nThis commit adds a `getTemplateOfComponent` method to the\n`TemplateTypeChecker` API, which retrieves the actual nodes parsed and used\nby the compiler for template type-checking. This is advantageous for the\nlanguage service, which may need to query other APIs in\n`TemplateTypeChecker` that require the same nodes used to bind the template\nwhile generating the TCB.\n\nFixes #38352\n\nPR Close #38355",
    "sha": "0b54c0c6b42276369848bce323b03c9da1244f92",
    "files": [
        {
            "sha": "3eac4dfebdff6eb9b665001d50fa82cde4472d20",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=0b54c0c6b42276369848bce323b03c9da1244f92",
            "patch": "@@ -28,6 +28,14 @@ export interface TemplateTypeChecker {\n    */\n   resetOverrides(): void;\n \n+  /**\n+   * Retrieve the template in use for the given component.\n+   *\n+   * If the template has been overridden via `overrideComponentTemplate`, this will retrieve the\n+   * overridden template nodes.\n+   */\n+  getTemplate(component: ts.ClassDeclaration): TmplAstNode[]|null;\n+\n   /**\n    * Provide a new template string that will be used in place of the user-defined template when\n    * checking or operating on the given component."
        },
        {
            "sha": "b91825c55f71912c842e6ee751a37ca6d9465655",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=0b54c0c6b42276369848bce323b03c9da1244f92",
            "patch": "@@ -48,6 +48,29 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     }\n   }\n \n+  getTemplate(component: ts.ClassDeclaration): TmplAstNode[]|null {\n+    this.ensureShimForComponent(component);\n+\n+    const sf = component.getSourceFile();\n+    const sfPath = absoluteFromSourceFile(sf);\n+    const shimPath = this.typeCheckingStrategy.shimPathForComponent(component);\n+\n+    const fileRecord = this.getFileData(sfPath);\n+\n+    if (!fileRecord.shimData.has(shimPath)) {\n+      return [];\n+    }\n+\n+    const templateId = fileRecord.sourceManager.getTemplateId(component);\n+    const shimRecord = fileRecord.shimData.get(shimPath)!;\n+\n+    if (!shimRecord.templates.has(templateId)) {\n+      return null;\n+    }\n+\n+    return shimRecord.templates.get(templateId)!.template;\n+  }\n+\n   overrideComponentTemplate(component: ts.ClassDeclaration, template: string):\n       {nodes: TmplAstNode[], errors?: ParseError[]} {\n     const {nodes, errors} = parseTemplate(template, 'override.html', {"
        },
        {
            "sha": "fa80d5b0b33fd112cf21b32dbf3257aeed9bcf45",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 3,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=0b54c0c6b42276369848bce323b03c9da1244f92",
            "patch": "@@ -6,14 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n+import {BoundTarget, ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n-import {ComponentToShimMappingStrategy, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n+import {ComponentToShimMappingStrategy, TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n \n import {TemplateDiagnostic} from './diagnostics';\n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n@@ -41,6 +41,28 @@ export interface ShimTypeCheckingData {\n    * Whether any inline operations for the input file were required to generate this shim.\n    */\n   hasInlines: boolean;\n+\n+  /**\n+   * Map of `TemplateId` to information collected about the template during the template\n+   * type-checking process.\n+   */\n+  templates: Map<TemplateId, TemplateData>;\n+}\n+\n+/**\n+ * Data tracked for each template processed by the template type-checking system.\n+ */\n+export interface TemplateData {\n+  /**\n+   * Template nodes for which the TCB was generated.\n+   */\n+  template: TmplAstNode[];\n+\n+  /**\n+   * `BoundTarget` which was used to generate the TCB, and contains bindings for the associated\n+   * template nodes.\n+   */\n+  boundTarget: BoundTarget<TypeCheckableDirectiveMeta>;\n }\n \n /**\n@@ -79,6 +101,12 @@ export interface PendingShimData {\n    * Shim file in the process of being generated.\n    */\n   file: TypeCheckFile;\n+\n+\n+  /**\n+   * Map of `TemplateId` to information collected about the template as it's ingested.\n+   */\n+  templates: Map<TemplateId, TemplateData>;\n }\n \n /**\n@@ -195,6 +223,7 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n     const fileData = this.dataForFile(ref.node.getSourceFile());\n     const shimData = this.pendingShimForComponent(ref.node);\n     const boundTarget = binder.bind({template});\n+\n     // Get all of the directives used in the template and record type constructors for all of them.\n     for (const dir of boundTarget.getUsedDirectives()) {\n       const dirRef = dir.ref as Reference<ClassDeclaration<ts.ClassDeclaration>>;\n@@ -221,6 +250,11 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n         });\n       }\n     }\n+    const templateId = fileData.sourceManager.getTemplateId(ref.node);\n+    shimData.templates.set(templateId, {\n+      template,\n+      boundTarget,\n+    });\n \n     const tcbRequiresInline = requiresInlineTypeCheckBlock(ref.node);\n \n@@ -231,7 +265,6 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       // and inlining would be required.\n \n       // Record diagnostics to indicate the issues with this template.\n-      const templateId = fileData.sourceManager.getTemplateId(ref.node);\n       if (tcbRequiresInline) {\n         shimData.oobRecorder.requiresInlineTcb(templateId, ref.node);\n       }\n@@ -348,6 +381,7 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n           ],\n           hasInlines: pendingFileData.hasInlines,\n           path: pendingShimData.file.fileName,\n+          templates: pendingShimData.templates,\n         });\n         updates.set(pendingShimData.file.fileName, pendingShimData.file.render());\n       }\n@@ -380,6 +414,7 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n         oobRecorder: new OutOfBandDiagnosticRecorderImpl(fileData.sourceManager),\n         file: new TypeCheckFile(\n             shimPath, this.config, this.refEmitter, this.reflector, this.compilerHost),\n+        templates: new Map<TemplateId, TemplateData>(),\n       });\n     }\n     return fileData.shimData.get(shimPath)!;"
        },
        {
            "sha": "b4d95d1b5a91eb0bed58b85b198a7e0e18328a60",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker_spec.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0b54c0c6b42276369848bce323b03c9da1244f92/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts?ref=0b54c0c6b42276369848bce323b03c9da1244f92",
            "patch": "@@ -353,5 +353,40 @@ runInEachFileSystem(os => {\n       expect(diags2[0].messageText).toContain('invalid-element-b');\n       expect(diags2[0].messageText).not.toContain('invalid-element-a');\n     });\n+\n+    describe('getTemplateOfComponent()', () => {\n+      it('should provide access to a component\\'s real template', () => {\n+        const fileName = absoluteFrom('/main.ts');\n+        const {program, templateTypeChecker} = setup([{\n+          fileName,\n+          templates: {\n+            'Cmp': '<div>Template</div>',\n+          },\n+        }]);\n+        const cmp = getClass(getSourceFileOrError(program, fileName), 'Cmp');\n+\n+        const nodes = templateTypeChecker.getTemplate(cmp)!;\n+        expect(nodes).not.toBeNull();\n+        expect(nodes[0].sourceSpan.start.file.content).toBe('<div>Template</div>');\n+      });\n+\n+      it('should provide access to an overridden template', () => {\n+        const fileName = absoluteFrom('/main.ts');\n+        const {program, templateTypeChecker} = setup([{\n+          fileName,\n+          templates: {\n+            'Cmp': '<div>Template</div>',\n+          },\n+        }]);\n+        const cmp = getClass(getSourceFileOrError(program, fileName), 'Cmp');\n+\n+        templateTypeChecker.overrideComponentTemplate(cmp, '<div>Overridden</div>');\n+        templateTypeChecker.getDiagnosticsForComponent(cmp);\n+\n+        const nodes = templateTypeChecker.getTemplate(cmp)!;\n+        expect(nodes).not.toBeNull();\n+        expect(nodes[0].sourceSpan.start.file.content).toBe('<div>Overridden</div>');\n+      });\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 104,
        "deletions": 3
    }
}