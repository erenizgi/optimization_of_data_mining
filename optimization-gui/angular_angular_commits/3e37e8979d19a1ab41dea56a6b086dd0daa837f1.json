{
    "author": "atscott",
    "message": "fix(language-service): provide dom event completions (#43299)\n\nNative DOM events were previously not included in the completions\nbecause the dom schema registry would filter out events completely. This\nchange updates the registry to include events in the private\nelement->property map and excludes events from lookups outside of the\nnew `allKnownEventsOfElement` function.\n\nfixes https://github.com/angular/vscode-ng-language-service/issues/1479\n\nPR Close #43299",
    "sha": "3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
    "files": [
        {
            "sha": "2872b6f5fcc182e25b865ce95ce6f1cd822bffd8",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
            "patch": "@@ -153,6 +153,11 @@ export interface TemplateTypeChecker {\n    */\n   getPotentialDomBindings(tagName: string): {attribute: string, property: string}[];\n \n+  /**\n+   * Retrieve any potential DOM events.\n+   */\n+  getPotentialDomEvents(tagName: string): string[];\n+\n   /**\n    * Retrieve the type checking engine's metadata for the given directive class, if available.\n    */"
        },
        {
            "sha": "bdbdc877e2196f68c7260dec8e9467821ea1ee0c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
            "patch": "@@ -582,6 +582,10 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n                           }));\n   }\n \n+  getPotentialDomEvents(tagName: string): string[] {\n+    return REGISTRY.allKnownEventsOfElement(tagName);\n+  }\n+\n   private getScopeData(component: ts.ClassDeclaration): ScopeData|null {\n     if (this.scopeCache.has(component)) {\n       return this.scopeCache.get(component)!;"
        },
        {
            "sha": "14599ae41d74979f384f4a8a21baaf90e1e3c91a",
            "filename": "packages/compiler/src/schema/dom_element_schema_registry.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 6,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Fcompiler%2Fsrc%2Fschema%2Fdom_element_schema_registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Fcompiler%2Fsrc%2Fschema%2Fdom_element_schema_registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fschema%2Fdom_element_schema_registry.ts?ref=3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
            "patch": "@@ -14,6 +14,7 @@ import {dashCaseToCamelCase} from '../util';\n import {SECURITY_SCHEMA} from './dom_security_schema';\n import {ElementSchemaRegistry} from './element_schema_registry';\n \n+const EVENT = 'event';\n const BOOLEAN = 'boolean';\n const NUMBER = 'number';\n const STRING = 'string';\n@@ -249,30 +250,36 @@ const _PROP_TO_ATTR: {[name: string]: string} =\n \n export class DomElementSchemaRegistry extends ElementSchemaRegistry {\n   private _schema: {[element: string]: {[property: string]: string}} = {};\n+  // We don't allow binding to events for security reasons. Allowing event bindings would almost\n+  // certainly introduce bad XSS vulnerabilities. Instead, we store events in a separate schema.\n+  private _eventSchema: {[element: string]: Set<string>} = {};\n \n   constructor() {\n     super();\n     SCHEMA.forEach(encodedType => {\n       const type: {[property: string]: string} = {};\n+      const events: Set<string> = new Set();\n       const [strType, strProperties] = encodedType.split('|');\n       const properties = strProperties.split(',');\n       const [typeNames, superName] = strType.split('^');\n-      typeNames.split(',').forEach(tag => this._schema[tag.toLowerCase()] = type);\n+      typeNames.split(',').forEach(tag => {\n+        this._schema[tag.toLowerCase()] = type;\n+        this._eventSchema[tag.toLowerCase()] = events;\n+      });\n       const superType = superName && this._schema[superName.toLowerCase()];\n       if (superType) {\n         Object.keys(superType).forEach((prop: string) => {\n           type[prop] = superType[prop];\n         });\n+        for (const superEvent of this._eventSchema[superName.toLowerCase()]) {\n+          events.add(superEvent);\n+        }\n       }\n       properties.forEach((property: string) => {\n         if (property.length > 0) {\n           switch (property[0]) {\n             case '*':\n-              // We don't yet support events.\n-              // If ever allowing to bind to events, GO THROUGH A SECURITY REVIEW, allowing events\n-              // will\n-              // almost certainly introduce bad XSS vulnerabilities.\n-              // type[property.substring(1)] = EVENT;\n+              events.add(property.substring(1));\n               break;\n             case '!':\n               type[property.substring(1)] = BOOLEAN;\n@@ -400,6 +407,10 @@ export class DomElementSchemaRegistry extends ElementSchemaRegistry {\n     return Object.keys(elementProperties).map(prop => _PROP_TO_ATTR[prop] ?? prop);\n   }\n \n+  allKnownEventsOfElement(tagName: string): string[] {\n+    return Array.from(this._eventSchema[tagName.toLowerCase()] ?? []);\n+  }\n+\n   override normalizeAnimationStyleProperty(propName: string): string {\n     return dashCaseToCamelCase(propName);\n   }"
        },
        {
            "sha": "88e3ac0919f7f2604806a1d94c9045687e61f59d",
            "filename": "packages/language-service/ivy/attribute_completions.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 3,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts?ref=3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
            "patch": "@@ -32,6 +32,11 @@ export enum AttributeCompletionKind {\n    */\n   DomProperty,\n \n+  /**\n+   * Completion of an event from the DOM schema.\n+   */\n+  DomEvent,\n+\n   /**\n    * Completion of an attribute that results in a new directive being matched on an element.\n    */\n@@ -87,6 +92,15 @@ export interface DomPropertyCompletion {\n   property: string;\n }\n \n+export interface DomEventCompletion {\n+  kind: AttributeCompletionKind.DomEvent;\n+\n+  /**\n+   * Name of the DOM event\n+   */\n+  eventName: string;\n+}\n+\n /**\n  * Completion of an attribute which results in a new directive being matched on an element.\n  */\n@@ -163,8 +177,9 @@ export interface DirectiveOutputCompletion {\n  *\n  * Disambiguated by the `kind` property into various types of completions.\n  */\n-export type AttributeCompletion = DomAttributeCompletion|DomPropertyCompletion|\n-    DirectiveAttributeCompletion|DirectiveInputCompletion|DirectiveOutputCompletion;\n+export type AttributeCompletion =\n+    DomAttributeCompletion|DomPropertyCompletion|DirectiveAttributeCompletion|\n+    DirectiveInputCompletion|DirectiveOutputCompletion|DomEventCompletion;\n \n /**\n  * Given an element and its context, produce a `Map` of all possible attribute completions.\n@@ -345,8 +360,13 @@ export function buildAttributeCompletionTable(\n         });\n       }\n     }\n+    for (const event of checker.getPotentialDomEvents(element.name)) {\n+      table.set(event, {\n+        kind: AttributeCompletionKind.DomEvent,\n+        eventName: event,\n+      });\n+    }\n   }\n-\n   return table;\n }\n \n@@ -466,6 +486,16 @@ export function addAttributeCompletionEntries(\n           replacementSpan,\n         });\n       }\n+      break;\n+    }\n+    case AttributeCompletionKind.DomEvent: {\n+      entries.push({\n+        kind: unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+        name: `(${completion.eventName})`,\n+        sortText: completion.eventName,\n+        replacementSpan,\n+      });\n+      break;\n     }\n   }\n }\n@@ -474,6 +504,7 @@ export function getAttributeCompletionSymbol(\n     completion: AttributeCompletion, checker: ts.TypeChecker): ts.Symbol|null {\n   switch (completion.kind) {\n     case AttributeCompletionKind.DomAttribute:\n+    case AttributeCompletionKind.DomEvent:\n     case AttributeCompletionKind.DomProperty:\n       return null;\n     case AttributeCompletionKind.DirectiveAttribute:"
        },
        {
            "sha": "1c2d9082dfe6fe2626962153d410392a1cb6a01d",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
            "patch": "@@ -568,6 +568,11 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       // the user is completing on a property binding `[foo|]`, don't offer output event\n       // completions.\n       switch (completion.kind) {\n+        case AttributeCompletionKind.DomEvent:\n+          if (this.node instanceof TmplAstBoundAttribute) {\n+            continue;\n+          }\n+          break;\n         case AttributeCompletionKind.DomAttribute:\n         case AttributeCompletionKind.DomProperty:\n           if (this.node instanceof TmplAstBoundEvent) {\n@@ -644,6 +649,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     let documentation: ts.SymbolDisplayPart[]|undefined = undefined;\n     let info: DisplayInfo|null;\n     switch (completion.kind) {\n+      case AttributeCompletionKind.DomEvent:\n       case AttributeCompletionKind.DomAttribute:\n       case AttributeCompletionKind.DomProperty:\n         // TODO(alxhub): ideally we would show the same documentation as quick info here. However,"
        },
        {
            "sha": "a92af9198fcb993862c8fafffa6db170758fb06a",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e37e8979d19a1ab41dea56a6b086dd0daa837f1/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=3e37e8979d19a1ab41dea56a6b086dd0daa837f1",
            "patch": "@@ -506,6 +506,21 @@ describe('completions', () => {\n               ['[value]']);\n         });\n \n+        it('should return event completion', () => {\n+          const {templateFile} = setup(`<button ></button>`, ``);\n+          templateFile.moveCursorToText(`<button ¦>`);\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(completions, DisplayInfoKind.EVENT, ['(click)']);\n+        });\n+\n+        it('should return event completion with empty parens', () => {\n+          const {templateFile} = setup(`<button ()></button>`, ``);\n+          templateFile.moveCursorToText(`<button (¦)>`);\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(completions, DisplayInfoKind.EVENT, ['(click)']);\n+        });\n+\n+\n         it('should return completions for a partial attribute', () => {\n           const {appFile} = setupInlineTemplate(`<input val>`, '');\n           appFile.moveCursorToText('<input val¦>');\n@@ -536,6 +551,13 @@ describe('completions', () => {\n               ['value']);\n           expectReplacementText(completions, appFile.contents, 'val');\n         });\n+\n+        it('should return completions inside an event binding', () => {\n+          const {templateFile} = setup(`<button (cl)=''></button>`, ``);\n+          templateFile.moveCursorToText(`(cl¦)=''`);\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(completions, DisplayInfoKind.EVENT, ['(click)']);\n+        });\n       });\n \n       describe('directive present', () => {"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 88,
        "deletions": 9
    }
}