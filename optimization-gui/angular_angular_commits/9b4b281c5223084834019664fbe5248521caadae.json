{
    "author": "petebacondarwin",
    "message": "fix(core): handle multiple i18n attributes with expression bindings (#41882)\n\nWhen there are multiple attributes that are marked for i18n translation,\nwhich contain expression bindings, we were generating i18n update op-codes\nthat did not accurately map to the correct value to be bound in the lView.\nEach attribute's bindings were relative to the start of the lView first\nattributes values rather than to their own.\n\nThis fix passes the current binding index to `generateBindingUpdateOpCodes()`\nwhen processing i18n attributes to account for this.\n\nFixes #41869\n\nPR Close #41882",
    "sha": "9b4b281c5223084834019664fbe5248521caadae",
    "files": [
        {
            "sha": "16edade3139acb466b4dc6eeed174e15007b7e7c",
            "filename": "packages/core/src/render3/i18n/i18n_parse.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 10,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/9b4b281c5223084834019664fbe5248521caadae/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_parse.ts",
            "raw_url": "https://github.com/angular/angular/raw/9b4b281c5223084834019664fbe5248521caadae/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_parse.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fi18n%2Fi18n_parse.ts?ref=9b4b281c5223084834019664fbe5248521caadae",
            "patch": "@@ -219,7 +219,7 @@ function i18nStartFirstCreatePassProcessTextNode(\n   const tNode = createTNodeAndAddOpCode(\n       tView, rootTNode, existingTNodes, lView, createOpCodes, hasBinding ? null : text, false);\n   if (hasBinding) {\n-    generateBindingUpdateOpCodes(updateOpCodes, text, tNode.index);\n+    generateBindingUpdateOpCodes(updateOpCodes, text, tNode.index, null, 0, null);\n   }\n }\n \n@@ -251,7 +251,11 @@ export function i18nAttributesFirstPass(tView: TView, index: number, values: str\n \n         // i18n attributes that hit this code path are guaranteed to have bindings, because\n         // the compiler treats static i18n attributes as regular attribute bindings.\n-        generateBindingUpdateOpCodes(updateOpCodes, message, previousElementIndex, attrName);\n+        // Since this may not be the first i18n attribute on this element we need to pass in how\n+        // many previous bindings there have already been.\n+        generateBindingUpdateOpCodes(\n+            updateOpCodes, message, previousElementIndex, attrName, countBindings(updateOpCodes),\n+            null);\n       }\n     }\n     tView.data[index] = updateOpCodes;\n@@ -267,10 +271,12 @@ export function i18nAttributesFirstPass(tView: TView, index: number, values: str\n  * @param destinationNode Index of the destination node which will receive the binding.\n  * @param attrName Name of the attribute, if the string belongs to an attribute.\n  * @param sanitizeFn Sanitization function used to sanitize the string after update, if necessary.\n+ * @param bindingStart The lView index of the next expression that can be bound via an opCode.\n+ * @returns The mask value for these bindings\n  */\n-export function generateBindingUpdateOpCodes(\n-    updateOpCodes: I18nUpdateOpCodes, str: string, destinationNode: number, attrName?: string,\n-    sanitizeFn: SanitizerFn|null = null): number {\n+function generateBindingUpdateOpCodes(\n+    updateOpCodes: I18nUpdateOpCodes, str: string, destinationNode: number, attrName: string|null,\n+    bindingStart: number, sanitizeFn: SanitizerFn|null): number {\n   ngDevMode &&\n       assertGreaterThanOrEqual(\n           destinationNode, HEADER_OFFSET, 'Index must be in absolute LView offset');\n@@ -289,7 +295,7 @@ export function generateBindingUpdateOpCodes(\n \n     if (j & 1) {\n       // Odd indexes are bindings\n-      const bindingIndex = parseInt(textValue, 10);\n+      const bindingIndex = bindingStart + parseInt(textValue, 10);\n       updateOpCodes.push(-1 - bindingIndex);\n       mask = mask | toMaskBit(bindingIndex);\n     } else if (textValue !== '') {\n@@ -309,6 +315,28 @@ export function generateBindingUpdateOpCodes(\n   return mask;\n }\n \n+/**\n+ * Count the number of bindings in the given `opCodes`.\n+ *\n+ * It could be possible to speed this up, by passing the number of bindings found back from\n+ * `generateBindingUpdateOpCodes()` to `i18nAttributesFirstPass()` but this would then require more\n+ * complexity in the code and/or transient objects to be created.\n+ *\n+ * Since this function is only called once when the template is instantiated, is trivial in the\n+ * first instance (since `opCodes` will be an empty array), and it is not common for elements to\n+ * contain multiple i18n bound attributes, it seems like this is a reasonable compromise.\n+ */\n+function countBindings(opCodes: I18nUpdateOpCodes): number {\n+  let count = 0;\n+  for (let i = 0; i < opCodes.length; i++) {\n+    const opCode = opCodes[i];\n+    // Bindings are negative numbers.\n+    if (typeof opCode === 'number' && opCode < 0) {\n+      count++;\n+    }\n+  }\n+  return count;\n+}\n \n /**\n  * Convert binding index to mask bit.\n@@ -595,12 +623,12 @@ function walkIcuTree(\n               if (VALID_ATTRS.hasOwnProperty(lowerAttrName)) {\n                 if (URI_ATTRS[lowerAttrName]) {\n                   generateBindingUpdateOpCodes(\n-                      update, attr.value, newIndex, attr.name, _sanitizeUrl);\n+                      update, attr.value, newIndex, attr.name, 0, _sanitizeUrl);\n                 } else if (SRCSET_ATTRS[lowerAttrName]) {\n                   generateBindingUpdateOpCodes(\n-                      update, attr.value, newIndex, attr.name, sanitizeSrcset);\n+                      update, attr.value, newIndex, attr.name, 0, sanitizeSrcset);\n                 } else {\n-                  generateBindingUpdateOpCodes(update, attr.value, newIndex, attr.name);\n+                  generateBindingUpdateOpCodes(update, attr.value, newIndex, attr.name, 0, null);\n                 }\n               } else {\n                 ngDevMode &&\n@@ -627,7 +655,8 @@ function walkIcuTree(\n         addCreateNodeAndAppend(create, null, hasBinding ? '' : value, parentIdx, newIndex);\n         addRemoveNode(remove, newIndex, depth);\n         if (hasBinding) {\n-          bindingMask = generateBindingUpdateOpCodes(update, value, newIndex) | bindingMask;\n+          bindingMask =\n+              generateBindingUpdateOpCodes(update, value, newIndex, null, 0, null) | bindingMask;\n         }\n         break;\n       case Node.COMMENT_NODE:"
        },
        {
            "sha": "e7d53802f7bfeb048da748a1e2e7bc3bdd4e1282",
            "filename": "packages/core/test/acceptance/i18n_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/9b4b281c5223084834019664fbe5248521caadae/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9b4b281c5223084834019664fbe5248521caadae/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts?ref=9b4b281c5223084834019664fbe5248521caadae",
            "patch": "@@ -1624,17 +1624,23 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n     });\n \n     it('multiple attributes', () => {\n-      loadTranslations({[computeMsgId('hello {$INTERPOLATION}')]: 'bonjour {$INTERPOLATION}'});\n+      loadTranslations({\n+        [computeMsgId('hello {$INTERPOLATION} - {$INTERPOLATION_1}')]:\n+            'bonjour {$INTERPOLATION} - {$INTERPOLATION_1}',\n+        [computeMsgId('bye {$INTERPOLATION} - {$INTERPOLATION_1}')]:\n+            'au revoir {$INTERPOLATION} - {$INTERPOLATION_1}',\n+      });\n       const fixture = initWithTemplate(\n           AppComp,\n-          `<input i18n i18n-title title=\"hello {{name}}\" i18n-placeholder placeholder=\"hello {{name}}\">`);\n+          `<input i18n i18n-title title=\"hello {{name}} - {{count}}\" i18n-placeholder placeholder=\"bye {{count}} - {{name}}\">`);\n       expect(fixture.nativeElement.innerHTML)\n-          .toEqual(`<input title=\"bonjour Angular\" placeholder=\"bonjour Angular\">`);\n+          .toEqual(`<input title=\"bonjour Angular - 0\" placeholder=\"au revoir 0 - Angular\">`);\n \n       fixture.componentRef.instance.name = 'John';\n+      fixture.componentRef.instance.count = 5;\n       fixture.detectChanges();\n       expect(fixture.nativeElement.innerHTML)\n-          .toEqual(`<input title=\"bonjour John\" placeholder=\"bonjour John\">`);\n+          .toEqual(`<input title=\"bonjour John - 5\" placeholder=\"au revoir 5 - John\">`);\n     });\n \n     it('on removed elements', () => {"
        },
        {
            "sha": "572c5248a15dc3a04bdec9d3db01092cc7b8ddc7",
            "filename": "packages/core/test/render3/i18n/i18n_spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/9b4b281c5223084834019664fbe5248521caadae/packages%2Fcore%2Ftest%2Frender3%2Fi18n%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9b4b281c5223084834019664fbe5248521caadae/packages%2Fcore%2Ftest%2Frender3%2Fi18n%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fi18n%2Fi18n_spec.ts?ref=9b4b281c5223084834019664fbe5248521caadae",
            "patch": "@@ -458,9 +458,10 @@ describe('Runtime i18n', () => {\n     });\n \n     it('for multiple attributes', () => {\n-      const message = `Hello �0�!`;\n-      const attrs = ['title', message, 'aria-label', message];\n-      const nbConsts = 2;\n+      const message1 = `Hello �0� - �1�!`;\n+      const message2 = `Bye �0� - �1�!`;\n+      const attrs = ['title', message1, 'aria-label', message2];\n+      const nbConsts = 4;\n       const index = 1;\n       const opCodes = getOpCodes(attrs, () => {\n         ɵɵelementStart(0, 'div');\n@@ -469,11 +470,10 @@ describe('Runtime i18n', () => {\n       }, undefined, nbConsts, HEADER_OFFSET + index);\n \n       expect(opCodes).toEqual(matchDebug([\n-        `if (mask & 0b1) { (lView[${\n-            HEADER_OFFSET + 0}] as Element).setAttribute('title', \\`Hello \\$\\{lView[i-1]}!\\`); }`,\n-        `if (mask & 0b1) { (lView[${\n-            HEADER_OFFSET +\n-            0}] as Element).setAttribute('aria-label', \\`Hello \\$\\{lView[i-1]}!\\`); }`,\n+        `if (mask & 0b11) { (lView[${HEADER_OFFSET + 0}] as Element).` +\n+            'setAttribute(\\'title\\', `Hello ${lView[i-1]} - ${lView[i-2]}!`); }',\n+        `if (mask & 0b1100) { (lView[${HEADER_OFFSET + 0}] as Element).` +\n+            'setAttribute(\\'aria-label\\', `Bye ${lView[i-3]} - ${lView[i-4]}!`); }',\n       ]));\n     });\n   });"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 57,
        "deletions": 22
    }
}