{
    "author": "gkalpak",
    "message": "fix(service-worker): correctly determine client ID on navigation requests (#42607)\n\nThe ServiceWorker assigns an app-version to a each client to ensure that\nall subsequent requests for a client are served using the same\napp-version. The assignment is done based on the client ID.\n\nPreviously, the ServiceWorker would only try to read the client's ID off\nof the `FetchEvent`'s `clientId` property. However, for navigation\nrequests the new client's ID will be set on [resultingClientId][1],\nwhile `clientId` will either be empty or hold the ID of the client where\nthe request initiated from. See also related discussions in\nw3c/ServiceWorker#870 and w3c/ServiceWorker#1266.\n\nIn theory, this could lead to the navigation request (i.e. `index.html`)\nbeing served from a different app-version than the subsequent\nsub-resource requests (i.e. assets). In practice, the likelihood of this\nhappening is probably very low though, since it would require the latest\napp-version to be updated between the initial navigation request and the\nfirst sub-resource request, which should happen very shortly after the\nnavigation request.\n\nThis commit ensures that the correct client ID is determined even for\nnavigation requests by also taking the `resultingClientId` property into\naccount.\n\n[1]: https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/resultingClientId\n\nPR Close #42607",
    "sha": "9498da1038ffa854effa672fac3a898039853375",
    "files": [
        {
            "sha": "bcecf3b00239ac896b5370dc007eac4e535dc2e7",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=9498da1038ffa854effa672fac3a898039853375",
            "patch": "@@ -609,7 +609,10 @@ export class Driver implements Debuggable, UpdateSource {\n   private async assignVersion(event: FetchEvent): Promise<AppVersion|null> {\n     // First, check whether the event has a (non empty) client ID. If it does, the version may\n     // already be associated.\n-    const clientId = event.clientId;\n+    //\n+    // NOTE: For navigation requests, we care about the `resultingClientId`. If it is undefined or\n+    //       the empty string (which is the case for sub-resource requests), we look at `clientId`.\n+    const clientId = event.resultingClientId || event.clientId;\n     if (clientId) {\n       // Check if there is an assigned client id.\n       if (this.clientVersionMap.has(clientId)) {"
        },
        {
            "sha": "71281d3679871a1764a362c51bdde97b3b003fbd",
            "filename": "packages/service-worker/worker/src/service-worker.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts?ref=9498da1038ffa854effa672fac3a898039853375",
            "patch": "@@ -60,8 +60,9 @@ type WindowClientState = 'hidden'|'visible'|'prerender'|'unloaded';\n // Fetch API\n \n interface FetchEvent extends ExtendableEvent {\n-  clientId: string|null;\n   request: Request;\n+  clientId?: string;\n+  resultingClientId?: string;\n   respondWith(response: Promise<Response>|Response): Promise<Response>;\n }\n "
        },
        {
            "sha": "5f191e7204a685ab7a3174008fda5150fd72e92a",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=9498da1038ffa854effa672fac3a898039853375",
            "patch": "@@ -538,7 +538,6 @@ describe('Driver', () => {\n   it('handles empty client ID', async () => {\n     // Initialize the SW.\n     expect(await makeNavigationRequest(scope, '/foo/file1', '')).toEqual('this is foo');\n-    expect(await makeNavigationRequest(scope, '/bar/file2', null)).toEqual('this is foo');\n     await driver.initialized;\n \n     // Update to a new version.\n@@ -547,7 +546,6 @@ describe('Driver', () => {\n \n     // Correctly handle navigation requests, even if `clientId` is null/empty.\n     expect(await makeNavigationRequest(scope, '/foo/file1', '')).toEqual('this is foo v2');\n-    expect(await makeNavigationRequest(scope, '/bar/file2', null)).toEqual('this is foo v2');\n   });\n \n   it('checks for updates on restart', async () => {\n@@ -2008,8 +2006,7 @@ async function removeAssetFromCache(\n }\n \n async function makeRequest(\n-    scope: SwTestHarness, url: string, clientId: string|null = 'default',\n-    init?: Object): Promise<string|null> {\n+    scope: SwTestHarness, url: string, clientId = 'default', init?: Object): Promise<string|null> {\n   const [resPromise, done] = scope.handleFetch(new MockRequest(url, init), clientId);\n   await done;\n   const res = await resPromise;\n@@ -2020,8 +2017,7 @@ async function makeRequest(\n }\n \n function makeNavigationRequest(\n-    scope: SwTestHarness, url: string, clientId?: string|null,\n-    init: Object = {}): Promise<string|null> {\n+    scope: SwTestHarness, url: string, clientId?: string, init: Object = {}): Promise<string|null> {\n   return makeRequest(scope, url, clientId, {\n     headers: {\n       Accept: 'text/plain, text/html, text/css',"
        },
        {
            "sha": "96eb23d5c9076b167f7c412be282e3854e158120",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/9498da1038ffa854effa672fac3a898039853375/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=9498da1038ffa854effa672fac3a898039853375",
            "patch": "@@ -219,12 +219,14 @@ export class SwTestHarness extends Adapter implements ServiceWorkerGlobalScope,\n \n   waitUntil(promise: Promise<void>): void {}\n \n-  handleFetch(req: Request, clientId: string|null = null):\n-      [Promise<Response|undefined>, Promise<void>] {\n+  handleFetch(req: Request, clientId = ''): [Promise<Response|undefined>, Promise<void>] {\n     if (!this.eventHandlers.has('fetch')) {\n       throw new Error('No fetch handler registered');\n     }\n-    const event = new MockFetchEvent(req, clientId);\n+\n+    const isNavigation = req.mode === 'navigate';\n+    const event = isNavigation ? new MockFetchEvent(req, '', clientId) :\n+                                 new MockFetchEvent(req, clientId, '');\n     this.eventHandlers.get('fetch')!.call(this, event);\n \n     if (clientId) {\n@@ -373,7 +375,8 @@ class MockExtendableEvent extends OneTimeContext {}\n class MockFetchEvent extends MockExtendableEvent {\n   response: Promise<Response|undefined> = Promise.resolve(undefined);\n \n-  constructor(readonly request: Request, readonly clientId: string|null) {\n+  constructor(\n+      readonly request: Request, readonly clientId: string, readonly resultingClientId: string) {\n     super();\n   }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 15,
        "deletions": 12
    }
}