{
    "author": "gkalpak",
    "message": "refactor(docs-infra): move `deploy-to-firebase` post-deploy actions to a separate file (#43963)\n\nMove some functions that are used as post-deploy actions from\n`deploy-to-firebase/index.mjs` to a separate file\n(`deploy-to-firebase/post-deploy-actions.mjs`) to keep `index.mjs` small\nand easier to maintain.\n\nNOTE:\nWhile not strictly necessary atm, `post-deploy-actions.mjs` uses the\nsame default export pattern for consistency with `utils.mjs`.\n\nPR Close #43963",
    "sha": "23b7543dca44e88b613c7f37a5bbe2e6624f2e59",
    "files": [
        {
            "sha": "1bd6cb83b163e719bb60c55bdb8ab6a4940249d9",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "modified",
            "additions": 6,
            "deletions": 51,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/23b7543dca44e88b613c7f37a5bbe2e6624f2e59/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/23b7543dca44e88b613c7f37a5bbe2e6624f2e59/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=23b7543dca44e88b613c7f37a5bbe2e6624f2e59",
            "patch": "@@ -5,6 +5,7 @@\n \n import sh from 'shelljs';\n import {fileURLToPath} from 'url';\n+import post from './post-deploy-actions.mjs';\n import pre from './pre-deploy-actions.mjs';\n import u from './utils.mjs';\n \n@@ -100,7 +101,7 @@ function computeDeploymentsInfo(\n       siteId: 'next-angular-io-site',\n       deployedUrl: 'https://next.angular.io/',\n       preDeployActions: [pre.build, pre.checkPayloadSize],\n-      postDeployActions: [testPwaScore],\n+      postDeployActions: [post.testPwaScore],\n     },\n     rc: {\n       name: 'rc',\n@@ -110,7 +111,7 @@ function computeDeploymentsInfo(\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n       preDeployActions: [pre.build, pre.checkPayloadSize],\n-      postDeployActions: [testPwaScore],\n+      postDeployActions: [post.testPwaScore],\n     },\n     stable: {\n       name: 'stable',\n@@ -120,7 +121,7 @@ function computeDeploymentsInfo(\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: 'https://angular.io/',\n       preDeployActions: [pre.build, pre.checkPayloadSize],\n-      postDeployActions: [testPwaScore],\n+      postDeployActions: [post.testPwaScore],\n     },\n     archive: {\n       name: 'archive',\n@@ -130,7 +131,7 @@ function computeDeploymentsInfo(\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n       preDeployActions: [pre.build, pre.checkPayloadSize],\n-      postDeployActions: [testPwaScore],\n+      postDeployActions: [post.testPwaScore],\n     },\n \n     // SECONDARY DEPLOY TARGETS\n@@ -151,7 +152,7 @@ function computeDeploymentsInfo(\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n       preDeployActions: [pre.disableServiceWorker, pre.redirectToAngularIo],\n-      postDeployActions: [testNoActiveRcDeployment],\n+      postDeployActions: [post.testNoActiveRcDeployment],\n     },\n   };\n \n@@ -279,52 +280,6 @@ function skipDeployment(reason) {\n   return {name: 'skipped', type: 'skipped', reason};\n }\n \n-function testNoActiveRcDeployment({deployedUrl}) {\n-  u.logSectionHeader(\n-      'Verify deployed RC version redirects to stable (and disables old ServiceWorker).');\n-\n-  const deployedOrigin = deployedUrl.replace(/\\/$/, '');\n-\n-  // Ensure a request for `ngsw.json` returns 404.\n-  const ngswJsonUrl = `${deployedOrigin}/ngsw.json`;\n-  const ngswJsonScript = `https.get('${ngswJsonUrl}', res => console.log(res.statusCode))`;\n-  const ngswJsonActualStatusCode =\n-      sh.exec(`node --eval \"${ngswJsonScript}\"`, {silent: true}).trim();\n-  const ngswJsonExpectedStatusCode = '404';\n-\n-  if (ngswJsonActualStatusCode !== ngswJsonExpectedStatusCode) {\n-    throw new Error(\n-        `Expected '${ngswJsonUrl}' to return a status code of '${ngswJsonExpectedStatusCode}', ` +\n-        `but it returned '${ngswJsonActualStatusCode}'.`);\n-  }\n-\n-  // Ensure a request for `foo/bar` is redirected to `https://angular.io/foo/bar`.\n-  const fooBarUrl = `${deployedOrigin}/foo/bar?baz=qux`;\n-  const fooBarScript =\n-      `https.get('${fooBarUrl}', res => console.log(res.statusCode, res.headers.location))`;\n-  const [fooBarActualStatusCode, fooBarActualRedirectUrl] =\n-      sh.exec(`node --eval \"${fooBarScript}\"`, {silent: true}).trim().split(' ');\n-  const fooBarExpectedStatusCode = '302';\n-  const fooBarExpectedRedirectUrl = 'https://angular.io/foo/bar?baz=qux';\n-\n-  if (fooBarActualStatusCode !== fooBarExpectedStatusCode) {\n-    throw new Error(\n-        `Expected '${fooBarUrl}' to return a status code of '${fooBarExpectedStatusCode}', but ` +\n-        `it returned '${fooBarActualStatusCode}'.`);\n-  } else if (fooBarActualRedirectUrl !== fooBarExpectedRedirectUrl) {\n-    const actualBehavior = (fooBarActualRedirectUrl === 'undefined') ?\n-      'not redirected' : `redirected to '${fooBarActualRedirectUrl}'`;\n-    throw new Error(\n-        `Expected '${fooBarUrl}' to be redirected to '${fooBarExpectedRedirectUrl}', but it was ` +\n-        `${actualBehavior}.`);\n-  }\n-}\n-\n-function testPwaScore({deployedUrl, minPwaScore}) {\n-  u.logSectionHeader('Run PWA-score tests.');\n-  u.yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n-}\n-\n function validateDeploymentsInfo(deploymentsList) {\n   const knownTargetTypes = ['primary', 'secondary', 'skipped'];\n   const requiredPropertiesForSkipped = ['name', 'type', 'reason'];"
        },
        {
            "sha": "7dd3911d6eb559b9c7c4b61310cba88182a0f8c2",
            "filename": "aio/scripts/deploy-to-firebase/post-deploy-actions.mjs",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/23b7543dca44e88b613c7f37a5bbe2e6624f2e59/aio%2Fscripts%2Fdeploy-to-firebase%2Fpost-deploy-actions.mjs",
            "raw_url": "https://github.com/angular/angular/raw/23b7543dca44e88b613c7f37a5bbe2e6624f2e59/aio%2Fscripts%2Fdeploy-to-firebase%2Fpost-deploy-actions.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpost-deploy-actions.mjs?ref=23b7543dca44e88b613c7f37a5bbe2e6624f2e59",
            "patch": "@@ -0,0 +1,57 @@\n+import sh from 'shelljs';\n+import u from './utils.mjs';\n+\n+\n+// Exports\n+const exp = {\n+  testNoActiveRcDeployment,\n+  testPwaScore,\n+};\n+export default exp;\n+\n+// Helpers\n+function testNoActiveRcDeployment({deployedUrl}) {\n+  u.logSectionHeader(\n+      'Verify deployed RC version redirects to stable (and disables old ServiceWorker).');\n+\n+  const deployedOrigin = deployedUrl.replace(/\\/$/, '');\n+\n+  // Ensure a request for `ngsw.json` returns 404.\n+  const ngswJsonUrl = `${deployedOrigin}/ngsw.json`;\n+  const ngswJsonScript = `https.get('${ngswJsonUrl}', res => console.log(res.statusCode))`;\n+  const ngswJsonActualStatusCode =\n+      sh.exec(`node --eval \"${ngswJsonScript}\"`, {silent: true}).trim();\n+  const ngswJsonExpectedStatusCode = '404';\n+\n+  if (ngswJsonActualStatusCode !== ngswJsonExpectedStatusCode) {\n+    throw new Error(\n+        `Expected '${ngswJsonUrl}' to return a status code of '${ngswJsonExpectedStatusCode}', ` +\n+        `but it returned '${ngswJsonActualStatusCode}'.`);\n+  }\n+\n+  // Ensure a request for `foo/bar` is redirected to `https://angular.io/foo/bar`.\n+  const fooBarUrl = `${deployedOrigin}/foo/bar?baz=qux`;\n+  const fooBarScript =\n+      `https.get('${fooBarUrl}', res => console.log(res.statusCode, res.headers.location))`;\n+  const [fooBarActualStatusCode, fooBarActualRedirectUrl] =\n+      sh.exec(`node --eval \"${fooBarScript}\"`, {silent: true}).trim().split(' ');\n+  const fooBarExpectedStatusCode = '302';\n+  const fooBarExpectedRedirectUrl = 'https://angular.io/foo/bar?baz=qux';\n+\n+  if (fooBarActualStatusCode !== fooBarExpectedStatusCode) {\n+    throw new Error(\n+        `Expected '${fooBarUrl}' to return a status code of '${fooBarExpectedStatusCode}', but ` +\n+        `it returned '${fooBarActualStatusCode}'.`);\n+  } else if (fooBarActualRedirectUrl !== fooBarExpectedRedirectUrl) {\n+    const actualBehavior = (fooBarActualRedirectUrl === 'undefined') ?\n+      'not redirected' : `redirected to '${fooBarActualRedirectUrl}'`;\n+    throw new Error(\n+        `Expected '${fooBarUrl}' to be redirected to '${fooBarExpectedRedirectUrl}', but it was ` +\n+        `${actualBehavior}.`);\n+  }\n+}\n+\n+function testPwaScore({deployedUrl, minPwaScore}) {\n+  u.logSectionHeader('Run PWA-score tests.');\n+  u.yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n+}"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 63,
        "deletions": 51
    }
}