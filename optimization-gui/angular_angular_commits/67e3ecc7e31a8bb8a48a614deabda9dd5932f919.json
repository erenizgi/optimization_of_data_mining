{
    "author": "atscott",
    "message": "fix(dev-infra): Ensure conditions with groups do not fail verification (#37798)\n\nThere are a few changes in this PR to ensure conditions that are based\non groups (i.e. `- groups.pending.length == 0`) do not fail the verify\ntask:\n\n* Remove the warning when a condition is encountered that depends on the\n`groups` state. The warning will otherwise be printed once for every\nfile that triggers the execution of the condition (400,000+ times)\n* Add an `unverifiable` flag to `GroupCondition` interface and set it to\ntrue when an error is encountered due to attempting to get the state of\n`groups` in a condition\n* Ignore any unverifiable conditions when gathering unmatched\nconditions. These should not be considered `unmatched` for verification\npurposes.\n* Print the unverifiable conditions by group in the results\n\nSample output:\n```\n\n┌──────────────────────────────────────────────────────────────────────────────┐\n│                         PullApprove results by group                         │\n└──────────────────────────────────────────────────────────────────────────────┘\nGroups skipped (4 groups)\nMatched conditions by Group (37 groups)\nUnmatched conditions by Group (0 groups)\nUnverifiable conditions by Group (3 groups)\n  [public-api]\n    len(groups.pending.exclude(\"required-minimum-review\")...\n    len(groups.rejected.exclude(\"required-minimum-review\")...\n  [size-tracking]\n    len(groups.pending.exclude(\"required-minimum-review\")...\n    len(groups.rejected.exclude(\"required-minimum-review\")...\n  [circular-dependencies]\n    len(groups.pending.exclude(\"required-minimum-review\")...\n    len(groups.rejected.exclude(\"required-minimum-review\")...\n\n```\n\nPR Close #37798",
    "sha": "67e3ecc7e31a8bb8a48a614deabda9dd5932f919",
    "files": [
        {
            "sha": "3aaeaf1cf60ffd2824c8295ac1fd8311e370e043",
            "filename": "dev-infra/pullapprove/group.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 11,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/67e3ecc7e31a8bb8a48a614deabda9dd5932f919/dev-infra%2Fpullapprove%2Fgroup.ts",
            "raw_url": "https://github.com/angular/angular/raw/67e3ecc7e31a8bb8a48a614deabda9dd5932f919/dev-infra%2Fpullapprove%2Fgroup.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpullapprove%2Fgroup.ts?ref=67e3ecc7e31a8bb8a48a614deabda9dd5932f919",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {error, warn} from '../utils/console';\n+import {error} from '../utils/console';\n import {convertConditionToFunction} from './condition_evaluator';\n import {PullApproveGroupConfig} from './parse-yaml';\n import {PullApproveGroupStateDependencyError} from './pullapprove_arrays';\n@@ -16,6 +16,7 @@ interface GroupCondition {\n   expression: string;\n   checkFn: (files: string[], groups: PullApproveGroup[]) => boolean;\n   matchedFiles: Set<string>;\n+  unverifiable: boolean;\n }\n \n /** Result of testing files against the group. */\n@@ -25,6 +26,7 @@ export interface PullApproveGroupResult {\n   matchedCount: number;\n   unmatchedConditions: GroupCondition[];\n   unmatchedCount: number;\n+  unverifiableConditions: GroupCondition[];\n }\n \n // Regular expression that matches conditions for the global approval.\n@@ -61,6 +63,7 @@ export class PullApproveGroup {\n             expression,\n             checkFn: convertConditionToFunction(expression),\n             matchedFiles: new Set(),\n+            unverifiable: false,\n           });\n         } catch (e) {\n           error(`Could not parse condition in group: ${this.groupName}`);\n@@ -79,24 +82,23 @@ export class PullApproveGroup {\n    * the pull approve group's conditions.\n    */\n   testFile(filePath: string): boolean {\n-    return this.conditions.every(({matchedFiles, checkFn, expression}) => {\n+    return this.conditions.every((condition) => {\n+      const {matchedFiles, checkFn, expression} = condition;\n       try {\n         const matchesFile = checkFn([filePath], this.precedingGroups);\n         if (matchesFile) {\n           matchedFiles.add(filePath);\n         }\n         return matchesFile;\n       } catch (e) {\n-        // In the case of a condition that depends on the state of groups we want to just\n-        // warn that the verification can't accurately evaluate the condition and then\n+        // In the case of a condition that depends on the state of groups we want to\n+        // ignore that the verification can't accurately evaluate the condition and then\n         // continue processing. Other types of errors fail the verification, as conditions\n         // should otherwise be able to execute without throwing.\n         if (e instanceof PullApproveGroupStateDependencyError) {\n-          const errMessage = `Condition could not be evaluated: \\n` +\n-              `${e.message}\\n` +\n-              `From the [${this.groupName}] group:\\n` +\n-              ` - ${expression}`;\n-          warn(errMessage);\n+          condition.unverifiable = true;\n+          // Return true so that `this.conditions.every` can continue evaluating.\n+          return true;\n         } else {\n           const errMessage = `Condition could not be evaluated: \\n\\n` +\n               `From the [${this.groupName}] group:\\n` +\n@@ -111,13 +113,16 @@ export class PullApproveGroup {\n \n   /** Retrieve the results for the Group, all matched and unmatched conditions. */\n   getResults(): PullApproveGroupResult {\n-    const matchedConditions = this.conditions.filter(c => !!c.matchedFiles.size);\n-    const unmatchedConditions = this.conditions.filter(c => !c.matchedFiles.size);\n+    const matchedConditions = this.conditions.filter(c => c.matchedFiles.size > 0);\n+    const unmatchedConditions =\n+        this.conditions.filter(c => c.matchedFiles.size === 0 && !c.unverifiable);\n+    const unverifiableConditions = this.conditions.filter(c => c.unverifiable);\n     return {\n       matchedConditions,\n       matchedCount: matchedConditions.length,\n       unmatchedConditions,\n       unmatchedCount: unmatchedConditions.length,\n+      unverifiableConditions,\n       groupName: this.groupName,\n     };\n   }"
        },
        {
            "sha": "573516e23e738886a6205355d6a6faa4d861f7a0",
            "filename": "dev-infra/pullapprove/logging.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/67e3ecc7e31a8bb8a48a614deabda9dd5932f919/dev-infra%2Fpullapprove%2Flogging.ts",
            "raw_url": "https://github.com/angular/angular/raw/67e3ecc7e31a8bb8a48a614deabda9dd5932f919/dev-infra%2Fpullapprove%2Flogging.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpullapprove%2Flogging.ts?ref=67e3ecc7e31a8bb8a48a614deabda9dd5932f919",
            "patch": "@@ -9,14 +9,23 @@\n import {info} from '../utils/console';\n import {PullApproveGroupResult} from './group';\n \n+type ConditionGrouping = keyof Pick<\n+    PullApproveGroupResult, 'matchedConditions'|'unmatchedConditions'|'unverifiableConditions'>;\n+\n /** Create logs for each pullapprove group result. */\n-export function logGroup(group: PullApproveGroupResult, matched = true, printMessageFn = info) {\n-  const conditions = matched ? group.matchedConditions : group.unmatchedConditions;\n+export function logGroup(\n+    group: PullApproveGroupResult, conditionsToPrint: ConditionGrouping, printMessageFn = info) {\n+  const conditions = group[conditionsToPrint];\n   printMessageFn.group(`[${group.groupName}]`);\n   if (conditions.length) {\n-    conditions.forEach(matcher => {\n-      const count = matcher.matchedFiles.size;\n-      printMessageFn(`${count} ${count === 1 ? 'match' : 'matches'} - ${matcher.expression}`);\n+    conditions.forEach(groupCondition => {\n+      const count = groupCondition.matchedFiles.size;\n+      if (conditionsToPrint === 'unverifiableConditions') {\n+        printMessageFn(`${groupCondition.expression}`);\n+      } else {\n+        printMessageFn(\n+            `${count} ${count === 1 ? 'match' : 'matches'} - ${groupCondition.expression}`);\n+      }\n     });\n     printMessageFn.groupEnd();\n   }"
        },
        {
            "sha": "167408338328f762dc793b69064cf5125b736b01",
            "filename": "dev-infra/pullapprove/verify.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/67e3ecc7e31a8bb8a48a614deabda9dd5932f919/dev-infra%2Fpullapprove%2Fverify.ts",
            "raw_url": "https://github.com/angular/angular/raw/67e3ecc7e31a8bb8a48a614deabda9dd5932f919/dev-infra%2Fpullapprove%2Fverify.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpullapprove%2Fverify.ts?ref=67e3ecc7e31a8bb8a48a614deabda9dd5932f919",
            "patch": "@@ -84,11 +84,16 @@ export function verify() {\n   info.groupEnd();\n   const matchedGroups = resultsByGroup.filter(group => !group.unmatchedCount);\n   info.group(`Matched conditions by Group (${matchedGroups.length} groups)`);\n-  matchedGroups.forEach(group => logGroup(group, true, debug));\n+  matchedGroups.forEach(group => logGroup(group, 'matchedConditions', debug));\n   info.groupEnd();\n   const unmatchedGroups = resultsByGroup.filter(group => group.unmatchedCount);\n   info.group(`Unmatched conditions by Group (${unmatchedGroups.length} groups)`);\n-  unmatchedGroups.forEach(group => logGroup(group, false));\n+  unmatchedGroups.forEach(group => logGroup(group, 'unmatchedConditions'));\n+  info.groupEnd();\n+  const unverifiableConditionsInGroups =\n+      resultsByGroup.filter(group => group.unverifiableConditions.length > 0);\n+  info.group(`Unverifiable conditions by Group (${unverifiableConditionsInGroups.length} groups)`);\n+  unverifiableConditionsInGroups.forEach(group => logGroup(group, 'unverifiableConditions'));\n   info.groupEnd();\n \n   // Provide correct exit code based on verification success."
        }
    ],
    "stats": {
        "total": 55,
        "additions": 37,
        "deletions": 18
    }
}