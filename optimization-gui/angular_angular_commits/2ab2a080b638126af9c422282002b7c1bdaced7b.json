{
    "author": "adrianliaw",
    "message": "fix(router): unset attachRef when router-outlet is destroyed to avoid mounting a destroyed component (#43697)\n\nPreviously, when a router-outlet is conditionally shown with an ngIf, and a sub-route was re-attached\nvia a custom RouteReuseStrategy, router-outlet would try to mount a destroyed component into the view\nif the router-outlet is destroyed and re-initialized.\n\nThis commit fixes it by unsetting context.attachRef when router-outlet is destroyed, so when the\nrouter-outlet is being initialized again, it no longer sees an attachRef that it needs to mount to the\nview.\n\nFixes #43696\n\nPR Close #43697",
    "sha": "2ab2a080b638126af9c422282002b7c1bdaced7b",
    "files": [
        {
            "sha": "94a3e76dcce1e020e4e4c7c9a28968b8c66566b3",
            "filename": "packages/router/src/router_outlet_context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/2ab2a080b638126af9c422282002b7c1bdaced7b/packages%2Frouter%2Fsrc%2Frouter_outlet_context.ts",
            "raw_url": "https://github.com/angular/angular/raw/2ab2a080b638126af9c422282002b7c1bdaced7b/packages%2Frouter%2Fsrc%2Frouter_outlet_context.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter_outlet_context.ts?ref=2ab2a080b638126af9c422282002b7c1bdaced7b",
            "patch": "@@ -50,6 +50,7 @@ export class ChildrenOutletContexts {\n     const context = this.getContext(childName);\n     if (context) {\n       context.outlet = null;\n+      context.attachRef = null;\n     }\n   }\n "
        },
        {
            "sha": "fbe0ad14e135764b0465bb3dd9e872e182c4701b",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/2ab2a080b638126af9c422282002b7c1bdaced7b/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2ab2a080b638126af9c422282002b7c1bdaced7b/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=2ab2a080b638126af9c422282002b7c1bdaced7b",
            "patch": "@@ -5941,6 +5941,59 @@ describe('Integration', () => {\n          advance(fixture);\n          expect(fixture).toContainComponent(Tool2Component, '(e)');\n        }));\n+\n+    it('should not remount a destroyed component', fakeAsync(() => {\n+         @Component({\n+           selector: 'root-cmp',\n+           template: '<div *ngIf=\"showRouterOutlet\"><router-outlet></router-outlet></div>'\n+         })\n+         class RootCmpWithCondOutlet {\n+           public showRouterOutlet: boolean = true;\n+         }\n+\n+         @NgModule({\n+           declarations: [RootCmpWithCondOutlet],\n+           imports: [\n+             CommonModule,\n+             RouterTestingModule.withRoutes([\n+               {path: 'a', component: SimpleCmp},\n+               {path: 'b', component: BlankCmp},\n+             ]),\n+           ],\n+           providers: [{provide: RouteReuseStrategy, useClass: AttachDetachReuseStrategy}]\n+         })\n+         class TestModule {\n+         }\n+         TestBed.configureTestingModule({imports: [TestModule]});\n+\n+         const router: Router = TestBed.inject(Router);\n+         const fixture = createRoot(router, RootCmpWithCondOutlet);\n+\n+         // Activate 'a'\n+         router.navigate(['a']);\n+         advance(fixture);\n+         expect(fixture.debugElement.query(By.directive(SimpleCmp))).toBeTruthy();\n+\n+         // Deactivate 'a' and detach the route\n+         router.navigate(['b']);\n+         advance(fixture);\n+         expect(fixture.debugElement.query(By.directive(SimpleCmp))).toBeNull();\n+\n+         // Activate 'a' again, the route should be re-attached\n+         router.navigate(['a']);\n+         advance(fixture);\n+         expect(fixture.debugElement.query(By.directive(SimpleCmp))).toBeTruthy();\n+\n+         // Hide the router-outlet, SimpleCmp should be destroyed\n+         fixture.componentInstance.showRouterOutlet = false;\n+         advance(fixture);\n+         expect(fixture.debugElement.query(By.directive(SimpleCmp))).toBeNull();\n+\n+         // Show the router-outlet, SimpleCmp should be re-created\n+         fixture.componentInstance.showRouterOutlet = true;\n+         advance(fixture);\n+         expect(fixture.debugElement.query(By.directive(SimpleCmp))).toBeTruthy();\n+       }));\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 54,
        "additions": 54,
        "deletions": 0
    }
}