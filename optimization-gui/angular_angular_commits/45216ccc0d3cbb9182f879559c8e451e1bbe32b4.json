{
    "author": "atscott",
    "message": "fix(language-service): Only provide dom completions for inline templates (#41078)\n\nWe currently provide completions for DOM elements in the schema as well\nas attributes when we are in the context of an external template.\nHowever, these completions are already provided by other extensions for\nHTML contexts (like Emmet). To avoid duplication of results, this commit\nupdates the language service to exclude DOM completions for external\ntemplates. They are still provided for inline templates because those\nare not handled by the HTML language extensions.\n\nPR Close #41078",
    "sha": "45216ccc0d3cbb9182f879559c8e451e1bbe32b4",
    "files": [
        {
            "sha": "295013862dff783dfbfae80dbe59dec9d81d4b5d",
            "filename": "packages/language-service/ivy/attribute_completions.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts",
            "raw_url": "https://github.com/angular/angular/raw/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts?ref=45216ccc0d3cbb9182f879559c8e451e1bbe32b4",
            "patch": "@@ -180,7 +180,8 @@ export type AttributeCompletion = DomAttributeCompletion|DomPropertyCompletion|\n  */\n export function buildAttributeCompletionTable(\n     component: ts.ClassDeclaration, element: TmplAstElement|TmplAstTemplate,\n-    checker: TemplateTypeChecker): Map<string, AttributeCompletion> {\n+    checker: TemplateTypeChecker,\n+    includeDomSchemaAttributes: boolean): Map<string, AttributeCompletion> {\n   const table = new Map<string, AttributeCompletion>();\n \n   // Use the `ElementSymbol` or `TemplateSymbol` to iterate over directives present on the node, and\n@@ -332,7 +333,7 @@ export function buildAttributeCompletionTable(\n   }\n \n   // Finally, add any DOM attributes not already covered by inputs.\n-  if (element instanceof TmplAstElement) {\n+  if (element instanceof TmplAstElement && includeDomSchemaAttributes) {\n     for (const {attribute, property} of checker.getPotentialDomBindings(element.name)) {\n       const isAlsoProperty = attribute === property;\n       if (!table.has(attribute)) {"
        },
        {
            "sha": "8c471a1a9fe7c2540ca391eee3b028835fa1ce1a",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 12,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=45216ccc0d3cbb9182f879559c8e451e1bbe32b4",
            "patch": "@@ -57,7 +57,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n   constructor(\n       private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,\n       private readonly component: ts.ClassDeclaration, private readonly node: N,\n-      private readonly targetDetails: TemplateTarget) {}\n+      private readonly targetDetails: TemplateTarget, private readonly inlineTemplate: boolean) {}\n \n   /**\n    * Analogue for `ts.LanguageService.getCompletionsAtPosition`.\n@@ -370,14 +370,18 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n \n     const replacementSpan: ts.TextSpan = {start, length};\n \n-    const entries: ts.CompletionEntry[] =\n-        Array.from(templateTypeChecker.getPotentialElementTags(this.component))\n-            .map(([tag, directive]) => ({\n-                   kind: tagCompletionKind(directive),\n-                   name: tag,\n-                   sortText: tag,\n-                   replacementSpan,\n-                 }));\n+    let potentialTags = Array.from(templateTypeChecker.getPotentialElementTags(this.component));\n+    if (!this.inlineTemplate) {\n+      // If we are in an external template, don't provide non-Angular tags (directive === null)\n+      // because we expect other extensions (i.e. Emmet) to provide those for HTML files.\n+      potentialTags = potentialTags.filter(([_, directive]) => directive !== null);\n+    }\n+    const entries: ts.CompletionEntry[] = potentialTags.map(([tag, directive]) => ({\n+                                                              kind: tagCompletionKind(directive),\n+                                                              name: tag,\n+                                                              sortText: tag,\n+                                                              replacementSpan,\n+                                                            }));\n \n     return {\n       entries,\n@@ -458,7 +462,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n \n     const attrTable = buildAttributeCompletionTable(\n-        this.component, element, this.compiler.getTemplateTypeChecker());\n+        this.component, element, this.compiler.getTemplateTypeChecker(), this.inlineTemplate);\n \n     let entries: ts.CompletionEntry[] = [];\n \n@@ -532,7 +536,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n \n     const attrTable = buildAttributeCompletionTable(\n-        this.component, element, this.compiler.getTemplateTypeChecker());\n+        this.component, element, this.compiler.getTemplateTypeChecker(), this.inlineTemplate);\n \n     if (!attrTable.has(name)) {\n       return undefined;\n@@ -599,7 +603,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n \n     const attrTable = buildAttributeCompletionTable(\n-        this.component, element, this.compiler.getTemplateTypeChecker());\n+        this.component, element, this.compiler.getTemplateTypeChecker(), this.inlineTemplate);\n \n     if (!attrTable.has(name)) {\n       return undefined;"
        },
        {
            "sha": "7167dbeb751539c559eab3bb1c1b1cf23c15834f",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=45216ccc0d3cbb9182f879559c8e451e1bbe32b4",
            "patch": "@@ -201,7 +201,8 @@ export class LanguageService {\n         positionDetails.context.nodes[0] :\n         positionDetails.context.node;\n     return new CompletionBuilder(\n-        this.tsLS, compiler, templateInfo.component, node, positionDetails);\n+        this.tsLS, compiler, templateInfo.component, node, positionDetails,\n+        isTypeScriptFile(fileName));\n   }\n \n   getCompletionsAtPosition("
        },
        {
            "sha": "ff7ad570a067b5ce4363a9b8cb5672af1b0bb442",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 10,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/45216ccc0d3cbb9182f879559c8e451e1bbe32b4/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=45216ccc0d3cbb9182f879559c8e451e1bbe32b4",
            "patch": "@@ -299,10 +299,19 @@ describe('completions', () => {\n   });\n \n   describe('element tag scope', () => {\n-    it('should return DOM completions', () => {\n+    it('should not return DOM completions for external template', () => {\n       const {templateFile} = setup(`<div>`, '');\n       templateFile.moveCursorToText('<div¦>');\n       const completions = templateFile.getCompletionsAtPosition();\n+      expectDoesNotContain(\n+          completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ELEMENT),\n+          ['div', 'span']);\n+    });\n+\n+    it('should return DOM completions', () => {\n+      const {appFile} = setupInlineTemplate(`<div>`, '');\n+      appFile.moveCursorToText('<div¦>');\n+      const completions = appFile.getCompletionsAtPosition();\n       expectContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ELEMENT),\n           ['div', 'span']);\n@@ -422,11 +431,19 @@ describe('completions', () => {\n \n     describe('element attribute scope', () => {\n       describe('dom completions', () => {\n-        it('should return completions for a new element attribute', () => {\n+        it('should not return completions dom completions in external template', () => {\n           const {templateFile} = setup(`<input >`, '');\n           templateFile.moveCursorToText('<input ¦>');\n \n           const completions = templateFile.getCompletionsAtPosition();\n+          expect(completions?.entries.length).toBe(0);\n+        });\n+\n+        it('should return completions for a new element attribute', () => {\n+          const {appFile} = setupInlineTemplate(`<input >`, '');\n+          appFile.moveCursorToText('<input ¦>');\n+\n+          const completions = appFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n@@ -436,24 +453,24 @@ describe('completions', () => {\n         });\n \n         it('should return completions for a partial attribute', () => {\n-          const {templateFile} = setup(`<input val>`, '');\n-          templateFile.moveCursorToText('<input val¦>');\n+          const {appFile} = setupInlineTemplate(`<input val>`, '');\n+          appFile.moveCursorToText('<input val¦>');\n \n-          const completions = templateFile.getCompletionsAtPosition();\n+          const completions = appFile.getCompletionsAtPosition();\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['[value]']);\n-          expectReplacementText(completions, templateFile.contents, 'val');\n+          expectReplacementText(completions, appFile.contents, 'val');\n         });\n \n         it('should return completions for a partial property binding', () => {\n-          const {templateFile} = setup(`<input [val]>`, '');\n-          templateFile.moveCursorToText('[val¦]');\n+          const {appFile} = setupInlineTemplate(`<input [val]>`, '');\n+          appFile.moveCursorToText('[val¦]');\n \n-          const completions = templateFile.getCompletionsAtPosition();\n+          const completions = appFile.getCompletionsAtPosition();\n           expectDoesNotContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n@@ -463,7 +480,7 @@ describe('completions', () => {\n           expectContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['value']);\n-          expectReplacementText(completions, templateFile.contents, 'val');\n+          expectReplacementText(completions, appFile.contents, 'val');\n         });\n       });\n \n@@ -779,3 +796,35 @@ function setup(\n   });\n   return {templateFile: project.openFile('test.html')};\n }\n+\n+function setupInlineTemplate(\n+    template: string, classContents: string, otherDeclarations: {[name: string]: string} = {}): {\n+  appFile: OpenBuffer,\n+} {\n+  const decls = ['AppCmp', ...Object.keys(otherDeclarations)];\n+\n+  const otherDirectiveClassDecls = Object.values(otherDeclarations).join('\\n\\n');\n+\n+  const env = LanguageServiceTestEnv.setup();\n+  const project = env.addProject('test', {\n+    'test.ts': `\n+        import {Component, Directive, NgModule, Pipe, TemplateRef} from '@angular/core';\n+\n+        @Component({\n+          template: '${template}',\n+          selector: 'app-cmp',\n+        })\n+        export class AppCmp {\n+          ${classContents}\n+        }\n+        \n+        ${otherDirectiveClassDecls}\n+\n+        @NgModule({\n+          declarations: [${decls.join(', ')}],\n+        })\n+        export class AppModule {}\n+        `,\n+  });\n+  return {appFile: project.openFile('test.ts')};\n+}"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 80,
        "deletions": 25
    }
}