{
    "author": "crisbeto",
    "message": "fix(compiler): generate view restoration for keyed write inside template listener (#42603)\n\nIf an implcit receiver is accessed in a listener inside of an `ng-template`, we generate some extra code in order to ensure that we're assigning to the correct object. The problem is that the logic wasn't covering keyed writes which caused it to write to the wrong object and throw an assertion error at runtime.\n\nThese changes expand the logic to cover keyed writes.\n\nFixes #41267.\n\nPR Close #42603",
    "sha": "f52df99fe369854c4ee49e3c01afa29cf2ae7126",
    "files": [
        {
            "sha": "b2ce2b31a0a9542fc02b19384b6b240874f0dab4",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -584,3 +584,55 @@ i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDE\n  ****************************************************************************************************/\n export {};\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: implicit_receiver_keyed_write_inside_template.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyComponent {\n+    constructor() {\n+        this.message = '';\n+    }\n+}\n+MyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `\n+    <ng-template #template>\n+      <button (click)=\"this['mes' + 'sage'] = 'hello'\">Click me</button>\n+    </ng-template>\n+  `, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, decorators: [{\n+            type: Component,\n+            args: [{\n+                    selector: 'my-component',\n+                    template: `\n+    <ng-template #template>\n+      <button (click)=\"this['mes' + 'sage'] = 'hello'\">Click me</button>\n+    </ng-template>\n+  `\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [MyComponent] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [MyComponent] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: implicit_receiver_keyed_write_inside_template.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyComponent {\n+    message: string;\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyComponent, \"my-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof MyComponent], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+"
        },
        {
            "sha": "992de375c80837c0ac66f7d029ebc1263d25f854",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/TEST_CASES.json",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FTEST_CASES.json?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -264,6 +264,23 @@\n           \"failureMessage\": \"Incorrect event listener\"\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should generate the view restoration statements if a keyed write is used in an event listener from within an ng-template\",\n+      \"inputFiles\": [\n+        \"implicit_receiver_keyed_write_inside_template.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"files\": [\n+            {\n+              \"expected\": \"implicit_receiver_keyed_write_inside_template_template.js\",\n+              \"generated\": \"implicit_receiver_keyed_write_inside_template.js\"\n+            }\n+          ],\n+          \"failureMessage\": \"Incorrect template\"\n+        }\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "63ff6a62cdb673da99d861b0f4b553fe68cf264e",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/implicit_receiver_keyed_write_inside_template.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fimplicit_receiver_keyed_write_inside_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fimplicit_receiver_keyed_write_inside_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fimplicit_receiver_keyed_write_inside_template.ts?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -0,0 +1,17 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  selector: 'my-component',\n+  template: `\n+    <ng-template #template>\n+      <button (click)=\"this['mes' + 'sage'] = 'hello'\">Click me</button>\n+    </ng-template>\n+  `\n+})\n+export class MyComponent {\n+  message = '';\n+}\n+\n+@NgModule({declarations: [MyComponent]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "bac6f514713950912351cc8bea7e6211554d25e8",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/implicit_receiver_keyed_write_inside_template_template.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fimplicit_receiver_keyed_write_inside_template_template.js",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fimplicit_receiver_keyed_write_inside_template_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2Fimplicit_receiver_keyed_write_inside_template_template.js?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -0,0 +1,13 @@\n+function MyComponent_ng_template_0_Template(rf, $ctx$) {\n+  if (rf & 1) {\n+    const _r3 = $i0$.ɵɵgetCurrentView();\n+    $i0$.ɵɵelementStart(0, \"button\", 1);\n+    $i0$.ɵɵlistener(\"click\", function MyComponent_ng_template_0_Template_button_click_0_listener() {\n+      $i0$.ɵɵrestoreView(_r3);\n+      const $ctx_2$ = $i0$.ɵɵnextContext();\n+      return ($ctx_2$[\"mes\" + \"sage\"] = \"hello\");\n+    });\n+    $i0$.ɵɵtext(1, \"Click me\");\n+    $i0$.ɵɵelementEnd();\n+  }\n+}"
        },
        {
            "sha": "cd0b50f4b447be4bc6861a25b990216d2ef23072",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -19,6 +19,7 @@ export interface LocalResolver {\n   getLocal(name: string): o.Expression|null;\n   notifyImplicitReceiverUse(): void;\n   globals?: Set<string>;\n+  maybeRestoreView(retrievalLevel: number, localRefLookup: boolean): void;\n }\n \n export class ConvertActionBindingResult {\n@@ -487,6 +488,11 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     const obj: o.Expression = this._visit(ast.receiver, _Mode.Expression);\n     const key: o.Expression = this._visit(ast.key, _Mode.Expression);\n     const value: o.Expression = this._visit(ast.value, _Mode.Expression);\n+\n+    if (obj === this._implicitReceiver) {\n+      this._localResolver.maybeRestoreView(0, false);\n+    }\n+\n     return convertToStatementIfNeeded(mode, obj.key(key).set(value));\n   }\n \n@@ -982,6 +988,7 @@ function flattenStatements(arg: any, output: o.Statement[]) {\n class DefaultLocalResolver implements LocalResolver {\n   constructor(public globals?: Set<string>) {}\n   notifyImplicitReceiverUse(): void {}\n+  maybeRestoreView(): void {}\n   getLocal(name: string): o.Expression|null {\n     if (name === EventHandlerVars.event.name) {\n       return EventHandlerVars.event;"
        },
        {
            "sha": "e4ed819a7f966214ed6128780d6695890712332c",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -339,6 +339,11 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n     this._bindingScope.notifyImplicitReceiverUse();\n   }\n \n+  // LocalResolver\n+  maybeRestoreView(retrievalLevel: number, localRefLookup: boolean): void {\n+    this._bindingScope.maybeRestoreView(retrievalLevel, localRefLookup);\n+  }\n+\n   private i18nTranslate(\n       message: i18n.Message, params: {[name: string]: o.Expression} = {}, ref?: o.ReadVarExpr,\n       transformFn?: (raw: o.ReadVarExpr) => o.Expression): o.ReadVarExpr {"
        },
        {
            "sha": "9518b0a77d924674978964ed10dde7d65cb1d513",
            "filename": "packages/compiler/src/view_compiler/type_check_compiler.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Fview_compiler%2Ftype_check_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Fview_compiler%2Ftype_check_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fview_compiler%2Ftype_check_compiler.ts?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -78,6 +78,7 @@ const DYNAMIC_VAR_NAME = '_any';\n \n class TypeCheckLocalResolver implements LocalResolver {\n   notifyImplicitReceiverUse(): void {}\n+  maybeRestoreView(): void {}\n   getLocal(name: string): o.Expression|null {\n     if (name === EventHandlerVars.event.name) {\n       // References to the event should not be type-checked.\n@@ -290,6 +291,8 @@ class ViewBuilder implements TemplateAstVisitor, LocalResolver {\n   }\n \n   notifyImplicitReceiverUse(): void {}\n+  maybeRestoreView(): void {}\n+\n   getLocal(name: string): o.Expression|null {\n     if (name == EventHandlerVars.event.name) {\n       return o.variable(this.getOutputVar(o.BuiltinTypeName.Dynamic));"
        },
        {
            "sha": "e8c4ef6ba9e6fd789cd9b0f35d6f94ea7ea94910",
            "filename": "packages/compiler/src/view_compiler/view_compiler.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Fview_compiler%2Fview_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcompiler%2Fsrc%2Fview_compiler%2Fview_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fview_compiler%2Fview_compiler.ts?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -680,11 +680,15 @@ class ViewBuilder implements TemplateAstVisitor, LocalResolver {\n   }\n \n   notifyImplicitReceiverUse(): void {\n-    // Not needed in View Engine as View Engine walks through the generated\n+    // Not needed in ViewEngine as ViewEngine walks through the generated\n     // expressions to figure out if the implicit receiver is used and needs\n     // to be generated as part of the pre-update statements.\n   }\n \n+  maybeRestoreView(): void {\n+    // Not necessary in ViewEngine, because view restoration is an Ivy concept.\n+  }\n+\n   private _createLiteralArrayConverter(sourceSpan: ParseSourceSpan, argCount: number):\n       BuiltinConverter {\n     if (argCount === 0) {"
        },
        {
            "sha": "118cbb84ce6ebf67f5a253c6f4432132aa472eed",
            "filename": "packages/core/test/acceptance/listener_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f52df99fe369854c4ee49e3c01afa29cf2ae7126/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Flistener_spec.ts?ref=f52df99fe369854c4ee49e3c01afa29cf2ae7126",
            "patch": "@@ -528,4 +528,28 @@ describe('event listeners', () => {\n         expect(eventVariable).toBe(10);\n         expect(eventObject?.type).toBe('click');\n       });\n+\n+  it('should be able to use a keyed write on `this` from a listener inside an ng-template', () => {\n+    @Component({\n+      template: `\n+        <ng-template #template>\n+          <button (click)=\"this['mes' + 'sage'] = 'hello'\">Click me</button>\n+        </ng-template>\n+\n+        <ng-container [ngTemplateOutlet]=\"template\"></ng-container>\n+      `\n+    })\n+    class MyComp {\n+      message = '';\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [MyComp], imports: [CommonModule]});\n+    const fixture = TestBed.createComponent(MyComp);\n+    fixture.detectChanges();\n+    const button = fixture.nativeElement.querySelector('button');\n+    button.click();\n+    fixture.detectChanges();\n+\n+    expect(fixture.componentInstance.message).toBe('hello');\n+  });\n });"
        }
    ],
    "stats": {
        "total": 144,
        "additions": 143,
        "deletions": 1
    }
}