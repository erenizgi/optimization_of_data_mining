{
    "author": "JoostK",
    "message": "test(compiler-cli): run watch mode tests using Ivy compiler (#43893)\n\nThis commit re-enables the `perform_watch` test target and updates the\ntest to run with the Ivy compiler.\n\nAdditionally, this target was switched over to use Angular v12 packages\nas input to the test, to allow the ViewEngine tests to continue working\nwith v13 packages which are Ivy-only. This commit reverts those changes\nnow that View Engine tests are disabled, as it's desirable to test\nagainst local artifacts that are build within the monorepo instead of\ndepending on NPM packages.\n\nPR Close #43893",
    "sha": "52a6785a82186cc9dda0b5957b5c138d3eb10e9a",
    "files": [
        {
            "sha": "8153a3740e73855456d15994829f636ecfbc7e73",
            "filename": "packages/compiler-cli/test/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/52a6785a82186cc9dda0b5957b5c138d3eb10e9a/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/52a6785a82186cc9dda0b5957b5c138d3eb10e9a/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel?ref=52a6785a82186cc9dda0b5957b5c138d3eb10e9a",
            "patch": "@@ -116,11 +116,7 @@ jasmine_node_test(\n     name = \"perform_watch\",\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"@npm//@angular/core-12\",\n-    ],\n-    tags = [\n-        # TODO: Reenable tests after determining if they appropriately rely on ViewEngine\n-        \"view-engine-only\",\n+        \"//packages/core:npm_package\",\n     ],\n     deps = [\n         \":perform_watch_lib\",\n@@ -147,7 +143,7 @@ jasmine_node_test(\n     name = \"perform_compile\",\n     bootstrap = [\"//tools/testing:node_es5\"],\n     data = [\n-        \"@npm//@angular/core-12\",\n+        \"//packages/core:npm_package\",\n     ],\n     deps = [\n         \":perform_compile_lib\","
        },
        {
            "sha": "3db90a6163ece3c22daae051f442a8e6b91deabf",
            "filename": "packages/compiler-cli/test/perform_watch_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 13,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/52a6785a82186cc9dda0b5957b5c138d3eb10e9a/packages%2Fcompiler-cli%2Ftest%2Fperform_watch_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/52a6785a82186cc9dda0b5957b5c138d3eb10e9a/packages%2Fcompiler-cli%2Ftest%2Fperform_watch_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fperform_watch_spec.ts?ref=52a6785a82186cc9dda0b5957b5c138d3eb10e9a",
            "patch": "@@ -6,7 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ivyEnabled} from '@angular/private/testing';\n import * as fs from 'fs';\n import * as path from 'path';\n import ts from 'typescript';\n@@ -48,11 +47,11 @@ describe('perform watch', () => {\n     const watchResult = performWatchCompilation(host);\n     expectNoDiagnostics(config.options, watchResult.firstCompileResult);\n \n-    expect(fs.existsSync(path.resolve(outDir, 'src', 'main.ngfactory.js'))).toBe(true);\n+    expect(fs.existsSync(path.resolve(outDir, 'src', 'main.js'))).toBe(true);\n   });\n \n   it('should recompile components when its template changes', () => {\n-    const config = createConfig({enableIvy: ivyEnabled});\n+    const config = createConfig();\n     const host = new MockWatchHost(config);\n \n     testSupport.writeFiles({\n@@ -65,8 +64,7 @@ describe('perform watch', () => {\n     expectNoDiagnostics(config.options, watchResult.firstCompileResult);\n \n     const htmlPath = path.join(testSupport.basePath, 'src', 'main.html');\n-    const genPath = ivyEnabled ? path.posix.join(outDir, 'src', 'main.js') :\n-                                 path.posix.join(outDir, 'src', 'main.ngfactory.js');\n+    const genPath = path.posix.join(outDir, 'src', 'main.js');\n \n     const initial = fs.readFileSync(genPath, {encoding: 'utf8'});\n     expect(initial).toContain('\"initial\"');\n@@ -101,10 +99,10 @@ describe('perform watch', () => {\n \n     const mainTsPath = path.posix.join(testSupport.basePath, 'src', 'main.ts');\n     const utilTsPath = path.posix.join(testSupport.basePath, 'src', 'util.ts');\n-    const mainNgFactory = path.posix.join(outDir, 'src', 'main.ngfactory.js');\n+    const genPath = path.posix.join(outDir, 'src', 'main.js');\n \n     performWatchCompilation(host);\n-    expect(fs.existsSync(mainNgFactory)).toBe(true);\n+    expect(fs.existsSync(genPath)).toBe(true);\n     expect(fileExistsSpy!).toHaveBeenCalledWith(mainTsPath);\n     expect(fileExistsSpy!).toHaveBeenCalledWith(utilTsPath);\n     expect(getSourceFileSpy!).toHaveBeenCalledWith(mainTsPath, ts.ScriptTarget.ES5);\n@@ -120,8 +118,8 @@ describe('perform watch', () => {\n \n     expect(fileExistsSpy!).not.toHaveBeenCalledWith(mainTsPath);\n     expect(fileExistsSpy!).toHaveBeenCalledWith(utilTsPath);\n-    expect(getSourceFileSpy!).not.toHaveBeenCalledWith(mainTsPath, ts.ScriptTarget.ES5);\n-    expect(getSourceFileSpy!).toHaveBeenCalledWith(utilTsPath, ts.ScriptTarget.ES5);\n+    expect(getSourceFileSpy!).not.toHaveBeenCalledWith(mainTsPath, jasmine.anything());\n+    expect(getSourceFileSpy!).toHaveBeenCalledWith(utilTsPath, jasmine.anything());\n \n     // trigger a folder change\n     // -> nothing should be cached\n@@ -131,8 +129,8 @@ describe('perform watch', () => {\n \n     expect(fileExistsSpy!).toHaveBeenCalledWith(mainTsPath);\n     expect(fileExistsSpy!).toHaveBeenCalledWith(utilTsPath);\n-    expect(getSourceFileSpy!).toHaveBeenCalledWith(mainTsPath, ts.ScriptTarget.ES5);\n-    expect(getSourceFileSpy!).toHaveBeenCalledWith(utilTsPath, ts.ScriptTarget.ES5);\n+    expect(getSourceFileSpy!).toHaveBeenCalledWith(mainTsPath, jasmine.anything());\n+    expect(getSourceFileSpy!).toHaveBeenCalledWith(utilTsPath, jasmine.anything());\n   });\n \n   // https://github.com/angular/angular/pull/26036\n@@ -200,7 +198,7 @@ describe('perform watch', () => {\n     expectNoDiagnostics(config.options, host.diagnostics);\n \n     // Do it multiple times as the watch mode switches internal modes.\n-    // E.g. from regular compile to using summaries, ...\n+    // E.g. from regular compile to incremental, ...\n     for (let i = 0; i < 3; i++) {\n       host.diagnostics = [];\n       testSupport.write(indexTsPath, okFileContent);\n@@ -213,7 +211,7 @@ describe('perform watch', () => {\n \n       const errDiags = host.diagnostics.filter(d => d.category === ts.DiagnosticCategory.Error);\n       expect(errDiags.length).toBe(1);\n-      expect(errDiags[0].messageText).toContain('Function expressions are not supported');\n+      expect(errDiags[0].messageText).toContain('@NgModule argument must be an object literal');\n     }\n   });\n });"
        },
        {
            "sha": "c26a3eac6ddb34a5f197e253c6172b57f7f56f27",
            "filename": "packages/compiler-cli/test/test_support.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 23,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/52a6785a82186cc9dda0b5957b5c138d3eb10e9a/packages%2Fcompiler-cli%2Ftest%2Ftest_support.ts",
            "raw_url": "https://github.com/angular/angular/raw/52a6785a82186cc9dda0b5957b5c138d3eb10e9a/packages%2Fcompiler-cli%2Ftest%2Ftest_support.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Ftest_support.ts?ref=52a6785a82186cc9dda0b5957b5c138d3eb10e9a",
            "patch": "@@ -57,7 +57,6 @@ function createTestSupportFor(basePath: string) {\n     'newLine': ts.NewLineKind.LineFeed,\n     'module': ts.ModuleKind.ES2015,\n     'moduleResolution': ts.ModuleResolutionKind.NodeJs,\n-    'enableIvy': false,\n     'lib': Object.freeze([\n       path.resolve(basePath, 'node_modules/typescript/lib/lib.es6.d.ts'),\n     ]) as string[],\n@@ -128,30 +127,14 @@ export function setupBazelTo(tmpDirPath: string) {\n   fs.mkdirSync(nodeModulesPath);\n   fs.mkdirSync(angularDirectory);\n \n-  function linkNpmArtifact(artifact: string, target: string = artifact) {\n-    try {\n-      const source = resolveNpmTreeArtifact(`npm/node_modules/${artifact}`);\n-      const dest = path.join(nodeModulesPath, target);\n-      fs.symlinkSync(source, dest, 'junction');\n-    } catch (e) {\n-      // Allow a module to be missing as some Bazel targets do not need all artifacts.\n-      if (e.code !== 'MODULE_NOT_FOUND') throw e;\n-    }\n-  }\n-\n-  // Link @angular packages. These reference the v12 packages from NPM as the ViewEngine tests\n-  // can no longer depend on `npm_package` Bazel targets, given that the `ng_module` to produce\n-  // them is no longer capable of producing ViewEngine packages. As a result, the `npm_package`\n-  // outputs end up being compiled using Ivy partial compilation format which is not suitable to be\n-  // used in ViewEngine ngc tests.\n-  linkNpmArtifact('@angular/core-12', '@angular/core');\n-  linkNpmArtifact('@angular/common-12', '@angular/common');\n-  linkNpmArtifact('@angular/router-12', '@angular/router');\n-  linkNpmArtifact('@angular/forms-12', '@angular/forms');\n-  linkNpmArtifact('@angular/platform-browser-12', '@angular/platform-browser');\n+  getAngularPackagesFromRunfiles().forEach(({pkgPath, name}) => {\n+    fs.symlinkSync(pkgPath, path.join(angularDirectory, name), 'junction');\n+  });\n \n   // Link typescript\n-  linkNpmArtifact('typescript');\n+  const typeScriptSource = resolveNpmTreeArtifact('npm/node_modules/typescript');\n+  const typescriptDest = path.join(nodeModulesPath, 'typescript');\n+  fs.symlinkSync(typeScriptSource, typescriptDest, 'junction');\n \n   // Link \"rxjs\" if it has been set up as a runfile. \"rxjs\" is linked optionally because\n   // not all compiler-cli tests need \"rxjs\" set up."
        }
    ],
    "stats": {
        "total": 61,
        "additions": 19,
        "deletions": 42
    }
}