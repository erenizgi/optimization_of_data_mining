{
    "author": "JoostK",
    "message": "refactor(ngcc): remove Ivy switch marker transform (#43891)\n\nngcc used to rewrite `PRE_R3` markers to become `POST_R3` in order to\nswitch the runtime implementation in `@angular/core` from View Engine to\nIvy. Now that `@angular/core` is published as native Ivy package and the\nruntime switch code has been removed, there is no need for ngcc to\nperform this transform anymore.\n\nPR Close #43891",
    "sha": "d8e65776cb35b08c435335ffeac0f82789477532",
    "files": [
        {
            "sha": "cd134d4c26bd62f0ebdb1ef1f90fb6b13efb1d35",
            "filename": "integration/ngcc/test.sh",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/integration%2Fngcc%2Ftest.sh",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/integration%2Fngcc%2Ftest.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fngcc%2Ftest.sh?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -70,14 +70,6 @@ assertSucceeded \"Expected 'ngcc' to log '- @angular/core [fesm2015/esm2015] (htt\n   cat node_modules/@angular/common/package.json | awk 'ORS=\" \"' | grep '\"__processed_by_ivy_ngcc__\":[^}]*\"module\": \"'\n   assertSucceeded \"Expected 'ngcc' to add build marker for 'module' in '@angular/common'.\"\n \n-# Did it replace the PRE_R3 markers correctly?\n-  grep \"= SWITCH_COMPILE_COMPONENT__POST_R3__\" node_modules/@angular/core/fesm2015/core.js\n-  assertSucceeded \"Expected 'ngcc' to replace 'SWITCH_COMPILE_COMPONENT__PRE_R3__' in '@angular/core' (fesm2015).\"\n-\n-  grep \"= SWITCH_COMPILE_COMPONENT__POST_R3__\" node_modules/@angular/core/bundles/core.umd.js\n-  assertSucceeded \"Expected 'ngcc' to replace 'SWITCH_COMPILE_COMPONENT__PRE_R3__' in '@angular/core' (main).\"\n-\n-\n # Did it compile @angular/core/ApplicationModule correctly?\n   grep \"ApplicationModule.ɵmod = /\\*@__PURE__\\*/ ɵɵdefineNgModule\" node_modules/@angular/core/fesm2015/core.js\n   assertSucceeded \"Expected 'ngcc' to correctly compile 'ApplicationModule' in '@angular/core' (fesm2015).\""
        },
        {
            "sha": "9a11e0992d4de7c4748a843548ea7feb69a4df78",
            "filename": "packages/compiler-cli/ngcc/src/analysis/switch_marker_analyzer.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 47,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fswitch_marker_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fswitch_marker_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fswitch_marker_analyzer.ts?ref=b2ac81d1472d118a2a03629139b6e724a730b982",
            "patch": "@@ -1,47 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-import ts from 'typescript';\n-import {absoluteFromSourceFile, AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n-import {NgccReflectionHost, SwitchableVariableDeclaration} from '../host/ngcc_host';\n-import {isWithinPackage} from './util';\n-\n-export interface SwitchMarkerAnalysis {\n-  sourceFile: ts.SourceFile;\n-  declarations: SwitchableVariableDeclaration[];\n-}\n-\n-export type SwitchMarkerAnalyses = Map<ts.SourceFile, SwitchMarkerAnalysis>;\n-export const SwitchMarkerAnalyses = Map;\n-\n-/**\n- * This Analyzer will analyse the files that have an R3 switch marker in them\n- * that will be replaced.\n- */\n-export class SwitchMarkerAnalyzer {\n-  constructor(private host: NgccReflectionHost, private packagePath: AbsoluteFsPath) {}\n-  /**\n-   * Analyze the files in the program to identify declarations that contain R3\n-   * switch markers.\n-   * @param program The program to analyze.\n-   * @return A map of source files to analysis objects. The map will contain only the\n-   * source files that had switch markers, and the analysis will contain an array of\n-   * the declarations in that source file that contain the marker.\n-   */\n-  analyzeProgram(program: ts.Program): SwitchMarkerAnalyses {\n-    const analyzedFiles = new SwitchMarkerAnalyses();\n-    program.getSourceFiles()\n-        .filter(sourceFile => isWithinPackage(this.packagePath, absoluteFromSourceFile(sourceFile)))\n-        .forEach(sourceFile => {\n-          const declarations = this.host.getSwitchableDeclarations(sourceFile);\n-          if (declarations.length) {\n-            analyzedFiles.set(sourceFile, {sourceFile, declarations});\n-          }\n-        });\n-    return analyzedFiles;\n-  }\n-}"
        },
        {
            "sha": "ef0e5c515ab8872c3076240db9ab299f23f232b5",
            "filename": "packages/compiler-cli/ngcc/src/host/delegating_host.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fdelegating_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fdelegating_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fdelegating_host.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -11,7 +11,7 @@ import ts from 'typescript';\n import {ClassDeclaration, ClassMember, CtorParameter, Declaration, DeclarationNode, Decorator, FunctionDefinition, Import, ReflectionHost} from '../../../src/ngtsc/reflection';\n import {isFromDtsFile} from '../../../src/ngtsc/util/src/typescript';\n \n-import {NgccClassSymbol, NgccReflectionHost, SwitchableVariableDeclaration} from './ngcc_host';\n+import {NgccClassSymbol, NgccReflectionHost} from './ngcc_host';\n \n /**\n  * A reflection host implementation that delegates reflector queries depending on whether they\n@@ -150,10 +150,6 @@ export class DelegatingReflectionHost implements NgccReflectionHost {\n     return this.ngccHost.getDecoratorsOfSymbol(symbol);\n   }\n \n-  getSwitchableDeclarations(module: ts.Node): SwitchableVariableDeclaration[] {\n-    return this.ngccHost.getSwitchableDeclarations(module);\n-  }\n-\n   getEndOfClass(classSymbol: NgccClassSymbol): ts.Node {\n     return this.ngccHost.getEndOfClass(classSymbol);\n   }"
        },
        {
            "sha": "14c41bc0533ed41d1d3630b2e66c50cd044c42a8",
            "filename": "packages/compiler-cli/ngcc/src/host/esm2015_host.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -14,9 +14,9 @@ import {ClassDeclaration, ClassMember, ClassMemberKind, CtorParameter, Declarati\n import {isSymbolWithValueDeclaration, SymbolWithValueDeclaration} from '../../../src/ngtsc/util/src/typescript';\n import {isWithinPackage} from '../analysis/util';\n import {BundleProgram} from '../packages/bundle_program';\n-import {findAll, getNameText, hasNameIdentifier, isDefined, stripDollarSuffix} from '../utils';\n+import {getNameText, hasNameIdentifier, isDefined, stripDollarSuffix} from '../utils';\n \n-import {ClassSymbol, isSwitchableVariableDeclaration, NgccClassSymbol, NgccReflectionHost, PRE_R3_MARKER, SwitchableVariableDeclaration} from './ngcc_host';\n+import {ClassSymbol, NgccClassSymbol, NgccReflectionHost} from './ngcc_host';\n import {stripParentheses} from './utils';\n \n export const DECORATORS = 'decorators' as ts.__String;\n@@ -342,19 +342,6 @@ export class Esm2015ReflectionHost extends TypeScriptReflectionHost implements N\n     return Array.from(classDecorators);\n   }\n \n-  /**\n-   * Search the given module for variable declarations in which the initializer\n-   * is an identifier marked with the `PRE_R3_MARKER`.\n-   * @param module the module in which to search for switchable declarations.\n-   * @returns an array of variable declarations that match.\n-   */\n-  getSwitchableDeclarations(module: ts.Node): SwitchableVariableDeclaration[] {\n-    // Don't bother to walk the AST if the marker is not found in the text\n-    return module.getText().indexOf(PRE_R3_MARKER) >= 0 ?\n-        findAll(module, isSwitchableVariableDeclaration) :\n-        [];\n-  }\n-\n   override getVariableValue(declaration: ts.VariableDeclaration): ts.Expression|null {\n     const value = super.getVariableValue(declaration);\n     if (value) {"
        },
        {
            "sha": "b2ee41dfdf09fb3e82a686251d6393045989b44a",
            "filename": "packages/compiler-cli/ngcc/src/host/ngcc_host.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 18,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fngcc_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fngcc_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fngcc_host.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -10,16 +10,6 @@ import ts from 'typescript';\n import {ClassDeclaration, Declaration, Decorator, ReflectionHost} from '../../../src/ngtsc/reflection';\n import {SymbolWithValueDeclaration} from '../../../src/ngtsc/util/src/typescript';\n \n-export const PRE_R3_MARKER = '__PRE_R3__';\n-export const POST_R3_MARKER = '__POST_R3__';\n-\n-export type SwitchableVariableDeclaration = ts.VariableDeclaration&{initializer: ts.Identifier};\n-export function isSwitchableVariableDeclaration(node: ts.Node):\n-    node is SwitchableVariableDeclaration {\n-  return ts.isVariableDeclaration(node) && !!node.initializer &&\n-      ts.isIdentifier(node.initializer) && node.initializer.text.endsWith(PRE_R3_MARKER);\n-}\n-\n /**\n  * The symbol corresponding to a \"class\" declaration. I.e. a `ts.Symbol` whose `valueDeclaration` is\n  * a `ClassDeclaration`.\n@@ -69,14 +59,6 @@ export interface NgccReflectionHost extends ReflectionHost {\n    */\n   getClassSymbol(declaration: ts.Node): NgccClassSymbol|undefined;\n \n-  /**\n-   * Search the given module for variable declarations in which the initializer\n-   * is an identifier marked with the `PRE_R3_MARKER`.\n-   * @param module The module in which to search for switchable declarations.\n-   * @returns An array of variable declarations that match.\n-   */\n-  getSwitchableDeclarations(module: ts.Node): SwitchableVariableDeclaration[];\n-\n   /**\n    * Retrieves all decorators of a given class symbol.\n    * @param symbol Class symbol that can refer to a declaration which can hold decorators."
        },
        {
            "sha": "fdc7920f07e3480e946fd28ea49bc4749ff77640",
            "filename": "packages/compiler-cli/ngcc/src/packages/transformer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Ftransformer.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Ftransformer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Ftransformer.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -15,7 +15,6 @@ import {DecorationAnalyzer} from '../analysis/decoration_analyzer';\n import {ModuleWithProvidersAnalyses, ModuleWithProvidersAnalyzer} from '../analysis/module_with_providers_analyzer';\n import {NgccReferencesRegistry} from '../analysis/ngcc_references_registry';\n import {ExportInfo, PrivateDeclarationsAnalyzer} from '../analysis/private_declarations_analyzer';\n-import {SwitchMarkerAnalyses, SwitchMarkerAnalyzer} from '../analysis/switch_marker_analyzer';\n import {CompiledFile} from '../analysis/types';\n import {DtsProcessing} from '../execution/tasks/api';\n import {CommonJsReflectionHost} from '../host/commonjs_host';\n@@ -81,7 +80,6 @@ export class Transformer {\n     // Parse and analyze the files.\n     const {\n       decorationAnalyses,\n-      switchMarkerAnalyses,\n       privateDeclarationsAnalyses,\n       moduleWithProvidersAnalyses,\n       diagnostics\n@@ -100,8 +98,7 @@ export class Transformer {\n       const srcFormatter = this.getRenderingFormatter(ngccReflectionHost, bundle);\n       const renderer =\n           new Renderer(reflectionHost, srcFormatter, this.fs, this.logger, bundle, this.tsConfig);\n-      renderedFiles = renderer.renderProgram(\n-          decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+      renderedFiles = renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n     }\n \n     if (bundle.dts) {\n@@ -152,10 +149,6 @@ export class Transformer {\n   analyzeProgram(reflectionHost: NgccReflectionHost, bundle: EntryPointBundle): ProgramAnalyses {\n     const referencesRegistry = new NgccReferencesRegistry(reflectionHost);\n \n-    const switchMarkerAnalyzer =\n-        new SwitchMarkerAnalyzer(reflectionHost, bundle.entryPoint.packagePath);\n-    const switchMarkerAnalyses = switchMarkerAnalyzer.analyzeProgram(bundle.src.program);\n-\n     const diagnostics: ts.Diagnostic[] = [];\n     const decorationAnalyzer = new DecorationAnalyzer(\n         this.fs, bundle, reflectionHost, referencesRegistry,\n@@ -175,7 +168,6 @@ export class Transformer {\n \n     return {\n       decorationAnalyses,\n-      switchMarkerAnalyses,\n       privateDeclarationsAnalyses,\n       moduleWithProvidersAnalyses,\n       diagnostics\n@@ -189,7 +181,6 @@ export function hasErrors(diagnostics: ts.Diagnostic[]) {\n \n interface ProgramAnalyses {\n   decorationAnalyses: Map<ts.SourceFile, CompiledFile>;\n-  switchMarkerAnalyses: SwitchMarkerAnalyses;\n   privateDeclarationsAnalyses: ExportInfo[];\n   moduleWithProvidersAnalyses: ModuleWithProvidersAnalyses|null;\n   diagnostics: ts.Diagnostic[];"
        },
        {
            "sha": "1e214c46710868e19095a2d559178e5cd93da438",
            "filename": "packages/compiler-cli/ngcc/src/rendering/esm_rendering_formatter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 16,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fesm_rendering_formatter.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fesm_rendering_formatter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fesm_rendering_formatter.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -17,7 +17,7 @@ import {ModuleWithProvidersInfo} from '../analysis/module_with_providers_analyze\n import {ExportInfo} from '../analysis/private_declarations_analyzer';\n import {CompiledClass} from '../analysis/types';\n import {getContainingStatement, isAssignment} from '../host/esm2015_host';\n-import {NgccReflectionHost, POST_R3_MARKER, PRE_R3_MARKER, SwitchableVariableDeclaration} from '../host/ngcc_host';\n+import {NgccReflectionHost} from '../host/ngcc_host';\n \n import {RedundantDecoratorMap, RenderingFormatter} from './rendering_formatter';\n import {stripExtension} from './utils';\n@@ -172,21 +172,6 @@ export class EsmRenderingFormatter implements RenderingFormatter {\n     });\n   }\n \n-  /**\n-   * Rewrite the IVY switch markers to indicate we are in IVY mode.\n-   */\n-  rewriteSwitchableDeclarations(\n-      outputText: MagicString, sourceFile: ts.SourceFile,\n-      declarations: SwitchableVariableDeclaration[]): void {\n-    declarations.forEach(declaration => {\n-      const start = declaration.initializer.getStart();\n-      const end = declaration.initializer.getEnd();\n-      const replacement = declaration.initializer.text.replace(PRE_R3_MARKER, POST_R3_MARKER);\n-      outputText.overwrite(start, end, replacement);\n-    });\n-  }\n-\n-\n   /**\n    * Add the type parameters to the appropriate functions that return `ModuleWithProviders`\n    * structures."
        },
        {
            "sha": "9454d644b08ca5e515bda93b248521e896bcea3c",
            "filename": "packages/compiler-cli/ngcc/src/rendering/renderer.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 14,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Frenderer.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Frenderer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Frenderer.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -14,7 +14,6 @@ import {Logger} from '../../../src/ngtsc/logging';\n import {ImportManager} from '../../../src/ngtsc/translator';\n import {ParsedConfiguration} from '../../../src/perform_compile';\n import {PrivateDeclarationsAnalyses} from '../analysis/private_declarations_analyzer';\n-import {SwitchMarkerAnalyses, SwitchMarkerAnalysis} from '../analysis/switch_marker_analyzer';\n import {CompiledClass, CompiledFile, DecorationAnalyses} from '../analysis/types';\n import {IMPORT_PREFIX} from '../constants';\n import {NgccReflectionHost} from '../host/ngcc_host';\n@@ -37,18 +36,16 @@ export class Renderer {\n       private tsConfig: ParsedConfiguration|null = null) {}\n \n   renderProgram(\n-      decorationAnalyses: DecorationAnalyses, switchMarkerAnalyses: SwitchMarkerAnalyses,\n+      decorationAnalyses: DecorationAnalyses,\n       privateDeclarationsAnalyses: PrivateDeclarationsAnalyses): FileToWrite[] {\n     const renderedFiles: FileToWrite[] = [];\n \n     // Transform the source files.\n     this.bundle.src.program.getSourceFiles().forEach(sourceFile => {\n-      if (decorationAnalyses.has(sourceFile) || switchMarkerAnalyses.has(sourceFile) ||\n-          sourceFile === this.bundle.src.file) {\n+      if (decorationAnalyses.has(sourceFile) || sourceFile === this.bundle.src.file) {\n         const compiledFile = decorationAnalyses.get(sourceFile);\n-        const switchMarkerAnalysis = switchMarkerAnalyses.get(sourceFile);\n-        renderedFiles.push(...this.renderFile(\n-            sourceFile, compiledFile, switchMarkerAnalysis, privateDeclarationsAnalyses));\n+        renderedFiles.push(\n+            ...this.renderFile(sourceFile, compiledFile, privateDeclarationsAnalyses));\n       }\n     });\n \n@@ -62,16 +59,10 @@ export class Renderer {\n    */\n   renderFile(\n       sourceFile: ts.SourceFile, compiledFile: CompiledFile|undefined,\n-      switchMarkerAnalysis: SwitchMarkerAnalysis|undefined,\n       privateDeclarationsAnalyses: PrivateDeclarationsAnalyses): FileToWrite[] {\n     const isEntryPoint = sourceFile === this.bundle.src.file;\n     const outputText = new MagicString(sourceFile.text);\n \n-    if (switchMarkerAnalysis) {\n-      this.srcFormatter.rewriteSwitchableDeclarations(\n-          outputText, switchMarkerAnalysis.sourceFile, switchMarkerAnalysis.declarations);\n-    }\n-\n     const importManager = new ImportManager(\n         getImportRewriter(\n             this.bundle.src.r3SymbolsFile, this.bundle.isCore, this.bundle.isFlatCore),\n@@ -118,7 +109,7 @@ export class Renderer {\n           outputText, importManager.getAllImports(sourceFile.fileName), sourceFile);\n     }\n \n-    if (compiledFile || switchMarkerAnalysis || isEntryPoint) {\n+    if (compiledFile || isEntryPoint) {\n       return renderSourceAndMap(this.logger, this.fs, sourceFile, outputText);\n     } else {\n       return [];"
        },
        {
            "sha": "861d92c7ba7db8cdf95f65022bdb6ecd080203df",
            "filename": "packages/compiler-cli/ngcc/src/rendering/rendering_formatter.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Frendering_formatter.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Frendering_formatter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Frendering_formatter.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -14,7 +14,6 @@ import {Import, ImportManager} from '../../../src/ngtsc/translator';\n import {ModuleWithProvidersInfo} from '../analysis/module_with_providers_analyzer';\n import {ExportInfo} from '../analysis/private_declarations_analyzer';\n import {CompiledClass} from '../analysis/types';\n-import {SwitchableVariableDeclaration} from '../host/ngcc_host';\n \n /**\n  * The collected decorators that have become redundant after the compilation\n@@ -41,9 +40,6 @@ export interface RenderingFormatter {\n   addAdjacentStatements(output: MagicString, compiledClass: CompiledClass, statements: string):\n       void;\n   removeDecorators(output: MagicString, decoratorsToRemove: RedundantDecoratorMap): void;\n-  rewriteSwitchableDeclarations(\n-      outputText: MagicString, sourceFile: ts.SourceFile,\n-      declarations: SwitchableVariableDeclaration[]): void;\n   addModuleWithProvidersParams(\n       outputText: MagicString, moduleWithProviders: ModuleWithProvidersInfo[],\n       importManager: ImportManager): void;"
        },
        {
            "sha": "ab1c25ed723202076177a82734406d12de34e7e4",
            "filename": "packages/compiler-cli/ngcc/src/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Futils.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -46,26 +46,6 @@ export function getNameText(name: ts.PropertyName|ts.BindingName): string {\n   return ts.isIdentifier(name) || ts.isLiteralExpression(name) ? name.text : name.getText();\n }\n \n-/**\n- * Parse down the AST and capture all the nodes that satisfy the test.\n- * @param node The start node.\n- * @param test The function that tests whether a node should be included.\n- * @returns a collection of nodes that satisfy the test.\n- */\n-export function findAll<T>(node: ts.Node, test: (node: ts.Node) => node is ts.Node & T): T[] {\n-  const nodes: T[] = [];\n-  findAllVisitor(node);\n-  return nodes;\n-\n-  function findAllVisitor(n: ts.Node) {\n-    if (test(n)) {\n-      nodes.push(n);\n-    } else {\n-      n.forEachChild(child => findAllVisitor(child));\n-    }\n-  }\n-}\n-\n /**\n  * Does the given declaration have a name which is an identifier?\n  * @param declaration The declaration to test."
        },
        {
            "sha": "b64d4bacdcd01373b0b9a5089b3ad092f0690938",
            "filename": "packages/compiler-cli/ngcc/test/analysis/switch_marker_analyzer_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 137,
            "changes": 137,
            "blob_url": "https://github.com/angular/angular/blob/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fswitch_marker_analyzer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b2ac81d1472d118a2a03629139b6e724a730b982/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fswitch_marker_analyzer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fswitch_marker_analyzer_spec.ts?ref=b2ac81d1472d118a2a03629139b6e724a730b982",
            "patch": "@@ -1,137 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-import {absoluteFrom, getSourceFileOrError} from '../../../src/ngtsc/file_system';\n-import {runInEachFileSystem, TestFile} from '../../../src/ngtsc/file_system/testing';\n-import {MockLogger} from '../../../src/ngtsc/logging/testing';\n-import {loadTestFiles} from '../../../src/ngtsc/testing';\n-import {SwitchMarkerAnalyzer} from '../../src/analysis/switch_marker_analyzer';\n-import {Esm2015ReflectionHost} from '../../src/host/esm2015_host';\n-import {makeTestEntryPointBundle} from '../helpers/utils';\n-\n-runInEachFileSystem(() => {\n-  describe('SwitchMarkerAnalyzer', () => {\n-    let _: typeof absoluteFrom;\n-    let TEST_PROGRAM: TestFile[];\n-\n-    beforeEach(() => {\n-      _ = absoluteFrom;\n-      TEST_PROGRAM = [\n-        {\n-          name: _('/node_modules/test/entrypoint.js'),\n-          contents: `\n-            import {a} from './a';\n-            import {b} from './b';\n-            import {x} from '../other/x';\n-            import {e} from 'nested/e';\n-          `,\n-        },\n-        {\n-          name: _('/node_modules/test/a.js'),\n-          contents: `\n-            import {c} from './c';\n-            export const a = 1;\n-          `,\n-        },\n-        {\n-          name: _('/node_modules/test/b.js'),\n-          contents: `\n-            export const b = 42;\n-            var factoryB = factory__PRE_R3__;\n-          `,\n-        },\n-        {\n-          name: _('/node_modules/test/c.js'),\n-          contents: `\n-            export const c = 'So long, and thanks for all the fish!';\n-            var factoryC = factory__PRE_R3__;\n-            var factoryD = factory__PRE_R3__;\n-          `,\n-        },\n-        {\n-          name: _('/node_modules/test/node_modules/nested/e.js'),\n-          contents: `\n-            export const e = 1337;\n-            var factoryE = factory__PRE_R3__;\n-          `,\n-        },\n-        {\n-          name: _('/node_modules/other/x.js'),\n-          contents: `\n-            export const x = 3.142;\n-            var factoryX = factory__PRE_R3__;\n-          `,\n-        },\n-        {\n-          name: _('/node_modules/other/x.d.ts'),\n-          contents: `\n-            export const x: number;\n-          `,\n-        },\n-      ];\n-    });\n-\n-    describe('analyzeProgram()', () => {\n-      it('should check for switchable markers in all the files of the program', () => {\n-        loadTestFiles(TEST_PROGRAM);\n-        const bundle = makeTestEntryPointBundle(\n-            'test', 'esm2015', false, [_('/node_modules/test/entrypoint.js')]);\n-        const program = bundle.src.program;\n-        const host = new Esm2015ReflectionHost(new MockLogger(), false, bundle.src);\n-        const analyzer = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath);\n-        const analysis = analyzer.analyzeProgram(program);\n-\n-        const entrypoint = getSourceFileOrError(program, _('/node_modules/test/entrypoint.js'));\n-        const a = getSourceFileOrError(program, _('/node_modules/test/a.js'));\n-        const b = getSourceFileOrError(program, _('/node_modules/test/b.js'));\n-        const c = getSourceFileOrError(program, _('/node_modules/test/c.js'));\n-\n-        expect(analysis.size).toEqual(2);\n-        expect(analysis.has(entrypoint)).toBe(false);\n-        expect(analysis.has(a)).toBe(false);\n-        expect(analysis.has(b)).toBe(true);\n-        expect(analysis.get(b)!.sourceFile).toBe(b);\n-        expect(analysis.get(b)!.declarations.map(decl => decl.getText())).toEqual([\n-          'factoryB = factory__PRE_R3__'\n-        ]);\n-\n-        expect(analysis.has(c)).toBe(true);\n-        expect(analysis.get(c)!.sourceFile).toBe(c);\n-        expect(analysis.get(c)!.declarations.map(decl => decl.getText())).toEqual([\n-          'factoryC = factory__PRE_R3__',\n-          'factoryD = factory__PRE_R3__',\n-        ]);\n-      });\n-\n-      it('should ignore files that are outside the package', () => {\n-        loadTestFiles(TEST_PROGRAM);\n-        const bundle = makeTestEntryPointBundle(\n-            'test', 'esm2015', false, [_('/node_modules/test/entrypoint.js')]);\n-        const program = bundle.src.program;\n-        const host = new Esm2015ReflectionHost(new MockLogger(), false, bundle.src);\n-        const analyzer = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath);\n-        const analysis = analyzer.analyzeProgram(program);\n-\n-        const x = getSourceFileOrError(program, _('/node_modules/other/x.js'));\n-        expect(analysis.has(x)).toBe(false);\n-      });\n-\n-      it('should ignore files that are inside the package\\'s `node_modules/`', () => {\n-        loadTestFiles(TEST_PROGRAM);\n-        const bundle = makeTestEntryPointBundle(\n-            'test', 'esm2015', false, [_('/node_modules/test/entrypoint.js')]);\n-        const program = bundle.src.program;\n-        const host = new Esm2015ReflectionHost(new MockLogger(), false, bundle.src);\n-        const analyzer = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath);\n-        const analysis = analyzer.analyzeProgram(program);\n-\n-        const x = getSourceFileOrError(program, _('/node_modules/test/node_modules/nested/e.js'));\n-        expect(analysis.has(x)).toBe(false);\n-      });\n-    });\n-  });\n-});"
        },
        {
            "sha": "fff33c75b970a8582ffcb7ec13e4db2857cbcec4",
            "filename": "packages/compiler-cli/ngcc/test/host/esm2015_host_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 34,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm2015_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm2015_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm2015_host_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -40,7 +40,6 @@ runInEachFileSystem(() => {\n     let IMPORTS_FILES: TestFile[];\n     let EXPORTS_FILES: TestFile[];\n     let FUNCTION_BODY_FILE: TestFile;\n-    let MARKER_FILE: TestFile;\n     let DECORATED_FILES: TestFile[];\n     let ARITY_CLASSES: TestFile[];\n     let TYPINGS_SRC_FILES: TestFile[];\n@@ -518,24 +517,6 @@ runInEachFileSystem(() => {\n   `\n       };\n \n-      MARKER_FILE = {\n-        name: _('/marker.js'),\n-        contents: `\n-    let compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;\n-\n-    function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {\n-      const compilerFactory = injector.get(CompilerFactory);\n-      const compiler = compilerFactory.createCompiler([options]);\n-      return compiler.compileModuleAsync(moduleType);\n-    }\n-\n-    function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {\n-      ngDevMode && assertNgModuleType(moduleType);\n-      return Promise.resolve(new R3NgModuleFactory(moduleType));\n-    }\n-  `\n-      };\n-\n       DECORATED_FILES = [\n         {\n           name: _('/primary.js'),\n@@ -2352,21 +2333,6 @@ runInEachFileSystem(() => {\n       });\n     });\n \n-    describe('getSwitchableDeclarations()', () => {\n-      it('should return a collection of all the switchable variable declarations in the given module',\n-         () => {\n-           loadTestFiles([MARKER_FILE]);\n-           const bundle = makeTestBundleProgram(MARKER_FILE.name);\n-           const host =\n-               createHost(bundle, new Esm2015ReflectionHost(new MockLogger(), false, bundle));\n-           const file = getSourceFileOrError(bundle.program, MARKER_FILE.name);\n-           const declarations = host.getSwitchableDeclarations(file);\n-           expect(declarations.map(d => [d.name.getText(), d.initializer!.getText()])).toEqual([\n-             ['compileNgModuleFactory', 'compileNgModuleFactory__PRE_R3__']\n-           ]);\n-         });\n-    });\n-\n     describe('findClassSymbols()', () => {\n       it('should return an array of all classes in the given source file', () => {\n         loadTestFiles(DECORATED_FILES);"
        },
        {
            "sha": "858a8a1d926fc1027b1c8c6de49388000b1389af",
            "filename": "packages/compiler-cli/ngcc/test/rendering/commonjs_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 38,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fcommonjs_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fcommonjs_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fcommonjs_rendering_formatter_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -17,7 +17,6 @@ import {getDeclaration, loadTestFiles} from '../../../src/ngtsc/testing';\n import {ImportManager} from '../../../src/ngtsc/translator';\n import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n-import {SwitchMarkerAnalyzer} from '../../src/analysis/switch_marker_analyzer';\n import {CommonJsReflectionHost} from '../../src/host/commonjs_host';\n import {CommonJsRenderingFormatter} from '../../src/rendering/commonjs_rendering_formatter';\n import {makeTestEntryPointBundle} from '../helpers/utils';\n@@ -74,18 +73,6 @@ var BadIife = (function() {\n   ];\n }());\n \n-var compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;\n-var badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;\n-function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {\n-  var compilerFactory = injector.get(CompilerFactory);\n-  var compiler = compilerFactory.createCompiler([options]);\n-  return compiler.compileModuleAsync(moduleType);\n-}\n-\n-function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {\n-  ngDevMode && assertNgModuleType(moduleType);\n-  return Promise.resolve(new R3NgModuleFactory(moduleType));\n-}\n // Some other content\n exports.A = A;\n exports.B = B;\n@@ -155,8 +142,6 @@ exports.D = D;\n       const referencesRegistry = new NgccReferencesRegistry(host);\n       const decorationAnalyses =\n           new DecorationAnalyzer(fs, bundle, host, referencesRegistry).analyzeProgram();\n-      const switchMarkerAnalyses = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath)\n-                                       .analyzeProgram(bundle.src.program);\n       const renderer = new CommonJsRenderingFormatter(fs, host, false);\n       const importManager = new ImportManager(new NoopImportRewriter(), 'i');\n       return {\n@@ -165,7 +150,6 @@ exports.D = D;\n         sourceFile: bundle.src.file,\n         renderer,\n         decorationAnalyses,\n-        switchMarkerAnalyses,\n         importManager\n       };\n     }\n@@ -268,28 +252,6 @@ var A = (function() {`);\n       });\n     });\n \n-    describe('rewriteSwitchableDeclarations', () => {\n-      it('should switch marked declaration initializers', () => {\n-        const {renderer, program, sourceFile, switchMarkerAnalyses} = setup(PROGRAM);\n-        const file = getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n-        const output = new MagicString(PROGRAM.contents);\n-        renderer.rewriteSwitchableDeclarations(\n-            output, file, switchMarkerAnalyses.get(sourceFile)!.declarations);\n-        expect(output.toString())\n-            .not.toContain(`var compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;`);\n-        expect(output.toString())\n-            .toContain(`var badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;`);\n-        expect(output.toString())\n-            .toContain(`var compileNgModuleFactory = compileNgModuleFactory__POST_R3__;`);\n-        expect(output.toString())\n-            .toContain(\n-                `function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {`);\n-        expect(output.toString())\n-            .toContain(\n-                `function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {`);\n-      });\n-    });\n-\n     describe('addDefinitions', () => {\n       it('should insert the definitions directly before the return statement of the class IIFE',\n          () => {"
        },
        {
            "sha": "6ccdd6434141cfdb3163caa5b5b4560519223519",
            "filename": "packages/compiler-cli/ngcc/test/rendering/dts_renderer_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fdts_renderer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fdts_renderer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fdts_renderer_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -48,9 +48,6 @@ class TestRenderingFormatter implements RenderingFormatter {\n   removeDecorators(output: MagicString, decoratorsToRemove: RedundantDecoratorMap) {\n     output.prepend('\\n// REMOVE DECORATORS\\n');\n   }\n-  rewriteSwitchableDeclarations(output: MagicString, sourceFile: ts.SourceFile): void {\n-    output.prepend('\\n// REWRITTEN DECLARATIONS\\n');\n-  }\n   addModuleWithProvidersParams(\n       output: MagicString, moduleWithProviders: ModuleWithProvidersInfo[],\n       importManager: ImportManager): void {\n@@ -92,7 +89,6 @@ function createTestRenderer(\n   spyOn(testFormatter, 'addAdjacentStatements').and.callThrough();\n   spyOn(testFormatter, 'addConstants').and.callThrough();\n   spyOn(testFormatter, 'removeDecorators').and.callThrough();\n-  spyOn(testFormatter, 'rewriteSwitchableDeclarations').and.callThrough();\n   spyOn(testFormatter, 'addModuleWithProvidersParams').and.callThrough();\n   spyOn(testFormatter, 'printStatement').and.callThrough();\n "
        },
        {
            "sha": "cfb6ce060998c4dfa4556ac3f2d865a9b43bfdaa",
            "filename": "packages/compiler-cli/ngcc/test/rendering/esm5_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 38,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fesm5_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fesm5_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fesm5_rendering_formatter_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -17,7 +17,6 @@ import {getDeclaration, loadTestFiles} from '../../../src/ngtsc/testing';\n import {ImportManager} from '../../../src/ngtsc/translator';\n import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n-import {SwitchMarkerAnalyzer} from '../../src/analysis/switch_marker_analyzer';\n import {IMPORT_PREFIX} from '../../src/constants';\n import {Esm5ReflectionHost} from '../../src/host/esm5_host';\n import {Esm5RenderingFormatter} from '../../src/rendering/esm5_rendering_formatter';\n@@ -32,8 +31,6 @@ function setup(file: {name: AbsoluteFsPath, contents: string}) {\n   const referencesRegistry = new NgccReferencesRegistry(host);\n   const decorationAnalyses =\n       new DecorationAnalyzer(fs, bundle, host, referencesRegistry).analyzeProgram();\n-  const switchMarkerAnalyses = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath)\n-                                   .analyzeProgram(bundle.src.program);\n   const renderer = new Esm5RenderingFormatter(fs, host, false);\n   const importManager = new ImportManager(new NoopImportRewriter(), IMPORT_PREFIX);\n   return {\n@@ -42,7 +39,6 @@ function setup(file: {name: AbsoluteFsPath, contents: string}) {\n     sourceFile: bundle.src.file,\n     renderer,\n     decorationAnalyses,\n-    switchMarkerAnalyses,\n     importManager\n   };\n }\n@@ -99,18 +95,6 @@ var BadIife = (function() {\n   ];\n }());\n \n-var compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;\n-var badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;\n-function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {\n-  var compilerFactory = injector.get(CompilerFactory);\n-  var compiler = compilerFactory.createCompiler([options]);\n-  return compiler.compileModuleAsync(moduleType);\n-}\n-\n-function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {\n-  ngDevMode && assertNgModuleType(moduleType);\n-  return Promise.resolve(new R3NgModuleFactory(moduleType));\n-}\n // Some other content\n export {A, B, C, NoIife, BadIife};`\n       };\n@@ -274,28 +258,6 @@ var A = (function() {`);\n       });\n     });\n \n-    describe('rewriteSwitchableDeclarations', () => {\n-      it('should switch marked declaration initializers', () => {\n-        const {renderer, program, sourceFile, switchMarkerAnalyses} = setup(PROGRAM);\n-        const file = getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n-        const output = new MagicString(PROGRAM.contents);\n-        renderer.rewriteSwitchableDeclarations(\n-            output, file, switchMarkerAnalyses.get(sourceFile)!.declarations);\n-        expect(output.toString())\n-            .not.toContain(`var compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;`);\n-        expect(output.toString())\n-            .toContain(`var badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;`);\n-        expect(output.toString())\n-            .toContain(`var compileNgModuleFactory = compileNgModuleFactory__POST_R3__;`);\n-        expect(output.toString())\n-            .toContain(\n-                `function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {`);\n-        expect(output.toString())\n-            .toContain(\n-                `function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {`);\n-      });\n-    });\n-\n     describe('addDefinitions', () => {\n       it('should insert the definitions directly before the return statement of the class IIFE',\n          () => {"
        },
        {
            "sha": "a2a149e5f4debeeb6bdb63a7446d3db3dfe8a10c",
            "filename": "packages/compiler-cli/ngcc/test/rendering/esm_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 49,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fesm_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fesm_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fesm_rendering_formatter_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -18,7 +18,6 @@ import {ImportManager} from '../../../src/ngtsc/translator';\n import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {ModuleWithProvidersAnalyzer} from '../../src/analysis/module_with_providers_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n-import {SwitchMarkerAnalyzer} from '../../src/analysis/switch_marker_analyzer';\n import {IMPORT_PREFIX} from '../../src/constants';\n import {Esm2015ReflectionHost} from '../../src/host/esm2015_host';\n import {EsmRenderingFormatter} from '../../src/rendering/esm_rendering_formatter';\n@@ -38,8 +37,6 @@ function setup(files: TestFile[], dtsFiles?: TestFile[]) {\n   const referencesRegistry = new NgccReferencesRegistry(host);\n   const decorationAnalyses =\n       new DecorationAnalyzer(fs, bundle, host, referencesRegistry).analyzeProgram();\n-  const switchMarkerAnalyses = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath)\n-                                   .analyzeProgram(bundle.src.program);\n   const renderer = new EsmRenderingFormatter(fs, host, false);\n   const importManager = new ImportManager(new NoopImportRewriter(), IMPORT_PREFIX);\n   return {\n@@ -49,7 +46,6 @@ function setup(files: TestFile[], dtsFiles?: TestFile[]) {\n     sourceFile: bundle.src.file,\n     renderer,\n     decorationAnalyses,\n-    switchMarkerAnalyses,\n     importManager,\n   };\n }\n@@ -75,19 +71,7 @@ C.decorators = [\n   { type: Directive, args: [{ selector: '[c]' }] },\n ];\n export C;\n-let compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;\n-let badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;\n \n-function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {\n-  const compilerFactory = injector.get(CompilerFactory);\n-  const compiler = compilerFactory.createCompiler([options]);\n-  return compiler.compileModuleAsync(moduleType);\n-}\n-\n-function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {\n-  ngDevMode && assertNgModuleType(moduleType);\n-  return Promise.resolve(new R3NgModuleFactory(moduleType));\n-}\n // Some other content`,\n \n \n@@ -120,17 +104,6 @@ C.decorators = [\n return C;\n })();\n export A, B, C;\n-let compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;\n-let badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;\n-function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {\n-  const compilerFactory = injector.get(CompilerFactory);\n-  const compiler = compilerFactory.createCompiler([options]);\n-  return compiler.compileModuleAsync(moduleType);\n-}\n-function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {\n-  ngDevMode && assertNgModuleType(moduleType);\n-  return Promise.resolve(new R3NgModuleFactory(moduleType));\n-}\n // Some other content`\n };\n \n@@ -242,28 +215,6 @@ const x = 3;\n         });\n       });\n \n-      describe('rewriteSwitchableDeclarations', () => {\n-        it('should switch marked declaration initializers', () => {\n-          const {renderer, program, switchMarkerAnalyses, sourceFile} = setup([PROGRAM]);\n-          const file = getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n-          const output = new MagicString(PROGRAM.contents);\n-          renderer.rewriteSwitchableDeclarations(\n-              output, file, switchMarkerAnalyses.get(sourceFile)!.declarations);\n-          expect(output.toString())\n-              .not.toContain(`let compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;`);\n-          expect(output.toString())\n-              .toContain(`let badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;`);\n-          expect(output.toString())\n-              .toContain(`let compileNgModuleFactory = compileNgModuleFactory__POST_R3__;`);\n-          expect(output.toString())\n-              .toContain(\n-                  `function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {`);\n-          expect(output.toString())\n-              .toContain(\n-                  `function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {`);\n-        });\n-      });\n-\n       describe('addDefinitions', () => {\n         it('should insert the definitions directly after the class declaration', () => {\n           const {renderer, decorationAnalyses, sourceFile} = setup([PROGRAM]);"
        },
        {
            "sha": "83e4f51b9ffc4bd420fa12f58781329b7a5c3c7e",
            "filename": "packages/compiler-cli/ngcc/test/rendering/renderer_spec.ts",
            "status": "modified",
            "additions": 57,
            "deletions": 177,
            "changes": 234,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Frenderer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Frenderer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Frenderer_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -21,7 +21,6 @@ import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {ModuleWithProvidersInfo} from '../../src/analysis/module_with_providers_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n import {ExportInfo, PrivateDeclarationsAnalyzer} from '../../src/analysis/private_declarations_analyzer';\n-import {SwitchMarkerAnalyzer} from '../../src/analysis/switch_marker_analyzer';\n import {CompiledClass} from '../../src/analysis/types';\n import {Esm2015ReflectionHost} from '../../src/host/esm2015_host';\n import {Esm5ReflectionHost} from '../../src/host/esm5_host';\n@@ -55,9 +54,6 @@ class TestRenderingFormatter implements RenderingFormatter {\n   removeDecorators(output: MagicString, decoratorsToRemove: RedundantDecoratorMap) {\n     output.prepend('\\n// REMOVE DECORATORS\\n');\n   }\n-  rewriteSwitchableDeclarations(output: MagicString, sourceFile: ts.SourceFile): void {\n-    output.prepend('\\n// REWRITTEN DECLARATIONS\\n');\n-  }\n   addModuleWithProvidersParams(\n       output: MagicString, moduleWithProviders: ModuleWithProvidersInfo[],\n       importManager: ImportManager): void {\n@@ -93,8 +89,6 @@ function createTestRenderer(\n   const referencesRegistry = new NgccReferencesRegistry(host);\n   const decorationAnalyses =\n       new DecorationAnalyzer(fs, bundle, host, referencesRegistry).analyzeProgram();\n-  const switchMarkerAnalyses = new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath)\n-                                   .analyzeProgram(bundle.src.program);\n   const privateDeclarationsAnalyses =\n       new PrivateDeclarationsAnalyzer(host, referencesRegistry).analyzeProgram(bundle.src.program);\n   const testFormatter = new TestRenderingFormatter(isEs5);\n@@ -104,20 +98,12 @@ function createTestRenderer(\n   spyOn(testFormatter, 'addAdjacentStatements').and.callThrough();\n   spyOn(testFormatter, 'addConstants').and.callThrough();\n   spyOn(testFormatter, 'removeDecorators').and.callThrough();\n-  spyOn(testFormatter, 'rewriteSwitchableDeclarations').and.callThrough();\n   spyOn(testFormatter, 'addModuleWithProvidersParams').and.callThrough();\n   spyOn(testFormatter, 'printStatement').and.callThrough();\n \n   const renderer = new Renderer(host, testFormatter, fs, logger, bundle);\n \n-  return {\n-    renderer,\n-    testFormatter,\n-    decorationAnalyses,\n-    switchMarkerAnalyses,\n-    privateDeclarationsAnalyses,\n-    bundle\n-  };\n+  return {renderer, testFormatter, decorationAnalyses, privateDeclarationsAnalyses, bundle};\n }\n \n runInEachFileSystem(() => {\n@@ -286,10 +272,10 @@ runInEachFileSystem(() => {\n     describe('renderProgram()', () => {\n       it('should render the modified contents; with an inline map file, if the original provided no map file.',\n          () => {\n-           const {renderer, decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses} =\n+           const {renderer, decorationAnalyses, privateDeclarationsAnalyses} =\n                createTestRenderer('test-package', [JS_CONTENT]);\n-           const [sourceFile, mapFile] = renderer.renderProgram(\n-               decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+           const [sourceFile, mapFile] =\n+               renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n            expect(sourceFile.path).toEqual(_('/node_modules/test-package/src/file.js'));\n            expect(sourceFile.contents).toContain(RENDERED_CONTENTS);\n            expect(mapHelpers.fromSource(sourceFile.contents)!.toObject())\n@@ -299,15 +285,9 @@ runInEachFileSystem(() => {\n \n \n       it('should render as JavaScript', () => {\n-        const {\n-          renderer,\n-          decorationAnalyses,\n-          switchMarkerAnalyses,\n-          privateDeclarationsAnalyses,\n-          testFormatter\n-        } = createTestRenderer('test-package', [COMPONENT_PROGRAM]);\n-        renderer.renderProgram(\n-            decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+        const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+            createTestRenderer('test-package', [COMPONENT_PROGRAM]);\n+        renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n         const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n         expect(addDefinitionsSpy.calls.first().args[2]).toEqual(`// TRANSPILED\n A.ɵfac = function A_Factory(t) { return new (t || A)(); };\n@@ -330,15 +310,9 @@ A.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: A, selectors: [[\"a\"]\n       describe('calling RenderingFormatter methods', () => {\n         it('should call addImports with the source code and info about the core Angular library.',\n            () => {\n-             const {\n-               renderer,\n-               decorationAnalyses,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses,\n-               testFormatter\n-             } = createTestRenderer('test-package', [JS_CONTENT]);\n-             const result = renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+                 createTestRenderer('test-package', [JS_CONTENT]);\n+             const result = renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              const addImportsSpy = testFormatter.addImports as jasmine.Spy;\n              expect(addImportsSpy.calls.first().args[0].toString()).toEqual(RENDERED_CONTENTS);\n              expect(addImportsSpy.calls.first().args[1]).toEqual([\n@@ -348,15 +322,9 @@ A.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: A, selectors: [[\"a\"]\n \n         it('should call addDefinitions with the source code, the analyzed class and the rendered definitions.',\n            () => {\n-             const {\n-               renderer,\n-               decorationAnalyses,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses,\n-               testFormatter\n-             } = createTestRenderer('test-package', [JS_CONTENT]);\n-             renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+                 createTestRenderer('test-package', [JS_CONTENT]);\n+             renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n              expect(addDefinitionsSpy.calls.first().args[0].toString()).toEqual(RENDERED_CONTENTS);\n              expect(addDefinitionsSpy.calls.first().args[1]).toEqual(jasmine.objectContaining({\n@@ -371,15 +339,9 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n \n         it('should call addAdjacentStatements with the source code, the analyzed class and the rendered statements',\n            () => {\n-             const {\n-               renderer,\n-               decorationAnalyses,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses,\n-               testFormatter\n-             } = createTestRenderer('test-package', [JS_CONTENT]);\n-             renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+                 createTestRenderer('test-package', [JS_CONTENT]);\n+             renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              const addAdjacentStatementsSpy = testFormatter.addAdjacentStatements as jasmine.Spy;\n              expect(addAdjacentStatementsSpy.calls.first().args[0].toString())\n                  .toEqual(RENDERED_CONTENTS);\n@@ -395,15 +357,9 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n \n         it('should call removeDecorators with the source code, a map of class decorators that have been analyzed',\n            () => {\n-             const {\n-               renderer,\n-               decorationAnalyses,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses,\n-               testFormatter\n-             } = createTestRenderer('test-package', [JS_CONTENT]);\n-             renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+                 createTestRenderer('test-package', [JS_CONTENT]);\n+             renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              const removeDecoratorsSpy = testFormatter.removeDecorators as jasmine.Spy;\n              expect(removeDecoratorsSpy.calls.first().args[0].toString())\n                  .toEqual(RENDERED_CONTENTS);\n@@ -423,44 +379,26 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n            });\n \n         it('should render definitions as static fields', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } = createTestRenderer('test-package', [NGMODULE_PROGRAM]);\n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+              createTestRenderer('test-package', [NGMODULE_PROGRAM]);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           const definitions: string = addDefinitionsSpy.calls.first().args[2];\n           expect(definitions).toContain('A.ɵmod = /*@__PURE__*/ ɵngcc0.ɵɵdefineNgModule(');\n           expect(definitions).toContain('A.ɵinj = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjector(');\n         });\n \n         it('should render adjacent statements', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } = createTestRenderer('test-package', [NGMODULE_PROGRAM]);\n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+              createTestRenderer('test-package', [NGMODULE_PROGRAM]);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n           const addAdjacentStatementsSpy = testFormatter.addAdjacentStatements as jasmine.Spy;\n           const statements: string = addAdjacentStatementsSpy.calls.first().args[2];\n           expect(statements).toContain('ɵsetClassMetadata(A');\n         });\n \n         it('should render directives using the inner class name if different from outer', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } =\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n               createTestRenderer(\n                   'test-package', [{\n                     name: _('/node_modules/test-package/src/file.js'),\n@@ -475,8 +413,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n                   }],\n                   undefined, undefined, /* isEs5 */ true);\n \n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n \n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           const definitions = addDefinitionsSpy.calls.first().args[2];\n@@ -491,13 +428,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n         });\n \n         it('should render injectables using the inner class name if different from outer', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } =\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n               createTestRenderer(\n                   'test-package', [{\n                     name: _('/node_modules/test-package/src/file.js'),\n@@ -512,8 +443,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n                   }],\n                   undefined, undefined, /* isEs5 */ true);\n \n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n \n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           const definitions = addDefinitionsSpy.calls.first().args[2];\n@@ -528,13 +458,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n         });\n \n         it('should render ng-modules using the inner class name if different from outer', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } =\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n               createTestRenderer(\n                   'test-package', [{\n                     name: _('/node_modules/test-package/src/file.js'),\n@@ -554,8 +478,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n                   }],\n                   undefined, undefined, /* isEs5 */ true);\n \n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n \n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           const definitions = addDefinitionsSpy.calls.all()[1].args[2];\n@@ -570,13 +493,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n         });\n \n         it('should render pipes using the inner class name if different from outer', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } =\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n               createTestRenderer(\n                   'test-package', [{\n                     name: _('/node_modules/test-package/src/file.js'),\n@@ -591,8 +508,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n                   }],\n                   undefined, undefined, /* isEs5 */ true);\n \n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n \n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           const definitions = addDefinitionsSpy.calls.first().args[2];\n@@ -606,13 +522,8 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n         });\n \n         it('should render classes without decorators if class fields are decorated', () => {\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } = createTestRenderer('test-package', [{\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+              createTestRenderer('test-package', [{\n                                    name: _('/node_modules/test-package/src/file.js'),\n                                    contents: `\n                   import { Directive, ViewChild } from '@angular/core';\n@@ -628,8 +539,7 @@ A.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: A, selectors: [[\"\",\n                 `\n                                  }]);\n \n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n \n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           expect(addDefinitionsSpy.calls.first().args[2]).toEqual(`// TRANSPILED\n@@ -645,20 +555,14 @@ UndecoratedBase.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Undeco\n \n         it('should call renderImports after other abstract methods', () => {\n           // This allows the other methods to add additional imports if necessary\n-          const {\n-            renderer,\n-            decorationAnalyses,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } = createTestRenderer('test-package', [JS_CONTENT]);\n+          const {renderer, decorationAnalyses, privateDeclarationsAnalyses, testFormatter} =\n+              createTestRenderer('test-package', [JS_CONTENT]);\n           const addExportsSpy = testFormatter.addExports as jasmine.Spy;\n           const addDefinitionsSpy = testFormatter.addDefinitions as jasmine.Spy;\n           const addAdjacentStatementsSpy = testFormatter.addAdjacentStatements as jasmine.Spy;\n           const addConstantsSpy = testFormatter.addConstants as jasmine.Spy;\n           const addImportsSpy = testFormatter.addImports as jasmine.Spy;\n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n           expect(addExportsSpy).toHaveBeenCalledBefore(addImportsSpy);\n           expect(addDefinitionsSpy).toHaveBeenCalledBefore(addImportsSpy);\n           expect(addAdjacentStatementsSpy).toHaveBeenCalledBefore(addImportsSpy);\n@@ -673,14 +577,10 @@ UndecoratedBase.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Undeco\n                name: JS_CONTENT.name,\n                contents: JS_CONTENT.contents + '\\n' + JS_CONTENT_MAP.toComment()\n              }];\n-             const {\n-               decorationAnalyses,\n-               renderer,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses\n-             } = createTestRenderer('test-package', sourceFiles);\n-             const [sourceFile, mapFile] = renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {decorationAnalyses, renderer, privateDeclarationsAnalyses} =\n+                 createTestRenderer('test-package', sourceFiles);\n+             const [sourceFile, mapFile] =\n+                 renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              expect(sourceFile.path).toEqual(_('/node_modules/test-package/src/file.js'));\n              expect(sourceFile.contents).toContain(RENDERED_CONTENTS);\n              expect(mapHelpers.fromSource(sourceFile.contents)!.toObject())\n@@ -696,14 +596,10 @@ UndecoratedBase.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Undeco\n              }];\n              const mappingFiles: TestFile[] =\n                  [{name: _(JS_CONTENT.name + '.map'), contents: JS_CONTENT_MAP.toJSON()}];\n-             const {\n-               decorationAnalyses,\n-               renderer,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses\n-             } = createTestRenderer('test-package', sourceFiles, undefined, mappingFiles);\n-             const [sourceFile, mapFile] = renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {decorationAnalyses, renderer, privateDeclarationsAnalyses} =\n+                 createTestRenderer('test-package', sourceFiles, undefined, mappingFiles);\n+             const [sourceFile, mapFile] =\n+                 renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              expect(sourceFile.path).toEqual(_('/node_modules/test-package/src/file.js'));\n              expect(sourceFile.contents)\n                  .toEqual(\n@@ -717,14 +613,10 @@ UndecoratedBase.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Undeco\n         it('should render an internal source map for files whose original file does not have a source map',\n            () => {\n              const sourceFiles: TestFile[] = [JS_CONTENT];\n-             const {\n-               decorationAnalyses,\n-               renderer,\n-               switchMarkerAnalyses,\n-               privateDeclarationsAnalyses\n-             } = createTestRenderer('test-package', sourceFiles, undefined);\n-             const [sourceFile, mapFile] = renderer.renderProgram(\n-                 decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+             const {decorationAnalyses, renderer, privateDeclarationsAnalyses} =\n+                 createTestRenderer('test-package', sourceFiles, undefined);\n+             const [sourceFile, mapFile] =\n+                 renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n              expect(sourceFile.path).toEqual(_('/node_modules/test-package/src/file.js'));\n              expect(sourceFile.contents)\n                  .toEqual(RENDERED_CONTENTS + '\\n' + OUTPUT_PROGRAM_MAP.toComment());\n@@ -746,15 +638,9 @@ UndecoratedBase.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Undeco\n             contents: `export const NgModule = () => null;`\n           };\n           // The package name of `@angular/core` indicates that we are compiling the core library.\n-          const {\n-            decorationAnalyses,\n-            renderer,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } = createTestRenderer('@angular/core', [CORE_FILE, R3_SYMBOLS_FILE]);\n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          const {decorationAnalyses, renderer, privateDeclarationsAnalyses, testFormatter} =\n+              createTestRenderer('@angular/core', [CORE_FILE, R3_SYMBOLS_FILE]);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n           const addAdjacentStatementsSpy = testFormatter.addAdjacentStatements as jasmine.Spy;\n           expect(addAdjacentStatementsSpy.calls.first().args[2])\n               .toContain(\n@@ -772,15 +658,9 @@ UndecoratedBase.ɵdir = /*@__PURE__*/ ɵngcc0.ɵɵdefineDirective({ type: Undeco\n             export class MyModule {}\\nMyModule.decorators = [\\n    { type: NgModule, args: [] }\\n];\\n`\n           };\n \n-          const {\n-            decorationAnalyses,\n-            renderer,\n-            switchMarkerAnalyses,\n-            privateDeclarationsAnalyses,\n-            testFormatter\n-          } = createTestRenderer('@angular/core', [CORE_FILE]);\n-          renderer.renderProgram(\n-              decorationAnalyses, switchMarkerAnalyses, privateDeclarationsAnalyses);\n+          const {decorationAnalyses, renderer, privateDeclarationsAnalyses, testFormatter} =\n+              createTestRenderer('@angular/core', [CORE_FILE]);\n+          renderer.renderProgram(decorationAnalyses, privateDeclarationsAnalyses);\n           const addAdjacentStatementsSpy = testFormatter.addAdjacentStatements as jasmine.Spy;\n           expect(addAdjacentStatementsSpy.calls.first().args[2])\n               .toContain("
        },
        {
            "sha": "46b6b92427450966485a4723c44ee87401f52814",
            "filename": "packages/compiler-cli/ngcc/test/rendering/umd_rendering_formatter_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 39,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8e65776cb35b08c435335ffeac0f82789477532/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Frendering%2Fumd_rendering_formatter_spec.ts?ref=d8e65776cb35b08c435335ffeac0f82789477532",
            "patch": "@@ -17,7 +17,6 @@ import {getDeclaration, loadTestFiles} from '../../../src/ngtsc/testing';\n import {ImportManager} from '../../../src/ngtsc/translator';\n import {DecorationAnalyzer} from '../../src/analysis/decoration_analyzer';\n import {NgccReferencesRegistry} from '../../src/analysis/ngcc_references_registry';\n-import {SwitchMarkerAnalyzer} from '../../src/analysis/switch_marker_analyzer';\n import {UmdReflectionHost} from '../../src/host/umd_host';\n import {UmdRenderingFormatter} from '../../src/rendering/umd_rendering_formatter';\n import {makeTestEntryPointBundle} from '../helpers/utils';\n@@ -36,8 +35,6 @@ function setup(file: TestFile) {\n   const referencesRegistry = new NgccReferencesRegistry(host);\n   const decorationAnalyses =\n       new DecorationAnalyzer(fs, bundle, host, referencesRegistry).analyzeProgram();\n-  const switchMarkerAnalyses =\n-      new SwitchMarkerAnalyzer(host, bundle.entryPoint.packagePath).analyzeProgram(src.program);\n   const renderer = new UmdRenderingFormatter(fs, host, false);\n   const importManager = new ImportManager(new NoopImportRewriter(), 'i');\n   return {\n@@ -47,7 +44,6 @@ function setup(file: TestFile) {\n     program: src.program,\n     renderer,\n     sourceFile: src.file,\n-    switchMarkerAnalyses\n   };\n }\n \n@@ -141,18 +137,6 @@ var BadIife = (function() {\n   ];\n }());\n \n-var compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;\n-var badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;\n-function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {\n-  var compilerFactory = injector.get(CompilerFactory);\n-  var compiler = compilerFactory.createCompiler([options]);\n-  return compiler.compileModuleAsync(moduleType);\n-}\n-\n-function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {\n-  ngDevMode && assertNgModuleType(moduleType);\n-  return Promise.resolve(new R3NgModuleFactory(moduleType));\n-}\n // Some other content\n exports.A = A;\n exports.B = B;\n@@ -496,29 +480,6 @@ var A = (function() {`);\n              });\n         });\n \n-        describe('rewriteSwitchableDeclarations', () => {\n-          it('should switch marked declaration initializers', () => {\n-            const {renderer, program, sourceFile, switchMarkerAnalyses} = setup(PROGRAM);\n-            const file =\n-                getSourceFileOrError(program, _('/node_modules/test-package/some/file.js'));\n-            const output = new MagicString(PROGRAM.contents);\n-            renderer.rewriteSwitchableDeclarations(\n-                output, file, switchMarkerAnalyses.get(sourceFile)!.declarations);\n-            expect(output.toString())\n-                .not.toContain(`var compileNgModuleFactory = compileNgModuleFactory__PRE_R3__;`);\n-            expect(output.toString())\n-                .toContain(`var badlyFormattedVariable = __PRE_R3__badlyFormattedVariable;`);\n-            expect(output.toString())\n-                .toContain(`var compileNgModuleFactory = compileNgModuleFactory__POST_R3__;`);\n-            expect(output.toString())\n-                .toContain(\n-                    `function compileNgModuleFactory__PRE_R3__(injector, options, moduleType) {`);\n-            expect(output.toString())\n-                .toContain(\n-                    `function compileNgModuleFactory__POST_R3__(injector, options, moduleType) {`);\n-          });\n-        });\n-\n         describe('addDefinitions', () => {\n           it('should insert the definitions directly before the return statement of the class IIFE',\n              () => {"
        }
    ],
    "stats": {
        "total": 740,
        "additions": 67,
        "deletions": 673
    }
}