{
    "author": "alxhub",
    "message": "fix(compiler-cli): ensure the compiler tracks `ts.Program`s correctly (#41291)\n\n`NgCompiler` previously had a notion of the \"next\" `ts.Program`, which\nserved two purposes:\n\n* it allowed a client using the `ts.createProgram` API to query for the\n  latest program produced by the previous `NgCompiler`, as a starting\n  point for building the _next_ program that incorporated any new user\n  changes.\n\n* it allowed the old `NgCompiler` to be queried for the `ts.Program` on\n  which all prior state is based, which is needed to compute the delta\n  from the new program to ultimately determine how much of the prior\n  state can be reused.\n\nThis system contained a flaw: it relied on the `NgCompiler` knowing when\nthe `ts.Program` would be changed. This works fine for changes that\noriginate in `NgCompiler` APIs, but a client of the `TemplateTypeChecker`\nmay use that API in ways that create new `ts.Program`s without the\n`NgCompiler`'s knowledge. This caused the `NgCompiler`'s concept of the\n\"next\" program to get out of sync, causing incorrectness in future\nincremental analysis.\n\nThis refactoring cleans up the compiler's `ts.Program` management in\nseveral ways:\n\n* `TypeCheckingProgramStrategy`, the API which controls `ts.Program`\n  updating, is renamed to the `ProgramDriver` and extracted to a separate\n  ngtsc package.\n\n* It loses its responsibility of determining component shim filenames. That\n  functionality now lives exclusively in the template type-checking package.\n\n* The \"next\" `ts.Program` concept is renamed to the \"current\" program, as\n  the \"next\" name was misleading in several ways.\n\n* `NgCompiler` now wraps the `ProgramDriver` used in the\n  `TemplateTypeChecker` to know when a new `ts.Program` is created,\n  regardless of which API drove the creation, which actually fixes the bug.\n\nPR Close #41291",
    "sha": "deacc741e0ee41666292d2e2c07812a78daf5d6f",
    "files": [
        {
            "sha": "29e00a0f90d94f0a2e8fd14f11b751915b9b660a",
            "filename": "packages/compiler-cli/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -33,6 +33,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/indexer\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/translator\","
        },
        {
            "sha": "901a47fa50236b86fe044828ef7b0811a5a0f3dd",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -26,6 +26,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/modulewithproviders\",\n         \"//packages/compiler-cli/src/ngtsc/partial_evaluator\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/resource\",\n         \"//packages/compiler-cli/src/ngtsc/routing\","
        },
        {
            "sha": "8a0ae5b4b373e204d8f463b44f0e8fc65a619725",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 88,
            "deletions": 59,
            "changes": 147,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -13,17 +13,16 @@ import {ComponentDecoratorHandler, DirectiveDecoratorHandler, InjectableDecorato\n import {CycleAnalyzer, CycleHandlingStrategy, ImportGraph} from '../../cycles';\n import {COMPILER_ERRORS_WITH_GUIDES, ERROR_DETAILS_PAGE_BASE_URL, ErrorCode, ngErrorCode} from '../../diagnostics';\n import {checkForPrivateExports, ReferenceGraph} from '../../entry_point';\n-import {LogicalFileSystem, resolve} from '../../file_system';\n+import {AbsoluteFsPath, LogicalFileSystem, resolve} from '../../file_system';\n import {AbsoluteModuleStrategy, AliasingHost, AliasStrategy, DefaultImportTracker, ImportRewriter, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NoopImportRewriter, PrivateExportAliasingHost, R3SymbolsImportRewriter, Reference, ReferenceEmitStrategy, ReferenceEmitter, RelativePathStrategy, UnifiedModulesAliasingHost, UnifiedModulesStrategy} from '../../imports';\n import {IncrementalBuildStrategy, IncrementalDriver} from '../../incremental';\n import {SemanticSymbol} from '../../incremental/semantic_graph';\n import {generateAnalysis, IndexedComponent, IndexingContext} from '../../indexer';\n import {ComponentResources, CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, MetadataReader, ResourceRegistry} from '../../metadata';\n import {ModuleWithProvidersScanner} from '../../modulewithproviders';\n import {PartialEvaluator} from '../../partial_evaluator';\n-import {ActivePerfRecorder} from '../../perf';\n-import {PerfCheckpoint, PerfEvent, PerfPhase} from '../../perf/src/api';\n-import {DelegatingPerfRecorder} from '../../perf/src/recorder';\n+import {ActivePerfRecorder, DelegatingPerfRecorder, PerfCheckpoint, PerfEvent, PerfPhase} from '../../perf';\n+import {ProgramDriver, UpdateMode} from '../../program_driver';\n import {DeclarationNode, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {AdapterResourceLoader} from '../../resource';\n import {entryPointKeyFor, NgModuleRouteAnalyzer} from '../../routing';\n@@ -32,7 +31,7 @@ import {generatedFactoryTransform} from '../../shims';\n import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, CompilationMode, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n-import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy} from '../../typecheck/api';\n+import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig} from '../../typecheck/api';\n import {getSourceFileOrNull, isDtsPath, resolveModuleName} from '../../util/src/typescript';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n \n@@ -78,7 +77,7 @@ export interface FreshCompilationTicket {\n   kind: CompilationTicketKind.Fresh;\n   options: NgCompilerOptions;\n   incrementalBuildStrategy: IncrementalBuildStrategy;\n-  typeCheckingProgramStrategy: TypeCheckingProgramStrategy;\n+  programDriver: ProgramDriver;\n   enableTemplateTypeChecker: boolean;\n   usePoisonedData: boolean;\n   tsProgram: ts.Program;\n@@ -94,7 +93,7 @@ export interface IncrementalTypeScriptCompilationTicket {\n   oldProgram: ts.Program;\n   newProgram: ts.Program;\n   incrementalBuildStrategy: IncrementalBuildStrategy;\n-  typeCheckingProgramStrategy: TypeCheckingProgramStrategy;\n+  programDriver: ProgramDriver;\n   newDriver: IncrementalDriver;\n   enableTemplateTypeChecker: boolean;\n   usePoisonedData: boolean;\n@@ -123,15 +122,15 @@ export type CompilationTicket = FreshCompilationTicket|IncrementalTypeScriptComp\n  */\n export function freshCompilationTicket(\n     tsProgram: ts.Program, options: NgCompilerOptions,\n-    incrementalBuildStrategy: IncrementalBuildStrategy,\n-    typeCheckingProgramStrategy: TypeCheckingProgramStrategy, perfRecorder: ActivePerfRecorder|null,\n-    enableTemplateTypeChecker: boolean, usePoisonedData: boolean): CompilationTicket {\n+    incrementalBuildStrategy: IncrementalBuildStrategy, programDriver: ProgramDriver,\n+    perfRecorder: ActivePerfRecorder|null, enableTemplateTypeChecker: boolean,\n+    usePoisonedData: boolean): CompilationTicket {\n   return {\n     kind: CompilationTicketKind.Fresh,\n     tsProgram,\n     options,\n     incrementalBuildStrategy,\n-    typeCheckingProgramStrategy,\n+    programDriver,\n     enableTemplateTypeChecker,\n     usePoisonedData,\n     perfRecorder: perfRecorder ?? ActivePerfRecorder.zeroedToNow(),\n@@ -144,17 +143,16 @@ export function freshCompilationTicket(\n  */\n export function incrementalFromCompilerTicket(\n     oldCompiler: NgCompiler, newProgram: ts.Program,\n-    incrementalBuildStrategy: IncrementalBuildStrategy,\n-    typeCheckingProgramStrategy: TypeCheckingProgramStrategy, modifiedResourceFiles: Set<string>,\n-    perfRecorder: ActivePerfRecorder|null): CompilationTicket {\n-  const oldProgram = oldCompiler.getNextProgram();\n+    incrementalBuildStrategy: IncrementalBuildStrategy, programDriver: ProgramDriver,\n+    modifiedResourceFiles: Set<string>, perfRecorder: ActivePerfRecorder|null): CompilationTicket {\n+  const oldProgram = oldCompiler.getCurrentProgram();\n   const oldDriver = oldCompiler.incrementalStrategy.getIncrementalDriver(oldProgram);\n   if (oldDriver === null) {\n     // No incremental step is possible here, since no IncrementalDriver was found for the old\n     // program.\n     return freshCompilationTicket(\n-        newProgram, oldCompiler.options, incrementalBuildStrategy, typeCheckingProgramStrategy,\n-        perfRecorder, oldCompiler.enableTemplateTypeChecker, oldCompiler.usePoisonedData);\n+        newProgram, oldCompiler.options, incrementalBuildStrategy, programDriver, perfRecorder,\n+        oldCompiler.enableTemplateTypeChecker, oldCompiler.usePoisonedData);\n   }\n \n   if (perfRecorder === null) {\n@@ -170,7 +168,7 @@ export function incrementalFromCompilerTicket(\n     usePoisonedData: oldCompiler.usePoisonedData,\n     options: oldCompiler.options,\n     incrementalBuildStrategy,\n-    typeCheckingProgramStrategy,\n+    programDriver,\n     newDriver,\n     oldProgram,\n     newProgram,\n@@ -185,13 +183,12 @@ export function incrementalFromCompilerTicket(\n export function incrementalFromDriverTicket(\n     oldProgram: ts.Program, oldDriver: IncrementalDriver, newProgram: ts.Program,\n     options: NgCompilerOptions, incrementalBuildStrategy: IncrementalBuildStrategy,\n-    typeCheckingProgramStrategy: TypeCheckingProgramStrategy, modifiedResourceFiles: Set<string>,\n+    programDriver: ProgramDriver, modifiedResourceFiles: Set<string>,\n     perfRecorder: ActivePerfRecorder|null, enableTemplateTypeChecker: boolean,\n     usePoisonedData: boolean): CompilationTicket {\n   if (perfRecorder === null) {\n     perfRecorder = ActivePerfRecorder.zeroedToNow();\n   }\n-\n   const newDriver = IncrementalDriver.reconcile(\n       oldProgram, oldDriver, newProgram, modifiedResourceFiles, perfRecorder);\n   return {\n@@ -201,7 +198,7 @@ export function incrementalFromDriverTicket(\n     options,\n     incrementalBuildStrategy,\n     newDriver,\n-    typeCheckingProgramStrategy,\n+    programDriver,\n     enableTemplateTypeChecker,\n     usePoisonedData,\n     perfRecorder,\n@@ -255,7 +252,7 @@ export class NgCompiler {\n   private nonTemplateDiagnostics: ts.Diagnostic[]|null = null;\n \n   private closureCompilerEnabled: boolean;\n-  private nextProgram: ts.Program;\n+  private currentProgram: ts.Program;\n   private entryPoint: ts.SourceFile|null;\n   private moduleResolver: ModuleResolver;\n   private resourceManager: AdapterResourceLoader;\n@@ -286,7 +283,7 @@ export class NgCompiler {\n             adapter,\n             ticket.options,\n             ticket.tsProgram,\n-            ticket.typeCheckingProgramStrategy,\n+            ticket.programDriver,\n             ticket.incrementalBuildStrategy,\n             IncrementalDriver.fresh(ticket.tsProgram),\n             ticket.enableTemplateTypeChecker,\n@@ -298,7 +295,7 @@ export class NgCompiler {\n             adapter,\n             ticket.options,\n             ticket.newProgram,\n-            ticket.typeCheckingProgramStrategy,\n+            ticket.programDriver,\n             ticket.incrementalBuildStrategy,\n             ticket.newDriver,\n             ticket.enableTemplateTypeChecker,\n@@ -315,8 +312,8 @@ export class NgCompiler {\n   private constructor(\n       private adapter: NgCompilerAdapter,\n       readonly options: NgCompilerOptions,\n-      private tsProgram: ts.Program,\n-      readonly typeCheckingProgramStrategy: TypeCheckingProgramStrategy,\n+      private inputProgram: ts.Program,\n+      readonly programDriver: ProgramDriver,\n       readonly incrementalStrategy: IncrementalBuildStrategy,\n       readonly incrementalDriver: IncrementalDriver,\n       readonly enableTemplateTypeChecker: boolean,\n@@ -329,11 +326,11 @@ export class NgCompiler {\n       this.constructionDiagnostics.push(incompatibleTypeCheckOptionsDiagnostic);\n     }\n \n-    this.nextProgram = tsProgram;\n+    this.currentProgram = inputProgram;\n     this.closureCompilerEnabled = !!this.options.annotateForClosureCompiler;\n \n     this.entryPoint =\n-        adapter.entryPoint !== null ? getSourceFileOrNull(tsProgram, adapter.entryPoint) : null;\n+        adapter.entryPoint !== null ? getSourceFileOrNull(inputProgram, adapter.entryPoint) : null;\n \n     const moduleResolutionCache = ts.createModuleResolutionCache(\n         this.adapter.getCurrentDirectory(),\n@@ -343,19 +340,19 @@ export class NgCompiler {\n         // way into all kinds of places inside TS internal objects.\n         this.adapter.getCanonicalFileName.bind(this.adapter));\n     this.moduleResolver =\n-        new ModuleResolver(tsProgram, this.options, this.adapter, moduleResolutionCache);\n+        new ModuleResolver(inputProgram, this.options, this.adapter, moduleResolutionCache);\n     this.resourceManager = new AdapterResourceLoader(adapter, this.options);\n-    this.cycleAnalyzer =\n-        new CycleAnalyzer(new ImportGraph(tsProgram.getTypeChecker(), this.delegatingPerfRecorder));\n-    this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, tsProgram);\n+    this.cycleAnalyzer = new CycleAnalyzer(\n+        new ImportGraph(inputProgram.getTypeChecker(), this.delegatingPerfRecorder));\n+    this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, inputProgram);\n \n     this.ignoreForDiagnostics =\n-        new Set(tsProgram.getSourceFiles().filter(sf => this.adapter.isShim(sf)));\n+        new Set(inputProgram.getSourceFiles().filter(sf => this.adapter.isShim(sf)));\n     this.ignoreForEmit = this.adapter.ignoreForEmit;\n \n     let dtsFileCount = 0;\n     let nonDtsFileCount = 0;\n-    for (const sf of tsProgram.getSourceFiles()) {\n+    for (const sf of inputProgram.getSourceFiles()) {\n       if (sf.isDeclarationFile) {\n         dtsFileCount++;\n       } else {\n@@ -462,16 +459,22 @@ export class NgCompiler {\n   }\n \n   /**\n-   * Get the `ts.Program` to use as a starting point when spawning a subsequent incremental\n-   * compilation.\n+   * Get the current `ts.Program` known to this `NgCompiler`.\n+   *\n+   * Compilation begins with an input `ts.Program`, and during template type-checking operations new\n+   * `ts.Program`s may be produced using the `ProgramDriver`. The most recent such `ts.Program` to\n+   * be produced is available here.\n    *\n-   * The `NgCompiler` spawns an internal incremental TypeScript compilation (inheriting the\n-   * consumer's `ts.Program` into a new one for the purposes of template type-checking). After this\n-   * operation, the consumer's `ts.Program` is no longer usable for starting a new incremental\n-   * compilation. `getNextProgram` retrieves the `ts.Program` which can be used instead.\n+   * This `ts.Program` serves two key purposes:\n+   *\n+   * * As an incremental starting point for creating the next `ts.Program` based on files that the\n+   *   user has changed (for clients using the TS compiler program APIs).\n+   *\n+   * * As the \"before\" point for an incremental compilation invocation, to determine what's changed\n+   *   between the old and new programs (for all compilations).\n    */\n-  getNextProgram(): ts.Program {\n-    return this.nextProgram;\n+  getCurrentProgram(): ts.Program {\n+    return this.currentProgram;\n   }\n \n   getTemplateTypeChecker(): TemplateTypeChecker {\n@@ -533,7 +536,7 @@ export class NgCompiler {\n       this.compilation = this.makeCompilation();\n \n       const promises: Promise<void>[] = [];\n-      for (const sf of this.tsProgram.getSourceFiles()) {\n+      for (const sf of this.inputProgram.getSourceFiles()) {\n         if (sf.isDeclarationFile) {\n           continue;\n         }\n@@ -579,7 +582,7 @@ export class NgCompiler {\n       //\n       // In all cases above, the `containingFile` argument is ignored, so we can just take the first\n       // of the root files.\n-      const containingFile = this.tsProgram.getRootFileNames()[0];\n+      const containingFile = this.inputProgram.getRootFileNames()[0];\n       const [entryPath, moduleName] = entryRoute.split('#');\n       const resolvedModule =\n           resolveModuleName(entryPath, containingFile, this.options, this.adapter, null);\n@@ -602,7 +605,7 @@ export class NgCompiler {\n   } {\n     const compilation = this.ensureAnalyzed();\n \n-    const coreImportsFrom = compilation.isCore ? getR3SymbolsFile(this.tsProgram) : null;\n+    const coreImportsFrom = compilation.isCore ? getR3SymbolsFile(this.inputProgram) : null;\n     let importRewriter: ImportRewriter;\n     if (coreImportsFrom !== null) {\n       importRewriter = new R3SymbolsImportRewriter(coreImportsFrom.fileName);\n@@ -661,7 +664,7 @@ export class NgCompiler {\n   private analyzeSync(): void {\n     this.perfRecorder.inPhase(PerfPhase.Analysis, () => {\n       this.compilation = this.makeCompilation();\n-      for (const sf of this.tsProgram.getSourceFiles()) {\n+      for (const sf of this.inputProgram.getSourceFiles()) {\n         if (sf.isDeclarationFile) {\n           continue;\n         }\n@@ -703,7 +706,7 @@ export class NgCompiler {\n     // is not disabled when `strictTemplates` is enabled.\n     const strictTemplates = !!this.options.strictTemplates;\n \n-    const useInlineTypeConstructors = this.typeCheckingProgramStrategy.supportsInlineOperations;\n+    const useInlineTypeConstructors = this.programDriver.supportsInlineOperations;\n \n     // First select a type-checking configuration, based on whether full template type-checking is\n     // requested.\n@@ -816,7 +819,7 @@ export class NgCompiler {\n \n     // Get the diagnostics.\n     const diagnostics: ts.Diagnostic[] = [];\n-    for (const sf of this.tsProgram.getSourceFiles()) {\n+    for (const sf of this.inputProgram.getSourceFiles()) {\n       if (sf.isDeclarationFile || this.adapter.isShim(sf)) {\n         continue;\n       }\n@@ -825,9 +828,9 @@ export class NgCompiler {\n           ...compilation.templateTypeChecker.getDiagnosticsForFile(sf, OptimizeFor.WholeProgram));\n     }\n \n-    const program = this.typeCheckingProgramStrategy.getProgram();\n+    const program = this.programDriver.getProgram();\n     this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, program);\n-    this.nextProgram = program;\n+    this.currentProgram = program;\n \n     return diagnostics;\n   }\n@@ -842,9 +845,9 @@ export class NgCompiler {\n       diagnostics.push(...compilation.templateTypeChecker.getDiagnosticsForFile(sf, optimizeFor));\n     }\n \n-    const program = this.typeCheckingProgramStrategy.getProgram();\n+    const program = this.programDriver.getProgram();\n     this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, program);\n-    this.nextProgram = program;\n+    this.currentProgram = program;\n \n     return diagnostics;\n   }\n@@ -855,7 +858,7 @@ export class NgCompiler {\n       this.nonTemplateDiagnostics = [...compilation.traitCompiler.diagnostics];\n       if (this.entryPoint !== null && compilation.exportReferenceGraph !== null) {\n         this.nonTemplateDiagnostics.push(...checkForPrivateExports(\n-            this.entryPoint, this.tsProgram.getTypeChecker(), compilation.exportReferenceGraph));\n+            this.entryPoint, this.inputProgram.getTypeChecker(), compilation.exportReferenceGraph));\n       }\n     }\n     return this.nonTemplateDiagnostics;\n@@ -872,7 +875,7 @@ export class NgCompiler {\n   }\n \n   private makeCompilation(): LazyCompilationState {\n-    const checker = this.tsProgram.getTypeChecker();\n+    const checker = this.inputProgram.getTypeChecker();\n \n     const reflector = new TypeScriptReflectionHost(checker);\n \n@@ -904,7 +907,7 @@ export class NgCompiler {\n         // First, try to use local identifiers if available.\n         new LocalIdentifierStrategy(),\n         // Next, attempt to use an absolute import.\n-        new AbsoluteModuleStrategy(this.tsProgram, checker, this.moduleResolver, reflector),\n+        new AbsoluteModuleStrategy(this.inputProgram, checker, this.moduleResolver, reflector),\n         // Finally, check if the reference is being written into a file within the project's .ts\n         // sources, and use a relative import if so. If this fails, ReferenceEmitter will throw\n         // an error.\n@@ -966,7 +969,7 @@ export class NgCompiler {\n \n     const mwpScanner = new ModuleWithProvidersScanner(reflector, evaluator, refEmitter);\n \n-    const isCore = isAngularCorePackage(this.tsProgram);\n+    const isCore = isAngularCorePackage(this.inputProgram);\n \n     const defaultImportTracker = new DefaultImportTracker();\n     const resourceRegistry = new ResourceRegistry();\n@@ -1024,10 +1027,18 @@ export class NgCompiler {\n         this.options.compileNonExportedClasses !== false, compilationMode, dtsTransforms,\n         semanticDepGraphUpdater);\n \n+    // Template type-checking may use the `ProgramDriver` to produce new `ts.Program`(s). If this\n+    // happens, they need to be tracked by the `NgCompiler`.\n+    const notifyingDriver =\n+        new NotifyingProgramDriverWrapper(this.programDriver, (program: ts.Program) => {\n+          this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, program);\n+          this.currentProgram = program;\n+        });\n+\n     const templateTypeChecker = new TemplateTypeCheckerImpl(\n-        this.tsProgram, this.typeCheckingProgramStrategy, traitCompiler,\n-        this.getTypeCheckingConfig(), refEmitter, reflector, this.adapter, this.incrementalDriver,\n-        scopeRegistry, typeCheckScopeRegistry, this.delegatingPerfRecorder);\n+        this.inputProgram, notifyingDriver, traitCompiler, this.getTypeCheckingConfig(), refEmitter,\n+        reflector, this.adapter, this.incrementalDriver, scopeRegistry, typeCheckScopeRegistry,\n+        this.delegatingPerfRecorder);\n \n     return {\n       isCore,\n@@ -1141,3 +1152,21 @@ class ReferenceGraphAdapter implements ReferencesRegistry {\n     }\n   }\n }\n+\n+class NotifyingProgramDriverWrapper implements ProgramDriver {\n+  constructor(\n+      private delegate: ProgramDriver, private notifyNewProgram: (program: ts.Program) => void) {}\n+\n+  get supportsInlineOperations() {\n+    return this.delegate.supportsInlineOperations;\n+  }\n+\n+  getProgram(): ts.Program {\n+    return this.delegate.getProgram();\n+  }\n+\n+  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void {\n+    this.delegate.updateFiles(contents, updateMode);\n+    this.notifyNewProgram(this.delegate.getProgram());\n+  }\n+}"
        },
        {
            "sha": "9ff0a5b7504ea89a20713d583355cba18007b0b0",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -15,6 +15,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\","
        },
        {
            "sha": "141f90bc9911a144d04f88810f02c345b0e7c62a",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/compiler_test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -11,9 +11,9 @@ import * as ts from 'typescript';\n import {absoluteFrom as _, FileSystem, getFileSystem, getSourceFileOrError, NgtscCompilerHost, setFileSystem} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {IncrementalBuildStrategy, NoopIncrementalBuildStrategy} from '../../incremental';\n+import {ProgramDriver, TsCreateProgramDriver} from '../../program_driver';\n import {ClassDeclaration, isNamedClassDeclaration} from '../../reflection';\n-import {ReusedProgramStrategy} from '../../typecheck';\n-import {OptimizeFor, TypeCheckingProgramStrategy} from '../../typecheck/api';\n+import {OptimizeFor} from '../../typecheck/api';\n \n import {NgCompilerOptions} from '../api';\n \n@@ -22,7 +22,7 @@ import {NgCompilerHost} from '../src/host';\n \n function makeFreshCompiler(\n     host: NgCompilerHost, options: NgCompilerOptions, program: ts.Program,\n-    programStrategy: TypeCheckingProgramStrategy, incrementalStrategy: IncrementalBuildStrategy,\n+    programStrategy: ProgramDriver, incrementalStrategy: IncrementalBuildStrategy,\n     enableTemplateTypeChecker: boolean, usePoisonedData: boolean): NgCompiler {\n   const ticket = freshCompilationTicket(\n       program, options, incrementalStrategy, programStrategy, /* perfRecorder */ null,\n@@ -61,7 +61,7 @@ runInEachFileSystem(() => {\n       const host = NgCompilerHost.wrap(baseHost, [COMPONENT], options, /* oldProgram */ null);\n       const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n       const compiler = makeFreshCompiler(\n-          host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+          host, options, program, new TsCreateProgramDriver(program, host, options, []),\n           new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n           /* usePoisonedData */ false);\n \n@@ -113,7 +113,7 @@ runInEachFileSystem(() => {\n         const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n \n         const compiler = makeFreshCompiler(\n-            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            host, options, program, new TsCreateProgramDriver(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n         const components = compiler.getComponentsWithTemplateFile(templateFile);\n@@ -165,7 +165,7 @@ runInEachFileSystem(() => {\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n         const compiler = makeFreshCompiler(\n-            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            host, options, program, new TsCreateProgramDriver(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n         const components = compiler.getComponentsWithStyleFile(styleFile);\n@@ -199,7 +199,7 @@ runInEachFileSystem(() => {\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const compiler = makeFreshCompiler(\n-            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            host, options, program, new TsCreateProgramDriver(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n         const resources = compiler.getComponentResources(CmpA);\n@@ -235,7 +235,7 @@ runInEachFileSystem(() => {\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const compiler = makeFreshCompiler(\n-            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            host, options, program, new TsCreateProgramDriver(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n         const resources = compiler.getComponentResources(CmpA);\n@@ -267,7 +267,7 @@ runInEachFileSystem(() => {\n         const host = NgCompilerHost.wrap(baseHost, [COMPONENT], options, /* oldProgram */ null);\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const compiler = makeFreshCompiler(\n-            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            host, options, program, new TsCreateProgramDriver(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n \n@@ -301,7 +301,7 @@ runInEachFileSystem(() => {\n         const host = NgCompilerHost.wrap(baseHost, [COMPONENT], options, /* oldProgram */ null);\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const compilerA = makeFreshCompiler(\n-            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            host, options, program, new TsCreateProgramDriver(program, host, options, []),\n             new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n             /* usePoisonedData */ false);\n "
        },
        {
            "sha": "a0074dd7e75e36e7ffb894e273905b05c05e6c7b",
            "filename": "packages/compiler-cli/src/ngtsc/program.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -18,9 +18,9 @@ import {absoluteFrom, AbsoluteFsPath, getFileSystem} from './file_system';\n import {TrackedIncrementalBuildStrategy} from './incremental';\n import {IndexedComponent} from './indexer';\n import {ActivePerfRecorder, PerfCheckpoint as PerfCheckpoint, PerfEvent, PerfPhase} from './perf';\n+import {TsCreateProgramDriver} from './program_driver';\n import {DeclarationNode} from './reflection';\n import {retagAllTsFiles, untagAllTsFiles} from './shims';\n-import {ReusedProgramStrategy} from './typecheck';\n import {OptimizeFor} from './typecheck/api';\n \n \n@@ -95,7 +95,7 @@ export class NgtscProgram implements api.Program {\n     // the program.\n     untagAllTsFiles(this.tsProgram);\n \n-    const reusedProgramStrategy = new ReusedProgramStrategy(\n+    const programDriver = new TsCreateProgramDriver(\n         this.tsProgram, this.host, this.options, this.host.shimExtensionPrefixes);\n \n     this.incrementalStrategy = oldProgram !== undefined ?\n@@ -114,14 +114,14 @@ export class NgtscProgram implements api.Program {\n     let ticket: CompilationTicket;\n     if (oldProgram === undefined) {\n       ticket = freshCompilationTicket(\n-          this.tsProgram, options, this.incrementalStrategy, reusedProgramStrategy, perfRecorder,\n+          this.tsProgram, options, this.incrementalStrategy, programDriver, perfRecorder,\n           /* enableTemplateTypeChecker */ false, /* usePoisonedData */ false);\n     } else {\n       ticket = incrementalFromCompilerTicket(\n           oldProgram.compiler,\n           this.tsProgram,\n           this.incrementalStrategy,\n-          reusedProgramStrategy,\n+          programDriver,\n           modifiedResourceFiles,\n           perfRecorder,\n       );\n@@ -223,7 +223,7 @@ export class NgtscProgram implements api.Program {\n     const diagnostics = sf === undefined ?\n         this.compiler.getDiagnostics() :\n         this.compiler.getDiagnosticsForFile(sf, OptimizeFor.WholeProgram);\n-    this.reuseTsProgram = this.compiler.getNextProgram();\n+    this.reuseTsProgram = this.compiler.getCurrentProgram();\n     return diagnostics;\n   }\n "
        },
        {
            "sha": "cc52a91289519ff54b83655479f8d7cec781fad2",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/BUILD.bazel",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -0,0 +1,17 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"program_driver\",\n+    srcs = [\"index.ts\"] + glob([\n+        \"src/*.ts\",\n+    ]),\n+    module_name = \"@angular/compiler-cli/src/ngtsc/program_driver\",\n+    deps = [\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/shims\",\n+        \"//packages/compiler-cli/src/ngtsc/util\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "9d230f5bbb18a51837f72554de26033980bddef5",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/README.md",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2FREADME.md?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -0,0 +1,18 @@\n+# The Program Driver interface\n+\n+`ProgramDriver` is a small but important interface which allows the template type-checking machinery to request changes to the current `ts.Program`, and to receive a new `ts.Program` with those changes applied. This is used to add template type-checking code to the current `ts.Program`, eventually allowing for diagnostics to be produced within that code. This operation is abstracted behind this interface because different clients create `ts.Program`s differently. The Language Service, for example, creates `ts.Program`s from the current editor state on request, while the TS compiler API creates them explicitly.\n+\n+When running using the TS APIs, it's important that each new `ts.Program` be created incrementally from the previous `ts.Program`. Under a normal compilation, this means that programs alternate between template type checking programs and user programs:\n+\n+* `ts.Program#1` is created from user input (the user's source files).\n+* `ts.Program#2` is created incrementally on top of #1 for template type-checking, and adds private TCB code.\n+* `ts.Program#3` is created incrementally on top of #2 when the user makes changes to files on disk (incremental build).\n+* `ts.Program#4` is created incrementally on top of #3 to adjust template type-checking code according to the user's changes.\n+\n+The `TsCreateProgramDriver` performs this operation for template type-checking `ts.Program`s built by the command-line compiler or by the CLI. The latest template type-checking program is then exposed via the `NgCompiler`'s `getCurrentProgram()` operation, and new user programs are expected to be created incrementally on top of the previous template type-checking program.\n+\n+## Programs and the compiler as a service\n+\n+Not all clients of the compiler follow the incremental tick-tock scenario above. When the compiler is used as a service, new `ts.Program`s may be generated in response to various queries, either directly to `NgCompiler` or via the `TemplateTypeChecker`. Internally, the compiler will use the current `ProgramDriver` to create these additional `ts.Program`s as needed.\n+\n+Incremental builds (new user code changes) may also require changing the `ts.Program`, using the compiler's incremental ticket process. If the `TsCreateProgramDriver` is used, the client is responsible for ensuring that any new incremental `ts.Program`s are created on top of the current program from the previous compilation, which can be obtained via `NgCompiler`'s `getCurrentProgram()`.\n\\ No newline at end of file"
        },
        {
            "sha": "5478afc9761c197dd1f22e8cadfab7d42786e6c5",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/index.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Findex.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './src/api';\n+export {TsCreateProgramDriver} from './src/ts_create_program_driver';"
        },
        {
            "sha": "d8008489a88d68ee9829d90555f6885c8958365e",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/src/api.ts",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -0,0 +1,44 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+import {AbsoluteFsPath} from '../../file_system';\n+\n+export interface ProgramDriver {\n+  /**\n+   * Whether this strategy supports modifying user files (inline modifications) in addition to\n+   * modifying type-checking shims.\n+   */\n+  readonly supportsInlineOperations: boolean;\n+\n+  /**\n+   * Retrieve the latest version of the program, containing all the updates made thus far.\n+   */\n+  getProgram(): ts.Program;\n+\n+  /**\n+   * Incorporate a set of changes to either augment or completely replace the type-checking code\n+   * included in the type-checking program.\n+   */\n+  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void;\n+}\n+\n+export enum UpdateMode {\n+  /**\n+   * A complete update creates a completely new overlay of type-checking code on top of the user's\n+   * original program, which doesn't include type-checking code from previous calls to\n+   * `updateFiles`.\n+   */\n+  Complete,\n+\n+  /**\n+   * An incremental update changes the contents of some files in the type-checking program without\n+   * reverting any prior changes.\n+   */\n+  Incremental,\n+}"
        },
        {
            "sha": "74acda952e7b79eae41d2f88346997b0e1ddd961",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/src/ts_create_program_driver.ts",
            "status": "renamed",
            "additions": 85,
            "deletions": 6,
            "changes": 91,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -8,9 +8,20 @@\n \n import * as ts from 'typescript';\n \n-import {copyFileShimData, ShimReferenceTagger} from '../../shims';\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {AbsoluteFsPath} from '../../file_system';\n+import {copyFileShimData, retagAllTsFiles, ShimReferenceTagger, untagAllTsFiles} from '../../shims';\n import {RequiredDelegations} from '../../util/src/typescript';\n \n+import {ProgramDriver, UpdateMode} from './api';\n+\n /**\n  * Delegates all methods of `ts.CompilerHost` to a delegate, with the exception of\n  * `getSourceFile`, `fileExists` and `writeFile` which are implemented in `TypeCheckProgramHost`.\n@@ -51,10 +62,9 @@ export class DelegatingCompilerHost implements\n }\n \n /**\n- * A `ts.CompilerHost` which augments source files with type checking code from a\n- * `TypeCheckContext`.\n+ * A `ts.CompilerHost` which augments source files.\n  */\n-export class TypeCheckProgramHost extends DelegatingCompilerHost {\n+class UpdatedProgramHost extends DelegatingCompilerHost {\n   /**\n    * Map of source file names to `ts.SourceFile` instances.\n    */\n@@ -63,12 +73,12 @@ export class TypeCheckProgramHost extends DelegatingCompilerHost {\n   /**\n    * The `ShimReferenceTagger` responsible for tagging `ts.SourceFile`s loaded via this host.\n    *\n-   * The `TypeCheckProgramHost` is used in the creation of a new `ts.Program`. Even though this new\n+   * The `UpdatedProgramHost` is used in the creation of a new `ts.Program`. Even though this new\n    * program is based on a prior one, TypeScript will still start from the root files and enumerate\n    * all source files to include in the new program.  This means that just like during the original\n    * program's creation, these source files must be tagged with references to per-file shims in\n    * order for those shims to be loaded, and then cleaned up afterwards. Thus the\n-   * `TypeCheckProgramHost` has its own `ShimReferenceTagger` to perform this function.\n+   * `UpdatedProgramHost` has its own `ShimReferenceTagger` to perform this function.\n    */\n   private shimTagger = new ShimReferenceTagger(this.shimExtensionPrefixes);\n \n@@ -127,3 +137,72 @@ export class TypeCheckProgramHost extends DelegatingCompilerHost {\n     return this.sfMap.has(fileName) || this.delegate.fileExists(fileName);\n   }\n }\n+\n+\n+/**\n+ * Updates a `ts.Program` instance with a new one that incorporates specific changes, using the\n+ * TypeScript compiler APIs for incremental program creation.\n+ */\n+export class TsCreateProgramDriver implements ProgramDriver {\n+  /**\n+   * A map of source file paths to replacement `ts.SourceFile`s for those paths.\n+   *\n+   * Effectively, this tracks the delta between the user's program (represented by the\n+   * `originalHost`) and the template type-checking program being managed.\n+   */\n+  private sfMap = new Map<string, ts.SourceFile>();\n+\n+  private program: ts.Program = this.originalProgram;\n+\n+  constructor(\n+      private originalProgram: ts.Program, private originalHost: ts.CompilerHost,\n+      private options: ts.CompilerOptions, private shimExtensionPrefixes: string[]) {}\n+\n+  readonly supportsInlineOperations = true;\n+\n+  getProgram(): ts.Program {\n+    return this.program;\n+  }\n+\n+  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void {\n+    if (contents.size === 0) {\n+      // No changes have been requested. Is it safe to skip updating entirely?\n+      // If UpdateMode is Incremental, then yes. If UpdateMode is Complete, then it's safe to skip\n+      // only if there are no active changes already (that would be cleared by the update).\n+\n+      if (updateMode !== UpdateMode.Complete || this.sfMap.size === 0) {\n+        // No changes would be made to the `ts.Program` anyway, so it's safe to do nothing here.\n+        return;\n+      }\n+    }\n+\n+    if (updateMode === UpdateMode.Complete) {\n+      this.sfMap.clear();\n+    }\n+\n+    for (const [filePath, text] of contents.entries()) {\n+      this.sfMap.set(filePath, ts.createSourceFile(filePath, text, ts.ScriptTarget.Latest, true));\n+    }\n+\n+    const host = new UpdatedProgramHost(\n+        this.sfMap, this.originalProgram, this.originalHost, this.shimExtensionPrefixes);\n+    const oldProgram = this.program;\n+\n+    // Retag the old program's `ts.SourceFile`s with shim tags, to allow TypeScript to reuse the\n+    // most data.\n+    retagAllTsFiles(oldProgram);\n+\n+    this.program = ts.createProgram({\n+      host,\n+      rootNames: this.program.getRootFileNames(),\n+      options: this.options,\n+      oldProgram,\n+    });\n+    host.postProgramCreationCleanup();\n+\n+    // And untag them afterwards. We explicitly untag both programs here, because the oldProgram\n+    // may still be used for emit and needs to not contain tags.\n+    untagAllTsFiles(this.program);\n+    untagAllTsFiles(oldProgram);\n+  }\n+}",
            "previous_filename": "packages/compiler-cli/src/ngtsc/typecheck/src/host.ts"
        },
        {
            "sha": "5a214876b184636af3d0d1188a8b806129aeb554",
            "filename": "packages/compiler-cli/src/ngtsc/tsc_plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -12,10 +12,10 @@ import {CompilationTicket, freshCompilationTicket, incrementalFromDriverTicket,\n import {NgCompilerOptions, UnifiedModulesHost} from './core/api';\n import {NodeJSFileSystem, setFileSystem} from './file_system';\n import {PatchedProgramIncrementalBuildStrategy} from './incremental';\n-import {ActivePerfRecorder, NOOP_PERF_RECORDER, PerfPhase} from './perf';\n+import {ActivePerfRecorder, PerfPhase} from './perf';\n+import {TsCreateProgramDriver} from './program_driver';\n import {untagAllTsFiles} from './shims';\n import {OptimizeFor} from './typecheck/api';\n-import {ReusedProgramStrategy} from './typecheck/src/augmented_program';\n \n // The following is needed to fix a the chicken-and-egg issue where the sync (into g3) script will\n // refuse to accept this file unless the following string appears:\n@@ -106,7 +106,7 @@ export class NgTscPlugin implements TscPlugin {\n     }\n     this.host.postProgramCreationCleanup();\n     untagAllTsFiles(program);\n-    const typeCheckStrategy = new ReusedProgramStrategy(\n+    const programDriver = new TsCreateProgramDriver(\n         program, this.host, this.options, this.host.shimExtensionPrefixes);\n     const strategy = new PatchedProgramIncrementalBuildStrategy();\n     const oldDriver = oldProgram !== undefined ? strategy.getIncrementalDriver(oldProgram) : null;\n@@ -122,12 +122,12 @@ export class NgTscPlugin implements TscPlugin {\n \n     if (oldProgram === undefined || oldDriver === null) {\n       ticket = freshCompilationTicket(\n-          program, this.options, strategy, typeCheckStrategy, perfRecorder,\n+          program, this.options, strategy, programDriver, perfRecorder,\n           /* enableTemplateTypeChecker */ false, /* usePoisonedData */ false);\n     } else {\n       strategy.toNextBuildStrategy().getIncrementalDriver(oldProgram);\n       ticket = incrementalFromDriverTicket(\n-          oldProgram, oldDriver, program, this.options, strategy, typeCheckStrategy,\n+          oldProgram, oldDriver, program, this.options, strategy, programDriver,\n           modifiedResourceFiles, perfRecorder, false, false);\n     }\n     this._compiler = NgCompiler.fromTicket(ticket, this.host);\n@@ -149,7 +149,7 @@ export class NgTscPlugin implements TscPlugin {\n   }\n \n   getNextProgram(): ts.Program {\n-    return this.compiler.getNextProgram();\n+    return this.compiler.getCurrentProgram();\n   }\n \n   createTransformers(): ts.CustomTransformers {"
        },
        {
            "sha": "47a64194b22ddc5f13d092bcc0acf4538f1f595e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -16,6 +16,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental:api\",\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/shims\","
        },
        {
            "sha": "42c947784f024a0139a728d5b15e142043bbd978",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/api.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 60,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -352,63 +352,3 @@ export interface FullTemplateMapping {\n   templateSourceMapping: TemplateSourceMapping;\n   span: ParseSourceSpan;\n }\n-\n-/**\n- * Abstracts the operation of determining which shim file will host a particular component's\n- * template type-checking code.\n- *\n- * Different consumers of the type checking infrastructure may choose different approaches to\n- * optimize for their specific use case (for example, the command-line compiler optimizes for\n- * efficient `ts.Program` reuse in watch mode).\n- */\n-export interface ComponentToShimMappingStrategy {\n-  /**\n-   * Given a component, determine a path to the shim file into which that component's type checking\n-   * code will be generated.\n-   *\n-   * A major constraint is that components in different input files must not share the same shim\n-   * file. The behavior of the template type-checking system is undefined if this is violated.\n-   */\n-  shimPathForComponent(node: ts.ClassDeclaration): AbsoluteFsPath;\n-}\n-\n-/**\n- * Strategy used to manage a `ts.Program` which contains template type-checking code and update it\n- * over time.\n- *\n- * This abstraction allows both the Angular compiler itself as well as the language service to\n- * implement efficient template type-checking using common infrastructure.\n- */\n-export interface TypeCheckingProgramStrategy extends ComponentToShimMappingStrategy {\n-  /**\n-   * Whether this strategy supports modifying user files (inline modifications) in addition to\n-   * modifying type-checking shims.\n-   */\n-  readonly supportsInlineOperations: boolean;\n-\n-  /**\n-   * Retrieve the latest version of the program, containing all the updates made thus far.\n-   */\n-  getProgram(): ts.Program;\n-\n-  /**\n-   * Incorporate a set of changes to either augment or completely replace the type-checking code\n-   * included in the type-checking program.\n-   */\n-  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void;\n-}\n-\n-export enum UpdateMode {\n-  /**\n-   * A complete update creates a completely new overlay of type-checking code on top of the user's\n-   * original program, which doesn't include type-checking code from previous calls to\n-   * `updateFiles`.\n-   */\n-  Complete,\n-\n-  /**\n-   * An incremental update changes the contents of some files in the type-checking program without\n-   * reverting any prior changes.\n-   */\n-  Incremental,\n-}"
        },
        {
            "sha": "1eb7540123ddf55eda37dcc70013188c3482fc7c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -6,9 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export {ReusedProgramStrategy} from './src/augmented_program';\n export {FileTypeCheckingData, TemplateTypeCheckerImpl} from './src/checker';\n export {TypeCheckContextImpl} from './src/context';\n-export {TypeCheckProgramHost} from './src/host';\n export {TypeCheckShimGenerator} from './src/shim';\n export {typeCheckFilePath} from './src/type_check_file';"
        },
        {
            "sha": "6176b36a12a817df2bfd58b37acadfff8684ebad",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/augmented_program.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 88,
            "changes": 88,
            "blob_url": "https://github.com/angular/angular/blob/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "raw_url": "https://github.com/angular/angular/raw/10a7c876929683234c6331905301727b1b337674/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts?ref=10a7c876929683234c6331905301727b1b337674",
            "patch": "@@ -1,88 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import * as ts from 'typescript';\n-\n-import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n-import {retagAllTsFiles, untagAllTsFiles} from '../../shims';\n-import {TypeCheckingProgramStrategy, UpdateMode} from '../api';\n-\n-import {TypeCheckProgramHost} from './host';\n-import {TypeCheckShimGenerator} from './shim';\n-\n-/**\n- * Implements a template type-checking program using `ts.createProgram` and TypeScript's program\n- * reuse functionality.\n- */\n-export class ReusedProgramStrategy implements TypeCheckingProgramStrategy {\n-  /**\n-   * A map of source file paths to replacement `ts.SourceFile`s for those paths.\n-   *\n-   * Effectively, this tracks the delta between the user's program (represented by the\n-   * `originalHost`) and the template type-checking program being managed.\n-   */\n-  private sfMap = new Map<string, ts.SourceFile>();\n-\n-  private program: ts.Program = this.originalProgram;\n-\n-  constructor(\n-      private originalProgram: ts.Program, private originalHost: ts.CompilerHost,\n-      private options: ts.CompilerOptions, private shimExtensionPrefixes: string[]) {}\n-\n-  readonly supportsInlineOperations = true;\n-\n-  getProgram(): ts.Program {\n-    return this.program;\n-  }\n-\n-  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void {\n-    if (contents.size === 0) {\n-      // No changes have been requested. Is it safe to skip updating entirely?\n-      // If UpdateMode is Incremental, then yes. If UpdateMode is Complete, then it's safe to skip\n-      // only if there are no active changes already (that would be cleared by the update).\n-\n-      if (updateMode !== UpdateMode.Complete || this.sfMap.size === 0) {\n-        // No changes would be made to the `ts.Program` anyway, so it's safe to do nothing here.\n-        return;\n-      }\n-    }\n-\n-    if (updateMode === UpdateMode.Complete) {\n-      this.sfMap.clear();\n-    }\n-\n-    for (const [filePath, text] of contents.entries()) {\n-      this.sfMap.set(filePath, ts.createSourceFile(filePath, text, ts.ScriptTarget.Latest, true));\n-    }\n-\n-    const host = new TypeCheckProgramHost(\n-        this.sfMap, this.originalProgram, this.originalHost, this.shimExtensionPrefixes);\n-    const oldProgram = this.program;\n-\n-    // Retag the old program's `ts.SourceFile`s with shim tags, to allow TypeScript to reuse the\n-    // most data.\n-    retagAllTsFiles(oldProgram);\n-\n-    this.program = ts.createProgram({\n-      host,\n-      rootNames: this.program.getRootFileNames(),\n-      options: this.options,\n-      oldProgram,\n-    });\n-    host.postProgramCreationCleanup();\n-\n-    // And untag them afterwards. We explicitly untag both programs here, because the oldProgram\n-    // may still be used for emit and needs to not contain tags.\n-    untagAllTsFiles(this.program);\n-    untagAllTsFiles(oldProgram);\n-  }\n-\n-  shimPathForComponent(node: ts.ClassDeclaration): AbsoluteFsPath {\n-    return TypeCheckShimGenerator.shimFor(absoluteFromSourceFile(node.getSourceFile()));\n-  }\n-}"
        },
        {
            "sha": "2490ad92bb4bbdab2df646d68226a09b90ea17bd",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 30,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -13,16 +13,18 @@ import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath, getSourceFileOrErr\n import {Reference, ReferenceEmitter} from '../../imports';\n import {IncrementalBuild} from '../../incremental/api';\n import {PerfCheckpoint, PerfEvent, PerfPhase, PerfRecorder} from '../../perf';\n+import {ProgramDriver, UpdateMode} from '../../program_driver';\n import {ClassDeclaration, isNamedClassDeclaration, ReflectionHost} from '../../reflection';\n import {ComponentScopeReader, TypeCheckScopeRegistry} from '../../scope';\n import {isShim} from '../../shims';\n import {getSourceFileOrNull} from '../../util/src/typescript';\n-import {DirectiveInScope, ElementSymbol, FullTemplateMapping, GlobalCompletion, OptimizeFor, PipeInScope, ProgramTypeCheckAdapter, ShimLocation, Symbol, TemplateId, TemplateSymbol, TemplateTypeChecker, TypeCheckableDirectiveMeta, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n+import {DirectiveInScope, ElementSymbol, FullTemplateMapping, GlobalCompletion, OptimizeFor, PipeInScope, ProgramTypeCheckAdapter, ShimLocation, Symbol, TemplateId, TemplateSymbol, TemplateTypeChecker, TypeCheckableDirectiveMeta, TypeCheckingConfig} from '../api';\n import {TemplateDiagnostic} from '../diagnostics';\n \n import {CompletionEngine} from './completion';\n import {InliningMode, ShimTypeCheckingData, TemplateData, TypeCheckContextImpl, TypeCheckingHost} from './context';\n import {shouldReportDiagnostic, translateDiagnostic} from './diagnostics';\n+import {TypeCheckShimGenerator} from './shim';\n import {TemplateSourceManager} from './source';\n import {findTypeCheckBlock, getTemplateMapping, TemplateSourceResolver} from './tcb_util';\n import {SymbolBuilder} from './template_symbol_builder';\n@@ -76,8 +78,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n   private isComplete = false;\n \n   constructor(\n-      private originalProgram: ts.Program,\n-      readonly typeCheckingStrategy: TypeCheckingProgramStrategy,\n+      private originalProgram: ts.Program, readonly programDriver: ProgramDriver,\n       private typeCheckAdapter: ProgramTypeCheckAdapter, private config: TypeCheckingConfig,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n@@ -100,7 +101,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n \n     const sf = component.getSourceFile();\n     const sfPath = absoluteFromSourceFile(sf);\n-    const shimPath = this.typeCheckingStrategy.shimPathForComponent(component);\n+    const shimPath = TypeCheckShimGenerator.shimFor(sfPath);\n \n     const fileRecord = this.getFileData(sfPath);\n \n@@ -112,7 +113,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     const shimRecord = fileRecord.shimData.get(shimPath)!;\n     const id = fileRecord.sourceManager.getTemplateId(component);\n \n-    const program = this.typeCheckingStrategy.getProgram();\n+    const program = this.programDriver.getProgram();\n     const shimSf = getSourceFileOrNull(program, shimPath);\n \n     if (shimSf === null || !fileRecord.shimData.has(shimPath)) {\n@@ -157,7 +158,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     }\n     const {fileRecord} = records;\n \n-    const shimSf = this.typeCheckingStrategy.getProgram().getSourceFile(absoluteFrom(shimPath));\n+    const shimSf = this.programDriver.getProgram().getSourceFile(absoluteFrom(shimPath));\n     if (shimSf === undefined) {\n       return null;\n     }\n@@ -187,7 +188,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       const sfPath = absoluteFromSourceFile(sf);\n       const fileRecord = this.state.get(sfPath)!;\n \n-      const typeCheckProgram = this.typeCheckingStrategy.getProgram();\n+      const typeCheckProgram = this.programDriver.getProgram();\n \n       const diagnostics: (ts.Diagnostic|null)[] = [];\n       if (fileRecord.hasInlines) {\n@@ -217,7 +218,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     return this.perf.inPhase(PerfPhase.TtcDiagnostics, () => {\n       const sf = component.getSourceFile();\n       const sfPath = absoluteFromSourceFile(sf);\n-      const shimPath = this.typeCheckingStrategy.shimPathForComponent(component);\n+      const shimPath = TypeCheckShimGenerator.shimFor(sfPath);\n \n       const fileRecord = this.getFileData(sfPath);\n \n@@ -228,7 +229,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       const templateId = fileRecord.sourceManager.getTemplateId(component);\n       const shimRecord = fileRecord.shimData.get(shimPath)!;\n \n-      const typeCheckProgram = this.typeCheckingStrategy.getProgram();\n+      const typeCheckProgram = this.programDriver.getProgram();\n \n       const diagnostics: (TemplateDiagnostic|null)[] = [];\n       if (shimRecord.hasInlines) {\n@@ -285,7 +286,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n \n     const sf = clazz.getSourceFile();\n     const sfPath = absoluteFromSourceFile(sf);\n-    const shimPath = this.typeCheckingStrategy.shimPathForComponent(clazz);\n+    const shimPath = TypeCheckShimGenerator.shimFor(sfPath);\n     const fileData = this.getFileData(sfPath);\n     const templateId = fileData.sourceManager.getTemplateId(clazz);\n \n@@ -374,8 +375,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n         return;\n       }\n \n-      const host =\n-          new SingleFileTypeCheckingHost(sfPath, fileData, this.typeCheckingStrategy, this);\n+      const host = new SingleFileTypeCheckingHost(sfPath, fileData, this);\n       const ctx = this.newContext(host);\n \n       this.typeCheckAdapter.typeCheck(sf, ctx);\n@@ -389,31 +389,29 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n   private ensureShimForComponent(component: ts.ClassDeclaration): void {\n     const sf = component.getSourceFile();\n     const sfPath = absoluteFromSourceFile(sf);\n+    const shimPath = TypeCheckShimGenerator.shimFor(sfPath);\n \n     this.maybeAdoptPriorResultsForFile(sf);\n \n     const fileData = this.getFileData(sfPath);\n-    const shimPath = this.typeCheckingStrategy.shimPathForComponent(component);\n \n     if (fileData.shimData.has(shimPath)) {\n       // All data for this component is available.\n       return;\n     }\n \n-    const host =\n-        new SingleShimTypeCheckingHost(sfPath, fileData, this.typeCheckingStrategy, this, shimPath);\n+    const host = new SingleShimTypeCheckingHost(sfPath, fileData, this, shimPath);\n     const ctx = this.newContext(host);\n \n     this.typeCheckAdapter.typeCheck(sf, ctx);\n     this.updateFromContext(ctx);\n   }\n \n   private newContext(host: TypeCheckingHost): TypeCheckContextImpl {\n-    const inlining = this.typeCheckingStrategy.supportsInlineOperations ? InliningMode.InlineOps :\n-                                                                          InliningMode.Error;\n+    const inlining =\n+        this.programDriver.supportsInlineOperations ? InliningMode.InlineOps : InliningMode.Error;\n     return new TypeCheckContextImpl(\n-        this.config, this.compilerHost, this.typeCheckingStrategy, this.refEmitter, this.reflector,\n-        host, inlining, this.perf);\n+        this.config, this.compilerHost, this.refEmitter, this.reflector, host, inlining, this.perf);\n   }\n \n   /**\n@@ -446,7 +444,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       if (updates.size > 0) {\n         this.perf.eventCount(PerfEvent.UpdateTypeCheckProgram);\n       }\n-      this.typeCheckingStrategy.updateFiles(updates, UpdateMode.Incremental);\n+      this.programDriver.updateFiles(updates, UpdateMode.Incremental);\n       this.priorBuild.recordSuccessfulTypeCheck(this.state);\n       this.perf.memory(PerfCheckpoint.TtcUpdateProgram);\n     });\n@@ -485,7 +483,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n \n     const builder = new SymbolBuilder(\n         shimPath, tcb, data, this.componentScopeReader,\n-        () => this.typeCheckingStrategy.getProgram().getTypeChecker());\n+        () => this.programDriver.getProgram().getTypeChecker());\n     this.symbolBuilderCache.set(component, builder);\n     return builder;\n   }\n@@ -571,7 +569,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       isPoisoned: scope.compilation.isPoisoned,\n     };\n \n-    const typeChecker = this.typeCheckingStrategy.getProgram().getTypeChecker();\n+    const typeChecker = this.programDriver.getProgram().getTypeChecker();\n     for (const dir of scope.compilation.directives) {\n       if (dir.selector === null) {\n         // Skip this directive, it can't be added to a template anyway.\n@@ -664,8 +662,9 @@ class WholeProgramTypeCheckingHost implements TypeCheckingHost {\n   }\n \n   shouldCheckComponent(node: ts.ClassDeclaration): boolean {\n-    const fileData = this.impl.getFileData(absoluteFromSourceFile(node.getSourceFile()));\n-    const shimPath = this.impl.typeCheckingStrategy.shimPathForComponent(node);\n+    const sfPath = absoluteFromSourceFile(node.getSourceFile());\n+    const shimPath = TypeCheckShimGenerator.shimFor(sfPath);\n+    const fileData = this.impl.getFileData(sfPath);\n     // The component needs to be checked unless the shim which would contain it already exists.\n     return !fileData.shimData.has(shimPath);\n   }\n@@ -691,7 +690,7 @@ class SingleFileTypeCheckingHost implements TypeCheckingHost {\n \n   constructor(\n       protected sfPath: AbsoluteFsPath, protected fileData: FileTypeCheckingData,\n-      protected strategy: TypeCheckingProgramStrategy, protected impl: TemplateTypeCheckerImpl) {}\n+      protected impl: TemplateTypeCheckerImpl) {}\n \n   private assertPath(sfPath: AbsoluteFsPath): void {\n     if (this.sfPath !== sfPath) {\n@@ -708,7 +707,7 @@ class SingleFileTypeCheckingHost implements TypeCheckingHost {\n     if (this.sfPath !== absoluteFromSourceFile(node.getSourceFile())) {\n       return false;\n     }\n-    const shimPath = this.strategy.shimPathForComponent(node);\n+    const shimPath = TypeCheckShimGenerator.shimFor(this.sfPath);\n \n     // Only need to generate a TCB for the class if no shim exists for it currently.\n     return !this.fileData.shimData.has(shimPath);\n@@ -747,9 +746,9 @@ class SingleFileTypeCheckingHost implements TypeCheckingHost {\n  */\n class SingleShimTypeCheckingHost extends SingleFileTypeCheckingHost {\n   constructor(\n-      sfPath: AbsoluteFsPath, fileData: FileTypeCheckingData, strategy: TypeCheckingProgramStrategy,\n-      impl: TemplateTypeCheckerImpl, private shimPath: AbsoluteFsPath) {\n-    super(sfPath, fileData, strategy, impl);\n+      sfPath: AbsoluteFsPath, fileData: FileTypeCheckingData, impl: TemplateTypeCheckerImpl,\n+      private shimPath: AbsoluteFsPath) {\n+    super(sfPath, fileData, impl);\n   }\n \n   shouldCheckNode(node: ts.ClassDeclaration): boolean {\n@@ -758,7 +757,7 @@ class SingleShimTypeCheckingHost extends SingleFileTypeCheckingHost {\n     }\n \n     // Only generate a TCB for the component if it maps to the requested shim file.\n-    const shimPath = this.strategy.shimPathForComponent(node);\n+    const shimPath = TypeCheckShimGenerator.shimFor(this.sfPath);\n     if (shimPath !== this.shimPath) {\n       return false;\n     }"
        },
        {
            "sha": "44938721965aa0cf75608247bed319a2ab108396",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -15,12 +15,13 @@ import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {PerfEvent, PerfRecorder} from '../../perf';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n-import {ComponentToShimMappingStrategy, TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n+import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n import {makeTemplateDiagnostic, TemplateDiagnostic} from '../diagnostics';\n \n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n import {Environment} from './environment';\n import {OutOfBandDiagnosticRecorder, OutOfBandDiagnosticRecorderImpl} from './oob';\n+import {TypeCheckShimGenerator} from './shim';\n import {TemplateSourceManager} from './source';\n import {requiresInlineTypeCheckBlock} from './tcb_util';\n import {generateTypeCheckBlock} from './type_check_block';\n@@ -178,7 +179,6 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n   constructor(\n       private config: TypeCheckingConfig,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n-      private componentMappingStrategy: ComponentToShimMappingStrategy,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n       private host: TypeCheckingHost, private inlining: InliningMode, private perf: PerfRecorder) {\n     if (inlining === InliningMode.Error && config.useInlineTypeConstructors) {\n@@ -410,7 +410,7 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n \n   private pendingShimForComponent(node: ts.ClassDeclaration): PendingShimData {\n     const fileData = this.dataForFile(node.getSourceFile());\n-    const shimPath = this.componentMappingStrategy.shimPathForComponent(node);\n+    const shimPath = TypeCheckShimGenerator.shimFor(absoluteFromSourceFile(node.getSourceFile()));\n     if (!fileData.shimData.has(shimPath)) {\n       fileData.shimData.set(shimPath, {\n         domSchemaChecker: new RegistryDomSchemaChecker(fileData.sourceManager),"
        },
        {
            "sha": "f84d17a25d953bfacabace24a2d27722e1316951",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -18,6 +18,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/shims\","
        },
        {
            "sha": "ea15ed67ddc3dfc51c4a31a11c01c20bb4a71e7d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/program_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -10,10 +10,10 @@ import * as ts from 'typescript';\n \n import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n+import {TsCreateProgramDriver, UpdateMode} from '../../program_driver';\n import {sfExtensionData, ShimReferenceTagger} from '../../shims';\n import {expectCompleteReuse, makeProgram} from '../../testing';\n-import {OptimizeFor, UpdateMode} from '../api';\n-import {ReusedProgramStrategy} from '../src/augmented_program';\n+import {OptimizeFor} from '../api';\n \n import {setup} from './test_utils';\n \n@@ -37,7 +37,7 @@ runInEachFileSystem(() => {\n \n     it('should have complete reuse if no structural changes are made to shims', () => {\n       const {program, host, options, typecheckPath} = makeSingleFileProgramWithTypecheckShim();\n-      const programStrategy = new ReusedProgramStrategy(program, host, options, ['ngtypecheck']);\n+      const programStrategy = new TsCreateProgramDriver(program, host, options, ['ngtypecheck']);\n \n       // Update /main.ngtypecheck.ts without changing its shape. Verify that the old program was\n       // reused completely.\n@@ -49,7 +49,7 @@ runInEachFileSystem(() => {\n \n     it('should have complete reuse if no structural changes are made to input files', () => {\n       const {program, host, options, mainPath} = makeSingleFileProgramWithTypecheckShim();\n-      const programStrategy = new ReusedProgramStrategy(program, host, options, ['ngtypecheck']);\n+      const programStrategy = new TsCreateProgramDriver(program, host, options, ['ngtypecheck']);\n \n       // Update /main.ts without changing its shape. Verify that the old program was reused\n       // completely."
        },
        {
            "sha": "09c0b72bb4603aba597bf3d18e02100ff527291d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -15,14 +15,14 @@ import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy,\n import {NOOP_INCREMENTAL_BUILD} from '../../incremental';\n import {ClassPropertyMapping, CompoundMetadataReader} from '../../metadata';\n import {NOOP_PERF_RECORDER} from '../../perf';\n+import {TsCreateProgramDriver} from '../../program_driver';\n import {ClassDeclaration, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {ComponentScopeReader, LocalModuleScope, ScopeData, TypeCheckScopeRegistry} from '../../scope';\n import {makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '../api';\n-import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, UpdateMode} from '../api/api';\n+import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig} from '../api/api';\n import {TemplateDiagnostic} from '../diagnostics';\n-import {ReusedProgramStrategy} from '../src/augmented_program';\n import {TemplateTypeCheckerImpl} from '../src/checker';\n import {DomSchemaChecker} from '../src/dom';\n import {Environment} from '../src/environment';\n@@ -347,7 +347,7 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n } = {}): {\n   templateTypeChecker: TemplateTypeChecker,\n   program: ts.Program,\n-  programStrategy: ReusedProgramStrategy,\n+  programStrategy: TsCreateProgramDriver,\n } {\n   const files = [\n     typescriptLibDts(),\n@@ -462,7 +462,7 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n     }\n   });\n \n-  const programStrategy = new ReusedProgramStrategy(program, host, options, ['ngtypecheck']);\n+  const programStrategy = new TsCreateProgramDriver(program, host, options, ['ngtypecheck']);\n   if (overrides.inlining !== undefined) {\n     (programStrategy as any).supportsInlineOperations = overrides.inlining;\n   }"
        },
        {
            "sha": "1fa41d2150d887f7dd26c326ee533124094173c4",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_constructor_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 16,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -11,11 +11,10 @@ import {absoluteFrom, AbsoluteFsPath, getFileSystem, getSourceFileOrError, Logic\n import {runInEachFileSystem, TestFile} from '../../file_system/testing';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n import {NOOP_PERF_RECORDER} from '../../perf';\n+import {TsCreateProgramDriver, UpdateMode} from '../../program_driver';\n import {isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {getDeclaration, makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n-import {ComponentToShimMappingStrategy, UpdateMode} from '../api';\n-import {ReusedProgramStrategy} from '../src/augmented_program';\n import {InliningMode, PendingFileTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from '../src/context';\n import {TemplateSourceManager} from '../src/source';\n import {TypeCheckFile} from '../src/type_check_file';\n@@ -74,8 +73,8 @@ TestClass.ngTypeCtor({value: 'test'});\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n         const ctx = new TypeCheckContextImpl(\n-            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n-            new TestTypeCheckingHost(), InliningMode.InlineOps, NOOP_PERF_RECORDER);\n+            ALL_ENABLED_CONFIG, host, emitter, reflectionHost, new TestTypeCheckingHost(),\n+            InliningMode.InlineOps, NOOP_PERF_RECORDER);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         const pendingFile = makePendingFile();\n@@ -113,8 +112,8 @@ TestClass.ngTypeCtor({value: 'test'});\n         ]);\n         const pendingFile = makePendingFile();\n         const ctx = new TypeCheckContextImpl(\n-            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n-            new TestTypeCheckingHost(), InliningMode.InlineOps, NOOP_PERF_RECORDER);\n+            ALL_ENABLED_CONFIG, host, emitter, reflectionHost, new TestTypeCheckingHost(),\n+            InliningMode.InlineOps, NOOP_PERF_RECORDER);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -128,7 +127,7 @@ TestClass.ngTypeCtor({value: 'test'});\n               },\n               coercedInputFields: new Set(),\n             });\n-        const programStrategy = new ReusedProgramStrategy(program, host, options, []);\n+        const programStrategy = new TsCreateProgramDriver(program, host, options, []);\n         programStrategy.updateFiles(ctx.finalize(), UpdateMode.Complete);\n         const TestClassWithCtor = getDeclaration(\n             programStrategy.getProgram(), _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n@@ -158,8 +157,8 @@ TestClass.ngTypeCtor({value: 'test'});\n         ]);\n         const pendingFile = makePendingFile();\n         const ctx = new TypeCheckContextImpl(\n-            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n-            new TestTypeCheckingHost(), InliningMode.InlineOps, NOOP_PERF_RECORDER);\n+            ALL_ENABLED_CONFIG, host, emitter, reflectionHost, new TestTypeCheckingHost(),\n+            InliningMode.InlineOps, NOOP_PERF_RECORDER);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -173,7 +172,7 @@ TestClass.ngTypeCtor({value: 'test'});\n               },\n               coercedInputFields: new Set(['bar']),\n             });\n-        const programStrategy = new ReusedProgramStrategy(program, host, options, []);\n+        const programStrategy = new TsCreateProgramDriver(program, host, options, []);\n         programStrategy.updateFiles(ctx.finalize(), UpdateMode.Complete);\n         const TestClassWithCtor = getDeclaration(\n             programStrategy.getProgram(), _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n@@ -216,9 +215,3 @@ class TestTypeCheckingHost implements TypeCheckingHost {\n \n   recordComplete(): void {}\n }\n-\n-class TestMappingStrategy implements ComponentToShimMappingStrategy {\n-  shimPathForComponent(): AbsoluteFsPath {\n-    return absoluteFrom('/typecheck.ts');\n-  }\n-}"
        },
        {
            "sha": "86a8b20334743fe3acf35aefd3565dcb14ecac01",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -16,6 +16,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\","
        },
        {
            "sha": "cc62d14ea26c808ae83ca98b420fd20cd193570d",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -9,8 +9,7 @@\n import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket, NgCompiler, resourceChangeTicket} from '@angular/compiler-cli/src/ngtsc/core';\n import {NgCompilerOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n-import {ActivePerfRecorder} from '@angular/compiler-cli/src/ngtsc/perf';\n-import {TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {LanguageServiceAdapter} from './adapters';\n@@ -32,7 +31,7 @@ export class CompilerFactory {\n \n   constructor(\n       private readonly adapter: LanguageServiceAdapter,\n-      private readonly programStrategy: TypeCheckingProgramStrategy,\n+      private readonly programStrategy: ProgramDriver,\n       private readonly options: NgCompilerOptions,\n   ) {}\n "
        },
        {
            "sha": "69a0a8bd759d391d4d115f2dc92403ee2aaae72b",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -47,7 +47,7 @@ export enum CompletionNodeContext {\n  * @param N type of the template node in question, narrowed accordingly.\n  */\n export class CompletionBuilder<N extends TmplAstNode|AST> {\n-  private readonly typeChecker = this.compiler.getNextProgram().getTypeChecker();\n+  private readonly typeChecker = this.compiler.getCurrentProgram().getTypeChecker();\n   private readonly templateTypeChecker = this.compiler.getTemplateTypeChecker();\n   private readonly nodeParent = this.targetDetails.parent;\n   private readonly nodeContext = nodeContextFromTarget(this.targetDetails.context);"
        },
        {
            "sha": "087ec372ed666941f7037aff5ef6a0609400be48",
            "filename": "packages/language-service/ivy/definitions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -282,7 +282,7 @@ export class DefinitionBuilder {\n function getDefinitionForExpressionAtPosition(\n     fileName: string, position: number, compiler: NgCompiler): ts.DefinitionInfoAndBoundSpan|\n     undefined {\n-  const sf = compiler.getNextProgram().getSourceFile(fileName);\n+  const sf = compiler.getCurrentProgram().getSourceFile(fileName);\n   if (sf === undefined) {\n     return;\n   }"
        },
        {
            "sha": "25ec273dd73e7cdecb606323c820788a0f0d5a8a",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 19,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -12,9 +12,10 @@ import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {ErrorCode, ngErrorCode} from '@angular/compiler-cli/src/ngtsc/diagnostics';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {PerfPhase} from '@angular/compiler-cli/src/ngtsc/perf';\n+import {ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n import {isNamedClassDeclaration} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n-import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {OptimizeFor} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {findFirstMatchingNode} from '@angular/compiler-cli/src/ngtsc/typecheck/src/comments';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n@@ -41,7 +42,7 @@ interface LanguageServiceConfig {\n export class LanguageService {\n   private options: CompilerOptions;\n   readonly compilerFactory: CompilerFactory;\n-  private readonly strategy: TypeCheckingProgramStrategy;\n+  private readonly programDriver: ProgramDriver;\n   private readonly adapter: LanguageServiceAdapter;\n   private readonly parseConfigHost: LSParseConfigHost;\n \n@@ -53,9 +54,9 @@ export class LanguageService {\n     this.parseConfigHost = new LSParseConfigHost(project.projectService.host);\n     this.options = parseNgCompilerOptions(project, this.parseConfigHost, config);\n     logCompilerOptions(project, this.options);\n-    this.strategy = createTypeCheckingProgramStrategy(project);\n+    this.programDriver = createProgramDriver(project);\n     this.adapter = new LanguageServiceAdapter(project);\n-    this.compilerFactory = new CompilerFactory(this.adapter, this.strategy, this.options);\n+    this.compilerFactory = new CompilerFactory(this.adapter, this.programDriver, this.options);\n     this.watchConfigFile(project);\n   }\n \n@@ -68,7 +69,7 @@ export class LanguageService {\n       const ttc = compiler.getTemplateTypeChecker();\n       const diagnostics: ts.Diagnostic[] = [];\n       if (isTypeScriptFile(fileName)) {\n-        const program = compiler.getNextProgram();\n+        const program = compiler.getCurrentProgram();\n         const sourceFile = program.getSourceFile(fileName);\n         if (sourceFile) {\n           const ngDiagnostics = compiler.getDiagnosticsForFile(sourceFile, OptimizeFor.SingleFile);\n@@ -112,7 +113,7 @@ export class LanguageService {\n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsDefinition, (compiler) => {\n-      if (!isInAngularContext(compiler.getNextProgram(), fileName, position)) {\n+      if (!isInAngularContext(compiler.getCurrentProgram(), fileName, position)) {\n         return undefined;\n       }\n       return new DefinitionBuilder(this.tsLS, compiler)\n@@ -123,7 +124,7 @@ export class LanguageService {\n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsDefinition, (compiler) => {\n-      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+      if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n         return undefined;\n       }\n       return new DefinitionBuilder(this.tsLS, compiler)\n@@ -142,7 +143,7 @@ export class LanguageService {\n       position: number,\n       compiler: NgCompiler,\n       ): ts.QuickInfo|undefined {\n-    if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+    if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n       return undefined;\n     }\n \n@@ -166,14 +167,14 @@ export class LanguageService {\n \n   getReferencesAtPosition(fileName: string, position: number): ts.ReferenceEntry[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      return new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n+      return new ReferencesAndRenameBuilder(this.programDriver, this.tsLS, compiler)\n           .getReferencesAtPosition(fileName, position);\n     });\n   }\n \n   getRenameInfo(fileName: string, position: number): ts.RenameInfo {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      const renameInfo = new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n+      const renameInfo = new ReferencesAndRenameBuilder(this.programDriver, this.tsLS, compiler)\n                              .getRenameInfo(absoluteFrom(fileName), position);\n       if (!renameInfo.canRename) {\n         return renameInfo;\n@@ -189,7 +190,7 @@ export class LanguageService {\n \n   findRenameLocations(fileName: string, position: number): readonly ts.RenameLocation[]|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsReferencesAndRenames, (compiler) => {\n-      return new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n+      return new ReferencesAndRenameBuilder(this.programDriver, this.tsLS, compiler)\n           .findRenameLocations(fileName, position);\n     });\n   }\n@@ -225,7 +226,7 @@ export class LanguageService {\n   private getCompletionsAtPositionImpl(\n       fileName: string, position: number, options: ts.GetCompletionsAtPositionOptions|undefined,\n       compiler: NgCompiler): ts.WithMetadata<ts.CompletionInfo>|undefined {\n-    if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+    if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n       return undefined;\n     }\n \n@@ -241,7 +242,7 @@ export class LanguageService {\n       formatOptions: ts.FormatCodeOptions|ts.FormatCodeSettings|undefined,\n       preferences: ts.UserPreferences|undefined): ts.CompletionEntryDetails|undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsCompletions, (compiler) => {\n-      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+      if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n         return undefined;\n       }\n \n@@ -256,7 +257,7 @@ export class LanguageService {\n   getCompletionEntrySymbol(fileName: string, position: number, entryName: string): ts.Symbol\n       |undefined {\n     return this.withCompilerAndPerfTracing(PerfPhase.LsCompletions, (compiler) => {\n-      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+      if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n         return undefined;\n       }\n \n@@ -457,13 +458,9 @@ function parseNgCompilerOptions(\n   return options;\n }\n \n-function createTypeCheckingProgramStrategy(project: ts.server.Project):\n-    TypeCheckingProgramStrategy {\n+function createProgramDriver(project: ts.server.Project): ProgramDriver {\n   return {\n     supportsInlineOperations: false,\n-    shimPathForComponent(component: ts.ClassDeclaration): AbsoluteFsPath {\n-      return TypeCheckShimGenerator.shimFor(absoluteFromSourceFile(component.getSourceFile()));\n-    },\n     getProgram(): ts.Program {\n       const program = project.getLanguageService().getProgram();\n       if (!program) {"
        },
        {
            "sha": "b35820cacfead9d7e6056d71ae9640b9c9902455",
            "filename": "packages/language-service/ivy/quick_info.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fquick_info.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Fquick_info.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fquick_info.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -14,7 +14,7 @@ import {createDisplayParts, DisplayInfoKind, SYMBOL_PUNC, SYMBOL_SPACE, SYMBOL_T\n import {filterAliasImports, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTextSpanOfNode} from './utils';\n \n export class QuickInfoBuilder {\n-  private readonly typeChecker = this.compiler.getNextProgram().getTypeChecker();\n+  private readonly typeChecker = this.compiler.getCurrentProgram().getTypeChecker();\n \n   constructor(\n       private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,"
        },
        {
            "sha": "7e0ba346c561344a7baaacf6440f209165217b04",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -9,7 +9,8 @@ import {AbsoluteSourceSpan, AST, BindingPipe, LiteralPrimitive, MethodCall, Pars\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {PerfPhase} from '@angular/compiler-cli/src/ngtsc/perf';\n-import {DirectiveSymbol, ShimLocation, SymbolKind, TemplateTypeChecker, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n+import {DirectiveSymbol, ShimLocation, SymbolKind, TemplateTypeChecker} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {ExpressionIdentifier, hasExpressionIdentifier} from '@angular/compiler-cli/src/ngtsc/typecheck/src/comments';\n import * as ts from 'typescript';\n \n@@ -62,8 +63,8 @@ export class ReferencesAndRenameBuilder {\n   private readonly ttc = this.compiler.getTemplateTypeChecker();\n \n   constructor(\n-      private readonly strategy: TypeCheckingProgramStrategy,\n-      private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler) {}\n+      private readonly driver: ProgramDriver, private readonly tsLS: ts.LanguageService,\n+      private readonly compiler: NgCompiler) {}\n \n   getRenameInfo(filePath: string, position: number):\n       Omit<ts.RenameInfoSuccess, 'kind'|'kindModifiers'>|ts.RenameInfoFailure {\n@@ -146,7 +147,7 @@ export class ReferencesAndRenameBuilder {\n   }\n \n   private getTsNodeAtPosition(filePath: string, position: number): ts.Node|null {\n-    const sf = this.strategy.getProgram().getSourceFile(filePath);\n+    const sf = this.driver.getProgram().getSourceFile(filePath);\n     if (!sf) {\n       return null;\n     }\n@@ -376,7 +377,7 @@ export class ReferencesAndRenameBuilder {\n   private convertToTemplateDocumentSpan<T extends ts.DocumentSpan>(\n       shimDocumentSpan: T, templateTypeChecker: TemplateTypeChecker, requiredNodeText?: string): T\n       |null {\n-    const sf = this.strategy.getProgram().getSourceFile(shimDocumentSpan.fileName);\n+    const sf = this.driver.getProgram().getSourceFile(shimDocumentSpan.fileName);\n     if (sf === undefined) {\n       return null;\n     }"
        },
        {
            "sha": "f204763c62236f20b09d221df39375aee7d7aebc",
            "filename": "packages/language-service/ivy/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/deacc741e0ee41666292d2e2c07812a78daf5d6f/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Futils.ts?ref=deacc741e0ee41666292d2e2c07812a78daf5d6f",
            "patch": "@@ -121,7 +121,7 @@ function getInlineTemplateInfoAtPosition(\n export function getTemplateInfoAtPosition(\n     fileName: string, position: number, compiler: NgCompiler): TemplateInfo|undefined {\n   if (isTypeScriptFile(fileName)) {\n-    const sf = compiler.getNextProgram().getSourceFile(fileName);\n+    const sf = compiler.getCurrentProgram().getSourceFile(fileName);\n     if (sf === undefined) {\n       return undefined;\n     }"
        }
    ],
    "stats": {
        "total": 690,
        "additions": 366,
        "deletions": 324
    }
}