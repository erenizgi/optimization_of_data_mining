{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): support external template source-mapping when linking (#40237)\n\nThis commit changes the `PartialComponentLinker` to use the original source\nof an external template when compiling, if available, to ensure that the\nsource-mapping of the final linked code is accurate.\n\nIf the linker is given a file-system and logger, then it will attempt\nto compute the original source of external templates so that the final\nlinked code references the correct template source.\n\nPR Close #40237",
    "sha": "266cc9b162d92f5998de1e574eb66b26c0e6f98f",
    "files": [
        {
            "sha": "f114a02c973ff2ad7fac6239959ebc73ee17cadb",
            "filename": "packages/compiler-cli/linker/BUILD.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2FBUILD.bazel?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -9,6 +9,9 @@ ts_library(\n     ]),\n     deps = [\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/logging\",\n+        \"//packages/compiler-cli/src/ngtsc/sourcemaps\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"@npm//@types/semver\",\n         \"@npm//semver\","
        },
        {
            "sha": "b8798073d98ee6dcdfb24929fdfe46036796419f",
            "filename": "packages/compiler-cli/linker/babel/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2FBUILD.bazel?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -10,6 +10,8 @@ ts_library(\n     deps = [\n         \"//packages/compiler\",\n         \"//packages/compiler-cli/linker\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/logging\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"@npm//@babel/core\",\n         \"@npm//@babel/types\","
        },
        {
            "sha": "17abf1ad3380f2730466fe72111a7a5d831fb5e0",
            "filename": "packages/compiler-cli/linker/babel/src/es2015_linker_plugin.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 12,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fes2015_linker_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fes2015_linker_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Fes2015_linker_plugin.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -9,24 +9,24 @@ import {PluginObj} from '@babel/core';\n import {NodePath} from '@babel/traverse';\n import * as t from '@babel/types';\n \n-import {FileLinker, isFatalLinkerError, LinkerEnvironment, LinkerOptions} from '../../../linker';\n+import {FileLinker, isFatalLinkerError, LinkerEnvironment} from '../../../linker';\n \n import {BabelAstFactory} from './ast/babel_ast_factory';\n import {BabelAstHost} from './ast/babel_ast_host';\n import {BabelDeclarationScope, ConstantScopePath} from './babel_declaration_scope';\n+import {LinkerPluginOptions} from './linker_plugin_options';\n+\n \n /**\n  * Create a Babel plugin that visits the program, identifying and linking partial declarations.\n  *\n  * The plugin delegates most of its work to a generic `FileLinker` for each file (`t.Program` in\n  * Babel) that is visited.\n  */\n-export function createEs2015LinkerPlugin(options: Partial<LinkerOptions> = {}): PluginObj {\n+export function createEs2015LinkerPlugin({fileSystem, logger, ...options}: LinkerPluginOptions):\n+    PluginObj {\n   let fileLinker: FileLinker<ConstantScopePath, t.Statement, t.Expression>|null = null;\n \n-  const linkerEnvironment = LinkerEnvironment.create<t.Statement, t.Expression>(\n-      new BabelAstHost(), new BabelAstFactory(), options);\n-\n   return {\n     visitor: {\n       Program: {\n@@ -36,8 +36,19 @@ export function createEs2015LinkerPlugin(options: Partial<LinkerOptions> = {}):\n          */\n         enter(path: NodePath<t.Program>): void {\n           assertNull(fileLinker);\n+          // Babel can be configured with a `filename` or `relativeFilename` (or both, or neither) -\n+          // possibly relative to the optional `cwd` path.\n           const file: BabelFile = path.hub.file;\n-          fileLinker = new FileLinker(linkerEnvironment, file.opts.filename ?? '', file.code);\n+          const filename = file.opts.filename ?? file.opts.filenameRelative;\n+          if (!filename) {\n+            throw new Error(\n+                'No filename (nor filenameRelative) provided by Babel. This is required for the linking of partially compiled directives and components.');\n+          }\n+          const sourceUrl = fileSystem.resolve(file.opts.cwd ?? '.', filename);\n+\n+          const linkerEnvironment = LinkerEnvironment.create<t.Statement, t.Expression>(\n+              fileSystem, logger, new BabelAstHost(), new BabelAstFactory(sourceUrl), options);\n+          fileLinker = new FileLinker(linkerEnvironment, sourceUrl, file.code);\n         },\n \n         /**\n@@ -66,11 +77,7 @@ export function createEs2015LinkerPlugin(options: Partial<LinkerOptions> = {}):\n         }\n \n         try {\n-          const callee = call.node.callee;\n-          if (!t.isExpression(callee)) {\n-            return;\n-          }\n-          const calleeName = linkerEnvironment.host.getSymbolName(callee);\n+          const calleeName = getCalleeName(call);\n           if (calleeName === null) {\n             return;\n           }\n@@ -126,6 +133,17 @@ function insertIntoProgram(program: NodePath<t.Program>, statements: t.Statement\n   }\n }\n \n+function getCalleeName(call: NodePath<t.CallExpression>): string|null {\n+  const callee = call.node.callee;\n+  if (t.isIdentifier(callee)) {\n+    return callee.name;\n+  } else if (t.isMemberExpression(callee) && t.isIdentifier(callee.property)) {\n+    return callee.property.name;\n+  } else {\n+    return null;\n+  }\n+}\n+\n /**\n  * Return true if all the `nodes` are Babel expressions.\n  */\n@@ -166,7 +184,11 @@ function buildCodeFrameError(file: BabelFile, message: string, node: t.Node): st\n  */\n interface BabelFile {\n   code: string;\n-  opts: {filename?: string;};\n+  opts: {\n+    filename?: string,\n+    filenameRelative?: string,\n+    cwd?: string,\n+  };\n \n   buildCodeFrameError(node: t.Node, message: string): Error;\n }"
        },
        {
            "sha": "49dbd839a30a7caeefe06c9278f3219492de326a",
            "filename": "packages/compiler-cli/linker/babel/src/linker_plugin_options.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Flinker_plugin_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Flinker_plugin_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Fsrc%2Flinker_plugin_options.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -0,0 +1,22 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {LinkerOptions} from '../..';\n+import {FileSystem} from '../../../src/ngtsc/file_system';\n+import {Logger} from '../../../src/ngtsc/logging';\n+\n+export interface LinkerPluginOptions extends Partial<LinkerOptions> {\n+  /**\n+   * File-system, used to load up the input source-map and content.\n+   */\n+  fileSystem: FileSystem;\n+\n+  /**\n+   * Logger used by the linker.\n+   */\n+  logger: Logger;\n+}"
        },
        {
            "sha": "f1a48537c30e5cad1ebb18ea15116f4d24ef480f",
            "filename": "packages/compiler-cli/linker/babel/test/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2FBUILD.bazel?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -13,6 +13,8 @@ ts_library(\n         \"//packages/compiler\",\n         \"//packages/compiler-cli/linker\",\n         \"//packages/compiler-cli/linker/babel\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/logging/testing\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"@npm//@babel/core\",\n         \"@npm//@babel/generator\","
        },
        {
            "sha": "21a8b63402de9028537755e3d33d390aaff60368",
            "filename": "packages/compiler-cli/linker/babel/test/es2015_linker_plugin_spec.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 12,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fes2015_linker_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fes2015_linker_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fbabel%2Ftest%2Fes2015_linker_plugin_spec.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -11,13 +11,17 @@ import generate from '@babel/generator';\n import * as t from '@babel/types';\n \n import {FileLinker} from '../../../linker';\n+import {MockFileSystemNative} from '../../../src/ngtsc/file_system/testing';\n+import {MockLogger} from '../../../src/ngtsc/logging/testing';\n import {PartialDirectiveLinkerVersion1} from '../../src/file_linker/partial_linkers/partial_directive_linker_1';\n import {createEs2015LinkerPlugin} from '../src/es2015_linker_plugin';\n \n describe('createEs2015LinkerPlugin()', () => {\n   it('should return a Babel plugin visitor that handles Program (enter/exit) and CallExpression nodes',\n      () => {\n-       const plugin = createEs2015LinkerPlugin();\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        expect(plugin.visitor).toEqual({\n          Program: {\n            enter: jasmine.any(Function),\n@@ -31,13 +35,16 @@ describe('createEs2015LinkerPlugin()', () => {\n      () => {\n        const isPartialDeclarationSpy = spyOn(FileLinker.prototype, 'isPartialDeclaration');\n \n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        transformSync(\n            [\n              'var core;', `fn1()`, 'fn2({prop: () => fn3({})});', `x.method(() => fn4());`,\n              'spread(...x);'\n            ].join('\\n'),\n            {\n-             plugins: [createEs2015LinkerPlugin()],\n+             plugins: [plugin],\n              filename: '/test.js',\n              parserOpts: {sourceType: 'unambiguous'},\n            });\n@@ -55,6 +62,9 @@ describe('createEs2015LinkerPlugin()', () => {\n      () => {\n        const linkSpy = spyOn(FileLinker.prototype, 'linkPartialDeclaration')\n                            .and.returnValue(t.identifier('REPLACEMENT'));\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n \n        transformSync(\n            [\n@@ -65,7 +75,7 @@ describe('createEs2015LinkerPlugin()', () => {\n              'spread(...x);',\n            ].join('\\n'),\n            {\n-             plugins: [createEs2015LinkerPlugin()],\n+             plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n              filename: '/test.js',\n              parserOpts: {sourceType: 'unambiguous'},\n            });\n@@ -86,6 +96,9 @@ describe('createEs2015LinkerPlugin()', () => {\n        let replaceCount = 0;\n        spyOn(FileLinker.prototype, 'linkPartialDeclaration')\n            .and.callFake(() => t.identifier('REPLACEMENT_' + ++replaceCount));\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        const result = transformSync(\n            [\n              'var core;',\n@@ -95,7 +108,7 @@ describe('createEs2015LinkerPlugin()', () => {\n              'spread(...x);',\n            ].join('\\n'),\n            {\n-             plugins: [createEs2015LinkerPlugin()],\n+             plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n              filename: '/test.js',\n              parserOpts: {sourceType: 'unambiguous'},\n              generatorOpts: {compact: true},\n@@ -105,6 +118,9 @@ describe('createEs2015LinkerPlugin()', () => {\n \n   it('should return a Babel plugin that adds shared statements after any imports', () => {\n     spyOnLinkPartialDeclarationWithConstants(o.literal('REPLACEMENT'));\n+    const fileSystem = new MockFileSystemNative();\n+    const logger = new MockLogger();\n+    const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n     const result = transformSync(\n         [\n           'import * as core from \\'some-module\\';',\n@@ -114,7 +130,7 @@ describe('createEs2015LinkerPlugin()', () => {\n           `ɵɵngDeclareDirective({version: '0.0.0-PLACEHOLDER', ngImport: core})`,\n         ].join('\\n'),\n         {\n-          plugins: [createEs2015LinkerPlugin()],\n+          plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n           filename: '/test.js',\n           parserOpts: {sourceType: 'unambiguous'},\n           generatorOpts: {compact: true},\n@@ -127,6 +143,9 @@ describe('createEs2015LinkerPlugin()', () => {\n   it('should return a Babel plugin that adds shared statements at the start of the program if it is an ECMAScript Module and there are no imports',\n      () => {\n        spyOnLinkPartialDeclarationWithConstants(o.literal('REPLACEMENT'));\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        const result = transformSync(\n            [\n              'var core;',\n@@ -135,7 +154,7 @@ describe('createEs2015LinkerPlugin()', () => {\n              `ɵɵngDeclareDirective({version: '0.0.0-PLACEHOLDER', ngImport: core})`,\n            ].join('\\n'),\n            {\n-             plugins: [createEs2015LinkerPlugin()],\n+             plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n              filename: '/test.js',\n              // We declare the file as a module because this cannot be inferred from the source\n              parserOpts: {sourceType: 'module'},\n@@ -149,6 +168,9 @@ describe('createEs2015LinkerPlugin()', () => {\n   it('should return a Babel plugin that adds shared statements at the start of the function body if the ngImport is from a function parameter',\n      () => {\n        spyOnLinkPartialDeclarationWithConstants(o.literal('REPLACEMENT'));\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        const result = transformSync(\n            [\n              'function run(core) {',\n@@ -157,7 +179,7 @@ describe('createEs2015LinkerPlugin()', () => {\n              `  ɵɵngDeclareDirective({version: '0.0.0-PLACEHOLDER', ngImport: core})`, '}'\n            ].join('\\n'),\n            {\n-             plugins: [createEs2015LinkerPlugin()],\n+             plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n              filename: '/test.js',\n              parserOpts: {sourceType: 'unambiguous'},\n              generatorOpts: {compact: true},\n@@ -170,6 +192,9 @@ describe('createEs2015LinkerPlugin()', () => {\n   it('should return a Babel plugin that adds shared statements into an IIFE if no scope could not be derived for the ngImport',\n      () => {\n        spyOnLinkPartialDeclarationWithConstants(o.literal('REPLACEMENT'));\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        const result = transformSync(\n            [\n              'function run() {',\n@@ -179,7 +204,7 @@ describe('createEs2015LinkerPlugin()', () => {\n              '}',\n            ].join('\\n'),\n            {\n-             plugins: [createEs2015LinkerPlugin()],\n+             plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n              filename: '/test.js',\n              parserOpts: {sourceType: 'unambiguous'},\n              generatorOpts: {compact: true},\n@@ -196,13 +221,16 @@ describe('createEs2015LinkerPlugin()', () => {\n   it('should still execute other plugins that match AST nodes inside the result of the replacement',\n      () => {\n        spyOnLinkPartialDeclarationWithConstants(o.fn([], [], null, null, 'FOO'));\n+       const fileSystem = new MockFileSystemNative();\n+       const logger = new MockLogger();\n+       const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n        const result = transformSync(\n            [\n              `ɵɵngDeclareDirective({version: '0.0.0-PLACEHOLDER', ngImport: core}); FOO;`,\n            ].join('\\n'),\n            {\n              plugins: [\n-               createEs2015LinkerPlugin(),\n+               createEs2015LinkerPlugin({fileSystem, logger}),\n                createIdentifierMapperPlugin('FOO', 'BAR'),\n                createIdentifierMapperPlugin('_c0', 'x1'),\n              ],\n@@ -217,7 +245,7 @@ describe('createEs2015LinkerPlugin()', () => {\n \n   it('should not process call expressions within inserted functions', () => {\n     spyOn(PartialDirectiveLinkerVersion1.prototype, 'linkPartialDeclaration')\n-        .and.callFake(((sourceUrl, code, constantPool) => {\n+        .and.callFake((constantPool => {\n                         // Insert a call expression into the constant pool. This is inserted into\n                         // Babel's AST upon program exit, and will therefore be visited by Babel\n                         // outside of an active linker context.\n@@ -233,13 +261,16 @@ describe('createEs2015LinkerPlugin()', () => {\n     const isPartialDeclarationSpy =\n         spyOn(FileLinker.prototype, 'isPartialDeclaration').and.callThrough();\n \n+    const fileSystem = new MockFileSystemNative();\n+    const logger = new MockLogger();\n+    const plugin = createEs2015LinkerPlugin({fileSystem, logger});\n     const result = transformSync(\n         [\n           'import * as core from \\'some-module\\';',\n           `ɵɵngDeclareDirective({version: '0.0.0-PLACEHOLDER', ngImport: core})`,\n         ].join('\\n'),\n         {\n-          plugins: [createEs2015LinkerPlugin()],\n+          plugins: [createEs2015LinkerPlugin({fileSystem, logger})],\n           filename: '/test.js',\n           parserOpts: {sourceType: 'unambiguous'},\n           generatorOpts: {compact: true},\n@@ -266,7 +297,7 @@ function humanizeLinkerCalls(\n function spyOnLinkPartialDeclarationWithConstants(replacement: o.Expression) {\n   let callCount = 0;\n   spyOn(PartialDirectiveLinkerVersion1.prototype, 'linkPartialDeclaration')\n-      .and.callFake(((sourceUrl, code, constantPool) => {\n+      .and.callFake((constantPool => {\n                       const constArray = o.literalArr([o.literal(++callCount)]);\n                       // We have to add the constant twice or it will not create a shared statement\n                       constantPool.getConstLiteral(constArray);"
        },
        {
            "sha": "4402e160df09ab45e823ef416813c8c337f3d9de",
            "filename": "packages/compiler-cli/linker/src/file_linker/emit_scopes/emit_scope.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Femit_scopes%2Femit_scope.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Femit_scopes%2Femit_scope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Femit_scopes%2Femit_scope.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -8,7 +8,7 @@\n import {ConstantPool} from '@angular/compiler';\n import * as o from '@angular/compiler/src/output/output_ast';\n import {LinkerImportGenerator} from '../../linker_import_generator';\n-import {LinkerEnvironment} from '../linker_environment';\n+import {Translator} from '../translator';\n \n /**\n  * This class represents (from the point of view of the `FileLinker`) the scope in which\n@@ -24,25 +24,24 @@ export class EmitScope<TStatement, TExpression> {\n \n   constructor(\n       protected readonly ngImport: TExpression,\n-      protected readonly linkerEnvironment: LinkerEnvironment<TStatement, TExpression>) {}\n+      protected readonly translator: Translator<TStatement, TExpression>) {}\n \n   /**\n    * Translate the given Output AST definition expression into a generic `TExpression`.\n    *\n    * Use a `LinkerImportGenerator` to handle any imports in the definition.\n    */\n   translateDefinition(definition: o.Expression): TExpression {\n-    return this.linkerEnvironment.translator.translateExpression(\n+    return this.translator.translateExpression(\n         definition, new LinkerImportGenerator(this.ngImport));\n   }\n \n   /**\n    * Return any constant statements that are shared between all uses of this `EmitScope`.\n    */\n   getConstantStatements(): TStatement[] {\n-    const {translator} = this.linkerEnvironment;\n     const importGenerator = new LinkerImportGenerator(this.ngImport);\n     return this.constantPool.statements.map(\n-        statement => translator.translateStatement(statement, importGenerator));\n+        statement => this.translator.translateStatement(statement, importGenerator));\n   }\n }"
        },
        {
            "sha": "d98484453c8d63a3a9935f7edf211e2dd09fa170",
            "filename": "packages/compiler-cli/linker/src/file_linker/emit_scopes/iife_emit_scope.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Femit_scopes%2Fiife_emit_scope.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Femit_scopes%2Fiife_emit_scope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Femit_scopes%2Fiife_emit_scope.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -6,6 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as o from '@angular/compiler/src/output/output_ast';\n+\n+import {AstFactory} from '../../../../src/ngtsc/translator';\n+import {Translator} from '../translator';\n+\n import {EmitScope} from './emit_scope';\n \n /**\n@@ -14,20 +18,26 @@ import {EmitScope} from './emit_scope';\n  * translated definition inside an IIFE.\n  */\n export class IifeEmitScope<TStatement, TExpression> extends EmitScope<TStatement, TExpression> {\n+  constructor(\n+      ngImport: TExpression, translator: Translator<TStatement, TExpression>,\n+      private readonly factory: AstFactory<TStatement, TExpression>) {\n+    super(ngImport, translator);\n+  }\n+\n   /**\n    * Translate the given Output AST definition expression into a generic `TExpression`.\n    *\n    * Wraps the output from `EmitScope.translateDefinition()` and `EmitScope.getConstantStatements()`\n    * in an IIFE.\n    */\n   translateDefinition(definition: o.Expression): TExpression {\n-    const {factory} = this.linkerEnvironment;\n     const constantStatements = super.getConstantStatements();\n \n-    const returnStatement = factory.createReturnStatement(super.translateDefinition(definition));\n-    const body = factory.createBlock([...constantStatements, returnStatement]);\n-    const fn = factory.createFunctionExpression(/* name */ null, /* args */[], body);\n-    return factory.createCallExpression(fn, /* args */[], /* pure */ false);\n+    const returnStatement =\n+        this.factory.createReturnStatement(super.translateDefinition(definition));\n+    const body = this.factory.createBlock([...constantStatements, returnStatement]);\n+    const fn = this.factory.createFunctionExpression(/* name */ null, /* args */[], body);\n+    return this.factory.createCallExpression(fn, /* args */[], /* pure */ false);\n   }\n \n   /**"
        },
        {
            "sha": "04c548e3856348af0397e430236b46d297fca74d",
            "filename": "packages/compiler-cli/linker/src/file_linker/file_linker.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Ffile_linker.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Ffile_linker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Ffile_linker.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {R3PartialDeclaration} from '@angular/compiler';\n+import {AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n import {AstObject} from '../ast/ast_value';\n import {DeclarationScope} from './declaration_scope';\n import {EmitScope} from './emit_scopes/emit_scope';\n@@ -19,12 +20,15 @@ export const NO_STATEMENTS: Readonly<any[]> = [] as const;\n  * This class is responsible for linking all the partial declarations found in a single file.\n  */\n export class FileLinker<TConstantScope, TStatement, TExpression> {\n-  private linkerSelector = new PartialLinkerSelector<TExpression>(this.linkerEnvironment.options);\n+  private linkerSelector: PartialLinkerSelector<TStatement, TExpression>;\n   private emitScopes = new Map<TConstantScope, EmitScope<TStatement, TExpression>>();\n \n   constructor(\n       private linkerEnvironment: LinkerEnvironment<TStatement, TExpression>,\n-      private sourceUrl: string, readonly code: string) {}\n+      sourceUrl: AbsoluteFsPath, code: string) {\n+    this.linkerSelector =\n+        new PartialLinkerSelector<TStatement, TExpression>(this.linkerEnvironment, sourceUrl, code);\n+  }\n \n   /**\n    * Return true if the given callee name matches a partial declaration that can be linked.\n@@ -61,8 +65,7 @@ export class FileLinker<TConstantScope, TStatement, TExpression> {\n \n     const version = metaObj.getString('version');\n     const linker = this.linkerSelector.getLinker(declarationFn, version);\n-    const definition =\n-        linker.linkPartialDeclaration(this.sourceUrl, this.code, emitScope.constantPool, metaObj);\n+    const definition = linker.linkPartialDeclaration(emitScope.constantPool, metaObj);\n \n     return emitScope.translateDefinition(definition);\n   }\n@@ -86,11 +89,13 @@ export class FileLinker<TConstantScope, TStatement, TExpression> {\n     const constantScope = declarationScope.getConstantScopeRef(ngImport);\n     if (constantScope === null) {\n       // There is no constant scope so we will emit extra statements into the definition IIFE.\n-      return new IifeEmitScope(ngImport, this.linkerEnvironment);\n+      return new IifeEmitScope(\n+          ngImport, this.linkerEnvironment.translator, this.linkerEnvironment.factory);\n     }\n \n     if (!this.emitScopes.has(constantScope)) {\n-      this.emitScopes.set(constantScope, new EmitScope(ngImport, this.linkerEnvironment));\n+      this.emitScopes.set(\n+          constantScope, new EmitScope(ngImport, this.linkerEnvironment.translator));\n     }\n     return this.emitScopes.get(constantScope)!;\n   }"
        },
        {
            "sha": "f7764e2c86e4089f0644b57be1f2300a2573f711",
            "filename": "packages/compiler-cli/linker/src/file_linker/get_source_file.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fget_source_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fget_source_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fget_source_file.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -0,0 +1,36 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n+import {SourceFile, SourceFileLoader} from '../../../src/ngtsc/sourcemaps';\n+\n+/**\n+ * A function that will return a `SourceFile` object (or null) for the current file being linked.\n+ */\n+export type GetSourceFileFn = () => SourceFile|null;\n+\n+/**\n+ * Create a `GetSourceFileFn` that will return the `SourceFile` being linked or `null`, if not\n+ * available.\n+ */\n+export function createGetSourceFile(\n+    sourceUrl: AbsoluteFsPath, code: string, loader: SourceFileLoader|null): GetSourceFileFn {\n+  if (loader === null) {\n+    // No source-mapping so just return a function that always returns `null`.\n+    return () => null;\n+  } else {\n+    // Source-mapping is available so return a function that will load (and cache) the `SourceFile`.\n+    let sourceFile: SourceFile|null|undefined = undefined;\n+    return () => {\n+      if (sourceFile === undefined) {\n+        sourceFile = loader.loadSourceFile(sourceUrl, code);\n+      }\n+      return sourceFile;\n+    };\n+  }\n+}"
        },
        {
            "sha": "3782ddeec114b09c47e0429ede4a5f1e4b793dd4",
            "filename": "packages/compiler-cli/linker/src/file_linker/linker_environment.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_environment.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_environment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_environment.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -5,27 +5,35 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AstFactory} from '@angular/compiler-cli/src/ngtsc/translator';\n+import {FileSystem} from '../../../src/ngtsc/file_system';\n+import {Logger} from '../../../src/ngtsc/logging';\n+import {SourceFileLoader} from '../../../src/ngtsc/sourcemaps';\n+import {AstFactory} from '../../../src/ngtsc/translator';\n \n import {AstHost} from '../ast/ast_host';\n import {DEFAULT_LINKER_OPTIONS, LinkerOptions} from './linker_options';\n import {Translator} from './translator';\n \n export class LinkerEnvironment<TStatement, TExpression> {\n   readonly translator = new Translator<TStatement, TExpression>(this.factory);\n+  readonly sourceFileLoader =\n+      this.options.sourceMapping ? new SourceFileLoader(this.fileSystem, this.logger, {}) : null;\n+\n   private constructor(\n-      readonly host: AstHost<TExpression>, readonly factory: AstFactory<TStatement, TExpression>,\n-      readonly options: LinkerOptions) {}\n+      readonly fileSystem: FileSystem, readonly logger: Logger, readonly host: AstHost<TExpression>,\n+      readonly factory: AstFactory<TStatement, TExpression>, readonly options: LinkerOptions) {}\n \n   static create<TStatement, TExpression>(\n-      host: AstHost<TExpression>, factory: AstFactory<TStatement, TExpression>,\n+      fileSystem: FileSystem, logger: Logger, host: AstHost<TExpression>,\n+      factory: AstFactory<TStatement, TExpression>,\n       options: Partial<LinkerOptions>): LinkerEnvironment<TStatement, TExpression> {\n-    return new LinkerEnvironment(host, factory, {\n+    return new LinkerEnvironment(fileSystem, logger, host, factory, {\n       enableI18nLegacyMessageIdFormat: options.enableI18nLegacyMessageIdFormat ??\n           DEFAULT_LINKER_OPTIONS.enableI18nLegacyMessageIdFormat,\n       i18nNormalizeLineEndingsInICUs: options.i18nNormalizeLineEndingsInICUs ??\n           DEFAULT_LINKER_OPTIONS.i18nNormalizeLineEndingsInICUs,\n       i18nUseExternalIds: options.i18nUseExternalIds ?? DEFAULT_LINKER_OPTIONS.i18nUseExternalIds,\n+      sourceMapping: options.sourceMapping ?? DEFAULT_LINKER_OPTIONS.sourceMapping\n     });\n   }\n }"
        },
        {
            "sha": "120be4d417ea43c327aa306fc505575126ace130",
            "filename": "packages/compiler-cli/linker/src/file_linker/linker_options.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Flinker_options.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -27,6 +27,12 @@ export interface LinkerOptions {\n    * The default is `false`.\n    */\n   i18nUseExternalIds: boolean;\n+\n+  /**\n+   * Whether to use source-mapping to compute the original source for external templates.\n+   * The default is `true`.\n+   */\n+  sourceMapping: boolean;\n }\n \n /**\n@@ -36,4 +42,5 @@ export const DEFAULT_LINKER_OPTIONS: LinkerOptions = {\n   enableI18nLegacyMessageIdFormat: true,\n   i18nNormalizeLineEndingsInICUs: false,\n   i18nUseExternalIds: false,\n+  sourceMapping: true,\n };"
        },
        {
            "sha": "c453286976783e42c765733683ab4093698e3974",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 178,
            "deletions": 116,
            "changes": 294,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -9,127 +9,210 @@ import {compileComponentFromMetadata, ConstantPool, DeclarationListEmitMode, DEF\n import {ChangeDetectionStrategy, ViewEncapsulation} from '@angular/compiler/src/core';\n import * as o from '@angular/compiler/src/output/output_ast';\n \n+import {AbsoluteFsPath} from '../../../../src/ngtsc/file_system';\n import {Range} from '../../ast/ast_host';\n import {AstObject, AstValue} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n-import {LinkerOptions} from '../linker_options';\n+import {GetSourceFileFn} from '../get_source_file';\n+import {LinkerEnvironment} from '../linker_environment';\n \n import {toR3DirectiveMeta} from './partial_directive_linker_1';\n import {PartialLinker} from './partial_linker';\n \n /**\n  * A `PartialLinker` that is designed to process `ɵɵngDeclareComponent()` call expressions.\n  */\n-export class PartialComponentLinkerVersion1<TExpression> implements PartialLinker<TExpression> {\n-  constructor(private readonly options: LinkerOptions) {}\n+export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n+    PartialLinker<TExpression> {\n+  private readonly i18nNormalizeLineEndingsInICUs =\n+      this.environment.options.i18nNormalizeLineEndingsInICUs;\n+  private readonly enableI18nLegacyMessageIdFormat =\n+      this.environment.options.enableI18nLegacyMessageIdFormat;\n+  private readonly i18nUseExternalIds = this.environment.options.i18nUseExternalIds;\n+\n+  constructor(\n+      private readonly environment: LinkerEnvironment<TStatement, TExpression>,\n+      private readonly getSourceFile: GetSourceFileFn, private sourceUrl: AbsoluteFsPath,\n+      private code: string) {}\n \n   linkPartialDeclaration(\n-      sourceUrl: string, code: string, constantPool: ConstantPool,\n+      constantPool: ConstantPool,\n       metaObj: AstObject<R3PartialDeclaration, TExpression>): o.Expression {\n-    const meta = toR3ComponentMeta(metaObj, code, sourceUrl, this.options);\n+    const meta = this.toR3ComponentMeta(metaObj);\n     const def = compileComponentFromMetadata(meta, constantPool, makeBindingParser());\n     return def.expression;\n   }\n-}\n \n-/**\n- * This function derives the `R3ComponentMetadata` from the provided AST object.\n- */\n-export function toR3ComponentMeta<TExpression>(\n-    metaObj: AstObject<R3DeclareComponentMetadata, TExpression>, code: string, sourceUrl: string,\n-    options: LinkerOptions): R3ComponentMetadata {\n-  const interpolation = parseInterpolationConfig(metaObj);\n-  const templateObj = metaObj.getObject('template');\n-  const templateSource = templateObj.getValue('source');\n-  const range = getTemplateRange(templateSource, code);\n-  const isInline = templateObj.getBoolean('isInline');\n-\n-  // We always normalize line endings if the template is inline.\n-  const i18nNormalizeLineEndingsInICUs = isInline || options.i18nNormalizeLineEndingsInICUs;\n-\n-  const template = parseTemplate(code, sourceUrl, {\n-    escapedString: true,\n-    interpolationConfig: interpolation,\n-    range,\n-    enableI18nLegacyMessageIdFormat: options.enableI18nLegacyMessageIdFormat,\n-    preserveWhitespaces:\n-        metaObj.has('preserveWhitespaces') ? metaObj.getBoolean('preserveWhitespaces') : false,\n-    i18nNormalizeLineEndingsInICUs,\n-    isInline,\n-  });\n-  if (template.errors !== null) {\n-    const errors = template.errors.map(err => err.toString()).join('\\n');\n-    throw new FatalLinkerError(\n-        templateSource.expression, `Errors found in the template:\\n${errors}`);\n-  }\n+  /**\n+   * This function derives the `R3ComponentMetadata` from the provided AST object.\n+   */\n+  private toR3ComponentMeta(metaObj: AstObject<R3DeclareComponentMetadata, TExpression>):\n+      R3ComponentMetadata {\n+    const interpolation = parseInterpolationConfig(metaObj);\n+    const templateObj = metaObj.getObject('template');\n+    const templateSource = templateObj.getValue('source');\n+    const isInline = templateObj.getBoolean('isInline');\n+    const templateInfo = this.getTemplateInfo(templateSource, isInline);\n \n-  let declarationListEmitMode = DeclarationListEmitMode.Direct;\n+    // We always normalize line endings if the template is inline.\n+    const i18nNormalizeLineEndingsInICUs = isInline || this.i18nNormalizeLineEndingsInICUs;\n \n-  let directives: R3UsedDirectiveMetadata[] = [];\n-  if (metaObj.has('directives')) {\n-    directives = metaObj.getArray('directives').map(directive => {\n-      const directiveExpr = directive.getObject();\n-      const type = directiveExpr.getValue('type');\n-      const selector = directiveExpr.getString('selector');\n+    const template = parseTemplate(templateInfo.code, templateInfo.sourceUrl, {\n+      escapedString: templateInfo.isEscaped,\n+      interpolationConfig: interpolation,\n+      range: templateInfo.range,\n+      enableI18nLegacyMessageIdFormat: this.enableI18nLegacyMessageIdFormat,\n+      preserveWhitespaces:\n+          metaObj.has('preserveWhitespaces') ? metaObj.getBoolean('preserveWhitespaces') : false,\n+      i18nNormalizeLineEndingsInICUs,\n+      isInline,\n+    });\n+    if (template.errors !== null) {\n+      const errors = template.errors.map(err => err.toString()).join('\\n');\n+      throw new FatalLinkerError(\n+          templateSource.expression, `Errors found in the template:\\n${errors}`);\n+    }\n \n-      let typeExpr = type.getOpaque();\n-      const forwardRefType = extractForwardRef(type);\n-      if (forwardRefType !== null) {\n-        typeExpr = forwardRefType;\n-        declarationListEmitMode = DeclarationListEmitMode.Closure;\n-      }\n+    let declarationListEmitMode = DeclarationListEmitMode.Direct;\n \n-      return {\n-        type: typeExpr,\n-        selector: selector,\n-        inputs: directiveExpr.has('inputs') ?\n-            directiveExpr.getArray('inputs').map(input => input.getString()) :\n-            [],\n-        outputs: directiveExpr.has('outputs') ?\n-            directiveExpr.getArray('outputs').map(input => input.getString()) :\n-            [],\n-        exportAs: directiveExpr.has('exportAs') ?\n-            directiveExpr.getArray('exportAs').map(exportAs => exportAs.getString()) :\n-            null,\n-      };\n-    });\n+    let directives: R3UsedDirectiveMetadata[] = [];\n+    if (metaObj.has('directives')) {\n+      directives = metaObj.getArray('directives').map(directive => {\n+        const directiveExpr = directive.getObject();\n+        const type = directiveExpr.getValue('type');\n+        const selector = directiveExpr.getString('selector');\n+\n+        let typeExpr = type.getOpaque();\n+        const forwardRefType = extractForwardRef(type);\n+        if (forwardRefType !== null) {\n+          typeExpr = forwardRefType;\n+          declarationListEmitMode = DeclarationListEmitMode.Closure;\n+        }\n+\n+        return {\n+          type: typeExpr,\n+          selector: selector,\n+          inputs: directiveExpr.has('inputs') ?\n+              directiveExpr.getArray('inputs').map(input => input.getString()) :\n+              [],\n+          outputs: directiveExpr.has('outputs') ?\n+              directiveExpr.getArray('outputs').map(input => input.getString()) :\n+              [],\n+          exportAs: directiveExpr.has('exportAs') ?\n+              directiveExpr.getArray('exportAs').map(exportAs => exportAs.getString()) :\n+              null,\n+        };\n+      });\n+    }\n+\n+    let pipes = new Map<string, o.Expression>();\n+    if (metaObj.has('pipes')) {\n+      pipes = metaObj.getObject('pipes').toMap(pipe => {\n+        const forwardRefType = extractForwardRef(pipe);\n+        if (forwardRefType !== null) {\n+          declarationListEmitMode = DeclarationListEmitMode.Closure;\n+          return forwardRefType;\n+        } else {\n+          return pipe.getOpaque();\n+        }\n+      });\n+    }\n+\n+    return {\n+      ...toR3DirectiveMeta(metaObj, this.code, this.sourceUrl),\n+      viewProviders: metaObj.has('viewProviders') ? metaObj.getOpaque('viewProviders') : null,\n+      template: {\n+        nodes: template.nodes,\n+        ngContentSelectors: template.ngContentSelectors,\n+      },\n+      declarationListEmitMode,\n+      styles: metaObj.has('styles') ? metaObj.getArray('styles').map(entry => entry.getString()) :\n+                                      [],\n+      encapsulation: metaObj.has('encapsulation') ?\n+          parseEncapsulation(metaObj.getValue('encapsulation')) :\n+          ViewEncapsulation.Emulated,\n+      interpolation,\n+      changeDetection: metaObj.has('changeDetection') ?\n+          parseChangeDetectionStrategy(metaObj.getValue('changeDetection')) :\n+          ChangeDetectionStrategy.Default,\n+      animations: metaObj.has('animations') ? metaObj.getOpaque('animations') : null,\n+      relativeContextFilePath: this.sourceUrl,\n+      i18nUseExternalIds: this.i18nUseExternalIds,\n+      pipes,\n+      directives,\n+    };\n   }\n \n-  let pipes = new Map<string, o.Expression>();\n-  if (metaObj.has('pipes')) {\n-    pipes = metaObj.getObject('pipes').toMap(pipe => {\n-      const forwardRefType = extractForwardRef(pipe);\n-      if (forwardRefType !== null) {\n-        declarationListEmitMode = DeclarationListEmitMode.Closure;\n-        return forwardRefType;\n-      } else {\n-        return pipe.getOpaque();\n+  /**\n+   * Update the range to remove the start and end chars, which should be quotes around the template.\n+   */\n+  private getTemplateInfo(templateNode: AstValue<unknown, TExpression>, isInline: boolean):\n+      TemplateInfo {\n+    const range = templateNode.getRange();\n+\n+    if (!isInline) {\n+      // If not marked as inline, then we try to get the template info from the original external\n+      // template file, via source-mapping.\n+      const externalTemplate = this.tryExternalTemplate(range);\n+      if (externalTemplate !== null) {\n+        return externalTemplate;\n       }\n-    });\n+    }\n+\n+    // Either the template is marked inline or we failed to find the original external template.\n+    // So just use the literal string from the partially compiled component declaration.\n+    return this.templateFromPartialCode(templateNode, range);\n   }\n \n-  return {\n-    ...toR3DirectiveMeta(metaObj, code, sourceUrl),\n-    viewProviders: metaObj.has('viewProviders') ? metaObj.getOpaque('viewProviders') : null,\n-    template: {\n-      nodes: template.nodes,\n-      ngContentSelectors: template.ngContentSelectors,\n-    },\n-    declarationListEmitMode,\n-    styles: metaObj.has('styles') ? metaObj.getArray('styles').map(entry => entry.getString()) : [],\n-    encapsulation: metaObj.has('encapsulation') ?\n-        parseEncapsulation(metaObj.getValue('encapsulation')) :\n-        ViewEncapsulation.Emulated,\n-    interpolation,\n-    changeDetection: metaObj.has('changeDetection') ?\n-        parseChangeDetectionStrategy(metaObj.getValue('changeDetection')) :\n-        ChangeDetectionStrategy.Default,\n-    animations: metaObj.has('animations') ? metaObj.getOpaque('animations') : null,\n-    relativeContextFilePath: sourceUrl,\n-    i18nUseExternalIds: options.i18nUseExternalIds,\n-    pipes,\n-    directives,\n-  };\n+  private tryExternalTemplate(range: Range): TemplateInfo|null {\n+    const sourceFile = this.getSourceFile();\n+    if (sourceFile === null) {\n+      return null;\n+    }\n+\n+    const pos = sourceFile.getOriginalLocation(range.startLine, range.startCol);\n+    // Only interested if the original location is in an \"external\" template file:\n+    // * the file is different to the current file\n+    // * the file does not end in `.js` or `.ts` (we expect it to be something like `.html`).\n+    // * the range starts at the beginning of the file\n+    if (pos === null || pos.file === this.sourceUrl || /\\.[jt]s$/.test(pos.file) ||\n+        pos.line !== 0 || pos.column !== 0) {\n+      return null;\n+    }\n+\n+    const templateContents = sourceFile.sources.find(src => src?.sourcePath === pos.file)!.contents;\n+\n+    return {\n+      code: templateContents,\n+      sourceUrl: pos.file,\n+      range: {startPos: 0, startLine: 0, startCol: 0, endPos: templateContents.length},\n+      isEscaped: false,\n+    };\n+  }\n+\n+  private templateFromPartialCode(\n+      templateNode: AstValue<unknown, TExpression>,\n+      {startPos, endPos, startLine, startCol}: Range): TemplateInfo {\n+    if (!/[\"'`]/.test(this.code[startPos]) || this.code[startPos] !== this.code[endPos - 1]) {\n+      throw new FatalLinkerError(\n+          templateNode.expression,\n+          `Expected the template string to be wrapped in quotes but got: ${\n+              this.code.substring(startPos, endPos)}`);\n+    }\n+    return {\n+      code: this.code,\n+      sourceUrl: this.sourceUrl,\n+      range: {startPos: startPos + 1, endPos: endPos - 1, startLine, startCol: startCol + 1},\n+      isEscaped: true,\n+    };\n+  }\n+}\n+\n+interface TemplateInfo {\n+  code: string;\n+  sourceUrl: string;\n+  range: Range;\n+  isEscaped: boolean;\n }\n \n /**\n@@ -188,27 +271,6 @@ function parseChangeDetectionStrategy<TExpression>(\n   return enumValue;\n }\n \n-/**\n- * Update the range to remove the start and end chars, which should be quotes around the template.\n- */\n-function getTemplateRange<TExpression>(\n-    templateNode: AstValue<unknown, TExpression>, code: string): Range {\n-  const {startPos, endPos, startLine, startCol} = templateNode.getRange();\n-\n-  if (!/[\"'`]/.test(code[startPos]) || code[startPos] !== code[endPos - 1]) {\n-    throw new FatalLinkerError(\n-        templateNode.expression,\n-        `Expected the template string to be wrapped in quotes but got: ${\n-            code.substring(startPos, endPos)}`);\n-  }\n-  return {\n-    startPos: startPos + 1,\n-    endPos: endPos - 1,\n-    startLine,\n-    startCol: startCol + 1,\n-  };\n-}\n-\n /**\n  * Extract the type reference expression from a `forwardRef` function call. For example, the\n  * expression `forwardRef(function() { return FooDir; })` returns `FooDir`. Note that this"
        },
        {
            "sha": "283c1b94744abc0bf7f2425dbc6b31b841a60258",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_directive_linker_1.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_directive_linker_1.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -8,6 +8,7 @@\n import {compileDirectiveFromMetadata, ConstantPool, makeBindingParser, ParseLocation, ParseSourceFile, ParseSourceSpan, R3DeclareDirectiveMetadata, R3DeclareQueryMetadata, R3DirectiveMetadata, R3HostMetadata, R3PartialDeclaration, R3QueryMetadata, R3Reference} from '@angular/compiler';\n import * as o from '@angular/compiler/src/output/output_ast';\n \n+import {AbsoluteFsPath} from '../../../../src/ngtsc/file_system';\n import {Range} from '../../ast/ast_host';\n import {AstObject, AstValue} from '../../ast/ast_value';\n import {FatalLinkerError} from '../../fatal_linker_error';\n@@ -18,10 +19,12 @@ import {PartialLinker} from './partial_linker';\n  * A `PartialLinker` that is designed to process `ɵɵngDeclareDirective()` call expressions.\n  */\n export class PartialDirectiveLinkerVersion1<TExpression> implements PartialLinker<TExpression> {\n+  constructor(private sourceUrl: AbsoluteFsPath, private code: string) {}\n+\n   linkPartialDeclaration(\n-      sourceUrl: string, code: string, constantPool: ConstantPool,\n+      constantPool: ConstantPool,\n       metaObj: AstObject<R3PartialDeclaration, TExpression>): o.Expression {\n-    const meta = toR3DirectiveMeta(metaObj, code, sourceUrl);\n+    const meta = toR3DirectiveMeta(metaObj, this.code, this.sourceUrl);\n     const def = compileDirectiveFromMetadata(meta, constantPool, makeBindingParser());\n     return def.expression;\n   }\n@@ -32,7 +35,7 @@ export class PartialDirectiveLinkerVersion1<TExpression> implements PartialLinke\n  */\n export function toR3DirectiveMeta<TExpression>(\n     metaObj: AstObject<R3DeclareDirectiveMetadata, TExpression>, code: string,\n-    sourceUrl: string): R3DirectiveMetadata {\n+    sourceUrl: AbsoluteFsPath): R3DirectiveMetadata {\n   const typeExpr = metaObj.getValue('type');\n   const typeName = typeExpr.getSymbolName();\n   if (typeName === null) {"
        },
        {
            "sha": "c75dbc2d937ac5049575448999439b43d974235e",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -7,6 +7,7 @@\n  */\n import {ConstantPool, R3PartialDeclaration} from '@angular/compiler';\n import * as o from '@angular/compiler/src/output/output_ast';\n+\n import {AstObject} from '../../ast/ast_value';\n \n /**\n@@ -20,6 +21,6 @@ export interface PartialLinker<TExpression> {\n    *     `R3DeclareComponentMetadata` interfaces.\n    */\n   linkPartialDeclaration(\n-      sourceUrl: string, code: string, constantPool: ConstantPool,\n+      constantPool: ConstantPool,\n       metaObj: AstObject<R3PartialDeclaration, TExpression>): o.Expression;\n }"
        },
        {
            "sha": "81e494ecf50ea09cfa7077116da5297695ad5ad4",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_linker_selector.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 27,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -6,7 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {satisfies} from 'semver';\n-import {LinkerOptions} from '../linker_options';\n+\n+import {AbsoluteFsPath} from '../../../../src/ngtsc/file_system';\n+import {createGetSourceFile} from '../get_source_file';\n+import {LinkerEnvironment} from '../linker_environment';\n \n import {PartialComponentLinkerVersion1} from './partial_component_linker_1';\n import {PartialDirectiveLinkerVersion1} from './partial_directive_linker_1';\n@@ -16,33 +19,29 @@ export const ɵɵngDeclareDirective = 'ɵɵngDeclareDirective';\n export const ɵɵngDeclareComponent = 'ɵɵngDeclareComponent';\n export const declarationFunctions = [ɵɵngDeclareDirective, ɵɵngDeclareComponent];\n \n-export class PartialLinkerSelector<TExpression> {\n-  /**\n-   * A database of linker instances that should be used if their given semver range satisfies the\n-   * version found in the code to be linked.\n-   *\n-   * Note that the ranges are checked in order, and the first matching range will be selected, so\n-   * ranges should be most restrictive first.\n-   *\n-   * Also, ranges are matched to include \"pre-releases\", therefore if the range is `>=11.1.0-next.1`\n-   * then this includes `11.1.0-next.2` and also `12.0.0-next.1`.\n-   *\n-   * Finally, note that we always start with the current version (i.e. `0.0.0-PLACEHOLDER`). This\n-   * allows the linker to work on local builds effectively.\n-   */\n-  private linkers: Record<string, {range: string, linker: PartialLinker<TExpression>}[]> = {\n-    [ɵɵngDeclareDirective]: [\n-      {range: '0.0.0-PLACEHOLDER', linker: new PartialDirectiveLinkerVersion1()},\n-      {range: '>=11.1.0-next.1', linker: new PartialDirectiveLinkerVersion1()},\n-    ],\n-    [ɵɵngDeclareComponent]:\n-        [\n-          {range: '0.0.0-PLACEHOLDER', linker: new PartialComponentLinkerVersion1(this.options)},\n-          {range: '>=11.1.0-next.1', linker: new PartialComponentLinkerVersion1(this.options)},\n-        ],\n-  };\n+/**\n+ * A helper that selects the appropriate `PartialLinker` for a given declaration.\n+ *\n+ * The selection is made from a database of linker instances, chosen if their given semver range\n+ * satisfies the version found in the code to be linked.\n+ *\n+ * Note that the ranges are checked in order, and the first matching range will be selected, so\n+ * ranges should be most restrictive first.\n+ *\n+ * Also, ranges are matched to include \"pre-releases\", therefore if the range is `>=11.1.0-next.1`\n+ * then this includes `11.1.0-next.2` and also `12.0.0-next.1`.\n+ *\n+ * Finally, note that we always start with the current version (i.e. `0.0.0-PLACEHOLDER`). This\n+ * allows the linker to work on local builds effectively.\n+ */\n+export class PartialLinkerSelector<TStatement, TExpression> {\n+  private readonly linkers: Record<string, {range: string, linker: PartialLinker<TExpression>}[]>;\n \n-  constructor(private options: LinkerOptions) {}\n+  constructor(\n+      environment: LinkerEnvironment<TStatement, TExpression>, sourceUrl: AbsoluteFsPath,\n+      code: string) {\n+    this.linkers = this.createLinkerMap(environment, sourceUrl, code);\n+  }\n \n   /**\n    * Returns true if there are `PartialLinker` classes that can handle functions with this name.\n@@ -69,4 +68,24 @@ export class PartialLinkerSelector<TExpression> {\n         `Unsupported partial declaration version ${version} for ${functionName}.\\n` +\n         'Valid version ranges are:\\n' + versions.map(v => ` - ${v.range}`).join('\\n'));\n   }\n+\n+  private createLinkerMap(\n+      environment: LinkerEnvironment<TStatement, TExpression>, sourceUrl: AbsoluteFsPath,\n+      code: string) {\n+    const partialDirectiveLinkerVersion1 = new PartialDirectiveLinkerVersion1(sourceUrl, code);\n+    const partialComponentLinkerVersion1 = new PartialComponentLinkerVersion1(\n+        environment, createGetSourceFile(sourceUrl, code, environment.sourceFileLoader), sourceUrl,\n+        code);\n+\n+    return {\n+      [ɵɵngDeclareDirective]: [\n+        {range: '0.0.0-PLACEHOLDER', linker: partialDirectiveLinkerVersion1},\n+        {range: '>=11.1.0-next.1', linker: partialDirectiveLinkerVersion1},\n+      ],\n+      [ɵɵngDeclareComponent]: [\n+        {range: '0.0.0-PLACEHOLDER', linker: partialComponentLinkerVersion1},\n+        {range: '>=11.1.0-next.1', linker: partialComponentLinkerVersion1},\n+      ],\n+    };\n+  }\n }"
        },
        {
            "sha": "e917f02c7415f0fa1b687284faa5bac8ac6b6262",
            "filename": "packages/compiler-cli/linker/test/BUILD.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2FBUILD.bazel?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -12,6 +12,9 @@ ts_library(\n         \"//packages:types\",\n         \"//packages/compiler\",\n         \"//packages/compiler-cli/linker\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/logging/testing\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "fe9b82ebfb7962f0123a60b69fc35cc8b5e5d2c1",
            "filename": "packages/compiler-cli/linker/test/file_linker/emit_scopes/emit_scope_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 15,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Femit_scopes%2Femit_scope_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Femit_scopes%2Femit_scope_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Femit_scopes%2Femit_scope_spec.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -9,31 +9,27 @@ import * as o from '@angular/compiler/src/output/output_ast';\n import * as ts from 'typescript';\n \n import {TypeScriptAstFactory} from '../../../../src/ngtsc/translator';\n-import {TypeScriptAstHost} from '../../../src/ast/typescript/typescript_ast_host';\n import {EmitScope} from '../../../src/file_linker/emit_scopes/emit_scope';\n-import {LinkerEnvironment} from '../../../src/file_linker/linker_environment';\n-import {DEFAULT_LINKER_OPTIONS} from '../../../src/file_linker/linker_options';\n+import {Translator} from '../../../src/file_linker/translator';\n import {generate} from '../helpers';\n \n describe('EmitScope', () => {\n   describe('translateDefinition()', () => {\n     it('should translate the given output AST into a TExpression', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, translator);\n \n       const def = emitScope.translateDefinition(o.fn([], [], null, null, 'foo'));\n       expect(generate(def)).toEqual('function foo() { }');\n     });\n \n     it('should use the `ngImport` idenfifier for imports when translating', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, translator);\n \n       const coreImportRef = new o.ExternalReference('@angular/core', 'foo');\n       const def = emitScope.translateDefinition(o.importExpr(coreImportRef).callMethod('bar', []));\n@@ -42,10 +38,9 @@ describe('EmitScope', () => {\n \n     it('should not emit any shared constants in the replacement expression', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, translator);\n \n       const constArray = o.literalArr([o.literal('CONST')]);\n       // We have to add the constant twice or it will not create a shared statement\n@@ -60,10 +55,9 @@ describe('EmitScope', () => {\n   describe('getConstantStatements()', () => {\n     it('should return any constant statements that were added to the `constantPool`', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope = new EmitScope<ts.Statement, ts.Expression>(ngImport, translator);\n \n       const constArray = o.literalArr([o.literal('CONST')]);\n       // We have to add the constant twice or it will not create a shared statement"
        },
        {
            "sha": "4873fd97b9e0f1fb603c0d381bf8cde618416fcf",
            "filename": "packages/compiler-cli/linker/test/file_linker/emit_scopes/iief_emit_scope_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 15,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Femit_scopes%2Fiief_emit_scope_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Femit_scopes%2Fiief_emit_scope_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Femit_scopes%2Fiief_emit_scope_spec.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -9,31 +9,29 @@ import * as o from '@angular/compiler/src/output/output_ast';\n import * as ts from 'typescript';\n \n import {TypeScriptAstFactory} from '../../../../src/ngtsc/translator';\n-import {TypeScriptAstHost} from '../../../src/ast/typescript/typescript_ast_host';\n import {IifeEmitScope} from '../../../src/file_linker/emit_scopes/iife_emit_scope';\n-import {LinkerEnvironment} from '../../../src/file_linker/linker_environment';\n-import {DEFAULT_LINKER_OPTIONS} from '../../../src/file_linker/linker_options';\n+import {Translator} from '../../../src/file_linker/translator';\n import {generate} from '../helpers';\n \n describe('IifeEmitScope', () => {\n   describe('translateDefinition()', () => {\n     it('should translate the given output AST into a TExpression, wrapped in an IIFE', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope =\n+          new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, translator, factory);\n \n       const def = emitScope.translateDefinition(o.fn([], [], null, null, 'foo'));\n       expect(generate(def)).toEqual('function () { return function foo() { }; }()');\n     });\n \n     it('should use the `ngImport` idenfifier for imports when translating', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope =\n+          new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, translator, factory);\n \n       const coreImportRef = new o.ExternalReference('@angular/core', 'foo');\n       const def = emitScope.translateDefinition(o.importExpr(coreImportRef).callMethod('bar', []));\n@@ -42,10 +40,10 @@ describe('IifeEmitScope', () => {\n \n     it('should emit any shared constants in the replacement expression IIFE', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope =\n+          new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, translator, factory);\n \n       const constArray = o.literalArr([o.literal('CONST')]);\n       // We have to add the constant twice or it will not create a shared statement\n@@ -61,10 +59,10 @@ describe('IifeEmitScope', () => {\n   describe('getConstantStatements()', () => {\n     it('should throw an error', () => {\n       const factory = new TypeScriptAstFactory();\n-      const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-          new TypeScriptAstHost(), factory, DEFAULT_LINKER_OPTIONS);\n+      const translator = new Translator<ts.Statement, ts.Expression>(factory);\n       const ngImport = factory.createIdentifier('core');\n-      const emitScope = new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, linkerEnvironment);\n+      const emitScope =\n+          new IifeEmitScope<ts.Statement, ts.Expression>(ngImport, translator, factory);\n       expect(() => emitScope.getConstantStatements()).toThrowError();\n     });\n   });"
        },
        {
            "sha": "39b0e2f78c7599c880567be4c37460836dd57bf1",
            "filename": "packages/compiler-cli/linker/test/file_linker/file_linker_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Ffile_linker_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Ffile_linker_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Ffile_linker_spec.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -8,6 +8,8 @@\n import * as o from '@angular/compiler/src/output/output_ast';\n import * as ts from 'typescript';\n \n+import {MockFileSystemNative} from '../../../src/ngtsc/file_system/testing';\n+import {MockLogger} from '../../../src/ngtsc/logging/testing';\n import {TypeScriptAstFactory} from '../../../src/ngtsc/translator';\n import {AstHost} from '../../src/ast/ast_host';\n import {TypeScriptAstHost} from '../../src/ast/typescript/typescript_ast_host';\n@@ -16,6 +18,7 @@ import {FileLinker} from '../../src/file_linker/file_linker';\n import {LinkerEnvironment} from '../../src/file_linker/linker_environment';\n import {DEFAULT_LINKER_OPTIONS} from '../../src/file_linker/linker_options';\n import {PartialDirectiveLinkerVersion1} from '../../src/file_linker/partial_linkers/partial_directive_linker_1';\n+\n import {generate} from './helpers';\n \n describe('FileLinker', () => {\n@@ -91,7 +94,7 @@ describe('FileLinker', () => {\n \n       expect(compilationResult).toEqual(factory.createLiteral('compilation result'));\n       expect(compileSpy).toHaveBeenCalled();\n-      expect(compileSpy.calls.mostRecent().args[3].getNode('ngImport')).toBe(ngImport);\n+      expect(compileSpy.calls.mostRecent().args[1].getNode('ngImport')).toBe(ngImport);\n     });\n   });\n \n@@ -148,10 +151,12 @@ describe('FileLinker', () => {\n     host: AstHost<ts.Expression>,\n     fileLinker: FileLinker<MockConstantScopeRef, ts.Statement, ts.Expression>\n   } {\n+    const fs = new MockFileSystemNative();\n+    const logger = new MockLogger();\n     const linkerEnvironment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n-        new TypeScriptAstHost(), new TypeScriptAstFactory(), DEFAULT_LINKER_OPTIONS);\n+        fs, logger, new TypeScriptAstHost(), new TypeScriptAstFactory(), DEFAULT_LINKER_OPTIONS);\n     const fileLinker = new FileLinker<MockConstantScopeRef, ts.Statement, ts.Expression>(\n-        linkerEnvironment, 'test.js', '// test code');\n+        linkerEnvironment, fs.resolve('/test.js'), '// test code');\n     return {host: linkerEnvironment.host, fileLinker};\n   }\n });\n@@ -185,7 +190,7 @@ class MockConstantScopeRef {\n function spyOnLinkPartialDeclarationWithConstants(replacement: o.Expression) {\n   let callCount = 0;\n   spyOn(PartialDirectiveLinkerVersion1.prototype, 'linkPartialDeclaration')\n-      .and.callFake(((sourceUrl, code, constantPool) => {\n+      .and.callFake((constantPool => {\n                       const constArray = o.literalArr([o.literal(++callCount)]);\n                       // We have to add the constant twice or it will not create a shared statement\n                       constantPool.getConstLiteral(constArray);"
        },
        {
            "sha": "f8d524881a4eceff32e5b7c144150299c6145fd3",
            "filename": "packages/compiler-cli/linker/test/file_linker/partial_linkers/partial_linker_selector_spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 5,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Ftest%2Ffile_linker%2Fpartial_linkers%2Fpartial_linker_selector_spec.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -5,8 +5,15 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import * as ts from 'typescript';\n \n import {LinkerOptions} from '../../..';\n+import {FileSystem} from '../../../../src/ngtsc/file_system';\n+import {MockFileSystemNative} from '../../../../src/ngtsc/file_system/testing';\n+import {MockLogger} from '../../../../src/ngtsc/logging/testing';\n+import {TypeScriptAstFactory} from '../../../../src/ngtsc/translator';\n+import {TypeScriptAstHost} from '../../../src/ast/typescript/typescript_ast_host';\n+import {LinkerEnvironment} from '../../../src/file_linker/linker_environment';\n import {PartialComponentLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_component_linker_1';\n import {PartialDirectiveLinkerVersion1} from '../../../src/file_linker/partial_linkers/partial_directive_linker_1';\n import {PartialLinkerSelector} from '../../../src/file_linker/partial_linkers/partial_linker_selector';\n@@ -16,12 +23,23 @@ describe('PartialLinkerSelector', () => {\n     i18nNormalizeLineEndingsInICUs: true,\n     enableI18nLegacyMessageIdFormat: false,\n     i18nUseExternalIds: false,\n+    sourceMapping: false,\n   };\n+  let environment: LinkerEnvironment<ts.Statement, ts.Expression>;\n+  let fs: FileSystem;\n+\n+  beforeEach(() => {\n+    fs = new MockFileSystemNative();\n+    const logger = new MockLogger();\n+    environment = LinkerEnvironment.create<ts.Statement, ts.Expression>(\n+        fs, logger, new TypeScriptAstHost(), new TypeScriptAstFactory(), options);\n+  });\n \n   describe('supportsDeclaration()', () => {\n     it('should return true if there is at least one linker that matches the given function name',\n        () => {\n-         const selector = new PartialLinkerSelector(options);\n+         const selector = new PartialLinkerSelector(\n+             environment, fs.resolve('/some/path/to/file.js'), 'some file contents');\n          expect(selector.supportsDeclaration('ɵɵngDeclareDirective')).toBe(true);\n          expect(selector.supportsDeclaration('ɵɵngDeclareComponent')).toBe(true);\n          expect(selector.supportsDeclaration('$foo')).toBe(false);\n@@ -30,15 +48,17 @@ describe('PartialLinkerSelector', () => {\n \n   describe('getLinker()', () => {\n     it('should return the latest linker if the version is \"0.0.0-PLACEHOLDER\"', () => {\n-      const selector = new PartialLinkerSelector(options);\n+      const selector = new PartialLinkerSelector(\n+          environment, fs.resolve('/some/path/to/file.js'), 'some file contents');\n       expect(selector.getLinker('ɵɵngDeclareDirective', '0.0.0-PLACEHOLDER'))\n           .toBeInstanceOf(PartialDirectiveLinkerVersion1);\n       expect(selector.getLinker('ɵɵngDeclareComponent', '0.0.0-PLACEHOLDER'))\n           .toBeInstanceOf(PartialComponentLinkerVersion1);\n     });\n \n     it('should return the linker that matches the name and valid full version', () => {\n-      const selector = new PartialLinkerSelector(options);\n+      const selector = new PartialLinkerSelector(\n+          environment, fs.resolve('/some/path/to/file.js'), 'some file contents');\n       expect(selector.getLinker('ɵɵngDeclareDirective', '11.1.2'))\n           .toBeInstanceOf(PartialDirectiveLinkerVersion1);\n       expect(selector.getLinker('ɵɵngDeclareDirective', '11.2.5'))\n@@ -48,7 +68,8 @@ describe('PartialLinkerSelector', () => {\n     });\n \n     it('should return the linker that matches the name and valid pre-release versions', () => {\n-      const selector = new PartialLinkerSelector(options);\n+      const selector = new PartialLinkerSelector(\n+          environment, fs.resolve('/some/path/to/file.js'), 'some file contents');\n       expect(selector.getLinker('ɵɵngDeclareDirective', '11.1.0-next.1'))\n           .toBeInstanceOf(PartialDirectiveLinkerVersion1);\n       expect(selector.getLinker('ɵɵngDeclareDirective', '11.1.0-next.7'))\n@@ -58,7 +79,8 @@ describe('PartialLinkerSelector', () => {\n     });\n \n     it('should throw an error if there is no linker that matches the given name or version', () => {\n-      const selector = new PartialLinkerSelector(options);\n+      const selector = new PartialLinkerSelector(\n+          environment, fs.resolve('/some/path/to/file.js'), 'some file contents');\n       // `$foo` is not a valid name, even though `0.0.0-PLACEHOLDER` is a valid version\n       expect(() => selector.getLinker('$foo', '0.0.0-PLACEHOLDER'))\n           .toThrowError('Unknown partial declaration function $foo.');"
        },
        {
            "sha": "bbe1379f7e94a9eee709f2b686b67fa99ccea91f",
            "filename": "packages/compiler-cli/test/compliance/linked/linked_compile_spec.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 25,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Flinked%2Flinked_compile_spec.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -22,50 +22,55 @@ runTests('linked compile', linkPartials);\n /**\n  * Link all the partials specified in the given `test`.\n  *\n- * @param fs The mock file-system to use for linking the partials.\n+ * @param fileSystem The mock file-system to use for linking the partials.\n  * @param test The compliance test whose partials will be linked.\n  */\n-function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n+function linkPartials(fileSystem: FileSystem, test: ComplianceTest): CompileResult {\n   const logger = new ConsoleLogger(LogLevel.debug);\n-  const loader = new SourceFileLoader(fs, logger, {});\n-  const builtDirectory = getBuildOutputDirectory(fs);\n+  const loader = new SourceFileLoader(fileSystem, logger, {});\n+  const builtDirectory = getBuildOutputDirectory(fileSystem);\n   const linkerPlugin = createEs2015LinkerPlugin({\n+    fileSystem,\n+    logger,\n     // By default we don't render legacy message ids in compliance tests.\n     enableI18nLegacyMessageIdFormat: false,\n+    sourceMapping: test.compilerOptions?.sourceMap === true,\n     ...test.angularCompilerOptions\n   });\n-  const goldenPartialPath = fs.resolve('/GOLDEN_PARTIAL.js');\n-  if (!fs.exists(goldenPartialPath)) {\n+  const goldenPartialPath = fileSystem.resolve('/GOLDEN_PARTIAL.js');\n+  if (!fileSystem.exists(goldenPartialPath)) {\n     throw new Error(\n         'Golden partial does not exist for this test\\n' +\n         'Try generating it by running:\\n' +\n         `bazel run //packages/compiler-cli/test/compliance/test_cases:${\n             test.relativePath}.golden.update`);\n   }\n-  const partialFile = fs.readFile(goldenPartialPath);\n+  const partialFile = fileSystem.readFile(goldenPartialPath);\n   const partialFiles = parseGoldenPartial(partialFile);\n \n-  partialFiles.forEach(f => safeWrite(fs, fs.resolve(builtDirectory, f.path), f.content));\n+  partialFiles.forEach(\n+      f => safeWrite(fileSystem, fileSystem.resolve(builtDirectory, f.path), f.content));\n \n   for (const expectation of test.expectations) {\n-    for (const {generated: fileName} of expectation.files) {\n-      const partialPath = fs.resolve(builtDirectory, fileName);\n-      if (!fs.exists(partialPath)) {\n+    for (const {generated} of expectation.files) {\n+      const fileName = fileSystem.resolve(builtDirectory, generated);\n+      if (!fileSystem.exists(fileName)) {\n         continue;\n       }\n-      const source = fs.readFile(partialPath);\n-      const sourceMapPath = fs.resolve(partialPath + '.map');\n-      const sourceMap =\n-          fs.exists(sourceMapPath) ? JSON.parse(fs.readFile(sourceMapPath)) : undefined;\n+      const source = fileSystem.readFile(fileName);\n+      const sourceMapPath = fileSystem.resolve(fileName + '.map');\n+      const sourceMap = fileSystem.exists(sourceMapPath) ?\n+          JSON.parse(fileSystem.readFile(sourceMapPath)) :\n+          undefined;\n       const {linkedSource, linkedSourceMap} =\n-          applyLinker({path: partialPath, source, sourceMap}, linkerPlugin);\n+          applyLinker(builtDirectory, fileName, source, sourceMap, linkerPlugin);\n \n       if (linkedSourceMap !== undefined) {\n         const mapAndPath: MapAndPath = {map: linkedSourceMap, mapPath: sourceMapPath};\n-        const sourceFile = loader.loadSourceFile(partialPath, linkedSource, mapAndPath);\n-        safeWrite(fs, sourceMapPath, JSON.stringify(sourceFile.renderFlattenedSourceMap()));\n+        const sourceFile = loader.loadSourceFile(fileName, linkedSource, mapAndPath);\n+        safeWrite(fileSystem, sourceMapPath, JSON.stringify(sourceFile.renderFlattenedSourceMap()));\n       }\n-      safeWrite(fs, partialPath, linkedSource);\n+      safeWrite(fileSystem, fileName, linkedSource);\n     }\n   }\n   return {emittedFiles: [], errors: []};\n@@ -81,14 +86,15 @@ function linkPartials(fs: FileSystem, test: ComplianceTest): CompileResult {\n  * @returns The file's source content, which has been transformed using the linker if necessary.\n  */\n function applyLinker(\n-    file: {path: string; source: string, sourceMap: RawSourceMap | undefined},\n+    cwd: string, filename: string, source: string, sourceMap: RawSourceMap|undefined,\n     linkerPlugin: PluginObj): {linkedSource: string, linkedSourceMap: RawSourceMap|undefined} {\n-  if (!file.path.endsWith('.js') || !needsLinking(file.path, file.source)) {\n-    return {linkedSource: file.source, linkedSourceMap: file.sourceMap};\n+  if (!filename.endsWith('.js') || !needsLinking(filename, source)) {\n+    return {linkedSource: source, linkedSourceMap: sourceMap};\n   }\n-  const result = transformSync(file.source, {\n-    filename: file.path,\n-    sourceMaps: !!file.sourceMap,\n+  const result = transformSync(source, {\n+    cwd,\n+    filename,\n+    sourceMaps: !!sourceMap,\n     plugins: [linkerPlugin],\n     parserOpts: {sourceType: 'unambiguous'},\n   });"
        },
        {
            "sha": "3953c78dc90f351ef4a4fc2e6f36071c6c718aaf",
            "filename": "packages/compiler-cli/test/compliance_old/prelink/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2FBUILD.bazel?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -8,6 +8,8 @@ ts_library(\n         \"//packages:types\",\n         \"//packages/compiler-cli/linker\",\n         \"//packages/compiler-cli/linker/babel\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/logging/testing\",\n         \"//packages/compiler-cli/test/compliance_old/mock_compile\",\n         \"@npm//@babel/core\",\n         \"@npm//@babel/generator\","
        },
        {
            "sha": "3830156273e4fcd72e8a3a2abf6946c93c5a5519",
            "filename": "packages/compiler-cli/test/compliance_old/prelink/bootstrap.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2Fbootstrap.ts",
            "raw_url": "https://github.com/angular/angular/raw/266cc9b162d92f5998de1e574eb66b26c0e6f98f/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2Fbootstrap.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance_old%2Fprelink%2Fbootstrap.ts?ref=266cc9b162d92f5998de1e574eb66b26c0e6f98f",
            "patch": "@@ -10,6 +10,8 @@ import * as ts from 'typescript';\n \n import {needsLinking} from '../../../linker';\n import {createEs2015LinkerPlugin} from '../../../linker/babel';\n+import {MockFileSystemNative} from '../../../src/ngtsc/file_system/testing';\n+import {MockLogger} from '../../../src/ngtsc/logging/testing';\n import {compileFiles, CompileFn, setCompileFn} from '../mock_compile';\n \n /**\n@@ -28,8 +30,11 @@ const linkedCompile: CompileFn = (data, angularFiles, options) => {\n   }\n \n   const compiledFiles = compileFiles(data, angularFiles, {...options, compilationMode: 'partial'});\n-\n+  const fileSystem = new MockFileSystemNative();\n+  const logger = new MockLogger();\n   const linkerPlugin = createEs2015LinkerPlugin({\n+    fileSystem,\n+    logger,\n     // enableI18nLegacyMessageIdFormat defaults to false in `compileFiles`.\n     enableI18nLegacyMessageIdFormat: false,\n     ...options,"
        }
    ],
    "stats": {
        "total": 781,
        "additions": 524,
        "deletions": 257
    }
}