{
    "author": "JoostK",
    "message": "feat(compiler-cli): JIT compilation of directive declarations (#40101)\n\nThe `ɵɵngDeclareDirective` calls are designed to be translated to fully\nAOT compiled code during a build transform, but in cases this is not\ndone it is still possible to compile the declaration object in the\nbrowser using the JIT compiler. This commit adds a runtime\nimplementation of `ɵɵngDeclareDirective` which invokes the JIT compiler\nusing the declaration object, such that a compiled directive definition\nis made available to the Ivy runtime.\n\nPR Close #40101",
    "sha": "9186f1feea2490efa4cb1c6c95665100142c9aa6",
    "files": [
        {
            "sha": "92d8d18f26cfa3859a1720769a9fb9ec55fe9d46",
            "filename": "packages/compiler/src/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -37,6 +37,9 @@ export interface CompilerFacade {\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3NgModuleMetadataFacade): any;\n   compileDirective(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3DirectiveMetadataFacade): any;\n+  compileDirectiveDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      declaration: R3DeclareDirectiveFacade): any;\n   compileComponent(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3ComponentMetadataFacade): any;\n   compileFactory(\n@@ -162,6 +165,28 @@ export interface R3ComponentMetadataFacade extends R3DirectiveMetadataFacade {\n   changeDetection?: ChangeDetectionStrategy;\n }\n \n+export type OpaqueValue = unknown;\n+\n+export interface R3DeclareDirectiveFacade {\n+  selector?: string;\n+  type: Function;\n+  inputs?: {[classPropertyName: string]: string|[string, string]};\n+  outputs?: {[classPropertyName: string]: string};\n+  host?: {\n+    attributes?: {[key: string]: OpaqueValue};\n+    listeners?: {[key: string]: string};\n+    properties?: {[key: string]: string};\n+    classAttribute?: string;\n+    styleAttribute?: string;\n+  };\n+  queries?: R3DeclareQueryMetadataFacade[];\n+  viewQueries?: R3DeclareQueryMetadataFacade[];\n+  providers?: OpaqueValue;\n+  exportAs?: string[];\n+  usesInheritance?: boolean;\n+  usesOnChanges?: boolean;\n+}\n+\n export interface R3UsedDirectiveMetadata {\n   selector: string;\n   inputs: string[];\n@@ -197,6 +222,15 @@ export interface R3QueryMetadataFacade {\n   static: boolean;\n }\n \n+export interface R3DeclareQueryMetadataFacade {\n+  propertyName: string;\n+  first?: boolean;\n+  predicate: OpaqueValue|string[];\n+  descendants?: boolean;\n+  read?: OpaqueValue;\n+  static?: boolean;\n+}\n+\n export interface ParseSourceSpan {\n   start: any;\n   end: any;"
        },
        {
            "sha": "750e925bf5b65de317dd6b991c5eb59b5c17f712",
            "filename": "packages/compiler/src/jit_compiler_facade.ts",
            "status": "modified",
            "additions": 76,
            "deletions": 4,
            "changes": 80,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n \n-import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, R3ComponentMetadataFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n+import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareDirectiveFacade, R3DeclareQueryMetadataFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n import {ConstantPool} from './constant_pool';\n import {HostBinding, HostListener, Input, Output, Type} from './core';\n import {Identifiers} from './identifiers';\n@@ -21,7 +21,7 @@ import {R3JitReflector} from './render3/r3_jit';\n import {compileInjector, compileNgModule, R3InjectorMetadata, R3NgModuleMetadata} from './render3/r3_module_compiler';\n import {compilePipeFromMetadata, R3PipeMetadata} from './render3/r3_pipe_compiler';\n import {R3Reference} from './render3/util';\n-import {R3ComponentMetadata, R3DirectiveMetadata, R3QueryMetadata} from './render3/view/api';\n+import {R3ComponentMetadata, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata} from './render3/view/api';\n import {compileComponentFromMetadata, compileDirectiveFromMetadata, ParsedHostBindings, parseHostBindings, verifyHostBindings} from './render3/view/compiler';\n import {makeBindingParser, parseTemplate} from './render3/view/template';\n import {ResourceLoader} from './resource_loader';\n@@ -107,10 +107,23 @@ export class CompilerFacadeImpl implements CompilerFacade {\n   compileDirective(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n       facade: R3DirectiveMetadataFacade): any {\n+    const meta: R3DirectiveMetadata = convertDirectiveFacadeToMetadata(facade);\n+    return this.compileDirectiveFromMeta(angularCoreEnv, sourceMapUrl, meta);\n+  }\n+\n+  compileDirectiveDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      declaration: R3DeclareDirectiveFacade): any {\n+    const typeSourceSpan =\n+        this.createParseSourceSpan('Directive', declaration.type.name, sourceMapUrl);\n+    const meta = convertDeclareDirectiveFacadeToMetadata(declaration, typeSourceSpan);\n+    return this.compileDirectiveFromMeta(angularCoreEnv, sourceMapUrl, meta);\n+  }\n+\n+  private compileDirectiveFromMeta(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3DirectiveMetadata): any {\n     const constantPool = new ConstantPool();\n     const bindingParser = makeBindingParser();\n-\n-    const meta: R3DirectiveMetadata = convertDirectiveFacadeToMetadata(facade);\n     const res = compileDirectiveFromMetadata(meta, constantPool, bindingParser);\n     return this.jitExpression(\n         res.expression, angularCoreEnv, sourceMapUrl, constantPool.statements);\n@@ -230,6 +243,19 @@ function convertToR3QueryMetadata(facade: R3QueryMetadataFacade): R3QueryMetadat\n   };\n }\n \n+function convertQueryDeclarationToMetadata(declaration: R3DeclareQueryMetadataFacade):\n+    R3QueryMetadata {\n+  return {\n+    propertyName: declaration.propertyName,\n+    first: declaration.first ?? false,\n+    predicate: Array.isArray(declaration.predicate) ? declaration.predicate :\n+                                                      new WrappedNodeExpr(declaration.predicate),\n+    descendants: declaration.descendants ?? false,\n+    read: declaration.read ? new WrappedNodeExpr(declaration.read) : null,\n+    static: declaration.static ?? false,\n+  };\n+}\n+\n function convertDirectiveFacadeToMetadata(facade: R3DirectiveMetadataFacade): R3DirectiveMetadata {\n   const inputsFromMetadata = parseInputOutputs(facade.inputs || []);\n   const outputsFromMetadata = parseInputOutputs(facade.outputs || []);\n@@ -265,6 +291,52 @@ function convertDirectiveFacadeToMetadata(facade: R3DirectiveMetadataFacade): R3\n   };\n }\n \n+function convertDeclareDirectiveFacadeToMetadata(\n+    declaration: R3DeclareDirectiveFacade, typeSourceSpan: ParseSourceSpan): R3DirectiveMetadata {\n+  return {\n+    name: declaration.type.name,\n+    type: wrapReference(declaration.type),\n+    typeSourceSpan,\n+    internalType: new WrappedNodeExpr(declaration.type),\n+    selector: declaration.selector ?? null,\n+    inputs: declaration.inputs ?? {},\n+    outputs: declaration.outputs ?? {},\n+    host: convertHostDeclarationToMetadata(declaration.host),\n+    queries: (declaration.queries ?? []).map(convertQueryDeclarationToMetadata),\n+    viewQueries: (declaration.viewQueries ?? []).map(convertQueryDeclarationToMetadata),\n+    providers: declaration.providers !== undefined ? new WrappedNodeExpr(declaration.providers) :\n+                                                     null,\n+    exportAs: declaration.exportAs ?? null,\n+    usesInheritance: declaration.usesInheritance ?? false,\n+    lifecycle: {usesOnChanges: declaration.usesOnChanges ?? false},\n+    deps: null,\n+    typeArgumentCount: 0,\n+    fullInheritance: false,\n+  };\n+}\n+\n+function convertHostDeclarationToMetadata(host: R3DeclareDirectiveFacade['host'] = {}):\n+    R3HostMetadata {\n+  return {\n+    attributes: convertOpaqueValuesToExpressions(host.attributes ?? {}),\n+    listeners: host.listeners ?? {},\n+    properties: host.properties ?? {},\n+    specialAttributes: {\n+      classAttr: host.classAttribute,\n+      styleAttr: host.styleAttribute,\n+    },\n+  };\n+}\n+\n+function convertOpaqueValuesToExpressions(obj: {[key: string]: OpaqueValue}):\n+    {[key: string]: WrappedNodeExpr<unknown>} {\n+  const result: {[key: string]: WrappedNodeExpr<unknown>} = {};\n+  for (const key of Object.keys(obj)) {\n+    result[key] = new WrappedNodeExpr(obj[key]);\n+  }\n+  return result;\n+}\n+\n // This seems to be needed to placate TS v3.0 only\n type R3DirectiveMetadataFacadeNoPropAndWhitespace =\n     Pick<R3DirectiveMetadataFacade, Exclude<keyof R3DirectiveMetadataFacade, 'propMetadata'>>;"
        },
        {
            "sha": "ac07694f2b7420f5072eb1fd81d86b5df30183d0",
            "filename": "packages/compiler/src/render3/partial/api.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -46,8 +46,7 @@ export interface R3DeclareDirectiveMetadata extends R3PartialDeclaration {\n   inputs?: {[classPropertyName: string]: string|[string, string]};\n \n   /**\n-   * A mapping of outputs from class property names to binding property names, or to a tuple of\n-   * binding property name and class property name if the names are different.\n+   * A mapping of outputs from class property names to binding property names.\n    */\n   outputs?: {[classPropertyName: string]: string};\n "
        },
        {
            "sha": "8f37e2d7f54d5526ecdf9bd4347cd0576452e6c9",
            "filename": "packages/compiler/src/render3/view/util.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Futil.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -98,17 +98,24 @@ function mapToExpression(\n     let declaredName: string;\n     let publicName: string;\n     let minifiedName: string;\n+    let needsDeclaredName: boolean;\n     if (Array.isArray(value)) {\n       [publicName, declaredName] = value;\n+      minifiedName = key;\n+      needsDeclaredName = publicName !== declaredName;\n     } else {\n       [declaredName, publicName] = splitAtColon(key, [key, value]);\n+      minifiedName = declaredName;\n+      // Only include the declared name if extracted from the key, i.e. the key contains a colon.\n+      // Otherwise the declared name should be omitted even if it is different from the public name,\n+      // as it may have already been minified.\n+      needsDeclaredName = publicName !== declaredName && key.includes(':');\n     }\n-    minifiedName = declaredName;\n     return {\n       key: minifiedName,\n       // put quotes around keys that contain potentially unsafe characters\n       quoted: UNSAFE_OBJECT_KEY_NAME_REGEXP.test(minifiedName),\n-      value: (keepDeclared && publicName !== declaredName) ?\n+      value: (keepDeclared && needsDeclaredName) ?\n           o.literalArr([asLiteral(publicName), asLiteral(declaredName)]) :\n           asLiteral(publicName)\n     };"
        },
        {
            "sha": "05b83010f01014fa8c89828f34c84f2ea39bdd2b",
            "filename": "packages/compiler/test/compiler_facade_interface_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -103,10 +103,20 @@ const coreR3ComponentMetadataFacade: core.R3ComponentMetadataFacade =\n const compilerR3ComponentMetadataFacade: compiler.R3ComponentMetadataFacade =\n     null! as core.R3ComponentMetadataFacade;\n \n+const coreR3DeclareDirectiveFacade: core.R3DeclareDirectiveFacade =\n+    null! as compiler.R3DeclareDirectiveFacade;\n+const compilerR3DeclareDirectiveFacade: compiler.R3DeclareDirectiveFacade =\n+    null! as core.R3DeclareDirectiveFacade;\n+\n const coreViewEncapsulation: core.ViewEncapsulation = null! as compiler.ViewEncapsulation;\n const compilerViewEncapsulation: compiler.ViewEncapsulation = null! as core.ViewEncapsulation;\n \n const coreR3QueryMetadataFacade: core.R3QueryMetadataFacade =\n     null! as compiler.R3QueryMetadataFacade;\n const compilerR3QueryMetadataFacade: compiler.R3QueryMetadataFacade =\n     null! as core.R3QueryMetadataFacade;\n+\n+const coreR3DeclareQueryMetadataFacade: core.R3DeclareQueryMetadataFacade =\n+    null! as compiler.R3DeclareQueryMetadataFacade;\n+const compilerR3DeclareQueryMetadataFacade: compiler.R3DeclareQueryMetadataFacade =\n+    null! as core.R3DeclareQueryMetadataFacade;"
        },
        {
            "sha": "92d8d18f26cfa3859a1720769a9fb9ec55fe9d46",
            "filename": "packages/core/src/compiler/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -37,6 +37,9 @@ export interface CompilerFacade {\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3NgModuleMetadataFacade): any;\n   compileDirective(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3DirectiveMetadataFacade): any;\n+  compileDirectiveDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      declaration: R3DeclareDirectiveFacade): any;\n   compileComponent(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3ComponentMetadataFacade): any;\n   compileFactory(\n@@ -162,6 +165,28 @@ export interface R3ComponentMetadataFacade extends R3DirectiveMetadataFacade {\n   changeDetection?: ChangeDetectionStrategy;\n }\n \n+export type OpaqueValue = unknown;\n+\n+export interface R3DeclareDirectiveFacade {\n+  selector?: string;\n+  type: Function;\n+  inputs?: {[classPropertyName: string]: string|[string, string]};\n+  outputs?: {[classPropertyName: string]: string};\n+  host?: {\n+    attributes?: {[key: string]: OpaqueValue};\n+    listeners?: {[key: string]: string};\n+    properties?: {[key: string]: string};\n+    classAttribute?: string;\n+    styleAttribute?: string;\n+  };\n+  queries?: R3DeclareQueryMetadataFacade[];\n+  viewQueries?: R3DeclareQueryMetadataFacade[];\n+  providers?: OpaqueValue;\n+  exportAs?: string[];\n+  usesInheritance?: boolean;\n+  usesOnChanges?: boolean;\n+}\n+\n export interface R3UsedDirectiveMetadata {\n   selector: string;\n   inputs: string[];\n@@ -197,6 +222,15 @@ export interface R3QueryMetadataFacade {\n   static: boolean;\n }\n \n+export interface R3DeclareQueryMetadataFacade {\n+  propertyName: string;\n+  first?: boolean;\n+  predicate: OpaqueValue|string[];\n+  descendants?: boolean;\n+  read?: OpaqueValue;\n+  static?: boolean;\n+}\n+\n export interface ParseSourceSpan {\n   start: any;\n   end: any;"
        },
        {
            "sha": "856b98fc49eaf213f8a83cf4248e26a67018719e",
            "filename": "packages/core/src/core_render3_private_export.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -165,8 +165,6 @@ export {\n   ɵɵnamespaceMathML,\n   ɵɵnamespaceSVG,\n   ɵɵnextContext,\n-  ɵɵngDeclareComponent,\n-  ɵɵngDeclareDirective,\n   ɵɵNgOnChangesFeature,\n   ɵɵpipe,\n   ɵɵpipeBind1,\n@@ -274,6 +272,10 @@ export {\n   resetCompiledComponents as ɵresetCompiledComponents,\n   transitiveScopesFor as ɵtransitiveScopesFor,\n } from './render3/jit/module';\n+export {\n+  ɵɵngDeclareComponent,\n+  ɵɵngDeclareDirective,\n+} from './render3/jit/partial';\n export {\n   compilePipe as ɵcompilePipe,\n } from './render3/jit/pipe';"
        },
        {
            "sha": "24d1d9230919307fbcac76b56e0f9eeefc9c76a8",
            "filename": "packages/core/src/render3/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Frender3%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Frender3%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Findex.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -134,10 +134,6 @@ export {\n   AttributeMarker\n } from './interfaces/node';\n export {CssSelectorList, ProjectionSlots} from './interfaces/projection';\n-export {\n-  ɵɵngDeclareComponent,\n-  ɵɵngDeclareDirective,\n-} from './jit/partial';\n export {\n   setClassMetadata,\n } from './metadata';"
        },
        {
            "sha": "7e2d14a9ac208a9298bfedf8f9385713e516622f",
            "filename": "packages/core/src/render3/jit/partial.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -6,13 +6,18 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {getCompilerFacade, R3DeclareDirectiveFacade} from '../../compiler/compiler_facade';\n+import {angularCoreEnv} from './environment';\n+\n /**\n  * Compiles a partial directive declaration object into a full directive definition object.\n  *\n  * @codeGenApi\n  */\n-export function ɵɵngDeclareDirective(decl: unknown): unknown {\n-  throw new Error('Not yet implemented');\n+export function ɵɵngDeclareDirective(decl: R3DeclareDirectiveFacade): unknown {\n+  const compiler = getCompilerFacade();\n+  return compiler.compileDirectiveDeclaration(\n+      angularCoreEnv, `ng:///${decl.type.name}/ɵfac.js`, decl);\n }\n \n /**"
        },
        {
            "sha": "e83e956098dd4e07e4d0a36131cd708c144afca5",
            "filename": "packages/core/test/render3/jit/declare_directive_spec.ts",
            "status": "added",
            "additions": 255,
            "deletions": 0,
            "changes": 255,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_directive_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_directive_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_directive_spec.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -0,0 +1,255 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ElementRef, ɵɵngDeclareDirective} from '@angular/core';\n+import {AttributeMarker, DirectiveDef} from '../../../src/render3';\n+import {functionContaining} from './matcher';\n+\n+describe('directive declaration jit compilation', () => {\n+  it('should compile a minimal directive declaration', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {});\n+  });\n+\n+  it('should compile a selector', () => {\n+    const def =\n+        ɵɵngDeclareDirective({type: TestClass, selector: '[dir], test'}) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      selectors: [['', 'dir', ''], ['test']],\n+    });\n+  });\n+\n+  it('should compile inputs and outputs', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  inputs: {\n+                    minifiedProperty: 'property',\n+                    minifiedClassProperty: ['bindingName', 'classProperty'],\n+                  },\n+                  outputs: {\n+                    minifiedEventName: 'eventBindingName',\n+                  },\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      inputs: {\n+        'property': 'minifiedProperty',\n+        'bindingName': 'minifiedClassProperty',\n+      },\n+      declaredInputs: {\n+        'property': 'property',\n+        'bindingName': 'classProperty',\n+      },\n+      outputs: {\n+        'eventBindingName': 'minifiedEventName',\n+      },\n+    });\n+  });\n+\n+  it('should compile exportAs', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  exportAs: ['a', 'b'],\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      exportAs: ['a', 'b'],\n+    });\n+  });\n+\n+  it('should compile providers', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  providers: [\n+                    {provide: 'token', useValue: 123},\n+                  ],\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      features: [jasmine.any(Function)],\n+      providersResolver: jasmine.any(Function),\n+    });\n+  });\n+\n+  it('should compile content queries', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  queries: [\n+                    {\n+                      propertyName: 'byRef',\n+                      predicate: ['ref'],\n+                    },\n+                    {\n+                      propertyName: 'byToken',\n+                      predicate: String,\n+                      descendants: true,\n+                      static: true,\n+                      first: true,\n+                      read: ElementRef,\n+                    }\n+                  ],\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      contentQueries: functionContaining([\n+        // \"byRef\" should use `contentQuery` with `false` for descendants flag without a read token,\n+        // and bind to the full query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:contentQuery|anonymous)[^(]*\\(dirIndex,_c0,false\\)/,\n+        '(ctx.byRef = _t)',\n+\n+        // \"byToken\" should use `staticContentQuery` with `true` for descendants flag and\n+        // `ElementRef` as read token, and bind to the first result in the query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:staticContentQuery|anonymous)[^(]*\\(dirIndex,[^,]*String[^,]*,true,[^)]*ElementRef[^)]*\\)/,\n+        '(ctx.byToken = _t.first)',\n+      ]),\n+    });\n+  });\n+\n+  it('should compile view queries', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  viewQueries: [\n+                    {\n+                      propertyName: 'byRef',\n+                      predicate: ['ref'],\n+                    },\n+                    {\n+                      propertyName: 'byToken',\n+                      predicate: String,\n+                      descendants: true,\n+                      static: true,\n+                      first: true,\n+                      read: ElementRef,\n+                    }\n+                  ],\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      viewQuery: functionContaining([\n+        // \"byRef\" should use `viewQuery` with `false` for descendants flag without a read token,\n+        // and bind to the full query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:viewQuery|anonymous)[^(]*\\(_c0,false\\)/,\n+        '(ctx.byRef = _t)',\n+\n+        // \"byToken\" should use `staticViewQuery` with `true` for descendants flag and\n+        // `ElementRef` as read token, and bind to the first result in the query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:staticViewQuery|anonymous)[^(]*\\([^,]*String[^,]*,true,[^)]*ElementRef[^)]*\\)/,\n+        '(ctx.byToken = _t.first)',\n+      ]),\n+    });\n+  });\n+\n+  it('should compile host bindings', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  host: {\n+                    attributes: {\n+                      'attr': 'value',\n+                    },\n+                    listeners: {\n+                      'event': 'handleEvent($event)',\n+                    },\n+                    properties: {\n+                      'foo': 'foo.prop',\n+                      'attr.bar': 'bar.prop',\n+                    },\n+                    classAttribute: 'foo bar',\n+                    styleAttribute: 'width: 100px;',\n+                  },\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      hostAttrs: [\n+        'attr', 'value', AttributeMarker.Classes, 'foo', 'bar', AttributeMarker.Styles, 'width',\n+        '100px'\n+      ],\n+      hostBindings: functionContaining([\n+        'return ctx.handleEvent($event)',\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:hostProperty|anonymous)[^(]*\\('foo',ctx\\.foo\\.prop\\)/,\n+        /(?:attribute|anonymous)[^(]*\\('bar',ctx\\.bar\\.prop\\)/,\n+      ]),\n+      hostVars: 2,\n+    });\n+  });\n+\n+  it('should compile directives with inheritance', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  usesInheritance: true,\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      features: [functionContaining(['ɵɵInheritDefinitionFeature'])],\n+    });\n+  });\n+\n+  it('should compile directives with onChanges lifecycle hook', () => {\n+    const def = ɵɵngDeclareDirective({\n+                  type: TestClass,\n+                  usesOnChanges: true,\n+                }) as DirectiveDef<TestClass>;\n+\n+    expectDirectiveDef(def, {\n+      features: [functionContaining(['ɵɵNgOnChangesFeature'])],\n+    });\n+  });\n+});\n+\n+type DirectiveDefExpectations = jasmine.Expected<Pick<\n+    DirectiveDef<unknown>,\n+    'selectors'|'inputs'|'declaredInputs'|'outputs'|'features'|'hostAttrs'|'hostBindings'|\n+    'hostVars'|'contentQueries'|'viewQuery'|'exportAs'|'providersResolver'>>;\n+\n+/**\n+ * Asserts that the provided directive definition is according to the provided expectation.\n+ * Definition fields for which no expectation is present are verified to be initialized to their\n+ * default value.\n+ */\n+function expectDirectiveDef(\n+    actual: DirectiveDef<unknown>, expected: Partial<DirectiveDefExpectations>): void {\n+  const expectation: DirectiveDefExpectations = {\n+    selectors: [],\n+    inputs: {},\n+    declaredInputs: {},\n+    outputs: {},\n+    features: null,\n+    hostAttrs: null,\n+    hostBindings: null,\n+    hostVars: 0,\n+    contentQueries: null,\n+    viewQuery: null,\n+    exportAs: null,\n+    providersResolver: null,\n+    ...expected,\n+  };\n+\n+  expect(actual.type).toBe(TestClass);\n+  expect(actual.selectors).toEqual(expectation.selectors);\n+  expect(actual.inputs).toEqual(expectation.inputs);\n+  expect(actual.declaredInputs).toEqual(expectation.declaredInputs);\n+  expect(actual.outputs).toEqual(expectation.outputs);\n+  expect(actual.features).toEqual(expectation.features);\n+  expect(actual.hostAttrs).toEqual(expectation.hostAttrs);\n+  expect(actual.hostBindings).toEqual(expectation.hostBindings);\n+  expect(actual.hostVars).toEqual(expectation.hostVars);\n+  expect(actual.contentQueries).toEqual(expectation.contentQueries);\n+  expect(actual.viewQuery).toEqual(expectation.viewQuery);\n+  expect(actual.exportAs).toEqual(expectation.exportAs);\n+  expect(actual.providersResolver).toEqual(expectation.providersResolver);\n+}\n+\n+class TestClass {}"
        },
        {
            "sha": "e5e6f169cacd91ed398b99ecc0294e2b7c44c047",
            "filename": "packages/core/test/render3/jit/matcher.ts",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fmatcher.ts",
            "raw_url": "https://github.com/angular/angular/raw/9186f1feea2490efa4cb1c6c95665100142c9aa6/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fmatcher.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fmatcher.ts?ref=9186f1feea2490efa4cb1c6c95665100142c9aa6",
            "patch": "@@ -0,0 +1,56 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Jasmine matcher to verify that a function contains the provided code fragments.\n+ */\n+export function functionContaining(expectedFragments: Array<string|RegExp>):\n+    jasmine.AsymmetricMatcher<Function> {\n+  let _actual: Function|null = null;\n+\n+  const matches = (code: string, fragment: string|RegExp): boolean => {\n+    if (typeof fragment === 'string') {\n+      return code.includes(fragment);\n+    } else {\n+      return fragment.test(code);\n+    }\n+  };\n+\n+  return {\n+    asymmetricMatch(actual: Function): boolean {\n+      _actual = actual;\n+\n+      if (typeof actual !== 'function') {\n+        return false;\n+      }\n+      const code = actual.toString();\n+      for (const fragment of expectedFragments) {\n+        if (!matches(code, fragment)) {\n+          return false;\n+        }\n+      }\n+      return true;\n+    },\n+    jasmineToString(): string {\n+      if (typeof _actual !== 'function') {\n+        return `Expected function to contain code fragments ${\n+            jasmine.pp(expectedFragments)} but got ${jasmine.pp(_actual)}`;\n+      }\n+      const errors: string[] = [];\n+      const code = _actual.toString();\n+      errors.push(\n+          `The actual function with code:\\n${code}\\n\\ndid not contain the following fragments:`);\n+      for (const fragment of expectedFragments) {\n+        if (!matches(code, fragment)) {\n+          errors.push(`- ${fragment}`);\n+        }\n+      }\n+      return errors.join('\\n');\n+    }\n+  };\n+}"
        }
    ],
    "stats": {
        "total": 502,
        "additions": 486,
        "deletions": 16
    }
}