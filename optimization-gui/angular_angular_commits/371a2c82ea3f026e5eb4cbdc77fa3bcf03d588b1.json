{
    "author": "atscott",
    "message": "refactor(language-service): adjust hybrid visitor to not throw away valid results (#40047)\n\nThe visitor has a check in it with the goal of preventing the structural directive\nparent elements from matching when we have already found the candidate we want.\nHowever, this code did not check to ensure that it was looking at the correct\ntype of node for this case and was evaluating this logic in places it shouldn't.\nThis special check can be more easily done by simply not traversing the\ntemplate children if we've already found a candidate on the template\nnode itself.\n\nPR Close #40047",
    "sha": "371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1",
    "files": [
        {
            "sha": "3207cdcd42401b723e27155314f9a21c4094100b",
            "filename": "packages/language-service/ivy/template_target.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 15,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1/packages%2Flanguage-service%2Fivy%2Ftemplate_target.ts",
            "raw_url": "https://github.com/angular/angular/raw/371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1/packages%2Flanguage-service%2Fivy%2Ftemplate_target.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftemplate_target.ts?ref=371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1",
            "patch": "@@ -102,19 +102,6 @@ class TemplateTargetVisitor implements t.Visitor {\n   visit(node: t.Node) {\n     const {start, end} = getSpanIncludingEndTag(node);\n     if (isWithin(this.position, {start, end})) {\n-      const length = end - start;\n-      const last: t.Node|e.AST|undefined = this.path[this.path.length - 1];\n-      if (last) {\n-        const {start, end} = isTemplateNode(last) ? getSpanIncludingEndTag(last) : last.sourceSpan;\n-        const lastLength = end - start;\n-        if (length > lastLength) {\n-          // The current node has a span that is larger than the last node found\n-          // so we do not descend into it. This typically means we have found\n-          // a candidate in one of the root nodes so we do not need to visit\n-          // other root nodes.\n-          return;\n-        }\n-      }\n       this.path.push(node);\n       node.visit(this);\n     }\n@@ -125,7 +112,12 @@ class TemplateTargetVisitor implements t.Visitor {\n     this.visitAll(element.inputs);\n     this.visitAll(element.outputs);\n     this.visitAll(element.references);\n-    this.visitAll(element.children);\n+    const last: t.Node|e.AST|undefined = this.path[this.path.length - 1];\n+    // If we get here and have not found a candidate node on the element itself, proceed with\n+    // looking for a more specific node on the element children.\n+    if (last === element) {\n+      this.visitAll(element.children);\n+    }\n   }\n \n   visitTemplate(template: t.Template) {\n@@ -135,7 +127,12 @@ class TemplateTargetVisitor implements t.Visitor {\n     this.visitAll(template.templateAttrs);\n     this.visitAll(template.references);\n     this.visitAll(template.variables);\n-    this.visitAll(template.children);\n+    const last: t.Node|e.AST|undefined = this.path[this.path.length - 1];\n+    // If we get here and have not found a candidate node on the template itself, proceed with\n+    // looking for a more specific node on the template children.\n+    if (last === template) {\n+      this.visitAll(template.children);\n+    }\n   }\n \n   visitContent(content: t.Content) {"
        },
        {
            "sha": "f54a374edcf6ea279fc037d1c35686e5b9cc0cb0",
            "filename": "packages/language-service/ivy/test/legacy/template_target_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Ftemplate_target_spec.ts?ref=371a2c82ea3f026e5eb4cbdc77fa3bcf03d588b1",
            "patch": "@@ -577,6 +577,18 @@ describe('findNodeAtPosition for microsyntax expression', () => {\n     expect((node as t.BoundAttribute).name).toBe('ngForOf');\n   });\n \n+  it('should locate bound attribute key when cursor is at the start', () => {\n+    const {errors, nodes, position} = parse(`<div *ngFor=\"let item ¦of items\"></div>`);\n+    expect(errors).toBe(null);\n+    // TODO(atscott): Fix this - we throw away the result because we match the variable node, after\n+    // the attribute binding, then throw away the result because we aren't in the variable key\n+    expect(getTargetAtPosition(nodes, position)).toBeNull();\n+    // const {node} = getTargetAtPosition(nodes, position)!;\n+    // expect(isTemplateNode(node!)).toBe(true);\n+    // expect(node).toBeInstanceOf(t.BoundAttribute);\n+    // expect((node as t.BoundAttribute).name).toBe('ngForOf');\n+  });\n+\n   it('should locate bound attribute key for trackBy', () => {\n     const {errors, nodes, position} =\n         parse(`<div *ngFor=\"let item of items; trac¦kBy: trackByFn\"></div>`);"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 24,
        "deletions": 15
    }
}