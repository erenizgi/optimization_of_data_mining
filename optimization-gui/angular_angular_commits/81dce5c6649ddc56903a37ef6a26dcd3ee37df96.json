{
    "author": "danieltre23",
    "message": "fix(compiler-cli): check split two way binding (#42601)\n\nCheck for split two way binding when output is not declared to make error message clearer.\n\nPR Close #42601",
    "sha": "81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
    "files": [
        {
            "sha": "84a4a595161b2391de3ea94cb0a3d8049b6750f3",
            "filename": "goldens/public-api/compiler-cli/error_code.md",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -50,6 +50,7 @@ export enum ErrorCode {\n     PIPE_MISSING_NAME = 2002,\n     SCHEMA_INVALID_ATTRIBUTE = 8002,\n     SCHEMA_INVALID_ELEMENT = 8001,\n+    SPLIT_TWO_WAY_BINDING = 8007,\n     SUGGEST_STRICT_TEMPLATES = 10001,\n     SUGGEST_SUBOPTIMAL_TYPE_INFERENCE = 10002,\n     // (undocumented)"
        },
        {
            "sha": "e6dba314c2a51268ce2515e32e077370aa42ee82",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -166,6 +166,12 @@ export enum ErrorCode {\n    */\n   DUPLICATE_VARIABLE_DECLARATION = 8006,\n \n+  /**\n+   * A template has a two way binding (two bindings created by a single syntactial element)\n+   * in which the input and output are going to different places.\n+   */\n+  SPLIT_TWO_WAY_BINDING = 8007,\n+\n   /**\n    * The template type-checking engine would need to generate an inline type check block for a\n    * component, but the current type-checking environment doesn't support it."
        },
        {
            "sha": "61d2f143aa8336acc4d1c1bc79d2d45f3da3707a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/diagnostics/src/diagnostic.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 21,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fdiagnostic.ts",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fdiagnostic.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fdiagnostic.ts?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -33,21 +33,26 @@ export interface TemplateDiagnostic extends ts.Diagnostic {\n export function makeTemplateDiagnostic(\n     templateId: TemplateId, mapping: TemplateSourceMapping, span: ParseSourceSpan,\n     category: ts.DiagnosticCategory, code: number, messageText: string|ts.DiagnosticMessageChain,\n-    relatedMessage?: {\n+    relatedMessages?: {\n       text: string,\n-      span: ParseSourceSpan,\n-    }): TemplateDiagnostic {\n+      start: number,\n+      end: number,\n+      sourceFile: ts.SourceFile,\n+    }[]): TemplateDiagnostic {\n   if (mapping.type === 'direct') {\n     let relatedInformation: ts.DiagnosticRelatedInformation[]|undefined = undefined;\n-    if (relatedMessage !== undefined) {\n-      relatedInformation = [{\n-        category: ts.DiagnosticCategory.Message,\n-        code: 0,\n-        file: mapping.node.getSourceFile(),\n-        start: relatedMessage.span.start.offset,\n-        length: relatedMessage.span.end.offset - relatedMessage.span.start.offset,\n-        messageText: relatedMessage.text,\n-      }];\n+    if (relatedMessages !== undefined) {\n+      relatedInformation = [];\n+      for (const relatedMessage of relatedMessages) {\n+        relatedInformation.push({\n+          category: ts.DiagnosticCategory.Message,\n+          code: 0,\n+          file: relatedMessage.sourceFile,\n+          start: relatedMessage.start,\n+          length: relatedMessage.end - relatedMessage.start,\n+          messageText: relatedMessage.text,\n+        });\n+      }\n     }\n     // For direct mappings, the error is shown inline as ngtsc was able to pinpoint a string\n     // constant within the `@Component` decorator for the template. This allows us to map the error\n@@ -82,15 +87,17 @@ export function makeTemplateDiagnostic(\n         fileName, mapping.template, ts.ScriptTarget.Latest, false, ts.ScriptKind.JSX);\n \n     let relatedInformation: ts.DiagnosticRelatedInformation[] = [];\n-    if (relatedMessage !== undefined) {\n-      relatedInformation.push({\n-        category: ts.DiagnosticCategory.Message,\n-        code: 0,\n-        file: sf,\n-        start: relatedMessage.span.start.offset,\n-        length: relatedMessage.span.end.offset - relatedMessage.span.start.offset,\n-        messageText: relatedMessage.text,\n-      });\n+    if (relatedMessages !== undefined) {\n+      for (const relatedMessage of relatedMessages) {\n+        relatedInformation.push({\n+          category: ts.DiagnosticCategory.Message,\n+          code: 0,\n+          file: relatedMessage.sourceFile,\n+          start: relatedMessage.start,\n+          length: relatedMessage.end - relatedMessage.start,\n+          messageText: relatedMessage.text,\n+        });\n+      }\n     }\n \n     relatedInformation.push({"
        },
        {
            "sha": "ec841fcd69fb8724d373fe651b8f90a5804bd56d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/oob.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 7,
            "changes": 71,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -6,7 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {BindingPipe, PropertyWrite, TmplAstReference, TmplAstVariable} from '@angular/compiler';\n+import {BindingPipe, PropertyWrite, TmplAstBoundEvent, TmplAstElement, TmplAstReference, TmplAstVariable} from '@angular/compiler';\n+import {BoundAttribute} from '@angular/compiler/src/render3/r3_ast';\n import * as ts from 'typescript';\n \n import {ErrorCode, makeDiagnostic, makeRelatedInformation, ngErrorCode} from '../../diagnostics';\n@@ -74,6 +75,13 @@ export interface OutOfBandDiagnosticRecorder {\n    * type-checking configuration prohibits their usage.\n    */\n   suboptimalTypeInference(templateId: TemplateId, variables: TmplAstVariable[]): void;\n+\n+  /**\n+   * Reports a split two way binding error message.\n+   */\n+  splitTwoWayBinding(\n+      templateId: TemplateId, input: BoundAttribute, output: TmplAstBoundEvent,\n+      inputConsumer: ClassDeclaration, outputConsumer: ClassDeclaration|TmplAstElement): void;\n }\n \n export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecorder {\n@@ -133,10 +141,12 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n     }\n     this._diagnostics.push(makeTemplateDiagnostic(\n         templateId, mapping, sourceSpan, ts.DiagnosticCategory.Error,\n-        ngErrorCode(ErrorCode.WRITE_TO_READ_ONLY_VARIABLE), errorMsg, {\n+        ngErrorCode(ErrorCode.WRITE_TO_READ_ONLY_VARIABLE), errorMsg, [{\n           text: `The variable ${assignment.name} is declared here.`,\n-          span: target.valueSpan || target.sourceSpan,\n-        }));\n+          start: target.valueSpan?.start.offset || target.sourceSpan.start.offset,\n+          end: target.valueSpan?.end.offset || target.sourceSpan.end.offset,\n+          sourceFile: mapping.node.getSourceFile(),\n+        }]));\n   }\n \n   duplicateTemplateVar(\n@@ -152,10 +162,12 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n     // TODO(alxhub): allocate to a tighter span once one is available.\n     this._diagnostics.push(makeTemplateDiagnostic(\n         templateId, mapping, variable.sourceSpan, ts.DiagnosticCategory.Error,\n-        ngErrorCode(ErrorCode.DUPLICATE_VARIABLE_DECLARATION), errorMsg, {\n+        ngErrorCode(ErrorCode.DUPLICATE_VARIABLE_DECLARATION), errorMsg, [{\n           text: `The variable '${firstDecl.name}' was first declared here.`,\n-          span: firstDecl.sourceSpan,\n-        }));\n+          start: firstDecl.sourceSpan.start.offset,\n+          end: firstDecl.sourceSpan.end.offset,\n+          sourceFile: mapping.node.getSourceFile(),\n+        }]));\n   }\n \n   requiresInlineTcb(templateId: TemplateId, node: ClassDeclaration): void {\n@@ -211,6 +223,51 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n         templateId, mapping, diagnosticVar.keySpan, ts.DiagnosticCategory.Suggestion,\n         ngErrorCode(ErrorCode.SUGGEST_SUBOPTIMAL_TYPE_INFERENCE), message));\n   }\n+\n+  splitTwoWayBinding(\n+      templateId: TemplateId, input: BoundAttribute, output: TmplAstBoundEvent,\n+      inputConsumer: ClassDeclaration, outputConsumer: ClassDeclaration|TmplAstElement): void {\n+    const mapping = this.resolver.getSourceMapping(templateId);\n+    const errorMsg = `The property and event halves of the two-way binding '${\n+        input.name}' are not bound to the same target.\n+            Find more at https://angular.io/guide/two-way-binding#how-two-way-binding-works`;\n+\n+    const relatedMessages: {text: string; start: number; end: number;\n+                            sourceFile: ts.SourceFile;}[] = [];\n+\n+    relatedMessages.push({\n+      text: `The property half of the binding is to the '${inputConsumer.name.text}' component.`,\n+      start: inputConsumer.name.getStart(),\n+      end: inputConsumer.name.getEnd(),\n+      sourceFile: inputConsumer.name.getSourceFile(),\n+    });\n+\n+    if (outputConsumer instanceof TmplAstElement) {\n+      let message = `The event half of the binding is to a native event called '${\n+          input.name}' on the <${outputConsumer.name}> DOM element.`;\n+      if (!mapping.node.getSourceFile().isDeclarationFile) {\n+        message += `\\n \\n Are you missing an output declaration called '${output.name}'?`;\n+      }\n+      relatedMessages.push({\n+        text: message,\n+        start: outputConsumer.sourceSpan.start.offset + 1,\n+        end: outputConsumer.sourceSpan.start.offset + outputConsumer.name.length + 1,\n+        sourceFile: mapping.node.getSourceFile(),\n+      });\n+    } else {\n+      relatedMessages.push({\n+        text: `The event half of the binding is to the '${outputConsumer.name.text}' component.`,\n+        start: outputConsumer.name.getStart(),\n+        end: outputConsumer.name.getEnd(),\n+        sourceFile: outputConsumer.name.getSourceFile(),\n+      });\n+    }\n+\n+\n+    this._diagnostics.push(makeTemplateDiagnostic(\n+        templateId, mapping, input.keySpan, ts.DiagnosticCategory.Error,\n+        ngErrorCode(ErrorCode.SPLIT_TWO_WAY_BINDING), errorMsg, relatedMessages));\n+  }\n }\n \n function makeInlineDiagnostic("
        },
        {
            "sha": "566f772734e90af95b0839f628ad9f2f9f9ad136",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -984,6 +984,11 @@ export class TcbDirectiveOutputsOp extends TcbOp {\n       if (output.type !== ParsedEventType.Regular || !outputs.hasBindingPropertyName(output.name)) {\n         continue;\n       }\n+\n+      if (this.tcb.env.config.checkTypeOfOutputEvents && output.name.endsWith('Change')) {\n+        const inputName = output.name.slice(0, -6);\n+        isSplitTwoWayBinding(inputName, output, this.node.inputs, this.tcb);\n+      }\n       // TODO(alxhub): consider supporting multiple fields with the same property name for outputs.\n       const field = outputs.getByBindingPropertyName(output.name)![0].classPropertyName;\n \n@@ -1049,6 +1054,14 @@ class TcbUnclaimedOutputsOp extends TcbOp {\n         continue;\n       }\n \n+      if (this.tcb.env.config.checkTypeOfOutputEvents && output.name.endsWith('Change')) {\n+        const inputName = output.name.slice(0, -6);\n+        if (isSplitTwoWayBinding(inputName, output, this.element.inputs, this.tcb)) {\n+          // Skip this event handler as the error was already handled.\n+          continue;\n+        }\n+      }\n+\n       if (output.type === ParsedEventType.Animation) {\n         // Animation output bindings always have an `$event` parameter of type `AnimationEvent`.\n         const eventType = this.tcb.env.config.checkTypeOfAnimationEvents ?\n@@ -1979,6 +1992,31 @@ function tcbEventHandlerExpression(ast: AST, tcb: Context, scope: Scope): ts.Exp\n   return translator.translate(ast);\n }\n \n+function isSplitTwoWayBinding(\n+    inputName: string, output: TmplAstBoundEvent, inputs: TmplAstBoundAttribute[], tcb: Context) {\n+  const input = inputs.find(input => input.name === inputName);\n+  if (input === undefined || input.sourceSpan !== output.sourceSpan) {\n+    return false;\n+  }\n+  // Input consumer should be a directive because it's claimed\n+  const inputConsumer = tcb.boundTarget.getConsumerOfBinding(input) as TypeCheckableDirectiveMeta;\n+  const outputConsumer = tcb.boundTarget.getConsumerOfBinding(output);\n+  if (outputConsumer === null || inputConsumer.ref === undefined ||\n+      outputConsumer instanceof TmplAstTemplate) {\n+    return false;\n+  }\n+  if (outputConsumer instanceof TmplAstElement) {\n+    tcb.oobRecorder.splitTwoWayBinding(\n+        tcb.id, input, output, inputConsumer.ref.node, outputConsumer);\n+    return true;\n+  } else if (outputConsumer.ref !== inputConsumer.ref) {\n+    tcb.oobRecorder.splitTwoWayBinding(\n+        tcb.id, input, output, inputConsumer.ref.node, outputConsumer.ref.node);\n+    return true;\n+  }\n+  return false;\n+}\n+\n class TcbEventHandlerTranslator extends TcbExpressionTranslator {\n   protected override resolve(ast: AST): ts.Expression|null {\n     // Recognize a property read on the implicit receiver corresponding with the event parameter"
        },
        {
            "sha": "860b0aafad4aa56d339a06349c1c911a43dca3e1",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -694,4 +694,5 @@ export class NoopOobRecorder implements OutOfBandDiagnosticRecorder {\n   requiresInlineTcb(): void {}\n   requiresInlineTypeConstructors(): void {}\n   suboptimalTypeInference(): void {}\n+  splitTwoWayBinding(): void {}\n }"
        },
        {
            "sha": "9543acfcc9eae69a7afb71315009b06a3fab753a",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/angular/angular/blob/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81dce5c6649ddc56903a37ef6a26dcd3ee37df96/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=81dce5c6649ddc56903a37ef6a26dcd3ee37df96",
            "patch": "@@ -338,6 +338,85 @@ export declare class AnimationEvent {\n       expect(diags.length).toBe(0);\n     });\n \n+    it('should check split two way binding', () => {\n+      env.tsconfig({strictTemplates: true});\n+      env.write('test.ts', `\n+        import {Component, Input, NgModule} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<child-cmp [(value)]=\"counterValue\"></child-cmp>',\n+        })\n+\n+        export class TestCmp {\n+          counterValue = 0;\n+        }\n+\n+        @Component({\n+          selector: 'child-cmp',\n+          template: '',\n+        })\n+\n+        export class ChildCmp {\n+          @Input() value = 0;\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp, ChildCmp],\n+        })\n+        export class Module {}\n+      `);\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].code).toBe(ngErrorCode(ErrorCode.SPLIT_TWO_WAY_BINDING));\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('value');\n+      expect(diags[0].relatedInformation!.length).toBe(2);\n+      expect(getSourceCodeForDiagnostic(diags[0].relatedInformation![0])).toBe('ChildCmp');\n+      expect(getSourceCodeForDiagnostic(diags[0].relatedInformation![1])).toBe('child-cmp');\n+    });\n+\n+    it('when input and output go to different directives', () => {\n+      env.tsconfig({strictTemplates: true});\n+      env.write('test.ts', `\n+        import {Component, Input, NgModule, Output, Directive} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<child-cmp [(value)]=\"counterValue\"></child-cmp>',\n+        })\n+        export class TestCmp {\n+          counterValue = 0;\n+        }\n+\n+        @Directive({\n+          selector: 'child-cmp'\n+        })\n+        export class ChildCmpDir {\n+          @Output() valueChange: any;\n+        }\n+\n+        @Component({\n+          selector: 'child-cmp',\n+          template: '',\n+        })\n+        export class ChildCmp {\n+          @Input() value = 0;\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp, ChildCmp, ChildCmpDir],\n+        })\n+        export class Module {}\n+      `);\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].code).toBe(ngErrorCode(ErrorCode.SPLIT_TWO_WAY_BINDING));\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('value');\n+      expect(diags[0].relatedInformation!.length).toBe(2);\n+      expect(getSourceCodeForDiagnostic(diags[0].relatedInformation![0])).toBe('ChildCmp');\n+      expect(getSourceCodeForDiagnostic(diags[0].relatedInformation![1])).toBe('ChildCmpDir');\n+    });\n+\n     describe('strictInputTypes', () => {\n       beforeEach(() => {\n         env.write('test.ts', `"
        }
    ],
    "stats": {
        "total": 245,
        "additions": 217,
        "deletions": 28
    }
}