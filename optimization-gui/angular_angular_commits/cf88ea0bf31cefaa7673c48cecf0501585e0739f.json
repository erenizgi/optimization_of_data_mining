{
    "author": "alxhub",
    "message": "fix(compiler-cli): avoid duplicate diagnostics about unknown pipes (#39517)\n\nTCB generation occasionally transforms binding expressions twice, which can\nresult in a `BindingPipe` operation being `resolve()`'d multiple times. When\nthe pipe does not exist, this caused multiple OOB diagnostics to be recorded\nabout the missing pipe.\n\nThis commit fixes the problem by making the OOB recorder track which pipe\nexpressions have had diagnostics produced already, and only producing them\nonce per expression.\n\nPR Close #39517",
    "sha": "cf88ea0bf31cefaa7673c48cecf0501585e0739f",
    "files": [
        {
            "sha": "75170a918a7567f290f438e94adfdbc8f02c2a3d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/oob.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/cf88ea0bf31cefaa7673c48cecf0501585e0739f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "raw_url": "https://github.com/angular/angular/raw/cf88ea0bf31cefaa7673c48cecf0501585e0739f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts?ref=cf88ea0bf31cefaa7673c48cecf0501585e0739f",
            "patch": "@@ -73,6 +73,12 @@ export interface OutOfBandDiagnosticRecorder {\n export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecorder {\n   private _diagnostics: TemplateDiagnostic[] = [];\n \n+  /**\n+   * Tracks which `BindingPipe` nodes have already been recorded as invalid, so only one diagnostic\n+   * is ever produced per node.\n+   */\n+  private recordedPipes = new Set<BindingPipe>();\n+\n   constructor(private resolver: TemplateSourceResolver) {}\n \n   get diagnostics(): ReadonlyArray<TemplateDiagnostic> {\n@@ -90,6 +96,10 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n   }\n \n   missingPipe(templateId: TemplateId, ast: BindingPipe): void {\n+    if (this.recordedPipes.has(ast)) {\n+      return;\n+    }\n+\n     const mapping = this.resolver.getSourceMapping(templateId);\n     const errorMsg = `No pipe found with name '${ast.name}'.`;\n \n@@ -101,6 +111,7 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n     this._diagnostics.push(makeTemplateDiagnostic(\n         templateId, mapping, sourceSpan, ts.DiagnosticCategory.Error,\n         ngErrorCode(ErrorCode.MISSING_PIPE), errorMsg));\n+    this.recordedPipes.add(ast);\n   }\n \n   illegalAssignmentToTemplateVar("
        },
        {
            "sha": "666203229662e5019229684aadf27c2d649f99a8",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/cf88ea0bf31cefaa7673c48cecf0501585e0739f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cf88ea0bf31cefaa7673c48cecf0501585e0739f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts?ref=cf88ea0bf31cefaa7673c48cecf0501585e0739f",
            "patch": "@@ -210,6 +210,32 @@ runInEachFileSystem(() => {\n       ]);\n     });\n \n+    it('does not repeat diagnostics for missing pipes in directive inputs', () => {\n+      // The directive here is structured so that a type constructor is used, which resuts in each\n+      // input binding being processed twice. This results in the 'uppercase' pipe being resolved\n+      // twice, and since it doesn't exist this operation will fail. The test is here to verify that\n+      // failing to resolve the pipe twice only produces a single diagnostic (no duplicates).\n+      const messages = diagnose(\n+          '<div *dir=\"let x of name | uppercase\"></div>', `\n+            class Dir<T> {\n+              dirOf: T;\n+            }\n+\n+            class TestComponent {\n+              name: string;\n+            }`,\n+          [{\n+            type: 'directive',\n+            name: 'Dir',\n+            selector: '[dir]',\n+            inputs: {'dirOf': 'dirOf'},\n+            isGeneric: true,\n+          }]);\n+\n+      expect(messages.length).toBe(1);\n+      expect(messages[0]).toContain(`No pipe found with name 'uppercase'.`);\n+    });\n+\n     it('does not repeat diagnostics for errors within LHS of safe-navigation operator', () => {\n       const messages = diagnose(`{{ personn?.name }} {{ personn?.getName() }}`, `\n          class TestComponent {"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 37,
        "deletions": 0
    }
}