{
    "author": "devversion",
    "message": "feat(dev-infra): add command for building release output (#38656)\n\nAdds a command for building all release packages. This command\nis primarily used by the release tool for building release output\nin version branches. The release tool cannot build the release packages\nconfigured in `master` as those packages could differ from the\npackages available in a given version branch. Also, the build process\ncould have changed, so we want to have an API for building\nrelease packages that is guaranteed to be consistent across branches.\n\nPR Close #38656",
    "sha": "b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
    "files": [
        {
            "sha": "8b9af3d9139b8d6250897f01fe7475b018e3415e",
            "filename": "dev-infra/release/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2FBUILD.bazel?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -8,6 +8,7 @@ ts_library(\n     module_name = \"@angular/dev-infra-private/release\",\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n+        \"//dev-infra/release/build\",\n         \"//dev-infra/utils\",\n         \"@npm//@types/yargs\",\n         \"@npm//yargs\","
        },
        {
            "sha": "dfd353d3a89a2f89911891f268b94ea0b8303008",
            "filename": "dev-infra/release/build/BUILD.bazel",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2FBUILD.bazel?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -0,0 +1,38 @@\n+load(\"@npm_bazel_typescript//:index.bzl\", \"ts_library\")\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\")\n+\n+ts_library(\n+    name = \"build\",\n+    srcs = glob(\n+        [\n+            \"**/*.ts\",\n+        ],\n+        exclude = [\"*.spec.ts\"],\n+    ),\n+    module_name = \"@angular/dev-infra-private/release/build\",\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/node\",\n+        \"@npm//@types/yargs\",\n+    ],\n+)\n+\n+ts_library(\n+    name = \"test_lib\",\n+    srcs = glob([\n+        \"*.spec.ts\",\n+    ]),\n+    deps = [\n+        \":build\",\n+        \"//dev-infra/release/config\",\n+        \"@npm//@types/jasmine\",\n+        \"@npm//@types/node\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    deps = [\":test_lib\"],\n+)"
        },
        {
            "sha": "5cc090495e3e6075664bd60a2bde45f27895d4a6",
            "filename": "dev-infra/release/build/build-worker.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Fbuild-worker.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Fbuild-worker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fbuild-worker.ts?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -0,0 +1,32 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/*\n+ * This file will be spawned as a separate process when the `ng-dev release build` command is\n+ * invoked. A separate process allows us to hide any superfluous stdout output from arbitrary\n+ * build commands that we cannot control. This is necessary as the `ng-dev release build` command\n+ * supports stdout JSON output that should be parsable and not polluted from other stdout messages.\n+ */\n+\n+import {getReleaseConfig} from '../config/index';\n+\n+// Start the release package building.\n+main();\n+\n+/** Main function for building the release packages. */\n+async function main() {\n+  if (process.send === undefined) {\n+    throw Error('This script needs to be invoked as a NodeJS worker.');\n+  }\n+\n+  const config = getReleaseConfig();\n+  const builtPackages = await config.buildPackages();\n+\n+  // Transfer the built packages back to the parent process.\n+  process.send(builtPackages);\n+}"
        },
        {
            "sha": "ac4df6938c076d32092790854df10a83010812c6",
            "filename": "dev-infra/release/build/build.spec.ts",
            "status": "added",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -0,0 +1,77 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as releaseConfig from '../config/index';\n+import {ReleaseBuildCommandModule} from './cli';\n+import * as index from './index';\n+\n+describe('ng-dev release build', () => {\n+  let npmPackages: string[];\n+  let buildPackages: jasmine.Spy;\n+\n+  beforeEach(() => {\n+    npmPackages = ['@angular/pkg1', '@angular/pkg2'];\n+    buildPackages = jasmine.createSpy('buildPackages').and.resolveTo([\n+      {name: '@angular/pkg1', outputPath: 'dist/pkg1'},\n+      {name: '@angular/pkg2', outputPath: 'dist/pkg2'},\n+    ]);\n+\n+    // We cannot test the worker process, so we fake the worker function and\n+    // directly call the package build function.\n+    spyOn(index, 'buildReleaseOutput').and.callFake(() => buildPackages());\n+    // We need to stub out the `process.exit` function during tests as the CLI\n+    // handler calls those in case of failures.\n+    spyOn(process, 'exit');\n+  });\n+\n+  /** Invokes the build command handler. */\n+  async function invokeBuild({json}: {json?: boolean} = {}) {\n+    spyOn(releaseConfig, 'getReleaseConfig')\n+        .and.returnValue({npmPackages, buildPackages, generateReleaseNotesForHead: async () => {}});\n+    await ReleaseBuildCommandModule.handler({json: !!json, $0: '', _: []});\n+  }\n+\n+  it('should invoke configured build packages function', async () => {\n+    await invokeBuild();\n+    expect(buildPackages).toHaveBeenCalledTimes(1);\n+    expect(process.exit).toHaveBeenCalledTimes(0);\n+  });\n+\n+  it('should print built packages as JSON if `--json` is specified', async () => {\n+    const writeSpy = spyOn(process.stdout, 'write');\n+    await invokeBuild({json: true});\n+\n+    expect(buildPackages).toHaveBeenCalledTimes(1);\n+    expect(writeSpy).toHaveBeenCalledTimes(1);\n+\n+    const jsonText = writeSpy.calls.mostRecent().args[0] as string;\n+    const parsed = JSON.parse(jsonText);\n+\n+    expect(parsed).toEqual([\n+      {name: '@angular/pkg1', outputPath: 'dist/pkg1'},\n+      {name: '@angular/pkg2', outputPath: 'dist/pkg2'}\n+    ]);\n+    expect(process.exit).toHaveBeenCalledTimes(0);\n+  });\n+\n+  it('should error if package has not been built', async () => {\n+    // Set up a NPM package that is not built.\n+    npmPackages.push('@angular/non-existent');\n+\n+    spyOn(console, 'error');\n+    await invokeBuild();\n+\n+    expect(console.error).toHaveBeenCalledTimes(2);\n+    expect(console.error)\n+        .toHaveBeenCalledWith(\n+            jasmine.stringMatching(`Release output missing for the following packages`));\n+    expect(console.error).toHaveBeenCalledWith(jasmine.stringMatching(`- @angular/non-existent`));\n+    expect(process.exit).toHaveBeenCalledTimes(1);\n+    expect(process.exit).toHaveBeenCalledWith(1);\n+  });\n+});"
        },
        {
            "sha": "9898e5f74bf3babfbc6ad1d3cf2b912a140eb2be",
            "filename": "dev-infra/release/build/cli.ts",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fcli.ts?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -0,0 +1,75 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Arguments, Argv, CommandModule} from 'yargs';\n+\n+import {getConfig} from '../../utils/config';\n+import {error, green, info, red, warn, yellow} from '../../utils/console';\n+import {BuiltPackage, getReleaseConfig} from '../config/index';\n+\n+import {buildReleaseOutput} from './index';\n+\n+/** Command line options for building a release. */\n+export interface ReleaseBuildOptions {\n+  json: boolean;\n+}\n+\n+/** Yargs command builder for configuring the `ng-dev release build` command. */\n+function builder(argv: Argv): Argv<ReleaseBuildOptions> {\n+  return argv.option('json', {\n+    type: 'boolean',\n+    description: 'Whether the built packages should be printed to stdout as JSON.',\n+    default: false,\n+  });\n+}\n+\n+/** Yargs command handler for building a release. */\n+async function handler(args: Arguments<ReleaseBuildOptions>) {\n+  const {npmPackages} = getReleaseConfig();\n+  let builtPackages = await buildReleaseOutput();\n+\n+  // If package building failed, print an error and exit with an error code.\n+  if (builtPackages === null) {\n+    error(red(`  ✘   Could not build release output. Please check output above.`));\n+    process.exit(1);\n+  }\n+\n+  // If no packages have been built, we assume that this is never correct\n+  // and exit with an error code.\n+  if (builtPackages.length === 0) {\n+    error(red(`  ✘   No release packages have been built. Please ensure that the`));\n+    error(red(`      build script is configured correctly in \".ng-dev\".`));\n+    process.exit(1);\n+  }\n+\n+  const missingPackages =\n+      npmPackages.filter(pkgName => !builtPackages!.find(b => b.name === pkgName));\n+\n+  // Check for configured release packages which have not been built. We want to\n+  // error and exit if any configured package has not been built.\n+  if (missingPackages.length > 0) {\n+    error(red(`  ✘   Release output missing for the following packages:`));\n+    missingPackages.forEach(pkgName => error(red(`      - ${pkgName}`)));\n+    process.exit(1);\n+  }\n+\n+  if (args.json) {\n+    process.stdout.write(JSON.stringify(builtPackages, null, 2));\n+  } else {\n+    info(green('  ✓   Built release packages.'));\n+    builtPackages.forEach(({name}) => info(green(`      - ${name}`)));\n+  }\n+}\n+\n+/** CLI command module for building release output. */\n+export const ReleaseBuildCommandModule: CommandModule<{}, ReleaseBuildOptions> = {\n+  builder,\n+  handler,\n+  command: 'build',\n+  describe: 'Builds the release output for the current branch.',\n+};"
        },
        {
            "sha": "7a024490a482a01e7ed20c480ab7a1694484c52c",
            "filename": "dev-infra/release/build/index.ts",
            "status": "added",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Findex.ts?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -0,0 +1,36 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {fork} from 'child_process';\n+import {BuiltPackage} from '../config/index';\n+\n+/**\n+ * Builds the release output without polluting the process stdout. Build scripts commonly\n+ * print messages to stderr or stdout. This is fine in most cases, but sometimes other tooling\n+ * reserves stdout for data transfer (e.g. when `ng release build --json` is invoked). To not\n+ * pollute the stdout in such cases, we launch a child process for building the release packages\n+ * and redirect all stdout output to the stderr channel (which can be read in the terminal).\n+ */\n+export async function buildReleaseOutput(): Promise<BuiltPackage[]|null> {\n+  return new Promise(resolve => {\n+    const buildProcess = fork(require.resolve('./build-worker'), [], {\n+      // The stdio option is set to redirect any \"stdout\" output directly to the \"stderr\" file\n+      // descriptor. An additional \"ipc\" file descriptor is created to support communication with\n+      // the build process. https://nodejs.org/api/child_process.html#child_process_options_stdio.\n+      stdio: ['inherit', 2, 2, 'ipc'],\n+    });\n+    let builtPackages: BuiltPackage[]|null = null;\n+\n+    // The child process will pass the `buildPackages()` output through the\n+    // IPC channel. We keep track of it so that we can use it as resolve value.\n+    buildProcess.on('message', buildResponse => builtPackages = buildResponse);\n+\n+    // On child process exit, resolve the promise with the received output.\n+    buildProcess.on('exit', () => resolve(builtPackages));\n+  });\n+}"
        },
        {
            "sha": "ab3da0057320d8dd47d830ab47e7b64bbe4ca91c",
            "filename": "dev-infra/release/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/b9dce19b3d063523e6a7296c1262d8c56d3aaa15/dev-infra%2Frelease%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fcli.ts?ref=b9dce19b3d063523e6a7296c1262d8c56d3aaa15",
            "patch": "@@ -7,13 +7,15 @@\n  */\n import * as yargs from 'yargs';\n \n+import {ReleaseBuildCommandModule} from './build/cli';\n import {buildEnvStamp} from './stamping/env-stamp';\n \n /** Build the parser for the release commands. */\n export function buildReleaseParser(localYargs: yargs.Argv) {\n   return localYargs.help()\n       .strict()\n       .demandCommand()\n+      .command(ReleaseBuildCommandModule)\n       .command(\n           'build-env-stamp', 'Build the environment stamping information', {},\n           () => buildEnvStamp());"
        }
    ],
    "stats": {
        "total": 261,
        "additions": 261,
        "deletions": 0
    }
}