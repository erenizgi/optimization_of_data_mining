{
    "author": "gkalpak",
    "message": "refactor(docs-infra): replace use of deprecated `Compiler` with `createNgModuleRef()` (#44293)\n\nRemove a use of the deprecated `Compiler` class in `ElementsLoader` and\nuse the `createNgModuleRef()` function instead.\n\nPR Close #44293",
    "sha": "f7ea5249deb98d691cac64edc4ae38404ee47a06",
    "files": [
        {
            "sha": "f26603947d0f16d8a072e17e79cdf7a584f97c76",
            "filename": "aio/src/app/custom-elements/elements-loader.spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 83,
            "changes": 95,
            "blob_url": "https://github.com/angular/angular/blob/f7ea5249deb98d691cac64edc4ae38404ee47a06/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7ea5249deb98d691cac64edc4ae38404ee47a06/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.spec.ts?ref=f7ea5249deb98d691cac64edc4ae38404ee47a06",
            "patch": "@@ -1,10 +1,4 @@\n-import {\n-  Compiler,\n-  ComponentFactory,\n-  ComponentFactoryResolver, ComponentRef, Injector, NgModuleFactory,\n-  NgModuleRef,\n-  Type,\n-} from '@angular/core';\n+import { Component, NgModule, Type } from '@angular/core';\n import { TestBed, fakeAsync, flushMicrotasks } from '@angular/core/testing';\n \n import { ElementsLoader } from './elements-loader';\n@@ -18,19 +12,11 @@ interface Deferred {\n \n describe('ElementsLoader', () => {\n   let elementsLoader: ElementsLoader;\n-  let compiler: Compiler;\n \n   beforeEach(() => {\n     const injector = TestBed.configureTestingModule({\n       providers: [\n         ElementsLoader,\n-        {\n-          provide: Compiler,\n-          useValue: {\n-            compileModuleAsync: jasmine.createSpy('compileModuleAsync').and.callFake(\n-                (Mod: typeof FakeCustomElementModule) => new FakeModuleFactory(Mod.modulePath)),\n-          },\n-        },\n         {\n           provide: ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN,\n           useValue: new Map<string, () => Promise<Type<WithCustomElementComponent>>>([\n@@ -43,7 +29,6 @@ describe('ElementsLoader', () => {\n     });\n \n     elementsLoader = injector.inject(ElementsLoader);\n-    compiler = injector.inject(Compiler);\n   });\n \n   describe('loadContainedCustomElements()', () => {\n@@ -235,23 +220,6 @@ describe('ElementsLoader', () => {\n         expect(definedSpy).toHaveBeenCalledTimes(1);\n       })\n     );\n-\n-    it('should be able to load and register an element after compiling its NgModule', fakeAsync(() => {\n-      const compilerSpy = compiler.compileModuleAsync as unknown as jasmine.Spy;\n-\n-      elementsLoader.loadCustomElement('element-c-selector');\n-      flushMicrotasks();\n-\n-      expect(definedSpy).toHaveBeenCalledTimes(1);\n-      expect(definedSpy).toHaveBeenCalledWith('element-c-selector', jasmine.any(Function));\n-\n-      expect(compilerSpy).toHaveBeenCalledBefore(definedSpy);\n-      expect(compilerSpy).toHaveBeenCalledOnceWith(jasmine.any(Function));\n-\n-      const CompiledModuleClass: typeof FakeCustomElementModule = compilerSpy.calls.first().args[0];\n-      expect(FakeCustomElementModule.isPrototypeOf(CompiledModuleClass)).toBeTrue();\n-      expect(CompiledModuleClass.modulePath).toBe('element-c-module');\n-    }));\n   });\n });\n \n@@ -262,61 +230,22 @@ class FakeCustomElementModule implements WithCustomElementComponent {\n   customElementComponent: Type<any>;\n }\n \n-class FakeComponentFactory extends ComponentFactory<any> {\n-  selector: string;\n-  componentType: Type<any>;\n-  ngContentSelectors: string[];\n-  inputs = [{propName: this.identifyingInput, templateName: this.identifyingInput}];\n-  outputs = [];\n+function createFakeComponent(inputName: string): Type<any> {\n+  // eslint-disable-next-line @angular-eslint/no-inputs-metadata-property\n+  @Component({inputs: [inputName]})\n+  class FakeComponent {}\n \n-  constructor(private identifyingInput: string) { super(); }\n-\n-  create(_injector: Injector,\n-         _projectableNodes?: any[][],\n-         _rootSelectorOrNode?: string | any,\n-         _ngModule?: NgModuleRef<any>): ComponentRef<any> {\n-    return jasmine.createSpy('ComponentRef') as any;\n-  }\n-}\n-\n-class FakeComponentFactoryResolver extends ComponentFactoryResolver {\n-  constructor(private modulePath: string) { super(); }\n-\n-  resolveComponentFactory(_component: Type<any>): ComponentFactory<any> {\n-    return new FakeComponentFactory(this.modulePath);\n-  }\n-}\n-\n-class FakeModuleRef extends NgModuleRef<WithCustomElementComponent> {\n-  injector = jasmine.createSpyObj('injector', ['get']);\n-  componentFactoryResolver = new FakeComponentFactoryResolver(this.modulePath);\n-  instance: WithCustomElementComponent = new FakeCustomElementModule();\n-\n-  constructor(private modulePath: string) {\n-    super();\n-\n-    this.injector.get.and.returnValue(this.componentFactoryResolver);\n-  }\n-\n-  destroy() {}\n-  onDestroy(_callback: () => void) {}\n-}\n-\n-class FakeModuleFactory extends NgModuleFactory<any> {\n-  moduleType: Type<any>;\n-  moduleRefToCreate = new FakeModuleRef(this.modulePath);\n-\n-  constructor(private modulePath: string) { super(); }\n-\n-  create(_parentInjector: Injector | null): NgModuleRef<any> {\n-    return this.moduleRefToCreate;\n-  }\n+  return FakeComponent;\n }\n \n function createFakeCustomElementModule(modulePath: string): typeof FakeCustomElementModule {\n-  return class extends FakeCustomElementModule {\n+  @NgModule({})\n+  class FakeModule extends FakeCustomElementModule {\n     static override readonly modulePath = modulePath;\n-  };\n+    override customElementComponent = createFakeComponent(modulePath);\n+  }\n+\n+  return FakeModule;\n }\n \n function returnPromisesFromSpy(spy: jasmine.Spy): Deferred[] {"
        },
        {
            "sha": "1ac185a3bb1ab1650e29e498beecaf49fef933ef",
            "filename": "aio/src/app/custom-elements/elements-loader.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/f7ea5249deb98d691cac64edc4ae38404ee47a06/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7ea5249deb98d691cac64edc4ae38404ee47a06/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Felements-loader.ts?ref=f7ea5249deb98d691cac64edc4ae38404ee47a06",
            "patch": "@@ -1,4 +1,4 @@\n-import { Compiler, Inject, Injectable, NgModuleRef, Type } from '@angular/core';\n+import { createNgModuleRef, Inject, Injectable, NgModuleRef, Type } from '@angular/core';\n import { ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN, WithCustomElementComponent } from './element-registry';\n import { from, Observable, of } from 'rxjs';\n import { createCustomElement } from '@angular/elements';\n@@ -13,8 +13,7 @@ export class ElementsLoader {\n   private elementsLoading = new Map<string, Promise<void>>();\n \n   constructor(private moduleRef: NgModuleRef<any>,\n-              @Inject(ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN) elementModulePaths: Map<string, LoadChildrenCallback>,\n-              private compiler: Compiler) {\n+              @Inject(ELEMENT_MODULE_LOAD_CALLBACKS_TOKEN) elementModulePaths: Map<string, LoadChildrenCallback>) {\n     this.elementsToLoad = new Map(elementModulePaths);\n   }\n \n@@ -46,9 +45,8 @@ export class ElementsLoader {\n       const modulePathLoader = this.elementsToLoad.get(selector) as LoadChildrenCallback;\n       const loadedAndRegistered =\n         (modulePathLoader() as Promise<Type<WithCustomElementComponent>>)\n-          .then(elementModule => this.compiler.compileModuleAsync(elementModule))\n-          .then(elementModuleFactory => {\n-            const elementModuleRef = elementModuleFactory.create(this.moduleRef.injector);\n+          .then(elementModule => {\n+            const elementModuleRef = createNgModuleRef(elementModule, this.moduleRef.injector);\n             const injector = elementModuleRef.injector;\n             const CustomElementComponent = elementModuleRef.instance.customElementComponent;\n             const CustomElement = createCustomElement(CustomElementComponent, {injector});"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 16,
        "deletions": 89
    }
}