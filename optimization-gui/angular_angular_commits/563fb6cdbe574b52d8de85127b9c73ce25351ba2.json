{
    "author": "atscott",
    "message": "feat(language-service): Implement go to definition for style and template urls (#39202)\n\nThis commit enables the Ivy Language Service to 'go to definition' of a\ntemplateUrl or styleUrl, which would jump to the template/style file\nitself.\n\nPR Close #39202",
    "sha": "563fb6cdbe574b52d8de85127b9c73ce25351ba2",
    "files": [
        {
            "sha": "afe8f39b56e876792dc91e9b4aee1223d02d728e",
            "filename": "packages/language-service/common/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fcommon%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fcommon%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fcommon%2FBUILD.bazel?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -6,7 +6,6 @@ ts_library(\n     name = \"common\",\n     srcs = glob([\"*.ts\"]),\n     deps = [\n-        \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "7e38cd8f8f184b6d2f321c7a8b3658574d3bfe46",
            "filename": "packages/language-service/common/definitions.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 13,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fcommon%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fcommon%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fcommon%2Fdefinitions.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -6,24 +6,35 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as path from 'path';\n import * as ts from 'typescript';\n \n import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n \n+export interface ResourceResolver {\n+  /**\n+   * Resolve the url of a resource relative to the file that contains the reference to it.\n+   *\n+   * @param file The, possibly relative, url of the resource.\n+   * @param basePath The path to the file that contains the URL of the resource.\n+   * @returns A resolved url of resource.\n+   * @throws An error if the resource cannot be resolved.\n+   */\n+  resolve(file: string, basePath: string): string;\n+}\n+\n /**\n  * Gets an Angular-specific definition in a TypeScript source file.\n  */\n export function getTsDefinitionAndBoundSpan(\n     sf: ts.SourceFile, position: number,\n-    tsLsHost: Pick<ts.LanguageServiceHost, 'fileExists'>): ts.DefinitionInfoAndBoundSpan|undefined {\n+    resourceResolver: ResourceResolver): ts.DefinitionInfoAndBoundSpan|undefined {\n   const node = findTightestNode(sf, position);\n   if (!node) return;\n   switch (node.kind) {\n     case ts.SyntaxKind.StringLiteral:\n     case ts.SyntaxKind.NoSubstitutionTemplateLiteral:\n       // Attempt to extract definition of a URL in a property assignment.\n-      return getUrlFromProperty(node as ts.StringLiteralLike, tsLsHost);\n+      return getUrlFromProperty(node as ts.StringLiteralLike, resourceResolver);\n     default:\n       return undefined;\n   }\n@@ -34,9 +45,8 @@ export function getTsDefinitionAndBoundSpan(\n  * directive decorator.\n  * Currently applies to `templateUrl` and `styleUrls` properties.\n  */\n-function getUrlFromProperty(\n-    urlNode: ts.StringLiteralLike,\n-    tsLsHost: Pick<ts.LanguageServiceHost, 'fileExists'>): ts.DefinitionInfoAndBoundSpan|undefined {\n+function getUrlFromProperty(urlNode: ts.StringLiteralLike, resourceResolver: ResourceResolver):\n+    ts.DefinitionInfoAndBoundSpan|undefined {\n   // Get the property assignment node corresponding to the `templateUrl` or `styleUrls` assignment.\n   // These assignments are specified differently; `templateUrl` is a string, and `styleUrls` is\n   // an array of strings:\n@@ -65,20 +75,23 @@ function getUrlFromProperty(\n   }\n \n   const sf = urlNode.getSourceFile();\n-  // Extract url path specified by the url node, which is relative to the TypeScript source file\n-  // the url node is defined in.\n-  const url = path.join(path.dirname(sf.fileName), urlNode.text);\n-\n-  // If the file does not exist, bail. It is possible that the TypeScript language service host\n-  // does not have a `fileExists` method, in which case optimistically assume the file exists.\n-  if (tsLsHost.fileExists && !tsLsHost.fileExists(url)) return;\n+  let url: string;\n+  try {\n+    url = resourceResolver.resolve(urlNode.text, sf.fileName);\n+  } catch {\n+    // If the file does not exist, bail.\n+    return;\n+  }\n \n   const templateDefinitions: ts.DefinitionInfo[] = [{\n     kind: ts.ScriptElementKind.externalModuleName,\n     name: url,\n     containerKind: ts.ScriptElementKind.unknown,\n     containerName: '',\n     // Reading the template is expensive, so don't provide a preview.\n+    // TODO(ayazhafiz): Consider providing an actual span:\n+    //  1. We're likely to read the template anyway\n+    //  2. We could show just the first 100 chars or so\n     textSpan: {start: 0, length: 0},\n     fileName: url,\n   }];"
        },
        {
            "sha": "3ff50242e0afc767c42bf67529ead3810ae2a5a1",
            "filename": "packages/language-service/common/ts_utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fcommon%2Fts_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fcommon%2Fts_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fcommon%2Fts_utils.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -83,5 +83,5 @@ export function getClassDeclOfInlineTemplateNode(templateStringNode: ts.Node): t\n   if (!tmplAsgn) {\n     return;\n   }\n-  return getClassDeclFromDecoratorProp(tmplAsgn)\n+  return getClassDeclFromDecoratorProp(tmplAsgn);\n }"
        },
        {
            "sha": "c8df602d71c99e2b8fa568a7658c1af213d5607e",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -13,6 +13,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n+        \"//packages/compiler-cli/src/ngtsc/resource\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\","
        },
        {
            "sha": "8397044e7a30aa6bcf134b771608fd3c5cc90e16",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -12,7 +12,8 @@ import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/i\n import {TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {isExternalTemplate, LanguageServiceAdapter} from './language_service_adapter';\n+import {LanguageServiceAdapter} from './language_service_adapter';\n+import {isExternalTemplate} from './utils';\n \n export class CompilerFactory {\n   private readonly incrementalStrategy = new TrackedIncrementalBuildStrategy();"
        },
        {
            "sha": "48fb9d9715f99f3c3d74fa1463e820cb1caf2b69",
            "filename": "packages/language-service/ivy/definitions.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -11,8 +11,10 @@ import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript';\n \n+import {getTsDefinitionAndBoundSpan, ResourceResolver} from '../common/definitions';\n+\n import {getPathToNodeAtPosition} from './hybrid_visitor';\n-import {flatMap, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, getTextSpanOfNode, isDollarEvent, TemplateInfo, toTextSpan} from './utils';\n+import {flatMap, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, getTextSpanOfNode, isDollarEvent, isTypeScriptFile, TemplateInfo, toTextSpan} from './utils';\n \n interface DefinitionMeta {\n   node: AST|TmplAstNode;\n@@ -25,13 +27,25 @@ interface HasShimLocation {\n }\n \n export class DefinitionBuilder {\n-  constructor(private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler) {}\n+  constructor(\n+      private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,\n+      private readonly resourceResolver: ResourceResolver) {}\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n     const templateInfo = getTemplateInfoAtPosition(fileName, position, this.compiler);\n     if (templateInfo === undefined) {\n-      return;\n+      // We were unable to get a template at the given position. If we are in a TS file, instead\n+      // attempt to get an Angular definition at the location inside a TS file (examples of this\n+      // would be templateUrl or a url in styleUrls).\n+      if (!isTypeScriptFile(fileName)) {\n+        return;\n+      }\n+      const sf = this.compiler.getNextProgram().getSourceFile(fileName);\n+      if (!sf) {\n+        return;\n+      }\n+      return getTsDefinitionAndBoundSpan(sf, position, this.resourceResolver);\n     }\n     const definitionMeta = this.getDefinitionMetaAtPosition(templateInfo, position);\n     // The `$event` of event handlers would point to the $event parameter in the shim file, as in"
        },
        {
            "sha": "b8d7e5fbfec93d3b6ca1702e8e51c898a16d5e43",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -7,16 +7,16 @@\n  */\n \n import {CompilerOptions, createNgCompilerOptions} from '@angular/compiler-cli';\n-import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {CompilerFactory} from './compiler_factory';\n import {DefinitionBuilder} from './definitions';\n-import {isExternalTemplate, isTypeScriptFile, LanguageServiceAdapter} from './language_service_adapter';\n+import {LanguageServiceAdapter} from './language_service_adapter';\n import {QuickInfoBuilder} from './quick_info';\n+import {isTypeScriptFile} from './utils';\n \n export class LanguageService {\n   private options: CompilerOptions;\n@@ -57,17 +57,17 @@ export class LanguageService {\n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n     const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n-    const results =\n-        new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n+    const results = new DefinitionBuilder(this.tsLS, compiler, this.adapter)\n+                        .getDefinitionAndBoundSpan(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n     return results;\n   }\n \n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n     const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n-    const results =\n-        new DefinitionBuilder(this.tsLS, compiler).getTypeDefinitionsAtPosition(fileName, position);\n+    const results = new DefinitionBuilder(this.tsLS, compiler, this.adapter)\n+                        .getTypeDefinitionsAtPosition(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n     return results;\n   }"
        },
        {
            "sha": "7b2cc77395fc3d70718b3f3a92e62b6ec8b4ffba",
            "filename": "packages/language-service/ivy/language_service_adapter.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -8,10 +8,15 @@\n \n import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {AdapterResourceLoader} from '@angular/compiler-cli/src/ngtsc/resource';\n import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-export class LanguageServiceAdapter implements NgCompilerAdapter {\n+import {ResourceResolver} from '../common/definitions';\n+\n+import {isTypeScriptFile} from './utils';\n+\n+export class LanguageServiceAdapter implements NgCompilerAdapter, ResourceResolver {\n   readonly entryPoint = null;\n   readonly constructionDiagnostics: ts.Diagnostic[] = [];\n   readonly ignoreForEmit: Set<ts.SourceFile> = new Set();\n@@ -75,12 +80,9 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n     const latestVersion = this.project.getScriptVersion(fileName);\n     return lastVersion !== latestVersion;\n   }\n-}\n \n-export function isTypeScriptFile(fileName: string): boolean {\n-  return fileName.endsWith('.ts');\n-}\n-\n-export function isExternalTemplate(fileName: string): boolean {\n-  return !isTypeScriptFile(fileName);\n+  resolve(file: string, basePath: string): string {\n+    const loader = new AdapterResourceLoader(this, this.project.getCompilationSettings());\n+    return loader.resolve(file, basePath);\n+  }\n }"
        },
        {
            "sha": "169ed2cc6901be928fe5268cc9e18e2c9f24bb2f",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -448,6 +448,53 @@ describe('definitions', () => {\n     });\n   });\n \n+  describe('external resources', () => {\n+    it('should be able to find a template from a url', () => {\n+      const {position, text} = service.overwrite(APP_COMPONENT, `\n+        import {Component} from '@angular/core';\n+\t      @Component({\n+\t        templateUrl: './tes¦t.ng',\n+\t      })\n+\t      export class MyComponent {}`);\n+      const result = ngLS.getDefinitionAndBoundSpan(APP_COMPONENT, position);\n+\n+      expect(result).toBeDefined();\n+      const {textSpan, definitions} = result!;\n+\n+      expect(text.substring(textSpan.start, textSpan.start + textSpan.length)).toEqual('./test.ng');\n+\n+      expect(definitions).toBeDefined();\n+      expect(definitions!.length).toBe(1);\n+      const [def] = definitions!;\n+      expect(def.fileName).toContain('/app/test.ng');\n+      expect(def.textSpan).toEqual({start: 0, length: 0});\n+    });\n+\n+    it('should be able to find a stylesheet from a url', () => {\n+      const {position, text} = service.overwrite(APP_COMPONENT, `\n+        import {Component} from '@angular/core';\n+\t      @Component({\n+\t        template: 'empty',\n+\t        styleUrls: ['./te¦st.css']\n+\t      })\n+\t      export class MyComponent {}`);\n+      const result = ngLS.getDefinitionAndBoundSpan(APP_COMPONENT, position);\n+\n+\n+      expect(result).toBeDefined();\n+      const {textSpan, definitions} = result!;\n+\n+      expect(text.substring(textSpan.start, textSpan.start + textSpan.length))\n+          .toEqual('./test.css');\n+\n+      expect(definitions).toBeDefined();\n+      expect(definitions!.length).toBe(1);\n+      const [def] = definitions!;\n+      expect(def.fileName).toContain('/app/test.css');\n+      expect(def.textSpan).toEqual({start: 0, length: 0});\n+    });\n+  });\n+\n   function getDefinitionsAndAssertBoundSpan(\n       {templateOverride, expectedSpanText}: {templateOverride: string, expectedSpanText: string}):\n       Array<{textSpan: string, contextSpan: string | undefined, fileName: string}> {"
        },
        {
            "sha": "34a052eacff47fe6f078bf775a57380c489dcde3",
            "filename": "packages/language-service/ivy/test/mock_host.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -8,7 +8,8 @@\n \n import {join} from 'path';\n import * as ts from 'typescript/lib/tsserverlibrary';\n-import {isTypeScriptFile} from '../language_service_adapter';\n+\n+import {isTypeScriptFile} from '../utils';\n \n const logger: ts.server.Logger = {\n   close(): void{},"
        },
        {
            "sha": "6888f2d32da40810e14b25f8cd1582b68f344cb2",
            "filename": "packages/language-service/ivy/utils.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 19,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Futils.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -14,6 +14,7 @@ import * as t from '@angular/compiler/src/render3/r3_ast';         // t for temp\n import * as ts from 'typescript';\n \n import {ALIAS_NAME, SYMBOL_PUNC} from '../common/quick_info';\n+import {findTightestNode, getClassDeclOfInlineTemplateNode} from '../common/ts_utils';\n \n export function getTextSpanOfNode(node: t.Node|e.AST): ts.TextSpan {\n   if (isTemplateNodeWithKeyAndValue(node)) {\n@@ -70,8 +71,8 @@ export interface TemplateInfo {\n  */\n export function getTemplateInfoAtPosition(\n     fileName: string, position: number, compiler: NgCompiler): TemplateInfo|undefined {\n-  if (fileName.endsWith('.ts')) {\n-    return getInlineTemplateInfoAtPosition(fileName, position, compiler);\n+  if (isTypeScriptFile(fileName)) {\n+    return getTemplateInfoFromClassMeta(fileName, position, compiler);\n   } else {\n     return getFirstComponentForTemplateFile(fileName, compiler);\n   }\n@@ -116,28 +117,29 @@ function getFirstComponentForTemplateFile(fileName: string, compiler: NgCompiler\n /**\n  * Retrieves the `ts.ClassDeclaration` at a location along with its template nodes.\n  */\n-function getInlineTemplateInfoAtPosition(\n+function getTemplateInfoFromClassMeta(\n     fileName: string, position: number, compiler: NgCompiler): TemplateInfo|undefined {\n-  const sourceFile = compiler.getNextProgram().getSourceFile(fileName);\n-  if (!sourceFile) {\n-    return undefined;\n+  const classDecl = getClassDeclForInlineTemplateAtPosition(fileName, position, compiler);\n+  if (!classDecl || !classDecl.name) {  // Does not handle anonymous class\n+    return;\n+  }\n+  const template = compiler.getTemplateTypeChecker().getTemplate(classDecl);\n+  if (template === null) {\n+    return;\n   }\n \n-  // We only support top level statements / class declarations\n-  for (const statement of sourceFile.statements) {\n-    if (!ts.isClassDeclaration(statement) || position < statement.pos || position > statement.end) {\n-      continue;\n-    }\n-\n-    const template = compiler.getTemplateTypeChecker().getTemplate(statement);\n-    if (template === null) {\n-      return undefined;\n-    }\n+  return {template, component: classDecl};\n+}\n \n-    return {template, component: statement};\n+function getClassDeclForInlineTemplateAtPosition(\n+    fileName: string, position: number, compiler: NgCompiler): ts.ClassDeclaration|undefined {\n+  const sourceFile = compiler.getNextProgram().getSourceFile(fileName);\n+  if (!sourceFile) {\n+    return undefined;\n   }\n-\n-  return undefined;\n+  const node = findTightestNode(sourceFile, position);\n+  if (!node) return;\n+  return getClassDeclOfInlineTemplateNode(node);\n }\n \n /**\n@@ -291,3 +293,11 @@ export function flatMap<T, R>(items: T[]|readonly T[], f: (item: T) => R[] | rea\n   }\n   return results;\n }\n+\n+export function isTypeScriptFile(fileName: string): boolean {\n+  return fileName.endsWith('.ts');\n+}\n+\n+export function isExternalTemplate(fileName: string): boolean {\n+  return !isTypeScriptFile(fileName);\n+}"
        },
        {
            "sha": "e9eeac68fef3d4bdbad92c8454ed3e4f4ed6c1ae",
            "filename": "packages/language-service/src/language_service.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -6,9 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getTsDefinitionAndBoundSpan} from '@angular/language-service/common/definitions';\n+import * as path from 'path';\n import * as tss from 'typescript/lib/tsserverlibrary';\n \n+import {getTsDefinitionAndBoundSpan, ResourceResolver} from '../common/definitions';\n+\n import {getTemplateCompletions} from './completions';\n import {getDefinitionAndBoundSpan} from './definitions';\n import {getDeclarationDiagnostics, getTemplateDiagnostics, ngDiagnosticToTsDiagnostic} from './diagnostics';\n@@ -76,13 +78,13 @@ class LanguageServiceImpl implements ng.LanguageService {\n     if (templateInfo) {\n       return getDefinitionAndBoundSpan(templateInfo, position);\n     }\n-\n     // Attempt to get Angular-specific definitions in a TypeScript file, like templates defined\n     // in a `templateUrl` property.\n     if (fileName.endsWith('.ts')) {\n       const sf = this.host.getSourceFile(fileName);\n       if (sf) {\n-        return getTsDefinitionAndBoundSpan(sf, position, this.host.tsLsHost);\n+        return getTsDefinitionAndBoundSpan(\n+            sf, position, new ViewEngineLSResourceResolver(this.host.tsLsHost));\n       }\n     }\n   }\n@@ -113,3 +115,20 @@ class LanguageServiceImpl implements ng.LanguageService {\n     return this.host.tsLS.getReferencesAtPosition(tsDef.fileName, tsDef.textSpan.start);\n   }\n }\n+\n+class ViewEngineLSResourceResolver implements ResourceResolver {\n+  constructor(private host: ts.LanguageServiceHost) {}\n+\n+  resolve(file: string, basePath: string): string {\n+    // Extract url path specified by the url node, which is relative to the TypeScript source file\n+    // the url node is defined in.\n+    const url = path.join(path.dirname(basePath), file);\n+\n+    // If the file does not exist, bail. It is possible that the TypeScript language service host\n+    // does not have a `fileExists` method, in which case optimistically assume the file exists.\n+    if (this.host.fileExists && !this.host.fileExists(url)) {\n+      throw new Error(`ResourceResolver: could not resolve ${url} in context of ${basePath})`);\n+    }\n+    return url;\n+  }\n+}"
        },
        {
            "sha": "a3d512a6c3086f8901be83c52368b6d47a419fac",
            "filename": "packages/language-service/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2FBUILD.bazel?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -59,6 +59,7 @@ ts_library(\n         \"//packages/compiler\",\n         \"//packages/language-service\",\n         \"//packages/language-service:ts_utils\",\n+        \"//packages/language-service/common\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "24001eafff0f893187346ee4af1768478498ddca",
            "filename": "packages/language-service/test/utils_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Ftest%2Futils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/563fb6cdbe574b52d8de85127b9c73ce25351ba2/packages%2Flanguage-service%2Ftest%2Futils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Futils_spec.ts?ref=563fb6cdbe574b52d8de85127b9c73ce25351ba2",
            "patch": "@@ -9,7 +9,8 @@\n import * as ng from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {getClassDeclFromDecoratorProp, getDirectiveClassLike} from '../src/ts_utils';\n+import {getClassDeclFromDecoratorProp} from '../common/ts_utils';\n+import {getDirectiveClassLike} from '../src/ts_utils';\n import {getPathToNodeAtPosition} from '../src/utils';\n import {MockTypescriptHost} from './test_utils';\n "
        }
    ],
    "stats": {
        "total": 223,
        "additions": 166,
        "deletions": 57
    }
}