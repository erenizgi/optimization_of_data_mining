{
    "author": "petebacondarwin",
    "message": "fix(compiler): handle `:host-context` and `:host` in the same selector (#40494)\n\nIn `ViewEncapsulation.Emulated` mode the compiler converts `:host` and\n`:host-context` pseudo classes into new CSS selectors.\n\nPreviously, when there was both `:host-context` and `:host` classes in a\nselector, the compiler was generating incorrect selectors. There are two\nscenarios:\n\n* Both classes are on the same element (i.e. not separated). E.g.\n  `:host-context(.foo):host(.bar)`. This setup should only match the\n  host element if it has both `foo` and `bar` classes. So the generated\n  CSS selector should be: `.foo.bar<hostmarker>`.\n* The `:host` class is on a descendant of the `:host-context`. E.g.\n  `:host-context(.foo) :host(.bar)`. This setup should only match the\n  `.foo` selector if it is a proper ancestor of the host (and not on the\n  host itself). So the generated CSS selector should be:\n  `.foo .bar<hostmarker>`.\n\nThis commit fixes the generation to handle these scenarios.\n\nFixes #14349\n\nPR Close #40494",
    "sha": "679c3bf7ead2b54b6653151c59eb9462fe59d711",
    "files": [
        {
            "sha": "2b8ec4eb5df1d0172def9281f5fee68716d80ac6",
            "filename": "packages/compiler/src/shadow_css.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/679c3bf7ead2b54b6653151c59eb9462fe59d711/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "raw_url": "https://github.com/angular/angular/raw/679c3bf7ead2b54b6653151c59eb9462fe59d711/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fshadow_css.ts?ref=679c3bf7ead2b54b6653151c59eb9462fe59d711",
            "patch": "@@ -314,7 +314,7 @@ export class ShadowCss {\n \n       // The context selectors now must be combined with each other to capture all the possible\n       // selectors that `:host-context` can match.\n-      return combineHostContextSelectors(_polyfillHostNoCombinator, contextSelectors, selectorText);\n+      return combineHostContextSelectors(contextSelectors, selectorText);\n     });\n   }\n \n@@ -682,8 +682,10 @@ function escapeBlocks(\n  * @param contextSelectors an array of context selectors that will be combined.\n  * @param otherSelectors the rest of the selectors that are not context selectors.\n  */\n-function combineHostContextSelectors(\n-    hostMarker: string, contextSelectors: string[], otherSelectors: string): string {\n+function combineHostContextSelectors(contextSelectors: string[], otherSelectors: string): string {\n+  const hostMarker = _polyfillHostNoCombinator;\n+  const otherSelectorsHasHost = _polyfillHostRe.test(otherSelectors);\n+\n   // If there are no context selectors then just output a host marker\n   if (contextSelectors.length === 0) {\n     return hostMarker + otherSelectors;\n@@ -706,6 +708,9 @@ function combineHostContextSelectors(\n   // Finally connect the selector to the `hostMarker`s: either acting directly on the host\n   // (A<hostMarker>) or as an ancestor (A <hostMarker>).\n   return combined\n-      .map(s => `${s}${hostMarker}${otherSelectors}, ${s} ${hostMarker}${otherSelectors}`)\n+      .map(\n+          s => otherSelectorsHasHost ?\n+              `${s}${otherSelectors}` :\n+              `${s}${hostMarker}${otherSelectors}, ${s} ${hostMarker}${otherSelectors}`)\n       .join(',');\n }"
        },
        {
            "sha": "ac0560f82ba5818b1dc9f788e0ecd62f032a0b5f",
            "filename": "packages/compiler/test/shadow_css_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/679c3bf7ead2b54b6653151c59eb9462fe59d711/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/679c3bf7ead2b54b6653151c59eb9462fe59d711/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fshadow_css_spec.ts?ref=679c3bf7ead2b54b6653151c59eb9462fe59d711",
            "patch": "@@ -260,6 +260,21 @@ import {normalizeCSS} from '@angular/platform-browser/testing/src/browser_util';\n       });\n     });\n \n+    describe((':host-context and :host combination selector'), () => {\n+      it('should handle selectors on the same element', () => {\n+        expect(s(':host-context(div):host(.x) > .y {}', 'contenta', 'a-host'))\n+            .toEqual('div.x[a-host] > .y[contenta] {}');\n+      });\n+\n+      it('should handle selectors on different elements', () => {\n+        expect(s(':host-context(div) :host(.x) > .y {}', 'contenta', 'a-host'))\n+            .toEqual('div .x[a-host] > .y[contenta] {}');\n+\n+        expect(s(':host-context(div) > :host(.x) > .y {}', 'contenta', 'a-host'))\n+            .toEqual('div > .x[a-host] > .y[contenta] {}');\n+      });\n+    });\n+\n     it('should support polyfill-next-selector', () => {\n       let css = s('polyfill-next-selector {content: \\'x > y\\'} z {}', 'contenta');\n       expect(css).toEqual('x[contenta] > y[contenta]{}');"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 24,
        "deletions": 4
    }
}