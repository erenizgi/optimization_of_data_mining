{
    "author": "AndrewKushnir",
    "message": "refactor(forms): get rid of duplicate functions (#38371)\n\nThis commit performs minor refactoring in Forms package to get rid of duplicate functions.\nIt looks like the functions were duplicated due to a slightly different type signatures, but\ntheir logic is completely identical. The logic in retained functions remains the same and now\nthese function also accept a generic type to achieve the same level of type safety.\n\nPR Close #38371",
    "sha": "856db56cca87b369cd46d55c0f1b3b7977583e6c",
    "files": [
        {
            "sha": "924b196222dccefa8b57b1938e2ec1c5361a771f",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/856db56cca87b369cd46d55c0f1b3b7977583e6c/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/856db56cca87b369cd46d55c0f1b3b7977583e6c/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=856db56cca87b369cd46d55c0f1b3b7977583e6c",
            "patch": "@@ -1855,11 +1855,6 @@\n     \"packages/forms/src/directives/ng_model.ts\",\n     \"packages/forms/src/directives/ng_model_group.ts\"\n   ],\n-  [\n-    \"packages/forms/src/directives/normalize_validator.ts\",\n-    \"packages/forms/src/model.ts\",\n-    \"packages/forms/src/directives/shared.ts\"\n-  ],\n   [\n     \"packages/forms/src/directives/reactive_directives/form_control_directive.ts\",\n     \"packages/forms/src/directives/shared.ts\","
        },
        {
            "sha": "53a49c913c30b6fa7fa6b560a93c60b41948ad93",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=856db56cca87b369cd46d55c0f1b3b7977583e6c",
            "patch": "@@ -701,9 +701,6 @@\n   {\n     \"name\": \"_keyMap\"\n   },\n-  {\n-    \"name\": \"_mergeErrors\"\n-  },\n   {\n     \"name\": \"_noControlError\"\n   },\n@@ -914,6 +911,9 @@\n   {\n     \"name\": \"executeTemplate\"\n   },\n+  {\n+    \"name\": \"executeValidators\"\n+  },\n   {\n     \"name\": \"executeViewQueryFn\"\n   },\n@@ -1346,6 +1346,9 @@\n   {\n     \"name\": \"mergeAll\"\n   },\n+  {\n+    \"name\": \"mergeErrors\"\n+  },\n   {\n     \"name\": \"mergeHostAttribute\"\n   },\n@@ -1401,10 +1404,7 @@\n     \"name\": \"noop\"\n   },\n   {\n-    \"name\": \"normalizeAsyncValidator\"\n-  },\n-  {\n-    \"name\": \"normalizeValidator\"\n+    \"name\": \"normalizeValidators\"\n   },\n   {\n     \"name\": \"observable\""
        },
        {
            "sha": "3246bdd4f9df4ebd2113e09c059d229605dbbb7e",
            "filename": "packages/forms/src/directives/normalize_validator.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 27,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/354e66efad728b39026fe1664903b55b65fc6786/packages%2Fforms%2Fsrc%2Fdirectives%2Fnormalize_validator.ts",
            "raw_url": "https://github.com/angular/angular/raw/354e66efad728b39026fe1664903b55b65fc6786/packages%2Fforms%2Fsrc%2Fdirectives%2Fnormalize_validator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fnormalize_validator.ts?ref=354e66efad728b39026fe1664903b55b65fc6786",
            "patch": "@@ -1,27 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {AbstractControl} from '../model';\n-import {AsyncValidator, AsyncValidatorFn, Validator, ValidatorFn} from './validators';\n-\n-export function normalizeValidator(validator: ValidatorFn|Validator): ValidatorFn {\n-  if (!!(<Validator>validator).validate) {\n-    return (c: AbstractControl) => (<Validator>validator).validate(c);\n-  } else {\n-    return <ValidatorFn>validator;\n-  }\n-}\n-\n-export function normalizeAsyncValidator(validator: AsyncValidatorFn|\n-                                        AsyncValidator): AsyncValidatorFn {\n-  if (!!(<AsyncValidator>validator).validate) {\n-    return (c: AbstractControl) => (<AsyncValidator>validator).validate(c);\n-  } else {\n-    return <AsyncValidatorFn>validator;\n-  }\n-}"
        },
        {
            "sha": "04c950aa9fb5b170478afd42ec5f0c79f239dd5c",
            "filename": "packages/forms/src/directives/shared.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts?ref=856db56cca87b369cd46d55c0f1b3b7977583e6c",
            "patch": "@@ -9,15 +9,15 @@\n import {isDevMode} from '@angular/core';\n \n import {FormArray, FormControl, FormGroup} from '../model';\n-import {Validators} from '../validators';\n+import {normalizeValidators, Validators} from '../validators';\n+\n import {AbstractControlDirective} from './abstract_control_directive';\n import {AbstractFormGroupDirective} from './abstract_form_group_directive';\n import {CheckboxControlValueAccessor} from './checkbox_value_accessor';\n import {ControlContainer} from './control_container';\n import {ControlValueAccessor} from './control_value_accessor';\n import {DefaultValueAccessor} from './default_value_accessor';\n import {NgControl} from './ng_control';\n-import {normalizeAsyncValidator, normalizeValidator} from './normalize_validator';\n import {NumberValueAccessor} from './number_value_accessor';\n import {RadioControlValueAccessor} from './radio_control_value_accessor';\n import {RangeValueAccessor} from './range_value_accessor';\n@@ -142,13 +142,15 @@ function _throwError(dir: AbstractControlDirective, message: string): void {\n }\n \n export function composeValidators(validators: Array<Validator|ValidatorFn>): ValidatorFn|null {\n-  return validators != null ? Validators.compose(validators.map(normalizeValidator)) : null;\n+  return validators != null ? Validators.compose(normalizeValidators<ValidatorFn>(validators)) :\n+                              null;\n }\n \n export function composeAsyncValidators(validators: Array<AsyncValidator|AsyncValidatorFn>):\n     AsyncValidatorFn|null {\n-  return validators != null ? Validators.composeAsync(validators.map(normalizeAsyncValidator)) :\n-                              null;\n+  return validators != null ?\n+      Validators.composeAsync(normalizeValidators<AsyncValidatorFn>(validators)) :\n+      null;\n }\n \n export function isPropertyUpdated(changes: {[key: string]: any}, viewModel: any): boolean {"
        },
        {
            "sha": "d2fb2bbf8620d4a51abd088c30b8cd60da3c55d5",
            "filename": "packages/forms/src/validators.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 13,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fforms%2Fsrc%2Fvalidators.ts",
            "raw_url": "https://github.com/angular/angular/raw/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fforms%2Fsrc%2Fvalidators.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fvalidators.ts?ref=856db56cca87b369cd46d55c0f1b3b7977583e6c",
            "patch": "@@ -10,7 +10,7 @@ import {InjectionToken, ɵisObservable as isObservable, ɵisPromise as isPromise\n import {forkJoin, from, Observable} from 'rxjs';\n import {map} from 'rxjs/operators';\n \n-import {AsyncValidatorFn, ValidationErrors, Validator, ValidatorFn} from './directives/validators';\n+import {AsyncValidator, AsyncValidatorFn, ValidationErrors, Validator, ValidatorFn} from './directives/validators';\n import {AbstractControl} from './model';\n \n function isEmptyInputValue(value: any): boolean {\n@@ -435,7 +435,7 @@ export class Validators {\n     if (presentValidators.length == 0) return null;\n \n     return function(control: AbstractControl) {\n-      return _mergeErrors(_executeValidators(control, presentValidators));\n+      return mergeErrors(executeValidators<ValidatorFn>(control, presentValidators));\n     };\n   }\n \n@@ -456,8 +456,9 @@ export class Validators {\n     if (presentValidators.length == 0) return null;\n \n     return function(control: AbstractControl) {\n-      const observables = _executeAsyncValidators(control, presentValidators).map(toObservable);\n-      return forkJoin(observables).pipe(map(_mergeErrors));\n+      const observables =\n+          executeValidators<AsyncValidatorFn>(control, presentValidators).map(toObservable);\n+      return forkJoin(observables).pipe(map(mergeErrors));\n     };\n   }\n }\n@@ -474,15 +475,7 @@ export function toObservable(r: any): Observable<any> {\n   return obs;\n }\n \n-function _executeValidators(control: AbstractControl, validators: ValidatorFn[]): any[] {\n-  return validators.map(v => v(control));\n-}\n-\n-function _executeAsyncValidators(control: AbstractControl, validators: AsyncValidatorFn[]): any[] {\n-  return validators.map(v => v(control));\n-}\n-\n-function _mergeErrors(arrayOfErrors: ValidationErrors[]): ValidationErrors|null {\n+function mergeErrors(arrayOfErrors: (ValidationErrors|null)[]): ValidationErrors|null {\n   let res: {[key: string]: any} = {};\n \n   // Not using Array.reduce here due to a Chrome 80 bug\n@@ -493,3 +486,30 @@ function _mergeErrors(arrayOfErrors: ValidationErrors[]): ValidationErrors|null\n \n   return Object.keys(res).length === 0 ? null : res;\n }\n+\n+type GenericValidatorFn = (control: AbstractControl) => any;\n+\n+function executeValidators<V extends GenericValidatorFn>(\n+    control: AbstractControl, validators: V[]): ReturnType<V>[] {\n+  return validators.map(validator => validator(control));\n+}\n+\n+function isValidatorFn<V>(validator: V|Validator|AsyncValidator): validator is V {\n+  return !(validator as Validator).validate;\n+}\n+\n+/**\n+ * Given the list of validators that may contain both functions as well as classes, return the list\n+ * of validator functions (convert validator classes into validator functions). This is needed to\n+ * have consistent structure in validators list before composing them.\n+ *\n+ * @param validators The set of validators that may contain validators both in plain function form\n+ *     as well as represented as a validator class.\n+ */\n+export function normalizeValidators<V>(validators: (V|Validator|AsyncValidator)[]): V[] {\n+  return validators.map(validator => {\n+    return isValidatorFn<V>(validator) ?\n+        validator :\n+        ((c: AbstractControl) => validator.validate(c)) as unknown as V;\n+  });\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "db5d5262d5ba7b0628d6f3d6c647a8271fca6ad1",
            "filename": "packages/forms/test/validators_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fforms%2Ftest%2Fvalidators_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/856db56cca87b369cd46d55c0f1b3b7977583e6c/packages%2Fforms%2Ftest%2Fvalidators_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Fvalidators_spec.ts?ref=856db56cca87b369cd46d55c0f1b3b7977583e6c",
            "patch": "@@ -8,12 +8,12 @@\n \n import {fakeAsync, tick} from '@angular/core/testing';\n import {describe, expect, it} from '@angular/core/testing/src/testing_internal';\n-import {AbstractControl, AsyncValidatorFn, FormArray, FormControl, Validators} from '@angular/forms';\n-import {normalizeAsyncValidator} from '@angular/forms/src/directives/normalize_validator';\n-import {AsyncValidator, ValidationErrors, ValidatorFn} from '@angular/forms/src/directives/validators';\n+import {AbstractControl, AsyncValidator, AsyncValidatorFn, FormArray, FormControl, ValidationErrors, ValidatorFn, Validators} from '@angular/forms';\n import {Observable, of, timer} from 'rxjs';\n import {first, map} from 'rxjs/operators';\n \n+import {normalizeValidators} from '../src/validators';\n+\n (function() {\n function validator(key: string, error: any): ValidatorFn {\n   return (c: AbstractControl) => {\n@@ -413,11 +413,12 @@ describe('Validators', () => {\n          }));\n \n       it('should normalize and evaluate async validator-directives correctly', fakeAsync(() => {\n-           const v = Validators.composeAsync(\n-               [normalizeAsyncValidator(new AsyncValidatorDirective('expected', {'one': true}))])!;\n+           const normalizedValidators = normalizeValidators<AsyncValidatorFn>(\n+               [new AsyncValidatorDirective('expected', {'one': true})]);\n+           const validatorFn = Validators.composeAsync(normalizedValidators)!;\n \n            let errorMap: {[key: string]: any}|null = undefined!;\n-           (v(new FormControl('invalid')) as Observable<ValidationErrors|null>)\n+           (validatorFn(new FormControl('invalid')) as Observable<ValidationErrors|null>)\n                .pipe(first())\n                .subscribe((errors: {[key: string]: any}|null) => errorMap = errors);\n            tick();\n@@ -475,11 +476,12 @@ describe('Validators', () => {\n       });\n \n       it('should normalize and evaluate async validator-directives correctly', () => {\n-        const v = Validators.composeAsync(\n-            [normalizeAsyncValidator(new AsyncValidatorDirective('expected', {'one': true}))])!;\n+        const normalizedValidators = normalizeValidators<AsyncValidatorFn>(\n+            [new AsyncValidatorDirective('expected', {'one': true})]);\n+        const validatorFn = Validators.composeAsync(normalizedValidators)!;\n \n         let errorMap: {[key: string]: any}|null = undefined!;\n-        (v(new FormControl('invalid')) as Observable<ValidationErrors|null>)\n+        (validatorFn(new FormControl('invalid')) as Observable<ValidationErrors|null>)\n             .pipe(first())\n             .subscribe((errors: {[key: string]: any}|null) => errorMap = errors)!;\n "
        }
    ],
    "stats": {
        "total": 124,
        "additions": 58,
        "deletions": 66
    }
}