{
    "author": "uraj",
    "message": "ci: Windows support for tsec_test. (#43924)\n\nContents of generated tsconfig for tsec_test now depend on whether\nBazel uses symlinked runfiles for nodejs_test. The current\nimplementation assumes that symlinked runfiles are not available\non Windows.\n\nPR Close #43924",
    "sha": "7ac2a8cd67c2d7ef3692de31763720d2a956e379",
    "files": [
        {
            "sha": "565c34c7a15165115e91078c0609527b3268cad6",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/7ac2a8cd67c2d7ef3692de31763720d2a956e379/package.json",
            "raw_url": "https://github.com/angular/angular/raw/7ac2a8cd67c2d7ef3692de31763720d2a956e379/package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/package.json?ref=7ac2a8cd67c2d7ef3692de31763720d2a956e379",
            "patch": "@@ -184,7 +184,7 @@\n     \"sauce-connect\": \"https://saucelabs.com/downloads/sc-4.6.2-linux.tar.gz\",\n     \"semver\": \"^7.3.5\",\n     \"ts-node\": \"^10.0.0\",\n-    \"tsec\": \"0.1.10\",\n+    \"tsec\": \"0.1.11\",\n     \"tslint-eslint-rules\": \"5.4.0\",\n     \"tslint-no-toplevel-property-access\": \"0.0.2\",\n     \"typed-graphqlify\": \"^3.1.1\","
        },
        {
            "sha": "7343614f4c1c9202c5e9febad7416ac94e76c80b",
            "filename": "tools/tsec.bzl",
            "status": "modified",
            "additions": 53,
            "deletions": 18,
            "changes": 71,
            "blob_url": "https://github.com/angular/angular/blob/7ac2a8cd67c2d7ef3692de31763720d2a956e379/tools%2Ftsec.bzl",
            "raw_url": "https://github.com/angular/angular/raw/7ac2a8cd67c2d7ef3692de31763720d2a956e379/tools%2Ftsec.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Ftsec.bzl?ref=7ac2a8cd67c2d7ef3692de31763720d2a956e379",
            "patch": "@@ -2,30 +2,34 @@\n \n load(\"@bazel_skylib//lib:new_sets.bzl\", \"sets\")\n load(\"@npm//@bazel/typescript/internal:ts_config.bzl\", \"TsConfigInfo\")\n-load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"DeclarationInfo\")\n+load(\"@build_bazel_rules_nodejs//:providers.bzl\", \"DeclarationInfo\", \"NpmPackageInfo\")\n load(\"@npm//tsec:index.bzl\", _tsec_test = \"tsec_test\")\n \n-TsecTargetInfo = provider(fields = [\"srcs\", \"deps\", \"module_name\", \"paths\"])\n+TsecTargetInfo = provider(fields = [\"srcs\", \"deps\", \"module_name\", \"paths\", \"node_modules_root\"])\n \n def _capture_tsec_attrs_aspect_impl(target, ctx):\n     \"\"\"Capture certain attributes of `ts_library` into a TsecTargetInfo provider.\"\"\"\n     module_name = getattr(target, \"module_name\", None)\n \n     paths = {}\n     deps = []\n+    node_modules_root = None\n     if module_name:\n-        paths[module_name] = [target.label.package]\n+        paths[module_name] = target.label.package\n     for d in ctx.rule.attr.deps:\n         if TsecTargetInfo in d:\n             paths.update(d[TsecTargetInfo].paths)\n         if DeclarationInfo in d:\n             deps.append(d[DeclarationInfo].transitive_declarations)\n+        if node_modules_root == None and NpmPackageInfo in d:\n+            node_modules_root = \"/\".join([\"external\", d[NpmPackageInfo].workspace, \"node_modules\"])\n     return [\n         TsecTargetInfo(\n             srcs = ctx.rule.attr.srcs,\n             deps = depset(transitive = deps),\n             module_name = module_name,\n             paths = paths,\n+            node_modules_root = node_modules_root,\n         ),\n     ]\n \n@@ -34,26 +38,48 @@ _capture_tsec_attrs_aspect = aspect(\n     attr_aspects = [\"deps\"],\n )\n \n-def _generate_tsconfig(target, base_tsconfig):\n-    tsconfig = {}\n-    base_url = \"/\".join([\"..\"] * len(target.label.package.split(\"/\")))\n+def _generate_tsconfig(bin_dir_path, target, base_tsconfig, use_runfiles):\n+    tsconfig = {\"bazel\": True}\n+    pkg_base_dir = \"/\".join([\"..\"] * len(target.label.package.split(\"/\")))\n+\n+    # With runfiles, the location of the source code is the same as the generated .d.ts, i.e., the workspace root.\n+    # Without runfiles, the source code remains in the Bazel package folder in the source tree, so `src_base_dir`\n+    # has to go to the execroot first and further back to the source tree.\n+    src_base_dir = pkg_base_dir if use_runfiles else \"/\".join([\"..\"] * len(bin_dir_path.split(\"/\")) + [pkg_base_dir])\n \n     if base_tsconfig:\n-        tsconfig[\"extends\"] = base_url + \"/\" + base_tsconfig.path\n+        base = src_base_dir if base_tsconfig.is_source else pkg_base_dir\n+        tsconfig[\"extends\"] = base + \"/\" + base_tsconfig.short_path\n \n     compiler_options = {\"noEmit\": True}\n-    compiler_options[\"baseUrl\"] = base_url\n+    compiler_options[\"baseUrl\"] = src_base_dir\n \n     tslib_info = target[TsecTargetInfo]\n-    compiler_options[\"paths\"] = tslib_info.paths\n+    paths = {}\n+    for name, path in tslib_info.paths.items():\n+        paths[name] = [path]\n+        if not use_runfiles:\n+            paths[name].append(bin_dir_path + \"/\" + path)\n+\n+    node_modules_root = tslib_info.node_modules_root\n+    if node_modules_root != None:\n+        type_roots = [node_modules_root, node_modules_root + \"/@types\"]\n+        paths[\"*\"] = [\"%s/*\" % r for r in type_roots]\n+        compiler_options[\"typeRoots\"] = [\"%s/%s/*\" % (src_base_dir, r) for r in type_roots]\n+\n+    compiler_options[\"paths\"] = paths\n+\n+    if not use_runfiles:\n+        compiler_options[\"rootDirs\"] = [src_base_dir, src_base_dir + \"/\" + bin_dir_path]\n \n     tsconfig[\"compilerOptions\"] = compiler_options\n \n     files = sets.make()\n     for s in tslib_info.srcs:\n         if hasattr(s, \"files\"):\n             for f in s.files.to_list():\n-                sets.insert(files, base_url + \"/\" + f.path)\n+                base = src_base_dir if f.is_source else pkg_base_dir\n+                sets.insert(files, base + \"/\" + f.short_path)\n \n     for f in tslib_info.deps.to_list():\n         # Do not include non-TS files\n@@ -70,7 +96,8 @@ def _generate_tsconfig(target, base_tsconfig):\n         if path.endswith(\".ngfactory.d.ts\") or path.endswith(\".ngsummary.d.ts\"):\n             continue\n \n-        sets.insert(files, base_url + \"/\" + path)\n+        base = src_base_dir if f.is_source else pkg_base_dir\n+        sets.insert(files, base + \"/\" + path)\n \n     tsconfig[\"files\"] = sets.to_list(files)\n \n@@ -91,15 +118,18 @@ def _tsec_config_impl(ctx):\n         deps.extend(base[TsConfigInfo].deps)\n         base_tsconfig_src = ctx.attr.base.files.to_list()[0]\n \n+    out = ctx.outputs.out\n     ts_target = ctx.attr.target\n-    generated_tsconfig_content = _generate_tsconfig(ts_target, base_tsconfig_src)\n-\n-    ctx.actions.write(\n-        output = ctx.outputs.out,\n-        content = generated_tsconfig_content,\n+    generated_tsconfig_content = _generate_tsconfig(\n+        ctx.bin_dir.path,\n+        ts_target,\n+        base_tsconfig_src,\n+        ctx.attr.use_runfiles,\n     )\n \n-    deps.append(ctx.outputs.out)\n+    ctx.actions.write(output = out, content = generated_tsconfig_content)\n+\n+    deps.append(out)\n \n     return [DefaultInfo(files = depset(deps))]\n \n@@ -115,6 +145,7 @@ _tsec_config = rule(\n             allow_single_file = [\".json\"],\n             doc = \"\"\"Base tsconfig to extend from.\"\"\",\n         ),\n+        \"use_runfiles\": attr.bool(mandatory = True),\n         \"out\": attr.output(mandatory = True),\n     },\n     doc = \"\"\"Generate the tsconfig.json for a tsec_test. \"\"\",\n@@ -160,6 +191,10 @@ def tsec_test(name, target, tsconfig):\n         tags = [\"tsec\"],\n         target = target,\n         base = tsconfig,\n+        use_runfiles = select({\n+            \"@platforms//os:windows\": False,\n+            \"//conditions:default\": True,\n+        }),\n         out = generated_tsconfig,\n     )\n \n@@ -175,5 +210,5 @@ def tsec_test(name, target, tsconfig):\n         name = name,\n         data = [tsec_tsconfig_name, all_transitive_deps_name, generated_tsconfig],\n         tags = [\"tsec\"],\n-        templated_args = [\"-p\", \"$(rootpath %s)\" % generated_tsconfig],\n+        templated_args = [\"-p\", \"$$(rlocation $(rootpath %s))\" % generated_tsconfig],\n     )"
        },
        {
            "sha": "e683f30a1a8faacc398864c8cd31a76f197f76fa",
            "filename": "yarn.lock",
            "status": "modified",
            "additions": 4,
            "deletions": 10,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/7ac2a8cd67c2d7ef3692de31763720d2a956e379/yarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/7ac2a8cd67c2d7ef3692de31763720d2a956e379/yarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/yarn.lock?ref=7ac2a8cd67c2d7ef3692de31763720d2a956e379",
            "patch": "@@ -1240,11 +1240,6 @@\n   dependencies:\n     \"@bazel/worker\" \"4.4.2\"\n \n-\"@bazel/runfiles@4.0.0\":\n-  version \"4.0.0\"\n-  resolved \"https://registry.yarnpkg.com/@bazel/runfiles/-/runfiles-4.0.0.tgz#3d649d93710364515402b873add73947aaa702e8\"\n-  integrity sha512-1V0E1ooSw7DARfOBkr24O5GOpqODDd7RuJ2Xb+JljjdpUdJTIaVeqELBpSHAiYzqVJYWAn61sD5JP1CPCllixA==\n-\n \"@bazel/runfiles@4.4.2\":\n   version \"4.4.2\"\n   resolved \"https://registry.yarnpkg.com/@bazel/runfiles/-/runfiles-4.4.2.tgz#9d424f0f9ad7505d2ff2f854a450b986e132ac8e\"\n@@ -13908,12 +13903,11 @@ ts-node@^10.0.0, ts-node@^10.2.1:\n     make-error \"^1.1.1\"\n     yn \"3.1.1\"\n \n-tsec@0.1.10:\n-  version \"0.1.10\"\n-  resolved \"https://registry.yarnpkg.com/tsec/-/tsec-0.1.10.tgz#53b43cb5384d542f69cf3273e82308f814b31b2e\"\n-  integrity sha512-VedCZnZxHLcTFueWwU6TYww6WXEKg19y4Td9ypbhUQKOMJ4l7tEo0bBqlIodnu1C7K162jH2bFwK8xJTk1NfYg==\n+tsec@0.1.11:\n+  version \"0.1.11\"\n+  resolved \"https://registry.yarnpkg.com/tsec/-/tsec-0.1.11.tgz#d24d0b36bfd73c83bf39db4211d29a0469457da4\"\n+  integrity sha512-GzUW2kyV8UgmEp0NPkcxsnlXimJj02kchmVde6FnzUfvpAp+l36MKT2swcCd0aS8QWfqaXNckXrFtjZhIGJWkw==\n   dependencies:\n-    \"@bazel/runfiles\" \"4.0.0\"\n     glob \"^7.1.1\"\n     minimatch \"^3.0.3\"\n "
        }
    ],
    "stats": {
        "total": 87,
        "additions": 58,
        "deletions": 29
    }
}