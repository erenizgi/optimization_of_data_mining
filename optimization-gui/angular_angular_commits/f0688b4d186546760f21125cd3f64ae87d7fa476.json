{
    "author": "JoostK",
    "message": "perf(ngcc): introduce cache for sharing data across entry-points (#38840)\n\nngcc creates typically two `ts.Program` instances for each entry-point,\none for processing sources and another one for processing the typings.\nThe creation of these programs is somewhat expensive, as it concerns\nmodule resolution and parsing of source files.\n\nThis commit implements several layers of caching to optimize the\ncreation of programs:\n\n1. A shared module resolution cache across all entry-points within a\n   single invocation of ngcc. Both the sources and typings program\n   benefit from this cache.\n2. Sharing the parsed `ts.SourceFile` for a single entry-point between\n   the sources and typings program.\n3. Sharing parsed `ts.SourceFile`s of TypeScript's default libraries\n   across all entry-points within a single invocation. Some of these\n   default library typings are large and therefore expensive to parse,\n   so sharing the parsed source files across all entry-points offers\n   a significant performance improvement.\n\nUsing a bare CLI app created using `ng new` + `ng add @angular/material`,\nthe above changes offer a 3-4x improvement in ngcc's processing time\nwhen running synchronously and ~2x improvement for asynchronous runs.\n\nPR Close #38840",
    "sha": "f0688b4d186546760f21125cd3f64ae87d7fa476",
    "files": [
        {
            "sha": "6f8d754ed2670d0a31863faac0c423e144b3366c",
            "filename": "packages/compiler-cli/ngcc/src/execution/create_compile_function.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcreate_compile_function.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcreate_compile_function.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcreate_compile_function.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -14,6 +14,7 @@ import {Logger} from '../../../src/ngtsc/logging';\n import {ParsedConfiguration} from '../../../src/perform_compile';\n import {getEntryPointFormat} from '../packages/entry_point';\n import {makeEntryPointBundle} from '../packages/entry_point_bundle';\n+import {createModuleResolutionCache, SharedFileCache} from '../packages/source_file_cache';\n import {PathMappings} from '../path_mappings';\n import {FileWriter} from '../writing/file_writer';\n \n@@ -30,6 +31,8 @@ export function getCreateCompileFn(\n   return (beforeWritingFiles, onTaskCompleted) => {\n     const {Transformer} = require('../packages/transformer');\n     const transformer = new Transformer(fileSystem, logger, tsConfig);\n+    const sharedFileCache = new SharedFileCache(fileSystem);\n+    const moduleResolutionCache = createModuleResolutionCache(fileSystem);\n \n     return (task: Task) => {\n       const {entryPoint, formatProperty, formatPropertiesToMarkAsProcessed, processDts} = task;\n@@ -54,8 +57,8 @@ export function getCreateCompileFn(\n       logger.info(`Compiling ${entryPoint.name} : ${formatProperty} as ${format}`);\n \n       const bundle = makeEntryPointBundle(\n-          fileSystem, entryPoint, formatPath, isCore, format, processDts, pathMappings, true,\n-          enableI18nLegacyMessageIdFormat);\n+          fileSystem, entryPoint, sharedFileCache, moduleResolutionCache, formatPath, isCore,\n+          format, processDts, pathMappings, true, enableI18nLegacyMessageIdFormat);\n \n       const result = transformer.transform(bundle);\n       if (result.success) {"
        },
        {
            "sha": "4acd7f0031de99c5d93fd4e0b75eef4a291ba7c7",
            "filename": "packages/compiler-cli/ngcc/src/packages/entry_point_bundle.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fentry_point_bundle.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fentry_point_bundle.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fentry_point_bundle.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -6,11 +6,12 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as ts from 'typescript';\n-import {AbsoluteFsPath, FileSystem, NgtscCompilerHost} from '../../../src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n import {PathMappings} from '../path_mappings';\n import {BundleProgram, makeBundleProgram} from './bundle_program';\n import {EntryPoint, EntryPointFormat} from './entry_point';\n-import {NgccSourcesCompilerHost} from './ngcc_compiler_host';\n+import {NgccDtsCompilerHost, NgccSourcesCompilerHost} from './ngcc_compiler_host';\n+import {EntryPointFileCache, SharedFileCache} from './source_file_cache';\n \n /**\n  * A bundle of files and paths (and TS programs) that correspond to a particular\n@@ -31,6 +32,8 @@ export interface EntryPointBundle {\n  * Get an object that describes a formatted bundle for an entry-point.\n  * @param fs The current file-system being used.\n  * @param entryPoint The entry-point that contains the bundle.\n+ * @param sharedFileCache The cache to use for source files that are shared across all entry-points.\n+ * @param moduleResolutionCache The module resolution cache to use.\n  * @param formatPath The path to the source files for this bundle.\n  * @param isCore This entry point is the Angular core package.\n  * @param format The underlying format of the bundle.\n@@ -42,16 +45,19 @@ export interface EntryPointBundle {\n  * component templates.\n  */\n export function makeEntryPointBundle(\n-    fs: FileSystem, entryPoint: EntryPoint, formatPath: string, isCore: boolean,\n+    fs: FileSystem, entryPoint: EntryPoint, sharedFileCache: SharedFileCache,\n+    moduleResolutionCache: ts.ModuleResolutionCache, formatPath: string, isCore: boolean,\n     format: EntryPointFormat, transformDts: boolean, pathMappings?: PathMappings,\n     mirrorDtsFromSrc: boolean = false,\n     enableI18nLegacyMessageIdFormat: boolean = true): EntryPointBundle {\n   // Create the TS program and necessary helpers.\n   const rootDir = entryPoint.packagePath;\n   const options: ts\n       .CompilerOptions = {allowJs: true, maxNodeModuleJsDepth: Infinity, rootDir, ...pathMappings};\n-  const srcHost = new NgccSourcesCompilerHost(fs, options, entryPoint.packagePath);\n-  const dtsHost = new NgtscCompilerHost(fs, options);\n+  const entryPointCache = new EntryPointFileCache(fs, sharedFileCache);\n+  const dtsHost = new NgccDtsCompilerHost(fs, options, entryPointCache, moduleResolutionCache);\n+  const srcHost = new NgccSourcesCompilerHost(\n+      fs, options, entryPointCache, moduleResolutionCache, entryPoint.packagePath);\n \n   // Create the bundle programs, as necessary.\n   const absFormatPath = fs.resolve(entryPoint.path, formatPath);"
        },
        {
            "sha": "c679a12503e947de9ebabbd1c38846ffe952ccde",
            "filename": "packages/compiler-cli/ngcc/src/packages/ngcc_compiler_host.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 5,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fngcc_compiler_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fngcc_compiler_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fngcc_compiler_host.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -10,6 +10,7 @@ import * as ts from 'typescript';\n import {AbsoluteFsPath, FileSystem, NgtscCompilerHost} from '../../../src/ngtsc/file_system';\n import {isWithinPackage} from '../analysis/util';\n import {isRelativePath} from '../utils';\n+import {EntryPointFileCache} from './source_file_cache';\n \n /**\n  * Represents a compiler host that resolves a module import as a JavaScript source file if\n@@ -18,19 +19,24 @@ import {isRelativePath} from '../utils';\n  * would otherwise let TypeScript prefer the .d.ts file instead of the JavaScript source file.\n  */\n export class NgccSourcesCompilerHost extends NgtscCompilerHost {\n-  private cache = ts.createModuleResolutionCache(\n-      this.getCurrentDirectory(), file => this.getCanonicalFileName(file));\n-\n-  constructor(fs: FileSystem, options: ts.CompilerOptions, protected packagePath: AbsoluteFsPath) {\n+  constructor(\n+      fs: FileSystem, options: ts.CompilerOptions, private cache: EntryPointFileCache,\n+      private moduleResolutionCache: ts.ModuleResolutionCache,\n+      protected packagePath: AbsoluteFsPath) {\n     super(fs, options);\n   }\n \n+  getSourceFile(fileName: string, languageVersion: ts.ScriptTarget): ts.SourceFile|undefined {\n+    return this.cache.getCachedSourceFile(fileName, languageVersion);\n+  }\n+\n   resolveModuleNames(\n       moduleNames: string[], containingFile: string, reusedNames?: string[],\n       redirectedReference?: ts.ResolvedProjectReference): Array<ts.ResolvedModule|undefined> {\n     return moduleNames.map(moduleName => {\n       const {resolvedModule} = ts.resolveModuleName(\n-          moduleName, containingFile, this.options, this, this.cache, redirectedReference);\n+          moduleName, containingFile, this.options, this, this.moduleResolutionCache,\n+          redirectedReference);\n \n       // If the module request originated from a relative import in a JavaScript source file,\n       // TypeScript may have resolved the module to its .d.ts declaration file if the .js source\n@@ -59,3 +65,31 @@ export class NgccSourcesCompilerHost extends NgtscCompilerHost {\n     });\n   }\n }\n+\n+/**\n+ * A compiler host implementation that is used for the typings program. It leverages the entry-point\n+ * cache for source files and module resolution, as these results can be reused across the sources\n+ * program.\n+ */\n+export class NgccDtsCompilerHost extends NgtscCompilerHost {\n+  constructor(\n+      fs: FileSystem, options: ts.CompilerOptions, private cache: EntryPointFileCache,\n+      private moduleResolutionCache: ts.ModuleResolutionCache) {\n+    super(fs, options);\n+  }\n+\n+  getSourceFile(fileName: string, languageVersion: ts.ScriptTarget): ts.SourceFile|undefined {\n+    return this.cache.getCachedSourceFile(fileName, languageVersion);\n+  }\n+\n+  resolveModuleNames(\n+      moduleNames: string[], containingFile: string, reusedNames?: string[],\n+      redirectedReference?: ts.ResolvedProjectReference): Array<ts.ResolvedModule|undefined> {\n+    return moduleNames.map(moduleName => {\n+      const {resolvedModule} = ts.resolveModuleName(\n+          moduleName, containingFile, this.options, this, this.moduleResolutionCache,\n+          redirectedReference);\n+      return resolvedModule;\n+    });\n+  }\n+}"
        },
        {
            "sha": "d9b0c33637c25bec7d33272cd451527afced8d8e",
            "filename": "packages/compiler-cli/ngcc/src/packages/source_file_cache.ts",
            "status": "added",
            "additions": 197,
            "deletions": 0,
            "changes": 197,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fsource_file_cache.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fsource_file_cache.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fsource_file_cache.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -0,0 +1,197 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import * as ts from 'typescript';\n+import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n+\n+/**\n+ * A cache that holds on to source files that can be shared for processing all entry-points in a\n+ * single invocation of ngcc. In particular, the following files are shared across all entry-points\n+ * through this cache:\n+ *\n+ * 1. Default library files such as `lib.dom.d.ts` and `lib.es5.d.ts`. These files don't change\n+ *    and some are very large, so parsing is expensive. Therefore, the parsed `ts.SourceFile`s for\n+ *    the default library files are cached.\n+ * 2. The typings of @angular scoped packages. The typing files for @angular packages are typically\n+ *    used in the entry-points that ngcc processes, so benefit from a single source file cache.\n+ *    Especially `@angular/core/core.d.ts` is large and expensive to parse repeatedly. In contrast\n+ *    to default library files, we have to account for these files to be invalidated during a single\n+ *    invocation of ngcc, as ngcc will overwrite the .d.ts files during its processing.\n+ *\n+ * The lifecycle of this cache corresponds with a single invocation of ngcc. Separate invocations,\n+ * e.g. the CLI's synchronous module resolution fallback will therefore all have their own cache.\n+ * This allows for the source file cache to be garbage collected once ngcc processing has completed.\n+ */\n+export class SharedFileCache {\n+  private sfCache = new Map<AbsoluteFsPath, ts.SourceFile>();\n+\n+  constructor(private fs: FileSystem) {}\n+\n+  /**\n+   * Loads a `ts.SourceFile` if the provided `fileName` is deemed appropriate to be cached. To\n+   * optimize for memory usage, only files that are generally used in all entry-points are cached.\n+   * If `fileName` is not considered to benefit from caching or the requested file does not exist,\n+   * then `undefined` is returned.\n+   */\n+  getCachedSourceFile(fileName: string): ts.SourceFile|undefined {\n+    const absPath = this.fs.resolve(fileName);\n+    if (isDefaultLibrary(absPath, this.fs)) {\n+      return this.getStableCachedFile(absPath);\n+    } else if (isAngularDts(absPath, this.fs)) {\n+      return this.getVolatileCachedFile(absPath);\n+    } else {\n+      return undefined;\n+    }\n+  }\n+\n+  /**\n+   * Attempts to load the source file from the cache, or parses the file into a `ts.SourceFile` if\n+   * it's not yet cached. This method assumes that the file will not be modified for the duration\n+   * that this cache is valid for. If that assumption does not hold, the `getVolatileCachedFile`\n+   * method is to be used instead.\n+   */\n+  private getStableCachedFile(absPath: AbsoluteFsPath): ts.SourceFile|undefined {\n+    if (!this.sfCache.has(absPath)) {\n+      const content = readFile(absPath, this.fs);\n+      if (content === undefined) {\n+        return undefined;\n+      }\n+      const sf = ts.createSourceFile(absPath, content, ts.ScriptTarget.ES2015);\n+      this.sfCache.set(absPath, sf);\n+    }\n+    return this.sfCache.get(absPath)!;\n+  }\n+\n+  /**\n+   * In contrast to `getStableCachedFile`, this method always verifies that the cached source file\n+   * is the same as what's stored on disk. This is done for files that are expected to change during\n+   * ngcc's processing, such as @angular scoped packages for which the .d.ts files are overwritten\n+   * by ngcc. If the contents on disk have changed compared to a previously cached source file, the\n+   * content from disk is re-parsed and the cache entry is replaced.\n+   */\n+  private getVolatileCachedFile(absPath: AbsoluteFsPath): ts.SourceFile|undefined {\n+    const content = readFile(absPath, this.fs);\n+    if (content === undefined) {\n+      return undefined;\n+    }\n+    if (!this.sfCache.has(absPath) || this.sfCache.get(absPath)!.text !== content) {\n+      const sf = ts.createSourceFile(absPath, content, ts.ScriptTarget.ES2015);\n+      this.sfCache.set(absPath, sf);\n+    }\n+    return this.sfCache.get(absPath)!;\n+  }\n+}\n+\n+const DEFAULT_LIB_PATTERN = ['node_modules', 'typescript', 'lib', /^lib\\..+\\.d\\.ts$/];\n+\n+/**\n+ * Determines whether the provided path corresponds with a default library file inside of the\n+ * typescript package.\n+ *\n+ * @param absPath The path for which to determine if it corresponds with a default library file.\n+ * @param fs The filesystem to use for inspecting the path.\n+ */\n+export function isDefaultLibrary(absPath: AbsoluteFsPath, fs: FileSystem): boolean {\n+  return isFile(absPath, DEFAULT_LIB_PATTERN, fs);\n+}\n+\n+const ANGULAR_DTS_PATTERN = ['node_modules', '@angular', /./, /\\.d\\.ts$/];\n+\n+/**\n+ * Determines whether the provided path corresponds with a .d.ts file inside of an @angular\n+ * scoped package. This logic only accounts for the .d.ts files in the root, which is sufficient\n+ * to find the large, flattened entry-point files that benefit from caching.\n+ *\n+ * @param absPath The path for which to determine if it corresponds with an @angular .d.ts file.\n+ * @param fs The filesystem to use for inspecting the path.\n+ */\n+export function isAngularDts(absPath: AbsoluteFsPath, fs: FileSystem): boolean {\n+  return isFile(absPath, ANGULAR_DTS_PATTERN, fs);\n+}\n+\n+/**\n+ * Helper function to determine whether a file corresponds with a given pattern of segments.\n+ *\n+ * @param path The path for which to determine if it corresponds with the provided segments.\n+ * @param segments Array of segments; the `path` must have ending segments that match the\n+ * patterns in this array.\n+ * @param fs The filesystem to use for inspecting the path.\n+ */\n+function isFile(\n+    path: AbsoluteFsPath, segments: ReadonlyArray<string|RegExp>, fs: FileSystem): boolean {\n+  for (let i = segments.length - 1; i >= 0; i--) {\n+    const pattern = segments[i];\n+    const segment = fs.basename(path);\n+    if (typeof pattern === 'string') {\n+      if (pattern !== segment) {\n+        return false;\n+      }\n+    } else {\n+      if (!pattern.test(segment)) {\n+        return false;\n+      }\n+    }\n+    path = fs.dirname(path);\n+  }\n+  return true;\n+}\n+\n+/**\n+ * A cache for processing a single entry-point. This exists to share `ts.SourceFile`s between the\n+ * source and typing programs that are created for a single program.\n+ */\n+export class EntryPointFileCache {\n+  private readonly sfCache = new Map<AbsoluteFsPath, ts.SourceFile>();\n+\n+  constructor(private fs: FileSystem, private sharedFileCache: SharedFileCache) {}\n+\n+  /**\n+   * Returns and caches a parsed `ts.SourceFile` for the provided `fileName`. If the `fileName` is\n+   * cached in the shared file cache, that result is used. Otherwise, the source file is cached\n+   * internally. This method returns `undefined` if the requested file does not exist.\n+   *\n+   * @param fileName The path of the file to retrieve a source file for.\n+   * @param languageVersion The language version to use for parsing the file.\n+   */\n+  getCachedSourceFile(fileName: string, languageVersion: ts.ScriptTarget): ts.SourceFile|undefined {\n+    const staticSf = this.sharedFileCache.getCachedSourceFile(fileName);\n+    if (staticSf !== undefined) {\n+      return staticSf;\n+    }\n+\n+    const absPath = this.fs.resolve(fileName);\n+    if (this.sfCache.has(absPath)) {\n+      return this.sfCache.get(absPath);\n+    }\n+\n+    const content = readFile(absPath, this.fs);\n+    if (content === undefined) {\n+      return undefined;\n+    }\n+    const sf = ts.createSourceFile(fileName, content, languageVersion);\n+    this.sfCache.set(absPath, sf);\n+    return sf;\n+  }\n+}\n+\n+function readFile(absPath: AbsoluteFsPath, fs: FileSystem): string|undefined {\n+  if (!fs.exists(absPath) || !fs.stat(absPath).isFile()) {\n+    return undefined;\n+  }\n+  return fs.readFile(absPath);\n+}\n+\n+/**\n+ * Creates a `ts.ModuleResolutionCache` that uses the provided filesystem for path operations.\n+ *\n+ * @param fs The filesystem to use for path operations.\n+ */\n+export function createModuleResolutionCache(fs: FileSystem): ts.ModuleResolutionCache {\n+  return ts.createModuleResolutionCache(fs.pwd(), fileName => {\n+    return fs.isCaseSensitive() ? fileName : fileName.toLowerCase();\n+  });\n+}"
        },
        {
            "sha": "382758f3c370b5be54be0d30a8e523cd3376b11a",
            "filename": "packages/compiler-cli/ngcc/test/helpers/utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -14,6 +14,7 @@ import {NgccEntryPointConfig} from '../../src/packages/configuration';\n import {EntryPoint, EntryPointFormat} from '../../src/packages/entry_point';\n import {EntryPointBundle} from '../../src/packages/entry_point_bundle';\n import {NgccSourcesCompilerHost} from '../../src/packages/ngcc_compiler_host';\n+import {createModuleResolutionCache, EntryPointFileCache, SharedFileCache} from '../../src/packages/source_file_cache';\n \n export type TestConfig = Pick<NgccEntryPointConfig, 'generateDeepReexports'>;\n \n@@ -68,7 +69,10 @@ export function makeTestBundleProgram(\n   const rootDir = fs.dirname(entryPointPath);\n   const options: ts.CompilerOptions =\n       {allowJs: true, maxNodeModuleJsDepth: Infinity, checkJs: false, rootDir, rootDirs: [rootDir]};\n-  const host = new NgccSourcesCompilerHost(fs, options, rootDir);\n+  const moduleResolutionCache = createModuleResolutionCache(fs);\n+  const entryPointFileCache = new EntryPointFileCache(fs, new SharedFileCache(fs));\n+  const host =\n+      new NgccSourcesCompilerHost(fs, options, entryPointFileCache, moduleResolutionCache, rootDir);\n   return makeBundleProgram(\n       fs, isCore, rootDir, path, 'r3_symbols.js', options, host, additionalFiles);\n }"
        },
        {
            "sha": "a5878794af169934f3c321007876702143177b89",
            "filename": "packages/compiler-cli/ngcc/test/packages/entry_point_bundle_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 6,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_bundle_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_bundle_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_bundle_spec.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -10,6 +10,7 @@ import {runInEachFileSystem} from '../../../src/ngtsc/file_system/testing';\n import {loadTestFiles} from '../../../test/helpers';\n import {EntryPoint} from '../../src/packages/entry_point';\n import {makeEntryPointBundle} from '../../src/packages/entry_point_bundle';\n+import {createModuleResolutionCache, SharedFileCache} from '../../src/packages/source_file_cache';\n \n runInEachFileSystem(() => {\n   describe('entry point bundle', () => {\n@@ -180,7 +181,10 @@ runInEachFileSystem(() => {\n            ignoreMissingDependencies: false,\n            generateDeepReexports: false,\n          };\n-         const esm5bundle = makeEntryPointBundle(fs, entryPoint, './index.js', false, 'esm5', true);\n+         const moduleResolutionCache = createModuleResolutionCache(fs);\n+         const esm5bundle = makeEntryPointBundle(\n+             fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache, './index.js', false,\n+             'esm5', true);\n \n          expect(esm5bundle.src.program.getSourceFiles().map(sf => sf.fileName))\n              .toEqual(jasmine.arrayWithExactContents([\n@@ -291,8 +295,11 @@ runInEachFileSystem(() => {\n         ignoreMissingDependencies: false,\n         generateDeepReexports: false,\n       };\n+      const moduleResolutionCache = createModuleResolutionCache(fs);\n       const esm5bundle = makeEntryPointBundle(\n-          fs, entryPoint, './index.js', false, 'esm5', /* transformDts */ true,\n+          fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache, './index.js', false,\n+          'esm5',\n+          /* transformDts */ true,\n           /* pathMappings */ undefined, /* mirrorDtsFromSrc */ true);\n \n       expect(esm5bundle.src.program.getSourceFiles().map(sf => _(sf.fileName)))\n@@ -328,8 +335,11 @@ runInEachFileSystem(() => {\n               ignoreMissingDependencies: false,\n               generateDeepReexports: false,\n             };\n+            const moduleResolutionCache = createModuleResolutionCache(fs);\n             const esm5bundle = makeEntryPointBundle(\n-                fs, entryPoint, './index.js', false, 'esm5', /* transformDts */ true,\n+                fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache, './index.js', false,\n+                'esm5',\n+                /* transformDts */ true,\n                 /* pathMappings */ undefined, /* mirrorDtsFromSrc */ true);\n             expect(esm5bundle.src.program.getSourceFiles().map(sf => sf.fileName))\n                 .toContain(absoluteFrom('/node_modules/test/internal.js'));\n@@ -351,8 +361,11 @@ runInEachFileSystem(() => {\n               ignoreMissingDependencies: false,\n               generateDeepReexports: false,\n             };\n+            const moduleResolutionCache = createModuleResolutionCache(fs);\n             const esm5bundle = makeEntryPointBundle(\n-                fs, entryPoint, './esm2015/index.js', false, 'esm2015', /* transformDts */ true,\n+                fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache,\n+                './esm2015/index.js', false, 'esm2015',\n+                /* transformDts */ true,\n                 /* pathMappings */ undefined, /* mirrorDtsFromSrc */ true);\n             expect(esm5bundle.src.program.getSourceFiles().map(sf => sf.fileName))\n                 .toContain(absoluteFrom('/node_modules/internal/esm2015/src/internal.js'));\n@@ -374,8 +387,11 @@ runInEachFileSystem(() => {\n               ignoreMissingDependencies: false,\n               generateDeepReexports: false,\n             };\n+            const moduleResolutionCache = createModuleResolutionCache(fs);\n             const esm5bundle = makeEntryPointBundle(\n-                fs, entryPoint, './index.js', false, 'esm5', /* transformDts */ true,\n+                fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache, './index.js', false,\n+                'esm5',\n+                /* transformDts */ true,\n                 /* pathMappings */ undefined, /* mirrorDtsFromSrc */ false);\n             expect(esm5bundle.src.program.getSourceFiles().map(sf => sf.fileName))\n                 .toContain(absoluteFrom('/node_modules/test/internal.js'));\n@@ -398,8 +414,11 @@ runInEachFileSystem(() => {\n         ignoreMissingDependencies: false,\n         generateDeepReexports: false,\n       };\n+      const moduleResolutionCache = createModuleResolutionCache(fs);\n       const bundle = makeEntryPointBundle(\n-          fs, entryPoint, './index.js', false, 'esm2015', /* transformDts */ true,\n+          fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache, './index.js', false,\n+          'esm2015',\n+          /* transformDts */ true,\n           /* pathMappings */ undefined, /* mirrorDtsFromSrc */ true);\n       expect(bundle.rootDirs).toEqual([absoluteFrom('/node_modules/primary')]);\n     });"
        },
        {
            "sha": "8c3ca880897ab3e1bbb390e03be032ae138d0313",
            "filename": "packages/compiler-cli/ngcc/test/packages/source_file_cache_spec.ts",
            "status": "added",
            "additions": 223,
            "deletions": 0,
            "changes": 223,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fsource_file_cache_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fsource_file_cache_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fsource_file_cache_spec.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -0,0 +1,223 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import * as ts from 'typescript';\n+\n+import {absoluteFrom, FileSystem, getFileSystem} from '../../../src/ngtsc/file_system';\n+import {runInEachFileSystem} from '../../../src/ngtsc/file_system/testing';\n+import {loadTestFiles} from '../../../test/helpers';\n+import {EntryPointFileCache, isAngularDts, isDefaultLibrary, SharedFileCache} from '../../src/packages/source_file_cache';\n+\n+runInEachFileSystem(() => {\n+  describe('caching', () => {\n+    let _: typeof absoluteFrom;\n+    let fs: FileSystem;\n+    beforeEach(() => {\n+      _ = absoluteFrom;\n+      fs = getFileSystem();\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/typescript/lib/lib.es5.d.ts'),\n+          contents: `export declare interface Array {}`,\n+        },\n+        {\n+          name: _('/node_modules/typescript/lib/lib.dom.d.ts'),\n+          contents: `export declare interface Window {}`,\n+        },\n+        {\n+          name: _('/node_modules/@angular/core/core.d.ts'),\n+          contents: `export declare interface Component {}`,\n+        },\n+        {\n+          name: _('/node_modules/@angular/common/common.d.ts'),\n+          contents: `export declare interface NgIf {}`,\n+        },\n+        {\n+          name: _('/index.ts'),\n+          contents: `export const index = true;`,\n+        },\n+        {\n+          name: _('/main.ts'),\n+          contents: `export const main = true;`,\n+        },\n+      ]);\n+    });\n+\n+    describe('SharedFileCache', () => {\n+      it('should cache a parsed source file for default libraries', () => {\n+        const cache = new SharedFileCache(fs);\n+\n+        const libEs5 = cache.getCachedSourceFile('/node_modules/typescript/lib/lib.es5.d.ts')!;\n+        expect(libEs5).not.toBeUndefined();\n+        expect(libEs5.text).toContain('Array');\n+\n+        const libDom = cache.getCachedSourceFile('/node_modules/typescript/lib/lib.dom.d.ts')!;\n+        expect(libDom).not.toBeUndefined();\n+        expect(libDom.text).toContain('Window');\n+\n+        const libEs5_2 = cache.getCachedSourceFile('/node_modules/typescript/lib/lib.es5.d.ts')!;\n+        expect(libEs5_2).toBe(libEs5);\n+\n+        const libDom_2 = cache.getCachedSourceFile('/node_modules/typescript/lib/lib.dom.d.ts')!;\n+        expect(libDom_2).toBe(libDom);\n+      });\n+\n+      it('should cache a parsed source file for @angular scoped packages', () => {\n+        const cache = new SharedFileCache(fs);\n+\n+        const core = cache.getCachedSourceFile('/node_modules/@angular/core/core.d.ts')!;\n+        expect(core).not.toBeUndefined();\n+        expect(core.text).toContain('Component');\n+\n+        const common = cache.getCachedSourceFile('/node_modules/@angular/common/common.d.ts')!;\n+        expect(common).not.toBeUndefined();\n+        expect(common.text).toContain('NgIf');\n+\n+        const core_2 = cache.getCachedSourceFile('/node_modules/@angular/core/core.d.ts')!;\n+        expect(core_2).toBe(core);\n+\n+        const common_2 = cache.getCachedSourceFile('/node_modules/@angular/common/common.d.ts')!;\n+        expect(common_2).toBe(common);\n+      });\n+\n+      it('should reparse @angular d.ts files when they change', () => {\n+        const cache = new SharedFileCache(fs);\n+\n+        const core = cache.getCachedSourceFile('/node_modules/@angular/core/core.d.ts')!;\n+        expect(core).not.toBeUndefined();\n+        expect(core.text).toContain('Component');\n+\n+        const common = cache.getCachedSourceFile('/node_modules/@angular/common/common.d.ts')!;\n+        expect(common).not.toBeUndefined();\n+        expect(common.text).toContain('NgIf');\n+\n+        fs.writeFile(\n+            _('/node_modules/@angular/core/core.d.ts'), `export declare interface Directive {}`);\n+\n+        const core_2 = cache.getCachedSourceFile('/node_modules/@angular/core/core.d.ts')!;\n+        expect(core_2).not.toBe(core);\n+        expect(core_2.text).toContain('Directive');\n+\n+        const core_3 = cache.getCachedSourceFile('/node_modules/@angular/core/core.d.ts')!;\n+        expect(core_3).toBe(core_2);\n+\n+        const common_2 = cache.getCachedSourceFile('/node_modules/@angular/common/common.d.ts')!;\n+        expect(common_2).toBe(common);\n+      });\n+\n+      it('should not cache files that are not default library files inside of the typescript package',\n+         () => {\n+           const cache = new SharedFileCache(fs);\n+\n+           expect(cache.getCachedSourceFile('/node_modules/typescript/lib/typescript.d.ts'))\n+               .toBeUndefined();\n+           expect(cache.getCachedSourceFile('/typescript/lib.es5.d.ts')).toBeUndefined();\n+         });\n+    });\n+\n+    describe('isDefaultLibrary()', () => {\n+      it('should accept lib files inside of the typescript package', () => {\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib/lib.es5.d.ts'), fs)).toBe(true);\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib/lib.dom.d.ts'), fs)).toBe(true);\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib/lib.es2015.core.d.ts'), fs))\n+            .toBe(true);\n+        expect(isDefaultLibrary(_('/root/node_modules/typescript/lib/lib.es5.d.ts'), fs))\n+            .toBe(true);\n+      });\n+      it('should reject non lib files inside of the typescript package', () => {\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib/typescript.d.ts'), fs)).toBe(false);\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib/lib.es5.ts'), fs)).toBe(false);\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib/lib.d.ts'), fs)).toBe(false);\n+        expect(isDefaultLibrary(_('/node_modules/typescript/lib.es5.d.ts'), fs)).toBe(false);\n+      });\n+      it('should reject lib files outside of the typescript package', () => {\n+        expect(isDefaultLibrary(_('/node_modules/ttypescript/lib/lib.es5.d.ts'), fs)).toBe(false);\n+        expect(isDefaultLibrary(_('/node_modules/ttypescript/lib/lib.es5.d.ts'), fs)).toBe(false);\n+        expect(isDefaultLibrary(_('/typescript/lib/lib.es5.d.ts'), fs)).toBe(false);\n+      });\n+    });\n+\n+    describe('isAngularDts()', () => {\n+      it('should accept .d.ts files inside of the @angular scope', () => {\n+        expect(isAngularDts(_('/node_modules/@angular/core/core.d.ts'), fs)).toBe(true);\n+        expect(isAngularDts(_('/node_modules/@angular/common/common.d.ts'), fs)).toBe(true);\n+      });\n+      it('should reject non-.d.ts files inside @angular scoped packages', () => {\n+        expect(isAngularDts(_('/node_modules/@angular/common/src/common.ts'), fs)).toBe(false);\n+      });\n+      it('should reject .d.ts files nested deeply inside @angular scoped packages', () => {\n+        expect(isAngularDts(_('/node_modules/@angular/common/src/common.d.ts'), fs)).toBe(false);\n+      });\n+      it('should reject .d.ts files directly inside the @angular scope', () => {\n+        expect(isAngularDts(_('/node_modules/@angular/common.d.ts'), fs)).toBe(false);\n+      });\n+      it('should reject files that are not inside node_modules', () => {\n+        expect(isAngularDts(_('/@angular/core/core.d.ts'), fs)).toBe(false);\n+      });\n+    });\n+\n+    describe('EntryPointFileCache', () => {\n+      let sharedFileCache: SharedFileCache;\n+      beforeEach(() => {\n+        sharedFileCache = new SharedFileCache(fs);\n+      });\n+\n+      it('should prefer source files cached in SharedFileCache', () => {\n+        const cache1 = new EntryPointFileCache(fs, sharedFileCache);\n+        const libEs5_1 = cache1.getCachedSourceFile(\n+            '/node_modules/typescript/lib/lib.es5.d.ts', ts.ScriptTarget.ESNext)!;\n+        expect(libEs5_1).not.toBeUndefined();\n+        expect(libEs5_1.text).toContain('Array');\n+        expect(libEs5_1.languageVersion).toBe(ts.ScriptTarget.ES2015);\n+\n+        const cache2 = new EntryPointFileCache(fs, sharedFileCache);\n+        const libEs5_2 = cache2.getCachedSourceFile(\n+            '/node_modules/typescript/lib/lib.es5.d.ts', ts.ScriptTarget.ESNext)!;\n+        expect(libEs5_1).toBe(libEs5_2);\n+      });\n+\n+      it('should cache source files that are not default library files', () => {\n+        const cache = new EntryPointFileCache(fs, sharedFileCache);\n+        const index = cache.getCachedSourceFile('/index.ts', ts.ScriptTarget.ESNext)!;\n+        expect(index).not.toBeUndefined();\n+        expect(index.text).toContain('index');\n+        expect(index.languageVersion).toBe(ts.ScriptTarget.ESNext);\n+\n+        const main = cache.getCachedSourceFile('/main.ts', ts.ScriptTarget.ESNext)!;\n+        expect(main).not.toBeUndefined();\n+        expect(main.text).toContain('main');\n+        expect(main.languageVersion).toBe(ts.ScriptTarget.ESNext);\n+\n+        const index_2 = cache.getCachedSourceFile('/index.ts', ts.ScriptTarget.ESNext)!;\n+        expect(index_2).toBe(index);\n+\n+        const main_2 = cache.getCachedSourceFile('/main.ts', ts.ScriptTarget.ESNext)!;\n+        expect(main_2).toBe(main);\n+      });\n+\n+      it('should not share non-library files across multiple cache instances', () => {\n+        const cache1 = new EntryPointFileCache(fs, sharedFileCache);\n+        const cache2 = new EntryPointFileCache(fs, sharedFileCache);\n+\n+        const index1 = cache1.getCachedSourceFile('/index.ts', ts.ScriptTarget.ESNext)!;\n+        const index2 = cache2.getCachedSourceFile('/index.ts', ts.ScriptTarget.ESNext)!;\n+        expect(index1).not.toBe(index2);\n+      });\n+\n+      it('should return undefined if the file does not exist', () => {\n+        const cache = new EntryPointFileCache(fs, sharedFileCache);\n+        expect(cache.getCachedSourceFile('/nonexistent.ts', ts.ScriptTarget.ESNext))\n+            .toBeUndefined();\n+      });\n+\n+      it('should return undefined if the path is a directory', () => {\n+        const cache = new EntryPointFileCache(fs, sharedFileCache);\n+        expect(cache.getCachedSourceFile('/node_modules', ts.ScriptTarget.ESNext)).toBeUndefined();\n+      });\n+    });\n+  });\n+});"
        },
        {
            "sha": "255212a20c9d0de038f099fa60439593d5702a5b",
            "filename": "packages/compiler-cli/ngcc/test/writing/new_entry_point_file_writer_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fwriting%2Fnew_entry_point_file_writer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f0688b4d186546760f21125cd3f64ae87d7fa476/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fwriting%2Fnew_entry_point_file_writer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fwriting%2Fnew_entry_point_file_writer_spec.ts?ref=f0688b4d186546760f21125cd3f64ae87d7fa476",
            "patch": "@@ -12,6 +12,7 @@ import {loadTestFiles} from '../../../test/helpers';\n import {NgccConfiguration} from '../../src/packages/configuration';\n import {EntryPoint, EntryPointFormat, EntryPointJsonProperty, getEntryPointInfo, isEntryPoint} from '../../src/packages/entry_point';\n import {EntryPointBundle, makeEntryPointBundle} from '../../src/packages/entry_point_bundle';\n+import {createModuleResolutionCache, SharedFileCache} from '../../src/packages/source_file_cache';\n import {FileWriter} from '../../src/writing/file_writer';\n import {NewEntryPointFileWriter} from '../../src/writing/new_entry_point_file_writer';\n import {DirectPackageJsonUpdater} from '../../src/writing/package_json_updater';\n@@ -634,7 +635,9 @@ runInEachFileSystem(() => {\n   function makeTestBundle(\n       fs: FileSystem, entryPoint: EntryPoint, formatProperty: EntryPointJsonProperty,\n       format: EntryPointFormat): EntryPointBundle {\n+    const moduleResolutionCache = createModuleResolutionCache(fs);\n     return makeEntryPointBundle(\n-        fs, entryPoint, entryPoint.packageJson[formatProperty]!, false, format, true);\n+        fs, entryPoint, new SharedFileCache(fs), moduleResolutionCache,\n+        entryPoint.packageJson[formatProperty]!, false, format, true);\n   }\n });"
        }
    ],
    "stats": {
        "total": 529,
        "additions": 509,
        "deletions": 20
    }
}