{
    "author": "JoostK",
    "message": "fix(compiler-cli): report missing pipes when `fullTemplateTypeCheck` is disabled (#39320)\n\nEven if `fullTemplateTypeCheck` is disabled should missing pipes still\nbe reported, as was the case in View Engine.\n\nFixes #38195\n\nPR Close #39320",
    "sha": "3b0b7d22109c79b4dceb4ae069c3927894cf1bd6",
    "files": [
        {
            "sha": "d1d08d50b033633d34e71c073c19900420db4777",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/3b0b7d22109c79b4dceb4ae069c3927894cf1bd6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/3b0b7d22109c79b4dceb4ae069c3927894cf1bd6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=3b0b7d22109c79b4dceb4ae069c3927894cf1bd6",
            "patch": "@@ -1022,11 +1022,11 @@ export class Context {\n     return ts.createIdentifier(`_t${this.nextId++}`);\n   }\n \n-  getPipeByName(name: string): ts.Expression|null {\n+  getPipeByName(name: string): Reference<ClassDeclaration<ts.ClassDeclaration>>|null {\n     if (!this.pipes.has(name)) {\n       return null;\n     }\n-    return this.env.pipeInst(this.pipes.get(name)!);\n+    return this.pipes.get(name)!;\n   }\n }\n \n@@ -1568,19 +1568,20 @@ class TcbExpressionTranslator {\n       return ts.createIdentifier('ctx');\n     } else if (ast instanceof BindingPipe) {\n       const expr = this.translate(ast.exp);\n+      const pipeRef = this.tcb.getPipeByName(ast.name);\n       let pipe: ts.Expression|null;\n-      if (this.tcb.env.config.checkTypeOfPipes) {\n-        pipe = this.tcb.getPipeByName(ast.name);\n-        if (pipe === null) {\n-          // No pipe by that name exists in scope. Record this as an error.\n-          this.tcb.oobRecorder.missingPipe(this.tcb.id, ast);\n-\n-          // Return an 'any' value to at least allow the rest of the expression to be checked.\n-          pipe = NULL_AS_ANY;\n-        }\n+      if (pipeRef === null) {\n+        // No pipe by that name exists in scope. Record this as an error.\n+        this.tcb.oobRecorder.missingPipe(this.tcb.id, ast);\n+\n+        // Use an 'any' value to at least allow the rest of the expression to be checked.\n+        pipe = NULL_AS_ANY;\n+      } else if (this.tcb.env.config.checkTypeOfPipes) {\n+        // Use a variable declared as the pipe's type.\n+        pipe = this.tcb.env.pipeInst(pipeRef);\n       } else {\n-        pipe = ts.createParen(ts.createAsExpression(\n-            ts.createNull(), ts.createKeywordTypeNode(ts.SyntaxKind.AnyKeyword)));\n+        // Use an 'any' value when not checking the type of the pipe.\n+        pipe = NULL_AS_ANY;\n       }\n       const args = ast.args.map(arg => this.translate(arg));\n       const result = tsCallMethod(pipe, 'transform', [expr, ...args]);"
        },
        {
            "sha": "ae6db43321e6770669065cbb5e2d5789814676c6",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/3b0b7d22109c79b4dceb4ae069c3927894cf1bd6/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3b0b7d22109c79b4dceb4ae069c3927894cf1bd6/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=3b0b7d22109c79b4dceb4ae069c3927894cf1bd6",
            "patch": "@@ -1080,6 +1080,31 @@ export declare class AnimationEvent {\n       expect(getSourceCodeForDiagnostic(diags[0])).toBe('unknown');\n     });\n \n+    it('should report an error with an unknown pipe even if `fullTemplateTypeCheck` is disabled',\n+       () => {\n+         env.tsconfig({ivyTemplateTypeCheck: true, fullTemplateTypeCheck: false});\n+         env.write('test.ts', `\n+          import {Component, NgModule} from '@angular/core';\n+\n+          @Component({\n+            selector: 'test',\n+            template: '{{expr | unknown}}',\n+          })\n+          class TestCmp {\n+            expr = 3;\n+          }\n+\n+          @NgModule({\n+            declarations: [TestCmp],\n+          })\n+          class Module {}\n+        `);\n+         const diags = env.driveDiagnostics();\n+         expect(diags.length).toBe(1);\n+         expect(diags[0].messageText).toBe(`No pipe found with name 'unknown'.`);\n+         expect(getSourceCodeForDiagnostic(diags[0])).toBe('unknown');\n+       });\n+\n     it('should report an error with pipe bindings', () => {\n       env.write('test.ts', `\n     import {CommonModule} from '@angular/common';"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 39,
        "deletions": 13
    }
}