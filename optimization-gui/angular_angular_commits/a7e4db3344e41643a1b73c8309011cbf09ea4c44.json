{
    "author": "JoostK",
    "message": "test(compiler-cli): improve compliance test performance (#39956)\n\nThe newly built compliance test runner was not using the shared source\nfile cache that was added in b627f7f02e714f68a2f6ab0724597ad6107db3ce,\nwhich offers a significant performance boost to the compliance test\ntargets.\n\nPR Close #39956",
    "sha": "a7e4db3344e41643a1b73c8309011cbf09ea4c44",
    "files": [
        {
            "sha": "fdb53352de8b693940f477030c790144d8bc6f22",
            "filename": "packages/compiler-cli/src/ngtsc/testing/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Findex.ts?ref=a7e4db3344e41643a1b73c8309011cbf09ea4c44",
            "patch": "@@ -7,5 +7,6 @@\n  */\n export * from './src/utils';\n export * from './src/cached_source_files';\n+export * from './src/compiler_host';\n export * from './src/mock_file_loading';\n export * from './src/runfile_helpers';"
        },
        {
            "sha": "83ca99ee1b75d2423a8d08f35e990841deb1a78b",
            "filename": "packages/compiler-cli/src/ngtsc/testing/src/compiler_host.ts",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Fsrc%2Fcompiler_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Fsrc%2Fcompiler_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Fsrc%2Fcompiler_host.ts?ref=a7e4db3344e41643a1b73c8309011cbf09ea4c44",
            "patch": "@@ -0,0 +1,25 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+import {NgtscCompilerHost} from '../../file_system';\n+import {getCachedSourceFile} from './cached_source_files';\n+\n+/**\n+ * A compiler host intended to improve test performance by caching default library source files for\n+ * reuse across tests.\n+ */\n+export class NgtscTestCompilerHost extends NgtscCompilerHost {\n+  getSourceFile(fileName: string, languageVersion: ts.ScriptTarget): ts.SourceFile|undefined {\n+    const cachedSf = getCachedSourceFile(fileName, () => this.readFile(fileName));\n+    if (cachedSf !== null) {\n+      return cachedSf;\n+    }\n+    return super.getSourceFile(fileName, languageVersion);\n+  }\n+}"
        },
        {
            "sha": "e8a04a4156ee052715200c6440268c6f05aaec95",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/compile_test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fcompile_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fcompile_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fcompile_test.ts?ref=a7e4db3344e41643a1b73c8309011cbf09ea4c44",
            "patch": "@@ -7,9 +7,9 @@\n  */\n import * as ts from 'typescript';\n \n-import {AbsoluteFsPath, FileSystem, NgtscCompilerHost} from '../../../src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem} from '../../../src/ngtsc/file_system';\n import {initMockFileSystem} from '../../../src/ngtsc/file_system/testing';\n-import {loadStandardTestFiles, loadTestDirectory} from '../../../src/ngtsc/testing';\n+import {loadStandardTestFiles, loadTestDirectory, NgtscTestCompilerHost} from '../../../src/ngtsc/testing';\n import {Diagnostics, performCompilation} from '../../../src/perform_compile';\n import {CompilerOptions} from '../../../src/transformers/api';\n \n@@ -52,7 +52,7 @@ export function compileTest(\n   const outDir = getBuildOutputDirectory(fs);\n   const options = getOptions(rootDir, outDir, compilerOptions, angularCompilerOptions);\n   const rootNames = files.map(f => fs.resolve(f));\n-  const host = new NgtscCompilerHost(fs, options);\n+  const host = new NgtscTestCompilerHost(fs, options);\n   const {diagnostics, emitResult} = performCompilation({rootNames, host, options});\n   const emittedFiles = emitResult ? emitResult.emittedFiles!.map(p => fs.resolve(rootDir, p)) : [];\n   const errors = parseDiagnostics(diagnostics);"
        },
        {
            "sha": "0c910065af53332c8011ccd09b17f40630ef0b00",
            "filename": "packages/compiler-cli/test/ngtsc/env.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/a7e4db3344e41643a1b73c8309011cbf09ea4c44/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts?ref=a7e4db3344e41643a1b73c8309011cbf09ea4c44",
            "patch": "@@ -12,13 +12,13 @@ import * as ts from 'typescript';\n \n import {createCompilerHost, createProgram} from '../../index';\n import {main, mainDiagnosticsForTest, readNgcCommandLineAndConfiguration} from '../../src/main';\n-import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, NgtscCompilerHost, relativeFrom} from '../../src/ngtsc/file_system';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, relativeFrom} from '../../src/ngtsc/file_system';\n import {Folder, MockFileSystem} from '../../src/ngtsc/file_system/testing';\n import {IndexedComponent} from '../../src/ngtsc/indexer';\n import {NgtscProgram} from '../../src/ngtsc/program';\n import {DeclarationNode} from '../../src/ngtsc/reflection';\n import {LazyRoute} from '../../src/ngtsc/routing';\n-import {getCachedSourceFile} from '../../src/ngtsc/testing';\n+import {NgtscTestCompilerHost} from '../../src/ngtsc/testing';\n import {setWrapHostForTest} from '../../src/transformers/compiler_host';\n \n \n@@ -268,16 +268,6 @@ export class NgtscTestEnvironment {\n   }\n }\n \n-class NgtscTestCompilerHost extends NgtscCompilerHost {\n-  getSourceFile(fileName: string, languageVersion: ts.ScriptTarget): ts.SourceFile|undefined {\n-    const cachedSf = getCachedSourceFile(fileName, () => this.readFile(fileName));\n-    if (cachedSf !== null) {\n-      return cachedSf;\n-    }\n-    return super.getSourceFile(fileName, languageVersion);\n-  }\n-}\n-\n class AugmentedCompilerHost extends NgtscTestCompilerHost {\n   delegate!: ts.CompilerHost;\n }"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 31,
        "deletions": 15
    }
}