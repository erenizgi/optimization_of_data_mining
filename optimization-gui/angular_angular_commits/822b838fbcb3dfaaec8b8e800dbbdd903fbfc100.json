{
    "author": "petebacondarwin",
    "message": "fix(ngcc): ensure that \"inline exports\" can be interpreted correctly (#39267)\n\nPreviously, inline exports of the form `exports.foo = <implementation>;` were\nbeing interpreted (by the ngtsc `PartialInterpeter`) as `Reference` objects.\nThis is not what is desired since it prevents the value of the export\nfrom being unpacked, such as when analyzing `NgModule` declarations:\n\n```\nexports.directives = [Directive1, Directive2];\n\n@NgImport({declarations: [exports.directives]})\nclass AppModule {}\n```\n\nIn this example the interpreter would think that `exports.directives`\nwas a reference rather than an array that needs to be unpacked.\n\nThis bug was picked up by the ngcc-validation repository. See\nhttps://github.com/angular/ngcc-validation/pull/1990 and\nhttps://circleci.com/gh/angular/ngcc-validation/17130\n\nPR Close #39267",
    "sha": "822b838fbcb3dfaaec8b8e800dbbdd903fbfc100",
    "files": [
        {
            "sha": "4a501a953a86917993dff859af0f21cba25a0358",
            "filename": "packages/compiler-cli/ngcc/src/host/commonjs_host.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 18,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_host.ts?ref=822b838fbcb3dfaaec8b8e800dbbdd903fbfc100",
            "patch": "@@ -14,7 +14,7 @@ import {Declaration, DeclarationKind, Import} from '../../../src/ngtsc/reflectio\n import {BundleProgram} from '../packages/bundle_program';\n import {FactoryMap, isDefined} from '../utils';\n \n-import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, RequireCall, WildcardReexportStatement} from './commonjs_umd_utils';\n+import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, RequireCall, skipAliases, WildcardReexportStatement} from './commonjs_umd_utils';\n import {Esm5ReflectionHost} from './esm5_host';\n import {NgccClassSymbol} from './ngcc_host';\n \n@@ -117,9 +117,16 @@ export class CommonJsReflectionHost extends Esm5ReflectionHost {\n   }\n \n   private extractBasicCommonJsExportDeclaration(statement: ExportsStatement): ExportDeclaration {\n-    const exportExpression = statement.expression.right;\n-    const name = statement.expression.left.name.text;\n-    return this.extractCommonJsExportDeclaration(name, exportExpression);\n+    const exportExpression = skipAliases(statement.expression.right);\n+    const node = statement.expression.left;\n+    const declaration = this.getDeclarationOfExpression(exportExpression) ?? {\n+      kind: DeclarationKind.Inline,\n+      node,\n+      implementation: exportExpression,\n+      known: null,\n+      viaModule: null,\n+    };\n+    return {name: node.name.text, declaration};\n   }\n \n   private extractCommonJsWildcardReexports(\n@@ -163,7 +170,22 @@ export class CommonJsReflectionHost extends Esm5ReflectionHost {\n     if (getterFnExpression === null) {\n       return null;\n     }\n-    return this.extractCommonJsExportDeclaration(name, getterFnExpression);\n+\n+    const declaration = this.getDeclarationOfExpression(getterFnExpression);\n+    if (declaration !== null) {\n+      return {name, declaration};\n+    }\n+\n+    return {\n+      name,\n+      declaration: {\n+        kind: DeclarationKind.Inline,\n+        node: args[1],\n+        implementation: getterFnExpression,\n+        known: null,\n+        viaModule: null,\n+      },\n+    };\n   }\n \n   private findCommonJsImport(id: ts.Identifier): RequireCall|null {\n@@ -173,19 +195,6 @@ export class CommonJsReflectionHost extends Esm5ReflectionHost {\n     return nsIdentifier && findRequireCallReference(nsIdentifier, this.checker);\n   }\n \n-  private extractCommonJsExportDeclaration(name: string, expression: ts.Expression):\n-      ExportDeclaration {\n-    const declaration = this.getDeclarationOfExpression(expression);\n-    if (declaration !== null) {\n-      return {name, declaration};\n-    } else {\n-      return {\n-        name,\n-        declaration: {node: expression, known: null, kind: DeclarationKind.Inline, viaModule: null},\n-      };\n-    }\n-  }\n-\n   /**\n    * Handle the case where the identifier represents a reference to a whole CommonJS\n    * module, i.e. the result of a call to `require(...)`."
        },
        {
            "sha": "b762eafdec51f85392b036b4af06e368b684dc34",
            "filename": "packages/compiler-cli/ngcc/src/host/commonjs_umd_utils.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_umd_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_umd_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fcommonjs_umd_utils.ts?ref=822b838fbcb3dfaaec8b8e800dbbdd903fbfc100",
            "patch": "@@ -264,3 +264,20 @@ export interface ExportsStatement extends ts.ExpressionStatement {\n export function isExportsStatement(stmt: ts.Node): stmt is ExportsStatement {\n   return ts.isExpressionStatement(stmt) && isExportsAssignment(stmt.expression);\n }\n+\n+/**\n+ * Find the far right hand side of a sequence of aliased assignements of the form\n+ *\n+ * ```\n+ * exports.MyClass = alias1 = alias2 = <<declaration>>\n+ * ```\n+ *\n+ * @param node the expression to parse\n+ * @returns the original `node` or the far right expression of a series of assignments.\n+ */\n+export function skipAliases(node: ts.Expression): ts.Expression {\n+  while (isAssignment(node)) {\n+    node = node.right;\n+  }\n+  return node;\n+}"
        },
        {
            "sha": "c56b95b2d6fa914484b86458387deed8c617cc4f",
            "filename": "packages/compiler-cli/ngcc/src/host/umd_host.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 19,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fumd_host.ts?ref=822b838fbcb3dfaaec8b8e800dbbdd903fbfc100",
            "patch": "@@ -14,7 +14,7 @@ import {Declaration, DeclarationKind, Import, isNamedFunctionDeclaration} from '\n import {BundleProgram} from '../packages/bundle_program';\n import {FactoryMap, getTsHelperFnFromIdentifier, stripExtension} from '../utils';\n \n-import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsAssignment, isExportsDeclaration, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, WildcardReexportStatement} from './commonjs_umd_utils';\n+import {DefinePropertyReexportStatement, ExportDeclaration, ExportsStatement, extractGetterFnExpression, findNamespaceOfIdentifier, findRequireCallReference, isDefinePropertyReexportStatement, isExportsAssignment, isExportsDeclaration, isExportsStatement, isExternalImport, isRequireCall, isWildcardReexportStatement, skipAliases, WildcardReexportStatement} from './commonjs_umd_utils';\n import {getInnerClassDeclaration, getOuterNodeFromInnerDeclaration, isAssignment} from './esm2015_host';\n import {Esm5ReflectionHost} from './esm5_host';\n import {NgccClassSymbol} from './ngcc_host';\n@@ -77,6 +77,7 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n     return {\n       kind: DeclarationKind.Inline,\n       node: outerNode.left,\n+      implementation: outerNode.right,\n       known: null,\n       viaModule: null,\n     };\n@@ -278,6 +279,7 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n     const declaration = this.getDeclarationOfExpression(exportExpression) ?? {\n       kind: DeclarationKind.Inline,\n       node: statement.expression.left,\n+      implementation: statement.expression.right,\n       known: null,\n       viaModule: null,\n     };\n@@ -340,7 +342,8 @@ export class UmdReflectionHost extends Esm5ReflectionHost {\n       name,\n       declaration: {\n         kind: DeclarationKind.Inline,\n-        node: getterFnExpression,\n+        node: args[1],\n+        implementation: getterFnExpression,\n         known: null,\n         viaModule: null,\n       },\n@@ -564,20 +567,3 @@ function getRequiredModulePath(wrapperFn: ts.FunctionExpression, paramIndex: num\n function isExportsIdentifier(node: ts.Node): node is ts.Identifier {\n   return ts.isIdentifier(node) && node.text === 'exports';\n }\n-\n-/**\n- * Find the far right hand side of a sequence of aliased assignements of the form\n- *\n- * ```\n- * exports.MyClass = alias1 = alias2 = <<declaration>>\n- * ```\n- *\n- * @param node the expression to parse\n- * @returns the original `node` or the far right expression of a series of assignments.\n- */\n-function skipAliases(node: ts.Expression): ts.Expression {\n-  while (isAssignment(node)) {\n-    node = node.right;\n-  }\n-  return node;\n-}"
        },
        {
            "sha": "0ffe3ed4850498046e8ce5164e552e2ace9d2762",
            "filename": "packages/compiler-cli/ngcc/test/host/commonjs_host_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts?ref=822b838fbcb3dfaaec8b8e800dbbdd903fbfc100",
            "patch": "@@ -2422,9 +2422,10 @@ exports.MissingClass2 = MissingClass2;\n           const file = getSourceFileOrError(bundle.program, _('/inline_export.js'));\n           const exportDeclarations = host.getExportsOfModule(file);\n           expect(exportDeclarations).not.toBeNull();\n-          const decl = exportDeclarations!.get('directives')!;\n+          const decl = exportDeclarations!.get('directives') as InlineDeclaration;\n           expect(decl).toBeDefined();\n-          expect(decl.node).toBeDefined();\n+          expect(decl.node.getText()).toEqual('exports.directives');\n+          expect(decl.implementation!.getText()).toEqual('[foo]');\n           expect(decl.kind).toEqual(DeclarationKind.Inline);\n         });\n "
        },
        {
            "sha": "8eda983323b55c9bcabc999d2b4538415ea619d1",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/822b838fbcb3dfaaec8b8e800dbbdd903fbfc100/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=822b838fbcb3dfaaec8b8e800dbbdd903fbfc100",
            "patch": "@@ -2750,13 +2750,13 @@ runInEachFileSystem(() => {\n           const exportDeclarations = host.getExportsOfModule(file);\n           expect(exportDeclarations).not.toBe(null);\n           expect(exportDeclarations!.size).toEqual(1);\n-          const classDecl = exportDeclarations!.get('DecoratedClass')!;\n+          const classDecl = exportDeclarations!.get('DecoratedClass') as InlineDeclaration;\n           expect(classDecl).toBeDefined();\n           expect(classDecl.kind).toEqual(DeclarationKind.Inline);\n           expect(classDecl.known).toBe(null);\n           expect(classDecl.viaModule).toBe(null);\n           expect(classDecl.node.getText()).toEqual('exports.DecoratedClass');\n-          expect(classDecl.node.parent.parent.getText()).toContain('function DecoratedClass() {');\n+          expect(classDecl.implementation!.getText()).toContain('function DecoratedClass() {');\n         });\n \n         it('should handle wildcard re-exports of other modules (with emitted helpers)', () => {\n@@ -2824,9 +2824,10 @@ runInEachFileSystem(() => {\n           const file = getSourceFileOrError(bundle.program, INLINE_EXPORT_FILE.name);\n           const exportDeclarations = host.getExportsOfModule(file);\n           expect(exportDeclarations).not.toBe(null);\n-          const decl = exportDeclarations!.get('directives')!;\n+          const decl = exportDeclarations!.get('directives') as InlineDeclaration;\n           expect(decl).toBeDefined();\n-          expect(decl.node).toBeDefined();\n+          expect(decl.node.getText()).toEqual('exports.directives');\n+          expect(decl.implementation!.getText()).toEqual('[foo]');\n           expect(decl.kind).toEqual(DeclarationKind.Inline);\n         });\n "
        }
    ],
    "stats": {
        "total": 100,
        "additions": 57,
        "deletions": 43
    }
}