{
    "author": "atscott",
    "message": "fix(language-service): 'go to defininition' for objects defined in template (#42559)\n\nPreviously, the \"go to definition\" action did no account for the\npossibility that something may actually be defined in a template. This\nchange updates the logic in the definition builder to convert any\nresults that are locations in template typecheck files to their\ncorresponding locations in the template.\n\nPR Close #42559",
    "sha": "4001e9d80852101a30b1adb1e501438b5846c463",
    "files": [
        {
            "sha": "257bd85cca8237f2d9df1e02fb1ff1aa6b237983",
            "filename": "packages/language-service/ivy/definitions.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 2,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/4001e9d80852101a30b1adb1e501438b5846c463/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/4001e9d80852101a30b1adb1e501438b5846c463/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts?ref=4001e9d80852101a30b1adb1e501438b5846c463",
            "patch": "@@ -8,10 +8,13 @@\n \n import {AST, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstTemplate, TmplAstTextAttribute} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {isExternalResource} from '@angular/compiler-cli/src/ngtsc/metadata';\n+import {ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ShimLocation, Symbol, SymbolKind, TemplateSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript';\n \n+import {convertToTemplateDocumentSpan} from './references_and_rename_utils';\n import {getTargetAtPosition, TargetNodeKind} from './template_target';\n import {findTightestNode, getParentClassDeclaration} from './ts_utils';\n import {flatMap, getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, getTemplateLocationFromShimLocation, getTextSpanOfNode, isDollarEvent, isTypeScriptFile, TemplateInfo, toTextSpan} from './utils';\n@@ -27,7 +30,11 @@ interface HasShimLocation {\n }\n \n export class DefinitionBuilder {\n-  constructor(private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler) {}\n+  private readonly ttc = this.compiler.getTemplateTypeChecker();\n+\n+  constructor(\n+      private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,\n+      private readonly driver: ProgramDriver) {}\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n@@ -132,10 +139,36 @@ export class DefinitionBuilder {\n   private getDefinitionsForSymbols(...symbols: HasShimLocation[]): ts.DefinitionInfo[] {\n     return flatMap(symbols, ({shimLocation}) => {\n       const {shimPath, positionInShimFile} = shimLocation;\n-      return this.tsLS.getDefinitionAtPosition(shimPath, positionInShimFile) ?? [];\n+      const definitionInfos = this.tsLS.getDefinitionAtPosition(shimPath, positionInShimFile);\n+      if (definitionInfos === undefined) {\n+        return [];\n+      }\n+      return this.mapShimResultsToTemplates(definitionInfos);\n     });\n   }\n \n+  /**\n+   * Converts and definition info result that points to a template typecheck file to a reference to\n+   * the corresponding location in the template.\n+   */\n+  private mapShimResultsToTemplates(definitionInfos: readonly ts.DefinitionInfo[]):\n+      readonly ts.DefinitionInfo[] {\n+    const result: ts.DefinitionInfo[] = [];\n+    for (const info of definitionInfos) {\n+      if (this.ttc.isTrackedTypeCheckFile(absoluteFrom(info.fileName))) {\n+        const templateDefinitionInfo =\n+            convertToTemplateDocumentSpan(info, this.ttc, this.driver.getProgram());\n+        if (templateDefinitionInfo === null) {\n+          continue;\n+        }\n+        result.push(templateDefinitionInfo);\n+      } else {\n+        result.push(info);\n+      }\n+    }\n+    return result;\n+  }\n+\n   getTypeDefinitionsAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n     const templateInfo = getTemplateInfoAtPosition(fileName, position, this.compiler);"
        },
        {
            "sha": "673128a1abdd47d4f7a10550661b2269a5f044de",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/4001e9d80852101a30b1adb1e501438b5846c463/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/4001e9d80852101a30b1adb1e501438b5846c463/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=4001e9d80852101a30b1adb1e501438b5846c463",
            "patch": "@@ -118,7 +118,7 @@ export class LanguageService {\n       if (!isInAngularContext(compiler.getCurrentProgram(), fileName, position)) {\n         return undefined;\n       }\n-      return new DefinitionBuilder(this.tsLS, compiler)\n+      return new DefinitionBuilder(this.tsLS, compiler, this.programDriver)\n           .getDefinitionAndBoundSpan(fileName, position);\n     });\n   }\n@@ -129,7 +129,7 @@ export class LanguageService {\n       if (!isTemplateContext(compiler.getCurrentProgram(), fileName, position)) {\n         return undefined;\n       }\n-      return new DefinitionBuilder(this.tsLS, compiler)\n+      return new DefinitionBuilder(this.tsLS, compiler, this.programDriver)\n           .getTypeDefinitionsAtPosition(fileName, position);\n     });\n   }"
        },
        {
            "sha": "145d8a3d1fb328d855089658bdcdd61f4b61f725",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/4001e9d80852101a30b1adb1e501438b5846c463/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4001e9d80852101a30b1adb1e501438b5846c463/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=4001e9d80852101a30b1adb1e501438b5846c463",
            "patch": "@@ -176,6 +176,35 @@ describe('definitions', () => {\n     assertFileNames(definitions, ['style.scss']);\n   });\n \n+  it('gets definition for property of variable declared in template', () => {\n+    initMockFileSystem('Native');\n+    const files = {\n+      'app.html': `\n+        <ng-container *ngIf=\"{prop: myVal} as myVar\">\n+          {{myVar.prop.name}}\n+        </ng-container>\n+      `,\n+      'app.ts': `\n+        import {Component} from '@angular/core';\n+\n+        @Component({templateUrl: '/app.html'})\n+        export class AppCmp {\n+          myVal = {name: 'Andrew'};\n+        }\n+      `,\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const template = project.openFile('app.html');\n+    project.expectNoSourceDiagnostics();\n+\n+    template.moveCursorToText('{{myVar.proÂ¦p.name}}');\n+    const {definitions} = getDefinitionsAndAssertBoundSpan(env, template);\n+    expect(definitions![0].name).toEqual('\"prop\"');\n+    assertFileNames(Array.from(definitions!), ['app.html']);\n+  });\n+\n   function getDefinitionsAndAssertBoundSpan(env: LanguageServiceTestEnv, file: OpenBuffer) {\n     env.expectNoSourceDiagnostics();\n     const definitionAndBoundSpan = file.getDefinitionAndBoundSpan();"
        }
    ],
    "stats": {
        "total": 70,
        "additions": 66,
        "deletions": 4
    }
}