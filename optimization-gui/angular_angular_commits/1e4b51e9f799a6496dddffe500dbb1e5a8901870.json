{
    "author": "mhevery",
    "message": "fix(core): improve injector debug information in `ngDevMode` (#40476)\n\n- `LViewDebug` now properly shows when `TNode` has `NO_NODE_INJECTOR`.\n- Provide `injectorResolutionPath` property `DebugNode`\n\nPR Close #40476",
    "sha": "1e4b51e9f799a6496dddffe500dbb1e5a8901870",
    "files": [
        {
            "sha": "a30d30ced7e348c05d4fd19a3f0aec3808df44a5",
            "filename": "packages/core/src/render3/instructions/lview_debug.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/1e4b51e9f799a6496dddffe500dbb1e5a8901870/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "raw_url": "https://github.com/angular/angular/raw/1e4b51e9f799a6496dddffe500dbb1e5a8901870/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts?ref=1e4b51e9f799a6496dddffe500dbb1e5a8901870",
            "patch": "@@ -15,7 +15,7 @@ import {assertDefined} from '../../util/assert';\n import {createNamedArrayType} from '../../util/named_array_type';\n import {initNgDevMode} from '../../util/ng_dev_mode';\n import {assertNodeInjector} from '../assert';\n-import {getInjectorIndex} from '../di';\n+import {getInjectorIndex, getParentInjectorLocation} from '../di';\n import {CONTAINER_HEADER_OFFSET, HAS_TRANSPLANTED_VIEWS, LContainer, MOVED_VIEWS, NATIVE} from '../interfaces/container';\n import {ComponentTemplate, DirectiveDef, DirectiveDefList, PipeDefList, ViewQueriesFunction} from '../interfaces/definition';\n import {NO_PARENT_INJECTOR, NodeInjectorOffset} from '../interfaces/injector';\n@@ -25,7 +25,7 @@ import {LQueries, TQueries} from '../interfaces/query';\n import {Renderer3, RendererFactory3} from '../interfaces/renderer';\n import {RComment, RElement, RNode} from '../interfaces/renderer_dom';\n import {getTStylingRangeNext, getTStylingRangeNextDuplicate, getTStylingRangePrev, getTStylingRangePrevDuplicate, TStylingKey, TStylingRange} from '../interfaces/styling';\n-import {CHILD_HEAD, CHILD_TAIL, CLEANUP, CONTEXT, DebugNode, DECLARATION_VIEW, DestroyHookData, FLAGS, HEADER_OFFSET, HookData, HOST, HostBindingOpCodes, INJECTOR, LContainerDebug as ILContainerDebug, LView, LViewDebug as ILViewDebug, LViewDebugRange, LViewDebugRangeContent, LViewFlags, NEXT, PARENT, QUERIES, RENDERER, RENDERER_FACTORY, SANITIZER, T_HOST, TData, TView as ITView, TVIEW, TView, TViewType, TViewTypeAsString} from '../interfaces/view';\n+import {CHILD_HEAD, CHILD_TAIL, CLEANUP, CONTEXT, DebugNode, DECLARATION_VIEW, DestroyHookData, FLAGS, HEADER_OFFSET, HookData, HOST, HostBindingOpCodes, INJECTOR, LContainerDebug as ILContainerDebug, LView, LViewDebug as ILViewDebug, LViewDebugRange, LViewDebugRangeContent, LViewFlags, NEXT, NodeInjectorDebug, PARENT, QUERIES, RENDERER, RENDERER_FACTORY, SANITIZER, T_HOST, TData, TView as ITView, TVIEW, TView, TViewType, TViewTypeAsString} from '../interfaces/view';\n import {attachDebugObject} from '../util/debug_utils';\n import {getParentInjectorIndex, getParentInjectorView} from '../util/injector_utils';\n import {unwrapRNode} from '../util/view_utils';\n@@ -216,8 +216,20 @@ class TNode implements ITNode {\n   debugNodeInjectorPath(lView: LView): DebugNode[] {\n     const path: DebugNode[] = [];\n     let injectorIndex = getInjectorIndex(this, lView);\n-    ngDevMode && assertNodeInjector(lView, injectorIndex);\n+    if (injectorIndex === -1) {\n+      // Looks like the current `TNode` does not have `NodeInjector` associated with it => look for\n+      // parent NodeInjector.\n+      const parentLocation = getParentInjectorLocation(this, lView);\n+      if (parentLocation !== NO_PARENT_INJECTOR) {\n+        // We found a parent, so start searching from the parent location.\n+        injectorIndex = getParentInjectorIndex(parentLocation);\n+        lView = getParentInjectorView(parentLocation, lView);\n+      } else {\n+        // No parents have been found, so there are no `NodeInjector`s to consult.\n+      }\n+    }\n     while (injectorIndex !== -1) {\n+      ngDevMode && assertNodeInjector(lView, injectorIndex);\n       const tNode = lView[TVIEW].data[injectorIndex + NodeInjectorOffset.TNODE] as TNode;\n       path.push(buildDebugNode(tNode, lView));\n       const parentLocation = lView[injectorIndex + NodeInjectorOffset.PARENT];\n@@ -583,15 +595,19 @@ export function buildDebugNode(tNode: ITNode, lView: LView): DebugNode {\n   return {\n     html: toHtml(native),\n     type: toTNodeTypeAsString(tNode.type),\n+    tNode,\n     native: native as any,\n     children: toDebugNodes(tNode.child, lView),\n     factories,\n     instances,\n-    injector: buildNodeInjectorDebug(tNode, tView, lView)\n+    injector: buildNodeInjectorDebug(tNode, tView, lView),\n+    get injectorResolutionPath() {\n+      return (tNode as TNode).debugNodeInjectorPath(lView);\n+    },\n   };\n }\n \n-function buildNodeInjectorDebug(tNode: ITNode, tView: ITView, lView: LView) {\n+function buildNodeInjectorDebug(tNode: ITNode, tView: ITView, lView: LView): NodeInjectorDebug {\n   const viewProviders: Type<any>[] = [];\n   for (let i = (tNode as TNode).providerIndexStart_; i < (tNode as TNode).providerIndexEnd_; i++) {\n     viewProviders.push(tView.data[i] as Type<any>);\n@@ -633,6 +649,9 @@ function binary(array: any[], idx: number): string {\n  * @param idx\n  */\n function toBloom(array: any[], idx: number): string {\n+  if (idx < 0) {\n+    return 'NO_NODE_INJECTOR';\n+  }\n   return `${binary(array, idx + 7)}_${binary(array, idx + 6)}_${binary(array, idx + 5)}_${\n       binary(array, idx + 4)}_${binary(array, idx + 3)}_${binary(array, idx + 2)}_${\n       binary(array, idx + 1)}_${binary(array, idx + 0)}`;"
        },
        {
            "sha": "64e3b020529c49b0957f5bf47ad75c520de62f36",
            "filename": "packages/core/src/render3/interfaces/view.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/1e4b51e9f799a6496dddffe500dbb1e5a8901870/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fview.ts",
            "raw_url": "https://github.com/angular/angular/raw/1e4b51e9f799a6496dddffe500dbb1e5a8901870/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fview.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fview.ts?ref=1e4b51e9f799a6496dddffe500dbb1e5a8901870",
            "patch": "@@ -1089,6 +1089,11 @@ export interface DebugNode {\n    */\n   html: string|null;\n \n+  /**\n+   * Associated `TNode`\n+   */\n+  tNode: TNode;\n+\n   /**\n    * Human readable node type.\n    */\n@@ -1118,6 +1123,11 @@ export interface DebugNode {\n    * NodeInjector information.\n    */\n   injector: NodeInjectorDebug;\n+\n+  /**\n+   * Injector resolution path.\n+   */\n+  injectorResolutionPath: any;\n }\n \n export interface NodeInjectorDebug {"
        },
        {
            "sha": "09d7fdd90e2ce5d07dee3a776b2281e993752f95",
            "filename": "packages/core/test/render3/instructions/lview_debug_spec.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 2,
            "changes": 66,
            "blob_url": "https://github.com/angular/angular/blob/1e4b51e9f799a6496dddffe500dbb1e5a8901870/packages%2Fcore%2Ftest%2Frender3%2Finstructions%2Flview_debug_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1e4b51e9f799a6496dddffe500dbb1e5a8901870/packages%2Fcore%2Ftest%2Frender3%2Finstructions%2Flview_debug_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Finstructions%2Flview_debug_spec.ts?ref=1e4b51e9f799a6496dddffe500dbb1e5a8901870",
            "patch": "@@ -6,15 +6,19 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ɵɵdefineComponent, ɵɵdefineDirective, ɵɵdirectiveInject, ɵɵProvidersFeature} from '@angular/core/src/core';\n+import {Component, Injectable, ɵɵdefineComponent, ɵɵdefineDirective, ɵɵdirectiveInject, ɵɵProvidersFeature} from '@angular/core/src/core';\n+import {getLContext} from '@angular/core/src/render3/context_discovery';\n import {ɵɵelement, ɵɵelementEnd, ɵɵelementStart} from '@angular/core/src/render3/instructions/element';\n import {TNodeDebug} from '@angular/core/src/render3/instructions/lview_debug';\n import {createTNode, createTView} from '@angular/core/src/render3/instructions/shared';\n+import {MONKEY_PATCH_KEY_NAME} from '@angular/core/src/render3/interfaces/context';\n import {TNodeType} from '@angular/core/src/render3/interfaces/node';\n-import {LView, TView, TViewType} from '@angular/core/src/render3/interfaces/view';\n+import {LView, LViewDebug, TView, TViewType} from '@angular/core/src/render3/interfaces/view';\n import {enterView, leaveView} from '@angular/core/src/render3/state';\n import {insertTStylingBinding} from '@angular/core/src/render3/styling/style_binding_list';\n+import {getComponentLView} from '@angular/core/src/render3/util/discovery_utils';\n import {KeyValueArray} from '@angular/core/src/util/array_utils';\n+import {TestBed} from '@angular/core/testing';\n import {TemplateFixture} from '../render_util';\n \n describe('lView_debug', () => {\n@@ -239,4 +243,62 @@ describe('lView_debug', () => {\n       });\n     });\n   });\n+\n+  describe('debugNodeInjectorPath', () => {\n+    @Injectable()\n+    class MyService {\n+    }\n+\n+    @Injectable()\n+    class OtherService {\n+    }\n+\n+    @Component({\n+      selector: 'parent',\n+      template: `Parent: [<child></child>]`,\n+      providers: [MyService],\n+    })\n+    class ParentComponent {\n+    }\n+    @Component({\n+      selector: 'child',\n+      template: `<b>Child!</b>`,\n+      providers: [OtherService],\n+    })\n+    class ChildComponent {\n+      constructor(private myService: MyService, private otherService: OtherService) {}\n+    }\n+\n+    it('should display injection path', () => {\n+      expect(ngDevMode).toBeTruthy();\n+      TestBed.configureTestingModule({declarations: [ParentComponent, ChildComponent]});\n+      const parentFixture = TestBed.createComponent(ParentComponent);\n+      const parentHostElement = parentFixture.nativeElement as HTMLElement;\n+      const childElement = parentHostElement.querySelector('child')! as HTMLElement;\n+      if (!(childElement as any)[MONKEY_PATCH_KEY_NAME]) {\n+        // In these browsers:\n+        //  - Chrome Mobile 72.0.3626 (Android 0.0.0)\n+        //  - IE 11.0.0 (Windows 8.1.0.0)\n+        // Retrieving `LContext` does not work for unknown reasons, and we are unable to debug it.\n+        // Exiting tests early to prevent breaking the test suite.\n+        return;\n+      }\n+      const childLViewDebug = getComponentLView(childElement).debug!;\n+      const parentLViewDebug = childLViewDebug.parent as LViewDebug;\n+      const rootLViewDebug = parentLViewDebug.parent! as LViewDebug;\n+      const childRootNode = childLViewDebug.nodes[0];\n+      expect(childRootNode.injector.bloom).toEqual('NO_NODE_INJECTOR');\n+      expect(childRootNode.injector.cumulativeBloom).toEqual('NO_NODE_INJECTOR');\n+      const injectorResolutionPath = childRootNode.injectorResolutionPath;\n+      expect(injectorResolutionPath.length).toEqual(2);\n+      expect(injectorResolutionPath[0].injector)\n+          .toEqual(\n+              parentLViewDebug.nodes[1].injector,\n+          );\n+      expect(injectorResolutionPath[1].injector)\n+          .toEqual(\n+              rootLViewDebug.nodes[0].injector,\n+          );\n+    });\n+  });\n });"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 98,
        "deletions": 7
    }
}