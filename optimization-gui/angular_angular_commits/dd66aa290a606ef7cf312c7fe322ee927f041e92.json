{
    "author": "AndrewKushnir",
    "message": "test(core): add micro benchmarks for i18n scenarios (#39142)\n\nThis commit adds micro benchmarks to run micro benchmarks for i18n-related logic in the\nfollowing scenarios:\n\n- i18n static attributes\n- i18n attributes with interpolations\n- i18n blocks of static text\n- i18n blocks of text + interpolations\n- simple ICUs\n- nested ICUs\n\nFirst 4 scenarios also have baseline scenarios (non-i18n) so that we can compare i18n perf with\nnon-i18n logic.\n\nPR Close #39142",
    "sha": "dd66aa290a606ef7cf312c7fe322ee927f041e92",
    "files": [
        {
            "sha": "182c1541e039eb12a8ce5145136ca5b455c3023b",
            "filename": "packages/core/src/render3/instructions/all.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fall.ts",
            "raw_url": "https://github.com/angular/angular/raw/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fall.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fall.ts?ref=dd66aa290a606ef7cf312c7fe322ee927f041e92",
            "patch": "@@ -48,3 +48,4 @@ export * from './class_map_interpolation';\n export * from './style_map_interpolation';\n export * from './style_prop_interpolation';\n export * from './host_property';\n+export * from './i18n';"
        },
        {
            "sha": "1ae2c7e5b5a18860928e450d747cc6188d16777f",
            "filename": "packages/core/src/render3/instructions/i18n.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fi18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fi18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fi18n.ts?ref=dd66aa290a606ef7cf312c7fe322ee927f041e92",
            "patch": "@@ -17,7 +17,7 @@ import {HEADER_OFFSET} from '../interfaces/view';\n import {getLView, getTView, nextBindingIndex} from '../state';\n import {getConstant} from '../util/view_utils';\n \n-import {setDelayProjection} from './all';\n+import {setDelayProjection} from './projection';\n \n /**\n  * Marks a block of text as translatable."
        },
        {
            "sha": "5e2b0401ab9ee471271d032db92b6a6cb2874930",
            "filename": "packages/core/test/render3/perf/BUILD.bazel",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2FBUILD.bazel?ref=dd66aa290a606ef7cf312c7fe322ee927f041e92",
            "patch": "@@ -230,6 +230,19 @@ ng_benchmark(\n     bundle = \":host_binding\",\n )\n \n+ng_rollup_bundle(\n+    name = \"i18n_lib\",\n+    entry_point = \":i18n/index.ts\",\n+    deps = [\n+        \":perf_lib\",\n+    ],\n+)\n+\n+ng_benchmark(\n+    name = \"i18n\",\n+    bundle = \":i18n\",\n+)\n+\n ng_rollup_bundle(\n     name = \"view_destroy_hook_lib\",\n     entry_point = \":view_destroy_hook/index.ts\","
        },
        {
            "sha": "beb6ac1c1070e063a244ebcfea6dd9200ae48787",
            "filename": "packages/core/test/render3/perf/i18n/index.ts",
            "status": "added",
            "additions": 345,
            "deletions": 0,
            "changes": 345,
            "blob_url": "https://github.com/angular/angular/blob/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fi18n%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fi18n%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fi18n%2Findex.ts?ref=dd66aa290a606ef7cf312c7fe322ee927f041e92",
            "patch": "@@ -0,0 +1,345 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ɵɵadvance, ɵɵelement, ɵɵelementEnd, ɵɵelementStart, ɵɵi18n, ɵɵi18nApply, ɵɵi18nAttributes, ɵɵi18nExp, ɵɵpropertyInterpolate1, ɵɵtext, ɵɵtextInterpolate1} from '../../../../src/render3/instructions/all';\n+import {ComponentTemplate, RenderFlags} from '../../../../src/render3/interfaces/definition';\n+import {AttributeMarker, TAttributes} from '../../../../src/render3/interfaces/node';\n+import {Benchmark, createBenchmark} from '../micro_bench';\n+import {MicroBenchmarkRenderNode} from '../noop_renderer';\n+import {setupTestHarness} from '../setup';\n+\n+type ComponentDef = {\n+  consts: (string|TAttributes)[],\n+  vars: number,\n+  decls: number,\n+  template: ComponentTemplate<any>,\n+  beforeCD?: Function,\n+  DOMParserMockFn?: Function,\n+};\n+\n+const enum NodeTypes {\n+  ELEMENT_NODE = 1,\n+  TEXT_NODE = 2,\n+  COMMENT_NODE = 8\n+}\n+\n+function createElement(nodeType: number, tagName?: string): any {\n+  const element = new MicroBenchmarkRenderNode();\n+  element.nodeType = nodeType;\n+  element.tagName = tagName;\n+  return element;\n+}\n+\n+// Mock function that is invoked when the string should be parsed.\n+function defaultDOMParserMockFn(content: string) {\n+  const element = createElement(NodeTypes.TEXT_NODE);\n+  element.textContent = content;\n+  return element;\n+}\n+\n+function createDOMParserMock(mockFn: Function) {\n+  return {\n+    parseFromString: (content: string) => {\n+      const body = createElement(NodeTypes.ELEMENT_NODE, 'body');\n+      content = content.replace(/<body><remove><\\/remove>/, '');\n+      body.firstChild = mockFn(content);\n+      return {body};\n+    },\n+  };\n+}\n+\n+function setupDOMParserMock(mockFn?: Function): Function {\n+  const glob = global as any;\n+  if (!glob.window) {\n+    glob.window = {};\n+  }\n+  const origDOMParser = glob.window.DOMParser;\n+  glob.window.DOMParser = function() {\n+    return createDOMParserMock(mockFn || defaultDOMParserMockFn);\n+  };\n+\n+  // Return a function that would restore DOMParser to its original state.\n+  return () => glob.window.DOMParser = origDOMParser;\n+}\n+\n+\n+const PROFILE_CREATE = true;\n+const PROFILE_UPDATE = true;\n+const NUM_OF_VIEWS_PER_RUN = 1000;\n+const DEFAULT_CONTEXT: any = {\n+  title: 'Test title',\n+  interpolation: 'Test interpolation',\n+  count: 0\n+};\n+\n+let context = DEFAULT_CONTEXT;\n+const benchmarks: Benchmark[] = [];\n+\n+function benchmark(name: string, def: ComponentDef, baselineDef?: ComponentDef) {\n+  // Reset context in case it was changed in `beforeCD` function during the previous benchmark.\n+  context = DEFAULT_CONTEXT;\n+\n+  const teardownDOMParserMock = setupDOMParserMock(def.DOMParserMockFn);\n+\n+  const ivyHarness = setupTestHarness(\n+      def.template, def.decls, def.vars, NUM_OF_VIEWS_PER_RUN, context,\n+      def.consts as TAttributes[]);\n+\n+  let baseHarness;\n+  if (baselineDef) {\n+    baseHarness = setupTestHarness(\n+        baselineDef.template, baselineDef.decls, baselineDef.vars, NUM_OF_VIEWS_PER_RUN, context,\n+        baselineDef.consts as TAttributes[]);\n+  }\n+\n+  if (PROFILE_CREATE) {\n+    const benchmark = createBenchmark('i18n [create]: ' + name);\n+    benchmarks.push(benchmark);\n+    const ivyProfile = benchmark('(i18n)');\n+    console.profile(benchmark.name + ':' + ivyProfile.name);\n+    while (ivyProfile()) {\n+      ivyHarness.createEmbeddedLView();\n+    }\n+    console.profileEnd();\n+\n+    if (baseHarness) {\n+      const baseProfile = benchmark('(baseline)');\n+      console.profile(benchmark.name + ':' + baseProfile.name);\n+      while (baseProfile()) {\n+        baseHarness.createEmbeddedLView();\n+      }\n+      console.profileEnd();\n+    }\n+  }\n+\n+  if (PROFILE_UPDATE) {\n+    const benchmark = createBenchmark('i18n [update]: : ' + name);\n+    benchmarks.push(benchmark);\n+    const ivyProfile = benchmark('(i18n)');\n+    console.profile(benchmark.name + ':' + ivyProfile.name);\n+    while (ivyProfile()) {\n+      if (def.beforeCD) {\n+        def.beforeCD(context);\n+      }\n+      ivyHarness.detectChanges();\n+    }\n+    console.profileEnd();\n+\n+    if (baseHarness) {\n+      const baseProfile = benchmark('(baseline)');\n+      console.profile(benchmark.name + ':' + baseProfile.name);\n+      while (baseProfile()) {\n+        if (baselineDef && baselineDef.beforeCD) {\n+          baselineDef.beforeCD(context);\n+        }\n+        baseHarness.detectChanges();\n+      }\n+      console.profileEnd();\n+    }\n+  }\n+\n+  teardownDOMParserMock();\n+}\n+\n+benchmark(\n+    `Static attributes`,\n+\n+    // <div i18n-title title=\"Test Title\"></div>\n+    {\n+      decls: 2,\n+      vars: 0,\n+      consts: [[AttributeMarker.I18n, 'title'], ['title', 'Test Title']],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelementStart(0, 'div', 0);\n+          ɵɵi18nAttributes(1, 1);\n+          ɵɵelementEnd();\n+        }\n+      }\n+    },\n+\n+    // <div title=\"Test Title\"></div>\n+    {\n+      decls: 2,\n+      vars: 0,\n+      consts: [['title', 'Test Title']],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelement(0, 'div', 0);\n+        }\n+      }\n+    });\n+\n+benchmark(\n+    `Attributes with interpolations`,\n+\n+    // <div i18n-title title=\"Test {{ title }}\"></div>\n+    {\n+      decls: 2,\n+      vars: 1,\n+      consts: [[AttributeMarker.I18n, 'title'], ['title', 'Test �0�']],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelementStart(0, 'div', 0);\n+          ɵɵi18nAttributes(1, 1);\n+          ɵɵelementEnd();\n+        }\n+        if (rf & 2) {\n+          ɵɵi18nExp(ctx.title);\n+          ɵɵi18nApply(1);\n+        }\n+      }\n+    },\n+\n+    // <div title=\"Test {{ title }}\"></div>\n+    {\n+      decls: 2,\n+      vars: 1,\n+      consts: [[AttributeMarker.Bindings, 'title']],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelement(0, 'div', 0);\n+        }\n+        if (rf & 2) {\n+          ɵɵpropertyInterpolate1('title', 'Test ', ctx.title, '');\n+        }\n+      }\n+    });\n+\n+benchmark(\n+    `Block of static text`,\n+\n+    // <div i18n>Some text content</div>\n+    {\n+      decls: 2,\n+      vars: 0,\n+      consts: ['Some text content'],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelementStart(0, 'div');\n+          ɵɵi18n(1, 0);\n+          ɵɵelementEnd();\n+        }\n+      }\n+    },\n+\n+    // <div>Some text content</div>\n+    {\n+      decls: 2,\n+      vars: 0,\n+      consts: [],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelementStart(0, 'div');\n+          ɵɵtext(1, 'Some text content');\n+          ɵɵelementEnd();\n+        }\n+      }\n+    });\n+\n+benchmark(\n+    `Block of text with interpolation`,\n+\n+    // <div i18n>Some text content with {{ interpolation }}</div>\n+    {\n+      decls: 2,\n+      vars: 1,\n+      consts: ['Some text content with �0�'],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelementStart(0, 'div');\n+          ɵɵi18n(1, 0);\n+          ɵɵelementEnd();\n+        }\n+        if (rf & 2) {\n+          ɵɵadvance(1);\n+          ɵɵi18nExp(ctx.interpolation);\n+          ɵɵi18nApply(1);\n+        }\n+      }\n+    },\n+\n+    // <div>Some text content with {{ interpolation }}</div>\n+    {\n+      decls: 2,\n+      vars: 1,\n+      consts: [],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵelementStart(0, 'div');\n+          ɵɵtext(1);\n+          ɵɵelementEnd();\n+        }\n+        if (rf & 2) {\n+          ɵɵadvance(1);\n+          ɵɵtextInterpolate1('Some text content with ', ctx.interpolation, '');\n+        }\n+      }\n+    });\n+\n+benchmark(\n+    `Simple ICU`,\n+\n+    // {count, plural, =1 {one} =2 {two} other {other}}\n+    {\n+      decls: 1,\n+      vars: 1,\n+      consts: ['{�0�, plural, =1 {one} =2 {two} other {other}}'],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵi18n(0, 0);\n+        }\n+        if (rf & 2) {\n+          ɵɵi18nExp(ctx.count);\n+          ɵɵi18nApply(0);\n+        }\n+      },\n+      beforeCD: function(ctx: any) {\n+        // Switch values between [0, 1, 2] to trigger different ICU cases.\n+        ctx.count = (ctx.count + 1) % 3;\n+      },\n+    });\n+\n+benchmark(\n+    `Nested ICUs`,\n+\n+    // {count, plural,\n+    //    =1 {one}\n+    //    =2 {two}\n+    //    other { {count, plural, =0 {zero} other {other}} }}\n+    {\n+      decls: 1,\n+      vars: 2,\n+      consts: ['{�0�, plural, =1 {one} =2 {two} other { {�0�, plural, =0 {zero} other {other}} }}'],\n+      template: function(rf: RenderFlags, ctx: any) {\n+        if (rf & 1) {\n+          ɵɵi18n(0, 0);\n+        }\n+        if (rf & 2) {\n+          ɵɵi18nExp(ctx.count)(ctx.count);\n+          ɵɵi18nApply(0);\n+        }\n+      },\n+      beforeCD: function(ctx: any) {\n+        // Switch values between [0, 1, 2] to trigger different ICU cases.\n+        ctx.count = (ctx.count + 1) % 3;\n+      },\n+      DOMParserMockFn: (content: string) => {\n+        content = content.trim();\n+        // Nested ICUs are represented as comment nodes. If we come across one - create an element\n+        // with correct node type, otherwise - call default mock fn.\n+        if (content.startsWith('<!--')) {\n+          const element = createElement(NodeTypes.COMMENT_NODE);\n+          element.textContent = content;\n+          return element;\n+        }\n+        return defaultDOMParserMockFn(content);\n+      }\n+    });\n+\n+benchmarks.forEach(b => b.report());"
        },
        {
            "sha": "4d0c58d20b8f94d0f51d94b36d5236f754706ce3",
            "filename": "packages/core/test/render3/perf/noop_renderer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fnoop_renderer.ts",
            "raw_url": "https://github.com/angular/angular/raw/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fnoop_renderer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fnoop_renderer.ts?ref=dd66aa290a606ef7cf312c7fe322ee927f041e92",
            "patch": "@@ -8,6 +8,8 @@\n import {ProceduralRenderer3, RComment, RElement, Renderer3, RendererFactory3, RendererStyleFlags3, RNode, RText} from '../../../src/render3/interfaces/renderer';\n \n export class MicroBenchmarkRenderNode implements RNode, RComment, RText {\n+  tagName?: string;\n+  nodeType?: number;\n   textContent: string|null = null;\n   parentNode: RNode|null = null;\n   parentElement: RElement|null = null;\n@@ -43,7 +45,7 @@ export class MicroBenchmarkRenderer implements ProceduralRenderer3 {\n     throw new Error('Method not implemented.');\n   }\n   parentNode(node: RNode): RElement|null {\n-    throw new Error('Method not implemented.');\n+    return null;\n   }\n   nextSibling(node: RNode): RNode|null {\n     throw new Error('Method not implemented.');"
        },
        {
            "sha": "58c21e9e2225abddb93412ca1022074c532b9362",
            "filename": "packages/core/test/render3/perf/profile_in_browser.html",
            "status": "modified",
            "additions": 23,
            "deletions": 16,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fprofile_in_browser.html",
            "raw_url": "https://github.com/angular/angular/raw/dd66aa290a606ef7cf312c7fe322ee927f041e92/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fprofile_in_browser.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Fprofile_in_browser.html?ref=dd66aa290a606ef7cf312c7fe322ee927f041e92",
            "patch": "@@ -1,18 +1,25 @@\n <html>\n-  <script>\n-   let BASE = location.toString().split('packages/core/test/render3/perf')[0]\n-   let BENCHMARK = location.search.split('=')[1];\n-   document.writeln('<' + 'script src=\"' + BASE + '/dist/bin/packages/core/test/render3/perf/' + BENCHMARK + '.min_debug.js\"></' + 'script>');\n-  </script>\n-  <body>\n-    <ol>\n-      <li>Build the benchmark using <tt>yarn bazel build //packages/core/test/render3/perf:${BENCHMARK}.min_debug.js --config=ivy</tt></li>\n-      <li>Open this file using the <tt>file://</tt> protocol and add <tt>?benchmark=BENCHMARK</tt> to the URL.</li>\n-      <li>\n-        Note: You should likely run this in an incognito browser with the \"no-turbo-inlining\" flag.<br />\n-        On Chrome, the command would be <code>/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome -incognito --js-flags=\"--no-turbo-inlining\"</code>\n-      </li>\n-      <li>Open debug console for details. Benchmark profiles are available in the \"JavaScript Profiler\" tab of Chrome DevTools.</li>\n-    </ol>\n-  </body>\n+<script>\n+  let BASE = location.toString().split('packages/core/test/render3/perf')[0]\n+  let BENCHMARK = location.search.split('=')[1];\n+  document.writeln('<' + 'script src=\"' + BASE + '/dist/bin/packages/core/test/render3/perf/' + BENCHMARK +\n+    '_lib.min_debug.js\"></' + 'script>');\n+\n+</script>\n+\n+<body>\n+  <ol>\n+    <li>Build the benchmark using <tt>yarn bazel build //packages/core/test/render3/perf:${BENCHMARK}.min_debug.js\n+        --config=ivy</tt></li>\n+    <li>Open this file using the <tt>file://</tt> protocol and add <tt>?benchmark=BENCHMARK</tt> to the URL.</li>\n+    <li>\n+      Note: You should likely run this in an incognito browser with the \"no-turbo-inlining\" flag.<br />\n+      On Chrome, the command would be <code>/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome -incognito\n+        --js-flags=\"--no-turbo-inlining\"</code>\n+    </li>\n+    <li>Open debug console for details. Benchmark profiles are available in the \"JavaScript Profiler\" tab of Chrome\n+      DevTools.</li>\n+  </ol>\n+</body>\n+\n </html>"
        }
    ],
    "stats": {
        "total": 404,
        "additions": 386,
        "deletions": 18
    }
}