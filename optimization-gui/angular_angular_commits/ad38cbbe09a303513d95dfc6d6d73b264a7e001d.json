{
    "author": "atscott",
    "message": "perf(language-service): Skip Angular analysis when quick info requested outside a template (#40956)\n\nThe Angular LS does not provide quick info when the given position is not\ninside a template. As an optimization, we can quickly look at the\nfile and determine if we are at a position that is part of an Angular\ntemplate. If not, we bail before asking the compiler for any more\ninformation. Note that the Angular LS _already_ provides no quick info\nwhen outside a template file, but currently asks the compiler to analyze\nthe program before it determines that information.\n\nPR Close #40956",
    "sha": "ad38cbbe09a303513d95dfc6d6d73b264a7e001d",
    "files": [
        {
            "sha": "eaf6113fd0512c6f40cdecbfe5b23397506b8485",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 18,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/ad38cbbe09a303513d95dfc6d6d73b264a7e001d/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/ad38cbbe09a303513d95dfc6d6d73b264a7e001d/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=ad38cbbe09a303513d95dfc6d6d73b264a7e001d",
            "patch": "@@ -96,25 +96,28 @@ export class LanguageService {\n   }\n \n   getQuickInfoAtPosition(fileName: string, position: number): ts.QuickInfo|undefined {\n-    const compiler = this.compilerFactory.getOrCreate();\n-    const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n-    if (templateInfo === undefined) {\n-      return undefined;\n-    }\n-    const positionDetails = getTargetAtPosition(templateInfo.template, position);\n-    if (positionDetails === null) {\n-      return undefined;\n-    }\n+    return this.withCompiler((compiler) => {\n+      if (!isTemplateContext(compiler.getNextProgram(), fileName, position)) {\n+        return undefined;\n+      }\n \n-    // Because we can only show 1 quick info, just use the bound attribute if the target is a two\n-    // way binding. We may consider concatenating additional display parts from the other target\n-    // nodes or representing the two way binding in some other manner in the future.\n-    const node = positionDetails.context.kind === TargetNodeKind.TwoWayBindingContext ?\n-        positionDetails.context.nodes[0] :\n-        positionDetails.context.node;\n-    const results = new QuickInfoBuilder(this.tsLS, compiler, templateInfo.component, node).get();\n-    this.compilerFactory.registerLastKnownProgram();\n-    return results;\n+      const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n+      if (templateInfo === undefined) {\n+        return undefined;\n+      }\n+      const positionDetails = getTargetAtPosition(templateInfo.template, position);\n+      if (positionDetails === null) {\n+        return undefined;\n+      }\n+\n+      // Because we can only show 1 quick info, just use the bound attribute if the target is a two\n+      // way binding. We may consider concatenating additional display parts from the other target\n+      // nodes or representing the two way binding in some other manner in the future.\n+      const node = positionDetails.context.kind === TargetNodeKind.TwoWayBindingContext ?\n+          positionDetails.context.nodes[0] :\n+          positionDetails.context.node;\n+      return new QuickInfoBuilder(this.tsLS, compiler, templateInfo.component, node).get();\n+    });\n   }\n \n   getReferencesAtPosition(fileName: string, position: number): ts.ReferenceEntry[]|undefined {"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 21,
        "deletions": 18
    }
}