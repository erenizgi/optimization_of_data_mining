{
    "author": "josephperrott",
    "message": "fix(dev-infra): use the version from package.json rather than tags (#42872)\n\nUse the version value from the primary package.json file rather than\nchecking the branch for the latest semver tag.  This allows for us\nto explictly create changelogs from the previous version to the new\nversion.\n\nPR Close #42872",
    "sha": "282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
    "files": [
        {
            "sha": "aad38435104ac53341eb50fc5638e277617e8508",
            "filename": "dev-infra/build-worker.js",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Fbuild-worker.js",
            "raw_url": "https://github.com/angular/angular/raw/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Fbuild-worker.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbuild-worker.js?ref=282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
            "patch": "@@ -262,6 +262,16 @@ var GitClient = /** @class */ (function () {\n         }\n         return new semver.SemVer(latestTag, semVerOptions);\n     };\n+    /** Retrieves the git tag matching the provided SemVer, if it exists. */\n+    GitClient.prototype.getMatchingTagForSemver = function (semver$1) {\n+        var semVerOptions = { loose: true };\n+        var tags = this.runGraceful(['tag', '--sort=-committerdate', '--merged']).stdout.split('\\n');\n+        var matchingTag = tags.find(function (tag) { var _a; return ((_a = semver.parse(tag, semVerOptions)) === null || _a === void 0 ? void 0 : _a.compare(semver$1)) === 0; });\n+        if (matchingTag === undefined) {\n+            throw new Error(\"Unable to find a tag for the version: \\\"\" + semver$1.format() + \"\\\"\");\n+        }\n+        return matchingTag;\n+    };\n     /** Retrieve a list of all files in the repository changed since the provided shaOrRef. */\n     GitClient.prototype.allChangesFilesSince = function (shaOrRef) {\n         if (shaOrRef === void 0) { shaOrRef = 'HEAD'; }"
        },
        {
            "sha": "7b7c2fb3d85c3425109b99a58a3f1b4e0484ad4e",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
            "patch": "@@ -434,6 +434,16 @@ var GitClient = /** @class */ (function () {\n         }\n         return new semver.SemVer(latestTag, semVerOptions);\n     };\n+    /** Retrieves the git tag matching the provided SemVer, if it exists. */\n+    GitClient.prototype.getMatchingTagForSemver = function (semver$1) {\n+        var semVerOptions = { loose: true };\n+        var tags = this.runGraceful(['tag', '--sort=-committerdate', '--merged']).stdout.split('\\n');\n+        var matchingTag = tags.find(function (tag) { var _a; return ((_a = semver.parse(tag, semVerOptions)) === null || _a === void 0 ? void 0 : _a.compare(semver$1)) === 0; });\n+        if (matchingTag === undefined) {\n+            throw new Error(\"Unable to find a tag for the version: \\\"\" + semver$1.format() + \"\\\"\");\n+        }\n+        return matchingTag;\n+    };\n     /** Retrieve a list of all files in the repository changed since the provided shaOrRef. */\n     GitClient.prototype.allChangesFilesSince = function (shaOrRef) {\n         if (shaOrRef === void 0) { shaOrRef = 'HEAD'; }\n@@ -6423,6 +6433,14 @@ class ReleaseAction {\n     static isActive(_trains, _config) {\n         throw Error('Not implemented.');\n     }\n+    /** Retrieves the version in the project top-level `package.json` file. */\n+    getProjectVersion() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            const pkgJsonPath = path.join(this.projectDir, packageJsonPath);\n+            const pkgJson = JSON.parse(yield fs.promises.readFile(pkgJsonPath, 'utf8'));\n+            return new semver.SemVer(pkgJson.version);\n+        });\n+    }\n     /** Updates the version in the project top-level `package.json` file. */\n     updateProjectVersion(newVersion) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n@@ -6676,7 +6694,12 @@ class ReleaseAction {\n      */\n     stageVersionForBranchAndCreatePullRequest(newVersion, pullRequestBaseBranch) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n-            const releaseNotes = yield ReleaseNotes.fromRange(newVersion, this.git.getLatestSemverTag().format(), 'HEAD');\n+            /**\n+             * The current version of the project for the branch from the root package.json. This must be\n+             * retrieved prior to updating the project version.\n+             */\n+            const currentVersion = this.git.getMatchingTagForSemver(yield this.getProjectVersion());\n+            const releaseNotes = yield ReleaseNotes.fromRange(newVersion, currentVersion, 'HEAD');\n             yield this.updateProjectVersion(newVersion);\n             yield this.prependReleaseNotesToChangelog(releaseNotes);\n             yield this.waitForEditsAndCreateReleaseCommit(newVersion);"
        },
        {
            "sha": "aa312a9a967c62277959aaa777edb0a65274d36c",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
            "patch": "@@ -80,6 +80,14 @@ export abstract class ReleaseAction {\n       protected active: ActiveReleaseTrains, protected git: AuthenticatedGitClient,\n       protected config: ReleaseConfig, protected projectDir: string) {}\n \n+  /** Retrieves the version in the project top-level `package.json` file. */\n+  private async getProjectVersion() {\n+    const pkgJsonPath = join(this.projectDir, packageJsonPath);\n+    const pkgJson =\n+        JSON.parse(await fs.readFile(pkgJsonPath, 'utf8')) as {version: string, [key: string]: any};\n+    return new semver.SemVer(pkgJson.version);\n+  }\n+\n   /** Updates the version in the project top-level `package.json` file. */\n   protected async updateProjectVersion(newVersion: semver.SemVer) {\n     const pkgJsonPath = join(this.projectDir, packageJsonPath);\n@@ -351,8 +359,12 @@ export abstract class ReleaseAction {\n   protected async stageVersionForBranchAndCreatePullRequest(\n       newVersion: semver.SemVer, pullRequestBaseBranch: string):\n       Promise<{releaseNotes: ReleaseNotes, pullRequest: PullRequest}> {\n-    const releaseNotes =\n-        await ReleaseNotes.fromRange(newVersion, this.git.getLatestSemverTag().format(), 'HEAD');\n+    /**\n+     * The current version of the project for the branch from the root package.json. This must be\n+     * retrieved prior to updating the project version.\n+     */\n+    const currentVersion = this.git.getMatchingTagForSemver(await this.getProjectVersion());\n+    const releaseNotes = await ReleaseNotes.fromRange(newVersion, currentVersion, 'HEAD');\n     await this.updateProjectVersion(newVersion);\n     await this.prependReleaseNotesToChangelog(releaseNotes);\n     await this.waitForEditsAndCreateReleaseCommit(newVersion);"
        },
        {
            "sha": "3681e3c2c0290c534aa67232eb16df433ef61376",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
            "patch": "@@ -108,7 +108,7 @@ export function setupReleaseActionForTesting<T extends ReleaseAction>(\n   // Create an empty changelog and a `package.json` file so that file system\n   // interactions with the project directory do not cause exceptions.\n   writeFileSync(join(testTmpDir, 'CHANGELOG.md'), 'Existing changelog');\n-  writeFileSync(join(testTmpDir, 'package.json'), JSON.stringify({version: 'unknown'}));\n+  writeFileSync(join(testTmpDir, 'package.json'), JSON.stringify({version: '0.0.0'}));\n \n   // Override the default pull request wait interval to a number of milliseconds that can be\n   // awaited in Jasmine tests. The default interval of 10sec is too large and causes a timeout."
        },
        {
            "sha": "eab11db98700819f8c03fa30ca4e1887026eaa83",
            "filename": "dev-infra/utils/git/git-client.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Futils%2Fgit%2Fgit-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Futils%2Fgit%2Fgit-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgit-client.ts?ref=282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
            "patch": "@@ -162,6 +162,19 @@ export class GitClient {\n     return new SemVer(latestTag, semVerOptions);\n   }\n \n+  /** Retrieves the git tag matching the provided SemVer, if it exists. */\n+  getMatchingTagForSemver(semver: SemVer): string {\n+    const semVerOptions: SemVerOptions = {loose: true};\n+    const tags = this.runGraceful(['tag', '--sort=-committerdate', '--merged']).stdout.split('\\n');\n+    const matchingTag =\n+        tags.find((tag: string) => parse(tag, semVerOptions)?.compare(semver) === 0);\n+\n+    if (matchingTag === undefined) {\n+      throw new Error(`Unable to find a tag for the version: \"${semver.format()}\"`);\n+    }\n+    return matchingTag;\n+  }\n+\n   /** Retrieve a list of all files in the repository changed since the provided shaOrRef. */\n   allChangesFilesSince(shaOrRef = 'HEAD'): string[] {\n     return Array.from(new Set(["
        },
        {
            "sha": "17202127c2e233e051325d8e1b991f128c85d9da",
            "filename": "dev-infra/utils/testing/virtual-git-client.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/282e86ad710647bf6516f5ee7bff5cc5d8a9144d/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts?ref=282e86ad710647bf6516f5ee7bff5cc5d8a9144d",
            "patch": "@@ -82,6 +82,14 @@ export class VirtualGitClient extends AuthenticatedGitClient {\n     return new SemVer('0.0.0');\n   }\n \n+  /**\n+   * Override the actual GitClient getLatestSemverTag, as an actual tags cannot be checked during\n+   * testing, return back the SemVer version as the tag.\n+   */\n+  override getMatchingTagForSemver(semver: SemVer) {\n+    return semver.format();\n+  }\n+\n   /** Override for the actual Git client command execution. */\n   override runGraceful(args: string[], options: SpawnSyncOptions = {}): SpawnSyncReturns<string> {\n     const [command, ...rawArgs] = args;"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 70,
        "deletions": 4
    }
}