{
    "author": "josephperrott",
    "message": "feat(dev-infra): Set up new common release notes generation tooling (#41905)\n\nEnables the new common release notes generation within the ng-dev release publishing\ntooling.\n\nPR Close #41905",
    "sha": "393ce94718cccf3d69fff44cb509ab487d61f3de",
    "files": [
        {
            "sha": "dd7ed545d401954e4440f9476c913903f8c3d111",
            "filename": "dev-infra/build-worker.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Fbuild-worker.js",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Fbuild-worker.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbuild-worker.js?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -691,8 +691,8 @@ function getReleaseConfig(config = getConfig()) {\n     if (((_b = config.release) === null || _b === void 0 ? void 0 : _b.buildPackages) === undefined) {\n         errors.push(`No \"buildPackages\" function configured for releasing.`);\n     }\n-    if (((_c = config.release) === null || _c === void 0 ? void 0 : _c.generateReleaseNotesForHead) === undefined) {\n-        errors.push(`No \"generateReleaseNotesForHead\" function configured for releasing.`);\n+    if (((_c = config.release) === null || _c === void 0 ? void 0 : _c.releaseNotes) === undefined) {\n+        errors.push(`No \"releaseNotes\" configured for releasing.`);\n     }\n     assertNoErrors(errors);\n     return config.release;"
        },
        {
            "sha": "9f95925b634f40b00adcaada4dac55565cdd1381",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 217,
            "deletions": 100,
            "changes": 317,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -25,7 +25,7 @@ var os = require('os');\n var shelljs = require('shelljs');\n var minimatch = require('minimatch');\n var ora = require('ora');\n-require('ejs');\n+var ejs = require('ejs');\n var glob = require('glob');\n var ts = require('typescript');\n \n@@ -647,6 +647,17 @@ function promptConfirm(message, defaultValue) {\n         });\n     });\n }\n+/** Prompts the user for one line of input. */\n+function promptInput(message) {\n+    return tslib.__awaiter(this, void 0, void 0, function () {\n+        return tslib.__generator(this, function (_a) {\n+            switch (_a.label) {\n+                case 0: return [4 /*yield*/, inquirer.prompt({ type: 'input', name: 'result', message: message })];\n+                case 1: return [2 /*return*/, (_a.sent()).result];\n+            }\n+        });\n+    });\n+}\n /**\n  * Supported levels for logging functions.\n  *\n@@ -5108,8 +5119,8 @@ function getReleaseConfig(config = getConfig()) {\n     if (((_b = config.release) === null || _b === void 0 ? void 0 : _b.buildPackages) === undefined) {\n         errors.push(`No \"buildPackages\" function configured for releasing.`);\n     }\n-    if (((_c = config.release) === null || _c === void 0 ? void 0 : _c.generateReleaseNotesForHead) === undefined) {\n-        errors.push(`No \"generateReleaseNotesForHead\" function configured for releasing.`);\n+    if (((_c = config.release) === null || _c === void 0 ? void 0 : _c.releaseNotes) === undefined) {\n+        errors.push(`No \"releaseNotes\" configured for releasing.`);\n     }\n     assertNoErrors(errors);\n     return config.release;\n@@ -5742,21 +5753,183 @@ function isCommitClosingPullRequest(api, sha, id) {\n const typesToIncludeInReleaseNotes = Object.values(COMMIT_TYPES)\n     .filter(type => type.releaseNotesLevel === ReleaseNotesLevel.Visible)\n     .map(type => type.name);\n-\n+/** Context class used for rendering release notes. */\n+class RenderContext {\n+    constructor(data) {\n+        this.data = data;\n+        /** An array of group names in sort order if defined. */\n+        this.groupOrder = this.data.groupOrder || [];\n+        /** An array of scopes to hide from the release entry output. */\n+        this.hiddenScopes = this.data.hiddenScopes || [];\n+        /** The title of the release, or `false` if no title should be used. */\n+        this.title = this.data.title;\n+        /** An array of commits in the release period. */\n+        this.commits = this.data.commits;\n+        /** The version of the release. */\n+        this.version = this.data.version;\n+        /** The date stamp string for use in the release notes entry. */\n+        this.dateStamp = buildDateStamp(this.data.date);\n+    }\n+    /**\n+     * Organizes and sorts the commits into groups of commits.\n+     *\n+     * Groups are sorted either by default `Array.sort` order, or using the provided group order from\n+     * the configuration. Commits are order in the same order within each groups commit list as they\n+     * appear in the provided list of commits.\n+     * */\n+    asCommitGroups(commits) {\n+        /** The discovered groups to organize into. */\n+        const groups = new Map();\n+        // Place each commit in the list into its group.\n+        commits.forEach(commit => {\n+            const key = commit.npmScope ? `${commit.npmScope}/${commit.scope}` : commit.scope;\n+            const groupCommits = groups.get(key) || [];\n+            groups.set(key, groupCommits);\n+            groupCommits.push(commit);\n+        });\n+        /**\n+         * Array of CommitGroups containing the discovered commit groups. Sorted in alphanumeric order\n+         * of the group title.\n+         */\n+        const commitGroups = Array.from(groups.entries())\n+            .map(([title, commits]) => ({ title, commits }))\n+            .sort((a, b) => a.title > b.title ? 1 : a.title < b.title ? -1 : 0);\n+        // If the configuration provides a sorting order, updated the sorted list of group keys to\n+        // satisfy the order of the groups provided in the list with any groups not found in the list at\n+        // the end of the sorted list.\n+        if (this.groupOrder.length) {\n+            for (const groupTitle of this.groupOrder.reverse()) {\n+                const currentIdx = commitGroups.findIndex(k => k.title === groupTitle);\n+                if (currentIdx !== -1) {\n+                    const removedGroups = commitGroups.splice(currentIdx, 1);\n+                    commitGroups.splice(0, 0, ...removedGroups);\n+                }\n+            }\n+        }\n+        return commitGroups;\n+    }\n+    /**\n+     * A filter function for filtering a list of commits to only include commits which should appear\n+     * in release notes.\n+     */\n+    includeInReleaseNotes() {\n+        return (commit) => {\n+            if (!typesToIncludeInReleaseNotes.includes(commit.type)) {\n+                return false;\n+            }\n+            if (this.hiddenScopes.includes(commit.scope)) {\n+                return false;\n+            }\n+            return true;\n+        };\n+    }\n+    /**\n+     * A filter function for filtering a list of commits to only include commits which contain a\n+     * truthy value, or for arrays an array with 1 or more elements, for the provided field.\n+     */\n+    contains(field) {\n+        return (commit) => {\n+            const fieldValue = commit[field];\n+            if (!fieldValue) {\n+                return false;\n+            }\n+            if (Array.isArray(fieldValue) && fieldValue.length === 0) {\n+                return false;\n+            }\n+            return true;\n+        };\n+    }\n+    /**\n+     * A filter function for filtering a list of commits to only include commits which contain a\n+     * unique value for the provided field across all commits in the list.\n+     */\n+    unique(field) {\n+        const set = new Set();\n+        return (commit) => {\n+            const include = !set.has(commit[field]);\n+            set.add(commit[field]);\n+            return include;\n+        };\n+    }\n+}\n /**\n- * Gets the default pattern for extracting release notes for the given version.\n- * This pattern matches for the conventional-changelog Angular preset.\n+ * Builds a date stamp for stamping in release notes.\n+ *\n+ * Uses the current date, or a provided date in the format of YYYY-MM-DD, i.e. 1970-11-05.\n  */\n-function getDefaultExtractReleaseNotesPattern(version) {\n-    const escapedVersion = version.format().replace('.', '\\\\.');\n-    // TODO: Change this once we have a canonical changelog generation tool. Also update this\n-    // based on the conventional-changelog version. They removed anchors in more recent versions.\n-    return new RegExp(`(<a name=\"${escapedVersion}\"></a>.*?)(?:<a name=\"|$)`, 's');\n+function buildDateStamp(date = new Date()) {\n+    const year = `${date.getFullYear()}`;\n+    const month = `${(date.getMonth() + 1)}`.padStart(2, '0');\n+    const day = `${date.getDate()}`.padStart(2, '0');\n+    return [year, month, day].join('-');\n }\n+\n /** Gets the path for the changelog file in a given project. */\n function getLocalChangelogFilePath(projectDir) {\n     return path.join(projectDir, changelogPath);\n }\n+/** Release note generation. */\n+class ReleaseNotes {\n+    constructor(version, config) {\n+        this.version = version;\n+        this.config = config;\n+        /** An instance of GitClient. */\n+        this.git = GitClient.getInstance();\n+        /** A promise resolving to a list of Commits since the latest semver tag on the branch. */\n+        this.commits = getCommitsInRange(this.git.getLatestSemverTag().format(), 'HEAD');\n+    }\n+    /** Construct a release note generation instance. */\n+    static fromLatestTagToHead(version, config) {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return new ReleaseNotes(version, config);\n+        });\n+    }\n+    /** Retrieve the release note generated for a Github Release. */\n+    getGithubReleaseEntry() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return ejs.renderFile(path.join(__dirname, 'templates/github-release.ejs'), yield this.generateRenderContext(), { rmWhitespace: true });\n+        });\n+    }\n+    /** Retrieve the release note generated for a CHANGELOG entry. */\n+    getChangelogEntry() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return ejs.renderFile(path.join(__dirname, 'templates/changelog.ejs'), yield this.generateRenderContext(), { rmWhitespace: true });\n+        });\n+    }\n+    /**\n+     * Prompt the user for a title for the release, if the project's configuration is defined to use a\n+     * title.\n+     */\n+    promptForReleaseTitle() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            if (this.title === undefined) {\n+                if (this.config.releaseNotes.useReleaseTitle) {\n+                    this.title = yield promptInput('Please provide a title for the release:');\n+                }\n+                else {\n+                    this.title = false;\n+                }\n+            }\n+            return this.title;\n+        });\n+    }\n+    /** Build the render context data object for constructing the RenderContext instance. */\n+    generateRenderContext() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            if (!this.renderContext) {\n+                this.renderContext = new RenderContext({\n+                    commits: yield this.commits,\n+                    github: this.git.remoteConfig,\n+                    version: this.version.format(),\n+                    groupOrder: this.config.releaseNotes.groupOrder,\n+                    hiddenScopes: this.config.releaseNotes.hiddenScopes,\n+                    title: yield this.promptForReleaseTitle(),\n+                });\n+            }\n+            return this.renderContext;\n+        });\n+    }\n+}\n \n /**\n  * @license\n@@ -5831,22 +6004,6 @@ class ReleaseAction {\n             info(green('  ✓   Upstream commit is passing all github status checks.'));\n         });\n     }\n-    /** Generates the changelog for the specified for the current `HEAD`. */\n-    _generateReleaseNotesForHead(version) {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            const changelogPath = getLocalChangelogFilePath(this.projectDir);\n-            yield this.config.generateReleaseNotesForHead(changelogPath);\n-            info(green(`  ✓   Updated the changelog to capture changes for \"${version}\".`));\n-        });\n-    }\n-    /** Extract the release notes for the given version from the changelog file. */\n-    _extractReleaseNotesForVersion(changelogContent, version) {\n-        const pattern = this.config.extractReleaseNotesPattern !== undefined ?\n-            this.config.extractReleaseNotesPattern(version) :\n-            getDefaultExtractReleaseNotesPattern(version);\n-        const matchedNotes = pattern.exec(changelogContent);\n-        return matchedNotes === null ? null : matchedNotes[1];\n-    }\n     /**\n      * Prompts the user for potential release notes edits that need to be made. Once\n      * confirmed, a new commit for the release point is created.\n@@ -6019,27 +6176,13 @@ class ReleaseAction {\n      * the current Git `HEAD`. This is useful for cherry-picking the changelog.\n      * @returns A boolean indicating whether the release notes have been prepended.\n      */\n-    prependReleaseNotesFromVersionBranch(version, containingBranch) {\n+    prependReleaseNotesToChangelog(releaseNotes) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n-            const { data } = yield this.git.github.repos.getContents(Object.assign(Object.assign({}, this.git.remoteParams), { path: '/' + changelogPath, ref: containingBranch }));\n-            const branchChangelog = Buffer.from(data.content, 'base64').toString();\n-            let releaseNotes = this._extractReleaseNotesForVersion(branchChangelog, version);\n-            // If no release notes could be extracted, return \"false\" so that the caller\n-            // can tell that changelog prepending failed.\n-            if (releaseNotes === null) {\n-                return false;\n-            }\n             const localChangelogPath = getLocalChangelogFilePath(this.projectDir);\n             const localChangelog = yield fs.promises.readFile(localChangelogPath, 'utf8');\n-            // If the extracted release notes do not have any new lines at the end and the\n-            // local changelog is not empty, we add lines manually so that there is space\n-            // between the previous and cherry-picked release notes.\n-            if (!/[\\r\\n]+$/.test(releaseNotes) && localChangelog !== '') {\n-                releaseNotes = `${releaseNotes}\\n\\n`;\n-            }\n-            // Prepend the extracted release notes to the local changelog and write it back.\n-            yield fs.promises.writeFile(localChangelogPath, releaseNotes + localChangelog);\n-            return true;\n+            const releaseNotesEntry = yield releaseNotes.getChangelogEntry();\n+            yield fs.promises.writeFile(localChangelogPath, `${releaseNotesEntry}\\n\\n${localChangelog}`);\n+            info(green(`  ✓   Updated the changelog to capture changes for \"${releaseNotes.version}\".`));\n         });\n     }\n     /** Checks out an upstream branch with a detached head. */\n@@ -6059,39 +6202,21 @@ class ReleaseAction {\n             this.git.run(['commit', '--no-verify', '-m', message, ...files]);\n         });\n     }\n-    /**\n-     * Creates a cherry-pick commit for the release notes of the specified version that\n-     * has been pushed to the given branch.\n-     * @returns a boolean indicating whether the commit has been created successfully.\n-     */\n-    createCherryPickReleaseNotesCommitFrom(version, branchName) {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            const commitMessage = getReleaseNoteCherryPickCommitMessage(version);\n-            // Fetch, extract and prepend the release notes to the local changelog. If that is not\n-            // possible, abort so that we can ask the user to manually cherry-pick the changelog.\n-            if (!(yield this.prependReleaseNotesFromVersionBranch(version, branchName))) {\n-                return false;\n-            }\n-            // Create a changelog cherry-pick commit.\n-            yield this.createCommit(commitMessage, [changelogPath]);\n-            info(green(`  ✓   Created changelog cherry-pick commit for: \"${version}\".`));\n-            return true;\n-        });\n-    }\n     /**\n      * Stages the specified new version for the current branch and creates a\n      * pull request that targets the given base branch.\n      * @returns an object describing the created pull request.\n      */\n     stageVersionForBranchAndCreatePullRequest(newVersion, pullRequestBaseBranch) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n+            const releaseNotes = yield ReleaseNotes.fromLatestTagToHead(newVersion, this.config);\n             yield this.updateProjectVersion(newVersion);\n-            yield this._generateReleaseNotesForHead(newVersion);\n+            yield this.prependReleaseNotesToChangelog(releaseNotes);\n             yield this.waitForEditsAndCreateReleaseCommit(newVersion);\n             const pullRequest = yield this.pushChangesToForkAndCreatePullRequest(pullRequestBaseBranch, `release-stage-${newVersion}`, `Bump version to \"v${newVersion}\" with changelog.`);\n             info(green('  ✓   Release staging pull request has been created.'));\n             info(yellow(`      Please ask team members to review: ${pullRequest.url}.`));\n-            return pullRequest;\n+            return { releaseNotes, pullRequest };\n         });\n     }\n     /**\n@@ -6111,21 +6236,18 @@ class ReleaseAction {\n      * into the `next` primary development branch. A pull request is created for this.\n      * @returns a boolean indicating successful creation of the cherry-pick pull request.\n      */\n-    cherryPickChangelogIntoNextBranch(newVersion, stagingBranch) {\n+    cherryPickChangelogIntoNextBranch(releaseNotes, stagingBranch) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             const nextBranch = this.active.next.branchName;\n-            const commitMessage = getReleaseNoteCherryPickCommitMessage(newVersion);\n+            const commitMessage = getReleaseNoteCherryPickCommitMessage(releaseNotes.version);\n             // Checkout the next branch.\n             yield this.checkoutUpstreamBranch(nextBranch);\n-            // Cherry-pick the release notes into the current branch. If it fails,\n-            // ask the user to manually copy the release notes into the next branch.\n-            if (!(yield this.createCherryPickReleaseNotesCommitFrom(newVersion, stagingBranch))) {\n-                error(yellow(`  ✘   Could not cherry-pick release notes for v${newVersion}.`));\n-                error(yellow(`      Please copy the release notes manually into the \"${nextBranch}\" branch.`));\n-                return false;\n-            }\n+            yield this.prependReleaseNotesToChangelog(releaseNotes);\n+            // Create a changelog cherry-pick commit.\n+            yield this.createCommit(commitMessage, [changelogPath]);\n+            info(green(`  ✓   Created changelog cherry-pick commit for: \"${releaseNotes.version}\".`));\n             // Create a cherry-pick pull request that should be merged by the caretaker.\n-            const { url, id } = yield this.pushChangesToForkAndCreatePullRequest(nextBranch, `changelog-cherry-pick-${newVersion}`, commitMessage, `Cherry-picks the changelog from the \"${stagingBranch}\" branch to the next ` +\n+            const { url, id } = yield this.pushChangesToForkAndCreatePullRequest(nextBranch, `changelog-cherry-pick-${releaseNotes.version}`, commitMessage, `Cherry-picks the changelog from the \"${stagingBranch}\" branch to the next ` +\n                 `branch (${nextBranch}).`);\n             info(green(`  ✓   Pull request for cherry-picking the changelog into \"${nextBranch}\" ` +\n                 'has been created.'));\n@@ -6253,10 +6375,10 @@ class CutLongTermSupportPatchAction extends ReleaseAction {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             const ltsBranch = yield this._promptForTargetLtsBranch();\n             const newVersion = semverInc(ltsBranch.version, 'patch');\n-            const { id } = yield this.checkoutBranchAndStageVersion(newVersion, ltsBranch.name);\n+            const { pullRequest: { id }, releaseNotes } = yield this.checkoutBranchAndStageVersion(newVersion, ltsBranch.name);\n             yield this.waitForPullRequestToBeMerged(id);\n             yield this.buildAndPublish(newVersion, ltsBranch.name, ltsBranch.npmDistTag);\n-            yield this.cherryPickChangelogIntoNextBranch(newVersion, ltsBranch.name);\n+            yield this.cherryPickChangelogIntoNextBranch(releaseNotes, ltsBranch.name);\n         });\n     }\n     /** Prompts the user to select an LTS branch for which a patch should but cut. */\n@@ -6330,10 +6452,10 @@ class CutNewPatchAction extends ReleaseAction {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             const { branchName } = this.active.latest;\n             const newVersion = this._newVersion;\n-            const { id } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n+            const { pullRequest: { id }, releaseNotes } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n             yield this.waitForPullRequestToBeMerged(id);\n             yield this.buildAndPublish(newVersion, branchName, 'latest');\n-            yield this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+            yield this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n         });\n     }\n     static isActive(active) {\n@@ -6400,14 +6522,14 @@ class CutNextPrereleaseAction extends ReleaseAction {\n             const releaseTrain = this._getActivePrereleaseTrain();\n             const { branchName } = releaseTrain;\n             const newVersion = yield this._newVersion;\n-            const { id } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n+            const { pullRequest: { id }, releaseNotes } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n             yield this.waitForPullRequestToBeMerged(id);\n             yield this.buildAndPublish(newVersion, branchName, 'next');\n             // If the pre-release has been cut from a branch that is not corresponding\n             // to the next release-train, cherry-pick the changelog into the primary\n             // development branch. i.e. the `next` branch that is usually `master`.\n             if (releaseTrain !== this.active.next) {\n-                yield this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+                yield this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n             }\n         });\n     }\n@@ -6467,10 +6589,10 @@ class CutReleaseCandidateAction extends ReleaseAction {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             const { branchName } = this.active.releaseCandidate;\n             const newVersion = this._newVersion;\n-            const { id } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n+            const { pullRequest: { id }, releaseNotes } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n             yield this.waitForPullRequestToBeMerged(id);\n             yield this.buildAndPublish(newVersion, branchName, 'next');\n-            yield this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+            yield this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n         });\n     }\n     static isActive(active) {\n@@ -6511,7 +6633,7 @@ class CutStableAction extends ReleaseAction {\n             const { branchName } = this.active.releaseCandidate;\n             const newVersion = this._newVersion;\n             const isNewMajor = (_a = this.active.releaseCandidate) === null || _a === void 0 ? void 0 : _a.isMajor;\n-            const { id } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n+            const { pullRequest: { id }, releaseNotes } = yield this.checkoutBranchAndStageVersion(newVersion, branchName);\n             yield this.waitForPullRequestToBeMerged(id);\n             yield this.buildAndPublish(newVersion, branchName, 'latest');\n             // If a new major version is published and becomes the \"latest\" release-train, we need\n@@ -6529,7 +6651,7 @@ class CutStableAction extends ReleaseAction {\n                 yield invokeYarnInstallCommand(this.projectDir);\n                 yield invokeSetNpmDistCommand(ltsTagForPatch, previousPatch.version);\n             }\n-            yield this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+            yield this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n         });\n     }\n     /** Gets the new stable version of the release candidate release-train. */\n@@ -6581,13 +6703,13 @@ class MoveNextIntoFeatureFreezeAction extends ReleaseAction {\n             // Stage the new version for the newly created branch, and push changes to a\n             // fork in order to create a staging pull request. Note that we re-use the newly\n             // created branch instead of re-fetching from the upstream.\n-            const stagingPullRequest = yield this.stageVersionForBranchAndCreatePullRequest(newVersion, newBranch);\n+            const { pullRequest: { id }, releaseNotes } = yield this.stageVersionForBranchAndCreatePullRequest(newVersion, newBranch);\n             // Wait for the staging PR to be merged. Then build and publish the feature-freeze next\n             // pre-release. Finally, cherry-pick the release notes into the next branch in combination\n             // with bumping the version to the next minor too.\n-            yield this.waitForPullRequestToBeMerged(stagingPullRequest.id);\n+            yield this.waitForPullRequestToBeMerged(id);\n             yield this.buildAndPublish(newVersion, newBranch, 'next');\n-            yield this._createNextBranchUpdatePullRequest(newVersion, newBranch);\n+            yield this._createNextBranchUpdatePullRequest(releaseNotes, newVersion);\n         });\n     }\n     /** Creates a new version branch from the next branch. */\n@@ -6605,7 +6727,7 @@ class MoveNextIntoFeatureFreezeAction extends ReleaseAction {\n      * Creates a pull request for the next branch that bumps the version to the next\n      * minor, and cherry-picks the changelog for the newly branched-off feature-freeze version.\n      */\n-    _createNextBranchUpdatePullRequest(newVersion, newBranch) {\n+    _createNextBranchUpdatePullRequest(releaseNotes, newVersion) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             const { branchName: nextBranch, version } = this.active.next;\n             // We increase the version for the next branch to the next minor. The team can decide\n@@ -6617,18 +6739,13 @@ class MoveNextIntoFeatureFreezeAction extends ReleaseAction {\n             // Create an individual commit for the next version bump. The changelog should go into\n             // a separate commit that makes it clear where the changelog is cherry-picked from.\n             yield this.createCommit(bumpCommitMessage, [packageJsonPath]);\n+            yield this.prependReleaseNotesToChangelog(releaseNotes);\n+            const commitMessage = getReleaseNoteCherryPickCommitMessage(releaseNotes.version);\n+            yield this.createCommit(commitMessage, [changelogPath]);\n             let nextPullRequestMessage = `The previous \"next\" release-train has moved into the ` +\n                 `release-candidate phase. This PR updates the next branch to the subsequent ` +\n-                `release-train.`;\n-            const hasChangelogCherryPicked = yield this.createCherryPickReleaseNotesCommitFrom(newVersion, newBranch);\n-            if (hasChangelogCherryPicked) {\n-                nextPullRequestMessage += `\\n\\nAlso this PR cherry-picks the changelog for ` +\n-                    `v${newVersion} into the ${nextBranch} branch so that the changelog is up to date.`;\n-            }\n-            else {\n-                error(yellow(`  ✘   Could not cherry-pick release notes for v${newVersion}.`));\n-                error(yellow(`      Please copy the release note manually into \"${nextBranch}\".`));\n-            }\n+                `release-train.\\n\\nAlso this PR cherry-picks the changelog for ` +\n+                `v${newVersion} into the ${nextBranch} branch so that the changelog is up to date.`;\n             const nextUpdatePullRequest = yield this.pushChangesToForkAndCreatePullRequest(nextBranch, `next-release-train-${newNextVersion}`, `Update next branch to reflect new release-train \"v${newNextVersion}\".`, nextPullRequestMessage);\n             info(green(`  ✓   Pull request for updating the \"${nextBranch}\" branch has been created.`));\n             info(yellow(`      Please ask team members to review: ${nextUpdatePullRequest.url}.`));"
        },
        {
            "sha": "86959094ffda071c96ed369219d560cb5aba98d3",
            "filename": "dev-infra/pr/merge/defaults/integration.spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fdefaults%2Fintegration.spec.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -31,7 +31,7 @@ describe('default target labels', () => {\n     releaseConfig = {\n       npmPackages: ['@angular/dev-infra-test-pkg'],\n       buildPackages: async () => [],\n-      generateReleaseNotesForHead: async () => {},\n+      releaseNotes: {}\n     };\n \n     // The label determination will print warn messages. These should not be"
        },
        {
            "sha": "6302752233b166ab1b6f46d83bb94fb4b48b4546",
            "filename": "dev-infra/release/build/build.spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fbuild%2Fbuild.spec.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -32,7 +32,7 @@ describe('ng-dev release build', () => {\n   /** Invokes the build command handler. */\n   async function invokeBuild({json}: {json?: boolean} = {}) {\n     spyOn(releaseConfig, 'getReleaseConfig')\n-        .and.returnValue({npmPackages, buildPackages, generateReleaseNotesForHead: async () => {}});\n+        .and.returnValue({npmPackages, buildPackages, releaseNotes: {}});\n     await ReleaseBuildCommandModule.handler({json: !!json, $0: '', _: []});\n   }\n "
        },
        {
            "sha": "368e942ddaa04e271dc4ac8df6c8746634a54208",
            "filename": "dev-infra/release/config/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fconfig%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fconfig%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fconfig%2Findex.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -26,20 +26,10 @@ export interface ReleaseConfig {\n   npmPackages: string[];\n   /** Builds release packages and returns a list of paths pointing to the output. */\n   buildPackages: () => Promise<BuiltPackage[]|null>;\n-  /** Generates the release notes from the most recent tag to `HEAD`. */\n-  generateReleaseNotesForHead: (outputPath: string) => Promise<void>;\n-  /**\n-   * Gets a pattern for extracting the release notes of the a given version.\n-   * @returns A pattern matching the notes for a given version (including the header).\n-   */\n-  // TODO: Remove this in favor of a canonical changelog format across the Angular organization.\n-  extractReleaseNotesPattern?: (version: semver.SemVer) => RegExp;\n   /** The list of github labels to add to the release PRs. */\n   releasePrLabels?: string[];\n   /** Configuration for creating release notes during publishing. */\n-  // TODO(josephperrott): Make releaseNotes a required attribute on the interface when tooling is\n-  // integrated.\n-  releaseNotes?: ReleaseNotesConfig;\n+  releaseNotes: ReleaseNotesConfig;\n }\n \n /** Configuration for creating release notes during publishing. */\n@@ -75,8 +65,8 @@ export function getReleaseConfig(config: Partial<DevInfraReleaseConfig> = getCon\n   if (config.release?.buildPackages === undefined) {\n     errors.push(`No \"buildPackages\" function configured for releasing.`);\n   }\n-  if (config.release?.generateReleaseNotesForHead === undefined) {\n-    errors.push(`No \"generateReleaseNotesForHead\" function configured for releasing.`);\n+  if (config.release?.releaseNotes === undefined) {\n+    errors.push(`No \"releaseNotes\" configured for releasing.`);\n   }\n \n   assertNoErrors(errors);"
        },
        {
            "sha": "01e321170302cccb7cefffb48a709577e7a75b65",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 73,
            "changes": 92,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -24,7 +24,7 @@ import {changelogPath, packageJsonPath, waitForPullRequestInterval} from './cons\n import {invokeBazelCleanCommand, invokeReleaseBuildCommand, invokeYarnInstallCommand} from './external-commands';\n import {findOwnedForksOfRepoQuery} from './graphql-queries';\n import {getPullRequestState} from './pull-request-state';\n-import {getDefaultExtractReleaseNotesPattern, getLocalChangelogFilePath} from './release-notes/release-notes';\n+import {getLocalChangelogFilePath, ReleaseNotes} from './release-notes/release-notes';\n \n /** Interface describing a Github repository. */\n export interface GithubRepo {\n@@ -132,22 +132,6 @@ export abstract class ReleaseAction {\n     info(green('  ✓   Upstream commit is passing all github status checks.'));\n   }\n \n-  /** Generates the changelog for the specified for the current `HEAD`. */\n-  private async _generateReleaseNotesForHead(version: semver.SemVer) {\n-    const changelogPath = getLocalChangelogFilePath(this.projectDir);\n-    await this.config.generateReleaseNotesForHead(changelogPath);\n-    info(green(`  ✓   Updated the changelog to capture changes for \"${version}\".`));\n-  }\n-\n-  /** Extract the release notes for the given version from the changelog file. */\n-  private _extractReleaseNotesForVersion(changelogContent: string, version: semver.SemVer): string\n-      |null {\n-    const pattern = this.config.extractReleaseNotesPattern !== undefined ?\n-        this.config.extractReleaseNotesPattern(version) :\n-        getDefaultExtractReleaseNotesPattern(version);\n-    const matchedNotes = pattern.exec(changelogContent);\n-    return matchedNotes === null ? null : matchedNotes[1];\n-  }\n \n   /**\n    * Prompts the user for potential release notes edits that need to be made. Once\n@@ -334,28 +318,12 @@ export abstract class ReleaseAction {\n    * the current Git `HEAD`. This is useful for cherry-picking the changelog.\n    * @returns A boolean indicating whether the release notes have been prepended.\n    */\n-  protected async prependReleaseNotesFromVersionBranch(\n-      version: semver.SemVer, containingBranch: string): Promise<boolean> {\n-    const {data} = await this.git.github.repos.getContents(\n-        {...this.git.remoteParams, path: '/' + changelogPath, ref: containingBranch});\n-    const branchChangelog = Buffer.from(data.content, 'base64').toString();\n-    let releaseNotes = this._extractReleaseNotesForVersion(branchChangelog, version);\n-    // If no release notes could be extracted, return \"false\" so that the caller\n-    // can tell that changelog prepending failed.\n-    if (releaseNotes === null) {\n-      return false;\n-    }\n+  protected async prependReleaseNotesToChangelog(releaseNotes: ReleaseNotes): Promise<void> {\n     const localChangelogPath = getLocalChangelogFilePath(this.projectDir);\n     const localChangelog = await fs.readFile(localChangelogPath, 'utf8');\n-    // If the extracted release notes do not have any new lines at the end and the\n-    // local changelog is not empty, we add lines manually so that there is space\n-    // between the previous and cherry-picked release notes.\n-    if (!/[\\r\\n]+$/.test(releaseNotes) && localChangelog !== '') {\n-      releaseNotes = `${releaseNotes}\\n\\n`;\n-    }\n-    // Prepend the extracted release notes to the local changelog and write it back.\n-    await fs.writeFile(localChangelogPath, releaseNotes + localChangelog);\n-    return true;\n+    const releaseNotesEntry = await releaseNotes.getChangelogEntry();\n+    await fs.writeFile(localChangelogPath, `${releaseNotesEntry}\\n\\n${localChangelog}`);\n+    info(green(`  ✓   Updated the changelog to capture changes for \"${releaseNotes.version}\".`));\n   }\n \n   /** Checks out an upstream branch with a detached head. */\n@@ -373,37 +341,18 @@ export abstract class ReleaseAction {\n     this.git.run(['commit', '--no-verify', '-m', message, ...files]);\n   }\n \n-  /**\n-   * Creates a cherry-pick commit for the release notes of the specified version that\n-   * has been pushed to the given branch.\n-   * @returns a boolean indicating whether the commit has been created successfully.\n-   */\n-  protected async createCherryPickReleaseNotesCommitFrom(\n-      version: semver.SemVer, branchName: string): Promise<boolean> {\n-    const commitMessage = getReleaseNoteCherryPickCommitMessage(version);\n-\n-    // Fetch, extract and prepend the release notes to the local changelog. If that is not\n-    // possible, abort so that we can ask the user to manually cherry-pick the changelog.\n-    if (!await this.prependReleaseNotesFromVersionBranch(version, branchName)) {\n-      return false;\n-    }\n-\n-    // Create a changelog cherry-pick commit.\n-    await this.createCommit(commitMessage, [changelogPath]);\n-\n-    info(green(`  ✓   Created changelog cherry-pick commit for: \"${version}\".`));\n-    return true;\n-  }\n \n   /**\n    * Stages the specified new version for the current branch and creates a\n    * pull request that targets the given base branch.\n    * @returns an object describing the created pull request.\n    */\n   protected async stageVersionForBranchAndCreatePullRequest(\n-      newVersion: semver.SemVer, pullRequestBaseBranch: string): Promise<PullRequest> {\n+      newVersion: semver.SemVer, pullRequestBaseBranch: string):\n+      Promise<{releaseNotes: ReleaseNotes, pullRequest: PullRequest}> {\n+    const releaseNotes = await ReleaseNotes.fromLatestTagToHead(newVersion, this.config);\n     await this.updateProjectVersion(newVersion);\n-    await this._generateReleaseNotesForHead(newVersion);\n+    await this.prependReleaseNotesToChangelog(releaseNotes);\n     await this.waitForEditsAndCreateReleaseCommit(newVersion);\n \n     const pullRequest = await this.pushChangesToForkAndCreatePullRequest(\n@@ -413,7 +362,7 @@ export abstract class ReleaseAction {\n     info(green('  ✓   Release staging pull request has been created.'));\n     info(yellow(`      Please ask team members to review: ${pullRequest.url}.`));\n \n-    return pullRequest;\n+    return {releaseNotes, pullRequest};\n   }\n \n   /**\n@@ -422,7 +371,7 @@ export abstract class ReleaseAction {\n    * @returns an object describing the created pull request.\n    */\n   protected async checkoutBranchAndStageVersion(newVersion: semver.SemVer, stagingBranch: string):\n-      Promise<PullRequest> {\n+      Promise<{releaseNotes: ReleaseNotes, pullRequest: PullRequest}> {\n     await this.verifyPassingGithubStatus(stagingBranch);\n     await this.checkoutUpstreamBranch(stagingBranch);\n     return await this.stageVersionForBranchAndCreatePullRequest(newVersion, stagingBranch);\n@@ -434,25 +383,22 @@ export abstract class ReleaseAction {\n    * @returns a boolean indicating successful creation of the cherry-pick pull request.\n    */\n   protected async cherryPickChangelogIntoNextBranch(\n-      newVersion: semver.SemVer, stagingBranch: string): Promise<boolean> {\n+      releaseNotes: ReleaseNotes, stagingBranch: string): Promise<boolean> {\n     const nextBranch = this.active.next.branchName;\n-    const commitMessage = getReleaseNoteCherryPickCommitMessage(newVersion);\n+    const commitMessage = getReleaseNoteCherryPickCommitMessage(releaseNotes.version);\n \n     // Checkout the next branch.\n     await this.checkoutUpstreamBranch(nextBranch);\n \n-    // Cherry-pick the release notes into the current branch. If it fails,\n-    // ask the user to manually copy the release notes into the next branch.\n-    if (!await this.createCherryPickReleaseNotesCommitFrom(newVersion, stagingBranch)) {\n-      error(yellow(`  ✘   Could not cherry-pick release notes for v${newVersion}.`));\n-      error(\n-          yellow(`      Please copy the release notes manually into the \"${nextBranch}\" branch.`));\n-      return false;\n-    }\n+    await this.prependReleaseNotesToChangelog(releaseNotes);\n+\n+    // Create a changelog cherry-pick commit.\n+    await this.createCommit(commitMessage, [changelogPath]);\n+    info(green(`  ✓   Created changelog cherry-pick commit for: \"${releaseNotes.version}\".`));\n \n     // Create a cherry-pick pull request that should be merged by the caretaker.\n     const {url, id} = await this.pushChangesToForkAndCreatePullRequest(\n-        nextBranch, `changelog-cherry-pick-${newVersion}`, commitMessage,\n+        nextBranch, `changelog-cherry-pick-${releaseNotes.version}`, commitMessage,\n         `Cherry-picks the changelog from the \"${stagingBranch}\" branch to the next ` +\n             `branch (${nextBranch}).`);\n "
        },
        {
            "sha": "91b839b192fcaefaecfc6add9ac4c42d18244345",
            "filename": "dev-infra/release/publish/actions/cut-lts-patch.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-lts-patch.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-lts-patch.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-lts-patch.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -41,11 +41,12 @@ export class CutLongTermSupportPatchAction extends ReleaseAction {\n   async perform() {\n     const ltsBranch = await this._promptForTargetLtsBranch();\n     const newVersion = semverInc(ltsBranch.version, 'patch');\n-    const {id} = await this.checkoutBranchAndStageVersion(newVersion, ltsBranch.name);\n+    const {pullRequest: {id}, releaseNotes} =\n+        await this.checkoutBranchAndStageVersion(newVersion, ltsBranch.name);\n \n     await this.waitForPullRequestToBeMerged(id);\n     await this.buildAndPublish(newVersion, ltsBranch.name, ltsBranch.npmDistTag);\n-    await this.cherryPickChangelogIntoNextBranch(newVersion, ltsBranch.name);\n+    await this.cherryPickChangelogIntoNextBranch(releaseNotes, ltsBranch.name);\n   }\n \n   /** Prompts the user to select an LTS branch for which a patch should but cut. */"
        },
        {
            "sha": "4c494d2a37a3780179cc9327a1f1b420ed6ebf7f",
            "filename": "dev-infra/release/publish/actions/cut-new-patch.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-new-patch.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-new-patch.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-new-patch.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -28,11 +28,12 @@ export class CutNewPatchAction extends ReleaseAction {\n     const {branchName} = this.active.latest;\n     const newVersion = this._newVersion;\n \n-    const {id} = await this.checkoutBranchAndStageVersion(newVersion, branchName);\n+    const {pullRequest: {id}, releaseNotes} =\n+        await this.checkoutBranchAndStageVersion(newVersion, branchName);\n \n     await this.waitForPullRequestToBeMerged(id);\n     await this.buildAndPublish(newVersion, branchName, 'latest');\n-    await this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+    await this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n   }\n \n   static async isActive(active: ActiveReleaseTrains) {"
        },
        {
            "sha": "b9998d5ccdd3fd5a4efc536f7c0109418ca3e47a",
            "filename": "dev-infra/release/publish/actions/cut-next-prerelease.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-next-prerelease.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-next-prerelease.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-next-prerelease.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -32,7 +32,8 @@ export class CutNextPrereleaseAction extends ReleaseAction {\n     const {branchName} = releaseTrain;\n     const newVersion = await this._newVersion;\n \n-    const {id} = await this.checkoutBranchAndStageVersion(newVersion, branchName);\n+    const {pullRequest: {id}, releaseNotes} =\n+        await this.checkoutBranchAndStageVersion(newVersion, branchName);\n \n     await this.waitForPullRequestToBeMerged(id);\n     await this.buildAndPublish(newVersion, branchName, 'next');\n@@ -41,7 +42,7 @@ export class CutNextPrereleaseAction extends ReleaseAction {\n     // to the next release-train, cherry-pick the changelog into the primary\n     // development branch. i.e. the `next` branch that is usually `master`.\n     if (releaseTrain !== this.active.next) {\n-      await this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+      await this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n     }\n   }\n "
        },
        {
            "sha": "93ba374fcb01d7df9cca5a61f232060c9ae8a668",
            "filename": "dev-infra/release/publish/actions/cut-release-candidate.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-release-candidate.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-release-candidate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-release-candidate.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -26,11 +26,12 @@ export class CutReleaseCandidateAction extends ReleaseAction {\n     const {branchName} = this.active.releaseCandidate!;\n     const newVersion = this._newVersion;\n \n-    const {id} = await this.checkoutBranchAndStageVersion(newVersion, branchName);\n+    const {pullRequest: {id}, releaseNotes} =\n+        await this.checkoutBranchAndStageVersion(newVersion, branchName);\n \n     await this.waitForPullRequestToBeMerged(id);\n     await this.buildAndPublish(newVersion, branchName, 'next');\n-    await this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+    await this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n   }\n \n   static async isActive(active: ActiveReleaseTrains) {"
        },
        {
            "sha": "e34bd905b5cf16fc8d62896345cd9716a5bbf546",
            "filename": "dev-infra/release/publish/actions/cut-stable.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-stable.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-stable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-stable.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -31,7 +31,8 @@ export class CutStableAction extends ReleaseAction {\n     const isNewMajor = this.active.releaseCandidate?.isMajor;\n \n \n-    const {id} = await this.checkoutBranchAndStageVersion(newVersion, branchName);\n+    const {pullRequest: {id}, releaseNotes} =\n+        await this.checkoutBranchAndStageVersion(newVersion, branchName);\n \n     await this.waitForPullRequestToBeMerged(id);\n     await this.buildAndPublish(newVersion, branchName, 'latest');\n@@ -53,7 +54,7 @@ export class CutStableAction extends ReleaseAction {\n       await invokeSetNpmDistCommand(ltsTagForPatch, previousPatch.version);\n     }\n \n-    await this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n+    await this.cherryPickChangelogIntoNextBranch(releaseNotes, branchName);\n   }\n \n   /** Gets the new stable version of the release candidate release-train. */"
        },
        {
            "sha": "591b83752469cf6e5a37b25436a5887cdfa7722b",
            "filename": "dev-infra/release/publish/actions/move-next-into-feature-freeze.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 18,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fmove-next-into-feature-freeze.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Factions%2Fmove-next-into-feature-freeze.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fmove-next-into-feature-freeze.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -8,12 +8,13 @@\n \n import * as semver from 'semver';\n \n-import {error, green, info, yellow} from '../../../utils/console';\n+import {green, info, yellow} from '../../../utils/console';\n import {ActiveReleaseTrains} from '../../versioning/active-release-trains';\n import {computeNewPrereleaseVersionForNext} from '../../versioning/next-prerelease-version';\n import {ReleaseAction} from '../actions';\n-import {getCommitMessageForExceptionalNextVersionBump} from '../commit-message';\n-import {packageJsonPath} from '../constants';\n+import {getCommitMessageForExceptionalNextVersionBump, getReleaseNoteCherryPickCommitMessage} from '../commit-message';\n+import {changelogPath, packageJsonPath} from '../constants';\n+import {ReleaseNotes} from '../release-notes/release-notes';\n \n /**\n  * Release action that moves the next release-train into the feature-freeze phase. This means\n@@ -39,15 +40,15 @@ export class MoveNextIntoFeatureFreezeAction extends ReleaseAction {\n     // Stage the new version for the newly created branch, and push changes to a\n     // fork in order to create a staging pull request. Note that we re-use the newly\n     // created branch instead of re-fetching from the upstream.\n-    const stagingPullRequest =\n+    const {pullRequest: {id}, releaseNotes} =\n         await this.stageVersionForBranchAndCreatePullRequest(newVersion, newBranch);\n \n     // Wait for the staging PR to be merged. Then build and publish the feature-freeze next\n     // pre-release. Finally, cherry-pick the release notes into the next branch in combination\n     // with bumping the version to the next minor too.\n-    await this.waitForPullRequestToBeMerged(stagingPullRequest.id);\n+    await this.waitForPullRequestToBeMerged(id);\n     await this.buildAndPublish(newVersion, newBranch, 'next');\n-    await this._createNextBranchUpdatePullRequest(newVersion, newBranch);\n+    await this._createNextBranchUpdatePullRequest(releaseNotes, newVersion);\n   }\n \n   /** Creates a new version branch from the next branch. */\n@@ -64,7 +65,8 @@ export class MoveNextIntoFeatureFreezeAction extends ReleaseAction {\n    * Creates a pull request for the next branch that bumps the version to the next\n    * minor, and cherry-picks the changelog for the newly branched-off feature-freeze version.\n    */\n-  private async _createNextBranchUpdatePullRequest(newVersion: semver.SemVer, newBranch: string) {\n+  private async _createNextBranchUpdatePullRequest(\n+      releaseNotes: ReleaseNotes, newVersion: semver.SemVer) {\n     const {branchName: nextBranch, version} = this.active.next;\n     // We increase the version for the next branch to the next minor. The team can decide\n     // later if they want next to be a major through the `Configure Next as Major` release action.\n@@ -78,19 +80,16 @@ export class MoveNextIntoFeatureFreezeAction extends ReleaseAction {\n     // a separate commit that makes it clear where the changelog is cherry-picked from.\n     await this.createCommit(bumpCommitMessage, [packageJsonPath]);\n \n+    await this.prependReleaseNotesToChangelog(releaseNotes);\n+\n+    const commitMessage = getReleaseNoteCherryPickCommitMessage(releaseNotes.version);\n+\n+    await this.createCommit(commitMessage, [changelogPath]);\n+\n     let nextPullRequestMessage = `The previous \"next\" release-train has moved into the ` +\n         `release-candidate phase. This PR updates the next branch to the subsequent ` +\n-        `release-train.`;\n-    const hasChangelogCherryPicked =\n-        await this.createCherryPickReleaseNotesCommitFrom(newVersion, newBranch);\n-\n-    if (hasChangelogCherryPicked) {\n-      nextPullRequestMessage += `\\n\\nAlso this PR cherry-picks the changelog for ` +\n-          `v${newVersion} into the ${nextBranch} branch so that the changelog is up to date.`;\n-    } else {\n-      error(yellow(`  ✘   Could not cherry-pick release notes for v${newVersion}.`));\n-      error(yellow(`      Please copy the release note manually into \"${nextBranch}\".`));\n-    }\n+        `release-train.\\n\\nAlso this PR cherry-picks the changelog for ` +\n+        `v${newVersion} into the ${nextBranch} branch so that the changelog is up to date.`;\n \n     const nextUpdatePullRequest = await this.pushChangesToForkAndCreatePullRequest(\n         nextBranch, `next-release-train-${newNextVersion}`,"
        },
        {
            "sha": "edbad432387da7d99e8eedcdf35bd3c10b752cc3",
            "filename": "dev-infra/release/publish/release-notes/release-notes.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 31,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Frelease-notes%2Frelease-notes.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Frelease-notes%2Frelease-notes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Frelease-notes%2Frelease-notes.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -10,25 +10,12 @@ import {join} from 'path';\n import * as semver from 'semver';\n \n import {getCommitsInRange} from '../../../commit-message/utils';\n-import {getConfig} from '../../../utils/config';\n import {promptInput} from '../../../utils/console';\n import {GitClient} from '../../../utils/git/index';\n-import {getReleaseConfig} from '../../config/index';\n+import {ReleaseConfig} from '../../config/index';\n import {changelogPath} from '../constants';\n import {RenderContext} from './context';\n \n-\n-/**\n- * Gets the default pattern for extracting release notes for the given version.\n- * This pattern matches for the conventional-changelog Angular preset.\n- */\n-export function getDefaultExtractReleaseNotesPattern(version: semver.SemVer): RegExp {\n-  const escapedVersion = version.format().replace('.', '\\\\.');\n-  // TODO: Change this once we have a canonical changelog generation tool. Also update this\n-  // based on the conventional-changelog version. They removed anchors in more recent versions.\n-  return new RegExp(`(<a name=\"${escapedVersion}\"></a>.*?)(?:<a name=\"|$)`, 's');\n-}\n-\n /** Gets the path for the changelog file in a given project. */\n export function getLocalChangelogFilePath(projectDir: string): string {\n   return join(projectDir, changelogPath);\n@@ -37,33 +24,35 @@ export function getLocalChangelogFilePath(projectDir: string): string {\n \n /** Release note generation. */\n export class ReleaseNotes {\n+  /** Construct a release note generation instance. */\n+  static async fromLatestTagToHead(version: semver.SemVer, config: ReleaseConfig):\n+      Promise<ReleaseNotes> {\n+    return new ReleaseNotes(version, config);\n+  }\n+\n   /** An instance of GitClient. */\n   private git = GitClient.getInstance();\n-  /** The github configuration. */\n-  private readonly github = getConfig().github;\n-  /** The configuration for the release notes generation. */\n-  // TODO(josephperrott): Remove non-null assertion after usage of ReleaseNotes is integrated into\n-  // release publish tooling.\n-  private readonly config = getReleaseConfig().releaseNotes! || {};\n-  /** A promise resolving to a list of Commits since the latest semver tag on the branch. */\n-  private commits = getCommitsInRange(this.git.getLatestSemverTag().format(), 'HEAD');\n   /** The RenderContext to be used during rendering. */\n   private renderContext: RenderContext|undefined;\n   /** The title to use for the release. */\n   private title: string|false|undefined;\n+  /** A promise resolving to a list of Commits since the latest semver tag on the branch. */\n+  private commits = getCommitsInRange(this.git.getLatestSemverTag().format(), 'HEAD');\n \n-  constructor(private version: semver.SemVer) {}\n+  private constructor(public readonly version: semver.SemVer, private config: ReleaseConfig) {}\n \n   /** Retrieve the release note generated for a Github Release. */\n   async getGithubReleaseEntry(): Promise<string> {\n-    return await renderFile(\n-        join(__dirname, 'templates/github-release.ejs'), await this.generateRenderContext());\n+    return renderFile(\n+        join(__dirname, 'templates/github-release.ejs'), await this.generateRenderContext(),\n+        {rmWhitespace: true});\n   }\n \n   /** Retrieve the release note generated for a CHANGELOG entry. */\n   async getChangelogEntry() {\n-    return await renderFile(\n-        join(__dirname, 'templates/changelog.ejs'), await this.generateRenderContext());\n+    return renderFile(\n+        join(__dirname, 'templates/changelog.ejs'), await this.generateRenderContext(),\n+        {rmWhitespace: true});\n   }\n \n   /**\n@@ -72,7 +61,7 @@ export class ReleaseNotes {\n    */\n   async promptForReleaseTitle() {\n     if (this.title === undefined) {\n-      if (this.config.useReleaseTitle) {\n+      if (this.config.releaseNotes.useReleaseTitle) {\n         this.title = await promptInput('Please provide a title for the release:');\n       } else {\n         this.title = false;\n@@ -86,10 +75,10 @@ export class ReleaseNotes {\n     if (!this.renderContext) {\n       this.renderContext = new RenderContext({\n         commits: await this.commits,\n-        github: getConfig().github,\n+        github: this.git.remoteConfig,\n         version: this.version.format(),\n-        groupOrder: this.config.groupOrder,\n-        hiddenScopes: this.config.hiddenScopes,\n+        groupOrder: this.config.releaseNotes.groupOrder,\n+        hiddenScopes: this.config.releaseNotes.hiddenScopes,\n         title: await this.promptForReleaseTitle(),\n       });\n     }"
        },
        {
            "sha": "3bb2a41242276535e60c4eec890d42e9665b7635",
            "filename": "dev-infra/release/publish/test/BUILD.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2FBUILD.bazel?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -33,5 +33,8 @@ jasmine_node_test(\n     # enabled in NodeJS. TODO: Remove this with rules_nodejs 3.x where patching is optional.\n     # https://github.com/bazelbuild/rules_nodejs/commit/7d070ffadf9c3b41711382a4737b995f987c14fa.\n     args = [\"--nobazel_patch_module_resolver\"],\n+    data = [\n+        \"//dev-infra/release/publish/release-notes/templates\",\n+    ],\n     deps = [\":test_lib\"],\n )"
        },
        {
            "sha": "a349aedb992aa6c9a7e36d750f7c38789fc91c94",
            "filename": "dev-infra/release/publish/test/common.spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 58,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -18,6 +18,7 @@ import {ReleaseTrain} from '../../versioning/release-trains';\n import {ReleaseAction} from '../actions';\n import {actions} from '../actions/index';\n import {changelogPath} from '../constants';\n+import {ReleaseNotes} from '../release-notes/release-notes';\n \n import {fakeNpmPackageQueryRequest, getChangelogForVersion, getTestingMocksForReleaseAction, parse, setupReleaseActionForTesting, testTmpDir} from './test-utils';\n \n@@ -89,7 +90,7 @@ describe('common release action logic', () => {\n     const fakeReleaseNotes = getChangelogForVersion(version.format());\n     const forkBranchName = `changelog-cherry-pick-${version}`;\n \n-    it('should prepend fetched changelog', async () => {\n+    it('should prepend the changelog to the next branch', async () => {\n       const {repo, fork, instance, testTmpDir} =\n           setupReleaseActionForTesting(TestAction, baseReleaseTrains);\n \n@@ -109,62 +110,6 @@ describe('common release action logic', () => {\n       expect(changelogContent).toEqual(`${fakeReleaseNotes}Existing changelog`);\n     });\n \n-    it('should respect a custom release note extraction pattern', async () => {\n-      const {repo, fork, instance, testTmpDir, releaseConfig} =\n-          setupReleaseActionForTesting(TestAction, baseReleaseTrains);\n-\n-      // Custom pattern matching changelog output sections grouped through\n-      // basic level-1 markdown headers (compared to the default anchor pattern).\n-      releaseConfig.extractReleaseNotesPattern = version =>\n-          new RegExp(`(# v${version} \\\\(\"[^\"]+\"\\\\).*?)(?:# v|$)`, 's');\n-\n-      const customReleaseNotes = `# v${version} (\"newton-kepler\")\\n\\nNew Content!`;\n-\n-      // Expect the changelog to be fetched and return a fake changelog to test that\n-      // it is properly appended. Also expect a pull request to be created in the fork.\n-      repo.expectChangelogFetch(branchName, customReleaseNotes)\n-          .expectFindForkRequest(fork)\n-          .expectPullRequestToBeCreated('master', fork, forkBranchName, 200)\n-          .expectPullRequestWait(200);\n-\n-      // Simulate that the fork branch name is available.\n-      fork.expectBranchRequest(forkBranchName, null);\n-\n-      await instance.testCherryPickWithPullRequest(version, branchName);\n-\n-      const changelogContent = readFileSync(join(testTmpDir, changelogPath), 'utf8');\n-      expect(changelogContent).toEqual(`${customReleaseNotes}\\n\\nExisting changelog`);\n-    });\n-\n-    it('should print an error if release notes cannot be extracted', async () => {\n-      const {repo, fork, instance, testTmpDir, releaseConfig} =\n-          setupReleaseActionForTesting(TestAction, baseReleaseTrains);\n-\n-      // Expect the changelog to be fetched and return a fake changelog to test that\n-      // it is properly appended. Also expect a pull request to be created in the fork.\n-      repo.expectChangelogFetch(branchName, `non analyzable changelog`)\n-          .expectFindForkRequest(fork)\n-          .expectPullRequestToBeCreated('master', fork, forkBranchName, 200)\n-          .expectPullRequestWait(200);\n-\n-      // Simulate that the fork branch name is available.\n-      fork.expectBranchRequest(forkBranchName, null);\n-\n-      spyOn(console, 'error');\n-\n-      await instance.testCherryPickWithPullRequest(version, branchName);\n-\n-      expect(console.error)\n-          .toHaveBeenCalledWith(\n-              jasmine.stringMatching(`Could not cherry-pick release notes for v${version}`));\n-      expect(console.error)\n-          .toHaveBeenCalledWith(jasmine.stringMatching(\n-              `Please copy the release notes manually into the \"master\" branch.`));\n-\n-      const changelogContent = readFileSync(join(testTmpDir, changelogPath), 'utf8');\n-      expect(changelogContent).toEqual(`Existing changelog`);\n-    });\n-\n     it('should push changes to a fork for creating a pull request', async () => {\n       const {repo, fork, instance, gitClient} =\n           setupReleaseActionForTesting(TestAction, baseReleaseTrains);\n@@ -214,6 +159,7 @@ class TestAction extends ReleaseAction {\n   }\n \n   async testCherryPickWithPullRequest(version: semver.SemVer, branch: string) {\n-    await this.cherryPickChangelogIntoNextBranch(version, branch);\n+    const releaseNotes = await ReleaseNotes.fromLatestTagToHead(version, this.config);\n+    await this.cherryPickChangelogIntoNextBranch(releaseNotes, branch);\n   }\n }"
        },
        {
            "sha": "78309754f997a8a71a9298e60ee7fe0ce8c8901a",
            "filename": "dev-infra/release/publish/test/move-next-into-feature-freeze.spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2Fmove-next-into-feature-freeze.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2Fmove-next-into-feature-freeze.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Fmove-next-into-feature-freeze.spec.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -140,7 +140,6 @@ describe('move next into feature-freeze action', () => {\n             'Expected next release-train update branch be created in fork.');\n \n     expect(externalCommands.invokeReleaseBuildCommand).toHaveBeenCalledTimes(1);\n-    expect(releaseConfig.generateReleaseNotesForHead).toHaveBeenCalledTimes(1);\n     expect(npm.runNpmPublish).toHaveBeenCalledTimes(2);\n     expect(npm.runNpmPublish).toHaveBeenCalledWith(`${testTmpDir}/dist/pkg1`, 'next', undefined);\n     expect(npm.runNpmPublish).toHaveBeenCalledWith(`${testTmpDir}/dist/pkg2`, 'next', undefined);"
        },
        {
            "sha": "0cffd5b8ffb70a8ac231fafb34bab24fb6ff9f8d",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -11,16 +11,18 @@ import * as nock from 'nock';\n import {join} from 'path';\n import * as semver from 'semver';\n \n+import * as commitMessageUtils from '../../../commit-message/utils';\n import {GithubConfig} from '../../../utils/config';\n import * as console from '../../../utils/console';\n-import {getBranchPushMatcher, VirtualGitClient} from '../../../utils/testing';\n+import {getBranchPushMatcher, installVirtualGitClientSpies, VirtualGitClient} from '../../../utils/testing';\n import {ReleaseConfig} from '../../config/index';\n import {ActiveReleaseTrains} from '../../versioning/active-release-trains';\n import * as npm from '../../versioning/npm-publish';\n import {_npmPackageInfoCache, NpmPackageInfo} from '../../versioning/npm-registry';\n import {ReleaseAction, ReleaseActionConstructor} from '../actions';\n import * as constants from '../constants';\n import * as externalCommands from '../external-commands';\n+import {buildDateStamp} from '../release-notes/context';\n \n import {GithubTestingRepo} from './github-api-testing';\n \n@@ -50,7 +52,7 @@ export function getTestingMocksForReleaseAction() {\n       '@angular/pkg1',\n       '@angular/pkg2',\n     ],\n-    generateReleaseNotesForHead: jasmine.createSpy('generateReleaseNotesForHead').and.resolveTo(),\n+    releaseNotes: {},\n     buildPackages: () => {\n       throw Error('Not implemented');\n     },\n@@ -67,6 +69,9 @@ export function getTestingMocksForReleaseAction() {\n export function setupReleaseActionForTesting<T extends ReleaseAction>(\n     actionCtor: ReleaseActionConstructor<T>, active: ActiveReleaseTrains,\n     isNextPublishedToNpm = true): TestReleaseAction<T> {\n+  installVirtualGitClientSpies();\n+  spyOn(commitMessageUtils, 'getCommitsInRange').and.returnValue(Promise.resolve([]));\n+\n   // Reset existing HTTP interceptors.\n   nock.cleanAll();\n \n@@ -121,7 +126,7 @@ export function parse(version: string): semver.SemVer {\n \n /** Gets a changelog for the specified version. */\n export function getChangelogForVersion(version: string): string {\n-  return `<a name=\"${version}\"></a>Changelog\\n\\n`;\n+  return `<a name=\"${version}\"></a>\\n# ${version} (${buildDateStamp()})\\n\\n\\n`;\n }\n \n export async function expectStagingAndPublishWithoutCherryPick(\n@@ -166,7 +171,6 @@ export async function expectStagingAndPublishWithoutCherryPick(\n           'Expected release staging branch to be created in fork.');\n \n   expect(externalCommands.invokeReleaseBuildCommand).toHaveBeenCalledTimes(1);\n-  expect(releaseConfig.generateReleaseNotesForHead).toHaveBeenCalledTimes(1);\n   expect(npm.runNpmPublish).toHaveBeenCalledTimes(2);\n   expect(npm.runNpmPublish)\n       .toHaveBeenCalledWith(`${testTmpDir}/dist/pkg1`, expectedNpmDistTag, undefined);\n@@ -235,7 +239,6 @@ export async function expectStagingAndPublishWithCherryPick(\n           'Expected cherry-pick branch to be created in fork.');\n \n   expect(externalCommands.invokeReleaseBuildCommand).toHaveBeenCalledTimes(1);\n-  expect(releaseConfig.generateReleaseNotesForHead).toHaveBeenCalledTimes(1);\n   expect(npm.runNpmPublish).toHaveBeenCalledTimes(2);\n   expect(npm.runNpmPublish)\n       .toHaveBeenCalledWith(`${testTmpDir}/dist/pkg1`, expectedNpmDistTag, undefined);"
        },
        {
            "sha": "13cbe1064a9c4ec6959c3c01e56b871ff2a18fe5",
            "filename": "dev-infra/release/set-dist-tag/set-dist-tag.spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fset-dist-tag%2Fset-dist-tag.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Frelease%2Fset-dist-tag%2Fset-dist-tag.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fset-dist-tag%2Fset-dist-tag.spec.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -32,7 +32,7 @@ describe('ng-dev release set-dist-tag', () => {\n       npmPackages,\n       publishRegistry,\n       buildPackages: async () => [],\n-      generateReleaseNotesForHead: async () => {}\n+      releaseNotes: {},\n     });\n     await ReleaseSetDistTagCommand.handler({tagName, targetVersion, $0: '', _: []});\n   }"
        },
        {
            "sha": "0962e94d6956a08d4801ec5280c0c8aa08f5a4bb",
            "filename": "dev-infra/utils/testing/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Futils%2Ftesting%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Futils%2Ftesting%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2FBUILD.bazel?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -10,6 +10,8 @@ ts_library(\n         \"@npm//@types/jasmine\",\n         \"@npm//@types/minimist\",\n         \"@npm//@types/node\",\n+        \"@npm//@types/semver\",\n         \"@npm//minimist\",\n+        \"@npm//semver\",\n     ],\n )"
        },
        {
            "sha": "37d59b446a9a4f47afade3652823bea5a02573f4",
            "filename": "dev-infra/utils/testing/virtual-git-client.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/393ce94718cccf3d69fff44cb509ab487d61f3de/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts?ref=393ce94718cccf3d69fff44cb509ab487d61f3de",
            "patch": "@@ -8,6 +8,7 @@\n \n import {SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n import * as parseArgs from 'minimist';\n+import {SemVer} from 'semver';\n \n import {NgDevConfig} from '../config';\n import {GitClient} from '../git/index';\n@@ -82,6 +83,15 @@ export class VirtualGitClient<Authenticated extends boolean> extends GitClient<A\n   /** List of pushed heads to a given remote ref. */\n   pushed: {remote: RemoteRef, head: GitHead}[] = [];\n \n+\n+  /**\n+   * Override the actual GitClient getLatestSemverTag, as an actual tag cannot be retrieved in\n+   * testing.\n+   */\n+  getLatestSemverTag() {\n+    return new SemVer('0.0.0');\n+  }\n+\n   /** Override for the actual Git client command execution. */\n   runGraceful(args: string[], options: SpawnSyncOptions = {}): SpawnSyncReturns<string> {\n     const [command, ...rawArgs] = args;"
        }
    ],
    "stats": {
        "total": 637,
        "additions": 323,
        "deletions": 314
    }
}