{
    "author": "JoostK",
    "message": "perf(compiler-cli): allow incremental compilation in the presence of redirected source files (#41448)\n\nWhen multiple occurrences of the same package exist within a single\nTypeScript compilation unit, TypeScript deduplicates the source files\nby introducing redirected source file proxies. Such proxies are\nrecreated during an incremental compilation even if the original\ndeclaration file did not change, which caused the compiler not to reuse\nany work from the prior compilation.\n\nThis commit changes the incremental driver to recognize a redirected\nsource file and treat them as their unredirected source file.\n\nPR Close #41448",
    "sha": "ffea31f433c1f71b78a2245d52d2969503db1784",
    "files": [
        {
            "sha": "6dcf4706be81373ad2e1c18fe8eadbd86399614f",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/state.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "raw_url": "https://github.com/angular/angular/raw/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts?ref=ffea31f433c1f71b78a2245d52d2969503db1784",
            "patch": "@@ -13,6 +13,7 @@ import {PerfEvent, PerfPhase, PerfRecorder} from '../../perf';\n import {ClassDeclaration} from '../../reflection';\n import {ClassRecord, TraitCompiler} from '../../transform';\n import {FileTypeCheckingData} from '../../typecheck/src/checker';\n+import {toUnredirectedSourceFile} from '../../util/src/typescript';\n import {IncrementalBuild} from '../api';\n import {SemanticDepGraph, SemanticDepGraphUpdater} from '../semantic_graph';\n \n@@ -85,12 +86,14 @@ export class IncrementalDriver implements IncrementalBuild<ClassRecord, FileType\n       //    avoid leaking memory.\n \n       // All files in the old program, for easy detection of changes.\n-      const oldFiles = new Set<ts.SourceFile>(oldProgram.getSourceFiles());\n+      const oldFiles =\n+          new Set<ts.SourceFile>(oldProgram.getSourceFiles().map(toUnredirectedSourceFile));\n \n       // Assume all the old files were deleted to begin with. Only TS files are tracked.\n       const deletedTsPaths = new Set<string>(tsOnlyFiles(oldProgram).map(sf => sf.fileName));\n \n-      for (const newFile of newProgram.getSourceFiles()) {\n+      for (const possiblyRedirectedNewFile of newProgram.getSourceFiles()) {\n+        const newFile = toUnredirectedSourceFile(possiblyRedirectedNewFile);\n         if (!newFile.isDeclarationFile) {\n           // This file exists in the new program, so remove it from `deletedTsPaths`.\n           deletedTsPaths.delete(newFile.fileName);"
        },
        {
            "sha": "4fce91fa2da3bcf7e42c6153fceda289626b75ef",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/src/ts_create_program_driver.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 14,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts",
            "raw_url": "https://github.com/angular/angular/raw/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts?ref=ffea31f433c1f71b78a2245d52d2969503db1784",
            "patch": "@@ -8,17 +8,9 @@\n \n import * as ts from 'typescript';\n \n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n import {AbsoluteFsPath} from '../../file_system';\n import {copyFileShimData, retagAllTsFiles, ShimReferenceTagger, untagAllTsFiles} from '../../shims';\n-import {RequiredDelegations} from '../../util/src/typescript';\n+import {RequiredDelegations, toUnredirectedSourceFile} from '../../util/src/typescript';\n \n import {ProgramDriver, UpdateMode} from './api';\n \n@@ -114,12 +106,9 @@ class UpdatedProgramHost extends DelegatingCompilerHost {\n     } else {\n       sf = delegateSf;\n     }\n-    // TypeScript doesn't allow returning redirect source files. To avoid unforseen errors we\n+    // TypeScript doesn't allow returning redirect source files. To avoid unforeseen errors we\n     // return the original source file instead of the redirect target.\n-    const redirectInfo = (sf as any).redirectInfo;\n-    if (redirectInfo !== undefined) {\n-      sf = redirectInfo.unredirected;\n-    }\n+    sf = toUnredirectedSourceFile(sf);\n \n     this.shimTagger.tag(sf);\n     return sf;"
        },
        {
            "sha": "565fab302662696c3454bae6e1834dcd567cdef9",
            "filename": "packages/compiler-cli/src/ngtsc/util/src/typescript.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Ftypescript.ts",
            "raw_url": "https://github.com/angular/angular/raw/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Ftypescript.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Futil%2Fsrc%2Ftypescript.ts?ref=ffea31f433c1f71b78a2245d52d2969503db1784",
            "patch": "@@ -161,3 +161,23 @@ export type SubsetOfKeys<T, K extends keyof T> = K;\n export type RequiredDelegations<T> = {\n   [M in keyof Required<T>]: T[M];\n };\n+\n+/**\n+ * Source files may become redirects to other source files when their package name and version are\n+ * identical. TypeScript creates a proxy source file for such source files which has an internal\n+ * `redirectInfo` property that refers to the original source file.\n+ */\n+interface RedirectedSourceFile extends ts.SourceFile {\n+  redirectInfo?: {unredirected: ts.SourceFile;};\n+}\n+\n+/**\n+ * Obtains the non-redirected source file for `sf`.\n+ */\n+export function toUnredirectedSourceFile(sf: ts.SourceFile): ts.SourceFile {\n+  const redirectInfo = (sf as RedirectedSourceFile).redirectInfo;\n+  if (redirectInfo === undefined) {\n+    return sf;\n+  }\n+  return redirectInfo.unredirected;\n+}"
        },
        {
            "sha": "9f6c4f56e19e333581c840c9c1c034af261b5839",
            "filename": "packages/compiler-cli/test/ngtsc/incremental_spec.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ffea31f433c1f71b78a2245d52d2969503db1784/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts?ref=ffea31f433c1f71b78a2245d52d2969503db1784",
            "patch": "@@ -524,6 +524,58 @@ runInEachFileSystem(() => {\n       env.driveMain();\n     });\n \n+    it('should allow incremental compilation with redirected source files', () => {\n+      env.tsconfig({fullTemplateTypeCheck: true});\n+\n+      // This file structure has an identical version of \"a\" under the root node_modules and inside\n+      // of \"b\". Because their package.json file indicates it is the exact same version of \"a\",\n+      // TypeScript will transform the source file of \"node_modules/b/node_modules/a/index.d.ts\"\n+      // into a redirect to \"node_modules/a/index.d.ts\". During incremental compilations, the\n+      // redirected \"node_modules/b/node_modules/a/index.d.ts\" source file should be considered as\n+      // its unredirected source file to avoid a change in declaration files.\n+      env.write('node_modules/a/index.js', `export class ServiceA {}`);\n+      env.write('node_modules/a/index.d.ts', `export declare class ServiceA {}`);\n+      env.write('node_modules/a/package.json', `{\"name\": \"a\", \"version\": \"1.0\"}`);\n+      env.write('node_modules/b/node_modules/a/index.js', `export class ServiceA {}`);\n+      env.write('node_modules/b/node_modules/a/index.d.ts', `export declare class ServiceA {}`);\n+      env.write('node_modules/b/node_modules/a/package.json', `{\"name\": \"a\", \"version\": \"1.0\"}`);\n+      env.write('node_modules/b/index.js', `export {ServiceA as ServiceB} from 'a';`);\n+      env.write('node_modules/b/index.d.ts', `export {ServiceA as ServiceB} from 'a';`);\n+      env.write('component1.ts', `\n+        import {Component} from '@angular/core';\n+        import {ServiceA} from 'a';\n+        import {ServiceB} from 'b';\n+\n+        @Component({selector: 'cmp', template: 'cmp'})\n+        export class Cmp1 {}\n+      `);\n+      env.write('component2.ts', `\n+        import {Component} from '@angular/core';\n+        import {ServiceA} from 'a';\n+        import {ServiceB} from 'b';\n+\n+        @Component({selector: 'cmp2', template: 'cmp'})\n+        export class Cmp2 {}\n+      `);\n+      env.driveMain();\n+      env.flushWrittenFileTracking();\n+\n+      // Now update `component1.ts` and change its imports to avoid complete structure reuse, which\n+      // forces recreation of source file redirects.\n+      env.write('component1.ts', `\n+        import {Component} from '@angular/core';\n+        import {ServiceA} from 'a';\n+\n+        @Component({selector: 'cmp', template: 'cmp'})\n+        export class Cmp1 {}\n+      `);\n+      env.driveMain();\n+\n+      const written = env.getFilesWrittenSinceLastFlush();\n+      expect(written).toContain('/component1.js');\n+      expect(written).not.toContain('/component2.js');\n+    });\n+\n     describe('template type-checking', () => {\n       beforeEach(() => {\n         env.tsconfig({strictTemplates: true});"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 80,
        "deletions": 16
    }
}