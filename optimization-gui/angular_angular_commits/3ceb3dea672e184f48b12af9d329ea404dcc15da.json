{
    "author": "AndrewKushnir",
    "message": "refactor(core): replace loadLContext with getLContext calls (#41606)\n\nThis commit refactors the code to replace `loadLContext` with `getLContext` calls. The only difference between these two functions is that the `loadLContext` supports throwing an error in case `LContext` can not be found. The investigation performed in #41525 revealed that throwing while retrieving `LContext` might have undesirable performance implications, so we should avoid that to make sure there are no accidental perf regressions in other parts of code that used `loadLContext`. Moreover, in most of the places the `loadLContext` was already called in a mode that prevented an error from being thrown, so this refactoring should have no effect on the actual behavior.\n\nPR Close #41606",
    "sha": "3ceb3dea672e184f48b12af9d329ea404dcc15da",
    "files": [
        {
            "sha": "f5db218fac7a326fb4c47fe891829ac07a2c7295",
            "filename": "packages/core/src/debug/debug_node.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Fsrc%2Fdebug%2Fdebug_node.ts",
            "raw_url": "https://github.com/angular/angular/raw/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Fsrc%2Fdebug%2Fdebug_node.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdebug%2Fdebug_node.ts?ref=3ceb3dea672e184f48b12af9d329ea404dcc15da",
            "patch": "@@ -8,11 +8,12 @@\n \n import {Injector} from '../di/injector';\n import {assertTNodeForLView} from '../render3/assert';\n+import {getLContext} from '../render3/context_discovery';\n import {CONTAINER_HEADER_OFFSET, LContainer, NATIVE} from '../render3/interfaces/container';\n import {TElementNode, TNode, TNodeFlags, TNodeType} from '../render3/interfaces/node';\n import {isComponentHost, isLContainer} from '../render3/interfaces/type_checks';\n import {DECLARATION_COMPONENT_VIEW, LView, PARENT, T_HOST, TData, TVIEW} from '../render3/interfaces/view';\n-import {getComponent, getContext, getInjectionTokens, getInjector, getListeners, getLocalRefs, getOwningComponent, loadLContext} from '../render3/util/discovery_utils';\n+import {getComponent, getContext, getInjectionTokens, getInjector, getListeners, getLocalRefs, getOwningComponent} from '../render3/util/discovery_utils';\n import {INTERPOLATION_DELIMITER} from '../render3/util/misc_utils';\n import {renderStringify} from '../render3/util/stringify_utils';\n import {getComponentLViewByIndex, getNativeByTNodeOrNull} from '../render3/util/view_utils';\n@@ -261,13 +262,13 @@ class DebugElement__POST_R3__ extends DebugNode__POST_R3__ implements DebugEleme\n   }\n \n   get name(): string {\n-    try {\n-      const context = loadLContext(this.nativeNode)!;\n+    const context = getLContext(this.nativeNode);\n+    if (context !== null) {\n       const lView = context.lView;\n       const tData = lView[TVIEW].data;\n       const tNode = tData[context.nodeIndex] as TNode;\n       return tNode.value!;\n-    } catch (e) {\n+    } else {\n       return this.nativeNode.nodeName;\n     }\n   }\n@@ -285,8 +286,8 @@ class DebugElement__POST_R3__ extends DebugNode__POST_R3__ implements DebugEleme\n    *  - attribute bindings (e.g. `[attr.role]=\"menu\"`)\n    */\n   get properties(): {[key: string]: any;} {\n-    const context = loadLContext(this.nativeNode, false);\n-    if (context == null) {\n+    const context = getLContext(this.nativeNode);\n+    if (context === null) {\n       return {};\n     }\n \n@@ -311,8 +312,8 @@ class DebugElement__POST_R3__ extends DebugNode__POST_R3__ implements DebugEleme\n       return attributes;\n     }\n \n-    const context = loadLContext(element, false);\n-    if (context == null) {\n+    const context = getLContext(element);\n+    if (context === null) {\n       return {};\n     }\n \n@@ -501,7 +502,7 @@ function _queryAllR3(\n function _queryAllR3(\n     parentElement: DebugElement, predicate: Predicate<DebugElement>|Predicate<DebugNode>,\n     matches: DebugElement[]|DebugNode[], elementsOnly: boolean) {\n-  const context = loadLContext(parentElement.nativeNode, false);\n+  const context = getLContext(parentElement.nativeNode);\n   if (context !== null) {\n     const parentTNode = context.lView[TVIEW].data[context.nodeIndex] as TNode;\n     _queryNodeChildrenR3("
        },
        {
            "sha": "430df1bf2d8f8a505cedee85bb47b51b22c62c46",
            "filename": "packages/core/src/render3/util/discovery_utils.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 34,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts?ref=3ceb3dea672e184f48b12af9d329ea404dcc15da",
            "patch": "@@ -53,7 +53,7 @@ import {getTNode, unwrapRNode} from './view_utils';\n  */\n export function getComponent<T>(element: Element): T|null {\n   assertDomElement(element);\n-  const context = loadLContext(element, false);\n+  const context = getLContext(element);\n   if (context === null) return null;\n \n   if (context.component === undefined) {\n@@ -78,7 +78,7 @@ export function getComponent<T>(element: Element): T|null {\n  */\n export function getContext<T>(element: Element): T|null {\n   assertDomElement(element);\n-  const context = loadLContext(element, false);\n+  const context = getLContext(element);\n   return context === null ? null : context.lView[CONTEXT] as T;\n }\n \n@@ -98,7 +98,7 @@ export function getContext<T>(element: Element): T|null {\n  * @globalApi ng\n  */\n export function getOwningComponent<T>(elementOrDir: Element|{}): T|null {\n-  const context = loadLContext(elementOrDir, false);\n+  const context = getLContext(elementOrDir);\n   if (context === null) return null;\n \n   let lView = context.lView;\n@@ -136,7 +136,7 @@ export function getRootComponents(elementOrDir: Element|{}): {}[] {\n  * @globalApi ng\n  */\n export function getInjector(elementOrDir: Element|{}): Injector {\n-  const context = loadLContext(elementOrDir, false);\n+  const context = getLContext(elementOrDir);\n   if (context === null) return Injector.NULL;\n \n   const tNode = context.lView[TVIEW].data[context.nodeIndex] as TElementNode;\n@@ -149,7 +149,7 @@ export function getInjector(elementOrDir: Element|{}): Injector {\n  * @param element Element for which the injection tokens should be retrieved.\n  */\n export function getInjectionTokens(element: Element): any[] {\n-  const context = loadLContext(element, false);\n+  const context = getLContext(element);\n   if (context === null) return [];\n   const lView = context.lView;\n   const tView = lView[TVIEW];\n@@ -200,7 +200,7 @@ export function getDirectives(node: Node): {}[] {\n     return [];\n   }\n \n-  const context = loadLContext(node, false);\n+  const context = getLContext(node);\n   if (context === null) {\n     return [];\n   }\n@@ -284,22 +284,6 @@ export function getDirectiveMetadata(directiveOrComponentInstance: any): Compone\n   return null;\n }\n \n-/**\n- * Returns LContext associated with a target passed as an argument.\n- * Throws if a given target doesn't have associated LContext.\n- */\n-export function loadLContext(target: {}): LContext;\n-export function loadLContext(target: {}, throwOnNotFound: false): LContext|null;\n-export function loadLContext(target: {}, throwOnNotFound: boolean = true): LContext|null {\n-  const context = getLContext(target);\n-  if (!context && throwOnNotFound) {\n-    throw new Error(\n-        ngDevMode ? `Unable to find context associated with ${stringifyForError(target)}` :\n-                    'Invalid ng target');\n-  }\n-  return context;\n-}\n-\n /**\n  * Retrieve map of local references.\n  *\n@@ -309,7 +293,7 @@ export function loadLContext(target: {}, throwOnNotFound: boolean = true): LCont\n  *    the local references.\n  */\n export function getLocalRefs(target: {}): {[key: string]: any} {\n-  const context = loadLContext(target, false);\n+  const context = getLContext(target);\n   if (context === null) return {};\n \n   if (context.localRefs === undefined) {\n@@ -349,11 +333,6 @@ export function getRenderedText(component: any): string {\n   return hostElement.textContent || '';\n }\n \n-export function loadLContextFromNode(node: Node): LContext {\n-  if (!(node instanceof Node)) throw new Error('Expecting instance of DOM Element');\n-  return loadLContext(node)!;\n-}\n-\n /**\n  * Event listener configuration returned from `getListeners`.\n  * @publicApi\n@@ -405,7 +384,7 @@ export interface Listener {\n  */\n export function getListeners(element: Element): Listener[] {\n   assertDomElement(element);\n-  const lContext = loadLContext(element, false);\n+  const lContext = getLContext(element);\n   if (lContext === null) return [];\n \n   const lView = lContext.lView;\n@@ -458,9 +437,15 @@ function isDirectiveDefHack(obj: any): obj is DirectiveDef<any> {\n  * @param element DOM element which is owned by an existing component's view.\n  */\n export function getDebugNode(element: Element): DebugNode|null {\n-  let debugNode: DebugNode|null = null;\n+  if (ngDevMode && !(element instanceof Node)) {\n+    throw new Error('Expecting instance of DOM Element');\n+  }\n+\n+  const lContext = getLContext(element);\n+  if (lContext === null) {\n+    return null;\n+  }\n \n-  const lContext = loadLContextFromNode(element);\n   const lView = lContext.lView;\n   const nodeIndex = lContext.nodeIndex;\n   if (nodeIndex !== -1) {\n@@ -471,10 +456,10 @@ export function getDebugNode(element: Element): DebugNode|null {\n         isLView(valueInLView) ? (valueInLView[T_HOST] as TNode) : getTNode(lView[TVIEW], nodeIndex);\n     ngDevMode &&\n         assertEqual(tNode.index, nodeIndex, 'Expecting that TNode at index is same as index');\n-    debugNode = buildDebugNode(tNode, lView);\n+    return buildDebugNode(tNode, lView);\n   }\n \n-  return debugNode;\n+  return null;\n }\n \n /**\n@@ -486,7 +471,7 @@ export function getDebugNode(element: Element): DebugNode|null {\n  * @param target DOM element or component instance for which to retrieve the LView.\n  */\n export function getComponentLView(target: any): LView {\n-  const lContext = loadLContext(target);\n+  const lContext = getLContext(target)!;\n   const nodeIndx = lContext.nodeIndex;\n   const lView = lContext.lView;\n   const componentLView = lView[nodeIndx];"
        },
        {
            "sha": "a1d589eabe7550a2bcaa07eef86244d26422a512",
            "filename": "packages/core/test/acceptance/discover_utils_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts?ref=3ceb3dea672e184f48b12af9d329ea404dcc15da",
            "patch": "@@ -17,8 +17,9 @@ import {getElementStyles} from '@angular/core/testing/src/styling';\n import {expect} from '@angular/core/testing/src/testing_internal';\n import {onlyInIvy} from '@angular/private/testing';\n \n+import {getLContext} from '../../src/render3/context_discovery';\n import {getHostElement, markDirty} from '../../src/render3/index';\n-import {ComponentDebugMetadata, getComponent, getComponentLView, getContext, getDebugNode, getDirectiveMetadata, getDirectives, getInjectionTokens, getInjector, getListeners, getLocalRefs, getOwningComponent, getRootComponents, loadLContext} from '../../src/render3/util/discovery_utils';\n+import {ComponentDebugMetadata, getComponent, getComponentLView, getContext, getDebugNode, getDirectiveMetadata, getDirectives, getInjectionTokens, getInjector, getListeners, getLocalRefs, getOwningComponent, getRootComponents} from '../../src/render3/util/discovery_utils';\n \n onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n   let fixture: ComponentFixture<MyApp>;\n@@ -270,17 +271,17 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n     });\n   });\n \n-  describe('loadLContext', () => {\n+  describe('getLContext', () => {\n     it('should work on components', () => {\n-      const lContext = loadLContext(child[0]);\n+      const lContext = getLContext(child[0])!;\n       expect(lContext).toBeDefined();\n       expect(lContext.native as any).toBe(child[0]);\n     });\n \n     it('should work on templates', () => {\n       const templateComment = Array.from((fixture.nativeElement as HTMLElement).childNodes)\n                                   .find((node: ChildNode) => node.nodeType === Node.COMMENT_NODE)!;\n-      const lContext = loadLContext(templateComment);\n+      const lContext = getLContext(templateComment)!;\n       expect(lContext).toBeDefined();\n       expect(lContext.native as any).toBe(templateComment);\n     });\n@@ -290,7 +291,7 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n                                      .find(\n                                          (node: ChildNode) => node.nodeType === Node.COMMENT_NODE &&\n                                              node.textContent === `ng-container`)!;\n-      const lContext = loadLContext(ngContainerComment);\n+      const lContext = getLContext(ngContainerComment)!;\n       expect(lContext).toBeDefined();\n       expect(lContext.native as any).toBe(ngContainerComment);\n     });"
        },
        {
            "sha": "64763f76509061bb2f200235f35eb89c30264e9f",
            "filename": "packages/core/test/acceptance/ngdevmode_debug_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Ftest%2Facceptance%2Fngdevmode_debug_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3ceb3dea672e184f48b12af9d329ea404dcc15da/packages%2Fcore%2Ftest%2Facceptance%2Fngdevmode_debug_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fngdevmode_debug_spec.ts?ref=3ceb3dea672e184f48b12af9d329ea404dcc15da",
            "patch": "@@ -8,8 +8,8 @@\n \n import {CommonModule} from '@angular/common';\n import {Component} from '@angular/core';\n-import {LView} from '@angular/core/src/render3/interfaces/view';\n-import {getComponentLView, loadLContext} from '@angular/core/src/render3/util/discovery_utils';\n+import {getLContext} from '@angular/core/src/render3/context_discovery';\n+import {getComponentLView} from '@angular/core/src/render3/util/discovery_utils';\n import {createNamedArrayType} from '@angular/core/src/util/named_array_type';\n import {TestBed} from '@angular/core/testing';\n import {onlyInIvy} from '@angular/private/testing';\n@@ -32,7 +32,7 @@ onlyInIvy('Debug information exist in ivy only').describe('ngDevMode debug', ()\n \n       TestBed.configureTestingModule({declarations: [MyApp], imports: [CommonModule]});\n       const fixture = TestBed.createComponent(MyApp);\n-      const rootLView = loadLContext(fixture.nativeElement).lView;\n+      const rootLView = getLContext(fixture.nativeElement)!.lView;\n       expect(rootLView.constructor.name).toEqual('LRootView');\n \n       const componentLView = getComponentLView(fixture.componentInstance);\n@@ -41,7 +41,7 @@ onlyInIvy('Debug information exist in ivy only').describe('ngDevMode debug', ()\n       const element: HTMLElement = fixture.nativeElement;\n       fixture.detectChanges();\n       const li = element.querySelector('li')!;\n-      const embeddedLView = loadLContext(li).lView;\n+      const embeddedLView = getLContext(li)!.lView;\n       expect(embeddedLView.constructor.name).toEqual('LEmbeddedView_MyApp_li_1');\n     });\n   });"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 39,
        "deletions": 52
    }
}