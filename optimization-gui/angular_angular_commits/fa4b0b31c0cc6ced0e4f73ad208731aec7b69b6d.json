{
    "author": "thePunderWoman",
    "message": "Revert \"build: simplify generation of closure locale file\" (#42521)\n\nThis reverts commit 5fca35de0de8da24b8a046616404e74ecb4547b4.\n\nPR Close #42521",
    "sha": "fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d",
    "files": [
        {
            "sha": "65470105af854de0b31ba7deb53575df8880d68d",
            "filename": "packages/common/locales/closure-locale.ts",
            "status": "modified",
            "additions": 763,
            "deletions": 6207,
            "changes": 6970,
            "blob_url": "https://github.com/angular/angular/blob/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fclosure-locale.ts",
            "raw_url": "https://github.com/angular/angular/raw/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fclosure-locale.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fclosure-locale.ts?ref=fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d"
        },
        {
            "sha": "eab8a7a1fc1b2fc3600cca18b4bd747af1af77bf",
            "filename": "packages/common/locales/generate-locales-tool/bin/write-locale-files-to-dist.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fbin%2Fwrite-locale-files-to-dist.ts",
            "raw_url": "https://github.com/angular/angular/raw/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fbin%2Fwrite-locale-files-to-dist.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fbin%2Fwrite-locale-files-to-dist.ts?ref=fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d",
            "patch": "@@ -31,8 +31,22 @@ function main(outputDir: string) {\n   console.info(`Writing locales to: ${outputDir}`);\n \n   // Generate locale files for all locales we have data for.\n-  cldrData.availableLocales.forEach(localeData => {\n-    const locale = localeData.locale;\n+  cldrData.availableLocales.forEach((locale: string) => {\n+    const localeData = cldrData.getLocaleData(locale);\n+\n+    // If `cldrjs` is unable to resolve a `bundle` for the current locale, then there is no data\n+    // for this locale, and it should not be generated. This can happen as with older versions of\n+    // CLDR where `availableLocales.json` specifies locales for which no data is available\n+    // (even within the `full` tier packages). See:\n+    // http://cldr.unicode.org/development/development-process/design-proposals/json-packaging.\n+    // TODO(devversion): Remove if we update to CLDR v39 where this seems fixed. Note that this\n+    //  worked before in the Gulp tooling without such a check because the `cldr-data-downloader`\n+    //  overwrote the `availableLocales` to only capture locales with data.\n+    if (localeData && !(localeData.attributes as any).bundle) {\n+      console.info(`Skipping generation of ${locale} as there is no data.`);\n+      return;\n+    }\n+\n     const localeFile = generateLocale(locale, localeData, baseCurrencies);\n     const localeExtraFile = generateLocaleExtra(locale, localeData);\n     const localeGlobalFile = generateLocaleGlobalFile(locale, localeData, baseCurrencies);"
        },
        {
            "sha": "9da8b77c5bb5bd39196ff0c2cf5c118d64b21046",
            "filename": "packages/common/locales/generate-locales-tool/cldr-data.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 23,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fcldr-data.ts",
            "raw_url": "https://github.com/angular/angular/raw/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fcldr-data.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fcldr-data.ts?ref=fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d",
            "patch": "@@ -40,7 +40,7 @@ export class CldrData {\n   cldrDataDir = runfiles.resolve('cldr_data');\n \n   /** List of all available locales CLDR provides data for. */\n-  availableLocales: CldrStatic[];\n+  availableLocales: string[];\n \n   constructor() {\n     this._loadAndPopulateCldrData();\n@@ -53,28 +53,8 @@ export class CldrData {\n   }\n \n   /** Gets a list of all locales CLDR provides data for. */\n-  private _getAvailableLocales(): CldrStatic[] {\n-    const allLocales =\n-        require(`${this.cldrDataDir}/${CLDR_AVAILABLE_LOCALES_PATH}`).availableLocales.full;\n-    const localesWithData: CldrStatic[] = [];\n-\n-    for (const localeName of allLocales) {\n-      const localeData = this.getLocaleData(localeName);\n-\n-      // If `cldrjs` is unable to resolve a `bundle` for the current locale, then there is no data\n-      // for this locale, and it should not be generated. This can happen as with older versions of\n-      // CLDR where `availableLocales.json` specifies locales for which no data is available\n-      // (even within the `full` tier packages). See:\n-      // http://cldr.unicode.org/development/development-process/design-proposals/json-packaging.\n-      // TODO(devversion): Remove if we update to CLDR v39 where this seems fixed. Note that this\n-      //  worked before in the Gulp tooling without such a check because the `cldr-data-downloader`\n-      //  overwrote the `availableLocales` to only capture locales with data.\n-      if (localeData && (localeData.attributes as any).bundle) {\n-        localesWithData.push(localeData);\n-      }\n-    }\n-\n-    return localesWithData;\n+  private _getAvailableLocales(): string[] {\n+    return require(`${this.cldrDataDir}/${CLDR_AVAILABLE_LOCALES_PATH}`).availableLocales.full;\n   }\n \n   /** Loads the CLDR data and populates the `cldrjs` library with it. */"
        },
        {
            "sha": "810b960a6fc693579a533e2186ea813ebbeef318",
            "filename": "packages/common/locales/generate-locales-tool/closure-locale-file.ts",
            "status": "modified",
            "additions": 115,
            "deletions": 23,
            "changes": 138,
            "blob_url": "https://github.com/angular/angular/blob/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts?ref=fa4b0b31c0cc6ced0e4f73ad208731aec7b69b6d",
            "patch": "@@ -6,35 +6,126 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CldrStatic} from 'cldrjs';\n-\n import {CldrData} from './cldr-data';\n import {fileHeader} from './file-header';\n import {BaseCurrencies} from './locale-base-currencies';\n import {generateLocale} from './locale-file';\n \n+/**\n+ * List of locales used by Closure. These locales will be incorporated in the generated\n+ * closure locale file. See:\n+ * https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimepatterns.js#L2450\n+ */\n+const GOOG_LOCALES = [\n+  'af',    'am',    'ar',    'ar-DZ', 'az',    'be',    'bg',    'bn',     'br',    'bs',\n+  'ca',    'chr',   'cs',    'cy',    'da',    'de',    'de-AT', 'de-CH',  'el',    'en-AU',\n+  'en-CA', 'en-GB', 'en-IE', 'en-IN', 'en-SG', 'en-ZA', 'es',    'es-419', 'es-MX', 'es-US',\n+  'et',    'eu',    'fa',    'fi',    'fr',    'fr-CA', 'ga',    'gl',     'gsw',   'gu',\n+  'haw',   'hi',    'hr',    'hu',    'hy',    'in',    'is',    'it',     'iw',    'ja',\n+  'ka',    'kk',    'km',    'kn',    'ko',    'ky',    'ln',    'lo',     'lt',    'lv',\n+  'mk',    'ml',    'mn',    'mo',    'mr',    'ms',    'mt',    'my',     'ne',    'nl',\n+  'no',    'or',    'pa',    'pl',    'pt',    'pt-PT', 'ro',    'ru',     'sh',    'si',\n+  'sk',    'sl',    'sq',    'sr',    'sv',    'sw',    'ta',    'te',     'th',    'tl',\n+  'tr',    'uk',    'ur',    'uz',    'vi',    'zh',    'zh-CN', 'zh-HK',  'zh-TW', 'zu'\n+];\n+\n+export function generateClosureLocaleFile(\n+    cldrData: CldrData, baseCurrencies: BaseCurrencies): string {\n+  // locale id aliases to support deprecated locale ids used by closure\n+  // it maps deprecated ids --> new ids\n+  // manually extracted from ./cldr-data/supplemental/aliases.json\n+  // TODO: Consider extracting directly from the CLDR data instead.\n+  const aliases = {\n+    'in': 'id',\n+    'iw': 'he',\n+    'mo': 'ro-MD',\n+    'no': 'nb',\n+    'nb': 'no-NO',\n+    'sh': 'sr-Latn',\n+    'tl': 'fil',\n+    'pt': 'pt-BR',\n+    'zh-CN': 'zh-Hans-CN',\n+    'zh-Hans-CN': 'zh-Hans',\n+    'zh-HK': 'zh-Hant-HK',\n+    'zh-TW': 'zh-Hant-TW',\n+    'zh-Hant-TW': 'zh-Hant',\n+  };\n+\n+  return generateAllLocalesFile(cldrData, GOOG_LOCALES, aliases, baseCurrencies);\n+}\n+\n /**\n  * Generate a file that contains all locale to import for closure.\n  * Tree shaking will only keep the data for the `goog.LOCALE` locale.\n  */\n-export function generateClosureLocaleFile(cldrData: CldrData, baseCurrencies: BaseCurrencies) {\n-  const locales = cldrData.availableLocales;\n-\n-  function generateLocaleConstant(localeData: CldrStatic): string {\n-    const locale = localeData.locale;\n-    const localeNameFormattedForJs = formatLocale(locale);\n-    return generateLocale(locale, localeData, baseCurrencies)\n-        .replace(`${fileHeader}\\n`, '')\n-        .replace('export default ', `export const locale_${localeNameFormattedForJs} = `)\n-        .replace('function plural', `function plural_${localeNameFormattedForJs}`)\n-        .replace(/,\\s+plural/, `, plural_${localeNameFormattedForJs}`)\n-        .replace(/\\s*const u = undefined;\\s*/, '');\n-  }\n+function generateAllLocalesFile(\n+    cldrData: CldrData, locales: string[], aliases: {[name: string]: string},\n+    baseCurrencies: BaseCurrencies) {\n+  const existingLocalesAliases: {[locale: string]: Set<string>} = {};\n+  const existingLocalesData: {[locale: string]: string} = {};\n+\n+  // for each locale, get the data and the list of equivalent locales\n+  locales.forEach(locale => {\n+    const eqLocales = new Set<string>();\n+    eqLocales.add(locale);\n+    if (locale.match(/-/)) {\n+      eqLocales.add(locale.replace(/-/g, '_'));\n+    }\n+\n+    // check for aliases\n+    const alias = aliases[locale];\n+    if (alias) {\n+      eqLocales.add(alias);\n+\n+      if (alias.match(/-/)) {\n+        eqLocales.add(alias.replace(/-/g, '_'));\n+      }\n+\n+      // to avoid duplicated \"case\" we regroup all locales in the same \"case\"\n+      // the simplest way to do that is to have alias aliases\n+      // e.g. 'no' --> 'nb', 'nb' --> 'no-NO'\n+      // which means that we'll have 'no', 'nb' and 'no-NO' in the same \"case\"\n+      const aliasKeys = Object.keys(aliases);\n+      for (let i = 0; i < aliasKeys.length; i++) {\n+        const aliasValue = aliases[alias];\n+        if (aliasKeys.indexOf(alias) !== -1 && !eqLocales.has(aliasValue)) {\n+          eqLocales.add(aliasValue);\n+\n+          if (aliasValue.match(/-/)) {\n+            eqLocales.add(aliasValue.replace(/-/g, '_'));\n+          }\n+        }\n+      }\n+    }\n+\n+    const localeNameForData = aliases[locale] ?? locale;\n+    const localeData = cldrData.getLocaleData(localeNameForData);\n+    const localeName = formatLocale(locale);\n+    existingLocalesData[locale] =\n+        generateLocale(localeNameForData, localeData, baseCurrencies)\n+            .replace(`${fileHeader}\\n`, '')\n+            .replace('export default ', `export const locale_${localeName} = `)\n+            .replace('function plural', `function plural_${localeName}`)\n+            .replace(/,\\s+plural/, `, plural_${localeName}`)\n+            .replace(/\\s*const u = undefined;\\s*/, '');\n+\n+    existingLocalesAliases[locale] = eqLocales;\n+  });\n+\n+  function generateCases(locale: string) {\n+    let str = '';\n+    let locales: string[] = [];\n+    const eqLocales = existingLocalesAliases[locale];\n+    eqLocales.forEach(l => {\n+      str += `case '${l}':\\n`;\n+      locales.push(`'${l}'`);\n+    });\n+    let localesStr = '[' + locales.join(',') + ']';\n \n-  function generateCase(localeName: string) {\n-    return `case '${localeName}':\\n` +\n-        `l = locale_${formatLocale(localeName)};\\n` +\n-        `break;\\n`;\n+    str += `  l = locale_${formatLocale(locale)};\n+    locales = ${localesStr};\n+    break;\\n`;\n+    return str;\n   }\n \n   return `${fileHeader}\n@@ -43,15 +134,16 @@ import {registerLocaleData} from '../src/i18n/locale_data';\n \n const u = undefined;\n \n-${locales.map(locale => `${generateLocaleConstant(locale)}`).join('\\n')}\n+${locales.map(locale => `${existingLocalesData[locale]}`).join('\\n')}\n \n let l: any;\n+let locales: string[] = [];\n \n switch (goog.LOCALE) {\n-${locales.map(localeData => generateCase(localeData.locale)).join('')}}\n+${locales.map(locale => generateCases(locale)).join('')}}\n \n-if (l) {\n-  registerLocaleData(l);\n+if(l) {\n+  locales.forEach(locale => registerLocaleData(l, locale));\n }\n `;\n }"
        }
    ],
    "stats": {
        "total": 7152,
        "additions": 897,
        "deletions": 6255
    }
}