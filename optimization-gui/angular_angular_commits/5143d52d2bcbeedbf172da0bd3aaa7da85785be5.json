{
    "author": "gkalpak",
    "message": "build(docs-infra): switch `deploy-to-firebase.sh` script to JS (#39470)\n\nThis commit switches the `deploy-to-firebase.sh` script, that we use for\ndeploying angular.io to production, from Bash to JavaScript. This makes\nthe script easier to maintain.\n\nFor the same reasons, it also switches the `deploy-to-firebase.test.sh`\nscript, that we use for testing the `deploy-to-firebase` script, from\nBash to JavaScript (using jasmine as the test runner).\n\nFinally, this commit also updates ShellJS to the latest version to get\nbetter error messages (including the actual error) when `exec()` fails.\n\nNOTE: Before switching the test script to JS, I verified that the new\n      `deploy-to-firebase.js` script passed the tests with the old\n      `deploy-to-firebase.test.sh` script.\n\nPR Close #39470",
    "sha": "5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
    "files": [
        {
            "sha": "149a429fbc9788db77139e086d7426dfd6c55936",
            "filename": "aio/aio-builds-setup/docs/misc--integrate-with-ci.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Faio-builds-setup%2Fdocs%2Fmisc--integrate-with-ci.md",
            "raw_url": "https://github.com/angular/angular/raw/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Faio-builds-setup%2Fdocs%2Fmisc--integrate-with-ci.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Faio-builds-setup%2Fdocs%2Fmisc--integrate-with-ci.md?ref=5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
            "patch": "@@ -6,4 +6,4 @@ TODO (gkalpak): Add docs. Mention:\n   Relevant files: `aio/aio-builds-setup/scripts/test.sh`\n - Deploying from CI.\n   Relevant files: `.circleci/config.yml`, `scripts/ci/deploy.sh`, `aio/scripts/build-artifacts.sh`,\n-  `aio/scripts/deploy-to-firebase.sh`\n+  `aio/scripts/deploy-to-firebase.js`"
        },
        {
            "sha": "0994bb73071cf39fe296f232fa3aa10c339fbd6e",
            "filename": "aio/package.json",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fpackage.json?ref=5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
            "patch": "@@ -49,7 +49,7 @@\n     \"example-use-local\": \"node tools/ng-packages-installer overwrite ./tools/examples/shared --debug --force\",\n     \"example-use-npm\": \"node tools/ng-packages-installer restore ./tools/examples/shared\",\n     \"example-check-local\": \"node tools/ng-packages-installer check ./tools/examples/shared\",\n-    \"deploy-production\": \"scripts/deploy-to-firebase.sh\",\n+    \"deploy-production\": \"node scripts/deploy-to-firebase\",\n     \"check-env\": \"yarn ~~check-env\",\n     \"postcheck-env\": \"yarn aio-check-local\",\n     \"payload-size\": \"scripts/payload.sh\",\n@@ -62,7 +62,7 @@\n     \"redirects-test\": \"node tests/deployment/unit/test\",\n     \"firebase-utils-test\": \"node tools/firebase-test-utils/test\",\n     \"tools-lint\": \"tslint --config \\\"tools/tslint.json\\\" --project \\\"tools/firebase-test-utils\\\"\",\n-    \"tools-test\": \"./scripts/deploy-to-firebase.test.sh && yarn docs-test && yarn boilerplate:test && jasmine tools/ng-packages-installer/index.spec.js && yarn firebase-utils-test\",\n+    \"tools-test\": \"yarn docs-test && yarn boilerplate:test && jasmine tools/ng-packages-installer/index.spec.js && jasmine scripts/deploy-to-firebase.spec.js && yarn firebase-utils-test\",\n     \"preserve-and-sync\": \"yarn docs\",\n     \"serve-and-sync\": \"run-p \\\"docs-watch --watch-only\\\" \\\"start {@}\\\" --\",\n     \"boilerplate:add\": \"node ./tools/examples/example-boilerplate add\",\n@@ -161,7 +161,7 @@\n     \"remark-html\": \"^8.0.0\",\n     \"rimraf\": \"^2.6.1\",\n     \"semver\": \"^5.3.0\",\n-    \"shelljs\": \"^0.7.7\",\n+    \"shelljs\": \"^0.8.4\",\n     \"tree-kill\": \"^1.1.0\",\n     \"ts-node\": \"^8.4.1\",\n     \"tslint\": \"~6.1.0\","
        },
        {
            "sha": "f5fa263ba83f808f74223e18e023298c5fc8be31",
            "filename": "aio/scripts/deploy-to-firebase.js",
            "status": "added",
            "additions": 165,
            "deletions": 0,
            "changes": 165,
            "blob_url": "https://github.com/angular/angular/blob/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "raw_url": "https://github.com/angular/angular/raw/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.js?ref=5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
            "patch": "@@ -0,0 +1,165 @@\n+#!/bin/env node\n+//\n+// WARNING: `CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN` should NOT be printed.\n+//\n+'use strict';\n+\n+const {cd, cp, exec: _exec, set} = require('shelljs');\n+\n+set('-e');\n+\n+\n+// Arguments and environment variables\n+const args = process.argv.slice(2);\n+const dryRun = args[0] === '--dry-run';\n+\n+const {\n+  CI_AIO_MIN_PWA_SCORE,\n+  CI_BRANCH,\n+  CI_COMMIT,\n+  CI_PULL_REQUEST,\n+  CI_REPO_NAME,\n+  CI_REPO_OWNER,\n+  CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN,\n+  CI_STABLE_BRANCH,\n+} = process.env;\n+\n+// Do not deploy if we are running in a fork.\n+if (`${CI_REPO_OWNER}/${CI_REPO_NAME}` !== 'angular/angular') {\n+  console.log('Skipping deploy because this is not angular/angular.');\n+  process.exit(0);\n+}\n+\n+// Do not deploy if this is a PR. PRs are deployed in the `aio_preview` CircleCI job.\n+if (CI_PULL_REQUEST !== 'false') {\n+  console.log('Skipping deploy because this is a PR build.');\n+  process.exit(0);\n+}\n+\n+// Do not deploy if the current commit is not the latest on its branch.\n+const latestCommit = exec(`git ls-remote origin ${CI_BRANCH}`).slice(0, 40);\n+if (CI_COMMIT !== latestCommit) {\n+  console.log(`Skipping deploy because ${CI_COMMIT} is not the latest commit (${latestCommit}).`);\n+  process.exit(0);\n+}\n+\n+// The deployment mode is computed based on the branch we are building.\n+const currentBranchMajorVersion = computeMajorVersion(CI_BRANCH);\n+// Special-case v9, because it is piloting the Firebase hosting \"multisites\" setup.\n+// See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n+const isV9 = currentBranchMajorVersion === 9;\n+const deployInfoPerTarget = {\n+  next: {\n+    deployEnv: 'next',\n+    projectId: 'aio-staging',\n+    siteId: 'aio-staging',\n+    deployedUrl: 'https://next.angular.io/',\n+  },\n+  stable: {\n+    deployEnv: 'stable',\n+    projectId: 'angular-io',\n+    siteId: 'angular-io',\n+    deployedUrl: 'https://angular.io/',\n+  },\n+  archive: {\n+    deployEnv: 'archive',\n+    projectId: isV9 ? 'aio-staging' : `v${currentBranchMajorVersion}-angular-io`,\n+    siteId: isV9 ? 'v9-angular-io' : `v${currentBranchMajorVersion}-angular-io`,\n+    deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+  },\n+};\n+let deployInfo = null;\n+\n+if (CI_BRANCH === 'master') {\n+  deployInfo = deployInfoPerTarget.next;\n+} else if (CI_BRANCH === CI_STABLE_BRANCH) {\n+  deployInfo = deployInfoPerTarget.stable;\n+} else {\n+  const stableBranchMajorVersion = computeMajorVersion(CI_STABLE_BRANCH);\n+\n+  // Do not deploy if the major version is not less than the stable branch major version.\n+  if (currentBranchMajorVersion >= stableBranchMajorVersion) {\n+    console.log(\n+        `Skipping deploy of branch \"${CI_BRANCH}\" to Firebase.\\n` +\n+        'We only deploy archive branches with the major version less than the stable branch: ' +\n+        `\"${CI_STABLE_BRANCH}\"`);\n+    process.exit(0);\n+  }\n+\n+  // Find the branch that has highest minor version for the given `currentBranchMajorVersion`.\n+  const mostRecentMinorVersion =\n+    // List the branches that start with the major version.\n+    exec(`git ls-remote origin refs/heads/${currentBranchMajorVersion}.*.x`).split('\\n')\n+        // Extract the version number.\n+        .map(line => line.split('/')[2])\n+        // Sort by the minor version.\n+        .sort((a, b) => a.split('.')[1] - b.split('.')[1])\n+        // Get the highest version.\n+        .pop();\n+\n+  // Do not deploy as it is not the latest branch for the given major version.\n+  if (CI_BRANCH !== mostRecentMinorVersion) {\n+    console.log(\n+        `Skipping deploy of branch \"${CI_BRANCH}\" to Firebase.\\n` +\n+        `There is a more recent branch with the same major version: \"${mostRecentMinorVersion}\"`);\n+    process.exit(0);\n+  }\n+\n+  deployInfo = deployInfoPerTarget.archive;\n+}\n+\n+const {deployEnv, projectId, siteId, deployedUrl} = deployInfo;\n+console.log(\n+    `Git branch        : ${CI_BRANCH}\\n` +\n+    `Build/deploy mode : ${deployEnv}\\n` +\n+    `Firebase project  : ${projectId}\\n` +\n+    `Firebase site     : ${siteId}\\n` +\n+    `Deployment URL    : ${deployedUrl}\\n`);\n+\n+if (dryRun) {\n+  process.exit(0);\n+}\n+\n+// Deploy\n+cd(`${__dirname}/..`);\n+\n+console.log('\\n\\n\\n==== Build the AIO app. ====\\n');\n+yarn(`build --configuration=${deployEnv} --progress=false`);\n+\n+console.log('\\n\\n\\n==== Add any mode-specific files into the AIO distribution. ====\\n');\n+cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+\n+\n+console.log('\\n\\n\\n==== Update opensearch descriptor for AIO with `deployedUrl`. ====\\n');\n+yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`);  // The URL must end with `/`.\n+\n+console.log('\\n\\n\\n==== Check payload size and upload the numbers to Firebase DB. ====\\n');\n+yarn('payload-size');\n+\n+console.log('\\n\\n\\n==== Deploy AIO to Firebase hosting. ====\\n');\n+yarn(`firebase use \"${projectId}\" --token \"${CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN}\"`);\n+yarn(\n+    `firebase target:apply hosting aio \"${siteId}\" --token ` +\n+    `\"${CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN}\"`);\n+yarn(\n+    `firebase deploy --only hosting:aio --message \"Commit: ${CI_COMMIT}\" --non-interactive ` +\n+    `--token ${CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN}`);\n+\n+console.log('\\n\\n\\n==== Run PWA-score tests. ====\\n');\n+yarn(`test-pwa-score \"${deployedUrl}\" \"${CI_AIO_MIN_PWA_SCORE}\"`);\n+\n+\n+// Helpers\n+function computeMajorVersion(branchName) {\n+  return +branchName.split('.', 1)[0];\n+}\n+\n+function exec(cmd, opts) {\n+  // Using `silent: true` to ensure no secret env variables are printed.\n+  return _exec(cmd, {silent: true, ...opts}).trim();\n+}\n+\n+function yarn(cmd) {\n+  // Using `--silent` to ensure no secret env variables are printed.\n+  return exec(`yarn --silent ${cmd}`);\n+}"
        },
        {
            "sha": "f19c97e60e2e6a1dd396e37cf94d26bdce45f56d",
            "filename": "aio/scripts/deploy-to-firebase.sh",
            "status": "removed",
            "additions": 0,
            "deletions": 132,
            "changes": 132,
            "blob_url": "https://github.com/angular/angular/blob/8317042483c52b9b5035c49d76fecc4b43a23090/aio%2Fscripts%2Fdeploy-to-firebase.sh",
            "raw_url": "https://github.com/angular/angular/raw/8317042483c52b9b5035c49d76fecc4b43a23090/aio%2Fscripts%2Fdeploy-to-firebase.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.sh?ref=8317042483c52b9b5035c49d76fecc4b43a23090",
            "patch": "@@ -1,132 +0,0 @@\n-#!/usr/bin/env bash\n-\n-# WARNING: CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN should NOT be printed.\n-set +x -eu -o pipefail\n-\n-# Do not deploy if we are running in a fork.\n-if [[ \"$CI_REPO_OWNER/$CI_REPO_NAME\" != \"angular/angular\" ]]; then\n-  echo \"Skipping deploy because this is not angular/angular.\"\n-  exit 0\n-fi\n-\n-# Do not deploy if this is a PR. PRs are deployed in the `aio_preview` CircleCI job.\n-if [[ $CI_PULL_REQUEST != \"false\" ]]; then\n-  echo \"Skipping deploy because this is a PR build.\"\n-  exit 0\n-fi\n-\n-# Do not deploy if the current commit is not the latest on its branch.\n-readonly latestCommit=$(git ls-remote origin $CI_BRANCH | cut -c1-40)\n-if [[ $CI_COMMIT != $latestCommit ]]; then\n-  echo \"Skipping deploy because $CI_COMMIT is not the latest commit ($latestCommit).\"\n-  exit 0\n-fi\n-\n-# The deployment mode is computed based on the branch we are building\n-if [[ $CI_BRANCH == master ]]; then\n-  readonly deployEnv=next\n-elif [[ $CI_BRANCH == $CI_STABLE_BRANCH ]]; then\n-  readonly deployEnv=stable\n-else\n-  # Extract the major versions from the branches, e.g. the 4 from 4.3.x\n-  readonly majorVersion=${CI_BRANCH%%.*}\n-  readonly majorVersionStable=${CI_STABLE_BRANCH%%.*}\n-\n-  # Do not deploy if the major version is not less than the stable branch major version\n-  if (( $majorVersion >= $majorVersionStable )); then\n-    echo \"Skipping deploy of branch \\\"$CI_BRANCH\\\" to firebase.\"\n-    echo \"We only deploy archive branches with the major version less than the stable branch: \\\"$CI_STABLE_BRANCH\\\"\"\n-    exit 0\n-  fi\n-\n-  # Find the branch that has highest minor version for the given `$majorVersion`\n-  readonly mostRecentMinorVersion=$(\n-    # List the branches that start with the major version\n-    git ls-remote origin refs/heads/${majorVersion}.*.x |\n-    # Extract the version number\n-    awk -F'/' '{print $3}' |\n-    # Sort by the minor version\n-    sort -t. -k 2,2n |\n-    # Get the highest version\n-    tail -n1\n-  )\n-\n-  # Do not deploy as it is not the latest branch for the given major version\n-  if [[ $CI_BRANCH != $mostRecentMinorVersion ]]; then\n-    echo \"Skipping deploy of branch \\\"$CI_BRANCH\\\" to firebase.\"\n-    echo \"There is a more recent branch with the same major version: \\\"$mostRecentMinorVersion\\\"\"\n-    exit 0\n-  fi\n-\n-  readonly deployEnv=archive\n-fi\n-\n-case $deployEnv in\n-  next)\n-    readonly projectId=aio-staging\n-    readonly siteId=$projectId\n-    readonly deployedUrl=https://next.angular.io/\n-    readonly firebaseToken=$CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN\n-    ;;\n-  stable)\n-    readonly projectId=angular-io\n-    readonly siteId=$projectId\n-    readonly deployedUrl=https://angular.io/\n-    readonly firebaseToken=$CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN\n-    ;;\n-  archive)\n-    # Special case v9-angular-io because its piloting the firebase hosting \"multisites\" setup\n-    # See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n-    if [[ \"$majorVersion\" == \"9\" ]]; then\n-      readonly projectId=aio-staging\n-      readonly siteId=v9-angular-io\n-    else\n-      readonly projectId=v${majorVersion}-angular-io\n-      readonly siteId=$projectId\n-    fi\n-\n-    readonly deployedUrl=https://v${majorVersion}.angular.io/\n-    readonly firebaseToken=$CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN\n-    ;;\n-esac\n-\n-echo \"Git branch        : $CI_BRANCH\"\n-echo \"Build/deploy mode : $deployEnv\"\n-echo \"Firebase project  : $projectId\"\n-echo \"Firebase site     : $siteId\"\n-echo \"Deployment URL    : $deployedUrl\"\n-\n-if [[ ${1:-} == \"--dry-run\" ]]; then\n-  exit 0\n-fi\n-\n-# Deploy\n-(\n-  cd \"`dirname $0`/..\"\n-\n-  echo \"\\n\\n\\n==== Build the aio app ====\\n\"\n-  yarn build --configuration=$deployEnv --progress=false\n-\n-\n-  echo \"\\n\\n\\n==== Add any mode-specific files into the aio distribution ====\\n\"\n-  cp -rf src/extra-files/$deployEnv/. dist/\n-\n-\n-  echo \"\\n\\n\\n==== Update opensearch descriptor for aio with the deployedUrl ====\\n\"\n-  # deployedUrl must end with /\n-  yarn set-opensearch-url $deployedUrl\n-\n-  echo \"\\n\\n\\n==== Check payload size and upload the numbers to firebase db ====\\n\"\n-  yarn payload-size\n-\n-\n-  echo \"\\n\\n\\n==== Deploy aio to firebase hosting ====\\n\"\n-\n-  yarn firebase use \"${projectId}\" --token \"$firebaseToken\"\n-  yarn firebase target:apply hosting aio $siteId --token \"$firebaseToken\"\n-  yarn firebase deploy --only hosting:aio --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n-\n-\n-  echo \"\\n\\n\\n==== Run PWA-score tests ====\\n\"\n-  yarn test-pwa-score \"$deployedUrl\" \"$CI_AIO_MIN_PWA_SCORE\"\n-)"
        },
        {
            "sha": "e09ac1b2193ade31fc104bdf40e6c94af9b6a7b2",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "added",
            "additions": 187,
            "deletions": 0,
            "changes": 187,
            "blob_url": "https://github.com/angular/angular/blob/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
            "patch": "@@ -0,0 +1,187 @@\n+#!/usr/bin/env node\n+'use strict';\n+\n+const {execSync} = require('child_process');\n+\n+\n+describe('deploy-to-firebase:', () => {\n+  const deployToFirebaseCmd = `\"${process.execPath}\" \"${__dirname}/deploy-to-firebase\" --dry-run`;\n+\n+  // Helpers\n+  const deployToFirebaseDryRun =\n+      env => execSync(deployToFirebaseCmd, {encoding: 'utf8', env}).toString().trim();\n+  const getLatestCommitForBranch =\n+      branch => execSync(`git ls-remote origin ${branch}`).slice(0, 40);\n+\n+  it('master - skip deploy - not angular', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'notangular',\n+    })).toBe('Skipping deploy because this is not angular/angular.');\n+  });\n+\n+  it('master - skip deploy - angular fork', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'notangular',\n+      CI_REPO_NAME: 'angular',\n+    })).toBe('Skipping deploy because this is not angular/angular.');\n+  });\n+\n+  it('master - skip deploy - pull request', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'true',\n+    })).toBe('Skipping deploy because this is a PR build.');\n+  });\n+\n+  it('master - deploy success', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: 'master',\n+      CI_COMMIT: getLatestCommitForBranch('master'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Git branch        : master\\n' +\n+        'Build/deploy mode : next\\n' +\n+        'Firebase project  : aio-staging\\n' +\n+        'Firebase site     : aio-staging\\n' +\n+        'Deployment URL    : https://next.angular.io/');\n+  });\n+\n+  it('master - skip deploy - commit not HEAD', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: 'master',\n+      CI_COMMIT: 'DUMMY_TEST_COMMIT',\n+    })).toBe(\n+        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+        `(${getLatestCommitForBranch('master')}).`);\n+  });\n+\n+  it('stable - deploy success', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '4.3.x',\n+      CI_STABLE_BRANCH: '4.3.x',\n+      CI_COMMIT: getLatestCommitForBranch('4.3.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Git branch        : 4.3.x\\n' +\n+        'Build/deploy mode : stable\\n' +\n+        'Firebase project  : angular-io\\n' +\n+        'Firebase site     : angular-io\\n' +\n+        'Deployment URL    : https://angular.io/');\n+  });\n+\n+  it('stable - skip deploy - commit not HEAD', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '4.3.x',\n+      CI_STABLE_BRANCH: '4.3.x',\n+      CI_COMMIT: 'DUMMY_TEST_COMMIT',\n+    })).toBe(\n+        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+        `(${getLatestCommitForBranch('4.3.x')}).`);\n+  });\n+\n+  it('archive - deploy success', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.4.x',\n+      CI_STABLE_BRANCH: '4.3.x',\n+      CI_COMMIT: getLatestCommitForBranch('2.4.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Git branch        : 2.4.x\\n' +\n+        'Build/deploy mode : archive\\n' +\n+        'Firebase project  : v2-angular-io\\n' +\n+        'Firebase site     : v2-angular-io\\n' +\n+        'Deployment URL    : https://v2.angular.io/');\n+  });\n+\n+  it('archive - v9-angular-io multisite special case - deploy success', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '9.1.x',\n+      CI_STABLE_BRANCH: '10.0.x',\n+      CI_COMMIT: getLatestCommitForBranch('9.1.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Git branch        : 9.1.x\\n' +\n+        'Build/deploy mode : archive\\n' +\n+        'Firebase project  : aio-staging\\n' +\n+        'Firebase site     : v9-angular-io\\n' +\n+        'Deployment URL    : https://v9.angular.io/');\n+  });\n+\n+  it('archive - skip deploy - commit not HEAD', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.4.x',\n+      CI_STABLE_BRANCH: '4.3.x',\n+      CI_COMMIT: 'DUMMY_TEST_COMMIT',\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n+        `(${getLatestCommitForBranch('2.4.x')}).`);\n+  });\n+\n+  it('archive - skip deploy - major version too high, lower minor', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.1.x',\n+      CI_STABLE_BRANCH: '2.2.x',\n+      CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n+        'We only deploy archive branches with the major version less than the stable branch: ' +\n+        '\"2.2.x\"');\n+  });\n+\n+  it('archive - skip deploy - major version too high, higher minor', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.4.x',\n+      CI_STABLE_BRANCH: '2.2.x',\n+      CI_COMMIT: getLatestCommitForBranch('2.4.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy of branch \"2.4.x\" to Firebase.\\n' +\n+        'We only deploy archive branches with the major version less than the stable branch: ' +\n+        '\"2.2.x\"');\n+  });\n+\n+  it('archive - skip deploy - minor version too low', () => {\n+    expect(deployToFirebaseDryRun({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: '2.1.x',\n+      CI_STABLE_BRANCH: '4.3.x',\n+      CI_COMMIT: getLatestCommitForBranch('2.1.x'),\n+      CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN: 'XXXXX',\n+    })).toBe(\n+        'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n+        'There is a more recent branch with the same major version: \"2.4.x\"');\n+  });\n+});"
        },
        {
            "sha": "8f4efebc72340215b57c6651ff9b715fab6263b0",
            "filename": "aio/scripts/deploy-to-firebase.test.sh",
            "status": "removed",
            "additions": 0,
            "deletions": 244,
            "changes": 244,
            "blob_url": "https://github.com/angular/angular/blob/8317042483c52b9b5035c49d76fecc4b43a23090/aio%2Fscripts%2Fdeploy-to-firebase.test.sh",
            "raw_url": "https://github.com/angular/angular/raw/8317042483c52b9b5035c49d76fecc4b43a23090/aio%2Fscripts%2Fdeploy-to-firebase.test.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.test.sh?ref=8317042483c52b9b5035c49d76fecc4b43a23090",
            "patch": "@@ -1,244 +0,0 @@\n-#!/usr/bin/env bash\n-set +x -eu -o pipefail\n-\n-readonly deployToFirebaseDryRun=\"`dirname $0`/deploy-to-firebase.sh --dry-run\"\n-\n-function check {\n-  if [[ $1 == $2 ]]; then\n-    echo Pass\n-    exit 0\n-  fi\n-  echo Fail\n-  echo ---- Expected ----\n-  echo \"$2\"\n-  echo ---- Actual   ----\n-  echo \"$1\"\n-  exit 1\n-}\n-\n-(\n-  echo ===== master - skip deploy - not angular\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=notangular\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy because this is not angular/angular.\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== master - skip deploy - angular fork\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=notangular\n-    export CI_REPO_NAME=angular\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy because this is not angular/angular.\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== master - skip deploy - pull request\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=true\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy because this is a PR build.\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== master - deploy success\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=master\n-    export CI_COMMIT=$(git ls-remote origin master | cut -c1-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Git branch        : master\n-Build/deploy mode : next\n-Firebase project  : aio-staging\n-Firebase site     : aio-staging\n-Deployment URL    : https://next.angular.io/\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== master - skip deploy - commit not HEAD\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=master\n-    export CI_COMMIT=DUMMY_TEST_COMMIT\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ($(git ls-remote origin master | cut -c1-40)).\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== stable - deploy success\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=4.3.x\n-    export CI_STABLE_BRANCH=4.3.x\n-    export CI_COMMIT=$(git ls-remote origin 4.3.x | cut -c1-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Git branch        : 4.3.x\n-Build/deploy mode : stable\n-Firebase project  : angular-io\n-Firebase site     : angular-io\n-Deployment URL    : https://angular.io/\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== stable - skip deploy - commit not HEAD\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=4.3.x\n-    export CI_STABLE_BRANCH=4.3.x\n-    export CI_COMMIT=DUMMY_TEST_COMMIT\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ($(git ls-remote origin 4.3.x | cut -c1-40)).\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== archive - deploy success\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=2.4.x\n-    export CI_STABLE_BRANCH=4.3.x\n-    export CI_COMMIT=$(git ls-remote origin 2.4.x | cut -c1-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Git branch        : 2.4.x\n-Build/deploy mode : archive\n-Firebase project  : v2-angular-io\n-Firebase site     : v2-angular-io\n-Deployment URL    : https://v2.angular.io/\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== archive - v9-angular-io multisite special case - deploy success\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=9.1.x\n-    export CI_STABLE_BRANCH=10.0.x\n-    export CI_COMMIT=$(git ls-remote origin 9.1.x | cut -c1-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Git branch        : 9.1.x\n-Build/deploy mode : archive\n-Firebase project  : aio-staging\n-Firebase site     : v9-angular-io\n-Deployment URL    : https://v9.angular.io/\"\n-  # TODO: This test incorrectly expects the Firebase project to be v9-angular-io.\n-  #       v9-angular-io is a \"multisites\" project currently within the aio-staging project\n-  #       This setup is temporary and was created in order to deploy v9.angular.io without\n-  #       disruptions.\n-  #       See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== archive - skip deploy - commit not HEAD\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=2.4.x\n-    export CI_STABLE_BRANCH=4.3.x\n-    export CI_COMMIT=DUMMY_TEST_COMMIT\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ($(git ls-remote origin 2.4.x | cut -c1-40)).\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== archive - skip deploy - major version too high, lower minor\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=2.1.x\n-    export CI_STABLE_BRANCH=2.2.x\n-    export CI_COMMIT=$(git ls-remote origin 2.1.x | cut -c-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy of branch \\\"2.1.x\\\" to firebase.\n-We only deploy archive branches with the major version less than the stable branch: \\\"2.2.x\\\"\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== archive - skip deploy - major version too high, higher minor\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=2.4.x\n-    export CI_STABLE_BRANCH=2.2.x\n-    export CI_COMMIT=$(git ls-remote origin 2.4.x | cut -c-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy of branch \\\"2.4.x\\\" to firebase.\n-We only deploy archive branches with the major version less than the stable branch: \\\"2.2.x\\\"\"\n-  check \"$actual\" \"$expected\"\n-)\n-\n-(\n-  echo ===== archive - skip deploy - minor version too low\n-  actual=$(\n-    export BASH_ENV=/dev/null\n-    export CI_REPO_OWNER=angular\n-    export CI_REPO_NAME=angular\n-    export CI_PULL_REQUEST=false\n-    export CI_BRANCH=2.1.x\n-    export CI_STABLE_BRANCH=4.3.x\n-    export CI_COMMIT=$(git ls-remote origin 2.1.x | cut -c-40)\n-    export CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN=XXXXX\n-    $deployToFirebaseDryRun\n-  )\n-  expected=\"Skipping deploy of branch \\\"2.1.x\\\" to firebase.\n-There is a more recent branch with the same major version: \\\"2.4.x\\\"\"\n-  check \"$actual\" \"$expected\"\n-)"
        },
        {
            "sha": "55e0ac8feac9110b445eb910c85f857a2a836a5c",
            "filename": "aio/src/extra-files/README.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fsrc%2Fextra-files%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fsrc%2Fextra-files%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fextra-files%2FREADME.md?ref=5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
            "patch": "@@ -6,8 +6,8 @@ After the AIO application had been built and before it is deployed all files and\n inside the folder with the same name as the current deployment mode (next, stable, archive)\n will be copied to the `dist` folder.\n \n-See the `scripts/deploy-to-firebase.sh` script for more detail.\n+See the `scripts/deploy-to-firebase.js` script for more details.\n \n **Note:**\n-The `deploy-to-firebase.sh` script always expects there to be a folder for the current deployment\n+The `deploy-to-firebase.js` script always expects there to be a folder for the current deployment\n mode (even if it is empty)."
        },
        {
            "sha": "e615d197c40d0677c9219543f379678e6c4ae53e",
            "filename": "aio/yarn.lock",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fyarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/5143d52d2bcbeedbf172da0bd3aaa7da85785be5/aio%2Fyarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fyarn.lock?ref=5143d52d2bcbeedbf172da0bd3aaa7da85785be5",
            "patch": "@@ -11863,7 +11863,7 @@ shell-quote@^1.6.1:\n   resolved \"https://registry.yarnpkg.com/shell-quote/-/shell-quote-1.7.2.tgz#67a7d02c76c9da24f99d20808fcaded0e0e04be2\"\n   integrity sha512-mRz/m/JVscCrkMyPqHc/bczi3OQHkLTqXHEFu0zDhK/qfv3UcOA4SVmRCLmos4bhjr9ekVQubj/R7waKapmiQg==\n \n-shelljs@^0.7.5, shelljs@^0.7.7:\n+shelljs@^0.7.5:\n   version \"0.7.8\"\n   resolved \"https://registry.yarnpkg.com/shelljs/-/shelljs-0.7.8.tgz#decbcf874b0d1e5fb72e14b164a9683048e9acb3\"\n   integrity sha1-3svPh0sNHl+3LhSxZKloMEjprLM=\n@@ -11872,6 +11872,15 @@ shelljs@^0.7.5, shelljs@^0.7.7:\n     interpret \"^1.0.0\"\n     rechoir \"^0.6.2\"\n \n+shelljs@^0.8.4:\n+  version \"0.8.4\"\n+  resolved \"https://registry.yarnpkg.com/shelljs/-/shelljs-0.8.4.tgz#de7684feeb767f8716b326078a8a00875890e3c2\"\n+  integrity sha512-7gk3UZ9kOfPLIAbslLzyWeGiEqx9e3rxwZM0KE6EL8GlGwjym9Mrlx5/p33bWTu9YG6vcS4MBxYZDHYr5lr8BQ==\n+  dependencies:\n+    glob \"^7.0.0\"\n+    interpret \"^1.0.0\"\n+    rechoir \"^0.6.2\"\n+\n signal-exit@^3.0.0, signal-exit@^3.0.2:\n   version \"3.0.2\"\n   resolved \"https://registry.yarnpkg.com/signal-exit/-/signal-exit-3.0.2.tgz#b5fdc08f1287ea1178628e415e25132b73646c6d\""
        }
    ],
    "stats": {
        "total": 751,
        "additions": 368,
        "deletions": 383
    }
}