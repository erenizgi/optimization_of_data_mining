{
    "author": "bjarkler",
    "message": "fix(core): convert legacy-sanitized values to Trusted Types (#39218)\n\nUse the bypass-specific Trusted Types policy for automatically upgrade\nany values from custom sanitizers or the bypassSecurityTrust functions\nto a Trusted Type. Update tests to reflect the new behavior.\n\nPR Close #39218",
    "sha": "81aa119739de36bb61a89f0a5e6fa2ae23247720",
    "files": [
        {
            "sha": "54f4f272ad3b35ea5f61ac4cf1ec0aa3da9a6b7d",
            "filename": "packages/core/src/sanitization/sanitization.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/81aa119739de36bb61a89f0a5e6fa2ae23247720/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts",
            "raw_url": "https://github.com/angular/angular/raw/81aa119739de36bb61a89f0a5e6fa2ae23247720/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts?ref=81aa119739de36bb61a89f0a5e6fa2ae23247720",
            "patch": "@@ -12,6 +12,7 @@ import {getLView} from '../render3/state';\n import {renderStringify} from '../render3/util/misc_utils';\n import {TrustedHTML, TrustedScript, TrustedScriptURL} from '../util/security/trusted_type_defs';\n import {trustedHTMLFromString, trustedScriptFromString, trustedScriptURLFromString} from '../util/security/trusted_types';\n+import {trustedHTMLFromStringBypass, trustedScriptFromStringBypass, trustedScriptURLFromStringBypass} from '../util/security/trusted_types_bypass';\n \n import {allowSanitizationBypassAndThrow, BypassType, unwrapSafeValue} from './bypass';\n import {_sanitizeHtml as _sanitizeHtml} from './html_sanitizer';\n@@ -39,10 +40,10 @@ import {_sanitizeUrl as _sanitizeUrl} from './url_sanitizer';\n export function ɵɵsanitizeHtml(unsafeHtml: any): TrustedHTML|string {\n   const sanitizer = getSanitizer();\n   if (sanitizer) {\n-    return sanitizer.sanitize(SecurityContext.HTML, unsafeHtml) || '';\n+    return trustedHTMLFromStringBypass(sanitizer.sanitize(SecurityContext.HTML, unsafeHtml) || '');\n   }\n   if (allowSanitizationBypassAndThrow(unsafeHtml, BypassType.Html)) {\n-    return unwrapSafeValue(unsafeHtml);\n+    return trustedHTMLFromStringBypass(unwrapSafeValue(unsafeHtml));\n   }\n   return _sanitizeHtml(getDocument(), renderStringify(unsafeHtml));\n }\n@@ -110,10 +111,11 @@ export function ɵɵsanitizeUrl(unsafeUrl: any): string {\n export function ɵɵsanitizeResourceUrl(unsafeResourceUrl: any): TrustedScriptURL|string {\n   const sanitizer = getSanitizer();\n   if (sanitizer) {\n-    return sanitizer.sanitize(SecurityContext.RESOURCE_URL, unsafeResourceUrl) || '';\n+    return trustedScriptURLFromStringBypass(\n+        sanitizer.sanitize(SecurityContext.RESOURCE_URL, unsafeResourceUrl) || '');\n   }\n   if (allowSanitizationBypassAndThrow(unsafeResourceUrl, BypassType.ResourceUrl)) {\n-    return unwrapSafeValue(unsafeResourceUrl);\n+    return trustedScriptURLFromStringBypass(unwrapSafeValue(unsafeResourceUrl));\n   }\n   throw new Error('unsafe value used in a resource URL context (see http://g.co/ng/security#xss)');\n }\n@@ -133,10 +135,11 @@ export function ɵɵsanitizeResourceUrl(unsafeResourceUrl: any): TrustedScriptUR\n export function ɵɵsanitizeScript(unsafeScript: any): TrustedScript|string {\n   const sanitizer = getSanitizer();\n   if (sanitizer) {\n-    return sanitizer.sanitize(SecurityContext.SCRIPT, unsafeScript) || '';\n+    return trustedScriptFromStringBypass(\n+        sanitizer.sanitize(SecurityContext.SCRIPT, unsafeScript) || '');\n   }\n   if (allowSanitizationBypassAndThrow(unsafeScript, BypassType.Script)) {\n-    return unwrapSafeValue(unsafeScript);\n+    return trustedScriptFromStringBypass(unwrapSafeValue(unsafeScript));\n   }\n   throw new Error('unsafe value used in a script context');\n }"
        },
        {
            "sha": "435b0514f1a311287eb9cf4762b79a1a2e5029da",
            "filename": "packages/core/test/sanitization/sanitization_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/81aa119739de36bb61a89f0a5e6fa2ae23247720/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/81aa119739de36bb61a89f0a5e6fa2ae23247720/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts?ref=81aa119739de36bb61a89f0a5e6fa2ae23247720",
            "patch": "@@ -37,7 +37,7 @@ describe('sanitization', () => {\n         .toEqual('<img src=\"unsafe:javascript:true\">');\n     expect(() => ɵɵsanitizeHtml(bypassSanitizationTrustUrl('<img src=\"javascript:true\">')))\n         .toThrowError(/Required a safe HTML, got a URL/);\n-    expect(ɵɵsanitizeHtml(bypassSanitizationTrustHtml('<img src=\"javascript:true\">')))\n+    expect(ɵɵsanitizeHtml(bypassSanitizationTrustHtml('<img src=\"javascript:true\">')).toString())\n         .toEqual('<img src=\"javascript:true\">');\n   });\n \n@@ -57,7 +57,7 @@ describe('sanitization', () => {\n     expect(() => ɵɵsanitizeResourceUrl('javascript:true')).toThrowError(ERROR);\n     expect(() => ɵɵsanitizeResourceUrl(bypassSanitizationTrustHtml('javascript:true')))\n         .toThrowError(/Required a safe ResourceURL, got a HTML/);\n-    expect(ɵɵsanitizeResourceUrl(bypassSanitizationTrustResourceUrl('javascript:true')))\n+    expect(ɵɵsanitizeResourceUrl(bypassSanitizationTrustResourceUrl('javascript:true')).toString())\n         .toEqual('javascript:true');\n   });\n \n@@ -78,7 +78,7 @@ describe('sanitization', () => {\n     expect(() => ɵɵsanitizeScript('true')).toThrowError(ERROR);\n     expect(() => ɵɵsanitizeScript(bypassSanitizationTrustHtml('true')))\n         .toThrowError(/Required a safe Script, got a HTML/);\n-    expect(ɵɵsanitizeScript(bypassSanitizationTrustScript('true'))).toEqual('true');\n+    expect(ɵɵsanitizeScript(bypassSanitizationTrustScript('true')).toString()).toEqual('true');\n   });\n \n   it('should select correct sanitizer for URL props', () => {\n@@ -114,7 +114,8 @@ describe('sanitization', () => {\n             bypassSanitizationTrustHtml('javascript:true'), 'iframe', 'src'))\n         .toThrowError(/Required a safe ResourceURL, got a HTML/);\n     expect(ɵɵsanitizeUrlOrResourceUrl(\n-               bypassSanitizationTrustResourceUrl('javascript:true'), 'iframe', 'src'))\n+               bypassSanitizationTrustResourceUrl('javascript:true'), 'iframe', 'src')\n+               .toString())\n         .toEqual('javascript:true');\n   });\n "
        }
    ],
    "stats": {
        "total": 24,
        "additions": 14,
        "deletions": 10
    }
}