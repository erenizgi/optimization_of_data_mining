{
    "author": "atscott",
    "message": "refactor(language-service): Move some util functions to common (#39202)\n\nThese functions will be useful to the Ivy language service as well to\nprovide 'go to definition' functionality for template and style urls.\n\nPR Close #39202",
    "sha": "087596bbde0525c382457ad1b6af4268a2cdaf66",
    "files": [
        {
            "sha": "5c3ccefc5ae4c9c4ef879b663f369bc781897b72",
            "filename": "packages/language-service/common/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fcommon%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fcommon%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fcommon%2FBUILD.bazel?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     name = \"common\",\n     srcs = glob([\"*.ts\"]),\n     deps = [\n+        \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "0db481cd14cf536495e2903fef87ba2124e17e92",
            "filename": "packages/language-service/common/definitions.ts",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fcommon%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fcommon%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fcommon%2Fdefinitions.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -0,0 +1,94 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as path from 'path';\n+import * as ts from 'typescript';\n+\n+import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n+\n+/**\n+ * Gets an Angular-specific definition in a TypeScript source file.\n+ */\n+export function getTsDefinitionAndBoundSpan(\n+    sf: ts.SourceFile, position: number,\n+    tsLsHost: Pick<ts.LanguageServiceHost, 'fileExists'>): ts.DefinitionInfoAndBoundSpan|undefined {\n+  const node = findTightestNode(sf, position);\n+  if (!node) return;\n+  switch (node.kind) {\n+    case ts.SyntaxKind.StringLiteral:\n+    case ts.SyntaxKind.NoSubstitutionTemplateLiteral:\n+      // Attempt to extract definition of a URL in a property assignment.\n+      return getUrlFromProperty(node as ts.StringLiteralLike, tsLsHost);\n+    default:\n+      return undefined;\n+  }\n+}\n+\n+/**\n+ * Attempts to get the definition of a file whose URL is specified in a property assignment in a\n+ * directive decorator.\n+ * Currently applies to `templateUrl` and `styleUrls` properties.\n+ */\n+function getUrlFromProperty(\n+    urlNode: ts.StringLiteralLike,\n+    tsLsHost: Pick<ts.LanguageServiceHost, 'fileExists'>): ts.DefinitionInfoAndBoundSpan|undefined {\n+  // Get the property assignment node corresponding to the `templateUrl` or `styleUrls` assignment.\n+  // These assignments are specified differently; `templateUrl` is a string, and `styleUrls` is\n+  // an array of strings:\n+  //   {\n+  //        templateUrl: './template.ng.html',\n+  //        styleUrls: ['./style.css', './other-style.css']\n+  //   }\n+  // `templateUrl`'s property assignment can be found from the string literal node;\n+  // `styleUrls`'s property assignment can be found from the array (parent) node.\n+  //\n+  // First search for `templateUrl`.\n+  let asgn = getPropertyAssignmentFromValue(urlNode, 'templateUrl');\n+  if (!asgn) {\n+    // `templateUrl` assignment not found; search for `styleUrls` array assignment.\n+    asgn = getPropertyAssignmentFromValue(urlNode.parent, 'styleUrls');\n+    if (!asgn) {\n+      // Nothing found, bail.\n+      return;\n+    }\n+  }\n+\n+  // If the property assignment is not a property of a class decorator, don't generate definitions\n+  // for it.\n+  if (!getClassDeclFromDecoratorProp(asgn)) {\n+    return;\n+  }\n+\n+  const sf = urlNode.getSourceFile();\n+  // Extract url path specified by the url node, which is relative to the TypeScript source file\n+  // the url node is defined in.\n+  const url = path.join(path.dirname(sf.fileName), urlNode.text);\n+\n+  // If the file does not exist, bail. It is possible that the TypeScript language service host\n+  // does not have a `fileExists` method, in which case optimistically assume the file exists.\n+  if (tsLsHost.fileExists && !tsLsHost.fileExists(url)) return;\n+\n+  const templateDefinitions: ts.DefinitionInfo[] = [{\n+    kind: ts.ScriptElementKind.externalModuleName,\n+    name: url,\n+    containerKind: ts.ScriptElementKind.unknown,\n+    containerName: '',\n+    // Reading the template is expensive, so don't provide a preview.\n+    textSpan: {start: 0, length: 0},\n+    fileName: url,\n+  }];\n+\n+  return {\n+    definitions: templateDefinitions,\n+    textSpan: {\n+      // Exclude opening and closing quotes in the url span.\n+      start: urlNode.getStart() + 1,\n+      length: urlNode.getWidth() - 2,\n+    },\n+  };\n+}"
        },
        {
            "sha": "08b0d22f5691e0b65d66fadd13bee10654374e75",
            "filename": "packages/language-service/common/ts_utils.ts",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fcommon%2Fts_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fcommon%2Fts_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fcommon%2Fts_utils.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -0,0 +1,87 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+/**\n+ * Return the node that most tightly encompass the specified `position`.\n+ * @param node\n+ * @param position\n+ */\n+export function findTightestNode(node: ts.Node, position: number): ts.Node|undefined {\n+  if (node.getStart() <= position && position < node.getEnd()) {\n+    return node.forEachChild(c => findTightestNode(c, position)) || node;\n+  }\n+}\n+\n+/**\n+ * Returns a property assignment from the assignment value if the property name\n+ * matches the specified `key`, or `undefined` if there is no match.\n+ */\n+export function getPropertyAssignmentFromValue(value: ts.Node, key: string): ts.PropertyAssignment|\n+    undefined {\n+  const propAssignment = value.parent;\n+  if (!propAssignment || !ts.isPropertyAssignment(propAssignment) ||\n+      propAssignment.name.getText() !== key) {\n+    return;\n+  }\n+  return propAssignment;\n+}\n+\n+/**\n+ * Given a decorator property assignment, return the ClassDeclaration node that corresponds to the\n+ * directive class the property applies to.\n+ * If the property assignment is not on a class decorator, no declaration is returned.\n+ *\n+ * For example,\n+ *\n+ * @Component({\n+ *   template: '<div></div>'\n+ *   ^^^^^^^^^^^^^^^^^^^^^^^---- property assignment\n+ * })\n+ * class AppComponent {}\n+ *           ^---- class declaration node\n+ *\n+ * @param propAsgnNode property assignment\n+ */\n+export function getClassDeclFromDecoratorProp(propAsgnNode: ts.PropertyAssignment):\n+    ts.ClassDeclaration|undefined {\n+  if (!propAsgnNode.parent || !ts.isObjectLiteralExpression(propAsgnNode.parent)) {\n+    return;\n+  }\n+  const objLitExprNode = propAsgnNode.parent;\n+  if (!objLitExprNode.parent || !ts.isCallExpression(objLitExprNode.parent)) {\n+    return;\n+  }\n+  const callExprNode = objLitExprNode.parent;\n+  if (!callExprNode.parent || !ts.isDecorator(callExprNode.parent)) {\n+    return;\n+  }\n+  const decorator = callExprNode.parent;\n+  if (!decorator.parent || !ts.isClassDeclaration(decorator.parent)) {\n+    return;\n+  }\n+  const classDeclNode = decorator.parent;\n+  return classDeclNode;\n+}\n+\n+/**\n+ * Given the node which is the string of the inline template for a component, returns the\n+ * `ts.ClassDeclaration` for the component.\n+ */\n+export function getClassDeclOfInlineTemplateNode(templateStringNode: ts.Node): ts.ClassDeclaration|\n+    undefined {\n+  if (!ts.isStringLiteralLike(templateStringNode)) {\n+    return;\n+  }\n+  const tmplAsgn = getPropertyAssignmentFromValue(templateStringNode, 'template');\n+  if (!tmplAsgn) {\n+    return;\n+  }\n+  return getClassDeclFromDecoratorProp(tmplAsgn)\n+}"
        },
        {
            "sha": "6539895d68abbf17db10c1f4a2a8c8f263cd1901",
            "filename": "packages/language-service/src/definitions.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 84,
            "changes": 84,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fdefinitions.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -6,11 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as path from 'path';\n import * as ts from 'typescript';  // used as value and is provided at runtime\n \n import {locateSymbols} from './locate_symbol';\n-import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n import {AstResult, Span} from './types';\n \n /**\n@@ -82,85 +80,3 @@ export function getDefinitionAndBoundSpan(\n     textSpan: symbols[0].span,\n   };\n }\n-\n-/**\n- * Gets an Angular-specific definition in a TypeScript source file.\n- */\n-export function getTsDefinitionAndBoundSpan(\n-    sf: ts.SourceFile, position: number,\n-    tsLsHost: Readonly<ts.LanguageServiceHost>): ts.DefinitionInfoAndBoundSpan|undefined {\n-  const node = findTightestNode(sf, position);\n-  if (!node) return;\n-  switch (node.kind) {\n-    case ts.SyntaxKind.StringLiteral:\n-    case ts.SyntaxKind.NoSubstitutionTemplateLiteral:\n-      // Attempt to extract definition of a URL in a property assignment.\n-      return getUrlFromProperty(node as ts.StringLiteralLike, tsLsHost);\n-    default:\n-      return undefined;\n-  }\n-}\n-\n-/**\n- * Attempts to get the definition of a file whose URL is specified in a property assignment in a\n- * directive decorator.\n- * Currently applies to `templateUrl` and `styleUrls` properties.\n- */\n-function getUrlFromProperty(\n-    urlNode: ts.StringLiteralLike,\n-    tsLsHost: Readonly<ts.LanguageServiceHost>): ts.DefinitionInfoAndBoundSpan|undefined {\n-  // Get the property assignment node corresponding to the `templateUrl` or `styleUrls` assignment.\n-  // These assignments are specified differently; `templateUrl` is a string, and `styleUrls` is\n-  // an array of strings:\n-  //   {\n-  //        templateUrl: './template.ng.html',\n-  //        styleUrls: ['./style.css', './other-style.css']\n-  //   }\n-  // `templateUrl`'s property assignment can be found from the string literal node;\n-  // `styleUrls`'s property assignment can be found from the array (parent) node.\n-  //\n-  // First search for `templateUrl`.\n-  let asgn = getPropertyAssignmentFromValue(urlNode, 'templateUrl');\n-  if (!asgn) {\n-    // `templateUrl` assignment not found; search for `styleUrls` array assignment.\n-    asgn = getPropertyAssignmentFromValue(urlNode.parent, 'styleUrls');\n-    if (!asgn) {\n-      // Nothing found, bail.\n-      return;\n-    }\n-  }\n-\n-  // If the property assignment is not a property of a class decorator, don't generate definitions\n-  // for it.\n-  if (!getClassDeclFromDecoratorProp(asgn)) {\n-    return;\n-  }\n-\n-  const sf = urlNode.getSourceFile();\n-  // Extract url path specified by the url node, which is relative to the TypeScript source file\n-  // the url node is defined in.\n-  const url = path.join(path.dirname(sf.fileName), urlNode.text);\n-\n-  // If the file does not exist, bail. It is possible that the TypeScript language service host\n-  // does not have a `fileExists` method, in which case optimistically assume the file exists.\n-  if (tsLsHost.fileExists && !tsLsHost.fileExists(url)) return;\n-\n-  const templateDefinitions: ts.DefinitionInfo[] = [{\n-    kind: ts.ScriptElementKind.externalModuleName,\n-    name: url,\n-    containerKind: ts.ScriptElementKind.unknown,\n-    containerName: '',\n-    // Reading the template is expensive, so don't provide a preview.\n-    textSpan: {start: 0, length: 0},\n-    fileName: url,\n-  }];\n-\n-  return {\n-    definitions: templateDefinitions,\n-    textSpan: {\n-      // Exclude opening and closing quotes in the url span.\n-      start: urlNode.getStart() + 1,\n-      length: urlNode.getWidth() - 2,\n-    },\n-  };\n-}"
        },
        {
            "sha": "184815651641be1888e23f6236f50142f1b3182e",
            "filename": "packages/language-service/src/diagnostics.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fdiagnostics.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -10,9 +10,11 @@ import {NgAnalyzedModules} from '@angular/compiler';\n import * as path from 'path';\n import * as ts from 'typescript';\n \n+import {findTightestNode} from '../common/ts_utils';\n+\n import {createDiagnostic, Diagnostic} from './diagnostic_messages';\n import {getTemplateExpressionDiagnostics} from './expression_diagnostics';\n-import {findPropertyValueOfType, findTightestNode} from './ts_utils';\n+import {findPropertyValueOfType} from './ts_utils';\n import * as ng from './types';\n import {TypeScriptServiceHost} from './typescript_host';\n import {offsetSpan, spanOf} from './utils';"
        },
        {
            "sha": "3ee3e24a4ce85e0c8a722faddcaf096c3c8b8980",
            "filename": "packages/language-service/src/language_service.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Flanguage_service.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -6,10 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {getTsDefinitionAndBoundSpan} from '@angular/language-service/common/definitions';\n import * as tss from 'typescript/lib/tsserverlibrary';\n \n import {getTemplateCompletions} from './completions';\n-import {getDefinitionAndBoundSpan, getTsDefinitionAndBoundSpan} from './definitions';\n+import {getDefinitionAndBoundSpan} from './definitions';\n import {getDeclarationDiagnostics, getTemplateDiagnostics, ngDiagnosticToTsDiagnostic} from './diagnostics';\n import {getTemplateHover, getTsHover} from './hover';\n import * as ng from './types';"
        },
        {
            "sha": "11c756007bff9217d419d36dffb66f906322966b",
            "filename": "packages/language-service/src/ts_utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 62,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Fts_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Fts_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_utils.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -8,68 +8,6 @@\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-/**\n- * Return the node that most tightly encompass the specified `position`.\n- * @param node\n- * @param position\n- */\n-export function findTightestNode(node: ts.Node, position: number): ts.Node|undefined {\n-  if (node.getStart() <= position && position < node.getEnd()) {\n-    return node.forEachChild(c => findTightestNode(c, position)) || node;\n-  }\n-}\n-\n-/**\n- * Returns a property assignment from the assignment value if the property name\n- * matches the specified `key`, or `undefined` if there is no match.\n- */\n-export function getPropertyAssignmentFromValue(value: ts.Node, key: string): ts.PropertyAssignment|\n-    undefined {\n-  const propAssignment = value.parent;\n-  if (!propAssignment || !ts.isPropertyAssignment(propAssignment) ||\n-      propAssignment.name.getText() !== key) {\n-    return;\n-  }\n-  return propAssignment;\n-}\n-\n-/**\n- * Given a decorator property assignment, return the ClassDeclaration node that corresponds to the\n- * directive class the property applies to.\n- * If the property assignment is not on a class decorator, no declaration is returned.\n- *\n- * For example,\n- *\n- * @Component({\n- *   template: '<div></div>'\n- *   ^^^^^^^^^^^^^^^^^^^^^^^---- property assignment\n- * })\n- * class AppComponent {}\n- *           ^---- class declaration node\n- *\n- * @param propAsgn property assignment\n- */\n-export function getClassDeclFromDecoratorProp(propAsgnNode: ts.PropertyAssignment):\n-    ts.ClassDeclaration|undefined {\n-  if (!propAsgnNode.parent || !ts.isObjectLiteralExpression(propAsgnNode.parent)) {\n-    return;\n-  }\n-  const objLitExprNode = propAsgnNode.parent;\n-  if (!objLitExprNode.parent || !ts.isCallExpression(objLitExprNode.parent)) {\n-    return;\n-  }\n-  const callExprNode = objLitExprNode.parent;\n-  if (!callExprNode.parent || !ts.isDecorator(callExprNode.parent)) {\n-    return;\n-  }\n-  const decorator = callExprNode.parent;\n-  if (!decorator.parent || !ts.isClassDeclaration(decorator.parent)) {\n-    return;\n-  }\n-  const classDeclNode = decorator.parent;\n-  return classDeclNode;\n-}\n-\n interface DirectiveClassLike {\n   decoratorId: ts.Identifier;  // decorator identifier, like @Component\n   classId: ts.Identifier;"
        },
        {
            "sha": "0921f50400437a5a3bfce4218304628dfe408e14",
            "filename": "packages/language-service/src/typescript_host.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/087596bbde0525c382457ad1b6af4268a2cdaf66/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts?ref=087596bbde0525c382457ad1b6af4268a2cdaf66",
            "patch": "@@ -10,10 +10,12 @@ import {analyzeNgModules, AotSummaryResolver, CompileDirectiveSummary, CompileMe\n import {SchemaMetadata, ViewEncapsulation, ÉµConsole as Console} from '@angular/core';\n import * as tss from 'typescript/lib/tsserverlibrary';\n \n+import {findTightestNode, getClassDeclOfInlineTemplateNode} from '../common/ts_utils';\n+\n import {createLanguageService} from './language_service';\n import {ReflectorHost} from './reflector_host';\n import {ExternalTemplate, InlineTemplate} from './template';\n-import {findTightestNode, getClassDeclFromDecoratorProp, getDirectiveClassLike, getPropertyAssignmentFromValue} from './ts_utils';\n+import {getDirectiveClassLike} from './ts_utils';\n import {AstResult, Declaration, DeclarationError, DiagnosticMessageChain, LanguageService, LanguageServiceHost, Span, TemplateSource} from './types';\n \n /**\n@@ -382,11 +384,7 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n     if (!tss.isStringLiteralLike(node)) {\n       return;\n     }\n-    const tmplAsgn = getPropertyAssignmentFromValue(node, 'template');\n-    if (!tmplAsgn) {\n-      return;\n-    }\n-    const classDecl = getClassDeclFromDecoratorProp(tmplAsgn);\n+    const classDecl = getClassDeclOfInlineTemplateNode(node);\n     if (!classDecl || !classDecl.name) {  // Does not handle anonymous class\n       return;\n     }"
        }
    ],
    "stats": {
        "total": 345,
        "additions": 191,
        "deletions": 154
    }
}