{
    "author": "petebacondarwin",
    "message": "build(docs-infra): add NgModules references to provided injectables (#41960)\n\nParse the `providers` property of each NgModule doc and add this doc to\nthe `ngModules` property of each provided injectable.\n\nPR Close #41960",
    "sha": "71f37c9d9c1f02673cc6cf6a10252ece598c92d2",
    "files": [
        {
            "sha": "c0d25b5bac23bc3237c06154e6d3a85e824e9bde",
            "filename": "aio/tools/transforms/angular-api-package/processors/processNgModuleDocs.js",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/71f37c9d9c1f02673cc6cf6a10252ece598c92d2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FprocessNgModuleDocs.js",
            "raw_url": "https://github.com/angular/angular/raw/71f37c9d9c1f02673cc6cf6a10252ece598c92d2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FprocessNgModuleDocs.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FprocessNgModuleDocs.js?ref=71f37c9d9c1f02673cc6cf6a10252ece598c92d2",
            "patch": "@@ -158,6 +158,19 @@ module.exports = function processNgModuleDocs(getDocFromAlias, createDocMessage,\n     processNgModuleProviders(ngModuleDoc) {\n       // Add providers from the NgModule decorator.\n       const providers = ngModuleDoc.ngmoduleOptions.providers || [];\n+\n+      // Update injectables which are provided by this NgModule\n+      for (const provider of providers) {\n+        const injectable = parseProvider(provider);\n+        const injectableDocs = getDocFromAlias(injectable, ngModuleDoc);\n+        if (injectableDocs.length !== 1) {\n+          continue;\n+        }\n+        const injectableDoc = injectableDocs[0];\n+        injectableDoc.ngModules = injectableDoc.ngModules || [];\n+        injectableDoc.ngModules.push(ngModuleDoc);\n+      }\n+\n       // And also add those associated via the `Injectable` `providedIn` property.\n       if (Array.isArray(ngModuleDoc.providers)) {\n         for (const provider of ngModuleDoc.providers) {\n@@ -168,6 +181,7 @@ module.exports = function processNgModuleDocs(getDocFromAlias, createDocMessage,\n       if (providers.length > 0) {\n         ngModuleDoc.providers = providers;\n       }\n+\n     }\n   };\n \n@@ -191,6 +205,15 @@ module.exports = function processNgModuleDocs(getDocFromAlias, createDocMessage,\n   }\n };\n \n+function parseProvider(provider) {\n+  const match = /\\{\\s*provide:\\s*(\\w+)\\s*,/.exec(provider);\n+  if (match) {\n+    return match[1];\n+  } else {\n+    return provider;\n+  }\n+}\n+\n /**\n  * Compute the name of the array that will hold items of this type in the NgModule document.\n  */"
        },
        {
            "sha": "7c78c86744d12899ae6f1ef44c60dd6966f7a4b0",
            "filename": "aio/tools/transforms/angular-api-package/processors/processNgModuleDocs.spec.js",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/71f37c9d9c1f02673cc6cf6a10252ece598c92d2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FprocessNgModuleDocs.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/71f37c9d9c1f02673cc6cf6a10252ece598c92d2/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FprocessNgModuleDocs.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-api-package%2Fprocessors%2FprocessNgModuleDocs.spec.js?ref=71f37c9d9c1f02673cc6cf6a10252ece598c92d2",
            "patch": "@@ -150,6 +150,24 @@ describe('processNgModuleDocs processor', () => {\n     expect(nonInjectable.ngModules).toBeUndefined();\n   });\n \n+  it('should link injectables that are parsed out of `@NgModule` decorators', () => {\n+    const ngModule1 = { docType: 'ngmodule', id: 'NgModule1', ngmoduleOptions: { providers: ['Injectable1', '{ provide: Injectable2, useClass: Injectable2 }'] } };\n+    const ngModule2 = { docType: 'ngmodule', id: 'NgModule2', ngmoduleOptions: { providers: ['{ provide: Injectable3, useValue: {} }'] } };\n+    const injectable1 = { docType: 'class', name: 'Injectable1', aliases: ['Injectable1'] };\n+    const injectable2 = { docType: 'class', name: 'Injectable2', aliases: ['Injectable2'] };\n+    const injectable3 = { docType: 'class', name: 'Injectable3', aliases: ['Injectable3'] };\n+\n+    const aliasMap = injector.get('aliasMap');\n+    aliasMap.addDoc(injectable1);\n+    aliasMap.addDoc(injectable2);\n+    aliasMap.addDoc(injectable3);\n+    processor.$process([ngModule1, ngModule2, injectable1, injectable2, injectable3]);\n+\n+    expect(injectable1.ngModules).toEqual([ngModule1]);\n+    expect(injectable2.ngModules).toEqual([ngModule1]);\n+    expect(injectable3.ngModules).toEqual([ngModule2]);\n+  });\n+\n   it('should error if an injectable that has a `providedIn` property that references an unknown NgModule doc', () => {\n     const log = injector.get('log');\n     const injectable = { docType: 'class', name: 'Injectable1', decorators: [{ name: 'Injectable', argumentInfo: [{ providedIn: 'NgModuleRef' }] }] };"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 41,
        "deletions": 0
    }
}