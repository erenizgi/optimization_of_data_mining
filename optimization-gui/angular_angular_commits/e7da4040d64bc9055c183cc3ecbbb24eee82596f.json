{
    "author": "crisbeto",
    "message": "fix(compiler-cli): adding references to const enums in runtime code (#38542)\n\nWe had a couple of places where we were assuming that if a particular\nsymbol has a value, then it will exist at runtime. This is true in most cases,\nbut it breaks down for `const` enums.\n\nFixes #38513.\n\nPR Close #38542",
    "sha": "e7da4040d64bc9055c183cc3ecbbb24eee82596f",
    "files": [
        {
            "sha": "cf17312b6065714604aecf0f7087a58aaad2583d",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/type_to_value.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftype_to_value.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftype_to_value.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftype_to_value.ts?ref=e7da4040d64bc9055c183cc3ecbbb24eee82596f",
            "patch": "@@ -35,8 +35,9 @@ export function typeToValue(\n \n   const {local, decl} = symbols;\n   // It's only valid to convert a type reference to a value reference if the type actually\n-  // has a value declaration associated with it.\n-  if (decl.valueDeclaration === undefined) {\n+  // has a value declaration associated with it. Note that const enums are an exception,\n+  // because while they do have a value declaration, they don't exist at runtime.\n+  if (decl.valueDeclaration === undefined || decl.flags & ts.SymbolFlags.ConstEnum) {\n     return noValueDeclaration(typeNode, decl.declarations[0]);\n   }\n "
        },
        {
            "sha": "87bbd085fb772bfe09f1c054fce477ed156a0f6d",
            "filename": "packages/compiler-cli/src/transformers/downlevel_decorators_transform.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts?ref=e7da4040d64bc9055c183cc3ecbbb24eee82596f",
            "patch": "@@ -298,15 +298,20 @@ function typeReferenceToExpression(\n }\n \n /**\n- * Returns true if the given symbol refers to a value (as distinct from a type).\n+ * Checks whether a given symbol refers to a value that exists at runtime (as distinct from a type).\n  *\n  * Expands aliases, which is important for the case where\n  *   import * as x from 'some-module';\n  * and x is now a value (the module object).\n  */\n-function symbolIsValue(tc: ts.TypeChecker, sym: ts.Symbol): boolean {\n-  if (sym.flags & ts.SymbolFlags.Alias) sym = tc.getAliasedSymbol(sym);\n-  return (sym.flags & ts.SymbolFlags.Value) !== 0;\n+function symbolIsRuntimeValue(typeChecker: ts.TypeChecker, symbol: ts.Symbol): boolean {\n+  if (symbol.flags & ts.SymbolFlags.Alias) {\n+    symbol = typeChecker.getAliasedSymbol(symbol);\n+  }\n+\n+  // Note that const enums are a special case, because\n+  // while they have a value, they don't exist at runtime.\n+  return (symbol.flags & ts.SymbolFlags.Value & ts.SymbolFlags.ConstEnumExcludes) !== 0;\n }\n \n /** ParameterDecorationInfo describes the information for a single constructor parameter. */\n@@ -351,7 +356,7 @@ export function getDownlevelDecoratorsTransform(\n       const symbol = typeChecker.getSymbolAtLocation(name);\n       // Check if the entity name references a symbol that is an actual value. If it is not, it\n       // cannot be referenced by an expression, so return undefined.\n-      if (!symbol || !symbolIsValue(typeChecker, symbol) || !symbol.declarations ||\n+      if (!symbol || !symbolIsRuntimeValue(typeChecker, symbol) || !symbol.declarations ||\n           symbol.declarations.length === 0) {\n         return undefined;\n       }"
        },
        {
            "sha": "596de1ef1429da6e327238b847cd4a07840249f0",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=e7da4040d64bc9055c183cc3ecbbb24eee82596f",
            "patch": "@@ -4369,6 +4369,53 @@ runInEachFileSystem(os => {\n          expect(jsContents).toMatch(setClassMetadataRegExp('type: undefined'));\n        });\n \n+    it('should use `undefined` in setClassMetadata for const enums', () => {\n+      env.write(`keycodes.ts`, `\n+        export const enum KeyCodes {A, B};\n+      `);\n+      env.write(`test.ts`, `\n+        import {Component, Inject} from '@angular/core';\n+        import {KeyCodes} from './keycodes';\n+\n+        @Component({\n+          selector: 'some-comp',\n+          template: '...',\n+        })\n+        export class SomeComp {\n+          constructor(@Inject('arg-token') arg: KeyCodes) {}\n+        }\n+      `);\n+\n+      env.driveMain();\n+      const jsContents = trim(env.getContents('test.js'));\n+      expect(jsContents).not.toContain(`import { KeyCodes } from './keycodes';`);\n+      // Note: `type: undefined` below, since KeyCodes can't be represented as a value\n+      expect(jsContents).toMatch(setClassMetadataRegExp('type: undefined'));\n+    });\n+\n+    it('should preserve the types of non-const enums in setClassMetadata', () => {\n+      env.write(`keycodes.ts`, `\n+        export enum KeyCodes {A, B};\n+      `);\n+      env.write(`test.ts`, `\n+        import {Component, Inject} from '@angular/core';\n+        import {KeyCodes} from './keycodes';\n+\n+        @Component({\n+          selector: 'some-comp',\n+          template: '...',\n+        })\n+        export class SomeComp {\n+          constructor(@Inject('arg-token') arg: KeyCodes) {}\n+        }\n+      `);\n+\n+      env.driveMain();\n+      const jsContents = trim(env.getContents('test.js'));\n+      expect(jsContents).toContain(`import { KeyCodes } from './keycodes';`);\n+      expect(jsContents).toMatch(setClassMetadataRegExp('type: i1.KeyCodes'));\n+    });\n+\n     it('should use `undefined` in setClassMetadata if types originate from type-only imports',\n        () => {\n          env.write(`types.ts`, `"
        },
        {
            "sha": "51e316cb6be8811b610f1ce2d95bf1a39d8a0044",
            "filename": "packages/compiler-cli/test/transformers/downlevel_decorators_transform_spec.ts",
            "status": "modified",
            "additions": 45,
            "deletions": 19,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2Fdownlevel_decorators_transform_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e7da4040d64bc9055c183cc3ecbbb24eee82596f/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2Fdownlevel_decorators_transform_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Ftransformers%2Fdownlevel_decorators_transform_spec.ts?ref=e7da4040d64bc9055c183cc3ecbbb24eee82596f",
            "patch": "@@ -192,7 +192,7 @@ describe('downlevel decorator transform', () => {\n   it('should downlevel Angular-decorated class member', () => {\n     const {output} = transform(`\n       import {Input} from '@angular/core';\n-      \n+\n       export class MyDir {\n         @Input() disabled: boolean = false;\n       }\n@@ -231,7 +231,7 @@ describe('downlevel decorator transform', () => {\n     const {output} = transform(`\n       import {Input} from '@angular/core';\n       import {MyOtherClass} from './other-file';\n-      \n+\n       export class MyDir {\n         @Input() trigger: HTMLElement;\n         @Input() fromOtherFile: MyOtherClass;\n@@ -255,7 +255,7 @@ describe('downlevel decorator transform', () => {\n         `\n       import {Directive} from '@angular/core';\n       import {MyOtherClass} from './other-file';\n-      \n+\n       @Directive()\n       export class MyDir {\n         constructor(other: MyOtherClass) {}\n@@ -281,7 +281,7 @@ describe('downlevel decorator transform', () => {\n         `\n       import {Directive} from '@angular/core';\n       import {MyOtherClass} from './other-file';\n-      \n+\n       @Directive()\n       export class MyDir {\n         constructor(other: MyOtherClass) {}\n@@ -307,7 +307,7 @@ describe('downlevel decorator transform', () => {\n     const {output} = transform(`\n       import {Directive} from '@angular/core';\n       import * as externalFile from './other-file';\n-      \n+\n       @Directive()\n       export class MyDir {\n         constructor(other: externalFile.MyOtherClass) {}\n@@ -329,11 +329,11 @@ describe('downlevel decorator transform', () => {\n   it('should properly serialize constructor parameter with local qualified name type', () => {\n     const {output} = transform(`\n       import {Directive} from '@angular/core';\n-      \n+\n       namespace other {\n         export class OtherClass {}\n       };\n-      \n+\n       @Directive()\n       export class MyDir {\n         constructor(other: other.OtherClass) {}\n@@ -355,7 +355,7 @@ describe('downlevel decorator transform', () => {\n   it('should properly downlevel constructor parameter decorators', () => {\n     const {output} = transform(`\n       import {Inject, Directive, DOCUMENT} from '@angular/core';\n-      \n+\n       @Directive()\n       export class MyDir {\n         constructor(@Inject(DOCUMENT) document: Document) {}\n@@ -376,7 +376,7 @@ describe('downlevel decorator transform', () => {\n   it('should properly downlevel constructor parameters with union type', () => {\n     const {output} = transform(`\n       import {Optional, Directive, NgZone} from '@angular/core';\n-      \n+\n       @Directive()\n       export class MyDir {\n         constructor(@Optional() ngZone: NgZone|null) {}\n@@ -546,18 +546,20 @@ describe('downlevel decorator transform', () => {\n       export default interface {\n         hello: false;\n       }\n+      export const enum KeyCodes {A, B}\n     `);\n     const {output} = transform(`\n       import {Directive, Inject} from '@angular/core';\n       import * as angular from './external';\n-      import {IOverlay} from './external';\n+      import {IOverlay, KeyCodes} from './external';\n       import TypeFromDefaultImport from './external';\n \n       @Directive()\n       export class MyDir {\n         constructor(@Inject('$state') param: angular.IState,\n                     @Inject('$overlay') other: IOverlay,\n-                    @Inject('$default') default: TypeFromDefaultImport) {}\n+                    @Inject('$default') default: TypeFromDefaultImport,\n+                    @Inject('$keyCodes') keyCodes: KeyCodes) {}\n       }\n     `);\n \n@@ -570,7 +572,8 @@ describe('downlevel decorator transform', () => {\n       MyDir.ctorParameters = () => [\n         { type: undefined, decorators: [{ type: core_1.Inject, args: ['$state',] }] },\n         { type: undefined, decorators: [{ type: core_1.Inject, args: ['$overlay',] }] },\n-        { type: undefined, decorators: [{ type: core_1.Inject, args: ['$default',] }] }\n+        { type: undefined, decorators: [{ type: core_1.Inject, args: ['$default',] }] },\n+        { type: undefined, decorators: [{ type: core_1.Inject, args: ['$keyCodes',] }] }\n       ];\n     `);\n   });\n@@ -593,7 +596,7 @@ describe('downlevel decorator transform', () => {\n     const {output} = transform(\n         `\n       import {Directive} from '@angular/core';\n-      \n+\n       export class MyInjectedClass {}\n \n       @Directive()\n@@ -609,13 +612,36 @@ describe('downlevel decorator transform', () => {\n     expect(output).not.toContain('tslib');\n   });\n \n+  it('should capture a non-const enum used as a constructor type', () => {\n+    const {output} = transform(`\n+      import {Component} from '@angular/core';\n+\n+      export enum Values {A, B};\n+\n+      @Component({template: 'hello'})\n+      export class MyComp {\n+        constructor(v: Values) {}\n+      }\n+    `);\n+\n+    expect(diagnostics.length).toBe(0);\n+    expect(output).toContain(dedent`\n+      MyComp.decorators = [\n+        { type: core_1.Component, args: [{ template: 'hello' },] }\n+      ];\n+      MyComp.ctorParameters = () => [\n+        { type: Values }\n+      ];`);\n+    expect(output).not.toContain('tslib');\n+  });\n+\n   describe('class decorators skipped', () => {\n     beforeEach(() => skipClassDecorators = true);\n \n     it('should not downlevel Angular class decorators', () => {\n       const {output} = transform(`\n         import {Injectable} from '@angular/core';\n-  \n+\n         @Injectable()\n         export class MyService {}\n       `);\n@@ -632,10 +658,10 @@ describe('downlevel decorator transform', () => {\n     it('should downlevel constructor parameters', () => {\n       const {output} = transform(`\n         import {Injectable} from '@angular/core';\n- \n+\n         @Injectable()\n         export class InjectClass {}\n- \n+\n         @Injectable()\n         export class MyService {\n           constructor(dep: InjectClass) {}\n@@ -658,10 +684,10 @@ describe('downlevel decorator transform', () => {\n     it('should downlevel constructor parameter decorators', () => {\n       const {output} = transform(`\n         import {Injectable, Inject} from '@angular/core';\n- \n+\n         @Injectable()\n         export class InjectClass {}\n- \n+\n         @Injectable()\n         export class MyService {\n           constructor(@Inject('test') dep: InjectClass) {}\n@@ -684,7 +710,7 @@ describe('downlevel decorator transform', () => {\n     it('should downlevel class member Angular decorators', () => {\n       const {output} = transform(`\n         import {Injectable, Input} from '@angular/core';\n- \n+\n         export class MyService {\n           @Input() disabled: boolean;\n         }"
        }
    ],
    "stats": {
        "total": 131,
        "additions": 105,
        "deletions": 26
    }
}