{
    "author": "arturovt",
    "message": "fix(core): unsubscribe from the `onError` when the root view is removed (#39940)\n\nAt the moment, when creating a root module, a subscription to the\n`onError` subject is also created. It captures the scope where `NgModuleRef`\nis created and prevents it from being garbage collected. Also note that this\n`NgModuleRef` has a reference to the root module instance (e.g. `AppModule`),\nwhich also prevents it from being GC'd.\n\nPR Close #39940",
    "sha": "5a3a154cd862e7294158d2d086a0a1a29bdbe09d",
    "files": [
        {
            "sha": "5f833bbddafc9f943242311eded1d459249279f0",
            "filename": "packages/core/src/application_ref.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/5a3a154cd862e7294158d2d086a0a1a29bdbe09d/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/5a3a154cd862e7294158d2d086a0a1a29bdbe09d/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fapplication_ref.ts?ref=5a3a154cd862e7294158d2d086a0a1a29bdbe09d",
            "patch": "@@ -350,12 +350,17 @@ export class PlatformRef {\n       if (!exceptionHandler) {\n         throw new Error('No ErrorHandler. Is platform module (BrowserModule) included?');\n       }\n-      moduleRef.onDestroy(() => remove(this._modules, moduleRef));\n-      ngZone!.runOutsideAngular(() => ngZone!.onError.subscribe({\n-        next: (error: any) => {\n-          exceptionHandler.handleError(error);\n-        }\n-      }));\n+      ngZone!.runOutsideAngular(() => {\n+        const subscription = ngZone!.onError.subscribe({\n+          next: (error: any) => {\n+            exceptionHandler.handleError(error);\n+          }\n+        });\n+        moduleRef.onDestroy(() => {\n+          remove(this._modules, moduleRef);\n+          subscription.unsubscribe();\n+        });\n+      });\n       return _callAndReportToErrorHandler(exceptionHandler, ngZone!, () => {\n         const initStatus: ApplicationInitStatus = moduleRef.injector.get(ApplicationInitStatus);\n         initStatus.runInitializers();"
        },
        {
            "sha": "edd8eaa43d254140090c6ac5b17273d9ab3ed3df",
            "filename": "packages/core/test/acceptance/bootstrap_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/5a3a154cd862e7294158d2d086a0a1a29bdbe09d/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5a3a154cd862e7294158d2d086a0a1a29bdbe09d/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fbootstrap_spec.ts?ref=5a3a154cd862e7294158d2d086a0a1a29bdbe09d",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ApplicationRef, COMPILER_OPTIONS, Component, destroyPlatform, NgModule, TestabilityRegistry, ViewEncapsulation} from '@angular/core';\n+import {ApplicationRef, COMPILER_OPTIONS, Component, destroyPlatform, NgModule, NgZone, TestabilityRegistry, ViewEncapsulation} from '@angular/core';\n import {expect} from '@angular/core/testing/src/testing_internal';\n import {BrowserModule} from '@angular/platform-browser';\n import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n@@ -227,6 +227,22 @@ describe('bootstrap', () => {\n          }));\n     });\n \n+    describe('PlatformRef cleanup', () => {\n+      it('should unsubscribe from `onError` when Injector is destroyed',\n+         withBody('<my-app></my-app>', async () => {\n+           const TestModule = createComponentAndModule();\n+\n+           const ngModuleRef = await platformBrowserDynamic().bootstrapModule(TestModule);\n+           const ngZone = ngModuleRef.injector.get(NgZone);\n+\n+           expect(ngZone.onError.observers.length).toBe(1);\n+\n+           ngModuleRef.destroy();\n+\n+           expect(ngZone.onError.observers.length).toBe(0);\n+         }));\n+    });\n+\n     onlyInIvy('options cannot be changed in Ivy').describe('changing bootstrap options', () => {\n       beforeEach(() => {\n         spyOn(console, 'error');\n@@ -365,4 +381,4 @@ export class MultipleSelectorsAppComponent {\n   bootstrap: [MultipleSelectorsAppComponent],\n })\n export class MultipleSelectorsAppModule {\n-}\n\\ No newline at end of file\n+}"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 29,
        "deletions": 8
    }
}