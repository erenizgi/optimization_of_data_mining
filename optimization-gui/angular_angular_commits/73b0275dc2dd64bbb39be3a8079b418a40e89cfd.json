{
    "author": "gkalpak",
    "message": "fix(service-worker): improve ServiceWorker cache names (#42622)\n\nThis commit improves the cache names generated by the ServiceWorker by\nmaking them shorter and non-repetitive. In particular, the following\nchanges are made:\n\n- Data-group cache names no longer include the `dynamic` infix, since it\n  does not add any value.\n  Before: `ngsw:<...>:data:dynamic:<...>`\n  After:  `ngsw:<...>:data:<...>`\n\n- `CacheDatabase` table names no longer include the `ngsw:<path>` prefix\n  twice.\n  Before: `ngsw:<path>:db:ngsw:<path>:<...>`\n  After:  `ngsw:<path>:db:<...>`\n\nNOTE 1:\nThis change will result in different cache names being generated for the\nsame app-versions with the new SericeWorker script. This means that some\nof the previously cached data will need to be re-downloaded (because the\nServiceWorker will not be able to re-use the old caches), but that\nshould be transparent for the end user.\nWhile possible, adding logic to allow the ServiceWorker to retrieve data\nfrom the old caches is not worth the extra complecity and maintenance\ncost.\n\nNOTE 2:\nGenerating different cache names for some of the caches means that the\nServiceWorker will not be able to clean-up some of the old caches. This\nwill be taken care of in a subsequent commit that will rework the\nclean-up logic to be more robust (covering changes such as this one and\nother edgecases).\n\nPR Close #42622",
    "sha": "73b0275dc2dd64bbb39be3a8079b418a40e89cfd",
    "files": [
        {
            "sha": "07cf0159ca4e2610e8e3ffa47d13aa121db87bfb",
            "filename": "packages/service-worker/worker/src/app-version.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "raw_url": "https://github.com/angular/angular/raw/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fapp-version.ts?ref=73b0275dc2dd64bbb39be3a8079b418a40e89cfd",
            "patch": "@@ -77,7 +77,7 @@ export class AppVersion implements UpdateSource {\n \n     // Process each `AssetGroup` declared in the manifest. Each declared group gets an `AssetGroup`\n     // instance created for it, of a type that depends on the configuration mode.\n-    const assetCacheNamePrefix = `${adapter.cacheNamePrefix}:${manifestHash}:assets`;\n+    const assetCacheNamePrefix = `${manifestHash}:assets`;\n     this.assetGroups = (manifest.assetGroups || []).map(config => {\n       // Check the caching mode, which determines when resources will be fetched/updated.\n       switch (config.installMode) {\n@@ -91,11 +91,11 @@ export class AppVersion implements UpdateSource {\n     });\n \n     // Process each `DataGroup` declared in the manifest.\n-    this.dataGroups = (manifest.dataGroups || [])\n-                          .map(\n-                              config => new DataGroup(\n-                                  scope, adapter, config, database, debugHandler,\n-                                  `${adapter.cacheNamePrefix}:${config.version}:data`));\n+    this.dataGroups =\n+        (manifest.dataGroups || [])\n+            .map(\n+                config => new DataGroup(\n+                    scope, adapter, config, database, debugHandler, `${config.version}:data`));\n \n     // This keeps backwards compatibility with app versions without navigation urls.\n     // Fix: https://github.com/angular/angular/issues/27209"
        },
        {
            "sha": "b511f082f22ef578201902a5e8ecb7bfa60d6ac1",
            "filename": "packages/service-worker/worker/src/assets.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "raw_url": "https://github.com/angular/angular/raw/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts?ref=73b0275dc2dd64bbb39be3a8079b418a40e89cfd",
            "patch": "@@ -67,7 +67,8 @@ export abstract class AssetGroup {\n \n     // This is the primary cache, which holds all of the cached requests for this group. If a\n     // resource isn't in this cache, it hasn't been fetched yet.\n-    this.cache = scope.caches.open(`${cacheNamePrefix}:${config.name}:cache`);\n+    this.cache =\n+        scope.caches.open(`${adapter.cacheNamePrefix}:${cacheNamePrefix}:${config.name}:cache`);\n \n     // This is the metadata table, which holds specific information for each cached URL, such as\n     // the timestamp of when it was added to the cache.\n@@ -103,7 +104,8 @@ export abstract class AssetGroup {\n    * Clean up all the cached data for this group.\n    */\n   async cleanup(): Promise<void> {\n-    await this.scope.caches.delete(`${this.cacheNamePrefix}:${this.config.name}:cache`);\n+    await this.scope.caches.delete(\n+        `${this.adapter.cacheNamePrefix}:${this.cacheNamePrefix}:${this.config.name}:cache`);\n     await this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:meta`);\n   }\n "
        },
        {
            "sha": "1803571f6ee5918ba0502b7aa4c243ab2482d21b",
            "filename": "packages/service-worker/worker/src/data.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "raw_url": "https://github.com/angular/angular/raw/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts?ref=73b0275dc2dd64bbb39be3a8079b418a40e89cfd",
            "patch": "@@ -249,11 +249,10 @@ export class DataGroup {\n       private config: DataGroupConfig, private db: Database, private debugHandler: DebugHandler,\n       private cacheNamePrefix: string) {\n     this.patterns = config.patterns.map(pattern => new RegExp(pattern));\n-    this.cache = scope.caches.open(`${cacheNamePrefix}:dynamic:${config.name}:cache`);\n-    this.lruTable =\n-        this.db.open(`${cacheNamePrefix}:dynamic:${config.name}:lru`, config.cacheQueryOptions);\n-    this.ageTable =\n-        this.db.open(`${cacheNamePrefix}:dynamic:${config.name}:age`, config.cacheQueryOptions);\n+    this.cache =\n+        scope.caches.open(`${adapter.cacheNamePrefix}:${cacheNamePrefix}:${config.name}:cache`);\n+    this.lruTable = this.db.open(`${cacheNamePrefix}:${config.name}:lru`, config.cacheQueryOptions);\n+    this.ageTable = this.db.open(`${cacheNamePrefix}:${config.name}:age`, config.cacheQueryOptions);\n   }\n \n   /**\n@@ -550,9 +549,10 @@ export class DataGroup {\n   async cleanup(): Promise<void> {\n     // Remove both the cache and the database entries which track LRU stats.\n     await Promise.all([\n-      this.scope.caches.delete(`${this.cacheNamePrefix}:dynamic:${this.config.name}:cache`),\n-      this.db.delete(`${this.cacheNamePrefix}:dynamic:${this.config.name}:age`),\n-      this.db.delete(`${this.cacheNamePrefix}:dynamic:${this.config.name}:lru`),\n+      this.scope.caches.delete(\n+          `${this.adapter.cacheNamePrefix}:${this.cacheNamePrefix}:${this.config.name}:cache`),\n+      this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:age`),\n+      this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:lru`),\n     ]);\n   }\n "
        },
        {
            "sha": "21a72fa13463caa1a61f3dc402b5c45f351c8583",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/73b0275dc2dd64bbb39be3a8079b418a40e89cfd/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=73b0275dc2dd64bbb39be3a8079b418a40e89cfd",
            "patch": "@@ -1269,12 +1269,12 @@ describe('Driver', () => {\n     const cacheKeysFor = (baseHref: string, manifestHash: string) =>\n         [`ngsw:${baseHref}:db:control`,\n          `ngsw:${baseHref}:${manifestHash}:assets:eager:cache`,\n-         `ngsw:${baseHref}:db:ngsw:${baseHref}:${manifestHash}:assets:eager:meta`,\n+         `ngsw:${baseHref}:db:${manifestHash}:assets:eager:meta`,\n          `ngsw:${baseHref}:${manifestHash}:assets:lazy:cache`,\n-         `ngsw:${baseHref}:db:ngsw:${baseHref}:${manifestHash}:assets:lazy:meta`,\n-         `ngsw:${baseHref}:42:data:dynamic:api:cache`,\n-         `ngsw:${baseHref}:db:ngsw:${baseHref}:42:data:dynamic:api:lru`,\n-         `ngsw:${baseHref}:db:ngsw:${baseHref}:42:data:dynamic:api:age`,\n+         `ngsw:${baseHref}:db:${manifestHash}:assets:lazy:meta`,\n+         `ngsw:${baseHref}:42:data:api:cache`,\n+         `ngsw:${baseHref}:db:42:data:api:lru`,\n+         `ngsw:${baseHref}:db:42:data:api:age`,\n     ];\n \n     const createManifestWithBaseHref = (baseHref: string, distDir: MockFileSystem): Manifest => ({"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 23,
        "deletions": 21
    }
}