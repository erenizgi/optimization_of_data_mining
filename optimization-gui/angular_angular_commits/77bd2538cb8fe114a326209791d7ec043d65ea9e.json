{
    "author": "atscott",
    "message": "fix(migrations): apply individual expression edits to preserve newline characters (#43519)\n\nThe previous replacement logic would not account for the CRLF line\nendings when applying replacements because it would replace the whole\ntemplate with `template.content.length` which would not account for\nCRLF. This update applies individual expression edits at each location\nin the template rather than attempting to replace the whole template\ncontents with a new string that contains the migrations.\n\nfixes #43416\n\nPR Close #43519",
    "sha": "77bd2538cb8fe114a326209791d7ec043d65ea9e",
    "files": [
        {
            "sha": "ae5e66a034ba182ddab15850c26d25b568f43709",
            "filename": "packages/core/schematics/migrations/router-link-empty-expression/index.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 17,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/77bd2538cb8fe114a326209791d7ec043d65ea9e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/77bd2538cb8fe114a326209791d7ec043d65ea9e/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Frouter-link-empty-expression%2Findex.ts?ref=77bd2538cb8fe114a326209791d7ec043d65ea9e",
            "patch": "@@ -22,9 +22,14 @@ type Logger = logging.LoggerApi;\n const README_URL =\n     'https://github.com/angular/angular/blob/master/packages/core/schematics/migrations/router-link-empty-expression/README.md';\n \n+interface Replacement {\n+  start: number;\n+  end: number;\n+  newContent: string;\n+}\n interface FixedTemplate {\n   originalTemplate: ResolvedTemplate;\n-  newContent: string;\n+  replacements: Replacement[];\n   emptyRouterlinkExpressions: TmplAstBoundAttribute[];\n }\n \n@@ -69,7 +74,7 @@ function fixEmptyRouterlinks(resolvedTemplates: ResolvedTemplate[], tree: Tree,\n   const collectedFixes: string[] = [];\n   const fixesByFile = getFixesByFile(resolvedTemplates);\n \n-  for (const [absFilePath, fixes] of fixesByFile) {\n+  for (const [absFilePath, templateFixes] of fixesByFile) {\n     const treeFilePath = relative(normalize(basePath), normalize(absFilePath));\n     const originalFileContent = tree.read(treeFilePath)?.toString();\n     if (originalFileContent === undefined) {\n@@ -80,14 +85,17 @@ function fixEmptyRouterlinks(resolvedTemplates: ResolvedTemplate[], tree: Tree,\n     }\n \n     const updater = tree.beginUpdate(treeFilePath);\n-    for (const fix of fixes) {\n-      const displayFilePath = normalize(relative(basePath, fix.originalTemplate.filePath));\n-      updater.remove(fix.originalTemplate.start, fix.originalTemplate.content.length);\n-      updater.insertLeft(fix.originalTemplate.start, fix.newContent);\n-\n-      for (const n of fix.emptyRouterlinkExpressions) {\n+    for (const templateFix of templateFixes) {\n+      // Sort backwards so string replacements do not conflict\n+      templateFix.replacements.sort((a, b) => b.start - a.start);\n+      for (const replacement of templateFix.replacements) {\n+        updater.remove(replacement.start, replacement.end - replacement.start);\n+        updater.insertLeft(replacement.start, replacement.newContent);\n+      }\n+      const displayFilePath = normalize(relative(basePath, templateFix.originalTemplate.filePath));\n+      for (const n of templateFix.emptyRouterlinkExpressions) {\n         const {line, character} =\n-            fix.originalTemplate.getCharacterAndLineOfPosition(n.sourceSpan.start.offset);\n+            templateFix.originalTemplate.getCharacterAndLineOfPosition(n.sourceSpan.start.offset);\n         collectedFixes.push(`${displayFilePath}@${line + 1}:${character + 1}`);\n       }\n       tree.commitUpdate(updater);\n@@ -140,18 +148,28 @@ function fixEmptyRouterlinksInTemplate(template: ResolvedTemplate): FixedTemplat\n     return null;\n   }\n \n-  // Sort backwards so string replacements do not conflict\n-  emptyRouterlinkExpressions.sort((a, b) => b.value.sourceSpan.start - a.value.sourceSpan.start);\n-  let newContent = template.content;\n+  const replacements: Replacement[] = [];\n   for (const expr of emptyRouterlinkExpressions) {\n+    let replacement: Replacement;\n     if (expr.valueSpan) {\n-      newContent = newContent.substr(0, expr.value.sourceSpan.start) + '[]' +\n-          newContent.substr(expr.value.sourceSpan.start);\n+      replacement = {\n+        start: template.start + expr.value.sourceSpan.start,\n+        end: template.start + expr.value.sourceSpan.end,\n+        newContent: '[]',\n+      };\n     } else {\n-      newContent = newContent.substr(0, expr.sourceSpan.end.offset) + '=\"[]\"' +\n-          newContent.substr(expr.sourceSpan.end.offset);\n+      const spanLength = expr.sourceSpan.end.offset - expr.sourceSpan.start.offset;\n+      // `expr.value.sourceSpan.start` is the start of the very beginning of the binding since there\n+      // is no value\n+      const endOfExpr = template.start + expr.value.sourceSpan.start + spanLength;\n+      replacement = {\n+        start: endOfExpr,\n+        end: endOfExpr,\n+        newContent: '=\"[]\"',\n+      };\n     }\n+    replacements.push(replacement);\n   }\n \n-  return {originalTemplate: template, newContent, emptyRouterlinkExpressions};\n+  return {originalTemplate: template, replacements, emptyRouterlinkExpressions};\n }"
        },
        {
            "sha": "f4184bbf6d889a14ac90374578f192dc8614a37a",
            "filename": "packages/core/schematics/test/routerlink_empty_expr_migration_spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/77bd2538cb8fe114a326209791d7ec043d65ea9e/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/77bd2538cb8fe114a326209791d7ec043d65ea9e/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts?ref=77bd2538cb8fe114a326209791d7ec043d65ea9e",
            "patch": "@@ -200,4 +200,24 @@ describe('routerlink emptyExpr assignment migration', () => {\n \n        expect(content).toEqual(contents);\n      });\n+\n+  it('should work for files that use CRLF line endings', async () => {\n+    writeFile(\n+        '/index.ts',\n+        `\n+      import {Component} from '@angular/core';\n+\n+      @Component({` +\n+            'template: `<div [routerLink]=\\'\\'>\\r\\n{{1}}\\r\\n</div>`' +\n+            `})\n+      export class MyComp {}\n+    `);\n+\n+    await runMigration();\n+    expect(warnOutput.length).toBe(1);\n+    expect(warnOutput[0]).toMatch(/^â®‘ {3}index.ts@4:35/);\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toContain(`<div [routerLink]='[]'>\\r\\n{{1}}\\r\\n</div>`);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 55,
        "deletions": 17
    }
}