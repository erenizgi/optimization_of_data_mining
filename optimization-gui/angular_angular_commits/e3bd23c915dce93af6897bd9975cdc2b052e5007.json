{
    "author": "alxhub",
    "message": "perf(language-service): update NgCompiler via resource-only path when able (#40585)\n\nThis commit changes the Language Service's \"compiler factory\" mechanism to\nleverage the new resource-only update path for `NgCompiler`. When an\nincoming change only affects a resource file like a component template or\nstylesheet, going through the new API allows the Language Service to avoid\nunnecessary incremental steps of the `NgCompiler` and return answers more\nefficiently.\n\nPR Close #40585",
    "sha": "e3bd23c915dce93af6897bd9975cdc2b052e5007",
    "files": [
        {
            "sha": "f77ac2b2b88e5b0a24f77c4ef4fdb2b70ec2045d",
            "filename": "packages/language-service/ivy/adapters.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fadapters.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -25,7 +25,13 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n   readonly factoryTracker = null;      // no .ngfactory shims\n   readonly unifiedModulesHost = null;  // only used in Bazel\n   readonly rootDirs: AbsoluteFsPath[];\n-  private readonly templateVersion = new Map<string, string>();\n+\n+  /**\n+   * Map of resource filenames to the version of the file last read via `readResource`.\n+   *\n+   * Used to implement `getModifiedResourceFiles`.\n+   */\n+  private readonly lastReadResourceVersion = new Map<string, string>();\n \n   constructor(private readonly project: ts.server.Project) {\n     this.rootDirs = getRootDirs(this, project.getCompilationSettings());\n@@ -81,14 +87,18 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n       throw new Error(`Failed to get script snapshot while trying to read ${fileName}`);\n     }\n     const version = this.project.getScriptVersion(fileName);\n-    this.templateVersion.set(fileName, version);\n+    this.lastReadResourceVersion.set(fileName, version);\n     return snapshot.getText(0, snapshot.getLength());\n   }\n \n-  isTemplateDirty(fileName: string): boolean {\n-    const lastVersion = this.templateVersion.get(fileName);\n-    const latestVersion = this.project.getScriptVersion(fileName);\n-    return lastVersion !== latestVersion;\n+  getModifiedResourceFiles(): Set<string>|undefined {\n+    const modifiedFiles = new Set<string>();\n+    for (const [fileName, oldVersion] of this.lastReadResourceVersion) {\n+      if (this.project.getScriptVersion(fileName) !== oldVersion) {\n+        modifiedFiles.add(fileName);\n+      }\n+    }\n+    return modifiedFiles.size > 0 ? modifiedFiles : undefined;\n   }\n }\n "
        },
        {
            "sha": "d243f0b16400dc4648e7766270be6402211ff84c",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 41,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket, NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n+import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket, NgCompiler, resourceChangeTicket} from '@angular/compiler-cli/src/ngtsc/core';\n import {NgCompilerOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n import {TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n@@ -37,51 +37,30 @@ export class CompilerFactory {\n \n   getOrCreate(): NgCompiler {\n     const program = this.programStrategy.getProgram();\n-    if (this.compiler === null || program !== this.lastKnownProgram) {\n-      let ticket: CompilationTicket;\n-      if (this.compiler === null || this.lastKnownProgram === null) {\n-        ticket = freshCompilationTicket(\n-            program, this.options, this.incrementalStrategy, this.programStrategy, true, true);\n-      } else {\n-        ticket = incrementalFromCompilerTicket(\n-            this.compiler, program, this.incrementalStrategy, this.programStrategy, new Set());\n+    const modifiedResourceFiles = this.adapter.getModifiedResourceFiles() ?? new Set();\n+\n+    if (this.compiler !== null && program === this.lastKnownProgram) {\n+      if (modifiedResourceFiles.size > 0) {\n+        // Only resource files have changed since the last NgCompiler was created.\n+        const ticket = resourceChangeTicket(this.compiler, modifiedResourceFiles);\n+        this.compiler = NgCompiler.fromTicket(ticket, this.adapter);\n       }\n-      this.compiler = NgCompiler.fromTicket(ticket, this.adapter);\n-      this.lastKnownProgram = program;\n-    }\n-    return this.compiler;\n-  }\n \n-  /**\n-   * Create a new instance of the Ivy compiler if the program has changed since\n-   * the last time the compiler was instantiated. If the program has not changed,\n-   * return the existing instance.\n-   * @param fileName override the template if this is an external template file\n-   * @param options angular compiler options\n-   */\n-  getOrCreateWithChangedFile(fileName: string): NgCompiler {\n-    const compiler = this.getOrCreate();\n-    if (isExternalTemplate(fileName)) {\n-      this.overrideTemplate(fileName, compiler);\n+      return this.compiler;\n     }\n-    return compiler;\n-  }\n \n-  private overrideTemplate(fileName: string, compiler: NgCompiler) {\n-    if (!this.adapter.isTemplateDirty(fileName)) {\n-      return;\n-    }\n-    // 1. Get the latest snapshot\n-    const latestTemplate = this.adapter.readResource(fileName);\n-    // 2. Find all components that use the template\n-    const ttc = compiler.getTemplateTypeChecker();\n-    const components = compiler.getComponentsWithTemplateFile(fileName);\n-    // 3. Update component template\n-    for (const component of components) {\n-      if (ts.isClassDeclaration(component)) {\n-        ttc.overrideComponentTemplate(component, latestTemplate);\n-      }\n+    let ticket: CompilationTicket;\n+    if (this.compiler === null || this.lastKnownProgram === null) {\n+      ticket = freshCompilationTicket(\n+          program, this.options, this.incrementalStrategy, this.programStrategy, true, true);\n+    } else {\n+      ticket = incrementalFromCompilerTicket(\n+          this.compiler, program, this.incrementalStrategy, this.programStrategy,\n+          modifiedResourceFiles);\n     }\n+    this.compiler = NgCompiler.fromTicket(ticket, this.adapter);\n+    this.lastKnownProgram = program;\n+    return this.compiler;\n   }\n \n   registerLastKnownProgram() {"
        },
        {
            "sha": "1b3a199b4829f6be93026468eb461fd16dc4c4a8",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -67,7 +67,7 @@ export class LanguageService {\n   }\n \n   getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const ttc = compiler.getTemplateTypeChecker();\n     const diagnostics: ts.Diagnostic[] = [];\n     if (isTypeScriptFile(fileName)) {\n@@ -90,7 +90,7 @@ export class LanguageService {\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const results =\n         new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n@@ -99,15 +99,15 @@ export class LanguageService {\n \n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const results =\n         new DefinitionBuilder(this.tsLS, compiler).getTypeDefinitionsAtPosition(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n     return results;\n   }\n \n   getQuickInfoAtPosition(fileName: string, position: number): ts.QuickInfo|undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n     if (templateInfo === undefined) {\n       return undefined;\n@@ -129,15 +129,15 @@ export class LanguageService {\n   }\n \n   getReferencesAtPosition(fileName: string, position: number): ts.ReferenceEntry[]|undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const results = new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n                         .getReferencesAtPosition(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n     return results;\n   }\n \n   getRenameInfo(fileName: string, position: number): ts.RenameInfo {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const renameInfo = new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n                            .getRenameInfo(absoluteFrom(fileName), position);\n     if (!renameInfo.canRename) {\n@@ -152,7 +152,7 @@ export class LanguageService {\n   }\n \n   findRenameLocations(fileName: string, position: number): readonly ts.RenameLocation[]|undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const results = new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n                         .findRenameLocations(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n@@ -161,7 +161,7 @@ export class LanguageService {\n \n   private getCompletionBuilder(fileName: string, position: number):\n       CompletionBuilder<TmplAstNode|AST>|null {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const compiler = this.compilerFactory.getOrCreate();\n     const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n     if (templateInfo === undefined) {\n       return null;\n@@ -219,7 +219,7 @@ export class LanguageService {\n   }\n \n   getTcb(fileName: string, position: number): GetTcbResponse {\n-    return this.withCompiler<GetTcbResponse>(fileName, compiler => {\n+    return this.withCompiler<GetTcbResponse>(compiler => {\n       const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n       if (templateInfo === undefined) {\n         return undefined;\n@@ -263,8 +263,8 @@ export class LanguageService {\n     });\n   }\n \n-  private withCompiler<T>(fileName: string, p: (compiler: NgCompiler) => T): T {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+  private withCompiler<T>(p: (compiler: NgCompiler) => T): T {\n+    const compiler = this.compilerFactory.getOrCreate();\n     const result = p(compiler);\n     this.compilerFactory.registerLastKnownProgram();\n     return result;"
        },
        {
            "sha": "87883fafc715df805c4e570034db951d0ed17f39",
            "filename": "packages/language-service/ivy/test/compiler_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -17,6 +17,38 @@ describe('language-service/compiler integration', () => {\n     initMockFileSystem('Native');\n   });\n \n+  it('should react to a change in an external template', () => {\n+    const cmpFile = absoluteFrom('/test.ts');\n+    const tmplFile = absoluteFrom('/test.html');\n+\n+    const env = LanguageServiceTestEnvironment.setup([\n+      {\n+        name: cmpFile,\n+        contents: `\n+          import {Component} from '@angular/core';\n+\n+          @Component({\n+            selector: 'test-cmp',\n+            templateUrl: './test.html',\n+          })\n+          export class TestCmp {}\n+        `,\n+        isRoot: true,\n+      },\n+      {\n+        name: tmplFile,\n+        contents: '<other-cmp>Test</other-cmp>',\n+      },\n+    ]);\n+\n+    const diags = env.ngLS.getSemanticDiagnostics(cmpFile);\n+    expect(diags.length).toBeGreaterThan(0);\n+\n+    env.updateFile(tmplFile, '<div>Test</div>');\n+    const afterDiags = env.ngLS.getSemanticDiagnostics(cmpFile);\n+    expect(afterDiags.length).toBe(0);\n+  });\n+\n   it('should not produce errors from inline test declarations mixing with those of the app', () => {\n     const appCmpFile = absoluteFrom('/test.cmp.ts');\n     const appModuleFile = absoluteFrom('/test.mod.ts');"
        },
        {
            "sha": "080abfbf9b90598aacae922840a60cff25a32853",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -6,14 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {TmplAstNode} from '@angular/compiler';\n import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import * as ts from 'typescript';\n import {DisplayInfoKind, unsafeCastDisplayInfoKindToScriptElementKind} from '../display_parts';\n import {LanguageService} from '../language_service';\n \n-import {LanguageServiceTestEnvironment} from './env';\n+import {extractCursorInfo, LanguageServiceTestEnvironment} from './env';\n \n const DIR_WITH_INPUT = {\n   'Dir': `\n@@ -640,7 +639,6 @@ function setup(\n   AppCmp: ts.ClassDeclaration,\n   ngLS: LanguageService,\n   cursor: number,\n-  nodes: TmplAstNode[],\n   text: string,\n } {\n   const codePath = absoluteFrom('/test.ts');\n@@ -650,6 +648,7 @@ function setup(\n \n   const otherDirectiveClassDecls = Object.values(otherDeclarations).join('\\n\\n');\n \n+  const {cursor, text: templateWithoutCursor} = extractCursorInfo(templateWithCursor);\n   const env = LanguageServiceTestEnvironment.setup([\n     {\n       name: codePath,\n@@ -675,18 +674,15 @@ function setup(\n     },\n     {\n       name: templatePath,\n-      contents: 'Placeholder template',\n+      contents: templateWithoutCursor,\n     }\n   ]);\n-  const {nodes, cursor, text} =\n-      env.overrideTemplateWithCursor(codePath, 'AppCmp', templateWithCursor);\n   return {\n     env,\n     fileName: templatePath,\n     AppCmp: env.getClass(codePath, 'AppCmp'),\n     ngLS: env.ngLS,\n-    nodes,\n-    text,\n+    text: templateWithoutCursor,\n     cursor,\n   };\n }"
        },
        {
            "sha": "056bf1b2a94697005dc31a2f97d13cf9b3becf8d",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -27,8 +27,8 @@ describe('definitions', () => {\n     };\n \n     const env = createModuleWithDeclarations([appFile], [templateFile]);\n-    const {cursor} = env.overrideTemplateWithCursor(\n-        absoluteFrom('/app.ts'), 'AppCmp', '<input #myInput /> {{myIn¦put.value}}');\n+    const {cursor} = env.updateFileWithCursor(\n+        absoluteFrom('/app.html'), '<input #myInput /> {{myIn¦put.value}}');\n     env.expectNoSourceDiagnostics();\n     const {definitions} = env.ngLS.getDefinitionAndBoundSpan(absoluteFrom('/app.html'), cursor)!;\n     expect(definitions![0].name).toEqual('myInput');"
        },
        {
            "sha": "9da1e74836b7cfda9acfd7522688dd2c8732aa69",
            "filename": "packages/language-service/ivy/test/env.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 23,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -46,13 +46,6 @@ function writeTsconfig(\n \n export type TestableOptions = StrictTemplateOptions;\n \n-export interface TemplateOverwriteResult {\n-  cursor: number;\n-  nodes: TmplAstNode[];\n-  component: ts.ClassDeclaration;\n-  text: string;\n-}\n-\n export class LanguageServiceTestEnvironment {\n   private constructor(\n       readonly tsLS: ts.LanguageService, readonly ngLS: LanguageService,\n@@ -118,26 +111,16 @@ export class LanguageServiceTestEnvironment {\n     return getClassOrError(sf, className);\n   }\n \n-  overrideTemplateWithCursor(fileName: AbsoluteFsPath, className: string, contents: string):\n-      TemplateOverwriteResult {\n-    const program = this.tsLS.getProgram();\n-    if (program === undefined) {\n-      throw new Error(`Expected to get a ts.Program`);\n-    }\n-    const sf = getSourceFileOrError(program, fileName);\n-    const component = getClassOrError(sf, className);\n-\n-    const ngCompiler = this.ngLS.compilerFactory.getOrCreate();\n-    const templateTypeChecker = ngCompiler.getTemplateTypeChecker();\n-\n+  updateFileWithCursor(fileName: AbsoluteFsPath, contents: string): {cursor: number, text: string} {\n     const {cursor, text} = extractCursorInfo(contents);\n-\n-    const {nodes} = templateTypeChecker.overrideComponentTemplate(component, text);\n-    return {cursor, nodes, component, text};\n+    this.updateFile(fileName, text);\n+    return {cursor, text};\n   }\n \n   updateFile(fileName: AbsoluteFsPath, contents: string): void {\n-    const scriptInfo = this.projectService.getScriptInfo(fileName);\n+    const normalFileName = ts.server.toNormalizedPath(fileName);\n+    const scriptInfo =\n+        this.projectService.getOrCreateScriptInfoForNormalizedPath(normalFileName, true, '');\n     if (scriptInfo === undefined) {\n       throw new Error(`Could not find a file named ${fileName}`);\n     }"
        },
        {
            "sha": "0b0a357d9d0dcbd20aa1b0c71a726b603b265c88",
            "filename": "packages/language-service/ivy/test/legacy/adapters_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/11ca2f04f90e0f68b91a0235643d7b81c0c094d2/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fadapters_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/11ca2f04f90e0f68b91a0235643d7b81c0c094d2/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fadapters_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fadapters_spec.ts?ref=11ca2f04f90e0f68b91a0235643d7b81c0c094d2",
            "patch": "@@ -1,41 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import * as ts from 'typescript/lib/tsserverlibrary';\n-\n-import {LanguageServiceAdapter} from '../../adapters';\n-\n-import {MockService, setup, TEST_TEMPLATE} from './mock_host';\n-\n-describe('Language service adapter', () => {\n-  let project: ts.server.Project;\n-  let service: MockService;\n-\n-  beforeAll(() => {\n-    const {project: _project, service: _service} = setup();\n-    project = _project;\n-    service = _service;\n-  });\n-\n-  it('should mark template dirty if it has not seen the template before', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeTrue();\n-  });\n-\n-  it('should not mark template dirty if template has not changed', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    adapter.readResource(TEST_TEMPLATE);\n-    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeFalse();\n-  });\n-\n-  it('should mark template dirty if template has changed', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    service.overwrite(TEST_TEMPLATE, '<p>Hello World</p>');\n-    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeTrue();\n-  });\n-});"
        },
        {
            "sha": "d7713bc0471ea46d78d452e1b5ef82998b5d3b4c",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n@@ -476,8 +476,8 @@ describe('quick info', () => {\n       });\n \n       it('should provide documentation', () => {\n-        const {cursor} = env.overrideTemplateWithCursor(\n-            absoluteFrom('/app.ts'), 'AppCmp', `<div>{{¦title}}</div>`);\n+        const {cursor} =\n+            env.updateFileWithCursor(absoluteFrom('/app.html'), `<div>{{¦title}}</div>`);\n         const quickInfo = env.ngLS.getQuickInfoAtPosition(absoluteFrom('/app.html'), cursor);\n         const documentation = toText(quickInfo!.documentation);\n         expect(documentation).toBe('This is the title of the `AppCmp` Component.');\n@@ -522,8 +522,7 @@ describe('quick info', () => {\n       {templateOverride, expectedSpanText, expectedDisplayString}:\n           {templateOverride: string, expectedSpanText: string, expectedDisplayString: string}):\n       ts.QuickInfo {\n-    const {cursor, text} =\n-        env.overrideTemplateWithCursor(absoluteFrom('/app.ts'), 'AppCmp', templateOverride);\n+    const {cursor, text} = env.updateFileWithCursor(absoluteFrom('/app.html'), templateOverride);\n     env.expectNoSourceDiagnostics();\n     env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n     const quickInfo = env.ngLS.getQuickInfoAtPosition(absoluteFrom('/app.html'), cursor);"
        },
        {
            "sha": "01ec679cade678675d872bd815e037d2e741e9a2",
            "filename": "packages/language-service/ivy/test/type_definitions_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e3bd23c915dce93af6897bd9975cdc2b052e5007/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Ftype_definitions_spec.ts?ref=e3bd23c915dce93af6897bd9975cdc2b052e5007",
            "patch": "@@ -49,8 +49,7 @@ describe('type definitions', () => {\n   });\n \n   function getTypeDefinitionsAndAssertBoundSpan({templateOverride}: {templateOverride: string}) {\n-    const {cursor, text} =\n-        env.overrideTemplateWithCursor(absoluteFrom('/app.ts'), 'AppCmp', templateOverride);\n+    const {cursor, text} = env.updateFileWithCursor(absoluteFrom('/app.html'), templateOverride);\n     env.expectNoSourceDiagnostics();\n     env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n     const defs = env.ngLS.getTypeDefinitionAtPosition(absoluteFrom('/app.html'), cursor);"
        }
    ],
    "stats": {
        "total": 235,
        "additions": 96,
        "deletions": 139
    }
}