{
    "author": "gkalpak",
    "message": "test(docs-infra): print the browser version in `audit-web-app.js` to help debugging (#41103)\n\nThis commit updates the `audit-web-app.js` script (used to run PWA and\na11y tests on angular.io) to also print the version of the browser used\nto run the tests. This can help when debugging a CI failure.\n\nPR Close #41103",
    "sha": "e59246cf5ce37cfa34f4c67bc22c986dda9f150a",
    "files": [
        {
            "sha": "a265194813446929ed30b0ce06106913318014dd",
            "filename": "aio/scripts/audit-web-app.js",
            "status": "modified",
            "additions": 22,
            "deletions": 19,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/e59246cf5ce37cfa34f4c67bc22c986dda9f150a/aio%2Fscripts%2Faudit-web-app.js",
            "raw_url": "https://github.com/angular/angular/raw/e59246cf5ce37cfa34f4c67bc22c986dda9f150a/aio%2Fscripts%2Faudit-web-app.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Faudit-web-app.js?ref=e59246cf5ce37cfa34f4c67bc22c986dda9f150a",
            "patch": "@@ -60,9 +60,16 @@ async function _main(args) {\n   try {\n     console.log('');\n     const startTime = Date.now();\n-    const results = await launchChromeAndRunLighthouse(url, lhFlags, lhConfig);\n+    const browser = await puppeteer.launch();\n+    const browserVersion = await browser.version();\n+    const results = await runLighthouse(browser, url, lhFlags, lhConfig);\n+\n+    console.log(\n+        `\\n  Browser version:    ${browserVersion}` +\n+        `\\n  Lighthouse version: ${results.lhr.lighthouseVersion}`);\n+\n     const success = await processResults(results, minScores, logFile);\n-    console.log(`\\n(Completed in ${((Date.now() - startTime) / 1000).toFixed(1)}s.)\\n`);\n+    console.log(`\\n  (Completed in ${((Date.now() - startTime) / 1000).toFixed(1)}s.)\\n`);\n \n     if (!success) {\n       throw new Error('One or more scores are too low.');\n@@ -76,17 +83,6 @@ function formatScore(score) {\n   return `${(score * 100).toFixed(0).padStart(3)}`;\n }\n \n-async function launchChromeAndRunLighthouse(url, flags, config) {\n-  const browser = await puppeteer.launch();\n-  flags.port = (new URL(browser.wsEndpoint())).port;\n-\n-  try {\n-    return await lighthouse(url, flags, config);\n-  } finally {\n-    await browser.close();\n-  }\n-}\n-\n function onError(err) {\n   console.error(err);\n   console.error('');\n@@ -136,19 +132,17 @@ function parseMinScores(raw) {\n }\n \n async function processResults(results, minScores, logFile) {\n-  const lhVersion = results.lhr.lighthouseVersion;\n   const categories = results.lhr.categories;\n   const report = results.report;\n \n   if (logFile) {\n-    console.log(`\\nSaving results in '${logFile}'...`);\n-    console.log(`  LightHouse viewer: ${VIEWER_URL}`);\n+    console.log(`\\n  Saving results in '${logFile}'...`);\n+    console.log(`    LightHouse viewer: ${VIEWER_URL}`);\n \n     await printer.write(report, printer.OutputMode.json, logFile);\n   }\n \n-  console.log(`\\nLighthouse version: ${lhVersion}`);\n-  console.log('\\nAudit results:');\n+  console.log('\\n  Audit results:');\n \n   const maxTitleLen = Math.max(...Object.values(categories).map(({title}) => title.length));\n   const success = Object.keys(categories).sort().reduce((aggr, cat) => {\n@@ -158,10 +152,19 @@ async function processResults(results, minScores, logFile) {\n     const passed = !isNaN(score) && (score >= minScore);\n \n     console.log(\n-      `  - ${paddedTitle}  ${formatScore(score)}  (Required: ${formatScore(minScore)})  ${passed ? 'OK' : 'FAILED'}`);\n+      `    - ${paddedTitle}  ${formatScore(score)}  (Required: ${formatScore(minScore)})  ${passed ? 'OK' : 'FAILED'}`);\n \n     return aggr && passed;\n   }, true);\n \n   return success;\n }\n+\n+async function runLighthouse(browser, url, flags, config) {\n+  try {\n+    flags.port = (new URL(browser.wsEndpoint())).port;\n+    return await lighthouse(url, flags, config);\n+  } finally {\n+    await browser.close();\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 22,
        "deletions": 19
    }
}