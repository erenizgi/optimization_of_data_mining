{
    "author": "alxhub",
    "message": "refactor(compiler-cli): support xi18n in ngtsc (#42485)\n\nxi18n is the operation of extracting i18n messages from templates in the\ncompilation. Previously, only View Engine was able to perform xi18n. This\ncommit implements xi18n in the Ivy compiler, and a copy of the View Engine\ntest for Ivy verifies that the results are identical.\n\nPR Close #42485",
    "sha": "e83d7cb2d309625e5f3de545df9cf1a0343d238c",
    "files": [
        {
            "sha": "2c3fb6bda2d0fc5c418dff174162d2c6780ed75d",
            "filename": "goldens/public-api/compiler-cli/compiler_options.d.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/goldens%2Fpublic-api%2Fcompiler-cli%2Fcompiler_options.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/goldens%2Fpublic-api%2Fcompiler-cli%2Fcompiler_options.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Fcompiler_options.d.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -7,6 +7,9 @@ export interface I18nOptions {\n     enableI18nLegacyMessageIdFormat?: boolean;\n     i18nInLocale?: string;\n     i18nNormalizeLineEndingsInICUs?: boolean;\n+    i18nOutFile?: string;\n+    i18nOutFormat?: string;\n+    i18nOutLocale?: string;\n     i18nUseExternalIds?: boolean;\n }\n "
        },
        {
            "sha": "fed954406423907ae496014129ded6fa9088212a",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -27,6 +27,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n+        \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "3ec40f3265973d70dc748cac9458dcf5a46c4ef2",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -25,6 +25,7 @@ import {ComponentScopeReader, LocalModuleScopeRegistry, TypeCheckScopeRegistry}\n import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFlags, HandlerPrecedence, ResolveResult} from '../../transform';\n import {TemplateSourceMapping, TypeCheckContext} from '../../typecheck/api';\n import {SubsetOfKeys} from '../../util/src/typescript';\n+import {Xi18nContext} from '../../xi18n';\n \n import {ResourceLoader} from './api';\n import {createValueHasWrongTypeError, getDirectiveDiagnostics, getProviderDiagnostics} from './diagnostics';\n@@ -837,6 +838,13 @@ export class ComponentDecoratorHandler implements\n     return {data};\n   }\n \n+  xi18n(ctx: Xi18nContext, node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>):\n+      void {\n+    ctx.updateFromTemplate(\n+        analysis.template.content, analysis.template.declaration.resolvedTemplateUrl,\n+        analysis.template.interpolationConfig ?? DEFAULT_INTERPOLATION_CONFIG);\n+  }\n+\n   updateResources(node: ClassDeclaration, analysis: ComponentAnalysisData): void {\n     const containingFile = node.getSourceFile().fileName;\n "
        },
        {
            "sha": "04122d3613997627042938e387eed51c82f41da5",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -38,6 +38,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n+        \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "9a3d1cb2bdcc16ea2072ba8b46da97f93e34efc5",
            "filename": "packages/compiler-cli/src/ngtsc/core/api/src/public_options.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Fpublic_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Fpublic_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Fpublic_options.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -309,6 +309,22 @@ export interface I18nOptions {\n    */\n   i18nInLocale?: string;\n \n+  /**\n+   * Export format (xlf, xlf2 or xmb) when the xi18n operation is requested.\n+   */\n+  i18nOutFormat?: string;\n+\n+  /**\n+   * Path to the extracted message file to emit when the xi18n operation is requested.\n+   */\n+  i18nOutFile?: string;\n+\n+\n+  /**\n+   * Locale of the application (used when xi18n is requested).\n+   */\n+  i18nOutLocale?: string;\n+\n   /**\n    * Render `$localize` messages with legacy format ids.\n    *"
        },
        {
            "sha": "fa95ac48e99ea4ac9a76e5f93d2bbb2d2372a48b",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -31,6 +31,7 @@ import {aliasTransformFactory, CompilationMode, declarationTransformFactory, Dec\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig} from '../../typecheck/api';\n import {getSourceFileOrNull, isDtsPath, resolveModuleName, toUnredirectedSourceFile} from '../../util/src/typescript';\n+import {Xi18nContext} from '../../xi18n';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n \n import {compileUndecoratedClassesWithAngularFeatures} from './config';\n@@ -674,6 +675,16 @@ export class NgCompiler {\n     return generateAnalysis(context);\n   }\n \n+  /**\n+   * Collect i18n messages into the `Xi18nContext`.\n+   */\n+  xi18n(ctx: Xi18nContext): void {\n+    // Note that the 'resolve' phase is not strictly necessary for xi18n, but this is not currently\n+    // optimized.\n+    const compilation = this.ensureAnalyzed();\n+    compilation.traitCompiler.xi18n(ctx);\n+  }\n+\n   private ensureAnalyzed(this: NgCompiler): LazyCompilationState {\n     if (this.compilation === null) {\n       this.analyzeSync();"
        },
        {
            "sha": "2f967a3f9cde10529d6587337e463c9ebe0ed716",
            "filename": "packages/compiler-cli/src/ngtsc/program.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 4,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -6,15 +6,16 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {GeneratedFile} from '@angular/compiler';\n+import {GeneratedFile, HtmlParser, MessageBundle} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import * as api from '../transformers/api';\n+import {i18nExtract} from '../transformers/i18n';\n import {verifySupportedTypeScriptVersion} from '../typescript_support';\n \n import {CompilationTicket, freshCompilationTicket, incrementalFromCompilerTicket, NgCompiler, NgCompilerHost} from './core';\n import {NgCompilerOptions} from './core/api';\n-import {absoluteFrom, AbsoluteFsPath, getFileSystem} from './file_system';\n+import {absoluteFrom, AbsoluteFsPath, getFileSystem, resolve} from './file_system';\n import {TrackedIncrementalBuildStrategy} from './incremental';\n import {IndexedComponent} from './indexer';\n import {ActivePerfRecorder, PerfCheckpoint as PerfCheckpoint, PerfEvent, PerfPhase} from './perf';\n@@ -23,8 +24,6 @@ import {DeclarationNode} from './reflection';\n import {retagAllTsFiles, untagAllTsFiles} from './shims';\n import {OptimizeFor} from './typecheck/api';\n \n-\n-\n /**\n  * Entrypoint to the Angular Compiler (Ivy+) which sits behind the `api.Program` interface, allowing\n  * it to be a drop-in replacement for the legacy View Engine compiler to tooling such as the\n@@ -227,13 +226,38 @@ export class NgtscProgram implements api.Program {\n     return this.compiler.listLazyRoutes(entryRoute);\n   }\n \n+  private emitXi18n(): void {\n+    const ctx = new MessageBundle(new HtmlParser(), [], {}, this.options.i18nOutLocale ?? null);\n+    this.compiler.xi18n(ctx);\n+    i18nExtract(\n+        this.options.i18nOutFormat ?? null, this.options.i18nOutFile ?? null, this.host,\n+        this.options, ctx, resolve);\n+  }\n+\n   emit(opts?: {\n     emitFlags?: api.EmitFlags|undefined;\n     cancellationToken?: ts.CancellationToken | undefined;\n     customTransformers?: api.CustomTransformers | undefined;\n     emitCallback?: api.TsEmitCallback | undefined;\n     mergeEmitResultsCallback?: api.TsMergeEmitResultsCallback | undefined;\n   }|undefined): ts.EmitResult {\n+    // Check if emission of the i18n messages bundle was requested.\n+    if (opts !== undefined && opts.emitFlags !== undefined &&\n+        opts.emitFlags & api.EmitFlags.I18nBundle) {\n+      this.emitXi18n();\n+\n+      // `api.EmitFlags` is a View Engine compiler concept. We only pay attention to the absence of\n+      // the other flags here if i18n emit was requested (since this is usually done in the xi18n\n+      // flow, where we don't want to emit JS at all).\n+      if (!(opts.emitFlags & api.EmitFlags.JS)) {\n+        return {\n+          diagnostics: [],\n+          emitSkipped: true,\n+          emittedFiles: [],\n+        };\n+      }\n+    }\n+\n     this.compiler.perfRecorder.memory(PerfCheckpoint.PreEmit);\n \n     const res = this.compiler.perfRecorder.inPhase(PerfPhase.TypeScriptEmit, () => {"
        },
        {
            "sha": "86d831269dc31f04d14cc943f8b30e840cd1e229",
            "filename": "packages/compiler-cli/src/ngtsc/transform/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -20,6 +20,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n+        \"//packages/compiler-cli/src/ngtsc/xi18n\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "4387a651c54d180980c998609e398a5a6120729d",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/api.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -15,6 +15,7 @@ import {IndexingContext} from '../../indexer';\n import {ClassDeclaration, Decorator} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {TypeCheckContext} from '../../typecheck/api';\n+import {Xi18nContext} from '../../xi18n';\n \n /**\n  * Specifies the compilation mode that is used for the compilation.\n@@ -176,6 +177,12 @@ export interface DecoratorHandler<D, A, S extends SemanticSymbol|null, R> {\n    */\n   resolve?(node: ClassDeclaration, analysis: Readonly<A>, symbol: S): ResolveResult<R>;\n \n+  /**\n+   * Extract i18n messages into the `Xi18nContext`, which is useful for generating various formats\n+   * of message file outputs.\n+   */\n+  xi18n?(bundle: Xi18nContext, node: ClassDeclaration, analysis: Readonly<A>): void;\n+\n   typeCheck?\n       (ctx: TypeCheckContext, node: ClassDeclaration, analysis: Readonly<A>,\n        resolution: Readonly<R>): void;"
        },
        {
            "sha": "a5bf2798ae753a816d7a3c2a106d7bda70d5c9f5",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/compilation.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -17,6 +17,7 @@ import {PerfEvent, PerfRecorder} from '../../perf';\n import {ClassDeclaration, DeclarationNode, Decorator, ReflectionHost} from '../../reflection';\n import {ProgramTypeCheckAdapter, TypeCheckContext} from '../../typecheck/api';\n import {getSourceFile, isExported} from '../../util/src/typescript';\n+import {Xi18nContext} from '../../xi18n';\n \n import {AnalysisOutput, CompilationMode, CompileResult, DecoratorHandler, HandlerFlags, HandlerPrecedence, ResolveResult} from './api';\n import {DtsTransformRegistry} from './declaration';\n@@ -494,6 +495,25 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n     }\n   }\n \n+  xi18n(bundle: Xi18nContext): void {\n+    for (const clazz of this.classes.keys()) {\n+      const record = this.classes.get(clazz)!;\n+      for (const trait of record.traits) {\n+        if (trait.state !== TraitState.Analyzed && trait.state !== TraitState.Resolved) {\n+          // Skip traits that haven't been analyzed successfully.\n+          continue;\n+        } else if (trait.handler.xi18n === undefined) {\n+          // Skip traits that don't support xi18n.\n+          continue;\n+        }\n+\n+        if (trait.analysis !== null) {\n+          trait.handler.xi18n(bundle, clazz, trait.analysis);\n+        }\n+      }\n+    }\n+  }\n+\n   updateResources(clazz: DeclarationNode): void {\n     if (!this.reflector.isClass(clazz) || !this.classes.has(clazz)) {\n       return;"
        },
        {
            "sha": "4097839c151503993213c45bb047efafcd2d0a4d",
            "filename": "packages/compiler-cli/src/ngtsc/xi18n/BUILD.bazel",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2FBUILD.bazel?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -0,0 +1,15 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"xi18n\",\n+    srcs = glob([\n+        \"*.ts\",\n+        \"src/**/*.ts\",\n+    ]),\n+    deps = [\n+        \"//packages/compiler\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "aebb55aca939d5e81e16c87206e905a68128a8a2",
            "filename": "packages/compiler-cli/src/ngtsc/xi18n/index.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2Findex.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -0,0 +1,9 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './src/context';"
        },
        {
            "sha": "7a3f0a90af2de8fa5a2b7e3c952aaf476a2a5ebe",
            "filename": "packages/compiler-cli/src/ngtsc/xi18n/src/context.ts",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fxi18n%2Fsrc%2Fcontext.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -0,0 +1,27 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {InterpolationConfig} from '@angular/compiler';\n+\n+/**\n+ * Captures template information intended for extraction of i18n messages from a template.\n+ *\n+ * This interface is compatible with the View Engine compiler's `MessageBundle` class, which is used\n+ * to implement xi18n for VE. Due to the dependency graph of ngtsc, an interface is needed as it\n+ * can't depend directly on `MessageBundle`.\n+ */\n+export interface Xi18nContext {\n+  /**\n+   * Capture i18n messages from the template.\n+   *\n+   * In `MessageBundle` itself, this returns any `ParseError`s from the template. In this interface,\n+   * the return type is declared as `void` for simplicity, since any parse errors would be reported\n+   * as diagnostics anyway.\n+   */\n+  updateFromTemplate(html: string, url: string, interpolationConfig: InterpolationConfig): void;\n+}"
        },
        {
            "sha": "e9d39f481036fa4e9eab85d7377e8ec807a8bb71",
            "filename": "packages/compiler-cli/src/transformers/api.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fapi.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -91,13 +91,6 @@ export interface CompilerOptions extends NgCompilerOptions, ts.CompilerOptions {\n   // position.\n   disableExpressionLowering?: boolean;\n \n-  // Locale of the application\n-  i18nOutLocale?: string;\n-  // Export format (xlf, xlf2 or xmb)\n-  i18nOutFormat?: string;\n-  // Path to the extracted message file\n-  i18nOutFile?: string;\n-\n   // Import format if different from `i18nFormat`\n   i18nInFormat?: string;\n   // Path to the translation file"
        },
        {
            "sha": "27db4c96a82354f29f937434099663f31c97fb11",
            "filename": "packages/compiler-cli/test/ngtsc/env.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fenv.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -11,6 +11,7 @@ import * as api from '@angular/compiler-cli/src/transformers/api';\n import * as ts from 'typescript';\n \n import {createCompilerHost, createProgram} from '../../index';\n+import {mainXi18n} from '../../src/extract_i18n';\n import {main, mainDiagnosticsForTest, readNgcCommandLineAndConfiguration} from '../../src/main';\n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, relativeFrom} from '../../src/ngtsc/file_system';\n import {Folder, MockFileSystem} from '../../src/ngtsc/file_system/testing';\n@@ -275,6 +276,21 @@ export class NgtscTestEnvironment {\n     const program = createProgram({rootNames, host, options});\n     return (program as NgtscProgram).getIndexedComponents();\n   }\n+\n+  driveXi18n(format: string, outputFileName: string, locale: string|null = null): void {\n+    const errorSpy = jasmine.createSpy('consoleError').and.callFake(console.error);\n+    const args = [\n+      ...this.commandLineArgs,\n+      `--i18nFormat=${format}`,\n+      `--outFile=${outputFileName}`,\n+    ];\n+    if (locale !== null) {\n+      args.push(`--locale=${locale}`);\n+    }\n+    const exitCode = mainXi18n(args, errorSpy);\n+    expect(errorSpy).not.toHaveBeenCalled();\n+    expect(exitCode).toEqual(0);\n+  }\n }\n \n class AugmentedCompilerHost extends NgtscTestCompilerHost {"
        },
        {
            "sha": "2fa94355bfa8bcd2ff3c7fb8bcfc606be3b2ff11",
            "filename": "packages/compiler-cli/test/ngtsc/xi18n_spec.ts",
            "status": "added",
            "additions": 334,
            "deletions": 0,
            "changes": 334,
            "blob_url": "https://github.com/angular/angular/blob/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fxi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e83d7cb2d309625e5f3de545df9cf1a0343d238c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fxi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fxi18n_spec.ts?ref=e83d7cb2d309625e5f3de545df9cf1a0343d238c",
            "patch": "@@ -0,0 +1,334 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {loadStandardTestFiles} from '@angular/compiler-cli/src/ngtsc/testing';\n+import {platform} from 'os';\n+\n+import {NgtscTestEnvironment} from './env';\n+\n+const testFiles = loadStandardTestFiles({fakeCore: true, fakeCommon: true});\n+\n+runInEachFileSystem(os => {\n+  let env!: NgtscTestEnvironment;\n+\n+  if (os === 'Windows' || platform() === 'win32') {\n+    // xi18n tests are skipped on Windows as the paths in the expected message files are platform-\n+    // sensitive. These tests will be deleted when xi18n is removed, so it's not a major priority\n+    // to make them work with Windows.\n+    return;\n+  }\n+\n+  describe('ngtsc xi18n', () => {\n+    beforeEach(() => {\n+      env = NgtscTestEnvironment.setup(testFiles);\n+      env.tsconfig();\n+      writeTestCode(env);\n+    });\n+\n+    it('should extract xmb', () => {\n+      env.driveXi18n('xmb', 'messages.xmb');\n+      expect(env.getContents('messages.xmb')).toEqual(EXPECTED_XMB);\n+    });\n+\n+    it('should extract xlf', () => {\n+      // Note that only in XLF mode do we pass a locale into the extraction.\n+      env.driveXi18n('xlf', 'messages.xlf', 'fr');\n+      expect(env.getContents('messages.xlf')).toEqual(EXPECTED_XLIFF);\n+    });\n+\n+    it('should extract xlf', () => {\n+      env.driveXi18n('xlf2', 'messages.xliff2.xlf');\n+      expect(env.getContents('messages.xliff2.xlf')).toEqual(EXPECTED_XLIFF2);\n+    });\n+\n+    it('should not emit js', () => {\n+      env.driveXi18n('xlf2', 'messages.xliff2.xlf');\n+      env.assertDoesNotExist('src/module.js');\n+    });\n+  });\n+});\n+\n+const EXPECTED_XMB = `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<!DOCTYPE messagebundle [\n+<!ELEMENT messagebundle (msg)*>\n+<!ATTLIST messagebundle class CDATA #IMPLIED>\n+\n+<!ELEMENT msg (#PCDATA|ph|source)*>\n+<!ATTLIST msg id CDATA #IMPLIED>\n+<!ATTLIST msg seq CDATA #IMPLIED>\n+<!ATTLIST msg name CDATA #IMPLIED>\n+<!ATTLIST msg desc CDATA #IMPLIED>\n+<!ATTLIST msg meaning CDATA #IMPLIED>\n+<!ATTLIST msg obsolete (obsolete) #IMPLIED>\n+<!ATTLIST msg xml:space (default|preserve) \"default\">\n+<!ATTLIST msg is_hidden CDATA #IMPLIED>\n+\n+<!ELEMENT source (#PCDATA)>\n+\n+<!ELEMENT ph (#PCDATA|ex)*>\n+<!ATTLIST ph name CDATA #REQUIRED>\n+\n+<!ELEMENT ex (#PCDATA)>\n+]>\n+<messagebundle>\n+  <msg id=\"8136548302122759730\" desc=\"desc\" meaning=\"meaning\"><source>src/basic.html:1</source><source>src/comp2.ts:1</source><source>src/basic.html:1</source>translate me</msg>\n+  <msg id=\"9038505069473852515\"><source>src/basic.html:3,4</source><source>src/comp2.ts:3,4</source><source>src/comp2.ts:2,3</source><source>src/basic.html:3,4</source>\n+    Welcome</msg>\n+  <msg id=\"5611534349548281834\" desc=\"with ICU\"><source>src/icu.html:1,3</source><source>src/icu.html:5</source>{VAR_PLURAL, plural, =1 {book} other {books} }</msg>\n+  <msg id=\"5811701742971715242\" desc=\"with ICU and other things\"><source>src/icu.html:4,6</source>\n+     foo <ph name=\"ICU\"><ex>{ count, plural, =1 {...} other {...}}</ex>{ count, plural, =1 {...} other {...}}</ph>\n+    </msg>\n+  <msg id=\"7254052530614200029\" desc=\"with placeholders\"><source>src/placeholders.html:1,3</source>Name: <ph name=\"START_BOLD_TEXT\"><ex>&lt;b&gt;</ex>&lt;b&gt;</ph><ph name=\"NAME\"><ex>{{\n+      name // i18n(ph=&quot;name&quot;)\n+    }}</ex>{{\n+      name // i18n(ph=&quot;name&quot;)\n+    }}</ph><ph name=\"CLOSE_BOLD_TEXT\"><ex>&lt;/b&gt;</ex>&lt;/b&gt;</ph></msg>\n+</messagebundle>\n+`;\n+\n+const EXPECTED_XLIFF = `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">\n+  <file source-language=\"fr\" datatype=\"plaintext\" original=\"ng2.template\">\n+    <body>\n+      <trans-unit id=\"76e1eccb1b772fa9f294ef9c146ea6d0efa8a2d4\" datatype=\"html\">\n+        <source>translate me</source>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/basic.html</context>\n+          <context context-type=\"linenumber\">1</context>\n+        </context-group>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/comp2.ts</context>\n+          <context context-type=\"linenumber\">1</context>\n+        </context-group>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/basic.html</context>\n+          <context context-type=\"linenumber\">1</context>\n+        </context-group>\n+        <note priority=\"1\" from=\"description\">desc</note>\n+        <note priority=\"1\" from=\"meaning\">meaning</note>\n+      </trans-unit>\n+      <trans-unit id=\"085a5ecc40cc87451d216725b2befd50866de18a\" datatype=\"html\">\n+        <source>\n+    Welcome</source>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/basic.html</context>\n+          <context context-type=\"linenumber\">3</context>\n+        </context-group>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/comp2.ts</context>\n+          <context context-type=\"linenumber\">3</context>\n+        </context-group>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/comp2.ts</context>\n+          <context context-type=\"linenumber\">2</context>\n+        </context-group>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/basic.html</context>\n+          <context context-type=\"linenumber\">3</context>\n+        </context-group>\n+      </trans-unit>\n+      <trans-unit id=\"83937c05b1216e7f4c02a85454260e28fd72d1e3\" datatype=\"html\">\n+        <source>{VAR_PLURAL, plural, =1 {book} other {books} }</source>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/icu.html</context>\n+          <context context-type=\"linenumber\">1</context>\n+        </context-group>\n+        <note priority=\"1\" from=\"description\">with ICU</note>\n+      </trans-unit>\n+      <trans-unit id=\"540c5f481129419ef21017f396b6c2d0869ca4d2\" datatype=\"html\">\n+        <source>\n+     foo <x id=\"ICU\" equiv-text=\"{ count, plural, =1 {...} other {...}}\"/>\n+    </source>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/icu.html</context>\n+          <context context-type=\"linenumber\">4</context>\n+        </context-group>\n+        <note priority=\"1\" from=\"description\">with ICU and other things</note>\n+      </trans-unit>\n+      <trans-unit id=\"ca7678090fddd04441d63b1218177af65f23342d\" datatype=\"html\">\n+        <source>{VAR_PLURAL, plural, =1 {book} other {books} }</source>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/icu.html</context>\n+          <context context-type=\"linenumber\">5</context>\n+        </context-group>\n+      </trans-unit>\n+      <trans-unit id=\"9311399c1ca7c75f771d77acb129e50581c6ec1f\" datatype=\"html\">\n+        <source>Name: <x id=\"START_BOLD_TEXT\" ctype=\"x-b\" equiv-text=\"&lt;b&gt;\"/><x id=\"NAME\" equiv-text=\"{{\n+      name // i18n(ph=&quot;name&quot;)\n+    }}\"/><x id=\"CLOSE_BOLD_TEXT\" ctype=\"x-b\" equiv-text=\"&lt;/b&gt;\"/></source>\n+        <context-group purpose=\"location\">\n+          <context context-type=\"sourcefile\">src/placeholders.html</context>\n+          <context context-type=\"linenumber\">1</context>\n+        </context-group>\n+        <note priority=\"1\" from=\"description\">with placeholders</note>\n+      </trans-unit>\n+    </body>\n+  </file>\n+</xliff>\n+`;\n+\n+const EXPECTED_XLIFF2 = `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en\">\n+  <file original=\"ng.template\" id=\"ngi18n\">\n+    <unit id=\"8136548302122759730\">\n+      <notes>\n+        <note category=\"description\">desc</note>\n+        <note category=\"meaning\">meaning</note>\n+        <note category=\"location\">src/basic.html:1</note>\n+        <note category=\"location\">src/comp2.ts:1</note>\n+        <note category=\"location\">src/basic.html:1</note>\n+      </notes>\n+      <segment>\n+        <source>translate me</source>\n+      </segment>\n+    </unit>\n+    <unit id=\"9038505069473852515\">\n+      <notes>\n+        <note category=\"location\">src/basic.html:3,4</note>\n+        <note category=\"location\">src/comp2.ts:3,4</note>\n+        <note category=\"location\">src/comp2.ts:2,3</note>\n+        <note category=\"location\">src/basic.html:3,4</note>\n+      </notes>\n+      <segment>\n+        <source>\n+    Welcome</source>\n+      </segment>\n+    </unit>\n+    <unit id=\"5611534349548281834\">\n+      <notes>\n+        <note category=\"description\">with ICU</note>\n+        <note category=\"location\">src/icu.html:1,3</note>\n+        <note category=\"location\">src/icu.html:5</note>\n+      </notes>\n+      <segment>\n+        <source>{VAR_PLURAL, plural, =1 {book} other {books} }</source>\n+      </segment>\n+    </unit>\n+    <unit id=\"5811701742971715242\">\n+      <notes>\n+        <note category=\"description\">with ICU and other things</note>\n+        <note category=\"location\">src/icu.html:4,6</note>\n+      </notes>\n+      <segment>\n+        <source>\n+     foo <ph id=\"0\" equiv=\"ICU\" disp=\"{ count, plural, =1 {...} other {...}}\"/>\n+    </source>\n+      </segment>\n+    </unit>\n+    <unit id=\"7254052530614200029\">\n+      <notes>\n+        <note category=\"description\">with placeholders</note>\n+        <note category=\"location\">src/placeholders.html:1,3</note>\n+      </notes>\n+      <segment>\n+        <source>Name: <pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\" type=\"fmt\" dispStart=\"&lt;b&gt;\" dispEnd=\"&lt;/b&gt;\"><ph id=\"1\" equiv=\"NAME\" disp=\"{{\n+      name // i18n(ph=&quot;name&quot;)\n+    }}\"/></pc></source>\n+      </segment>\n+    </unit>\n+  </file>\n+</xliff>\n+`;\n+\n+/**\n+ * Note: the indentation here is load-bearing.\n+ */\n+function writeTestCode(env: NgtscTestEnvironment): void {\n+  const welcomeMessage = `\n+    <!--i18n-->\n+    Welcome<!--/i18n-->\n+    `;\n+  env.write('src/basic.html', `<div title=\"translate me\" i18n-title=\"meaning|desc\"></div>\n+         <p id=\"welcomeMessage\">${welcomeMessage}</p>`);\n+\n+  env.write('src/comp1.ts', `\n+    import {Component} from '@angular/core';\n+\n+    @Component({\n+      selector: 'basic',\n+      templateUrl: './basic.html',\n+    })\n+    export class BasicCmp1 {}`);\n+\n+  env.write('src/comp2.ts', `\n+    import {Component} from '@angular/core';\n+\n+    @Component({\n+      selector: 'basic2',\n+      template: \\`<div title=\"translate me\" i18n-title=\"meaning|desc\"></div>\n+      <p id=\"welcomeMessage\">${welcomeMessage}</p>\\`,\n+    })\n+    export class BasicCmp2 {}\n+    @Component({\n+      selector: 'basic4',\n+      template: \\`<p id=\"welcomeMessage\">${welcomeMessage}</p>\\`,\n+    })\n+    export class BasicCmp4 {}`);\n+\n+  env.write('src/comp3.ts', `\n+    import {Component} from '@angular/core';\n+\n+    @Component({\n+      selector: 'basic3',\n+      templateUrl: './basic.html',\n+    })\n+    export class BasicCmp3 {}`);\n+\n+  env.write('src/placeholders.html', `<div i18n=\"with placeholders\">Name: <b>{{\n+      name // i18n(ph=\"name\")\n+    }}</b></div>`);\n+\n+  env.write('src/placeholder_cmp.ts', `\n+    import {Component} from '@angular/core';\n+\n+    @Component({\n+      selector: 'placeholders',\n+      templateUrl: './placeholders.html',\n+    })\n+    export class PlaceholderCmp { name = 'whatever'; }`);\n+\n+  env.write('src/icu.html', `<div i18n=\"with ICU\">{\n+      count, plural, =1 {book} other {books}\n+    }</div>\n+    <div i18n=\"with ICU and other things\">\n+     foo { count, plural, =1 {book} other {books} }\n+    </div>`);\n+\n+  env.write('src/icu_cmp.ts', `\n+    import {Component} from '@angular/core';\n+\n+    @Component({\n+      selector: 'icu',\n+      templateUrl: './icu.html',\n+    })\n+    export class IcuCmp { count = 3; }`);\n+\n+  env.write('src/module.ts', `\n+    import {NgModule} from '@angular/core';\n+    import {CommonModule} from '@angular/common';\n+    import {BasicCmp1} from './comp1';\n+    import {BasicCmp2, BasicCmp4} from './comp2';\n+    import {BasicCmp3} from './comp3';\n+    import {PlaceholderCmp} from './placeholder_cmp';\n+    import {IcuCmp} from './icu_cmp';\n+\n+    @NgModule({\n+      declarations: [\n+        BasicCmp1,\n+        BasicCmp2,\n+        BasicCmp3,\n+        BasicCmp4,\n+        PlaceholderCmp,\n+        IcuCmp,\n+      ],\n+      imports: [CommonModule],\n+    })\n+    export class I18nModule {}\n+    `);\n+}"
        }
    ],
    "stats": {
        "total": 508,
        "additions": 497,
        "deletions": 11
    }
}