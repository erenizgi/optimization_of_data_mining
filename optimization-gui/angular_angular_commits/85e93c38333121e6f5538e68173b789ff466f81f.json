{
    "author": "gkalpak",
    "message": "fix(docs-infra): notify `ErrorHandler` of `UnrecoverableState` errors (#42941)\n\nWith this commit, the `ErrorHandler` is notified of ServiceWorker\n`UnrecoverableState` errors. The main purpose of this change is\ngathering info about the occurrence (and frequency) of such errors in\nGoogle analytics.\n\nPR Close #42941",
    "sha": "85e93c38333121e6f5538e68173b789ff466f81f",
    "files": [
        {
            "sha": "c08a03515a1ddab42dfb08a811a2bc12ca81072f",
            "filename": "aio/src/app/sw-updates/sw-updates.service.spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 2,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/85e93c38333121e6f5538e68173b789ff466f81f/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/85e93c38333121e6f5538e68173b789ff466f81f/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.spec.ts?ref=85e93c38333121e6f5538e68173b789ff466f81f",
            "patch": "@@ -1,4 +1,4 @@\n-import { ApplicationRef, Injector } from '@angular/core';\n+import { ApplicationRef, ErrorHandler, Injector } from '@angular/core';\n import { discardPeriodicTasks, fakeAsync, tick } from '@angular/core/testing';\n import { SwUpdate } from '@angular/service-worker';\n import { Subject } from 'rxjs';\n@@ -13,6 +13,7 @@ import { SwUpdatesService } from './sw-updates.service';\n describe('SwUpdatesService', () => {\n   let injector: Injector;\n   let appRef: MockApplicationRef;\n+  let errorHandler: ErrorHandler;\n   let location: MockLocationService;\n   let service: SwUpdatesService;\n   let swu: MockSwUpdate;\n@@ -27,13 +28,15 @@ describe('SwUpdatesService', () => {\n   const setup = (isSwUpdateEnabled: boolean) => {\n     injector = Injector.create({providers: [\n       { provide: ApplicationRef, useClass: MockApplicationRef, deps: [] },\n+      { provide: ErrorHandler, useValue: {handleError: jasmine.createSpy('handlerError')} },\n       { provide: LocationService, useFactory: () => new MockLocationService(''), deps: [] },\n       { provide: Logger, useClass: MockLogger, deps: [] },\n       { provide: SwUpdate, useFactory: () => new MockSwUpdate(isSwUpdateEnabled), deps: [] },\n-      { provide: SwUpdatesService, deps: [ApplicationRef, LocationService, Logger, SwUpdate] }\n+      { provide: SwUpdatesService, deps: [ApplicationRef, ErrorHandler, LocationService, Logger, SwUpdate] }\n     ]});\n \n     appRef = injector.get(ApplicationRef) as unknown as MockApplicationRef;\n+    errorHandler = injector.get(ErrorHandler);\n     location = injector.get(LocationService) as unknown as MockLocationService;\n     service = injector.get(SwUpdatesService);\n     swu = injector.get(SwUpdate) as unknown as MockSwUpdate;\n@@ -129,6 +132,24 @@ describe('SwUpdatesService', () => {\n     expect(location.reloadPage).toHaveBeenCalledTimes(2);\n   }));\n \n+  it('should notify the `ErrorHandler` when an unrecoverable state has been detected', run(() => {\n+    expect(errorHandler.handleError).not.toHaveBeenCalled();\n+\n+    swu.$$unrecoverableSubj.next({reason: 'Something bad happened'});\n+    expect(errorHandler.handleError).toHaveBeenCalledBefore(location.reloadPage);\n+    expect(errorHandler.handleError)\n+        .toHaveBeenCalledWith('Unrecoverable state: Something bad happened');\n+\n+    (errorHandler.handleError as jasmine.Spy).calls.reset();\n+    location.reloadPage.calls.reset();\n+\n+    swu.$$unrecoverableSubj.next({reason: 'Something worse happened'});\n+    expect(errorHandler.handleError).toHaveBeenCalledBefore(location.reloadPage);\n+    expect(errorHandler.handleError)\n+        .toHaveBeenCalledWith('Unrecoverable state: Something worse happened');\n+\n+  }));\n+\n   describe('when `SwUpdate` is not enabled', () => {\n     const runDeactivated = (specFn: VoidFunction) => run(specFn, false);\n \n@@ -165,6 +186,7 @@ describe('SwUpdatesService', () => {\n       swu.$$unrecoverableSubj.next({reason: 'Something bad happened'});\n       swu.$$unrecoverableSubj.next({reason: 'Something worse happened'});\n \n+      expect(errorHandler.handleError).not.toHaveBeenCalled();\n       expect(location.reloadPage).not.toHaveBeenCalled();\n     }));\n   });\n@@ -221,12 +243,15 @@ describe('SwUpdatesService', () => {\n \n     it('should stop requesting page reloads when unrecoverable states are detected', run(() => {\n       swu.$$unrecoverableSubj.next({reason: 'Something bad happened'});\n+      expect(errorHandler.handleError).toHaveBeenCalledTimes(1);\n       expect(location.reloadPage).toHaveBeenCalledTimes(1);\n \n       service.ngOnDestroy();\n+      (errorHandler.handleError as jasmine.Spy).calls.reset();\n       location.reloadPage.calls.reset();\n \n       swu.$$unrecoverableSubj.next({reason: 'Something worse happened'});\n+      expect(errorHandler.handleError).not.toHaveBeenCalled();\n       expect(location.reloadPage).not.toHaveBeenCalled();\n     }));\n   });"
        },
        {
            "sha": "d0568ffc9acda697571a28e81273d403b357530b",
            "filename": "aio/src/app/sw-updates/sw-updates.service.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/85e93c38333121e6f5538e68173b789ff466f81f/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/85e93c38333121e6f5538e68173b789ff466f81f/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsw-updates%2Fsw-updates.service.ts?ref=85e93c38333121e6f5538e68173b789ff466f81f",
            "patch": "@@ -1,4 +1,4 @@\n-import { ApplicationRef, Injectable, OnDestroy } from '@angular/core';\n+import { ApplicationRef, ErrorHandler, Injectable, OnDestroy } from '@angular/core';\n import { SwUpdate } from '@angular/service-worker';\n import { concat, interval, Subject } from 'rxjs';\n import { first, takeUntil, tap } from 'rxjs/operators';\n@@ -21,8 +21,8 @@ export class SwUpdatesService implements OnDestroy {\n   private onDestroy = new Subject<void>();\n \n   constructor(\n-      appRef: ApplicationRef, location: LocationService, private logger: Logger,\n-      private swu: SwUpdate) {\n+      appRef: ApplicationRef, errorHandler: ErrorHandler, location: LocationService,\n+      private logger: Logger, private swu: SwUpdate) {\n     if (!swu.isEnabled) {\n       return;\n     }\n@@ -55,7 +55,11 @@ export class SwUpdatesService implements OnDestroy {\n     // Request an immediate page reload once an unrecoverable state has been detected.\n     this.swu.unrecoverable\n         .pipe(\n-            tap(evt => this.log(`Unrecoverable state: ${evt.reason}\\nReloading...`)),\n+            tap(evt => {\n+              const errorMsg = `Unrecoverable state: ${evt.reason}`;\n+              errorHandler.handleError(errorMsg);\n+              this.log(`${errorMsg}\\nReloading...`);\n+            }),\n             takeUntil(this.onDestroy),\n         )\n         .subscribe(() => location.reloadPage());"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 35,
        "deletions": 6
    }
}