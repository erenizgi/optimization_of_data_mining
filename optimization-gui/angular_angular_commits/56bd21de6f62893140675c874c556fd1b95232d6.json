{
    "author": "devversion",
    "message": "feat(dev-infra): introduce shared tool for validating API signature (#42688)\n\nFor the last years the Angular repositories relied on `ts-api-guardian`\nfor testing the public API signature. This project worked well in\ngeneral but its another inconvenience to maintain if we could rely on\nMicrosoft's `api-extractor` tool.\n\nEspecially since with TypeScript 4.3 issues with export aliases appeared\nthat would require us to extend TS API guardian to support such exports.\nThis is not as straightforward as it sounds, given it requires rewriting\nof declarations to show-case the proper name in the API golden. Microsoft's\nAPI extractor has integrated support for this.\n\nAs of TypeScript 4.3, we want to start using the new `override` keyword.\nWe are not able to use that keyword currently because an old version of\nAPI extractor is used in the `ng_module` rule to flatten the types into\na single file. To fix this, we need to update `api-extractor`, but this\nunveils the issue with TS API guardian because the most recent version\nof api-extractor uses alias exports to avoid potential conflicts\nwith globals available through the TypeScript default libraries (e.g.\n`dom.d.ts`).\n\nPR Close #42688",
    "sha": "56bd21de6f62893140675c874c556fd1b95232d6",
    "files": [
        {
            "sha": "1b8806153cd6180ecc0d887d9c72ff4029afe00f",
            "filename": "dev-infra/bazel/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2FBUILD.bazel?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -5,6 +5,7 @@ filegroup(\n     srcs = [\n         \"BUILD.bazel\",\n         \"expand_template.bzl\",\n+        \"//dev-infra/bazel/api-golden:files\",\n         \"//dev-infra/bazel/browsers:files\",\n         \"//dev-infra/bazel/remote-execution:files\",\n     ],"
        },
        {
            "sha": "0ab29df547b040dce22cbc8ebc8bfab0bb650c0e",
            "filename": "dev-infra/bazel/api-golden/BUILD.bazel",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2FBUILD.bazel?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -0,0 +1,32 @@\n+load(\"@npm//@bazel/typescript:index.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+exports_files([\n+    \"index.ts\",\n+    \"index_npm_packages.ts\",\n+])\n+\n+ts_library(\n+    name = \"api-golden\",\n+    srcs = [\n+        \"find_entry_points.ts\",\n+        \"index.ts\",\n+        \"index_npm_packages.ts\",\n+        \"test_api_report.ts\",\n+    ],\n+    deps = [\n+        \"@npm//@bazel/runfiles\",\n+        \"@npm//@microsoft/api-extractor\",\n+        \"@npm//@types/node\",\n+        \"@npm//chalk\",\n+        \"@npm//tslib\",\n+        \"@npm//typescript\",\n+    ],\n+)\n+\n+# Expose the sources in the dev-infra NPM package.\n+filegroup(\n+    name = \"files\",\n+    srcs = glob([\"*\"]),\n+)"
        },
        {
            "sha": "3343639fecbadb1d450b313c8fda54670fa16384",
            "filename": "dev-infra/bazel/api-golden/find_entry_points.ts",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Ffind_entry_points.ts",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Ffind_entry_points.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Ffind_entry_points.ts?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -0,0 +1,62 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {lstatSync, readdirSync, readFileSync} from 'fs';\n+import {dirname, join} from 'path';\n+\n+/** Interface describing a resolved NPM package entry point. */\n+export interface PackageEntryPoint {\n+  typesEntryPointPath: string;\n+  packageJsonPath: string;\n+}\n+\n+/** Interface describing contents of a `package.json`. */\n+interface PackageJson {\n+  types?: string;\n+  typings?: string;\n+}\n+\n+/** Finds all entry points within a given NPM package directory. */\n+export function findEntryPointsWithinNpmPackage(dirPath: string): PackageEntryPoint[] {\n+  const entryPoints: PackageEntryPoint[] = [];\n+\n+  for (const packageJsonFilePath of findPackageJsonFilesInDirectory(dirPath)) {\n+    const packageJson = JSON.parse(readFileSync(packageJsonFilePath, 'utf8')) as PackageJson;\n+    const typesFile = packageJson.types || packageJson.typings;\n+\n+    if (typesFile) {\n+      entryPoints.push({\n+        packageJsonPath: packageJsonFilePath,\n+        typesEntryPointPath: join(dirname(packageJsonFilePath), typesFile),\n+      });\n+    }\n+  }\n+\n+  return entryPoints;\n+}\n+\n+/** Determine if the provided path is a directory. */\n+function isDirectory(dirPath: string) {\n+  try {\n+    return lstatSync(dirPath).isDirectory();\n+  } catch {\n+    return false;\n+  }\n+}\n+\n+/** Finds all `package.json` files within a directory. */\n+function* findPackageJsonFilesInDirectory(directoryPath: string): IterableIterator<string> {\n+  for (const fileName of readdirSync(directoryPath)) {\n+    const fullPath = join(directoryPath, fileName);\n+    if (isDirectory(fullPath)) {\n+      yield* findPackageJsonFilesInDirectory(fullPath);\n+    } else if (fileName === 'package.json') {\n+      yield fullPath;\n+    }\n+  }\n+}"
        },
        {
            "sha": "fd8548f66e735bb3c63eb88e95b41631eb6907f6",
            "filename": "dev-infra/bazel/api-golden/index.bzl",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex.bzl?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -0,0 +1,83 @@\n+load(\"@build_bazel_rules_nodejs//:index.bzl\", \"nodejs_binary\", \"nodejs_test\")\n+\n+nodejs_test_args = [\n+    # Needed so that node doesn't walk back to the source directory.\n+    # From there, the relative imports would point to .ts files.\n+    \"--node_options=--preserve-symlinks\",\n+    # TODO(josephperrott): update dependency usages to no longer need bazel patch module resolver\n+    # See: https://github.com/bazelbuild/rules_nodejs/wiki#--bazel_patch_module_resolver-now-defaults-to-false-2324\n+    \"--bazel_patch_module_resolver\",\n+]\n+\n+default_strip_export_pattern = \"^ɵ(?!ɵdefineInjectable|ɵinject|ɵInjectableDef)\"\n+\n+\"\"\"Escapes a Regular expression so that it can be passed as process argument.\"\"\"\n+\n+def _escape_regex_for_arg(value):\n+    return \"\\\"%s\\\"\" % value\n+\n+\"\"\"\n+  Builds an API report for the specified entry-point and compares it against the\n+  specified golden\n+\"\"\"\n+\n+def api_golden_test(\n+        name,\n+        golden,\n+        entry_point,\n+        data = [],\n+        strip_export_pattern = default_strip_export_pattern,\n+        **kwargs):\n+    quoted_export_pattern = _escape_regex_for_arg(strip_export_pattern)\n+\n+    kwargs[\"tags\"] = kwargs.get(\"tags\", []) + [\"api_guard\"]\n+\n+    nodejs_test(\n+        name = name,\n+        data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\"] + data,\n+        entry_point = \"//dev-infra/bazel/api-golden:index.ts\",\n+        templated_args = nodejs_test_args + [golden, entry_point, \"false\", quoted_export_pattern],\n+        **kwargs\n+    )\n+\n+    nodejs_binary(\n+        name = name + \".accept\",\n+        testonly = True,\n+        data = [\"//dev-infra/bazel/api-golden\", \"//:package.json\"] + data,\n+        entry_point = \"//dev-infra/bazel/api-golden:index.ts\",\n+        templated_args = nodejs_test_args + [golden, entry_point, \"true\", quoted_export_pattern],\n+        **kwargs\n+    )\n+\n+\"\"\"\n+  Builds an API report for all entrypoints within the given NPM package and compares it\n+  against goldens within the specified directory.\n+\"\"\"\n+\n+def api_golden_test_npm_package(\n+        name,\n+        golden_dir,\n+        npm_package,\n+        data = [],\n+        strip_export_pattern = default_strip_export_pattern,\n+        **kwargs):\n+    quoted_export_pattern = _escape_regex_for_arg(strip_export_pattern)\n+\n+    kwargs[\"tags\"] = kwargs.get(\"tags\", []) + [\"api_guard\"]\n+\n+    nodejs_test(\n+        name = name,\n+        data = [\"//dev-infra/bazel/api-golden\"] + data,\n+        entry_point = \"//dev-infra/bazel/api-golden:index_npm_packages.ts\",\n+        templated_args = nodejs_test_args + [golden_dir, npm_package, \"false\", quoted_export_pattern],\n+        **kwargs\n+    )\n+\n+    nodejs_binary(\n+        name = name + \".accept\",\n+        testonly = True,\n+        data = [\"//dev-infra/bazel/api-golden\"] + data,\n+        entry_point = \"//dev-infra/bazel/api-golden:index_npm_packages.ts\",\n+        templated_args = nodejs_test_args + [golden_dir, npm_package, \"true\", quoted_export_pattern],\n+        **kwargs\n+    )"
        },
        {
            "sha": "59ad79ac02f9bf9c31275e834e60a385996b0804",
            "filename": "dev-infra/bazel/api-golden/index.ts",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex.ts?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -0,0 +1,45 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {runfiles} from '@bazel/runfiles';\n+import * as chalk from 'chalk';\n+\n+import {testApiGolden} from './test_api_report';\n+\n+/**\n+ * Entry point for the `api_golden_test` Bazel rule. This function builds an API report for\n+ * the specified entry point file and compares it against the specified golden file.\n+ */\n+async function main(\n+    goldenFilePath: string, entryPointFilePath: string, approveGolden: boolean,\n+    stripExportPattern: RegExp) {\n+  const {succeeded, apiReportChanged} =\n+      await testApiGolden(goldenFilePath, entryPointFilePath, approveGolden, stripExportPattern);\n+\n+  if (!succeeded && apiReportChanged) {\n+    console.error(chalk.red(`The API signature has changed and the golden file is outdated.`));\n+    console.info(chalk.yellow(\n+        `Golden can be updated by running: yarn bazel run ${process.env.TEST_TARGET}.accept`));\n+  }\n+\n+  // Bazel expects `3` as exit code for failing tests.\n+  process.exitCode = succeeded ? 0 : 3;\n+}\n+\n+if (require.main === module) {\n+  const args = process.argv.slice(2);\n+  const goldenFilePath = runfiles.resolve(args[0]);\n+  const entryPointFilePath = runfiles.resolve(args[1]);\n+  const approveGolden = args[2] === 'true';\n+  const stripExportPattern = new RegExp(args[3]);\n+\n+  main(goldenFilePath, entryPointFilePath, approveGolden, stripExportPattern).catch(e => {\n+    console.error(e);\n+    process.exit(1);\n+  });\n+}"
        },
        {
            "sha": "74f7d9d64a34a42c3f7d0bc8733e2f4c8f73b3b2",
            "filename": "dev-infra/bazel/api-golden/index_npm_packages.ts",
            "status": "added",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Findex_npm_packages.ts",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Findex_npm_packages.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Findex_npm_packages.ts?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -0,0 +1,71 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {runfiles} from '@bazel/runfiles';\n+import * as chalk from 'chalk';\n+import {join, relative} from 'path';\n+\n+import {findEntryPointsWithinNpmPackage} from './find_entry_points';\n+import {testApiGolden} from './test_api_report';\n+\n+/**\n+ * Entry point for the `api_golden_test_npm_package` Bazel rule. This function determines\n+ * all types within the specified NPM package and builds API reports that will be compared\n+ * against golden files within the given golden directory.\n+ */\n+async function main(\n+    goldenDir: string, npmPackageDir: string, approveGolden: boolean, stripExportPattern: RegExp) {\n+  const entryPoints = findEntryPointsWithinNpmPackage(npmPackageDir);\n+  const outdatedGoldens: string[] = [];\n+  let allTestsSucceeding = true;\n+\n+  for (const {packageJsonPath, typesEntryPointPath} of entryPoints) {\n+    const pkgRelativeName = relative(npmPackageDir, typesEntryPointPath);\n+    // API extractor generates API reports as markdown files. For each types\n+    // entry-point we maintain a separate golden file. These golden files are\n+    // based on the name of the entry-point `.d.ts` file in the NPM package,\n+    // but with the proper `.md` file extension.\n+    // See: https://api-extractor.com/pages/overview/demo_api_report/.\n+    const goldenName = pkgRelativeName.replace(/\\.d\\.ts$/, '.md');\n+    const goldenFilePath = join(goldenDir, goldenName);\n+\n+    const {succeeded, apiReportChanged} = await testApiGolden(\n+        goldenFilePath, typesEntryPointPath, approveGolden, stripExportPattern, packageJsonPath);\n+\n+    // Keep track of outdated goldens.\n+    if (!succeeded && apiReportChanged) {\n+      outdatedGoldens.push(goldenName);\n+    }\n+\n+    allTestsSucceeding = allTestsSucceeding && succeeded;\n+  }\n+\n+  if (outdatedGoldens.length) {\n+    console.error(chalk.red(`The following goldens are outdated:`));\n+    outdatedGoldens.forEach(name => console.info(`-  ${name}`));\n+    console.info();\n+    console.info(chalk.yellow(\n+        `The goldens can be updated by running: yarn bazel run ${process.env.TEST_TARGET}.accept`));\n+  }\n+\n+  // Bazel expects `3` as exit code for failing tests.\n+  process.exitCode = allTestsSucceeding ? 0 : 3;\n+}\n+\n+if (require.main === module) {\n+  const args = process.argv.slice(2);\n+  const goldenDir = runfiles.resolve(args[0]);\n+  const npmPackageDir = runfiles.resolve(args[1]);\n+  const approveGolden = args[2] === 'true';\n+  const stripExportPattern = new RegExp(args[3]);\n+\n+  main(goldenDir, npmPackageDir, approveGolden, stripExportPattern).catch(e => {\n+    console.error(e);\n+    process.exit(1);\n+  });\n+}"
        },
        {
            "sha": "6261ce67399ec07ebed60fd161886210027ddb6f",
            "filename": "dev-infra/bazel/api-golden/test_api_report.ts",
            "status": "added",
            "additions": 134,
            "deletions": 0,
            "changes": 134,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Ftest_api_report.ts",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Fbazel%2Fapi-golden%2Ftest_api_report.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fapi-golden%2Ftest_api_report.ts?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -0,0 +1,134 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {runfiles} from '@bazel/runfiles';\n+import {ConsoleMessageId, Extractor, ExtractorConfig, ExtractorLogLevel, ExtractorMessage, ExtractorMessageId, ExtractorResult, IConfigFile} from '@microsoft/api-extractor';\n+import {AstModule} from '@microsoft/api-extractor/lib/analyzer/AstModule';\n+import {ExportAnalyzer} from '@microsoft/api-extractor/lib/analyzer/ExportAnalyzer';\n+import {basename, dirname} from 'path';\n+\n+/**\n+ * Original definition of the `ExportAnalyzer#fetchAstModuleExportInfo` method.\n+ * We store the original function since we monkey-patch it later to account for\n+ * specified strip export patterns.\n+ * */\n+const _origFetchAstModuleExportInfo = ExportAnalyzer.prototype.fetchAstModuleExportInfo;\n+\n+/**\n+ * Builds an API report for the given entry-point file and compares\n+ * it against a golden file.\n+ *\n+ * @param goldenFilePath Path to an API report file that is used as golden\n+ * @param indexFilePath Entry point file that is analyzed to build the API report.\n+ * @param approveGolden Whether the golden file should be updated.\n+ * @param stripExportPattern Regular Expression that can be used to filter out exports\n+ *   from the API report.\n+ * @param packageJsonPath Optional path to a `package.json` file that contains the entry\n+ *   point. Note that the `package.json` is currently only used by `api-extractor` to determine\n+ *   the package name displayed within the API golden.\n+ */\n+export async function testApiGolden(\n+    goldenFilePath: string, indexFilePath: string, approveGolden: boolean,\n+    stripExportPattern: RegExp,\n+    packageJsonPath = resolveWorkspacePackageJsonPath()): Promise<ExtractorResult> {\n+  // If no `TEST_TMPDIR` is defined, then this script runs using `bazel run`. We use\n+  // the runfile directory as temporary directory for API extractor.\n+  const tempDir = process.env.TEST_TMPDIR ?? process.cwd();\n+\n+  const configObject: IConfigFile = {\n+    compiler: {overrideTsconfig: {files: [indexFilePath]}},\n+    projectFolder: dirname(packageJsonPath),\n+    mainEntryPointFilePath: indexFilePath,\n+    dtsRollup: {enabled: false},\n+    docModel: {enabled: false},\n+    apiReport: {\n+      enabled: true,\n+      reportFolder: dirname(goldenFilePath),\n+      reportTempFolder: tempDir,\n+      reportFileName: basename(goldenFilePath),\n+    },\n+    tsdocMetadata: {enabled: false},\n+    newlineKind: 'lf',\n+    messages: {\n+      extractorMessageReporting: {\n+        // If an export does not have a release tag (like `@public`), API extractor maps\n+        // considers it still as `Public`. We hide the message for now given the Angular\n+        // repositories do not follow the TSDoc standard. https://tsdoc.org/.\n+        // TODO: Make this an error once TSDoc standard is followed in all projects.\n+        [ExtractorMessageId.MissingReleaseTag]: {logLevel: ExtractorLogLevel.None},\n+      },\n+    },\n+  };\n+\n+  // We read the specified `package.json` manually and build a package name that is\n+  // compatible with the API extractor. This is a workaround for a bug in api-extractor.\n+  // TODO remove once https://github.com/microsoft/rushstack/issues/2774 is resolved.\n+  const packageJson = require(packageJsonPath);\n+  const packageNameSegments = packageJson.name.split('/');\n+  const packageName = packageNameSegments.length === 1 ?\n+      packageNameSegments[0] :\n+      `${packageNameSegments[0]}/${packageNameSegments.slice(1).join('_')}`;\n+\n+  const extractorConfig = ExtractorConfig.prepare({\n+    configObject,\n+    // TODO: Remove workaround once https://github.com/microsoft/rushstack/issues/2774 is fixed.\n+    packageJson: {name: packageName},\n+    packageJsonFullPath: packageJsonPath,\n+    configObjectFullPath: undefined,\n+  });\n+\n+  // This patches the `ExportAnalyzer` of `api-extractor` so that we can filter out\n+  // exports that match a specified pattern. Ideally this would not be needed as the\n+  // TSDoc JSDoc annotations could be used to filter out exports from the API report,\n+  // but there are cases in Angular where exports cannot be `@internal` but at the same\n+  // time are denoted as unstable. Such exports are allowed to change frequently and should\n+  // not be captured in the API report (as this would be unnecessarily inconvenient).\n+  ExportAnalyzer.prototype.fetchAstModuleExportInfo = function(module: AstModule) {\n+    const info = _origFetchAstModuleExportInfo.apply(this, [module]);\n+\n+    info.exportedLocalEntities.forEach((entity, exportName) => {\n+      if (stripExportPattern.test(exportName)) {\n+        info.exportedLocalEntities.delete(exportName);\n+      }\n+    });\n+\n+    return info;\n+  };\n+\n+  return Extractor.invoke(extractorConfig, {\n+    // If the golden should be approved, then `localBuild: true` instructs\n+    // API extractor to update the file.\n+    localBuild: approveGolden,\n+    // Process messages from the API extractor (and modify log levels if needed).\n+    messageCallback: msg => processExtractorMessage(msg, approveGolden),\n+  });\n+}\n+\n+/**\n+ * Process an API extractor message. Microsoft's API extractor allows developers to\n+ * handle messages before API extractor prints them. This allows us to adjust log level\n+ * for certain messages, or to fully prevent messages from being printed out.\n+ * */\n+async function processExtractorMessage(message: ExtractorMessage, isApprove: boolean) {\n+  // If the golden does not match, we hide the error as API extractor prints\n+  // a warning asking the user to manually copy the new API report. We print\n+  // a custom warning below asking the developer to run the `.accept` Bazel target.\n+  // TODO: Simplify once https://github.com/microsoft/rushstack/issues/2773 is resolved.\n+  if (message.messageId === ConsoleMessageId.ApiReportNotCopied) {\n+    // Mark the message as handled so that API-extractor does not print it. We print\n+    // a message manually after extraction.\n+    message.handled = true;\n+    message.logLevel = isApprove ? ExtractorLogLevel.None : ExtractorLogLevel.Error;\n+  }\n+}\n+\n+/** Resolves the `package.json` of the workspace executing this action. */\n+function resolveWorkspacePackageJsonPath(): string {\n+  const workspaceName = process.env.BAZEL_WORKSPACE!;\n+  return runfiles.resolve(`${workspaceName}/package.json`);\n+}"
        },
        {
            "sha": "3fb79079ff40803e9dc00d54e4f1d6bf97e6791b",
            "filename": "dev-infra/tmpl-package.json",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Ftmpl-package.json",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Ftmpl-package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Ftmpl-package.json?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -10,11 +10,15 @@\n   },\n   \"dependencies\": {\n     \"@angular/benchpress\": \"0.2.1\",\n+    \"@bazel/buildifier\": \"<from-root>\",\n+    \"@bazel/runfiles\": \"<from-root>\",\n+    \"@microsoft/api-extractor\": \"<from-root>\",\n     \"@octokit/graphql\": \"<from-root>\",\n-    \"@octokit/types\": \"<from-root>\",\n     \"@octokit/rest\": \"<from-root>\",\n+    \"@octokit/types\": \"<from-root>\",\n     \"brotli\": \"<from-root>\",\n     \"chalk\": \"<from-root>\",\n+    \"clang-format\": \"<from-root>\",\n     \"cli-progress\": \"<from-root>\",\n     \"conventional-commits-parser\": \"<from-root>\",\n     \"ejs\": \"<from-root>\",\n@@ -26,18 +30,16 @@\n     \"node-fetch\": \"<from-root>\",\n     \"node-uuid\": \"<from-root>\",\n     \"ora\": \"<from-root>\",\n+    \"protractor\": \"<from-root>\",\n+    \"selenium-webdriver\": \"<from-root>\",\n     \"semver\": \"<from-root>\",\n     \"shelljs\": \"<from-root>\",\n+    \"ts-node\": \"<from-root>\",\n     \"tslib\": \"<from-root>\",\n     \"typed-graphqlify\": \"<from-root>\",\n+    \"typescript\": \"<from-root>\",\n     \"yaml\": \"<from-root>\",\n-    \"yargs\": \"<from-root>\",\n-    \"@bazel/buildifier\": \"<from-root>\",\n-    \"clang-format\": \"<from-root>\",\n-    \"protractor\": \"<from-root>\",\n-    \"selenium-webdriver\": \"<from-root>\",\n-    \"ts-node\": \"<from-root>\",\n-    \"typescript\": \"<from-root>\"\n+    \"yargs\": \"<from-root>\"\n   },\n   \"peerDependenciesMeta\": {\n     \"@bazel/buildifier\": {"
        },
        {
            "sha": "a107894e335384a7894493351b37a6fdf8e0a262",
            "filename": "dev-infra/tsconfig.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Ftsconfig.json",
            "raw_url": "https://github.com/angular/angular/raw/56bd21de6f62893140675c874c556fd1b95232d6/dev-infra%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Ftsconfig.json?ref=56bd21de6f62893140675c874c556fd1b95232d6",
            "patch": "@@ -1,5 +1,6 @@\n {\n   \"compilerOptions\": {\n-    \"strict\": true\n+    \"strict\": true,\n+    \"downlevelIteration\": true\n   }\n }"
        }
    ],
    "stats": {
        "total": 449,
        "additions": 440,
        "deletions": 9
    }
}