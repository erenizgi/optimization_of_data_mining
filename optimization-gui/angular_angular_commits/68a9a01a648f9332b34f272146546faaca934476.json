{
    "author": "petebacondarwin",
    "message": "fix(localize): parse all parts of a translation with nested HTML (#38452)\n\nPreviously nested container placeholders (i.e. HTML elements) were\nnot being fully parsed from translation files. This resulted in bad\ntranslation of messages that contain these placeholders.\n\nNote that this causes the canonical message ID to change for\nsuch messages. Currently all messages generated from\ntemplates use \"legacy\" message ids that are not affected by\nthis change, so this fix should not be seen as a breaking change.\n\nFixes #38422\n\nPR Close #38452",
    "sha": "68a9a01a648f9332b34f272146546faaca934476",
    "files": [
        {
            "sha": "995e6fbebd975c6983d9fbab7f6028eb05f8c864",
            "filename": "packages/localize/src/tools/src/translate/translation_files/message_serialization/message_serializer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 23,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Fmessage_serialization%2Fmessage_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Fmessage_serialization%2Fmessage_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Fmessage_serialization%2Fmessage_serializer.ts?ref=68a9a01a648f9332b34f272146546faaca934476",
            "patch": "@@ -75,29 +75,9 @@ export class MessageSerializer<T> extends BaseVisitor {\n   }\n \n   visitContainedNodes(nodes: Node[]): void {\n-    const length = nodes.length;\n-    let index = 0;\n-    while (index < length) {\n-      if (!this.isPlaceholderContainer(nodes[index])) {\n-        const startOfContainedNodes = index;\n-        while (index < length - 1) {\n-          index++;\n-          if (this.isPlaceholderContainer(nodes[index])) {\n-            break;\n-          }\n-        }\n-        if (index - startOfContainedNodes > 1) {\n-          // Only create a container if there are two or more contained Nodes in a row\n-          this.renderer.startContainer();\n-          visitAll(this, nodes.slice(startOfContainedNodes, index - 1));\n-          this.renderer.closeContainer();\n-        }\n-      }\n-      if (index < length) {\n-        nodes[index].visit(this, undefined);\n-      }\n-      index++;\n-    }\n+    this.renderer.startContainer();\n+    visitAll(this, nodes);\n+    this.renderer.closeContainer();\n   }\n \n   visitPlaceholder(name: string, body: string|undefined): void {"
        },
        {
            "sha": "c69b839433def303e6f84a4f7f4c196fb6ae7281",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xliff1_translation_parser_spec.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts?ref=68a9a01a648f9332b34f272146546faaca934476",
            "patch": "@@ -212,6 +212,46 @@ describe('Xliff1TranslationParser', () => {\n                 ['INTERPOLATION', 'START_BOLD_TEXT', 'CLOSE_BOLD_TEXT']));\n       });\n \n+      it('should extract nested placeholder containers (i.e. nested HTML elements)', () => {\n+        /**\n+         * Source HTML:\n+         *\n+         * ```\n+         * <div i18n>\n+         *   translatable <span>element <b>with placeholders</b></span> {{ interpolation}}\n+         * </div>\n+         * ```\n+         */\n+        const XLIFF = [\n+          `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n+          `  <file source-language=\"en\" target-language=\"fr\" datatype=\"plaintext\" original=\"ng2.template\">`,\n+          `    <body>`,\n+          `      <trans-unit id=\"9051630253697141670\" datatype=\"html\">`,\n+          `        <source>translatable <x id=\"START_TAG_SPAN\"/>element <x id=\"START_BOLD_TEXT\"/>with placeholders<x id=\"CLOSE_BOLD_TEXT\"/><x id=\"CLOSE_TAG_SPAN\"/> <x id=\"INTERPOLATION\"/></source>`,\n+          `        <target><x id=\"START_TAG_SPAN\"/><x id=\"INTERPOLATION\"/> tnemele<x id=\"CLOSE_TAG_SPAN\"/> elbatalsnart <x id=\"START_BOLD_TEXT\"/>sredlohecalp htiw<x id=\"CLOSE_BOLD_TEXT\"/></target>`,\n+          `        <context-group purpose=\"location\">`,\n+          `          <context context-type=\"sourcefile\">file.ts</context>`,\n+          `          <context context-type=\"linenumber\">3</context>`,\n+          `        </context-group>`,\n+          `      </trans-unit>`,\n+          `    </body>`,\n+          `  </file>`,\n+          `</xliff>`,\n+        ].join('\\n');\n+        const result = doParse('/some/file.xlf', XLIFF);\n+        expect(result.translations[ɵcomputeMsgId(\n+                   'translatable {$START_TAG_SPAN}element {$START_BOLD_TEXT}with placeholders' +\n+                   '{$CLOSE_BOLD_TEXT}{$CLOSE_TAG_SPAN} {$INTERPOLATION}')])\n+            .toEqual(ɵmakeParsedTranslation(\n+                ['', '', ' tnemele', ' elbatalsnart ', 'sredlohecalp htiw', ''], [\n+                  'START_TAG_SPAN',\n+                  'INTERPOLATION',\n+                  'CLOSE_TAG_SPAN',\n+                  'START_BOLD_TEXT',\n+                  'CLOSE_BOLD_TEXT',\n+                ]));\n+      });\n+\n       it('should extract translations with placeholders containing hyphens', () => {\n         /**\n          * Source HTML:"
        },
        {
            "sha": "9bcae2900bcb32b2799491d42d4f6639817c615a",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xliff2_translation_parser_spec.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 3,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts?ref=68a9a01a648f9332b34f272146546faaca934476",
            "patch": "@@ -172,13 +172,13 @@ describe(\n                  * Source HTML:\n                  *\n                  * ```\n-                 * <div i18n>translatable element <b>>with placeholders</b> {{ interpolation}}</div>\n+                 * <div i18n>translatable element <b>with placeholders</b> {{ interpolation}}</div>\n                  * ```\n                  */\n                 const XLIFF = [\n                   `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en\" trgLang=\"fr\">`,\n                   `  <file original=\"ng.template\" id=\"ngi18n\">`,\n-                  `    <unit id=\"5057824347511785081\">`,\n+                  `    <unit id=\"6949438802869886378\">`,\n                   `      <notes>`,\n                   `        <note category=\"location\">file.ts:3</note>`,\n                   `      </notes>`,\n@@ -193,12 +193,58 @@ describe(\n                 const result = doParse('/some/file.xlf', XLIFF);\n                 expect(\n                     result.translations[ɵcomputeMsgId(\n-                        'translatable element {$START_BOLD_TEXT}with placeholders{$LOSE_BOLD_TEXT} {$INTERPOLATION}')])\n+                        'translatable element {$START_BOLD_TEXT}with placeholders{$CLOSE_BOLD_TEXT} {$INTERPOLATION}')])\n                     .toEqual(ɵmakeParsedTranslation(\n                         ['', ' tnemele elbatalsnart ', 'sredlohecalp htiw', ''],\n                         ['INTERPOLATION', 'START_BOLD_TEXT', 'CLOSE_BOLD_TEXT']));\n               });\n \n+              it('should extract nested placeholder containers (i.e. nested HTML elements)', () => {\n+                /**\n+                 * Source HTML:\n+                 *\n+                 * ```\n+                 * <div i18n>\n+                 *   translatable <span>element <b>with placeholders</b></span> {{ interpolation}}\n+                 * </div>\n+                 * ```\n+                 */\n+                const XLIFF = [\n+                  `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en\" trgLang=\"fr\">`,\n+                  `  <file original=\"ng.template\" id=\"ngi18n\">`,\n+                  `    <unit id=\"9051630253697141670\">`,\n+                  `      <notes>`,\n+                  `        <note category=\"location\">file.ts:3</note>`,\n+                  `      </notes>`,\n+                  `      <segment>`,\n+                  `        <source>translatable <pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"other\"` +\n+                      ` dispStart=\"&lt;span&gt;\" dispEnd=\"&lt;/span&gt;\">element <pc id=\"1\" equivStart=\"START_BOLD_TEXT\" equivEnd=` +\n+                      `\"CLOSE_BOLD_TEXT\" type=\"fmt\" dispStart=\"&lt;b&gt;\" dispEnd=\"&lt;/b&gt;\">with placeholders</pc></pc>` +\n+                      ` <ph id=\"2\" equiv=\"INTERPOLATION\" disp=\"{{ interpolation}}\"/></source>`,\n+                  `        <target><pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"fmt\" dispStart=\"&lt;` +\n+                      `span&gt;\" dispEnd=\"&lt;/span&gt;\"><ph id=\"2\" equiv=\"INTERPOLATION\" disp=\"{{ interpolation}}\"/> tnemele</pc>` +\n+                      ` elbatalsnart <pc id=\"1\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\" type=\"fmt\" dispStart=` +\n+                      `\"&lt;b&gt;\" dispEnd=\"&lt;/b&gt;\">sredlohecalp htiw</pc></target>`,\n+                  `      </segment>`,\n+                  `    </unit>`,\n+                  `  </file>`,\n+                  `</xliff>`,\n+                ].join('\\n');\n+                const result = doParse('/some/file.xlf', XLIFF);\n+                expect(\n+                    result.translations[ɵcomputeMsgId(\n+                        'translatable {$START_TAG_SPAN}element {$START_BOLD_TEXT}with placeholders' +\n+                        '{$CLOSE_BOLD_TEXT}{$CLOSE_TAG_SPAN} {$INTERPOLATION}')])\n+                    .toEqual(ɵmakeParsedTranslation(\n+                        ['', '', ' tnemele', ' elbatalsnart ', 'sredlohecalp htiw', ''], [\n+                          'START_TAG_SPAN',\n+                          'INTERPOLATION',\n+                          'CLOSE_TAG_SPAN',\n+                          'START_BOLD_TEXT',\n+                          'CLOSE_BOLD_TEXT',\n+                        ]));\n+              });\n+\n               it('should extract translations with simple ICU expressions', () => {\n                 /**\n                  * Source HTML:"
        },
        {
            "sha": "20ce00469565c460ef0ea4cfb9805b87a7b07f56",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xtb_translation_parser_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/68a9a01a648f9332b34f272146546faaca934476/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts?ref=68a9a01a648f9332b34f272146546faaca934476",
            "patch": "@@ -140,6 +140,38 @@ describe('XtbTranslationParser', () => {\n                 ɵmakeParsedTranslation(['', 'rab', ''], ['START_PARAGRAPH', 'CLOSE_PARAGRAPH']));\n       });\n \n+      it('should extract nested placeholder containers (i.e. nested HTML elements)', () => {\n+        /**\n+         * Source HTML:\n+         *\n+         * ```\n+         * <div i18n>\n+         *   translatable <span>element <b>with placeholders</b></span> {{ interpolation}}\n+         * </div>\n+         * ```\n+         */\n+        const XLIFF = [\n+          `<?xml version=\"1.0\" encoding=\"UTF-8\"?>`,\n+          `<translationbundle>`,\n+          `  <translation id=\"9051630253697141670\">` +\n+              `<ph name=\"START_TAG_SPAN\"/><ph name=\"INTERPOLATION\"/> tnemele<ph name=\"CLOSE_TAG_SPAN\"/> elbatalsnart <ph name=\"START_BOLD_TEXT\"/>sredlohecalp htiw<ph name=\"CLOSE_BOLD_TEXT\"/>` +\n+              `</translation>`,\n+          `</translationbundle>`,\n+        ].join('\\n');\n+        const result = doParse('/some/file.xtb', XLIFF);\n+        expect(result.translations[ɵcomputeMsgId(\n+                   'translatable {$START_TAG_SPAN}element {$START_BOLD_TEXT}with placeholders' +\n+                   '{$CLOSE_BOLD_TEXT}{$CLOSE_TAG_SPAN} {$INTERPOLATION}')])\n+            .toEqual(ɵmakeParsedTranslation(\n+                ['', '', ' tnemele', ' elbatalsnart ', 'sredlohecalp htiw', ''], [\n+                  'START_TAG_SPAN',\n+                  'INTERPOLATION',\n+                  'CLOSE_TAG_SPAN',\n+                  'START_BOLD_TEXT',\n+                  'CLOSE_BOLD_TEXT',\n+                ]));\n+      });\n+\n       it('should extract translations with simple ICU expressions', () => {\n         const XTB = [\n           `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 124,
        "deletions": 26
    }
}