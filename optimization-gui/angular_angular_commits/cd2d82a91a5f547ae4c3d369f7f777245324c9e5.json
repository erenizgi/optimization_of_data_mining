{
    "author": "JoostK",
    "message": "fix(core): associate the NgModule scope for an overridden component (#42817)\n\nWhen using `TestBed.overrideComponent`, the overridden component would\nincorrectly lose access to its NgModule's declaration scope if the\nNgModule had been imported into the testing NgModule as a\n`ModuleWithProviders`, e.g. using a `forRoot` call.\n\nThe issue occurred as the `TestBed` compiler did not consider NgModules\nthat had been imported as a `ModuleWithProviders` when associating\nNgModules with component overrides. This caused the overridden component\nto be compiled standalone, meaning that it does not have access to\nits NgModule's declarations. This commit extends the logic for\ntraversing the NgModule graph to also consider `ModuleWithProviders`\nimports.\n\nFixes #42734\n\nPR Close #42817",
    "sha": "cd2d82a91a5f547ae4c3d369f7f777245324c9e5",
    "files": [
        {
            "sha": "9bd540a2a8e53e3de74a4893914330a3ef8a4086",
            "filename": "packages/core/test/test_bed_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/cd2d82a91a5f547ae4c3d369f7f777245324c9e5/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cd2d82a91a5f547ae4c3d369f7f777245324c9e5/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Ftest_bed_spec.ts?ref=cd2d82a91a5f547ae4c3d369f7f777245324c9e5",
            "patch": "@@ -248,6 +248,25 @@ describe('TestBed', () => {\n     expect(hello.nativeElement).toHaveText('Hello World!');\n   });\n \n+  // https://github.com/angular/angular/issues/42734\n+  it('should override a component which is declared in an NgModule which is imported as a `ModuleWithProviders`',\n+     () => {\n+       // This test verifies that an overridden component that is declared in an NgModule that has\n+       // been imported as a `ModuleWithProviders` continues to have access to the declaration scope\n+       // of the NgModule.\n+       TestBed.resetTestingModule();\n+\n+       const moduleWithProviders:\n+           ModuleWithProviders<HelloWorldModule> = {ngModule: HelloWorldModule};\n+       TestBed.configureTestingModule({imports: [moduleWithProviders]});\n+       TestBed.overrideComponent(\n+           HelloWorld, {set: {template: 'Overridden <greeting-cmp></greeting-cmp>'}});\n+\n+       const hello = TestBed.createComponent(HelloWorld);\n+       hello.detectChanges();\n+       expect(hello.nativeElement).toHaveText('Overridden Hello World!');\n+     });\n+\n   it('should run `APP_INITIALIZER` before accessing `LOCALE_ID` provider', () => {\n     let locale: string = '';\n     @NgModule({"
        },
        {
            "sha": "cc6690e7972d443385d2833c3c75a7d6df27178f",
            "filename": "packages/core/testing/src/r3_test_bed_compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/cd2d82a91a5f547ae4c3d369f7f777245324c9e5/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/cd2d82a91a5f547ae4c3d369f7f777245324c9e5/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts?ref=cd2d82a91a5f547ae4c3d369f7f777245324c9e5",
            "patch": "@@ -538,6 +538,8 @@ export class R3TestBedCompiler {\n           this.queueTypeArray(maybeUnwrapFn(def.declarations), value);\n           queueTypesFromModulesArrayRecur(maybeUnwrapFn(def.imports));\n           queueTypesFromModulesArrayRecur(maybeUnwrapFn(def.exports));\n+        } else if (isModuleWithProviders(value)) {\n+          queueTypesFromModulesArrayRecur([value.ngModule]);\n         }\n       }\n     };"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 21,
        "deletions": 0
    }
}