{
    "author": "JoostK",
    "message": "fix(ngcc): do not fail for packages which correspond with `Object` members (#43589)\n\nPrior to this commit ngcc stored its package configuration in JavaScript\nobjects, which caused the builtin `Object` members to be found as\npackage configuration. This would subsequently crash as their shape was\nnot as expected.\n\nThis commit moves away from using raw JavaScript objects in favor of a\nMap. To code was refactored such that `PartiallyProcessedConfig` is\nnow a class.\n\nFixes #43570\n\nPR Close #43589",
    "sha": "988cca7ef59df9c740b988eabb94fa084cfa5451",
    "files": [
        {
            "sha": "26d15688d1ea384fb421a1853b464000af7666b2",
            "filename": "packages/compiler-cli/ngcc/src/packages/configuration.ts",
            "status": "modified",
            "additions": 108,
            "deletions": 68,
            "changes": 176,
            "blob_url": "https://github.com/angular/angular/blob/988cca7ef59df9c740b988eabb94fa084cfa5451/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fconfiguration.ts",
            "raw_url": "https://github.com/angular/angular/raw/988cca7ef59df9c740b988eabb94fa084cfa5451/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fconfiguration.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fconfiguration.ts?ref=988cca7ef59df9c740b988eabb94fa084cfa5451",
            "patch": "@@ -16,11 +16,11 @@ import {PackageJsonFormatPropertiesMap} from './entry_point';\n /**\n  * The format of a project level configuration file.\n  */\n-export interface NgccProjectConfig<T = RawNgccPackageConfig> {\n+export interface NgccProjectConfig {\n   /**\n    * The packages that are configured by this project config.\n    */\n-  packages?: {[packagePath: string]: T|undefined};\n+  packages?: {[packagePath: string]: RawNgccPackageConfig|undefined};\n   /**\n    * Options that control how locking the process is handled.\n    */\n@@ -102,7 +102,107 @@ interface VersionedPackageConfig extends RawNgccPackageConfig {\n   versionRange: string;\n }\n \n-type PartiallyProcessedConfig = Required<NgccProjectConfig<VersionedPackageConfig[]>>;\n+/**\n+ * The internal representation of a configuration file. Configured packages are transformed into\n+ * `ProcessedNgccPackageConfig` when a certain version is requested.\n+ */\n+export class PartiallyProcessedConfig {\n+  /**\n+   * The packages that are configured by this project config, keyed by package name.\n+   */\n+  packages = new Map<string, VersionedPackageConfig[]>();\n+  /**\n+   * Options that control how locking the process is handled.\n+   */\n+  locking: ProcessLockingConfiguration = {};\n+  /**\n+   * Name of hash algorithm used to generate hashes of the configuration.\n+   *\n+   * Defaults to `sha256`.\n+   */\n+  hashAlgorithm = 'sha256';\n+\n+  constructor(projectConfig: NgccProjectConfig) {\n+    // locking configuration\n+    if (projectConfig.locking !== undefined) {\n+      this.locking = projectConfig.locking;\n+    }\n+\n+    // packages configuration\n+    for (const packageNameAndVersion in projectConfig.packages) {\n+      const packageConfig = projectConfig.packages[packageNameAndVersion];\n+      if (packageConfig) {\n+        const [packageName, versionRange = '*'] = this.splitNameAndVersion(packageNameAndVersion);\n+        this.addPackageConfig(packageName, {...packageConfig, versionRange});\n+      }\n+    }\n+\n+    // hash algorithm config\n+    if (projectConfig.hashAlgorithm !== undefined) {\n+      this.hashAlgorithm = projectConfig.hashAlgorithm;\n+    }\n+  }\n+\n+  private splitNameAndVersion(packageNameAndVersion: string): [string, string|undefined] {\n+    const versionIndex = packageNameAndVersion.lastIndexOf('@');\n+    // Note that > 0 is because we don't want to match @ at the start of the line\n+    // which is what you would have with a namespaced package, e.g. `@angular/common`.\n+    return versionIndex > 0 ?\n+        [\n+          packageNameAndVersion.substring(0, versionIndex),\n+          packageNameAndVersion.substring(versionIndex + 1),\n+        ] :\n+        [packageNameAndVersion, undefined];\n+  }\n+\n+  /**\n+   * Registers the configuration for a particular version of the provided package.\n+   */\n+  private addPackageConfig(packageName: string, config: VersionedPackageConfig): void {\n+    if (!this.packages.has(packageName)) {\n+      this.packages.set(packageName, []);\n+    }\n+    this.packages.get(packageName)!.push(config);\n+  }\n+\n+  /**\n+   * Finds the configuration for a particular version of the provided package.\n+   */\n+  findPackageConfig(packageName: string, version: string|null): VersionedPackageConfig|null {\n+    if (!this.packages.has(packageName)) {\n+      return null;\n+    }\n+\n+    const configs = this.packages.get(packageName)!;\n+    if (version === null) {\n+      // The package has no version (!) - perhaps the entry-point was from a deep import, which made\n+      // it impossible to find the package.json.\n+      // So just return the first config that matches the package name.\n+      return configs[0];\n+    }\n+    return configs.find(\n+               config => satisfies(version, config.versionRange, {includePrerelease: true})) ??\n+        null;\n+  }\n+\n+  /**\n+   * Converts the configuration into a JSON representation that is used to compute a hash of the\n+   * configuration.\n+   */\n+  toJson(): string {\n+    return JSON.stringify(this, (key: string, value: unknown) => {\n+      if (value instanceof Map) {\n+        const res: Record<string, unknown> = {};\n+        for (const [k, v] of value) {\n+          res[k] = v;\n+        }\n+        return res;\n+      } else {\n+        return value;\n+      }\n+    });\n+  }\n+}\n \n /**\n  * The default configuration for ngcc.\n@@ -239,8 +339,8 @@ export class NgccConfiguration {\n   readonly hashAlgorithm: string;\n \n   constructor(private fs: ReadonlyFileSystem, baseDir: AbsoluteFsPath) {\n-    this.defaultConfig = this.processProjectConfig(DEFAULT_NGCC_CONFIG);\n-    this.projectConfig = this.processProjectConfig(this.loadProjectConfig(baseDir));\n+    this.defaultConfig = new PartiallyProcessedConfig(DEFAULT_NGCC_CONFIG);\n+    this.projectConfig = new PartiallyProcessedConfig(this.loadProjectConfig(baseDir));\n     this.hashAlgorithm = this.projectConfig.hashAlgorithm;\n     this.hash = this.computeHash();\n   }\n@@ -281,9 +381,7 @@ export class NgccConfiguration {\n       return this.cache.get(cacheKey)!;\n     }\n \n-    const projectLevelConfig = this.projectConfig.packages ?\n-        findSatisfactoryVersion(this.projectConfig.packages[packageName], version) :\n-        null;\n+    const projectLevelConfig = this.projectConfig.findPackageConfig(packageName, version);\n     if (projectLevelConfig !== null) {\n       this.cache.set(cacheKey, projectLevelConfig);\n       return projectLevelConfig;\n@@ -295,9 +393,7 @@ export class NgccConfiguration {\n       return packageLevelConfig;\n     }\n \n-    const defaultLevelConfig = this.defaultConfig.packages ?\n-        findSatisfactoryVersion(this.defaultConfig.packages[packageName], version) :\n-        null;\n+    const defaultLevelConfig = this.defaultConfig.findPackageConfig(packageName, version);\n     if (defaultLevelConfig !== null) {\n       this.cache.set(cacheKey, defaultLevelConfig);\n       return defaultLevelConfig;\n@@ -306,34 +402,6 @@ export class NgccConfiguration {\n     return {versionRange: '*'};\n   }\n \n-  private processProjectConfig(projectConfig: NgccProjectConfig): PartiallyProcessedConfig {\n-    const processedConfig:\n-        PartiallyProcessedConfig = {packages: {}, locking: {}, hashAlgorithm: 'sha256'};\n-\n-    // locking configuration\n-    if (projectConfig.locking !== undefined) {\n-      processedConfig.locking = projectConfig.locking;\n-    }\n-\n-    // packages configuration\n-    for (const packageNameAndVersion in projectConfig.packages) {\n-      const packageConfig = projectConfig.packages[packageNameAndVersion];\n-      if (packageConfig) {\n-        const [packageName, versionRange = '*'] = this.splitNameAndVersion(packageNameAndVersion);\n-        const packageConfigs =\n-            processedConfig.packages[packageName] || (processedConfig.packages[packageName] = []);\n-        packageConfigs!.push({...packageConfig, versionRange});\n-      }\n-    }\n-\n-    // hash algorithm config\n-    if (projectConfig.hashAlgorithm !== undefined) {\n-      processedConfig.hashAlgorithm = projectConfig.hashAlgorithm;\n-    }\n-\n-    return processedConfig;\n-  }\n-\n   private loadProjectConfig(baseDir: AbsoluteFsPath): NgccProjectConfig {\n     const configFilePath = this.fs.join(baseDir, NGCC_CONFIG_FILENAME);\n     if (this.fs.exists(configFilePath)) {\n@@ -379,35 +447,7 @@ export class NgccConfiguration {\n     return sandbox.module.exports;\n   }\n \n-  private splitNameAndVersion(packageNameAndVersion: string): [string, string|undefined] {\n-    const versionIndex = packageNameAndVersion.lastIndexOf('@');\n-    // Note that > 0 is because we don't want to match @ at the start of the line\n-    // which is what you would have with a namespaced package, e.g. `@angular/common`.\n-    return versionIndex > 0 ?\n-        [\n-          packageNameAndVersion.substring(0, versionIndex),\n-          packageNameAndVersion.substring(versionIndex + 1),\n-        ] :\n-        [packageNameAndVersion, undefined];\n-  }\n-\n   private computeHash(): string {\n-    return createHash(this.hashAlgorithm).update(JSON.stringify(this.projectConfig)).digest('hex');\n-  }\n-}\n-\n-function findSatisfactoryVersion(configs: VersionedPackageConfig[]|undefined, version: string|null):\n-    VersionedPackageConfig|null {\n-  if (configs === undefined) {\n-    return null;\n-  }\n-  if (version === null) {\n-    // The package has no version (!) - perhaps the entry-point was from a deep import, which made\n-    // it impossible to find the package.json.\n-    // So just return the first config that matches the package name.\n-    return configs[0];\n+    return createHash(this.hashAlgorithm).update(this.projectConfig.toJson()).digest('hex');\n   }\n-  return configs.find(\n-             config => satisfies(version, config.versionRange, {includePrerelease: true})) ||\n-      null;\n }"
        },
        {
            "sha": "cf63df31674970454f2798f879fa26017c6eb04c",
            "filename": "packages/compiler-cli/ngcc/test/packages/configuration_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 6,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/988cca7ef59df9c740b988eabb94fa084cfa5451/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fconfiguration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/988cca7ef59df9c740b988eabb94fa084cfa5451/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fconfiguration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fconfiguration_spec.ts?ref=988cca7ef59df9c740b988eabb94fa084cfa5451",
            "patch": "@@ -10,7 +10,7 @@ import {createHash} from 'crypto';\n import {absoluteFrom, getFileSystem, ReadonlyFileSystem} from '../../../src/ngtsc/file_system';\n import {runInEachFileSystem} from '../../../src/ngtsc/file_system/testing';\n import {loadTestFiles} from '../../../src/ngtsc/testing';\n-import {DEFAULT_NGCC_CONFIG, NgccConfiguration, NgccProjectConfig, ProcessLockingConfiguration, RawNgccPackageConfig} from '../../src/packages/configuration';\n+import {DEFAULT_NGCC_CONFIG, NgccConfiguration, NgccProjectConfig, PartiallyProcessedConfig, ProcessLockingConfiguration} from '../../src/packages/configuration';\n \n \n runInEachFileSystem(() => {\n@@ -75,10 +75,9 @@ runInEachFileSystem(() => {\n         loadTestFiles([{name: _Abs('/project-1/empty.js'), contents: ``}]);\n         const configuration = new NgccConfiguration(fs, _Abs('/project-1'));\n         expect(configuration.hash)\n-            .toEqual(\n-                createHash('sha256')\n-                    .update(JSON.stringify({packages: {}, locking: {}, hashAlgorithm: 'sha256'}))\n-                    .digest('hex'));\n+            .toEqual(createHash('sha256')\n+                         .update(new PartiallyProcessedConfig({}).toJson())\n+                         .digest('hex'));\n       });\n \n       it('should use a custom hash algorithm if specified in the config', () => {\n@@ -98,7 +97,7 @@ runInEachFileSystem(() => {\n         const project1Conf = new NgccConfiguration(fs, project1);\n         const expectedProject1Config =\n             `{\"packages\":{\"package-1\":[{\"entryPoints\":{\"./entry-point-1\":{}},\"versionRange\":\"*\"}]},\"locking\":{},\"hashAlgorithm\":\"md5\"}`;\n-        expect(JSON.stringify((project1Conf as any).projectConfig)).toEqual(expectedProject1Config);\n+        expect((project1Conf as any).projectConfig.toJson()).toEqual(expectedProject1Config);\n         expect(project1Conf.hash)\n             .toEqual(createHash('md5').update(expectedProject1Config).digest('hex'));\n       });\n@@ -150,6 +149,24 @@ runInEachFileSystem(() => {\n           }));\n         });\n \n+        it('should handle packages with an Object member name when no config is present', () => {\n+          loadTestFiles([\n+            {\n+              name: _Abs('/project-1/node_modules/constructor/package.json'),\n+              contents: '{\"version\": \"1.0.0\"}',\n+            },\n+          ]);\n+\n+          const configuration = new NgccConfiguration(fs, _Abs('/project-1'));\n+          const config = configuration.getPackageConfig(\n+              'constructor', _Abs('/project-1/node_modules/constructor'), '1.0.0');\n+\n+          expect(config).toEqual(jasmine.objectContaining({\n+            ignorableDeepImportMatchers: [],\n+            entryPoints: new Map(),\n+          }));\n+        });\n+\n         it('should read extra package config from package level file', () => {\n           loadTestFiles(packageWithConfigFiles(\n               'package-1', 'entry-point-1', '1.0.0', 'ignorableDeepImportMatchers: [ /xxx/ ]'));"
        }
    ],
    "stats": {
        "total": 205,
        "additions": 131,
        "deletions": 74
    }
}