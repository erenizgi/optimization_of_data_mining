{
    "author": "ayazhafiz",
    "message": "fix(compiler): do not throw away render3 AST on errors (#39413)\n\nCurrently render3's `parseTemplate` throws away the parsed AST and\nreturns an empty list of HTML nodes if HTML->R3 translation failed. This\nis not preferrable in some contexts like that of a language service,\nwhere we would like a well-formed AST even if it is has errors.\n\nPR Close #39413",
    "sha": "19b88cef71b4c8e046ea751d5470dce5f9e1438b",
    "files": [
        {
            "sha": "cc313ce1c08dd2518b475e27250f3378bca56002",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/19b88cef71b4c8e046ea751d5470dce5f9e1438b/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/19b88cef71b4c8e046ea751d5470dce5f9e1438b/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=19b88cef71b4c8e046ea751d5470dce5f9e1438b",
            "patch": "@@ -2046,6 +2046,8 @@ export function parseTemplate(\n       {leadingTriviaChars: LEADING_TRIVIA_CHARS, ...options, tokenizeExpansionForms: true});\n \n   if (parseResult.errors && parseResult.errors.length > 0) {\n+    // TODO(ayazhafiz): we may not always want to bail out at this point (e.g. in\n+    // the context of a language service).\n     return {\n       interpolationConfig,\n       preserveWhitespaces,\n@@ -2084,23 +2086,11 @@ export function parseTemplate(\n \n   const {nodes, errors, styleUrls, styles, ngContentSelectors} =\n       htmlAstToRender3Ast(rootNodes, bindingParser);\n-  if (errors && errors.length > 0) {\n-    return {\n-      interpolationConfig,\n-      preserveWhitespaces,\n-      template,\n-      errors,\n-      nodes: [],\n-      styleUrls: [],\n-      styles: [],\n-      ngContentSelectors: []\n-    };\n-  }\n \n   return {\n     interpolationConfig,\n     preserveWhitespaces,\n-    errors: null,\n+    errors: errors.length > 0 ? errors : null,\n     template,\n     nodes,\n     styleUrls,\n@@ -2265,6 +2255,8 @@ export interface ParsedTemplate {\n \n   /**\n    * Any errors from parsing the template the first time.\n+   *\n+   * `null` if there are no errors. Otherwise, the array of errors is guaranteed to be non-empty.\n    */\n   errors: ParseError[]|null;\n "
        },
        {
            "sha": "c238cb97f563d8dedecd7785a6a9905ae1356f82",
            "filename": "packages/language-service/ivy/test/hybrid_visitor_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 10,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/19b88cef71b4c8e046ea751d5470dce5f9e1438b/packages%2Flanguage-service%2Fivy%2Ftest%2Fhybrid_visitor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/19b88cef71b4c8e046ea751d5470dce5f9e1438b/packages%2Flanguage-service%2Fivy%2Ftest%2Fhybrid_visitor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fhybrid_visitor_spec.ts?ref=19b88cef71b4c8e046ea751d5470dce5f9e1438b",
            "patch": "@@ -433,16 +433,17 @@ describe('findNodeAtPosition for expression AST', () => {\n     expect(node).toBeInstanceOf(e.BindingPipe);\n   });\n \n-  it('should locate binding pipe without identifier',\n-     () => {\n-         // TODO: We are not able to locate pipe if identifier is missing because the\n-         // parser throws an error. This case is important for autocomplete.\n-         // const {errors, nodes, position} = parse(`{{ title | ¦ }}`);\n-         // expect(errors).toBe(null);\n-         // const node = findNodeAtPosition(nodes, position);\n-         // expect(isExpressionNode(node!)).toBe(true);\n-         // expect(node).toBeInstanceOf(e.BindingPipe);\n-     });\n+  it('should locate binding pipe without identifier', () => {\n+    const {errors, nodes, position} = parse(`{{ title | ¦ }}`);\n+    expect(errors?.length).toBe(1);\n+    expect(errors![0].toString())\n+        .toContain(\n+            'Unexpected end of input, expected identifier or keyword at the end of the expression');\n+    const node = findNodeAtPosition(nodes, position);\n+    expect(isExpressionNode(node!)).toBe(true);\n+    // TODO: We want this to be a BindingPipe.\n+    expect(node).toBeInstanceOf(e.Interpolation);\n+  });\n \n   it('should locate method call', () => {\n     const {errors, nodes, position} = parse(`{{ title.toString(¦) }}`);"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 16,
        "deletions": 23
    }
}