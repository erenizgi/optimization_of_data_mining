{
    "author": "mhevery",
    "message": "fix(core): fix possible XSS attack in development through SSR. (#40136)\n\nEscape the content of the strings so that it can be safely inserted into a comment node.\nThe issue is that HTML does not specify any way to escape comment end text inside the comment.\n`<!-- The way you close a comment is with \"-->\". -->`. Above the `\"-->\"` is meant to be text\nnot an end to the comment. This can be created programmatically through DOM APIs.\n\n```\ndiv.innerHTML = div.innerHTML\n```\nOne would expect that the above code would be safe to do, but it turns out that because comment\ntext is not escaped, the comment may contain text which will prematurely close the comment\nopening up the application for XSS attack. (In SSR we programmatically create comment nodes which\nmay contain such text and expect them to be safe.)\nThis function escapes the comment text by looking for the closing char sequence `-->` and replace\nit with `-_-_>` where the `_` is a zero width space `\\u200B`. The result is that if a comment\ncontains `-->` text it will render normally but it will not cause the HTML parser to close the\ncomment.\n\nPR Close #40136",
    "sha": "47d9b6d72dab9d60c96bc1c3604219f6385649ea",
    "files": [
        {
            "sha": "f1a8c836085d6742eba43c05c89723723cec3c37",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=47d9b6d72dab9d60c96bc1c3604219f6385649ea",
            "patch": "@@ -13,6 +13,7 @@ import {ViewEncapsulation} from '../../metadata/view';\n import {validateAgainstEventAttributes, validateAgainstEventProperties} from '../../sanitization/sanitization';\n import {Sanitizer} from '../../sanitization/sanitizer';\n import {assertDefined, assertDomNode, assertEqual, assertGreaterThanOrEqual, assertIndexInRange, assertNotEqual, assertNotSame, assertSame, assertString} from '../../util/assert';\n+import {escapeCommentText} from '../../util/dom';\n import {createNamedArrayType} from '../../util/named_array_type';\n import {initNgDevMode} from '../../util/ng_dev_mode';\n import {normalizeDebugBindingName, normalizeDebugBindingValue} from '../../util/ng_reflect';\n@@ -1043,7 +1044,8 @@ function setNgReflectProperty(\n           (element as RElement).setAttribute(attrName, debugValue);\n     }\n   } else {\n-    const textContent = `bindings=${JSON.stringify({[attrName]: debugValue}, null, 2)}`;\n+    const textContent =\n+        escapeCommentText(`bindings=${JSON.stringify({[attrName]: debugValue}, null, 2)}`);\n     if (isProceduralRenderer(renderer)) {\n       renderer.setValue((element as RComment), textContent);\n     } else {"
        },
        {
            "sha": "4b694a598af4c3ffd30fa6896c8b62f5b97adfa1",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=47d9b6d72dab9d60c96bc1c3604219f6385649ea",
            "patch": "@@ -11,6 +11,7 @@ import {Renderer2} from '../render/api';\n import {RendererStyleFlags2} from '../render/api_flags';\n import {addToArray, removeFromArray} from '../util/array_utils';\n import {assertDefined, assertDomNode, assertEqual, assertFunction, assertString} from '../util/assert';\n+import {escapeCommentText} from '../util/dom';\n import {assertLContainer, assertLView, assertTNodeForLView} from './assert';\n import {attachPatchData} from './context_discovery';\n import {icuContainerIterate} from './i18n/i18n_tree_shaking';\n@@ -113,7 +114,7 @@ export function createCommentNode(renderer: Renderer3, value: string): RComment\n   ngDevMode && ngDevMode.rendererCreateComment++;\n   // isProceduralRenderer check is not needed because both `Renderer2` and `Renderer3` have the same\n   // method name.\n-  return renderer.createComment(value);\n+  return renderer.createComment(escapeCommentText(value));\n }\n \n /**"
        },
        {
            "sha": "805daa5a926b6c5846b7c1e25e58d0efdf0fd890",
            "filename": "packages/core/src/util/dom.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts",
            "raw_url": "https://github.com/angular/angular/raw/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fdom.ts?ref=47d9b6d72dab9d60c96bc1c3604219f6385649ea",
            "patch": "@@ -0,0 +1,37 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+const END_COMMENT = /-->/g;\n+const END_COMMENT_ESCAPED = '-\\u200B-\\u200B>';\n+\n+/**\n+ * Escape the content of the strings so that it can be safely inserted into a comment node.\n+ *\n+ * The issue is that HTML does not specify any way to escape comment end text inside the comment.\n+ * `<!-- The way you close a comment is with \"-->\". -->`. Above the `\"-->\"` is meant to be text not\n+ * an end to the comment. This can be created programmatically through DOM APIs.\n+ *\n+ * ```\n+ * div.innerHTML = div.innerHTML\n+ * ```\n+ *\n+ * One would expect that the above code would be safe to do, but it turns out that because comment\n+ * text is not escaped, the comment may contain text which will prematurely close the comment\n+ * opening up the application for XSS attack. (In SSR we programmatically create comment nodes which\n+ * may contain such text and expect them to be safe.)\n+ *\n+ * This function escapes the comment text by looking for the closing char sequence `-->` and replace\n+ * it with `-_-_>` where the `_` is a zero width space `\\u200B`. The result is that if a comment\n+ * contains `-->` text it will render normally but it will not cause the HTML parser to close the\n+ * comment.\n+ *\n+ * @param value text to make safe for comment node by escaping the comment close character sequence\n+ */\n+export function escapeCommentText(value: string): string {\n+  return value.replace(END_COMMENT, END_COMMENT_ESCAPED);\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "c15f0a4aa155e468949f63d356de5aa21e55d810",
            "filename": "packages/core/src/view/services.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts",
            "raw_url": "https://github.com/angular/angular/raw/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts?ref=47d9b6d72dab9d60c96bc1c3604219f6385649ea",
            "patch": "@@ -16,6 +16,7 @@ import {NgModuleRef} from '../linker/ng_module_factory';\n import {Renderer2, RendererFactory2} from '../render/api';\n import {RendererStyleFlags2, RendererType2} from '../render/api_flags';\n import {Sanitizer} from '../sanitization/sanitizer';\n+import {escapeCommentText} from '../util/dom';\n import {isDevMode} from '../util/is_dev_mode';\n import {normalizeDebugBindingName, normalizeDebugBindingValue} from '../util/ng_reflect';\n \n@@ -448,7 +449,8 @@ function debugCheckAndUpdateNode(\n       const el = asElementData(view, elDef.nodeIndex).renderElement;\n       if (!elDef.element!.name) {\n         // a comment.\n-        view.renderer.setValue(el, `bindings=${JSON.stringify(bindingValues, null, 2)}`);\n+        view.renderer.setValue(\n+            el, escapeCommentText(`bindings=${JSON.stringify(bindingValues, null, 2)}`));\n       } else {\n         // a regular element.\n         for (let attr in bindingValues) {\n@@ -727,7 +729,7 @@ export class DebugRenderer2 implements Renderer2 {\n   }\n \n   createComment(value: string): any {\n-    const comment = this.delegate.createComment(value);\n+    const comment = this.delegate.createComment(escapeCommentText(value));\n     const debugCtx = this.createDebugContext(comment);\n     if (debugCtx) {\n       indexDebugNode(new DebugNode__PRE_R3__(comment, null, debugCtx));"
        },
        {
            "sha": "0376dcc1cf7125c5bd16cc1fcd4a62cc72b464bb",
            "filename": "packages/core/test/acceptance/security_spec.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fsecurity_spec.ts?ref=47d9b6d72dab9d60c96bc1c3604219f6385649ea",
            "patch": "@@ -0,0 +1,34 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Component} from '@angular/core';\n+import {TestBed} from '@angular/core/testing';\n+\n+\n+describe('comment node text escaping', () => {\n+  it('should not be possible to do XSS through comment reflect data', () => {\n+    @Component({template: `<div><span *ngIf=\"xssValue\"></span><div>`})\n+    class XSSComp {\n+      xssValue: string = '--> --><script>\"evil\"</script>';\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [XSSComp]});\n+    const fixture = TestBed.createComponent(XSSComp);\n+    fixture.detectChanges();\n+    const div = fixture.nativeElement.querySelector('div') as HTMLElement;\n+    // Serialize into a string to mimic SSR serialization.\n+    const html = div.innerHTML;\n+    // This must be escaped or we have XSS.\n+    expect(html).not.toContain('--><script');\n+    // Now parse it back into DOM (from string)\n+    div.innerHTML = html;\n+    // Verify that we did not accidentally deserialize the `<script>`\n+    const script = div.querySelector('script');\n+    expect(script).toBeFalsy();\n+  });\n+});\n\\ No newline at end of file"
        },
        {
            "sha": "8d552ccf2ea00c65ac6dbd8621cd9f0ddcdbfb50",
            "filename": "packages/core/test/util/dom_spec.ts",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/47d9b6d72dab9d60c96bc1c3604219f6385649ea/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Futil%2Fdom_spec.ts?ref=47d9b6d72dab9d60c96bc1c3604219f6385649ea",
            "patch": "@@ -0,0 +1,26 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {escapeCommentText} from '@angular/core/src/util/dom';\n+\n+describe('comment node text escaping', () => {\n+  describe('escapeCommentText', () => {\n+    it('should not change anything on basic text', () => {\n+      expect(escapeCommentText('text')).toEqual('text');\n+    });\n+\n+    it('should escape end marker', () => {\n+      expect(escapeCommentText('before-->after')).toEqual('before-\\u200b-\\u200b>after');\n+    });\n+\n+    it('should escape multiple markers', () => {\n+      expect(escapeCommentText('before-->inline-->after'))\n+          .toEqual('before-\\u200b-\\u200b>inline-\\u200b-\\u200b>after');\n+    });\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 110,
        "additions": 106,
        "deletions": 4
    }
}