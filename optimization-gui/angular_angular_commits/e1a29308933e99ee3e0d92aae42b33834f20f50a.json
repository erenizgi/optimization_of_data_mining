{
    "author": "alxhub",
    "message": "fix(compiler): avoid parsing EmptyExpr with a backwards span (#41581)\n\n`EmptyExpr` is somewhat unique, in that it's constructed in a circumstance\nwhere the parser has been looking for a particular token or string of tokens\nand has failed to find any. This means the parser state when constructing\n`EmptyExpr` is fairly unique.\n\nThis gives rise to a bug where the parser constructs `EmptyExpr` with a\nbackwards span - a `start` value that's beyond the `end` value. This likely\nhappens because of the strange state the parser is in when recovering with\n`EmptyExpr`.\n\nThis commit adds a backstop/workaround to avoid constructing such broken\n`EmptyExpr` spans (or any other kind of span). Eventually, the parser state\nshould be fixed such that this does not occur, but that requires a\nsignificant change to the parser's functionality, so a simple fix in th\ninterim is in order.\n\nPR Close #41581",
    "sha": "e1a29308933e99ee3e0d92aae42b33834f20f50a",
    "files": [
        {
            "sha": "18a516649e58af4f8fb52e94f9dcc790646432fe",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/e1a29308933e99ee3e0d92aae42b33834f20f50a/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/e1a29308933e99ee3e0d92aae42b33834f20f50a/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=e1a29308933e99ee3e0d92aae42b33834f20f50a",
            "patch": "@@ -461,6 +461,19 @@ export class _ParseAST {\n     if (artificialEndIndex !== undefined && artificialEndIndex > this.currentEndIndex) {\n       endIndex = artificialEndIndex;\n     }\n+\n+    // In some unusual parsing scenarios (like when certain tokens are missing and an `EmptyExpr` is\n+    // being created), the current token may already be advanced beyond the `currentEndIndex`. This\n+    // appears to be a deep-seated parser bug.\n+    //\n+    // As a workaround for now, swap the start and end indices to ensure a valid `ParseSpan`.\n+    // TODO(alxhub): fix the bug upstream in the parser state, and remove this workaround.\n+    if (start > endIndex) {\n+      const tmp = endIndex;\n+      endIndex = start;\n+      start = tmp;\n+    }\n+\n     return new ParseSpan(start, endIndex);\n   }\n "
        },
        {
            "sha": "5e9b149c83522faffaa8100b8e56953d2f562ee4",
            "filename": "packages/compiler/test/expression_parser/parser_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e1a29308933e99ee3e0d92aae42b33834f20f50a/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e1a29308933e99ee3e0d92aae42b33834f20f50a/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts?ref=e1a29308933e99ee3e0d92aae42b33834f20f50a",
            "patch": "@@ -188,6 +188,13 @@ describe('parser', () => {\n         checkAction('a.add(1, 2)');\n         checkAction('fn().add(1, 2)');\n       });\n+\n+      it('should parse an EmptyExpr with a correct span for a trailing empty argument', () => {\n+        const ast = parseAction('fn(1, )').ast as MethodCall;\n+        expect(ast.args[1]).toBeAnInstanceOf(EmptyExpr);\n+        const sourceSpan = (ast.args[1] as EmptyExpr).sourceSpan;\n+        expect([sourceSpan.start, sourceSpan.end]).toEqual([5, 6]);\n+      });\n     });\n \n     describe('functional calls', () => {"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 20,
        "deletions": 0
    }
}