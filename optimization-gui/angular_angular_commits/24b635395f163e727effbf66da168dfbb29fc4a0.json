{
    "author": "petebacondarwin",
    "message": "fix(ngcc): ensure that ngcc does not write a lock-file into node_modules package directories (#44228)\n\nWhen executing, ngcc writes a lock-file that is used to coordinate multiple concurrent instances of ngcc.\nPreviously, this file was written at `node_modules/@angular/compiler-cli/ngcc`, or similar depending upon the bundling of the package.\nBut this causes problems for setups where `node_modules` package directories are expected to be read-only.\nNow, the lock-file is written as `.ngcc_lock_file` into the top of the `node_modules`, which is an acceptable place to store transient files.\n\nThis change should help to unblock use of tools like pnpm and lerna, which can use symlinks to readonly package directories.\n\nPR Close #44228",
    "sha": "24b635395f163e727effbf66da168dfbb29fc4a0",
    "files": [
        {
            "sha": "bc8e35dde06847db92ff678ebc8e219941ed1cfb",
            "filename": "integration/ngcc/test.sh",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/24b635395f163e727effbf66da168dfbb29fc4a0/integration%2Fngcc%2Ftest.sh",
            "raw_url": "https://github.com/angular/angular/raw/24b635395f163e727effbf66da168dfbb29fc4a0/integration%2Fngcc%2Ftest.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fngcc%2Ftest.sh?ref=24b635395f163e727effbf66da168dfbb29fc4a0",
            "patch": "@@ -209,7 +209,7 @@ ngcc --formats fesm2015\n assertFailed \"Expected 'ngcc --formats fesm2015' to fail (since '--formats' is deprecated).\"\n \n # Does it timeout if there is another ngcc process running\n-LOCKFILE=node_modules/@angular/compiler-cli/bundles/ngcc/__ngcc_lock_file__\n+LOCKFILE=node_modules/.ngcc_lock_file\n touch $LOCKFILE\n trap \"[[ -f $LOCKFILE ]] && rm $LOCKFILE\" EXIT\n ngcc"
        },
        {
            "sha": "d16d5d4306155d16c696044b97c6ca8a1bee17ed",
            "filename": "packages/compiler-cli/ngcc/src/locking/lock_file.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file.ts?ref=24b635395f163e727effbf66da168dfbb29fc4a0",
            "patch": "@@ -19,8 +19,8 @@ export function getLockFilePath(fs: PathManipulation) {\n   // allows us to have a consistent position for the lock file to reside. We are unable to rely\n   // on `__dirname` (or equivalent) as this code is being bundled and different entry-points\n   // will have dedicated bundles where the lock file location would differ then.\n-  const ngccEntryPointFile = requireFn.resolve('@angular/compiler-cli/ngcc');\n-  return fs.resolve(ngccEntryPointFile, '../__ngcc_lock_file__');\n+  const ngccEntryPointFile = requireFn.resolve('@angular/compiler-cli/package.json');\n+  return fs.resolve(ngccEntryPointFile, '../../../.ngcc_lock_file');\n }\n \n export interface LockFile {"
        },
        {
            "sha": "a776c0248423eb34b6dbe5a6390037aa9644274d",
            "filename": "packages/compiler-cli/ngcc/test/helpers/utils.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts?ref=24b635395f163e727effbf66da168dfbb29fc4a0",
            "patch": "@@ -119,3 +119,18 @@ var __assign${suffix} = null;\n export function getRootFiles(testFiles: TestFile[]): AbsoluteFsPath[] {\n   return testFiles.filter(f => f.isRoot !== false).map(f => absoluteFrom(f.name));\n }\n+\n+/**\n+ * Mock out the lockfile path resolution, which uses `require.resolve()`.\n+ */\n+export function mockRequireResolveForLockfile() {\n+  const moduleConstructor: any = module.constructor;\n+  const originalResolveFileName = moduleConstructor._resolveFilename;\n+  spyOn<any>(moduleConstructor, '_resolveFilename').and.callFake(function(request: string) {\n+    if (request === '@angular/compiler-cli/package.json') {\n+      return '/node_modules/' + request;\n+    } else {\n+      return originalResolveFileName.apply(null, arguments as any);\n+    }\n+  });\n+}"
        },
        {
            "sha": "9b5abf01c185f19c3c8ff0b7a9466a7395a8157d",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=24b635395f163e727effbf66da168dfbb29fc4a0",
            "patch": "@@ -22,6 +22,7 @@ import {EntryPointJsonProperty, EntryPointPackageJson, SUPPORTED_FORMAT_PROPERTI\n import {EntryPointManifestFile} from '../../src/packages/entry_point_manifest';\n import {Transformer} from '../../src/packages/transformer';\n import {DirectPackageJsonUpdater, PackageJsonUpdater} from '../../src/writing/package_json_updater';\n+import {mockRequireResolveForLockfile} from '../helpers/utils';\n \n import {compileIntoApf, compileIntoFlatEs2015Package, compileIntoFlatEs5Package, loadNgccIntegrationTestFiles} from './util';\n \n@@ -46,6 +47,7 @@ runInEachFileSystem(() => {\n       _ = absoluteFrom;\n       fs = getFileSystem();\n       pkgJsonUpdater = new DirectPackageJsonUpdater(fs);\n+      mockRequireResolveForLockfile();\n       initMockFileSystem(fs, testFiles);\n \n       // Force single-process execution in unit tests by mocking available CPUs to 1."
        },
        {
            "sha": "95b84b9a42f4c5c0f4829ac59e724c8ee2ba1099",
            "filename": "packages/compiler-cli/ngcc/test/locking/lockfile_with_child_process/index_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Flocking%2Flockfile_with_child_process%2Findex_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b635395f163e727effbf66da168dfbb29fc4a0/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Flocking%2Flockfile_with_child_process%2Findex_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Flocking%2Flockfile_with_child_process%2Findex_spec.ts?ref=24b635395f163e727effbf66da168dfbb29fc4a0",
            "patch": "@@ -13,6 +13,7 @@ import {runInEachFileSystem} from '../../../../src/ngtsc/file_system/testing';\n import {MockLogger} from '../../../../src/ngtsc/logging/testing';\n import {getLockFilePath} from '../../../src/locking/lock_file';\n import {LockFileWithChildProcess} from '../../../src/locking/lock_file_with_child_process';\n+import {mockRequireResolveForLockfile} from '../../helpers/utils';\n \n runInEachFileSystem(() => {\n   describe('LockFileWithChildProcess', () => {\n@@ -55,6 +56,10 @@ runInEachFileSystem(() => {\n       }\n     }\n \n+    beforeEach(() => {\n+      mockRequireResolveForLockfile();\n+    });\n+\n     describe('constructor', () => {\n       it('should create the unlocker process', () => {\n         const fs = getFileSystem();"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 25,
        "deletions": 3
    }
}