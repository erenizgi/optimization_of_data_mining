{
    "author": "devversion",
    "message": "refactor(dev-infra): improve type-safety of git client utility (#42468)\n\nCurrently the `GitClient` accepts a generic parameter for determining\nwhether the `githubToken` should be set or not. This worked fine so far\nin terms of distinguishing between an authenticated and\nnon-authenticated git client instance, but if we intend to conditionally\nshow methods only for authenticated instances, the generic parameter\nis not suitable.\n\nThis commit splits up the `GitClient` into two classes. One for\nthe base logic without any authorization, and a second class that\nextends the base logic with authentication logic. i.e. the\n`AuthenticatedGitClient`. This allows us to have specific methods only\nfor the authenticated instance. e.g.\n\n  * `hasOauthScopes` has been moved to only exist for authenticated\n    instances.\n  * the GraphQL functionality within `gitClient.github` is not\n    accessible for non-authenticated instances. GraphQL API requires\n    authentication as per Github.\n\nThe initial motiviation for this was that we want to throw if\n`hasOAuthScopes` is called without the Octokit instance having\na token configured. This should help avoiding issues as within\nhttps://github.com/angular/angular/commit/3b434ed94d9ed067e5d999c064ae5f12b3cb175c\nthat prevented the caretaker process momentarily.\n\nAdditionally, the Git client has moved from `index.ts` to\n`git-client.ts` for better discoverability in the codebase.\n\nPR Close #42468",
    "sha": "67f65a9d2581b70300c609b665e5d582d296eedf",
    "files": [
        {
            "sha": "b67a0c4746e9328a9de1bf1d13f795ddc58f34b5",
            "filename": "dev-infra/build-worker.js",
            "status": "modified",
            "additions": 80,
            "deletions": 176,
            "changes": 256,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fbuild-worker.js",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fbuild-worker.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbuild-worker.js?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -3,7 +3,7 @@\n var tslib = require('tslib');\n var fs = require('fs');\n var path = require('path');\n-var chalk = require('chalk');\n+require('chalk');\n require('inquirer');\n var child_process = require('child_process');\n var semver = require('semver');\n@@ -54,61 +54,50 @@ var GithubApiRequestError = /** @class */ (function (_super) {\n     }\n     return GithubApiRequestError;\n }(Error));\n-/** Error for failed Github API requests. */\n-var GithubGraphqlClientError = /** @class */ (function (_super) {\n-    tslib.__extends(GithubGraphqlClientError, _super);\n-    function GithubGraphqlClientError() {\n-        return _super !== null && _super.apply(this, arguments) || this;\n-    }\n-    return GithubGraphqlClientError;\n-}(Error));\n-/**\n- * A Github client for interacting with the Github APIs.\n- *\n- * Additionally, provides convenience methods for actions which require multiple requests, or\n- * would provide value from memoized style responses.\n- **/\n+/** A Github client for interacting with the Github APIs. */\n var GithubClient = /** @class */ (function () {\n-    /**\n-     * @param token The github authentication token for Github Rest and Graphql API requests.\n-     */\n-    function GithubClient(token) {\n-        this.token = token;\n-        /** The graphql instance with authentication set during construction. */\n-        this._graphql = graphql.graphql.defaults({ headers: { authorization: \"token \" + this.token } });\n-        /** The Octokit instance actually performing API requests. */\n-        this._octokit = new rest.Octokit({ auth: this.token });\n+    function GithubClient(_octokitOptions) {\n+        this._octokitOptions = _octokitOptions;\n+        /** The octokit instance actually performing API requests. */\n+        this._octokit = new rest.Octokit(this._octokitOptions);\n         this.pulls = this._octokit.pulls;\n         this.repos = this._octokit.repos;\n         this.issues = this._octokit.issues;\n         this.git = this._octokit.git;\n         this.paginate = this._octokit.paginate;\n         this.rateLimit = this._octokit.rateLimit;\n-        this._octokit.hook.error('request', function (error) {\n-            // Wrap API errors in a known error class. This allows us to\n-            // expect Github API errors better and in a non-ambiguous way.\n-            throw new GithubApiRequestError(error.status, error.message);\n-        });\n+    }\n+    return GithubClient;\n+}());\n+/**\n+ * Extension of the `GithubClient` that provides utilities which are specific\n+ * to authenticated instances.\n+ */\n+var AuthenticatedGithubClient = /** @class */ (function (_super) {\n+    tslib.__extends(AuthenticatedGithubClient, _super);\n+    function AuthenticatedGithubClient(_token) {\n+        var _this = \n+        // Set the token for the octokit instance.\n+        _super.call(this, { auth: _token }) || this;\n+        _this._token = _token;\n+        /** The graphql instance with authentication set during construction. */\n+        _this._graphql = graphql.graphql.defaults({ headers: { authorization: \"token \" + _this._token } });\n+        return _this;\n     }\n     /** Perform a query using Github's Graphql API. */\n-    GithubClient.prototype.graphql = function (queryObject, params) {\n+    AuthenticatedGithubClient.prototype.graphql = function (queryObject, params) {\n         if (params === void 0) { params = {}; }\n         return tslib.__awaiter(this, void 0, void 0, function () {\n             return tslib.__generator(this, function (_a) {\n                 switch (_a.label) {\n-                    case 0:\n-                        if (this.token === undefined) {\n-                            throw new GithubGraphqlClientError('Cannot query via graphql without an authentication token set, use the authenticated ' +\n-                                '`GitClient` by calling `GitClient.getAuthenticatedInstance()`.');\n-                        }\n-                        return [4 /*yield*/, this._graphql(typedGraphqlify.query(queryObject).toString(), params)];\n+                    case 0: return [4 /*yield*/, this._graphql(typedGraphqlify.query(queryObject).toString(), params)];\n                     case 1: return [2 /*return*/, (_a.sent())];\n                 }\n             });\n         });\n     };\n-    return GithubClient;\n-}());\n+    return AuthenticatedGithubClient;\n+}(GithubClient));\n \n /**\n  * @license\n@@ -117,10 +106,6 @@ var GithubClient = /** @class */ (function () {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-/** URL to the Github page where personal access tokens can be managed. */\n-var GITHUB_TOKEN_SETTINGS_URL = 'https://github.com/settings/tokens';\n-/** URL to the Github page where personal access tokens can be generated. */\n-var GITHUB_TOKEN_GENERATE_URL = 'https://github.com/settings/tokens/new';\n /** Adds the provided token to the given Github HTTPs remote url. */\n function addTokenToGitHttpsUrl(githubHttpsUrl, token) {\n     var url$1 = new url.URL(githubHttpsUrl);\n@@ -154,80 +139,30 @@ var GitCommandError = /** @class */ (function (_super) {\n         // Errors are not guaranteed to be caught. To ensure that we don't\n         // accidentally leak the Github token that might be used in a command,\n         // we sanitize the command that will be part of the error message.\n-        _super.call(this, \"Command failed: git \" + client.omitGithubTokenFromMessage(args.join(' '))) || this;\n+        _super.call(this, \"Command failed: git \" + client.sanitizeConsoleOutput(args.join(' '))) || this;\n         _this.args = args;\n         return _this;\n     }\n     return GitCommandError;\n }(Error));\n-/**\n- * Common client for performing Git interactions with a given remote.\n- *\n- * Takes in two optional arguments:\n- *   `githubToken`: the token used for authentication in Github interactions, by default empty\n- *     allowing readonly actions.\n- *   `config`: The dev-infra configuration containing information about the remote. By default\n- *     the dev-infra configuration is loaded with its Github configuration.\n- **/\n+/** Class that can be used to perform Git interactions with a given remote. **/\n var GitClient = /** @class */ (function () {\n-    /**\n-     * @param githubToken The github token used for authentication, if provided.\n-     * @param config The configuration, containing the github specific configuration.\n-     * @param baseDir The full path to the root of the repository base.\n-     */\n-    function GitClient(githubToken, config, baseDir) {\n-        this.githubToken = githubToken;\n-        /** The OAuth scopes available for the provided Github token. */\n-        this._cachedOauthScopes = null;\n-        /**\n-         * Regular expression that matches the provided Github token. Used for\n-         * sanitizing the token from Git child process output.\n-         */\n-        this._githubTokenRegex = null;\n-        /** Instance of the Github octokit API. */\n-        this.github = new GithubClient(this.githubToken);\n-        this.baseDir = baseDir || this.determineBaseDir();\n-        this.config = config || getConfig(this.baseDir);\n+    function GitClient(\n+    /** The full path to the root of the repository base. */\n+    baseDir, \n+    /** The configuration, containing the github specific configuration. */\n+    config) {\n+        if (baseDir === void 0) { baseDir = determineRepoBaseDirFromCwd(); }\n+        if (config === void 0) { config = getConfig(baseDir); }\n+        this.baseDir = baseDir;\n+        this.config = config;\n+        /** Short-hand for accessing the default remote configuration. */\n         this.remoteConfig = this.config.github;\n+        /** Octokit request parameters object for targeting the configured remote. */\n         this.remoteParams = { owner: this.remoteConfig.owner, repo: this.remoteConfig.name };\n-        // If a token has been specified (and is not empty), pass it to the Octokit API and\n-        // also create a regular expression that can be used for sanitizing Git command output\n-        // so that it does not print the token accidentally.\n-        if (typeof githubToken === 'string') {\n-            this._githubTokenRegex = new RegExp(githubToken, 'g');\n-        }\n+        /** Instance of the Github client. */\n+        this.github = new GithubClient();\n     }\n-    /**\n-     * Static method to get the singleton instance of the unauthorized GitClient, creating it if it\n-     * has not yet been created.\n-     */\n-    GitClient.getInstance = function () {\n-        if (!GitClient.unauthenticated) {\n-            GitClient.unauthenticated = new GitClient(undefined);\n-        }\n-        return GitClient.unauthenticated;\n-    };\n-    /**\n-     * Static method to get the singleton instance of the authenticated GitClient if it has been\n-     * generated.\n-     */\n-    GitClient.getAuthenticatedInstance = function () {\n-        if (!GitClient.authenticated) {\n-            throw Error('The authenticated GitClient has not yet been generated.');\n-        }\n-        return GitClient.authenticated;\n-    };\n-    /** Build the authenticated GitClient instance. */\n-    GitClient.authenticateWithToken = function (token) {\n-        if (GitClient.authenticated) {\n-            throw Error('Cannot generate new authenticated GitClient after one has already been generated.');\n-        }\n-        GitClient.authenticated = new GitClient(token);\n-    };\n-    /** Set the verbose logging state of the GitClient class. */\n-    GitClient.setVerboseLoggingState = function (verbose) {\n-        this.verboseLogging = verbose;\n-    };\n     /** Executes the given git command. Throws if the command fails. */\n     GitClient.prototype.run = function (args, options) {\n         var result = this.runGraceful(args, options);\n@@ -252,13 +187,14 @@ var GitClient = /** @class */ (function () {\n             throw new DryRunError();\n         }\n         // To improve the debugging experience in case something fails, we print all executed Git\n-        // commands at the DEBUG level to better understand the git actions occuring. Verbose logging,\n+        // commands at the DEBUG level to better understand the git actions occurring. Verbose logging,\n         // always logging at the INFO level, can be enabled either by setting the verboseLogging\n         // property on the GitClient class or the options object provided to the method.\n         var printFn = (GitClient.verboseLogging || options.verboseLogging) ? info : debug;\n-        // Note that we do not want to print the token if it is contained in the command. It's common\n-        // to share errors with others if the tool failed, and we do not want to leak tokens.\n-        printFn('Executing: git', this.omitGithubTokenFromMessage(args.join(' ')));\n+        // Note that we sanitize the command before printing it to the console. We do not want to\n+        // print an access token if it is contained in the command. It's common to share errors with\n+        // others if the tool failed, and we do not want to leak tokens.\n+        printFn('Executing: git', this.sanitizeConsoleOutput(args.join(' ')));\n         var result = child_process.spawnSync('git', args, tslib.__assign(tslib.__assign({ cwd: this.baseDir, stdio: 'pipe' }, options), { \n             // Encoding is always `utf8` and not overridable. This ensures that this method\n             // always returns `string` as output instead of buffers.\n@@ -267,13 +203,13 @@ var GitClient = /** @class */ (function () {\n             // Git sometimes prints the command if it failed. This means that it could\n             // potentially leak the Github token used for accessing the remote. To avoid\n             // printing a token, we sanitize the string before printing the stderr output.\n-            process.stderr.write(this.omitGithubTokenFromMessage(result.stderr));\n+            process.stderr.write(this.sanitizeConsoleOutput(result.stderr));\n         }\n         return result;\n     };\n     /** Git URL that resolves to the configured repository. */\n     GitClient.prototype.getRepoGitUrl = function () {\n-        return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n+        return getRepositoryGitUrl(this.remoteConfig);\n     };\n     /** Whether the given branch contains the specified SHA. */\n     GitClient.prototype.hasCommit = function (branchName, sha) {\n@@ -294,15 +230,6 @@ var GitClient = /** @class */ (function () {\n     GitClient.prototype.hasUncommittedChanges = function () {\n         return this.runGraceful(['diff-index', '--quiet', 'HEAD']).status !== 0;\n     };\n-    /** Sanitizes a given message by omitting the provided Github token if present. */\n-    GitClient.prototype.omitGithubTokenFromMessage = function (value) {\n-        // If no token has been defined (i.e. no token regex), we just return the\n-        // value as is. There is no secret value that needs to be omitted.\n-        if (this._githubTokenRegex === null) {\n-            return value;\n-        }\n-        return value.replace(this._githubTokenRegex, '<TOKEN>');\n-    };\n     /**\n      * Checks out a requested branch or revision, optionally cleaning the state of the repository\n      * before attempting the checking. Returns a boolean indicating whether the branch or revision\n@@ -331,7 +258,7 @@ var GitClient = /** @class */ (function () {\n         }\n         return new semver.SemVer(latestTag, semVerOptions);\n     };\n-    /** Retrieve a list of all files in the repostitory changed since the provided shaOrRef. */\n+    /** Retrieve a list of all files in the repository changed since the provided shaOrRef. */\n     GitClient.prototype.allChangesFilesSince = function (shaOrRef) {\n         if (shaOrRef === void 0) { shaOrRef = 'HEAD'; }\n         return Array.from(new Set(tslib.__spreadArray(tslib.__spreadArray([], tslib.__read(gitOutputAsArray(this.runGraceful(['diff', '--name-only', '--diff-filter=d', shaOrRef])))), tslib.__read(gitOutputAsArray(this.runGraceful(['ls-files', '--others', '--exclude-standard']))))));\n@@ -340,71 +267,38 @@ var GitClient = /** @class */ (function () {\n     GitClient.prototype.allStagedFiles = function () {\n         return gitOutputAsArray(this.runGraceful(['diff', '--name-only', '--diff-filter=ACM', '--staged']));\n     };\n-    /** Retrieve a list of all files tracked in the repostitory. */\n+    /** Retrieve a list of all files tracked in the repository. */\n     GitClient.prototype.allFiles = function () {\n         return gitOutputAsArray(this.runGraceful(['ls-files']));\n     };\n     /**\n-     * Assert the GitClient instance is using a token with permissions for the all of the\n-     * provided OAuth scopes.\n+     * Sanitizes the given console message. This method can be overridden by\n+     * derived classes. e.g. to sanitize access tokens from Git commands.\n      */\n-    GitClient.prototype.hasOauthScopes = function (testFn) {\n-        return tslib.__awaiter(this, void 0, void 0, function () {\n-            var scopes, missingScopes, error;\n-            return tslib.__generator(this, function (_a) {\n-                switch (_a.label) {\n-                    case 0: return [4 /*yield*/, this.getAuthScopesForToken()];\n-                    case 1:\n-                        scopes = _a.sent();\n-                        missingScopes = [];\n-                        // Test Github OAuth scopes and collect missing ones.\n-                        testFn(scopes, missingScopes);\n-                        // If no missing scopes are found, return true to indicate all OAuth Scopes are available.\n-                        if (missingScopes.length === 0) {\n-                            return [2 /*return*/, true];\n-                        }\n-                        error = \"The provided <TOKEN> does not have required permissions due to missing scope(s): \" +\n-                            (yellow(missingScopes.join(', ')) + \"\\n\\n\") +\n-                            \"Update the token in use at:\\n\" +\n-                            (\"  \" + GITHUB_TOKEN_SETTINGS_URL + \"\\n\\n\") +\n-                            (\"Alternatively, a new token can be created at: \" + GITHUB_TOKEN_GENERATE_URL + \"\\n\");\n-                        return [2 /*return*/, { error: error }];\n-                }\n-            });\n-        });\n+    GitClient.prototype.sanitizeConsoleOutput = function (value) {\n+        return value;\n     };\n-    /**\n-     * Retrieve the OAuth scopes for the loaded Github token.\n-     **/\n-    GitClient.prototype.getAuthScopesForToken = function () {\n-        // If the OAuth scopes have already been loaded, return the Promise containing them.\n-        if (this._cachedOauthScopes !== null) {\n-            return this._cachedOauthScopes;\n-        }\n-        // OAuth scopes are loaded via the /rate_limit endpoint to prevent\n-        // usage of a request against that rate_limit for this lookup.\n-        return this._cachedOauthScopes = this.github.rateLimit.get().then(function (_response) {\n-            var response = _response;\n-            var scopes = response.headers['x-oauth-scopes'] || '';\n-            return scopes.split(',').map(function (scope) { return scope.trim(); });\n-        });\n+    /** Set the verbose logging state of all git client instances. */\n+    GitClient.setVerboseLoggingState = function (verbose) {\n+        GitClient.verboseLogging = verbose;\n     };\n-    GitClient.prototype.determineBaseDir = function () {\n-        var _a = this.runGraceful(['rev-parse', '--show-toplevel']), stdout = _a.stdout, stderr = _a.stderr, status = _a.status;\n-        if (status !== 0) {\n-            throw Error(\"Unable to find the path to the base directory of the repository.\\n\" +\n-                \"Was the command run from inside of the repo?\\n\\n\" +\n-                (\"ERROR:\\n \" + stderr));\n+    /**\n+     * Static method to get the singleton instance of the `GitClient`, creating it\n+     * if it has not yet been created.\n+     */\n+    GitClient.get = function () {\n+        if (!this._unauthenticatedInstance) {\n+            GitClient._unauthenticatedInstance = new GitClient();\n         }\n-        return stdout.trim();\n+        return GitClient._unauthenticatedInstance;\n     };\n     /** Whether verbose logging of Git actions should be used. */\n     GitClient.verboseLogging = false;\n     return GitClient;\n }());\n /**\n- * Takes the output from `GitClient.run` and `GitClient.runGraceful` and returns an array of strings\n- * for each new line. Git commands typically return multiple output values for a command a set of\n+ * Takes the output from `run` and `runGraceful` and returns an array of strings for each\n+ * new line. Git commands typically return multiple output values for a command a set of\n  * strings separated by new lines.\n  *\n  * Note: This is specifically created as a locally available function for usage as convenience\n@@ -413,6 +307,17 @@ var GitClient = /** @class */ (function () {\n function gitOutputAsArray(gitCommandResult) {\n     return gitCommandResult.stdout.split('\\n').map(function (x) { return x.trim(); }).filter(function (x) { return !!x; });\n }\n+/** Determines the repository base directory from the current working directory. */\n+function determineRepoBaseDirFromCwd() {\n+    // TODO(devversion): Replace with common spawn sync utility once available.\n+    var _a = child_process.spawnSync('git', ['rev-parse --show-toplevel'], { shell: true, stdio: 'pipe', encoding: 'utf8' }), stdout = _a.stdout, stderr = _a.stderr, status = _a.status;\n+    if (status !== 0) {\n+        throw Error(\"Unable to find the path to the base directory of the repository.\\n\" +\n+            \"Was the command run from inside of the repo?\\n\\n\" +\n+            (\"\" + stderr));\n+    }\n+    return stdout.trim();\n+}\n \n /**\n  * @license\n@@ -421,7 +326,6 @@ function gitOutputAsArray(gitCommandResult) {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-var yellow = chalk.yellow;\n /**\n  * Supported levels for logging functions.\n  *\n@@ -552,7 +456,7 @@ var cachedConfig = null;\n function getConfig(baseDir) {\n     // If the global config is not defined, load it from the file system.\n     if (cachedConfig === null) {\n-        baseDir = baseDir || GitClient.getInstance().baseDir;\n+        baseDir = baseDir || GitClient.get().baseDir;\n         // The full path to the configuration file.\n         var configPath = path.join(baseDir, CONFIG_FILE_PATH);\n         // Read the configuration and validate it before caching it for the future."
        },
        {
            "sha": "61ca5bbccbf858066ecc56e68b06c0442277ff38",
            "filename": "dev-infra/caretaker/check/base.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fbase.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fbase.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -5,14 +5,15 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+\n import {NgDevConfig} from '../../utils/config';\n-import {GitClient} from '../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {CaretakerConfig} from '../config';\n \n /** The BaseModule to extend modules for caretaker checks from. */\n export abstract class BaseModule<Data> {\n-  /** The singleton instance of the GitClient. */\n-  protected git = GitClient.getAuthenticatedInstance();\n+  /** The singleton instance of the authenticated git client. */\n+  protected git = AuthenticatedGitClient.get();\n   /** The data for the module. */\n   readonly data = this.retrieveData();\n "
        },
        {
            "sha": "bd3483d485564b71a3ab76a85bf1ce891977f1e1",
            "filename": "dev-infra/caretaker/check/g3.spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fg3.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fg3.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fg3.spec.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -9,7 +9,7 @@\n import {SpawnSyncReturns} from 'child_process';\n \n import * as console from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n import {installVirtualGitClientSpies, mockNgDevConfig} from '../../utils/testing';\n \n import {G3Module, G3StatsData} from './g3';"
        },
        {
            "sha": "faefc9bd9f8a395a5816f75c9d63b716693426b9",
            "filename": "dev-infra/caretaker/check/g3.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fg3.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fg3.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fg3.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,7 +10,7 @@ import {existsSync, readFileSync} from 'fs';\n import * as multimatch from 'multimatch';\n import {join} from 'path';\n import {parse as parseYaml} from 'yaml';\n-import {bold, debug, error, info} from '../../utils/console';\n+import {bold, debug, info} from '../../utils/console';\n \n import {BaseModule} from './base';\n "
        },
        {
            "sha": "08af371533bc910b313dbcc86c03259d21ea5743",
            "filename": "dev-infra/caretaker/check/github.spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcaretaker%2Fcheck%2Fgithub.spec.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -7,7 +7,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as console from '../../utils/console';\n-import {GithubClient} from '../../utils/git/github';\n+import {AuthenticatedGithubClient, GithubClient} from '../../utils/git/github';\n import {installVirtualGitClientSpies, mockNgDevConfig} from '../../utils/testing';\n \n import {GithubQueriesModule} from './github';\n@@ -18,7 +18,7 @@ describe('GithubQueriesModule', () => {\n   let infoGroupSpy: jasmine.Spy;\n \n   beforeEach(() => {\n-    githubApiSpy = spyOn(GithubClient.prototype, 'graphql')\n+    githubApiSpy = spyOn(AuthenticatedGithubClient.prototype, 'graphql')\n                        .and.throwError(\n                            'The graphql query response must always be manually defined in a test.');\n     installVirtualGitClientSpies();"
        },
        {
            "sha": "31358459ddcfd60fe53f195d4cccae2120dbb55d",
            "filename": "dev-infra/commit-message/validate-file/validate-file.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcommit-message%2Fvalidate-file%2Fvalidate-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fcommit-message%2Fvalidate-file%2Fvalidate-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-file%2Fvalidate-file.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -9,14 +9,14 @@ import {readFileSync} from 'fs';\n import {resolve} from 'path';\n \n import {error, green, info, log, red, yellow} from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n \n import {deleteCommitMessageDraft, saveCommitMessageDraft} from '../restore-commit-message/commit-message-draft';\n import {printValidationErrors, validateCommitMessage} from '../validate';\n \n /** Validate commit message at the provided file path. */\n export function validateFile(filePath: string, isErrorMode: boolean) {\n-  const git = GitClient.getInstance();\n+  const git = GitClient.get();\n   const commitMessage = readFileSync(resolve(git.baseDir, filePath), 'utf8');\n   const {valid, errors} = validateCommitMessage(commitMessage);\n   if (valid) {"
        },
        {
            "sha": "47261b58aea6d2cc241c7b8a939ff1df69e900f5",
            "filename": "dev-infra/format/cli.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fformat%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fformat%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fformat%2Fcli.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as yargs from 'yargs';\n-import {GitClient} from '../utils/git/index';\n+import {GitClient} from '../utils/git/git-client';\n \n import {checkFiles, formatFiles} from './format';\n \n@@ -24,7 +24,7 @@ export function buildFormatParser(localYargs: yargs.Argv) {\n           'all', 'Run the formatter on all files in the repository', args => args,\n           ({check}) => {\n             const executionCmd = check ? checkFiles : formatFiles;\n-            const allFiles = GitClient.getInstance().allFiles();\n+            const allFiles = GitClient.get().allFiles();\n             executionCmd(allFiles);\n           })\n       .command(\n@@ -33,14 +33,14 @@ export function buildFormatParser(localYargs: yargs.Argv) {\n           ({shaOrRef, check}) => {\n             const sha = shaOrRef || 'master';\n             const executionCmd = check ? checkFiles : formatFiles;\n-            const allChangedFilesSince = GitClient.getInstance().allChangesFilesSince(sha);\n+            const allChangedFilesSince = GitClient.get().allChangesFilesSince(sha);\n             executionCmd(allChangedFilesSince);\n           })\n       .command(\n           'staged', 'Run the formatter on all staged files', args => args,\n           ({check}) => {\n             const executionCmd = check ? checkFiles : formatFiles;\n-            const allStagedFiles = GitClient.getInstance().allStagedFiles();\n+            const allStagedFiles = GitClient.get().allStagedFiles();\n             executionCmd(allStagedFiles);\n           })\n       .command("
        },
        {
            "sha": "24ba0fa516619654a7750940f3f2cfff8d26a8f3",
            "filename": "dev-infra/format/formatters/base-formatter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fformat%2Fformatters%2Fbase-formatter.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fformat%2Fformatters%2Fbase-formatter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fformat%2Fformatters%2Fbase-formatter.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n import {FormatConfig} from '../config';\n \n // A callback to determine if the formatter run found a failure in formatting.\n@@ -25,7 +25,7 @@ interface FormatterActionMetadata {\n  * The base class for formatters to run against provided files.\n  */\n export abstract class Formatter {\n-  protected git = GitClient.getInstance();\n+  protected git = GitClient.get();\n   /**\n    * The name of the formatter, this is used for identification in logging and for enabling and\n    * configuring the formatter in the config."
        },
        {
            "sha": "5bb1d3044a10f4450930bf2f0b377da51cb652e0",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 211,
            "deletions": 198,
            "changes": 409,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -71,7 +71,7 @@ var userConfig = null;\n function getConfig(baseDir) {\n     // If the global config is not defined, load it from the file system.\n     if (cachedConfig === null) {\n-        baseDir = baseDir || GitClient.getInstance().baseDir;\n+        baseDir = baseDir || GitClient.get().baseDir;\n         // The full path to the configuration file.\n         var configPath = path.join(baseDir, CONFIG_FILE_PATH);\n         // Read the configuration and validate it before caching it for the future.\n@@ -164,7 +164,7 @@ function assertNoErrors(errors) {\n function getUserConfig() {\n     // If the global config is not defined, load it from the file system.\n     if (userConfig === null) {\n-        var git = GitClient.getInstance();\n+        var git = GitClient.get();\n         // The full path to the configuration file.\n         var configPath = path.join(git.baseDir, USER_CONFIG_FILE_PATH);\n         // Set the global config object.\n@@ -217,61 +217,50 @@ var GithubApiRequestError = /** @class */ (function (_super) {\n     }\n     return GithubApiRequestError;\n }(Error));\n-/** Error for failed Github API requests. */\n-var GithubGraphqlClientError = /** @class */ (function (_super) {\n-    tslib.__extends(GithubGraphqlClientError, _super);\n-    function GithubGraphqlClientError() {\n-        return _super !== null && _super.apply(this, arguments) || this;\n-    }\n-    return GithubGraphqlClientError;\n-}(Error));\n-/**\n- * A Github client for interacting with the Github APIs.\n- *\n- * Additionally, provides convenience methods for actions which require multiple requests, or\n- * would provide value from memoized style responses.\n- **/\n+/** A Github client for interacting with the Github APIs. */\n var GithubClient = /** @class */ (function () {\n-    /**\n-     * @param token The github authentication token for Github Rest and Graphql API requests.\n-     */\n-    function GithubClient(token) {\n-        this.token = token;\n-        /** The graphql instance with authentication set during construction. */\n-        this._graphql = graphql.graphql.defaults({ headers: { authorization: \"token \" + this.token } });\n-        /** The Octokit instance actually performing API requests. */\n-        this._octokit = new rest.Octokit({ auth: this.token });\n+    function GithubClient(_octokitOptions) {\n+        this._octokitOptions = _octokitOptions;\n+        /** The octokit instance actually performing API requests. */\n+        this._octokit = new rest.Octokit(this._octokitOptions);\n         this.pulls = this._octokit.pulls;\n         this.repos = this._octokit.repos;\n         this.issues = this._octokit.issues;\n         this.git = this._octokit.git;\n         this.paginate = this._octokit.paginate;\n         this.rateLimit = this._octokit.rateLimit;\n-        this._octokit.hook.error('request', function (error) {\n-            // Wrap API errors in a known error class. This allows us to\n-            // expect Github API errors better and in a non-ambiguous way.\n-            throw new GithubApiRequestError(error.status, error.message);\n-        });\n+    }\n+    return GithubClient;\n+}());\n+/**\n+ * Extension of the `GithubClient` that provides utilities which are specific\n+ * to authenticated instances.\n+ */\n+var AuthenticatedGithubClient = /** @class */ (function (_super) {\n+    tslib.__extends(AuthenticatedGithubClient, _super);\n+    function AuthenticatedGithubClient(_token) {\n+        var _this = \n+        // Set the token for the octokit instance.\n+        _super.call(this, { auth: _token }) || this;\n+        _this._token = _token;\n+        /** The graphql instance with authentication set during construction. */\n+        _this._graphql = graphql.graphql.defaults({ headers: { authorization: \"token \" + _this._token } });\n+        return _this;\n     }\n     /** Perform a query using Github's Graphql API. */\n-    GithubClient.prototype.graphql = function (queryObject, params) {\n+    AuthenticatedGithubClient.prototype.graphql = function (queryObject, params) {\n         if (params === void 0) { params = {}; }\n         return tslib.__awaiter(this, void 0, void 0, function () {\n             return tslib.__generator(this, function (_a) {\n                 switch (_a.label) {\n-                    case 0:\n-                        if (this.token === undefined) {\n-                            throw new GithubGraphqlClientError('Cannot query via graphql without an authentication token set, use the authenticated ' +\n-                                '`GitClient` by calling `GitClient.getAuthenticatedInstance()`.');\n-                        }\n-                        return [4 /*yield*/, this._graphql(typedGraphqlify.query(queryObject).toString(), params)];\n+                    case 0: return [4 /*yield*/, this._graphql(typedGraphqlify.query(queryObject).toString(), params)];\n                     case 1: return [2 /*return*/, (_a.sent())];\n                 }\n             });\n         });\n     };\n-    return GithubClient;\n-}());\n+    return AuthenticatedGithubClient;\n+}(GithubClient));\n \n /**\n  * @license\n@@ -322,80 +311,30 @@ var GitCommandError = /** @class */ (function (_super) {\n         // Errors are not guaranteed to be caught. To ensure that we don't\n         // accidentally leak the Github token that might be used in a command,\n         // we sanitize the command that will be part of the error message.\n-        _super.call(this, \"Command failed: git \" + client.omitGithubTokenFromMessage(args.join(' '))) || this;\n+        _super.call(this, \"Command failed: git \" + client.sanitizeConsoleOutput(args.join(' '))) || this;\n         _this.args = args;\n         return _this;\n     }\n     return GitCommandError;\n }(Error));\n-/**\n- * Common client for performing Git interactions with a given remote.\n- *\n- * Takes in two optional arguments:\n- *   `githubToken`: the token used for authentication in Github interactions, by default empty\n- *     allowing readonly actions.\n- *   `config`: The dev-infra configuration containing information about the remote. By default\n- *     the dev-infra configuration is loaded with its Github configuration.\n- **/\n+/** Class that can be used to perform Git interactions with a given remote. **/\n var GitClient = /** @class */ (function () {\n-    /**\n-     * @param githubToken The github token used for authentication, if provided.\n-     * @param config The configuration, containing the github specific configuration.\n-     * @param baseDir The full path to the root of the repository base.\n-     */\n-    function GitClient(githubToken, config, baseDir) {\n-        this.githubToken = githubToken;\n-        /** The OAuth scopes available for the provided Github token. */\n-        this._cachedOauthScopes = null;\n-        /**\n-         * Regular expression that matches the provided Github token. Used for\n-         * sanitizing the token from Git child process output.\n-         */\n-        this._githubTokenRegex = null;\n-        /** Instance of the Github octokit API. */\n-        this.github = new GithubClient(this.githubToken);\n-        this.baseDir = baseDir || this.determineBaseDir();\n-        this.config = config || getConfig(this.baseDir);\n+    function GitClient(\n+    /** The full path to the root of the repository base. */\n+    baseDir, \n+    /** The configuration, containing the github specific configuration. */\n+    config) {\n+        if (baseDir === void 0) { baseDir = determineRepoBaseDirFromCwd(); }\n+        if (config === void 0) { config = getConfig(baseDir); }\n+        this.baseDir = baseDir;\n+        this.config = config;\n+        /** Short-hand for accessing the default remote configuration. */\n         this.remoteConfig = this.config.github;\n+        /** Octokit request parameters object for targeting the configured remote. */\n         this.remoteParams = { owner: this.remoteConfig.owner, repo: this.remoteConfig.name };\n-        // If a token has been specified (and is not empty), pass it to the Octokit API and\n-        // also create a regular expression that can be used for sanitizing Git command output\n-        // so that it does not print the token accidentally.\n-        if (typeof githubToken === 'string') {\n-            this._githubTokenRegex = new RegExp(githubToken, 'g');\n-        }\n+        /** Instance of the Github client. */\n+        this.github = new GithubClient();\n     }\n-    /**\n-     * Static method to get the singleton instance of the unauthorized GitClient, creating it if it\n-     * has not yet been created.\n-     */\n-    GitClient.getInstance = function () {\n-        if (!GitClient.unauthenticated) {\n-            GitClient.unauthenticated = new GitClient(undefined);\n-        }\n-        return GitClient.unauthenticated;\n-    };\n-    /**\n-     * Static method to get the singleton instance of the authenticated GitClient if it has been\n-     * generated.\n-     */\n-    GitClient.getAuthenticatedInstance = function () {\n-        if (!GitClient.authenticated) {\n-            throw Error('The authenticated GitClient has not yet been generated.');\n-        }\n-        return GitClient.authenticated;\n-    };\n-    /** Build the authenticated GitClient instance. */\n-    GitClient.authenticateWithToken = function (token) {\n-        if (GitClient.authenticated) {\n-            throw Error('Cannot generate new authenticated GitClient after one has already been generated.');\n-        }\n-        GitClient.authenticated = new GitClient(token);\n-    };\n-    /** Set the verbose logging state of the GitClient class. */\n-    GitClient.setVerboseLoggingState = function (verbose) {\n-        this.verboseLogging = verbose;\n-    };\n     /** Executes the given git command. Throws if the command fails. */\n     GitClient.prototype.run = function (args, options) {\n         var result = this.runGraceful(args, options);\n@@ -420,13 +359,14 @@ var GitClient = /** @class */ (function () {\n             throw new DryRunError();\n         }\n         // To improve the debugging experience in case something fails, we print all executed Git\n-        // commands at the DEBUG level to better understand the git actions occuring. Verbose logging,\n+        // commands at the DEBUG level to better understand the git actions occurring. Verbose logging,\n         // always logging at the INFO level, can be enabled either by setting the verboseLogging\n         // property on the GitClient class or the options object provided to the method.\n         var printFn = (GitClient.verboseLogging || options.verboseLogging) ? info : debug;\n-        // Note that we do not want to print the token if it is contained in the command. It's common\n-        // to share errors with others if the tool failed, and we do not want to leak tokens.\n-        printFn('Executing: git', this.omitGithubTokenFromMessage(args.join(' ')));\n+        // Note that we sanitize the command before printing it to the console. We do not want to\n+        // print an access token if it is contained in the command. It's common to share errors with\n+        // others if the tool failed, and we do not want to leak tokens.\n+        printFn('Executing: git', this.sanitizeConsoleOutput(args.join(' ')));\n         var result = child_process.spawnSync('git', args, tslib.__assign(tslib.__assign({ cwd: this.baseDir, stdio: 'pipe' }, options), { \n             // Encoding is always `utf8` and not overridable. This ensures that this method\n             // always returns `string` as output instead of buffers.\n@@ -435,13 +375,13 @@ var GitClient = /** @class */ (function () {\n             // Git sometimes prints the command if it failed. This means that it could\n             // potentially leak the Github token used for accessing the remote. To avoid\n             // printing a token, we sanitize the string before printing the stderr output.\n-            process.stderr.write(this.omitGithubTokenFromMessage(result.stderr));\n+            process.stderr.write(this.sanitizeConsoleOutput(result.stderr));\n         }\n         return result;\n     };\n     /** Git URL that resolves to the configured repository. */\n     GitClient.prototype.getRepoGitUrl = function () {\n-        return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n+        return getRepositoryGitUrl(this.remoteConfig);\n     };\n     /** Whether the given branch contains the specified SHA. */\n     GitClient.prototype.hasCommit = function (branchName, sha) {\n@@ -462,15 +402,6 @@ var GitClient = /** @class */ (function () {\n     GitClient.prototype.hasUncommittedChanges = function () {\n         return this.runGraceful(['diff-index', '--quiet', 'HEAD']).status !== 0;\n     };\n-    /** Sanitizes a given message by omitting the provided Github token if present. */\n-    GitClient.prototype.omitGithubTokenFromMessage = function (value) {\n-        // If no token has been defined (i.e. no token regex), we just return the\n-        // value as is. There is no secret value that needs to be omitted.\n-        if (this._githubTokenRegex === null) {\n-            return value;\n-        }\n-        return value.replace(this._githubTokenRegex, '<TOKEN>');\n-    };\n     /**\n      * Checks out a requested branch or revision, optionally cleaning the state of the repository\n      * before attempting the checking. Returns a boolean indicating whether the branch or revision\n@@ -499,7 +430,7 @@ var GitClient = /** @class */ (function () {\n         }\n         return new semver.SemVer(latestTag, semVerOptions);\n     };\n-    /** Retrieve a list of all files in the repostitory changed since the provided shaOrRef. */\n+    /** Retrieve a list of all files in the repository changed since the provided shaOrRef. */\n     GitClient.prototype.allChangesFilesSince = function (shaOrRef) {\n         if (shaOrRef === void 0) { shaOrRef = 'HEAD'; }\n         return Array.from(new Set(tslib.__spreadArray(tslib.__spreadArray([], tslib.__read(gitOutputAsArray(this.runGraceful(['diff', '--name-only', '--diff-filter=d', shaOrRef])))), tslib.__read(gitOutputAsArray(this.runGraceful(['ls-files', '--others', '--exclude-standard']))))));\n@@ -508,71 +439,38 @@ var GitClient = /** @class */ (function () {\n     GitClient.prototype.allStagedFiles = function () {\n         return gitOutputAsArray(this.runGraceful(['diff', '--name-only', '--diff-filter=ACM', '--staged']));\n     };\n-    /** Retrieve a list of all files tracked in the repostitory. */\n+    /** Retrieve a list of all files tracked in the repository. */\n     GitClient.prototype.allFiles = function () {\n         return gitOutputAsArray(this.runGraceful(['ls-files']));\n     };\n     /**\n-     * Assert the GitClient instance is using a token with permissions for the all of the\n-     * provided OAuth scopes.\n+     * Sanitizes the given console message. This method can be overridden by\n+     * derived classes. e.g. to sanitize access tokens from Git commands.\n      */\n-    GitClient.prototype.hasOauthScopes = function (testFn) {\n-        return tslib.__awaiter(this, void 0, void 0, function () {\n-            var scopes, missingScopes, error;\n-            return tslib.__generator(this, function (_a) {\n-                switch (_a.label) {\n-                    case 0: return [4 /*yield*/, this.getAuthScopesForToken()];\n-                    case 1:\n-                        scopes = _a.sent();\n-                        missingScopes = [];\n-                        // Test Github OAuth scopes and collect missing ones.\n-                        testFn(scopes, missingScopes);\n-                        // If no missing scopes are found, return true to indicate all OAuth Scopes are available.\n-                        if (missingScopes.length === 0) {\n-                            return [2 /*return*/, true];\n-                        }\n-                        error = \"The provided <TOKEN> does not have required permissions due to missing scope(s): \" +\n-                            (yellow(missingScopes.join(', ')) + \"\\n\\n\") +\n-                            \"Update the token in use at:\\n\" +\n-                            (\"  \" + GITHUB_TOKEN_SETTINGS_URL + \"\\n\\n\") +\n-                            (\"Alternatively, a new token can be created at: \" + GITHUB_TOKEN_GENERATE_URL + \"\\n\");\n-                        return [2 /*return*/, { error: error }];\n-                }\n-            });\n-        });\n+    GitClient.prototype.sanitizeConsoleOutput = function (value) {\n+        return value;\n+    };\n+    /** Set the verbose logging state of all git client instances. */\n+    GitClient.setVerboseLoggingState = function (verbose) {\n+        GitClient.verboseLogging = verbose;\n     };\n     /**\n-     * Retrieve the OAuth scopes for the loaded Github token.\n-     **/\n-    GitClient.prototype.getAuthScopesForToken = function () {\n-        // If the OAuth scopes have already been loaded, return the Promise containing them.\n-        if (this._cachedOauthScopes !== null) {\n-            return this._cachedOauthScopes;\n+     * Static method to get the singleton instance of the `GitClient`, creating it\n+     * if it has not yet been created.\n+     */\n+    GitClient.get = function () {\n+        if (!this._unauthenticatedInstance) {\n+            GitClient._unauthenticatedInstance = new GitClient();\n         }\n-        // OAuth scopes are loaded via the /rate_limit endpoint to prevent\n-        // usage of a request against that rate_limit for this lookup.\n-        return this._cachedOauthScopes = this.github.rateLimit.get().then(function (_response) {\n-            var response = _response;\n-            var scopes = response.headers['x-oauth-scopes'] || '';\n-            return scopes.split(',').map(function (scope) { return scope.trim(); });\n-        });\n-    };\n-    GitClient.prototype.determineBaseDir = function () {\n-        var _a = this.runGraceful(['rev-parse', '--show-toplevel']), stdout = _a.stdout, stderr = _a.stderr, status = _a.status;\n-        if (status !== 0) {\n-            throw Error(\"Unable to find the path to the base directory of the repository.\\n\" +\n-                \"Was the command run from inside of the repo?\\n\\n\" +\n-                (\"ERROR:\\n \" + stderr));\n-        }\n-        return stdout.trim();\n+        return GitClient._unauthenticatedInstance;\n     };\n     /** Whether verbose logging of Git actions should be used. */\n     GitClient.verboseLogging = false;\n     return GitClient;\n }());\n /**\n- * Takes the output from `GitClient.run` and `GitClient.runGraceful` and returns an array of strings\n- * for each new line. Git commands typically return multiple output values for a command a set of\n+ * Takes the output from `run` and `runGraceful` and returns an array of strings for each\n+ * new line. Git commands typically return multiple output values for a command a set of\n  * strings separated by new lines.\n  *\n  * Note: This is specifically created as a locally available function for usage as convenience\n@@ -581,6 +479,17 @@ var GitClient = /** @class */ (function () {\n function gitOutputAsArray(gitCommandResult) {\n     return gitCommandResult.stdout.split('\\n').map(function (x) { return x.trim(); }).filter(function (x) { return !!x; });\n }\n+/** Determines the repository base directory from the current working directory. */\n+function determineRepoBaseDirFromCwd() {\n+    // TODO(devversion): Replace with common spawn sync utility once available.\n+    var _a = child_process.spawnSync('git', ['rev-parse --show-toplevel'], { shell: true, stdio: 'pipe', encoding: 'utf8' }), stdout = _a.stdout, stderr = _a.stderr, status = _a.status;\n+    if (status !== 0) {\n+        throw Error(\"Unable to find the path to the base directory of the repository.\\n\" +\n+            \"Was the command run from inside of the repo?\\n\\n\" +\n+            (\"\" + stderr));\n+    }\n+    return stdout.trim();\n+}\n \n /**\n  * @license\n@@ -726,7 +635,7 @@ function captureLogOutputForCommand(argv) {\n     if (FILE_LOGGING_ENABLED) {\n         throw Error('`captureLogOutputForCommand` cannot be called multiple times');\n     }\n-    var git = GitClient.getInstance();\n+    var git = GitClient.get();\n     /** The date time used for timestamping when the command was invoked. */\n     var now = new Date();\n     /** Header line to separate command runs in log files. */\n@@ -763,6 +672,103 @@ function printToLogFile(logLevel) {\n     LOGGED_TEXT += text.join(' ').split('\\n').map(function (l) { return logLevelText + \" \" + l + \"\\n\"; }).join('');\n }\n \n+/**\n+ * Extension of the `GitClient` with additional utilities which are useful for\n+ * authenticated Git client instances.\n+ */\n+var AuthenticatedGitClient = /** @class */ (function (_super) {\n+    tslib.__extends(AuthenticatedGitClient, _super);\n+    function AuthenticatedGitClient(githubToken, baseDir, config) {\n+        var _this = _super.call(this, baseDir, config) || this;\n+        _this.githubToken = githubToken;\n+        /**\n+         * Regular expression that matches the provided Github token. Used for\n+         * sanitizing the token from Git child process output.\n+         */\n+        _this._githubTokenRegex = new RegExp(_this.githubToken, 'g');\n+        /** The OAuth scopes available for the provided Github token. */\n+        _this._cachedOauthScopes = null;\n+        /** Instance of an authenticated github client. */\n+        _this.github = new AuthenticatedGithubClient(_this.githubToken);\n+        return _this;\n+    }\n+    /** Sanitizes a given message by omitting the provided Github token if present. */\n+    AuthenticatedGitClient.prototype.sanitizeConsoleOutput = function (value) {\n+        return value.replace(this._githubTokenRegex, '<TOKEN>');\n+    };\n+    /** Git URL that resolves to the configured repository. */\n+    AuthenticatedGitClient.prototype.getRepoGitUrl = function () {\n+        return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n+    };\n+    /**\n+     * Assert the GitClient instance is using a token with permissions for the all of the\n+     * provided OAuth scopes.\n+     */\n+    AuthenticatedGitClient.prototype.hasOauthScopes = function (testFn) {\n+        return tslib.__awaiter(this, void 0, void 0, function () {\n+            var scopes, missingScopes, error;\n+            return tslib.__generator(this, function (_a) {\n+                switch (_a.label) {\n+                    case 0: return [4 /*yield*/, this._fetchAuthScopesForToken()];\n+                    case 1:\n+                        scopes = _a.sent();\n+                        missingScopes = [];\n+                        // Test Github OAuth scopes and collect missing ones.\n+                        testFn(scopes, missingScopes);\n+                        // If no missing scopes are found, return true to indicate all OAuth Scopes are available.\n+                        if (missingScopes.length === 0) {\n+                            return [2 /*return*/, true];\n+                        }\n+                        error = \"The provided <TOKEN> does not have required permissions due to missing scope(s): \" +\n+                            (yellow(missingScopes.join(', ')) + \"\\n\\n\") +\n+                            \"Update the token in use at:\\n\" +\n+                            (\"  \" + GITHUB_TOKEN_SETTINGS_URL + \"\\n\\n\") +\n+                            (\"Alternatively, a new token can be created at: \" + GITHUB_TOKEN_GENERATE_URL + \"\\n\");\n+                        return [2 /*return*/, { error: error }];\n+                }\n+            });\n+        });\n+    };\n+    /** Fetch the OAuth scopes for the loaded Github token. */\n+    AuthenticatedGitClient.prototype._fetchAuthScopesForToken = function () {\n+        // If the OAuth scopes have already been loaded, return the Promise containing them.\n+        if (this._cachedOauthScopes !== null) {\n+            return this._cachedOauthScopes;\n+        }\n+        // OAuth scopes are loaded via the /rate_limit endpoint to prevent\n+        // usage of a request against that rate_limit for this lookup.\n+        return this._cachedOauthScopes = this.github.rateLimit.get().then(function (_response) {\n+            var response = _response;\n+            var scopes = response.headers['x-oauth-scopes'];\n+            // If no token is provided, or if the Github client is authenticated incorrectly,\n+            // the `x-oauth-scopes` response header is not set. We error in such cases as it\n+            // signifies a faulty  of the\n+            if (scopes === undefined) {\n+                throw Error('Unable to retrieve OAuth scopes for token provided to Git client.');\n+            }\n+            return scopes.split(',').map(function (scope) { return scope.trim(); }).filter(function (scope) { return scope !== ''; });\n+        });\n+    };\n+    /**\n+     * Static method to get the singleton instance of the `AuthenticatedGitClient`,\n+     * creating it if it has not yet been created.\n+     */\n+    AuthenticatedGitClient.get = function () {\n+        if (!AuthenticatedGitClient._authenticatedInstance) {\n+            throw new Error('No instance of `AuthenticatedGitClient` has been set up yet.');\n+        }\n+        return AuthenticatedGitClient._authenticatedInstance;\n+    };\n+    /** Configures an authenticated git client. */\n+    AuthenticatedGitClient.configure = function (token) {\n+        if (AuthenticatedGitClient._authenticatedInstance) {\n+            throw Error('Unable to configure `AuthenticatedGitClient` as it has been configured already.');\n+        }\n+        AuthenticatedGitClient._authenticatedInstance = new AuthenticatedGitClient(token);\n+    };\n+    return AuthenticatedGitClient;\n+}(GitClient));\n+\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -774,7 +780,7 @@ function printToLogFile(logLevel) {\n function addGithubTokenOption(yargs) {\n     return yargs\n         // 'github-token' is casted to 'githubToken' to properly set up typings to reflect the key in\n-        // the Argv object being camelCase rather than kebob case due to the `camel-case-expansion`\n+        // the Argv object being camelCase rather than kebab case due to the `camel-case-expansion`\n         // config: https://github.com/yargs/yargs-parser#camel-case-expansion\n         .option('github-token', {\n         type: 'string',\n@@ -788,10 +794,10 @@ function addGithubTokenOption(yargs) {\n                 process.exit(1);\n             }\n             try {\n-                GitClient.getAuthenticatedInstance();\n+                AuthenticatedGitClient.get();\n             }\n             catch (_a) {\n-                GitClient.authenticateWithToken(githubToken);\n+                AuthenticatedGitClient.configure(githubToken);\n             }\n             return githubToken;\n         },\n@@ -1128,12 +1134,19 @@ function getLtsNpmDistTagOfMajor(major) {\n     return `v${major}-lts`;\n }\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n /** The BaseModule to extend modules for caretaker checks from. */\n class BaseModule {\n     constructor(config) {\n         this.config = config;\n-        /** The singleton instance of the GitClient. */\n-        this.git = GitClient.getAuthenticatedInstance();\n+        /** The singleton instance of the authenticated git client. */\n+        this.git = AuthenticatedGitClient.get();\n         /** The data for the module. */\n         this.data = this.retrieveData();\n     }\n@@ -2053,7 +2066,7 @@ function printValidationErrors(errors, print = error) {\n  */\n /** Validate commit message at the provided file path. */\n function validateFile(filePath, isErrorMode) {\n-    const git = GitClient.getInstance();\n+    const git = GitClient.get();\n     const commitMessage = fs.readFileSync(path.resolve(git.baseDir, filePath), 'utf8');\n     const { valid, errors } = validateCommitMessage(commitMessage);\n     if (valid) {\n@@ -2308,7 +2321,7 @@ function checkFormatterConfig(key, config, errors) {\n class Formatter {\n     constructor(config) {\n         this.config = config;\n-        this.git = GitClient.getInstance();\n+        this.git = GitClient.get();\n     }\n     /**\n      * Retrieve the command to execute the provided action, including both the binary\n@@ -2684,18 +2697,18 @@ function buildFormatParser(localYargs) {\n     })\n         .command('all', 'Run the formatter on all files in the repository', args => args, ({ check }) => {\n         const executionCmd = check ? checkFiles : formatFiles;\n-        const allFiles = GitClient.getInstance().allFiles();\n+        const allFiles = GitClient.get().allFiles();\n         executionCmd(allFiles);\n     })\n         .command('changed [shaOrRef]', 'Run the formatter on files changed since the provided sha/ref', args => args.positional('shaOrRef', { type: 'string' }), ({ shaOrRef, check }) => {\n         const sha = shaOrRef || 'master';\n         const executionCmd = check ? checkFiles : formatFiles;\n-        const allChangedFilesSince = GitClient.getInstance().allChangesFilesSince(sha);\n+        const allChangedFilesSince = GitClient.get().allChangesFilesSince(sha);\n         executionCmd(allChangedFilesSince);\n     })\n         .command('staged', 'Run the formatter on all staged files', args => args, ({ check }) => {\n         const executionCmd = check ? checkFiles : formatFiles;\n-        const allStagedFiles = GitClient.getInstance().allStagedFiles();\n+        const allStagedFiles = GitClient.get().allStagedFiles();\n         executionCmd(allStagedFiles);\n     })\n         .command('files <files..>', 'Run the formatter on provided files', args => args.positional('files', { array: true, type: 'string' }), ({ check, files }) => {\n@@ -2712,7 +2725,7 @@ function buildFormatParser(localYargs) {\n  * found in the LICENSE file at https://angular.io/license\n  */\n function verify() {\n-    const git = GitClient.getInstance();\n+    const git = GitClient.get();\n     /** Full path to NgBot config file */\n     const NGBOT_CONFIG_YAML_PATH = path.resolve(git.baseDir, '.github/angular-robot.yml');\n     /** The NgBot config file */\n@@ -2902,7 +2915,7 @@ function getTargetBranchesForPr(prNumber) {\n         /** Repo owner and name for the github repository. */\n         const { owner, name: repo } = config.github;\n         /** The singleton instance of the GitClient. */\n-        const git = GitClient.getInstance();\n+        const git = GitClient.get();\n         /** The validated merge config. */\n         const { config: mergeConfig, errors } = yield loadAndValidateConfig(config, git.github);\n         if (errors !== undefined) {\n@@ -3102,8 +3115,8 @@ class MaintainerModifyAccessError extends Error {\n  */\n function checkOutPullRequestLocally(prNumber, githubToken, opts = {}) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        /** The singleton instance of the GitClient. */\n-        const git = GitClient.getAuthenticatedInstance();\n+        /** The singleton instance of the authenticated git client. */\n+        const git = AuthenticatedGitClient.get();\n         // In order to preserve local changes, checkouts cannot occur if local changes are present in the\n         // git environment. Checked before retrieving the PR to fail fast.\n         if (git.hasUncommittedChanges()) {\n@@ -3242,8 +3255,8 @@ const tempWorkingBranch = '__NgDevRepoBaseAfterChange__';\n /** Checks if the provided PR will cause new conflicts in other pending PRs. */\n function discoverNewConflictsForPr(newPrNumber, updatedAfter) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        /** The singleton instance of the GitClient. */\n-        const git = GitClient.getAuthenticatedInstance();\n+        /** The singleton instance of the authenticated git client. */\n+        const git = AuthenticatedGitClient.get();\n         // If there are any local changes in the current repository state, the\n         // check cannot run as it needs to move between branches.\n         if (git.hasUncommittedChanges()) {\n@@ -4477,7 +4490,7 @@ function createPullRequestMergeTask(flags) {\n             switch (_b.label) {\n                 case 0:\n                     devInfraConfig = getConfig();\n-                    git = GitClient.getAuthenticatedInstance();\n+                    git = AuthenticatedGitClient.get();\n                     return [4 /*yield*/, loadAndValidateConfig(devInfraConfig, git.github)];\n                 case 1:\n                     _a = _b.sent(), config = _a.config, errors = _a.errors;\n@@ -4576,8 +4589,8 @@ const PR_SCHEMA$3 = {\n  */\n function rebasePr(prNumber, githubToken, config = getConfig()) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        /** The singleton instance of the GitClient. */\n-        const git = GitClient.getAuthenticatedInstance();\n+        /** The singleton instance of the authenticated git client. */\n+        const git = AuthenticatedGitClient.get();\n         if (git.hasUncommittedChanges()) {\n             error('Cannot perform rebase of PR with local changes.');\n             process.exit(1);\n@@ -5015,7 +5028,7 @@ function getGroupsFromYaml(pullApproveYamlRaw) {\n  * found in the LICENSE file at https://angular.io/license\n  */\n function verify$1() {\n-    const git = GitClient.getInstance();\n+    const git = GitClient.get();\n     /** Full path to PullApprove config file */\n     const PULL_APPROVE_YAML_PATH = path.resolve(git.baseDir, '.pullapprove.yml');\n     /** All tracked files in the repository. */\n@@ -5524,7 +5537,7 @@ class ReleaseNotes {\n         this.startingRef = startingRef;\n         this.endingRef = endingRef;\n         /** An instance of GitClient. */\n-        this.git = GitClient.getInstance();\n+        this.git = GitClient.get();\n         /** A promise resolving to a list of Commits since the latest semver tag on the branch. */\n         this.commits = this.getCommitsInRange(this.startingRef, this.endingRef);\n         /** The configuration for release notes. */\n@@ -5630,7 +5643,7 @@ function handler$8({ releaseVersion, from, to, outFile, type }) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         // Since `yargs` evaluates defaults even if a value as been provided, if no value is provided to\n         // the handler, the latest semver tag on the branch is used.\n-        from = from || GitClient.getInstance().getLatestSemverTag().format();\n+        from = from || GitClient.get().getLatestSemverTag().format();\n         /** The ReleaseNotes instance to generate release notes. */\n         const releaseNotes = yield ReleaseNotes.fromRange(releaseVersion, from, to);\n         /** The requested release notes entry. */\n@@ -7085,8 +7098,8 @@ class ReleaseTool {\n         this._config = _config;\n         this._github = _github;\n         this._projectRoot = _projectRoot;\n-        /** The singleton instance of the GitClient. */\n-        this._git = GitClient.getAuthenticatedInstance();\n+        /** The singleton instance of the authenticated git client. */\n+        this._git = AuthenticatedGitClient.get();\n         /** The previous git commit to return back to after the release tool runs. */\n         this.previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n     }\n@@ -7279,7 +7292,7 @@ function builder$9(argv) {\n /** Yargs command handler for staging a release. */\n function handler$9() {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const git = GitClient.getInstance();\n+        const git = GitClient.get();\n         const config = getConfig();\n         const releaseConfig = getReleaseConfig(config);\n         const projectDir = git.baseDir;\n@@ -7409,7 +7422,7 @@ function hasLocalChanges() {\n  */\n function getSCMVersion(mode) {\n     if (mode === 'release') {\n-        const git = GitClient.getInstance();\n+        const git = GitClient.get();\n         const packageJsonPath = path.join(git.baseDir, 'package.json');\n         const { version } = require(packageJsonPath);\n         return version;"
        },
        {
            "sha": "af9e559efcb6cb63c6689072f5be0d9b2ccbfe2b",
            "filename": "dev-infra/ngbot/verify.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fngbot%2Fverify.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fngbot%2Fverify.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fngbot%2Fverify.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,10 +10,10 @@ import {resolve} from 'path';\n import {parse as parseYaml} from 'yaml';\n \n import {error, green, info, red} from '../utils/console';\n-import {GitClient} from '../utils/git/index';\n+import {GitClient} from '../utils/git/git-client';\n \n export function verify() {\n-  const git = GitClient.getInstance();\n+  const git = GitClient.get();\n   /** Full path to NgBot config file */\n   const NGBOT_CONFIG_YAML_PATH = resolve(git.baseDir, '.github/angular-robot.yml');\n "
        },
        {
            "sha": "ae6b0283ab9a432db7d28b3356f3cb2f0d64dfb6",
            "filename": "dev-infra/pr/check-target-branches/check-target-branches.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheck-target-branches%2Fcheck-target-branches.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -8,7 +8,7 @@\n \n import {getConfig} from '../../utils/config';\n import {error, info, red} from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n import {loadAndValidateConfig, TargetLabel} from '../merge/config';\n import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest, InvalidTargetLabelError} from '../merge/target-label';\n \n@@ -18,7 +18,7 @@ export async function getTargetBranchesForPr(prNumber: number) {\n   /** Repo owner and name for the github repository. */\n   const {owner, name: repo} = config.github;\n   /** The singleton instance of the GitClient. */\n-  const git = GitClient.getInstance();\n+  const git = GitClient.get();\n   /** The validated merge config. */\n   const {config: mergeConfig, errors} = await loadAndValidateConfig(config, git.github);\n   if (errors !== undefined) {"
        },
        {
            "sha": "10d1d6cd597c63f1839b56a11e4bec806fe7ed76",
            "filename": "dev-infra/pr/common/checkout-pr.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -9,8 +9,8 @@\n import {types as graphqlTypes} from 'typed-graphqlify';\n \n import {info} from '../../utils/console';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n-import {GitClient} from '../../utils/git/index';\n import {getPr} from '../../utils/github';\n \n /* Graphql schema for the response body for a pending PR. */\n@@ -62,8 +62,8 @@ export interface PullRequestCheckoutOptions {\n  */\n export async function checkOutPullRequestLocally(\n     prNumber: number, githubToken: string, opts: PullRequestCheckoutOptions = {}) {\n-  /** The singleton instance of the GitClient. */\n-  const git = GitClient.getAuthenticatedInstance();\n+  /** The singleton instance of the authenticated git client. */\n+  const git = AuthenticatedGitClient.get();\n \n   // In order to preserve local changes, checkouts cannot occur if local changes are present in the\n   // git environment. Checked before retrieving the PR to fail fast."
        },
        {
            "sha": "b164155566a33f626ef8efea27f92eada9961504",
            "filename": "dev-infra/pr/discover-new-conflicts/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,7 +10,8 @@ import {Bar} from 'cli-progress';\n import {types as graphqlTypes} from 'typed-graphqlify';\n \n import {error, info} from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n+import {GitClient} from '../../utils/git/git-client';\n import {getPendingPrs} from '../../utils/github';\n import {exec} from '../../utils/shelljs';\n \n@@ -53,8 +54,8 @@ const tempWorkingBranch = '__NgDevRepoBaseAfterChange__';\n \n /** Checks if the provided PR will cause new conflicts in other pending PRs. */\n export async function discoverNewConflictsForPr(newPrNumber: number, updatedAfter: number) {\n-  /** The singleton instance of the GitClient. */\n-  const git = GitClient.getAuthenticatedInstance();\n+  /** The singleton instance of the authenticated git client. */\n+  const git = AuthenticatedGitClient.get();\n   // If there are any local changes in the current repository state, the\n   // check cannot run as it needs to move between branches.\n   if (git.hasUncommittedChanges()) {"
        },
        {
            "sha": "76feb3db69e4f22cd4a1246b9b906fcae3a2c535",
            "filename": "dev-infra/pr/merge/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Findex.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -9,9 +9,9 @@\n \n import {getConfig} from '../../utils/config';\n import {error, green, info, promptConfirm, red, yellow} from '../../utils/console';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {GithubApiRequestError} from '../../utils/git/github';\n import {GITHUB_TOKEN_GENERATE_URL} from '../../utils/git/github-urls';\n-import {GitClient} from '../../utils/git/index';\n \n import {loadAndValidateConfig, MergeConfigWithRemote} from './config';\n import {MergeResult, MergeStatus, PullRequestMergeTask, PullRequestMergeTaskFlags} from './task';\n@@ -126,8 +126,8 @@ export async function mergePullRequest(prNumber: number, flags: PullRequestMerge\n  */\n async function createPullRequestMergeTask(flags: PullRequestMergeTaskFlags) {\n   const devInfraConfig = getConfig();\n-  /** The singleton instance of the GitClient. */\n-  const git = GitClient.getAuthenticatedInstance();\n+  /** The singleton instance of the authenticated git client. */\n+  const git = AuthenticatedGitClient.get();\n   const {config, errors} = await loadAndValidateConfig(devInfraConfig, git.github);\n \n   if (errors) {"
        },
        {
            "sha": "3137e425f1a38375b7cd9a5a16052d8e20bacb90",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -7,13 +7,13 @@\n  */\n \n import {params, types as graphqlTypes} from 'typed-graphqlify';\n+\n import {Commit, parseCommitMessage} from '../../commit-message/parse';\n import {red, warn} from '../../utils/console';\n-\n-import {GitClient} from '../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {getPr} from '../../utils/github';\n-import {MergeConfig, TargetLabel} from './config';\n \n+import {MergeConfig, TargetLabel} from './config';\n import {PullRequestFailure} from './failures';\n import {matchesPattern} from './string-pattern';\n import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest, InvalidTargetBranchError, InvalidTargetLabelError} from './target-label';\n@@ -168,7 +168,7 @@ type RawPullRequest = typeof PR_SCHEMA;\n \n /** Fetches a pull request from Github. Returns null if an error occurred. */\n async function fetchPullRequestFromGithub(\n-    git: GitClient<true>, prNumber: number): Promise<RawPullRequest|null> {\n+    git: AuthenticatedGitClient, prNumber: number): Promise<RawPullRequest|null> {\n   try {\n     return await getPr(PR_SCHEMA, prNumber, git);\n   } catch (e) {"
        },
        {
            "sha": "2141e6d3430b60928ae686e27072674ba27d67eb",
            "filename": "dev-infra/pr/merge/strategies/api-merge.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,7 +10,8 @@ import {Octokit} from '@octokit/rest';\n import {prompt} from 'inquirer';\n \n import {parseCommitMessage} from '../../../commit-message/parse';\n-import {GitClient} from '../../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../../utils/git/authenticated-git-client';\n+import {GitClient} from '../../../utils/git/git-client';\n import {GithubApiMergeMethod} from '../config';\n import {PullRequestFailure} from '../failures';\n import {PullRequest} from '../pull-request';\n@@ -37,7 +38,7 @@ const COMMIT_HEADER_SEPARATOR = '\\n\\n';\n  * is properly set, but a notable downside is that PRs cannot use fixup or squash commits.\n  */\n export class GithubApiMergeStrategy extends MergeStrategy {\n-  constructor(git: GitClient<true>, private _config: GithubApiMergeStrategyConfig) {\n+  constructor(git: AuthenticatedGitClient, private _config: GithubApiMergeStrategyConfig) {\n     super(git);\n   }\n "
        },
        {
            "sha": "0011b5b2e36021b5698f2b5279c6e1b40307bdb5",
            "filename": "dev-infra/pr/merge/strategies/strategy.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fstrategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fstrategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fstrategy.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {GitClient} from '../../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../../utils/git/authenticated-git-client';\n import {PullRequestFailure} from '../failures';\n import {PullRequest} from '../pull-request';\n \n@@ -22,7 +22,7 @@ export const TEMP_PR_HEAD_BRANCH = 'merge_pr_head';\n  * merges it into the determined target branches.\n  */\n export abstract class MergeStrategy {\n-  constructor(protected git: GitClient<true>) {}\n+  constructor(protected git: AuthenticatedGitClient) {}\n \n   /**\n    * Prepares a merge of the given pull request. The strategy by default will"
        },
        {
            "sha": "2d6ec9c66f31dee48903506ccd68d8f3cafbbce1",
            "filename": "dev-infra/pr/merge/task.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftask.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -7,7 +7,8 @@\n  */\n \n import {promptConfirm} from '../../utils/console';\n-import {GitClient, GitCommandError} from '../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n+import {GitCommandError} from '../../utils/git/git-client';\n \n import {MergeConfigWithRemote} from './config';\n import {PullRequestFailure} from './failures';\n@@ -51,7 +52,7 @@ export class PullRequestMergeTask {\n   private flags: PullRequestMergeTaskFlags;\n \n   constructor(\n-      public config: MergeConfigWithRemote, public git: GitClient<true>,\n+      public config: MergeConfigWithRemote, public git: AuthenticatedGitClient,\n       flags: Partial<PullRequestMergeTaskFlags>) {\n     // Update flags property with the provided flags values as patches to the default flag values.\n     this.flags = {...defaultPullRequestMergeTaskFlags, ...flags};"
        },
        {
            "sha": "b9dbd8517f8f8dd6bf5770cd72766abaa0fa9cbb",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -12,8 +12,8 @@ import {Commit} from '../../commit-message/parse';\n import {getCommitsInRange} from '../../commit-message/utils';\n import {getConfig, NgDevConfig} from '../../utils/config';\n import {error, info, promptConfirm} from '../../utils/console';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {addTokenToGitHttpsUrl} from '../../utils/git/github-urls';\n-import {GitClient} from '../../utils/git/index';\n import {getPr} from '../../utils/github';\n \n /* Graphql schema for the response body for each pending PR. */\n@@ -44,8 +44,8 @@ const PR_SCHEMA = {\n  */\n export async function rebasePr(\n     prNumber: number, githubToken: string, config: Pick<NgDevConfig, 'github'> = getConfig()) {\n-  /** The singleton instance of the GitClient. */\n-  const git = GitClient.getAuthenticatedInstance();\n+  /** The singleton instance of the authenticated git client. */\n+  const git = AuthenticatedGitClient.get();\n   if (git.hasUncommittedChanges()) {\n     error('Cannot perform rebase of PR with local changes.');\n     process.exit(1);"
        },
        {
            "sha": "6b67a9a8f89304855473f1df6696e3e37f1d1d8a",
            "filename": "dev-infra/pullapprove/verify.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpullapprove%2Fverify.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Fpullapprove%2Fverify.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpullapprove%2Fverify.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -9,12 +9,12 @@ import {readFileSync} from 'fs';\n import {resolve} from 'path';\n \n import {debug, info} from '../utils/console';\n-import {GitClient} from '../utils/git/index';\n+import {GitClient} from '../utils/git/git-client';\n import {logGroup, logHeader} from './logging';\n import {getGroupsFromYaml} from './parse-yaml';\n \n export function verify() {\n-  const git = GitClient.getInstance();\n+  const git = GitClient.get();\n   /** Full path to PullApprove config file */\n   const PULL_APPROVE_YAML_PATH = resolve(git.baseDir, '.pullapprove.yml');\n   /** All tracked files in the repository. */"
        },
        {
            "sha": "022a25cfc4f9cf4e84e49457b4a8c1fbe101d2c9",
            "filename": "dev-infra/release/notes/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fnotes%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fnotes%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fnotes%2Fcli.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -12,7 +12,7 @@ import {SemVer} from 'semver';\n import {Arguments, Argv, CommandModule} from 'yargs';\n \n import {debug, info} from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n \n import {ReleaseNotes} from './release-notes';\n \n@@ -58,7 +58,7 @@ function builder(argv: Argv): Argv<ReleaseNotesOptions> {\n async function handler({releaseVersion, from, to, outFile, type}: Arguments<ReleaseNotesOptions>) {\n   // Since `yargs` evaluates defaults even if a value as been provided, if no value is provided to\n   // the handler, the latest semver tag on the branch is used.\n-  from = from || GitClient.getInstance().getLatestSemverTag().format();\n+  from = from || GitClient.get().getLatestSemverTag().format();\n   /** The ReleaseNotes instance to generate release notes. */\n   const releaseNotes = await ReleaseNotes.fromRange(releaseVersion, from, to);\n "
        },
        {
            "sha": "74b46db024e8a4891d3bedb8babdab657e1bc57c",
            "filename": "dev-infra/release/notes/release-notes.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fnotes%2Frelease-notes.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fnotes%2Frelease-notes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fnotes%2Frelease-notes.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -11,7 +11,7 @@ import {CommitFromGitLog} from '../../commit-message/parse';\n \n import {getCommitsInRange} from '../../commit-message/utils';\n import {promptInput} from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n import {DevInfraReleaseConfig, getReleaseConfig, ReleaseNotesConfig} from '../config/index';\n import {RenderContext} from './context';\n \n@@ -25,7 +25,7 @@ export class ReleaseNotes {\n   }\n \n   /** An instance of GitClient. */\n-  private git = GitClient.getInstance();\n+  private git = GitClient.get();\n   /** The RenderContext to be used during rendering. */\n   private renderContext: RenderContext|undefined;\n   /** The title to use for the release. */"
        },
        {
            "sha": "2d94339a2520f770e484d7a16f895259faddef9b",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -12,8 +12,8 @@ import {join} from 'path';\n import * as semver from 'semver';\n \n import {debug, error, green, info, promptConfirm, red, warn, yellow} from '../../utils/console';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {getListCommitsInBranchUrl, getRepositoryGitUrl} from '../../utils/git/github-urls';\n-import {GitClient} from '../../utils/git/index';\n import {BuiltPackage, ReleaseConfig} from '../config/index';\n import {ReleaseNotes} from '../notes/release-notes';\n import {NpmDistTag} from '../versioning';\n@@ -50,7 +50,7 @@ export interface ReleaseActionConstructor<T extends ReleaseAction = ReleaseActio\n   /** Whether the release action is currently active. */\n   isActive(active: ActiveReleaseTrains, config: ReleaseConfig): Promise<boolean>;\n   /** Constructs a release action. */\n-  new(...args: [ActiveReleaseTrains, GitClient<true>, ReleaseConfig, string]): T;\n+  new(...args: [ActiveReleaseTrains, AuthenticatedGitClient, ReleaseConfig, string]): T;\n }\n \n /**\n@@ -77,7 +77,7 @@ export abstract class ReleaseAction {\n   private _cachedForkRepo: GithubRepo|null = null;\n \n   constructor(\n-      protected active: ActiveReleaseTrains, protected git: GitClient<true>,\n+      protected active: ActiveReleaseTrains, protected git: AuthenticatedGitClient,\n       protected config: ReleaseConfig, protected projectDir: string) {}\n \n   /** Updates the version in the project top-level `package.json` file. */"
        },
        {
            "sha": "5a6ec8363d203295ef0b3b2347e684da1de20e27",
            "filename": "dev-infra/release/publish/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fcli.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,8 +10,8 @@ import {Arguments, Argv, CommandModule} from 'yargs';\n \n import {getConfig} from '../../utils/config';\n import {error, green, info, red, yellow} from '../../utils/console';\n+import {GitClient} from '../../utils/git/git-client';\n import {addGithubTokenOption} from '../../utils/git/github-yargs';\n-import {GitClient} from '../../utils/git/index';\n import {getReleaseConfig} from '../config/index';\n \n import {CompletionState, ReleaseTool} from './index';\n@@ -28,7 +28,7 @@ function builder(argv: Argv): Argv<ReleasePublishOptions> {\n \n /** Yargs command handler for staging a release. */\n async function handler() {\n-  const git = GitClient.getInstance();\n+  const git = GitClient.get();\n   const config = getConfig();\n   const releaseConfig = getReleaseConfig(config);\n   const projectDir = git.baseDir;"
        },
        {
            "sha": "e3bc250a28b38ca4e7900f9371c25189c487c94a",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -11,7 +11,7 @@ import {ListChoiceOptions, prompt} from 'inquirer';\n import {spawnWithDebugOutput} from '../../utils/child-process';\n import {GithubConfig} from '../../utils/config';\n import {debug, error, info, log, promptConfirm, red, yellow} from '../../utils/console';\n-import {GitClient} from '../../utils/git/index';\n+import {AuthenticatedGitClient} from '../../utils/git/authenticated-git-client';\n import {ReleaseConfig} from '../config/index';\n import {ActiveReleaseTrains, fetchActiveReleaseTrains, nextBranchName} from '../versioning/active-release-trains';\n import {npmIsLoggedIn, npmLogin, npmLogout} from '../versioning/npm-publish';\n@@ -29,8 +29,8 @@ export enum CompletionState {\n }\n \n export class ReleaseTool {\n-  /** The singleton instance of the GitClient. */\n-  private _git = GitClient.getAuthenticatedInstance();\n+  /** The singleton instance of the authenticated git client. */\n+  private _git = AuthenticatedGitClient.get();\n   /** The previous git commit to return back to after the release tool runs. */\n   private previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n "
        },
        {
            "sha": "85f423124d066f8e04d6ad8aef3721c7966dd2a0",
            "filename": "dev-infra/release/publish/pull-request-state.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fpull-request-state.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Octokit} from '@octokit/rest';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n \n /** Thirty seconds in milliseconds. */\n const THIRTY_SECONDS_IN_MS = 30000;\n@@ -16,8 +16,7 @@ const THIRTY_SECONDS_IN_MS = 30000;\n export type PullRequestState = 'merged'|'closed'|'open';\n \n /** Gets whether a given pull request has been merged. */\n-export async function getPullRequestState(\n-    api: GitClient<boolean>, id: number): Promise<PullRequestState> {\n+export async function getPullRequestState(api: GitClient, id: number): Promise<PullRequestState> {\n   const {data} = await api.github.pulls.get({...api.remoteParams, pull_number: id});\n   if (data.merged) {\n     return 'merged';\n@@ -39,7 +38,7 @@ export async function getPullRequestState(\n  * the merge is not fast-forward, Github does not consider the PR as merged and instead\n  * shows the PR as closed. See for example: https://github.com/angular/angular/pull/37918.\n  */\n-async function isPullRequestClosedWithAssociatedCommit(api: GitClient<boolean>, id: number) {\n+async function isPullRequestClosedWithAssociatedCommit(api: GitClient, id: number) {\n   const request =\n       api.github.issues.listEvents.endpoint.merge({...api.remoteParams, issue_number: id});\n   const events: Octokit.IssuesListEventsResponse = await api.github.paginate(request);\n@@ -73,7 +72,7 @@ async function isPullRequestClosedWithAssociatedCommit(api: GitClient<boolean>,\n }\n \n /** Checks whether the specified commit is closing the given pull request. */\n-async function isCommitClosingPullRequest(api: GitClient<boolean>, sha: string, id: number) {\n+async function isCommitClosingPullRequest(api: GitClient, sha: string, id: number) {\n   const {data} = await api.github.repos.getCommit({...api.remoteParams, ref: sha});\n   // Matches the closing keyword supported in commit messages. See:\n   // https://docs.github.com/en/enterprise/2.16/user/github/managing-your-work-on-github/closing-issues-using-keywords."
        },
        {
            "sha": "43a65eb2323d72947ccec264c8aa3286f321f5cb",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -34,7 +34,7 @@ export const testTmpDir: string = process.env['TEST_TMPDIR']!;\n /** Interface describing a test release action. */\n export interface TestReleaseAction<T extends ReleaseAction = ReleaseAction> {\n   instance: T;\n-  gitClient: VirtualGitClient<boolean>;\n+  gitClient: VirtualGitClient;\n   repo: GithubTestingRepo;\n   fork: GithubTestingRepo;\n   testTmpDir: string;\n@@ -45,7 +45,7 @@ export interface TestReleaseAction<T extends ReleaseAction = ReleaseAction> {\n /** Gets necessary test mocks for running a release action. */\n export function getTestingMocksForReleaseAction() {\n   const githubConfig = {owner: 'angular', name: 'dev-infra-test'};\n-  const gitClient = VirtualGitClient.getAuthenticatedInstance({github: githubConfig});\n+  const gitClient = VirtualGitClient.createInstance({github: githubConfig});\n   const releaseConfig: ReleaseConfig = {\n     npmPackages: [\n       '@angular/pkg1',"
        },
        {
            "sha": "45d5221275bdf5a17e7d1ee7d5a24b823d2055e0",
            "filename": "dev-infra/release/stamping/env-stamp.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {join} from 'path';\n-import {GitClient} from '../../utils/git/index';\n+import {GitClient} from '../../utils/git/git-client';\n \n import {exec as _exec} from '../../utils/shelljs';\n \n@@ -51,7 +51,7 @@ function hasLocalChanges() {\n  */\n function getSCMVersion(mode: EnvStampMode) {\n   if (mode === 'release') {\n-    const git = GitClient.getInstance();\n+    const git = GitClient.get();\n     const packageJsonPath = join(git.baseDir, 'package.json');\n     const {version} = require(packageJsonPath);\n     return version;"
        },
        {
            "sha": "ca9b25e14ff8ecaa546025615623794ec8148bff",
            "filename": "dev-infra/utils/config.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fconfig.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fconfig.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,7 +10,7 @@ import {existsSync} from 'fs';\n import {dirname, join} from 'path';\n \n import {debug, error} from './console';\n-import {GitClient} from './git/index';\n+import {GitClient} from './git/git-client';\n import {isTsNodeAvailable} from './ts-node';\n \n /** Configuration for Git client interactions. */\n@@ -69,7 +69,7 @@ export function getConfig(baseDir?: string): NgDevConfig;\n export function getConfig(baseDir?: string): NgDevConfig {\n   // If the global config is not defined, load it from the file system.\n   if (cachedConfig === null) {\n-    baseDir = baseDir || GitClient.getInstance().baseDir;\n+    baseDir = baseDir || GitClient.get().baseDir;\n     // The full path to the configuration file.\n     const configPath = join(baseDir, CONFIG_FILE_PATH);\n     // Read the configuration and validate it before caching it for the future.\n@@ -154,7 +154,7 @@ export function assertNoErrors(errors: string[]) {\n export function getUserConfig() {\n   // If the global config is not defined, load it from the file system.\n   if (userConfig === null) {\n-    const git = GitClient.getInstance();\n+    const git = GitClient.get();\n     // The full path to the configuration file.\n     const configPath = join(git.baseDir, USER_CONFIG_FILE_PATH);\n     // Set the global config object."
        },
        {
            "sha": "b24f722f75bc7dad86533265fa3fd84c513e069b",
            "filename": "dev-infra/utils/console.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fconsole.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fconsole.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fconsole.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -12,7 +12,7 @@ import {prompt} from 'inquirer';\n import {join} from 'path';\n import {Arguments} from 'yargs';\n \n-import {GitClient} from './git/index';\n+import {GitClient} from './git/git-client';\n \n /** Reexport of chalk colors for convenient access. */\n export const red = chalk.red;\n@@ -144,7 +144,7 @@ export function captureLogOutputForCommand(argv: Arguments) {\n     throw Error('`captureLogOutputForCommand` cannot be called multiple times');\n   }\n \n-  const git = GitClient.getInstance();\n+  const git = GitClient.get();\n   /** The date time used for timestamping when the command was invoked. */\n   const now = new Date();\n   /** Header line to separate command runs in log files. */"
        },
        {
            "sha": "f9bcfbe688743fe9167689272d73b3ee86cfadd4",
            "filename": "dev-infra/utils/git/authenticated-git-client.ts",
            "status": "added",
            "additions": 127,
            "deletions": 0,
            "changes": 127,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fauthenticated-git-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fauthenticated-git-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fauthenticated-git-client.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -0,0 +1,127 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {Octokit} from '@octokit/rest';\n+\n+import {NgDevConfig} from '../config';\n+import {yellow} from '../console';\n+\n+import {GitClient} from './git-client';\n+import {AuthenticatedGithubClient} from './github';\n+import {getRepositoryGitUrl, GITHUB_TOKEN_GENERATE_URL, GITHUB_TOKEN_SETTINGS_URL} from './github-urls';\n+\n+/** Github response type extended to include the `x-oauth-scopes` headers presence. */\n+type RateLimitResponseWithOAuthScopeHeader = Octokit.Response<Octokit.RateLimitGetResponse>&{\n+  headers: {'x-oauth-scopes': string|undefined};\n+};\n+\n+/** Describes a function that can be used to test for given Github OAuth scopes. */\n+export type OAuthScopeTestFunction = (scopes: string[], missing: string[]) => void;\n+\n+/**\n+ * Extension of the `GitClient` with additional utilities which are useful for\n+ * authenticated Git client instances.\n+ */\n+export class AuthenticatedGitClient extends GitClient {\n+  /**\n+   * Regular expression that matches the provided Github token. Used for\n+   * sanitizing the token from Git child process output.\n+   */\n+  private readonly _githubTokenRegex: RegExp = new RegExp(this.githubToken, 'g');\n+\n+  /** The OAuth scopes available for the provided Github token. */\n+  private _cachedOauthScopes: Promise<string[]>|null = null;\n+\n+  /** Instance of an authenticated github client. */\n+  readonly github = new AuthenticatedGithubClient(this.githubToken);\n+\n+  protected constructor(readonly githubToken: string, baseDir?: string, config?: NgDevConfig) {\n+    super(baseDir, config);\n+  }\n+\n+  /** Sanitizes a given message by omitting the provided Github token if present. */\n+  sanitizeConsoleOutput(value: string): string {\n+    return value.replace(this._githubTokenRegex, '<TOKEN>');\n+  }\n+\n+  /** Git URL that resolves to the configured repository. */\n+  getRepoGitUrl() {\n+    return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n+  }\n+\n+  /**\n+   * Assert the GitClient instance is using a token with permissions for the all of the\n+   * provided OAuth scopes.\n+   */\n+  async hasOauthScopes(testFn: OAuthScopeTestFunction): Promise<true|{error: string}> {\n+    const scopes = await this._fetchAuthScopesForToken();\n+    const missingScopes: string[] = [];\n+    // Test Github OAuth scopes and collect missing ones.\n+    testFn(scopes, missingScopes);\n+    // If no missing scopes are found, return true to indicate all OAuth Scopes are available.\n+    if (missingScopes.length === 0) {\n+      return true;\n+    }\n+\n+    // Pre-constructed error message to log to the user, providing missing scopes and\n+    // remediation instructions.\n+    const error =\n+        `The provided <TOKEN> does not have required permissions due to missing scope(s): ` +\n+        `${yellow(missingScopes.join(', '))}\\n\\n` +\n+        `Update the token in use at:\\n` +\n+        `  ${GITHUB_TOKEN_SETTINGS_URL}\\n\\n` +\n+        `Alternatively, a new token can be created at: ${GITHUB_TOKEN_GENERATE_URL}\\n`;\n+\n+    return {error};\n+  }\n+\n+  /** Fetch the OAuth scopes for the loaded Github token. */\n+  private _fetchAuthScopesForToken() {\n+    // If the OAuth scopes have already been loaded, return the Promise containing them.\n+    if (this._cachedOauthScopes !== null) {\n+      return this._cachedOauthScopes;\n+    }\n+    // OAuth scopes are loaded via the /rate_limit endpoint to prevent\n+    // usage of a request against that rate_limit for this lookup.\n+    return this._cachedOauthScopes = this.github.rateLimit.get().then(_response => {\n+      const response = _response as RateLimitResponseWithOAuthScopeHeader;\n+      const scopes = response.headers['x-oauth-scopes'];\n+\n+      // If no token is provided, or if the Github client is authenticated incorrectly,\n+      // the `x-oauth-scopes` response header is not set. We error in such cases as it\n+      // signifies a faulty  of the\n+      if (scopes === undefined) {\n+        throw Error('Unable to retrieve OAuth scopes for token provided to Git client.');\n+      }\n+\n+      return scopes.split(',').map(scope => scope.trim()).filter(scope => scope !== '');\n+    });\n+  }\n+\n+  /** The singleton instance of the `AuthenticatedGitClient`. */\n+  private static _authenticatedInstance: AuthenticatedGitClient;\n+\n+  /**\n+   * Static method to get the singleton instance of the `AuthenticatedGitClient`,\n+   * creating it if it has not yet been created.\n+   */\n+  static get(): AuthenticatedGitClient {\n+    if (!AuthenticatedGitClient._authenticatedInstance) {\n+      throw new Error('No instance of `AuthenticatedGitClient` has been set up yet.');\n+    }\n+    return AuthenticatedGitClient._authenticatedInstance;\n+  }\n+\n+  /** Configures an authenticated git client. */\n+  static configure(token: string): void {\n+    if (AuthenticatedGitClient._authenticatedInstance) {\n+      throw Error(\n+          'Unable to configure `AuthenticatedGitClient` as it has been configured already.');\n+    }\n+    AuthenticatedGitClient._authenticatedInstance = new AuthenticatedGitClient(token);\n+  }\n+}"
        },
        {
            "sha": "2faef8480531368e525d276416a8a1e2f557c4e4",
            "filename": "dev-infra/utils/git/git-client.ts",
            "status": "added",
            "additions": 239,
            "deletions": 0,
            "changes": 239,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgit-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgit-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgit-client.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -0,0 +1,239 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n+import {Options as SemVerOptions, parse, SemVer} from 'semver';\n+\n+import {spawnWithDebugOutput} from '../child-process';\n+import {getConfig, GithubConfig, NgDevConfig} from '../config';\n+import {debug, info} from '../console';\n+import {DryRunError, isDryRun} from '../dry-run';\n+\n+import {GithubClient} from './github';\n+import {getRepositoryGitUrl} from './github-urls';\n+\n+/** Error for failed Git commands. */\n+export class GitCommandError extends Error {\n+  constructor(client: GitClient, public args: string[]) {\n+    // Errors are not guaranteed to be caught. To ensure that we don't\n+    // accidentally leak the Github token that might be used in a command,\n+    // we sanitize the command that will be part of the error message.\n+    super(`Command failed: git ${client.sanitizeConsoleOutput(args.join(' '))}`);\n+  }\n+}\n+\n+/** The options available for the `GitClient``run` and `runGraceful` methods. */\n+type GitCommandRunOptions = SpawnSyncOptions&{\n+  verboseLogging?: boolean;\n+};\n+\n+/** Class that can be used to perform Git interactions with a given remote. **/\n+export class GitClient {\n+  /** Short-hand for accessing the default remote configuration. */\n+  readonly remoteConfig: GithubConfig = this.config.github;\n+\n+  /** Octokit request parameters object for targeting the configured remote. */\n+  readonly remoteParams = {owner: this.remoteConfig.owner, repo: this.remoteConfig.name};\n+\n+  /** Instance of the Github client. */\n+  readonly github = new GithubClient();\n+\n+  constructor(\n+      /** The full path to the root of the repository base. */\n+      readonly baseDir = determineRepoBaseDirFromCwd(),\n+      /** The configuration, containing the github specific configuration. */\n+      readonly config = getConfig(baseDir)) {}\n+\n+  /** Executes the given git command. Throws if the command fails. */\n+  run(args: string[], options?: GitCommandRunOptions): Omit<SpawnSyncReturns<string>, 'status'> {\n+    const result = this.runGraceful(args, options);\n+    if (result.status !== 0) {\n+      throw new GitCommandError(this, args);\n+    }\n+    // Omit `status` from the type so that it's obvious that the status is never\n+    // non-zero as explained in the method description.\n+    return result as Omit<SpawnSyncReturns<string>, 'status'>;\n+  }\n+\n+  /**\n+   * Spawns a given Git command process. Does not throw if the command fails. Additionally,\n+   * if there is any stderr output, the output will be printed. This makes it easier to\n+   * info failed commands.\n+   */\n+  runGraceful(args: string[], options: GitCommandRunOptions = {}): SpawnSyncReturns<string> {\n+    /** The git command to be run. */\n+    const gitCommand = args[0];\n+\n+    if (isDryRun() && gitCommand === 'push') {\n+      debug(`\"git push\" is not able to be run in dryRun mode.`);\n+      throw new DryRunError();\n+    }\n+\n+    // To improve the debugging experience in case something fails, we print all executed Git\n+    // commands at the DEBUG level to better understand the git actions occurring. Verbose logging,\n+    // always logging at the INFO level, can be enabled either by setting the verboseLogging\n+    // property on the GitClient class or the options object provided to the method.\n+    const printFn = (GitClient.verboseLogging || options.verboseLogging) ? info : debug;\n+    // Note that we sanitize the command before printing it to the console. We do not want to\n+    // print an access token if it is contained in the command. It's common to share errors with\n+    // others if the tool failed, and we do not want to leak tokens.\n+    printFn('Executing: git', this.sanitizeConsoleOutput(args.join(' ')));\n+\n+    const result = spawnSync('git', args, {\n+      cwd: this.baseDir,\n+      stdio: 'pipe',\n+      ...options,\n+      // Encoding is always `utf8` and not overridable. This ensures that this method\n+      // always returns `string` as output instead of buffers.\n+      encoding: 'utf8',\n+    });\n+\n+    if (result.stderr !== null) {\n+      // Git sometimes prints the command if it failed. This means that it could\n+      // potentially leak the Github token used for accessing the remote. To avoid\n+      // printing a token, we sanitize the string before printing the stderr output.\n+      process.stderr.write(this.sanitizeConsoleOutput(result.stderr));\n+    }\n+\n+    return result;\n+  }\n+\n+  /** Git URL that resolves to the configured repository. */\n+  getRepoGitUrl() {\n+    return getRepositoryGitUrl(this.remoteConfig);\n+  }\n+\n+  /** Whether the given branch contains the specified SHA. */\n+  hasCommit(branchName: string, sha: string): boolean {\n+    return this.run(['branch', branchName, '--contains', sha]).stdout !== '';\n+  }\n+\n+  /** Gets the currently checked out branch or revision. */\n+  getCurrentBranchOrRevision(): string {\n+    const branchName = this.run(['rev-parse', '--abbrev-ref', 'HEAD']).stdout.trim();\n+    // If no branch name could be resolved. i.e. `HEAD` has been returned, then Git\n+    // is currently in a detached state. In those cases, we just want to return the\n+    // currently checked out revision/SHA.\n+    if (branchName === 'HEAD') {\n+      return this.run(['rev-parse', 'HEAD']).stdout.trim();\n+    }\n+    return branchName;\n+  }\n+\n+  /** Gets whether the current Git repository has uncommitted changes. */\n+  hasUncommittedChanges(): boolean {\n+    return this.runGraceful(['diff-index', '--quiet', 'HEAD']).status !== 0;\n+  }\n+\n+  /**\n+   * Checks out a requested branch or revision, optionally cleaning the state of the repository\n+   * before attempting the checking. Returns a boolean indicating whether the branch or revision\n+   * was cleanly checked out.\n+   */\n+  checkout(branchOrRevision: string, cleanState: boolean): boolean {\n+    if (cleanState) {\n+      // Abort any outstanding ams.\n+      this.runGraceful(['am', '--abort'], {stdio: 'ignore'});\n+      // Abort any outstanding cherry-picks.\n+      this.runGraceful(['cherry-pick', '--abort'], {stdio: 'ignore'});\n+      // Abort any outstanding rebases.\n+      this.runGraceful(['rebase', '--abort'], {stdio: 'ignore'});\n+      // Clear any changes in the current repo.\n+      this.runGraceful(['reset', '--hard'], {stdio: 'ignore'});\n+    }\n+    return this.runGraceful(['checkout', branchOrRevision], {stdio: 'ignore'}).status === 0;\n+  }\n+\n+  /** Gets the latest git tag on the current branch that matches SemVer. */\n+  getLatestSemverTag(): SemVer {\n+    const semVerOptions: SemVerOptions = {loose: true};\n+    const tags = this.runGraceful(['tag', '--sort=-committerdate', '--merged']).stdout.split('\\n');\n+    const latestTag = tags.find((tag: string) => parse(tag, semVerOptions));\n+\n+    if (latestTag === undefined) {\n+      throw new Error(\n+          `Unable to find a SemVer matching tag on \"${this.getCurrentBranchOrRevision()}\"`);\n+    }\n+    return new SemVer(latestTag, semVerOptions);\n+  }\n+\n+  /** Retrieve a list of all files in the repository changed since the provided shaOrRef. */\n+  allChangesFilesSince(shaOrRef = 'HEAD'): string[] {\n+    return Array.from(new Set([\n+      ...gitOutputAsArray(this.runGraceful(['diff', '--name-only', '--diff-filter=d', shaOrRef])),\n+      ...gitOutputAsArray(this.runGraceful(['ls-files', '--others', '--exclude-standard'])),\n+    ]));\n+  }\n+\n+  /** Retrieve a list of all files currently staged in the repostitory. */\n+  allStagedFiles(): string[] {\n+    return gitOutputAsArray(\n+        this.runGraceful(['diff', '--name-only', '--diff-filter=ACM', '--staged']));\n+  }\n+\n+  /** Retrieve a list of all files tracked in the repository. */\n+  allFiles(): string[] {\n+    return gitOutputAsArray(this.runGraceful(['ls-files']));\n+  }\n+\n+  /**\n+   * Sanitizes the given console message. This method can be overridden by\n+   * derived classes. e.g. to sanitize access tokens from Git commands.\n+   */\n+  sanitizeConsoleOutput(value: string) {\n+    return value;\n+  }\n+\n+  /** Whether verbose logging of Git actions should be used. */\n+  private static verboseLogging = false;\n+\n+  /** The singleton instance of the unauthenticated `GitClient`. */\n+  private static _unauthenticatedInstance: GitClient;\n+\n+  /** Set the verbose logging state of all git client instances. */\n+  static setVerboseLoggingState(verbose: boolean) {\n+    GitClient.verboseLogging = verbose;\n+  }\n+\n+  /**\n+   * Static method to get the singleton instance of the `GitClient`, creating it\n+   * if it has not yet been created.\n+   */\n+  static get(): GitClient {\n+    if (!this._unauthenticatedInstance) {\n+      GitClient._unauthenticatedInstance = new GitClient();\n+    }\n+    return GitClient._unauthenticatedInstance;\n+  }\n+}\n+\n+/**\n+ * Takes the output from `run` and `runGraceful` and returns an array of strings for each\n+ * new line. Git commands typically return multiple output values for a command a set of\n+ * strings separated by new lines.\n+ *\n+ * Note: This is specifically created as a locally available function for usage as convenience\n+ * utility within `GitClient`'s methods to create outputs as array.\n+ */\n+function gitOutputAsArray(gitCommandResult: SpawnSyncReturns<string>): string[] {\n+  return gitCommandResult.stdout.split('\\n').map(x => x.trim()).filter(x => !!x);\n+}\n+\n+/** Determines the repository base directory from the current working directory. */\n+function determineRepoBaseDirFromCwd() {\n+  // TODO(devversion): Replace with common spawn sync utility once available.\n+  const {stdout, stderr, status} = spawnSync(\n+      'git', ['rev-parse --show-toplevel'], {shell: true, stdio: 'pipe', encoding: 'utf8'});\n+  if (status !== 0) {\n+    throw Error(\n+        `Unable to find the path to the base directory of the repository.\\n` +\n+        `Was the command run from inside of the repo?\\n\\n` +\n+        `${stderr}`);\n+  }\n+  return stdout.trim();\n+}"
        },
        {
            "sha": "bce1e08fbae7bdd2be2049c76d1e14a227219240",
            "filename": "dev-infra/utils/git/github-urls.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub-urls.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -8,8 +8,9 @@\n \n \n import {URL} from 'url';\n+\n import {GithubConfig} from '../config';\n-import {GitClient} from './index';\n+import {GitClient} from './git-client';\n \n /** URL to the Github page where personal access tokens can be managed. */\n export const GITHUB_TOKEN_SETTINGS_URL = 'https://github.com/settings/tokens';\n@@ -37,6 +38,6 @@ export function getRepositoryGitUrl(config: GithubConfig, githubToken?: string):\n }\n \n /** Gets a Github URL that refers to a list of recent commits within a specified branch. */\n-export function getListCommitsInBranchUrl({remoteParams}: GitClient<boolean>, branchName: string) {\n+export function getListCommitsInBranchUrl({remoteParams}: GitClient, branchName: string) {\n   return `https://github.com/${remoteParams.owner}/${remoteParams.repo}/commits/${branchName}`;\n }"
        },
        {
            "sha": "606d66bdd055acc2fa3e2d0926ad5665bbdf8ea2",
            "filename": "dev-infra/utils/git/github-yargs.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub-yargs.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -10,16 +10,16 @@ import {Argv} from 'yargs';\n \n import {error, red, yellow} from '../console';\n \n+import {AuthenticatedGitClient} from './authenticated-git-client';\n import {GITHUB_TOKEN_GENERATE_URL} from './github-urls';\n-import {GitClient} from './index';\n \n export type ArgvWithGithubToken = Argv<{githubToken: string}>;\n \n /** Sets up the `github-token` command option for the given Yargs instance. */\n export function addGithubTokenOption(yargs: Argv): ArgvWithGithubToken {\n   return yargs\n       // 'github-token' is casted to 'githubToken' to properly set up typings to reflect the key in\n-      // the Argv object being camelCase rather than kebob case due to the `camel-case-expansion`\n+      // the Argv object being camelCase rather than kebab case due to the `camel-case-expansion`\n       // config: https://github.com/yargs/yargs-parser#camel-case-expansion\n       .option('github-token' as 'githubToken', {\n         type: 'string',\n@@ -33,9 +33,9 @@ export function addGithubTokenOption(yargs: Argv): ArgvWithGithubToken {\n             process.exit(1);\n           }\n           try {\n-            GitClient.getAuthenticatedInstance();\n+            AuthenticatedGitClient.get();\n           } catch {\n-            GitClient.authenticateWithToken(githubToken);\n+            AuthenticatedGitClient.configure(githubToken);\n           }\n           return githubToken;\n         },"
        },
        {
            "sha": "fdbc4351be9a83a6a4da01fc5b88c7e55a9fe3ae",
            "filename": "dev-infra/utils/git/github.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 32,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -32,46 +32,36 @@ export class GithubApiRequestError extends Error {\n   }\n }\n \n-/** Error for failed Github API requests. */\n-export class GithubGraphqlClientError extends Error {}\n+/** A Github client for interacting with the Github APIs. */\n+export class GithubClient {\n+  /** The octokit instance actually performing API requests. */\n+  private _octokit = new Octokit(this._octokitOptions);\n+\n+  readonly pulls = this._octokit.pulls;\n+  readonly repos = this._octokit.repos;\n+  readonly issues = this._octokit.issues;\n+  readonly git = this._octokit.git;\n+  readonly paginate = this._octokit.paginate;\n+  readonly rateLimit = this._octokit.rateLimit;\n+\n+  constructor(private _octokitOptions?: Octokit.Options) {}\n+}\n \n /**\n- * A Github client for interacting with the Github APIs.\n- *\n- * Additionally, provides convenience methods for actions which require multiple requests, or\n- * would provide value from memoized style responses.\n- **/\n-export class GithubClient {\n+ * Extension of the `GithubClient` that provides utilities which are specific\n+ * to authenticated instances.\n+ */\n+export class AuthenticatedGithubClient extends GithubClient {\n   /** The graphql instance with authentication set during construction. */\n-  private _graphql = graphql.defaults({headers: {authorization: `token ${this.token}`}});\n-  /** The Octokit instance actually performing API requests. */\n-  private _octokit = new Octokit({auth: this.token});\n+  private _graphql = graphql.defaults({headers: {authorization: `token ${this._token}`}});\n \n-  /**\n-   * @param token The github authentication token for Github Rest and Graphql API requests.\n-   */\n-  constructor(private token?: string) {\n-    this._octokit.hook.error('request', error => {\n-      // Wrap API errors in a known error class. This allows us to\n-      // expect Github API errors better and in a non-ambiguous way.\n-      throw new GithubApiRequestError(error.status, error.message);\n-    });\n+  constructor(private _token: string) {\n+    // Set the token for the octokit instance.\n+    super({auth: _token});\n   }\n \n   /** Perform a query using Github's Graphql API. */\n   async graphql<T extends GraphqlQueryObject>(queryObject: T, params: RequestParameters = {}) {\n-    if (this.token === undefined) {\n-      throw new GithubGraphqlClientError(\n-          'Cannot query via graphql without an authentication token set, use the authenticated ' +\n-          '`GitClient` by calling `GitClient.getAuthenticatedInstance()`.');\n-    }\n     return (await this._graphql(query(queryObject).toString(), params)) as T;\n   }\n-\n-  pulls = this._octokit.pulls;\n-  repos = this._octokit.repos;\n-  issues = this._octokit.issues;\n-  git = this._octokit.git;\n-  paginate = this._octokit.paginate;\n-  rateLimit = this._octokit.rateLimit;\n }"
        },
        {
            "sha": "c428da2c5f80ab04f686c6e6cbb565e6a81f2975",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 345,
            "changes": 345,
            "blob_url": "https://github.com/angular/angular/blob/aea56048f65b9cac2d045d318b57766989950b46/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/aea56048f65b9cac2d045d318b57766989950b46/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=aea56048f65b9cac2d045d318b57766989950b46",
            "patch": "@@ -1,345 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import {Octokit} from '@octokit/rest';\n-import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n-import {Options as SemVerOptions, parse, SemVer} from 'semver';\n-\n-import {getConfig, GithubConfig, NgDevConfig} from '../config';\n-import {debug, info, yellow} from '../console';\n-import {DryRunError, isDryRun} from '../dry-run';\n-import {GithubClient} from './github';\n-import {getRepositoryGitUrl, GITHUB_TOKEN_GENERATE_URL, GITHUB_TOKEN_SETTINGS_URL} from './github-urls';\n-\n-/** Github response type extended to include the `x-oauth-scopes` headers presence. */\n-type RateLimitResponseWithOAuthScopeHeader = Octokit.Response<Octokit.RateLimitGetResponse>&{\n-  headers: {'x-oauth-scopes': string};\n-};\n-\n-/** Describes a function that can be used to test for given Github OAuth scopes. */\n-export type OAuthScopeTestFunction = (scopes: string[], missing: string[]) => void;\n-\n-/** Error for failed Git commands. */\n-export class GitCommandError extends Error {\n-  constructor(client: GitClient<boolean>, public args: string[]) {\n-    // Errors are not guaranteed to be caught. To ensure that we don't\n-    // accidentally leak the Github token that might be used in a command,\n-    // we sanitize the command that will be part of the error message.\n-    super(`Command failed: git ${client.omitGithubTokenFromMessage(args.join(' '))}`);\n-  }\n-}\n-\n-/** The options available for `GitClient`'s `run` and `runGraceful` methods. */\n-type GitClientRunOptions = SpawnSyncOptions&{\n-  verboseLogging?: boolean;\n-};\n-\n-/**\n- * Common client for performing Git interactions with a given remote.\n- *\n- * Takes in two optional arguments:\n- *   `githubToken`: the token used for authentication in Github interactions, by default empty\n- *     allowing readonly actions.\n- *   `config`: The dev-infra configuration containing information about the remote. By default\n- *     the dev-infra configuration is loaded with its Github configuration.\n- **/\n-export class GitClient<Authenticated extends boolean> {\n-  /*************************************************\n-   * Singleton definition and configuration.       *\n-   *************************************************/\n-  /** The singleton instance of the authenticated GitClient. */\n-  private static authenticated: GitClient<true>;\n-  /** The singleton instance of the unauthenticated GitClient. */\n-  private static unauthenticated: GitClient<false>;\n-\n-  /**\n-   * Static method to get the singleton instance of the unauthorized GitClient, creating it if it\n-   * has not yet been created.\n-   */\n-  static getInstance() {\n-    if (!GitClient.unauthenticated) {\n-      GitClient.unauthenticated = new GitClient(undefined);\n-    }\n-    return GitClient.unauthenticated;\n-  }\n-\n-  /**\n-   * Static method to get the singleton instance of the authenticated GitClient if it has been\n-   * generated.\n-   */\n-  static getAuthenticatedInstance() {\n-    if (!GitClient.authenticated) {\n-      throw Error('The authenticated GitClient has not yet been generated.');\n-    }\n-    return GitClient.authenticated;\n-  }\n-\n-  /** Build the authenticated GitClient instance. */\n-  static authenticateWithToken(token: string) {\n-    if (GitClient.authenticated) {\n-      throw Error(\n-          'Cannot generate new authenticated GitClient after one has already been generated.');\n-    }\n-    GitClient.authenticated = new GitClient(token);\n-  }\n-\n-  /** Set the verbose logging state of the GitClient class. */\n-  static setVerboseLoggingState(verbose: boolean) {\n-    this.verboseLogging = verbose;\n-  }\n-\n-  /** Whether verbose logging of Git actions should be used. */\n-  private static verboseLogging = false;\n-  /** The configuration, containing the github specific configuration. */\n-  private config: NgDevConfig;\n-  /** The OAuth scopes available for the provided Github token. */\n-  private _cachedOauthScopes: Promise<string[]>|null = null;\n-  /**\n-   * Regular expression that matches the provided Github token. Used for\n-   * sanitizing the token from Git child process output.\n-   */\n-  private _githubTokenRegex: RegExp|null = null;\n-  /** Short-hand for accessing the default remote configuration. */\n-  remoteConfig: GithubConfig;\n-  /** Octokit request parameters object for targeting the configured remote. */\n-  remoteParams: {owner: string, repo: string};\n-  /** Instance of the Github octokit API. */\n-  github = new GithubClient(this.githubToken);\n-  /** The full path to the root of the repository base. */\n-  baseDir: string;\n-\n-  /**\n-   * @param githubToken The github token used for authentication, if provided.\n-   * @param config The configuration, containing the github specific configuration.\n-   * @param baseDir The full path to the root of the repository base.\n-   */\n-  protected constructor(public githubToken: Authenticated extends true? string: undefined,\n-                                                                  config?: NgDevConfig,\n-                                                                  baseDir?: string) {\n-    this.baseDir = baseDir || this.determineBaseDir();\n-    this.config = config || getConfig(this.baseDir);\n-    this.remoteConfig = this.config.github;\n-    this.remoteParams = {owner: this.remoteConfig.owner, repo: this.remoteConfig.name};\n-\n-    // If a token has been specified (and is not empty), pass it to the Octokit API and\n-    // also create a regular expression that can be used for sanitizing Git command output\n-    // so that it does not print the token accidentally.\n-    if (typeof githubToken === 'string') {\n-      this._githubTokenRegex = new RegExp(githubToken, 'g');\n-    }\n-  }\n-\n-  /** Executes the given git command. Throws if the command fails. */\n-  run(args: string[], options?: GitClientRunOptions): Omit<SpawnSyncReturns<string>, 'status'> {\n-    const result = this.runGraceful(args, options);\n-    if (result.status !== 0) {\n-      throw new GitCommandError(this, args);\n-    }\n-    // Omit `status` from the type so that it's obvious that the status is never\n-    // non-zero as explained in the method description.\n-    return result as Omit<SpawnSyncReturns<string>, 'status'>;\n-  }\n-\n-  /**\n-   * Spawns a given Git command process. Does not throw if the command fails. Additionally,\n-   * if there is any stderr output, the output will be printed. This makes it easier to\n-   * info failed commands.\n-   */\n-  runGraceful(args: string[], options: GitClientRunOptions = {}): SpawnSyncReturns<string> {\n-    /** The git command to be run. */\n-    const gitCommand = args[0];\n-\n-    if (isDryRun() && gitCommand === 'push') {\n-      debug(`\"git push\" is not able to be run in dryRun mode.`);\n-      throw new DryRunError();\n-    }\n-\n-    // To improve the debugging experience in case something fails, we print all executed Git\n-    // commands at the DEBUG level to better understand the git actions occuring. Verbose logging,\n-    // always logging at the INFO level, can be enabled either by setting the verboseLogging\n-    // property on the GitClient class or the options object provided to the method.\n-    const printFn = (GitClient.verboseLogging || options.verboseLogging) ? info : debug;\n-    // Note that we do not want to print the token if it is contained in the command. It's common\n-    // to share errors with others if the tool failed, and we do not want to leak tokens.\n-    printFn('Executing: git', this.omitGithubTokenFromMessage(args.join(' ')));\n-\n-    const result = spawnSync('git', args, {\n-      cwd: this.baseDir,\n-      stdio: 'pipe',\n-      ...options,\n-      // Encoding is always `utf8` and not overridable. This ensures that this method\n-      // always returns `string` as output instead of buffers.\n-      encoding: 'utf8',\n-    });\n-\n-    if (result.stderr !== null) {\n-      // Git sometimes prints the command if it failed. This means that it could\n-      // potentially leak the Github token used for accessing the remote. To avoid\n-      // printing a token, we sanitize the string before printing the stderr output.\n-      process.stderr.write(this.omitGithubTokenFromMessage(result.stderr));\n-    }\n-\n-    return result;\n-  }\n-\n-  /** Git URL that resolves to the configured repository. */\n-  getRepoGitUrl() {\n-    return getRepositoryGitUrl(this.remoteConfig, this.githubToken);\n-  }\n-\n-  /** Whether the given branch contains the specified SHA. */\n-  hasCommit(branchName: string, sha: string): boolean {\n-    return this.run(['branch', branchName, '--contains', sha]).stdout !== '';\n-  }\n-\n-  /** Gets the currently checked out branch or revision. */\n-  getCurrentBranchOrRevision(): string {\n-    const branchName = this.run(['rev-parse', '--abbrev-ref', 'HEAD']).stdout.trim();\n-    // If no branch name could be resolved. i.e. `HEAD` has been returned, then Git\n-    // is currently in a detached state. In those cases, we just want to return the\n-    // currently checked out revision/SHA.\n-    if (branchName === 'HEAD') {\n-      return this.run(['rev-parse', 'HEAD']).stdout.trim();\n-    }\n-    return branchName;\n-  }\n-\n-  /** Gets whether the current Git repository has uncommitted changes. */\n-  hasUncommittedChanges(): boolean {\n-    return this.runGraceful(['diff-index', '--quiet', 'HEAD']).status !== 0;\n-  }\n-\n-  /** Sanitizes a given message by omitting the provided Github token if present. */\n-  omitGithubTokenFromMessage(value: string): string {\n-    // If no token has been defined (i.e. no token regex), we just return the\n-    // value as is. There is no secret value that needs to be omitted.\n-    if (this._githubTokenRegex === null) {\n-      return value;\n-    }\n-    return value.replace(this._githubTokenRegex, '<TOKEN>');\n-  }\n-\n-  /**\n-   * Checks out a requested branch or revision, optionally cleaning the state of the repository\n-   * before attempting the checking. Returns a boolean indicating whether the branch or revision\n-   * was cleanly checked out.\n-   */\n-  checkout(branchOrRevision: string, cleanState: boolean): boolean {\n-    if (cleanState) {\n-      // Abort any outstanding ams.\n-      this.runGraceful(['am', '--abort'], {stdio: 'ignore'});\n-      // Abort any outstanding cherry-picks.\n-      this.runGraceful(['cherry-pick', '--abort'], {stdio: 'ignore'});\n-      // Abort any outstanding rebases.\n-      this.runGraceful(['rebase', '--abort'], {stdio: 'ignore'});\n-      // Clear any changes in the current repo.\n-      this.runGraceful(['reset', '--hard'], {stdio: 'ignore'});\n-    }\n-    return this.runGraceful(['checkout', branchOrRevision], {stdio: 'ignore'}).status === 0;\n-  }\n-\n-  /** Gets the latest git tag on the current branch that matches SemVer. */\n-  getLatestSemverTag(): SemVer {\n-    const semVerOptions: SemVerOptions = {loose: true};\n-    const tags = this.runGraceful(['tag', '--sort=-committerdate', '--merged']).stdout.split('\\n');\n-    const latestTag = tags.find((tag: string) => parse(tag, semVerOptions));\n-\n-    if (latestTag === undefined) {\n-      throw new Error(\n-          `Unable to find a SemVer matching tag on \"${this.getCurrentBranchOrRevision()}\"`);\n-    }\n-    return new SemVer(latestTag, semVerOptions);\n-  }\n-\n-  /** Retrieve a list of all files in the repostitory changed since the provided shaOrRef. */\n-  allChangesFilesSince(shaOrRef = 'HEAD'): string[] {\n-    return Array.from(new Set([\n-      ...gitOutputAsArray(this.runGraceful(['diff', '--name-only', '--diff-filter=d', shaOrRef])),\n-      ...gitOutputAsArray(this.runGraceful(['ls-files', '--others', '--exclude-standard'])),\n-    ]));\n-  }\n-\n-  /** Retrieve a list of all files currently staged in the repostitory. */\n-  allStagedFiles(): string[] {\n-    return gitOutputAsArray(\n-        this.runGraceful(['diff', '--name-only', '--diff-filter=ACM', '--staged']));\n-  }\n-\n-  /** Retrieve a list of all files tracked in the repostitory. */\n-  allFiles(): string[] {\n-    return gitOutputAsArray(this.runGraceful(['ls-files']));\n-  }\n-\n-  /**\n-   * Assert the GitClient instance is using a token with permissions for the all of the\n-   * provided OAuth scopes.\n-   */\n-  async hasOauthScopes(testFn: OAuthScopeTestFunction): Promise<true|{error: string}> {\n-    const scopes = await this.getAuthScopesForToken();\n-    const missingScopes: string[] = [];\n-    // Test Github OAuth scopes and collect missing ones.\n-    testFn(scopes, missingScopes);\n-    // If no missing scopes are found, return true to indicate all OAuth Scopes are available.\n-    if (missingScopes.length === 0) {\n-      return true;\n-    }\n-\n-    /**\n-     * Preconstructed error message to log to the user, providing missing scopes and\n-     * remediation instructions.\n-     **/\n-    const error =\n-        `The provided <TOKEN> does not have required permissions due to missing scope(s): ` +\n-        `${yellow(missingScopes.join(', '))}\\n\\n` +\n-        `Update the token in use at:\\n` +\n-        `  ${GITHUB_TOKEN_SETTINGS_URL}\\n\\n` +\n-        `Alternatively, a new token can be created at: ${GITHUB_TOKEN_GENERATE_URL}\\n`;\n-\n-    return {error};\n-  }\n-\n-  /**\n-   * Retrieve the OAuth scopes for the loaded Github token.\n-   **/\n-  private getAuthScopesForToken() {\n-    // If the OAuth scopes have already been loaded, return the Promise containing them.\n-    if (this._cachedOauthScopes !== null) {\n-      return this._cachedOauthScopes;\n-    }\n-    // OAuth scopes are loaded via the /rate_limit endpoint to prevent\n-    // usage of a request against that rate_limit for this lookup.\n-    return this._cachedOauthScopes = this.github.rateLimit.get().then(_response => {\n-      const response = _response as RateLimitResponseWithOAuthScopeHeader;\n-      const scopes: string = response.headers['x-oauth-scopes'] || '';\n-      return scopes.split(',').map(scope => scope.trim());\n-    });\n-  }\n-\n-  private determineBaseDir() {\n-    const {stdout, stderr, status} = this.runGraceful(['rev-parse', '--show-toplevel']);\n-    if (status !== 0) {\n-      throw Error(\n-          `Unable to find the path to the base directory of the repository.\\n` +\n-          `Was the command run from inside of the repo?\\n\\n` +\n-          `ERROR:\\n ${stderr}`);\n-    }\n-    return stdout.trim();\n-  }\n-}\n-\n-/**\n- * Takes the output from `GitClient.run` and `GitClient.runGraceful` and returns an array of strings\n- * for each new line. Git commands typically return multiple output values for a command a set of\n- * strings separated by new lines.\n- *\n- * Note: This is specifically created as a locally available function for usage as convenience\n- * utility within `GitClient`'s methods to create outputs as array.\n- */\n-function gitOutputAsArray(gitCommandResult: SpawnSyncReturns<string>): string[] {\n-  return gitCommandResult.stdout.split('\\n').map(x => x.trim()).filter(x => !!x);\n-}"
        },
        {
            "sha": "9df744378ed47dc5ba818d99c36704d6d288a212",
            "filename": "dev-infra/utils/github.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgithub.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -7,11 +7,12 @@\n  */\n \n import {params, types} from 'typed-graphqlify';\n+import {AuthenticatedGitClient} from './git/authenticated-git-client';\n \n-import {GitClient} from './git/index';\n \n /** Get a PR from github  */\n-export async function getPr<PrSchema>(prSchema: PrSchema, prNumber: number, git: GitClient<true>) {\n+export async function getPr<PrSchema>(\n+    prSchema: PrSchema, prNumber: number, git: AuthenticatedGitClient) {\n   /** The owner and name of the repository */\n   const {owner, name} = git.remoteConfig;\n   /** The Graphql query object to get a the PR */\n@@ -32,7 +33,7 @@ export async function getPr<PrSchema>(prSchema: PrSchema, prNumber: number, git:\n }\n \n /** Get all pending PRs from github  */\n-export async function getPendingPrs<PrSchema>(prSchema: PrSchema, git: GitClient<true>) {\n+export async function getPendingPrs<PrSchema>(prSchema: PrSchema, git: AuthenticatedGitClient) {\n   /** The owner and name of the repository */\n   const {owner, name} = git.remoteConfig;\n   /** The Graphql query object to get a page of pending PRs */"
        },
        {
            "sha": "363a53bee9b030a39f2d401e914a74e6b3f697ec",
            "filename": "dev-infra/utils/testing/virtual-git-client.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 21,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "raw_url": "https://github.com/angular/angular/raw/67f65a9d2581b70300c609b665e5d582d296eedf/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Ftesting%2Fvirtual-git-client.ts?ref=67f65a9d2581b70300c609b665e5d582d296eedf",
            "patch": "@@ -11,7 +11,8 @@ import * as parseArgs from 'minimist';\n import {SemVer} from 'semver';\n \n import {NgDevConfig} from '../config';\n-import {GitClient} from '../git/index';\n+import {AuthenticatedGitClient} from '../git/authenticated-git-client';\n+import {GitClient} from '../git/git-client';\n \n /**\n  * Temporary directory which will be used as project directory in tests. Note that\n@@ -59,19 +60,9 @@ export interface Commit {\n  * Virtual git client that mocks Git commands and keeps track of the repository state\n  * in memory. This allows for convenient test assertions with Git interactions.\n  */\n-export class VirtualGitClient<Authenticated extends boolean> extends GitClient<Authenticated> {\n-  static getInstance(config = mockNgDevConfig, tmpDir = testTmpDir): VirtualGitClient<false> {\n-    return new VirtualGitClient(undefined, config, tmpDir);\n-  }\n-\n-  static getAuthenticatedInstance(config = mockNgDevConfig, tmpDir = testTmpDir):\n-      VirtualGitClient<true> {\n-    return new VirtualGitClient('abc123', config, tmpDir);\n-  }\n-\n-  private constructor(token: Authenticated extends true? string: undefined, config: NgDevConfig,\n-                                                   tmpDir: string) {\n-    super(token, config, tmpDir);\n+export class VirtualGitClient extends AuthenticatedGitClient {\n+  static createInstance(config = mockNgDevConfig, tmpDir = testTmpDir): VirtualGitClient {\n+    return new VirtualGitClient('abc123', tmpDir, config);\n   }\n \n   /** Current Git HEAD that has been previously fetched. */\n@@ -83,7 +74,6 @@ export class VirtualGitClient<Authenticated extends boolean> extends GitClient<A\n   /** List of pushed heads to a given remote ref. */\n   pushed: {remote: RemoteRef, head: GitHead}[] = [];\n \n-\n   /**\n    * Override the actual GitClient getLatestSemverTag, as an actual tag cannot be retrieved in\n    * testing.\n@@ -213,11 +203,8 @@ export class VirtualGitClient<Authenticated extends boolean> extends GitClient<A\n   }\n }\n \n-\n export function installVirtualGitClientSpies() {\n-  const authenticatedVirtualGitClient = VirtualGitClient.getAuthenticatedInstance();\n-  spyOn(GitClient, 'getAuthenticatedInstance').and.returnValue(authenticatedVirtualGitClient);\n-\n-  const unauthenticatedVirtualGitClient = VirtualGitClient.getInstance();\n-  spyOn(GitClient, 'getInstance').and.returnValue(unauthenticatedVirtualGitClient);\n+  const mockInstance = VirtualGitClient.createInstance();\n+  spyOn(GitClient, 'get').and.returnValue(mockInstance);\n+  spyOn(AuthenticatedGitClient, 'get').and.returnValue(mockInstance);\n }"
        }
    ],
    "stats": {
        "total": 1620,
        "additions": 770,
        "deletions": 850
    }
}