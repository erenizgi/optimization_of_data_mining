{
    "author": "gkalpak",
    "message": "ci(docs-infra): store JS bundles as CI artifacts to debug size check flakes (#37703)\n\nAs reported in #37699, the size of the main angular.io bundle sometimes\nends up bigger than expected on CI. This usually goes away after\nrerunning the job a couple of times.\n\nIt is unclear what is causing this. In order to help debug the issue,\nthis commit stores the JS files that are checked as part of the aio\npayload-size check as CI artifacts, where they can be retrieved from and\ninspected.\n\nPR Close #37703",
    "sha": "eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb",
    "files": [
        {
            "sha": "3b1267df967b29bf517b463025638b687d9c8919",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb",
            "patch": "@@ -377,6 +377,10 @@ jobs:\n \n   test_aio:\n     executor: default-executor\n+    parameters:\n+      debugArtifactsDir:\n+        type: string\n+        default: aio/dist/size-debug-artifacts\n     steps:\n       - custom_attach_workspace\n       - init_environment\n@@ -395,6 +399,15 @@ jobs:\n       - run: yarn --cwd aio test-a11y-score-localhost\n         # Check the bundle sizes.\n       - run: yarn --cwd aio payload-size\n+        # When `payload-size` check fails, copy the files that were checked into `debugArtifactsDir`.\n+      - run:\n+          when: on_fail\n+          name: Prepare JS bundles to be stored as artifacts\n+          command: node aio/scripts/prepare-size-debug-artifacts aio << parameters.debugArtifactsDir >>\n+        # Store files in `debugArtifactsDir` (if any) as artifacts for debugging purposes.\n+      - store_artifacts:\n+          path: << parameters.debugArtifactsDir >>\n+          destination: aio\n         # Run unit tests for Firebase redirects\n       - run: yarn --cwd aio redirects-test\n \n@@ -410,6 +423,9 @@ jobs:\n \n   test_aio_local:\n     parameters:\n+      debugArtifactsDir:\n+        type: string\n+        default: aio/dist/size-debug-artifacts\n       viewengine:\n         type: boolean\n         default: false\n@@ -428,6 +444,15 @@ jobs:\n       - run: yarn --cwd aio test-pwa-score-localhost $CI_AIO_MIN_PWA_SCORE\n         # Check the bundle sizes.\n       - run: yarn --cwd aio payload-size aio-local<<# parameters.viewengine >>-viewengine<</ parameters.viewengine >>\n+        # When `payload-size` check fails, copy the files that were checked into `debugArtifactsDir`.\n+      - run:\n+          when: on_fail\n+          name: Prepare JS bundles to be stored as artifacts\n+          command: node aio/scripts/prepare-size-debug-artifacts aio-local<<# parameters.viewengine >>-viewengine<</ parameters.viewengine >> << parameters.debugArtifactsDir >>\n+        # Store files in `debugArtifactsDir` (if any) as artifacts for debugging purposes.\n+      - store_artifacts:\n+          path: << parameters.debugArtifactsDir >>\n+          destination: aio\n \n   test_aio_tools:\n     executor: default-executor"
        },
        {
            "sha": "503948baa270be59b1a45bb2b8a1b93ecc06f1af",
            "filename": "aio/scripts/prepare-size-debug-artifacts.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb/aio%2Fscripts%2Fprepare-size-debug-artifacts.js",
            "raw_url": "https://github.com/angular/angular/raw/eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb/aio%2Fscripts%2Fprepare-size-debug-artifacts.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fprepare-size-debug-artifacts.js?ref=eee2fd22e0a41d1df8e504a96501d83bb8e6f4cb",
            "patch": "@@ -0,0 +1,24 @@\n+#!/usr/bin/env node\n+const {cp, ls, mkdir, set} = require('shelljs');\n+const {join, resolve} = require('path');\n+set('-e');\n+\n+// Read input arguments.\n+const [sizesTarget, artifactsRelativeDir] = process.argv.slice(2);\n+\n+// Compute paths.\n+const projectDir = resolve(__dirname, '../..');\n+const sizesFilePath = join(projectDir, 'goldens/size-tracking/aio-payloads.json');\n+const distDir = join(projectDir, 'aio/dist');\n+const artifactsDir = resolve(projectDir, artifactsRelativeDir);\n+\n+// Determine which files need to be copied.\n+const fileNamePrefixes = Object.keys(require(sizesFilePath)[sizesTarget].master.uncompressed);\n+const filesToCopyRe = new RegExp(`^(?:${fileNamePrefixes.join('|')})\\\\..+\\\\.js$`);\n+const filesToCopy = ls(distDir)\n+    .filter(file => filesToCopyRe.test(file))\n+    .map(file => join(distDir, file));\n+\n+// Copy files to the specified directory.\n+mkdir('-p', artifactsDir);\n+cp(filesToCopy, artifactsDir);"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 49,
        "deletions": 0
    }
}