{
    "author": "alxhub",
    "message": "fix(compiler-cli): preserve user line endings in diagnostic template parse (#40597)\n\nNormally the template parsing operation normalizes all template line endings\nto '\\n' only. This normalization operation causes source mapping errors when\nthe original template uses '\\r\\n' line endings.\n\nThe compiler already parses templates again to create a \"diagnostic\"\ntemplate AST with accurate source maps, to avoid other parsing issues that\naffect source map accuracy. This commit configures this diagnostic parse to\nalso preserve line endings.\n\nPR Close #40597",
    "sha": "bd0d19141b241173439cb7ed8b8578d4c0ee60a2",
    "files": [
        {
            "sha": "5db7d33e45aba9495009162a6146df91e5b5c73f",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/bd0d19141b241173439cb7ed8b8578d4c0ee60a2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd0d19141b241173439cb7ed8b8578d4c0ee60a2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=bd0d19141b241173439cb7ed8b8578d4c0ee60a2",
            "patch": "@@ -869,12 +869,14 @@ export class ComponentDecoratorHandler implements\n \n     // Unfortunately, the primary parse of the template above may not contain accurate source map\n     // information. If used directly, it would result in incorrect code locations in template\n-    // errors, etc. There are two main problems:\n+    // errors, etc. There are three main problems:\n     //\n     // 1. `preserveWhitespaces: false` annihilates the correctness of template source mapping, as\n     //    the whitespace transformation changes the contents of HTML text nodes before they're\n     //    parsed into Angular expressions.\n-    // 2. By default, the template parser strips leading trivia characters (like spaces, tabs, and\n+    // 2. `preserveLineEndings: false` causes growing misalignments in templates that use '\\r\\n'\n+    //    line endings, by normalizing them to '\\n'.\n+    // 3. By default, the template parser strips leading trivia characters (like spaces, tabs, and\n     //    newlines). This also destroys source mapping information.\n     //\n     // In order to guarantee the correctness of diagnostics, templates are parsed a second time\n@@ -885,6 +887,7 @@ export class ComponentDecoratorHandler implements\n \n     const {nodes: diagNodes} = parseTemplate(templateStr, template.sourceMapUrl, {\n       preserveWhitespaces: true,\n+      preserveLineEndings: true,\n       interpolationConfig: template.interpolationConfig,\n       range: templateRange ?? undefined,\n       escapedString,"
        },
        {
            "sha": "fc060b60986d400e9f384585ff4a56f37cf332fd",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/bd0d19141b241173439cb7ed8b8578d4c0ee60a2/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd0d19141b241173439cb7ed8b8578d4c0ee60a2/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=bd0d19141b241173439cb7ed8b8578d4c0ee60a2",
            "patch": "@@ -110,6 +110,23 @@ export declare class AnimationEvent {\n       env.driveMain();\n     });\n \n+    it('should have accurate diagnostics in a template using crlf line endings', () => {\n+      env.write('test.ts', `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test',\n+          templateUrl: './test.html',\n+        })\n+        class TestCmp {}\n+      `);\n+      env.write('test.html', '<span>\\r\\n{{does_not_exist}}\\r\\n</span>');\n+\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(1);\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('does_not_exist');\n+    });\n+\n     it('should check regular attributes that are directive inputs', () => {\n       env.tsconfig(\n           {fullTemplateTypeCheck: true, strictInputTypes: true, strictAttributeTypes: true});"
        },
        {
            "sha": "e7d7618cc8a73493d856dc867c8f59ceeb109149",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/bd0d19141b241173439cb7ed8b8578d4c0ee60a2/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/bd0d19141b241173439cb7ed8b8578d4c0ee60a2/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=bd0d19141b241173439cb7ed8b8578d4c0ee60a2",
            "patch": "@@ -2003,6 +2003,10 @@ export interface ParseTemplateOptions {\n    * Include whitespace nodes in the parsed output.\n    */\n   preserveWhitespaces?: boolean;\n+  /**\n+   * Preserve original line endings instead of normalizing '\\r\\n' endings to '\\n'.\n+   */\n+  preserveLineEndings?: boolean;\n   /**\n    * How to parse interpolation markers.\n    */"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 26,
        "deletions": 2
    }
}