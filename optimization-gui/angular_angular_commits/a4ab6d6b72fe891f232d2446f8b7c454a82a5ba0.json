{
    "author": "crisbeto",
    "message": "feat(compiler): add support for safe calls in templates (#44580)\n\nAdds support for safely calling functions that may be undefined inside template expressions. E.g. `maybeUndefined?.()`\n\nFixes #42298.\n\nPR Close #44580",
    "sha": "a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
    "files": [
        {
            "sha": "240f23fdfab8b478b35be3bc8c08b0320e86f99c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/expression.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 14,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Call, Chain, Conditional, EmptyExpr, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeKeyedRead, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n+import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Call, Chain, Conditional, EmptyExpr, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeCall, SafeKeyedRead, SafePropertyRead, ThisReceiver, Unary} from '@angular/compiler';\n import ts from 'typescript';\n \n import {TypeCheckingConfig} from '../api';\n@@ -337,25 +337,40 @@ class AstTranslator implements AstVisitor {\n \n     // Safe property/keyed reads will produce a ternary whose value is nullable.\n     // We have to generate a similar ternary around the call.\n-    if (receiver instanceof SafePropertyRead || receiver instanceof SafeKeyedRead) {\n-      if (this.config.strictSafeNavigationTypes) {\n-        // \"a?.method(...)\" becomes (null as any ? a!.method(...) : undefined)\n-        const call = ts.createCall(ts.createNonNullExpression(expr), undefined, args);\n-        node = ts.createParen(ts.createConditional(NULL_AS_ANY, call, UNDEFINED));\n-      } else if (VeSafeLhsInferenceBugDetector.veWillInferAnyFor(ast)) {\n-        // \"a?.method(...)\" becomes (a as any).method(...)\n-        node = ts.createCall(tsCastToAny(expr), undefined, args);\n-      } else {\n-        // \"a?.method(...)\" becomes (a!.method(...) as any)\n-        node = tsCastToAny(ts.createCall(ts.createNonNullExpression(expr), undefined, args));\n-      }\n+    if (ast.receiver instanceof SafePropertyRead || ast.receiver instanceof SafeKeyedRead) {\n+      node = this.convertToSafeCall(ast, expr, args);\n     } else {\n       node = ts.createCall(expr, undefined, args);\n     }\n \n     addParseSpanInfo(node, ast.sourceSpan);\n     return node;\n   }\n+\n+  visitSafeCall(ast: SafeCall): ts.Expression {\n+    const args = ast.args.map(expr => this.translate(expr));\n+    const expr = wrapForDiagnostics(this.translate(ast.receiver));\n+    const node = this.convertToSafeCall(ast, expr, args);\n+    addParseSpanInfo(node, ast.sourceSpan);\n+    return node;\n+  }\n+\n+  private convertToSafeCall(ast: Call|SafeCall, expr: ts.Expression, args: ts.Expression[]):\n+      ts.Expression {\n+    if (this.config.strictSafeNavigationTypes) {\n+      // \"a?.method(...)\" becomes (null as any ? a!.method(...) : undefined)\n+      const call = ts.createCall(ts.createNonNullExpression(expr), undefined, args);\n+      return ts.createParen(ts.createConditional(NULL_AS_ANY, call, UNDEFINED));\n+    }\n+\n+    if (VeSafeLhsInferenceBugDetector.veWillInferAnyFor(ast)) {\n+      // \"a?.method(...)\" becomes (a as any).method(...)\n+      return ts.createCall(tsCastToAny(expr), undefined, args);\n+    }\n+\n+    // \"a?.method(...)\" becomes (a!.method(...) as any)\n+    return tsCastToAny(ts.createCall(ts.createNonNullExpression(expr), undefined, args));\n+  }\n }\n \n /**\n@@ -374,7 +389,7 @@ class AstTranslator implements AstVisitor {\n class VeSafeLhsInferenceBugDetector implements AstVisitor {\n   private static SINGLETON = new VeSafeLhsInferenceBugDetector();\n \n-  static veWillInferAnyFor(ast: Call|SafePropertyRead|SafeKeyedRead) {\n+  static veWillInferAnyFor(ast: Call|SafeCall|SafePropertyRead|SafeKeyedRead) {\n     const visitor = VeSafeLhsInferenceBugDetector.SINGLETON;\n     return ast instanceof Call ? ast.visit(visitor) : ast.receiver.visit(visitor);\n   }\n@@ -394,6 +409,9 @@ class VeSafeLhsInferenceBugDetector implements AstVisitor {\n   visitCall(ast: Call): boolean {\n     return true;\n   }\n+  visitSafeCall(ast: SafeCall): boolean {\n+    return false;\n+  }\n   visitImplicitReceiver(ast: ImplicitReceiver): boolean {\n     return false;\n   }"
        },
        {
            "sha": "c0336c43d13e0cdffc5fad134109d8cc60681aac",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, BindingPipe, BindingType, BoundTarget, Call, DYNAMIC_TYPE, ImplicitReceiver, ParsedEventType, ParseSourceSpan, PropertyRead, PropertyWrite, SafePropertyRead, SchemaMetadata, ThisReceiver, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstIcu, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, BindingPipe, BindingType, BoundTarget, Call, DYNAMIC_TYPE, ImplicitReceiver, ParsedEventType, ParseSourceSpan, PropertyRead, PropertyWrite, SafeCall, SafePropertyRead, SchemaMetadata, ThisReceiver, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstIcu, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import ts from 'typescript';\n \n import {Reference} from '../../imports';\n@@ -1727,7 +1727,7 @@ class TcbExpressionTranslator {\n       addParseSpanInfo(result, ast.sourceSpan);\n       return result;\n     } else if (\n-        ast instanceof Call &&\n+        (ast instanceof Call || ast instanceof SafeCall) &&\n         (ast.receiver instanceof PropertyRead || ast.receiver instanceof SafePropertyRead)) {\n       // Resolve the special `$any(expr)` syntax to insert a cast of the argument to type `any`.\n       // `$any(expr)` -> `expr as any`"
        },
        {
            "sha": "73d5842f2fa469a33f1ece5260a3c00ad2991cec",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -491,6 +491,35 @@ runInEachFileSystem(() => {\n           `TestComponent.html(1, 19): Argument of type 'string | undefined' is not assignable to parameter of type 'string'.`\n         ]);\n       });\n+\n+      it('does not produce diagnostic for safe calls', () => {\n+        const messages =\n+            diagnose(`<div [class.is-hobbit]=\"person.getName?.() === 'Bilbo'\"></div>`, `\n+              export class TestComponent {\n+                person: {\n+                  getName?: () => string;\n+                };\n+              }`);\n+\n+        expect(messages).toEqual([]);\n+      });\n+\n+      it('infers a safe call return value as undefined', () => {\n+        const messages = diagnose(`<div (click)=\"log(person.getName?.())\"></div>`, `\n+          export class TestComponent {\n+            person: {\n+              getName?: () => string;\n+            };\n+\n+            log(name: string) {\n+              console.log(name);\n+            }\n+          }`);\n+\n+        expect(messages).toEqual([\n+          `TestComponent.html(1, 19): Argument of type 'string | undefined' is not assignable to parameter of type 'string'.`\n+        ]);\n+      });\n     });\n \n     it('computes line and column offsets', () => {"
        },
        {
            "sha": "79508b5a3028386ac2a775c2d3948747a047e42c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/span_comments_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -79,6 +79,13 @@ describe('type check blocks diagnostics', () => {\n               '(ctx).method /*3,9*/(((ctx).a /*10,11*/) /*10,11*/, ((ctx).b /*13,14*/) /*13,14*/) /*3,15*/');\n     });\n \n+    it('should annotate safe calls', () => {\n+      const TEMPLATE = `{{ method?.(a, b) }}`;\n+      expect(tcbWithSpans(TEMPLATE))\n+          .toContain(\n+              '((null as any ? (((ctx).method /*3,9*/) /*3,9*/)!(((ctx).a /*12,13*/) /*12,13*/, ((ctx).b /*15,16*/) /*15,16*/) : undefined) /*3,17*/)');\n+    });\n+\n     it('should annotate method calls of variables', () => {\n       const TEMPLATE = `<ng-template let-method>{{ method(a, b) }}</ng-template>`;\n       expect(tcbWithSpans(TEMPLATE))"
        },
        {
            "sha": "30d3a30fd1f32d9a56688ea79ab894fc21a2a872",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -1002,14 +1002,15 @@ describe('type check blocks', () => {\n     });\n \n     describe('config.strictSafeNavigationTypes', () => {\n-      const TEMPLATE = `{{a?.b}} {{a?.method()}} {{a?.[0]}}`;\n+      const TEMPLATE = `{{a?.b}} {{a?.method()}} {{a?.[0]}} {{a.optionalMethod?.()}}`;\n \n       it('should use undefined for safe navigation operations when enabled', () => {\n         const block = tcb(TEMPLATE, DIRECTIVES);\n         expect(block).toContain(\n             '(null as any ? (null as any ? (((ctx).a))!.method : undefined)!() : undefined)');\n         expect(block).toContain('(null as any ? (((ctx).a))!.b : undefined)');\n         expect(block).toContain('(null as any ? (((ctx).a))![0] : undefined)');\n+        expect(block).toContain('(null as any ? (((((ctx).a)).optionalMethod))!() : undefined)');\n       });\n       it('should use an \\'any\\' type for safe navigation operations when disabled', () => {\n         const DISABLED_CONFIG:\n@@ -1018,17 +1019,21 @@ describe('type check blocks', () => {\n         expect(block).toContain('((((((ctx).a))!.method as any) as any)())');\n         expect(block).toContain('((((ctx).a))!.b as any)');\n         expect(block).toContain('(((((ctx).a))![0] as any)');\n+        expect(block).toContain('((((((ctx).a)).optionalMethod))!() as any)');\n       });\n     });\n \n     describe('config.strictSafeNavigationTypes (View Engine bug emulation)', () => {\n-      const TEMPLATE = `{{a.method()?.b}} {{a()?.method()}} {{a.method()?.[0]}}`;\n+      const TEMPLATE =\n+          `{{a.method()?.b}} {{a()?.method()}} {{a.method()?.[0]}} {{a.method()?.otherMethod?.()}}`;\n       it('should check the presence of a property/method on the receiver when enabled', () => {\n         const block = tcb(TEMPLATE, DIRECTIVES);\n         expect(block).toContain('(null as any ? ((((ctx).a)).method())!.b : undefined)');\n         expect(block).toContain(\n             '(null as any ? (null as any ? ((ctx).a())!.method : undefined)!() : undefined)');\n         expect(block).toContain('(null as any ? ((((ctx).a)).method())![0] : undefined)');\n+        expect(block).toContain(\n+            '(null as any ? ((null as any ? ((((ctx).a)).method())!.otherMethod : undefined))!() : undefined)');\n       });\n       it('should not check the presence of a property/method on the receiver when disabled', () => {\n         const DISABLED_CONFIG:\n@@ -1037,6 +1042,7 @@ describe('type check blocks', () => {\n         expect(block).toContain('(((((ctx).a)).method()) as any).b');\n         expect(block).toContain('(((((ctx).a()) as any).method as any)())');\n         expect(block).toContain('(((((ctx).a)).method()) as any)[0]');\n+        expect(block).toContain('(((((((ctx).a)).method()) as any).otherMethod)!() as any)');\n       });\n     });\n "
        },
        {
            "sha": "3f331c940f48c88ec85b4810a9cb582cbb4b7b1a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -14,7 +14,6 @@ import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError} from '../../file_sys\n import {runInEachFileSystem} from '../../file_system/testing';\n import {ClassDeclaration} from '../../reflection';\n import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, PipeSymbol, ReferenceSymbol, Symbol, SymbolKind, TemplateSymbol, TemplateTypeChecker, TypeCheckingConfig, VariableSymbol} from '../api';\n-\n import {getClass, ngForDeclaration, ngForTypeCheckTarget, setup as baseTestSetup, TypeCheckingTarget} from '../testing';\n \n runInEachFileSystem(() => {\n@@ -870,6 +869,26 @@ runInEachFileSystem(() => {\n         expect(callSymbol.tsSymbol).toBeNull();\n         expect(program.getTypeChecker().typeToString(callSymbol.tsType)).toBe('string');\n       });\n+\n+      it('should get a symbol for SafeCall expressions', () => {\n+        const fileName = absoluteFrom('/main.ts');\n+        const {templateTypeChecker, program} = setup([\n+          {\n+            fileName,\n+            templates: {'Cmp': '<div [input]=\"toString?.(123)\"></div>'},\n+            source: `export class Cmp { toString?: (value: number) => string; }`\n+          },\n+        ]);\n+        const sf = getSourceFileOrError(program, fileName);\n+        const cmp = getClass(sf, 'Cmp');\n+        const node = getAstElements(templateTypeChecker, cmp)[0];\n+        const safeCallSymbol = templateTypeChecker.getSymbolOfNode(node.inputs[0].value, cmp)!;\n+        assertExpressionSymbol(safeCallSymbol);\n+        // Note that the symbol returned is for the return value of the SafeCall.\n+        expect(safeCallSymbol.tsSymbol).toBeNull();\n+        expect(program.getTypeChecker().typeToString(safeCallSymbol.tsType))\n+            .toBe('string | undefined');\n+      });\n     });\n \n     describe('input bindings', () => {"
        },
        {
            "sha": "889a8e665cac097f5c0c643ef4a75324cb82e16d",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FGOLDEN_PARTIAL.js?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -108,3 +108,60 @@ export declare class MyApp {\n     static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"ng-component\", never, {}, {}, never, never>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: safe_call.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyApp {\n+    constructor() {\n+        this.person = { getName: () => 'Bilbo' };\n+    }\n+}\n+MyApp.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, deps: [], target: i0.ɵɵFactoryTarget.Component });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: `\n+    <span [title]=\"'Your last name is ' + (person.getLastName?.() ?? 'unknown')\">\n+      Hello, {{ person.getName?.() }}!\n+      You are a Balrog: {{ person.getSpecies?.()?.()?.()?.()?.() || 'unknown' }}\n+    </span>\n+`, isInline: true });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyApp, decorators: [{\n+            type: Component,\n+            args: [{\n+                    template: `\n+    <span [title]=\"'Your last name is ' + (person.getLastName?.() ?? 'unknown')\">\n+      Hello, {{ person.getName?.() }}!\n+      You are a Balrog: {{ person.getSpecies?.()?.()?.()?.()?.() || 'unknown' }}\n+    </span>\n+`\n+                }]\n+        }] });\n+export class MyModule {\n+}\n+MyModule.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule });\n+MyModule.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, declarations: [MyApp] });\n+MyModule.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule });\n+i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyModule, decorators: [{\n+            type: NgModule,\n+            args: [{ declarations: [MyApp] }]\n+        }] });\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: safe_call.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyApp {\n+    person: {\n+        getName: () => string;\n+        getLastName?: () => string;\n+        getSpecies?: () => () => () => () => () => string;\n+    };\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyApp, never>;\n+    static ɵcmp: i0.ɵɵComponentDeclaration<MyApp, \"ng-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵfac: i0.ɵɵFactoryDeclaration<MyModule, never>;\n+    static ɵmod: i0.ɵɵNgModuleDeclaration<MyModule, [typeof MyApp], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDeclaration<MyModule>;\n+}\n+"
        },
        {
            "sha": "68851d3accec262dfb168c07a147012657e400c0",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/TEST_CASES.json",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2FTEST_CASES.json?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -34,6 +34,23 @@\n           \"failureMessage\": \"Incorrect template\"\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should handle safe calls inside templates\",\n+      \"inputFiles\": [\n+        \"safe_call.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"files\": [\n+            {\n+              \"expected\": \"safe_call_template.js\",\n+              \"generated\": \"safe_call.js\"\n+            }\n+          ],\n+          \"failureMessage\": \"Incorrect template\"\n+        }\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "2a27d0e87aaba5bcbcf9e38fc76466640e4ec0ed",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/safe_call.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_call.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_call.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_call.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -0,0 +1,21 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  template: `\n+    <span [title]=\"'Your last name is ' + (person.getLastName?.() ?? 'unknown')\">\n+      Hello, {{ person.getName?.() }}!\n+      You are a Balrog: {{ person.getSpecies?.()?.()?.()?.()?.() || 'unknown' }}\n+    </span>\n+`\n+})\n+export class MyApp {\n+  person: {\n+    getName: () => string,\n+    getLastName?: () => string,\n+    getSpecies?: () => () => () => () => () => string,\n+  } = {getName: () => 'Bilbo'};\n+}\n+\n+@NgModule({declarations: [MyApp]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "16e792537867b5ca852f9b432f728beb6e857ae4",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/safe_access/safe_call_template.js",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_call_template.js",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_call_template.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2Fsafe_access%2Fsafe_call_template.js?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -0,0 +1,17 @@\n+template: function MyApp_Template(rf, $ctx$) {\n+  if (rf & 1) {\n+    $i0$.ɵɵelementStart(0, \"span\", 0);\n+    $i0$.ɵɵtext(1);\n+    $i0$.ɵɵelementEnd();\n+  }\n+  if (rf & 2) {\n+    let $tmp_0_0$;\n+    let $tmp_1_0$;\n+    let $tmp_1_1$;\n+    let $tmp_1_2$;\n+    let $tmp_1_3$;\n+    $i0$.ɵɵproperty(\"title\", \"Your last name is \" + (($tmp_0_0$ = $ctx$.person.getLastName == null ? null : $ctx$.person.getLastName()) !== null && $tmp_0_0$ !== undefined ? $tmp_0_0$ : \"unknown\"));\n+    $i0$.ɵɵadvance(1);\n+    $i0$.ɵɵtextInterpolate2(\" Hello, \", $ctx$.person.getName == null ? null : $ctx$.person.getName(), \"! You are a Balrog: \", ($ctx$.person.getSpecies == null ? null : ($tmp_1_0$ = $ctx$.person.getSpecies()) == null ? null : ($tmp_1_1$ = $tmp_1_0$()) == null ? null : ($tmp_1_2$ = $tmp_1_1$()) == null ? null : ($tmp_1_3$ = $tmp_1_2$()) == null ? null : $tmp_1_3$()) || \"unknown\", \" \");\n+  }\n+}"
        },
        {
            "sha": "1b15db6254754f9bbc137dd220ac73f8837948c7",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -551,14 +551,19 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n     return convertToStatementIfNeeded(mode, call);\n   }\n \n+  visitSafeCall(ast: cdAst.SafeCall, mode: _Mode): any {\n+    return this.convertSafeAccess(ast, this.leftMostSafeNode(ast), mode);\n+  }\n+\n   private _visit(ast: cdAst.AST, mode: _Mode): any {\n     const result = this._resultMap.get(ast);\n     if (result) return result;\n     return (this._nodeMap.get(ast) || ast).visit(this, mode);\n   }\n \n   private convertSafeAccess(\n-      ast: cdAst.AST, leftMostSafe: cdAst.SafePropertyRead|cdAst.SafeKeyedRead, mode: _Mode): any {\n+      ast: cdAst.AST, leftMostSafe: cdAst.SafePropertyRead|cdAst.SafeKeyedRead|cdAst.SafeCall,\n+      mode: _Mode): any {\n     // If the expression contains a safe access node on the left it needs to be converted to\n     // an expression that guards the access to the member by checking the receiver for blank. As\n     // execution proceeds from left to right, the left most part of the expression must be guarded\n@@ -615,7 +620,13 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n \n     // Convert the ast to an unguarded access to the receiver's member. The map will substitute\n     // leftMostNode with its unguarded version in the call to `this.visit()`.\n-    if (leftMostSafe instanceof cdAst.SafeKeyedRead) {\n+    if (leftMostSafe instanceof cdAst.SafeCall) {\n+      this._nodeMap.set(\n+          leftMostSafe,\n+          new cdAst.Call(\n+              leftMostSafe.span, leftMostSafe.sourceSpan, leftMostSafe.receiver, leftMostSafe.args,\n+              leftMostSafe.argumentSpan));\n+    } else if (leftMostSafe instanceof cdAst.SafeKeyedRead) {\n       this._nodeMap.set(\n           leftMostSafe,\n           new cdAst.KeyedRead(\n@@ -689,6 +700,9 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n       visitCall(ast: cdAst.Call) {\n         return visit(this, ast.receiver);\n       },\n+      visitSafeCall(ast: cdAst.SafeCall) {\n+        return visit(this, ast.receiver) || ast;\n+      },\n       visitImplicitReceiver(ast: cdAst.ImplicitReceiver) {\n         return null;\n       },\n@@ -766,6 +780,9 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n       visitCall(ast: cdAst.Call) {\n         return true;\n       },\n+      visitSafeCall(ast: cdAst.SafeCall) {\n+        return true;\n+      },\n       visitImplicitReceiver(ast: cdAst.ImplicitReceiver) {\n         return false;\n       },"
        },
        {
            "sha": "43e23d56e61e04950a18fe0aa5c2edaeaa1474bd",
            "filename": "packages/compiler/src/expression_parser/ast.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -318,7 +318,7 @@ export class NonNullAssert extends AST {\n \n export class Call extends AST {\n   constructor(\n-      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public receiver: AST, public args: any[],\n+      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public receiver: AST, public args: AST[],\n       public argumentSpan: AbsoluteSourceSpan) {\n     super(span, sourceSpan);\n   }\n@@ -327,6 +327,18 @@ export class Call extends AST {\n   }\n }\n \n+export class SafeCall extends AST {\n+  constructor(\n+      span: ParseSpan, sourceSpan: AbsoluteSourceSpan, public receiver: AST, public args: AST[],\n+      public argumentSpan: AbsoluteSourceSpan) {\n+    super(span, sourceSpan);\n+  }\n+  override visit(visitor: AstVisitor, context: any = null): any {\n+    return visitor.visitSafeCall(this, context);\n+  }\n+}\n+\n+\n /**\n  * Records the absolute position of a text span in a source file, where `start` and `end` are the\n  * starting and ending byte offsets, respectively, of the text span in a source file.\n@@ -439,6 +451,7 @@ export interface AstVisitor {\n   visitSafePropertyRead(ast: SafePropertyRead, context: any): any;\n   visitSafeKeyedRead(ast: SafeKeyedRead, context: any): any;\n   visitCall(ast: Call, context: any): any;\n+  visitSafeCall(ast: SafeCall, context: any): any;\n   visitASTWithSource?(ast: ASTWithSource, context: any): any;\n   /**\n    * This function is optionally defined to allow classes that implement this\n@@ -520,6 +533,10 @@ export class RecursiveAstVisitor implements AstVisitor {\n     this.visit(ast.receiver, context);\n     this.visitAll(ast.args, context);\n   }\n+  visitSafeCall(ast: SafeCall, context: any): any {\n+    this.visit(ast.receiver, context);\n+    this.visitAll(ast.args, context);\n+  }\n   visitQuote(ast: Quote, context: any): any {}\n   // This is not part of the AstVisitor interface, just a helper method\n   visitAll(asts: AST[], context: any): any {\n@@ -622,6 +639,12 @@ export class AstTransformer implements AstVisitor {\n         ast.argumentSpan);\n   }\n \n+  visitSafeCall(ast: SafeCall, context: any): AST {\n+    return new SafeCall(\n+        ast.span, ast.sourceSpan, ast.receiver.visit(this), this.visitAll(ast.args),\n+        ast.argumentSpan);\n+  }\n+\n   visitAll(asts: any[]): any[] {\n     const res = [];\n     for (let i = 0; i < asts.length; ++i) {\n@@ -816,6 +839,15 @@ export class AstMemoryEfficientTransformer implements AstVisitor {\n     return ast;\n   }\n \n+  visitSafeCall(ast: SafeCall, context: any): AST {\n+    const receiver = ast.receiver.visit(this);\n+    const args = this.visitAll(ast.args);\n+    if (receiver !== ast.receiver || args !== ast.args) {\n+      return new SafeCall(ast.span, ast.sourceSpan, receiver, args, ast.argumentSpan);\n+    }\n+    return ast;\n+  }\n+\n   visitQuote(ast: Quote, context: any): AST {\n     return ast;\n   }"
        },
        {
            "sha": "fd92d14a1dfa82d99e30b5242a03fa28faffe7b2",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 30,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -9,7 +9,7 @@\n import * as chars from '../chars';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../ml_parser/interpolation_config';\n \n-import {AbsoluteSourceSpan, AST, ASTWithSource, Binary, BindingPipe, Call, Chain, Conditional, EmptyExpr, ExpressionBinding, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralMapKey, LiteralPrimitive, NonNullAssert, ParserError, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeKeyedRead, SafePropertyRead, TemplateBinding, TemplateBindingIdentifier, ThisReceiver, Unary, VariableBinding} from './ast';\n+import {AbsoluteSourceSpan, AST, ASTWithSource, Binary, BindingPipe, Call, Chain, Conditional, EmptyExpr, ExpressionBinding, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralMapKey, LiteralPrimitive, NonNullAssert, ParserError, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeCall, SafeKeyedRead, SafePropertyRead, TemplateBinding, TemplateBindingIdentifier, ThisReceiver, Unary, VariableBinding} from './ast';\n import {EOF, isIdentifier, Lexer, Token, TokenType} from './lexer';\n \n export interface InterpolationPiece {\n@@ -813,23 +813,19 @@ export class _ParseAST {\n     let result = this.parsePrimary();\n     while (true) {\n       if (this.consumeOptionalCharacter(chars.$PERIOD)) {\n-        result = this.parseAccessMemberOrCall(result, start, false);\n-\n+        result = this.parseAccessMember(result, start, false);\n       } else if (this.consumeOptionalOperator('?.')) {\n-        result = this.consumeOptionalCharacter(chars.$LBRACKET) ?\n-            this.parseKeyedReadOrWrite(result, start, true) :\n-            this.parseAccessMemberOrCall(result, start, true);\n+        if (this.consumeOptionalCharacter(chars.$LPAREN)) {\n+          result = this.parseCall(result, start, true);\n+        } else {\n+          result = this.consumeOptionalCharacter(chars.$LBRACKET) ?\n+              this.parseKeyedReadOrWrite(result, start, true) :\n+              this.parseAccessMember(result, start, true);\n+        }\n       } else if (this.consumeOptionalCharacter(chars.$LBRACKET)) {\n         result = this.parseKeyedReadOrWrite(result, start, false);\n       } else if (this.consumeOptionalCharacter(chars.$LPAREN)) {\n-        const argumentStart = this.inputIndex;\n-        this.rparensExpected++;\n-        const args = this.parseCallArguments();\n-        const argumentSpan =\n-            this.span(argumentStart, this.inputIndex).toAbsolute(this.absoluteOffset);\n-        this.rparensExpected--;\n-        this.expectCharacter(chars.$RPAREN);\n-        result = new Call(this.span(start), this.sourceSpan(start), result, args, argumentSpan);\n+        result = this.parseCall(result, start, false);\n       } else if (this.consumeOptionalOperator('!')) {\n         result = new NonNullAssert(this.span(start), this.sourceSpan(start), result);\n \n@@ -878,9 +874,8 @@ export class _ParseAST {\n       return this.parseLiteralMap();\n \n     } else if (this.next.isIdentifier()) {\n-      return this.parseAccessMemberOrCall(\n+      return this.parseAccessMember(\n           new ImplicitReceiver(this.span(start), this.sourceSpan(start)), start, false);\n-\n     } else if (this.next.isNumber()) {\n       const value = this.next.toNumber();\n       this.advance();\n@@ -949,7 +944,7 @@ export class _ParseAST {\n     return new LiteralMap(this.span(start), this.sourceSpan(start), keys, values);\n   }\n \n-  parseAccessMemberOrCall(readReceiver: AST, start: number, isSafe: boolean): AST {\n+  parseAccessMember(readReceiver: AST, start: number, isSafe: boolean): AST {\n     const nameStart = this.inputIndex;\n     const id = this.withContext(ParseContextFlags.Writable, () => {\n       const id = this.expectIdentifierOrKeyword() ?? '';\n@@ -985,22 +980,22 @@ export class _ParseAST {\n       }\n     }\n \n-    if (this.consumeOptionalCharacter(chars.$LPAREN)) {\n-      const argumentStart = this.inputIndex;\n-      this.rparensExpected++;\n-      const args = this.parseCallArguments();\n-      const argumentSpan =\n-          this.span(argumentStart, this.inputIndex).toAbsolute(this.absoluteOffset);\n-      this.expectCharacter(chars.$RPAREN);\n-      this.rparensExpected--;\n-      const span = this.span(start);\n-      const sourceSpan = this.sourceSpan(start);\n-      return new Call(span, sourceSpan, receiver, args, argumentSpan);\n-    }\n-\n     return receiver;\n   }\n \n+  parseCall(receiver: AST, start: number, isSafe: boolean): AST {\n+    const argumentStart = this.inputIndex;\n+    this.rparensExpected++;\n+    const args = this.parseCallArguments();\n+    const argumentSpan = this.span(argumentStart, this.inputIndex).toAbsolute(this.absoluteOffset);\n+    this.expectCharacter(chars.$RPAREN);\n+    this.rparensExpected--;\n+    const span = this.span(start);\n+    const sourceSpan = this.sourceSpan(start);\n+    return isSafe ? new SafeCall(span, sourceSpan, receiver, args, argumentSpan) :\n+                    new Call(span, sourceSpan, receiver, args, argumentSpan);\n+  }\n+\n   parseCallArguments(): BindingPipe[] {\n     if (this.next.isCharacter(chars.$RPAREN)) return [];\n     const positionals: AST[] = [];"
        },
        {
            "sha": "4c704cb5ae908aeb339a5531ac897c19ebe1f2e8",
            "filename": "packages/compiler/test/expression_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -256,6 +256,24 @@ function expectErrorToken(token: Token, index: any, end: number, message: string\n         expectCharacterToken(tokens[13], 16, 17, ')');\n       });\n \n+      it('should tokenize safe function invocation', () => {\n+        const tokens: Token[] = lex('a?.()');\n+        expectIdentifierToken(tokens[0], 0, 1, 'a');\n+        expectOperatorToken(tokens[1], 1, 3, '?.');\n+        expectCharacterToken(tokens[2], 3, 4, '(');\n+        expectCharacterToken(tokens[3], 4, 5, ')');\n+      });\n+\n+      it('should tokenize a safe method invocations', () => {\n+        const tokens: Token[] = lex('a.method?.()');\n+        expectIdentifierToken(tokens[0], 0, 1, 'a');\n+        expectCharacterToken(tokens[1], 1, 2, '.');\n+        expectIdentifierToken(tokens[2], 2, 8, 'method');\n+        expectOperatorToken(tokens[3], 8, 10, '?.');\n+        expectCharacterToken(tokens[4], 10, 11, '(');\n+        expectCharacterToken(tokens[5], 11, 12, ')');\n+      });\n+\n       it('should tokenize number', () => {\n         expectNumberToken(lex('0.5')[0], 0, 3, 0.5);\n       });"
        },
        {
            "sha": "61d1ff1e92f0976432747d52ca39e4715b373120",
            "filename": "packages/compiler/test/expression_parser/parser_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -50,6 +50,8 @@ describe('parser', () => {\n       checkAction('true!');\n       checkAction('a!.b');\n       checkAction('a!!!!.b');\n+      checkAction('a!()');\n+      checkAction('a.b!()');\n     });\n \n     it('should parse multiplicative expressions', () => {\n@@ -222,6 +224,15 @@ describe('parser', () => {\n         const sourceSpan = (ast.args[1] as EmptyExpr).sourceSpan;\n         expect([sourceSpan.start, sourceSpan.end]).toEqual([5, 6]);\n       });\n+\n+      it('should parse safe calls', () => {\n+        checkAction('fn?.()');\n+        checkAction('add?.(1, 2)');\n+        checkAction('a.add?.(1, 2)');\n+        checkAction('a?.add?.(1, 2)');\n+        checkAction('fn?.().add?.(1, 2)');\n+        checkAction('fn?.()?.(1, 2)');\n+      });\n     });\n \n     describe('keyed read', () => {"
        },
        {
            "sha": "99cac5c39872f316bcb406d0df41bd0fe09b70b4",
            "filename": "packages/compiler/test/expression_parser/utils/unparser.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Call, Chain, Conditional, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeKeyedRead, SafePropertyRead, ThisReceiver, Unary} from '../../../src/expression_parser/ast';\n+import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Call, Chain, Conditional, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeCall, SafeKeyedRead, SafePropertyRead, ThisReceiver, Unary} from '../../../src/expression_parser/ast';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../../../src/ml_parser/interpolation_config';\n \n class Unparser implements AstVisitor {\n@@ -85,6 +85,18 @@ class Unparser implements AstVisitor {\n     this._expression += ')';\n   }\n \n+  visitSafeCall(ast: SafeCall, context: any) {\n+    this._visit(ast.receiver);\n+    this._expression += '?.(';\n+    let isFirst = true;\n+    ast.args.forEach(arg => {\n+      if (!isFirst) this._expression += ', ';\n+      isFirst = false;\n+      this._visit(arg);\n+    });\n+    this._expression += ')';\n+  }\n+\n   visitImplicitReceiver(ast: ImplicitReceiver, context: any) {}\n \n   visitThisReceiver(ast: ThisReceiver, context: any) {}"
        },
        {
            "sha": "5528ff2cf8ae48192261eb8e4c3ef0be719d8f5b",
            "filename": "packages/compiler/test/expression_parser/utils/validator.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Fvalidator.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Fvalidator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Fvalidator.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, Binary, BindingPipe, Call, Chain, Conditional, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeKeyedRead, SafePropertyRead, Unary} from '../../../src/expression_parser/ast';\n+import {AST, Binary, BindingPipe, Call, Chain, Conditional, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, ParseSpan, PrefixNot, PropertyRead, PropertyWrite, Quote, RecursiveAstVisitor, SafeCall, SafeKeyedRead, SafePropertyRead, Unary} from '../../../src/expression_parser/ast';\n \n import {unparse} from './unparser';\n \n@@ -109,6 +109,10 @@ class ASTValidator extends RecursiveAstVisitor {\n   override visitCall(ast: Call, context: any): any {\n     this.validate(ast, () => super.visitCall(ast, context));\n   }\n+\n+  override visitSafeCall(ast: SafeCall, context: any): any {\n+    this.validate(ast, () => super.visitSafeCall(ast, context));\n+  }\n }\n \n function inSpan(span: ParseSpan, parentSpan: ParseSpan|undefined): parentSpan is ParseSpan {"
        },
        {
            "sha": "67048dff611e5f29eb27d4c54d4ec3aef63fb6f4",
            "filename": "packages/compiler/test/render3/util/expression.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Futil%2Fexpression.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {AbsoluteSourceSpan} from '@angular/compiler';\n+\n import * as e from '../../../src/expression_parser/ast';\n import * as t from '../../../src/render3/r3_ast';\n import {unparse} from '../../expression_parser/utils/unparser';\n@@ -110,6 +111,10 @@ class ExpressionSourceHumanizer extends e.RecursiveAstVisitor implements t.Visit\n     this.recordAst(ast);\n     super.visitCall(ast, null);\n   }\n+  override visitSafeCall(ast: e.SafeCall) {\n+    this.recordAst(ast);\n+    super.visitSafeCall(ast, null);\n+  }\n \n   visitTemplate(ast: t.Template) {\n     t.visitAll(this, ast.children);"
        },
        {
            "sha": "572d56b4fbea6f48af408e891ff14348defd999f",
            "filename": "packages/core/test/acceptance/integration_spec.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -1974,6 +1974,59 @@ describe('acceptance integration tests', () => {\n     expect(content).toContain(`<span title=\"Your last name is unknown\">`);\n   });\n \n+  it('should handle safe keyed reads inside templates', () => {\n+    @Component({\n+      template: `\n+        <span [title]=\"'Your last name is ' + (person.getLastName?.() ?? 'unknown')\">\n+          Hello, {{ person.getName?.() }}!\n+          You are a Balrog: {{ person.getSpecies?.()?.()?.()?.()?.() || 'unknown' }}\n+        </span>\n+      `\n+    })\n+    class App {\n+      person: {\n+        getName: () => string,\n+        getLastName?: () => string,\n+        getSpecies?: () => () => () => () => () => string,\n+      } = {getName: () => 'Bilbo'};\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+    const content = fixture.nativeElement.innerHTML;\n+\n+    expect(content).toContain('Hello, Bilbo!');\n+    expect(content).toContain('You are a Balrog: unknown');\n+    expect(content).toContain(`<span title=\"Your last name is unknown\">`);\n+  });\n+\n+  it('should not invoke safe calls more times than plain calls', () => {\n+    const returnValue = () => () => () => () => 'hi';\n+    let plainCalls = 0;\n+    let safeCalls = 0;\n+\n+    @Component({template: `{{ safe?.()?.()?.()?.()?.() }} {{ plain()()()()() }}`})\n+    class App {\n+      plain() {\n+        plainCalls++;\n+        return returnValue;\n+      }\n+\n+      safe() {\n+        safeCalls++;\n+        return returnValue;\n+      }\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    expect(safeCalls).toBeGreaterThan(0);\n+    expect(safeCalls).toBe(plainCalls);\n+  });\n+\n   it('should handle nullish coalescing inside host bindings', () => {\n     const logs: string[] = [];\n "
        },
        {
            "sha": "b2352c5bbfb45e7da500cb3fd062a46bfa1f0658",
            "filename": "packages/language-service/src/signature_help.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Fsrc%2Fsignature_help.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Fsrc%2Fsignature_help.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fsignature_help.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Call} from '@angular/compiler';\n+import {Call, SafeCall} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {getSourceFileOrError} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {SymbolKind} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n@@ -48,19 +48,19 @@ export function getSignatureHelp(\n   // Additionally, extract the `Call` node for which signature help is being queried, as this\n   // is needed to construct the correct span for the results later.\n   let shimPosition: number;\n-  let expr: Call;\n+  let expr: Call|SafeCall;\n   switch (targetInfo.context.kind) {\n     case TargetNodeKind.RawExpression:\n       // For normal expressions, just use the primary TCB position of the expression.\n       shimPosition = symbol.shimLocation.positionInShimFile;\n \n       // Walk up the parents of this expression and try to find a\n       // `Call` for which signature information is being fetched.\n-      let callExpr: Call|null = null;\n+      let callExpr: Call|SafeCall|null = null;\n       const parents = targetInfo.context.parents;\n       for (let i = parents.length - 1; i >= 0; i--) {\n         const parent = parents[i];\n-        if (parent instanceof Call) {\n+        if (parent instanceof Call || parent instanceof SafeCall) {\n           callExpr = parent;\n           break;\n         }"
        },
        {
            "sha": "47eaef64c444b944dfe50b0fe7bfa3c4f45c1ab0",
            "filename": "packages/language-service/src/template_target.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Fsrc%2Ftemplate_target.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Fsrc%2Ftemplate_target.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftemplate_target.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -93,7 +93,7 @@ export interface RawExpression {\n  */\n export interface CallExpressionInArgContext {\n   kind: TargetNodeKind.CallExpressionInArgContext;\n-  node: e.Call;\n+  node: e.Call|e.SafeCall;\n }\n \n /**\n@@ -184,7 +184,8 @@ export function getTargetAtPosition(template: t.Node[], position: number): Templ\n \n   // Given the candidate node, determine the full targeted context.\n   let nodeInContext: TargetContext;\n-  if (candidate instanceof e.Call && isWithin(position, candidate.argumentSpan)) {\n+  if ((candidate instanceof e.Call || candidate instanceof e.SafeCall) &&\n+      isWithin(position, candidate.argumentSpan)) {\n     nodeInContext = {\n       kind: TargetNodeKind.CallExpressionInArgContext,\n       node: candidate,"
        },
        {
            "sha": "df32573322e344d0e64d5c6ed73ae66d62ed603d",
            "filename": "packages/language-service/test/completions_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 17,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fcompletions_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -97,7 +97,6 @@ const NG_FOR_DIR = {\n      })\n      export class NgFor {\n        constructor(ref: TemplateRef<any>) {}\n- \n        ngForOf!: any;\n      }\n    `\n@@ -355,16 +354,6 @@ describe('completions', () => {\n         full: ts.ScriptElementKind.memberFunctionElement,\n       });\n     });\n-\n-    it('should return completions in an empty safe method call context', () => {\n-      const {templateFile} = setup(`{{name?.()}}`, `name!: {first: string; full(): string;};`);\n-      templateFile.moveCursorToText('{{name?.¦()}}');\n-      const completions = templateFile.getCompletionsAtPosition();\n-      expectAll(completions, {\n-        first: ts.ScriptElementKind.memberVariableElement,\n-        full: ts.ScriptElementKind.memberFunctionElement,\n-      });\n-    });\n   });\n \n   describe('element tag scope', () => {\n@@ -1284,7 +1273,7 @@ function setup(\n   const project = env.addProject('test', {\n     'test.ts': `\n          import {Component, Directive, NgModule, Pipe, TemplateRef} from '@angular/core';\n- \n+\n          ${functionDeclarations}\n \n          @Component({\n@@ -1295,9 +1284,9 @@ function setup(\n          export class AppCmp {\n            ${classContents}\n          }\n- \n+\n          ${otherDirectiveClassDecls}\n- \n+\n          @NgModule({\n            declarations: [${decls.join(', ')}],\n          })\n@@ -1320,17 +1309,17 @@ function setupInlineTemplate(\n   const project = env.addProject('test', {\n     'test.ts': `\n          import {Component, Directive, NgModule, Pipe, TemplateRef} from '@angular/core';\n- \n+\n          @Component({\n            template: '${template}',\n            selector: 'app-cmp',\n          })\n          export class AppCmp {\n            ${classContents}\n          }\n- \n+\n          ${otherDirectiveClassDecls}\n- \n+\n          @NgModule({\n            declarations: [${decls.join(', ')}],\n          })"
        },
        {
            "sha": "d62e9f49dc87eb8541c2083b2a715538c88ba54a",
            "filename": "packages/language-service/test/legacy/template_target_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0/packages%2Flanguage-service%2Ftest%2Flegacy%2Ftemplate_target_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Flegacy%2Ftemplate_target_spec.ts?ref=a4ab6d6b72fe891f232d2446f8b7c454a82a5ba0",
            "patch": "@@ -558,6 +558,15 @@ describe('getTargetAtPosition for expression AST', () => {\n     expect(node).toBeInstanceOf(e.Call);\n   });\n \n+  it('should locate safe call', () => {\n+    const {errors, nodes, position} = parse(`{{ title.toString?.(¦) }}`);\n+    expect(errors).toBe(null);\n+    const {context} = getTargetAtPosition(nodes, position)!;\n+    const {node} = context as SingleNodeTarget;\n+    expect(isExpressionNode(node!)).toBe(true);\n+    expect(node).toBeInstanceOf(e.SafeCall);\n+  });\n+\n   it('should identify when in the argument position in a no-arg method call', () => {\n     const {errors, nodes, position} = parse(`{{ title.toString(¦) }}`);\n     expect(errors).toBe(null);"
        }
    ],
    "stats": {
        "total": 491,
        "additions": 414,
        "deletions": 77
    }
}