{
    "author": "alxhub",
    "message": "fix(compiler-cli): show a more specific error for Ivy NgModules (#41534)\n\nWhen an Ivy NgModule is imported into a View Engine build, it doesn't have\nmetadata.json files that describe it as an NgModule, so it appears to VE\nbuilds as a plain, undecorated class. The error message shown in this\nsituation generic and confusing, since it recommends adding an @NgModule\nannotation to a class from a library.\n\nThis commit adds special detection into the View Engine compiler to give a\nmore specific error message when an Ivy NgModule is imported.\n\nPR Close #41534",
    "sha": "c9aa87cec02a8ff1eeacea30be40764062a903c4",
    "files": [
        {
            "sha": "55d3c29d8750602d07ca4cfaa1189018057eeb0a",
            "filename": "goldens/public-api/compiler-cli/error_code.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c9aa87cec02a8ff1eeacea30be40764062a903c4/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9aa87cec02a8ff1eeacea30be40764062a903c4/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts?ref=c9aa87cec02a8ff1eeacea30be40764062a903c4",
            "patch": "@@ -29,6 +29,7 @@ export declare enum ErrorCode {\n     NGMODULE_MODULE_WITH_PROVIDERS_MISSING_GENERIC = 6005,\n     NGMODULE_REEXPORT_NAME_COLLISION = 6006,\n     NGMODULE_DECLARATION_NOT_UNIQUE = 6007,\n+    NGMODULE_VE_DEPENDENCY_ON_IVY_LIB = 6999,\n     SCHEMA_INVALID_ELEMENT = 8001,\n     SCHEMA_INVALID_ATTRIBUTE = 8002,\n     MISSING_REFERENCE_TARGET = 8003,"
        },
        {
            "sha": "63f8b01f2b7a37b7a8a3583a5c49f04599eef3e7",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=c9aa87cec02a8ff1eeacea30be40764062a903c4",
            "patch": "@@ -110,6 +110,12 @@ export enum ErrorCode {\n    */\n   NGMODULE_DECLARATION_NOT_UNIQUE = 6007,\n \n+  /**\n+   * Not actually raised by the compiler, but reserved for documentation of a View Engine error when\n+   * a View Engine build depends on an Ivy-compiled NgModule.\n+   */\n+  NGMODULE_VE_DEPENDENCY_ON_IVY_LIB = 6999,\n+\n   /**\n    * An element name failed validation against the DOM schema.\n    */"
        },
        {
            "sha": "b0266def9dd1f96d30fddda2b17af935ee0ecd3e",
            "filename": "packages/compiler-cli/src/transformers/program.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 3,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fprogram.ts?ref=c9aa87cec02a8ff1eeacea30be40764062a903c4",
            "patch": "@@ -7,7 +7,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AotCompiler, AotCompilerOptions, core, createAotCompiler, FormattedMessageChain, GeneratedFile, getParseErrors, isFormattedError, isSyntaxError, MessageBundle, NgAnalyzedFileWithInjectables, NgAnalyzedModules, ParseSourceSpan, PartialModule, Serializer, Xliff, Xliff2, Xmb} from '@angular/compiler';\n+import {AotCompiler, AotCompilerOptions, core, createAotCompiler, FormattedMessageChain, GeneratedFile, getMissingNgModuleMetadataErrorData, getParseErrors, isFormattedError, isSyntaxError, MessageBundle, NgAnalyzedFileWithInjectables, NgAnalyzedModules, ParseSourceSpan, PartialModule, Serializer, Xliff, Xliff2, Xmb} from '@angular/compiler';\n import * as fs from 'fs';\n import * as path from 'path';\n import * as ts from 'typescript';\n@@ -690,7 +690,7 @@ class AngularCompilerProgram implements Program {\n   private _addStructuralDiagnostics(error: Error) {\n     const diagnostics = this._structuralDiagnostics || (this._structuralDiagnostics = []);\n     if (isSyntaxError(error)) {\n-      diagnostics.push(...syntaxErrorToDiagnostics(error));\n+      diagnostics.push(...syntaxErrorToDiagnostics(error, this.tsProgram));\n     } else {\n       diagnostics.push({\n         messageText: error.toString(),\n@@ -1036,7 +1036,7 @@ function diagnosticChainFromFormattedDiagnosticChain(chain: FormattedMessageChai\n   };\n }\n \n-function syntaxErrorToDiagnostics(error: Error): Diagnostic[] {\n+function syntaxErrorToDiagnostics(error: Error, program: ts.Program): Diagnostic[] {\n   const parserErrors = getParseErrors(error);\n   if (parserErrors && parserErrors.length) {\n     return parserErrors.map<Diagnostic>(e => ({\n@@ -1058,6 +1058,33 @@ function syntaxErrorToDiagnostics(error: Error): Diagnostic[] {\n       position: error.position\n     }];\n   }\n+\n+  const ngModuleErrorData = getMissingNgModuleMetadataErrorData(error);\n+  if (ngModuleErrorData !== null) {\n+    // This error represents the import or export of an `NgModule` that didn't have valid metadata.\n+    // This _might_ happen because the NgModule in question is an Ivy-compiled library, and we want\n+    // to show a more useful error if that's the case.\n+    const ngModuleClass =\n+        getDtsClass(program, ngModuleErrorData.fileName, ngModuleErrorData.className);\n+    if (ngModuleClass !== null && isIvyNgModule(ngModuleClass)) {\n+      return [{\n+        messageText: `The NgModule '${ngModuleErrorData.className}' in '${\n+            ngModuleErrorData\n+                .fileName}' is imported by this compilation, but appears to be part of a library compiled for Angular Ivy. This may occur because:\n+\n+  1) the library was processed with 'ngcc'. Removing and reinstalling node_modules may fix this problem.\n+\n+  2) the library was published for Angular Ivy and v12+ applications only. Check its peer dependencies carefully and ensure that you're using a compatible version of Angular.\n+\n+See https://angular.io/errors/NG6999 for more information.\n+`,\n+        category: ts.DiagnosticCategory.Error,\n+        code: DEFAULT_ERROR_CODE,\n+        source: SOURCE,\n+      }];\n+    }\n+  }\n+\n   // Produce a Diagnostic anyway since we know for sure `error` is a SyntaxError\n   return [{\n     messageText: error.message,\n@@ -1066,3 +1093,38 @@ function syntaxErrorToDiagnostics(error: Error): Diagnostic[] {\n     source: SOURCE,\n   }];\n }\n+\n+function getDtsClass(program: ts.Program, fileName: string, className: string): ts.ClassDeclaration|\n+    null {\n+  const sf = program.getSourceFile(fileName);\n+  if (sf === undefined || !sf.isDeclarationFile) {\n+    return null;\n+  }\n+  for (const stmt of sf.statements) {\n+    if (!ts.isClassDeclaration(stmt)) {\n+      continue;\n+    }\n+    if (stmt.name === undefined || stmt.name.text !== className) {\n+      continue;\n+    }\n+\n+    return stmt;\n+  }\n+\n+  // No classes found that matched the given name.\n+  return null;\n+}\n+\n+function isIvyNgModule(clazz: ts.ClassDeclaration): boolean {\n+  for (const member of clazz.members) {\n+    if (!ts.isPropertyDeclaration(member)) {\n+      continue;\n+    }\n+    if (ts.isIdentifier(member.name) && member.name.text === 'ɵmod') {\n+      return true;\n+    }\n+  }\n+\n+  // No Ivy 'ɵmod' property found.\n+  return false;\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "ed8b9a9f154d4638a56fc71514c4be7415210248",
            "filename": "packages/compiler-cli/test/ngc_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts?ref=c9aa87cec02a8ff1eeacea30be40764062a903c4",
            "patch": "@@ -330,6 +330,34 @@ describe('ngc transformer command-line', () => {\n     });\n   });\n \n+  it('should give a specific error when an Angular Ivy NgModule is imported', () => {\n+    writeConfig(`{\n+      \"extends\": \"./tsconfig-base.json\",\n+      \"files\": [\"mymodule.ts\"]\n+    }`);\n+    write('node_modules/test/index.d.ts', `\n+      export declare class FooModule {\n+        static ɵmod = null;\n+      }\n+    `);\n+    write('mymodule.ts', `\n+      import {NgModule} from '@angular/core';\n+      import {FooModule} from 'test';\n+\n+      @NgModule({\n+        imports: [FooModule],\n+      })\n+      export class TestModule {}\n+    `);\n+\n+    const exitCode = main(['-p', basePath], errorSpy);\n+    expect(errorSpy).toHaveBeenCalledTimes(1);\n+    const message = errorSpy.calls.mostRecent().args[0];\n+\n+    // The error message should mention Ivy specifically.\n+    expect(message).toContain('Angular Ivy');\n+  });\n+\n   describe('compile ngfactory files', () => {\n     it('should compile ngfactory files that are not referenced by root files', () => {\n       writeConfig(`{"
        },
        {
            "sha": "00315c77f5202e40ab5734fd7a9b40e2e52b5a48",
            "filename": "packages/compiler/src/metadata_resolver.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 5,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler%2Fsrc%2Fmetadata_resolver.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9aa87cec02a8ff1eeacea30be40764062a903c4/packages%2Fcompiler%2Fsrc%2Fmetadata_resolver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fmetadata_resolver.ts?ref=c9aa87cec02a8ff1eeacea30be40764062a903c4",
            "patch": "@@ -29,6 +29,18 @@ export type ErrorCollector = (error: any, type?: any) => void;\n \n export const ERROR_COMPONENT_TYPE = 'ngComponentType';\n \n+const MISSING_NG_MODULE_METADATA_ERROR_DATA = 'ngMissingNgModuleMetadataErrorData';\n+export interface MissingNgModuleMetadataErrorData {\n+  fileName: string;\n+  className: string;\n+}\n+\n+\n+export function getMissingNgModuleMetadataErrorData(error: any): MissingNgModuleMetadataErrorData|\n+    null {\n+  return error[MISSING_NG_MODULE_METADATA_ERROR_DATA] ?? null;\n+}\n+\n // Design notes:\n // - don't lazily create metadata:\n //   For some metadata, we need to do async work sometimes,\n@@ -563,11 +575,18 @@ export class CompileMetadataResolver {\n               this.getNgModuleSummary(importedModuleType, alreadyCollecting);\n           alreadyCollecting.delete(importedModuleType);\n           if (!importedModuleSummary) {\n-            this._reportError(\n-                syntaxError(`Unexpected ${this._getTypeDescriptor(importedType)} '${\n-                    stringifyType(importedType)}' imported by the module '${\n-                    stringifyType(moduleType)}'. Please add a @NgModule annotation.`),\n-                moduleType);\n+            const err = syntaxError(`Unexpected ${this._getTypeDescriptor(importedType)} '${\n+                stringifyType(importedType)}' imported by the module '${\n+                stringifyType(moduleType)}'. Please add a @NgModule annotation.`);\n+            // If possible, record additional context for this error to enable more useful\n+            // diagnostics on the compiler side.\n+            if (importedType instanceof StaticSymbol) {\n+              (err as any)[MISSING_NG_MODULE_METADATA_ERROR_DATA] = {\n+                fileName: importedType.filePath,\n+                className: importedType.name,\n+              } as MissingNgModuleMetadataErrorData;\n+            }\n+            this._reportError(err, moduleType);\n             return;\n           }\n           importedModules.push(importedModuleSummary);"
        }
    ],
    "stats": {
        "total": 132,
        "additions": 124,
        "deletions": 8
    }
}