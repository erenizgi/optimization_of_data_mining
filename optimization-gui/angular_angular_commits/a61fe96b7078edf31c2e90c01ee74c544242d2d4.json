{
    "author": "crisbeto",
    "message": "fix(compiler-cli): incorrectly type checking calls to implicit template variables (#39686)\n\nCurrently when we encounter an implicit method call (e.g. `{{ foo(1) }}`) and we manage to resolve\nits receiver to something within the template, we assume that the method is on the receiver itself\nso we generate a type checking code to reflect it. This assumption is true in most cases, but it\nbreaks down if the call is on an implicit receiver and the receiver itself is being invoked. E.g.\n\n```\n<div *ngFor=\"let fn of functions\">{{ fn(1) }}</div>\n```\n\nThese changes resolve the issue by generating a regular function call if the method call's receiver\nis pointing to `$implicit`.\n\nFixes #39634.\n\nPR Close #39686",
    "sha": "a61fe96b7078edf31c2e90c01ee74c544242d2d4",
    "files": [
        {
            "sha": "0410b72bc5b20ae92f2072b938c63dd53c38e3be",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=a61fe96b7078edf31c2e90c01ee74c544242d2d4",
            "patch": "@@ -1622,7 +1622,7 @@ class TcbExpressionTranslator {\n         return null;\n       }\n \n-      const method = ts.createPropertyAccess(wrapForDiagnostics(receiver), ast.name);\n+      const method = wrapForDiagnostics(receiver);\n       addParseSpanInfo(method, ast.nameSpan);\n       const args = ast.args.map(arg => this.translate(arg));\n       const node = ts.createCall(method, undefined, args);"
        },
        {
            "sha": "6d8236e23e03311bea511617fad8b33cee58a80c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/span_comments_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fspan_comments_spec.ts?ref=a61fe96b7078edf31c2e90c01ee74c544242d2d4",
            "patch": "@@ -71,7 +71,7 @@ describe('type check blocks diagnostics', () => {\n       const TEMPLATE = `<ng-template let-method>{{ method(a, b) }}</ng-template>`;\n       expect(tcbWithSpans(TEMPLATE))\n           .toContain(\n-              '(_t2 /*27,39*/).method /*27,33*/(((ctx).a /*34,35*/) /*34,35*/, ((ctx).b /*37,38*/) /*37,38*/) /*27,39*/');\n+              '(_t2 /*27,39*/) /*27,33*/(((ctx).a /*34,35*/) /*34,35*/, ((ctx).b /*37,38*/) /*37,38*/) /*27,39*/');\n     });\n \n     it('should annotate function calls', () => {"
        },
        {
            "sha": "82fc1d0583c0cfa02368e914cf4d47f6221b8f7e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=a61fe96b7078edf31c2e90c01ee74c544242d2d4",
            "patch": "@@ -106,14 +106,20 @@ describe('type check blocks', () => {\n   it('should handle method calls of template variables', () => {\n     const TEMPLATE = `<ng-template let-a>{{a(1)}}</ng-template>`;\n     expect(tcb(TEMPLATE)).toContain('var _t2 = _t1.$implicit;');\n-    expect(tcb(TEMPLATE)).toContain('(_t2).a(1)');\n+    expect(tcb(TEMPLATE)).toContain('(_t2)(1)');\n   });\n \n   it('should handle implicit vars when using microsyntax', () => {\n     const TEMPLATE = `<div *ngFor=\"let user of users\"></div>`;\n     expect(tcb(TEMPLATE)).toContain('var _t2 = _t1.$implicit;');\n   });\n \n+  it('should handle direct calls of an implicit template variable', () => {\n+    const TEMPLATE = `<div *ngFor=\"let a of letters\">{{a(1)}}</div>`;\n+    expect(tcb(TEMPLATE)).toContain('var _t2 = _t1.$implicit;');\n+    expect(tcb(TEMPLATE)).toContain('(_t2)(1)');\n+  });\n+\n   describe('type constructors', () => {\n     it('should handle missing property bindings', () => {\n       const TEMPLATE = `<div dir [inputA]=\"foo\"></div>`;"
        },
        {
            "sha": "80d0f20199df5ebe3308df92578a079a935b3654",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a61fe96b7078edf31c2e90c01ee74c544242d2d4/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=a61fe96b7078edf31c2e90c01ee74c544242d2d4",
            "patch": "@@ -1009,6 +1009,30 @@ export declare class AnimationEvent {\n       expect(diags.length).toBe(0);\n     });\n \n+    it('should allow the implicit value of an NgFor to be invoked', () => {\n+      env.tsconfig({fullTemplateTypeCheck: true, strictInputTypes: true});\n+      env.write('test.ts', `\n+        import {CommonModule} from '@angular/common';\n+        import {Component, NgModule} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<div *ngFor=\"let fn of functions\">{{fn()}}</div>',\n+        })\n+        class TestCmp {\n+          functions = [() => 1, () => 2];\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp],\n+          imports: [CommonModule],\n+        })\n+        class Module {}\n+    `);\n+\n+      env.driveMain();\n+    });\n+\n     it('should infer the context of NgIf', () => {\n       env.tsconfig({strictTemplates: true});\n       env.write('test.ts', `"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 33,
        "deletions": 3
    }
}