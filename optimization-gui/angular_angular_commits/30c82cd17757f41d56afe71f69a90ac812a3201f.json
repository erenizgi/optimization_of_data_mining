{
    "author": "JoostK",
    "message": "fix(compiler-cli): inline type checking instructions no longer prevent incremental reuse (#42759)\n\nSource files that contain directives or components that need an inline\ntype constructor or inline template type-check block would always be\nconsidered as affected in incremental rebuilds. The inline operations\ncause the source file to be updated in the TypeScript program that is\ncreated for template type-checking, which becomes the reuse program\nin a subsequent incremental rebuild.\n\nIn an incremental rebuild, the source files from the new user program\nare compared to those from the reuse program. The updated source files\nare not the same as the original source file from the user program, so\nthe incremental engine would mark the file which needed inline\noperations as affected. This prevents incremental reuse for these files,\ncausing sub-optimal rebuild performance.\n\nThis commit attaches the original source file for source files that have\nbeen updated with inline operations, such that the incremental engine\nis able to compare source files using the original source file.\n\nFixes #42543\n\nPR Close #42759",
    "sha": "30c82cd17757f41d56afe71f69a90ac812a3201f",
    "files": [
        {
            "sha": "dcc37051f9affdd166b7698bc6316b0cb6caebc5",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -20,7 +20,7 @@ import {generateAnalysis, IndexedComponent, IndexingContext} from '../../indexer\n import {ComponentResources, CompoundMetadataReader, CompoundMetadataRegistry, DirectiveMeta, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry, MetadataReader, PipeMeta, ResourceRegistry} from '../../metadata';\n import {PartialEvaluator} from '../../partial_evaluator';\n import {ActivePerfRecorder, DelegatingPerfRecorder, PerfCheckpoint, PerfEvent, PerfPhase} from '../../perf';\n-import {ProgramDriver, UpdateMode} from '../../program_driver';\n+import {FileUpdate, ProgramDriver, UpdateMode} from '../../program_driver';\n import {DeclarationNode, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {AdapterResourceLoader} from '../../resource';\n import {entryPointKeyFor, NgModuleRouteAnalyzer} from '../../routing';\n@@ -1180,7 +1180,7 @@ class NotifyingProgramDriverWrapper implements ProgramDriver {\n     return this.delegate.getProgram();\n   }\n \n-  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void {\n+  updateFiles(contents: Map<AbsoluteFsPath, FileUpdate>, updateMode: UpdateMode): void {\n     this.delegate.updateFiles(contents, updateMode);\n     this.notifyNewProgram(this.delegate.getProgram());\n   }"
        },
        {
            "sha": "78f5074011633a069581d9963a803842636b1c02",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2FBUILD.bazel?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -15,6 +15,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/partial_evaluator\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n+        \"//packages/compiler-cli/src/ngtsc/program_driver\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/transform\","
        },
        {
            "sha": "7ef18d83c221716b5b08cbc4cc84816807900af3",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/incremental.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -10,11 +10,13 @@ import * as ts from 'typescript';\n \n import {absoluteFromSourceFile, AbsoluteFsPath, resolve} from '../../file_system';\n import {PerfPhase, PerfRecorder} from '../../perf';\n+import {MaybeSourceFileWithOriginalFile, NgOriginalFile} from '../../program_driver';\n import {ClassRecord, TraitCompiler} from '../../transform';\n import {FileTypeCheckingData} from '../../typecheck';\n import {toUnredirectedSourceFile} from '../../util/src/typescript';\n import {IncrementalBuild} from '../api';\n import {SemanticDepGraphUpdater} from '../semantic_graph';\n+\n import {FileDependencyGraph} from './dependency_tracking';\n import {AnalyzedIncrementalState, DeltaIncrementalState, IncrementalState, IncrementalStateKind} from './state';\n \n@@ -134,12 +136,12 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n \n       const oldVersions = priorAnalysis.versions;\n \n-      const oldFilesArray = oldProgram.getSourceFiles().map(sf => toUnredirectedSourceFile(sf));\n+      const oldFilesArray = oldProgram.getSourceFiles().map(toOriginalSourceFile);\n       const oldFiles = new Set(oldFilesArray);\n       const deletedTsFiles = new Set(oldFilesArray.map(sf => absoluteFromSourceFile(sf)));\n \n       for (const possiblyRedirectedNewFile of program.getSourceFiles()) {\n-        const sf = toUnredirectedSourceFile(possiblyRedirectedNewFile);\n+        const sf = toOriginalSourceFile(possiblyRedirectedNewFile);\n         const sfPath = absoluteFromSourceFile(sf);\n         // Since we're seeing a file in the incoming program with this name, it can't have been\n         // deleted.\n@@ -373,3 +375,28 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n     return this.step.priorState.emitted.has(sfPath);\n   }\n }\n+\n+/**\n+ * To accurately detect whether a source file was affected during an incremental rebuild, the\n+ * \"original\" source file needs to be consistently used.\n+ *\n+ * First, TypeScript may have created source file redirects when declaration files of the same\n+ * version of a library are included multiple times. The non-redirected source file should be used\n+ * to detect changes, as otherwise the redirected source files cause a mismatch when compared to\n+ * a prior program.\n+ *\n+ * Second, the program that is used for template type checking may contain mutated source files, if\n+ * inline type constructors or inline template type-check blocks had to be used. Such source files\n+ * store their original, non-mutated source file from the original program in a symbol. For\n+ * computing the affected files in an incremental build this original source file should be used, as\n+ * the mutated source file would always be considered affected.\n+ */\n+function toOriginalSourceFile(sf: ts.SourceFile): ts.SourceFile {\n+  const unredirectedSf = toUnredirectedSourceFile(sf);\n+  const originalFile = (unredirectedSf as MaybeSourceFileWithOriginalFile)[NgOriginalFile];\n+  if (originalFile !== undefined) {\n+    return originalFile;\n+  } else {\n+    return unredirectedSf;\n+  }\n+}"
        },
        {
            "sha": "f837244d1681cf3aef150ad483e3f4d40ea57633",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/src/api.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fapi.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -9,6 +9,29 @@\n import * as ts from 'typescript';\n import {AbsoluteFsPath} from '../../file_system';\n \n+export interface FileUpdate {\n+  /**\n+   * The source file text.\n+   */\n+  newText: string;\n+\n+  /**\n+   * Represents the source file from the original program that is being updated. If the file update\n+   * targets a shim file then this is null, as shim files do not have an associated original file.\n+   */\n+  originalFile: ts.SourceFile|null;\n+}\n+\n+export const NgOriginalFile = Symbol('NgOriginalFile');\n+\n+/**\n+ * If an updated file has an associated original source file, then the original source file\n+ * is attached to the updated file using the `NgOriginalFile` symbol.\n+ */\n+export interface MaybeSourceFileWithOriginalFile extends ts.SourceFile {\n+  [NgOriginalFile]?: ts.SourceFile;\n+}\n+\n export interface ProgramDriver {\n   /**\n    * Whether this strategy supports modifying user files (inline modifications) in addition to\n@@ -25,7 +48,7 @@ export interface ProgramDriver {\n    * Incorporate a set of changes to either augment or completely replace the type-checking code\n    * included in the type-checking program.\n    */\n-  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void;\n+  updateFiles(contents: Map<AbsoluteFsPath, FileUpdate>, updateMode: UpdateMode): void;\n \n   /**\n    * Retrieve a string version for a given `ts.SourceFile`, which much change when the contents of"
        },
        {
            "sha": "5c4c483fb1f2d8da80bf28703f15a498aefa58d2",
            "filename": "packages/compiler-cli/src/ngtsc/program_driver/src/ts_create_program_driver.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram_driver%2Fsrc%2Fts_create_program_driver.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -12,7 +12,7 @@ import {AbsoluteFsPath} from '../../file_system';\n import {copyFileShimData, retagAllTsFiles, ShimReferenceTagger, untagAllTsFiles} from '../../shims';\n import {RequiredDelegations, toUnredirectedSourceFile} from '../../util/src/typescript';\n \n-import {ProgramDriver, UpdateMode} from './api';\n+import {FileUpdate, MaybeSourceFileWithOriginalFile, NgOriginalFile, ProgramDriver, UpdateMode} from './api';\n \n /**\n  * Delegates all methods of `ts.CompilerHost` to a delegate, with the exception of\n@@ -153,7 +153,7 @@ export class TsCreateProgramDriver implements ProgramDriver {\n     return this.program;\n   }\n \n-  updateFiles(contents: Map<AbsoluteFsPath, string>, updateMode: UpdateMode): void {\n+  updateFiles(contents: Map<AbsoluteFsPath, FileUpdate>, updateMode: UpdateMode): void {\n     if (contents.size === 0) {\n       // No changes have been requested. Is it safe to skip updating entirely?\n       // If UpdateMode is Incremental, then yes. If UpdateMode is Complete, then it's safe to skip\n@@ -169,8 +169,12 @@ export class TsCreateProgramDriver implements ProgramDriver {\n       this.sfMap.clear();\n     }\n \n-    for (const [filePath, text] of contents.entries()) {\n-      this.sfMap.set(filePath, ts.createSourceFile(filePath, text, ts.ScriptTarget.Latest, true));\n+    for (const [filePath, {newText, originalFile}] of contents.entries()) {\n+      const sf = ts.createSourceFile(filePath, newText, ts.ScriptTarget.Latest, true);\n+      if (originalFile !== null) {\n+        (sf as MaybeSourceFileWithOriginalFile)[NgOriginalFile] = originalFile;\n+      }\n+      this.sfMap.set(filePath, sf);\n     }\n \n     const host = new UpdatedProgramHost("
        },
        {
            "sha": "d1ac3e3eac782252a5b0e318c5dadcc2245576e2",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -13,6 +13,7 @@ import * as ts from 'typescript';\n import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {PerfEvent, PerfRecorder} from '../../perf';\n+import {FileUpdate} from '../../program_driver';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n@@ -376,13 +377,16 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n     return code;\n   }\n \n-  finalize(): Map<AbsoluteFsPath, string> {\n+  finalize(): Map<AbsoluteFsPath, FileUpdate> {\n     // First, build the map of updates to source files.\n-    const updates = new Map<AbsoluteFsPath, string>();\n+    const updates = new Map<AbsoluteFsPath, FileUpdate>();\n     for (const originalSf of this.opMap.keys()) {\n       const newText = this.transform(originalSf);\n       if (newText !== null) {\n-        updates.set(absoluteFromSourceFile(originalSf), newText);\n+        updates.set(absoluteFromSourceFile(originalSf), {\n+          newText,\n+          originalFile: originalSf,\n+        });\n       }\n     }\n \n@@ -399,8 +403,13 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n           path: pendingShimData.file.fileName,\n           templates: pendingShimData.templates,\n         });\n-        updates.set(\n-            pendingShimData.file.fileName, pendingShimData.file.render(false /* removeComments */));\n+        const sfText = pendingShimData.file.render(false /* removeComments */);\n+        updates.set(pendingShimData.file.fileName, {\n+          newText: sfText,\n+\n+          // Shim files do not have an associated original file.\n+          originalFile: null,\n+        });\n       }\n     }\n "
        },
        {
            "sha": "39027c315ab35466d06764a42b30f5dabc1c3c44",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/program_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -10,7 +10,7 @@ import * as ts from 'typescript';\n \n import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n-import {TsCreateProgramDriver, UpdateMode} from '../../program_driver';\n+import {FileUpdate, TsCreateProgramDriver, UpdateMode} from '../../program_driver';\n import {sfExtensionData, ShimReferenceTagger} from '../../shims';\n import {expectCompleteReuse, makeProgram} from '../../testing';\n import {OptimizeFor} from '../api';\n@@ -42,7 +42,8 @@ runInEachFileSystem(() => {\n       // Update /main.ngtypecheck.ts without changing its shape. Verify that the old program was\n       // reused completely.\n       programStrategy.updateFiles(\n-          new Map([[typecheckPath, 'export const VERSION = 2;']]), UpdateMode.Complete);\n+          new Map([[typecheckPath, createUpdate('export const VERSION = 2;')]]),\n+          UpdateMode.Complete);\n \n       expectCompleteReuse(programStrategy.getProgram());\n     });\n@@ -54,13 +55,21 @@ runInEachFileSystem(() => {\n       // Update /main.ts without changing its shape. Verify that the old program was reused\n       // completely.\n       programStrategy.updateFiles(\n-          new Map([[mainPath, 'export const STILL_NOT_A_COMPONENT = true;']]), UpdateMode.Complete);\n+          new Map([[mainPath, createUpdate('export const STILL_NOT_A_COMPONENT = true;')]]),\n+          UpdateMode.Complete);\n \n       expectCompleteReuse(programStrategy.getProgram());\n     });\n   });\n });\n \n+function createUpdate(text: string): FileUpdate {\n+  return {\n+    newText: text,\n+    originalFile: null,\n+  };\n+}\n+\n function makeSingleFileProgramWithTypecheckShim(): {\n   program: ts.Program,\n   host: ts.CompilerHost,"
        },
        {
            "sha": "8e2827ae9005407b4a4dbc7a11f9086002f1899f",
            "filename": "packages/compiler-cli/test/ngtsc/incremental_spec.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fincremental_spec.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -895,6 +895,53 @@ runInEachFileSystem(() => {\n           expect(diags[0].messageText)\n               .toContain(`Type '\"gamma\"' is not assignable to type 'keyof Keys'.`);\n         });\n+\n+        it('should not re-emit files that need inline type constructors', () => {\n+          // Setup a directive that requires an inline type constructor, as it has a generic type\n+          // parameter that refer an interface that has not been exported. The inline operation\n+          // causes an updated dir.ts to be used in the type-check program, which should not\n+          // confuse the incremental engine in undesirably considering dir.ts as affected in\n+          // incremental rebuilds.\n+          env.write('dir.ts', `\n+            import {Directive, Input} from '@angular/core';\n+            interface Keys {\n+              alpha: string;\n+              beta: string;\n+            }\n+            @Directive({\n+              selector: '[dir]'\n+            })\n+            export class Dir<T extends keyof Keys> {\n+              @Input() dir: T;\n+            }\n+          `);\n+\n+          env.write('cmp.ts', `\n+            import {Component, NgModule} from '@angular/core';\n+            import {Dir} from './dir';\n+            @Component({\n+              selector: 'test-cmp',\n+              template: '<div dir=\"alpha\"></div>',\n+            })\n+            export class Cmp {}\n+            @NgModule({\n+              declarations: [Cmp, Dir],\n+            })\n+            export class Module {}\n+          `);\n+          env.driveMain();\n+\n+          // Trigger a recompile by changing cmp.ts.\n+          env.invalidateCachedFile('cmp.ts');\n+\n+          env.flushWrittenFileTracking();\n+          env.driveMain();\n+\n+          // Verify that only cmp.ts was emitted, but not dir.ts as it was not affected.\n+          const written = env.getFilesWrittenSinceLastFlush();\n+          expect(written).toContain('/cmp.js');\n+          expect(written).not.toContain('/dir.js');\n+        });\n       });\n     });\n   });"
        },
        {
            "sha": "66573f971d51b4e4a0c05c6e38dccc42c45f862a",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/30c82cd17757f41d56afe71f69a90ac812a3201f/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=30c82cd17757f41d56afe71f69a90ac812a3201f",
            "patch": "@@ -12,7 +12,7 @@ import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {ErrorCode, ngErrorCode} from '@angular/compiler-cli/src/ngtsc/diagnostics';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {PerfPhase} from '@angular/compiler-cli/src/ngtsc/perf';\n-import {ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n+import {FileUpdate, ProgramDriver} from '@angular/compiler-cli/src/ngtsc/program_driver';\n import {isNamedClassDeclaration} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n@@ -483,8 +483,8 @@ function createProgramDriver(project: ts.server.Project): ProgramDriver {\n       }\n       return program;\n     },\n-    updateFiles(contents: Map<AbsoluteFsPath, string>) {\n-      for (const [fileName, newText] of contents) {\n+    updateFiles(contents: Map<AbsoluteFsPath, FileUpdate>) {\n+      for (const [fileName, {newText}] of contents) {\n         const scriptInfo = getOrCreateTypeCheckScriptInfo(project, fileName);\n         const snapshot = scriptInfo.getSnapshot();\n         const length = snapshot.getLength();"
        }
    ],
    "stats": {
        "total": 160,
        "additions": 140,
        "deletions": 20
    }
}