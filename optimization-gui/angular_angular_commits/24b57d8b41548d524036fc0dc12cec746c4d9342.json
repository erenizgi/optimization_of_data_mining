{
    "author": "mhevery",
    "message": "refactor(core): Cleanup circular dependency between ViewEngine and Ivy `ChangeDetectorRef`. (#39621)\n\n`ChangeDetectorRef` is declared in ViewEngine but it sub-classed in Ivy. This creates a circular\ndependency between ViewEngine `ChangeDetectorRef` which needs to declare `__NG_ELEMENT_ID__` and\nivy factory which needs to create it. The workaround used to be to pass the `ChangeDetectorRef`\nthrough stack but that created a very convoluted code. This refactoring simply bundles the\ntwo files together and removes the stack workaround making the code simpler to follow.\n\nPR Close #39621",
    "sha": "24b57d8b41548d524036fc0dc12cec746c4d9342",
    "files": [
        {
            "sha": "38ad9b0ce5ab4f2168cdda037482692bbd355090",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 140,
            "deletions": 42,
            "changes": 182,
            "blob_url": "https://github.com/angular/angular/blob/24b57d8b41548d524036fc0dc12cec746c4d9342/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/24b57d8b41548d524036fc0dc12cec746c4d9342/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=24b57d8b41548d524036fc0dc12cec746c4d9342",
            "patch": "@@ -146,8 +146,26 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n+    \"packages/core/src/linker/view_ref.ts\"\n+  ],\n+  [\n+    \"packages/core/src/application_ref.ts\",\n+    \"packages/core/src/application_tokens.ts\",\n+    \"packages/core/src/linker/component_factory.ts\",\n+    \"packages/core/src/change_detection/change_detection.ts\",\n+    \"packages/core/src/change_detection/change_detector_ref.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/di/injector.ts\",\n     \"packages/core/src/di/r3_injector.ts\",\n@@ -160,8 +178,12 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/metadata.ts\",\n     \"packages/core/src/di.ts\",\n@@ -181,20 +203,12 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\",\n-    \"packages/core/src/render3/interfaces/container.ts\",\n-    \"packages/core/src/linker/view_ref.ts\"\n-  ],\n-  [\n-    \"packages/core/src/application_ref.ts\",\n-    \"packages/core/src/application_tokens.ts\",\n-    \"packages/core/src/linker/component_factory.ts\",\n-    \"packages/core/src/change_detection/change_detection.ts\",\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n-    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/render3/interfaces/definition.ts\",\n     \"packages/core/src/core.ts\",\n@@ -216,6 +230,9 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n     \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/state.ts\",\n     \"packages/core/src/render3/assert.ts\",\n@@ -228,7 +245,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\"\n   ],\n   [\n@@ -237,7 +253,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/di/injector.ts\",\n@@ -251,7 +266,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/di.ts\",\n@@ -267,7 +281,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/di.ts\",\n@@ -282,7 +295,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/di.ts\",\n@@ -295,7 +307,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -316,7 +327,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -340,7 +350,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -359,7 +368,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -379,7 +387,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -392,7 +399,6 @@\n     \"packages/core/src/linker/component_factory.ts\",\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -844,15 +850,13 @@\n   [\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/linker/component_factory.ts\"\n   ],\n   [\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -864,7 +868,6 @@\n   [\n     \"packages/core/src/change_detection/change_detection.ts\",\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\",\n     \"packages/core/src/linker/view_container_ref.ts\",\n     \"packages/core/src/render3/instructions/shared.ts\",\n@@ -877,19 +880,16 @@\n   ],\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\"\n-  ],\n-  [\n-    \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\",\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/linker/view_ref.ts\"\n   ],\n   [\n     \"packages/core/src/change_detection/change_detector_ref.ts\",\n-    \"packages/core/src/render3/view_engine_compatibility.ts\",\n     \"packages/core/src/render3/view_ref.ts\"\n   ],\n   [\n@@ -998,31 +998,129 @@\n     \"packages/core/src/render3/view_engine_compatibility.ts\"\n   ],\n   [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\"\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n     \"packages/core/src/render3/interfaces/container.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\"\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n     \"packages/core/src/render3/interfaces/definition.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\"\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n-    \"packages/core/src/render3/interfaces/definition.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\"\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\",\n+    \"packages/core/src/render3/interfaces/query.ts\",\n     \"packages/core/src/render3/interfaces/node.ts\",\n-    \"packages/core/src/render3/interfaces/view.ts\"\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n   ],\n   [\n-    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/container.ts\",\n     \"packages/core/src/render3/interfaces/view.ts\",\n-    \"packages/core/src/render3/interfaces/query.ts\"\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/interfaces/type_checks.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/state.ts\",\n+    \"packages/core/src/render3/assert.ts\",\n+    \"packages/core/src/render3/interfaces/injector.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/state.ts\",\n+    \"packages/core/src/render3/assert.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/state.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/state.ts\",\n+    \"packages/core/src/render3/util/view_utils.ts\",\n+    \"packages/core/src/render3/interfaces/context.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/state.ts\",\n+    \"packages/core/src/render3/util/view_utils.ts\",\n+    \"packages/core/src/render3/interfaces/node.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render/api.ts\",\n+    \"packages/core/src/render3/view_engine_compatibility.ts\",\n+    \"packages/core/src/render3/state.ts\",\n+    \"packages/core/src/render3/util/view_utils.ts\",\n+    \"packages/core/src/render3/interfaces/renderer.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render3/interfaces/container.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\"\n+  ],\n+  [\n+    \"packages/core/src/render3/interfaces/definition.ts\",\n+    \"packages/core/src/render3/interfaces/view.ts\"\n   ],\n   [\n     \"packages/core/src/render3/interfaces/query.ts\","
        },
        {
            "sha": "f467d4faf8c9f8f24ea693fce0ee5a3583b64cb6",
            "filename": "packages/core/src/change_detection/change_detector_ref.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 6,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Fchange_detection%2Fchange_detector_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Fchange_detection%2Fchange_detector_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fchange_detection%2Fchange_detector_ref.ts?ref=24b57d8b41548d524036fc0dc12cec746c4d9342",
            "patch": "@@ -6,7 +6,18 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {injectChangeDetectorRef as render3InjectChangeDetectorRef} from '../render3/view_engine_compatibility';\n+import {TNode, TNodeType} from '../render3/interfaces/node';\n+import {isComponentHost} from '../render3/interfaces/type_checks';\n+import {DECLARATION_COMPONENT_VIEW, LView} from '../render3/interfaces/view';\n+import {getCurrentTNode, getLView} from '../render3/state';\n+import {getComponentLViewByIndex} from '../render3/util/view_utils';\n+import {ViewRef as R3_ViewRef} from '../render3/view_ref';\n+import {noop} from '../util/noop';\n+\n+export const SWITCH_CHANGE_DETECTOR_REF_FACTORY__POST_R3__ = injectChangeDetectorRef;\n+const SWITCH_CHANGE_DETECTOR_REF_FACTORY__PRE_R3__ = noop;\n+const SWITCH_CHANGE_DETECTOR_REF_FACTORY: typeof injectChangeDetectorRef =\n+    SWITCH_CHANGE_DETECTOR_REF_FACTORY__PRE_R3__;\n \n /**\n  * Base class that provides change detection functionality.\n@@ -114,12 +125,38 @@ export abstract class ChangeDetectorRef {\n    * @internal\n    * @nocollapse\n    */\n-  static __NG_ELEMENT_ID__: () => ChangeDetectorRef = () => SWITCH_CHANGE_DETECTOR_REF_FACTORY();\n+  static __NG_ELEMENT_ID__: () => ChangeDetectorRef = SWITCH_CHANGE_DETECTOR_REF_FACTORY;\n }\n \n \n \n-export const SWITCH_CHANGE_DETECTOR_REF_FACTORY__POST_R3__ = render3InjectChangeDetectorRef;\n-const SWITCH_CHANGE_DETECTOR_REF_FACTORY__PRE_R3__ = (...args: any[]): any => {};\n-const SWITCH_CHANGE_DETECTOR_REF_FACTORY: typeof render3InjectChangeDetectorRef =\n-    SWITCH_CHANGE_DETECTOR_REF_FACTORY__PRE_R3__;\n+/** Returns a ChangeDetectorRef (a.k.a. a ViewRef) */\n+export function injectChangeDetectorRef(isPipe = false): ChangeDetectorRef {\n+  return createViewRef(getCurrentTNode()!, getLView(), isPipe);\n+}\n+\n+/**\n+ * Creates a ViewRef and stores it on the injector as ChangeDetectorRef (public alias).\n+ *\n+ * @param tNode The node that is requesting a ChangeDetectorRef\n+ * @param lView The view to which the node belongs\n+ * @param isPipe Whether the view is being injected into a pipe.\n+ * @returns The ChangeDetectorRef to use\n+ */\n+function createViewRef(tNode: TNode, lView: LView, isPipe: boolean): ChangeDetectorRef {\n+  // `isComponentView` will be true for Component and Directives (but not for Pipes).\n+  // See https://github.com/angular/angular/pull/33072 for proper fix\n+  const isComponentView = !isPipe && isComponentHost(tNode);\n+  if (isComponentView) {\n+    // The LView represents the location where the component is declared.\n+    // Instead we want the LView for the component View and so we need to look it up.\n+    const componentView = getComponentLViewByIndex(tNode.index, lView);  // look down\n+    return new R3_ViewRef(componentView, componentView);\n+  } else if (tNode.type & (TNodeType.AnyRNode | TNodeType.AnyContainer | TNodeType.Icu)) {\n+    // The LView represents the location where the injection is requested from.\n+    // We need to locate the containing LView (in case where the `lView` is an embedded view)\n+    const hostComponentView = lView[DECLARATION_COMPONENT_VIEW];  // look up\n+    return new R3_ViewRef(hostComponentView, lView);\n+  }\n+  return null!;\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "8d5d8cc4147a61229c62383c3a0340d1ec9600c8",
            "filename": "packages/core/src/render3/view_engine_compatibility.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 36,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility.ts?ref=24b57d8b41548d524036fc0dc12cec746c4d9342",
            "patch": "@@ -6,49 +6,15 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ChangeDetectorRef as ViewEngine_ChangeDetectorRef} from '../change_detection/change_detector_ref';\n import {Renderer2} from '../render/api';\n-import {TNode, TNodeType} from './interfaces/node';\n import {isProceduralRenderer} from './interfaces/renderer';\n-import {isComponentHost, isLView} from './interfaces/type_checks';\n-import {DECLARATION_COMPONENT_VIEW, LView, RENDERER} from './interfaces/view';\n+import {isLView} from './interfaces/type_checks';\n+import {LView, RENDERER} from './interfaces/view';\n import {getCurrentTNode, getLView} from './state';\n import {getComponentLViewByIndex} from './util/view_utils';\n-import {ViewRef} from './view_ref';\n \n \n \n-/** Returns a ChangeDetectorRef (a.k.a. a ViewRef) */\n-export function injectChangeDetectorRef(isPipe = false): ViewEngine_ChangeDetectorRef {\n-  return createViewRef(getCurrentTNode()!, getLView(), isPipe);\n-}\n-\n-/**\n- * Creates a ViewRef and stores it on the injector as ChangeDetectorRef (public alias).\n- *\n- * @param tNode The node that is requesting a ChangeDetectorRef\n- * @param lView The view to which the node belongs\n- * @param isPipe Whether the view is being injected into a pipe.\n- * @returns The ChangeDetectorRef to use\n- */\n-function createViewRef(tNode: TNode, lView: LView, isPipe: boolean): ViewEngine_ChangeDetectorRef {\n-  // `isComponentView` will be true for Component and Directives (but not for Pipes).\n-  // See https://github.com/angular/angular/pull/33072 for proper fix\n-  const isComponentView = !isPipe && isComponentHost(tNode);\n-  if (isComponentView) {\n-    // The LView represents the location where the component is declared.\n-    // Instead we want the LView for the component View and so we need to look it up.\n-    const componentView = getComponentLViewByIndex(tNode.index, lView);  // look down\n-    return new ViewRef(componentView, componentView);\n-  } else if (tNode.type & (TNodeType.AnyRNode | TNodeType.AnyContainer | TNodeType.Icu)) {\n-    // The LView represents the location where the injection is requested from.\n-    // We need to locate the containing LView (in case where the `lView` is an embedded view)\n-    const hostComponentView = lView[DECLARATION_COMPONENT_VIEW];  // look up\n-    return new ViewRef(hostComponentView, lView);\n-  }\n-  return null!;\n-}\n-\n /** Returns a Renderer2 (or throws when application was bootstrapped with Renderer3) */\n function getOrCreateRenderer2(view: LView): Renderer2 {\n   const renderer = view[RENDERER];"
        },
        {
            "sha": "2b748eef3261dd3081b04268e79e371d83552998",
            "filename": "packages/core/src/render3/view_engine_compatibility_prebound.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts",
            "raw_url": "https://github.com/angular/angular/raw/24b57d8b41548d524036fc0dc12cec746c4d9342/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_engine_compatibility_prebound.ts?ref=24b57d8b41548d524036fc0dc12cec746c4d9342",
            "patch": "@@ -7,13 +7,12 @@\n  */\n \n \n-import {ChangeDetectorRef} from '../change_detection/change_detector_ref';\n+import {ChangeDetectorRef, injectChangeDetectorRef} from '../change_detection/change_detector_ref';\n import {InjectFlags} from '../di/interface/injector';\n import {createTemplateRef, TemplateRef} from '../linker/template_ref';\n import {throwProviderNotFoundError} from './errors';\n import {TNode} from './interfaces/node';\n import {LView} from './interfaces/view';\n-import {injectChangeDetectorRef} from './view_engine_compatibility';\n \n \n /**"
        }
    ],
    "stats": {
        "total": 272,
        "additions": 186,
        "deletions": 86
    }
}