{
    "author": "clydin",
    "message": "feat(compiler-cli): support getting resource dependencies for a source file (#38048)\n\nThe compiler maintains an internal dependency graph of all resource\ndependencies for application source files. This information can be useful\nfor tools that integrate the compiler and need to support file watching.\nThis change adds a `getResourceDependencies` method to the\n`NgCompiler` class that allows compiler integrations to access resource\ndependencies of files within the compilation.\n\nPR Close #38048",
    "sha": "5dbf3572248941698088798c655b4c412e7ee0cb",
    "files": [
        {
            "sha": "a867e72613937995927ff3df38017f9718713d3e",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/5dbf3572248941698088798c655b4c412e7ee0cb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/5dbf3572248941698088798c655b4c412e7ee0cb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=5dbf3572248941698088798c655b4c412e7ee0cb",
            "patch": "@@ -162,6 +162,17 @@ export class NgCompiler {\n     this.ignoreForEmit = this.adapter.ignoreForEmit;\n   }\n \n+  /**\n+   * Get the resource dependencies of a file.\n+   *\n+   * If the file is not part of the compilation, an empty array will be returned.\n+   */\n+  getResourceDependencies(file: ts.SourceFile): string[] {\n+    this.ensureAnalyzed();\n+\n+    return this.incrementalDriver.depGraph.getResourceDependencies(file);\n+  }\n+\n   /**\n    * Get all Angular-related diagnostics for this compilation.\n    *"
        },
        {
            "sha": "9e873e720e1ff5df826009403ca4a9e97e4dacdb",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/compiler_test.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/5dbf3572248941698088798c655b4c412e7ee0cb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/5dbf3572248941698088798c655b4c412e7ee0cb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts?ref=5dbf3572248941698088798c655b4c412e7ee0cb",
            "patch": "@@ -105,6 +105,40 @@ runInEachFileSystem(() => {\n         expect(components).toEqual(new Set([CmpA, CmpC]));\n       });\n     });\n+\n+    describe('getResourceDependencies', () => {\n+      it('should return resource dependencies of a component source file', () => {\n+        const COMPONENT = _('/cmp.ts');\n+        fs.writeFile(COMPONENT, `\n+          import {Component} from '@angular/core';\n+          @Component({\n+            selector: 'test-cmp',\n+            templateUrl: './template.html',\n+            styleUrls: ['./style.css'],\n+          })\n+          export class Cmp {}\n+        `);\n+        fs.writeFile(_('/template.html'), `<h1>Resource</h1>`);\n+        fs.writeFile(_('/style.css'), `h1 { }`);\n+\n+        const options: NgCompilerOptions = {\n+          strictTemplates: true,\n+        };\n+        const baseHost = new NgtscCompilerHost(getFileSystem(), options);\n+        const host = NgCompilerHost.wrap(baseHost, [COMPONENT], options, /* oldProgram */ null);\n+        const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n+        const compiler = new NgCompiler(\n+            host, options, program, new ReusedProgramStrategy(program, host, options, []),\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+\n+        const deps = compiler.getResourceDependencies(getSourceFileOrError(program, COMPONENT));\n+        expect(deps.length).toBe(2);\n+        expect(deps).toEqual(jasmine.arrayContaining([\n+          jasmine.stringMatching(/\\/template.html$/),\n+          jasmine.stringMatching(/\\/style.css$/),\n+        ]));\n+      });\n+    });\n   });\n });\n "
        },
        {
            "sha": "42fc122f00e60226d8e189cc8a45fbebca05f1e5",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/dependency_tracking.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/5dbf3572248941698088798c655b4c412e7ee0cb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fdependency_tracking.ts",
            "raw_url": "https://github.com/angular/angular/raw/5dbf3572248941698088798c655b4c412e7ee0cb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fdependency_tracking.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fdependency_tracking.ts?ref=5dbf3572248941698088798c655b4c412e7ee0cb",
            "patch": "@@ -53,6 +53,12 @@ export class FileDependencyGraph<T extends {fileName: string} = ts.SourceFile> i\n     }\n   }\n \n+  getResourceDependencies(from: T): AbsoluteFsPath[] {\n+    const node = this.nodes.get(from);\n+\n+    return node ? [...node.usesResources] : [];\n+  }\n+\n   isStale(sf: T, changedTsPaths: Set<string>, changedResources: Set<AbsoluteFsPath>): boolean {\n     return isLogicallyChanged(sf, this.nodeFor(sf), changedTsPaths, EMPTY_SET, changedResources);\n   }"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 51,
        "deletions": 0
    }
}