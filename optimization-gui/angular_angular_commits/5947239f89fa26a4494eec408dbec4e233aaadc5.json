{
    "author": "devversion",
    "message": "fix(dev-infra): do not set lts dist tag on packages from release-candidate train (#41946)\n\nCurrently if a major release-train in the `release-candidate`/`feature-freeze`\nphase becomes `latest`, we intend to set the NPM LTS dist tag for all packages\nof the previous major (as the old release train in `latest` moves into LTS phase).\n\nThe logic for this exists but the release tool sets the NPM dist tag for\nall packages of the new major. This means that the script might error if\na new package is part of the new major; or it could cause a deleted\npackage to not receive the LTS tag properly.\n\nPR Close #41946",
    "sha": "5947239f89fa26a4494eec408dbec4e233aaadc5",
    "files": [
        {
            "sha": "92d0715da2efed33e9408c2be4014f662932cfe1",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/5947239f89fa26a4494eec408dbec4e233aaadc5/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/5947239f89fa26a4494eec408dbec4e233aaadc5/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=5947239f89fa26a4494eec408dbec4e233aaadc5",
            "patch": "@@ -6500,16 +6500,17 @@ class CutStableAction extends ReleaseAction {\n             // If a new major version is published and becomes the \"latest\" release-train, we need\n             // to set the LTS npm dist tag for the previous latest release-train (the current patch).\n             if (isNewMajor) {\n-                const previousPatchVersion = this.active.latest.version;\n-                const ltsTagForPatch = getLtsNpmDistTagOfMajor(previousPatchVersion.major);\n+                const previousPatch = this.active.latest;\n+                const ltsTagForPatch = getLtsNpmDistTagOfMajor(previousPatch.version.major);\n                 // Instead of directly setting the NPM dist tags, we invoke the ng-dev command for\n                 // setting the NPM dist tag to the specified version. We do this because release NPM\n                 // packages could be different in the previous patch branch, and we want to set the\n                 // LTS tag for all packages part of the last major. It would not be possible to set the\n                 // NPM dist tag for new packages part of the released major, nor would it be acceptable\n                 // to skip the LTS tag for packages which are no longer part of the new major.\n+                yield this.checkoutUpstreamBranch(previousPatch.branchName);\n                 yield invokeYarnInstallCommand(this.projectDir);\n-                yield invokeSetNpmDistCommand(ltsTagForPatch, previousPatchVersion);\n+                yield invokeSetNpmDistCommand(ltsTagForPatch, previousPatch.version);\n             }\n             yield this.cherryPickChangelogIntoNextBranch(newVersion, branchName);\n         });"
        },
        {
            "sha": "0db17c0bbaa0ca4bde7f93529311591d5c1bb773",
            "filename": "dev-infra/release/publish/actions/cut-stable.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/5947239f89fa26a4494eec408dbec4e233aaadc5/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-stable.ts",
            "raw_url": "https://github.com/angular/angular/raw/5947239f89fa26a4494eec408dbec4e233aaadc5/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-stable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-stable.ts?ref=5947239f89fa26a4494eec408dbec4e233aaadc5",
            "patch": "@@ -39,17 +39,18 @@ export class CutStableAction extends ReleaseAction {\n     // If a new major version is published and becomes the \"latest\" release-train, we need\n     // to set the LTS npm dist tag for the previous latest release-train (the current patch).\n     if (isNewMajor) {\n-      const previousPatchVersion = this.active.latest.version;\n-      const ltsTagForPatch = getLtsNpmDistTagOfMajor(previousPatchVersion.major);\n+      const previousPatch = this.active.latest;\n+      const ltsTagForPatch = getLtsNpmDistTagOfMajor(previousPatch.version.major);\n \n       // Instead of directly setting the NPM dist tags, we invoke the ng-dev command for\n       // setting the NPM dist tag to the specified version. We do this because release NPM\n       // packages could be different in the previous patch branch, and we want to set the\n       // LTS tag for all packages part of the last major. It would not be possible to set the\n       // NPM dist tag for new packages part of the released major, nor would it be acceptable\n       // to skip the LTS tag for packages which are no longer part of the new major.\n+      await this.checkoutUpstreamBranch(previousPatch.branchName);\n       await invokeYarnInstallCommand(this.projectDir);\n-      await invokeSetNpmDistCommand(ltsTagForPatch, previousPatchVersion);\n+      await invokeSetNpmDistCommand(ltsTagForPatch, previousPatch.version);\n     }\n \n     await this.cherryPickChangelogIntoNextBranch(newVersion, branchName);"
        },
        {
            "sha": "8a740b7316c3a358d32e28258916c5a130631220",
            "filename": "dev-infra/release/publish/test/cut-stable.spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/5947239f89fa26a4494eec408dbec4e233aaadc5/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcut-stable.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5947239f89fa26a4494eec408dbec4e233aaadc5/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcut-stable.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcut-stable.spec.ts?ref=5947239f89fa26a4494eec408dbec4e233aaadc5",
            "patch": "@@ -70,6 +70,13 @@ describe('cut stable action', () => {\n       latest: new ReleaseTrain('10.0.x', parse('10.0.3')),\n     });\n \n+    // Ensure that the NPM dist tag is set only for packages that were available in the previous\n+    // major version. A spy has already been installed on the function.\n+    (externalCommands.invokeSetNpmDistCommand as jasmine.Spy).and.callFake(() => {\n+      expect(action.gitClient.head.ref?.name).toBe('10.0.x');\n+      return Promise.resolve();\n+    });\n+\n     await expectStagingAndPublishWithCherryPick(action, '11.0.x', '11.0.0', 'latest');\n     expect(externalCommands.invokeSetNpmDistCommand).toHaveBeenCalledTimes(1);\n     expect(externalCommands.invokeSetNpmDistCommand)"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 15,
        "deletions": 6
    }
}