{
    "author": "danieltre23",
    "message": "test(compiler-cli): add tests for `NullishCoalescingNotNullableCheck` (#43232)\n\nAdd tests to make sure the nullish coalescing check is generating the\ncorrect diagnostics.\n\nRefs #42966\n\nPR Close #43232",
    "sha": "95cfd0b0e1022c9222646c9989d091f8645b2355",
    "files": [
        {
            "sha": "30f1f8f4789ad9bee69e3f5b06dfb3186ee7b827",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/nullish_coalescing_not_nullable/BUILD.bazel",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/95cfd0b0e1022c9222646c9989d091f8645b2355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/95cfd0b0e1022c9222646c9989d091f8645b2355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2FBUILD.bazel?ref=95cfd0b0e1022c9222646c9989d091f8645b2355",
            "patch": "@@ -0,0 +1,26 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = [\"spec.ts\"],\n+    deps = [\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/checks/nullish_coalescing_not_nullable\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/testing\",\n+        \"@npm//typescript\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n+    deps = [\n+        \":test_lib\",\n+    ],\n+)"
        },
        {
            "sha": "3bed38765adaf666446540b01106e2389c95f103",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/checks/nullish_coalescing_not_nullable/spec.ts",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/95cfd0b0e1022c9222646c9989d091f8645b2355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fspec.ts",
            "raw_url": "https://github.com/angular/angular/raw/95cfd0b0e1022c9222646c9989d091f8645b2355/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fspec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Fchecks%2Fnullish_coalescing_not_nullable%2Fspec.ts?ref=95cfd0b0e1022c9222646c9989d091f8645b2355",
            "patch": "@@ -0,0 +1,75 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+import {ErrorCode, ngErrorCode} from '../../../../../diagnostics';\n+import {absoluteFrom, getSourceFileOrError} from '../../../../../file_system';\n+import {runInEachFileSystem} from '../../../../../file_system/testing';\n+import {getSourceCodeForDiagnostic} from '../../../../../testing';\n+import {getClass, setup} from '../../../../testing';\n+import {NullishCoalescingNotNullableCheck} from '../../../checks/nullish_coalescing_not_nullable';\n+import {ExtendedTemplateCheckerImpl} from '../../../src/extended_template_checker';\n+\n+runInEachFileSystem(() => {\n+  describe('NullishCoalescingNotNullableCheck', () => {\n+    it('should produce nullish coalescing warning', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([{\n+        fileName,\n+        templates: {\n+          'TestCmp': `{{ var1 ?? 'foo' }}`,\n+        },\n+        source: 'export class TestCmp { var1: string = \"text\"; }'\n+      }]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new NullishCoalescingNotNullableCheck()]);\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].category).toBe(ts.DiagnosticCategory.Warning);\n+      expect(diags[0].code).toBe(ngErrorCode(ErrorCode.NULLISH_COALESCING_NOT_NULLABLE));\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe(`var1 ?? 'foo'`);\n+    });\n+\n+    it('should not produce nullish coalescing warning for a nullable type', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([{\n+        fileName,\n+        templates: {\n+          'TestCmp': `{{ var1 ?? 'foo' }}`,\n+        },\n+        source: 'export class TestCmp { var1: string | null = \"text\"; }'\n+      }]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new NullishCoalescingNotNullableCheck()]);\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+      expect(diags.length).toBe(0);\n+    });\n+\n+    it('should not produce nullish coalescing warning for a type that includes undefined', () => {\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker} = setup([{\n+        fileName,\n+        templates: {\n+          'TestCmp': `{{ var1 ?? 'foo' }}`,\n+        },\n+        source: 'export class TestCmp { var1: string | undefined = \"text\"; }'\n+      }]);\n+      const sf = getSourceFileOrError(program, fileName);\n+      const component = getClass(sf, 'TestCmp');\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new NullishCoalescingNotNullableCheck()]);\n+      const diags = extendedTemplateChecker.getDiagnosticsForComponent(component);\n+      expect(diags.length).toBe(0);\n+    });\n+  });\n+});"
        },
        {
            "sha": "e00e6fb33714e7feaf8a41fbc0d8f4a420727bac",
            "filename": "packages/compiler-cli/test/ngtsc/extended_template_diagnostics_spec.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/95cfd0b0e1022c9222646c9989d091f8645b2355/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/95cfd0b0e1022c9222646c9989d091f8645b2355/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fextended_template_diagnostics_spec.ts?ref=95cfd0b0e1022c9222646c9989d091f8645b2355",
            "patch": "@@ -103,5 +103,43 @@ runInEachFileSystem(() => {\n              .toMatch(\n                  /Error: The '_extendedTemplateDiagnostics' option requires 'strictTemplates' to also be enabled./);\n        });\n+\n+    it(`should produce nullish coalescing not nullable warning`, () => {\n+      env.write('test.ts', `\n+              import {Component} from '@angular/core';\n+              @Component({\n+                selector: 'test',\n+                template: '{{ bar ?? \"foo\" }}',\n+              })\n+              export class TestCmp { \n+                bar: string = \"text\"; \n+              }\n+            `);\n+\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].category).toBe(ts.DiagnosticCategory.Warning);\n+      expect(diags[0].code).toBe(ngErrorCode(ErrorCode.NULLISH_COALESCING_NOT_NULLABLE));\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('bar ?? \"foo\"');\n+    });\n+\n+    it(`should not produce nullish coalescing not nullable warning with strictNullChecks disabled`,\n+       () => {\n+         env.tsconfig(\n+             {_extendedTemplateDiagnostics: true, strictTemplates: true, strictNullChecks: false});\n+         env.write('test.ts', `\n+              import {Component} from '@angular/core';\n+              @Component({\n+                selector: 'test',\n+                template: '{{ bar ?? \"foo\" }}',\n+              })\n+              export class TestCmp { \n+                bar: string = undefined; \n+              }\n+            `);\n+\n+         const diags = env.driveDiagnostics();\n+         expect(diags.length).toBe(0);\n+       });\n   });\n });"
        }
    ],
    "stats": {
        "total": 139,
        "additions": 139,
        "deletions": 0
    }
}