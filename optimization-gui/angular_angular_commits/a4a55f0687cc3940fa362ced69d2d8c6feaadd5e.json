{
    "author": "josephperrott",
    "message": "fix(dev-infra): verify python3 is available before release (#41753)\n\nVerify that the /usr/bin/python points to the python3 interpreter binary.\n\nPR Close #41753",
    "sha": "a4a55f0687cc3940fa362ced69d2d8c6feaadd5e",
    "files": [
        {
            "sha": "931f4b596207c28b7d8929e707a8802452ad86ff",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 39,
            "deletions": 3,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/a4a55f0687cc3940fa362ced69d2d8c6feaadd5e/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/a4a55f0687cc3940fa362ced69d2d8c6feaadd5e/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=a4a55f0687cc3940fa362ced69d2d8c6feaadd5e",
            "patch": "@@ -5179,7 +5179,7 @@ const ReleaseBuildCommandModule = {\n  * output is captured and returned as resolution on completion. Depending on the chosen\n  * output mode, stdout/stderr output is also printed to the console, or only on error.\n  *\n- * @returns a Promise resolving with captured stdout on success. The promise\n+ * @returns a Promise resolving with captured stdout and stderr on success. The promise\n  *   rejects on command failure.\n  */\n function spawnWithDebugOutput(command, args, options) {\n@@ -5191,9 +5191,11 @@ function spawnWithDebugOutput(command, args, options) {\n         var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: ['inherit', 'pipe', 'pipe'] }));\n         var logOutput = '';\n         var stdout = '';\n+        var stderr = '';\n         // Capture the stdout separately so that it can be passed as resolve value.\n         // This is useful if commands return parsable stdout.\n         childProcess.stderr.on('data', function (message) {\n+            stderr += message;\n             logOutput += message;\n             // If console output is enabled, print the message directly to the stderr. Note that\n             // we intentionally print all output to stderr as stdout should not be polluted.\n@@ -5218,7 +5220,7 @@ function spawnWithDebugOutput(command, args, options) {\n             // On success, resolve the promise. Otherwise reject with the captured stderr\n             // and stdout log output if the output mode was set to `silent`.\n             if (status === 0) {\n-                resolve({ stdout: stdout });\n+                resolve({ stdout: stdout, stderr: stderr });\n             }\n             else {\n                 reject(outputMode === 'silent' ? logOutput : undefined);\n@@ -6636,7 +6638,8 @@ class ReleaseTool {\n             log(yellow('  Angular Dev-Infra release staging script'));\n             log(yellow('--------------------------------------------'));\n             log();\n-            if (!(yield this._verifyNoUncommittedChanges()) || !(yield this._verifyRunningFromNextBranch())) {\n+            if (!(yield this._verifyEnvironmentHasPython3Symlink()) ||\n+                !(yield this._verifyNoUncommittedChanges()) || !(yield this._verifyRunningFromNextBranch())) {\n                 return CompletionState.FATAL_ERROR;\n             }\n             if (!(yield this._verifyNpmLoginState())) {\n@@ -6712,6 +6715,39 @@ class ReleaseTool {\n             return true;\n         });\n     }\n+    /**\n+     * Verifies the current environment contains /usr/bin/python which points to the Python3\n+     * interpreter.  python is required by our tooling in bazel as it contains scripts setting\n+     * `#! /usr/bin/env python`.\n+     *\n+     * @returns a boolean indicating success or failure.\n+     */\n+    _verifyEnvironmentHasPython3Symlink() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            try {\n+                const pyVersion = yield spawnWithDebugOutput('/usr/bin/python', ['--version'], { mode: 'silent' });\n+                const version = pyVersion.stdout.trim() || pyVersion.stderr.trim();\n+                if (version.startsWith('Python 3.')) {\n+                    debug(`Local python version: ${version}`);\n+                    return true;\n+                }\n+                error(red(`  ✘   \\`/usr/bin/python\\` is currently symlinked to \"${version}\", please update`));\n+                error(red('      the symlink to link instead to Python3'));\n+                error();\n+                error(red('      Googlers: please run the following command to symlink python to python3:'));\n+                error(red('        sudo ln -s /usr/bin/python3 /usr/bin/python'));\n+                return false;\n+            }\n+            catch (_a) {\n+                error(red('  ✘   `/usr/bin/python` does not exist, please ensure `/usr/bin/python` is'));\n+                error(red('      symlinked to Python3.'));\n+                error();\n+                error(red('      Googlers: please run the following command to symlink python to python3:'));\n+                error(red('        sudo ln -s /usr/bin/python3 /usr/bin/python'));\n+            }\n+            return false;\n+        });\n+    }\n     /**\n      * Verifies that the next branch from the configured repository is checked out.\n      * @returns a boolean indicating success or failure."
        },
        {
            "sha": "03b9e360ef92e042a6137e71fac80ecc4c149b0a",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 1,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/a4a55f0687cc3940fa362ced69d2d8c6feaadd5e/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4a55f0687cc3940fa362ced69d2d8c6feaadd5e/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=a4a55f0687cc3940fa362ced69d2d8c6feaadd5e",
            "patch": "@@ -7,10 +7,12 @@\n  */\n \n import {ListChoiceOptions, prompt} from 'inquirer';\n+import {spawnWithDebugOutput} from '../../utils/child-process';\n \n import {GithubConfig} from '../../utils/config';\n import {debug, error, info, log, promptConfirm, red, yellow} from '../../utils/console';\n import {GitClient} from '../../utils/git/index';\n+import {exec} from '../../utils/shelljs';\n import {ReleaseConfig} from '../config/index';\n import {ActiveReleaseTrains, fetchActiveReleaseTrains, nextBranchName} from '../versioning/active-release-trains';\n import {npmIsLoggedIn, npmLogin, npmLogout} from '../versioning/npm-publish';\n@@ -45,7 +47,8 @@ export class ReleaseTool {\n     log(yellow('--------------------------------------------'));\n     log();\n \n-    if (!await this._verifyNoUncommittedChanges() || !await this._verifyRunningFromNextBranch()) {\n+    if (!await this._verifyEnvironmentHasPython3Symlink() ||\n+        !await this._verifyNoUncommittedChanges() || !await this._verifyRunningFromNextBranch()) {\n       return CompletionState.FATAL_ERROR;\n     }\n \n@@ -127,6 +130,38 @@ export class ReleaseTool {\n     return true;\n   }\n \n+  /**\n+   * Verifies the current environment contains /usr/bin/python which points to the Python3\n+   * interpreter.  python is required by our tooling in bazel as it contains scripts setting\n+   * `#! /usr/bin/env python`.\n+   *\n+   * @returns a boolean indicating success or failure.\n+   */\n+  private async _verifyEnvironmentHasPython3Symlink(): Promise<boolean> {\n+    try {\n+      const pyVersion =\n+          await spawnWithDebugOutput('/usr/bin/python', ['--version'], {mode: 'silent'});\n+      const version = pyVersion.stdout.trim() || pyVersion.stderr.trim();\n+      if (version.startsWith('Python 3.')) {\n+        debug(`Local python version: ${version}`);\n+        return true;\n+      }\n+      error(red(`  ✘   \\`/usr/bin/python\\` is currently symlinked to \"${version}\", please update`));\n+      error(red('      the symlink to link instead to Python3'));\n+      error();\n+      error(red('      Googlers: please run the following command to symlink python to python3:'));\n+      error(red('        sudo ln -s /usr/bin/python3 /usr/bin/python'));\n+      return false;\n+    } catch {\n+      error(red('  ✘   `/usr/bin/python` does not exist, please ensure `/usr/bin/python` is'));\n+      error(red('      symlinked to Python3.'));\n+      error();\n+      error(red('      Googlers: please run the following command to symlink python to python3:'));\n+      error(red('        sudo ln -s /usr/bin/python3 /usr/bin/python'));\n+    }\n+    return false;\n+  }\n+\n   /**\n    * Verifies that the next branch from the configured repository is checked out.\n    * @returns a boolean indicating success or failure."
        },
        {
            "sha": "07bddf9da5027635c9c3cfc805b5ae117e0ee593",
            "filename": "dev-infra/utils/child-process.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/a4a55f0687cc3940fa362ced69d2d8c6feaadd5e/dev-infra%2Futils%2Fchild-process.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4a55f0687cc3940fa362ced69d2d8c6feaadd5e/dev-infra%2Futils%2Fchild-process.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fchild-process.ts?ref=a4a55f0687cc3940fa362ced69d2d8c6feaadd5e",
            "patch": "@@ -19,14 +19,16 @@ export interface SpawnedProcessOptions extends Omit<SpawnOptions, 'stdio'> {\n export interface SpawnedProcessResult {\n   /** Captured stdout in string format. */\n   stdout: string;\n+  /** Captured stderr in string format. */\n+  stderr: string;\n }\n \n /**\n  * Spawns a given command with the specified arguments inside a shell. All process stdout\n  * output is captured and returned as resolution on completion. Depending on the chosen\n  * output mode, stdout/stderr output is also printed to the console, or only on error.\n  *\n- * @returns a Promise resolving with captured stdout on success. The promise\n+ * @returns a Promise resolving with captured stdout and stderr on success. The promise\n  *   rejects on command failure.\n  */\n export function spawnWithDebugOutput(\n@@ -42,10 +44,12 @@ export function spawnWithDebugOutput(\n         spawn(command, args, {...options, shell: true, stdio: ['inherit', 'pipe', 'pipe']});\n     let logOutput = '';\n     let stdout = '';\n+    let stderr = '';\n \n     // Capture the stdout separately so that it can be passed as resolve value.\n     // This is useful if commands return parsable stdout.\n     childProcess.stderr.on('data', message => {\n+      stderr += message;\n       logOutput += message;\n       // If console output is enabled, print the message directly to the stderr. Note that\n       // we intentionally print all output to stderr as stdout should not be polluted.\n@@ -73,7 +77,7 @@ export function spawnWithDebugOutput(\n       // On success, resolve the promise. Otherwise reject with the captured stderr\n       // and stdout log output if the output mode was set to `silent`.\n       if (status === 0) {\n-        resolve({stdout});\n+        resolve({stdout, stderr});\n       } else {\n         reject(outputMode === 'silent' ? logOutput : undefined);\n       }"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 81,
        "deletions": 6
    }
}