{
    "author": "JoostK",
    "message": "fix(compiler): include used components during JIT compilation of partial component declaration (#41353)\n\nIn #41104 the list of used directives was split into two arrays of used\ndirectives and components, but the JIT side was not updated. This commit\nfixes the JIT integration by including the list of used components.\n\nFixes #41318\n\nPR Close #41353",
    "sha": "ff9470b0a0196a3638f19028bba15e002cb0ff27",
    "files": [
        {
            "sha": "5343e4583c1d466c84d16d30c06846a86cafedac",
            "filename": "packages/compiler/src/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts?ref=ff9470b0a0196a3638f19028bba15e002cb0ff27",
            "patch": "@@ -200,12 +200,8 @@ export interface R3DeclareComponentFacade extends R3DeclareDirectiveFacade {\n   template: string;\n   isInline?: boolean;\n   styles?: string[];\n-  directives?: {\n-    selector: string; type: OpaqueValue | (() => OpaqueValue);\n-    inputs?: string[];\n-    outputs?: string[];\n-    exportAs?: string[];\n-  }[];\n+  components?: R3DeclareUsedDirectiveFacade[];\n+  directives?: R3DeclareUsedDirectiveFacade[];\n   pipes?: {[pipeName: string]: OpaqueValue|(() => OpaqueValue)};\n   viewProviders?: OpaqueValue;\n   animations?: OpaqueValue;\n@@ -215,6 +211,14 @@ export interface R3DeclareComponentFacade extends R3DeclareDirectiveFacade {\n   preserveWhitespaces?: boolean;\n }\n \n+export interface R3DeclareUsedDirectiveFacade {\n+  selector: string;\n+  type: OpaqueValue|(() => OpaqueValue);\n+  inputs?: string[];\n+  outputs?: string[];\n+  exportAs?: string[];\n+}\n+\n export interface R3UsedDirectiveMetadata {\n   selector: string;\n   inputs: string[];"
        },
        {
            "sha": "32496f8789753fcd4809da53876914112c0fd28b",
            "filename": "packages/compiler/src/jit_compiler_facade.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts?ref=ff9470b0a0196a3638f19028bba15e002cb0ff27",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n \n-import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareComponentFacade, R3DeclareDependencyMetadataFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade, R3DeclareQueryMetadataFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n+import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareComponentFacade, R3DeclareDependencyMetadataFacade, R3DeclareDirectiveFacade, R3DeclareFactoryFacade, R3DeclareInjectorFacade, R3DeclareNgModuleFacade, R3DeclarePipeFacade, R3DeclareQueryMetadataFacade, R3DeclareUsedDirectiveFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n import {ConstantPool} from './constant_pool';\n import {ChangeDetectionStrategy, HostBinding, HostListener, Input, Output, Type, ViewEncapsulation} from './core';\n import {compileInjectable} from './injectable_compiler_2';\n@@ -384,7 +384,9 @@ function convertDeclareComponentFacadeToMetadata(\n     ...convertDeclareDirectiveFacadeToMetadata(declaration, typeSourceSpan),\n     template,\n     styles: declaration.styles ?? [],\n-    directives: (declaration.directives ?? []).map(convertUsedDirectiveDeclarationToMetadata),\n+    directives: (declaration.components ?? [])\n+                    .concat(declaration.directives ?? [])\n+                    .map(convertUsedDirectiveDeclarationToMetadata),\n     pipes: convertUsedPipesToMetadata(declaration.pipes),\n     viewProviders: declaration.viewProviders !== undefined ?\n         new WrappedNodeExpr(declaration.viewProviders) :\n@@ -400,8 +402,7 @@ function convertDeclareComponentFacadeToMetadata(\n   };\n }\n \n-function convertUsedDirectiveDeclarationToMetadata(\n-    declaration: NonNullable<R3DeclareComponentFacade['directives']>[number]):\n+function convertUsedDirectiveDeclarationToMetadata(declaration: R3DeclareUsedDirectiveFacade):\n     R3UsedDirectiveMetadata {\n   return {\n     selector: declaration.selector,"
        },
        {
            "sha": "e0481e504ae3ee76c2e1667611764dad489e7255",
            "filename": "packages/compiler/test/compiler_facade_interface_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts?ref=ff9470b0a0196a3638f19028bba15e002cb0ff27",
            "patch": "@@ -116,6 +116,11 @@ const coreR3DeclareComponentFacade: core.R3DeclareComponentFacade =\n const compilerR3DeclareComponentFacade: compiler.R3DeclareComponentFacade =\n     null! as core.R3DeclareComponentFacade;\n \n+const coreR3DeclareUsedDirectiveFacade: core.R3DeclareUsedDirectiveFacade =\n+    null! as compiler.R3DeclareUsedDirectiveFacade;\n+const compilerR3DeclareUsedDirectiveFacade: compiler.R3DeclareUsedDirectiveFacade =\n+    null! as core.R3DeclareUsedDirectiveFacade;\n+\n const coreR3UsedDirectiveMetadata: core.R3UsedDirectiveMetadata =\n     null! as compiler.R3UsedDirectiveMetadata;\n const compilerR3UsedDirectiveMetadata: compiler.R3UsedDirectiveMetadata ="
        },
        {
            "sha": "5343e4583c1d466c84d16d30c06846a86cafedac",
            "filename": "packages/core/src/compiler/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts?ref=ff9470b0a0196a3638f19028bba15e002cb0ff27",
            "patch": "@@ -200,12 +200,8 @@ export interface R3DeclareComponentFacade extends R3DeclareDirectiveFacade {\n   template: string;\n   isInline?: boolean;\n   styles?: string[];\n-  directives?: {\n-    selector: string; type: OpaqueValue | (() => OpaqueValue);\n-    inputs?: string[];\n-    outputs?: string[];\n-    exportAs?: string[];\n-  }[];\n+  components?: R3DeclareUsedDirectiveFacade[];\n+  directives?: R3DeclareUsedDirectiveFacade[];\n   pipes?: {[pipeName: string]: OpaqueValue|(() => OpaqueValue)};\n   viewProviders?: OpaqueValue;\n   animations?: OpaqueValue;\n@@ -215,6 +211,14 @@ export interface R3DeclareComponentFacade extends R3DeclareDirectiveFacade {\n   preserveWhitespaces?: boolean;\n }\n \n+export interface R3DeclareUsedDirectiveFacade {\n+  selector: string;\n+  type: OpaqueValue|(() => OpaqueValue);\n+  inputs?: string[];\n+  outputs?: string[];\n+  exportAs?: string[];\n+}\n+\n export interface R3UsedDirectiveMetadata {\n   selector: string;\n   inputs: string[];"
        },
        {
            "sha": "28dd53ef4431589203ee63d9fce46c38c51f1089",
            "filename": "packages/core/test/render3/jit/declare_component_spec.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_component_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ff9470b0a0196a3638f19028bba15e002cb0ff27/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_component_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_component_spec.ts?ref=ff9470b0a0196a3638f19028bba15e002cb0ff27",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ChangeDetectionStrategy, Directive, ElementRef, forwardRef, Pipe, Type, ViewEncapsulation, ɵɵngDeclareComponent} from '@angular/core';\n+import {ChangeDetectionStrategy, Component, Directive, ElementRef, forwardRef, Pipe, Type, ViewEncapsulation, ɵɵngDeclareComponent} from '@angular/core';\n import {AttributeMarker, ComponentDef} from '../../../src/render3';\n import {functionContaining} from './matcher';\n \n@@ -338,6 +338,21 @@ describe('component declaration jit compilation', () => {\n     });\n   });\n \n+  it('should compile used components', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: '<cmp></cmp>',\n+                  components: [{\n+                    type: TestCmp,\n+                    selector: 'cmp',\n+                  }],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      directives: [TestCmp],\n+    });\n+  });\n+\n   it('should compile used directives', () => {\n     const def = ɵɵngDeclareComponent({\n                   type: TestClass,\n@@ -353,6 +368,25 @@ describe('component declaration jit compilation', () => {\n     });\n   });\n \n+  it('should compile used directives together with used components', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: '<cmp dir></cmp>',\n+                  components: [{\n+                    type: TestCmp,\n+                    selector: 'cmp',\n+                  }],\n+                  directives: [{\n+                    type: TestDir,\n+                    selector: '[dir]',\n+                  }],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      directives: [TestCmp, TestDir],\n+    });\n+  });\n+\n   it('should compile forward declared directives', () => {\n     const def = ɵɵngDeclareComponent({\n                   type: TestClass,\n@@ -534,6 +568,10 @@ class TestClass {}\n class TestDir {\n }\n \n+@Component({selector: 'cmp', template: ''})\n+class TestCmp {\n+}\n+\n @Pipe({name: 'test'})\n class TestPipe {\n }"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 69,
        "deletions": 17
    }
}