{
    "author": "AleksanderBodurri",
    "message": "refactor(devtools): refactor tree-map visualizer to use ResizeObserver instead of window resize listener",
    "sha": "794d06ab1b963e06c11d6670cddda0b872c47f9a",
    "files": [
        {
            "sha": "a7252f4cd39d9fa2f4ab14e2019cf9be67c41a1e",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/794d06ab1b963e06c11d6670cddda0b872c47f9a/package.json",
            "raw_url": "https://github.com/angular/angular/raw/794d06ab1b963e06c11d6670cddda0b872c47f9a/package.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/package.json?ref=794d06ab1b963e06c11d6670cddda0b872c47f9a",
            "patch": "@@ -66,6 +66,7 @@\n     \"@types/clone-deep\": \"^4.0.1\",\n     \"@types/jasmine\": \"~3.6.0\",\n     \"@types/jasminewd2\": \"~2.0.3\",\n+    \"@types/resize-observer-browser\": \"^0.1.5\",\n     \"@types/semver\": \"^7.1.0\",\n     \"codelyzer\": \"^6.0.0\",\n     \"cross-env\": \"^7.0.2\","
        },
        {
            "sha": "2490e9d6dc0dcba3f9d8744e90515c47e71c2dc3",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/recording-visualizer/tree-map-visualizer/tree-map-visualizer.component.scss",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/794d06ab1b963e06c11d6670cddda0b872c47f9a/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecording-visualizer%2Ftree-map-visualizer%2Ftree-map-visualizer.component.scss",
            "raw_url": "https://github.com/angular/angular/raw/794d06ab1b963e06c11d6670cddda0b872c47f9a/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecording-visualizer%2Ftree-map-visualizer%2Ftree-map-visualizer.component.scss",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecording-visualizer%2Ftree-map-visualizer%2Ftree-map-visualizer.component.scss?ref=794d06ab1b963e06c11d6670cddda0b872c47f9a",
            "patch": "@@ -1,12 +1,14 @@\n .web-tree {\n-  height: 70%;\n-  width: 85%;\n-  margin: 20px auto;\n+  height: calc(100% - 25px);\n+  width: calc(100% - 25px);\n+  margin: auto;\n }\n \n-::ng-deep {\n-  .webtreemap-caption {\n-    font-size: 0.9em !important;\n+:host {\n+  ::ng-deep {\n+    .webtreemap-caption {\n+      font-size: 0.9em;\n+    }\n   }\n }\n "
        },
        {
            "sha": "7e43a83599a6d1fc95f9417b9d6e7125113fe9bc",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/profiler/recording/timeline/recording-visualizer/tree-map-visualizer/tree-map-visualizer.component.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 27,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/794d06ab1b963e06c11d6670cddda0b872c47f9a/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecording-visualizer%2Ftree-map-visualizer%2Ftree-map-visualizer.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/794d06ab1b963e06c11d6670cddda0b872c47f9a/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecording-visualizer%2Ftree-map-visualizer%2Ftree-map-visualizer.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fprofiler%2Frecording%2Ftimeline%2Frecording-visualizer%2Ftree-map-visualizer%2Ftree-map-visualizer.component.ts?ref=794d06ab1b963e06c11d6670cddda0b872c47f9a",
            "patch": "@@ -1,62 +1,61 @@\n-import { AfterViewInit, Component, ElementRef, HostListener, Input, OnInit, ViewChild } from '@angular/core';\n+/// <reference types=\"resize-observer-browser\" />\n+import { Component, ElementRef, Input, NgZone, OnDestroy, OnInit, ViewChild } from '@angular/core';\n import * as treemap from 'webtreemap/build/webtreemap';\n import { TreeMapNode, TreeMapFormatter } from '../../record-formatter/tree-map-formatter';\n-import { Subject } from 'rxjs';\n-import { throttleTime } from 'rxjs/operators';\n import { ProfilerFrame } from 'protocol';\n+import { Subject, Subscription } from 'rxjs';\n+import { debounceTime } from 'rxjs/operators';\n \n @Component({\n   selector: 'ng-tree-map-visualizer',\n   templateUrl: './tree-map-visualizer.component.html',\n   styleUrls: ['./tree-map-visualizer.component.scss'],\n })\n-export class TreeMapVisualizerComponent implements AfterViewInit, OnInit {\n+export class TreeMapVisualizerComponent implements OnInit, OnDestroy {\n   private _formatter = new TreeMapFormatter();\n \n   @Input() set frame(frame: ProfilerFrame) {\n     // first element in data is the Application node\n     this.treeMapRecords = this._formatter.formatFrame(frame);\n     if (this.tree) {\n-      this.updateTree();\n+      this._renderTree();\n     }\n   }\n \n+  constructor(private _ngZone: NgZone) {}\n+\n   private resize$ = new Subject<void>();\n+  private _throttledResizeSubscription: Subscription;\n \n+  private _resizeObserver: ResizeObserver = new ResizeObserver(() => this._ngZone.run(() => this.resize$.next()));\n   treeMapRecords: TreeMapNode;\n \n-  @ViewChild('webTree') tree: ElementRef;\n-\n-  ngAfterViewInit(): void {\n-    this.updateTree();\n-  }\n+  @ViewChild('webTree', { static: true }) tree: ElementRef;\n \n   ngOnInit(): void {\n-    this.resize$\n-      .asObservable()\n-      .pipe(throttleTime(100))\n-      .subscribe((_) => this.updateTree());\n+    this._throttledResizeSubscription = this.resize$.pipe(debounceTime(100)).subscribe(() => this._renderTree());\n+    this._resizeObserver.observe(this.tree.nativeElement);\n   }\n \n-  updateTree(): void {\n-    this.removeTree();\n-    this.createTree();\n+  ngOnDestroy(): void {\n+    this._throttledResizeSubscription.unsubscribe();\n+    this._resizeObserver.unobserve(this.tree.nativeElement);\n   }\n \n-  createTree(): void {\n-    treemap.render(this.tree.nativeElement, this.treeMapRecords as any, {\n-      padding: [20, 5, 5, 5],\n-      caption: (node) => `${node.id}: ${node.size.toFixed(3)} ms`,\n-      showNode: () => true,\n-    });\n+  private _renderTree(): void {\n+    this._removeTree();\n+    this._createTree();\n   }\n \n-  removeTree(): void {\n+  private _removeTree(): void {\n     Array.from(this.tree.nativeElement.children).forEach((child: HTMLElement) => child.remove());\n   }\n \n-  @HostListener('window:resize', ['$event'])\n-  onResize(): void {\n-    this.resize$.next();\n+  private _createTree(): void {\n+    treemap.render(this.tree.nativeElement, this.treeMapRecords, {\n+      padding: [20, 5, 5, 5],\n+      caption: (node) => `${node.id}: ${node.size.toFixed(3)} ms`,\n+      showNode: () => true,\n+    });\n   }\n }"
        },
        {
            "sha": "2c286cde61b74f281f5b234117b91506d472ec8e",
            "filename": "yarn.lock",
            "status": "modified",
            "additions": 16,
            "deletions": 22,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/794d06ab1b963e06c11d6670cddda0b872c47f9a/yarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/794d06ab1b963e06c11d6670cddda0b872c47f9a/yarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/yarn.lock?ref=794d06ab1b963e06c11d6670cddda0b872c47f9a",
            "patch": "@@ -172,8 +172,7 @@\n     rxjs \"6.6.6\"\n \n \"@angular/animations@github:angular/animations-builds#7dccd1151d9d255cc3492c4c5775285ab638198c\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid \"7dccd1151d9d255cc3492c4c5775285ab638198c\"\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/animations-builds/tar.gz/7dccd1151d9d255cc3492c4c5775285ab638198c\"\n   dependencies:\n     tslib \"^2.0.0\"\n@@ -215,15 +214,13 @@\n     uuid \"8.3.2\"\n \n \"@angular/common@github:angular/common-builds#0c9d26f2399dad7e354ff1622d2e825622b26191\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid \"0c9d26f2399dad7e354ff1622d2e825622b26191\"\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/common-builds/tar.gz/0c9d26f2399dad7e354ff1622d2e825622b26191\"\n   dependencies:\n     tslib \"^2.0.0\"\n \n \"@angular/compiler-cli@github:angular/compiler-cli-builds#5e58e9ea0185e73a98c84b857d0fe0238d19d1e3\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid \"5e58e9ea0185e73a98c84b857d0fe0238d19d1e3\"\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/compiler-cli-builds/tar.gz/5e58e9ea0185e73a98c84b857d0fe0238d19d1e3\"\n   dependencies:\n     \"@babel/core\" \"^7.8.6\"\n@@ -248,8 +245,7 @@\n   integrity sha512-ctjwuntPfZZT2mNj2NDIVu51t9cvbhl/16epc5xEwyzyDt76pX9UgwvY+MbXrf/C/FWwdtmNtfP698BKI+9leQ==\n \n \"@angular/compiler@github:angular/compiler-builds#5198e1183ed772ee3367d5a0d48e6fa9af965de0\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid \"5198e1183ed772ee3367d5a0d48e6fa9af965de0\"\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/compiler-builds/tar.gz/5198e1183ed772ee3367d5a0d48e6fa9af965de0\"\n   dependencies:\n     tslib \"^2.0.0\"\n@@ -260,29 +256,25 @@\n   integrity sha512-6Pxgsrf0qF9iFFqmIcWmjJGkkCaCm6V5QNnxMy2KloO3SDq6QuMVRbN9RtC8Urmo25LP+eZ6ZgYqFYpdD8Hd9w==\n \n \"@angular/core@github:angular/core-builds#5fd9dad3c93f7f7dc40beaca3234f2f1a51a67bc\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid \"5fd9dad3c93f7f7dc40beaca3234f2f1a51a67bc\"\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/core-builds/tar.gz/5fd9dad3c93f7f7dc40beaca3234f2f1a51a67bc\"\n   dependencies:\n     tslib \"^2.0.0\"\n \n \"@angular/elements@github:angular/elements-builds#c993cdc325ee60ad7b8db5637d9af390e8de98bd\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid c993cdc325ee60ad7b8db5637d9af390e8de98bd\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/elements-builds/tar.gz/c993cdc325ee60ad7b8db5637d9af390e8de98bd\"\n   dependencies:\n     tslib \"^2.0.0\"\n \n \"@angular/forms@github:angular/forms-builds#7a81e88ba8e84e2e8a78ab963d582ef8864fc0dc\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid \"7a81e88ba8e84e2e8a78ab963d582ef8864fc0dc\"\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/forms-builds/tar.gz/7a81e88ba8e84e2e8a78ab963d582ef8864fc0dc\"\n   dependencies:\n     tslib \"^2.0.0\"\n \n \"@angular/language-service@github:angular/language-service-builds#f27e78da4ff805f080947ab430e2242d8f58a881\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid f27e78da4ff805f080947ab430e2242d8f58a881\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/language-service-builds/tar.gz/f27e78da4ff805f080947ab430e2242d8f58a881\"\n \n \"@angular/material@~11.2.0\":\n@@ -293,22 +285,19 @@\n     tslib \"^2.0.0\"\n \n \"@angular/platform-browser-dynamic@github:angular/platform-browser-dynamic-builds#ed6ff1fee00c8e8007feee83ad66b2de2f703900\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid ed6ff1fee00c8e8007feee83ad66b2de2f703900\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/platform-browser-dynamic-builds/tar.gz/ed6ff1fee00c8e8007feee83ad66b2de2f703900\"\n   dependencies:\n     tslib \"^2.0.0\"\n \n \"@angular/platform-browser@github:angular/platform-browser-builds#cd6e97e5e00e7706f99f373324b08f81f00bf74f\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid cd6e97e5e00e7706f99f373324b08f81f00bf74f\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/platform-browser-builds/tar.gz/cd6e97e5e00e7706f99f373324b08f81f00bf74f\"\n   dependencies:\n     tslib \"^2.0.0\"\n \n \"@angular/router@github:angular/router-builds#ae1dc731c88598c1e25083657497dfe78f8931a2\":\n-  version \"12.0.0-next.3+18.sha-c676ec1\"\n-  uid ae1dc731c88598c1e25083657497dfe78f8931a2\n+  version \"12.0.0-next.3\"\n   resolved \"https://codeload.github.com/angular/router-builds/tar.gz/ae1dc731c88598c1e25083657497dfe78f8931a2\"\n   dependencies:\n     tslib \"^2.0.0\"\n@@ -2627,6 +2616,11 @@\n   resolved \"https://registry.yarnpkg.com/@types/q/-/q-1.5.4.tgz#15925414e0ad2cd765bfef58842f7e26a7accb24\"\n   integrity sha512-1HcDas8SEj4z1Wc696tH56G8OlRaH/sqZOynNNB+HF0WOeXPaxTtbYzJY2oEfiUxjSKjhCKr+MvR7dCHcEelug==\n \n+\"@types/resize-observer-browser@^0.1.5\":\n+  version \"0.1.5\"\n+  resolved \"https://registry.yarnpkg.com/@types/resize-observer-browser/-/resize-observer-browser-0.1.5.tgz#36d897708172ac2380cd486da7a3daf1161c1e23\"\n+  integrity sha512-8k/67Z95Goa6Lznuykxkfhq9YU3l1Qe6LNZmwde1u7802a3x8v44oq0j91DICclxatTr0rNnhXx7+VTIetSrSQ==\n+\n \"@types/resolve@1.17.1\":\n   version \"1.17.1\"\n   resolved \"https://registry.yarnpkg.com/@types/resolve/-/resolve-1.17.1.tgz#3afd6ad8967c77e4376c598a82ddd58f46ec45d6\""
        }
    ],
    "stats": {
        "total": 106,
        "additions": 51,
        "deletions": 55
    }
}