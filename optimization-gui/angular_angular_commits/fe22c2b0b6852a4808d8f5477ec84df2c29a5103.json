{
    "author": "atscott",
    "message": "fix(language-service): Correct rename info for pipe name expressions (#41974)\n\nPrior to this PR, attempting to get rename info for pipe name expressions would defer to the\ntypescript language service, which would return no rename info. This was not caught because\nthe test was written incorrectly.\n\nThis PR corrects the test behavior and adjusts the logic in getting rename info to account\nfor indirect renames (like pipe names).\n\nPR Close #41974",
    "sha": "fe22c2b0b6852a4808d8f5477ec84df2c29a5103",
    "files": [
        {
            "sha": "74b85be19f42cb6fb3f11d3de2d1a1877bdf15e5",
            "filename": "packages/language-service/ivy/references_and_rename.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/fe22c2b0b6852a4808d8f5477ec84df2c29a5103/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe22c2b0b6852a4808d8f5477ec84df2c29a5103/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences_and_rename.ts?ref=fe22c2b0b6852a4808d8f5477ec84df2c29a5103",
            "patch": "@@ -154,7 +154,29 @@ export class RenameBuilder {\n       // We could not get a template at position so we assume the request came from outside the\n       // template.\n       if (templateInfo === undefined) {\n-        return this.tsLS.getRenameInfo(filePath, position);\n+        const renameRequest = this.buildRenameRequestAtTypescriptPosition(filePath, position);\n+        if (renameRequest === null) {\n+          return {\n+            canRename: false,\n+            localizedErrorMessage: 'Could not determine rename info at typescript position.',\n+          };\n+        }\n+        if (renameRequest.type === RequestKind.PipeName) {\n+          const pipeName = renameRequest.pipeNameExpr.text;\n+          return {\n+            canRename: true,\n+            displayName: pipeName,\n+            fullDisplayName: pipeName,\n+            triggerSpan: {\n+              length: pipeName.length,\n+              // Offset the pipe name by 1 to account for start of string '/`/\"\n+              start: renameRequest.pipeNameExpr.getStart() + 1,\n+            },\n+          };\n+        } else {\n+          // TODO(atscott): Add support for other special indirect renames from typescript files.\n+          return this.tsLS.getRenameInfo(filePath, position);\n+        }\n       }\n \n       const allTargetDetails = getTargetDetailsAtTemplatePosition(templateInfo, position, this.ttc);"
        },
        {
            "sha": "a8a994cbf352d3651497a9b360266a38510498a3",
            "filename": "packages/language-service/ivy/test/references_and_rename_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/fe22c2b0b6852a4808d8f5477ec84df2c29a5103/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_and_rename_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/fe22c2b0b6852a4808d8f5477ec84df2c29a5103/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_and_rename_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_and_rename_spec.ts?ref=fe22c2b0b6852a4808d8f5477ec84df2c29a5103",
            "patch": "@@ -809,20 +809,23 @@ describe('find references and rename locations', () => {\n           birthday = '';\n         }\n       `,\n-          'prefix-pipe.ts': prefixPipe\n+          'prefix_pipe.ts': prefixPipe\n         };\n         env = LanguageServiceTestEnv.setup();\n         const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n-        const file = project.openFile('app.ts');\n-        file.moveCursorToText('prefi¦xPipe:');\n+        const file = project.openFile('prefix_pipe.ts');\n+        file.moveCursorToText(`'prefi¦xPipe'`);\n         const renameLocations = getRenameLocationsAtPosition(file)!;\n         expect(renameLocations.length).toBe(2);\n-        assertFileNames(renameLocations, ['prefix-pipe.ts', 'app.ts']);\n+        assertFileNames(renameLocations, ['prefix_pipe.ts', 'app.ts']);\n         assertTextSpans(renameLocations, ['prefixPipe']);\n \n         const result = file.getRenameInfo() as ts.RenameInfoSuccess;\n         expect(result.canRename).toEqual(true);\n         expect(result.displayName).toEqual('prefixPipe');\n+        expect(file.contents.substring(\n+                   result.triggerSpan.start, result.triggerSpan.start + result.triggerSpan.length))\n+            .toBe('prefixPipe');\n       });\n \n       it('finds rename locations in base class', () => {"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 30,
        "deletions": 5
    }
}