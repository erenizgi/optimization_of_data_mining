{
    "author": "atscott",
    "message": "refactor(language-service): de-duplicate rename and reference results (#40454)\n\nThe initial implementation assumed that the consuming editors would\nde-duplicate rename locations. In fact, vscode treats overlapping rename\nlocations as distinct and errors when trying to preview the renames.\n\nThis commit updates the language service to de-duplicate exact file+span\nmatches before returning rename and reference locations.\n\nWhile vscode _does_ de-duplicate reference results, it still makes sense\nto de-duplicate them on our side when possible to make tests more\nunderstandable. If a template has 3 instances of a variable, it makes\nsense to get get 3 reference results rather than 4+ with some duplicates.\n\nPR Close #40454",
    "sha": "402e2e618934c3b84555684915f87d3ee0e11d90",
    "files": [
        {
            "sha": "ab923898945de8608cdd0cea92d28a8b72410f5b",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/402e2e618934c3b84555684915f87d3ee0e11d90/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/402e2e618934c3b84555684915f87d3ee0e11d90/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=402e2e618934c3b84555684915f87d3ee0e11d90",
            "patch": "@@ -166,7 +166,7 @@ export class ReferencesAndRenameBuilder {\n       return undefined;\n     }\n \n-    const entries: ts.RenameLocation[] = [];\n+    const entries: Map<string, ts.RenameLocation> = new Map();\n     for (const location of locations) {\n       // TODO(atscott): Determine if a file is a shim file in a more robust way and make the API\n       // available in an appropriate location.\n@@ -177,17 +177,17 @@ export class ReferencesAndRenameBuilder {\n         if (entry === null) {\n           return undefined;\n         }\n-        entries.push(entry);\n+        entries.set(createLocationKey(entry), entry);\n       } else {\n         // Ensure we only allow renaming a TS result with matching text\n         const refNode = this.getTsNodeAtPosition(location.fileName, location.textSpan.start);\n         if (refNode === null || refNode.getText() !== originalNodeText) {\n           return undefined;\n         }\n-        entries.push(location);\n+        entries.set(createLocationKey(location), location);\n       }\n     }\n-    return entries;\n+    return Array.from(entries.values());\n   }\n \n   getReferencesAtPosition(filePath: string, position: number): ts.ReferenceEntry[]|undefined {\n@@ -344,18 +344,18 @@ export class ReferencesAndRenameBuilder {\n       return undefined;\n     }\n \n-    const entries: ts.ReferenceEntry[] = [];\n+    const entries: Map<string, ts.ReferenceEntry> = new Map();\n     for (const ref of refs) {\n       if (this.ttc.isTrackedTypeCheckFile(absoluteFrom(ref.fileName))) {\n         const entry = this.convertToTemplateDocumentSpan(ref, this.ttc);\n         if (entry !== null) {\n-          entries.push(entry);\n+          entries.set(createLocationKey(entry), entry);\n         }\n       } else {\n-        entries.push(ref);\n+        entries.set(createLocationKey(ref), ref);\n       }\n     }\n-    return entries;\n+    return Array.from(entries.values());\n   }\n \n   private convertToTemplateDocumentSpan<T extends ts.DocumentSpan>(\n@@ -432,3 +432,13 @@ function getRenameTextAndSpanAtPosition(node: TmplAstNode|AST, position: number)\n \n   return null;\n }\n+\n+\n+/**\n+ * Creates a \"key\" for a rename/reference location by concatenating file name, span start, and span\n+ * length. This allows us to de-duplicate template results when an item may appear several times\n+ * in the TCB but map back to the same template location.\n+ */\n+function createLocationKey(ds: ts.DocumentSpan) {\n+  return ds.fileName + ds.textSpan.start + ds.textSpan.length;\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "66959b221a6a84cbc83b2da5d7b637b2478e6bb8",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 12,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/402e2e618934c3b84555684915f87d3ee0e11d90/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/402e2e618934c3b84555684915f87d3ee0e11d90/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=402e2e618934c3b84555684915f87d3ee0e11d90",
            "patch": "@@ -554,33 +554,43 @@ describe('find references and rename locations', () => {\n       let cursor: number;\n       beforeEach(() => {\n         const cursorInfo = extractCursorInfo(`\n+          <div *ngFor=\"let hero of heroes\">\n+            <span *ngIf=\"hero\">\n+              {{her¦o}}\n+            </span>\n+          </div>\n+          `);\n+        cursor = cursorInfo.cursor;\n+        const appFile = {\n+          name: _('/app.ts'),\n+          contents: `\n           import {Component} from '@angular/core';\n \n-          @Component({template: '<div *ngFor=\"let hero of heroes\">{{her¦o}}</div>'})\n+          @Component({templateUrl: './template.ng.html'})\n           export class AppCmp {\n             heroes: string[] = [];\n-          }`);\n-        cursor = cursorInfo.cursor;\n-        const appFile = {name: _('/app.ts'), contents: cursorInfo.text};\n-        env = createModuleWithDeclarations([appFile]);\n+          }`\n+        };\n+        const templateFile = {name: _('/template.ng.html'), contents: cursorInfo.text};\n+        env = createModuleWithDeclarations([appFile], [templateFile]);\n       });\n \n       it('should find references', () => {\n-        const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n-        expect(refs.length).toBe(2);\n-        assertFileNames(refs, ['app.ts']);\n+        const refs = getReferencesAtPosition(_('/template.ng.html'), cursor)!;\n+        expect(refs.length).toBe(3);\n+        assertFileNames(refs, ['template.ng.html']);\n         assertTextSpans(refs, ['hero']);\n \n-        const originalRefs = env.ngLS.getReferencesAtPosition(_('/app.ts'), cursor)!;\n+        const originalRefs = env.ngLS.getReferencesAtPosition(_('/template.ng.html'), cursor)!;\n         // Get the declaration by finding the reference that appears first in the template\n         originalRefs.sort((a, b) => a.textSpan.start - b.textSpan.start);\n         expect(originalRefs[0].isDefinition).toBe(true);\n       });\n \n       it('should find rename locations', () => {\n-        const renameLocations = getRenameLocationsAtPosition(_('/app.ts'), cursor)!;\n-        expect(renameLocations.length).toBe(2);\n-        assertFileNames(renameLocations, ['app.ts']);\n+        const renameLocations = getRenameLocationsAtPosition(_('/template.ng.html'), cursor)!;\n+        expect(renameLocations.length).toBe(3);\n+        assertFileNames(renameLocations, ['template.ng.html']);\n         assertTextSpans(renameLocations, ['hero']);\n       });\n     });"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 40,
        "deletions": 20
    }
}