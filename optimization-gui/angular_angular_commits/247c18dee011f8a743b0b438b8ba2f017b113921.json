{
    "author": "crisbeto",
    "message": "fix(compiler-cli): handle pre-release versions when checking version (#44109)\n\nCurrently the TS version checking function interprets a version like `1.2.3-rc.5` as `1.2.NaN` which would allow it to bypass the version checking altogether.\n\nThese changes add a little bit more logic to ensure that such versions are handled correctly. There's also an error if we don't manage to parse the version string.\n\nAlso it seemed like we never actually ran the version check unit tests, because they didn't have a test target.\n\nPR Close #44109",
    "sha": "247c18dee011f8a743b0b438b8ba2f017b113921",
    "files": [
        {
            "sha": "6f5fcdc9423c2833063205c4208c5d3f2e3cf2df",
            "filename": "packages/compiler-cli/src/diagnostics/typescript_version.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/247c18dee011f8a743b0b438b8ba2f017b113921/packages%2Fcompiler-cli%2Fsrc%2Fdiagnostics%2Ftypescript_version.ts",
            "raw_url": "https://github.com/angular/angular/raw/247c18dee011f8a743b0b438b8ba2f017b113921/packages%2Fcompiler-cli%2Fsrc%2Fdiagnostics%2Ftypescript_version.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fdiagnostics%2Ftypescript_version.ts?ref=247c18dee011f8a743b0b438b8ba2f017b113921",
            "patch": "@@ -12,7 +12,17 @@\n  * toNumbers('2.0.1'); // returns [2, 0, 1]\n  */\n export function toNumbers(value: string): number[] {\n-  return value.split('.').map(Number);\n+  // Drop any suffixes starting with `-` so that versions like `1.2.3-rc.5` are treated as `1.2.3`.\n+  const suffixIndex = value.lastIndexOf('-');\n+  return value.slice(0, suffixIndex === -1 ? value.length : suffixIndex).split('.').map(segment => {\n+    const parsed = parseInt(segment, 10);\n+\n+    if (isNaN(parsed)) {\n+      throw Error(`Unable to parse version string ${value}.`);\n+    }\n+\n+    return parsed;\n+  });\n }\n \n /**"
        },
        {
            "sha": "4b929bfcf693497563551bbb3c64302aeb47900a",
            "filename": "packages/compiler-cli/test/BUILD.bazel",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/247c18dee011f8a743b0b438b8ba2f017b113921/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/247c18dee011f8a743b0b438b8ba2f017b113921/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2FBUILD.bazel?ref=247c18dee011f8a743b0b438b8ba2f017b113921",
            "patch": "@@ -145,3 +145,22 @@ jasmine_node_test(\n         \"//packages/core\",\n     ],\n )\n+\n+ts_library(\n+    name = \"typescript_support_lib\",\n+    testonly = True,\n+    srcs = [\n+        \"typescript_support_spec.ts\",\n+    ],\n+    deps = [\n+        \"//packages/compiler-cli\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"typescript_support\",\n+    bootstrap = [\"//tools/testing:node_es5\"],\n+    deps = [\n+        \":typescript_support_lib\",\n+    ],\n+)"
        },
        {
            "sha": "59cac3f23eee81ccb94bbc2db9678b871c5c48ae",
            "filename": "packages/compiler-cli/test/typescript_support_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/247c18dee011f8a743b0b438b8ba2f017b113921/packages%2Fcompiler-cli%2Ftest%2Ftypescript_support_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/247c18dee011f8a743b0b438b8ba2f017b113921/packages%2Fcompiler-cli%2Ftest%2Ftypescript_support_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Ftypescript_support_spec.ts?ref=247c18dee011f8a743b0b438b8ba2f017b113921",
            "patch": "@@ -32,4 +32,16 @@ describe('checkVersion', () => {\n     expect(() => checkVersion('2.8.0', MIN_TS_VERSION, MAX_TS_VERSION))\n         .toThrowError(versionError('2.8.0'));\n   });\n+\n+  it('should throw when an out-of-bounds pre-release version is used', () => {\n+    expect(() => checkVersion('2.7.0-beta', MIN_TS_VERSION, MAX_TS_VERSION))\n+        .toThrowError(versionError('2.7.0-beta'));\n+    expect(() => checkVersion('2.8.5-rc.3', MIN_TS_VERSION, MAX_TS_VERSION))\n+        .toThrowError(versionError('2.8.5-rc.3'));\n+  });\n+\n+  it('should not throw when a valid pre-release version is used', () => {\n+    expect(() => checkVersion('2.7.2-beta', MIN_TS_VERSION, MAX_TS_VERSION)).not.toThrow();\n+    expect(() => checkVersion('2.7.9-rc.8', MIN_TS_VERSION, MAX_TS_VERSION)).not.toThrow();\n+  });\n });"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 42,
        "deletions": 1
    }
}