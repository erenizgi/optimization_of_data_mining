{
    "author": "Zuckjet",
    "message": "fix(animations): should not invoke disabled child animations (#37724)\n\nCurrently child animation will be triggered by `animateChild()` despite it has been disabled.\nThese changes add some logic to prevent that unexpected behavior.\n\nPR Close #37724\n\nPR Close #37724",
    "sha": "bab7ed35418173714509e06ba8b092aff28fff89",
    "files": [
        {
            "sha": "6d8fd23c0b4cbba925120a93664241d424d8188f",
            "filename": "packages/animations/browser/src/render/transition_animation_engine.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/bab7ed35418173714509e06ba8b092aff28fff89/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts",
            "raw_url": "https://github.com/angular/angular/raw/bab7ed35418173714509e06ba8b092aff28fff89/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts?ref=bab7ed35418173714509e06ba8b092aff28fff89",
            "patch": "@@ -1034,7 +1034,14 @@ export class TransitionAnimationEngine {\n         // instead stretch the first keyframe gap until the animation starts. This is\n         // important in order to prevent extra initialization styles from being\n         // required by the user for the animation.\n-        instruction.timelines.forEach(tl => tl.stretchStartingKeyframe = true);\n+        const timelines: AnimationTimelineInstruction[] = [];\n+        instruction.timelines.forEach(tl => {\n+          tl.stretchStartingKeyframe = true;\n+          if (!this.disabledNodes.has(tl.element)) {\n+            timelines.push(tl);\n+          }\n+        });\n+        instruction.timelines = timelines;\n \n         subTimelines.append(element, instruction.timelines);\n "
        },
        {
            "sha": "4eb9803d8329d63700d51d20c3c49ccf42925bf8",
            "filename": "packages/core/test/animation/animation_query_integration_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 4,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/bab7ed35418173714509e06ba8b092aff28fff89/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_query_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bab7ed35418173714509e06ba8b092aff28fff89/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_query_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_query_integration_spec.ts?ref=bab7ed35418173714509e06ba8b092aff28fff89",
            "patch": "@@ -3309,14 +3309,14 @@ describe('animation query tests', function() {\n            })\n            class Cmp {\n              exp: any = '';\n-             disableExp = false;\n+             disabledExp = false;\n            }\n \n            TestBed.configureTestingModule({declarations: [Cmp]});\n \n            const fixture = TestBed.createComponent(Cmp);\n            const cmp = fixture.componentInstance;\n-           cmp.disableExp = true;\n+           cmp.disabledExp = true;\n            fixture.detectChanges();\n            resetLog();\n \n@@ -3363,14 +3363,14 @@ describe('animation query tests', function() {\n            })\n            class Cmp {\n              exp: any = '';\n-             disableExp = false;\n+             disabledExp = false;\n            }\n \n            TestBed.configureTestingModule({declarations: [Cmp]});\n \n            const fixture = TestBed.createComponent(Cmp);\n            const cmp = fixture.componentInstance;\n-           cmp.disableExp = true;\n+           cmp.disabledExp = true;\n            fixture.detectChanges();\n            resetLog();\n \n@@ -3386,6 +3386,63 @@ describe('animation query tests', function() {\n            expect(p2.duration).toEqual(1000);\n            expect(p2.element.classList.contains('parent')).toBeTrue();\n          });\n+\n+      it('should disable the animation for the given element regardless of existing parent element animation queries or child element animation queries',\n+         () => {\n+           @Component({\n+             selector: 'some-cmp',\n+             template: `\n+              <div class=\"parent\" [@parentAnimation]=\"exp\">\n+                <div class=\"child\" [@.disabled]=\"disabledExp\" [@childAnimation]=\"exp\">\n+                  <div class=\"grand-child\" [@grandChildAnimation]=\"exp\"></div>\n+                </div>\n+              </div>\n+            `,\n+             animations: [\n+               trigger(\n+                   'parentAnimation',\n+                   [\n+                     transition(\n+                         '* => go',\n+                         [query('@*', animateChild()), animate(1500, style({opacity: 0}))]),\n+                   ]),\n+               trigger(\n+                   'childAnimation',\n+                   [\n+                     transition('* => go', [animate(1000, style({opacity: 0}))]),\n+                   ]),\n+               trigger(\n+                   'grandChildAnimation',\n+                   [\n+                     transition('* => go', [animate(500, style({opacity: 0}))]),\n+                   ]),\n+             ]\n+           })\n+           class Cmp {\n+             exp: any = '';\n+             disabledExp = false;\n+           }\n+\n+           TestBed.configureTestingModule({declarations: [Cmp]});\n+\n+           const fixture = TestBed.createComponent(Cmp);\n+           const cmp = fixture.componentInstance;\n+           cmp.disabledExp = true;\n+           fixture.detectChanges();\n+           resetLog();\n+\n+           cmp.exp = 'go';\n+           fixture.detectChanges();\n+\n+           const players = getLog();\n+           expect(players.length).toEqual(2);\n+\n+           const [p1, p2] = players;\n+           expect(p1.duration).toEqual(500);\n+           expect(p1.element.classList.contains('grand-child')).toBeTrue();\n+           expect(p2.duration).toEqual(1500);\n+           expect(p2.element.classList.contains('parent')).toBeTrue();\n+         });\n     });\n   });\n });"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 69,
        "deletions": 5
    }
}