{
    "author": "JoostK",
    "message": "fix(platform-browser): prevent memory leak of style nodes if shadow DOM encapsulation is used (#42005)\n\nPrior to this change, any inserted `<style>` nodes into shadow dom trees would be retained\nin memory, even after the shadow dom tree has been removed. This commit fixes the memory\nleak by tracking the inserted `<style>` nodes per host element, such that removal of the\nhost element also releases the style nodes.\n\nFixes #36655\n\nPR Close #42005",
    "sha": "96624b71a7a512c714ae7ecd09eabe347285b25c",
    "files": [
        {
            "sha": "ac71b3c2880862beb51529965e147b0a999700ee",
            "filename": "packages/core/test/bundling/forms_reactive/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fcore%2Ftest%2Fbundling%2Fforms_reactive%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fcore%2Ftest%2Fbundling%2Fforms_reactive%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms_reactive%2Fbundle.golden_symbols.json?ref=96624b71a7a512c714ae7ecd09eabe347285b25c",
            "patch": "@@ -1430,6 +1430,9 @@\n   {\n     \"name\": \"removeListItem\"\n   },\n+  {\n+    \"name\": \"removeStyle\"\n+  },\n   {\n     \"name\": \"renderComponent\"\n   },"
        },
        {
            "sha": "067827b956e26cc6262462080d90db0b001d92c8",
            "filename": "packages/core/test/bundling/forms_template_driven/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fcore%2Ftest%2Fbundling%2Fforms_template_driven%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fcore%2Ftest%2Fbundling%2Fforms_template_driven%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms_template_driven%2Fbundle.golden_symbols.json?ref=96624b71a7a512c714ae7ecd09eabe347285b25c",
            "patch": "@@ -1394,6 +1394,9 @@\n   {\n     \"name\": \"removeListItem\"\n   },\n+  {\n+    \"name\": \"removeStyle\"\n+  },\n   {\n     \"name\": \"renderComponent\"\n   },"
        },
        {
            "sha": "29c8b54fc2fee08cea830415dd0db5c21819a325",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=96624b71a7a512c714ae7ecd09eabe347285b25c",
            "patch": "@@ -1832,6 +1832,9 @@\n   {\n     \"name\": \"removeFromArray\"\n   },\n+  {\n+    \"name\": \"removeStyle\"\n+  },\n   {\n     \"name\": \"renderComponent\"\n   },"
        },
        {
            "sha": "f82ee229c013c83dfef4791e80e4cb19d6ada176",
            "filename": "packages/platform-browser/src/dom/shared_styles_host.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 9,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fshared_styles_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fshared_styles_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Fsrc%2Fdom%2Fshared_styles_host.ts?ref=96624b71a7a512c714ae7ecd09eabe347285b25c",
            "patch": "@@ -34,35 +34,47 @@ export class SharedStylesHost {\n \n @Injectable()\n export class DomSharedStylesHost extends SharedStylesHost implements OnDestroy {\n-  private _hostNodes = new Set<Node>();\n-  private _styleNodes = new Set<Node>();\n+  // Maps all registered host nodes to a list of style nodes that have been added to the host node.\n+  private _hostNodes = new Map<Node, Node[]>();\n+\n   constructor(@Inject(DOCUMENT) private _doc: any) {\n     super();\n-    this._hostNodes.add(_doc.head);\n+    this._hostNodes.set(_doc.head, []);\n   }\n \n-  private _addStylesToHost(styles: Set<string>, host: Node): void {\n+  private _addStylesToHost(styles: Set<string>, host: Node, styleNodes: Node[]): void {\n     styles.forEach((style: string) => {\n       const styleEl = this._doc.createElement('style');\n       styleEl.textContent = style;\n-      this._styleNodes.add(host.appendChild(styleEl));\n+      styleNodes.push(host.appendChild(styleEl));\n     });\n   }\n \n   addHost(hostNode: Node): void {\n-    this._addStylesToHost(this._stylesSet, hostNode);\n-    this._hostNodes.add(hostNode);\n+    const styleNodes: Node[] = [];\n+    this._addStylesToHost(this._stylesSet, hostNode, styleNodes);\n+    this._hostNodes.set(hostNode, styleNodes);\n   }\n \n   removeHost(hostNode: Node): void {\n+    const styleNodes = this._hostNodes.get(hostNode);\n+    if (styleNodes) {\n+      styleNodes.forEach(removeStyle);\n+    }\n     this._hostNodes.delete(hostNode);\n   }\n \n   onStylesAdded(additions: Set<string>): void {\n-    this._hostNodes.forEach(hostNode => this._addStylesToHost(additions, hostNode));\n+    this._hostNodes.forEach((styleNodes, hostNode) => {\n+      this._addStylesToHost(additions, hostNode, styleNodes);\n+    });\n   }\n \n   ngOnDestroy(): void {\n-    this._styleNodes.forEach(styleNode => getDOM().remove(styleNode));\n+    this._hostNodes.forEach(styleNodes => styleNodes.forEach(removeStyle));\n   }\n }\n+\n+function removeStyle(styleNode: Node): void {\n+  getDOM().remove(styleNode);\n+}"
        },
        {
            "sha": "ac00e735d12de01eadb0070f1172a79e79fb6bb7",
            "filename": "packages/platform-browser/test/dom/shared_styles_host_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fplatform-browser%2Ftest%2Fdom%2Fshared_styles_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/96624b71a7a512c714ae7ecd09eabe347285b25c/packages%2Fplatform-browser%2Ftest%2Fdom%2Fshared_styles_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-browser%2Ftest%2Fdom%2Fshared_styles_host_spec.ts?ref=96624b71a7a512c714ae7ecd09eabe347285b25c",
            "patch": "@@ -47,6 +47,15 @@ import {expect} from '@angular/platform-browser/testing/src/matchers';\n       expect(doc.head).toHaveText('a {};b {};');\n     });\n \n+    it('should remove style nodes when the host is removed', () => {\n+      ssh.addStyles(['a {};']);\n+      ssh.addHost(someHost);\n+      expect(someHost.innerHTML).toEqual('<style>a {};</style>');\n+\n+      ssh.removeHost(someHost);\n+      expect(someHost.innerHTML).toEqual('');\n+    });\n+\n     it('should remove style nodes on destroy', () => {\n       ssh.addStyles(['a {};']);\n       ssh.addHost(someHost);"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 39,
        "deletions": 9
    }
}