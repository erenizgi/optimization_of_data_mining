{
    "author": "JoostK",
    "message": "fix(compiler-cli): prevent prior compilations from being retained in watch builds (#42537)\n\nIn watch builds, the compiler attempts to reuse as much information from\na prior compilation as possible. To accomplish this, it keeps a\nreference to the most recently succeeded `TraitCompiler`, which contains\nall analysis data for the program. However, `TraitCompiler` has an\ninternal reference to an `IncrementalBuild`, which is itself built on\ntop of its prior state. Consequently, all prior compilations continued\nto be referenced, preventing garbage collection from cleaning up these\ninstances.\n\nThis commit changes the `AnalyzedIncrementalState` to no longer retain\na `TraitCompiler` instance, but only the analysis data it contains. This\nbreaks the retainer path to the prior incremental state, allowing it to\nbe garbage collected.\n\nPR Close #42537",
    "sha": "22bda2226bd42d081b7314c1b11144ad79ad1c44",
    "files": [
        {
            "sha": "1f466dc968c011211a46bf91c71df2a4e60ba5d3",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/incremental.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts",
            "raw_url": "https://github.com/angular/angular/raw/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fincremental.ts?ref=22bda2226bd42d081b7314c1b11144ad79ad1c44",
            "patch": "@@ -259,7 +259,7 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n       versions: this.versions,\n       depGraph: this.depGraph,\n       semanticDepGraph: newGraph,\n-      traitCompiler,\n+      priorAnalysis: traitCompiler.getAnalyzedRecords(),\n       typeCheckResults: null,\n       emitted,\n     };\n@@ -303,7 +303,11 @@ export class IncrementalCompilation implements IncrementalBuild<ClassRecord, Fil\n       return null;\n     }\n \n-    return this.step.priorState.traitCompiler.recordsFor(sf);\n+    const priorAnalysis = this.step.priorState.priorAnalysis;\n+    if (!priorAnalysis.has(sf)) {\n+      return null;\n+    }\n+    return priorAnalysis.get(sf)!;\n   }\n \n   priorTypeCheckingResultsFor(sf: ts.SourceFile): FileTypeCheckingData|null {"
        },
        {
            "sha": "5526affe5c055cc41ccdd99377177ff1b05c6aae",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/state.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "raw_url": "https://github.com/angular/angular/raw/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts?ref=22bda2226bd42d081b7314c1b11144ad79ad1c44",
            "patch": "@@ -6,8 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import * as ts from 'typescript';\n+\n import {AbsoluteFsPath} from '../../file_system';\n-import {TraitCompiler} from '../../transform';\n+import {ClassRecord} from '../../transform';\n import {FileTypeCheckingData} from '../../typecheck/src/checker';\n import {SemanticDepGraph} from '../semantic_graph';\n \n@@ -51,9 +53,10 @@ export interface AnalyzedIncrementalState {\n   semanticDepGraph: SemanticDepGraph;\n \n   /**\n-   * `TraitCompiler` which contains records of all analyzed classes within the build.\n+   * The analysis data from a prior compilation. This stores the trait information for all source\n+   * files that was present in a prior compilation.\n    */\n-  traitCompiler: TraitCompiler;\n+  priorAnalysis: Map<ts.SourceFile, ClassRecord[]>;\n \n   /**\n    * All generated template type-checking files produced as part of this compilation, or `null` if"
        },
        {
            "sha": "77fb8e15f5ed08b1bc97884a63e1914505fc939f",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2FBUILD.bazel?ref=22bda2226bd42d081b7314c1b11144ad79ad1c44",
            "patch": "@@ -16,6 +16,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/transform\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "1dd3edca02318943fe5e8978b039947d918ae946",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/test/incremental_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2Fincremental_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2Fincremental_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Ftest%2Fincremental_spec.ts?ref=22bda2226bd42d081b7314c1b11144ad79ad1c44",
            "patch": "@@ -10,6 +10,7 @@ import {absoluteFrom, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {NOOP_PERF_RECORDER} from '../../perf';\n import {makeProgram} from '../../testing';\n+import {TraitCompiler} from '../../transform';\n import {IncrementalCompilation} from '../src/incremental';\n \n runInEachFileSystem(() => {\n@@ -20,21 +21,22 @@ runInEachFileSystem(() => {\n         {name: FOO_PATH, contents: `export const FOO = true;`},\n       ]);\n       const fooSf = getSourceFileOrError(program, FOO_PATH);\n+      const traitCompiler = {getAnalyzedRecords: () => new Map()} as TraitCompiler;\n \n       const versionMapFirst = new Map([[FOO_PATH, 'version.1']]);\n       const firstCompilation = IncrementalCompilation.fresh(\n           program,\n           versionMapFirst,\n       );\n-      firstCompilation.recordSuccessfulAnalysis(null!);\n+      firstCompilation.recordSuccessfulAnalysis(traitCompiler);\n       firstCompilation.recordSuccessfulEmit(fooSf);\n \n       const versionMapSecond = new Map([[FOO_PATH, 'version.2']]);\n       const secondCompilation = IncrementalCompilation.incremental(\n           program, versionMapSecond, program, firstCompilation.state, new Set(),\n           NOOP_PERF_RECORDER);\n \n-      secondCompilation.recordSuccessfulAnalysis(null!);\n+      secondCompilation.recordSuccessfulAnalysis(traitCompiler);\n       expect(secondCompilation.safeToSkipEmit(fooSf)).toBeFalse();\n     });\n   });"
        },
        {
            "sha": "a189f5d4a93b51d26ca444ffe1e3dc6bbc0cd579",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/compilation.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/22bda2226bd42d081b7314c1b11144ad79ad1c44/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts?ref=22bda2226bd42d081b7314c1b11144ad79ad1c44",
            "patch": "@@ -166,6 +166,18 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n     return records;\n   }\n \n+  getAnalyzedRecords(): Map<ts.SourceFile, ClassRecord[]> {\n+    const result = new Map<ts.SourceFile, ClassRecord[]>();\n+    for (const [sf, classes] of this.fileToClasses) {\n+      const records: ClassRecord[] = [];\n+      for (const clazz of classes) {\n+        records.push(this.classes.get(clazz)!);\n+      }\n+      result.set(sf, records);\n+    }\n+    return result;\n+  }\n+\n   /**\n    * Import a `ClassRecord` from a previous compilation.\n    *"
        }
    ],
    "stats": {
        "total": 36,
        "additions": 29,
        "deletions": 7
    }
}