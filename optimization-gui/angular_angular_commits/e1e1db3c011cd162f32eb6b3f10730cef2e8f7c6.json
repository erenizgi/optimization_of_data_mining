{
    "author": "kyliau",
    "message": "fix(language-service): Paths on Windows should be normalized (#40492)\n\nMany `ts.LanguageService` APIs accept a filename, for example\n```ts\ngetQuickInfoAtPosition(fileName: string, position: number)\n```\nThe requirement is that `fileName` is agnostic to the platform (Linux, Mac,\nWindows, etc), and is always normalized to TypeScript's internal\n`NormalizedPath`.\n\nThis is evident from the way these APIs are called from the language server:\n```ts\n  private onHover(params: lsp.TextDocumentPositionParams) {\n    const lsInfo = this.getLSAndScriptInfo(params.textDocument);\n    if (lsInfo === undefined) {\n      return;\n    }\n    const {languageService, scriptInfo} = lsInfo;\n    const offset = lspPositionToTsPosition(scriptInfo, params.position);\n    const info = languageService.getQuickInfoAtPosition(scriptInfo.fileName, offset);\n    // ...\n  }\n```\nhttps://github.com/angular/vscode-ng-language-service/blob/9fca9c66510974c26d5c21b31adb9fa39ac0a38a/server/src/session.ts#L594\nHere `scriptInfo.fileName` is always a `ts.server.NormalizedPath`.\n\nHowever, https://github.com/angular/angular/pull/39917 accidentally leaked\nthe platform-specific paths, and caused a mismatch between the incoming paths\nand the paths stored in the internal data structure `fileToComponent`.\n\nThis PR fixes the bug by always normalizing the paths, and updating the\ntype to reflect the format of the underlying data.\n\nFixes https://github.com/angular/vscode-ng-language-service/issues/1063\n\nPR Close #40492",
    "sha": "e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6",
    "files": [
        {
            "sha": "934501daf9cc3f9f45c221368cdfda8b07a73bc8",
            "filename": "packages/language-service/src/typescript_host.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftypescript_host.ts?ref=e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6",
            "patch": "@@ -62,7 +62,12 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n   private readonly staticSymbolResolver: StaticSymbolResolver;\n \n   private readonly staticSymbolCache = new StaticSymbolCache();\n-  private readonly fileToComponent = new Map<string, StaticSymbol>();\n+  /**\n+   * Key of the `fileToComponent` map must be TS internal normalized path (path\n+   * separator must be `/`), value of the map is the StaticSymbol for the\n+   * Component class declaration.\n+   */\n+  private readonly fileToComponent = new Map<ts.server.NormalizedPath, StaticSymbol>();\n   private readonly collectedErrors = new Map<string, any[]>();\n   private readonly fileVersions = new Map<string, string>();\n   private readonly urlResolver: UrlResolver;\n@@ -165,7 +170,7 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n   /**\n    * Return all known external templates.\n    */\n-  getExternalTemplates(): string[] {\n+  getExternalTemplates(): ts.server.NormalizedPath[] {\n     return [...this.fileToComponent.keys()];\n   }\n \n@@ -210,7 +215,7 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n           const templateName = this.urlResolver.resolve(\n               this.reflector.componentModuleUrl(directive.reference),\n               metadata.template.templateUrl);\n-          this.fileToComponent.set(templateName, directive.reference);\n+          this.fileToComponent.set(tss.server.toNormalizedPath(templateName), directive.reference);\n         }\n       }\n     }\n@@ -417,7 +422,7 @@ export class TypeScriptServiceHost implements LanguageServiceHost {\n     }\n     const source = snapshot.getText(0, snapshot.getLength());\n     // Next find the component class symbol\n-    const classSymbol = this.fileToComponent.get(fileName);\n+    const classSymbol = this.fileToComponent.get(tss.server.toNormalizedPath(fileName));\n     if (!classSymbol) {\n       return;\n     }"
        },
        {
            "sha": "ee4b7ed69c9aceb1bf264436d68d2add92e0fd75",
            "filename": "packages/language-service/test/typescript_host_spec.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6/packages%2Flanguage-service%2Ftest%2Ftypescript_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6/packages%2Flanguage-service%2Ftest%2Ftypescript_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Ftypescript_host_spec.ts?ref=e1e1db3c011cd162f32eb6b3f10730cef2e8f7c6",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import * as path from 'path';\n import * as ts from 'typescript';\n \n import {TypeScriptServiceHost} from '../src/typescript_host';\n@@ -114,7 +115,7 @@ describe('TypeScriptServiceHost', () => {\n     const tsLS = ts.createLanguageService(tsLSHost);\n     const ngLSHost = new TypeScriptServiceHost(tsLSHost, tsLS);\n     ngLSHost.getAnalyzedModules();\n-    expect(ngLSHost.getExternalTemplates()).toContain('/app/#inner/inner.html');\n+    expect(ngLSHost.getExternalTemplates() as string[]).toContain('/app/#inner/inner.html');\n   });\n \n   // https://github.com/angular/angular/issues/32301\n@@ -238,7 +239,7 @@ describe('TypeScriptServiceHost', () => {\n     let content = `\n     import {CommonModule} from '@angular/common';\n     import {NgModule} from '@angular/core';\n-    \n+\n     @NgModule({\n       entryComponents: [CommonModule],\n     })\n@@ -256,7 +257,7 @@ describe('TypeScriptServiceHost', () => {\n     content = `\n     import {CommonModule} from '@angular/common';\n     import {NgModule} from '@angular/core';\n-    \n+\n     @NgModule({})\n     export class AppModule {}\n     `;\n@@ -265,4 +266,19 @@ describe('TypeScriptServiceHost', () => {\n     newModules = ngLSHost.getAnalyzedModules();\n     expect(newModules.ngModules.length).toBeGreaterThan(0);\n   });\n+\n+  it('should normalize path on Windows', () => {\n+    // Spy on the `path.resolve()` method called by the URL resolver and mimic\n+    // behavior on Windows.\n+    spyOn(path, 'resolve').and.callFake((...pathSegments: string[]) => {\n+      return path.win32.resolve(...pathSegments);\n+    });\n+    const tsLSHost = new MockTypescriptHost(['/app/main.ts']);\n+    const tsLS = ts.createLanguageService(tsLSHost);\n+    const ngLSHost = new TypeScriptServiceHost(tsLSHost, tsLS);\n+    ngLSHost.getAnalyzedModules();\n+    const externalTemplates: string[] = ngLSHost.getExternalTemplates();\n+    // External templates should be normalized.\n+    expect(externalTemplates).toContain('/app/test.ng');\n+  });\n });"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 28,
        "deletions": 7
    }
}