{
    "author": "JoostK",
    "message": "fix(compiler-cli): report error when a reference target is missing instead of crashing (#39805)\n\nIf a template declares a reference to a missing target then referring to\nthat reference from elsewhere in the template would crash the template\ntype checker, due to a regression introduced in #38618. This commit\nfixes the crash by ensuring that the invalid reference will resolve to\na variable of type any.\n\nFixes #39744\n\nPR Close #39805",
    "sha": "453b32f4b9936b78cfb2991b64d78c0509c94514",
    "files": [
        {
            "sha": "59e87635b9b1c789499f41669db8eb4051d00689",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 4,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/453b32f4b9936b78cfb2991b64d78c0509c94514/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/453b32f4b9936b78cfb2991b64d78c0509c94514/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=453b32f4b9936b78cfb2991b64d78c0509c94514",
            "patch": "@@ -458,6 +458,26 @@ class TcbReferenceOp extends TcbOp {\n   }\n }\n \n+/**\n+ * A `TcbOp` which is used when the target of a reference is missing. This operation generates a\n+ * variable of type any for usages of the invalid reference to resolve to. The invalid reference\n+ * itself is recorded out-of-band.\n+ */\n+class TcbInvalidReferenceOp extends TcbOp {\n+  constructor(private readonly tcb: Context, private readonly scope: Scope) {\n+    super();\n+  }\n+\n+  // The declaration of a missing reference is only needed when the reference is resolved.\n+  readonly optional = true;\n+\n+  execute(): ts.Identifier {\n+    const id = this.tcb.allocateId();\n+    this.scope.addStatement(tsCreateVariable(id, NULL_AS_ANY));\n+    return id;\n+  }\n+}\n+\n /**\n  * A `TcbOp` which constructs an instance of a directive with types inferred from its inputs. The\n  * inputs themselves are not checked here; checking of inputs is achieved in `TcbDirectiveInputsOp`.\n@@ -1353,13 +1373,15 @@ class Scope {\n   private checkAndAppendReferencesOfNode(node: TmplAstElement|TmplAstTemplate): void {\n     for (const ref of node.references) {\n       const target = this.tcb.boundTarget.getReferenceTarget(ref);\n+\n+      let ctxIndex: number;\n       if (target === null) {\n+        // The reference is invalid if it doesn't have a target, so report it as an error.\n         this.tcb.oobRecorder.missingReferenceTarget(this.tcb.id, ref);\n-        continue;\n-      }\n \n-      let ctxIndex: number;\n-      if (target instanceof TmplAstTemplate || target instanceof TmplAstElement) {\n+        // Any usages of the invalid reference will be resolved to a variable of type any.\n+        ctxIndex = this.opQueue.push(new TcbInvalidReferenceOp(this.tcb, this)) - 1;\n+      } else if (target instanceof TmplAstTemplate || target instanceof TmplAstElement) {\n         ctxIndex = this.opQueue.push(new TcbReferenceOp(this.tcb, this, ref, node, target)) - 1;\n       } else {\n         ctxIndex ="
        },
        {
            "sha": "def7a8bf16aeb47c8e969f833ee7b775744cab0b",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/453b32f4b9936b78cfb2991b64d78c0509c94514/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/453b32f4b9936b78cfb2991b64d78c0509c94514/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=453b32f4b9936b78cfb2991b64d78c0509c94514",
            "patch": "@@ -1080,6 +1080,29 @@ export declare class AnimationEvent {\n       expect(getSourceCodeForDiagnostic(diags[0])).toBe('unknownTarget');\n     });\n \n+    it('should treat an unknown local ref target as type any', () => {\n+      env.write('test.ts', `\n+        import {Component, NgModule} from '@angular/core';\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<div #ref=\"unknownTarget\">{{ use(ref) }}</div>',\n+        })\n+        class TestCmp {\n+          use(ref: string): string { return ref; }\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp],\n+        })\n+        class Module {}\n+      `);\n+      const diags = env.driveDiagnostics();\n+      expect(diags.length).toBe(1);\n+      expect(diags[0].messageText).toBe(`No directive found with exportAs 'unknownTarget'.`);\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('unknownTarget');\n+    });\n+\n     it('should report an error with an unknown pipe', () => {\n       env.write('test.ts', `\n         import {Component, NgModule} from '@angular/core';"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 49,
        "deletions": 4
    }
}