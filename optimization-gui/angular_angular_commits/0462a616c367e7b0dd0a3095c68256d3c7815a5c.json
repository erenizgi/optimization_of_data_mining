{
    "author": "petebacondarwin",
    "message": "fix(compiler): ensure that placeholders have the correct sourceSpan (#39717)\n\nWhen the `preserveWhitespaces` is not true, the template parser will\nprocess the parsed AST nodes to remove excess whitespace. Since the\ngenerated `goog.getMsg()` statements rely upon the AST nodes after\nthis whitespace is removed, the i18n extraction must make a second pass.\n\nPreviously this resulted in innacurrate source-spans for the i18n text and\nplaceholder nodes that were extracted in the second pass.\n\nThis commit fixes this by reusing the source-spans from the first pass\nwhen extracting the nodes in the second pass.\n\nFixes #39671\n\nPR Close #39717",
    "sha": "0462a616c367e7b0dd0a3095c68256d3c7815a5c",
    "files": [
        {
            "sha": "017abd819041f2296ba5e5906dfafad6ad200bb1",
            "filename": "packages/compiler-cli/test/ngtsc/template_mapping_spec.ts",
            "status": "modified",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/angular/angular/blob/0462a616c367e7b0dd0a3095c68256d3c7815a5c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0462a616c367e7b0dd0a3095c68256d3c7815a5c/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts?ref=0462a616c367e7b0dd0a3095c68256d3c7815a5c",
            "patch": "@@ -427,6 +427,95 @@ runInEachFileSystem((os) => {\n           });\n         });\n \n+        it('should correctly handle collapsed whitespace in interpolation placeholder source-mappings',\n+           () => {\n+             const mappings = compileAndMap(\n+                 `<div i18n title=\"  pre-title {{title_value}}  post-title\" i18n-title>  pre-body {{body_value}}  post-body</div>`);\n+             expectMapping(mappings, {\n+               source: '<div i18n title=\"  pre-title {{title_value}}  post-title\" i18n-title>  ',\n+               generated: 'i0.ɵɵelementStart(0, \"div\", 0)',\n+               sourceUrl: '../test.ts',\n+             });\n+             expectMapping(mappings, {\n+               source: '</div>',\n+               generated: 'i0.ɵɵelementEnd()',\n+               sourceUrl: '../test.ts',\n+             });\n+             expectMapping(mappings, {\n+               source: '  pre-body ',\n+               generated: '` pre-body ${',\n+               sourceUrl: '../test.ts',\n+             });\n+             expectMapping(mappings, {\n+               source: '{{body_value}}',\n+               generated: '\"\\\\uFFFD0\\\\uFFFD\"',\n+               sourceUrl: '../test.ts',\n+             });\n+             expectMapping(mappings, {\n+               source: '  post-body',\n+               generated: '}:INTERPOLATION: post-body`',\n+               sourceUrl: '../test.ts',\n+             });\n+           });\n+\n+        it('should correctly handle collapsed whitespace in element placeholder source-mappings',\n+           () => {\n+             const mappings =\n+                 compileAndMap(`<div i18n>\\n  pre-p\\n  <p>\\n    in-p\\n  </p>\\n  post-p\\n</div>`);\n+             // $localize expressions\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: 'pre-p\\n  ',\n+               generated: '` pre-p ${',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '<p>\\n    ',\n+               generated: '\"\\\\uFFFD#2\\\\uFFFD\"',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: 'in-p\\n  ',\n+               generated: '}:START_PARAGRAPH: in-p ${',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '</p>\\n  ',\n+               generated: '\"\\\\uFFFD/#2\\\\uFFFD\"',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: 'post-p\\n',\n+               generated: '}:CLOSE_PARAGRAPH: post-p\\n`',\n+             });\n+             // ivy instructions\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '<div i18n>\\n  ',\n+               generated: 'i0.ɵɵelementStart(0, \"div\")',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '<div i18n>\\n  ',\n+               generated: 'i0.ɵɵi18nStart(1, 0)',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '<p>\\n    in-p\\n  </p>',\n+               generated: 'i0.ɵɵelement(2, \"p\")',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '</div>',\n+               generated: 'i0.ɵɵi18nEnd()',\n+             });\n+             expectMapping(mappings, {\n+               sourceUrl: '../test.ts',\n+               source: '</div>',\n+               generated: 'i0.ɵɵelementEnd()',\n+             });\n+           });\n+\n         it('should create tag (container) placeholder source-mappings', () => {\n           const mappings = compileAndMap(`<div i18n>Hello, <b>World</b>!</div>`);\n           expectMapping(mappings, {"
        },
        {
            "sha": "4e85abfc49e68a6e13cb156feaaf1b05b41934ef",
            "filename": "packages/compiler/src/i18n/i18n_parser.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 3,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/0462a616c367e7b0dd0a3095c68256d3c7815a5c/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/0462a616c367e7b0dd0a3095c68256d3c7815a5c/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts?ref=0462a616c367e7b0dd0a3095c68256d3c7815a5c",
            "patch": "@@ -105,12 +105,13 @@ class _I18nVisitor implements html.Visitor {\n   }\n \n   visitAttribute(attribute: html.Attribute, context: I18nMessageVisitorContext): i18n.Node {\n-    const node = this._visitTextWithInterpolation(attribute.value, attribute.sourceSpan, context);\n+    const node = this._visitTextWithInterpolation(\n+        attribute.value, attribute.valueSpan || attribute.sourceSpan, context, attribute.i18n);\n     return context.visitNodeFn(attribute, node);\n   }\n \n   visitText(text: html.Text, context: I18nMessageVisitorContext): i18n.Node {\n-    const node = this._visitTextWithInterpolation(text.value, text.sourceSpan, context);\n+    const node = this._visitTextWithInterpolation(text.value, text.sourceSpan, context, text.i18n);\n     return context.visitNodeFn(text, node);\n   }\n \n@@ -156,7 +157,8 @@ class _I18nVisitor implements html.Visitor {\n   }\n \n   private _visitTextWithInterpolation(\n-      text: string, sourceSpan: ParseSourceSpan, context: I18nMessageVisitorContext): i18n.Node {\n+      text: string, sourceSpan: ParseSourceSpan, context: I18nMessageVisitorContext,\n+      previousI18n: i18n.I18nMeta|undefined): i18n.Node {\n     const splitInterpolation = this._expressionParser.splitInterpolation(\n         text, sourceSpan.start.toString(), this._interpolationConfig);\n \n@@ -197,10 +199,48 @@ class _I18nVisitor implements html.Visitor {\n           getOffsetSourceSpan(sourceSpan, splitInterpolation.stringSpans[lastStringIdx]);\n       nodes.push(new i18n.Text(splitInterpolation.strings[lastStringIdx], stringSpan));\n     }\n+\n+    if (previousI18n instanceof i18n.Message) {\n+      // The `previousI18n` is an i18n `Message`, so we are processing an `Attribute` with i18n\n+      // metadata. The `Message` should consist only of a single `Container` that contains the\n+      // parts (`Text` and `Placeholder`) to process.\n+      assertSingleContainerMessage(previousI18n);\n+      previousI18n = previousI18n.nodes[0];\n+    }\n+\n+    if (previousI18n instanceof i18n.Container) {\n+      // The `previousI18n` is a `Container`, which means that this is a second i18n extraction pass\n+      // after whitespace has been removed from the AST ndoes.\n+      assertEquivalentNodes(previousI18n.children, nodes);\n+\n+      // Reuse the source-spans from the first pass.\n+      for (let i = 0; i < nodes.length; i++) {\n+        nodes[i].sourceSpan = previousI18n.children[i].sourceSpan;\n+      }\n+    }\n+\n     return container;\n   }\n }\n \n+function assertSingleContainerMessage(message: i18n.Message): void {\n+  const nodes = message.nodes;\n+  if (nodes.length !== 1 || !(nodes[0] instanceof i18n.Container)) {\n+    throw new Error(\n+        'Unexpected previous i18n message - expected it to consist of only a single `Container` node.');\n+  }\n+}\n+\n+function assertEquivalentNodes(previousNodes: i18n.Node[], nodes: i18n.Node[]): void {\n+  if (previousNodes.length !== nodes.length) {\n+    throw new Error('The number of i18n message children changed between first and second pass.');\n+  }\n+  if (previousNodes.some((node, i) => nodes[i].constructor !== node.constructor)) {\n+    throw new Error(\n+        'The types of the i18n message children changed between first and second pass.');\n+  }\n+}\n+\n function getOffsetSourceSpan(\n     sourceSpan: ParseSourceSpan, {start, end}: {start: number, end: number}): ParseSourceSpan {\n   return new ParseSourceSpan(sourceSpan.fullStart.moveBy(start), sourceSpan.fullStart.moveBy(end));"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 132,
        "deletions": 3
    }
}