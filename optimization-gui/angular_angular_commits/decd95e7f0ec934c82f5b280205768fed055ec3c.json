{
    "author": "petebacondarwin",
    "message": "fix(compiler-cli): ensure source-maps can handle webpack:// protocol (#32912)\n\nWebpack and other build tools sometimes inline the contents of the\nsource files in their generated source-maps, and at the same time\nchange the paths to be prefixed with a protocol, such as `webpack://`.\n\nThis can confuse tools that need to read these paths, so now it is\npossible to provide a mapping to where these files originated.\n\nPR Close #32912",
    "sha": "decd95e7f0ec934c82f5b280205768fed055ec3c",
    "files": [
        {
            "sha": "ec1b64c1f4db4df6dc158d6bd2e2a49ee8db071b",
            "filename": "packages/compiler-cli/ngcc/src/rendering/source_maps.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/decd95e7f0ec934c82f5b280205768fed055ec3c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fsource_maps.ts",
            "raw_url": "https://github.com/angular/angular/raw/decd95e7f0ec934c82f5b280205768fed055ec3c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fsource_maps.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Frendering%2Fsource_maps.ts?ref=decd95e7f0ec934c82f5b280205768fed055ec3c",
            "patch": "@@ -35,7 +35,7 @@ export function renderSourceAndMap(\n       {file: generatedPath, source: generatedPath, includeContent: true});\n \n   try {\n-    const loader = new SourceFileLoader(fs, logger);\n+    const loader = new SourceFileLoader(fs, logger, {});\n     const generatedFile = loader.loadSourceFile(\n         generatedPath, generatedContent, {map: generatedMap, mapPath: generatedMapPath});\n "
        },
        {
            "sha": "f51e903b92175e73e16ca12a3901d73927160f4b",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file_loader.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 3,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/decd95e7f0ec934c82f5b280205768fed055ec3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "raw_url": "https://github.com/angular/angular/raw/decd95e7f0ec934c82f5b280205768fed055ec3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file_loader.ts?ref=decd95e7f0ec934c82f5b280205768fed055ec3c",
            "patch": "@@ -13,6 +13,8 @@ import {Logger} from '../../logging';\n import {RawSourceMap} from './raw_source_map';\n import {SourceFile} from './source_file';\n \n+const SCHEME_MATCHER = /^([a-z][a-z0-9.-]*):\\/\\//i;\n+\n /**\n  * This class can be used to load a source file, its associated source map and any upstream sources.\n  *\n@@ -25,7 +27,10 @@ import {SourceFile} from './source_file';\n export class SourceFileLoader {\n   private currentPaths: AbsoluteFsPath[] = [];\n \n-  constructor(private fs: FileSystem, private logger: Logger) {}\n+  constructor(\n+      private fs: FileSystem, private logger: Logger,\n+      /** A map of URL schemes to base paths. The scheme name should be lowercase. */\n+      private schemeMap: Record<string, AbsoluteFsPath>) {}\n \n   /**\n    * Load a source file, compute its source map, and recursively load any referenced source files.\n@@ -128,9 +133,10 @@ export class SourceFileLoader {\n    * source file and its associated source map.\n    */\n   private processSources(basePath: AbsoluteFsPath, map: RawSourceMap): (SourceFile|null)[] {\n-    const sourceRoot = this.fs.resolve(this.fs.dirname(basePath), map.sourceRoot || '');\n+    const sourceRoot = this.fs.resolve(\n+        this.fs.dirname(basePath), this.replaceSchemeWithPath(map.sourceRoot || ''));\n     return map.sources.map((source, index) => {\n-      const path = this.fs.resolve(sourceRoot, source);\n+      const path = this.fs.resolve(sourceRoot, this.replaceSchemeWithPath(source));\n       const content = map.sourcesContent && map.sourcesContent[index] || null;\n       return this.loadSourceFile(path, content, null);\n     });\n@@ -168,6 +174,19 @@ export class SourceFileLoader {\n     }\n     this.currentPaths.push(path);\n   }\n+\n+  /**\n+   * Replace any matched URL schemes with their corresponding path held in the schemeMap.\n+   *\n+   * Some build tools replace real file paths with scheme prefixed paths - e.g. `webpack://`.\n+   * We use the `schemeMap` passed to this class to convert such paths to \"real\" file paths.\n+   * In some cases, this is not possible, since the file was actually synthesized by the build tool.\n+   * But the end result is better than prefixing the sourceRoot in front of the scheme.\n+   */\n+  private replaceSchemeWithPath(path: string): string {\n+    return path.replace(\n+        SCHEME_MATCHER, (_: string, scheme: string) => this.schemeMap[scheme.toLowerCase()] || '');\n+  }\n }\n \n /** A small helper structure that is returned from `loadSourceMap()`. */"
        },
        {
            "sha": "72a9201e3270d1bc3d68de797127778f5d8b4a99",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/test/source_file_loader_spec.ts",
            "status": "modified",
            "additions": 54,
            "deletions": 1,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/decd95e7f0ec934c82f5b280205768fed055ec3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_loader_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/decd95e7f0ec934c82f5b280205768fed055ec3c/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_loader_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_loader_spec.ts?ref=decd95e7f0ec934c82f5b280205768fed055ec3c",
            "patch": "@@ -23,7 +23,7 @@ runInEachFileSystem(() => {\n       fs = getFileSystem();\n       logger = new MockLogger();\n       _ = absoluteFrom;\n-      registry = new SourceFileLoader(fs, logger);\n+      registry = new SourceFileLoader(fs, logger, {webpack: _('/foo')});\n     });\n \n     describe('loadSourceFile', () => {\n@@ -279,6 +279,59 @@ runInEachFileSystem(() => {\n \n       expect(() => registry.loadSourceFile(aPath)).not.toThrow();\n     });\n+\n+    for (const {scheme, mappedPath} of\n+             [{scheme: 'WEBPACK://', mappedPath: '/foo/src/index.ts'},\n+              {scheme: 'webpack://', mappedPath: '/foo/src/index.ts'},\n+              {scheme: 'missing://', mappedPath: '/src/index.ts'},\n+    ]) {\n+      it(`should handle source paths that are protocol mapped [scheme:\"${scheme}\"]`, () => {\n+        fs.ensureDir(_('/foo/src'));\n+\n+        const indexSourceMap = createRawSourceMap({\n+          file: 'index.js',\n+          sources: [`${scheme}/src/index.ts`],\n+          'sourcesContent': ['original content']\n+        });\n+        fs.writeFile(_('/foo/src/index.js.map'), JSON.stringify(indexSourceMap));\n+        const sourceFile = registry.loadSourceFile(_('/foo/src/index.js'), 'generated content');\n+        if (sourceFile === null) {\n+          return fail('Expected source file to be defined');\n+        }\n+        const originalSource = sourceFile.sources[0];\n+        if (originalSource === null) {\n+          return fail('Expected source file to be defined');\n+        }\n+        expect(originalSource.contents).toEqual('original content');\n+        expect(originalSource.sourcePath).toEqual(_(mappedPath));\n+        expect(originalSource.rawMap).toEqual(null);\n+        expect(originalSource.sources).toEqual([]);\n+      });\n+\n+      it(`should handle source roots that are protocol mapped [scheme:\"${scheme}\"]`, () => {\n+        fs.ensureDir(_('/foo/src'));\n+\n+        const indexSourceMap = createRawSourceMap({\n+          file: 'index.js',\n+          sources: ['index.ts'],\n+          'sourcesContent': ['original content'],\n+          sourceRoot: `${scheme}/src`,\n+        });\n+        fs.writeFile(_('/foo/src/index.js.map'), JSON.stringify(indexSourceMap));\n+        const sourceFile = registry.loadSourceFile(_('/foo/src/index.js'), 'generated content');\n+        if (sourceFile === null) {\n+          return fail('Expected source file to be defined');\n+        }\n+        const originalSource = sourceFile.sources[0];\n+        if (originalSource === null) {\n+          return fail('Expected source file to be defined');\n+        }\n+        expect(originalSource.contents).toEqual('original content');\n+        expect(originalSource.sourcePath).toEqual(_(mappedPath));\n+        expect(originalSource.rawMap).toEqual(null);\n+        expect(originalSource.sources).toEqual([]);\n+      });\n+    }\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 82,
        "additions": 77,
        "deletions": 5
    }
}