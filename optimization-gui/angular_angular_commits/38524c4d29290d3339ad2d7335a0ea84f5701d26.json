{
    "author": "arturovt",
    "message": "fix(common): cleanup location change listeners when the root view is removed (#40867)\n\nIn the new behavior Angular cleanups `popstate` and `hashchange` event listeners\nwhen the root view gets destroyed, thus event handlers are not added twice\nwhen the application is bootstrapped again.\n\nBREAKING CHANGE:\n\nMethods of the `PlatformLocation` class, namely `onPopState` and `onHashChange`,\nused to return `void`. Now those methods return functions that can be called\nto remove event handlers.\n\nPR Close #31546\n\nPR Close #40867",
    "sha": "38524c4d29290d3339ad2d7335a0ea84f5701d26",
    "files": [
        {
            "sha": "3226b869f00bf8ed221bbdbfe36e5e1e111ac534",
            "filename": "goldens/public-api/common/common.d.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/goldens%2Fpublic-api%2Fcommon%2Fcommon.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/goldens%2Fpublic-api%2Fcommon%2Fcommon.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcommon%2Fcommon.d.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -96,11 +96,12 @@ export declare function getLocaleWeekEndRange(locale: string): [WeekDay, WeekDay\n \n export declare function getNumberOfCurrencyDigits(code: string): number;\n \n-export declare class HashLocationStrategy extends LocationStrategy {\n+export declare class HashLocationStrategy extends LocationStrategy implements OnDestroy {\n     constructor(_platformLocation: PlatformLocation, _baseHref?: string);\n     back(): void;\n     forward(): void;\n     getBaseHref(): string;\n+    ngOnDestroy(): void;\n     onPopState(fn: LocationChangeListener): void;\n     path(includeHash?: boolean): string;\n     prepareExternalUrl(internal: string): string;\n@@ -324,11 +325,12 @@ export declare enum NumberSymbol {\n     CurrencyGroup = 13\n }\n \n-export declare class PathLocationStrategy extends LocationStrategy {\n+export declare class PathLocationStrategy extends LocationStrategy implements OnDestroy {\n     constructor(_platformLocation: PlatformLocation, href?: string);\n     back(): void;\n     forward(): void;\n     getBaseHref(): string;\n+    ngOnDestroy(): void;\n     onPopState(fn: LocationChangeListener): void;\n     path(includeHash?: boolean): string;\n     prepareExternalUrl(internal: string): string;\n@@ -355,8 +357,8 @@ export declare abstract class PlatformLocation {\n     abstract forward(): void;\n     abstract getBaseHrefFromDOM(): string;\n     abstract getState(): unknown;\n-    abstract onHashChange(fn: LocationChangeListener): void;\n-    abstract onPopState(fn: LocationChangeListener): void;\n+    abstract onHashChange(fn: LocationChangeListener): VoidFunction;\n+    abstract onPopState(fn: LocationChangeListener): VoidFunction;\n     abstract pushState(state: any, title: string, url: string): void;\n     abstract replaceState(state: any, title: string, url: string): void;\n }"
        },
        {
            "sha": "b4b4b8fca8192b85a08595e6981379e71e788b7a",
            "filename": "goldens/public-api/common/testing/testing.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/goldens%2Fpublic-api%2Fcommon%2Ftesting%2Ftesting.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/goldens%2Fpublic-api%2Fcommon%2Ftesting%2Ftesting.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcommon%2Ftesting%2Ftesting.d.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -33,8 +33,8 @@ export declare class MockPlatformLocation implements PlatformLocation {\n     forward(): void;\n     getBaseHrefFromDOM(): string;\n     getState(): unknown;\n-    onHashChange(fn: LocationChangeListener): void;\n-    onPopState(fn: LocationChangeListener): void;\n+    onHashChange(fn: LocationChangeListener): VoidFunction;\n+    onPopState(fn: LocationChangeListener): VoidFunction;\n     pushState(state: any, title: string, newUrl: string): void;\n     replaceState(state: any, title: string, newUrl: string): void;\n }"
        },
        {
            "sha": "fef0112d62b3c813ec1f7d00faaffc0dabcc163e",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -26,4 +26,4 @@\n       }\n     }\n   }\n-}\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "b46ff1ccfaf25ee57014223da1505e9d6f16c67d",
            "filename": "packages/common/src/location/hash_location_strategy.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Fsrc%2Flocation%2Fhash_location_strategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Fsrc%2Flocation%2Fhash_location_strategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Flocation%2Fhash_location_strategy.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -6,7 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Inject, Injectable, Optional} from '@angular/core';\n+import {Inject, Injectable, OnDestroy, Optional} from '@angular/core';\n+\n import {APP_BASE_HREF, LocationStrategy} from './location_strategy';\n import {LocationChangeListener, PlatformLocation} from './platform_location';\n import {joinWithSlash, normalizeQueryParams} from './util';\n@@ -32,8 +33,10 @@ import {joinWithSlash, normalizeQueryParams} from './util';\n  * @publicApi\n  */\n @Injectable()\n-export class HashLocationStrategy extends LocationStrategy {\n+export class HashLocationStrategy extends LocationStrategy implements OnDestroy {\n   private _baseHref: string = '';\n+  private _removeListenerFns: (() => void)[] = [];\n+\n   constructor(\n       private _platformLocation: PlatformLocation,\n       @Optional() @Inject(APP_BASE_HREF) _baseHref?: string) {\n@@ -43,9 +46,15 @@ export class HashLocationStrategy extends LocationStrategy {\n     }\n   }\n \n+  ngOnDestroy(): void {\n+    while (this._removeListenerFns.length) {\n+      this._removeListenerFns.pop()!();\n+    }\n+  }\n+\n   onPopState(fn: LocationChangeListener): void {\n-    this._platformLocation.onPopState(fn);\n-    this._platformLocation.onHashChange(fn);\n+    this._removeListenerFns.push(\n+        this._platformLocation.onPopState(fn), this._platformLocation.onHashChange(fn));\n   }\n \n   getBaseHref(): string {"
        },
        {
            "sha": "731f5c60914f890b92762d48cf3238e05b1f0eac",
            "filename": "packages/common/src/location/location_strategy.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Fsrc%2Flocation%2Flocation_strategy.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Fsrc%2Flocation%2Flocation_strategy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Flocation%2Flocation_strategy.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {Inject, Injectable, InjectionToken, Optional, ɵɵinject} from '@angular/core';\n+import {Inject, Injectable, InjectionToken, OnDestroy, Optional, ɵɵinject} from '@angular/core';\n import {DOCUMENT} from '../dom_tokens';\n import {LocationChangeListener, PlatformLocation} from './platform_location';\n import {joinWithSlash, normalizeQueryParams} from './util';\n@@ -105,8 +105,9 @@ export const APP_BASE_HREF = new InjectionToken<string>('appBaseHref');\n  * @publicApi\n  */\n @Injectable()\n-export class PathLocationStrategy extends LocationStrategy {\n+export class PathLocationStrategy extends LocationStrategy implements OnDestroy {\n   private _baseHref: string;\n+  private _removeListenerFns: (() => void)[] = [];\n \n   constructor(\n       private _platformLocation: PlatformLocation,\n@@ -125,9 +126,15 @@ export class PathLocationStrategy extends LocationStrategy {\n     this._baseHref = href;\n   }\n \n+  ngOnDestroy(): void {\n+    while (this._removeListenerFns.length) {\n+      this._removeListenerFns.pop()!();\n+    }\n+  }\n+\n   onPopState(fn: LocationChangeListener): void {\n-    this._platformLocation.onPopState(fn);\n-    this._platformLocation.onHashChange(fn);\n+    this._removeListenerFns.push(\n+        this._platformLocation.onPopState(fn), this._platformLocation.onHashChange(fn));\n   }\n \n   getBaseHref(): string {"
        },
        {
            "sha": "06c1b81cf97c60c17b32bdf432425ccd13adaea8",
            "filename": "packages/common/src/location/platform_location.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Fsrc%2Flocation%2Fplatform_location.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Fsrc%2Flocation%2Fplatform_location.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Fsrc%2Flocation%2Fplatform_location.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -40,8 +40,14 @@ import {DOCUMENT} from '../dom_tokens';\n export abstract class PlatformLocation {\n   abstract getBaseHrefFromDOM(): string;\n   abstract getState(): unknown;\n-  abstract onPopState(fn: LocationChangeListener): void;\n-  abstract onHashChange(fn: LocationChangeListener): void;\n+  /**\n+   * Returns a function that, when executed, removes the `popstate` event handler.\n+   */\n+  abstract onPopState(fn: LocationChangeListener): VoidFunction;\n+  /**\n+   * Returns a function that, when executed, removes the `hashchange` event handler.\n+   */\n+  abstract onHashChange(fn: LocationChangeListener): VoidFunction;\n \n   abstract get href(): string;\n   abstract get protocol(): string;\n@@ -122,12 +128,16 @@ export class BrowserPlatformLocation extends PlatformLocation {\n     return getDOM().getBaseHref(this._doc)!;\n   }\n \n-  onPopState(fn: LocationChangeListener): void {\n-    getDOM().getGlobalEventTarget(this._doc, 'window').addEventListener('popstate', fn, false);\n+  onPopState(fn: LocationChangeListener): VoidFunction {\n+    const window = getDOM().getGlobalEventTarget(this._doc, 'window');\n+    window.addEventListener('popstate', fn, false);\n+    return () => window.removeEventListener('popstate', fn);\n   }\n \n-  onHashChange(fn: LocationChangeListener): void {\n-    getDOM().getGlobalEventTarget(this._doc, 'window').addEventListener('hashchange', fn, false);\n+  onHashChange(fn: LocationChangeListener): VoidFunction {\n+    const window = getDOM().getGlobalEventTarget(this._doc, 'window');\n+    window.addEventListener('hashchange', fn, false);\n+    return () => window.removeEventListener('hashchange', fn);\n   }\n \n   get href(): string {"
        },
        {
            "sha": "e4f3f336077495e425c6fda876054f580b690664",
            "filename": "packages/common/testing/src/mock_platform_location.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Ftesting%2Fsrc%2Fmock_platform_location.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fcommon%2Ftesting%2Fsrc%2Fmock_platform_location.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Ftesting%2Fsrc%2Fmock_platform_location.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -153,13 +153,15 @@ export class MockPlatformLocation implements PlatformLocation {\n     return this.baseHref;\n   }\n \n-  onPopState(fn: LocationChangeListener): void {\n+  onPopState(fn: LocationChangeListener): VoidFunction {\n     // No-op: a state stack is not implemented, so\n     // no events will ever come.\n+    return () => {};\n   }\n \n-  onHashChange(fn: LocationChangeListener): void {\n-    this.hashUpdate.subscribe(fn);\n+  onHashChange(fn: LocationChangeListener): VoidFunction {\n+    const subscription = this.hashUpdate.subscribe(fn);\n+    return () => subscription.unsubscribe();\n   }\n \n   get href(): string {"
        },
        {
            "sha": "fe404c2412b65ab82e71c87dc36995619574b7b6",
            "filename": "packages/platform-server/src/location.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fplatform-server%2Fsrc%2Flocation.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Fplatform-server%2Fsrc%2Flocation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Flocation.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -70,13 +70,15 @@ export class ServerPlatformLocation implements PlatformLocation {\n     return getDOM().getBaseHref(this._doc)!;\n   }\n \n-  onPopState(fn: LocationChangeListener): void {\n+  onPopState(fn: LocationChangeListener): VoidFunction {\n     // No-op: a state stack is not implemented, so\n     // no events will ever come.\n+    return () => {};\n   }\n \n-  onHashChange(fn: LocationChangeListener): void {\n-    this._hashUpdate.subscribe(fn);\n+  onHashChange(fn: LocationChangeListener): VoidFunction {\n+    const subscription = this._hashUpdate.subscribe(fn);\n+    return () => subscription.unsubscribe();\n   }\n \n   get url(): string {"
        },
        {
            "sha": "e3b9a63915e64df9d99d8c402d5b3ad423572137",
            "filename": "packages/router/test/bootstrap.spec.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 5,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Frouter%2Ftest%2Fbootstrap.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/38524c4d29290d3339ad2d7335a0ea84f5701d26/packages%2Frouter%2Ftest%2Fbootstrap.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fbootstrap.spec.ts?ref=38524c4d29290d3339ad2d7335a0ea84f5701d26",
            "patch": "@@ -6,13 +6,12 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {APP_BASE_HREF, DOCUMENT, Location, ɵgetDOM as getDOM} from '@angular/common';\n+import {APP_BASE_HREF, DOCUMENT, ɵgetDOM as getDOM} from '@angular/common';\n import {ApplicationRef, Component, CUSTOM_ELEMENTS_SCHEMA, destroyPlatform, NgModule} from '@angular/core';\n import {inject} from '@angular/core/testing';\n import {BrowserModule} from '@angular/platform-browser';\n import {platformBrowserDynamic} from '@angular/platform-browser-dynamic';\n import {NavigationEnd, Resolve, Router, RouterModule} from '@angular/router';\n-import {filter, first} from 'rxjs/operators';\n \n describe('bootstrap', () => {\n   if (isNode) return;\n@@ -369,7 +368,30 @@ describe('bootstrap', () => {\n     done();\n   });\n \n-  function waitForNavigationToComplete(router: Router): Promise<any> {\n-    return router.events.pipe(filter((e: any) => e instanceof NavigationEnd), first()).toPromise();\n-  }\n+  it('should cleanup \"popstate\" and \"hashchange\" listeners', async () => {\n+    @NgModule({\n+      imports: [BrowserModule, RouterModule.forRoot([])],\n+      declarations: [RootCmp],\n+      bootstrap: [RootCmp],\n+      providers: testProviders,\n+    })\n+    class TestModule {\n+    }\n+\n+    spyOn(window, 'addEventListener').and.callThrough();\n+    spyOn(window, 'removeEventListener').and.callThrough();\n+\n+    const ngModuleRef = await platformBrowserDynamic().bootstrapModule(TestModule);\n+    ngModuleRef.destroy();\n+\n+    expect(window.addEventListener).toHaveBeenCalledTimes(2);\n+\n+    expect(window.addEventListener)\n+        .toHaveBeenCalledWith('popstate', jasmine.any(Function), jasmine.any(Boolean));\n+    expect(window.addEventListener)\n+        .toHaveBeenCalledWith('hashchange', jasmine.any(Function), jasmine.any(Boolean));\n+\n+    expect(window.removeEventListener).toHaveBeenCalledWith('popstate', jasmine.any(Function));\n+    expect(window.removeEventListener).toHaveBeenCalledWith('hashchange', jasmine.any(Function));\n+  });\n });"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 86,
        "deletions": 32
    }
}