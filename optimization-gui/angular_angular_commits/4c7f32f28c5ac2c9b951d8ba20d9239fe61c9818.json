{
    "author": "IgorMinar",
    "message": "fix(docs-infra): fix deploy-to-firebase.sh for master and v10.0.x branches (#37762)\n\nThe deployment to aio is currently failing because #37721 introduced\n\"project\" entry into the firebase.json which means that we now need to\nselect the deployment target before deploying to firebase.\n\nThis change fixes the issue and refactors the file to be easier to read.\n\nI also added extra echo statements so that the CI logs are easier to\nread in case we need to troubleshoot future issues.\n\nPR Close #37762",
    "sha": "4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818",
    "files": [
        {
            "sha": "f19c97e60e2e6a1dd396e37cf94d26bdce45f56d",
            "filename": "aio/scripts/deploy-to-firebase.sh",
            "status": "modified",
            "additions": 24,
            "deletions": 17,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818/aio%2Fscripts%2Fdeploy-to-firebase.sh",
            "raw_url": "https://github.com/angular/angular/raw/4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818/aio%2Fscripts%2Fdeploy-to-firebase.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.sh?ref=4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818",
            "patch": "@@ -64,16 +64,27 @@ fi\n case $deployEnv in\n   next)\n     readonly projectId=aio-staging\n+    readonly siteId=$projectId\n     readonly deployedUrl=https://next.angular.io/\n     readonly firebaseToken=$CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN\n     ;;\n   stable)\n     readonly projectId=angular-io\n+    readonly siteId=$projectId\n     readonly deployedUrl=https://angular.io/\n     readonly firebaseToken=$CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN\n     ;;\n   archive)\n-    readonly projectId=v${majorVersion}-angular-io\n+    # Special case v9-angular-io because its piloting the firebase hosting \"multisites\" setup\n+    # See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n+    if [[ \"$majorVersion\" == \"9\" ]]; then\n+      readonly projectId=aio-staging\n+      readonly siteId=v9-angular-io\n+    else\n+      readonly projectId=v${majorVersion}-angular-io\n+      readonly siteId=$projectId\n+    fi\n+\n     readonly deployedUrl=https://v${majorVersion}.angular.io/\n     readonly firebaseToken=$CI_SECRET_AIO_DEPLOY_FIREBASE_TOKEN\n     ;;\n@@ -82,6 +93,7 @@ esac\n echo \"Git branch        : $CI_BRANCH\"\n echo \"Build/deploy mode : $deployEnv\"\n echo \"Firebase project  : $projectId\"\n+echo \"Firebase site     : $siteId\"\n echo \"Deployment URL    : $deployedUrl\"\n \n if [[ ${1:-} == \"--dry-run\" ]]; then\n@@ -92,34 +104,29 @@ fi\n (\n   cd \"`dirname $0`/..\"\n \n-  # Build the app\n+  echo \"\\n\\n\\n==== Build the aio app ====\\n\"\n   yarn build --configuration=$deployEnv --progress=false\n \n-  # Include any mode-specific files\n+\n+  echo \"\\n\\n\\n==== Add any mode-specific files into the aio distribution ====\\n\"\n   cp -rf src/extra-files/$deployEnv/. dist/\n \n-  # Set deployedUrl as parameter in the opensearch description\n+\n+  echo \"\\n\\n\\n==== Update opensearch descriptor for aio with the deployedUrl ====\\n\"\n   # deployedUrl must end with /\n   yarn set-opensearch-url $deployedUrl\n \n-  # Check payload size\n+  echo \"\\n\\n\\n==== Check payload size and upload the numbers to firebase db ====\\n\"\n   yarn payload-size\n \n \n-  # Deploy to Firebase\n+  echo \"\\n\\n\\n==== Deploy aio to firebase hosting ====\\n\"\n \n-  # Special case v9-angular-io because its piloting the firebase hosting \"multisites\" setup\n-  # See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n-  if [[ \"$projectId\" == \"v9-angular-io\" ]]; then\n-    yarn firebase use aio-staging --token \"$firebaseToken\"\n-    yarn firebase target:apply hosting aio $projectId --token \"$firebaseToken\"\n-    yarn firebase deploy --only hosting:aio --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n-  else\n-    yarn firebase use \"$projectId\" --token \"$firebaseToken\"\n-    yarn firebase deploy --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n-  fi\n+  yarn firebase use \"${projectId}\" --token \"$firebaseToken\"\n+  yarn firebase target:apply hosting aio $siteId --token \"$firebaseToken\"\n+  yarn firebase deploy --only hosting:aio --message \"Commit: $CI_COMMIT\" --non-interactive --token \"$firebaseToken\"\n \n \n-  # Run PWA-score tests\n+  echo \"\\n\\n\\n==== Run PWA-score tests ====\\n\"\n   yarn test-pwa-score \"$deployedUrl\" \"$CI_AIO_MIN_PWA_SCORE\"\n )"
        },
        {
            "sha": "8f4efebc72340215b57c6651ff9b715fab6263b0",
            "filename": "aio/scripts/deploy-to-firebase.test.sh",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818/aio%2Fscripts%2Fdeploy-to-firebase.test.sh",
            "raw_url": "https://github.com/angular/angular/raw/4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818/aio%2Fscripts%2Fdeploy-to-firebase.test.sh",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.test.sh?ref=4c7f32f28c5ac2c9b951d8ba20d9239fe61c9818",
            "patch": "@@ -68,6 +68,7 @@ function check {\n   expected=\"Git branch        : master\n Build/deploy mode : next\n Firebase project  : aio-staging\n+Firebase site     : aio-staging\n Deployment URL    : https://next.angular.io/\"\n   check \"$actual\" \"$expected\"\n )\n@@ -103,6 +104,7 @@ Deployment URL    : https://next.angular.io/\"\n   expected=\"Git branch        : 4.3.x\n Build/deploy mode : stable\n Firebase project  : angular-io\n+Firebase site     : angular-io\n Deployment URL    : https://angular.io/\"\n   check \"$actual\" \"$expected\"\n )\n@@ -139,6 +141,7 @@ Deployment URL    : https://angular.io/\"\n   expected=\"Git branch        : 2.4.x\n Build/deploy mode : archive\n Firebase project  : v2-angular-io\n+Firebase site     : v2-angular-io\n Deployment URL    : https://v2.angular.io/\"\n   check \"$actual\" \"$expected\"\n )\n@@ -158,7 +161,8 @@ Deployment URL    : https://v2.angular.io/\"\n   )\n   expected=\"Git branch        : 9.1.x\n Build/deploy mode : archive\n-Firebase project  : v9-angular-io\n+Firebase project  : aio-staging\n+Firebase site     : v9-angular-io\n Deployment URL    : https://v9.angular.io/\"\n   # TODO: This test incorrectly expects the Firebase project to be v9-angular-io.\n   #       v9-angular-io is a \"multisites\" project currently within the aio-staging project"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 29,
        "deletions": 18
    }
}