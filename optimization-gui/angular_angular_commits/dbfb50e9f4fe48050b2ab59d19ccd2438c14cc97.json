{
    "author": "atscott",
    "message": "fix(router): ensure routerLinkActive updates when associated routerLinks change (#38511)\n\nThis commit introduces a new subscription in the `routerLinkActive` directive which triggers an update\nwhen any of its associated routerLinks have changes. `RouterLinkActive` not only needs to know when\nlinks are added or removed, but it also needs to know about if a link it already knows about\nchanges in some way.\n\nQuick note that `from...mergeAll` is used instead of just a simple\n`merge` (or `scheduled...mergeAll`) to avoid introducing new rxjs\noperators in order to keep bundle size down.\n\nFixes #18469\n\nPR Close #38511",
    "sha": "dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97",
    "files": [
        {
            "sha": "5d911194bdd1dcaac826b99bd07d5933c313f04b",
            "filename": "goldens/public-api/router/router.d.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts?ref=dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97",
            "patch": "@@ -378,7 +378,7 @@ export declare class RouterEvent {\n     url: string);\n }\n \n-export declare class RouterLink {\n+export declare class RouterLink implements OnChanges {\n     fragment: string;\n     preserveFragment: boolean;\n     /** @deprecated */ set preserveQueryParams(value: boolean);\n@@ -394,6 +394,7 @@ export declare class RouterLink {\n     };\n     get urlTree(): UrlTree;\n     constructor(router: Router, route: ActivatedRoute, tabIndex: string, renderer: Renderer2, el: ElementRef);\n+    ngOnChanges(changes: SimpleChanges): void;\n     onClick(): boolean;\n }\n \n@@ -429,7 +430,7 @@ export declare class RouterLinkWithHref implements OnChanges, OnDestroy {\n     target: string;\n     get urlTree(): UrlTree;\n     constructor(router: Router, route: ActivatedRoute, locationStrategy: LocationStrategy);\n-    ngOnChanges(changes: {}): any;\n+    ngOnChanges(changes: SimpleChanges): any;\n     ngOnDestroy(): any;\n     onClick(button: number, ctrlKey: boolean, metaKey: boolean, shiftKey: boolean): boolean;\n }"
        },
        {
            "sha": "8d8a2da5cb865d04e3258745e9f793b29347b6a0",
            "filename": "packages/router/src/directives/router_link.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link.ts?ref=dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n import {LocationStrategy} from '@angular/common';\n-import {Attribute, Directive, ElementRef, HostBinding, HostListener, Input, isDevMode, OnChanges, OnDestroy, Renderer2} from '@angular/core';\n-import {Subscription} from 'rxjs';\n+import {Attribute, Directive, ElementRef, HostBinding, HostListener, Input, isDevMode, OnChanges, OnDestroy, Renderer2, SimpleChanges} from '@angular/core';\n+import {Subject, Subscription} from 'rxjs';\n \n import {QueryParamsHandling} from '../config';\n import {Event, NavigationEnd} from '../events';\n@@ -115,7 +115,7 @@ import {UrlTree} from '../url_tree';\n  * @publicApi\n  */\n @Directive({selector: ':not(a):not(area)[routerLink]'})\n-export class RouterLink {\n+export class RouterLink implements OnChanges {\n   /**\n    * Passed to {@link Router#createUrlTree Router#createUrlTree} as part of the `NavigationExtras`.\n    * @see {@link NavigationExtras#queryParams NavigationExtras#queryParams}\n@@ -167,6 +167,9 @@ export class RouterLink {\n   private commands: any[] = [];\n   private preserve!: boolean;\n \n+  /** @internal */\n+  onChanges = new Subject<RouterLink>();\n+\n   constructor(\n       private router: Router, private route: ActivatedRoute,\n       @Attribute('tabindex') tabIndex: string, renderer: Renderer2, el: ElementRef) {\n@@ -175,6 +178,13 @@ export class RouterLink {\n     }\n   }\n \n+  /** @nodoc */\n+  ngOnChanges(changes: SimpleChanges) {\n+    // This is subscribed to by `RouterLinkActive` so that it knows to update when there are changes\n+    // to the RouterLinks it's tracking.\n+    this.onChanges.next(this);\n+  }\n+\n   /**\n    * Commands to pass to {@link Router#createUrlTree Router#createUrlTree}.\n    *   - **array**: commands to pass to {@link Router#createUrlTree Router#createUrlTree}.\n@@ -298,6 +308,9 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n   // TODO(issue/24571): remove '!'.\n   @HostBinding() href!: string;\n \n+  /** @internal */\n+  onChanges = new Subject<RouterLinkWithHref>();\n+\n   constructor(\n       private router: Router, private route: ActivatedRoute,\n       private locationStrategy: LocationStrategy) {\n@@ -336,8 +349,9 @@ export class RouterLinkWithHref implements OnChanges, OnDestroy {\n   }\n \n   /** @nodoc */\n-  ngOnChanges(changes: {}): any {\n+  ngOnChanges(changes: SimpleChanges): any {\n     this.updateTargetUrlAndHref();\n+    this.onChanges.next(this);\n   }\n   /** @nodoc */\n   ngOnDestroy(): any {"
        },
        {
            "sha": "4b1f69b47c365ef918b5cb17b714002c9d4a1476",
            "filename": "packages/router/src/directives/router_link_active.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 9,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts?ref=dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97",
            "patch": "@@ -7,7 +7,8 @@\n  */\n \n import {AfterContentInit, ChangeDetectorRef, ContentChildren, Directive, ElementRef, Input, OnChanges, OnDestroy, Optional, QueryList, Renderer2, SimpleChanges} from '@angular/core';\n-import {Subscription} from 'rxjs';\n+import {from, of, Subscription} from 'rxjs';\n+import {mergeAll} from 'rxjs/operators';\n \n import {Event, NavigationEnd} from '../events';\n import {Router} from '../router';\n@@ -79,14 +80,13 @@ import {RouterLink, RouterLinkWithHref} from './router_link';\n   exportAs: 'routerLinkActive',\n })\n export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit {\n-  // TODO(issue/24571): remove '!'.\n   @ContentChildren(RouterLink, {descendants: true}) links!: QueryList<RouterLink>;\n-  // TODO(issue/24571): remove '!'.\n   @ContentChildren(RouterLinkWithHref, {descendants: true})\n   linksWithHrefs!: QueryList<RouterLinkWithHref>;\n \n   private classes: string[] = [];\n-  private subscription: Subscription;\n+  private routerEventsSubscription: Subscription;\n+  private linkInputChangesSubscription?: Subscription;\n   public readonly isActive: boolean = false;\n \n   @Input() routerLinkActiveOptions: {exact: boolean} = {exact: false};\n@@ -95,7 +95,7 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n       private router: Router, private element: ElementRef, private renderer: Renderer2,\n       private readonly cdr: ChangeDetectorRef, @Optional() private link?: RouterLink,\n       @Optional() private linkWithHref?: RouterLinkWithHref) {\n-    this.subscription = router.events.subscribe((s: Event) => {\n+    this.routerEventsSubscription = router.events.subscribe((s: Event) => {\n       if (s instanceof NavigationEnd) {\n         this.update();\n       }\n@@ -104,9 +104,26 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n \n   /** @nodoc */\n   ngAfterContentInit(): void {\n-    this.links.changes.subscribe(_ => this.update());\n-    this.linksWithHrefs.changes.subscribe(_ => this.update());\n-    this.update();\n+    // `of(null)` is used to force subscribe body to execute once immediately (like `startWith`).\n+    from([this.links.changes, this.linksWithHrefs.changes, of(null)])\n+        .pipe(mergeAll())\n+        .subscribe(_ => {\n+          this.update();\n+          this.subscribeToEachLinkOnChanges();\n+        });\n+  }\n+\n+  private subscribeToEachLinkOnChanges() {\n+    this.linkInputChangesSubscription?.unsubscribe();\n+    const allLinkChanges =\n+        [...this.links.toArray(), ...this.linksWithHrefs.toArray(), this.link, this.linkWithHref]\n+            .filter((link): link is RouterLink|RouterLinkWithHref => !!link)\n+            .map(link => link.onChanges);\n+    this.linkInputChangesSubscription = from(allLinkChanges).pipe(mergeAll()).subscribe(link => {\n+      if (this.isActive !== this.isLinkActive(this.router)(link)) {\n+        this.update();\n+      }\n+    });\n   }\n \n   @Input()\n@@ -121,7 +138,8 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n   }\n   /** @nodoc */\n   ngOnDestroy(): void {\n-    this.subscription.unsubscribe();\n+    this.routerEventsSubscription.unsubscribe();\n+    this.linkInputChangesSubscription?.unsubscribe();\n   }\n \n   private update(): void {"
        },
        {
            "sha": "52a568b6b15749143c13fe3b4f2791ef7a505e45",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97",
            "patch": "@@ -4344,7 +4344,7 @@ describe('Integration', () => {\n        })));\n   });\n \n-  describe('routerActiveLink', () => {\n+  describe('routerLinkActive', () => {\n     it('should set the class when the link is active (a tag)',\n        fakeAsync(inject([Router, Location], (router: Router, location: Location) => {\n          const fixture = createRoot(router, RootCmp);\n@@ -4494,6 +4494,29 @@ describe('Integration', () => {\n          advance(fixture);\n          expect(paragraph.textContent).toEqual('false');\n        }));\n+\n+    it('should not trigger change detection when active state has not changed', fakeAsync(() => {\n+         @Component({\n+           template: `<div id=\"link\" routerLinkActive=\"active\" [routerLink]=\"link\"></div>`,\n+         })\n+         class LinkComponent {\n+           link = 'notactive';\n+         }\n+\n+         @Component({template: ''})\n+         class SimpleComponent {\n+         }\n+\n+         TestBed.configureTestingModule({\n+           imports: [RouterTestingModule.withRoutes([{path: '', component: SimpleComponent}])],\n+           declarations: [LinkComponent, SimpleComponent]\n+         });\n+\n+         const fixture = createRoot(TestBed.inject(Router), LinkComponent);\n+         fixture.componentInstance.link = 'stillnotactive';\n+         fixture.detectChanges(false /** checkNoChanges */);\n+         expect(TestBed.inject(NgZone).hasPendingMicrotasks).toBe(false);\n+       }));\n   });\n \n   describe('lazy loading', () => {"
        },
        {
            "sha": "9dd5b8ba323b653153d0cc5a405b2bed7969ce3a",
            "filename": "packages/router/test/regression_integration.spec.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts?ref=dbfb50e9f4fe48050b2ab59d19ccd2438c14cc97",
            "patch": "@@ -14,6 +14,54 @@ import {RouterTestingModule} from '@angular/router/testing';\n \n describe('Integration', () => {\n   describe('routerLinkActive', () => {\n+    it('should update when the associated routerLinks change - #18469', fakeAsync(() => {\n+         @Component({\n+           template: `\n+          <a id=\"first-link\" [routerLink]=\"[firstLink]\" routerLinkActive=\"active\">{{firstLink}}</a>\n+          <div id=\"second-link\" routerLinkActive=\"active\">\n+            <a [routerLink]=\"[secondLink]\">{{secondLink}}</a>\n+          </div>\n+           `,\n+         })\n+         class LinkComponent {\n+           firstLink = 'link-a';\n+           secondLink = 'link-b';\n+\n+           changeLinks(): void {\n+             const temp = this.secondLink;\n+             this.secondLink = this.firstLink;\n+             this.firstLink = temp;\n+           }\n+         }\n+\n+         @Component({template: 'simple'})\n+         class SimpleCmp {\n+         }\n+\n+         TestBed.configureTestingModule({\n+           imports: [RouterTestingModule.withRoutes(\n+               [{path: 'link-a', component: SimpleCmp}, {path: 'link-b', component: SimpleCmp}])],\n+           declarations: [LinkComponent, SimpleCmp]\n+         });\n+\n+         const router: Router = TestBed.inject(Router);\n+         const fixture = createRoot(router, LinkComponent);\n+         const firstLink = fixture.debugElement.query(p => p.nativeElement.id === 'first-link');\n+         const secondLink = fixture.debugElement.query(p => p.nativeElement.id === 'second-link');\n+         router.navigateByUrl('/link-a');\n+         advance(fixture);\n+\n+         expect(firstLink.nativeElement.classList).toContain('active');\n+         expect(secondLink.nativeElement.classList).not.toContain('active');\n+\n+         fixture.componentInstance.changeLinks();\n+         fixture.detectChanges();\n+         advance(fixture);\n+\n+         expect(firstLink.nativeElement.classList).not.toContain('active');\n+         expect(secondLink.nativeElement.classList).toContain('active');\n+       }));\n+\n     it('should not cause infinite loops in the change detection - #15825', fakeAsync(() => {\n          @Component({selector: 'simple', template: 'simple'})\n          class SimpleCmp {"
        }
    ],
    "stats": {
        "total": 136,
        "additions": 120,
        "deletions": 16
    }
}