{
    "author": "dimakuba",
    "message": "perf(router): apply prioritizedGuardValue operator to optimize CanLoad guards (#37523)\n\nCanLoad guards are processed in asynchronous manner with the following rules:\n* If all guards return `true`, operator returns `true`;\n* `false` and `UrlTree` values wait for higher priority guards to resolve;\n* Highest priority `false` or `UrlTree` value will be returned.\n\n`prioritizedGuardValue` uses `combineLatest` which in order subscribes to each Observable immediately (not waiting when previous one completes that `concatAll` do). So it makes some advantages in order to run them concurrently. Respectively, a time to resolve all guards will be reduced.\n\nPR Close #37523",
    "sha": "d7dd2959c87d4539e08e3337f22caaf91705e0ba",
    "files": [
        {
            "sha": "6827c0b005cee141a6273e17db5737355305b9dd",
            "filename": "packages/router/src/apply_redirects.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 16,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/d7dd2959c87d4539e08e3337f22caaf91705e0ba/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "raw_url": "https://github.com/angular/angular/raw/d7dd2959c87d4539e08e3337f22caaf91705e0ba/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fapply_redirects.ts?ref=d7dd2959c87d4539e08e3337f22caaf91705e0ba",
            "patch": "@@ -7,11 +7,12 @@\n  */\n \n import {Injector, NgModuleRef} from '@angular/core';\n-import {EmptyError, from, Observable, Observer, of} from 'rxjs';\n-import {catchError, concatAll, every, first, map, mergeMap, tap} from 'rxjs/operators';\n+import {EmptyError, Observable, Observer, of} from 'rxjs';\n+import {catchError, concatAll, first, map, mergeMap, tap} from 'rxjs/operators';\n \n import {LoadedRouterConfig, Route, Routes} from './config';\n import {CanLoadFn} from './interfaces';\n+import {prioritizedGuardValue} from './operators/prioritized_guard_value';\n import {RouterConfigLoader} from './router_config_loader';\n import {defaultUrlMatcher, navigationCancelingError, Params, PRIMARY_OUTLET} from './shared';\n import {UrlSegment, UrlSegmentGroup, UrlSerializer, UrlTree} from './url_tree';\n@@ -321,7 +322,7 @@ class ApplyRedirects {\n     const canLoad = route.canLoad;\n     if (!canLoad || canLoad.length === 0) return of(true);\n \n-    const obs = from(canLoad).pipe(map((injectionToken: any) => {\n+    const canLoadObservables = canLoad.map((injectionToken: any) => {\n       const guard = moduleInjector.get(injectionToken);\n       let guardVal;\n       if (isCanLoad(guard)) {\n@@ -332,20 +333,21 @@ class ApplyRedirects {\n         throw new Error('Invalid CanLoad guard');\n       }\n       return wrapIntoObservable(guardVal);\n-    }));\n-\n-    return obs.pipe(\n-        concatAll(),\n-        tap((result: UrlTree|boolean) => {\n-          if (!isUrlTree(result)) return;\n+    });\n \n-          const error: Error&{url?: UrlTree} =\n-              navigationCancelingError(`Redirecting to \"${this.urlSerializer.serialize(result)}\"`);\n-          error.url = result;\n-          throw error;\n-        }),\n-        every(result => result === true),\n-    );\n+    return of(canLoadObservables)\n+        .pipe(\n+            prioritizedGuardValue(),\n+            tap((result: UrlTree|boolean) => {\n+              if (!isUrlTree(result)) return;\n+\n+              const error: Error&{url?: UrlTree} = navigationCancelingError(\n+                  `Redirecting to \"${this.urlSerializer.serialize(result)}\"`);\n+              error.url = result;\n+              throw error;\n+            }),\n+            map(result => result === true),\n+        );\n   }\n \n   private lineralizeSegments(route: Route, urlTree: UrlTree): Observable<UrlSegment[]> {"
        },
        {
            "sha": "369936ddfd3ec3aeac553612766a403b8eb6a7d8",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 107,
            "deletions": 1,
            "changes": 108,
            "blob_url": "https://github.com/angular/angular/blob/d7dd2959c87d4539e08e3337f22caaf91705e0ba/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d7dd2959c87d4539e08e3337f22caaf91705e0ba/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=d7dd2959c87d4539e08e3337f22caaf91705e0ba",
            "patch": "@@ -14,7 +14,7 @@ import {By} from '@angular/platform-browser/src/dom/debug/by';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {ActivatedRoute, ActivatedRouteSnapshot, ActivationEnd, ActivationStart, CanActivate, CanDeactivate, ChildActivationEnd, ChildActivationStart, DefaultUrlSerializer, DetachedRouteHandle, Event, GuardsCheckEnd, GuardsCheckStart, Navigation, NavigationCancel, NavigationEnd, NavigationError, NavigationStart, ParamMap, Params, PreloadAllModules, PreloadingStrategy, PRIMARY_OUTLET, Resolve, ResolveEnd, ResolveStart, RouteConfigLoadEnd, RouteConfigLoadStart, Router, RouteReuseStrategy, RouterEvent, RouterModule, RouterPreloader, RouterStateSnapshot, RoutesRecognized, RunGuardsAndResolvers, UrlHandlingStrategy, UrlSegmentGroup, UrlSerializer, UrlTree} from '@angular/router';\n import {EMPTY, Observable, Observer, of, Subscription} from 'rxjs';\n-import {filter, first, map, tap} from 'rxjs/operators';\n+import {delay, filter, first, map, mapTo, tap} from 'rxjs/operators';\n \n import {forEach} from '../src/utils/collection';\n import {RouterTestingModule, SpyNgModuleFactoryLoader} from '../testing';\n@@ -3998,6 +3998,112 @@ describe('Integration', () => {\n              })));\n     });\n \n+    describe('should run CanLoad guards concurrently', () => {\n+      function delayObservable(delayMs: number): Observable<boolean> {\n+        return of(delayMs).pipe(delay(delayMs), mapTo(true));\n+      }\n+\n+      @NgModule()\n+      class LoadedModule {\n+      }\n+\n+      let log: string[];\n+\n+      beforeEach(() => {\n+        log = [];\n+        TestBed.configureTestingModule({\n+          providers: [\n+            {\n+              provide: 'guard1',\n+              useValue: () => {\n+                return delayObservable(5).pipe(tap({next: () => log.push('guard1')}));\n+              }\n+            },\n+            {\n+              provide: 'guard2',\n+              useValue: () => {\n+                return delayObservable(0).pipe(tap({next: () => log.push('guard2')}));\n+              }\n+            },\n+            {\n+              provide: 'returnFalse',\n+              useValue: () => {\n+                log.push('returnFalse');\n+                return false;\n+              }\n+            },\n+            {\n+              provide: 'returnUrlTree',\n+              useFactory: (router: Router) => () => {\n+                return delayObservable(15).pipe(\n+                    mapTo(router.parseUrl('/redirected')),\n+                    tap({next: () => log.push('returnUrlTree')}));\n+              },\n+              deps: [Router]\n+            },\n+          ]\n+        });\n+      });\n+\n+      it('should wait for higher priority guards to be resolved',\n+         fakeAsync(inject(\n+             [Router, NgModuleFactoryLoader],\n+             (router: Router, loader: SpyNgModuleFactoryLoader) => {\n+               loader.stubbedModules = {expected: LoadedModule};\n+\n+               router.resetConfig(\n+                   [{path: 'lazy', canLoad: ['guard1', 'guard2'], loadChildren: 'expected'}]);\n+\n+               router.navigateByUrl('/lazy');\n+               tick(5);\n+\n+               expect(log.length).toEqual(2);\n+               expect(log).toEqual(['guard2', 'guard1']);\n+             })));\n+\n+      it('should redirect with UrlTree if higher priority guards have resolved',\n+         fakeAsync(inject(\n+             [Router, NgModuleFactoryLoader, Location],\n+             (router: Router, loader: SpyNgModuleFactoryLoader, location: Location) => {\n+               loader.stubbedModules = {expected: LoadedModule};\n+\n+               router.resetConfig([\n+                 {\n+                   path: 'lazy',\n+                   canLoad: ['returnUrlTree', 'guard1', 'guard2'],\n+                   loadChildren: 'expected'\n+                 },\n+                 {path: 'redirected', component: SimpleCmp}\n+               ]);\n+\n+               router.navigateByUrl('/lazy');\n+               tick(15);\n+\n+               expect(log.length).toEqual(3);\n+               expect(log).toEqual(['guard2', 'guard1', 'returnUrlTree']);\n+               expect(location.path()).toEqual('/redirected');\n+             })));\n+\n+      it('should redirect with UrlTree if UrlTree is lower priority',\n+         fakeAsync(inject(\n+             [Router, NgModuleFactoryLoader, Location],\n+             (router: Router, loader: SpyNgModuleFactoryLoader, location: Location) => {\n+               loader.stubbedModules = {expected: LoadedModule};\n+\n+               router.resetConfig([\n+                 {path: 'lazy', canLoad: ['guard1', 'returnUrlTree'], loadChildren: 'expected'},\n+                 {path: 'redirected', component: SimpleCmp}\n+               ]);\n+\n+               router.navigateByUrl('/lazy');\n+               tick(15);\n+\n+               expect(log.length).toEqual(2);\n+               expect(log).toEqual(['guard1', 'returnUrlTree']);\n+               expect(location.path()).toEqual('/redirected');\n+             })));\n+    });\n+\n     describe('order', () => {\n       class Logger {\n         logs: string[] = [];"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 125,
        "deletions": 17
    }
}