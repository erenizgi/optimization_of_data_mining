{
    "author": "gkalpak",
    "message": "fix(service-worker): correctly serve `ngsw/state` with a non-root SW scope (#37922)\n\nThe Angular ServiceWorker can serve requests to a special virtual path,\n`ngsw/state`, showing [information about its internal state][1], which\ncan be useful for debugging.\n\nPreviously, this would only work if the ServiceWorker's [scope][2] was\nthe root directory (`/`). Otherwise, (e.g. when building the app with\n`--baseHref=/some/path/`), the ServiceWorker would fail to detect a\nrequest to `/some/path/ngsw/state` as matching `ngsw/state` and would\nnot serve it with the debugging information.\n\nThis commit fixes it by ensuring that the ServiceWorker's scope is taken\ninto account when detecting a request to `ngsw/state`.\n\n[1]: https://angular.io/guide/service-worker-devops#locating-and-analyzing-debugging-information\n[2]: https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/scope\n\nFixes #30505\n\nPR Close #37922",
    "sha": "2156beed0c198a0c46f6f5a373a68c3de40117ed",
    "files": [
        {
            "sha": "e3585fee5029aaf92995395410d43a2ee5535d36",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/2156beed0c198a0c46f6f5a373a68c3de40117ed/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/2156beed0c198a0c46f6f5a373a68c3de40117ed/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=2156beed0c198a0c46f6f5a373a68c3de40117ed",
            "patch": "@@ -99,6 +99,8 @@ export class Driver implements Debuggable, UpdateSource {\n    */\n   private loggedInvalidOnlyIfCachedRequest: boolean = false;\n \n+  private ngswStatePath = this.adapter.parseUrl('ngsw/state', this.scope.registration.scope).path;\n+\n   /**\n    * A scheduler which manages a queue of tasks that need to be executed when the SW is\n    * not doing any other work (not processing any other requests).\n@@ -184,7 +186,7 @@ export class Driver implements Debuggable, UpdateSource {\n     }\n \n     // The only thing that is served unconditionally is the debug page.\n-    if (requestUrlObj.path === '/ngsw/state') {\n+    if (requestUrlObj.path === this.ngswStatePath) {\n       // Allow the debugger to handle the request, but don't affect SW state in any other way.\n       event.respondWith(this.debugger.handleFetch(req));\n       return;"
        },
        {
            "sha": "44b12a188064790539ed515d7b700a4a4f599d8a",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/2156beed0c198a0c46f6f5a373a68c3de40117ed/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2156beed0c198a0c46f6f5a373a68c3de40117ed/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=2156beed0c198a0c46f6f5a373a68c3de40117ed",
            "patch": "@@ -893,6 +893,34 @@ describe('Driver', () => {\n        expect(await scope.caches.keys()).not.toEqual([]);\n      });\n \n+  describe('serving ngsw/state', () => {\n+    it('should show debug info (when in NORMAL state)', async () => {\n+      expect(await makeRequest(scope, '/ngsw/state'))\n+          .toMatch(/^NGSW Debug Info:\\n\\nDriver state: NORMAL/);\n+    });\n+\n+    it('should show debug info (when in EXISTING_CLIENTS_ONLY state)', async () => {\n+      driver.state = DriverReadyState.EXISTING_CLIENTS_ONLY;\n+      expect(await makeRequest(scope, '/ngsw/state'))\n+          .toMatch(/^NGSW Debug Info:\\n\\nDriver state: EXISTING_CLIENTS_ONLY/);\n+    });\n+\n+    it('should show debug info (when in SAFE_MODE state)', async () => {\n+      driver.state = DriverReadyState.SAFE_MODE;\n+      expect(await makeRequest(scope, '/ngsw/state'))\n+          .toMatch(/^NGSW Debug Info:\\n\\nDriver state: SAFE_MODE/);\n+    });\n+\n+    it('should show debug info when the scope is not root', async () => {\n+      const newScope =\n+          new SwTestHarnessBuilder('http://localhost/foo/bar/').withServerState(server).build();\n+      new Driver(newScope, newScope, new CacheDatabase(newScope, newScope));\n+\n+      expect(await makeRequest(newScope, '/foo/bar/ngsw/state'))\n+          .toMatch(/^NGSW Debug Info:\\n\\nDriver state: NORMAL/);\n+    });\n+  });\n+\n   describe('cache naming', () => {\n     // Helpers\n     const cacheKeysFor = (baseHref: string) =>"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 31,
        "deletions": 1
    }
}