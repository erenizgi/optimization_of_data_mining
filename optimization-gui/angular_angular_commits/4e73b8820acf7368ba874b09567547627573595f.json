{
    "author": "devversion",
    "message": "build: no longer ship ecmascript module files within NPM packages (#42809)\n\nWe accidentally started shipping `.mjs` files for the following\nmodules (or module paths) as of the v12.1.0-next.2 tag:\n\n- `@angular/compiler-cli`\n- `@angular/common/locales`\n- `@angular/bazel`\n- `@angular/benchpress`\n- `@angular/core/schematics`\n- `@angular/elements/schematics`\n- `@angular/language-service`\n- `@angular/localize/schematics`,\n- `@angular/localize/tools`\n- `zone.js`\n\nThis did not cause any issues for consumers but we\nwant to not ship these files without having them wired\nup in `package.json` files. We accidentally started shipping\nthese `.mjs` files due to a NodeJS update which wired up the\nother JavaScript module output flavors in the `pkg_npm` rule.\n\nhttps://github.com/bazelbuild/rules_nodejs/commit/911529fd364eb3ee1b8ecdc568a9fcf38a8b55ca\n\nPR Close #42809",
    "sha": "4e73b8820acf7368ba874b09567547627573595f",
    "files": [
        {
            "sha": "96a34a5b27af987c94984b4e0e02e2b61a2403bd",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/4e73b8820acf7368ba874b09567547627573595f/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/4e73b8820acf7368ba874b09567547627573595f/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=4e73b8820acf7368ba874b09567547627573595f",
            "patch": "@@ -13,6 +13,7 @@ load(\"//packages/bazel:index.bzl\", _ng_module = \"ng_module\", _ng_package = \"ng_p\n load(\"//dev-infra/benchmark/ng_rollup_bundle:ng_rollup_bundle.bzl\", _ng_rollup_bundle = \"ng_rollup_bundle\")\n load(\"//tools:ng_benchmark.bzl\", _ng_benchmark = \"ng_benchmark\")\n load(\"//dev-infra/bazel/api-golden:index.bzl\", _api_golden_test = \"api_golden_test\", _api_golden_test_npm_package = \"api_golden_test_npm_package\")\n+load(\"//dev-infra/bazel:extract_js_module_output.bzl\", \"extract_js_module_output\")\n \n _DEFAULT_TSCONFIG_TEST = \"//packages:tsconfig-test\"\n _INTERNAL_NG_MODULE_API_EXTRACTOR = \"//packages/bazel/src/api-extractor:api_extractor\"\n@@ -252,6 +253,21 @@ def pkg_npm(name, **kwargs):\n         \"0.0.0-PLACEHOLDER\": \"{BUILD_SCM_VERSION}\",\n     })\n \n+    deps = kwargs.pop(\"deps\", [])\n+\n+    # The `pkg_npm` rule brings in devmode (`JSModuleInfo`) and prodmode (`JSEcmaScriptModuleInfo`)\n+    # output into the the NPM package. We do not plan to ship prodmode ECMAScript `.mjs` files yet,\n+    # so we only extract the `JSModuleInfo` outputs (which correspond to ES5 output) from the deps.\n+    # https://github.com/bazelbuild/rules_nodejs/commit/911529fd364eb3ee1b8ecdc568a9fcf38a8b55ca.\n+    # https://github.com/bazelbuild/rules_nodejs/blob/stable/packages/typescript/internal/build_defs.bzl#L334-L337.\n+    extract_js_module_output(\n+        name = \"%s_js_module_output\" % name,\n+        provider = \"JSModuleInfo\",\n+        include_declarations = True,\n+        include_default_files = True,\n+        deps = deps,\n+    )\n+\n     _pkg_npm(\n         name = name,\n         # We never set a `package_name` for NPM packages, neither do we enable validation.\n@@ -274,6 +290,7 @@ def pkg_npm(name, **kwargs):\n             \"//conditions:default\": substitutions,\n         }),\n         visibility = visibility,\n+        deps = [\":%s_js_module_output\" % name],\n         **kwargs\n     )\n "
        }
    ],
    "stats": {
        "total": 17,
        "additions": 17,
        "deletions": 0
    }
}