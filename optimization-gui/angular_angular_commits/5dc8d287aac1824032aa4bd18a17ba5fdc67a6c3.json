{
    "author": "crisbeto",
    "message": "fix(core): queries not matching string injection tokens (#38321)\n\nQueries weren't matching directives that provide themselves via string\ninjection tokens, because the assumption was that any string passed to\na query decorator refers to a template reference.\n\nThese changes make it so we match both template references and\nproviders while giving precedence to the template references.\n\nFixes #38313.\nFixes #38315.\n\nPR Close #38321",
    "sha": "5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3",
    "files": [
        {
            "sha": "0c799cbcf2bed9d898be1f1a11f8b957c172e9a7",
            "filename": "packages/core/src/render3/di.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3/packages%2Fcore%2Fsrc%2Frender3%2Fdi.ts",
            "raw_url": "https://github.com/angular/angular/raw/5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3/packages%2Fcore%2Fsrc%2Frender3%2Fdi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fdi.ts?ref=5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3",
            "patch": "@@ -495,8 +495,8 @@ function searchTokensOnInjector<T>(\n  * @returns Index of a found directive or provider, or null when none found.\n  */\n export function locateDirectiveOrProvider<T>(\n-    tNode: TNode, tView: TView, token: Type<T>|InjectionToken<T>, canAccessViewProviders: boolean,\n-    isHostSpecialCase: boolean|number): number|null {\n+    tNode: TNode, tView: TView, token: Type<T>|InjectionToken<T>|string,\n+    canAccessViewProviders: boolean, isHostSpecialCase: boolean|number): number|null {\n   const nodeProviderIndexes = tNode.providerIndexes;\n   const tInjectables = tView.data;\n \n@@ -510,7 +510,8 @@ export function locateDirectiveOrProvider<T>(\n   // When the host special case applies, only the viewProviders and the component are visible\n   const endIndex = isHostSpecialCase ? injectablesStart + cptViewProvidersCount : directiveEnd;\n   for (let i = startingIndex; i < endIndex; i++) {\n-    const providerTokenOrDef = tInjectables[i] as InjectionToken<any>| Type<any>| DirectiveDef<any>;\n+    const providerTokenOrDef =\n+        tInjectables[i] as InjectionToken<any>| Type<any>| DirectiveDef<any>| string;\n     if (i < directivesStart && token === providerTokenOrDef ||\n         i >= directivesStart && (providerTokenOrDef as DirectiveDef<any>).type === token) {\n       return i;"
        },
        {
            "sha": "3f135d8633ba29ce088e9e939202e90814191719",
            "filename": "packages/core/src/render3/query.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "raw_url": "https://github.com/angular/angular/raw/5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts?ref=5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3",
            "patch": "@@ -227,20 +227,23 @@ class TQuery_ implements TQuery {\n   }\n \n   private matchTNode(tView: TView, tNode: TNode): void {\n-    if (Array.isArray(this.metadata.predicate)) {\n-      const localNames = this.metadata.predicate;\n-      for (let i = 0; i < localNames.length; i++) {\n-        this.matchTNodeWithReadOption(tView, tNode, getIdxOfMatchingSelector(tNode, localNames[i]));\n+    const predicate = this.metadata.predicate;\n+    if (Array.isArray(predicate)) {\n+      for (let i = 0; i < predicate.length; i++) {\n+        const name = predicate[i];\n+        this.matchTNodeWithReadOption(tView, tNode, getIdxOfMatchingSelector(tNode, name));\n+        // Also try matching the name to a provider since strings can be used as DI tokens too.\n+        this.matchTNodeWithReadOption(\n+            tView, tNode, locateDirectiveOrProvider(tNode, tView, name, false, false));\n       }\n     } else {\n-      const typePredicate = this.metadata.predicate as any;\n-      if (typePredicate === ViewEngine_TemplateRef) {\n+      if ((predicate as any) === ViewEngine_TemplateRef) {\n         if (tNode.type === TNodeType.Container) {\n           this.matchTNodeWithReadOption(tView, tNode, -1);\n         }\n       } else {\n         this.matchTNodeWithReadOption(\n-            tView, tNode, locateDirectiveOrProvider(tNode, tView, typePredicate, false, false));\n+            tView, tNode, locateDirectiveOrProvider(tNode, tView, predicate, false, false));\n       }\n     }\n   }"
        },
        {
            "sha": "341f4f45c960046be0aaaef655ae97c95ce86b0c",
            "filename": "packages/core/test/acceptance/query_spec.ts",
            "status": "modified",
            "additions": 173,
            "deletions": 0,
            "changes": 173,
            "blob_url": "https://github.com/angular/angular/blob/5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3/packages%2Fcore%2Ftest%2Facceptance%2Fquery_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3/packages%2Fcore%2Ftest%2Facceptance%2Fquery_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fquery_spec.ts?ref=5dc8d287aac1824032aa4bd18a17ba5fdc67a6c3",
            "patch": "@@ -1631,6 +1631,179 @@ describe('query logic', () => {\n       expect(groups[2]).toBeUndefined();\n     });\n   });\n+\n+  describe('querying for string token providers', () => {\n+    @Directive({\n+      selector: '[text-token]',\n+      providers: [{provide: 'Token', useExisting: TextTokenDirective}],\n+    })\n+    class TextTokenDirective {\n+    }\n+\n+    it('should match string injection token in a ViewChild query', () => {\n+      @Component({template: '<div text-token></div>'})\n+      class App {\n+        @ViewChild('Token') token: any;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, TextTokenDirective]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+      expect(fixture.componentInstance.token).toBeAnInstanceOf(TextTokenDirective);\n+    });\n+\n+    it('should give precedence to local reference if both a reference and a string injection token provider match a ViewChild query',\n+       () => {\n+         @Component({template: '<div text-token #Token></div>'})\n+         class App {\n+           @ViewChild('Token') token: any;\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [App, TextTokenDirective]});\n+         const fixture = TestBed.createComponent(App);\n+         fixture.detectChanges();\n+         expect(fixture.componentInstance.token).toBeAnInstanceOf(ElementRef);\n+       });\n+\n+    it('should match string injection token in a ViewChildren query', () => {\n+      @Component({template: '<div text-token></div>'})\n+      class App {\n+        @ViewChildren('Token') tokens!: QueryList<any>;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, TextTokenDirective]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+\n+      const tokens = fixture.componentInstance.tokens;\n+      expect(tokens.length).toBe(1);\n+      expect(tokens.first).toBeAnInstanceOf(TextTokenDirective);\n+    });\n+\n+    it('should match both string injection token and local reference inside a ViewChildren query',\n+       () => {\n+         @Component({template: '<div text-token #Token></div>'})\n+         class App {\n+           @ViewChildren('Token') tokens!: QueryList<any>;\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [App, TextTokenDirective]});\n+         const fixture = TestBed.createComponent(App);\n+         fixture.detectChanges();\n+\n+         expect(fixture.componentInstance.tokens.toArray()).toEqual([\n+           jasmine.any(ElementRef), jasmine.any(TextTokenDirective)\n+         ]);\n+       });\n+\n+    it('should match string injection token in a ContentChild query', () => {\n+      @Component({selector: 'has-query', template: '<ng-content></ng-content>'})\n+      class HasQuery {\n+        @ContentChild('Token') token: any;\n+      }\n+\n+      @Component({template: '<has-query><div text-token></div></has-query>'})\n+      class App {\n+        @ViewChild(HasQuery) queryComp!: HasQuery;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, HasQuery, TextTokenDirective]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+\n+      expect(fixture.componentInstance.queryComp.token).toBeAnInstanceOf(TextTokenDirective);\n+    });\n+\n+    it('should give precedence to local reference if both a reference and a string injection token provider match a ContentChild query',\n+       () => {\n+         @Component({selector: 'has-query', template: '<ng-content></ng-content>'})\n+         class HasQuery {\n+           @ContentChild('Token') token: any;\n+         }\n+\n+         @Component({template: '<has-query><div text-token #Token></div></has-query>'})\n+         class App {\n+           @ViewChild(HasQuery) queryComp!: HasQuery;\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [App, HasQuery, TextTokenDirective]});\n+         const fixture = TestBed.createComponent(App);\n+         fixture.detectChanges();\n+\n+         expect(fixture.componentInstance.queryComp.token).toBeAnInstanceOf(ElementRef);\n+       });\n+\n+    it('should match string injection token in a ContentChildren query', () => {\n+      @Component({selector: 'has-query', template: '<ng-content></ng-content>'})\n+      class HasQuery {\n+        @ContentChildren('Token') tokens!: QueryList<any>;\n+      }\n+\n+      @Component({template: '<has-query><div text-token></div></has-query>'})\n+      class App {\n+        @ViewChild(HasQuery) queryComp!: HasQuery;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, HasQuery, TextTokenDirective]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+\n+      const tokens = fixture.componentInstance.queryComp.tokens;\n+      expect(tokens.length).toBe(1);\n+      expect(tokens.first).toBeAnInstanceOf(TextTokenDirective);\n+    });\n+\n+    it('should match both string injection token and local reference inside a ContentChildren query',\n+       () => {\n+         @Component({selector: 'has-query', template: '<ng-content></ng-content>'})\n+         class HasQuery {\n+           @ContentChildren('Token') tokens!: QueryList<any>;\n+         }\n+\n+         @Component({template: '<has-query><div text-token #Token></div></has-query>'})\n+         class App {\n+           @ViewChild(HasQuery) queryComp!: HasQuery;\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [App, HasQuery, TextTokenDirective]});\n+         const fixture = TestBed.createComponent(App);\n+         fixture.detectChanges();\n+\n+         expect(fixture.componentInstance.queryComp.tokens.toArray()).toEqual([\n+           jasmine.any(ElementRef), jasmine.any(TextTokenDirective)\n+         ]);\n+       });\n+\n+    it('should match string token specified through the `read` option of a view query', () => {\n+      @Component({template: '<div text-token #Token></div>'})\n+      class App {\n+        @ViewChild('Token', {read: 'Token'}) token: any;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, TextTokenDirective]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+      expect(fixture.componentInstance.token).toBeAnInstanceOf(TextTokenDirective);\n+    });\n+\n+    it('should match string token specified through the `read` option of a content query', () => {\n+      @Component({selector: 'has-query', template: '<ng-content></ng-content>'})\n+      class HasQuery {\n+        @ContentChild('Token', {read: 'Token'}) token: any;\n+      }\n+\n+      @Component({template: '<has-query><div text-token #Token></div></has-query>'})\n+      class App {\n+        @ViewChild(HasQuery) queryComp!: HasQuery;\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [App, HasQuery, TextTokenDirective]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+\n+      expect(fixture.componentInstance.queryComp.token).toBeAnInstanceOf(TextTokenDirective);\n+    });\n+  });\n });\n \n function initWithTemplate(compType: Type<any>, template: string) {"
        }
    ],
    "stats": {
        "total": 197,
        "additions": 187,
        "deletions": 10
    }
}