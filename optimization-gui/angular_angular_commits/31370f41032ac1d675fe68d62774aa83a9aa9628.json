{
    "author": "devversion",
    "message": "feat(bazel): allow setting `compilationMode` in `ng_module` rule (#41366)\n\nAdds a new attribute to the `ng_module` rule that allows users to\nset the Angular compiler `compilationMode` flag. An alternative\nwould have been to just enable the option in the user-specified\ntsconfig. Though that is more inconvenient if a Bazel workspace\nwants to change the compilation mode conditionally at anaylsis\nphase through build settings.\n\nRelated to: https://github.com/angular/components/pull/22351t\n\nPR Close #41366",
    "sha": "31370f41032ac1d675fe68d62774aa83a9aa9628",
    "files": [
        {
            "sha": "febce716c5676e6b0a6e60a2d12229cda782d7f6",
            "filename": "packages/bazel/src/ng_module.bzl",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Fsrc%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module.bzl?ref=31370f41032ac1d675fe68d62774aa83a9aa9628",
            "patch": "@@ -339,6 +339,7 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         # Summaries are only enabled if Angular outputs are to be produced.\n         \"enableSummariesForJit\": is_legacy_ngc,\n         \"enableIvy\": is_ivy_enabled(ctx),\n+        \"compilationMode\": ctx.attr.compilation_mode,\n         \"fullTemplateTypeCheck\": ctx.attr.type_check,\n         # In Google3 we still want to use the symbol factory re-exports in order to\n         # not break existing apps inside Google. Unlike Bazel, Google3 does not only\n@@ -725,6 +726,14 @@ NG_MODULE_ATTRIBUTES = {\n     \"filter_summaries\": attr.bool(default = False),\n     \"type_check\": attr.bool(default = True),\n     \"inline_resources\": attr.bool(default = True),\n+    \"compilation_mode\": attr.string(\n+        doc = \"\"\"Set the compilation mode for the Angular compiler.\n+\n+        This attribute is a noop if Ivy is not enabled.\n+        \"\"\",\n+        values = [\"partial\", \"full\", \"\"],\n+        default = \"\",\n+    ),\n     \"no_i18n\": attr.bool(default = False),\n     \"compiler\": attr.label(\n         doc = \"\"\"Sets a different ngc compiler binary to use for this library."
        },
        {
            "sha": "93f9263fe0e8b6060458b4dd5feb2f8a76b9cf4b",
            "filename": "packages/bazel/test/ngc-wrapped/ivy_enabled/BUILD.bazel",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2FBUILD.bazel?ref=31370f41032ac1d675fe68d62774aa83a9aa9628",
            "patch": "@@ -0,0 +1,45 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ng_module\", \"ts_library\")\n+\n+ts_library(\n+    name = \"ng_module_ivy_test_lib\",\n+    testonly = True,\n+    srcs = [\"ng_module_ivy_test.ts\"],\n+    tags = [\"ivy-only\"],\n+)\n+\n+# `ng_module` with `compilation_mode` explicitly set to `partial`.\n+ng_module(\n+    name = \"test_module_partial_compilation\",\n+    srcs = [\"test_module_partial_compilation.ts\"],\n+    compilation_mode = \"partial\",\n+    tags = [\"ivy-only\"],\n+    deps = [\"//packages/core\"],\n+)\n+\n+# `ng_module` with `compilation_mode` explicitly set to `full`.\n+ng_module(\n+    name = \"test_module_full_compilation\",\n+    srcs = [\"test_module_full_compilation.ts\"],\n+    compilation_mode = \"full\",\n+    tags = [\"ivy-only\"],\n+    deps = [\"//packages/core\"],\n+)\n+\n+# `ng_module` with no specific `compilation_mode` attribute specified.\n+ng_module(\n+    name = \"test_module_default_compilation\",\n+    srcs = [\"test_module_default_compilation.ts\"],\n+    tags = [\"ivy-only\"],\n+    deps = [\"//packages/core\"],\n+)\n+\n+jasmine_node_test(\n+    name = \"ng_module_ivy_test\",\n+    srcs = [\":ng_module_ivy_test_lib\"],\n+    data = [\n+        \":test_module_default_compilation\",\n+        \":test_module_full_compilation\",\n+        \":test_module_partial_compilation\",\n+    ],\n+    tags = [\"ivy-only\"],\n+)"
        },
        {
            "sha": "9e64b1e628ef1661c839c35a475ef845f1ab31de",
            "filename": "packages/bazel/test/ngc-wrapped/ivy_enabled/ng_module_ivy_test.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Fng_module_ivy_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Fng_module_ivy_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Fng_module_ivy_test.ts?ref=31370f41032ac1d675fe68d62774aa83a9aa9628",
            "patch": "@@ -0,0 +1,41 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {readFileSync} from 'fs';\n+\n+/** Runfiles helper from bazel to resolve file name paths.  */\n+const runfiles = require(process.env['BAZEL_NODE_RUNFILES_HELPER']!);\n+\n+describe('ng_module with ivy enabled', () => {\n+  describe('default compilation mode', () => {\n+    it('should generate definitions', () => {\n+      const outputFile = runfiles.resolveWorkspaceRelative(\n+          'packages/bazel/test/ngc-wrapped/ivy_enabled/test_module_default_compilation.js');\n+      const fileContent = readFileSync(outputFile, 'utf8');\n+      expect(fileContent).toContain(`TestComponent.ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent(`);\n+    });\n+  });\n+\n+  describe('full compilation mode', () => {\n+    it('should generate definitions', () => {\n+      const outputFile = runfiles.resolveWorkspaceRelative(\n+          'packages/bazel/test/ngc-wrapped/ivy_enabled/test_module_full_compilation.js');\n+      const fileContent = readFileSync(outputFile, 'utf8');\n+      expect(fileContent).toContain(`TestComponent.ɵcmp = /*@__PURE__*/ i0.ɵɵdefineComponent(`);\n+    });\n+  });\n+\n+  describe('partial compilation mode', () => {\n+    it('should generate declarations', () => {\n+      const outputFile = runfiles.resolveWorkspaceRelative(\n+          'packages/bazel/test/ngc-wrapped/ivy_enabled/test_module_partial_compilation.js');\n+      const fileContent = readFileSync(outputFile, 'utf8');\n+      expect(fileContent).toContain(`TestComponent.ɵcmp = i0.ɵɵngDeclareComponent(`);\n+    });\n+  });\n+});"
        },
        {
            "sha": "8fb7607675b097f827da05305ebc11cfe2233446",
            "filename": "packages/bazel/test/ngc-wrapped/ivy_enabled/test_module_default_compilation.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_default_compilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_default_compilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_default_compilation.ts?ref=31370f41032ac1d675fe68d62774aa83a9aa9628",
            "patch": "@@ -0,0 +1,15 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Component} from '@angular/core';\n+\n+@Component({\n+  template: 'Hello',\n+})\n+export class TestComponent {\n+}"
        },
        {
            "sha": "8fb7607675b097f827da05305ebc11cfe2233446",
            "filename": "packages/bazel/test/ngc-wrapped/ivy_enabled/test_module_full_compilation.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_full_compilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_full_compilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_full_compilation.ts?ref=31370f41032ac1d675fe68d62774aa83a9aa9628",
            "patch": "@@ -0,0 +1,15 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Component} from '@angular/core';\n+\n+@Component({\n+  template: 'Hello',\n+})\n+export class TestComponent {\n+}"
        },
        {
            "sha": "8fb7607675b097f827da05305ebc11cfe2233446",
            "filename": "packages/bazel/test/ngc-wrapped/ivy_enabled/test_module_partial_compilation.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_partial_compilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/31370f41032ac1d675fe68d62774aa83a9aa9628/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_partial_compilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Fivy_enabled%2Ftest_module_partial_compilation.ts?ref=31370f41032ac1d675fe68d62774aa83a9aa9628",
            "patch": "@@ -0,0 +1,15 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Component} from '@angular/core';\n+\n+@Component({\n+  template: 'Hello',\n+})\n+export class TestComponent {\n+}"
        }
    ],
    "stats": {
        "total": 140,
        "additions": 140,
        "deletions": 0
    }
}