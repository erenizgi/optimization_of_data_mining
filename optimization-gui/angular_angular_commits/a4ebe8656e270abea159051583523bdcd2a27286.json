{
    "author": "dylhunn",
    "message": "fix(forms): registerOnValidatorChange should be called for ngModelGroup. (#41971)\n\nThe Validator and AsyncValidator interfaces provide a callback, `registerOnValidatorChange(fn)`. `registerOnValidatorChange` is supposed to be fired at least once to register `fn` with the validator. `fn` is then called by the validator whenever its inputs change. This was previously not happening for FormGroup validators, and is now fixed.\n\nPR Close #41971",
    "sha": "a4ebe8656e270abea159051583523bdcd2a27286",
    "files": [
        {
            "sha": "f8ab4a62a9f50b8cae0348bdc24b89bffe705f04",
            "filename": "packages/forms/src/directives/reactive_directives/form_group_directive.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts?ref=a4ebe8656e270abea159051583523bdcd2a27286",
            "patch": "@@ -114,7 +114,7 @@ export class FormGroupDirective extends ControlContainer implements Form, OnChan\n   /** @nodoc */\n   ngOnDestroy() {\n     if (this.form) {\n-      cleanUpValidators(this.form, this, /* handleOnValidatorChange */ false);\n+      cleanUpValidators(this.form, this);\n \n       // Currently the `onCollectionChange` callback is rewritten each time the\n       // `_registerOnCollectionChange` function is invoked. The implication is that cleanup should\n@@ -348,9 +348,9 @@ export class FormGroupDirective extends ControlContainer implements Form, OnChan\n   }\n \n   private _updateValidators() {\n-    setUpValidators(this.form, this, /* handleOnValidatorChange */ false);\n+    setUpValidators(this.form, this);\n     if (this._oldForm) {\n-      cleanUpValidators(this._oldForm, this, /* handleOnValidatorChange */ false);\n+      cleanUpValidators(this._oldForm, this);\n     }\n   }\n "
        },
        {
            "sha": "e8025b2327ccb6abe451386964ae4bfda4f01366",
            "filename": "packages/forms/src/directives/shared.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 24,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts?ref=a4ebe8656e270abea159051583523bdcd2a27286",
            "patch": "@@ -37,7 +37,7 @@ export function setUpControl(control: FormControl, dir: NgControl): void {\n     if (!dir.valueAccessor) _throwError(dir, 'No value accessor for form control with');\n   }\n \n-  setUpValidators(control, dir, /* handleOnValidatorChange */ true);\n+  setUpValidators(control, dir);\n \n   dir.valueAccessor!.writeValue(control.value);\n \n@@ -79,7 +79,7 @@ export function cleanUpControl(\n     dir.valueAccessor.registerOnTouched(noop);\n   }\n \n-  cleanUpValidators(control, dir, /* handleOnValidatorChange */ true);\n+  cleanUpValidators(control, dir);\n \n   if (control) {\n     dir._invokeOnDestroyCallbacks();\n@@ -122,12 +122,8 @@ export function setUpDisabledChangeHandler(control: FormControl, dir: NgControl)\n  *\n  * @param control Form control where directive validators should be setup.\n  * @param dir Directive instance that contains validators to be setup.\n- * @param handleOnValidatorChange Flag that determines whether directive validators should be setup\n- *     to handle validator input change.\n  */\n-export function setUpValidators(\n-    control: AbstractControl, dir: AbstractControlDirective,\n-    handleOnValidatorChange: boolean): void {\n+export function setUpValidators(control: AbstractControl, dir: AbstractControlDirective): void {\n   const validators = getControlValidators(control);\n   if (dir.validator !== null) {\n     control.setValidators(mergeValidators<ValidatorFn>(validators, dir.validator));\n@@ -151,11 +147,9 @@ export function setUpValidators(\n   }\n \n   // Re-run validation when validator binding changes, e.g. minlength=3 -> minlength=4\n-  if (handleOnValidatorChange) {\n-    const onValidatorChange = () => control.updateValueAndValidity();\n-    registerOnValidatorChange<ValidatorFn>(dir._rawValidators, onValidatorChange);\n-    registerOnValidatorChange<AsyncValidatorFn>(dir._rawAsyncValidators, onValidatorChange);\n-  }\n+  const onValidatorChange = () => control.updateValueAndValidity();\n+  registerOnValidatorChange<ValidatorFn>(dir._rawValidators, onValidatorChange);\n+  registerOnValidatorChange<AsyncValidatorFn>(dir._rawAsyncValidators, onValidatorChange);\n }\n \n /**\n@@ -165,13 +159,10 @@ export function setUpValidators(\n  *\n  * @param control Form control from where directive validators should be removed.\n  * @param dir Directive instance that contains validators to be removed.\n- * @param handleOnValidatorChange Flag that determines whether directive validators should also be\n- *     cleaned up to stop handling validator input change (if previously configured to do so).\n  * @returns true if a control was updated as a result of this action.\n  */\n export function cleanUpValidators(\n-    control: AbstractControl|null, dir: AbstractControlDirective,\n-    handleOnValidatorChange: boolean): boolean {\n+    control: AbstractControl|null, dir: AbstractControlDirective): boolean {\n   let isControlUpdated = false;\n   if (control !== null) {\n     if (dir.validator !== null) {\n@@ -200,12 +191,10 @@ export function cleanUpValidators(\n     }\n   }\n \n-  if (handleOnValidatorChange) {\n-    // Clear onValidatorChange callbacks by providing a noop function.\n-    const noop = () => {};\n-    registerOnValidatorChange<ValidatorFn>(dir._rawValidators, noop);\n-    registerOnValidatorChange<AsyncValidatorFn>(dir._rawAsyncValidators, noop);\n-  }\n+  // Clear onValidatorChange callbacks by providing a noop function.\n+  const noop = () => {};\n+  registerOnValidatorChange<ValidatorFn>(dir._rawValidators, noop);\n+  registerOnValidatorChange<AsyncValidatorFn>(dir._rawAsyncValidators, noop);\n \n   return isControlUpdated;\n }\n@@ -264,7 +253,7 @@ export function setUpFormContainer(\n     control: FormGroup|FormArray, dir: AbstractFormGroupDirective|FormArrayName) {\n   if (control == null && (typeof ngDevMode === 'undefined' || ngDevMode))\n     _throwError(dir, 'Cannot find control with');\n-  setUpValidators(control, dir, /* handleOnValidatorChange */ false);\n+  setUpValidators(control, dir);\n }\n \n /**\n@@ -276,7 +265,7 @@ export function setUpFormContainer(\n  */\n export function cleanUpFormContainer(\n     control: FormGroup|FormArray, dir: AbstractFormGroupDirective|FormArrayName): boolean {\n-  return cleanUpValidators(control, dir, /* handleOnValidatorChange */ false);\n+  return cleanUpValidators(control, dir);\n }\n \n function _noControlError(dir: NgControl) {"
        },
        {
            "sha": "588c344b42a5234479c518ac68a944c2fc7909ff",
            "filename": "packages/forms/test/reactive_integration_spec.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 0,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts?ref=a4ebe8656e270abea159051583523bdcd2a27286",
            "patch": "@@ -2733,6 +2733,80 @@ const ValueAccessorB = createControlValueAccessor('[cva-b]');\n             expect(form.controls.pin.errors).toEqual({max: {max: -10, actual: 0}});\n           });\n         });\n+\n+        it('should fire registerOnValidatorChange for validators attached to the formGroups',\n+           () => {\n+             let registerOnValidatorChangeFired = 0;\n+             let registerOnAsyncValidatorChangeFired = 0;\n+\n+             @Directive({\n+               selector: '[ng-noop-validator]',\n+               providers: [\n+                 {provide: NG_VALIDATORS, useExisting: forwardRef(() => NoOpValidator), multi: true}\n+               ]\n+             })\n+             class NoOpValidator implements Validator {\n+               @Input() validatorInput = '';\n+\n+               validate(c: AbstractControl) {\n+                 return null;\n+               }\n+\n+               public registerOnValidatorChange(fn: () => void) {\n+                 registerOnValidatorChangeFired++;\n+               }\n+             }\n+\n+             @Directive({\n+               selector: '[ng-noop-async-validator]',\n+               providers: [{\n+                 provide: NG_ASYNC_VALIDATORS,\n+                 useExisting: forwardRef(() => NoOpAsyncValidator),\n+                 multi: true\n+               }]\n+             })\n+             class NoOpAsyncValidator implements AsyncValidator {\n+               @Input() validatorInput = '';\n+\n+               validate(c: AbstractControl) {\n+                 return Promise.resolve(null);\n+               }\n+\n+               public registerOnValidatorChange(fn: () => void) {\n+                 registerOnAsyncValidatorChangeFired++;\n+               }\n+             }\n+\n+             @Component({\n+               selector: 'ng-model-noop-validation',\n+               template: `\n+            <form [formGroup]=\"fooGroup\" ng-noop-validator ng-noop-async-validator [validatorInput]=\"validatorInput\">\n+                <input type=\"text\" formControlName=\"fooInput\">\n+            </form>\n+           `\n+             })\n+             class NgModelNoOpValidation {\n+               validatorInput = 'bar';\n+\n+               fooGroup = new FormGroup({\n+                 fooInput: new FormControl(''),\n+               });\n+             }\n+\n+             const fixture = initTest(NgModelNoOpValidation, NoOpValidator, NoOpAsyncValidator);\n+             fixture.detectChanges();\n+\n+             expect(registerOnValidatorChangeFired).toBe(1);\n+             expect(registerOnAsyncValidatorChangeFired).toBe(1);\n+\n+             fixture.componentInstance.validatorInput = 'baz';\n+             fixture.detectChanges();\n+\n+             // Changing the validator input should not cause the onValidatorChange to be called\n+             // again.\n+             expect(registerOnValidatorChangeFired).toBe(1);\n+             expect(registerOnAsyncValidatorChangeFired).toBe(1);\n+           });\n       });\n     });\n "
        },
        {
            "sha": "e35d281d64b0846a9a054fd7ea9306e795835016",
            "filename": "packages/forms/test/template_integration_spec.ts",
            "status": "modified",
            "additions": 74,
            "deletions": 1,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Ftest%2Ftemplate_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a4ebe8656e270abea159051583523bdcd2a27286/packages%2Fforms%2Ftest%2Ftemplate_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Ftemplate_integration_spec.ts?ref=a4ebe8656e270abea159051583523bdcd2a27286",
            "patch": "@@ -9,7 +9,7 @@\n import {ÉµgetDOM as getDOM} from '@angular/common';\n import {Component, Directive, forwardRef, Input, Type, ViewChild} from '@angular/core';\n import {ComponentFixture, fakeAsync, TestBed, tick, waitForAsync} from '@angular/core/testing';\n-import {AbstractControl, AsyncValidator, COMPOSITION_BUFFER_MODE, ControlValueAccessor, FormControl, FormsModule, MaxValidator, MinValidator, NG_ASYNC_VALIDATORS, NG_VALIDATORS, NG_VALUE_ACCESSOR, NgForm, NgModel} from '@angular/forms';\n+import {AbstractControl, AsyncValidator, COMPOSITION_BUFFER_MODE, ControlValueAccessor, FormControl, FormsModule, MaxValidator, MinValidator, NG_ASYNC_VALIDATORS, NG_VALIDATORS, NG_VALUE_ACCESSOR, NgForm, NgModel, Validator} from '@angular/forms';\n import {By} from '@angular/platform-browser/src/dom/debug/by';\n import {dispatchEvent, sortedClassList} from '@angular/platform-browser/testing/src/browser_util';\n import {merge} from 'rxjs';\n@@ -1967,6 +1967,79 @@ import {NgModelCustomComp, NgModelCustomWrapper} from './value_accessor_integrat\n            expect(form.valid).toBeFalse();\n            expect(form.controls.min_max.errors).toEqual({max: {max: -10, actual: 0}});\n          }));\n+\n+      it('should call registerOnValidatorChange as a part of a formGroup setup', fakeAsync(() => {\n+           let registerOnValidatorChangeFired = 0;\n+           let registerOnAsyncValidatorChangeFired = 0;\n+\n+           @Directive({\n+             selector: '[ng-noop-validator]',\n+             providers: [\n+               {provide: NG_VALIDATORS, useExisting: forwardRef(() => NoOpValidator), multi: true}\n+             ]\n+           })\n+           class NoOpValidator implements Validator {\n+             @Input() validatorInput = '';\n+\n+             validate(c: AbstractControl) {\n+               return null;\n+             }\n+\n+             public registerOnValidatorChange(fn: () => void) {\n+               registerOnValidatorChangeFired++;\n+             }\n+           }\n+\n+           @Directive({\n+             selector: '[ng-noop-async-validator]',\n+             providers: [{\n+               provide: NG_ASYNC_VALIDATORS,\n+               useExisting: forwardRef(() => NoOpAsyncValidator),\n+               multi: true\n+             }]\n+           })\n+           class NoOpAsyncValidator implements AsyncValidator {\n+             @Input() validatorInput = '';\n+\n+             validate(c: AbstractControl) {\n+               return Promise.resolve(null);\n+             }\n+\n+             public registerOnValidatorChange(fn: () => void) {\n+               registerOnAsyncValidatorChangeFired++;\n+             }\n+           }\n+\n+           @Component({\n+             selector: 'ng-model-noop-validation',\n+             template: `\n+              <form>\n+                <div ngModelGroup=\"emptyGroup\" ng-noop-validator ng-noop-async-validator [validatorInput]=\"validatorInput\">\n+                  <input name=\"fgInput\" ngModel>\n+                </div>\n+              </form>\n+            `\n+           })\n+           class NgModelNoOpValidation {\n+             validatorInput = 'foo';\n+             emptyGroup = {};\n+           }\n+\n+           const fixture = initTest(NgModelNoOpValidation, NoOpValidator, NoOpAsyncValidator);\n+           fixture.detectChanges();\n+           tick();\n+\n+           expect(registerOnValidatorChangeFired).toBe(1);\n+           expect(registerOnAsyncValidatorChangeFired).toBe(1);\n+\n+           fixture.componentInstance.validatorInput = 'bar';\n+           fixture.detectChanges();\n+\n+           // Changing validator inputs should not cause `registerOnValidatorChange` to be invoked,\n+           // since it's invoked just once during the setup phase.\n+           expect(registerOnValidatorChangeFired).toBe(1);\n+           expect(registerOnAsyncValidatorChangeFired).toBe(1);\n+         }));\n     });\n \n     describe('IME events', () => {"
        }
    ],
    "stats": {
        "total": 192,
        "additions": 164,
        "deletions": 28
    }
}