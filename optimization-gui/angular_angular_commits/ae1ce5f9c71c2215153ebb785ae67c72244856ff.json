{
    "author": "gkalpak",
    "message": "refactor(docs-infra): prepare `firebase-test-utils` for accepting regex-based redirects (#41842)\n\nCurrently, the utilities for testing Firebase redirects assume that the\nredirects are configured using the glob-based `source` property.\nHowever, Firebase also supports configuring redirects using regular\nexpressions (via the `regex` property).\nSee the [Firebase docs][1] for more details.\n\nThis commit refactors the utilities in `firebase-test-utils/` to make it\neasy to add support for such regex-based redirect configurations.\n\n[1]: https://firebase.google.com/docs/hosting/full-config#redirects\n\nPR Close #41842",
    "sha": "ae1ce5f9c71c2215153ebb785ae67c72244856ff",
    "files": [
        {
            "sha": "257edbeb437c97e9f683a08ffbadd34f50d1fd86",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirect.spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.spec.ts?ref=ae1ce5f9c71c2215153ebb785ae67c72244856ff",
            "patch": "@@ -3,27 +3,27 @@ import { FirebaseRedirect } from './FirebaseRedirect';\n describe('FirebaseRedirect', () => {\n   describe('replace', () => {\n     it('should return undefined if the redirect does not match the url', () => {\n-      const redirect = new FirebaseRedirect('/a/b/c', '/x/y/z');\n+      const redirect = new FirebaseRedirect({source: '/a/b/c', destination: '/x/y/z'});\n       expect(redirect.replace('/1/2/3')).toBe(undefined);\n     });\n \n     it('should return the destination if there is a match', () => {\n-      const redirect = new FirebaseRedirect('/a/b/c', '/x/y/z');\n+      const redirect = new FirebaseRedirect({source: '/a/b/c', destination: '/x/y/z'});\n       expect(redirect.replace('/a/b/c')).toBe('/x/y/z');\n     });\n \n     it('should inject name params into the destination', () => {\n-      const redirect = new FirebaseRedirect('/api/:package/:api-*', '<:package><:api>');\n+      const redirect = new FirebaseRedirect({source: '/api/:package/:api-*', destination: '<:package><:api>'});\n       expect(redirect.replace('/api/common/NgClass-directive')).toEqual('<common><NgClass>');\n     });\n \n     it('should inject rest params into the destination', () => {\n-      const redirect = new FirebaseRedirect('/a/:rest*', '/x/:rest*/y');\n+      const redirect = new FirebaseRedirect({source: '/a/:rest*', destination: '/x/:rest*/y'});\n       expect(redirect.replace('/a/b/c')).toEqual('/x/b/c/y');\n     });\n \n     it('should inject both named and rest parameters into the destination', () => {\n-      const redirect = new FirebaseRedirect('/:a/:rest*', '/x/:a/y/:rest*/z');\n+      const redirect = new FirebaseRedirect({source: '/:a/:rest*', destination: '/x/:a/y/:rest*/z'});\n       expect(redirect.replace('/a/b/c')).toEqual('/x/a/y/b/c/z');\n     });\n   });"
        },
        {
            "sha": "212ae7f3271305e2ef872f2868c5457f56626551",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirect.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.ts",
            "raw_url": "https://github.com/angular/angular/raw/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.ts?ref=ae1ce5f9c71c2215153ebb785ae67c72244856ff",
            "patch": "@@ -1,19 +1,25 @@\n import * as XRegExp from 'xregexp';\n-import { FirebaseGlob } from './FirebaseGlob';\n+import { FirebaseRedirectConfig } from './FirebaseRedirector';\n+import { FirebaseRedirectSource } from './FirebaseRedirectSource';\n \n export class FirebaseRedirect {\n-  glob = new FirebaseGlob(this.source);\n-  constructor(public source: string, public destination: string) {}\n+  source: FirebaseRedirectSource;\n+  destination: string;\n+\n+  constructor({source, destination}: FirebaseRedirectConfig) {\n+    this.source = FirebaseRedirectSource.fromGlobPattern(source);\n+    this.destination = destination;\n+  }\n \n   replace(url: string): string | undefined {\n-    const match = this.glob.match(url);\n+    const match = this.source.match(url);\n \n     if (!match) {\n       return undefined;\n     }\n \n-    const paramReplacers = Object.keys(this.glob.namedParams).map<[RegExp, string]>(name => [ XRegExp(`:${name}`, 'g'), match[name] ]);\n-    const restReplacers = Object.keys(this.glob.restParams).map<[RegExp, string]>(name => [ XRegExp(`:${name}\\\\*`, 'g'), match[name] ]);\n-    return XRegExp.replaceEach(this.destination, [...paramReplacers, ...restReplacers]);\n+    const namedReplacers = this.source.namedGroups.map<[RegExp, string]>(name => [ XRegExp(`:${name}`, 'g'), match[name] ]);\n+    const restReplacers = this.source.restNamedGroups.map<[RegExp, string]>(name => [ XRegExp(`:${name}\\\\*`, 'g'), match[name] ]);\n+    return XRegExp.replaceEach(this.destination, [...namedReplacers, ...restReplacers]);\n   }\n }"
        },
        {
            "sha": "4c2b95c2c23d4256d83c009fda2f6204b9dcc24b",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirectSource.spec.ts",
            "status": "renamed",
            "additions": 15,
            "deletions": 15,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.spec.ts?ref=ae1ce5f9c71c2215153ebb785ae67c72244856ff",
            "patch": "@@ -1,6 +1,6 @@\n-import { FirebaseGlob } from './FirebaseGlob';\n-describe('FirebaseGlob', () => {\n+import { FirebaseRedirectSource } from './FirebaseRedirectSource';\n \n+describe('FirebaseRedirectSource', () => {\n   describe('test', () => {\n     it('should match * parts', () => {\n       testGlob('asdf/*.jpg',\n@@ -42,12 +42,12 @@ describe('FirebaseGlob', () => {\n     });\n \n     it('should error on non-supported choice groups', () => {\n-      expect(() => new FirebaseGlob('/!(a|b)/c'))\n-        .toThrowError('Error in FirebaseGlob: \"/!(a|b)/c\" - \"not\" expansions are not supported: \"!(a|b)\"');\n-      expect(() => new FirebaseGlob('/(a|b)/c'))\n-      .toThrowError('Error in FirebaseGlob: \"/(a|b)/c\" - unknown expansion type: \"/\" in \"/(a|b)\"');\n-      expect(() => new FirebaseGlob('/&(a|b)/c'))\n-        .toThrowError('Error in FirebaseGlob: \"/&(a|b)/c\" - unknown expansion type: \"&\" in \"&(a|b)\"');\n+      expect(() => FirebaseRedirectSource.fromGlobPattern('/!(a|b)/c'))\n+        .toThrowError('Error in FirebaseRedirectSource: \"/!(a|b)/c\" - \"not\" expansions are not supported: \"!(a|b)\"');\n+      expect(() => FirebaseRedirectSource.fromGlobPattern('/(a|b)/c'))\n+      .toThrowError('Error in FirebaseRedirectSource: \"/(a|b)/c\" - unknown expansion type: \"/\" in \"/(a|b)\"');\n+      expect(() => FirebaseRedirectSource.fromGlobPattern('/&(a|b)/c'))\n+        .toThrowError('Error in FirebaseRedirectSource: \"/&(a|b)/c\" - unknown expansion type: \"&\" in \"&(a|b)\"');\n     });\n \n     // Globs that contain params tested via the match tests below\n@@ -176,14 +176,14 @@ describe('FirebaseGlob', () => {\n });\n \n function testGlob(pattern: string, matches: string[], nonMatches: string[]) {\n-  const glob = new FirebaseGlob(pattern);\n-  matches.forEach(url => expect(glob.test(url)).toBe(true, url));\n-  nonMatches.forEach(url => expect(glob.test(url)).toBe(false, url));\n+  const redirectSource = FirebaseRedirectSource.fromGlobPattern(pattern);\n+  matches.forEach(url => expect(redirectSource.test(url)).toBe(true, url));\n+  nonMatches.forEach(url => expect(redirectSource.test(url)).toBe(false, url));\n }\n \n function testMatch(pattern: string, captures: { named?: string[], rest?: string[] }, matches: { [url: string]: object|undefined }) {\n-  const glob = new FirebaseGlob(pattern);\n-  expect(Object.keys(glob.namedParams)).toEqual(captures.named || []);\n-  expect(Object.keys(glob.restParams)).toEqual(captures.rest || []);\n-  Object.keys(matches).forEach(url => expect(glob.match(url)).toEqual(matches[url]));\n+  const redirectSource = FirebaseRedirectSource.fromGlobPattern(pattern);\n+  expect(redirectSource.namedGroups).toEqual(captures.named || []);\n+  expect(redirectSource.restNamedGroups).toEqual(captures.rest || []);\n+  Object.keys(matches).forEach(url => expect(redirectSource.match(url)).toEqual(matches[url]));\n }",
            "previous_filename": "aio/tools/firebase-test-utils/FirebaseGlob.spec.ts"
        },
        {
            "sha": "51294427a4434fafbcd68263dd0283bd12a073ff",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirectSource.ts",
            "status": "renamed",
            "additions": 32,
            "deletions": 26,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.ts",
            "raw_url": "https://github.com/angular/angular/raw/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirectSource.ts?ref=ae1ce5f9c71c2215153ebb785ae67c72244856ff",
            "patch": "@@ -5,45 +5,51 @@ interface XRegExp extends RegExp {\n   xregexp: { captureNames?: string[] };\n }\n \n-const dot = /\\./g;\n-const star = /\\*/g;\n-const doubleStar = /(^|\\/)\\*\\*($|\\/)/g;           // e.g. a/**/b or **/b or a/** but not a**b\n-const modifiedPatterns = /(.)\\(([^)]+)\\)/g;       // e.g. `@(a|b)\n-const restParam = /\\/:([A-Za-z]+)\\*/g;            // e.g. `:rest*`\n-const namedParam = /\\/:([A-Za-z]+)/g;             // e.g. `:api`\n-const possiblyEmptyInitialSegments = /^\\.游냥\\//g;  // e.g. `**/a` can also match `a`\n-const possiblyEmptySegments = /\\/\\.游냥\\//g;        // e.g. `a/**/b` can also match `a/b`\n-const willBeStar = /游냥/g;                         // e.g. `a**b` not matched by previous rule\n+export class FirebaseRedirectSource {\n+  regex = XRegExp(this.pattern) as XRegExp;\n+  namedGroups: string[] = [];\n+\n+  private constructor(public pattern: string, public restNamedGroups: string[] = []) {\n+    const restNamedGroupsSet = new Set(restNamedGroups);\n+    pattern.replace(/\\(\\?<([^>]+)>/g, (_, name) => {\n+      if (!restNamedGroupsSet.has(name)) {\n+        this.namedGroups.push(name);\n+      }\n+      return '';\n+    });\n+  }\n+\n+  static fromGlobPattern(glob: string): FirebaseRedirectSource {\n+    const dot = /\\./g;\n+    const star = /\\*/g;\n+    const doubleStar = /(^|\\/)\\*\\*($|\\/)/g;           // e.g. a/**/b or **/b or a/** but not a**b\n+    const modifiedPatterns = /(.)\\(([^)]+)\\)/g;       // e.g. `@(a|b)\n+    const restParam = /\\/:([A-Za-z]+)\\*/g;            // e.g. `:rest*`\n+    const namedParam = /\\/:([A-Za-z]+)/g;             // e.g. `:api`\n+    const possiblyEmptyInitialSegments = /^\\.游냥\\//g;  // e.g. `**/a` can also match `a`\n+    const possiblyEmptySegments = /\\/\\.游냥\\//g;        // e.g. `a/**/b` can also match `a/b`\n+    const willBeStar = /游냥/g;                         // e.g. `a**b` not matched by previous rule\n \n-export class FirebaseGlob {\n-  pattern: string;\n-  regex: XRegExp;\n-  namedParams: { [key: string]: boolean } = {};\n-  restParams: { [key: string]: boolean } = {};\n-  constructor(glob: string) {\n     try {\n+      const restNamedGroups: string[] = [];\n       const pattern = glob\n           .replace(dot, '\\\\.')\n           .replace(modifiedPatterns, replaceModifiedPattern)\n           .replace(restParam, (_, param) => {\n             // capture the rest of the string\n-            this.restParams[param] = true;\n+            restNamedGroups.push(param);\n             return `(?:/(?<${param}>.游냥))?`;\n           })\n-          .replace(namedParam, (_, param) => {\n-            // capture the named parameter\n-            this.namedParams[param] = true;\n-            return `/(?<${param}>[^/]+)`;\n-          })\n+          .replace(namedParam, `/(?<$1>[^/]+)`)\n           .replace(doubleStar, '$1.游냥$2')                 // use the pig to avoid replacing ** in next rule\n           .replace(star, '[^/]*')                         // match a single segment\n           .replace(possiblyEmptyInitialSegments, '(?:.*)')// deal with **/ special cases\n           .replace(possiblyEmptySegments, '(?:/|/.*/)')   // deal with /**/ special cases\n           .replace(willBeStar, '*');                      // other ** matches\n-      this.pattern = `^${pattern}$`;\n-      this.regex = XRegExp(this.pattern) as XRegExp;\n-    } catch (e) {\n-      throw new Error(`Error in FirebaseGlob: \"${glob}\" - ${e.message}`);\n+\n+      return new FirebaseRedirectSource(`^${pattern}$`, restNamedGroups);\n+    } catch (err) {\n+      throw new Error(`Error in FirebaseRedirectSource: \"${glob}\" - ${err.message}`);\n     }\n   }\n \n@@ -52,7 +58,7 @@ export class FirebaseGlob {\n   }\n \n   match(url: string): { [key: string]: string } | undefined {\n-    const match = XRegExp.exec(url, this.regex) as ReturnType<typeof XRegExp.exec> & { [captured: string]: string };\n+    const match = XRegExp.exec(url, this.regex) as ReturnType<typeof XRegExp.exec>;\n \n     if (!match) {\n       return undefined;",
            "previous_filename": "aio/tools/firebase-test-utils/FirebaseGlob.ts"
        },
        {
            "sha": "19f6a73ebc4b445072073ad027120896ac6466f1",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirector.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.ts",
            "raw_url": "https://github.com/angular/angular/raw/ae1ce5f9c71c2215153ebb785ae67c72244856ff/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.ts?ref=ae1ce5f9c71c2215153ebb785ae67c72244856ff",
            "patch": "@@ -8,7 +8,7 @@ export interface FirebaseRedirectConfig {\n export class FirebaseRedirector {\n   private redirects: FirebaseRedirect[];\n   constructor(redirects: FirebaseRedirectConfig[]) {\n-    this.redirects = redirects.map(redirect => new FirebaseRedirect(redirect.source, redirect.destination));\n+    this.redirects = redirects.map(redirect => new FirebaseRedirect(redirect));\n   }\n \n   redirect(url: string): string {"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 66,
        "deletions": 54
    }
}