{
    "author": "zarend",
    "message": "refactor(compiler-cli): move template parse errors to TemplateData (#40026)\n\nDurring analysis we find template parse errors. This commit changes\nwhere the type checking context stores the parse errors. Previously, we\nstored them on the AnalysisOutput this commit changes the errors to be\nstored on the TemplateData (which is a property on the shim). That way,\nthe template parse errors can be grouped by template.\n\nPreviously, if a template had a parse error, we poisoned the module and\nwould not procede to find typecheck errors. This change does not poison\nmodules whose template have typecheck errors, so that ngtsc can emit\ntypecheck errors for templates with parse errors.\n\nAdditionally, all template diagnostics are produced in the same place.\nThis allows requesting just the template template diagnostics or just\nother types of errors.\n\nPR Close #40026",
    "sha": "db97453ca0d4c4dd011eef8df18cf6a482f0b272",
    "files": [
        {
            "sha": "e4d39317b637c742601e3e53b333d8f49e69bb0d",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 26,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileComponentFromMetadata, compileDeclareComponentFromMetadata, ConstantPool, CssSelector, DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Expression, ExternalExpr, Identifiers, InterpolationConfig, LexerRange, makeBindingParser, ParsedTemplate, ParseSourceFile, parseTemplate, R3ComponentDef, R3ComponentMetadata, R3FactoryTarget, R3TargetBinder, R3UsedDirectiveMetadata, SelectorMatcher, Statement, TmplAstNode, WrappedNodeExpr} from '@angular/compiler';\n+import {compileComponentFromMetadata, compileDeclareComponentFromMetadata, ConstantPool, CssSelector, DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Expression, ExternalExpr, Identifiers, InterpolationConfig, LexerRange, makeBindingParser, ParsedTemplate, ParseSourceFile, parseTemplate, R3ComponentDef, R3ComponentMetadata, R3FactoryTarget, R3TargetBinder, R3UsedDirectiveMetadata, SelectorMatcher, Statement, syntaxError, TmplAstNode, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {CycleAnalyzer} from '../../cycles';\n@@ -266,28 +266,6 @@ export class ComponentDecoratorHandler implements\n         {path: null, expression: component.get('template')!} :\n         {path: absoluteFrom(template.templateUrl), expression: template.sourceMapping.node};\n \n-    let diagnostics: ts.Diagnostic[]|undefined = undefined;\n-\n-    if (template.errors !== null) {\n-      // If there are any template parsing errors, convert them to `ts.Diagnostic`s for display.\n-      const id = getTemplateId(node);\n-      diagnostics = template.errors.map(error => {\n-        const span = error.span;\n-\n-        if (span.start.offset === span.end.offset) {\n-          // Template errors can contain zero-length spans, if the error occurs at a single point.\n-          // However, TypeScript does not handle displaying a zero-length diagnostic very well, so\n-          // increase the ending offset by 1 for such errors, to ensure the position is shown in the\n-          // diagnostic.\n-          span.end.offset++;\n-        }\n-\n-        return makeTemplateDiagnostic(\n-            id, template.sourceMapping, span, ts.DiagnosticCategory.Error,\n-            ngErrorCode(ErrorCode.TEMPLATE_PARSE_ERROR), error.msg);\n-      });\n-    }\n-\n     // Figure out the set of styles. The ordering here is important: external resources (styleUrls)\n     // precede inline styles, and styles defined in the template override styles defined in the\n     // component.\n@@ -370,9 +348,8 @@ export class ComponentDecoratorHandler implements\n           styles: styleResources,\n           template: templateResource,\n         },\n-        isPoisoned: diagnostics !== undefined && diagnostics.length > 0,\n+        isPoisoned: false,\n       },\n-      diagnostics,\n     };\n     if (changeDetection !== null) {\n       output.analysis!.meta.changeDetection = changeDetection;\n@@ -456,7 +433,7 @@ export class ComponentDecoratorHandler implements\n     const binder = new R3TargetBinder(scope.matcher);\n     ctx.addTemplate(\n         new Reference(node), binder, meta.template.diagNodes, scope.pipes, scope.schemas,\n-        meta.template.sourceMapping, meta.template.file);\n+        meta.template.sourceMapping, meta.template.file, meta.template.errors);\n   }\n \n   resolve(node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>):\n@@ -616,6 +593,9 @@ export class ComponentDecoratorHandler implements\n   compileFull(\n       node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>,\n       resolution: Readonly<ComponentResolutionData>, pool: ConstantPool): CompileResult[] {\n+    if (analysis.template.errors !== null && analysis.template.errors.length > 0) {\n+      return [];\n+    }\n     const meta: R3ComponentMetadata = {...analysis.meta, ...resolution};\n     const def = compileComponentFromMetadata(meta, pool, makeBindingParser());\n     return this.compileComponent(analysis, def);\n@@ -624,6 +604,9 @@ export class ComponentDecoratorHandler implements\n   compilePartial(\n       node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>,\n       resolution: Readonly<ComponentResolutionData>): CompileResult[] {\n+    if (analysis.template.errors !== null && analysis.template.errors.length > 0) {\n+      return [];\n+    }\n     const meta: R3ComponentMetadata = {...analysis.meta, ...resolution};\n     const def = compileDeclareComponentFromMetadata(meta, analysis.template);\n     return this.compileComponent(analysis, def);"
        },
        {
            "sha": "eff64819b07c45ed6f3f906c5609e8c60c33759d",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {ConstantPool} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {CycleAnalyzer, ImportGraph} from '../../cycles';\n@@ -219,6 +220,38 @@ runInEachFileSystem(() => {\n       const {analysis} = handler.analyze(TestCmp, detected.metadata);\n       expect(analysis?.resources.styles.size).toBe(3);\n     });\n+\n+    it('does not emit a program with template parse errors', () => {\n+      const template = '{{x ? y }}';\n+      const {program, options, host} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Component: any;',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: `\n+          import {Component} from '@angular/core';\n+          @Component({\n+            template: '${template}',\n+          }) class TestCmp {}\n+      `\n+        },\n+      ]);\n+\n+      const {reflectionHost, handler} = setup(program, options, host);\n+      const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n+      const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n+      if (detected === undefined) {\n+        return fail('Failed to recognize @Component');\n+      }\n+      const {analysis} = handler.analyze(TestCmp, detected.metadata);\n+      const resolution = handler.resolve(TestCmp, analysis!);\n+\n+      const compileResult =\n+          handler.compileFull(TestCmp, analysis!, resolution.data!, new ConstantPool());\n+      expect(compileResult).toEqual([]);\n+    });\n   });\n \n   function ivyCode(code: ErrorCode): number {"
        },
        {
            "sha": "e738aa46b3f37c773dd18f494e202f84d5205ded",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/context.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcontext.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n+import {ParseError, ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {Reference} from '../../imports';\n@@ -35,12 +35,14 @@ export interface TypeCheckContext {\n    * @param sourceMapping a `TemplateSourceMapping` instance which describes the origin of the\n    * template text described by the AST.\n    * @param file the `ParseSourceFile` associated with the template.\n+   * @param parseErrors the `ParseError`'s associated with the template.\n    */\n   addTemplate(\n       ref: Reference<ClassDeclaration<ts.ClassDeclaration>>,\n       binder: R3TargetBinder<TypeCheckableDirectiveMeta>, template: TmplAstNode[],\n       pipes: Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>,\n-      schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping, file: ParseSourceFile): void;\n+      schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping, file: ParseSourceFile,\n+      parseErrors: ParseError[]|null): void;\n }\n \n /**"
        },
        {
            "sha": "2cd5cfffa47c34280e2d3cc6313818500cd1b545",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -20,7 +20,7 @@ import {DirectiveInScope, ElementSymbol, FullTemplateMapping, GlobalCompletion,\n import {TemplateDiagnostic} from '../diagnostics';\n \n import {CompletionEngine} from './completion';\n-import {InliningMode, ShimTypeCheckingData, TemplateData, TypeCheckContextImpl, TypeCheckingHost} from './context';\n+import {InliningMode, ShimTypeCheckingData, TemplateData, TemplateOverride, TypeCheckContextImpl, TypeCheckingHost} from './context';\n import {shouldReportDiagnostic, translateDiagnostic} from './diagnostics';\n import {TemplateSourceManager} from './source';\n import {findTypeCheckBlock, getTemplateMapping, TemplateSourceResolver} from './tcb_util';\n@@ -167,7 +167,7 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       fileRecord.templateOverrides = new Map();\n     }\n \n-    fileRecord.templateOverrides.set(id, nodes);\n+    fileRecord.templateOverrides.set(id, {nodes, errors});\n \n     // Clear data for the shim in question, so it'll be regenerated on the next request.\n     const shimFile = this.typeCheckingStrategy.shimPathForComponent(component);\n@@ -217,8 +217,8 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n   }\n \n   /**\n-   * Retrieve type-checking diagnostics from the given `ts.SourceFile` using the most recent\n-   * type-checking program.\n+   * Retrieve type-checking and template parse diagnostics from the given `ts.SourceFile` using the\n+   * most recent type-checking program.\n    */\n   getDiagnosticsForFile(sf: ts.SourceFile, optimizeFor: OptimizeFor): ts.Diagnostic[] {\n     switch (optimizeFor) {\n@@ -247,6 +247,10 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       diagnostics.push(...typeCheckProgram.getSemanticDiagnostics(shimSf).map(\n           diag => convertDiagnostic(diag, fileRecord.sourceManager)));\n       diagnostics.push(...shimRecord.genesisDiagnostics);\n+\n+      for (const templateData of shimRecord.templates.values()) {\n+        diagnostics.push(...templateData.templateDiagnostics);\n+      }\n     }\n \n     return diagnostics.filter((diag: ts.Diagnostic|null): diag is ts.Diagnostic => diag !== null);\n@@ -282,6 +286,10 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n         diag => convertDiagnostic(diag, fileRecord.sourceManager)));\n     diagnostics.push(...shimRecord.genesisDiagnostics);\n \n+    for (const templateData of shimRecord.templates.values()) {\n+      diagnostics.push(...templateData.templateDiagnostics);\n+    }\n+\n     return diagnostics.filter(\n         (diag: TemplateDiagnostic|null): diag is TemplateDiagnostic =>\n             diag !== null && diag.templateId === templateId);\n@@ -650,7 +658,7 @@ export interface FileTypeCheckingData {\n   /**\n    * Map of template overrides applied to any components in this input file.\n    */\n-  templateOverrides: Map<TemplateId, TmplAstNode[]>|null;\n+  templateOverrides: Map<TemplateId, TemplateOverride>|null;\n \n   /**\n    * Data for each shim generated from this input file.\n@@ -684,7 +692,7 @@ class WholeProgramTypeCheckingHost implements TypeCheckingHost {\n     return !fileData.shimData.has(shimPath);\n   }\n \n-  getTemplateOverride(sfPath: AbsoluteFsPath, node: ts.ClassDeclaration): TmplAstNode[]|null {\n+  getTemplateOverride(sfPath: AbsoluteFsPath, node: ts.ClassDeclaration): TemplateOverride|null {\n     const fileData = this.impl.getFileData(sfPath);\n     if (fileData.templateOverrides === null) {\n       return null;\n@@ -742,7 +750,7 @@ class SingleFileTypeCheckingHost implements TypeCheckingHost {\n     return !this.fileData.shimData.has(shimPath);\n   }\n \n-  getTemplateOverride(sfPath: AbsoluteFsPath, node: ts.ClassDeclaration): TmplAstNode[]|null {\n+  getTemplateOverride(sfPath: AbsoluteFsPath, node: ts.ClassDeclaration): TemplateOverride|null {\n     this.assertPath(sfPath);\n     if (this.fileData.templateOverrides === null) {\n       return null;"
        },
        {
            "sha": "1bb8845a0f04453123bc4b80323d474d9aa5620b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 14,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -6,15 +6,16 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {BoundTarget, ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n+import {BoundTarget, ParseError, ParseSourceFile, R3TargetBinder, SchemaMetadata, TemplateParseError, TmplAstNode} from '@angular/compiler';\n+import {ErrorCode, ngErrorCode} from '@angular/compiler-cli/src/ngtsc/diagnostics';\n import * as ts from 'typescript';\n \n import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {ComponentToShimMappingStrategy, TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n-import {TemplateDiagnostic} from '../diagnostics';\n+import {makeTemplateDiagnostic, TemplateDiagnostic} from '../diagnostics';\n \n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n import {Environment} from './environment';\n@@ -50,6 +51,11 @@ export interface ShimTypeCheckingData {\n   templates: Map<TemplateId, TemplateData>;\n }\n \n+export interface TemplateOverride {\n+  nodes: TmplAstNode[];\n+  errors: ParseError[]|null;\n+}\n+\n /**\n  * Data tracked for each template processed by the template type-checking system.\n  */\n@@ -64,6 +70,11 @@ export interface TemplateData {\n    * template nodes.\n    */\n   boundTarget: BoundTarget<TypeCheckableDirectiveMeta>;\n+\n+  /**\n+   * Errors found while parsing them template, which have been converted to diagnostics.\n+   */\n+  templateDiagnostics: TemplateDiagnostic[];\n }\n \n /**\n@@ -136,7 +147,7 @@ export interface TypeCheckingHost {\n    * Check if the given component has had its template overridden, and retrieve the new template\n    * nodes if so.\n    */\n-  getTemplateOverride(sfPath: AbsoluteFsPath, node: ts.ClassDeclaration): TmplAstNode[]|null;\n+  getTemplateOverride(sfPath: AbsoluteFsPath, node: ts.ClassDeclaration): TemplateOverride|null;\n \n   /**\n    * Report data from a shim generated from the given input file path.\n@@ -194,35 +205,42 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n   private typeCtorPending = new Set<ts.ClassDeclaration>();\n \n   /**\n-   * Record a template for the given component `node`, with a `SelectorMatcher` for directive\n-   * matching.\n+   * Register a template to potentially be type-checked.\n    *\n-   * @param node class of the node being recorded.\n-   * @param template AST nodes of the template being recorded.\n-   * @param matcher `SelectorMatcher` which tracks directives that are in scope for this template.\n+   * Implements `TypeCheckContext.addTemplate`.\n    */\n   addTemplate(\n       ref: Reference<ClassDeclaration<ts.ClassDeclaration>>,\n       binder: R3TargetBinder<TypeCheckableDirectiveMeta>, template: TmplAstNode[],\n       pipes: Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>,\n-      schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping,\n-      file: ParseSourceFile): void {\n+      schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping, file: ParseSourceFile,\n+      parseErrors: ParseError[]|null): void {\n     if (!this.host.shouldCheckComponent(ref.node)) {\n       return;\n     }\n \n+    const fileData = this.dataForFile(ref.node.getSourceFile());\n+    const shimData = this.pendingShimForComponent(ref.node);\n+    const templateId = fileData.sourceManager.getTemplateId(ref.node);\n+\n+    const templateDiagnostics: TemplateDiagnostic[] = [];\n+\n     const sfPath = absoluteFromSourceFile(ref.node.getSourceFile());\n     const overrideTemplate = this.host.getTemplateOverride(sfPath, ref.node);\n     if (overrideTemplate !== null) {\n-      template = overrideTemplate;\n+      template = overrideTemplate.nodes;\n+      parseErrors = overrideTemplate.errors;\n+    }\n+\n+    if (parseErrors !== null) {\n+      templateDiagnostics.push(\n+          ...this.getTemplateDiagnostics(parseErrors, templateId, sourceMapping));\n     }\n \n     // Accumulate a list of any directives which could not have type constructors generated due to\n     // unsupported inlining operations.\n     let missingInlines: ClassDeclaration[] = [];\n \n-    const fileData = this.dataForFile(ref.node.getSourceFile());\n-    const shimData = this.pendingShimForComponent(ref.node);\n     const boundTarget = binder.bind({template});\n \n     // Get all of the directives used in the template and record type constructors for all of them.\n@@ -251,10 +269,11 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n         });\n       }\n     }\n-    const templateId = fileData.sourceManager.getTemplateId(ref.node);\n+\n     shimData.templates.set(templateId, {\n       template,\n       boundTarget,\n+      templateDiagnostics,\n     });\n \n     const tcbRequiresInline = requiresInlineTypeCheckBlock(ref.node, pipes);\n@@ -435,6 +454,26 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n \n     return this.fileMap.get(sfPath)!;\n   }\n+\n+  private getTemplateDiagnostics(\n+      parseErrors: ParseError[], templateId: TemplateId,\n+      sourceMapping: TemplateSourceMapping): TemplateDiagnostic[] {\n+    return parseErrors.map(error => {\n+      const span = error.span;\n+\n+      if (span.start.offset === span.end.offset) {\n+        // Template errors can contain zero-length spans, if the error occurs at a single point.\n+        // However, TypeScript does not handle displaying a zero-length diagnostic very well, so\n+        // increase the ending offset by 1 for such errors, to ensure the position is shown in the\n+        // diagnostic.\n+        span.end.offset++;\n+      }\n+\n+      return makeTemplateDiagnostic(\n+          templateId, sourceMapping, span, ts.DiagnosticCategory.Error,\n+          ngErrorCode(ErrorCode.TEMPLATE_PARSE_ERROR), error.msg);\n+    });\n+  }\n }\n \n /**"
        },
        {
            "sha": "bc55caad9231fda359bfffe2bda8fa64f0903852",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -407,7 +407,7 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n           node: classRef.node.name,\n         };\n \n-        ctx.addTemplate(classRef, binder, nodes, pipes, [], sourceMapping, templateFile);\n+        ctx.addTemplate(classRef, binder, nodes, pipes, [], sourceMapping, templateFile, errors);\n       }\n     }\n   });"
        },
        {
            "sha": "cb2a9391964a98ff0448fd0730e9c06e2555f848",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 7,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -7577,10 +7577,13 @@ export const Foo = Foo__PRE_R3__;\n           env.write('test.ts', `\n             import {Component} from '@angular/core';\n             @Component({\n-              template: '<cmp [input]=\"x ? y\">',\n+              template: '<input [value]=\"x ? y\"/>',\n               selector: 'test-cmp',\n             })\n-            export class TestCmp {}\n+            export class TestCmp {\n+                x = null;\n+                y = null;\n+            }\n           `);\n           const diags = env.driveDiagnostics();\n           expect(diags.length).toBe(1);\n@@ -7591,19 +7594,41 @@ export const Foo = Foo__PRE_R3__;\n           env.write('test.ts', `\n               import {Component} from '@angular/core';\n               @Component({\n-                template: '<cmp [input]=\"x>',\n+                template: '<input [value]=\"x/>',\n                 selector: 'test-cmp',\n               })\n-              export class TestCmp {}\n+              export class TestCmp {\n+                x = null;\n+              }\n             `);\n           const diags = env.driveDiagnostics();\n           expect(diags.length).toBe(1);\n           expect(getDiagnosticSourceCode(diags[0])).toBe('\\'');\n         });\n+\n+        it('should emit both type-check diagnostics and parse error diagnostics', () => {\n+          env.write('test.ts', `\n+              import {Component} from '@angular/core';\n+              @Component({\n+                template: \\`<input (click)=\"x = 'invalid'\"/> {{x = 2}}\\`,\n+                selector: 'test-cmp',\n+              })\n+              export class TestCmp {\n+                x: number = 1;\n+              }\n+            `);\n+          const diags = env.driveDiagnostics();\n+\n+          expect(diags.length).toBe(2);\n+          expect(diags[0].messageText).toEqual(`Type 'string' is not assignable to type 'number'.`);\n+          expect(diags[1].messageText)\n+              .toContain(\n+                  'Parser Error: Bindings cannot contain assignments at column 5 in [ {{x = 2}}]');\n+        });\n       });\n \n       describe('i18n errors', () => {\n-        it('should report helpful error message on nested i18n sections', () => {\n+        it('reports a diagnostics on nested i18n sections', () => {\n           env.write('test.ts', `\n             import {Component} from '@angular/core';\n             @Component({\n@@ -7625,7 +7650,7 @@ export const Foo = Foo__PRE_R3__;\n               .toEqual('<div i18n>Content</div>');\n         });\n \n-        it('report a diagnostic on nested i18n sections with tags in between', () => {\n+        it('reports a diagnostic on nested i18n sections with tags in between', () => {\n           env.write('test.ts', `\n             import {Component} from '@angular/core';\n             @Component({\n@@ -7647,7 +7672,7 @@ export const Foo = Foo__PRE_R3__;\n               .toEqual('<div i18n>Content</div>');\n         });\n \n-        it('report a diagnostic on nested i18n sections represented with <ng-continers>s', () => {\n+        it('reports a diagnostic on nested i18n sections represented with <ng-continers>s', () => {\n           env.write('test.ts', `\n             import {Component} from '@angular/core';\n             @Component({"
        },
        {
            "sha": "b837c18ce739dbaa2a781579c2ad24becc265b36",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 75,
            "deletions": 6,
            "changes": 81,
            "blob_url": "https://github.com/angular/angular/blob/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/db97453ca0d4c4dd011eef8df18cf6a482f0b272/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=db97453ca0d4c4dd011eef8df18cf6a482f0b272",
            "patch": "@@ -13,8 +13,6 @@ import * as ts from 'typescript';\n import {createModuleWithDeclarations} from './test_utils';\n \n describe('getSemanticDiagnostics', () => {\n-  let env: LanguageServiceTestEnvironment;\n-\n   beforeEach(() => {\n     initMockFileSystem('Native');\n   });\n@@ -31,7 +29,7 @@ describe('getSemanticDiagnostics', () => {\n       export class AppComponent {}\n     `\n     };\n-    env = createModuleWithDeclarations([appFile]);\n+    const env = createModuleWithDeclarations([appFile]);\n \n     const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n     expect(diags.length).toEqual(0);\n@@ -49,7 +47,7 @@ describe('getSemanticDiagnostics', () => {\n       export class AppComponent {}\n     `\n     };\n-    env = createModuleWithDeclarations([appFile]);\n+    const env = createModuleWithDeclarations([appFile]);\n \n     const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n     expect(diags.length).toBe(1);\n@@ -78,7 +76,7 @@ describe('getSemanticDiagnostics', () => {\n     `\n     };\n \n-    env = createModuleWithDeclarations([appFile], [templateFile]);\n+    const env = createModuleWithDeclarations([appFile], [templateFile]);\n     const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n     expect(diags).toEqual([]);\n   });\n@@ -97,12 +95,83 @@ describe('getSemanticDiagnostics', () => {\n     };\n     const templateFile = {name: absoluteFrom('/app.html'), contents: `{{nope}}`};\n \n-    env = createModuleWithDeclarations([appFile], [templateFile]);\n+    const env = createModuleWithDeclarations([appFile], [templateFile]);\n     const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n     expect(diags.length).toBe(1);\n     const {category, file, start, length, messageText} = diags[0];\n     expect(category).toBe(ts.DiagnosticCategory.Error);\n     expect(file?.fileName).toBe('/app.html');\n     expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n   });\n+\n+  it('should report a parse error in external template', () => {\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({\n+        templateUrl: './app.html'\n+      })\n+      export class AppComponent {\n+        nope = false;\n+      }\n+    `\n+    };\n+    const templateFile = {name: absoluteFrom('/app.html'), contents: `{{nope = true}}`};\n+\n+    const env = createModuleWithDeclarations([appFile], [templateFile]);\n+    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.html'));\n+    expect(diags.length).toBe(1);\n+\n+    const {category, file, messageText} = diags[0];\n+    expect(category).toBe(ts.DiagnosticCategory.Error);\n+    expect(file?.fileName).toBe('/app.html');\n+    expect(messageText)\n+        .toContain(\n+            `Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}]`);\n+  });\n+\n+  it('should report parse errors of components defined in the same ts file', () => {\n+    const appFile = {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+      import {Component, NgModule} from '@angular/core';\n+\n+      @Component({ templateUrl: './app1.html' })\n+      export class AppComponent1 { nope = false; }\n+\n+      @Component({ templateUrl: './app2.html' })\n+      export class AppComponent2 { nope = false; }\n+    `\n+    };\n+    const templateFile1 = {name: absoluteFrom('/app1.html'), contents: `{{nope = false}}`};\n+    const templateFile2 = {name: absoluteFrom('/app2.html'), contents: `{{nope = true}}`};\n+\n+    const moduleFile = {\n+      name: absoluteFrom('/app-module.ts'),\n+      contents: `\n+        import {NgModule} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+        import {AppComponent, AppComponent2} from './app';\n+\n+        @NgModule({\n+          declarations: [AppComponent, AppComponent2],\n+          imports: [CommonModule],\n+        })\n+        export class AppModule {}\n+    `,\n+      isRoot: true\n+    };\n+\n+    const env =\n+        LanguageServiceTestEnvironment.setup([moduleFile, appFile, templateFile1, templateFile2]);\n+\n+    const diags = env.ngLS.getSemanticDiagnostics(absoluteFrom('/app.ts'));\n+\n+    expect(diags.map(x => x.messageText).sort()).toEqual([\n+      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = false}}] in /app1.html@0:0',\n+      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}] in /app2.html@0:0'\n+    ]);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 285,
        "additions": 222,
        "deletions": 63
    }
}