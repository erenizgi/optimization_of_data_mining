{
    "author": "crisbeto",
    "message": "fix(core): not invoking object's toString when rendering to the DOM (#39843)\n\nCurrently we convert objects to strings using `'' + value` which is quickest,\nbut it stringifies the value using its `valueOf`, rather than `toString`. These\nchanges switch to using `String(value)` which has identical performance\nand calls the `toString` method as expected. Note that another option\nwas calling `toString` directly, but benchmarking showed it to be slower.\n\nI've included the benchmark I used to verify the performance so we have it\nfor future reference and we can reuse it when making changes to `renderStringify`\nin the future.\n\nAlso for reference, here are the results of the benchmark:\n\n```\nBenchmark: renderStringify\n concat: 2.006 ns(0%)\n concat with toString: 2.201 ns(-10%)\n toString: 237.494 ns(-11741%)\n toString with toString: 121.072 ns(-5937%)\n constructor: 2.201 ns(-10%)\n constructor with toString: 2.201 ns(-10%)\n toString mono: 14.536 ns(-625%)\n toString with toString mono: 9.757 ns(-386%)\n```\n\nFixes #38839.\n\nPR Close #39843",
    "sha": "11cd37fae304720d32b3f010f61ea7065d34b40b",
    "files": [
        {
            "sha": "872457fe9f889e1c12567ca28fee5b01d7578af5",
            "filename": "packages/core/src/render3/util/stringify_utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fstringify_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fstringify_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fstringify_utils.ts?ref=11cd37fae304720d32b3f010f61ea7065d34b40b",
            "patch": "@@ -10,11 +10,14 @@\n  * Used for stringify render output in Ivy.\n  * Important! This function is very performance-sensitive and we should\n  * be extra careful not to introduce megamorphic reads in it.\n+ * Check `core/test/render3/perf/render_stringify` for benchmarks and alternate implementations.\n  */\n export function renderStringify(value: any): string {\n   if (typeof value === 'string') return value;\n   if (value == null) return '';\n-  return '' + value;\n+  // Use `String` so that it invokes the `toString` method of the value. Note that this\n+  // appears to be faster than calling `value.toString` (see `render_stringify` benchmark).\n+  return String(value);\n }\n \n "
        },
        {
            "sha": "4d25f933335529481c8400875717f4faa8f216cf",
            "filename": "packages/core/test/acceptance/text_spec.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Ftest%2Facceptance%2Ftext_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Ftest%2Facceptance%2Ftext_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Ftext_spec.ts?ref=11cd37fae304720d32b3f010f61ea7065d34b40b",
            "patch": "@@ -129,4 +129,46 @@ describe('text instructions', () => {\n \n     expect(div.innerHTML).toBe('function foo() { }');\n   });\n+\n+  it('should stringify an object using its toString method', () => {\n+    class TestObject {\n+      toString() {\n+        return 'toString';\n+      }\n+      valueOf() {\n+        return 'valueOf';\n+      }\n+    }\n+\n+    @Component({template: '{{object}}'})\n+    class App {\n+      object = new TestObject();\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    expect(fixture.nativeElement.textContent).toBe('toString');\n+  });\n+\n+  it('should stringify a symbol', () => {\n+    // This test is only valid on browsers that support Symbol.\n+    if (typeof Symbol === 'undefined') {\n+      return;\n+    }\n+\n+    @Component({template: '{{symbol}}'})\n+    class App {\n+      symbol = Symbol('hello');\n+    }\n+\n+    TestBed.configureTestingModule({declarations: [App]});\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+\n+    // Note that this uses `toContain`, because a polyfilled `Symbol` produces something like\n+    // `Symbol(hello)_p.sc8s398cplk`, whereas the native one is `Symbol(hello)`.\n+    expect(fixture.nativeElement.textContent).toContain('Symbol(hello)');\n+  });\n });"
        },
        {
            "sha": "144b8f5eb77162531d9bf1e9848759f4ca2334ca",
            "filename": "packages/core/test/render3/perf/BUILD.bazel",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Ftest%2Frender3%2Fperf%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Ftest%2Frender3%2Fperf%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2FBUILD.bazel?ref=11cd37fae304720d32b3f010f61ea7065d34b40b",
            "patch": "@@ -255,3 +255,16 @@ ng_benchmark(\n     name = \"view_destroy_hook\",\n     bundle = \":view_destroy_hook_lib\",\n )\n+\n+ng_rollup_bundle(\n+    name = \"render_stringify_lib\",\n+    entry_point = \":render_stringify/index.ts\",\n+    deps = [\n+        \":perf_lib\",\n+    ],\n+)\n+\n+ng_benchmark(\n+    name = \"render_stringify\",\n+    bundle = \":render_stringify_lib\",\n+)"
        },
        {
            "sha": "c8547df7993873e8eaeaf0dde192e90dc726ae24",
            "filename": "packages/core/test/render3/perf/render_stringify/index.ts",
            "status": "added",
            "additions": 104,
            "deletions": 0,
            "changes": 104,
            "blob_url": "https://github.com/angular/angular/blob/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Frender_stringify%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/11cd37fae304720d32b3f010f61ea7065d34b40b/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Frender_stringify%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fperf%2Frender_stringify%2Findex.ts?ref=11cd37fae304720d32b3f010f61ea7065d34b40b",
            "patch": "@@ -0,0 +1,104 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {createBenchmark} from '../micro_bench';\n+\n+// These benchmarks compare various implementations of the `renderStringify` utility\n+// which vary in subtle ways which end up having an effect on performance.\n+\n+/** Uses string concatenation to convert a value into a string. */\n+function renderStringifyConcat(value: any): string {\n+  if (typeof value === 'string') return value;\n+  if (value == null) return '';\n+  return '' + value;\n+}\n+\n+/** Uses `toString` to convert a value into a string. */\n+function renderStringifyToString(value: any): string {\n+  if (typeof value === 'string') return value;\n+  if (value == null) return '';\n+  return value.toString();\n+}\n+\n+/** Uses the `String` constructor to convert a value into a string. */\n+function renderStringifyConstructor(value: any): string {\n+  if (typeof value === 'string') return value;\n+  if (value == null) return '';\n+  return String(value);\n+}\n+\n+const objects: any[] = [];\n+const objectsWithToString: any[] = [];\n+\n+// Allocate a bunch of objects with a unique structure.\n+for (let i = 0; i < 1000000; i++) {\n+  objects.push({['foo_' + i]: i});\n+  objectsWithToString.push({['foo_' + i]: i, toString: () => 'x'});\n+}\n+const max = objects.length - 1;\n+let i = 0;\n+\n+const benchmarkRefresh = createBenchmark('renderStringify');\n+const renderStringifyConcatTime = benchmarkRefresh('concat');\n+const renderStringifyConcatWithToStringTime = benchmarkRefresh('concat with toString');\n+const renderStringifyToStringTime = benchmarkRefresh('toString');\n+const renderStringifyToStringWithToStringTime = benchmarkRefresh('toString with toString');\n+const renderStringifyConstructorTime = benchmarkRefresh('constructor');\n+const renderStringifyConstructorWithToStringTime = benchmarkRefresh('constructor with toString');\n+const renderStringifyToStringMonoTime = benchmarkRefresh('toString mono');\n+const renderStringifyToStringWithToStringMonoTime = benchmarkRefresh('toString with toString mono');\n+\n+// Important! This code is somewhat repetitive, but we can't move it out into something like\n+// `benchmark(name, stringifyFn)`, because passing in the function as a parameter breaks inlining.\n+\n+// String concatenation\n+while (renderStringifyConcatTime()) {\n+  renderStringifyConcat(objects[i]);\n+  i = i < max ? i + 1 : 0;\n+}\n+\n+while (renderStringifyConcatWithToStringTime()) {\n+  renderStringifyConcat(objectsWithToString[i]);\n+  i = i < max ? i + 1 : 0;\n+}\n+/////////////\n+\n+// String()\n+while (renderStringifyConstructorTime()) {\n+  renderStringifyConstructor(objects[i]);\n+  i = i < max ? i + 1 : 0;\n+}\n+\n+while (renderStringifyConstructorWithToStringTime()) {\n+  renderStringifyConstructor(objectsWithToString[i]);\n+  i = i < max ? i + 1 : 0;\n+}\n+/////////////\n+\n+// toString\n+while (renderStringifyToStringTime()) {\n+  renderStringifyToString(objects[i]);\n+  i = i < max ? i + 1 : 0;\n+}\n+\n+while (renderStringifyToStringWithToStringTime()) {\n+  renderStringifyToString(objectsWithToString[i]);\n+  i = i < max ? i + 1 : 0;\n+}\n+/////////////\n+\n+// toString mono\n+while (renderStringifyToStringMonoTime()) {\n+  renderStringifyToString(objects[0]);\n+}\n+\n+while (renderStringifyToStringWithToStringMonoTime()) {\n+  renderStringifyToString(objectsWithToString[0]);\n+}\n+/////////////\n+\n+benchmarkRefresh.report();"
        }
    ],
    "stats": {
        "total": 164,
        "additions": 163,
        "deletions": 1
    }
}