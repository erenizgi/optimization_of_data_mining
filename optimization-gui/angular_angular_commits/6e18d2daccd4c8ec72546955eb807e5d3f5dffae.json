{
    "author": "bjarkler",
    "message": "fix(compiler): promote constants in templates to Trusted Types (#39211)\n\nAngular treats constant values of attributes and properties in templates\nas secure. This means that these values are not sanitized, and are\ninstead passed directly to the corresponding setAttribute or setProperty\nfunction. In cases where the given attribute or property is\nsecurity-sensitive, this causes a Trusted Types violation.\n\nTo address this, functions for promoting constant strings to each of the\nthree Trusted Types are introduced to Angular's private codegen API. The\ncompiler is updated to wrap constant strings with calls to these\nfunctions as appropriate when constructing the `consts` array. This is\nonly done for security-sensitive attributes and properties, as\nclassified by Angular's dom_security_schema.\n\nPR Close #39211",
    "sha": "6e18d2daccd4c8ec72546955eb807e5d3f5dffae",
    "files": [
        {
            "sha": "87e108d8e43d336954306313424de25432222471",
            "filename": "packages/compiler/src/render3/r3_identifiers.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts?ref=6e18d2daccd4c8ec72546955eb807e5d3f5dffae",
            "patch": "@@ -320,4 +320,9 @@ export class Identifiers {\n   static sanitizeUrl: o.ExternalReference = {name: 'ɵɵsanitizeUrl', moduleName: CORE};\n   static sanitizeUrlOrResourceUrl:\n       o.ExternalReference = {name: 'ɵɵsanitizeUrlOrResourceUrl', moduleName: CORE};\n+  static trustConstantHtml: o.ExternalReference = {name: 'ɵɵtrustConstantHtml', moduleName: CORE};\n+  static trustConstantScript:\n+      o.ExternalReference = {name: 'ɵɵtrustConstantScript', moduleName: CORE};\n+  static trustConstantResourceUrl:\n+      o.ExternalReference = {name: 'ɵɵtrustConstantResourceUrl', moduleName: CORE};\n }"
        },
        {
            "sha": "e71b84c05dd7fe3692efda565d8afd2ff4595852",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 7,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=6e18d2daccd4c8ec72546955eb807e5d3f5dffae",
            "patch": "@@ -568,7 +568,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n \n     const nonContentSelectAttributes =\n         ngContent.attributes.filter(attr => attr.name.toLowerCase() !== NG_CONTENT_SELECT_ATTR);\n-    const attributes = this.getAttributeExpressions(nonContentSelectAttributes, [], []);\n+    const attributes =\n+        this.getAttributeExpressions(ngContent.name, nonContentSelectAttributes, [], []);\n \n     if (attributes.length > 0) {\n       parameters.push(o.literal(projectionSlotIdx), o.literalArr(attributes));\n@@ -635,7 +636,7 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n \n     // add attributes for directive and projection matching purposes\n     const attributes: o.Expression[] = this.getAttributeExpressions(\n-        outputAttrs, allOtherInputs, element.outputs, stylingBuilder, [], i18nAttrs);\n+        element.name, outputAttrs, allOtherInputs, element.outputs, stylingBuilder, [], i18nAttrs);\n     parameters.push(this.addAttrsToConsts(attributes));\n \n     // local refs (ex.: <div #foo #bar=\"baz\">)\n@@ -867,8 +868,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n     // prepare attributes parameter (including attributes used for directive matching)\n     const [i18nStaticAttrs, staticAttrs] = partitionArray(template.attributes, hasI18nMeta);\n     const attrsExprs: o.Expression[] = this.getAttributeExpressions(\n-        staticAttrs, template.inputs, template.outputs, undefined /* styles */,\n-        template.templateAttrs, i18nStaticAttrs);\n+        NG_TEMPLATE_TAG_NAME, staticAttrs, template.inputs, template.outputs,\n+        undefined /* styles */, template.templateAttrs, i18nStaticAttrs);\n     parameters.push(this.addAttrsToConsts(attrsExprs));\n \n     // local refs (ex.: <ng-template #foo>)\n@@ -1285,8 +1286,9 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n    * because those values are intended to always be generated as property instructions.\n    */\n   private getAttributeExpressions(\n-      renderAttributes: t.TextAttribute[], inputs: t.BoundAttribute[], outputs: t.BoundEvent[],\n-      styles?: StylingBuilder, templateAttrs: (t.BoundAttribute|t.TextAttribute)[] = [],\n+      elementName: string, renderAttributes: t.TextAttribute[], inputs: t.BoundAttribute[],\n+      outputs: t.BoundEvent[], styles?: StylingBuilder,\n+      templateAttrs: (t.BoundAttribute|t.TextAttribute)[] = [],\n       i18nAttrs: (t.BoundAttribute|t.TextAttribute)[] = []): o.Expression[] {\n     const alreadySeen = new Set<string>();\n     const attrExprs: o.Expression[] = [];\n@@ -1296,7 +1298,8 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n       if (attr.name === NG_PROJECT_AS_ATTR_NAME) {\n         ngProjectAsAttr = attr;\n       }\n-      attrExprs.push(...getAttributeNameLiterals(attr.name), asLiteral(attr.value));\n+      attrExprs.push(\n+          ...getAttributeNameLiterals(attr.name), trustedConstAttribute(elementName, attr));\n     });\n \n     // Keep ngProjectAs next to the other name, value pairs so we can verify that we match\n@@ -2128,6 +2131,20 @@ export function resolveSanitizationFn(context: core.SecurityContext, isAttribute\n   }\n }\n \n+function trustedConstAttribute(tagName: string, attr: t.TextAttribute): o.Expression {\n+  const value = asLiteral(attr.value);\n+  switch (elementRegistry.securityContext(tagName, attr.name, /* isAttribute */ true)) {\n+    case core.SecurityContext.HTML:\n+      return o.importExpr(R3.trustConstantHtml).callFn([value], attr.valueSpan);\n+    case core.SecurityContext.SCRIPT:\n+      return o.importExpr(R3.trustConstantScript).callFn([value], attr.valueSpan);\n+    case core.SecurityContext.RESOURCE_URL:\n+      return o.importExpr(R3.trustConstantResourceUrl).callFn([value], attr.valueSpan);\n+    default:\n+      return value;\n+  }\n+}\n+\n function isSingleElementTemplate(children: t.Node[]): children is[t.Element] {\n   return children.length === 1 && children[0] instanceof t.Element;\n }"
        },
        {
            "sha": "07ccc60cf2fed42c00f994d4cb2a411a17c01850",
            "filename": "packages/core/src/core_render3_private_export.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts?ref=6e18d2daccd4c8ec72546955eb807e5d3f5dffae",
            "patch": "@@ -290,6 +290,9 @@ export {\n   ɵɵsanitizeStyle,\n   ɵɵsanitizeUrl,\n   ɵɵsanitizeUrlOrResourceUrl,\n+  ɵɵtrustConstantHtml,\n+  ɵɵtrustConstantResourceUrl,\n+  ɵɵtrustConstantScript,\n } from './sanitization/sanitization';\n export {\n   noSideEffects as ɵnoSideEffects,"
        },
        {
            "sha": "9f028b1d43eb4e14b7609b528afbe4984ded2f13",
            "filename": "packages/core/src/render3/jit/environment.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fenvironment.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fenvironment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fenvironment.ts?ref=6e18d2daccd4c8ec72546955eb807e5d3f5dffae",
            "patch": "@@ -166,4 +166,7 @@ export const angularCoreEnv: {[name: string]: Function} =\n        'ɵɵsanitizeScript': sanitization.ɵɵsanitizeScript,\n        'ɵɵsanitizeUrl': sanitization.ɵɵsanitizeUrl,\n        'ɵɵsanitizeUrlOrResourceUrl': sanitization.ɵɵsanitizeUrlOrResourceUrl,\n+       'ɵɵtrustConstantHtml': sanitization.ɵɵtrustConstantHtml,\n+       'ɵɵtrustConstantScript': sanitization.ɵɵtrustConstantScript,\n+       'ɵɵtrustConstantResourceUrl': sanitization.ɵɵtrustConstantResourceUrl,\n      }))();"
        },
        {
            "sha": "49b151a1e0e6cc1f8bfa5dbedd3cfa2fbaf59cb3",
            "filename": "packages/core/src/sanitization/sanitization.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e18d2daccd4c8ec72546955eb807e5d3f5dffae/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts?ref=6e18d2daccd4c8ec72546955eb807e5d3f5dffae",
            "patch": "@@ -10,6 +10,8 @@ import {getDocument} from '../render3/interfaces/document';\n import {SANITIZER} from '../render3/interfaces/view';\n import {getLView} from '../render3/state';\n import {renderStringify} from '../render3/util/misc_utils';\n+import {TrustedHTML, TrustedScript, TrustedScriptURL} from '../util/security/trusted_type_defs';\n+import {trustedHTMLFromString, trustedScriptFromString, trustedScriptURLFromString} from '../util/security/trusted_types';\n \n import {allowSanitizationBypassAndThrow, BypassType, unwrapSafeValue} from './bypass';\n import {_sanitizeHtml as _sanitizeHtml} from './html_sanitizer';\n@@ -139,6 +141,51 @@ export function ɵɵsanitizeScript(unsafeScript: any): string {\n   throw new Error('unsafe value used in a script context');\n }\n \n+/**\n+ * Promotes the given constant string to a TrustedHTML.\n+ * @param html constant string containing trusted HTML.\n+ * @returns TrustedHTML wrapping `html`.\n+ *\n+ * @security This is a security-sensitive function and should only be used to\n+ * convert constant values of attributes and properties found in\n+ * application-provided Angular templates to TrustedHTML.\n+ *\n+ * @codeGenApi\n+ */\n+export function ɵɵtrustConstantHtml(html: string): TrustedHTML|string {\n+  return trustedHTMLFromString(html);\n+}\n+\n+/**\n+ * Promotes the given constant string to a TrustedScript.\n+ * @param script constant string containing a trusted script.\n+ * @returns TrustedScript wrapping `script`.\n+ *\n+ * @security This is a security-sensitive function and should only be used to\n+ * convert constant values of attributes and properties found in\n+ * application-provided Angular templates to TrustedScript.\n+ *\n+ * @codeGenApi\n+ */\n+export function ɵɵtrustConstantScript(script: string): TrustedScript|string {\n+  return trustedScriptFromString(script);\n+}\n+\n+/**\n+ * Promotes the given constant string to a TrustedScriptURL.\n+ * @param url constant string containing a trusted script URL.\n+ * @returns TrustedScriptURL wrapping `url`.\n+ *\n+ * @security This is a security-sensitive function and should only be used to\n+ * convert constant values of attributes and properties found in\n+ * application-provided Angular templates to TrustedScriptURL.\n+ *\n+ * @codeGenApi\n+ */\n+export function ɵɵtrustConstantResourceUrl(url: string): TrustedScriptURL|string {\n+  return trustedScriptURLFromString(url);\n+}\n+\n /**\n  * Detects which sanitizer to use for URL property, based on tag name and prop name.\n  *"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 82,
        "deletions": 7
    }
}