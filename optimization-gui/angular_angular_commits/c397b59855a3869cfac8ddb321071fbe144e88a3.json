{
    "author": "gkalpak",
    "message": "test(docs-infra): ensure all redirect rules are tested (#42452)\n\nThis commit adds a test assertion to verify that all redirect rules\ndefined in `firebase.json` are tested, i.e. that each rule is applied to\nat least one testcase from `URLS_TO_REDIRECT.txt`.\n\nThis will ensure that any redirect rules added in the future will be\ntested.\n\nPR Close #42452",
    "sha": "c397b59855a3869cfac8ddb321071fbe144e88a3",
    "files": [
        {
            "sha": "fd0c0a6ba64c9486eea84dbf9ff01a33c3e70eb8",
            "filename": "aio/tests/deployment/shared/helpers.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftests%2Fdeployment%2Fshared%2Fhelpers.ts",
            "raw_url": "https://github.com/angular/angular/raw/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftests%2Fdeployment%2Fshared%2Fhelpers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Fshared%2Fhelpers.ts?ref=c397b59855a3869cfac8ddb321071fbe144e88a3",
            "patch": "@@ -12,6 +12,7 @@ import { FirebaseRedirector, FirebaseRedirectConfig } from '../../../tools/fireb\n \n \n const AIO_DIR = resolvePath(__dirname, '../../..');\n+export const PATH_TO_LEGACY_URLS = resolvePath(__dirname, 'URLS_TO_REDIRECT.txt');\n \n export function getRedirector() {\n   return new FirebaseRedirector(loadRedirects());\n@@ -40,8 +41,7 @@ export function loadRedirects(): FirebaseRedirectConfig[] {\n }\n \n export function loadLegacyUrls() {\n-  const pathToLegacyUrls = `${__dirname}/URLS_TO_REDIRECT.txt`;\n-  const urls = readFileSync(pathToLegacyUrls, 'utf8')\n+  const urls = readFileSync(PATH_TO_LEGACY_URLS, 'utf8')\n       .split('\\n')\n       .filter(line => line.trim() !== '')\n       .map(line => line.split(/\\s*-->\\s*/));"
        },
        {
            "sha": "531ec16ed9203e62c2bdf4b8ec2f315d624c0bb8",
            "filename": "aio/tests/deployment/unit/testFirebaseRedirection.spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftests%2Fdeployment%2Funit%2FtestFirebaseRedirection.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftests%2Fdeployment%2Funit%2FtestFirebaseRedirection.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Funit%2FtestFirebaseRedirection.spec.ts?ref=c397b59855a3869cfac8ddb321071fbe144e88a3",
            "patch": "@@ -1,4 +1,6 @@\n-import { getRedirector, loadLegacyUrls, loadLocalSitemapUrls, loadRedirects } from '../shared/helpers';\n+import {\n+  getRedirector, loadLegacyUrls, loadLocalSitemapUrls, loadRedirects, PATH_TO_LEGACY_URLS,\n+} from '../shared/helpers';\n \n describe('firebase.json redirect config', () => {\n   describe('with sitemap urls', () => {\n@@ -14,6 +16,14 @@ describe('firebase.json redirect config', () => {\n   describe('with legacy urls', () => {\n     const redirector = getRedirector();\n \n+    afterAll(() => {\n+      expect(redirector.unusedRedirectConfigs)\n+          .withContext(\n+              'Some redirect rules from \\'firebase.json\\' were not tested. ' +\n+              `Ensure there is at least one testcase for each redirect rule in '${PATH_TO_LEGACY_URLS}'.`)\n+          .toEqual([]);\n+    });\n+\n     loadLegacyUrls().forEach(urlPair => {\n       it(`should redirect legacy URL '${urlPair[0]}'`, () => {\n         const redirected = redirector.redirect(urlPair[0]);"
        },
        {
            "sha": "69c85f45cf3f8de8baf161746fcc4b22fb5752ce",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirect.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.ts",
            "raw_url": "https://github.com/angular/angular/raw/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirect.ts?ref=c397b59855a3869cfac8ddb321071fbe144e88a3",
            "patch": "@@ -6,7 +6,8 @@ export class FirebaseRedirect {\n   source: FirebaseRedirectSource;\n   destination: string;\n \n-  constructor({source, regex, destination}: FirebaseRedirectConfig) {\n+  constructor(readonly rawConfig: FirebaseRedirectConfig) {\n+    const {source, regex, destination} = rawConfig;\n     this.source = (typeof source === 'string') ?\n       FirebaseRedirectSource.fromGlobPattern(source) :\n       FirebaseRedirectSource.fromRegexPattern(regex!);"
        },
        {
            "sha": "03729967de12a44e309e7f0a87b820a4318032ff",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirector.spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.spec.ts?ref=c397b59855a3869cfac8ddb321071fbe144e88a3",
            "patch": "@@ -39,4 +39,25 @@ describe('FirebaseRedirector', () => {\n     ]);\n     expect(() => redirector.redirect('a')).toThrowError('infinite redirect loop');\n   });\n+\n+  it('should keep track of unused redirects', () => {\n+    const redirects = [\n+      { source: '/a', destination: '/A' },\n+      { regex: '^/b$', destination: '/B' },\n+      { source: '/c', destination: '/C' },\n+    ];\n+    const redirector = new FirebaseRedirector(redirects);\n+\n+    expect(redirector.unusedRedirectConfigs).toEqual([redirects[0], redirects[1], redirects[2]]);\n+\n+    redirector.redirect('/a');\n+    expect(redirector.unusedRedirectConfigs).toEqual([redirects[1], redirects[2]]);\n+\n+    redirector.redirect('/not-redirected');\n+    expect(redirector.unusedRedirectConfigs).toEqual([redirects[1], redirects[2]]);\n+\n+    redirector.redirect('/b');\n+    redirector.redirect('/c');\n+    expect(redirector.unusedRedirectConfigs).toEqual([]);\n+  });\n });"
        },
        {
            "sha": "d33c4c17062ce9f9ef6a7f531bdf5492f8f3b4cf",
            "filename": "aio/tools/firebase-test-utils/FirebaseRedirector.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.ts",
            "raw_url": "https://github.com/angular/angular/raw/c397b59855a3869cfac8ddb321071fbe144e88a3/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ffirebase-test-utils%2FFirebaseRedirector.ts?ref=c397b59855a3869cfac8ddb321071fbe144e88a3",
            "patch": "@@ -6,8 +6,15 @@ export type FirebaseRedirectConfig =\n \n export class FirebaseRedirector {\n   private redirects: FirebaseRedirect[];\n+  private unusedRedirects: Set<FirebaseRedirect>;\n+\n+  get unusedRedirectConfigs(): FirebaseRedirectConfig[] {\n+    return [...this.unusedRedirects].map(({rawConfig}) => rawConfig);\n+  }\n+\n   constructor(redirects: FirebaseRedirectConfig[]) {\n     this.redirects = redirects.map(redirect => new FirebaseRedirect(redirect));\n+    this.unusedRedirects = new Set(this.redirects);\n   }\n \n   redirect(url: string): string {\n@@ -28,6 +35,7 @@ export class FirebaseRedirector {\n     for (const redirect of this.redirects) {\n       const newUrl = redirect.replace(url);\n       if (newUrl !== undefined) {\n+        this.unusedRedirects.delete(redirect);\n         return newUrl;\n       }\n     }"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 44,
        "deletions": 4
    }
}