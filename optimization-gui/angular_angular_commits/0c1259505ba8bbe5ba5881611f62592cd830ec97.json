{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): use a shared function for gathering factory metadata. (#41231)\n\nEach of the annotations had its own function for doing this, and those\nmethods were generally employing spread operators that could allow\nunwanted properties to leak into the factory metadata object.\n\nThis commit supplies a shared function `toFactoryMetadata()` that\navoids this spread of properties into the returned function.\n\nPR Close #41231",
    "sha": "0c1259505ba8bbe5ba5881611f62592cd830ec97",
    "files": [
        {
            "sha": "16c57a1bf85553784c9f944b1a0dbc9e74c369be",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=0c1259505ba8bbe5ba5881611f62592cd830ec97",
            "patch": "@@ -32,7 +32,7 @@ import {DirectiveSymbol, extractDirectiveMetadata, parseFieldArrayValue} from '.\n import {compileDeclareFactory, compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n import {NgModuleSymbol} from './ng_module';\n-import {compileResults, findAngularDecorator, isAngularCoreReference, isExpressionForwardReference, readBaseClass, resolveProvidersRequiringFactory, unwrapExpression, wrapFunctionExpressionsInParens} from './util';\n+import {compileResults, findAngularDecorator, isAngularCoreReference, isExpressionForwardReference, readBaseClass, resolveProvidersRequiringFactory, toFactoryMetadata, unwrapExpression, wrapFunctionExpressionsInParens} from './util';\n \n const EMPTY_MAP = new Map<string, Expression>();\n const EMPTY_ARRAY: any[] = [];\n@@ -833,7 +833,7 @@ export class ComponentDecoratorHandler implements\n       return [];\n     }\n     const meta: R3ComponentMetadata = {...analysis.meta, ...resolution};\n-    const fac = compileNgFactoryDefField(toComponentFactoryMetadata(meta));\n+    const fac = compileNgFactoryDefField(toFactoryMetadata(meta, R3FactoryTarget.Component));\n     const def = compileComponentFromMetadata(meta, pool, makeBindingParser());\n     return compileResults(fac, def, analysis.metadataStmt, 'ɵcmp');\n   }\n@@ -845,7 +845,7 @@ export class ComponentDecoratorHandler implements\n       return [];\n     }\n     const meta: R3ComponentMetadata = {...analysis.meta, ...resolution};\n-    const fac = compileDeclareFactory(toComponentFactoryMetadata(meta));\n+    const fac = compileDeclareFactory(toFactoryMetadata(meta, R3FactoryTarget.Component));\n     const def = compileDeclareComponentFromMetadata(meta, analysis.template);\n     return compileResults(fac, def, analysis.metadataStmt, 'ɵcmp');\n   }\n@@ -1390,7 +1390,3 @@ function makeCyclicImportInfo(\n       `The ${type} '${name}' is used in the template but importing it would create a cycle: `;\n   return makeRelatedInformation(ref.node, message + path);\n }\n-\n-function toComponentFactoryMetadata(meta: R3ComponentMetadata): R3FactoryMetadata {\n-  return {...meta, target: R3FactoryTarget.Component};\n-}"
        },
        {
            "sha": "14b2a71d6f39adaf0c99ed17177bdf55d40c7bed",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/directive.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts?ref=0c1259505ba8bbe5ba5881611f62592cd830ec97",
            "patch": "@@ -24,7 +24,7 @@ import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFl\n import {createValueHasWrongTypeError, getDirectiveDiagnostics, getProviderDiagnostics, getUndecoratedClassWithAngularFeaturesDiagnostic} from './diagnostics';\n import {compileDeclareFactory, compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n-import {compileResults, createSourceSpan, findAngularDecorator, getConstructorDependencies, isAngularDecorator, readBaseClass, resolveProvidersRequiringFactory, unwrapConstructorDependencies, unwrapExpression, unwrapForwardRef, validateConstructorDependencies, wrapFunctionExpressionsInParens, wrapTypeReference} from './util';\n+import {compileResults, createSourceSpan, findAngularDecorator, getConstructorDependencies, isAngularDecorator, readBaseClass, resolveProvidersRequiringFactory, toFactoryMetadata, unwrapConstructorDependencies, unwrapExpression, unwrapForwardRef, validateConstructorDependencies, wrapFunctionExpressionsInParens, wrapTypeReference} from './util';\n \n const EMPTY_OBJECT: {[key: string]: string} = {};\n const FIELD_DECORATORS = [\n@@ -302,15 +302,16 @@ export class DirectiveDecoratorHandler implements\n   compileFull(\n       node: ClassDeclaration, analysis: Readonly<DirectiveHandlerData>,\n       resolution: Readonly<unknown>, pool: ConstantPool): CompileResult[] {\n-    const fac = compileNgFactoryDefField(toDirectiveFactoryMetadata(analysis.meta));\n+    const fac =\n+        compileNgFactoryDefField(toFactoryMetadata(analysis.meta, R3FactoryTarget.Directive));\n     const def = compileDirectiveFromMetadata(analysis.meta, pool, makeBindingParser());\n     return compileResults(fac, def, analysis.metadataStmt, 'ɵdir');\n   }\n \n   compilePartial(\n       node: ClassDeclaration, analysis: Readonly<DirectiveHandlerData>,\n       resolution: Readonly<unknown>): CompileResult[] {\n-    const fac = compileDeclareFactory(toDirectiveFactoryMetadata(analysis.meta));\n+    const fac = compileDeclareFactory(toFactoryMetadata(analysis.meta, R3FactoryTarget.Directive));\n     const def = compileDeclareDirectiveFromMetadata(analysis.meta);\n     return compileResults(fac, def, analysis.metadataStmt, 'ɵdir');\n   }\n@@ -919,7 +920,3 @@ const QUERY_TYPES = new Set([\n   'ViewChild',\n   'ViewChildren',\n ]);\n-\n-function toDirectiveFactoryMetadata(meta: R3DirectiveMetadata): R3FactoryMetadata {\n-  return {...meta, target: R3FactoryTarget.Directive};\n-}"
        },
        {
            "sha": "1e63bf0d30481c07c617abd71c728d317e700b3b",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 17,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts?ref=0c1259505ba8bbe5ba5881611f62592cd830ec97",
            "patch": "@@ -18,7 +18,7 @@ import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerPr\n \n import {compileDeclareFactory, compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n-import {findAngularDecorator, getConstructorDependencies, getValidConstructorDependencies, isAngularCore, unwrapConstructorDependencies, unwrapForwardRef, validateConstructorDependencies, wrapTypeReference} from './util';\n+import {findAngularDecorator, getConstructorDependencies, getValidConstructorDependencies, isAngularCore, toFactoryMetadata, unwrapConstructorDependencies, unwrapForwardRef, validateConstructorDependencies, wrapTypeReference} from './util';\n \n export interface InjectableHandlerData {\n   meta: R3InjectableMetadata;\n@@ -101,8 +101,8 @@ export class InjectableDecoratorHandler implements\n \n     if (analysis.needsFactory) {\n       const meta = analysis.meta;\n-      const factoryRes =\n-          compileNgFactoryDefField(toInjectableFactoryMetadata(meta, analysis.ctorDeps));\n+      const factoryRes = compileNgFactoryDefField(\n+          toFactoryMetadata({...meta, deps: analysis.ctorDeps}, R3FactoryTarget.Injectable));\n       if (analysis.metadataStmt !== null) {\n         factoryRes.statements.push(analysis.metadataStmt);\n       }\n@@ -133,8 +133,8 @@ export class InjectableDecoratorHandler implements\n \n     if (analysis.needsFactory) {\n       const meta = analysis.meta;\n-      const factoryRes =\n-          compileDeclareFactory(toInjectableFactoryMetadata(meta, analysis.ctorDeps));\n+      const factoryRes = compileDeclareFactory(\n+          toFactoryMetadata({...meta, deps: analysis.ctorDeps}, R3FactoryTarget.Injectable));\n       if (analysis.metadataStmt !== null) {\n         factoryRes.statements.push(analysis.metadataStmt);\n       }\n@@ -157,18 +157,6 @@ export class InjectableDecoratorHandler implements\n   }\n }\n \n-function toInjectableFactoryMetadata(\n-    meta: R3InjectableMetadata, deps: R3DependencyMetadata[]|'invalid'|null): R3FactoryMetadata {\n-  return {\n-    name: meta.name,\n-    type: meta.type,\n-    internalType: meta.internalType,\n-    typeArgumentCount: meta.typeArgumentCount,\n-    deps,\n-    target: R3FactoryTarget.Injectable,\n-  };\n-}\n-\n /**\n  * Read metadata from the `@Injectable` decorator and produce the `IvyInjectableMetadata`, the\n  * input metadata needed to run `compileIvyInjectable`."
        },
        {
            "sha": "36300760149006b4d213539700a907122f325c4c",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/pipe.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fpipe.ts",
            "raw_url": "https://github.com/angular/angular/raw/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fpipe.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fpipe.ts?ref=0c1259505ba8bbe5ba5881611f62592cd830ec97",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileDeclarePipeFromMetadata, compilePipeFromMetadata, R3FactoryMetadata, R3FactoryTarget, R3PipeMetadata, Statement, WrappedNodeExpr} from '@angular/compiler';\n+import {compileDeclarePipeFromMetadata, compilePipeFromMetadata, R3FactoryTarget, R3PipeMetadata, Statement, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError} from '../../diagnostics';\n@@ -22,7 +22,7 @@ import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerPr\n import {createValueHasWrongTypeError} from './diagnostics';\n import {compileDeclareFactory, compileNgFactoryDefField} from './factory';\n import {generateSetClassMetadataCall} from './metadata';\n-import {compileResults, findAngularDecorator, getValidConstructorDependencies, makeDuplicateDeclarationError, unwrapExpression, wrapTypeReference} from './util';\n+import {compileResults, findAngularDecorator, getValidConstructorDependencies, makeDuplicateDeclarationError, toFactoryMetadata, unwrapExpression, wrapTypeReference} from './util';\n \n export interface PipeHandlerData {\n   meta: R3PipeMetadata;\n@@ -165,18 +165,14 @@ export class PipeDecoratorHandler implements\n   }\n \n   compileFull(node: ClassDeclaration, analysis: Readonly<PipeHandlerData>): CompileResult[] {\n-    const fac = compileNgFactoryDefField(toPipeFactoryMetadata(analysis.meta));\n+    const fac = compileNgFactoryDefField(toFactoryMetadata(analysis.meta, R3FactoryTarget.Pipe));\n     const def = compilePipeFromMetadata(analysis.meta);\n     return compileResults(fac, def, analysis.metadataStmt, 'ɵpipe');\n   }\n \n   compilePartial(node: ClassDeclaration, analysis: Readonly<PipeHandlerData>): CompileResult[] {\n-    const fac = compileDeclareFactory(toPipeFactoryMetadata(analysis.meta));\n+    const fac = compileDeclareFactory(toFactoryMetadata(analysis.meta, R3FactoryTarget.Pipe));\n     const def = compileDeclarePipeFromMetadata(analysis.meta);\n     return compileResults(fac, def, analysis.metadataStmt, 'ɵpipe');\n   }\n }\n-\n-function toPipeFactoryMetadata(meta: R3PipeMetadata): R3FactoryMetadata {\n-  return {...meta, target: R3FactoryTarget.Pipe};\n-}"
        },
        {
            "sha": "f1ddbb2e729462b81cf76c474b112620b6210d48",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/util.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/0c1259505ba8bbe5ba5881611f62592cd830ec97/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Futil.ts?ref=0c1259505ba8bbe5ba5881611f62592cd830ec97",
            "patch": "@@ -7,6 +7,8 @@\n  */\n \n import {Expression, ExternalExpr, LiteralExpr, ParseLocation, ParseSourceFile, ParseSourceSpan, R3CompiledExpression, R3DependencyMetadata, R3Reference, ReadPropExpr, Statement, WrappedNodeExpr} from '@angular/compiler';\n+import {R3FactoryMetadata} from '@angular/compiler/src/compiler';\n+import {R3FactoryTarget} from '@angular/compiler/src/render3/partial/api';\n import * as ts from 'typescript';\n \n import {ErrorCode, FatalDiagnosticError, makeDiagnostic, makeRelatedInformation} from '../../diagnostics';\n@@ -579,3 +581,15 @@ export function compileResults(\n     }\n   ];\n }\n+\n+export function toFactoryMetadata(\n+    meta: Omit<R3FactoryMetadata, 'target'>, target: R3FactoryTarget): R3FactoryMetadata {\n+  return {\n+    name: meta.name,\n+    type: meta.type,\n+    internalType: meta.internalType,\n+    typeArgumentCount: meta.typeArgumentCount,\n+    deps: meta.deps,\n+    target\n+  };\n+}"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 30,
        "deletions": 39
    }
}