{
    "author": "mgechev",
    "message": "fix(devtools): make sure we update the property explorer on state change (rangle/angular-devtools#821)\n\nFix rangle/angular-devtools#786\r\n\r\nWith this PR now we consider not only the property name but also the\r\nvalue of properties in the differ comparison.\r\n\r\nThe change also contains e2e and unit tests.",
    "sha": "dfc4437afdc04e970ed617a31487ec788cb5daf5",
    "files": [
        {
            "sha": "499b3bbafb1cf8d498b3ebe2c038ddac6234515a",
            "filename": "cypress/integration/property-update.e2e.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/dfc4437afdc04e970ed617a31487ec788cb5daf5/cypress%2Fintegration%2Fproperty-update.e2e.js",
            "raw_url": "https://github.com/angular/angular/raw/dfc4437afdc04e970ed617a31487ec788cb5daf5/cypress%2Fintegration%2Fproperty-update.e2e.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/cypress%2Fintegration%2Fproperty-update.e2e.js?ref=dfc4437afdc04e970ed617a31487ec788cb5daf5",
            "patch": "@@ -0,0 +1,26 @@\n+describe('change of the state should reflect in property update', () => {\n+  beforeEach(() => {\n+    cy.visit('/');\n+  });\n+\n+  it('should update the property value', () => {\n+    // Complete the todo\n+    cy.enter('#sample-app').then((getBody) => {\n+      getBody().find('input[type=\"checkbox\"].toggle').first().click();\n+    });\n+\n+    // Select the todo item\n+    cy.get('.tree-wrapper').find('.tree-node:contains(\"app-todo[TooltipDirective]\")').first().click({ force: true });\n+\n+    // Expand the todo in the property explorer\n+    cy.get('.explorer-panel:contains(\"app-todo\")').find('ng-property-view mat-tree-node:contains(\"todo\")').click();\n+\n+    // Verify its value is now completed\n+    cy.get('.explorer-panel:contains(\"app-todo\")')\n+      .find('ng-property-view mat-tree-node:contains(\"completed\")')\n+      .find('ng-property-editor .editor')\n+      .should((el) => {\n+        expect(el.text().trim()).equal('true');\n+      });\n+  });\n+});"
        },
        {
            "sha": "7d62e2b6edc9a09b7f3c7fb52243713858cb38d6",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/directive-explorer/property-resolver/directive-property-resolver.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 38,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fdirective-property-resolver.ts",
            "raw_url": "https://github.com/angular/angular/raw/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fdirective-property-resolver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fdirective-property-resolver.ts?ref=dfc4437afdc04e970ed617a31487ec788cb5daf5",
            "patch": "@@ -1,28 +1,16 @@\n-import { Descriptor, PropType, MessageBus, Events, Properties, DirectivePosition, NestedProp } from 'protocol';\n-import { MatTreeFlattener } from '@angular/material/tree';\n+import { Descriptor, MessageBus, Events, Properties, DirectivePosition, NestedProp } from 'protocol';\n import { PropertyDataSource } from './property-data-source';\n import { FlatTreeControl } from '@angular/cdk/tree';\n import { getExpandedDirectiveProperties } from './property-expanded-directive-properties';\n-import { Observable } from 'rxjs';\n import { Property, FlatNode } from './element-property-resolver';\n import { ViewEncapsulation } from '@angular/core';\n-import { arrayifyProps } from './arrayify-props';\n+import { getTreeFlattener } from './flatten';\n \n export interface DirectiveTreeData {\n   dataSource: PropertyDataSource;\n   treeControl: FlatTreeControl<FlatNode>;\n }\n \n-const expandable = (prop: Descriptor) => {\n-  if (!prop) {\n-    return false;\n-  }\n-  if (!prop.expandable) {\n-    return false;\n-  }\n-  return !(prop.type !== PropType.Object && prop.type !== PropType.Array);\n-};\n-\n const getDirectiveControls = (\n   dataSource: PropertyDataSource\n ): { dataSource: PropertyDataSource; treeControl: FlatTreeControl<FlatNode> } => {\n@@ -43,18 +31,7 @@ export const constructPathOfKeysToPropertyValue = (nodePropToGetKeysFor: Propert\n };\n \n export class DirectivePropertyResolver {\n-  private _treeFlattener = new MatTreeFlattener(\n-    (node: Property, level: number): FlatNode => {\n-      return {\n-        expandable: expandable(node.descriptor),\n-        prop: node,\n-        level,\n-      };\n-    },\n-    (node) => node.level,\n-    (node) => node.expandable,\n-    (node) => this._getChildren(node)\n-  );\n+  private _treeFlattener = getTreeFlattener();\n \n   private _treeControl = new FlatTreeControl<FlatNode>(\n     (node) => node.level,\n@@ -125,18 +102,6 @@ export class DirectivePropertyResolver {\n     node.prop.descriptor.value = newValue;\n   }\n \n-  private _getChildren(prop: Property): Property[] | undefined {\n-    const descriptor = prop.descriptor;\n-    if (\n-      (descriptor.type === PropType.Object || descriptor.type === PropType.Array) &&\n-      !(descriptor.value instanceof Observable)\n-    ) {\n-      return arrayifyProps(descriptor.value || {}, prop);\n-    } else {\n-      console.error('Unexpected data type', descriptor, 'in property', prop);\n-    }\n-  }\n-\n   private _initDataSources(): void {\n     const { inputProps, outputProps, stateProps } = this._classifyProperties();\n "
        },
        {
            "sha": "63a09bf111eece4a20df5edb54ee2d3407ec189e",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/directive-explorer/property-resolver/flatten.ts",
            "status": "added",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fflatten.ts",
            "raw_url": "https://github.com/angular/angular/raw/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fflatten.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fflatten.ts?ref=dfc4437afdc04e970ed617a31487ec788cb5daf5",
            "patch": "@@ -0,0 +1,41 @@\n+import { MatTreeFlattener } from '@angular/material/tree';\n+import { Descriptor, PropType } from 'protocol';\n+import { Observable } from 'rxjs';\n+import { arrayifyProps } from './arrayify-props';\n+import { FlatNode, Property } from './element-property-resolver';\n+\n+export const getTreeFlattener = () =>\n+  new MatTreeFlattener(\n+    (node: Property, level: number): FlatNode => {\n+      return {\n+        expandable: expandable(node.descriptor),\n+        prop: node,\n+        level,\n+      };\n+    },\n+    (node) => node.level,\n+    (node) => node.expandable,\n+    (node) => getChildren(node)\n+  );\n+\n+export const expandable = (prop: Descriptor) => {\n+  if (!prop) {\n+    return false;\n+  }\n+  if (!prop.expandable) {\n+    return false;\n+  }\n+  return !(prop.type !== PropType.Object && prop.type !== PropType.Array);\n+};\n+\n+const getChildren = (prop: Property): Property[] | undefined => {\n+  const descriptor = prop.descriptor;\n+  if (\n+    (descriptor.type === PropType.Object || descriptor.type === PropType.Array) &&\n+    !(descriptor.value instanceof Observable)\n+  ) {\n+    return arrayifyProps(descriptor.value || {}, prop);\n+  } else {\n+    console.error('Unexpected data type', descriptor, 'in property', prop);\n+  }\n+};"
        },
        {
            "sha": "527161aed5c3a585d6712bf324c5cc5663e10f90",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/directive-explorer/property-resolver/property-data-source.spec.ts",
            "status": "added",
            "additions": 58,
            "deletions": 0,
            "changes": 58,
            "blob_url": "https://github.com/angular/angular/blob/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fproperty-data-source.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fproperty-data-source.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fproperty-data-source.spec.ts?ref=dfc4437afdc04e970ed617a31487ec788cb5daf5",
            "patch": "@@ -0,0 +1,58 @@\n+import { FlatTreeControl } from '@angular/cdk/tree';\n+import { PropType } from 'protocol';\n+import { FlatNode } from './element-property-resolver';\n+import { getTreeFlattener } from './flatten';\n+import { PropertyDataSource } from './property-data-source';\n+\n+const flatTreeControl = new FlatTreeControl<FlatNode>(\n+  (node) => node.level,\n+  (node) => node.expandable\n+);\n+\n+describe('PropertyDataSource', () => {\n+  it('should detect changes in the collection', () => {\n+    const source = new PropertyDataSource(\n+      {\n+        foo: {\n+          editable: true,\n+          expandable: false,\n+          preview: '42',\n+          type: PropType.Number,\n+          value: 42,\n+        },\n+      },\n+      getTreeFlattener(),\n+      flatTreeControl,\n+      { element: [1, 2, 3] },\n+      null as any\n+    );\n+\n+    source.update({\n+      foo: {\n+        editable: true,\n+        expandable: false,\n+        preview: '43',\n+        type: PropType.Number,\n+        value: 43,\n+      },\n+    });\n+\n+    expect(source.data).toEqual([\n+      {\n+        expandable: false,\n+        level: 0,\n+        prop: {\n+          descriptor: {\n+            editable: true,\n+            expandable: false,\n+            preview: '43',\n+            type: PropType.Number,\n+            value: 43,\n+          },\n+          name: 'foo',\n+          parent: null,\n+        },\n+      },\n+    ]);\n+  });\n+});"
        },
        {
            "sha": "0c58a25e53e91f7b1b6cb92e38869eabc4d2b395",
            "filename": "projects/ng-devtools/src/lib/devtools-tabs/directive-explorer/property-resolver/property-data-source.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fproperty-data-source.ts",
            "raw_url": "https://github.com/angular/angular/raw/dfc4437afdc04e970ed617a31487ec788cb5daf5/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fproperty-data-source.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools%2Fsrc%2Flib%2Fdevtools-tabs%2Fdirective-explorer%2Fproperty-resolver%2Fproperty-data-source.ts?ref=dfc4437afdc04e970ed617a31487ec788cb5daf5",
            "patch": "@@ -9,9 +9,7 @@ import { diff } from '../../diffing';\n import { FlatNode, Property } from './element-property-resolver';\n import { arrayifyProps } from './arrayify-props';\n \n-const trackBy = (_: number, item: FlatNode) => {\n-  return `#${item.prop.name}#${item.level}`;\n-};\n+const trackBy = (_: number, item: FlatNode) => `#${item.prop.name}#${item.prop.descriptor.preview}#${item.level}`;\n \n export class PropertyDataSource extends DataSource<FlatNode> {\n   private _data = new BehaviorSubject<FlatNode[]>([]);"
        }
    ],
    "stats": {
        "total": 170,
        "additions": 129,
        "deletions": 41
    }
}