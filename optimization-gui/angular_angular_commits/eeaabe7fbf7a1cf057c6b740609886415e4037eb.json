{
    "author": "crisbeto",
    "message": "fix(compiler-cli): incorrectly interpreting $any calls with a property read (#44657)\n\nThis was flagged during the code review of #44580. When generating a type check block, we were interpreting any call to `$any` as an `as any` cast, even if it's part of a `PropertyRead` (e.g. `foo.$any(1)`). This is handled correctly in other parts of the compiler, but it looks like it was missed in the type checker.\n\nPR Close #44657",
    "sha": "eeaabe7fbf7a1cf057c6b740609886415e4037eb",
    "files": [
        {
            "sha": "3331f20ed33abbff7e2191e50d1bc7b64c92bfc7",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/eeaabe7fbf7a1cf057c6b740609886415e4037eb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/eeaabe7fbf7a1cf057c6b740609886415e4037eb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=eeaabe7fbf7a1cf057c6b740609886415e4037eb",
            "patch": "@@ -1728,11 +1728,12 @@ class TcbExpressionTranslator {\n       return result;\n     } else if (\n         ast instanceof Call &&\n-        (ast.receiver instanceof PropertyRead || ast.receiver instanceof SafePropertyRead) &&\n-        !(ast.receiver.receiver instanceof ThisReceiver)) {\n+        (ast.receiver instanceof PropertyRead || ast.receiver instanceof SafePropertyRead)) {\n       // Resolve the special `$any(expr)` syntax to insert a cast of the argument to type `any`.\n       // `$any(expr)` -> `expr as any`\n-      if (ast.receiver.name === '$any' && ast.args.length === 1) {\n+      if (ast.receiver.receiver instanceof ImplicitReceiver &&\n+          !(ast.receiver.receiver instanceof ThisReceiver) && ast.receiver.name === '$any' &&\n+          ast.args.length === 1) {\n         const expr = this.translate(ast.args[0]);\n         const exprAsAny =\n             ts.createAsExpression(expr, ts.createKeywordTypeNode(ts.SyntaxKind.AnyKeyword));"
        },
        {
            "sha": "cf6b9459d4e270cc3f70ca28c65674eea3a3a257",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/eeaabe7fbf7a1cf057c6b740609886415e4037eb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/eeaabe7fbf7a1cf057c6b740609886415e4037eb/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=eeaabe7fbf7a1cf057c6b740609886415e4037eb",
            "patch": "@@ -8,7 +8,6 @@\n \n import {initMockFileSystem} from '../../file_system/testing';\n import {TypeCheckingConfig} from '../api';\n-\n import {ALL_ENABLED_CONFIG, tcb, TestDeclaration, TestDirective} from '../testing';\n \n \n@@ -613,6 +612,12 @@ describe('type check blocks', () => {\n     expect(block).toContain('((((ctx).$any))(((ctx).a)))');\n   });\n \n+  it('should handle $any accessed through a property read', () => {\n+    const TEMPLATE = `{{foo.$any(a)}}`;\n+    const block = tcb(TEMPLATE);\n+    expect(block).toContain('((((((ctx).foo)).$any))(((ctx).a)))');\n+  });\n+\n   describe('experimental DOM checking via lib.dom.d.ts', () => {\n     it('should translate unclaimed bindings to their property equivalent', () => {\n       const TEMPLATE = `<label [for]=\"'test'\"></label>`;"
        }
    ],
    "stats": {
        "total": 14,
        "additions": 10,
        "deletions": 4
    }
}