{
    "author": "petebacondarwin",
    "message": "fix(localize): serialize all the message locations to XLIFF (#39411)\n\nPreviously only the first message, for each id, was serialized\nwhich meant that additional message location information\nwas lost.\n\nNow all the message locations are included in the serialized\nmessages.\n\nFixes #39330\n\nPR Close #39411",
    "sha": "57ead7aa53016fe4b5eaaffbb41fd434b3b74faf",
    "files": [
        {
            "sha": "c2fa65c43fee7142c0135b40eb80b3f8097da8f8",
            "filename": "packages/localize/src/tools/src/extract/translation_files/utils.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Futils.ts?ref=57ead7aa53016fe4b5eaaffbb41fd434b3b74faf",
            "patch": "@@ -0,0 +1,37 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {ɵMessageId, ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n+\n+/**\n+ * Consolidate an array of messages into a map from message id to an array of messages with that id.\n+ *\n+ * @param messages the messages to consolidate.\n+ * @param getMessageId a function that will compute the message id of a message.\n+ */\n+export function consolidateMessages(\n+    messages: ɵParsedMessage[],\n+    getMessageId: (message: ɵParsedMessage) => string): Map<ɵMessageId, ɵParsedMessage[]> {\n+  const consolidateMessages = new Map<ɵMessageId, ɵParsedMessage[]>();\n+  for (const message of messages) {\n+    const id = getMessageId(message);\n+    if (!consolidateMessages.has(id)) {\n+      consolidateMessages.set(id, [message]);\n+    } else {\n+      consolidateMessages.get(id)!.push(message);\n+    }\n+  }\n+  return consolidateMessages;\n+}\n+\n+/**\n+ * Does the given message have a location property?\n+ */\n+export function hasLocation(message: ɵParsedMessage): message is ɵParsedMessage&\n+    {location: ɵSourceLocation} {\n+  return message.location !== undefined;\n+}"
        },
        {
            "sha": "78006a29806fb7604f94dc49e14947506a4f7675",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff1_translation_serializer.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 10,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts?ref=57ead7aa53016fe4b5eaaffbb41fd434b3b74faf",
            "patch": "@@ -11,6 +11,7 @@ import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n import {FormatOptions, validateOptions} from './format_options';\n import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n+import {consolidateMessages, hasLocation} from './utils';\n import {XmlFile} from './xml_file';\n \n /** This is the number of characters that a legacy Xliff 1.2 message id has. */\n@@ -33,7 +34,7 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n   }\n \n   serialize(messages: ɵParsedMessage[]): string {\n-    const ids = new Set<string>();\n+    const messageMap = consolidateMessages(messages, message => this.getMessageId(message));\n     const xml = new XmlFile();\n     xml.startTag('xliff', {'version': '1.2', 'xmlns': 'urn:oasis:names:tc:xliff:document:1.2'});\n     // NOTE: the `original` property is set to the legacy `ng2.template` value for backward\n@@ -50,21 +51,19 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n       ...this.formatOptions,\n     });\n     xml.startTag('body');\n-    for (const message of messages) {\n-      const id = this.getMessageId(message);\n-      if (ids.has(id)) {\n-        // Do not render the same message more than once\n-        continue;\n-      }\n-      ids.add(id);\n+    for (const [id, duplicateMessages] of messageMap.entries()) {\n+      const message = duplicateMessages[0];\n \n       xml.startTag('trans-unit', {id, datatype: 'html'});\n       xml.startTag('source', {}, {preserveWhitespace: true});\n       this.serializeMessage(xml, message);\n       xml.endTag('source', {preserveWhitespace: false});\n-      if (message.location) {\n-        this.serializeLocation(xml, message.location);\n+\n+      // Write all the locations\n+      for (const {location} of duplicateMessages.filter(hasLocation)) {\n+        this.serializeLocation(xml, location);\n       }\n+\n       if (message.description) {\n         this.serializeNote(xml, 'description', message.description);\n       }"
        },
        {
            "sha": "fb926abfdbd7e4ca90d746dd90930ec111284599",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff2_translation_serializer.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts?ref=57ead7aa53016fe4b5eaaffbb41fd434b3b74faf",
            "patch": "@@ -11,6 +11,7 @@ import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n import {FormatOptions, validateOptions} from './format_options';\n import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n+import {consolidateMessages, hasLocation} from './utils';\n import {XmlFile} from './xml_file';\n \n /** This is the maximum number of characters that can appear in a legacy XLIFF 2.0 message id. */\n@@ -33,7 +34,7 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n   }\n \n   serialize(messages: ɵParsedMessage[]): string {\n-    const ids = new Set<string>();\n+    const messageMap = consolidateMessages(messages, message => this.getMessageId(message));\n     const xml = new XmlFile();\n     xml.startTag('xliff', {\n       'version': '2.0',\n@@ -48,24 +49,23 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n     // messages that come from a particular original file, and the translation file parsers may\n     // not\n     xml.startTag('file', {'id': 'ngi18n', 'original': 'ng.template', ...this.formatOptions});\n-    for (const message of messages) {\n-      const id = this.getMessageId(message);\n-      if (ids.has(id)) {\n-        // Do not render the same message more than once\n-        continue;\n-      }\n-      ids.add(id);\n+    for (const [id, duplicateMessages] of messageMap.entries()) {\n+      const message = duplicateMessages[0];\n+\n       xml.startTag('unit', {id});\n-      if (message.meaning || message.description || message.location) {\n+      const messagesWithLocations = duplicateMessages.filter(hasLocation);\n+      if (message.meaning || message.description || messagesWithLocations.length) {\n         xml.startTag('notes');\n-        if (message.location) {\n-          const {file, start, end} = message.location;\n+\n+        // Write all the locations\n+        for (const {location: {file, start, end}} of messagesWithLocations) {\n           const endLineString =\n               end !== undefined && end.line !== start.line ? `,${end.line + 1}` : '';\n           this.serializeNote(\n               xml, 'location',\n               `${this.fs.relative(this.basePath, file)}:${start.line + 1}${endLineString}`);\n         }\n+\n         if (message.description) {\n           this.serializeNote(xml, 'description', message.description);\n         }"
        },
        {
            "sha": "9697a8cfdaab7c314ecb8361fd13e7c9b7349688",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff1_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 95,
            "deletions": 0,
            "changes": 95,
            "blob_url": "https://github.com/angular/angular/blob/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts?ref=57ead7aa53016fe4b5eaaffbb41fd434b3b74faf",
            "patch": "@@ -135,6 +135,101 @@ runInEachFileSystem(() => {\n               `</xliff>\\n`,\n             ].join('\\n'));\n           });\n+\n+          it('should convert a set of parsed messages into an XML string', () => {\n+            const messageLocation1: ɵSourceLocation = {\n+              start: {line: 0, column: 5},\n+              end: {line: 0, column: 10},\n+              file: absoluteFrom('/project/file-1.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messageLocation2: ɵSourceLocation = {\n+              start: {line: 3, column: 2},\n+              end: {line: 4, column: 7},\n+              file: absoluteFrom('/project/file-2.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messageLocation3: ɵSourceLocation = {\n+              start: {line: 0, column: 5},\n+              end: {line: 0, column: 10},\n+              file: absoluteFrom('/project/file-3.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messageLocation4: ɵSourceLocation = {\n+              start: {line: 3, column: 2},\n+              end: {line: 4, column: 7},\n+              file: absoluteFrom('/project/file-4.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messages: ɵParsedMessage[] = [\n+              mockMessage('1234', ['message text'], [], {location: messageLocation1}),\n+              mockMessage('1234', ['message text'], [], {location: messageLocation2}),\n+              mockMessage('1234', ['message text'], [], {\n+                location: messageLocation3,\n+                legacyIds: ['87654321FEDCBA0987654321FEDCBA0987654321', '563965274788097516']\n+              }),\n+              mockMessage(\n+                  '1234', ['message text'], [], {location: messageLocation4, customId: 'other'}),\n+            ];\n+            const serializer = new Xliff1TranslationSerializer(\n+                'xx', absoluteFrom('/project'), useLegacyIds, options);\n+            const output = serializer.serialize(messages);\n+\n+            // Note that in this test the third message will match the first two if legacyIds is\n+            // false. Otherwise it will be a separate message on its own.\n+\n+            expect(output).toEqual([\n+              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+              `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n+              `  <file source-language=\"xx\" datatype=\"plaintext\" original=\"ng2.template\"${\n+                  toAttributes(options)}>`,\n+              `    <body>`,\n+              `      <trans-unit id=\"1234\" datatype=\"html\">`,\n+              `        <source>message text</source>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file-1.ts</context>`,\n+              `          <context context-type=\"linenumber\">1</context>`,\n+              `        </context-group>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file-2.ts</context>`,\n+              `          <context context-type=\"linenumber\">4,5</context>`,\n+              `        </context-group>`,\n+              ...useLegacyIds ?\n+                  [] :\n+                  [\n+                    `        <context-group purpose=\"location\">`,\n+                    `          <context context-type=\"sourcefile\">file-3.ts</context>`,\n+                    `          <context context-type=\"linenumber\">1</context>`,\n+                    `        </context-group>`,\n+                  ],\n+              `      </trans-unit>`,\n+              ...useLegacyIds ?\n+                  [\n+                    `      <trans-unit id=\"87654321FEDCBA0987654321FEDCBA0987654321\" datatype=\"html\">`,\n+                    `        <source>message text</source>`,\n+                    `        <context-group purpose=\"location\">`,\n+                    `          <context context-type=\"sourcefile\">file-3.ts</context>`,\n+                    `          <context context-type=\"linenumber\">1</context>`,\n+                    `        </context-group>`,\n+                    `      </trans-unit>`,\n+                  ] :\n+                  [],\n+              `      <trans-unit id=\"other\" datatype=\"html\">`,\n+              `        <source>message text</source>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file-4.ts</context>`,\n+              `          <context context-type=\"linenumber\">4,5</context>`,\n+              `        </context-group>`,\n+              `      </trans-unit>`,\n+              `    </body>`,\n+              `  </file>`,\n+              `</xliff>\\n`,\n+            ].join('\\n'));\n+          });\n         });\n       });\n     });"
        },
        {
            "sha": "832d517ff7fefdafd7fadbdb687f3074c42a8727",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff2_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/57ead7aa53016fe4b5eaaffbb41fd434b3b74faf/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts?ref=57ead7aa53016fe4b5eaaffbb41fd434b3b74faf",
            "patch": "@@ -158,6 +158,91 @@ runInEachFileSystem(() => {\n               `</xliff>\\n`,\n             ].join('\\n'));\n           });\n+\n+          it('should convert a set of parsed messages into an XML string', () => {\n+            const messageLocation1: ɵSourceLocation = {\n+              start: {line: 0, column: 5},\n+              end: {line: 0, column: 10},\n+              file: absoluteFrom('/project/file-1.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messageLocation2: ɵSourceLocation = {\n+              start: {line: 3, column: 2},\n+              end: {line: 4, column: 7},\n+              file: absoluteFrom('/project/file-2.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messageLocation3: ɵSourceLocation = {\n+              start: {line: 0, column: 5},\n+              end: {line: 0, column: 10},\n+              file: absoluteFrom('/project/file-3.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messageLocation4: ɵSourceLocation = {\n+              start: {line: 3, column: 2},\n+              end: {line: 4, column: 7},\n+              file: absoluteFrom('/project/file-4.ts'),\n+              text: 'message text'\n+            };\n+\n+            const messages: ɵParsedMessage[] = [\n+              mockMessage('1234', ['message text'], [], {location: messageLocation1}),\n+              mockMessage('1234', ['message text'], [], {location: messageLocation2}),\n+              mockMessage('1234', ['message text'], [], {\n+                location: messageLocation3,\n+                legacyIds: ['87654321FEDCBA0987654321FEDCBA0987654321', '563965274788097516']\n+              }),\n+              mockMessage(\n+                  '1234', ['message text'], [], {location: messageLocation4, customId: 'other'}),\n+            ];\n+            const serializer = new Xliff2TranslationSerializer(\n+                'xx', absoluteFrom('/project'), useLegacyIds, options);\n+            const output = serializer.serialize(messages);\n+\n+            // Note that in this test the third message will match the first two if legacyIds is\n+            // false. Otherwise it will be a separate message on its own.\n+\n+            expect(output).toEqual([\n+              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+              `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"xx\">`,\n+              `  <file id=\"ngi18n\" original=\"ng.template\"${toAttributes(options)}>`,\n+              `    <unit id=\"1234\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file-1.ts:1</note>`,\n+              `        <note category=\"location\">file-2.ts:4,5</note>`,\n+              ...useLegacyIds ? [] : ['        <note category=\"location\">file-3.ts:1</note>'],\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>message text</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              ...useLegacyIds ?\n+                  [\n+                    `    <unit id=\"563965274788097516\">`,\n+                    `      <notes>`,\n+                    `        <note category=\"location\">file-3.ts:1</note>`,\n+                    `      </notes>`,\n+                    `      <segment>`,\n+                    `        <source>message text</source>`,\n+                    `      </segment>`,\n+                    `    </unit>`,\n+                  ] :\n+                  [],\n+              `    <unit id=\"other\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file-4.ts:4,5</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>message text</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `  </file>`,\n+              `</xliff>\\n`,\n+            ].join('\\n'));\n+          });\n         });\n       });\n     });"
        }
    ],
    "stats": {
        "total": 258,
        "additions": 237,
        "deletions": 21
    }
}