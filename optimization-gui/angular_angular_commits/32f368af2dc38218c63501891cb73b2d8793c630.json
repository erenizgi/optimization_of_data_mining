{
    "author": "atscott",
    "message": "fix(router): Do not clear currentNavigation if already set to next one (#43852)\n\nExperimentation with the Router URL management exposed a situation where\nthe `currentNavigation` was being cleared in the `finalize` after the\n`currentNavigation` was already set to the next one.\n\nThis change ensures that the `currentNavigation` is only cleared if the\nid of the finalized transition matches the one on the\n`currentNavigation` object.\n\nPR Close #43852",
    "sha": "32f368af2dc38218c63501891cb73b2d8793c630",
    "files": [
        {
            "sha": "ad298fc4111c059a081d150b26dcf853f9587d86",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/32f368af2dc38218c63501891cb73b2d8793c630/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/32f368af2dc38218c63501891cb73b2d8793c630/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=32f368af2dc38218c63501891cb73b2d8793c630",
            "patch": "@@ -923,10 +923,11 @@ export class Router {\n                              t.id} is not equal to the current navigation id ${this.navigationId}`;\n                          this.cancelNavigationTransition(t, cancelationReason);\n                        }\n-                       // currentNavigation should always be reset to null here. If navigation was\n-                       // successful, lastSuccessfulTransition will have already been set. Therefore\n-                       // we can safely set currentNavigation to null here.\n-                       this.currentNavigation = null;\n+                       // Only clear current navigation if it is still set to the one that\n+                       // finalized.\n+                       if (this.currentNavigation?.id === t.id) {\n+                         this.currentNavigation = null;\n+                       }\n                      }),\n                      catchError((e) => {\n                        // TODO(atscott): The NavigationTransition `t` used here does not accurately"
        },
        {
            "sha": "f2c3cedfa00ebb3448a47ff49e5ec9a9ec3b6fd9",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/32f368af2dc38218c63501891cb73b2d8793c630/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/32f368af2dc38218c63501891cb73b2d8793c630/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=32f368af2dc38218c63501891cb73b2d8793c630",
            "patch": "@@ -1310,6 +1310,31 @@ describe('Integration', () => {\n          expect(fixture.nativeElement.innerHTML).toContain('simple');\n          expect(location.urlChanges).toEqual(['hash: /blocked']);\n        }));\n+\n+    it('should accurately track currentNavigation', fakeAsync(() => {\n+         const router = TestBed.inject(Router);\n+         router.resetConfig([\n+           {path: 'one', component: SimpleCmp, canActivate: ['in1Second']},\n+           {path: 'two', component: BlankCmp, canActivate: ['in1Second']},\n+         ]);\n+\n+         router.events.subscribe((e) => {\n+           if (e instanceof NavigationStart) {\n+             if (e.url === '/one') {\n+               router.navigateByUrl('two');\n+             }\n+             router.events.subscribe((e) => {\n+               if (e instanceof GuardsCheckEnd) {\n+                 expect(router.getCurrentNavigation()?.extractedUrl.toString()).toEqual('/two');\n+                 expect(router.getCurrentNavigation()?.extras).toBeDefined();\n+               }\n+             });\n+           }\n+         });\n+\n+         router.navigateByUrl('one');\n+         tick(1000);\n+       }));\n   });\n \n   it('should support secondary routes', fakeAsync(inject([Router], (router: Router) => {"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 30,
        "deletions": 4
    }
}