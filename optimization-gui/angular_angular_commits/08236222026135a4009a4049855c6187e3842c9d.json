{
    "author": "alxhub",
    "message": "fix(compiler-cli): track poisoned scopes with a flag (#39923)\n\nTo avoid overwhelming a user with secondary diagnostics that derive from a\n\"root cause\" error, the compiler has the notion of a \"poisoned\" NgModule.\nAn NgModule becomes poisoned when its declaration contains semantic errors:\ndeclarations which are not components or pipes, imports which are not other\nNgModules, etc. An NgModule also becomes poisoned if it imports or exports\nanother poisoned NgModule.\n\nPreviously, the compiler tracked this poisoned status as an alternate state\nfor each scope. Either a correct scope could be produced, or the entire\nscope would be set to a sentinel error value. This meant that the compiler\nwould not track any information about a scope that was determined to be in\nerror.\n\nThis method presents several issues:\n\n1. The compiler is unable to support the language service and return results\nwhen a component or its module scope is poisoned.\n\nThis is fine for compilation, since diagnostics will be produced showing the\nerror(s), but the language service needs to still work for incorrect code.\n\n2. `getComponentScopes()` does not return components with a poisoned scope,\nwhich interferes with resource tracking of incremental builds.\n\nIf the component isn't included in that list, then the NgModule for it will\nnot have its dependencies properly tracked, and this can cause future\nincremental build steps to produce incorrect results.\n\nThis commit changes the tracking of poisoned module scopes to use a flag on\nthe scope itself, rather than a sentinel value that replaces the scope. This\nmeans that the scope itself will still be tracked, even if it contains\nsemantic errors. A test is added to the language service which verifies that\npoisoned scopes can still be used in template type-checking.\n\nPR Close #39923",
    "sha": "08236222026135a4009a4049855c6187e3842c9d",
    "files": [
        {
            "sha": "bc9a4fc6469212084f5077edb1a44fc5e825c561",
            "filename": "packages/compiler-cli/ngcc/src/analysis/decoration_analyzer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -97,6 +97,7 @@ export class DecorationAnalyzer {\n         this.scopeRegistry, this.scopeRegistry, new ResourceRegistry(), this.isCore,\n         this.resourceManager, this.rootDirs, !!this.compilerOptions.preserveWhitespaces,\n         /* i18nUseExternalIds */ true, this.bundle.enableI18nLegacyMessageIdFormat,\n+        /* usePoisonedData */ false,\n         /* i18nNormalizeLineEndingsInICUs */ false, this.moduleResolver, this.cycleAnalyzer,\n         this.refEmitter, NOOP_DEFAULT_IMPORT_RECORDER, NOOP_DEPENDENCY_TRACKER,\n         this.injectableRegistry, !!this.compilerOptions.annotateForClosureCompiler),"
        },
        {
            "sha": "2a88fb2bec9bb72b05f865b368f49141bbf4e080",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 9,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -72,6 +72,8 @@ export interface ComponentAnalysisData {\n   viewProvidersRequiringFactory: Set<Reference<ClassDeclaration>>|null;\n \n   resources: ComponentResources;\n+\n+  isPoisoned: boolean;\n }\n \n export type ComponentResolutionData = Pick<R3ComponentMetadata, ComponentMetadataResolvedFields>;\n@@ -88,7 +90,7 @@ export class ComponentDecoratorHandler implements\n       private resourceRegistry: ResourceRegistry, private isCore: boolean,\n       private resourceLoader: ResourceLoader, private rootDirs: ReadonlyArray<string>,\n       private defaultPreserveWhitespaces: boolean, private i18nUseExternalIds: boolean,\n-      private enableI18nLegacyMessageIdFormat: boolean,\n+      private enableI18nLegacyMessageIdFormat: boolean, private usePoisonedData: boolean,\n       private i18nNormalizeLineEndingsInICUs: boolean|undefined,\n       private moduleResolver: ModuleResolver, private cycleAnalyzer: CycleAnalyzer,\n       private refEmitter: ReferenceEmitter, private defaultImportRecorder: DefaultImportRecorder,\n@@ -369,6 +371,7 @@ export class ComponentDecoratorHandler implements\n           styles: styleResources,\n           template: templateResource,\n         },\n+        isPoisoned: diagnostics !== undefined && diagnostics.length > 0,\n       },\n       diagnostics,\n     };\n@@ -393,6 +396,7 @@ export class ComponentDecoratorHandler implements\n       isComponent: true,\n       baseClass: analysis.baseClass,\n       ...analysis.typeCheckMeta,\n+      isPoisoned: analysis.isPoisoned,\n     });\n \n     this.resourceRegistry.registerResources(analysis.resources, node);\n@@ -401,15 +405,19 @@ export class ComponentDecoratorHandler implements\n \n   index(\n       context: IndexingContext, node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>) {\n+    if (analysis.isPoisoned && !this.usePoisonedData) {\n+      return null;\n+    }\n     const scope = this.scopeReader.getScopeForComponent(node);\n     const selector = analysis.meta.selector;\n     const matcher = new SelectorMatcher<DirectiveMeta>();\n-    if (scope === 'error') {\n-      // Don't bother indexing components which had erroneous scopes.\n-      return null;\n-    }\n-\n     if (scope !== null) {\n+      if ((scope.compilation.isPoisoned || scope.exported.isPoisoned) && !this.usePoisonedData) {\n+        // Don't bother indexing components which had erroneous scopes, unless specifically\n+        // requested.\n+        return null;\n+      }\n+\n       for (const directive of scope.compilation.directives) {\n         if (directive.selector !== null) {\n           matcher.addSelectables(CssSelector.parse(directive.selector), directive);\n@@ -436,9 +444,13 @@ export class ComponentDecoratorHandler implements\n       return;\n     }\n \n+    if (meta.isPoisoned && !this.usePoisonedData) {\n+      return;\n+    }\n+\n     const scope = this.typeCheckScopes.getTypeCheckScope(node);\n-    if (scope === 'error') {\n-      // Don't type-check components that had errors in their scopes.\n+    if (scope.isPoisoned && !this.usePoisonedData) {\n+      // Don't type-check components that had errors in their scopes, unless requested.\n       return;\n     }\n \n@@ -450,6 +462,10 @@ export class ComponentDecoratorHandler implements\n \n   resolve(node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>):\n       ResolveResult<ComponentResolutionData> {\n+    if (analysis.isPoisoned && !this.usePoisonedData) {\n+      return {};\n+    }\n+\n     const context = node.getSourceFile();\n     // Check whether this component was registered with an NgModule. If so, it should be compiled\n     // under that module's compilation scope.\n@@ -462,7 +478,7 @@ export class ComponentDecoratorHandler implements\n       wrapDirectivesAndPipesInClosure: false,\n     };\n \n-    if (scope !== null && scope !== 'error') {\n+    if (scope !== null && (!scope.compilation.isPoisoned || this.usePoisonedData)) {\n       // Replace the empty components and directives from the analyze() step with a fully expanded\n       // scope. This is possible now because during resolve() the whole compilation unit has been\n       // fully analyzed."
        },
        {
            "sha": "f07b3d0411b48acaa8416d58a80023453a17babb",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/directive.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -41,6 +41,7 @@ export interface DirectiveHandlerData {\n   providersRequiringFactory: Set<Reference<ClassDeclaration>>|null;\n   inputs: ClassPropertyMapping;\n   outputs: ClassPropertyMapping;\n+  isPoisoned: boolean;\n }\n \n export class DirectiveDecoratorHandler implements\n@@ -106,7 +107,8 @@ export class DirectiveDecoratorHandler implements\n             this.annotateForClosureCompiler),\n         baseClass: readBaseClass(node, this.reflector, this.evaluator),\n         typeCheckMeta: extractDirectiveTypeCheckMeta(node, directiveResult.inputs, this.reflector),\n-        providersRequiringFactory\n+        providersRequiringFactory,\n+        isPoisoned: false,\n       }\n     };\n   }\n@@ -126,6 +128,7 @@ export class DirectiveDecoratorHandler implements\n       isComponent: false,\n       baseClass: analysis.baseClass,\n       ...analysis.typeCheckMeta,\n+      isPoisoned: analysis.isPoisoned,\n     });\n \n     this.injectableRegistry.registerInjectable(node);"
        },
        {
            "sha": "ef01a4bdce0ca7ccd1a22639371cf383c5f2787e",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/ng_module.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -336,7 +336,7 @@ export class NgModuleDecoratorHandler implements\n       injectorImports: [],\n     };\n \n-    if (scope !== null && scope !== 'error') {\n+    if (scope !== null && !scope.compilation.isPoisoned) {\n       // Using the scope information, extend the injector's imports using the modules that are\n       // specified as module exports.\n       const context = getSourceFile(node);\n@@ -361,7 +361,8 @@ export class NgModuleDecoratorHandler implements\n       return {diagnostics};\n     }\n \n-    if (scope === null || scope === 'error' || scope.reexports === null) {\n+    if (scope === null || scope.compilation.isPoisoned || scope.exported.isPoisoned ||\n+        scope.reexports === null) {\n       return {data};\n     } else {\n       return {"
        },
        {
            "sha": "f3319f9e57909652b6c6ef7cc74c91f3086da7fa",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/typecheck_scopes.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Ftypecheck_scopes.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Ftypecheck_scopes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Ftypecheck_scopes.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -33,6 +33,12 @@ export interface TypeCheckScope {\n    * The schemas that are used in this scope.\n    */\n   schemas: SchemaMetadata[];\n+\n+  /**\n+   * Whether the original compilation scope which produced this `TypeCheckScope` was itself poisoned\n+   * (contained semantic errors during its production).\n+   */\n+  isPoisoned: boolean;\n }\n \n /**\n@@ -57,15 +63,18 @@ export class TypeCheckScopes {\n    * contains an error, then 'error' is returned. If the component is not declared in any NgModule,\n    * an empty type-check scope is returned.\n    */\n-  getTypeCheckScope(node: ClassDeclaration): TypeCheckScope|'error' {\n+  getTypeCheckScope(node: ClassDeclaration): TypeCheckScope {\n     const matcher = new SelectorMatcher<DirectiveMeta>();\n     const pipes = new Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>();\n \n     const scope = this.scopeReader.getScopeForComponent(node);\n     if (scope === null) {\n-      return {matcher, pipes, schemas: []};\n-    } else if (scope === 'error') {\n-      return scope;\n+      return {\n+        matcher,\n+        pipes,\n+        schemas: [],\n+        isPoisoned: false,\n+      };\n     }\n \n     if (this.scopeCache.has(scope.ngModule)) {\n@@ -87,7 +96,12 @@ export class TypeCheckScopes {\n       pipes.set(name, ref as Reference<ClassDeclaration<ts.ClassDeclaration>>);\n     }\n \n-    const typeCheckScope: TypeCheckScope = {matcher, pipes, schemas: scope.schemas};\n+    const typeCheckScope: TypeCheckScope = {\n+      matcher,\n+      pipes,\n+      schemas: scope.schemas,\n+      isPoisoned: scope.compilation.isPoisoned || scope.exported.isPoisoned,\n+    };\n     this.scopeCache.set(scope.ngModule, typeCheckScope);\n     return typeCheckScope;\n   }"
        },
        {
            "sha": "b3c8134e0d699b789223e5c6a87dd472f8372301",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -55,6 +55,7 @@ function setup(program: ts.Program, options: ts.CompilerOptions, host: ts.Compil\n       /* isCore */ false, new StubResourceLoader(), /* rootDirs */['/'],\n       /* defaultPreserveWhitespaces */ false, /* i18nUseExternalIds */ true,\n       /* enableI18nLegacyMessageIdFormat */ false,\n+      /* usePoisonedData */ false,\n       /* i18nNormalizeLineEndingsInICUs */ undefined, moduleResolver, cycleAnalyzer, refEmitter,\n       NOOP_DEFAULT_IMPORT_RECORDER, /* depTracker */ null, injectableRegistry,\n       /* annotateForClosureCompiler */ false);"
        },
        {
            "sha": "a566ed8ae65ce0bff0984397639dd005caeab1c4",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -106,6 +106,7 @@ export class NgCompiler {\n       private typeCheckingProgramStrategy: TypeCheckingProgramStrategy,\n       private incrementalStrategy: IncrementalBuildStrategy,\n       private enableTemplateTypeChecker: boolean,\n+      private usePoisonedData: boolean,\n       oldProgram: ts.Program|null = null,\n       private perfRecorder: PerfRecorder = NOOP_PERF_RECORDER,\n   ) {\n@@ -767,7 +768,7 @@ export class NgCompiler {\n           reflector, evaluator, metaRegistry, metaReader, scopeReader, scopeRegistry,\n           resourceRegistry, isCore, this.resourceManager, this.adapter.rootDirs,\n           this.options.preserveWhitespaces || false, this.options.i18nUseExternalIds !== false,\n-          this.options.enableI18nLegacyMessageIdFormat !== false,\n+          this.options.enableI18nLegacyMessageIdFormat !== false, this.usePoisonedData,\n           this.options.i18nNormalizeLineEndingsInICUs, this.moduleResolver, this.cycleAnalyzer,\n           refEmitter, defaultImportTracker, this.incrementalDriver.depGraph, injectableRegistry,\n           this.closureCompilerEnabled),"
        },
        {
            "sha": "e9ff2151be44d09d18c0c348e8f12ff14f0848f4",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/compiler_test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -51,7 +51,8 @@ runInEachFileSystem(() => {\n       const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n       const compiler = new NgCompiler(\n           host, options, program, new ReusedProgramStrategy(program, host, options, []),\n-          new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+          new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n+          /* usePoisonedData */ false);\n \n       const diags = compiler.getDiagnostics(getSourceFileOrError(program, COMPONENT));\n       expect(diags.length).toBe(1);\n@@ -100,7 +101,8 @@ runInEachFileSystem(() => {\n         const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n         const compiler = new NgCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n-            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n+            /* usePoisonedData */ false);\n         const components = compiler.getComponentsWithTemplateFile(templateFile);\n         expect(components).toEqual(new Set([CmpA, CmpC]));\n       });\n@@ -151,7 +153,8 @@ runInEachFileSystem(() => {\n         const CmpC = getClass(getSourceFileOrError(program, cmpCFile), 'CmpC');\n         const compiler = new NgCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n-            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n+            /* usePoisonedData */ false);\n         const components = compiler.getComponentsWithStyleFile(styleFile);\n         expect(components).toEqual(new Set([CmpA, CmpC]));\n       });\n@@ -184,7 +187,8 @@ runInEachFileSystem(() => {\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const compiler = new NgCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n-            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n+            /* usePoisonedData */ false);\n         const resources = compiler.getComponentResources(CmpA);\n         expect(resources).not.toBeNull();\n         const {template, styles} = resources!;\n@@ -219,7 +223,8 @@ runInEachFileSystem(() => {\n         const CmpA = getClass(getSourceFileOrError(program, cmpAFile), 'CmpA');\n         const compiler = new NgCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n-            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n+            /* usePoisonedData */ false);\n         const resources = compiler.getComponentResources(CmpA);\n         expect(resources).not.toBeNull();\n         const {styles} = resources!;\n@@ -250,7 +255,8 @@ runInEachFileSystem(() => {\n         const program = ts.createProgram({host, options, rootNames: host.inputFiles});\n         const compiler = new NgCompiler(\n             host, options, program, new ReusedProgramStrategy(program, host, options, []),\n-            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false);\n+            new NoopIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n+            /* usePoisonedData */ false);\n \n         const deps = compiler.getResourceDependencies(getSourceFileOrError(program, COMPONENT));\n         expect(deps.length).toBe(2);"
        },
        {
            "sha": "37accc62bbbeba4d9ab647240c5c21ac1c87f0bd",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fapi.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -108,6 +108,12 @@ export interface DirectiveMeta extends T2DirectiveMeta, DirectiveTypeCheckMeta {\n    * another type, it could not statically determine the base class.\n    */\n   baseClass: Reference<ClassDeclaration>|'dynamic'|null;\n+\n+  /**\n+   * Whether the directive had some issue with its declaration that means it might not have complete\n+   * and reliable metadata.\n+   */\n+  isPoisoned: boolean;\n }\n \n /**"
        },
        {
            "sha": "5c693a92e4bdc0ec06dc5c9803dada8e9a0a869e",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/dts.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fdts.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -92,6 +92,7 @@ export class DtsMetadataReader implements MetadataReader {\n       queries: readStringArrayType(def.type.typeArguments[5]),\n       ...extractDirectiveTypeCheckMeta(clazz, inputs, this.reflector),\n       baseClass: readBaseClass(clazz, this.checker, this.reflector),\n+      isPoisoned: false,\n     };\n   }\n "
        },
        {
            "sha": "1af0e8643afdddcc6c7e79ab6761112cded2785d",
            "filename": "packages/compiler-cli/src/ngtsc/program.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -100,7 +100,8 @@ export class NgtscProgram implements api.Program {\n     // Create the NgCompiler which will drive the rest of the compilation.\n     this.compiler = new NgCompiler(\n         this.host, options, this.tsProgram, reusedProgramStrategy, this.incrementalStrategy,\n-        /** enableTemplateTypeChecker */ false, reuseProgram, this.perfRecorder);\n+        /** enableTemplateTypeChecker */ false, /* usePoisonedData */ false, reuseProgram,\n+        this.perfRecorder);\n   }\n \n   getTsProgram(): ts.Program {"
        },
        {
            "sha": "70ba24bc136e813cbaf90da0b78d76a5fa9d7a12",
            "filename": "packages/compiler-cli/src/ngtsc/scope/src/api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fapi.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -29,6 +29,12 @@ export interface ScopeData {\n    * NgModules which contributed to the scope of the module.\n    */\n   ngModules: ClassDeclaration[];\n+\n+  /**\n+   * Whether some module or component in this scope contains errors and is thus semantically\n+   * unreliable.\n+   */\n+  isPoisoned: boolean;\n }\n \n /**"
        },
        {
            "sha": "d1f06409d7d974c527926dc6895a4f988d9230ea",
            "filename": "packages/compiler-cli/src/ngtsc/scope/src/component_scope.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fcomponent_scope.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fcomponent_scope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fcomponent_scope.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -13,7 +13,7 @@ import {LocalModuleScope} from './local';\n  * Read information about the compilation scope of components.\n  */\n export interface ComponentScopeReader {\n-  getScopeForComponent(clazz: ClassDeclaration): LocalModuleScope|null|'error';\n+  getScopeForComponent(clazz: ClassDeclaration): LocalModuleScope|null;\n \n   /**\n    * Get the `RemoteScope` required for this component, if any.\n@@ -34,7 +34,7 @@ export interface ComponentScopeReader {\n export class CompoundComponentScopeReader implements ComponentScopeReader {\n   constructor(private readers: ComponentScopeReader[]) {}\n \n-  getScopeForComponent(clazz: ClassDeclaration): LocalModuleScope|null|'error' {\n+  getScopeForComponent(clazz: ClassDeclaration): LocalModuleScope|null {\n     for (const reader of this.readers) {\n       const meta = reader.getScopeForComponent(clazz);\n       if (meta !== null) {"
        },
        {
            "sha": "5bc06f47dcbe1f2f853d5dfb0dc8db5bfaaf1538",
            "filename": "packages/compiler-cli/src/ngtsc/scope/src/dependency.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fdependency.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fdependency.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Fdependency.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -132,6 +132,7 @@ export class MetadataDtsModuleScopeResolver implements DtsModuleScopeResolver {\n         directives,\n         pipes,\n         ngModules: Array.from(ngModules),\n+        isPoisoned: false,\n       },\n     };\n     this.cache.set(clazz, exportScope);"
        },
        {
            "sha": "464756104db4d9e8afba4e19300a483b69b99dfb",
            "filename": "packages/compiler-cli/src/ngtsc/scope/src/local.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 60,
            "changes": 122,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Flocal.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Flocal.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Fsrc%2Flocal.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -89,11 +89,9 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n \n   /**\n    * A cache of calculated `LocalModuleScope`s for each NgModule declared in the current program.\n-   *\n-   * A value of `undefined` indicates the scope was invalid and produced errors (therefore,\n-   * diagnostics should exist in the `scopeErrors` map).\n+\n    */\n-  private cache = new Map<ClassDeclaration, LocalModuleScope|undefined|null>();\n+  private cache = new Map<ClassDeclaration, LocalModuleScope|null>();\n \n   /**\n    * Tracks the `RemoteScope` for components requiring \"remote scoping\".\n@@ -111,13 +109,9 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n   private scopeErrors = new Map<ClassDeclaration, ts.Diagnostic[]>();\n \n   /**\n-   * Tracks which NgModules are unreliable due to errors within their declarations.\n-   *\n-   * This provides a unified view of which modules have errors, across all of the different\n-   * diagnostic categories that can be produced. Theoretically this can be inferred from the other\n-   * properties of this class, but is tracked explicitly to simplify the logic.\n+   * Tracks which NgModules have directives/pipes that are declared in more than one module.\n    */\n-  private taintedModules = new Set<ClassDeclaration>();\n+  private modulesWithStructuralErrors = new Set<ClassDeclaration>();\n \n   constructor(\n       private localReader: MetadataReader, private dependencyScopeReader: DtsModuleScopeResolver,\n@@ -141,7 +135,7 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n \n   registerPipeMetadata(pipe: PipeMeta): void {}\n \n-  getScopeForComponent(clazz: ClassDeclaration): LocalModuleScope|null|'error' {\n+  getScopeForComponent(clazz: ClassDeclaration): LocalModuleScope|null {\n     const scope = !this.declarationToModule.has(clazz) ?\n         null :\n         this.getScopeOfModule(this.declarationToModule.get(clazz)!.ngModule);\n@@ -171,17 +165,10 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n    * `LocalModuleScope` for the given NgModule if one can be produced, `null` if no scope was ever\n    * defined, or the string `'error'` if the scope contained errors.\n    */\n-  getScopeOfModule(clazz: ClassDeclaration): LocalModuleScope|'error'|null {\n-    const scope = this.moduleToRef.has(clazz) ?\n+  getScopeOfModule(clazz: ClassDeclaration): LocalModuleScope|null {\n+    return this.moduleToRef.has(clazz) ?\n         this.getScopeOfModuleReference(this.moduleToRef.get(clazz)!) :\n         null;\n-    // If the NgModule class is marked as tainted, consider it an error.\n-    if (this.taintedModules.has(clazz)) {\n-      return 'error';\n-    }\n-\n-    // Translate undefined -> 'error'.\n-    return scope !== undefined ? scope : 'error';\n   }\n \n   /**\n@@ -207,7 +194,7 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n     const scopes: CompilationScope[] = [];\n     this.declarationToModule.forEach((declData, declaration) => {\n       const scope = this.getScopeOfModule(declData.ngModule);\n-      if (scope !== null && scope !== 'error') {\n+      if (scope !== null) {\n         scopes.push({declaration, ngModule: declData.ngModule, ...scope.compilation});\n       }\n     });\n@@ -236,9 +223,9 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n       const duplicateDeclMap = new Map<ClassDeclaration, DeclarationData>();\n       const firstDeclData = this.declarationToModule.get(decl.node)!;\n \n-      // Mark both modules as tainted, since their declarations are missing a component.\n-      this.taintedModules.add(firstDeclData.ngModule);\n-      this.taintedModules.add(ngModule);\n+      // Mark both modules as having duplicate declarations.\n+      this.modulesWithStructuralErrors.add(firstDeclData.ngModule);\n+      this.modulesWithStructuralErrors.add(ngModule);\n \n       // Being detected as a duplicate means there are two NgModules (for now) which declare this\n       // directive/pipe. Add both of them to the duplicate tracking map.\n@@ -256,16 +243,11 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n   }\n \n   /**\n-   * Implementation of `getScopeOfModule` which accepts a reference to a class and differentiates\n-   * between:\n-   *\n-   * * no scope being available (returns `null`)\n-   * * a scope being produced with errors (returns `undefined`).\n+   * Implementation of `getScopeOfModule` which accepts a reference to a class.\n    */\n-  private getScopeOfModuleReference(ref: Reference<ClassDeclaration>): LocalModuleScope|null\n-      |undefined {\n+  private getScopeOfModuleReference(ref: Reference<ClassDeclaration>): LocalModuleScope|null {\n     if (this.cache.has(ref.node)) {\n-      return this.cache.get(ref.node);\n+      return this.cache.get(ref.node)!;\n     }\n \n     // Seal the registry to protect the integrity of the `LocalModuleScope` cache.\n@@ -315,20 +297,33 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n     //    c) If it's neither an NgModule nor a directive/pipe in the compilation scope, then this\n     //       is an error.\n \n+    //\n+    let isPoisoned = false;\n+    if (this.modulesWithStructuralErrors.has(ngModule.ref.node)) {\n+      // If the module contains declarations that are duplicates, then it's considered poisoned.\n+      isPoisoned = true;\n+    }\n+\n     // 1) process imports.\n     for (const decl of ngModule.imports) {\n       const importScope = this.getExportedScope(decl, diagnostics, ref.node, 'import');\n       if (importScope === null) {\n         // An import wasn't an NgModule, so record an error.\n         diagnostics.push(invalidRef(ref.node, decl, 'import'));\n+        isPoisoned = true;\n         continue;\n-      } else if (importScope === undefined) {\n+      } else if (importScope === 'invalid' || importScope.exported.isPoisoned) {\n         // An import was an NgModule but contained errors of its own. Record this as an error too,\n         // because this scope is always going to be incorrect if one of its imports could not be\n         // read.\n         diagnostics.push(invalidTransitiveNgModuleRef(ref.node, decl, 'import'));\n-        continue;\n+        isPoisoned = true;\n+\n+        if (importScope === 'invalid') {\n+          continue;\n+        }\n       }\n+\n       for (const directive of importScope.exported.directives) {\n         compilationDirectives.set(directive.ref.node, directive);\n       }\n@@ -346,11 +341,12 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n       const pipe = this.localReader.getPipeMetadata(decl);\n       if (directive !== null) {\n         compilationDirectives.set(decl.node, {...directive, ref: decl});\n+        if (directive.isPoisoned) {\n+          isPoisoned = true;\n+        }\n       } else if (pipe !== null) {\n         compilationPipes.set(decl.node, {...pipe, ref: decl});\n       } else {\n-        this.taintedModules.add(ngModule.ref.node);\n-\n         const errorNode = decl.getOriginForDiagnostics(ngModule.rawDeclarations!);\n         diagnostics.push(makeDiagnostic(\n             ErrorCode.NGMODULE_INVALID_DECLARATION, errorNode,\n@@ -361,6 +357,7 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n                 `Either remove it from the NgModule's declarations, or add an appropriate Angular decorator.`,\n             [makeRelatedInformation(\n                 decl.node.name, `'${decl.node.name.text}' is declared here.`)]));\n+        isPoisoned = true;\n         continue;\n       }\n \n@@ -374,22 +371,26 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n     // imported types.\n     for (const decl of ngModule.exports) {\n       // Attempt to resolve decl as an NgModule.\n-      const importScope = this.getExportedScope(decl, diagnostics, ref.node, 'export');\n-      if (importScope === undefined) {\n+      const exportScope = this.getExportedScope(decl, diagnostics, ref.node, 'export');\n+      if (exportScope === 'invalid' || (exportScope !== null && exportScope.exported.isPoisoned)) {\n         // An export was an NgModule but contained errors of its own. Record this as an error too,\n         // because this scope is always going to be incorrect if one of its exports could not be\n         // read.\n         diagnostics.push(invalidTransitiveNgModuleRef(ref.node, decl, 'export'));\n-        continue;\n-      } else if (importScope !== null) {\n+        isPoisoned = true;\n+\n+        if (exportScope === 'invalid') {\n+          continue;\n+        }\n+      } else if (exportScope !== null) {\n         // decl is an NgModule.\n-        for (const directive of importScope.exported.directives) {\n+        for (const directive of exportScope.exported.directives) {\n           exportDirectives.set(directive.ref.node, directive);\n         }\n-        for (const pipe of importScope.exported.pipes) {\n+        for (const pipe of exportScope.exported.pipes) {\n           exportPipes.set(pipe.ref.node, pipe);\n         }\n-        for (const exportedModule of importScope.exported.ngModules) {\n+        for (const exportedModule of exportScope.exported.ngModules) {\n           exportedModules.add(exportedModule);\n         }\n       } else if (compilationDirectives.has(decl.node)) {\n@@ -408,30 +409,20 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n         } else {\n           diagnostics.push(invalidRef(ref.node, decl, 'export'));\n         }\n+        isPoisoned = true;\n         continue;\n       }\n     }\n \n-    const exported = {\n+    const exported: ScopeData = {\n       directives: Array.from(exportDirectives.values()),\n       pipes: Array.from(exportPipes.values()),\n       ngModules: Array.from(exportedModules),\n+      isPoisoned,\n     };\n \n     const reexports = this.getReexports(ngModule, ref, declared, exported, diagnostics);\n \n-    // Check if this scope had any errors during production.\n-    if (diagnostics.length > 0) {\n-      // Cache undefined, to mark the fact that the scope is invalid.\n-      this.cache.set(ref.node, undefined);\n-\n-      // Save the errors for retrieval.\n-      this.scopeErrors.set(ref.node, diagnostics);\n-\n-      // Mark this module as being tainted.\n-      this.taintedModules.add(ref.node);\n-      return undefined;\n-    }\n \n     // Finally, produce the `LocalModuleScope` with both the compilation and export scopes.\n     const scope: LocalModuleScope = {\n@@ -440,11 +431,22 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n         directives: Array.from(compilationDirectives.values()),\n         pipes: Array.from(compilationPipes.values()),\n         ngModules: Array.from(compilationModules),\n+        isPoisoned,\n       },\n       exported,\n       reexports,\n       schemas: ngModule.schemas,\n     };\n+\n+    // Check if this scope had any errors during production.\n+    if (diagnostics.length > 0) {\n+      // Save the errors for retrieval.\n+      this.scopeErrors.set(ref.node, diagnostics);\n+\n+      // Mark this module as being tainted.\n+      this.modulesWithStructuralErrors.add(ref.node);\n+    }\n+\n     this.cache.set(ref.node, scope);\n     return scope;\n   }\n@@ -471,15 +473,15 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n    * The NgModule in question may be declared locally in the current ts.Program, or it may be\n    * declared in a .d.ts file.\n    *\n-   * @returns `null` if no scope could be found, or `undefined` if an invalid scope\n-   * was found.\n+   * @returns `null` if no scope could be found, or `'invalid'` if the `Reference` is not a valid\n+   *     NgModule.\n    *\n    * May also contribute diagnostics of its own by adding to the given `diagnostics`\n    * array parameter.\n    */\n   private getExportedScope(\n       ref: Reference<ClassDeclaration>, diagnostics: ts.Diagnostic[],\n-      ownerForErrors: DeclarationNode, type: 'import'|'export'): ExportScope|null|undefined {\n+      ownerForErrors: DeclarationNode, type: 'import'|'export'): ExportScope|null|'invalid' {\n     if (ref.node.getSourceFile().isDeclarationFile) {\n       // The NgModule is declared in a .d.ts file. Resolve it with the `DependencyScopeReader`.\n       if (!ts.isClassDeclaration(ref.node)) {\n@@ -491,7 +493,7 @@ export class LocalModuleScopeRegistry implements MetadataRegistry, ComponentScop\n             code, identifierOfNode(ref.node) || ref.node,\n             `Appears in the NgModule.${type}s of ${\n                 nodeNameForError(ownerForErrors)}, but could not be resolved to an NgModule`));\n-        return undefined;\n+        return 'invalid';\n       }\n       return this.dependencyScopeReader.resolve(ref);\n     } else {"
        },
        {
            "sha": "dd289671fedaa9449c9f3409ab7b939741187ece",
            "filename": "packages/compiler-cli/src/ngtsc/scope/test/local_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Flocal_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Flocal_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2Ftest%2Flocal_spec.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -219,7 +219,7 @@ describe('LocalModuleScopeRegistry', () => {\n       rawDeclarations: null,\n     });\n \n-    expect(scopeRegistry.getScopeOfModule(ModuleA.node)).toBe('error');\n+    expect(scopeRegistry.getScopeOfModule(ModuleA.node)!.compilation.isPoisoned).toBeTrue();\n \n     // ModuleA should have associated diagnostics as it exports `Dir` without declaring it.\n     expect(scopeRegistry.getDiagnosticsOfModule(ModuleA.node)).not.toBeNull();\n@@ -248,6 +248,7 @@ function fakeDirective(ref: Reference<ClassDeclaration>): DirectiveMeta {\n     undeclaredInputFields: new Set<string>(),\n     isGeneric: false,\n     baseClass: null,\n+    isPoisoned: false,\n   };\n }\n "
        },
        {
            "sha": "f76d4eb50cef24c84811b31cbe4706e829d3479a",
            "filename": "packages/compiler-cli/src/ngtsc/tsc_plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftsc_plugin.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -103,7 +103,7 @@ export class NgTscPlugin implements TscPlugin {\n     this._compiler = new NgCompiler(\n         this.host, this.options, program, typeCheckStrategy,\n         new PatchedProgramIncrementalBuildStrategy(), /** enableTemplateTypeChecker */ false,\n-        oldProgram, NOOP_PERF_RECORDER);\n+        /* usePoisonedData */ false, oldProgram, NOOP_PERF_RECORDER);\n     return {\n       ignoreForDiagnostics: this._compiler.ignoreForDiagnostics,\n       ignoreForEmit: this._compiler.ignoreForEmit,"
        },
        {
            "sha": "4260a7b4020c99a287bf624cb22ea70a00580d31",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -502,16 +502,17 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       throw new Error(`AssertionError: components must have names`);\n     }\n \n+    const scope = this.componentScopeReader.getScopeForComponent(component);\n+    if (scope === null) {\n+      return null;\n+    }\n+\n     const data: ScopeData = {\n       directives: [],\n       pipes: [],\n+      isPoisoned: scope.compilation.isPoisoned,\n     };\n \n-    const scope = this.componentScopeReader.getScopeForComponent(component);\n-    if (scope === null || scope === 'error') {\n-      return null;\n-    }\n-\n     const typeChecker = this.typeCheckingStrategy.getProgram().getTypeChecker();\n     for (const dir of scope.exported.directives) {\n       if (dir.selector === null) {\n@@ -739,4 +740,5 @@ class SingleShimTypeCheckingHost extends SingleFileTypeCheckingHost {\n interface ScopeData {\n   directives: DirectiveInScope[];\n   pipes: PipeInScope[];\n+  isPoisoned: boolean;\n }"
        },
        {
            "sha": "bf3df64c20e549414ea557b41f6b790dc0c52728",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -159,7 +159,7 @@ export class SymbolBuilder {\n \n   private getDirectiveModule(declaration: ts.ClassDeclaration): ClassDeclaration|null {\n     const scope = this.componentScopeReader.getScopeForComponent(declaration as ClassDeclaration);\n-    if (scope === null || scope === 'error') {\n+    if (scope === null) {\n       return null;\n     }\n     return scope.ngModule;"
        },
        {
            "sha": "aab925cfd09fa4d1f94bb8653bf70589c7fda9df",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -435,6 +435,7 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n                 directives: [],\n                 ngModules: [],\n                 pipes: [],\n+                isPoisoned: false,\n               };\n               return {\n                 ngModule,\n@@ -532,6 +533,7 @@ function makeScope(program: ts.Program, sf: ts.SourceFile, decls: TestDeclaratio\n     ngModules: [],\n     directives: [],\n     pipes: [],\n+    isPoisoned: false,\n   };\n \n   for (const decl of decls) {\n@@ -561,6 +563,7 @@ function makeScope(program: ts.Program, sf: ts.SourceFile, decls: TestDeclaratio\n         stringLiteralInputFields: new Set(decl.stringLiteralInputFields ?? []),\n         undeclaredInputFields: new Set(decl.undeclaredInputFields ?? []),\n         isGeneric: decl.isGeneric ?? false,\n+        isPoisoned: false,\n       });\n     } else if (decl.type === 'pipe') {\n       scope.pipes.push({"
        },
        {
            "sha": "b42b1e660ee9c2e9cf11361ea0a2fb7047c226d4",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -45,6 +45,7 @@ export class CompilerFactory {\n           this.programStrategy,\n           this.incrementalStrategy,\n           true,  // enableTemplateTypeChecker\n+          true,  // usePoisonedData\n           this.lastKnownProgram,\n           undefined,  // perfRecorder (use default)\n       );"
        },
        {
            "sha": "f5acc120017ab9ff7d774c705dd06a12a5316fdf",
            "filename": "packages/language-service/ivy/test/compiler_spec.ts",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/08236222026135a4009a4049855c6187e3842c9d/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/08236222026135a4009a4049855c6187e3842c9d/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts?ref=08236222026135a4009a4049855c6187e3842c9d",
            "patch": "@@ -0,0 +1,63 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import {LanguageServiceTestEnvironment} from './env';\n+\n+describe('language-service/compiler integration', () => {\n+  beforeEach(() => {\n+    initMockFileSystem('Native');\n+  });\n+\n+  it('should show type-checking errors from components with poisoned scopes', () => {\n+    // Normally, the Angular compiler suppresses errors from components that belong to NgModules\n+    // which themselves have errors (such scopes are considered \"poisoned\"), to avoid overwhelming\n+    // the user with secondary errors that stem from a primary root cause. However, this prevents\n+    // the generation of type check blocks and other metadata within the compiler which drive the\n+    // Language Service's understanding of components. Therefore in the Language Service, the\n+    // compiler is configured to make use of such data even if it's \"poisoned\". This test verifies\n+    // that a component declared in an NgModule with a faulty import still generates template\n+    // diagnostics.\n+\n+    const file = absoluteFrom('/test.ts');\n+    const env = LanguageServiceTestEnvironment.setup([{\n+      name: file,\n+      contents: `\n+          import {Component, Directive, Input, NgModule} from '@angular/core';\n+\n+          @Component({\n+            selector: 'test-cmp',\n+            template: '<div [dir]=\"3\"></div>',\n+          })\n+          export class Cmp {}\n+\n+          @Directive({\n+            selector: '[dir]',\n+          })\n+          export class Dir {\n+            @Input() dir!: string;\n+          }\n+\n+          export class NotAModule {}\n+\n+          @NgModule({\n+            declarations: [Cmp, Dir],\n+            imports: [NotAModule],\n+          })\n+          export class Mod {}\n+        `,\n+      isRoot: true,\n+    }]);\n+\n+    const diags = env.ngLS.getSemanticDiagnostics(file);\n+    expect(diags.map(diag => diag.messageText))\n+        .toContain(`Type 'number' is not assignable to type 'string'.`);\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 320,
        "additions": 225,
        "deletions": 95
    }
}