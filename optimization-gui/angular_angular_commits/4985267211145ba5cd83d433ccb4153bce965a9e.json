{
    "author": "kyliau",
    "message": "test(language-service): [Ivy] return cursor position in overwritten template (#38552)\n\nIn many testing scenarios, there is a common pattern:\n\n1. Overwrite template (inline or external)\n2. Find cursor position\n3. Call one of language service APIs\n4. Inspect spans in result\n\nIn order to faciliate this pattern, this commit refactors\n`MockHost.overwrite()` and `MockHost.overwriteInlineTemplate()` to\nallow a faux cursor symbol `¦` to be injected into the template, and\nthe methods will automatically remove it before updating the script snapshot.\nBoth methods will return the cursor position and the new text without\nthe cursor symbol.\n\nThis makes testing very convenient. Here's a typical example:\n\n```ts\nconst {position, text} = mockHost.overwrite('template.html', `{{ ti¦tle }}`);\nconst quickInfo = ngLS.getQuickInfoAtPosition('template.html', position);\nconst {start, length} = quickInfo!.textSpan;\nexpect(text.substring(start, start + length)).toBe('title');\n```\n\nPR Close #38552",
    "sha": "4985267211145ba5cd83d433ccb4153bce965a9e",
    "files": [
        {
            "sha": "45eeb72e2f77714ac74f0f2645f0bb7addcab219",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/4985267211145ba5cd83d433ccb4153bce965a9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4985267211145ba5cd83d433ccb4153bce965a9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=4985267211145ba5cd83d433ccb4153bce965a9e",
            "patch": "@@ -26,13 +26,13 @@ describe('diagnostic', () => {\n   });\n \n   it('should report member does not exist', () => {\n-    const content = service.overwriteInlineTemplate(APP_COMPONENT, '{{ nope }}');\n+    const {text} = service.overwriteInlineTemplate(APP_COMPONENT, '{{ nope }}');\n     const diags = ngLS.getSemanticDiagnostics(APP_COMPONENT);\n     expect(diags.length).toBe(1);\n     const {category, file, start, length, messageText} = diags[0];\n     expect(category).toBe(ts.DiagnosticCategory.Error);\n     expect(file?.fileName).toBe(APP_COMPONENT);\n-    expect(content.substring(start!, start! + length!)).toBe('nope');\n+    expect(text.substring(start!, start! + length!)).toBe('nope');\n     expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n   });\n });"
        },
        {
            "sha": "152c2200f49cefde0e84d454874d46f276bdd3db",
            "filename": "packages/language-service/ivy/test/mock_host.ts",
            "status": "modified",
            "additions": 58,
            "deletions": 14,
            "changes": 72,
            "blob_url": "https://github.com/angular/angular/blob/4985267211145ba5cd83d433ccb4153bce965a9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/4985267211145ba5cd83d433ccb4153bce965a9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts?ref=4985267211145ba5cd83d433ccb4153bce965a9e",
            "patch": "@@ -105,6 +105,17 @@ export function setup() {\n   };\n }\n \n+interface OverwriteResult {\n+  /**\n+   * Position of the cursor, -1 if there isn't one.\n+   */\n+  position: number;\n+  /**\n+   * Overwritten content without the cursor.\n+   */\n+  text: string;\n+}\n+\n class MockService {\n   private readonly overwritten = new Set<ts.server.NormalizedPath>();\n \n@@ -113,20 +124,32 @@ class MockService {\n       private readonly ps: ts.server.ProjectService,\n   ) {}\n \n-  overwrite(fileName: string, newText: string): string {\n+  /**\n+   * Overwrite the entire content of `fileName` with `newText`. If cursor is\n+   * present in `newText`, it will be removed and the position of the cursor\n+   * will be returned.\n+   */\n+  overwrite(fileName: string, newText: string): OverwriteResult {\n     const scriptInfo = this.getScriptInfo(fileName);\n-    this.overwriteScriptInfo(scriptInfo, preprocess(newText));\n-    return newText;\n+    return this.overwriteScriptInfo(scriptInfo, newText);\n   }\n \n-  overwriteInlineTemplate(fileName: string, newTemplate: string): string {\n+  /**\n+   * Overwrite an inline template defined in `fileName` and return the entire\n+   * content of the source file (not just the template). If a cursor is present\n+   * in `newTemplate`, it will be removed and the position of the cursor in the\n+   * source file will be returned.\n+   */\n+  overwriteInlineTemplate(fileName: string, newTemplate: string): OverwriteResult {\n     const scriptInfo = this.getScriptInfo(fileName);\n     const snapshot = scriptInfo.getSnapshot();\n-    const originalContent = snapshot.getText(0, snapshot.getLength());\n-    const newContent =\n-        originalContent.replace(/template: `([\\s\\S]+)`/, `template: \\`${newTemplate}\\``);\n-    this.overwriteScriptInfo(scriptInfo, preprocess(newContent));\n-    return newContent;\n+    const originalText = snapshot.getText(0, snapshot.getLength());\n+    const {position, text} =\n+        replaceOnce(originalText, /template: `([\\s\\S]+?)`/, `template: \\`${newTemplate}\\``);\n+    if (position === -1) {\n+      throw new Error(`${fileName} does not contain a component with template`);\n+    }\n+    return this.overwriteScriptInfo(scriptInfo, text);\n   }\n \n   reset() {\n@@ -151,16 +174,37 @@ class MockService {\n     return scriptInfo;\n   }\n \n-  private overwriteScriptInfo(scriptInfo: ts.server.ScriptInfo, newText: string) {\n+  /**\n+   * Remove the cursor from `newText`, then replace `scriptInfo` with the new\n+   * content and return the position of the cursor.\n+   * @param scriptInfo\n+   * @param newText Text that possibly contains a cursor\n+   */\n+  private overwriteScriptInfo(scriptInfo: ts.server.ScriptInfo, newText: string): OverwriteResult {\n+    const result = replaceOnce(newText, /¦/, '');\n     const snapshot = scriptInfo.getSnapshot();\n-    scriptInfo.editContent(0, snapshot.getLength(), newText);\n+    scriptInfo.editContent(0, snapshot.getLength(), result.text);\n     this.overwritten.add(scriptInfo.fileName);\n+    return result;\n   }\n }\n \n-const REGEX_CURSOR = /¦/g;\n-function preprocess(text: string): string {\n-  return text.replace(REGEX_CURSOR, '');\n+/**\n+ * Replace at most one occurence that matches `regex` in the specified\n+ * `searchText` with the specified `replaceText`. Throw an error if there is\n+ * more than one occurrence.\n+ */\n+function replaceOnce(searchText: string, regex: RegExp, replaceText: string): OverwriteResult {\n+  regex = new RegExp(regex.source, regex.flags + 'g' /* global */);\n+  let position = -1;\n+  const text = searchText.replace(regex, (...args) => {\n+    if (position !== -1) {\n+      throw new Error(`${regex} matches more than one occurrence in text: ${searchText}`);\n+    }\n+    position = args[args.length - 2];  // second last argument is always the index\n+    return replaceText;\n+  });\n+  return {position, text};\n }\n \n const REF_MARKER = /«(((\\w|\\-)+)|([^ᐱ]*ᐱ(\\w+)ᐱ.[^»]*))»/g;"
        },
        {
            "sha": "e12dd112c1f6fb731df958cb65a268cf360b753e",
            "filename": "packages/language-service/ivy/test/mock_host_spec.ts",
            "status": "modified",
            "additions": 88,
            "deletions": 8,
            "changes": 96,
            "blob_url": "https://github.com/angular/angular/blob/4985267211145ba5cd83d433ccb4153bce965a9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4985267211145ba5cd83d433ccb4153bce965a9e/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host_spec.ts?ref=4985267211145ba5cd83d433ccb4153bce965a9e",
            "patch": "@@ -8,7 +8,7 @@\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {APP_MAIN, setup, TEST_SRCDIR} from './mock_host';\n+import {APP_COMPONENT, APP_MAIN, setup, TEST_SRCDIR} from './mock_host';\n \n describe('mock host', () => {\n   const {project, service, tsLS} = setup();\n@@ -58,13 +58,93 @@ describe('mock host', () => {\n     expect(getText(scriptInfo)).toBe('const x: string = 0');\n   });\n \n-  it('can find the cursor', () => {\n-    const content = service.overwrite(APP_MAIN, `const fo¦o = 'hello world';`);\n-    // content returned by overwrite() is the original content with cursor\n-    expect(content).toBe(`const fo¦o = 'hello world';`);\n-    const scriptInfo = service.getScriptInfo(APP_MAIN);\n-    // script info content should not contain cursor\n-    expect(getText(scriptInfo)).toBe(`const foo = 'hello world';`);\n+  describe('overwrite()', () => {\n+    it('will return the cursor position', () => {\n+      const {position} = service.overwrite(APP_MAIN, `const fo¦o = 'hello world';`);\n+      expect(position).toBe(8);\n+    });\n+\n+    it('will remove the cursor in overwritten text', () => {\n+      const {text} = service.overwrite(APP_MAIN, `const fo¦o = 'hello world';`);\n+      expect(text).toBe(`const foo = 'hello world';`);\n+    });\n+\n+    it('will update script info without cursor', () => {\n+      const {text} = service.overwrite(APP_MAIN, `const fo¦o = 'hello world';`);\n+      const scriptInfo = service.getScriptInfo(APP_MAIN);\n+      const snapshot = getText(scriptInfo);\n+      expect(snapshot).toBe(`const foo = 'hello world';`);\n+      expect(snapshot).toBe(text);\n+    });\n+\n+    it('will throw if there is more than one cursor', () => {\n+      expect(() => service.overwrite(APP_MAIN, `const f¦oo = 'hello wo¦rld';`))\n+          .toThrowError(/matches more than one occurrence in text/);\n+    });\n+\n+    it('will return -1 if cursor is not present', () => {\n+      const {position} = service.overwrite(APP_MAIN, `const foo = 'hello world';`);\n+      expect(position).toBe(-1);\n+    });\n+  });\n+\n+  describe('overwriteInlineTemplate()', () => {\n+    it('will return the cursor position', () => {\n+      const {position, text} = service.overwriteInlineTemplate(APP_COMPONENT, `{{ fo¦o }}`);\n+      // The position returned should be relative to the start of the source\n+      // file, not the start of the template.\n+      expect(position).not.toBe(5);\n+      expect(text.substring(position, position + 4)).toBe('o }}');\n+    });\n+\n+    it('will remove the cursor in overwritten text', () => {\n+      const {text} = service.overwriteInlineTemplate(APP_COMPONENT, `{{ fo¦o }}`);\n+      expect(text).toContain(`{{ foo }}`);\n+    });\n+\n+    it('will return the entire content of the source file', () => {\n+      const {text} = service.overwriteInlineTemplate(APP_COMPONENT, `{{ foo }}`);\n+      expect(text).toContain(`@Component`);\n+    });\n+\n+    it('will update script info without cursor', () => {\n+      service.overwriteInlineTemplate(APP_COMPONENT, `{{ fo¦o }}`);\n+      const scriptInfo = service.getScriptInfo(APP_COMPONENT);\n+      expect(getText(scriptInfo)).toContain(`{{ foo }}`);\n+    });\n+\n+    it('will throw if there is no template in file', () => {\n+      expect(() => service.overwriteInlineTemplate(APP_MAIN, `{{ foo }}`))\n+          .toThrowError(/does not contain a component with template/);\n+    });\n+\n+    it('will throw if there is more than one cursor', () => {\n+      expect(() => service.overwriteInlineTemplate(APP_COMPONENT, `{{ f¦o¦o }}`))\n+          .toThrowError(/matches more than one occurrence in text/);\n+    });\n+\n+    it('will return -1 if cursor is not present', () => {\n+      const {position} = service.overwriteInlineTemplate(APP_COMPONENT, `{{ foo }}`);\n+      expect(position).toBe(-1);\n+    });\n+\n+    it('will throw if there is more than one component with template', () => {\n+      service.overwrite(APP_COMPONENT, `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          template: \\`<h1></h1>\\`,\n+        })\n+        export class ComponentA {}\n+\n+        @Component({\n+          template: \\`<h2></h2>\\`,\n+        })\n+        export class ComponentB {}\n+      `);\n+      expect(() => service.overwriteInlineTemplate(APP_COMPONENT, `<p></p>`))\n+          .toThrowError(/matches more than one occurrence in text/);\n+    });\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 172,
        "additions": 148,
        "deletions": 24
    }
}