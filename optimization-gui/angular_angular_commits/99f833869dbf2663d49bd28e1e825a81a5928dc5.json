{
    "author": "josephperrott",
    "message": "feat(dev-infra): include experimental version stamp in env stamps (#42934)\n\nInclude the determined experimental version for stamping in the env stamps\ncreated for release and snapshot builds.\n\nPR Close #42934",
    "sha": "99f833869dbf2663d49bd28e1e825a81a5928dc5",
    "files": [
        {
            "sha": "d97df3d361ebb1fef951802e2a8f671254be1cb2",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 18,
            "deletions": 9,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=99f833869dbf2663d49bd28e1e825a81a5928dc5",
            "patch": "@@ -6201,6 +6201,7 @@ function semverInc(version, release, identifier) {\n }\n /** Creates the equivalent experimental version for a provided SemVer. */\n function createExperimentalSemver(version) {\n+    version = new semver.SemVer(version);\n     var experimentalVersion = new semver.SemVer(version.format());\n     experimentalVersion.major = 0;\n     experimentalVersion.minor = version.major * 100 + version.minor;\n@@ -7681,7 +7682,9 @@ function buildEnvStamp(mode) {\n     console.info(`BUILD_SCM_HASH ${getCurrentBranchOrRevision()}`);\n     console.info(`BUILD_SCM_LOCAL_CHANGES ${hasLocalChanges()}`);\n     console.info(`BUILD_SCM_USER ${getCurrentGitUser()}`);\n-    console.info(`BUILD_SCM_VERSION ${getSCMVersion(mode)}`);\n+    const { version, experimentalVersion } = getSCMVersions(mode);\n+    console.info(`BUILD_SCM_VERSION ${version}`);\n+    console.info(`BUILD_SCM_EXPERIMENTAL_VERSION ${experimentalVersion}`);\n     process.exit();\n }\n /** Whether the repo has local changes. */\n@@ -7690,24 +7693,30 @@ function hasLocalChanges() {\n     return git.hasUncommittedChanges();\n }\n /**\n- * Get the version for generated packages.\n+ * Get the versions for generated packages.\n  *\n  * In snapshot mode, the version is based on the most recent semver tag.\n  * In release mode, the version is based on the base package.json version.\n  */\n-function getSCMVersion(mode) {\n+function getSCMVersions(mode) {\n     const git = GitClient.get();\n     if (mode === 'release') {\n         const packageJsonPath = path.join(git.baseDir, 'package.json');\n-        const { version } = require(packageJsonPath);\n-        return version;\n+        const { version } = new semver.SemVer(require(packageJsonPath).version);\n+        const { version: experimentalVersion } = createExperimentalSemver(new semver.SemVer(version));\n+        return { version, experimentalVersion };\n     }\n     if (mode === 'snapshot') {\n-        const version = git.run(['describe', '--match', '[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD'])\n-            .stdout.trim();\n-        return `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${(hasLocalChanges() ? '.with-local-changes' : '')}`;\n+        const localChanges = hasLocalChanges() ? '.with-local-changes' : '';\n+        const { stdout: rawVersion } = git.run(['describe', '--match', '*[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD~100']);\n+        const { version } = new semver.SemVer(rawVersion);\n+        const { version: experimentalVersion } = createExperimentalSemver(version);\n+        return {\n+            version: `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+            experimentalVersion: `${experimentalVersion.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+        };\n     }\n-    return '0.0.0';\n+    throw Error('No environment stamp mode was provided.');\n }\n /** Get the current branch or revision of HEAD. */\n function getCurrentBranchOrRevision() {"
        },
        {
            "sha": "54b73c76a12b8901c21c94165471a844ebde35a3",
            "filename": "dev-infra/release/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Frelease%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Frelease%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2FBUILD.bazel?ref=99f833869dbf2663d49bd28e1e825a81a5928dc5",
            "patch": "@@ -14,7 +14,9 @@ ts_library(\n         \"//dev-infra/release/set-dist-tag\",\n         \"//dev-infra/utils\",\n         \"@npm//@types/node\",\n+        \"@npm//@types/semver\",\n         \"@npm//@types/yargs\",\n+        \"@npm//semver\",\n         \"@npm//yargs\",\n     ],\n )"
        },
        {
            "sha": "17fd158ba0377341661a0e1709ae0d65f866781a",
            "filename": "dev-infra/release/stamping/env-stamp.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 11,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "raw_url": "https://github.com/angular/angular/raw/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fstamping%2Fenv-stamp.ts?ref=99f833869dbf2663d49bd28e1e825a81a5928dc5",
            "patch": "@@ -7,7 +7,9 @@\n  */\n \n import {join} from 'path';\n+import {SemVer} from 'semver';\n import {GitClient} from '../../utils/git/git-client';\n+import {createExperimentalSemver} from '../../utils/semver';\n \n export type EnvStampMode = 'snapshot'|'release';\n \n@@ -27,7 +29,9 @@ export function buildEnvStamp(mode: EnvStampMode) {\n   console.info(`BUILD_SCM_HASH ${getCurrentBranchOrRevision()}`);\n   console.info(`BUILD_SCM_LOCAL_CHANGES ${hasLocalChanges()}`);\n   console.info(`BUILD_SCM_USER ${getCurrentGitUser()}`);\n-  console.info(`BUILD_SCM_VERSION ${getSCMVersion(mode)}`);\n+  const {version, experimentalVersion} = getSCMVersions(mode);\n+  console.info(`BUILD_SCM_VERSION ${version}`);\n+  console.info(`BUILD_SCM_EXPERIMENTAL_VERSION ${experimentalVersion}`);\n   process.exit();\n }\n \n@@ -38,26 +42,32 @@ function hasLocalChanges() {\n }\n \n /**\n- * Get the version for generated packages.\n+ * Get the versions for generated packages.\n  *\n  * In snapshot mode, the version is based on the most recent semver tag.\n  * In release mode, the version is based on the base package.json version.\n  */\n-function getSCMVersion(mode: EnvStampMode) {\n+function getSCMVersions(mode: EnvStampMode): {version: string, experimentalVersion: string} {\n   const git = GitClient.get();\n   if (mode === 'release') {\n     const packageJsonPath = join(git.baseDir, 'package.json');\n-    const {version} = require(packageJsonPath);\n-    return version;\n+    const {version} = new SemVer(require(packageJsonPath).version);\n+    const {version: experimentalVersion} = createExperimentalSemver(new SemVer(version));\n+    return {version, experimentalVersion};\n   }\n   if (mode === 'snapshot') {\n-    const version =\n-        git.run(['describe', '--match', '[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD'])\n-            .stdout.trim();\n-    return `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${\n-        (hasLocalChanges() ? '.with-local-changes' : '')}`;\n+    const localChanges = hasLocalChanges() ? '.with-local-changes' : '';\n+    const {stdout: rawVersion} = git.run(\n+        ['describe', '--match', '*[0-9]*.[0-9]*.[0-9]*', '--abbrev=7', '--tags', 'HEAD~100']);\n+    const {version} = new SemVer(rawVersion);\n+    const {version: experimentalVersion} = createExperimentalSemver(version);\n+    return {\n+      version: `${version.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+      experimentalVersion:\n+          `${experimentalVersion.replace(/-([0-9]+)-g/, '+$1.sha-')}${localChanges}`,\n+    };\n   }\n-  return '0.0.0';\n+  throw Error('No environment stamp mode was provided.');\n }\n \n /** Get the current branch or revision of HEAD. */"
        },
        {
            "sha": "ad2141435ff31177ab862d817b98adeb5ecdb068",
            "filename": "dev-infra/utils/semver.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Futils%2Fsemver.ts",
            "raw_url": "https://github.com/angular/angular/raw/99f833869dbf2663d49bd28e1e825a81a5928dc5/dev-infra%2Futils%2Fsemver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fsemver.ts?ref=99f833869dbf2663d49bd28e1e825a81a5928dc5",
            "patch": "@@ -19,7 +19,8 @@ export function semverInc(\n }\n \n /** Creates the equivalent experimental version for a provided SemVer. */\n-export function createExperimentalSemver(version: semver.SemVer): semver.SemVer {\n+export function createExperimentalSemver(version: string|semver.SemVer): semver.SemVer {\n+  version = new semver.SemVer(version);\n   const experimentalVersion = new semver.SemVer(version.format());\n   experimentalVersion.major = 0;\n   experimentalVersion.minor = version.major * 100 + version.minor;"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 43,
        "deletions": 21
    }
}