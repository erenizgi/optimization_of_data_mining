{
    "author": "atscott",
    "message": "refactor(compiler-cli): add keySpan to parsed events (#39609)\n\nThough we currently have the knowledge of where the `key` for an\nevent binding appears during parsing, we do not propagate this\ninformation to the output AST. This means that once we produce the\ntemplate AST, we have no way of mapping a template position to the key\nspan alone. The best we can currently do is map back to the\n`sourceSpan`. This presents problems downstream, specifically for the\nlanguage service, where we cannot provide correct information about a\nposition in a template because the AST is not granular enough.\n\nThis is essentially identical to the change from #38898, but for event\nbindings rather than input bindings.\n\nPR Close #39609",
    "sha": "c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
    "files": [
        {
            "sha": "327311a1dd9100c96cfb0f267039f1e0e9a42d2d",
            "filename": "packages/compiler/src/expression_parser/ast.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -869,7 +869,7 @@ export class ParsedProperty {\n \n   constructor(\n       public name: string, public expression: ASTWithSource, public type: ParsedPropertyType,\n-      // TODO(atscott): `keySpan` should really be required but allows `undefined` so VE does\n+      // TODO(FW-2095): `keySpan` should really be required but allows `undefined` so VE does\n       // not need to be updated. Make `keySpan` required when VE is removed.\n       public sourceSpan: ParseSourceSpan, readonly keySpan: ParseSourceSpan|undefined,\n       public valueSpan: ParseSourceSpan|undefined) {\n@@ -897,7 +897,8 @@ export class ParsedEvent {\n   constructor(\n       public name: string, public targetOrPhase: string, public type: ParsedEventType,\n       public handler: ASTWithSource, public sourceSpan: ParseSourceSpan,\n-      public handlerSpan: ParseSourceSpan) {}\n+      // TODO(FW-2095): keySpan should be required but was made optional to avoid changing VE\n+      public handlerSpan: ParseSourceSpan, readonly keySpan: ParseSourceSpan|undefined) {}\n }\n \n /**"
        },
        {
            "sha": "68153667b12a0b7c9aa972015116e31df77ef52a",
            "filename": "packages/compiler/src/render3/r3_ast.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_ast.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -73,14 +73,19 @@ export class BoundEvent implements Node {\n   constructor(\n       public name: string, public type: ParsedEventType, public handler: AST,\n       public target: string|null, public phase: string|null, public sourceSpan: ParseSourceSpan,\n-      public handlerSpan: ParseSourceSpan) {}\n+      public handlerSpan: ParseSourceSpan, readonly keySpan: ParseSourceSpan) {}\n \n   static fromParsedEvent(event: ParsedEvent) {\n     const target: string|null = event.type === ParsedEventType.Regular ? event.targetOrPhase : null;\n     const phase: string|null =\n         event.type === ParsedEventType.Animation ? event.targetOrPhase : null;\n+    if (event.keySpan === undefined) {\n+      throw new Error(`Unexpected state: keySpan must be defined for bound event but was not for ${\n+          event.name}: ${event.sourceSpan}`);\n+    }\n     return new BoundEvent(\n-        event.name, event.type, event.handler, target, phase, event.sourceSpan, event.handlerSpan);\n+        event.name, event.type, event.handler, target, phase, event.sourceSpan, event.handlerSpan,\n+        event.keySpan);\n   }\n \n   visit<Result>(visitor: Visitor<Result>): Result {"
        },
        {
            "sha": "3019bfb3b3b3f401b7b887380ae2e6571d8142f8",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -361,9 +361,10 @@ class HtmlAstToIvyAst implements html.Visitor {\n       } else if (bindParts[KW_ON_IDX]) {\n         const events: ParsedEvent[] = [];\n         const identifier = bindParts[IDENT_KW_IDX];\n+        const keySpan = createKeySpan(srcSpan, bindParts[KW_ON_IDX], identifier);\n         this.bindingParser.parseEvent(\n-            identifier, value, srcSpan, attribute.valueSpan || srcSpan, matchableAttributes,\n-            events);\n+            identifier, value, srcSpan, attribute.valueSpan || srcSpan, matchableAttributes, events,\n+            keySpan);\n         addEvents(events, boundEvents);\n       } else if (bindParts[KW_BINDON_IDX]) {\n         const identifier = bindParts[IDENT_KW_IDX];\n@@ -372,7 +373,8 @@ class HtmlAstToIvyAst implements html.Visitor {\n             identifier, value, false, srcSpan, absoluteOffset, attribute.valueSpan,\n             matchableAttributes, parsedProperties, keySpan);\n         this.parseAssignmentEvent(\n-            identifier, value, srcSpan, attribute.valueSpan, matchableAttributes, boundEvents);\n+            identifier, value, srcSpan, attribute.valueSpan, matchableAttributes, boundEvents,\n+            keySpan);\n       } else if (bindParts[KW_AT_IDX]) {\n         const keySpan = createKeySpan(srcSpan, '', name);\n         this.bindingParser.parseLiteralAttr(\n@@ -399,23 +401,23 @@ class HtmlAstToIvyAst implements html.Visitor {\n         // TODO(ayazhafiz): update this to handle malformed bindings.\n         name.endsWith(delims.end) && name.length > delims.start.length + delims.end.length) {\n       const identifier = name.substring(delims.start.length, name.length - delims.end.length);\n+      const keySpan = createKeySpan(srcSpan, delims.start, identifier);\n       if (delims.start === BINDING_DELIMS.BANANA_BOX.start) {\n-        const keySpan = createKeySpan(srcSpan, delims.start, identifier);\n         this.bindingParser.parsePropertyBinding(\n             identifier, value, false, srcSpan, absoluteOffset, attribute.valueSpan,\n             matchableAttributes, parsedProperties, keySpan);\n         this.parseAssignmentEvent(\n-            identifier, value, srcSpan, attribute.valueSpan, matchableAttributes, boundEvents);\n+            identifier, value, srcSpan, attribute.valueSpan, matchableAttributes, boundEvents,\n+            keySpan);\n       } else if (delims.start === BINDING_DELIMS.PROPERTY.start) {\n-        const keySpan = createKeySpan(srcSpan, delims.start, identifier);\n         this.bindingParser.parsePropertyBinding(\n             identifier, value, false, srcSpan, absoluteOffset, attribute.valueSpan,\n             matchableAttributes, parsedProperties, keySpan);\n       } else {\n         const events: ParsedEvent[] = [];\n         this.bindingParser.parseEvent(\n-            identifier, value, srcSpan, attribute.valueSpan || srcSpan, matchableAttributes,\n-            events);\n+            identifier, value, srcSpan, attribute.valueSpan || srcSpan, matchableAttributes, events,\n+            keySpan);\n         addEvents(events, boundEvents);\n       }\n \n@@ -463,11 +465,11 @@ class HtmlAstToIvyAst implements html.Visitor {\n   private parseAssignmentEvent(\n       name: string, expression: string, sourceSpan: ParseSourceSpan,\n       valueSpan: ParseSourceSpan|undefined, targetMatchableAttrs: string[][],\n-      boundEvents: t.BoundEvent[]) {\n+      boundEvents: t.BoundEvent[], keySpan: ParseSourceSpan) {\n     const events: ParsedEvent[] = [];\n     this.bindingParser.parseEvent(\n         `${name}Change`, `${expression}=$event`, sourceSpan, valueSpan || sourceSpan,\n-        targetMatchableAttrs, events);\n+        targetMatchableAttrs, events, keySpan);\n     addEvents(events, boundEvents);\n   }\n "
        },
        {
            "sha": "ea3636673a5dcbe55854d072109ac436d6e81d15",
            "filename": "packages/compiler/src/template_parser/binding_parser.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -97,8 +97,14 @@ export class BindingParser {\n       Object.keys(dirMeta.hostListeners).forEach(propName => {\n         const expression = dirMeta.hostListeners[propName];\n         if (typeof expression === 'string') {\n-          // TODO: pass a more accurate handlerSpan for this event.\n-          this.parseEvent(propName, expression, sourceSpan, sourceSpan, [], targetEvents);\n+          // Use the `sourceSpan` for  `keySpan` and `handlerSpan`. This isn't really accurate, but\n+          // neither is the `sourceSpan`, as it represents the `sourceSpan` of the host itself\n+          // rather than the source of the host binding (which doesn't exist in the template).\n+          // Regardless, neither of these values are used in Ivy but are only here to satisfy the\n+          // function signature. This should likely be refactored in the future so that `sourceSpan`\n+          // isn't being used inaccurately.\n+          this.parseEvent(\n+              propName, expression, sourceSpan, sourceSpan, [], targetEvents, sourceSpan);\n         } else {\n           this._reportError(\n               `Value of the host listener \"${\n@@ -408,19 +414,20 @@ export class BindingParser {\n         boundProp.sourceSpan, boundProp.keySpan, boundProp.valueSpan);\n   }\n \n+  // TODO: keySpan should be required but was made optional to avoid changing VE parser.\n   parseEvent(\n       name: string, expression: string, sourceSpan: ParseSourceSpan, handlerSpan: ParseSourceSpan,\n-      targetMatchableAttrs: string[][], targetEvents: ParsedEvent[]) {\n+      targetMatchableAttrs: string[][], targetEvents: ParsedEvent[], keySpan?: ParseSourceSpan) {\n     if (name.length === 0) {\n       this._reportError(`Event name is missing in binding`, sourceSpan);\n     }\n \n     if (isAnimationLabel(name)) {\n       name = name.substr(1);\n-      this._parseAnimationEvent(name, expression, sourceSpan, handlerSpan, targetEvents);\n+      this._parseAnimationEvent(name, expression, sourceSpan, handlerSpan, targetEvents, keySpan);\n     } else {\n       this._parseRegularEvent(\n-          name, expression, sourceSpan, handlerSpan, targetMatchableAttrs, targetEvents);\n+          name, expression, sourceSpan, handlerSpan, targetMatchableAttrs, targetEvents, keySpan);\n     }\n   }\n \n@@ -432,7 +439,7 @@ export class BindingParser {\n \n   private _parseAnimationEvent(\n       name: string, expression: string, sourceSpan: ParseSourceSpan, handlerSpan: ParseSourceSpan,\n-      targetEvents: ParsedEvent[]) {\n+      targetEvents: ParsedEvent[], keySpan?: ParseSourceSpan) {\n     const matches = splitAtPeriod(name, [name, '']);\n     const eventName = matches[0];\n     const phase = matches[1].toLowerCase();\n@@ -442,7 +449,7 @@ export class BindingParser {\n         case 'done':\n           const ast = this._parseAction(expression, handlerSpan);\n           targetEvents.push(new ParsedEvent(\n-              eventName, phase, ParsedEventType.Animation, ast, sourceSpan, handlerSpan));\n+              eventName, phase, ParsedEventType.Animation, ast, sourceSpan, handlerSpan, keySpan));\n           break;\n \n         default:\n@@ -462,13 +469,13 @@ export class BindingParser {\n \n   private _parseRegularEvent(\n       name: string, expression: string, sourceSpan: ParseSourceSpan, handlerSpan: ParseSourceSpan,\n-      targetMatchableAttrs: string[][], targetEvents: ParsedEvent[]) {\n+      targetMatchableAttrs: string[][], targetEvents: ParsedEvent[], keySpan?: ParseSourceSpan) {\n     // long format: 'target: eventName'\n     const [target, eventName] = splitAtColon(name, [null!, name]);\n     const ast = this._parseAction(expression, handlerSpan);\n     targetMatchableAttrs.push([name!, ast.source!]);\n-    targetEvents.push(\n-        new ParsedEvent(eventName, target, ParsedEventType.Regular, ast, sourceSpan, handlerSpan));\n+    targetEvents.push(new ParsedEvent(\n+        eventName, target, ParsedEventType.Regular, ast, sourceSpan, handlerSpan, keySpan));\n     // Don't detect directives for event names for now,\n     // so don't add the event name to the matchableAttrs\n   }"
        },
        {
            "sha": "3b1ef79825cebda35db7df9b6cc552afdc293d32",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -78,8 +78,10 @@ class R3AstSourceSpans implements t.Visitor<void> {\n   }\n \n   visitBoundEvent(event: t.BoundEvent) {\n-    this.result.push(\n-        ['BoundEvent', humanizeSpan(event.sourceSpan), humanizeSpan(event.handlerSpan)]);\n+    this.result.push([\n+      'BoundEvent', humanizeSpan(event.sourceSpan), humanizeSpan(event.keySpan),\n+      humanizeSpan(event.handlerSpan)\n+    ]);\n   }\n \n   visitText(text: t.Text) {\n@@ -356,45 +358,45 @@ describe('R3 AST source spans', () => {\n     it('is correct for event names case sensitive', () => {\n       expectFromHtml('<div (someEvent)=\"v\"></div>').toEqual([\n         ['Element', '<div (someEvent)=\"v\"></div>', '<div (someEvent)=\"v\">', '</div>'],\n-        ['BoundEvent', '(someEvent)=\"v\"', 'v'],\n+        ['BoundEvent', '(someEvent)=\"v\"', 'someEvent', 'v'],\n       ]);\n     });\n \n     it('is correct for bound events via on-', () => {\n       expectFromHtml('<div on-event=\"v\"></div>').toEqual([\n         ['Element', '<div on-event=\"v\"></div>', '<div on-event=\"v\">', '</div>'],\n-        ['BoundEvent', 'on-event=\"v\"', 'v'],\n+        ['BoundEvent', 'on-event=\"v\"', 'event', 'v'],\n       ]);\n     });\n \n     it('is correct for bound events via data-on-', () => {\n       expectFromHtml('<div data-on-event=\"v\"></div>').toEqual([\n         ['Element', '<div data-on-event=\"v\"></div>', '<div data-on-event=\"v\">', '</div>'],\n-        ['BoundEvent', 'data-on-event=\"v\"', 'v'],\n+        ['BoundEvent', 'data-on-event=\"v\"', 'event', 'v'],\n       ]);\n     });\n \n     it('is correct for bound events and properties via [(...)]', () => {\n       expectFromHtml('<div [(prop)]=\"v\"></div>').toEqual([\n         ['Element', '<div [(prop)]=\"v\"></div>', '<div [(prop)]=\"v\">', '</div>'],\n         ['BoundAttribute', '[(prop)]=\"v\"', 'prop', 'v'],\n-        ['BoundEvent', '[(prop)]=\"v\"', 'v'],\n+        ['BoundEvent', '[(prop)]=\"v\"', 'prop', 'v'],\n       ]);\n     });\n \n     it('is correct for bound events and properties via bindon-', () => {\n       expectFromHtml('<div bindon-prop=\"v\"></div>').toEqual([\n         ['Element', '<div bindon-prop=\"v\"></div>', '<div bindon-prop=\"v\">', '</div>'],\n         ['BoundAttribute', 'bindon-prop=\"v\"', 'prop', 'v'],\n-        ['BoundEvent', 'bindon-prop=\"v\"', 'v'],\n+        ['BoundEvent', 'bindon-prop=\"v\"', 'prop', 'v'],\n       ]);\n     });\n \n     it('is correct for bound events and properties via data-bindon-', () => {\n       expectFromHtml('<div data-bindon-prop=\"v\"></div>').toEqual([\n         ['Element', '<div data-bindon-prop=\"v\"></div>', '<div data-bindon-prop=\"v\">', '</div>'],\n         ['BoundAttribute', 'data-bindon-prop=\"v\"', 'prop', 'v'],\n-        ['BoundEvent', 'data-bindon-prop=\"v\"', 'v'],\n+        ['BoundEvent', 'data-bindon-prop=\"v\"', 'prop', 'v'],\n       ]);\n     });\n   });"
        },
        {
            "sha": "117f572593834573b8d3487d89465745f6803853",
            "filename": "packages/language-service/ivy/test/definitions_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdefinitions_spec.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -199,7 +199,7 @@ describe('definitions', () => {\n       it('should work for event providers', () => {\n         const definitions = getDefinitionsAndAssertBoundSpan({\n           templateOverride: `<test-comp (te¦st)=\"myClick($event)\"></test-comp>`,\n-          expectedSpanText: '(test)=\"myClick($event)\"',\n+          expectedSpanText: 'test',\n         });\n         expect(definitions!.length).toEqual(1);\n \n@@ -218,7 +218,7 @@ describe('definitions', () => {\n       it('should return the directive when the event is part of the selector', () => {\n         const definitions = getDefinitionsAndAssertBoundSpan({\n           templateOverride: `<div (eventSelect¦or)=\"title = ''\"></div>`,\n-          expectedSpanText: `(eventSelector)=\"title = ''\"`,\n+          expectedSpanText: `eventSelector`,\n         });\n         expect(definitions!.length).toEqual(2);\n "
        },
        {
            "sha": "b8a6b5b6d615775a43056bf921a0c7c94ecfe50e",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c33326c5382508c8b2c0a805abdb29c4c7cc0b5f/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=c33326c5382508c8b2c0a805abdb29c4c7cc0b5f",
            "patch": "@@ -156,20 +156,20 @@ describe('quick info', () => {\n       it('should work for event providers', () => {\n         expectQuickInfo({\n           templateOverride: `<test-comp (te¦st)=\"myClick($event)\"></test-comp>`,\n-          expectedSpanText: '(test)=\"myClick($event)\"',\n+          expectedSpanText: 'test',\n           expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<any>'\n         });\n       });\n \n       it('should work for on- syntax binding', () => {\n         expectQuickInfo({\n           templateOverride: `<test-comp on-te¦st=\"myClick($event)\"></test-comp>`,\n-          expectedSpanText: 'on-test=\"myClick($event)\"',\n+          expectedSpanText: 'test',\n           expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<any>'\n         });\n         expectQuickInfo({\n           templateOverride: `<test-comp data-on-te¦st=\"myClick($event)\"></test-comp>`,\n-          expectedSpanText: 'data-on-test=\"myClick($event)\"',\n+          expectedSpanText: 'test',\n           expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<any>'\n         });\n       });"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 54,
        "deletions": 37
    }
}