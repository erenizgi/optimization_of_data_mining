{
    "author": "petebacondarwin",
    "message": "fix(migrations): account for CRLF characters in template migrations (#44013)\n\nPreviously, when parsing code for templates to migrate, CRLF characters were converted to just LF.\nThis meant that the source-spans being used to overwrite the template strings in the original source code were out of sync with the positions identified in the parsed templates.\n\nThis commit fixes this by parsing the raw text of the template taken from the source code instead of processed string contents.\n\nFixes #44005\n\nPR Close #44013",
    "sha": "3fada9ee7e670be8dfd59fe4a168c292830a6f2d",
    "files": [
        {
            "sha": "be2f78a3078d8851c424680dd8485e5b5f5a9b59",
            "filename": "packages/core/schematics/test/routerlink_empty_expr_migration_spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/3fada9ee7e670be8dfd59fe4a168c292830a6f2d/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3fada9ee7e670be8dfd59fe4a168c292830a6f2d/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Frouterlink_empty_expr_migration_spec.ts?ref=3fada9ee7e670be8dfd59fe4a168c292830a6f2d",
            "patch": "@@ -76,7 +76,7 @@ describe('routerlink emptyExpr assignment migration', () => {\n \n     await runMigration();\n     expect(warnOutput.length).toBe(1);\n-    expect(warnOutput[0]).toMatch(/^⮑ {3}index.ts@5:25/);\n+    expect(warnOutput[0]).toMatch(/^⮑ {3}index\\.ts@5:25/);\n \n     const content = tree.readContent('/index.ts');\n     expect(content).toContain(`<div [routerLink]=\"[]\"></div>`);\n@@ -101,7 +101,7 @@ describe('routerlink emptyExpr assignment migration', () => {\n     await runMigration();\n \n     expect(warnOutput.length).toBe(1);\n-    expect(warnOutput).toMatch(/^⮑ {3}tmpl.html@3:20/);\n+    expect(warnOutput).toMatch(/^⮑ {3}tmpl\\.html@3:20/);\n \n     const content = tree.readContent('/tmpl.html');\n     expect(content).toContain(`<some-comp [routerLink]=\"[]\"></some-comp>`);\n@@ -215,9 +215,30 @@ describe('routerlink emptyExpr assignment migration', () => {\n \n     await runMigration();\n     expect(warnOutput.length).toBe(1);\n-    expect(warnOutput[0]).toMatch(/^⮑ {3}index.ts@4:35/);\n+    expect(warnOutput[0]).toMatch(/^⮑ {3}index\\.ts@4:35/);\n \n     const content = tree.readContent('/index.ts');\n     expect(content).toContain(`<div [routerLink]='[]'>\\r\\n{{1}}\\r\\n</div>`);\n   });\n+\n+  it('should work for files that use CRLF line endings before routerLink bindings', async () => {\n+    writeFile(\n+        '/index.ts',\n+        `\n+      import {Component} from '@angular/core';\n+\n+      @Component({` +\n+            'template: `' +\n+            '\\r\\n\\r\\n\\r\\n<div [routerLink]>{{1}}</div>`' +\n+            `})\n+      export class MyComp {}\n+    `);\n+\n+    await runMigration();\n+    expect(warnOutput.length).toBe(1);\n+    expect(warnOutput[0]).toMatch(/^⮑ {3}index\\.ts@7:6/);\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toContain(`\\r\\n\\r\\n\\r\\n<div [routerLink]=\"[]\">{{1}}</div>`);\n+  });\n });"
        },
        {
            "sha": "8c2c5c34217f7e90684a7b3f26ebd035ee6554a0",
            "filename": "packages/core/schematics/utils/ng_component_template.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/3fada9ee7e670be8dfd59fe4a168c292830a6f2d/packages%2Fcore%2Fschematics%2Futils%2Fng_component_template.ts",
            "raw_url": "https://github.com/angular/angular/raw/3fada9ee7e670be8dfd59fe4a168c292830a6f2d/packages%2Fcore%2Fschematics%2Futils%2Fng_component_template.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Futils%2Fng_component_template.ts?ref=3fada9ee7e670be8dfd59fe4a168c292830a6f2d",
            "patch": "@@ -97,16 +97,24 @@ export class NgComponentTemplateVisitor {\n       if (propertyName === 'template' && ts.isStringLiteralLike(property.initializer)) {\n         // Need to add an offset of one to the start because the template quotes are\n         // not part of the template content.\n-        const templateStartIdx = property.initializer.getStart() + 1;\n+        // The `getText()` method gives us the original raw text.\n+        // We could have used the `text` property, but if the template is defined as a backtick\n+        // string then the `text` property contains a \"cooked\" version of the string. Such cooked\n+        // strings will have converted CRLF characters to only LF. This messes up string\n+        // replacements in template migrations.\n+        // The raw text returned by `getText()` includes the enclosing quotes so we change the\n+        // `content` and `start` values accordingly.\n+        const content = property.initializer.getText().slice(1, -1);\n+        const start = property.initializer.getStart() + 1;\n         const filePath = resolve(sourceFileName);\n         this.resolvedTemplates.push({\n           filePath: filePath,\n           container: node,\n-          content: property.initializer.text,\n+          content,\n           inline: true,\n-          start: templateStartIdx,\n+          start: start,\n           getCharacterAndLineOfPosition: pos =>\n-              ts.getLineAndCharacterOfPosition(sourceFile, pos + templateStartIdx)\n+              ts.getLineAndCharacterOfPosition(sourceFile, pos + start)\n         });\n       }\n       if (propertyName === 'templateUrl' && ts.isStringLiteralLike(property.initializer)) {"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 36,
        "deletions": 7
    }
}