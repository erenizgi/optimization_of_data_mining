{
    "author": "atscott",
    "message": "feat(core): Add schematic to fix invalid `Route` configs (#40067)\n\n`Route` configs with `redirectTo` as well as `canActivate` are not valid\nbecause the `canActivate` guards will never execute. Redirects are\napplied before activation. There is no error currently for these\nconfigs, but another commit will change this so that an error does\nappear in dev mode. This migration fixes the configs by removing the\n`canActivate` property.\n\nPR Close #40067",
    "sha": "805b4f936bc0da41a00aac938bcd60605a1d25ac",
    "files": [
        {
            "sha": "4934255a82dd6a61e920adec48c94916fc56ee17",
            "filename": "packages/core/schematics/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2FBUILD.bazel?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -11,6 +11,7 @@ pkg_npm(\n     visibility = [\"//packages/core:__pkg__\"],\n     deps = [\n         \"//packages/core/schematics/migrations/abstract-control-parent\",\n+        \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n         \"//packages/core/schematics/migrations/dynamic-queries\",\n         \"//packages/core/schematics/migrations/initial-navigation\",\n         \"//packages/core/schematics/migrations/missing-injectable\","
        },
        {
            "sha": "9d6d557e64e9bf212e869882f2328a95894844e4",
            "filename": "packages/core/schematics/migrations.json",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations.json?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -79,6 +79,11 @@\n       \"version\": \"11.0.0-beta\",\n       \"description\": \"Updates the `initialNavigation` property for `RouterModule.forRoot`.\",\n       \"factory\": \"./migrations/initial-navigation/index\"\n+    },\n+    \"migration-v11.1-can-activate-with-redirect-to\": {\n+      \"version\": \"11.1.0-beta\",\n+      \"description\": \"Removes `canActivate` from a `Route` config when `redirectTo` is also present\",\n+      \"factory\": \"./migrations/can-activate-with-redirect-to/index\"\n     }\n   }\n-}\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "38990660897a8ad462c729e7737be00b41640a24",
            "filename": "packages/core/schematics/migrations/can-activate-with-redirect-to/BUILD.bazel",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2FBUILD.bazel?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,18 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"can-activate-with-redirect-to\",\n+    srcs = glob([\"**/*.ts\"]),\n+    tsconfig = \"//packages/core/schematics:tsconfig.json\",\n+    visibility = [\n+        \"//packages/core/schematics:__pkg__\",\n+        \"//packages/core/schematics/migrations/google3:__pkg__\",\n+        \"//packages/core/schematics/test:__pkg__\",\n+    ],\n+    deps = [\n+        \"//packages/core/schematics/utils\",\n+        \"@npm//@angular-devkit/schematics\",\n+        \"@npm//@types/node\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "e640403ec8c0e69a1665aa00ced44a33151bbfb1",
            "filename": "packages/core/schematics/migrations/can-activate-with-redirect-to/README.md",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2FREADME.md?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,23 @@\n+## Router migration to remove canActivate property from Routes that also have redirectTo\n+\n+The activation stage of the router happens after redirects so any `canActivate` guards\n+will not be executed. This invalid configuration is now an error. This migration \n+removes `canActivate` from the `Route` to fix pre-existing invalid configurations.\n+\n+#### Before\n+```ts\n+import { Routes } from '@angular/router';\n+\n+const routes: Routes = [\n+  {path: '', redirectTo: 'other', canActivate: [MyGuard]}\n+];\n+```\n+\n+#### After\n+```ts\n+import { Routes } from '@angular/router';\n+\n+const routes: Routes = [\n+  {path: '', redirectTo: 'other'}\n+];\n+```"
        },
        {
            "sha": "34578470f5eee42e0cb53b382fd5a2d9af67a5ae",
            "filename": "packages/core/schematics/migrations/can-activate-with-redirect-to/index.ts",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2Findex.ts?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,56 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Rule, SchematicsException, Tree} from '@angular-devkit/schematics';\n+import {relative} from 'path';\n+import * as ts from 'typescript';\n+\n+import {getProjectTsConfigPaths} from '../../utils/project_tsconfig_paths';\n+import {canMigrateFile, createMigrationProgram} from '../../utils/typescript/compiler_host';\n+import {findLiteralsToMigrate, migrateLiteral} from './util';\n+\n+\n+/** Migration that removes `canActivate` property from routes that also have `redirectTo`. */\n+export default function(): Rule {\n+  return (tree: Tree) => {\n+    const {buildPaths, testPaths} = getProjectTsConfigPaths(tree);\n+    const basePath = process.cwd();\n+    const allPaths = [...buildPaths, ...testPaths];\n+\n+    if (!allPaths.length) {\n+      throw new SchematicsException(\n+          'Could not find any tsconfig file. Cannot migrate ' +\n+          'Router.navigateByUrl and Router.createUrlTree calls.');\n+    }\n+\n+    for (const tsconfigPath of allPaths) {\n+      runCanActivateWithRedirectToMigration(tree, tsconfigPath, basePath);\n+    }\n+  };\n+}\n+\n+function runCanActivateWithRedirectToMigration(tree: Tree, tsconfigPath: string, basePath: string) {\n+  const {program} = createMigrationProgram(tree, tsconfigPath, basePath);\n+  const printer = ts.createPrinter();\n+  const sourceFiles =\n+      program.getSourceFiles().filter(sourceFile => canMigrateFile(basePath, sourceFile, program));\n+\n+  sourceFiles.forEach(sourceFile => {\n+    const literalsToMigrate = findLiteralsToMigrate(sourceFile);\n+    const update = tree.beginUpdate(relative(basePath, sourceFile.fileName));\n+\n+    for (const literal of Array.from(literalsToMigrate)) {\n+      const migratedNode = migrateLiteral(literal);\n+      update.remove(literal.getStart(), literal.getWidth());\n+      update.insertRight(\n+          literal.getStart(), printer.printNode(ts.EmitHint.Unspecified, migratedNode, sourceFile));\n+    }\n+\n+    tree.commitUpdate(update);\n+  });\n+}"
        },
        {
            "sha": "63a6684317a874a46ddd2db67975b9b2c9f7a82d",
            "filename": "packages/core/schematics/migrations/can-activate-with-redirect-to/util.ts",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fcan-activate-with-redirect-to%2Futil.ts?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,62 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+const CAN_ACTIVATE = 'canActivate';\n+const REDIRECT_TO = 'redirectTo';\n+\n+export function migrateLiteral(node: ts.ObjectLiteralExpression): ts.ObjectLiteralExpression {\n+  const propertiesToKeep: ts.ObjectLiteralElementLike[] = [];\n+  node.properties.forEach(property => {\n+    // Only look for regular and shorthand property assignments since resolving things\n+    // like spread operators becomes too complicated for this migration.\n+    if ((ts.isPropertyAssignment(property) || ts.isShorthandPropertyAssignment(property)) &&\n+        (ts.isStringLiteralLike(property.name) || ts.isNumericLiteral(property.name) ||\n+         ts.isIdentifier(property.name))) {\n+      if (property.name.text !== CAN_ACTIVATE) {\n+        propertiesToKeep.push(property);\n+      }\n+    } else {\n+      propertiesToKeep.push(property);\n+    }\n+  });\n+\n+  return ts.createObjectLiteral(propertiesToKeep);\n+}\n+\n+\n+export function findLiteralsToMigrate(sourceFile: ts.SourceFile) {\n+  const results = new Set<ts.ObjectLiteralExpression>();\n+\n+  sourceFile.forEachChild(function visitNode(node: ts.Node) {\n+    if (!ts.isObjectLiteralExpression(node)) {\n+      node.forEachChild(visitNode);\n+      return;\n+    }\n+    if (hasProperty(node, REDIRECT_TO) && hasProperty(node, CAN_ACTIVATE)) {\n+      results.add(node);\n+    }\n+  });\n+\n+  return results;\n+}\n+\n+function hasProperty(node: ts.ObjectLiteralExpression, propertyName: string): boolean {\n+  for (const property of node.properties) {\n+    // Only look for regular and shorthand property assignments since resolving things\n+    // like spread operators becomes too complicated for this migration.\n+    if ((ts.isPropertyAssignment(property) || ts.isShorthandPropertyAssignment(property)) &&\n+        (ts.isStringLiteralLike(property.name) || ts.isNumericLiteral(property.name) ||\n+         ts.isIdentifier(property.name)) &&\n+        property.name.text === propertyName) {\n+      return true;\n+    }\n+  }\n+  return false;\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "1fcd8e91f9de0c56f2e4f3f066c576fe072451c5",
            "filename": "packages/core/schematics/migrations/google3/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FBUILD.bazel?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     tsconfig = \"//packages/core/schematics:tsconfig.json\",\n     visibility = [\"//packages/core/schematics/test/google3:__pkg__\"],\n     deps = [\n+        \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n         \"//packages/core/schematics/migrations/dynamic-queries\",\n         \"//packages/core/schematics/migrations/initial-navigation\",\n         \"//packages/core/schematics/migrations/initial-navigation/google3\","
        },
        {
            "sha": "d920e136b4b39a6cb0f4e39492fd44c0a19b6adc",
            "filename": "packages/core/schematics/migrations/google3/canActivateWithRedirectToRule.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FcanActivateWithRedirectToRule.ts",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FcanActivateWithRedirectToRule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Fmigrations%2Fgoogle3%2FcanActivateWithRedirectToRule.ts?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,33 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Replacement, RuleFailure, Rules} from 'tslint';\n+import * as ts from 'typescript';\n+import {findLiteralsToMigrate, migrateLiteral} from '../can-activate-with-redirect-to/util';\n+\n+\n+/** TSLint rule that removes canActivate from Route configs that also have redirectTo. */\n+export class Rule extends Rules.TypedRule {\n+  applyWithProgram(sourceFile: ts.SourceFile, program: ts.Program): RuleFailure[] {\n+    const failures: RuleFailure[] = [];\n+    const printer = ts.createPrinter();\n+    const literalsToMigrate = findLiteralsToMigrate(sourceFile);\n+\n+    for (const literal of Array.from(literalsToMigrate)) {\n+      const migratedNode = migrateLiteral(literal);\n+      failures.push(new RuleFailure(\n+          sourceFile, literal.getStart(), literal.getEnd(),\n+          'canActivate cannot be used with redirectTo.', this.ruleName,\n+          new Replacement(\n+              literal.getStart(), literal.getWidth(),\n+              printer.printNode(ts.EmitHint.Unspecified, migratedNode, sourceFile))));\n+    }\n+\n+    return failures;\n+  }\n+}"
        },
        {
            "sha": "c6d62041e8977dae2f239cd2b1a7297a26b7ca7e",
            "filename": "packages/core/schematics/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2FBUILD.bazel?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -9,6 +9,7 @@ ts_library(\n     ],\n     deps = [\n         \"//packages/core/schematics/migrations/abstract-control-parent\",\n+        \"//packages/core/schematics/migrations/can-activate-with-redirect-to\",\n         \"//packages/core/schematics/migrations/dynamic-queries\",\n         \"//packages/core/schematics/migrations/initial-navigation\",\n         \"//packages/core/schematics/migrations/missing-injectable\","
        },
        {
            "sha": "24c750b9361f31245ac69eb0a6fa7c7419a18178",
            "filename": "packages/core/schematics/test/can_activate_with_redirect_migration_spec.ts",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Ftest%2Fcan_activate_with_redirect_migration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Ftest%2Fcan_activate_with_redirect_migration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fcan_activate_with_redirect_migration_spec.ts?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,78 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {getSystemPath, normalize, virtualFs} from '@angular-devkit/core';\n+import {TempScopedNodeJsSyncHost} from '@angular-devkit/core/node/testing';\n+import {HostTree} from '@angular-devkit/schematics';\n+import {SchematicTestRunner, UnitTestTree} from '@angular-devkit/schematics/testing';\n+import * as shx from 'shelljs';\n+\n+describe('canActivate removal with redirectTo', () => {\n+  let runner: SchematicTestRunner;\n+  let host: TempScopedNodeJsSyncHost;\n+  let tree: UnitTestTree;\n+  let tmpDirPath: string;\n+  let previousWorkingDir: string;\n+\n+  beforeEach(() => {\n+    runner = new SchematicTestRunner('test', require.resolve('../migrations.json'));\n+    host = new TempScopedNodeJsSyncHost();\n+    tree = new UnitTestTree(new HostTree(host));\n+\n+    writeFile('/tsconfig.json', JSON.stringify({\n+      compilerOptions: {\n+        lib: ['es2015'],\n+        strictNullChecks: true,\n+      },\n+    }));\n+    writeFile('/angular.json', JSON.stringify({\n+      projects: {t: {architect: {build: {options: {tsConfig: './tsconfig.json'}}}}}\n+    }));\n+\n+    previousWorkingDir = shx.pwd();\n+    tmpDirPath = getSystemPath(host.root);\n+\n+    // Switch into the temporary directory path. This allows us to run\n+    // the schematic against our custom unit test tree.\n+    shx.cd(tmpDirPath);\n+  });\n+\n+  afterEach(() => {\n+    shx.cd(previousWorkingDir);\n+    shx.rm('-r', tmpDirPath);\n+  });\n+\n+  it('should not remove canActivate when redirectTo is not present', async () => {\n+    writeFile('/index.ts', `const route = {path: '', canActivate: ['my_guard_token']}`);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toEqual(`const route = {path: '', canActivate: ['my_guard_token']}`);\n+  });\n+\n+  it('removes canActivate when redirectTo is present', async () => {\n+    writeFile(\n+        '/index.ts',\n+        `const route = {path: '', redirectTo: 'other', canActivate: ['my_guard_token']}`);\n+\n+    await runMigration();\n+\n+    const content = tree.readContent('/index.ts');\n+    expect(content).toEqual(`const route = { path: '', redirectTo: 'other' }`);\n+  });\n+\n+  function writeFile(filePath: string, contents: string) {\n+    host.sync.write(normalize(filePath), virtualFs.stringToFileBuffer(contents));\n+  }\n+\n+  function runMigration() {\n+    return runner.runSchematicAsync('migration-v11.1-can-activate-with-redirect-to', {}, tree)\n+        .toPromise();\n+  }\n+});"
        },
        {
            "sha": "0f3a479c5cf6edb5f0eb63823a1bcfadd86c07cf",
            "filename": "packages/core/schematics/test/google3/can_activate_with_redirect_rule_spec.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/angular/angular/blob/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Fcan_activate_with_redirect_rule_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/805b4f936bc0da41a00aac938bcd60605a1d25ac/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Fcan_activate_with_redirect_rule_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fschematics%2Ftest%2Fgoogle3%2Fcan_activate_with_redirect_rule_spec.ts?ref=805b4f936bc0da41a00aac938bcd60605a1d25ac",
            "patch": "@@ -0,0 +1,83 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {readFileSync, writeFileSync} from 'fs';\n+import {dirname, join} from 'path';\n+import * as shx from 'shelljs';\n+import {Configuration, Linter} from 'tslint';\n+\n+describe('Google3 canActivate with redirectTo', () => {\n+  const rulesDirectory =\n+      dirname(require.resolve('../../migrations/google3/canActivateWithRedirectToRule'));\n+\n+  let tmpDir: string;\n+\n+  beforeEach(() => {\n+    tmpDir = join(process.env['TEST_TMPDIR']!, 'google3-test');\n+    shx.mkdir('-p', tmpDir);\n+\n+    writeFile('tsconfig.json', JSON.stringify({\n+      compilerOptions: {\n+        module: 'es2015',\n+        baseUrl: './',\n+      },\n+    }));\n+  });\n+\n+  afterEach(() => shx.rm('-r', tmpDir));\n+\n+  function runTSLint(fix: boolean) {\n+    const program = Linter.createProgram(join(tmpDir, 'tsconfig.json'));\n+    const linter = new Linter({fix, rulesDirectory: [rulesDirectory]}, program);\n+    const config = Configuration.parseConfigFile({rules: {'can-activate-with-redirect-to': true}});\n+\n+    program.getRootFileNames().forEach(fileName => {\n+      linter.lint(fileName, program.getSourceFile(fileName)!.getFullText(), config);\n+    });\n+\n+    return linter;\n+  }\n+\n+  function writeFile(fileName: string, content: string) {\n+    writeFileSync(join(tmpDir, fileName), content);\n+  }\n+\n+  function getFile(fileName: string) {\n+    return readFileSync(join(tmpDir, fileName), 'utf8');\n+  }\n+\n+  it('should not flag canActivate when redirectTo is not present', async () => {\n+    writeFile('/index.ts', `const route = {path: '', canActivate: ['my_guard_token']}`);\n+\n+    const linter = runTSLint(false);\n+    const failures = linter.getResult().failures.map(failure => failure.getFailure());\n+\n+    expect(failures.length).toBe(0);\n+  });\n+\n+  it('should flag when canActivate when redirectTo is present', async () => {\n+    writeFile(\n+        '/index.ts',\n+        `const route = {path: '', redirectTo: 'other', canActivate: ['my_guard_token']}`);\n+\n+    const linter = runTSLint(false);\n+    const failures = linter.getResult().failures.map(failure => failure.getFailure());\n+    expect(failures.length).toBe(1);\n+    expect(failures[0]).toMatch(/canActivate cannot be used with redirectTo./);\n+  });\n+\n+  it('should fix when canActivate when redirectTo is present', async () => {\n+    writeFile(\n+        '/index.ts',\n+        `const route = {path: '', redirectTo: 'other', canActivate: ['my_guard_token']}`);\n+\n+    runTSLint(true);\n+    const content = getFile('/index.ts');\n+    expect(content).toContain(`const route = { path: '', redirectTo: 'other' }`);\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 363,
        "additions": 362,
        "deletions": 1
    }
}