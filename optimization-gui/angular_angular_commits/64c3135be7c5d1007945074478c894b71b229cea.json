{
    "author": "ayazhafiz",
    "message": "refactor(compiler-cli): provide a host to readConfiguration (#39619)\n\nCurrently `readConfiguration` relies on the file system to perform disk\nutilities needed to read determine a project configuration file and read\nit. This poses a challenge for the language service, which would like to\nuse `readConfiguration` to watch and read configurations dependent on\nextended tsconfigs (#39134). Challenges are at least twofold:\n\n1. To test this, the langauge service would need to provide to the\n   compiler a mock file system.\n2. The language service uses file system utilities primarily through\n   TypeScript's `Project` abstraction. In general this should correspond\n   to the underlying file system, but it may differ and it is better to\n   go through one channel when possible.\n\nThis patch alleviates the concern by directly providing to the compiler\na \"ParseConfigurationHost\" with read-only \"file system\"-like utilties.\nFor the language service, this host is derived from the project owned by\nthe language service.\n\nFor more discussion see\nhttps://docs.google.com/document/d/1TrbT-m7bqyYZICmZYHjnJ7NG9Vzt5Rd967h43Qx8jw0/edit?usp=sharing\n\nPR Close #39619",
    "sha": "64c3135be7c5d1007945074478c894b71b229cea",
    "files": [
        {
            "sha": "3ec3ca0783277aa7125cdad856b03b09f897d2c9",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 17,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -9,7 +9,7 @@\n import {isSyntaxError, Position} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {absoluteFrom, AbsoluteFsPath, getFileSystem, relative, resolve} from '../src/ngtsc/file_system';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, relative, resolve} from '../src/ngtsc/file_system';\n \n import {replaceTsWithNgInErrors} from './ngtsc/diagnostics';\n import * as api from './transformers/api';\n@@ -108,6 +108,11 @@ export function formatDiagnostics(\n   }\n }\n \n+// TODO(ayazhafiz): split FileSystem into a ReadonlyFileSystem and make this a\n+// subset of that.\n+export type ParseConfigurationHost =\n+    Pick<FileSystem, 'readFile'|'exists'|'lstat'|'resolve'|'join'|'dirname'|'extname'|'pwd'>;\n+\n export interface ParsedConfiguration {\n   project: string;\n   options: api.CompilerOptions;\n@@ -117,14 +122,14 @@ export interface ParsedConfiguration {\n   errors: Diagnostics;\n }\n \n-export function calcProjectFileAndBasePath(project: string):\n+export function calcProjectFileAndBasePath(\n+    project: string, host: ParseConfigurationHost = getFileSystem()):\n     {projectFile: AbsoluteFsPath, basePath: AbsoluteFsPath} {\n-  const fs = getFileSystem();\n-  const absProject = fs.resolve(project);\n-  const projectIsDir = fs.lstat(absProject).isDirectory();\n-  const projectFile = projectIsDir ? fs.join(absProject, 'tsconfig.json') : absProject;\n-  const projectDir = projectIsDir ? absProject : fs.dirname(absProject);\n-  const basePath = fs.resolve(projectDir);\n+  const absProject = host.resolve(project);\n+  const projectIsDir = host.lstat(absProject).isDirectory();\n+  const projectFile = projectIsDir ? host.join(absProject, 'tsconfig.json') : absProject;\n+  const projectDir = projectIsDir ? absProject : host.dirname(absProject);\n+  const basePath = host.resolve(projectDir);\n   return {projectFile, basePath};\n }\n \n@@ -139,14 +144,15 @@ export function createNgCompilerOptions(\n }\n \n export function readConfiguration(\n-    project: string, existingOptions?: ts.CompilerOptions): ParsedConfiguration {\n+    project: string, existingOptions?: ts.CompilerOptions,\n+    host: ParseConfigurationHost = getFileSystem()): ParsedConfiguration {\n   try {\n-    const fs = getFileSystem();\n-    const {projectFile, basePath} = calcProjectFileAndBasePath(project);\n+    const {projectFile, basePath} = calcProjectFileAndBasePath(project, host);\n \n     const readExtendedConfigFile =\n         (configFile: string, existingConfig?: any): {config?: any, error?: ts.Diagnostic} => {\n-          const {config, error} = ts.readConfigFile(configFile, ts.sys.readFile);\n+          const {config, error} =\n+              ts.readConfigFile(configFile, file => host.readFile(host.resolve(file)));\n \n           if (error) {\n             return {error};\n@@ -163,12 +169,12 @@ export function readConfiguration(\n           }\n \n           if (config.extends) {\n-            let extendedConfigPath = fs.resolve(fs.dirname(configFile), config.extends);\n-            extendedConfigPath = fs.extname(extendedConfigPath) ?\n+            let extendedConfigPath = host.resolve(host.dirname(configFile), config.extends);\n+            extendedConfigPath = host.extname(extendedConfigPath) ?\n                 extendedConfigPath :\n                 absoluteFrom(`${extendedConfigPath}.json`);\n \n-            if (fs.exists(extendedConfigPath)) {\n+            if (host.exists(extendedConfigPath)) {\n               // Call read config recursively as TypeScript only merges CompilerOptions\n               return readExtendedConfigFile(extendedConfigPath, baseConfig);\n             }\n@@ -190,11 +196,11 @@ export function readConfiguration(\n     }\n     const parseConfigHost = {\n       useCaseSensitiveFileNames: true,\n-      fileExists: fs.exists.bind(fs),\n+      fileExists: host.exists.bind(host),\n       readDirectory: ts.sys.readDirectory,\n       readFile: ts.sys.readFile\n     };\n-    const configFileName = fs.resolve(fs.pwd(), projectFile);\n+    const configFileName = host.resolve(host.pwd(), projectFile);\n     const parsed = ts.parseJsonConfigFileContent(\n         config, parseConfigHost, basePath, existingOptions, configFileName);\n     const rootNames = parsed.fileNames;"
        },
        {
            "sha": "ce37cd763144028d82dc729a32bcfa67ee6b1da8",
            "filename": "packages/language-service/ivy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2FBUILD.bazel?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -17,6 +17,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "db23b165883685c60279af0bd9ffa0e483ab81fa",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 15,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -6,15 +6,15 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CompilerOptions, createNgCompilerOptions} from '@angular/compiler-cli';\n+import {CompilerOptions, formatDiagnostics, ParseConfigurationHost, readConfiguration} from '@angular/compiler-cli';\n import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {CompilerFactory} from './compiler_factory';\n import {DefinitionBuilder} from './definitions';\n-import {LanguageServiceAdapter} from './language_service_adapter';\n+import {LanguageServiceAdapter, LSParseConfigHost} from './language_service_adapter';\n import {QuickInfoBuilder} from './quick_info';\n import {getTargetAtPosition} from './template_target';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n@@ -24,15 +24,21 @@ export class LanguageService {\n   readonly compilerFactory: CompilerFactory;\n   private readonly strategy: TypeCheckingProgramStrategy;\n   private readonly adapter: LanguageServiceAdapter;\n+  private readonly parseConfigHost: LSParseConfigHost;\n \n   constructor(project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n-    this.options = parseNgCompilerOptions(project);\n+    this.parseConfigHost = new LSParseConfigHost(project);\n+    this.options = parseNgCompilerOptions(project, this.parseConfigHost);\n     this.strategy = createTypeCheckingProgramStrategy(project);\n     this.adapter = new LanguageServiceAdapter(project);\n     this.compilerFactory = new CompilerFactory(this.adapter, this.strategy, this.options);\n     this.watchConfigFile(project);\n   }\n \n+  getCompilerOptions(): CompilerOptions {\n+    return this.options;\n+  }\n+\n   getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n     const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n     const ttc = compiler.getTemplateTypeChecker();\n@@ -104,24 +110,24 @@ export class LanguageService {\n         project.getConfigFilePath(), (fileName: string, eventKind: ts.FileWatcherEventKind) => {\n           project.log(`Config file changed: ${fileName}`);\n           if (eventKind === ts.FileWatcherEventKind.Changed) {\n-            this.options = parseNgCompilerOptions(project);\n+            this.options = parseNgCompilerOptions(project, this.parseConfigHost);\n           }\n         });\n   }\n }\n \n-export function parseNgCompilerOptions(project: ts.server.Project): CompilerOptions {\n-  let config = {};\n-  if (project instanceof ts.server.ConfiguredProject) {\n-    const configPath = project.getConfigFilePath();\n-    const result = ts.readConfigFile(configPath, path => project.readFile(path));\n-    if (result.error) {\n-      project.error(ts.flattenDiagnosticMessageText(result.error.messageText, '\\n'));\n-    }\n-    config = result.config || config;\n+export function parseNgCompilerOptions(\n+    project: ts.server.Project, host: ParseConfigurationHost): CompilerOptions {\n+  if (!(project instanceof ts.server.ConfiguredProject)) {\n+    return {};\n   }\n-  const basePath = project.getCurrentDirectory();\n-  return createNgCompilerOptions(basePath, config, project.getCompilationSettings());\n+  const {options, errors} =\n+      readConfiguration(project.getConfigFilePath(), /* existingOptions */ undefined, host);\n+  if (errors.length > 0) {\n+    project.error(formatDiagnostics(errors));\n+  }\n+\n+  return options;\n }\n \n function createTypeCheckingProgramStrategy(project: ts.server.Project):"
        },
        {
            "sha": "928c3b3e702f26dea9da406840c875fc574c23f3",
            "filename": "packages/language-service/ivy/language_service_adapter.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 1,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -6,9 +6,11 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {ParseConfigurationHost} from '@angular/compiler-cli';\n import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n-import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom, AbsoluteFsPath, FileStats, PathSegment, PathString} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n+import * as p from 'path';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {isTypeScriptFile} from './utils';\n@@ -78,3 +80,53 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n     return lastVersion !== latestVersion;\n   }\n }\n+\n+/**\n+ * Used to read configuration files.\n+ *\n+ * A language service parse configuration host is independent of the adapter\n+ * because signatures of calls like `FileSystem#readFile` are a bit stricter\n+ * than those on the adapter.\n+ */\n+export class LSParseConfigHost implements ParseConfigurationHost {\n+  private readonly host: ts.server.ServerHost = this.project.projectService.host;\n+  constructor(private readonly project: ts.server.Project) {}\n+  exists(path: AbsoluteFsPath): boolean {\n+    return this.project.fileExists(path) || this.project.directoryExists(path);\n+  }\n+  readFile(path: AbsoluteFsPath): string {\n+    const content = this.project.readFile(path);\n+    if (content === undefined) {\n+      throw new Error(`LanguageServiceFS#readFile called on unavailable file ${path}`);\n+    }\n+    return content;\n+  }\n+  lstat(path: AbsoluteFsPath): FileStats {\n+    return {\n+      isFile: () => {\n+        return this.project.fileExists(path);\n+      },\n+      isDirectory: () => {\n+        return this.project.directoryExists(path);\n+      },\n+      isSymbolicLink: () => {\n+        throw new Error(`LanguageServiceFS#lstat#isSymbolicLink not implemented`);\n+      },\n+    };\n+  }\n+  pwd(): AbsoluteFsPath {\n+    return this.project.getCurrentDirectory() as AbsoluteFsPath;\n+  }\n+  extname(path: AbsoluteFsPath|PathSegment): string {\n+    return p.extname(path);\n+  }\n+  resolve(...paths: string[]): AbsoluteFsPath {\n+    return this.host.resolvePath(this.join(paths[0], ...paths.slice(1))) as AbsoluteFsPath;\n+  }\n+  dirname<T extends PathString>(file: T): T {\n+    return p.dirname(file) as T;\n+  }\n+  join<T extends PathString>(basePath: T, ...paths: string[]): T {\n+    return p.join(basePath, ...paths) as T;\n+  }\n+}"
        },
        {
            "sha": "71ff969447d7d4c4daa388a075d62879d59ce91a",
            "filename": "packages/language-service/ivy/test/legacy/language_service_spec.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 7,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_spec.ts?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -8,33 +8,66 @@\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {LanguageService, parseNgCompilerOptions} from '../../language_service';\n+import {LanguageService} from '../../language_service';\n \n-import {MockService, setup, TEST_TEMPLATE} from './mock_host';\n+import {MockConfigFileFs, MockService, setup, TEST_TEMPLATE, TSCONFIG} from './mock_host';\n \n describe('language service adapter', () => {\n   let project: ts.server.Project;\n   let service: MockService;\n   let ngLS: LanguageService;\n+  let configFileFs: MockConfigFileFs;\n \n   beforeAll(() => {\n-    const {project: _project, tsLS, service: _service} = setup();\n+    const {project: _project, tsLS, service: _service, configFileFs: _configFileFs} = setup();\n     project = _project;\n     service = _service;\n     ngLS = new LanguageService(project, tsLS);\n+    configFileFs = _configFileFs;\n   });\n \n-  describe('parseNgCompilerOptions', () => {\n-    it('should read angularCompilerOptions in tsconfig.json', () => {\n-      const options = parseNgCompilerOptions(project);\n-      expect(options).toEqual(jasmine.objectContaining({\n+  afterEach(() => {\n+    configFileFs.clear();\n+  });\n+\n+  describe('parse compiler options', () => {\n+    beforeEach(() => {\n+      // Need to reset project on each test to reinitialize file watchers.\n+      const {project: _project, tsLS, service: _service, configFileFs: _configFileFs} = setup();\n+      project = _project;\n+      service = _service;\n+      configFileFs = _configFileFs;\n+      ngLS = new LanguageService(project, tsLS);\n+    });\n+\n+    it('should initialize with angularCompilerOptions from tsconfig.json', () => {\n+      expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n         enableIvy: true,  // default for ivy is true\n         strictTemplates: true,\n         strictInjectionParameters: true,\n       }));\n     });\n+\n+    it('should reparse angularCompilerOptions on tsconfig.json change', () => {\n+      expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n+        enableIvy: true,  // default for ivy is true\n+        strictTemplates: true,\n+        strictInjectionParameters: true,\n+      }));\n+\n+      configFileFs.overwriteConfigFile(TSCONFIG, `{\n+         \"angularCompilerOptions\": {\n+           \"strictTemplates\": false\n+         }\n+       }`);\n+\n+      expect(ngLS.getCompilerOptions()).toEqual(jasmine.objectContaining({\n+        strictTemplates: false,\n+      }));\n+    });\n   });\n \n+\n   describe('last known program', () => {\n     beforeEach(() => {\n       service.reset();"
        },
        {
            "sha": "f1b6f3f4e0f6cf9d2180e8772e1bf6b20979c67c",
            "filename": "packages/language-service/ivy/test/legacy/mock_host.ts",
            "status": "modified",
            "additions": 94,
            "deletions": 26,
            "changes": 120,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -43,31 +43,97 @@ const NOOP_FILE_WATCHER: ts.FileWatcher = {\n   close() {}\n };\n \n-export const host: ts.server.ServerHost = {\n-  ...ts.sys,\n-  readFile(absPath: string, encoding?: string): string |\n-      undefined {\n-        return ts.sys.readFile(absPath, encoding);\n-      },\n-  watchFile(path: string, callback: ts.FileWatcherCallback): ts.FileWatcher {\n-    return NOOP_FILE_WATCHER;\n-  },\n-  watchDirectory(path: string, callback: ts.DirectoryWatcherCallback): ts.FileWatcher {\n-    return NOOP_FILE_WATCHER;\n-  },\n-  setTimeout() {\n-    throw new Error('setTimeout is not implemented');\n-  },\n-  clearTimeout() {\n-    throw new Error('clearTimeout is not implemented');\n-  },\n-  setImmediate() {\n-    throw new Error('setImmediate is not implemented');\n-  },\n-  clearImmediate() {\n-    throw new Error('clearImmediate is not implemented');\n-  },\n-};\n+class MockWatcher implements ts.FileWatcher {\n+  constructor(\n+      private readonly fileName: string,\n+      private readonly cb: ts.FileWatcherCallback,\n+      readonly close: () => void,\n+  ) {}\n+\n+  changed() {\n+    this.cb(this.fileName, ts.FileWatcherEventKind.Changed);\n+  }\n+\n+  deleted() {\n+    this.cb(this.fileName, ts.FileWatcherEventKind.Deleted);\n+  }\n+}\n+\n+/**\n+ * A mock file system impacting configuration files.\n+ * Queries for all other files are deferred to the underlying filesystem.\n+ */\n+export class MockConfigFileFs implements\n+    Pick<ts.server.ServerHost, 'readFile'|'fileExists'|'watchFile'> {\n+  private configOverwrites = new Map<string, string>();\n+  private configFileWatchers = new Map<string, MockWatcher>();\n+\n+  overwriteConfigFile(configFile: string, contents: string) {\n+    if (!configFile.endsWith('.json')) {\n+      throw new Error(`${configFile} is not a configuration file.`);\n+    }\n+    this.configOverwrites.set(configFile, contents);\n+    this.configFileWatchers.get(configFile)?.changed();\n+  }\n+\n+  readFile(file: string, encoding?: string): string|undefined {\n+    const read = this.configOverwrites.get(file) ?? ts.sys.readFile(file, encoding);\n+    return read;\n+  }\n+\n+  fileExists(file: string): boolean {\n+    return this.configOverwrites.has(file) || ts.sys.fileExists(file);\n+  }\n+\n+  watchFile(path: string, callback: ts.FileWatcherCallback) {\n+    if (!path.endsWith('.json')) {\n+      // We only care about watching config files.\n+      return NOOP_FILE_WATCHER;\n+    }\n+    const watcher = new MockWatcher(path, callback, () => {\n+      this.configFileWatchers.delete(path);\n+    });\n+    this.configFileWatchers.set(path, watcher);\n+    return watcher;\n+  }\n+\n+  clear() {\n+    this.configOverwrites.clear();\n+    this.configFileWatchers.clear();\n+  }\n+}\n+\n+function createHost(configFileFs: MockConfigFileFs): ts.server.ServerHost {\n+  return {\n+    ...ts.sys,\n+    fileExists(absPath: string): boolean {\n+      return configFileFs.fileExists(absPath);\n+    },\n+    readFile(absPath: string, encoding?: string): string |\n+        undefined {\n+          return configFileFs.readFile(absPath, encoding);\n+        },\n+    watchFile(path: string, callback: ts.FileWatcherCallback): ts.FileWatcher {\n+      return configFileFs.watchFile(path, callback);\n+    },\n+    watchDirectory(path: string, callback: ts.DirectoryWatcherCallback): ts.FileWatcher {\n+      return NOOP_FILE_WATCHER;\n+    },\n+    setTimeout() {\n+      throw new Error('setTimeout is not implemented');\n+    },\n+    clearTimeout() {\n+      throw new Error('clearTimeout is not implemented');\n+    },\n+    setImmediate() {\n+      throw new Error('setImmediate is not implemented');\n+    },\n+    clearImmediate() {\n+      throw new Error('clearImmediate is not implemented');\n+    },\n+  };\n+}\n+\n \n /**\n  * Create a ConfiguredProject and an actual program for the test project located\n@@ -76,8 +142,9 @@ export const host: ts.server.ServerHost = {\n  * and modify test files.\n  */\n export function setup() {\n+  const configFileFs = new MockConfigFileFs();\n   const projectService = new ts.server.ProjectService({\n-    host,\n+    host: createHost(configFileFs),\n     logger,\n     cancellationToken: ts.server.nullCancellationToken,\n     useSingleInferredProject: true,\n@@ -97,6 +164,7 @@ export function setup() {\n     service: new MockService(project, projectService),\n     project,\n     tsLS,\n+    configFileFs,\n   };\n }\n "
        }
    ],
    "stats": {
        "total": 298,
        "additions": 232,
        "deletions": 66
    }
}