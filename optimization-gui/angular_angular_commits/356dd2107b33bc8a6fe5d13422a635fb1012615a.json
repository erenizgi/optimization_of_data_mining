{
    "author": "gkalpak",
    "message": "refactor(service-worker): simplify accessing `CacheStorage` throughout the ServiceWorker (#42622)\n\nThis commit simplifies/systemizes accessing the `CacheStorage` through a\nwrapper, with the following benefits:\n- Ensuring a consistent cache name prefix is used for all caches\n  (without having to repeat the prefix in different places).\n- Allowing referring to caches using their name without the common\n  cache name prefix.\n- Exposing the cache name on cache instances, which for example makes it\n  easier to delete caches without having to keep track of the name used\n  to create them.\n\nPR Close #42622",
    "sha": "356dd2107b33bc8a6fe5d13422a635fb1012615a",
    "files": [
        {
            "sha": "68152ec565e1bcdd49e5a0dde74c94e4c0fc72c5",
            "filename": "packages/service-worker/test/integration_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Ftest%2Fintegration_spec.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -87,7 +87,7 @@ describe('ngsw + companion lib', () => {\n     mock = new MockServiceWorkerContainer();\n     comm = new NgswCommChannel(mock as any);\n     scope = new SwTestHarnessBuilder().withServerState(server).build();\n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n     scope.clients.add('default');\n     scope.clients.getMock('default')!.queue.subscribe(msg => {"
        },
        {
            "sha": "4d380fc253b646f76b3e966f76db6337c07a796e",
            "filename": "packages/service-worker/worker/main.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fmain.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -10,7 +10,7 @@ import {Adapter} from './src/adapter';\n import {CacheDatabase} from './src/db-cache';\n import {Driver} from './src/driver';\n \n-const scope = self as any as ServiceWorkerGlobalScope;\n+const scope = self as unknown as ServiceWorkerGlobalScope;\n \n-const adapter = new Adapter(scope.registration.scope);\n-const driver = new Driver(scope, adapter, new CacheDatabase(scope, adapter));\n+const adapter = new Adapter(scope.registration.scope, self.caches);\n+new Driver(scope, adapter, new CacheDatabase(adapter));"
        },
        {
            "sha": "c711436d1e791de9b25eb13f8358eced622a24c0",
            "filename": "packages/service-worker/worker/src/adapter.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fadapter.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import {NormalizedUrl} from './api';\n+import {NamedCacheStorage} from './named-cache-storage';\n \n \n /**\n@@ -15,20 +16,20 @@ import {NormalizedUrl} from './api';\n  * Mostly, this is used to mock out identifiers which are otherwise read\n  * from the global scope.\n  */\n-export class Adapter {\n-  readonly cacheNamePrefix: string;\n+export class Adapter<T extends CacheStorage = CacheStorage> {\n+  readonly caches: NamedCacheStorage<T>;\n   private readonly origin: string;\n \n-  constructor(protected readonly scopeUrl: string) {\n+  constructor(protected readonly scopeUrl: string, caches: T) {\n     const parsedScopeUrl = this.parseUrl(this.scopeUrl);\n \n     // Determine the origin from the registration scope. This is used to differentiate between\n     // relative and absolute URLs.\n     this.origin = parsedScopeUrl.origin;\n \n-    // Suffixing `ngsw` with the baseHref to avoid clash of cache names for SWs with different\n-    // scopes on the same domain.\n-    this.cacheNamePrefix = 'ngsw:' + parsedScopeUrl.path;\n+    // Use the baseHref in the cache name prefix to avoid clash of cache names for SWs with\n+    // different scopes on the same domain.\n+    this.caches = new NamedCacheStorage(caches, `ngsw:${parsedScopeUrl.path}`);\n   }\n \n   /**"
        },
        {
            "sha": "d04b57dfebdacb0459130b59f05d7820e3c1a38c",
            "filename": "packages/service-worker/worker/src/assets.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 13,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fassets.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -12,6 +12,7 @@ import {Database, Table} from './database';\n import {errorToString, SwCriticalError, SwUnrecoverableStateError} from './error';\n import {IdleScheduler} from './idle';\n import {AssetGroupConfig} from './manifest';\n+import {NamedCache} from './named-cache-storage';\n import {sha1Binary} from './sha1';\n \n /**\n@@ -40,7 +41,7 @@ export abstract class AssetGroup {\n    * A Promise which resolves to the `Cache` used to back this asset group. This\n    * is opened from the constructor.\n    */\n-  protected cache: Promise<Cache>;\n+  protected cache: Promise<NamedCache>;\n \n   /**\n    * Group name from the configuration.\n@@ -55,8 +56,7 @@ export abstract class AssetGroup {\n   constructor(\n       protected scope: ServiceWorkerGlobalScope, protected adapter: Adapter,\n       protected idle: IdleScheduler, protected config: AssetGroupConfig,\n-      protected hashes: Map<string, string>, protected db: Database,\n-      protected cacheNamePrefix: string) {\n+      protected hashes: Map<string, string>, protected db: Database, cacheNamePrefix: string) {\n     this.name = config.name;\n \n     // Normalize the config's URLs to take the ServiceWorker's scope into account.\n@@ -67,8 +67,7 @@ export abstract class AssetGroup {\n \n     // This is the primary cache, which holds all of the cached requests for this group. If a\n     // resource isn't in this cache, it hasn't been fetched yet.\n-    this.cache =\n-        scope.caches.open(`${adapter.cacheNamePrefix}:${cacheNamePrefix}:${config.name}:cache`);\n+    this.cache = adapter.caches.open(`${cacheNamePrefix}:${config.name}:cache`);\n \n     // This is the metadata table, which holds specific information for each cached URL, such as\n     // the timestamp of when it was added to the cache.\n@@ -104,9 +103,10 @@ export abstract class AssetGroup {\n    * Clean up all the cached data for this group.\n    */\n   async cleanup(): Promise<void> {\n-    await this.scope.caches.delete(\n-        `${this.adapter.cacheNamePrefix}:${this.cacheNamePrefix}:${this.config.name}:cache`);\n-    await this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:meta`);\n+    await Promise.all([\n+      this.cache.then(cache => this.adapter.caches.delete(cache.name)),\n+      this.metadata.then(metadata => this.db.delete(metadata.name)),\n+    ]);\n   }\n \n   /**\n@@ -138,11 +138,9 @@ export abstract class AssetGroup {\n           // This resource has no hash, and yet exists in the cache. Check how old this request is\n           // to make sure it's still usable.\n           if (await this.needToRevalidate(req, cachedResponse)) {\n-            this.idle.schedule(\n-                `revalidate(${this.cacheNamePrefix}, ${this.config.name}): ${req.url}`,\n-                async () => {\n-                  await this.fetchAndCacheOnce(req);\n-                });\n+            this.idle.schedule(`revalidate(${cache.name}): ${req.url}`, async () => {\n+              await this.fetchAndCacheOnce(req);\n+            });\n           }\n \n           // In either case (revalidation or not), the cached response must be good."
        },
        {
            "sha": "4fa3a29ff3570e6e5718d512c51d81208874609e",
            "filename": "packages/service-worker/worker/src/data.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdata.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -10,6 +10,7 @@ import {Adapter, Context} from './adapter';\n import {Database, Table} from './database';\n import {DebugHandler} from './debug';\n import {DataGroupConfig} from './manifest';\n+import {NamedCache} from './named-cache-storage';\n \n /**\n  * A metadata record of how old a particular cached resource is.\n@@ -227,7 +228,7 @@ export class DataGroup {\n   /**\n    * The `Cache` instance in which resources belonging to this group are cached.\n    */\n-  private readonly cache: Promise<Cache>;\n+  private readonly cache: Promise<NamedCache>;\n \n   /**\n    * Tracks the LRU state of resources in this cache.\n@@ -247,10 +248,9 @@ export class DataGroup {\n   constructor(\n       private scope: ServiceWorkerGlobalScope, private adapter: Adapter,\n       private config: DataGroupConfig, private db: Database, private debugHandler: DebugHandler,\n-      private cacheNamePrefix: string) {\n+      cacheNamePrefix: string) {\n     this.patterns = config.patterns.map(pattern => new RegExp(pattern));\n-    this.cache =\n-        scope.caches.open(`${adapter.cacheNamePrefix}:${cacheNamePrefix}:${config.name}:cache`);\n+    this.cache = adapter.caches.open(`${cacheNamePrefix}:${config.name}:cache`);\n     this.lruTable = this.db.open(`${cacheNamePrefix}:${config.name}:lru`, config.cacheQueryOptions);\n     this.ageTable = this.db.open(`${cacheNamePrefix}:${config.name}:age`, config.cacheQueryOptions);\n   }\n@@ -549,10 +549,9 @@ export class DataGroup {\n   async cleanup(): Promise<void> {\n     // Remove both the cache and the database entries which track LRU stats.\n     await Promise.all([\n-      this.scope.caches.delete(\n-          `${this.adapter.cacheNamePrefix}:${this.cacheNamePrefix}:${this.config.name}:cache`),\n-      this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:age`),\n-      this.db.delete(`${this.cacheNamePrefix}:${this.config.name}:lru`),\n+      this.cache.then(cache => this.adapter.caches.delete(cache.name)),\n+      this.ageTable.then(table => this.db.delete(table.name)),\n+      this.lruTable.then(table => this.db.delete(table.name)),\n     ]);\n   }\n "
        },
        {
            "sha": "0f1d3c455a6ebe5ec85b698ae6d51d5c6eba7134",
            "filename": "packages/service-worker/worker/src/database.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdatabase.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdatabase.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdatabase.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -10,6 +10,11 @@\n  * An abstract table, with the ability to read/write objects stored under keys.\n  */\n export interface Table {\n+  /**\n+   * The name of this table in the database.\n+   */\n+  name: string;\n+\n   /**\n    * Delete a key from the table.\n    */"
        },
        {
            "sha": "f360879ec464114491be1266dea29d48771147ee",
            "filename": "packages/service-worker/worker/src/db-cache.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdb-cache.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdb-cache.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdb-cache.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -15,21 +15,21 @@ import {Database, NotFound, Table} from './database';\n  * state within mock `Response` objects.\n  */\n export class CacheDatabase implements Database {\n-  private cacheNamePrefix = `${this.adapter.cacheNamePrefix}:db`;\n+  private cacheNamePrefix = 'db';\n   private tables = new Map<string, CacheTable>();\n \n-  constructor(private scope: ServiceWorkerGlobalScope, private adapter: Adapter) {}\n+  constructor(private adapter: Adapter) {}\n \n   'delete'(name: string): Promise<boolean> {\n     if (this.tables.has(name)) {\n       this.tables.delete(name);\n     }\n-    return this.scope.caches.delete(`${this.cacheNamePrefix}:${name}`);\n+    return this.adapter.caches.delete(`${this.cacheNamePrefix}:${name}`);\n   }\n \n   async list(): Promise<string[]> {\n     const prefix = `${this.cacheNamePrefix}:`;\n-    const allCacheNames = await this.scope.caches.keys();\n+    const allCacheNames = await this.adapter.caches.keys();\n     const dbCacheNames = allCacheNames.filter(name => name.startsWith(prefix));\n \n     // Return the un-prefixed table names, so they can be used with other `CacheDatabase` methods\n@@ -39,7 +39,7 @@ export class CacheDatabase implements Database {\n \n   async open(name: string, cacheQueryOptions?: CacheQueryOptions): Promise<Table> {\n     if (!this.tables.has(name)) {\n-      const cache = await this.scope.caches.open(`${this.cacheNamePrefix}:${name}`);\n+      const cache = await this.adapter.caches.open(`${this.cacheNamePrefix}:${name}`);\n       const table = new CacheTable(name, cache, this.adapter, cacheQueryOptions);\n       this.tables.set(name, table);\n     }\n@@ -52,7 +52,7 @@ export class CacheDatabase implements Database {\n  */\n export class CacheTable implements Table {\n   constructor(\n-      readonly table: string, private cache: Cache, private adapter: Adapter,\n+      readonly name: string, private cache: Cache, private adapter: Adapter,\n       private cacheQueryOptions?: CacheQueryOptions) {}\n \n   private request(key: string): Request {\n@@ -70,7 +70,7 @@ export class CacheTable implements Table {\n   read(key: string): Promise<any> {\n     return this.cache.match(this.request(key), this.cacheQueryOptions).then(res => {\n       if (res === undefined) {\n-        return Promise.reject(new NotFound(this.table, key));\n+        return Promise.reject(new NotFound(this.name, key));\n       }\n       return res.json();\n     });"
        },
        {
            "sha": "895fed51b6383f7937f67e84d5377ad400ce2443",
            "filename": "packages/service-worker/worker/src/driver.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fdriver.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -760,11 +760,8 @@ export class Driver implements Debuggable, UpdateSource {\n   }\n \n   private async deleteAllCaches(): Promise<void> {\n-    const cacheNames = await this.scope.caches.keys();\n-    const ownCacheNames =\n-        cacheNames.filter(name => name.startsWith(`${this.adapter.cacheNamePrefix}:`));\n-\n-    await Promise.all(ownCacheNames.map(name => this.scope.caches.delete(name)));\n+    const cacheNames = await this.adapter.caches.keys();\n+    await Promise.all(cacheNames.map(name => this.adapter.caches.delete(name)));\n   }\n \n   /**\n@@ -988,9 +985,13 @@ export class Driver implements Debuggable, UpdateSource {\n    * (Since at this point the SW has claimed all clients, it is safe to remove those caches.)\n    */\n   async cleanupOldSwCaches(): Promise<void> {\n-    const cacheNames = await this.scope.caches.keys();\n+    // This is an exceptional case, where we need to interact with caches that would not be\n+    // generated by this ServiceWorker (but by old versions of it). Use the native `CacheStorage`\n+    // directly.\n+    const caches = this.adapter.caches.original;\n+    const cacheNames = await caches.keys();\n     const oldSwCacheNames = cacheNames.filter(name => /^ngsw:(?!\\/)/.test(name));\n-    await Promise.all(oldSwCacheNames.map(name => this.scope.caches.delete(name)));\n+    await Promise.all(oldSwCacheNames.map(name => caches.delete(name)));\n   }\n \n   /**"
        },
        {
            "sha": "a9ccadbf55f64b01dd80224f72f5c4989b944dce",
            "filename": "packages/service-worker/worker/src/named-cache-storage.ts",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fnamed-cache-storage.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fnamed-cache-storage.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fnamed-cache-storage.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -0,0 +1,45 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export interface NamedCache extends Cache {\n+  readonly name: string;\n+}\n+\n+/**\n+ * A wrapper around `CacheStorage` to allow interacting with caches more easily and consistently by:\n+ * - Adding a `name` property to all opened caches, which can be used to easily perform other\n+ *   operations that require the cache name.\n+ * - Name-spacing cache names to avoid conflicts with other caches on the same domain.\n+ */\n+export class NamedCacheStorage<T extends CacheStorage> implements CacheStorage {\n+  constructor(readonly original: T, private cacheNamePrefix: string) {}\n+\n+  delete(cacheName: string): Promise<boolean> {\n+    return this.original.delete(`${this.cacheNamePrefix}:${cacheName}`);\n+  }\n+\n+  has(cacheName: string): Promise<boolean> {\n+    return this.original.has(`${this.cacheNamePrefix}:${cacheName}`);\n+  }\n+\n+  async keys(): Promise<string[]> {\n+    const prefix = `${this.cacheNamePrefix}:`;\n+    const allCacheNames = await this.original.keys();\n+    const ownCacheNames = allCacheNames.filter(name => name.startsWith(prefix));\n+    return ownCacheNames.map(name => name.slice(prefix.length));\n+  }\n+\n+  match(request: RequestInfo, options?: MultiCacheQueryOptions): Promise<Response|undefined> {\n+    return this.original.match(request, options);\n+  }\n+\n+  async open(cacheName: string): Promise<NamedCache> {\n+    const cache = await this.original.open(`${this.cacheNamePrefix}:${cacheName}`);\n+    return Object.assign(cache, {name: cacheName});\n+  }\n+}"
        },
        {
            "sha": "7af223bc07b2c0e7c91e70309da1332c3e17f52f",
            "filename": "packages/service-worker/worker/src/service-worker.d.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -111,7 +111,9 @@ interface ExtendableMessageEvent extends ExtendableEvent {\n // ServiceWorkerGlobalScope\n \n interface ServiceWorkerGlobalScope {\n-  caches: CacheStorage;\n+  // Intentionally does not include a `caches` property to disallow accessing `CacheStorage` APIs\n+  // directly. All interactions with `CacheStorage` should go through a `NamedCacheStorage` instance\n+  // (exposed by the `Adapter`).\n   clients: Clients;\n   registration: ServiceWorkerRegistration;\n "
        },
        {
            "sha": "507bbdf9637a7333d3a15af30c390e7baa5dcf8d",
            "filename": "packages/service-worker/worker/test/data_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fdata_spec.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -126,7 +126,7 @@ describe('data cache', () => {\n   let driver: Driver;\n   beforeEach(async () => {\n     scope = new SwTestHarnessBuilder().withServerState(server).build();\n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n     // Initialize.\n     expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n@@ -144,7 +144,7 @@ describe('data cache', () => {\n   describe('in performance mode', () => {\n     it('names the caches correctly', async () => {\n       expect(await makeRequest(scope, '/api/test')).toEqual('version 1');\n-      const keys = await scope.caches.keys();\n+      const keys = await scope.caches.original.keys();\n       expect(keys.every(key => key.startsWith('ngsw:/:'))).toEqual(true);\n     });\n "
        },
        {
            "sha": "21955a5de407b08c69ee4a1f26cfd192c8255e3d",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 40,
            "changes": 80,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -304,7 +304,7 @@ describe('Driver', () => {\n     brokenServer.reset();\n \n     scope = new SwTestHarnessBuilder().withServerState(server).build();\n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n   });\n \n   it('activates without waiting', async () => {\n@@ -553,10 +553,10 @@ describe('Driver', () => {\n     await driver.initialized;\n \n     scope = new SwTestHarnessBuilder()\n-                .withCacheState(scope.caches.dehydrate())\n+                .withCacheState(scope.caches.original.dehydrate())\n                 .withServerState(serverUpdate)\n                 .build();\n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n     expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n     await driver.initialized;\n     serverUpdate.assertNoOtherRequests();\n@@ -609,10 +609,10 @@ describe('Driver', () => {\n     serverUpdate.clearRequests();\n \n     scope = new SwTestHarnessBuilder()\n-                .withCacheState(scope.caches.dehydrate())\n+                .withCacheState(scope.caches.original.dehydrate())\n                 .withServerState(serverUpdate)\n                 .build();\n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n     expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n     expect(await makeRequest(scope, '/foo.txt', 'new')).toEqual('this is foo v2');\n@@ -671,16 +671,16 @@ describe('Driver', () => {\n     await driver.initialized;\n \n     scope = new SwTestHarnessBuilder()\n-                .withCacheState(scope.caches.dehydrate())\n+                .withCacheState(scope.caches.original.dehydrate())\n                 .withServerState(serverUpdate)\n                 .build();\n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n     expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n     await driver.initialized;\n     serverUpdate.assertNoOtherRequests();\n \n     let keys = await scope.caches.keys();\n-    let hasOriginalCaches = keys.some(name => name.startsWith(`ngsw:/:${manifestHash}:`));\n+    let hasOriginalCaches = keys.some(name => name.startsWith(`${manifestHash}:`));\n     expect(hasOriginalCaches).toEqual(true);\n \n     scope.clients.remove('default');\n@@ -689,11 +689,11 @@ describe('Driver', () => {\n     await driver.idle.empty;\n     serverUpdate.clearRequests();\n \n-    driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+    driver = new Driver(scope, scope, new CacheDatabase(scope));\n     expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo v2');\n \n     keys = await scope.caches.keys();\n-    hasOriginalCaches = keys.some(name => name.startsWith(`ngsw:/:${manifestHash}:`));\n+    hasOriginalCaches = keys.some(name => name.startsWith(`${manifestHash}:`));\n     expect(hasOriginalCaches).toEqual(false);\n   });\n \n@@ -1255,7 +1255,7 @@ describe('Driver', () => {\n     it('should show debug info when the scope is not root', async () => {\n       const newScope =\n           new SwTestHarnessBuilder('http://localhost/foo/bar/').withServerState(server).build();\n-      new Driver(newScope, newScope, new CacheDatabase(newScope, newScope));\n+      new Driver(newScope, newScope, new CacheDatabase(newScope));\n \n       expect(await makeRequest(newScope, '/foo/bar/ngsw/state'))\n           .toMatch(/^NGSW Debug Info:\\n\\nDriver version: .+\\nDriver state: NORMAL/);\n@@ -1324,7 +1324,8 @@ describe('Driver', () => {\n     });\n \n     const getClientAssignments = async (sw: SwTestHarness, baseHref: string) => {\n-      const cache = await sw.caches.open(`ngsw:${baseHref}:db:control`) as unknown as MockCache;\n+      const cache =\n+          await sw.caches.original.open(`ngsw:${baseHref}:db:control`) as unknown as MockCache;\n       const dehydrated = cache.dehydrate();\n       return JSON.parse(dehydrated['/assignments'].body!) as any;\n     };\n@@ -1344,7 +1345,7 @@ describe('Driver', () => {\n                            .withCacheState(initialCacheState)\n                            .withServerState(serverState)\n                            .build();\n-      const newDriver = new Driver(newScope, newScope, new CacheDatabase(newScope, newScope));\n+      const newDriver = new Driver(newScope, newScope, new CacheDatabase(newScope));\n \n       await makeRequest(newScope, newManifest.index, baseHref.replace(/\\//g, '_'));\n       await newDriver.initialized;\n@@ -1359,14 +1360,14 @@ describe('Driver', () => {\n     it('includes the SW scope in all cache names', async () => {\n       // SW with scope `/`.\n       const [rootScope, rootManifestHash] = await initializeSwFor('/');\n-      const cacheNames = await rootScope.caches.keys();\n+      const cacheNames = await rootScope.caches.original.keys();\n \n       expect(cacheNames).toEqual(cacheKeysFor('/', rootManifestHash));\n       expect(cacheNames.every(name => name.includes('/'))).toBe(true);\n \n       // SW with scope `/foo/`.\n       const [fooScope, fooManifestHash] = await initializeSwFor('/foo/');\n-      const fooCacheNames = await fooScope.caches.keys();\n+      const fooCacheNames = await fooScope.caches.original.keys();\n \n       expect(fooCacheNames).toEqual(cacheKeysFor('/foo/', fooManifestHash));\n       expect(fooCacheNames.every(name => name.includes('/foo/'))).toBe(true);\n@@ -1381,8 +1382,8 @@ describe('Driver', () => {\n \n       // Add new SW with different scope.\n       const [barScope, barManifestHash] =\n-          await initializeSwFor('/bar/', await fooScope.caches.dehydrate());\n-      const barCacheNames = await barScope.caches.keys();\n+          await initializeSwFor('/bar/', await fooScope.caches.original.dehydrate());\n+      const barCacheNames = await barScope.caches.original.keys();\n       const barAssignments = await getClientAssignments(barScope, '/bar/');\n \n       expect(barAssignments).toEqual({_bar_: barManifestHash});\n@@ -1412,7 +1413,7 @@ describe('Driver', () => {\n \n       // Add new SW with same scope.\n       const [fooScope2, fooManifestHash2] =\n-          await initializeSwFor('/foo/', await fooScope.caches.dehydrate());\n+          await initializeSwFor('/foo/', await fooScope.caches.original.dehydrate());\n \n       // Update client `_foo_` but not client `_bar_`.\n       await fooScope2.handleMessage({action: 'CHECK_FOR_UPDATES'}, '_foo_');\n@@ -1490,9 +1491,9 @@ describe('Driver', () => {\n       expect(await makeRequest(scope, '/unhashed/a.txt')).toEqual('this is unhashed');\n       server.clearRequests();\n \n-      const state = scope.caches.dehydrate();\n+      const state = scope.caches.original.dehydrate();\n       scope = new SwTestHarnessBuilder().withCacheState(state).withServerState(server).build();\n-      driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+      driver = new Driver(scope, scope, new CacheDatabase(scope));\n       expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n       await driver.initialized;\n       server.assertNoRequestFor('/unhashed/a.txt');\n@@ -1514,10 +1515,10 @@ describe('Driver', () => {\n       server.clearRequests();\n \n       scope = new SwTestHarnessBuilder()\n-                  .withCacheState(scope.caches.dehydrate())\n+                  .withCacheState(scope.caches.original.dehydrate())\n                   .withServerState(serverUpdate)\n                   .build();\n-      driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+      driver = new Driver(scope, scope, new CacheDatabase(scope));\n       expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo');\n       await driver.initialized;\n \n@@ -1709,7 +1710,7 @@ describe('Driver', () => {\n       scope = new SwTestHarnessBuilder('http://localhost/base/href/')\n                   .withServerState(serverWithBaseHref)\n                   .build();\n-      driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+      driver = new Driver(scope, scope, new CacheDatabase(scope));\n     });\n \n     it('initializes prefetched content correctly, after a request kicks it off', async () => {\n@@ -1820,21 +1821,21 @@ describe('Driver', () => {\n       ];\n       const allCacheNames = oldSwCacheNames.concat(otherCacheNames);\n \n-      await Promise.all(allCacheNames.map(name => scope.caches.open(name)));\n-      expect(await scope.caches.keys()).toEqual(allCacheNames);\n+      await Promise.all(allCacheNames.map(name => scope.caches.original.open(name)));\n+      expect(await scope.caches.original.keys()).toEqual(allCacheNames);\n \n       await driver.cleanupOldSwCaches();\n-      expect(await scope.caches.keys()).toEqual(otherCacheNames);\n+      expect(await scope.caches.original.keys()).toEqual(otherCacheNames);\n     });\n \n     it('should delete other caches even if deleting one of them fails', async () => {\n       const oldSwCacheNames = ['ngsw:active', 'ngsw:staged', 'ngsw:manifest:a1b2c3:super:duper'];\n       const deleteSpy =\n-          spyOn(scope.caches, 'delete')\n+          spyOn(scope.caches.original, 'delete')\n               .and.callFake(\n                   (cacheName: string) => Promise.reject(`Failed to delete cache '${cacheName}'.`));\n \n-      await Promise.all(oldSwCacheNames.map(name => scope.caches.open(name)));\n+      await Promise.all(oldSwCacheNames.map(name => scope.caches.original.open(name)));\n       const error = await driver.cleanupOldSwCaches().catch(err => err);\n \n       expect(error).toBe('Failed to delete cache \\'ngsw:active\\'.');\n@@ -1847,7 +1848,7 @@ describe('Driver', () => {\n     it('does not crash with bad index hash', async () => {\n       scope = new SwTestHarnessBuilder().withServerState(brokenServer).build();\n       (scope.registration as any).scope = 'http://site.com';\n-      driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+      driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n       expect(await makeRequest(scope, '/foo.txt')).toEqual('this is foo (broken)');\n     });\n@@ -1858,10 +1859,10 @@ describe('Driver', () => {\n       server.clearRequests();\n \n       scope = new SwTestHarnessBuilder()\n-                  .withCacheState(scope.caches.dehydrate())\n+                  .withCacheState(scope.caches.original.dehydrate())\n                   .withServerState(brokenServer)\n                   .build();\n-      driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+      driver = new Driver(scope, scope, new CacheDatabase(scope));\n       await driver.checkForUpdate();\n \n       scope.advance(12000);\n@@ -2018,7 +2019,7 @@ describe('Driver', () => {\n          expect(driver.state).toBe(DriverReadyState.NORMAL);\n \n          // Ensure the data has been stored in the DB.\n-         const db: MockCache = await scope.caches.open('ngsw:/:db:control') as any;\n+         const db: MockCache = await scope.caches.open('db:control') as any;\n          const getLatestHashFromDb = async () => (await (await db.match('/latest')).json()).latest;\n          expect(await getLatestHashFromDb()).toBe(manifestHash);\n \n@@ -2145,7 +2146,7 @@ describe('Driver', () => {\n \n         // Create initial server state and initialize the SW.\n         scope = new SwTestHarnessBuilder().withServerState(serverState1).build();\n-        driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+        driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n         // Verify that all three clients are able to make the request.\n         expect(await makeRequest(scope, '/foo.hash.js', 'client1')).toBe('console.log(\"FOO\");');\n@@ -2223,7 +2224,7 @@ describe('Driver', () => {\n \n         // Create initial server state and initialize the SW.\n         scope = new SwTestHarnessBuilder().withServerState(originalServer).build();\n-        driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+        driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n         expect(await makeRequest(scope, '/foo.hash.js')).toBe('console.log(\"FOO\");');\n         await driver.initialized;\n@@ -2236,10 +2237,10 @@ describe('Driver', () => {\n         // Update the server state to emulate deploying a new version (where `foo.hash.js` does not\n         // exist any more). Keep the cache though.\n         scope = new SwTestHarnessBuilder()\n-                    .withCacheState(scope.caches.dehydrate())\n+                    .withCacheState(scope.caches.original.dehydrate())\n                     .withServerState(updatedServer)\n                     .build();\n-        driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+        driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n         // The SW is still able to serve `foo.hash.js` from the cache.\n         expect(await makeRequest(scope, '/foo.hash.js')).toBe('console.log(\"FOO\");');\n@@ -2267,7 +2268,7 @@ describe('Driver', () => {\n                              .build();\n \n         scope = new SwTestHarnessBuilder().withServerState(serverV5).build();\n-        driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+        driver = new Driver(scope, scope, new CacheDatabase(scope));\n       });\n \n       // Test this bug: https://github.com/angular/angular/issues/27209\n@@ -2321,7 +2322,7 @@ describe('Driver', () => {\n       const freshnessManifest: Manifest = {...manifest, navigationRequestStrategy: 'freshness'};\n       const server = serverBuilderBase.withManifest(freshnessManifest).build();\n       const scope = new SwTestHarnessBuilder().withServerState(server).build();\n-      const driver = new Driver(scope, scope, new CacheDatabase(scope, scope));\n+      const driver = new Driver(scope, scope, new CacheDatabase(scope));\n \n       return {server, scope, driver};\n     }\n@@ -2333,8 +2334,7 @@ async function removeAssetFromCache(\n     scope: SwTestHarness, appVersionManifest: Manifest, assetPath: string) {\n   const assetGroupName =\n       appVersionManifest.assetGroups?.find(group => group.urls.includes(assetPath))?.name;\n-  const cacheName = `${scope.cacheNamePrefix}:${sha1(JSON.stringify(appVersionManifest))}:assets:${\n-      assetGroupName}:cache`;\n+  const cacheName = `${sha1(JSON.stringify(appVersionManifest))}:assets:${assetGroupName}:cache`;\n   const cache = await scope.caches.open(cacheName);\n   return cache.delete(assetPath);\n }"
        },
        {
            "sha": "ceef0b5d05f98da0f766cceb2a3b53eee2cdff53",
            "filename": "packages/service-worker/worker/test/prefetch_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftest%2Fprefetch_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftest%2Fprefetch_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fprefetch_spec.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -31,7 +31,7 @@ const server = new MockServerStateBuilder().withStaticFiles(dist).withManifest(m\n \n const scope = new SwTestHarnessBuilder().withServerState(server).build();\n \n-const db = new CacheDatabase(scope, scope);\n+const db = new CacheDatabase(scope);\n \n \n describe('prefetch assets', () => {\n@@ -57,10 +57,11 @@ describe('prefetch assets', () => {\n   });\n   it('persists the cache across restarts', async () => {\n     await group.initializeFully();\n-    const freshScope = new SwTestHarnessBuilder().withCacheState(scope.caches.dehydrate()).build();\n+    const freshScope =\n+        new SwTestHarnessBuilder().withCacheState(scope.caches.original.dehydrate()).build();\n     group = new PrefetchAssetGroup(\n         freshScope, freshScope, idle, manifest.assetGroups![0], tmpHashTable(manifest),\n-        new CacheDatabase(freshScope, freshScope), 'test');\n+        new CacheDatabase(freshScope), 'test');\n     await group.initializeFully();\n     const res1 = await group.handleFetch(scope.newRequest('/foo.txt'), scope);\n     const res2 = await group.handleFetch(scope.newRequest('/bar.txt'), scope);\n@@ -82,7 +83,7 @@ describe('prefetch assets', () => {\n     const badScope = new SwTestHarnessBuilder().withServerState(badServer).build();\n     group = new PrefetchAssetGroup(\n         badScope, badScope, idle, manifest.assetGroups![0], tmpHashTable(manifest),\n-        new CacheDatabase(badScope, badScope), 'test');\n+        new CacheDatabase(badScope), 'test');\n     const err = await errorFrom(group.initializeFully());\n     expect(err.message).toContain('Hash mismatch');\n   });"
        },
        {
            "sha": "fb92476c3d47cea8606602f13f55b7b33e951398",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/356dd2107b33bc8a6fe5d13422a635fb1012615a/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=356dd2107b33bc8a6fe5d13422a635fb1012615a",
            "patch": "@@ -105,7 +105,8 @@ export class MockClients implements Clients {\n   async claim(): Promise<any> {}\n }\n \n-export class SwTestHarness extends Adapter implements ServiceWorkerGlobalScope, Context {\n+export class SwTestHarness extends Adapter<MockCacheStorage> implements Context,\n+                                                                        ServiceWorkerGlobalScope {\n   readonly clients = new MockClients();\n   private eventHandlers = new Map<string, Function>();\n   private skippedWaiting = false;\n@@ -163,9 +164,8 @@ export class SwTestHarness extends Adapter implements ServiceWorkerGlobalScope,\n \n   parseUrl = parseUrl;\n \n-  constructor(\n-      private server: MockServerState, readonly caches: MockCacheStorage, scopeUrl: string) {\n-    super(scopeUrl);\n+  constructor(private server: MockServerState, caches: MockCacheStorage, scopeUrl: string) {\n+    super(scopeUrl, caches);\n   }\n \n   async resolveSelfMessages(): Promise<void> {"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 148,
        "deletions": 96
    }
}