{
    "author": "JoostK",
    "message": "fix(compiler): properly compile DI factories when coverage reporting is enabled (#44732)\n\nWhen running tests with code coverage using Istanbul, the code is\ninstrumented with coverage reporting statements. These statements are\nalso inserted into synthesized constructors, preventing Angular from\nproperly recognizing them as synthesized constructor.\n\nThis commit changes the regex to detect synthesized constructors to allow\nfor statements within the constructor before the `super(...arguments);`\ncall. This is limited to code that does not contain a `}`, but this\nis sufficient to support Istanbul's coverage instrumentation statements.\n\nThe tests have been extended with an input file that is being\ninstrumented using `babel-plugin-istanbul` for both ES2015 and ES5\ntargets, in order to verify that the approach works for real-world\nusages.\n\nFixes #31337\n\nPR Close #44732",
    "sha": "627e807eb8d872e8e2de5067659a3a78eb706ee8",
    "files": [
        {
            "sha": "b2e1ae694e7823b6bce8439b527fea272d8e76de",
            "filename": "packages/core/src/reflection/reflection_capabilities.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/627e807eb8d872e8e2de5067659a3a78eb706ee8/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts",
            "raw_url": "https://github.com/angular/angular/raw/627e807eb8d872e8e2de5067659a3a78eb706ee8/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Freflection%2Freflection_capabilities.ts?ref=627e807eb8d872e8e2de5067659a3a78eb706ee8",
            "patch": "@@ -63,7 +63,7 @@ export const ES2015_INHERITED_CLASS_WITH_CTOR =\n  * and inherit a constructor.\n  */\n export const ES2015_INHERITED_CLASS_WITH_DELEGATE_CTOR =\n-    /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{[\\s\\S]*constructor\\s*\\(\\)\\s*{\\s*super\\(\\.\\.\\.arguments\\)/;\n+    /^class\\s+[A-Za-z\\d$_]*\\s*extends\\s+[^{]+{[\\s\\S]*constructor\\s*\\(\\)\\s*{[^}]*super\\(\\.\\.\\.arguments\\)/;\n \n /**\n  * Determine whether a stringified type is a class which delegates its constructor"
        },
        {
            "sha": "9af4fd30b90f9bad613259fd9f113e3f35d2e0d6",
            "filename": "packages/core/test/reflection/reflector_spec.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/627e807eb8d872e8e2de5067659a3a78eb706ee8/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/627e807eb8d872e8e2de5067659a3a78eb706ee8/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Freflection%2Freflector_spec.ts?ref=627e807eb8d872e8e2de5067659a3a78eb706ee8",
            "patch": "@@ -292,13 +292,59 @@ class TestObj {\n         expect(isDelegateCtor(ChildWithCtorComplexBase)).toBe(false);\n       });\n \n+      it('should deal with coverage instrumentation statements', () => {\n+        // The Istanbul coverage tool augments code with additional statements to capture coverage\n+        // information, and this test verifies that those do not interfere with our ability to\n+        // detect delegate constructors.\n+        const Es2015ClassNoCtor = `class TestService extends Parent {\n+          constructor() {\n+            cov_8nt6qq5zt().f[2]++;\n+            cov_8nt6qq5zt().s[6]++;\n+            super(...arguments);\n+            cov_8nt6qq5zt().s[7]++;\n+            this.foo = 'bar';\n+          }\n+        }`;\n+        const Es2015ClassWithCtor = `class TestService extends Parent {\n+          constructor() {\n+            cov_8nt6qq5zt().f[2]++;\n+            cov_8nt6qq5zt().s[6]++;\n+            super();\n+            cov_8nt6qq5zt().s[7]++;\n+            this.foo = 'bar';\n+          }\n+        }`;\n+        const Es5ClassNoCtor = `function TestService() {\n+          cov_8nt6qq5zt().f[4]++;\n+          var _this = (cov_8nt6qq5zt().s[8]++, (cov_8nt6qq5zt().b[0][0]++, _super !== null) && (cov_8nt6qq5zt().b[0][1]++, _super.apply(this, arguments)) || (cov_8nt6qq5zt().b[0][2]++, this));\n+          cov_8nt6qq5zt().s[9]++;\n+          _this.foo = 'bar';\n+          cov_8nt6qq5zt().s[10]++;\n+          return _this;\n+        }`;\n+        const Es5ClassWithCtor = `function TestService() {\n+          cov_8nt6qq5zt().f[4]++;\n+          var _this = _super.call();\n+          cov_8nt6qq5zt().s[9]++;\n+          _this.foo = 'bar';\n+          cov_8nt6qq5zt().s[10]++;\n+          return _this;\n+        }`;\n+\n+        expect(isDelegateCtor(Es2015ClassNoCtor)).toBe(true);\n+        expect(isDelegateCtor(Es2015ClassWithCtor)).toBe(false);\n+        expect(isDelegateCtor(Es5ClassNoCtor)).toBe(true);\n+        expect(isDelegateCtor(Es5ClassWithCtor)).toBe(false);\n+      });\n+\n       it('should properly handle all class forms', () => {\n         const ctor = (str: string) => expect(isDelegateCtor(str)).toBe(false);\n         const noCtor = (str: string) => expect(isDelegateCtor(str)).toBe(true);\n \n         ctor(`class Bar extends Foo {constructor(){}}`);\n         ctor(`class Bar extends Foo { constructor ( ) {} }`);\n         ctor(`class Bar extends Foo { other(){}; constructor(){} }`);\n+        ctor(`class Bar extends Foo { constructor(){} a(){super(...arguments)} }`);\n \n         noCtor(`class extends Foo{}`);\n         noCtor(`class extends Foo {}`);"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 47,
        "deletions": 1
    }
}