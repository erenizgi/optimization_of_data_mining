{
    "author": "atscott",
    "message": "fix(router): recursively merge empty path matches (#41584)\n\nWhen recognizing routes, the router merges nodes which map to the same\nempty path config. This is because auxiliary outlets under empty path\nparents need to match the parent config. This would result in two\noutlet matches for that parent which need to be combined into a single\nnode: The regular 'primary' match and the match for the auxiliary outlet.\nIn addition, the children of the merged nodes should also be merged to\naccount for multiple levels of empty path parents.\n\nFixes #41481\n\nPR Close #41584",
    "sha": "a1b2718b92457effbbdc2e31838f3cf96b0b8fe0",
    "files": [
        {
            "sha": "cb12aa8172fd36b6c5bd2e66606af063cb421002",
            "filename": "packages/router/src/recognize.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/a1b2718b92457effbbdc2e31838f3cf96b0b8fe0/packages%2Frouter%2Fsrc%2Frecognize.ts",
            "raw_url": "https://github.com/angular/angular/raw/a1b2718b92457effbbdc2e31838f3cf96b0b8fe0/packages%2Frouter%2Fsrc%2Frecognize.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frecognize.ts?ref=a1b2718b92457effbbdc2e31838f3cf96b0b8fe0",
            "patch": "@@ -251,6 +251,8 @@ function hasEmptyPathConfig(node: TreeNode<ActivatedRouteSnapshot>) {\n function mergeEmptyPathMatches(nodes: Array<TreeNode<ActivatedRouteSnapshot>>):\n     Array<TreeNode<ActivatedRouteSnapshot>> {\n   const result: Array<TreeNode<ActivatedRouteSnapshot>> = [];\n+  // The set of nodes which contain children that were merged from two duplicate empty path nodes.\n+  const mergedNodes: Set<TreeNode<ActivatedRouteSnapshot>> = new Set();\n \n   for (const node of nodes) {\n     if (!hasEmptyPathConfig(node)) {\n@@ -262,11 +264,20 @@ function mergeEmptyPathMatches(nodes: Array<TreeNode<ActivatedRouteSnapshot>>):\n         result.find(resultNode => node.value.routeConfig === resultNode.value.routeConfig);\n     if (duplicateEmptyPathNode !== undefined) {\n       duplicateEmptyPathNode.children.push(...node.children);\n+      mergedNodes.add(duplicateEmptyPathNode);\n     } else {\n       result.push(node);\n     }\n   }\n-  return result;\n+  // For each node which has children from multiple sources, we need to recompute a new `TreeNode`\n+  // by also merging those children. This is necessary when there are multiple empty path configs in\n+  // a row. Put another way: whenever we combine children of two nodes, we need to also check if any\n+  // of those children can be combined into a single node as well.\n+  for (const mergedNode of mergedNodes) {\n+    const mergedChildren = mergeEmptyPathMatches(mergedNode.children);\n+    result.push(new TreeNode(mergedNode.value, mergedChildren));\n+  }\n+  return result.filter(n => !mergedNodes.has(n));\n }\n \n function checkOutletNameUniqueness(nodes: TreeNode<ActivatedRouteSnapshot>[]): void {"
        },
        {
            "sha": "01ccd5495e4727dc490552088bca837683074d1b",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/a1b2718b92457effbbdc2e31838f3cf96b0b8fe0/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a1b2718b92457effbbdc2e31838f3cf96b0b8fe0/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=a1b2718b92457effbbdc2e31838f3cf96b0b8fe0",
            "patch": "@@ -595,6 +595,39 @@ describe('Integration', () => {\n              {},\n            ]);\n          }));\n+\n+      it('should work between aux outlets under two levels of empty path parents', fakeAsync(() => {\n+           TestBed.configureTestingModule({imports: [TestModule]});\n+           const router = TestBed.inject(Router);\n+           router.resetConfig([{\n+             path: '',\n+             children: [\n+               {\n+                 path: '',\n+                 component: NamedOutletHost,\n+                 children: [\n+                   {path: 'one', component: Child1, outlet: 'first'},\n+                   {path: 'two', component: Child2, outlet: 'first'},\n+                 ]\n+               },\n+             ]\n+           }]);\n+\n+           const fixture = createRoot(router, RootCmp);\n+\n+           router.navigateByUrl('/(first:one)');\n+           advance(fixture);\n+           expect(log).toEqual(['child1 constructor']);\n+\n+           log.length = 0;\n+           router.navigateByUrl('/(first:two)');\n+           advance(fixture);\n+           expect(log).toEqual([\n+             'child1 destroy',\n+             'first deactivate',\n+             'child2 constructor',\n+           ]);\n+         }));\n     });\n \n     it('should not wait for prior navigations to start a new navigation',"
        },
        {
            "sha": "eff0951df6cd844977119e94f8e3e7bfda6bd320",
            "filename": "packages/router/test/recognize.spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/a1b2718b92457effbbdc2e31838f3cf96b0b8fe0/packages%2Frouter%2Ftest%2Frecognize.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a1b2718b92457effbbdc2e31838f3cf96b0b8fe0/packages%2Frouter%2Ftest%2Frecognize.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Frecognize.spec.ts?ref=a1b2718b92457effbbdc2e31838f3cf96b0b8fe0",
            "patch": "@@ -626,9 +626,16 @@ describe('recognize', () => {\n               }]\n             }],\n             '(c:c)');\n-        checkActivatedRoute(s.root.children[0], '', {}, ComponentA);\n-        checkActivatedRoute(s.root.children[0].children[0], '', {}, ComponentB);\n-        checkActivatedRoute(s.root.children[0].children[0].children[0], 'c', {}, ComponentC, 'c');\n+        const [compAConfig] = s.root.children;\n+        checkActivatedRoute(compAConfig, '', {}, ComponentA);\n+        expect(compAConfig.children.length).toBe(1);\n+\n+        const [compBConfig] = compAConfig.children;\n+        checkActivatedRoute(compBConfig, '', {}, ComponentB);\n+        expect(compBConfig.children.length).toBe(1);\n+\n+        const [compCConfig] = compBConfig.children;\n+        checkActivatedRoute(compCConfig, 'c', {}, ComponentC, 'c');\n       });\n \n       it('should not persist a primary segment beyond the boundary of a named outlet match', () => {"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 55,
        "deletions": 4
    }
}