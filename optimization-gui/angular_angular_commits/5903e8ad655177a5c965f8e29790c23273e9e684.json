{
    "author": "petebacondarwin",
    "message": "test(compiler-cli): run compliance tests for two compilation modes … (#38938)\n\nTo verify the correctness of the linker output, we leverage the existing\ncompliance tests. The plan is to test the linker by running all compliance\ntests using a full round trip of pre-linking and subsequently post-linking,\nwhere the generated code should be identical to a full AOT compile.\n\nThis commit adds an additional Bazel target that runs the compliance\ntests in partial mode. Follow-up work is required to implement the logic\nfor running the linker round trip.\n\nPR Close #38938",
    "sha": "5903e8ad655177a5c965f8e29790c23273e9e684",
    "files": [
        {
            "sha": "e9ca4aae4e2fcf8907c63347f6a421c6abd5f1e4",
            "filename": "packages/compiler-cli/test/compliance/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2FBUILD.bazel?ref=5903e8ad655177a5c965f8e29790c23273e9e684",
            "patch": "@@ -6,11 +6,15 @@ ts_library(\n     srcs = glob(\n         [\"**/*.ts\"],\n     ),\n+    visibility = [\n+        \":__subpackages__\",\n+    ],\n     deps = [\n         \"//packages:types\",\n         \"//packages/compiler\",\n         \"//packages/compiler-cli\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/test/compliance/mock_compile\",\n         \"//packages/compiler/test:test_utils\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "0dd814d256ebe4fc0698222ec000a040a9a3a076",
            "filename": "packages/compiler-cli/test/compliance/mock_compile/BUILD.bazel",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2FBUILD.bazel?ref=5903e8ad655177a5c965f8e29790c23273e9e684",
            "patch": "@@ -0,0 +1,19 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"mock_compile\",\n+    testonly = True,\n+    srcs = [\"index.ts\"],\n+    visibility = [\n+        \"//packages/compiler-cli/test/compliance:__subpackages__\",\n+    ],\n+    deps = [\n+        \"//packages:types\",\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler/test:test_utils\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "4c56d03741b42c0cece93cd9fb49f12fec255bfa",
            "filename": "packages/compiler-cli/test/compliance/mock_compile/index.ts",
            "status": "renamed",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fmock_compile%2Findex.ts?ref=5903e8ad655177a5c965f8e29790c23273e9e684",
            "patch": "@@ -5,13 +5,13 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AotCompilerOptions} from '@angular/compiler';\n import {escapeRegExp} from '@angular/compiler/src/util';\n import {arrayToMockDir, MockCompilerHost, MockData, MockDirectory, toMockFileArray} from '@angular/compiler/test/aot/test_util';\n import * as ts from 'typescript';\n \n-import {NodeJSFileSystem, setFileSystem} from '../../src/ngtsc/file_system';\n-import {NgtscProgram} from '../../src/ngtsc/program';\n+import {NgCompilerOptions} from '../../../src/ngtsc/core/api';\n+import {NodeJSFileSystem, setFileSystem} from '../../../src/ngtsc/file_system';\n+import {NgtscProgram} from '../../../src/ngtsc/program';\n \n const IDENTIFIER = /[A-Za-z_$ɵ][A-Za-z0-9_$]*/;\n const OPERATOR =\n@@ -196,12 +196,8 @@ function buildMatcher(pieces: (string|RegExp)[]): {regexp: RegExp, groups: Map<s\n   };\n }\n \n-\n-export function compile(\n-    data: MockDirectory, angularFiles: MockData, options: AotCompilerOptions = {},\n-    errorCollector: (error: any, fileName?: string) => void = error => {\n-      throw error;\n-    }): {\n+export function doCompile(\n+    data: MockDirectory, angularFiles: MockData, options: NgCompilerOptions = {}): {\n   source: string,\n } {\n   setFileSystem(new NodeJSFileSystem());\n@@ -226,3 +222,18 @@ export function compile(\n \n   return {source};\n }\n+\n+export type CompileFn = typeof doCompile;\n+\n+/**\n+ * The actual compile function that will be used to compile the test code.\n+ * This can be updated by a test bootstrap script to provide an alternative compile function.\n+ */\n+export let compile: CompileFn = doCompile;\n+\n+/**\n+ * Update the `compile` exported function to use a new implementation.\n+ */\n+export function setCompileFn(compileFn: CompileFn) {\n+  compile = compileFn;\n+}",
            "previous_filename": "packages/compiler-cli/test/compliance/mock_compile.ts"
        },
        {
            "sha": "c0e657d27435230d4adc848f5ab8fc0ef9bd57ec",
            "filename": "packages/compiler-cli/test/compliance/prelink/BUILD.bazel",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2FBUILD.bazel?ref=5903e8ad655177a5c965f8e29790c23273e9e684",
            "patch": "@@ -0,0 +1,29 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+ts_library(\n+    name = \"prelink_bootstrap\",\n+    testonly = True,\n+    srcs = [\"bootstrap.ts\"],\n+    deps = [\n+        \"//packages:types\",\n+        \"//packages/compiler-cli/test/compliance/mock_compile\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"prelink\",\n+    bootstrap = [\n+        \"//tools/testing:node_no_angular_es5\",\n+        \":prelink_bootstrap_es5\",\n+    ],\n+    data = [\n+        \"//packages/compiler-cli/test/ngtsc/fake_core:npm_package\",\n+    ],\n+    shard_count = 4,\n+    tags = [\n+        \"ivy-only\",\n+    ],\n+    deps = [\n+        \"//packages/compiler-cli/test/compliance:test_lib\",\n+    ],\n+)"
        },
        {
            "sha": "38d8efa990401a3a19d61b4f8b52202048947d13",
            "filename": "packages/compiler-cli/test/compliance/prelink/bootstrap.ts",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2Fbootstrap.ts",
            "raw_url": "https://github.com/angular/angular/raw/5903e8ad655177a5c965f8e29790c23273e9e684/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2Fbootstrap.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fprelink%2Fbootstrap.ts?ref=5903e8ad655177a5c965f8e29790c23273e9e684",
            "patch": "@@ -0,0 +1,27 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {CompileFn, doCompile, setCompileFn} from '../mock_compile';\n+\n+/**\n+ * A function to compile the given code in two steps:\n+ *\n+ * - first compile the code in partial mode\n+ * - then compile the partially compiled code using the linker\n+ *\n+ * This should produce the same output as the full AOT compilation\n+ */\n+const linkedCompile: CompileFn = (data, angularFiles, options) => {\n+  const result = doCompile(data, angularFiles, {...options, compilationMode: 'partial'});\n+  // TODO: additional post linking\n+  return result;\n+};\n+\n+// Update the function that will do the compiling with this specialised version that\n+// runs the prelink and postlink parts of AOT compilation, to check it produces the\n+// same result as a normal full AOT compile.\n+setCompileFn(linkedCompile);"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 99,
        "deletions": 9
    }
}