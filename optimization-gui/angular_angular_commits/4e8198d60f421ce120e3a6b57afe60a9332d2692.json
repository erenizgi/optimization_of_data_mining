{
    "author": "atscott",
    "message": "feat(language-service): Implement `getRenameInfo` (#40439)\n\nThe `getRenameInfo` action is used by consumers to\n\n1. Determine if a location is a candidate for renames\n2. Determine what text to use as the starting point for the rename\n\nPR Close #40439",
    "sha": "4e8198d60f421ce120e3a6b57afe60a9332d2692",
    "files": [
        {
            "sha": "fc8f886822cbd829531f866e6a1ab5017deda487",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=4e8198d60f421ce120e3a6b57afe60a9332d2692",
            "patch": "@@ -8,7 +8,7 @@\n \n import {AST, TmplAstBoundEvent, TmplAstNode} from '@angular/compiler';\n import {CompilerOptions, ConfigurationHost, readConfiguration} from '@angular/compiler-cli';\n-import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n@@ -113,6 +113,21 @@ export class LanguageService {\n     return results;\n   }\n \n+  getRenameInfo(fileName: string, position: number): ts.RenameInfo {\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n+    const renameInfo = new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)\n+                           .getRenameInfo(absoluteFrom(fileName), position);\n+    if (!renameInfo.canRename) {\n+      return renameInfo;\n+    }\n+\n+    const quickInfo = this.getQuickInfoAtPosition(fileName, position) ??\n+        this.tsLS.getQuickInfoAtPosition(fileName, position);\n+    const kind = quickInfo?.kind ?? ts.ScriptElementKind.unknown;\n+    const kindModifiers = quickInfo?.kindModifiers ?? ts.ScriptElementKind.unknown;\n+    return {...renameInfo, kind, kindModifiers};\n+  }\n+\n   findRenameLocations(fileName: string, position: number): readonly ts.RenameLocation[]|undefined {\n     const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n     const results = new ReferencesAndRenameBuilder(this.strategy, this.tsLS, compiler)"
        },
        {
            "sha": "4e713607645209c3b11abc3a0b5bf7157671d84f",
            "filename": "packages/language-service/ivy/references.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 21,
            "changes": 88,
            "blob_url": "https://github.com/angular/angular/blob/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "raw_url": "https://github.com/angular/angular/raw/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Freferences.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Freferences.ts?ref=4e8198d60f421ce120e3a6b57afe60a9332d2692",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {AST, BindingPipe, LiteralPrimitive, MethodCall, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstNode, TmplAstReference, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AbsoluteSourceSpan, AST, BindingPipe, LiteralPrimitive, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstNode, TmplAstReference, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {DirectiveSymbol, ShimLocation, SymbolKind, TemplateTypeChecker, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n@@ -14,7 +14,7 @@ import * as ts from 'typescript';\n \n import {getTargetAtPosition, TargetNodeKind} from './template_target';\n import {findTightestNode} from './ts_utils';\n-import {getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, isTemplateNode, isWithin, TemplateInfo, toTextSpan} from './utils';\n+import {getDirectiveMatchesForAttribute, getDirectiveMatchesForElementTag, getTemplateInfoAtPosition, isWithin, TemplateInfo, toTextSpan} from './utils';\n \n interface FilePosition {\n   fileName: string;\n@@ -64,10 +64,37 @@ export class ReferencesAndRenameBuilder {\n       private readonly strategy: TypeCheckingProgramStrategy,\n       private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler) {}\n \n+  getRenameInfo(filePath: string, position: number):\n+      Omit<ts.RenameInfoSuccess, 'kind'|'kindModifiers'>|ts.RenameInfoFailure {\n+    const templateInfo = getTemplateInfoAtPosition(filePath, position, this.compiler);\n+    // We could not get a template at position so we assume the request came from outside the\n+    // template.\n+    if (templateInfo === undefined) {\n+      return this.tsLS.getRenameInfo(filePath, position);\n+    }\n+\n+    const allTargetDetails = this.getTargetDetailsAtTemplatePosition(templateInfo, position);\n+    if (allTargetDetails === null) {\n+      return {canRename: false, localizedErrorMessage: 'Could not find template node at position.'};\n+    }\n+    const {templateTarget} = allTargetDetails[0];\n+    const templateTextAndSpan = getRenameTextAndSpanAtPosition(templateTarget, position);\n+    if (templateTextAndSpan === null) {\n+      return {canRename: false, localizedErrorMessage: 'Could not determine template node text.'};\n+    }\n+    const {text, span} = templateTextAndSpan;\n+    return {\n+      canRename: true,\n+      displayName: text,\n+      fullDisplayName: text,\n+      triggerSpan: toTextSpan(span),\n+    };\n+  }\n+\n   findRenameLocations(filePath: string, position: number): readonly ts.RenameLocation[]|undefined {\n     this.ttc.generateAllTypeCheckBlocks();\n     const templateInfo = getTemplateInfoAtPosition(filePath, position, this.compiler);\n-    // We could not get a template at position so we assume the request is came from outside the\n+    // We could not get a template at position so we assume the request came from outside the\n     // template.\n     if (templateInfo === undefined) {\n       const requestNode = this.getTsNodeAtPosition(filePath, position);\n@@ -126,11 +153,11 @@ export class ReferencesAndRenameBuilder {\n       originalNodeText = requestOrigin.requestNode.getText();\n     } else {\n       const templateNodeText =\n-          getTemplateNodeRenameTextAtPosition(requestOrigin.requestNode, requestOrigin.position);\n+          getRenameTextAndSpanAtPosition(requestOrigin.requestNode, requestOrigin.position);\n       if (templateNodeText === null) {\n         return undefined;\n       }\n-      originalNodeText = templateNodeText;\n+      originalNodeText = templateNodeText.text;\n     }\n \n     const locations = this.tsLS.findRenameLocations(\n@@ -207,11 +234,11 @@ export class ReferencesAndRenameBuilder {\n     for (const node of nodes) {\n       // Get the information about the TCB at the template position.\n       const symbol = this.ttc.getSymbolOfNode(node, component);\n-      const templateTarget = node;\n-\n       if (symbol === null) {\n         continue;\n       }\n+\n+      const templateTarget = node;\n       switch (symbol.kind) {\n         case SymbolKind.Directive:\n         case SymbolKind.Template:\n@@ -233,13 +260,17 @@ export class ReferencesAndRenameBuilder {\n           }\n           const directives = getDirectiveMatchesForAttribute(\n               node.name, symbol.host.templateNode, symbol.host.directives);\n-          details.push(\n-              {typescriptLocations: this.getPositionsForDirectives(directives), templateTarget});\n+          details.push({\n+            typescriptLocations: this.getPositionsForDirectives(directives),\n+            templateTarget,\n+          });\n           break;\n         }\n         case SymbolKind.Reference: {\n-          details.push(\n-              {typescriptLocations: [toFilePosition(symbol.referenceVarLocation)], templateTarget});\n+          details.push({\n+            typescriptLocations: [toFilePosition(symbol.referenceVarLocation)],\n+            templateTarget,\n+          });\n           break;\n         }\n         case SymbolKind.Variable: {\n@@ -253,14 +284,18 @@ export class ReferencesAndRenameBuilder {\n               });\n             } else if (isWithin(position, templateTarget.keySpan)) {\n               // In the keySpan of the variable, we want to get the reference of the local variable.\n-              details.push(\n-                  {typescriptLocations: [toFilePosition(symbol.localVarLocation)], templateTarget});\n+              details.push({\n+                typescriptLocations: [toFilePosition(symbol.localVarLocation)],\n+                templateTarget,\n+              });\n             }\n           } else {\n             // If the templateNode is not the `TmplAstVariable`, it must be a usage of the\n             // variable somewhere in the template.\n-            details.push(\n-                {typescriptLocations: [toFilePosition(symbol.localVarLocation)], templateTarget});\n+            details.push({\n+              typescriptLocations: [toFilePosition(symbol.localVarLocation)],\n+              templateTarget,\n+            });\n           }\n           break;\n         }\n@@ -374,15 +409,19 @@ export class ReferencesAndRenameBuilder {\n   }\n }\n \n-function getTemplateNodeRenameTextAtPosition(node: TmplAstNode|AST, position: number): string|null {\n+function getRenameTextAndSpanAtPosition(node: TmplAstNode|AST, position: number):\n+    {text: string, span: ParseSourceSpan|AbsoluteSourceSpan}|null {\n   if (node instanceof TmplAstBoundAttribute || node instanceof TmplAstTextAttribute ||\n       node instanceof TmplAstBoundEvent) {\n-    return node.name;\n+    if (node.keySpan === undefined) {\n+      return null;\n+    }\n+    return {text: node.name, span: node.keySpan};\n   } else if (node instanceof TmplAstVariable || node instanceof TmplAstReference) {\n     if (isWithin(position, node.keySpan)) {\n-      return node.keySpan.toString();\n+      return {text: node.keySpan.toString(), span: node.keySpan};\n     } else if (node.valueSpan && isWithin(position, node.valueSpan)) {\n-      return node.valueSpan.toString();\n+      return {text: node.valueSpan.toString(), span: node.valueSpan};\n     }\n   }\n \n@@ -392,9 +431,16 @@ function getTemplateNodeRenameTextAtPosition(node: TmplAstNode|AST, position: nu\n   }\n   if (node instanceof PropertyRead || node instanceof MethodCall || node instanceof PropertyWrite ||\n       node instanceof SafePropertyRead || node instanceof SafeMethodCall) {\n-    return node.name;\n+    return {text: node.name, span: node.nameSpan};\n   } else if (node instanceof LiteralPrimitive) {\n-    return node.value;\n+    const span = node.span;\n+    const text = node.value;\n+    if (typeof text === 'string') {\n+      // The span of a string literal includes the quotes but they should be removed for renaming.\n+      span.start += 1;\n+      span.end -= 1;\n+    }\n+    return {text, span};\n   }\n \n   return null;"
        },
        {
            "sha": "39cb45be2193ab72d91b64230ca68eb2e0640592",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=4e8198d60f421ce120e3a6b57afe60a9332d2692",
            "patch": "@@ -1369,6 +1369,81 @@ describe('find references and rename locations', () => {\n     });\n   });\n \n+  describe('get rename info', () => {\n+    it('indicates inability to rename when cursor is outside template and in a string literal',\n+       () => {\n+         const {cursor, text} = extractCursorInfo(`\n+            import {Component} from '@angular/core';\n+\n+            @Component({selector: 'my-comp', template: ''})\n+            export class MyComp {\n+              myProp = 'cannot rena¦me me';\n+            }`);\n+         env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}]);\n+         env.expectNoSourceDiagnostics();\n+         const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor);\n+         expect(result.canRename).toEqual(false);\n+       });\n+\n+    it('gets rename info when cursor is outside template', () => {\n+      const {cursor, text} = extractCursorInfo(`\n+            import {Component, Input} from '@angular/core';\n+\n+            @Component({name: 'my-comp', template: ''})\n+            export class MyComp {\n+              @Input() m¦yProp!: string;\n+            }`);\n+      env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}]);\n+      env.expectNoSourceDiagnostics();\n+      const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+      expect(result.canRename).toEqual(true);\n+      expect(result.displayName).toEqual('myProp');\n+      expect(result.kind).toEqual('property');\n+    });\n+\n+    it('gets rename info on keyed read', () => {\n+      const {cursor, text} = extractCursorInfo(`\n+            import {Component} from '@angular/core';\n+\n+            @Component({name: 'my-comp', template: '{{ myObj[\"my¦Prop\"] }}'})\n+            export class MyComp {\n+              readonly myObj = {'myProp': 'hello world'};\n+            }`);\n+      env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}]);\n+      env.expectNoSourceDiagnostics();\n+      const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+      expect(result.canRename).toEqual(true);\n+      expect(result.displayName).toEqual('myProp');\n+      expect(result.kind).toEqual('property');\n+      expect(result.triggerSpan.length).toEqual('myProp'.length);\n+    });\n+\n+    it('gets rename info when cursor is on a directive input in a template', () => {\n+      const dirFile = {\n+        name: _('/dir.ts'),\n+        contents: `\n+        import {Directive, Input} from '@angular/core';\n+        @Directive({selector: '[dir]'})\n+        export class MyDir {\n+          @Input() dir!: any;\n+        }`\n+      };\n+      const {cursor, text} = extractCursorInfo(`\n+            import {Component, Input} from '@angular/core';\n+\n+            @Component({name: 'my-comp', template: '<div di¦r=\"something\"></div>'})\n+            export class MyComp {\n+              @Input() myProp!: string;\n+            }`);\n+      env = createModuleWithDeclarations([{name: _('/my-comp.ts'), contents: text}, dirFile]);\n+      env.expectNoSourceDiagnostics();\n+      const result = env.ngLS.getRenameInfo(_('/my-comp.ts'), cursor) as ts.RenameInfoSuccess;\n+      expect(result.canRename).toEqual(true);\n+      expect(result.displayName).toEqual('dir');\n+      expect(result.kind).toEqual('property');\n+    });\n+  });\n+\n   function getReferencesAtPosition(fileName: string, position: number) {\n     env.expectNoSourceDiagnostics();\n     const result = env.ngLS.getReferencesAtPosition(fileName, position);"
        },
        {
            "sha": "d39c0946fc1f4624ec8fa5cf04bab5ac6465071c",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=4e8198d60f421ce120e3a6b57afe60a9332d2692",
            "patch": "@@ -71,6 +71,12 @@ export function create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n     return ngLS.findRenameLocations(fileName, position);\n   }\n \n+  function getRenameInfo(fileName: string, position: number): ts.RenameInfo {\n+    // See the comment in `findRenameLocations` explaining why we don't check the `angularOnly`\n+    // flag.\n+    return ngLS.getRenameInfo(fileName, position);\n+  }\n+\n   function getCompletionsAtPosition(\n       fileName: string, position: number,\n       options: ts.GetCompletionsAtPositionOptions): ts.WithMetadata<ts.CompletionInfo>|undefined {\n@@ -118,6 +124,7 @@ export function create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n     getDefinitionAndBoundSpan,\n     getReferencesAtPosition,\n     findRenameLocations,\n+    getRenameInfo,\n     getCompletionsAtPosition,\n     getCompletionEntryDetails,\n     getCompletionEntrySymbol,"
        },
        {
            "sha": "07c4c15c2804d715b8f756f04e4ae375c380a2f8",
            "filename": "packages/language-service/ivy/utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/4e8198d60f421ce120e3a6b57afe60a9332d2692/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Futils.ts?ref=4e8198d60f421ce120e3a6b57afe60a9332d2692",
            "patch": "@@ -10,7 +10,6 @@ import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {isExternalResource} from '@angular/compiler-cli/src/ngtsc/metadata';\n import {DeclarationNode} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {DirectiveSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n-import {Diagnostic as ngDiagnostic, isNgDiagnostic} from '@angular/compiler-cli/src/transformers/api';\n import * as e from '@angular/compiler/src/expression_parser/ast';  // e for expression AST\n import * as t from '@angular/compiler/src/render3/r3_ast';         // t for template AST\n import * as ts from 'typescript';\n@@ -33,9 +32,9 @@ export function getTextSpanOfNode(node: t.Node|e.AST): ts.TextSpan {\n   }\n }\n \n-export function toTextSpan(span: AbsoluteSourceSpan|ParseSourceSpan): ts.TextSpan {\n+export function toTextSpan(span: AbsoluteSourceSpan|ParseSourceSpan|e.ParseSpan): ts.TextSpan {\n   let start: number, end: number;\n-  if (span instanceof AbsoluteSourceSpan) {\n+  if (span instanceof AbsoluteSourceSpan || span instanceof e.ParseSpan) {\n     start = span.start;\n     end = span.end;\n   } else {"
        }
    ],
    "stats": {
        "total": 192,
        "additions": 167,
        "deletions": 25
    }
}