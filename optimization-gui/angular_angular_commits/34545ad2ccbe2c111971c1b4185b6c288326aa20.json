{
    "author": "alxhub",
    "message": "refactor(compiler): add an `argumentSpan` to the method call AST (#41581)\n\nThis commit adds a separate span to `MethodCall` and `SafeMethodCall` which\ntracks the text span between the `(` and `)` tokens of the call. Tools like\nthe Language Service can use this span to more accurately understand a\ncursor position within a method call expression.\n\nPR Close #41581",
    "sha": "34545ad2ccbe2c111971c1b4185b6c288326aa20",
    "files": [
        {
            "sha": "318e548cc40146147cc4f83e863f26765490ddb9",
            "filename": "packages/compiler/src/compiler_util/expression_converter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "raw_url": "https://github.com/angular/angular/raw/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_util%2Fexpression_converter.ts?ref=34545ad2ccbe2c111971c1b4185b6c288326aa20",
            "patch": "@@ -705,7 +705,8 @@ class _AstToIrVisitor implements cdAst.AstVisitor {\n           leftMostSafe,\n           new cdAst.MethodCall(\n               leftMostSafe.span, leftMostSafe.sourceSpan, leftMostSafe.nameSpan,\n-              leftMostSafe.receiver, leftMostSafe.name, leftMostSafe.args));\n+              leftMostSafe.receiver, leftMostSafe.name, leftMostSafe.args,\n+              leftMostSafe.argumentSpan));\n     } else {\n       this._nodeMap.set(\n           leftMostSafe,"
        },
        {
            "sha": "fd0b77584fad5ded0d4d605eb6f7935538c61eed",
            "filename": "packages/compiler/src/expression_parser/ast.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "raw_url": "https://github.com/angular/angular/raw/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fast.ts?ref=34545ad2ccbe2c111971c1b4185b6c288326aa20",
            "patch": "@@ -308,7 +308,8 @@ export class NonNullAssert extends AST {\n export class MethodCall extends ASTWithName {\n   constructor(\n       span: ParseSpan, sourceSpan: AbsoluteSourceSpan, nameSpan: AbsoluteSourceSpan,\n-      public receiver: AST, public name: string, public args: any[]) {\n+      public receiver: AST, public name: string, public args: any[],\n+      public argumentSpan: AbsoluteSourceSpan) {\n     super(span, sourceSpan, nameSpan);\n   }\n   visit(visitor: AstVisitor, context: any = null): any {\n@@ -319,7 +320,8 @@ export class MethodCall extends ASTWithName {\n export class SafeMethodCall extends ASTWithName {\n   constructor(\n       span: ParseSpan, sourceSpan: AbsoluteSourceSpan, nameSpan: AbsoluteSourceSpan,\n-      public receiver: AST, public name: string, public args: any[]) {\n+      public receiver: AST, public name: string, public args: any[],\n+      public argumentSpan: AbsoluteSourceSpan) {\n     super(span, sourceSpan, nameSpan);\n   }\n   visit(visitor: AstVisitor, context: any = null): any {\n@@ -583,13 +585,13 @@ export class AstTransformer implements AstVisitor {\n   visitMethodCall(ast: MethodCall, context: any): AST {\n     return new MethodCall(\n         ast.span, ast.sourceSpan, ast.nameSpan, ast.receiver.visit(this), ast.name,\n-        this.visitAll(ast.args));\n+        this.visitAll(ast.args), ast.argumentSpan);\n   }\n \n   visitSafeMethodCall(ast: SafeMethodCall, context: any): AST {\n     return new SafeMethodCall(\n         ast.span, ast.sourceSpan, ast.nameSpan, ast.receiver.visit(this), ast.name,\n-        this.visitAll(ast.args));\n+        this.visitAll(ast.args), ast.argumentSpan);\n   }\n \n   visitFunctionCall(ast: FunctionCall, context: any): AST {\n@@ -719,7 +721,8 @@ export class AstMemoryEfficientTransformer implements AstVisitor {\n     const receiver = ast.receiver.visit(this);\n     const args = this.visitAll(ast.args);\n     if (receiver !== ast.receiver || args !== ast.args) {\n-      return new MethodCall(ast.span, ast.sourceSpan, ast.nameSpan, receiver, ast.name, args);\n+      return new MethodCall(\n+          ast.span, ast.sourceSpan, ast.nameSpan, receiver, ast.name, args, ast.argumentSpan);\n     }\n     return ast;\n   }\n@@ -728,7 +731,8 @@ export class AstMemoryEfficientTransformer implements AstVisitor {\n     const receiver = ast.receiver.visit(this);\n     const args = this.visitAll(ast.args);\n     if (receiver !== ast.receiver || args !== ast.args) {\n-      return new SafeMethodCall(ast.span, ast.sourceSpan, ast.nameSpan, receiver, ast.name, args);\n+      return new SafeMethodCall(\n+          ast.span, ast.sourceSpan, ast.nameSpan, receiver, ast.name, args, ast.argumentSpan);\n     }\n     return ast;\n   }"
        },
        {
            "sha": "855b60e89c7941d42a5bdce467d48c31db04a0c2",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=34545ad2ccbe2c111971c1b4185b6c288326aa20",
            "patch": "@@ -940,14 +940,19 @@ export class _ParseAST {\n     const nameSpan = this.sourceSpan(nameStart);\n \n     if (this.consumeOptionalCharacter(chars.$LPAREN)) {\n+      const argumentStart = this.inputIndex;\n       this.rparensExpected++;\n       const args = this.parseCallArguments();\n+      const argumentSpan =\n+          this.span(argumentStart, this.inputIndex).toAbsolute(this.absoluteOffset);\n+\n       this.expectCharacter(chars.$RPAREN);\n       this.rparensExpected--;\n       const span = this.span(start);\n       const sourceSpan = this.sourceSpan(start);\n-      return isSafe ? new SafeMethodCall(span, sourceSpan, nameSpan, receiver, id, args) :\n-                      new MethodCall(span, sourceSpan, nameSpan, receiver, id, args);\n+      return isSafe ?\n+          new SafeMethodCall(span, sourceSpan, nameSpan, receiver, id, args, argumentSpan) :\n+          new MethodCall(span, sourceSpan, nameSpan, receiver, id, args, argumentSpan);\n \n     } else {\n       if (isSafe) {"
        },
        {
            "sha": "e9f180d3d1f113709f3aa3bfd88d573a8263dd2b",
            "filename": "packages/compiler/test/expression_parser/parser_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts?ref=34545ad2ccbe2c111971c1b4185b6c288326aa20",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AbsoluteSourceSpan, ASTWithSource, BindingPipe, EmptyExpr, Interpolation, ParserError, TemplateBinding, VariableBinding} from '@angular/compiler/src/expression_parser/ast';\n+import {AbsoluteSourceSpan, ASTWithSource, BindingPipe, EmptyExpr, Interpolation, MethodCall, ParserError, TemplateBinding, VariableBinding} from '@angular/compiler/src/expression_parser/ast';\n import {Lexer} from '@angular/compiler/src/expression_parser/lexer';\n import {IvyParser, Parser, SplitInterpolation} from '@angular/compiler/src/expression_parser/parser';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n@@ -350,6 +350,11 @@ describe('parser', () => {\n       expect(unparseWithSpan(ast)).toContain(['foo()', '[nameSpan] foo']);\n     });\n \n+    it('should record method call argument span', () => {\n+      const ast = parseAction('foo(1 + 2)');\n+      expect(unparseWithSpan(ast)).toContain(['foo(1 + 2)', '[argumentSpan] 1 + 2']);\n+    });\n+\n     it('should record accessed method call span', () => {\n       const ast = parseAction('foo.bar()');\n       expect(unparseWithSpan(ast)).toContain(['foo.bar()', 'foo.bar()']);"
        },
        {
            "sha": "04f96b30b1e88c386a4c4f871619803561518caa",
            "filename": "packages/compiler/test/expression_parser/utils/unparser.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/34545ad2ccbe2c111971c1b4185b6c288326aa20/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Futils%2Funparser.ts?ref=34545ad2ccbe2c111971c1b4185b6c288326aa20",
            "patch": "@@ -229,6 +229,9 @@ export function unparseWithSpan(\n       if (ast.hasOwnProperty('nameSpan')) {\n         this.recordUnparsed(ast, 'nameSpan', unparsedList);\n       }\n+      if (ast.hasOwnProperty('argumentSpan')) {\n+        this.recordUnparsed(ast, 'argumentSpan', unparsedList);\n+      }\n       ast.visit(this, unparsedList);\n     }\n   };"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 28,
        "deletions": 10
    }
}