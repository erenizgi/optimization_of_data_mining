{
    "author": "AndrewKushnir",
    "message": "fix(core): handle spaces after `select` and `plural` ICU keywords (#37866)\n\nCurrently when the `plural` or `select` keywords in an ICU contain trailing spaces (e.g. `{count, select , ...}`), these spaces are also included into the key names in ICU vars (e.g. \"VAR_SELECT \"). These trailing spaces are not desirable, since they will later be converted into `_` symbols while normalizing placeholder names, thus causing mismatches at runtime (i.e. placeholder will not be replaced with the correct value). This commit updates the code to trim these spaces while generating an object with placeholders, to make sure the runtime logic can replace these placeholders with the right values.\n\nPR Close #37866",
    "sha": "aed6b131bbc36eb438e2c6e29b657a36101baba2",
    "files": [
        {
            "sha": "2755e0b57ade7a0af6a5dba95a4a2f32c3211b4c",
            "filename": "packages/compiler-cli/test/compliance/r3_view_compiler_i18n_spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/aed6b131bbc36eb438e2c6e29b657a36101baba2/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_view_compiler_i18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/aed6b131bbc36eb438e2c6e29b657a36101baba2/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_view_compiler_i18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fr3_view_compiler_i18n_spec.ts?ref=aed6b131bbc36eb438e2c6e29b657a36101baba2",
            "patch": "@@ -3661,6 +3661,39 @@ describe('i18n support in the template compiler', () => {\n \n       verify(input, output);\n     });\n+\n+    it('should produce proper messages when `select` or `plural` keywords have spaces after them',\n+       () => {\n+         const input = `\n+            <div i18n>\n+              {count, select , 1 {one} other {more than one}}\n+              {count, plural , =1 {one} other {more than one}}\n+            </div>\n+          `;\n+\n+         const output = String.raw`\n+            var $I18N_1$;\n+            if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n+                const $MSG_EXTERNAL_199763560911211963$$APP_SPEC_TS_2$ = goog.getMsg(\"{VAR_SELECT , select , 1 {one} other {more than one}}\");\n+                $I18N_1$ = $MSG_EXTERNAL_199763560911211963$$APP_SPEC_TS_2$;\n+            }\n+            else {\n+                $I18N_1$ = $localize \\`{VAR_SELECT , select , 1 {one} other {more than one}}\\`;\n+            }\n+            $I18N_1$ = i0.ɵɵi18nPostprocess($I18N_1$, { \"VAR_SELECT\": \"\\uFFFD0\\uFFFD\" });\n+            var $I18N_3$;\n+            if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) {\n+                const $MSG_EXTERNAL_3383986062053865025$$APP_SPEC_TS_4$ = goog.getMsg(\"{VAR_PLURAL , plural , =1 {one} other {more than one}}\");\n+                $I18N_3$ = $MSG_EXTERNAL_3383986062053865025$$APP_SPEC_TS_4$;\n+            }\n+            else {\n+                $I18N_3$ = $localize \\`{VAR_PLURAL , plural , =1 {one} other {more than one}}\\`;\n+            }\n+            $I18N_3$ = i0.ɵɵi18nPostprocess($I18N_3$, { \"VAR_PLURAL\": \"\\uFFFD1\\uFFFD\" });\n+          `;\n+\n+         verify(input, output);\n+       });\n   });\n \n   describe('$localize legacy message ids', () => {"
        },
        {
            "sha": "7d1ffeba28d4d9806938c5e4440bb1b4051b4114",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/aed6b131bbc36eb438e2c6e29b657a36101baba2/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/aed6b131bbc36eb438e2c6e29b657a36101baba2/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=aed6b131bbc36eb438e2c6e29b657a36101baba2",
            "patch": "@@ -273,10 +273,20 @@ class HtmlAstToIvyAst implements html.Visitor {\n       const value = message.placeholders[key];\n       if (key.startsWith(I18N_ICU_VAR_PREFIX)) {\n         const config = this.bindingParser.interpolationConfig;\n+\n         // ICU expression is a plain string, not wrapped into start\n         // and end tags, so we wrap it before passing to binding parser\n         const wrapped = `${config.start}${value}${config.end}`;\n-        vars[key] = this._visitTextWithInterpolation(wrapped, expansion.sourceSpan) as t.BoundText;\n+\n+        // Currently when the `plural` or `select` keywords in an ICU contain trailing spaces (e.g.\n+        // `{count, select , ...}`), these spaces are also included into the key names in ICU vars\n+        // (e.g. \"VAR_SELECT \"). These trailing spaces are not desirable, since they will later be\n+        // converted into `_` symbols while normalizing placeholder names, which might lead to\n+        // mismatches at runtime (i.e. placeholder will not be replaced with the correct value).\n+        const formattedKey = key.trim();\n+\n+        vars[formattedKey] =\n+            this._visitTextWithInterpolation(wrapped, expansion.sourceSpan) as t.BoundText;\n       } else {\n         placeholders[key] = this._visitTextWithInterpolation(value, expansion.sourceSpan);\n       }"
        },
        {
            "sha": "cbca1e1246c57d0e5f3801d5fab9ad2c6c71ef57",
            "filename": "packages/core/test/acceptance/i18n_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/aed6b131bbc36eb438e2c6e29b657a36101baba2/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/aed6b131bbc36eb438e2c6e29b657a36101baba2/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts?ref=aed6b131bbc36eb438e2c6e29b657a36101baba2",
            "patch": "@@ -627,6 +627,24 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n       expect(element.textContent).toContain('ICU start --> Autre <-- ICU end');\n     });\n \n+    it('when `select` or `plural` keywords have spaces after them', () => {\n+      loadTranslations({\n+        [computeMsgId('{VAR_SELECT , select , 10 {ten} 20 {twenty} other {other}}')]:\n+            '{VAR_SELECT , select , 10 {dix} 20 {vingt} other {autre}}',\n+        [computeMsgId('{VAR_PLURAL , plural , =0 {zero} =1 {one} other {other}}')]:\n+            '{VAR_PLURAL , plural , =0 {zéro} =1 {une} other {autre}}'\n+      });\n+      const fixture = initWithTemplate(AppComp, `\n+        <div i18n>\n+          {count, select , 10 {ten} 20 {twenty} other {other}} -\n+          {count, plural , =0 {zero} =1 {one} other {other}}\n+        </div>\n+      `);\n+\n+      const element = fixture.nativeElement;\n+      expect(element.textContent).toContain('autre - zéro');\n+    });\n+\n     it('with no root node and text and DOM nodes surrounding ICU', () => {\n       loadTranslations({\n         [computeMsgId('{VAR_SELECT, select, 10 {Ten} 20 {Twenty} other {Other}}')]:"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 62,
        "deletions": 1
    }
}