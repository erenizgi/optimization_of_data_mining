{
    "author": "alxhub",
    "message": "refactor(compiler-cli): add `TemplateId` to template diagnostics (#38105)\n\nPreviously, a stable template id was implemented for each component in a\nfile. This commit adds this id to each `TemplateDiagnostic` generated from\nthe template type-checker, so it can potentially be used for filtration.\n\nPR Close #38105",
    "sha": "8f73169979274eea61af52b68758a38a470bc65b",
    "files": [
        {
            "sha": "9bd6897fdedbdef75889cad77ed2d9b3a83bb951",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=8f73169979274eea61af52b68758a38a470bc65b",
            "patch": "@@ -15,6 +15,7 @@ import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {ComponentToShimMappingStrategy, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n \n+import {TemplateDiagnostic} from './diagnostics';\n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n import {Environment} from './environment';\n import {OutOfBandDiagnosticRecorder, OutOfBandDiagnosticRecorderImpl} from './oob';\n@@ -34,7 +35,7 @@ export interface ShimTypeCheckingData {\n    *\n    * Some diagnostics are produced during creation time and are tracked here.\n    */\n-  genesisDiagnostics: ts.Diagnostic[];\n+  genesisDiagnostics: TemplateDiagnostic[];\n \n   /**\n    * Whether any inline operations for the input file were required to generate this shim.\n@@ -182,7 +183,6 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n     }\n \n     const sfPath = absoluteFromSourceFile(ref.node.getSourceFile());\n-\n     const overrideTemplate = this.host.getTemplateOverride(sfPath, ref.node);\n     if (overrideTemplate !== null) {\n       template = overrideTemplate;\n@@ -231,12 +231,13 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       // and inlining would be required.\n \n       // Record diagnostics to indicate the issues with this template.\n+      const templateId = fileData.sourceManager.getTemplateId(ref.node);\n       if (tcbRequiresInline) {\n-        shimData.oobRecorder.requiresInlineTcb(ref.node);\n+        shimData.oobRecorder.requiresInlineTcb(templateId, ref.node);\n       }\n \n       if (missingInlines.length > 0) {\n-        shimData.oobRecorder.requiresInlineTypeConstructors(ref.node, missingInlines);\n+        shimData.oobRecorder.requiresInlineTypeConstructors(templateId, ref.node, missingInlines);\n       }\n \n       // Checking this template would be unsupported, so don't try."
        },
        {
            "sha": "2b61b1bc39c26e448a9b4696f49635fdeca995c0",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/diagnostics.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts?ref=8f73169979274eea61af52b68758a38a470bc65b",
            "patch": "@@ -21,6 +21,11 @@ export interface TemplateDiagnostic extends ts.Diagnostic {\n    * The component with the template that resulted in this diagnostic.\n    */\n   componentFile: ts.SourceFile;\n+\n+  /**\n+   * The template id of the component that resulted in this diagnostic.\n+   */\n+  templateId: TemplateId;\n }\n \n /**\n@@ -119,7 +124,7 @@ export function shouldReportDiagnostic(diagnostic: ts.Diagnostic): boolean {\n  * file from being reported as type-check errors.\n  */\n export function translateDiagnostic(\n-    diagnostic: ts.Diagnostic, resolver: TemplateSourceResolver): ts.Diagnostic|null {\n+    diagnostic: ts.Diagnostic, resolver: TemplateSourceResolver): TemplateDiagnostic|null {\n   if (diagnostic.file === undefined || diagnostic.start === undefined) {\n     return null;\n   }\n@@ -139,7 +144,8 @@ export function translateDiagnostic(\n \n   const mapping = resolver.getSourceMapping(sourceLocation.id);\n   return makeTemplateDiagnostic(\n-      mapping, span, diagnostic.category, diagnostic.code, diagnostic.messageText);\n+      sourceLocation.id, mapping, span, diagnostic.category, diagnostic.code,\n+      diagnostic.messageText);\n }\n \n export function findTypeCheckBlock(file: ts.SourceFile, id: TemplateId): ts.Node|null {\n@@ -155,8 +161,9 @@ export function findTypeCheckBlock(file: ts.SourceFile, id: TemplateId): ts.Node\n  * Constructs a `ts.Diagnostic` for a given `ParseSourceSpan` within a template.\n  */\n export function makeTemplateDiagnostic(\n-    mapping: TemplateSourceMapping, span: ParseSourceSpan, category: ts.DiagnosticCategory,\n-    code: number, messageText: string|ts.DiagnosticMessageChain, relatedMessage?: {\n+    templateId: TemplateId, mapping: TemplateSourceMapping, span: ParseSourceSpan,\n+    category: ts.DiagnosticCategory, code: number, messageText: string|ts.DiagnosticMessageChain,\n+    relatedMessage?: {\n       text: string,\n       span: ParseSourceSpan,\n     }): TemplateDiagnostic {\n@@ -182,6 +189,7 @@ export function makeTemplateDiagnostic(\n       messageText,\n       file: mapping.node.getSourceFile(),\n       componentFile: mapping.node.getSourceFile(),\n+      templateId,\n       start: span.start.offset,\n       length: span.end.offset - span.start.offset,\n       relatedInformation,\n@@ -233,6 +241,7 @@ export function makeTemplateDiagnostic(\n       messageText,\n       file: sf,\n       componentFile: componentSf,\n+      templateId,\n       start: span.start.offset,\n       length: span.end.offset - span.start.offset,\n       // Show a secondary message indicating the component whose template contains the error."
        },
        {
            "sha": "c6b39be34dfd04499faddca79c8592622295beb3",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/dom.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts?ref=8f73169979274eea61af52b68758a38a470bc65b",
            "patch": "@@ -12,7 +12,7 @@ import * as ts from 'typescript';\n import {ErrorCode, ngErrorCode} from '../../diagnostics';\n import {TemplateId} from '../api';\n \n-import {makeTemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n+import {makeTemplateDiagnostic, TemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n \n const REGISTRY = new DomElementSchemaRegistry();\n const REMOVE_XHTML_REGEX = /^:xhtml:/;\n@@ -31,7 +31,7 @@ export interface DomSchemaChecker {\n    * Get the `ts.Diagnostic`s that have been generated via `checkElement` and `checkProperty` calls\n    * thus far.\n    */\n-  readonly diagnostics: ReadonlyArray<ts.Diagnostic>;\n+  readonly diagnostics: ReadonlyArray<TemplateDiagnostic>;\n \n   /**\n    * Check a non-Angular element and record any diagnostics about it.\n@@ -64,9 +64,9 @@ export interface DomSchemaChecker {\n  * maintained by the Angular team via extraction from a browser IDL.\n  */\n export class RegistryDomSchemaChecker implements DomSchemaChecker {\n-  private _diagnostics: ts.Diagnostic[] = [];\n+  private _diagnostics: TemplateDiagnostic[] = [];\n \n-  get diagnostics(): ReadonlyArray<ts.Diagnostic> {\n+  get diagnostics(): ReadonlyArray<TemplateDiagnostic> {\n     return this._diagnostics;\n   }\n \n@@ -93,7 +93,7 @@ export class RegistryDomSchemaChecker implements DomSchemaChecker {\n       }\n \n       const diag = makeTemplateDiagnostic(\n-          mapping, element.sourceSpan, ts.DiagnosticCategory.Error,\n+          id, mapping, element.sourceSpan, ts.DiagnosticCategory.Error,\n           ngErrorCode(ErrorCode.SCHEMA_INVALID_ELEMENT), errorMsg);\n       this._diagnostics.push(diag);\n     }\n@@ -123,7 +123,7 @@ export class RegistryDomSchemaChecker implements DomSchemaChecker {\n       }\n \n       const diag = makeTemplateDiagnostic(\n-          mapping, span, ts.DiagnosticCategory.Error,\n+          id, mapping, span, ts.DiagnosticCategory.Error,\n           ngErrorCode(ErrorCode.SCHEMA_INVALID_ATTRIBUTE), errorMsg);\n       this._diagnostics.push(diag);\n     }"
        },
        {
            "sha": "0d9ab782a67a578d3552c994cdb26cf0a8124d99",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/oob.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 17,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts?ref=8f73169979274eea61af52b68758a38a470bc65b",
            "patch": "@@ -13,7 +13,7 @@ import {ErrorCode, makeDiagnostic, makeRelatedInformation, ngErrorCode} from '..\n import {ClassDeclaration} from '../../reflection';\n import {TemplateId} from '../api';\n \n-import {makeTemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n+import {makeTemplateDiagnostic, TemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n \n \n \n@@ -27,7 +27,7 @@ import {makeTemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n  * recorder for later display.\n  */\n export interface OutOfBandDiagnosticRecorder {\n-  readonly diagnostics: ReadonlyArray<ts.Diagnostic>;\n+  readonly diagnostics: ReadonlyArray<TemplateDiagnostic>;\n \n   /**\n    * Reports a `#ref=\"target\"` expression in the template for which a target directive could not be\n@@ -63,17 +63,18 @@ export interface OutOfBandDiagnosticRecorder {\n   duplicateTemplateVar(\n       templateId: TemplateId, variable: TmplAstVariable, firstDecl: TmplAstVariable): void;\n \n-  requiresInlineTcb(node: ClassDeclaration): void;\n+  requiresInlineTcb(templateId: TemplateId, node: ClassDeclaration): void;\n \n-  requiresInlineTypeConstructors(node: ClassDeclaration, directives: ClassDeclaration[]): void;\n+  requiresInlineTypeConstructors(\n+      templateId: TemplateId, node: ClassDeclaration, directives: ClassDeclaration[]): void;\n }\n \n export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecorder {\n-  private _diagnostics: ts.Diagnostic[] = [];\n+  private _diagnostics: TemplateDiagnostic[] = [];\n \n   constructor(private resolver: TemplateSourceResolver) {}\n \n-  get diagnostics(): ReadonlyArray<ts.Diagnostic> {\n+  get diagnostics(): ReadonlyArray<TemplateDiagnostic> {\n     return this._diagnostics;\n   }\n \n@@ -83,7 +84,7 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n \n     const errorMsg = `No directive found with exportAs '${value}'.`;\n     this._diagnostics.push(makeTemplateDiagnostic(\n-        mapping, ref.valueSpan || ref.sourceSpan, ts.DiagnosticCategory.Error,\n+        templateId, mapping, ref.valueSpan || ref.sourceSpan, ts.DiagnosticCategory.Error,\n         ngErrorCode(ErrorCode.MISSING_REFERENCE_TARGET), errorMsg));\n   }\n \n@@ -97,8 +98,8 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n           `Assertion failure: no SourceLocation found for usage of pipe '${ast.name}'.`);\n     }\n     this._diagnostics.push(makeTemplateDiagnostic(\n-        mapping, sourceSpan, ts.DiagnosticCategory.Error, ngErrorCode(ErrorCode.MISSING_PIPE),\n-        errorMsg));\n+        templateId, mapping, sourceSpan, ts.DiagnosticCategory.Error,\n+        ngErrorCode(ErrorCode.MISSING_PIPE), errorMsg));\n   }\n \n   illegalAssignmentToTemplateVar(\n@@ -113,7 +114,7 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n       throw new Error(`Assertion failure: no SourceLocation found for property binding.`);\n     }\n     this._diagnostics.push(makeTemplateDiagnostic(\n-        mapping, sourceSpan, ts.DiagnosticCategory.Error,\n+        templateId, mapping, sourceSpan, ts.DiagnosticCategory.Error,\n         ngErrorCode(ErrorCode.WRITE_TO_READ_ONLY_VARIABLE), errorMsg, {\n           text: `The variable ${assignment.name} is declared here.`,\n           span: target.valueSpan || target.sourceSpan,\n@@ -132,20 +133,21 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n     //\n     // TODO(alxhub): allocate to a tighter span once one is available.\n     this._diagnostics.push(makeTemplateDiagnostic(\n-        mapping, variable.sourceSpan, ts.DiagnosticCategory.Error,\n+        templateId, mapping, variable.sourceSpan, ts.DiagnosticCategory.Error,\n         ngErrorCode(ErrorCode.DUPLICATE_VARIABLE_DECLARATION), errorMsg, {\n           text: `The variable '${firstDecl.name}' was first declared here.`,\n           span: firstDecl.sourceSpan,\n         }));\n   }\n \n-  requiresInlineTcb(node: ClassDeclaration): void {\n-    this._diagnostics.push(makeDiagnostic(\n-        ErrorCode.INLINE_TCB_REQUIRED, node.name,\n+  requiresInlineTcb(templateId: TemplateId, node: ClassDeclaration): void {\n+    this._diagnostics.push(makeInlineDiagnostic(\n+        templateId, ErrorCode.INLINE_TCB_REQUIRED, node.name,\n         `This component requires inline template type-checking, which is not supported by the current environment.`));\n   }\n \n-  requiresInlineTypeConstructors(node: ClassDeclaration, directives: ClassDeclaration[]): void {\n+  requiresInlineTypeConstructors(\n+      templateId: TemplateId, node: ClassDeclaration, directives: ClassDeclaration[]): void {\n     let message: string;\n     if (directives.length > 1) {\n       message =\n@@ -155,9 +157,20 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n           `This component uses a directive which requires an inline type constructor, which is not supported by the current environment.`;\n     }\n \n-    this._diagnostics.push(makeDiagnostic(\n-        ErrorCode.INLINE_TYPE_CTOR_REQUIRED, node.name, message,\n+    this._diagnostics.push(makeInlineDiagnostic(\n+        templateId, ErrorCode.INLINE_TYPE_CTOR_REQUIRED, node.name, message,\n         directives.map(\n             dir => makeRelatedInformation(dir.name, `Requires an inline type constructor.`))));\n   }\n }\n+\n+function makeInlineDiagnostic(\n+    templateId: TemplateId, code: ErrorCode.INLINE_TCB_REQUIRED|ErrorCode.INLINE_TYPE_CTOR_REQUIRED,\n+    node: ts.Node, messageText: string|ts.DiagnosticMessageChain,\n+    relatedInformation?: ts.DiagnosticRelatedInformation[]): TemplateDiagnostic {\n+  return {\n+    ...makeDiagnostic(code, node, messageText, relatedInformation),\n+    componentFile: node.getSourceFile(),\n+    templateId,\n+  };\n+}"
        },
        {
            "sha": "99043a6428fcf28a9ad199fccfa8143d52742d0e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f73169979274eea61af52b68758a38a470bc65b/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=8f73169979274eea61af52b68758a38a470bc65b",
            "patch": "@@ -20,6 +20,7 @@ import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '..\n import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, UpdateMode} from '../api/api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n import {TemplateTypeCheckerImpl} from '../src/checker';\n+import {TemplateDiagnostic} from '../src/diagnostics';\n import {DomSchemaChecker} from '../src/dom';\n import {Environment} from '../src/environment';\n import {OutOfBandDiagnosticRecorder} from '../src/oob';\n@@ -487,7 +488,7 @@ class FakeEnvironment /* implements Environment */ {\n }\n \n export class NoopSchemaChecker implements DomSchemaChecker {\n-  get diagnostics(): ReadonlyArray<ts.Diagnostic> {\n+  get diagnostics(): ReadonlyArray<TemplateDiagnostic> {\n     return [];\n   }\n \n@@ -498,7 +499,7 @@ export class NoopSchemaChecker implements DomSchemaChecker {\n }\n \n export class NoopOobRecorder implements OutOfBandDiagnosticRecorder {\n-  get diagnostics(): ReadonlyArray<ts.Diagnostic> {\n+  get diagnostics(): ReadonlyArray<TemplateDiagnostic> {\n     return [];\n   }\n   missingReferenceTarget(): void {}"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 57,
        "deletions": 33
    }
}