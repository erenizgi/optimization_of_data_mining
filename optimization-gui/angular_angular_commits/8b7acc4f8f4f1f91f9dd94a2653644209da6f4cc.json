{
    "author": "unknown",
    "message": "refactor(compiler): Binding parser sets binding span as source span in Ivy (#39036)\n\nCurrently it is impossible to determine the source of a binding that\ngenerates `BoundAttribute` because all bound attributes generated from a\nmicrosyntax expression share the same source span.\n\nFor example, in\n```html\n<div *ngFor=\"let item of items; trackBy: trackByFn\"></div>\n     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n     source span for all `BoundAttribute`s generated from microsyntax\n```\nthe `BoundAttribute` for both `ngForOf` and `ngForTrackBy`\nshare the same source span.\n\nA lot of hacks were necessary in View Engine language service to work\naround this limitation. It was done by inspecting the whole source span\nthen figuring out the relative position of the cursor.\n\nWith this change, we introduce a flag to set the binding span as the\nsource span of the `ParsedProperty` in Ivy AST.\nThis flag is needed so that we don't have to change VE ASTs.\n\nNote that in the binding parser, we already set `bindingSpan` as the\nsource span for a `ParsedVariable`, and `keySpan` as the source span for\na literal attribute. This change makes the Ivy AST more consistent by\npropagating the binding span to `ParsedProperty` as well.\n\nPR Close #39036",
    "sha": "8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc",
    "files": [
        {
            "sha": "92d652d16d7b8e29511c94fbc9247df699731646",
            "filename": "packages/compiler/src/render3/r3_template_transform.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_template_transform.ts?ref=8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc",
            "patch": "@@ -157,7 +157,7 @@ class HtmlAstToIvyAst implements html.Visitor {\n \n         this.bindingParser.parseInlineTemplateBinding(\n             templateKey, templateValue, attribute.sourceSpan, absoluteValueOffset, [],\n-            templateParsedProperties, parsedVariables);\n+            templateParsedProperties, parsedVariables, true /* isIvyAst */);\n         templateVariables.push(...parsedVariables.map(\n             v => new t.Variable(v.name, v.value, v.sourceSpan, v.keySpan, v.valueSpan)));\n       } else {"
        },
        {
            "sha": "bc4ccf9cd1f7840ab7816f875da309e528498c13",
            "filename": "packages/compiler/src/template_parser/binding_parser.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Fbinding_parser.ts?ref=8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc",
            "patch": "@@ -141,8 +141,8 @@ export class BindingParser {\n    */\n   parseInlineTemplateBinding(\n       tplKey: string, tplValue: string, sourceSpan: ParseSourceSpan, absoluteValueOffset: number,\n-      targetMatchableAttrs: string[][], targetProps: ParsedProperty[],\n-      targetVars: ParsedVariable[]) {\n+      targetMatchableAttrs: string[][], targetProps: ParsedProperty[], targetVars: ParsedVariable[],\n+      isIvyAst: boolean) {\n     const absoluteKeyOffset = sourceSpan.start.offset + TEMPLATE_ATTR_PREFIX.length;\n     const bindings = this._parseTemplateBindings(\n         tplKey, tplValue, sourceSpan, absoluteKeyOffset, absoluteValueOffset);\n@@ -159,9 +159,10 @@ export class BindingParser {\n             binding.value ? moveParseSourceSpan(sourceSpan, binding.value.span) : undefined;\n         targetVars.push(new ParsedVariable(key, value, bindingSpan, keySpan, valueSpan));\n       } else if (binding.value) {\n+        const srcSpan = isIvyAst ? bindingSpan : sourceSpan;\n         const valueSpan = moveParseSourceSpan(sourceSpan, binding.value.ast.sourceSpan);\n         this._parsePropertyAst(\n-            key, binding.value, sourceSpan, keySpan, valueSpan, targetMatchableAttrs, targetProps);\n+            key, binding.value, srcSpan, keySpan, valueSpan, targetMatchableAttrs, targetProps);\n       } else {\n         targetMatchableAttrs.push([key, '' /* value */]);\n         // Since this is a literal attribute with no RHS, source span should be"
        },
        {
            "sha": "19dfe8f3841b58e73f0855e2c72f723f11077aca",
            "filename": "packages/compiler/src/template_parser/template_parser.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Ftemplate_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Ftemplate_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Ftemplate_parser%2Ftemplate_parser.ts?ref=8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc",
            "patch": "@@ -317,7 +317,7 @@ class TemplateParseVisitor implements html.Visitor {\n         const absoluteOffset = (attr.valueSpan || attr.sourceSpan).start.offset;\n         this._bindingParser.parseInlineTemplateBinding(\n             templateKey!, templateValue!, attr.sourceSpan, absoluteOffset, templateMatchableAttrs,\n-            templateElementOrDirectiveProps, parsedVariables);\n+            templateElementOrDirectiveProps, parsedVariables, false /* isIvyAst */);\n         templateElementVars.push(...parsedVariables.map(v => t.VariableAst.fromParsedVariable(v)));\n       }\n "
        },
        {
            "sha": "1f82c8a78bf342a26a5032ee09a16e265cc4e23a",
            "filename": "packages/compiler/test/render3/r3_ast_spans_spec.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fr3_ast_spans_spec.ts?ref=8b7acc4f8f4f1f91f9dd94a2653644209da6f4cc",
            "patch": "@@ -285,7 +285,7 @@ describe('R3 AST source spans', () => {\n           '</div>'\n         ],\n         ['TextAttribute', 'ngFor', '<empty>'],\n-        ['BoundAttribute', '*ngFor=\"let item of items\"', 'of', 'items'],\n+        ['BoundAttribute', 'of items', 'of', 'items'],\n         ['Variable', 'let item ', 'item', '<empty>'],\n         [\n           'Element', '<div *ngFor=\"let item of items\"></div>', '<div *ngFor=\"let item of items\">',\n@@ -303,8 +303,8 @@ describe('R3 AST source spans', () => {\n         [\n           'Template', '<div *ngFor=\"item of items\"></div>', '<div *ngFor=\"item of items\">', '</div>'\n         ],\n-        ['BoundAttribute', '*ngFor=\"item of items\"', 'ngFor', 'item'],\n-        ['BoundAttribute', '*ngFor=\"item of items\"', 'of', 'items'],\n+        ['BoundAttribute', 'ngFor=\"item ', 'ngFor', 'item'],\n+        ['BoundAttribute', 'of items', 'of', 'items'],\n         ['Element', '<div *ngFor=\"item of items\"></div>', '<div *ngFor=\"item of items\">', '</div>'],\n       ]);\n \n@@ -314,10 +314,8 @@ describe('R3 AST source spans', () => {\n           '<div *ngFor=\"let item of items; trackBy: trackByFn\">', '</div>'\n         ],\n         ['TextAttribute', 'ngFor', '<empty>'],\n-        ['BoundAttribute', '*ngFor=\"let item of items; trackBy: trackByFn\"', 'of', 'items'],\n-        [\n-          'BoundAttribute', '*ngFor=\"let item of items; trackBy: trackByFn\"', 'trackBy', 'trackByFn'\n-        ],\n+        ['BoundAttribute', 'of items; ', 'of', 'items'],\n+        ['BoundAttribute', 'trackBy: trackByFn', 'trackBy', 'trackByFn'],\n         ['Variable', 'let item ', 'item', '<empty>'],\n         [\n           'Element', '<div *ngFor=\"let item of items; trackBy: trackByFn\"></div>',\n@@ -339,7 +337,7 @@ describe('R3 AST source spans', () => {\n     it('is correct for variables via as ...', () => {\n       expectFromHtml('<div *ngIf=\"expr as local\"></div>').toEqual([\n         ['Template', '<div *ngIf=\"expr as local\"></div>', '<div *ngIf=\"expr as local\">', '</div>'],\n-        ['BoundAttribute', '*ngIf=\"expr as local\"', 'ngIf', 'expr'],\n+        ['BoundAttribute', 'ngIf=\"expr ', 'ngIf', 'expr'],\n         ['Variable', 'ngIf=\"expr as local', 'local', 'ngIf'],\n         ['Element', '<div *ngIf=\"expr as local\"></div>', '<div *ngIf=\"expr as local\">', '</div>'],\n       ]);"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 12,
        "deletions": 13
    }
}