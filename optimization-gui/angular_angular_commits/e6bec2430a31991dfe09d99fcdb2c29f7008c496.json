{
    "author": "mgechev",
    "message": "fix(devtools): update the prod mode detection to also consider VE apps\n\nFix rangle/angular-devtools#798",
    "sha": "e6bec2430a31991dfe09d99fcdb2c29f7008c496",
    "files": [
        {
            "sha": "21d2ae8938b0b4a53aa1f4ac941fe0fa177e8284",
            "filename": "projects/ng-devtools-backend/src/lib/angular-check.spec.ts",
            "status": "added",
            "additions": 109,
            "deletions": 0,
            "changes": 109,
            "blob_url": "https://github.com/angular/angular/blob/e6bec2430a31991dfe09d99fcdb2c29f7008c496/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fangular-check.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e6bec2430a31991dfe09d99fcdb2c29f7008c496/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fangular-check.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fangular-check.spec.ts?ref=e6bec2430a31991dfe09d99fcdb2c29f7008c496",
            "patch": "@@ -0,0 +1,109 @@\n+import {\n+  appIsAngularInDevMode,\n+  appIsAngularIvy,\n+  appIsAngular,\n+  appIsSupportedAngularVersion,\n+  getAngularVersion,\n+} from './angular-check';\n+\n+const setNgVersion = (version = '12.0.0') => document.documentElement.setAttribute('ng-version', version);\n+const removeNgVersion = () => document.documentElement.removeAttribute('ng-version');\n+\n+describe('angular-check', () => {\n+  afterEach(() => removeNgVersion());\n+\n+  describe('getAngularVersion', () => {\n+    it('should return the angular version', () => {\n+      setNgVersion('11.1.1');\n+      expect(getAngularVersion()).toBe('11.1.1');\n+    });\n+  });\n+\n+  describe('appIsSupportedAngularVersion', () => {\n+    it('should work with g3', () => {\n+      setNgVersion('0.0.0-placeholder');\n+      expect(appIsSupportedAngularVersion()).toBeTrue();\n+    });\n+\n+    it('should work with new versions', () => {\n+      setNgVersion('9.0.0');\n+      expect(appIsSupportedAngularVersion()).toBeTrue();\n+    });\n+\n+    it('should return false for older version', () => {\n+      setNgVersion('8.0.0');\n+      expect(appIsSupportedAngularVersion()).toBeFalse();\n+    });\n+\n+    it('should return false for no version', () => {\n+      expect(appIsSupportedAngularVersion()).toBeFalse();\n+    });\n+  });\n+\n+  describe('appIsAngular', () => {\n+    it('should return true for older version', () => {\n+      setNgVersion('8.0.0');\n+      expect(appIsAngular()).toBeTrue();\n+    });\n+\n+    it('should return false for no version', () => {\n+      expect(appIsAngular()).toBeFalse();\n+    });\n+  });\n+\n+  describe('appIsAngularIvy', () => {\n+    it('should not recognize VE apps', () => {\n+      (window as any).ng = {\n+        probe() {},\n+      };\n+      setNgVersion();\n+      expect(appIsAngularIvy()).toBeFalse();\n+    });\n+\n+    it('should not recognize no Angular apps', () => {\n+      expect(appIsAngularIvy()).toBeFalse();\n+    });\n+\n+    it('should recognize Ivy apps', () => {\n+      (window as any).getAllAngularRootElements = () => {\n+        const el = document.createElement('div');\n+        (el as any).__ngContext__ = 0;\n+        return [el];\n+      };\n+      expect(appIsAngularIvy()).toBeTrue();\n+      delete (window as any).getAllAngularRootElements;\n+    });\n+  });\n+\n+  describe('appIsAngularInDevMode', () => {\n+    afterEach(() => {\n+      delete (window as any).ng;\n+    });\n+\n+    it('should detect VE apps', () => {\n+      (window as any).ng = {\n+        probe() {},\n+      };\n+      setNgVersion();\n+\n+      expect(appIsAngularInDevMode()).toBeTrue();\n+    });\n+\n+    it('should detect Ivy apps', () => {\n+      (window as any).ng = {\n+        getComponent() {},\n+      };\n+      setNgVersion();\n+      expect(appIsAngularInDevMode()).toBeTrue();\n+    });\n+\n+    it('should not detect apps if `ng` is not an object with the right shape', () => {\n+      setNgVersion();\n+      (window as any).ng = {};\n+      expect(appIsAngularInDevMode()).toBeFalse();\n+\n+      (window as any).ng = () => {};\n+      expect(appIsAngularInDevMode()).toBeFalse();\n+    });\n+  });\n+});"
        },
        {
            "sha": "a73c95dfd1b995841f2244cec0f9619d1d89c0fe",
            "filename": "projects/ng-devtools-backend/src/lib/angular-check.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/e6bec2430a31991dfe09d99fcdb2c29f7008c496/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fangular-check.ts",
            "raw_url": "https://github.com/angular/angular/raw/e6bec2430a31991dfe09d99fcdb2c29f7008c496/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fangular-check.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fangular-check.ts?ref=e6bec2430a31991dfe09d99fcdb2c29f7008c496",
            "patch": "@@ -23,14 +23,18 @@ export const appIsSupportedAngularVersion = (): boolean => {\n \n /**\n  * We check if the global `window.ng` is an object and if this object\n- * has the `getComponent` method attached to it. In some g3 apps processed\n- * with Closure, `ng` is a function, which means that `typeof ng !== 'undefined'`\n- * is not a sufficient check.\n+ * has the `getComponent` or `probe` methods attached to it.\n+ *\n+ * `ng.probe` is a view engine method, but to ensure that we correctly\n+ * detect development mode we need to consider older rendering engines.\n+ *\n+ * In some g3 apps processed with Closure, `ng` is a function,\n+ * which means that `typeof ng !== 'undefined'` is not a sufficient check.\n  *\n  * @returns if the app has global ng debug object\n  */\n const appHasGlobalNgDebugObject = (): boolean => {\n-  return typeof ng === 'object' && typeof ng.getComponent === 'function';\n+  return typeof ng === 'object' && (typeof ng.getComponent === 'function' || typeof ng.probe === 'function');\n };\n \n export const getAngularVersion = (): string | null => {"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 117,
        "deletions": 4
    }
}