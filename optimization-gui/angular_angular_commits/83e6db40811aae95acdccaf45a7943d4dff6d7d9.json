{
    "author": "dgp1130",
    "message": "refactor(compiler-cli): add validation to extended template diagnostics configuration (#44391)\n\nRefs #42966.\n\nThis validates the `tsconfig.json` options for extended template diagnostics. It verifies:\n* `strictTemplates` must be enabled if `extendedDiagnostics` have any explicit configuration.\n* `extendedDiagnostics.defaultCategory` must be a valid `DiagnosticCategoryLabel`.\n* `extendedDiagnostics.checks` keys must all be real diagnostics.\n* `extendedDiagnostics.checks` values must all be valid `DiagnosticCategoryLabel`s.\n\nThese include new error codes, each of which prints out the exact property that was the issue and what the available options are to fix them.\n\nIt does disallow the config:\n\n```json\n{\n  \"angularCompilerOptions\": {\n    \"strictTemplates\": false,\n    \"extendedDiagnostics\": {\n      \"defaultCategory\": \"suppress\"\n    }\n  }\n}\n```\n\nSuch a configuration is technically valid and could be executed, but will be rejected by this verification logic. There isn't much reason to ever do this, since users could just drop `extendedDiagnostics` altogether and get the intended effect. This is unlikely to be a significant issue for users, so it is considered invalid for now to keep the implementation simple.\n\nPR Close #44391",
    "sha": "83e6db40811aae95acdccaf45a7943d4dff6d7d9",
    "files": [
        {
            "sha": "bb5dbbd8845c7da9282345fd30200278b2962675",
            "filename": "goldens/public-api/compiler-cli/error_code.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/83e6db40811aae95acdccaf45a7943d4dff6d7d9/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md",
            "raw_url": "https://github.com/angular/angular/raw/83e6db40811aae95acdccaf45a7943d4dff6d7d9/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.md?ref=83e6db40811aae95acdccaf45a7943d4dff6d7d9",
            "patch": "@@ -11,6 +11,12 @@ export enum ErrorCode {\n     COMPONENT_MISSING_TEMPLATE = 2001,\n     COMPONENT_RESOURCE_NOT_FOUND = 2008,\n     // (undocumented)\n+    CONFIG_EXTENDED_DIAGNOSTICS_IMPLIES_STRICT_TEMPLATES = 4003,\n+    // (undocumented)\n+    CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CATEGORY_LABEL = 4004,\n+    // (undocumented)\n+    CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CHECK = 4005,\n+    // (undocumented)\n     CONFIG_FLAT_MODULE_NO_INDEX = 4001,\n     // (undocumented)\n     CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK = 4002,"
        },
        {
            "sha": "32eebae4cdbbc53463ce052c1eb137bb4eef31ca",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 90,
            "deletions": 17,
            "changes": 107,
            "blob_url": "https://github.com/angular/angular/blob/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=83e6db40811aae95acdccaf45a7943d4dff6d7d9",
            "patch": "@@ -32,7 +32,7 @@ import {ALL_DIAGNOSTIC_FACTORIES, ExtendedTemplateCheckerImpl} from '../../typec\n import {ExtendedTemplateChecker} from '../../typecheck/extended/api';\n import {getSourceFileOrNull, isDtsPath, toUnredirectedSourceFile} from '../../util/src/typescript';\n import {Xi18nContext} from '../../xi18n';\n-import {NgCompilerAdapter, NgCompilerOptions} from '../api';\n+import {DiagnosticCategoryLabel, NgCompilerAdapter, NgCompilerOptions} from '../api';\n \n /**\n  * State information about a compilation which is only generated once some data is requested from\n@@ -322,11 +322,8 @@ export class NgCompiler {\n           'The \\'_extendedTemplateDiagnostics\\' option requires \\'strictTemplates\\' to also be enabled.');\n     }\n \n-    this.constructionDiagnostics.push(...this.adapter.constructionDiagnostics);\n-    const incompatibleTypeCheckOptionsDiagnostic = verifyCompatibleTypeCheckOptions(this.options);\n-    if (incompatibleTypeCheckOptionsDiagnostic !== null) {\n-      this.constructionDiagnostics.push(incompatibleTypeCheckOptionsDiagnostic);\n-    }\n+    this.constructionDiagnostics.push(\n+        ...this.adapter.constructionDiagnostics, ...verifyCompatibleTypeCheckOptions(this.options));\n \n     this.currentProgram = inputProgram;\n     this.closureCompilerEnabled = !!this.options.annotateForClosureCompiler;\n@@ -1135,16 +1132,15 @@ function getR3SymbolsFile(program: ts.Program): ts.SourceFile|null {\n  * \"fullTemplateTypeCheck\", it is required that the latter is not explicitly disabled if the\n  * former is enabled.\n  */\n-function verifyCompatibleTypeCheckOptions(options: NgCompilerOptions): ts.Diagnostic|null {\n+function*\n+    verifyCompatibleTypeCheckOptions(options: NgCompilerOptions):\n+        Generator<ts.Diagnostic, void, void> {\n   if (options.fullTemplateTypeCheck === false && options.strictTemplates === true) {\n-    return {\n+    yield makeConfigDiagnostic({\n       category: ts.DiagnosticCategory.Error,\n-      code: ngErrorCode(ErrorCode.CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK),\n-      file: undefined,\n-      start: undefined,\n-      length: undefined,\n-      messageText:\n-          `Angular compiler option \"strictTemplates\" is enabled, however \"fullTemplateTypeCheck\" is disabled.\n+      code: ErrorCode.CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK,\n+      messageText: `\n+Angular compiler option \"strictTemplates\" is enabled, however \"fullTemplateTypeCheck\" is disabled.\n \n Having the \"strictTemplates\" flag enabled implies that \"fullTemplateTypeCheck\" is also enabled, so\n the latter can not be explicitly disabled.\n@@ -1154,11 +1150,88 @@ One of the following actions is required:\n 2. Remove \"strictTemplates\" or set it to 'false'.\n \n More information about the template type checking compiler options can be found in the documentation:\n-https://angular.io/guide/template-typecheck`,\n-    };\n+https://angular.io/guide/template-typecheck\n+      `.trim(),\n+    });\n+  }\n+\n+  if (options.extendedDiagnostics && options.strictTemplates === false) {\n+    yield makeConfigDiagnostic({\n+      category: ts.DiagnosticCategory.Error,\n+      code: ErrorCode.CONFIG_EXTENDED_DIAGNOSTICS_IMPLIES_STRICT_TEMPLATES,\n+      messageText: `\n+Angular compiler option \"extendedDiagnostics\" is configured, however \"strictTemplates\" is disabled.\n+\n+Using \"extendedDiagnostics\" requires that \"strictTemplates\" is also enabled.\n+\n+One of the following actions is required:\n+1. Remove \"strictTemplates: false\" to enable it.\n+2. Remove \"extendedDiagnostics\" configuration to disable them.\n+      `.trim(),\n+    });\n   }\n \n-  return null;\n+  const allowedCategoryLabels = Array.from(Object.values(DiagnosticCategoryLabel)) as string[];\n+  const defaultCategory = options.extendedDiagnostics?.defaultCategory;\n+  if (defaultCategory && !allowedCategoryLabels.includes(defaultCategory)) {\n+    yield makeConfigDiagnostic({\n+      category: ts.DiagnosticCategory.Error,\n+      code: ErrorCode.CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CATEGORY_LABEL,\n+      messageText: `\n+Angular compiler option \"extendedDiagnostics.defaultCategory\" has an unknown diagnostic category: \"${\n+                       defaultCategory}\".\n+\n+Allowed diagnostic categories are:\n+${allowedCategoryLabels.join('\\n')}\n+      `.trim(),\n+    });\n+  }\n+\n+  const allExtendedDiagnosticNames =\n+      ALL_DIAGNOSTIC_FACTORIES.map((factory) => factory.name) as string[];\n+  for (const [checkName, category] of Object.entries(options.extendedDiagnostics?.checks ?? {})) {\n+    if (!allExtendedDiagnosticNames.includes(checkName)) {\n+      yield makeConfigDiagnostic({\n+        category: ts.DiagnosticCategory.Error,\n+        code: ErrorCode.CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CHECK,\n+        messageText: `\n+Angular compiler option \"extendedDiagnostics.checks\" has an unknown check: \"${checkName}\".\n+\n+Allowed check names are:\n+${allExtendedDiagnosticNames.join('\\n')}\n+        `.trim(),\n+      });\n+    }\n+\n+    if (!allowedCategoryLabels.includes(category)) {\n+      yield makeConfigDiagnostic({\n+        category: ts.DiagnosticCategory.Error,\n+        code: ErrorCode.CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CATEGORY_LABEL,\n+        messageText: `\n+Angular compiler option \"extendedDiagnostics.checks['${\n+                         checkName}']\" has an unknown diagnostic category: \"${category}\".\n+\n+Allowed diagnostic categories are:\n+${allowedCategoryLabels.join('\\n')}\n+        `.trim(),\n+      });\n+    }\n+  }\n+}\n+\n+function makeConfigDiagnostic({category, code, messageText}: {\n+  category: ts.DiagnosticCategory,\n+  code: ErrorCode,\n+  messageText: string,\n+}): ts.Diagnostic {\n+  return {\n+    category,\n+    code: ngErrorCode(code),\n+    file: undefined,\n+    start: undefined,\n+    length: undefined,\n+    messageText,\n+  };\n }\n \n class ReferenceGraphAdapter implements ReferencesRegistry {"
        },
        {
            "sha": "ee4b4c044d3f455d96202c69ce451ba5251d57f0",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=83e6db40811aae95acdccaf45a7943d4dff6d7d9",
            "patch": "@@ -71,6 +71,9 @@ export enum ErrorCode {\n \n   CONFIG_FLAT_MODULE_NO_INDEX = 4001,\n   CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK = 4002,\n+  CONFIG_EXTENDED_DIAGNOSTICS_IMPLIES_STRICT_TEMPLATES = 4003,\n+  CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CATEGORY_LABEL = 4004,\n+  CONFIG_EXTENDED_DIAGNOSTICS_UNKNOWN_CHECK = 4005,\n \n   /**\n    * Raised when a host expression has a parse error, such as a host listener or host binding"
        },
        {
            "sha": "a8d9fe22cf8e02bd063ca86a64506d3e889668f7",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/checks/invalid_banana_in_box/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fchecks%2Finvalid_banana_in_box%2FBUILD.bazel?ref=83e6db40811aae95acdccaf45a7943d4dff6d7d9",
            "patch": "@@ -3,7 +3,10 @@ load(\"//tools:defaults.bzl\", \"ts_library\")\n ts_library(\n     name = \"invalid_banana_in_box\",\n     srcs = [\"index.ts\"],\n-    visibility = [\"//packages/compiler-cli/src/ngtsc:__subpackages__\"],\n+    visibility = [\n+        \"//packages/compiler-cli/src/ngtsc:__subpackages__\",\n+        \"//packages/compiler-cli/test/ngtsc:__pkg__\",\n+    ],\n     deps = [\n         \"//packages/compiler\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\","
        },
        {
            "sha": "b27709f9aed06d36751173769dd8febc4f24b47d",
            "filename": "packages/compiler-cli/test/ngtsc/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2FBUILD.bazel?ref=83e6db40811aae95acdccaf45a7943d4dff6d7d9",
            "patch": "@@ -7,12 +7,14 @@ ts_library(\n     deps = [\n         \"//packages/compiler\",\n         \"//packages/compiler-cli\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n         \"//packages/compiler-cli/src/ngtsc/indexer\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/extended/checks/invalid_banana_in_box\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"//packages/compiler-cli/test:test_utils\",\n         \"@npm//source-map\","
        },
        {
            "sha": "aa707b4ac5a3b7d2d600fdbd1747e04b2700b4f7",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 123,
            "deletions": 1,
            "changes": 124,
            "blob_url": "https://github.com/angular/angular/blob/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/83e6db40811aae95acdccaf45a7943d4dff6d7d9/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=83e6db40811aae95acdccaf45a7943d4dff6d7d9",
            "patch": "@@ -8,10 +8,12 @@\n \n import ts from 'typescript';\n \n+import {DiagnosticCategoryLabel} from '../../src/ngtsc/core/api';\n import {ErrorCode, ngErrorCode} from '../../src/ngtsc/diagnostics';\n-import {absoluteFrom as _, getFileSystem, getSourceFileOrError} from '../../src/ngtsc/file_system';\n+import {absoluteFrom as _, getSourceFileOrError} from '../../src/ngtsc/file_system';\n import {runInEachFileSystem} from '../../src/ngtsc/file_system/testing';\n import {expectCompleteReuse, getSourceCodeForDiagnostic, loadStandardTestFiles} from '../../src/ngtsc/testing';\n+import {factory as invalidBananaInBoxFactory} from '../../src/ngtsc/typecheck/extended/checks/invalid_banana_in_box';\n \n import {NgtscTestEnvironment} from './env';\n \n@@ -2454,6 +2456,126 @@ export declare class AnimationEvent {\n            const diags = env.driveDiagnostics();\n            expect(diags.length).toBe(0);\n          });\n+\n+      it('should error if \"strictTemplates\" is false when \"extendedDiagnostics\" is configured', () => {\n+        env.tsconfig({strictTemplates: false, extendedDiagnostics: {}});\n+\n+        const diags = env.driveDiagnostics();\n+        expect(diags.length).toBe(1);\n+        expect(diags[0].messageText)\n+            .toContain(\n+                'Angular compiler option \"extendedDiagnostics\" is configured, however \"strictTemplates\" is disabled.');\n+      });\n+      it('should not error if \"strictTemplates\" is true when \"extendedDiagnostics\" is configured',\n+         () => {\n+           env.tsconfig({strictTemplates: true, extendedDiagnostics: {}});\n+\n+           const diags = env.driveDiagnostics();\n+           expect(diags).toEqual([]);\n+         });\n+      it('should not error if \"strictTemplates\" is false when \"extendedDiagnostics\" is not configured',\n+         () => {\n+           env.tsconfig({strictTemplates: false});\n+\n+           const diags = env.driveDiagnostics();\n+           expect(diags).toEqual([]);\n+         });\n+\n+      it('should error if \"extendedDiagnostics.defaultCategory\" is set to an unknown value', () => {\n+        env.tsconfig({\n+          extendedDiagnostics: {\n+            defaultCategory: 'does-not-exist',\n+          },\n+        });\n+\n+        const diags = env.driveDiagnostics();\n+        expect(diags.length).toBe(1);\n+        expect(diags[0].messageText)\n+            .toContain(\n+                'Angular compiler option \"extendedDiagnostics.defaultCategory\" has an unknown diagnostic category: \"does-not-exist\".');\n+        expect(diags[0].messageText).toContain(`\n+Allowed diagnostic categories are:\n+warning\n+error\n+suppress\n+        `.trim());\n+      });\n+      it('should not error if \"extendedDiagnostics.defaultCategory\" is set to a known value',\n+         () => {\n+           env.tsconfig({\n+             extendedDiagnostics: {\n+               defaultCategory: DiagnosticCategoryLabel.Error,\n+             },\n+           });\n+\n+           const diags = env.driveDiagnostics();\n+           expect(diags).toEqual([]);\n+         });\n+\n+      it('should error if \"extendedDiagnostics.checks\" contains an unknown check', () => {\n+        env.tsconfig({\n+          extendedDiagnostics: {\n+            checks: {\n+              doesNotExist: DiagnosticCategoryLabel.Error,\n+            },\n+          },\n+        });\n+\n+        const diags = env.driveDiagnostics();\n+        expect(diags.length).toBe(1);\n+        expect(diags[0].messageText)\n+            .toContain(\n+                'Angular compiler option \"extendedDiagnostics.checks\" has an unknown check: \"doesNotExist\".');\n+      });\n+      it('should not error if \"extendedDiagnostics.checks\" contains all known checks', () => {\n+        env.tsconfig({\n+          extendedDiagnostics: {\n+            checks: {\n+              [invalidBananaInBoxFactory.name]: DiagnosticCategoryLabel.Error,\n+            },\n+          },\n+        });\n+\n+        const diags = env.driveDiagnostics();\n+        expect(diags).toEqual([]);\n+      });\n+\n+      it('should error if \"extendedDiagnostics.checks\" contains an unknown diagnostic category',\n+         () => {\n+           env.tsconfig({\n+             extendedDiagnostics: {\n+               checks: {\n+                 [invalidBananaInBoxFactory.name]: 'does-not-exist',\n+               },\n+             },\n+           });\n+\n+           const diags = env.driveDiagnostics();\n+           expect(diags.length).toBe(1);\n+           expect(diags[0].messageText)\n+               .toContain(`Angular compiler option \"extendedDiagnostics.checks['${\n+                   invalidBananaInBoxFactory\n+                       .name}']\" has an unknown diagnostic category: \"does-not-exist\".`);\n+           expect(diags[0].messageText).toContain(`\n+Allowed diagnostic categories are:\n+warning\n+error\n+suppress\n+        `.trim());\n+         });\n+      it('should not error if \"extendedDiagnostics.checks\" contains all known diagnostic categories',\n+         () => {\n+           env.tsconfig({\n+             extendedDiagnostics: {\n+               checks: {\n+                 [invalidBananaInBoxFactory.name]: DiagnosticCategoryLabel.Error,\n+               },\n+             },\n+           });\n+\n+           const diags = env.driveDiagnostics();\n+           expect(diags).toEqual([]);\n+         });\n     });\n \n     describe('stability', () => {"
        }
    ],
    "stats": {
        "total": 247,
        "additions": 228,
        "deletions": 19
    }
}