{
    "author": "unknown",
    "message": "docs: Update security.md to include Trusted Types (#40142)\n\nPR Close #40142",
    "sha": "b3b85091cad0cb407c760788982ba63f08b5f8b2",
    "files": [
        {
            "sha": "47f6fe32228bab596dd97f12e450c370390335fc",
            "filename": "aio/content/guide/security.md",
            "status": "modified",
            "additions": 99,
            "deletions": 109,
            "changes": 208,
            "blob_url": "https://github.com/angular/angular/blob/b3b85091cad0cb407c760788982ba63f08b5f8b2/aio%2Fcontent%2Fguide%2Fsecurity.md",
            "raw_url": "https://github.com/angular/angular/raw/b3b85091cad0cb407c760788982ba63f08b5f8b2/aio%2Fcontent%2Fguide%2Fsecurity.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fsecurity.md?ref=b3b85091cad0cb407c760788982ba63f08b5f8b2",
            "patch": "@@ -1,34 +1,29 @@\n # Security\n \n-This page describes Angular's built-in\n+This topic describes Angular's built-in\n protections against common web-application vulnerabilities and attacks such as cross-site\n-scripting attacks. It doesn't cover application-level security, such as authentication (_Who is\n-this user?_) and authorization (_What can this user do?_).\n+scripting attacks. It doesn't cover application-level security, such as authentication and authorization.\n \n For more information about the attacks and mitigations described below, see [OWASP Guide Project](https://www.owasp.org/index.php/Category:OWASP_Guide_Project).\n \n You can run the <live-example></live-example> in Stackblitz and download the code from there.\n \n+<div class=\"callout is-important\">\n \n-\n-<h2 id='report-issues'>\n-  Reporting vulnerabilities\n-</h2>\n-\n-\n+{@a report-issues}\n+<header>Reporting vulnerabilities</header>\n \n To report vulnerabilities in Angular itself, email us at [security@angular.io](mailto:security@angular.io).\n \n For more information about how Google handles security issues, see [Google's security\n philosophy](https://www.google.com/about/appsecurity/).\n \n+</div>\n \n+<div class=\"callout is-helpful\">\n \n-<h2 id='best-practices'>\n-  Best practices\n-</h2>\n-\n-\n+{@a best-practices}\n+<header>Best practices</header>\n \n * **Keep current with the latest Angular library releases.**\n We regularly update the Angular libraries, and these updates may fix security defects discovered in\n@@ -43,13 +38,9 @@ community and make a pull request.\n * **Avoid Angular APIs marked in the documentation as “_Security Risk_.”**\n For more information, see the [Trusting safe values](guide/security#bypass-security-apis) section of this page.\n \n+</div>\n \n-\n-<h2 id='xss'>\n-  Preventing cross-site scripting (XSS)\n-</h2>\n-\n-\n+## Preventing cross-site scripting (XSS)\n \n [Cross-site scripting (XSS)](https://en.wikipedia.org/wiki/Cross-site_scripting) enables attackers\n to inject malicious code into web pages. Such code can then, for example, steal user data (in\n@@ -64,16 +55,11 @@ attacker-controlled data enters the DOM, expect security vulnerabilities.\n \n ### Angular’s cross-site scripting security model\n \n-To systematically block XSS bugs, Angular treats all values as untrusted by default. When a value\n-is inserted into the DOM from a template, via property, attribute, style, class binding, or interpolation,\n-Angular sanitizes and escapes untrusted values.\n+To systematically block XSS bugs, Angular treats all values as untrusted by default. When a value is inserted into the DOM from a template binding, or interpolation, Angular sanitizes and escapes untrusted values. If a value was already sanitized outside of Angular and is considered safe, you can communicate this to Angular by marking the [value as trusted](#bypass-security-apis).\n+\n+Unlike values to be used for rendering, Angular templates are considered trusted by default, and should be treated as executable code. Never generate templates by concatenating user input and template syntax. Doing this would enable attackers to [inject arbitrary code](https://en.wikipedia.org/wiki/Code_injection) into your application. To prevent these vulnerabilities, always use the default [AOT template compiler](/guide/security#offline-template-compiler) in production deployments.\n \n-_Angular templates are the same as executable code_: HTML, attributes, and binding expressions\n-(but not the values bound) in templates are trusted to be safe. This means that applications must\n-prevent values that an attacker can control from ever making it into the source code of a\n-template. Never generate template source code by concatenating user input and templates.\n-To prevent these vulnerabilities, use\n-the [offline template compiler](guide/security#offline-template-compiler), also known as _template injection_.\n+An additional layer of protection can be provided through the use of Content security policy and Trusted Types. These web platform features operate at the DOM level which is the most effective place to prevent XSS issues because they can't be bypassed using other, lower-level APIs. For this reason, we strongly encourage developers to take advantage of these features by configuring the [content security policy](#content-security-policy) for their application and enabling [trusted types enforcement](#trusted-types).\n \n ### Sanitization and security contexts\n \n@@ -97,35 +83,26 @@ when it has to change a value during sanitization.\n The following template binds the value of `htmlSnippet`, once by interpolating it into an element's\n content, and once by binding it to the `innerHTML` property of an element:\n \n-\n <code-example path=\"security/src/app/inner-html-binding.component.html\" header=\"src/app/inner-html-binding.component.html\"></code-example>\n \n-\n-\n Interpolated content is always escaped&mdash;the HTML isn't interpreted and the browser displays\n angle brackets in the element's text content.\n \n For the HTML to be interpreted, bind it to an HTML property such as `innerHTML`. But binding\n a value that an attacker might control into `innerHTML` normally causes an XSS\n-vulnerability. For example, code contained in a `<script>` tag is executed:\n-\n+vulnerability. For example, one could execute JavaScript in a following way:\n \n <code-example path=\"security/src/app/inner-html-binding.component.ts\" header=\"src/app/inner-html-binding.component.ts (class)\" region=\"class\"></code-example>\n \n-\n-\n-Angular recognizes the value as unsafe and automatically sanitizes it, which removes the `<script>`\n-tag but keeps safe content such as the `<b>` element.\n-\n+Angular recognizes the value as unsafe and automatically sanitizes it, which removes the `onerror` attribute but keeps safe content such as the `<b>` element.\n \n <div class=\"lightbox\">\n   <img src='generated/images/guide/security/binding-inner-html.png' alt='A screenshot showing interpolated and bound HTML values'>\n </div>\n \n-\n ### Direct use of the DOM APIs and explicit sanitization calls\n \n-The built-in browser DOM APIs don't automatically protect you from security vulnerabilities.\n+Unless you enforce Trusted Types, the built-in browser DOM APIs don't automatically protect you from security vulnerabilities.\n For example, `document`, the node available through `ElementRef`, and many third-party APIs\n contain unsafe methods. In the same way, if you interact with other libraries that manipulate\n the DOM, you likely won't have the same automatic sanitization as with Angular interpolations.\n@@ -137,43 +114,9 @@ method and the appropriate `SecurityContext`. That function also accepts values\n marked as trusted using the `bypassSecurityTrust`... functions, and will not sanitize them,\n as [described below](#bypass-security-apis).\n \n-### Content security policy\n-\n-Content Security Policy (CSP) is a defense-in-depth\n-technique to prevent XSS. To enable CSP, configure your web server to return an appropriate\n-`Content-Security-Policy` HTTP header. Read more about content security policy at the \n-[Web Fundamentals guide](https://developers.google.com/web/fundamentals/security/csp) on the\n-Google Developers website.\n-\n-\n-{@a offline-template-compiler}\n-\n-\n-### Use the offline template compiler\n-\n-The offline template compiler prevents a whole class of vulnerabilities called template injection,\n-and greatly improves application performance. Use the offline template compiler in production\n-deployments; don't dynamically generate templates. Angular trusts template code, so generating\n-templates, in particular templates containing user data, circumvents Angular's built-in protections.\n-For information about dynamically constructing forms in a safe way, see the\n-[Dynamic Forms](guide/dynamic-form) guide page.\n-\n-### Server-side XSS protection\n-\n-HTML constructed on the server is vulnerable to injection attacks. Injecting template code into an\n-Angular application is the same as injecting executable code into the\n-application: it gives the attacker full control over the application. To prevent this,\n-use a templating language that automatically escapes values to prevent XSS vulnerabilities on\n-the server. Don't generate Angular templates on the server side using a templating language; doing this\n-carries a high risk of introducing template-injection vulnerabilities.\n-\n-\n-\n-<h2 id='bypass-security-apis'>\n-  Trusting safe values\n-</h2>\n-\n+{@a bypass-security-apis}\n \n+### Trusting safe values\n \n Sometimes applications genuinely need to include executable code, display an `<iframe>` from some\n URL, or construct potentially dangerous URLs. To prevent automatic sanitization in any of these\n@@ -195,26 +138,18 @@ Remember, whether a value is safe depends on context, so choose the right contex\n your intended use of the value. Imagine that the following template needs to bind a URL to a\n `javascript:alert(...)` call:\n \n-\n <code-example path=\"security/src/app/bypass-security.component.html\" header=\"src/app/bypass-security.component.html (URL)\" region=\"URL\"></code-example>\n \n-\n-\n Normally, Angular automatically sanitizes the URL, disables the dangerous code, and\n in development mode, logs this action to the console. To prevent\n this, mark the URL value as a trusted URL using the `bypassSecurityTrustUrl` call:\n \n-\n <code-example path=\"security/src/app/bypass-security.component.ts\" header=\"src/app/bypass-security.component.ts (trust-url)\" region=\"trust-url\"></code-example>\n \n-\n-\n <div class=\"lightbox\">\n   <img src='generated/images/guide/security/bypass-security-component.png' alt='A screenshot showing an alert box created from a trusted URL'>\n </div>\n \n-\n-\n If you need to convert user input into a trusted value, use a\n controller method. The following template allows users to enter a YouTube video ID and load the\n corresponding video in an `<iframe>`. The `<iframe src>` attribute is a resource URL security\n@@ -225,29 +160,93 @@ Angular to allow binding into `<iframe src>`:\n \n <code-example path=\"security/src/app/bypass-security.component.html\" header=\"src/app/bypass-security.component.html (iframe)\" region=\"iframe\"></code-example>\n \n+<code-example path=\"security/src/app/bypass-security.component.ts\" header=\"src/app/bypass-security.component.ts (trust-video-url)\" region=\"trust-video-url\"></code-example>\n \n+{@a content-security-policy}\n+### Content security policy\n \n-<code-example path=\"security/src/app/bypass-security.component.ts\" header=\"src/app/bypass-security.component.ts (trust-video-url)\" region=\"trust-video-url\"></code-example>\n+Content Security Policy (CSP) is a defense-in-depth\n+technique to prevent XSS. To enable CSP, configure your web server to return an appropriate\n+`Content-Security-Policy` HTTP header. Read more about content security policy at the \n+[Web Fundamentals guide](https://developers.google.com/web/fundamentals/security/csp) on the\n+Google Developers website.\n \n+{@a trusted-types}\n+### Enforcing Trusted Types\n \n+We recommend the use of [Trusted Types](https://w3c.github.io/webappsec-trusted-types/dist/spec/) as a way to help secure your applications from cross-site scripting attacks. Trusted Types is a [web platform](https://en.wikipedia.org/wiki/Web_platform)\n+feature that can help you prevent cross-site scripting attacks by enforcing\n+safer coding practices. Trusted Types can also help simplify the auditing of application code.\n \n+<div class=\"callout is-helpful\">\n \n-<h2 id='http'>\n-  HTTP-level vulnerabilities\n-</h2>\n+Trusted Types might not yet be available in all browsers your application targets. In the case your Trusted-Types-enabled application runs in a browser that doesn't support Trusted Types, the functionality of the application will be preserved, and your application will be guarded against XSS via Angular's DomSanitizer. See [caniuse.com/trusted-types](https://caniuse.com/trusted-types) for the current browser support.\n \n+</div>\n \n+To enforce Trusted Types for your application, you must configure your application's web server to emit HTTP headers with one of the following Angular policies:\n \n-Angular has built-in support to help prevent two common HTTP vulnerabilities, cross-site request\n-forgery (CSRF or XSRF) and cross-site script inclusion (XSSI). Both of these must be mitigated primarily\n-on the server side, but Angular provides helpers to make integration on the client side easier.\n+* `angular` - This policy is used in security-reviewed code that is internal to Angular, and is required for Angular to function when Trusted Types are enforced. Any inline template values or content sanitized by Angular is treated as safe by this policy.\n+* `angular#unsafe-bypass` - This policy is used for applications that use any of the methods in Angular's [DomSanitizer](api/platform-browser/DomSanitizer) that bypass security, such as `bypassSecurityTrustHtml`. Any application that uses these methods must enable this policy.\n+* `angular#unsafe-jit` - This policy is used by the [JIT compiler](api/core/Compiler). You must enable this policy if your application interacts directly with the JIT compiler or is running in JIT mode using the [platform browser dynamic](api/platform-browser-dynamic/platformBrowserDynamic).\n+\n+You should configure the HTTP headers for Trusted Types in the following locations:\n+\n+* Production serving infrastructure\n+* Angular CLI (`ng serve`), using the `headers` property in the `angular.json` file, for local development and end-to-end testing\n+* Karma (`ng test`), using the `customHeaders` property in the `karma.config.js` file, for unit testing\n+\n+The following is an example of a header specifically configured for Trusted Types and Angular:\n+\n+<code-example language=\"html\">\n+Content-Security-Policy: trusted-types angular; required-trusted-types-for 'script';\n+</code-example>\n \n+The following is an example of a header specifically configured for Trusted Types and Angular applications that use any of the methods in Angular's [DomSanitizer](api/platform-browser/DomSanitizer) that bypasses security.\n \n-<h3 id='xsrf'>\n-  Cross-site request forgery\n-</h3>\n+<code-example language=\"html\">\n+Content-Security-Policy: trusted-types angular angular#unsafe-bypass; require-trusted-types-for 'script';\n+</code-example>\n \n+The following is an example of a header specifically configured for Trusted Types and Angular applications using JIT:\n \n+<code-example language=\"html\">\n+Content-Security-Policy: trusted-types angular angular#unsafe-jit; require-trusted-types-for 'script';\n+</code-example>\n+\n+<div class=\"callout is-helpful\">\n+\n+<header>Community contributions</header>\n+\n+To learn more about troubleshooting Trusted Type configurations, the following resource might be helpful:\n+\n+[Prevent DOM-based cross-site scripting vulnerabilities with Trusted Types](https://web.dev/trusted-types/#how-to-use-trusted-types)\n+\n+</div>\n+\n+{@a offline-template-compiler}\n+\n+### Use the AOT template compiler\n+\n+The AOT template compiler prevents a whole class of vulnerabilities called template injection,\n+and greatly improves application performance. The AOT template compiler is the default compiler used by Angular CLI applications, and you should use it in all production deployments.\n+\n+An alternative to the AOT compiler is the JIT compiler which compiles templates to executable template code within the browser at runtime. Angular trusts template code, so dynamically generating templates and compiling them, in particular templates containing user data, circumvents Angular's built-in protections and is a security anti-pattern. For information about dynamically constructing forms in a safe way, see the [Dynamic Forms](guide/dynamic-form) guide.\n+\n+{@a server-side-xss}\n+### Server-side XSS protection\n+\n+HTML constructed on the server is vulnerable to injection attacks. Injecting template code into an Angular application is the same as injecting executable code into the application: it gives the attacker full control over the application. To prevent this, use a templating language that automatically escapes values to prevent XSS vulnerabilities on the server. Don't generate Angular templates on the server side using a templating language; doing this carries a high risk of introducing template-injection vulnerabilities.\n+\n+{@a http}\n+## HTTP-level vulnerabilities\n+\n+Angular has built-in support to help prevent two common HTTP vulnerabilities, cross-site request\n+forgery (CSRF or XSRF) and cross-site script inclusion (XSSI). Both of these must be mitigated primarily\n+on the server side, but Angular provides helpers to make integration on the client side easier.\n+\n+{@a xsrf}\n+### Cross-site request forgery\n \n In a cross-site request forgery (CSRF or XSRF), an attacker tricks the user into visiting\n a different web page (such as `evil.com`) with malignant code that secretly sends a malicious request\n@@ -287,12 +286,8 @@ The Stanford University paper\n See also Dave Smith's easy-to-understand\n [talk on XSRF at AngularConnect 2016](https://www.youtube.com/watch?v=9inczw6qtpY \"Cross Site Request Funkery Securing Your Angular Apps From Evil Doers\").\n \n-\n-<h3 id='xssi'>\n-  Cross-site script inclusion (XSSI)\n-</h3>\n-\n-\n+{@a xssi}\n+### Cross-site script inclusion (XSSI)\n \n Cross-site script inclusion, also known as JSON vulnerability, can allow an attacker's website to\n read data from a JSON API. The attack works on older browsers by overriding native JavaScript\n@@ -308,15 +303,10 @@ Angular's `HttpClient` library recognizes this convention and automatically stri\n For more information, see the XSSI section of this [Google web security blog\n post](https://security.googleblog.com/2011/05/website-security-for-webmasters.html).\n \n-\n-\n-<h2 id='code-review'>\n-  Auditing Angular applications\n-</h2>\n-\n-\n+{@a code-review}\n+## Auditing Angular applications\n \n Angular applications must follow the same security principles as regular web applications, and\n must be audited as such. Angular-specific APIs that should be audited in a security review,\n such as the [_bypassSecurityTrust_](guide/security#bypass-security-apis) methods, are marked in the documentation\n-as security sensitive.\n+as security sensitive.\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 208,
        "additions": 99,
        "deletions": 109
    }
}