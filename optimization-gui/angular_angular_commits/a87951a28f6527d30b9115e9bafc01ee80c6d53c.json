{
    "author": "JoostK",
    "message": "fix(ngcc): prevent including JavaScript sources outside of the package (#37596)\n\nWhen ngcc creates an entry-point program, the `allowJs` option is enabled\nin order to operate on the JavaScript source files of the entry-point.\nA side-effect of this approach is that external modules that don't ship\ndeclaration files will also have their JavaScript source files loaded\ninto the program, as the `allowJs` flag allows for them to be imported.\nThis may pose an issue in certain edge cases, where ngcc would inadvertently\noperate on these external modules. This can introduce all sorts of undesirable\nbehavior and incompatibilities, e.g. the reflection host that is selected for\nthe entry-point's format could be incompatible with that of the external\nmodule's JavaScript bundles.\n\nTo avoid these kinds of issues, module resolution that would resolve to\na JavaScript file located outside of the package will instead be rejected,\nas if the file would not exist. This would have been the behavior when\n`allowJs` is set to false, which is the case in typical Angular compilations.\n\nFixes #37508\n\nPR Close #37596",
    "sha": "a87951a28f6527d30b9115e9bafc01ee80c6d53c",
    "files": [
        {
            "sha": "68eea9495df185f82fef710e27d7120ec3e8e007",
            "filename": "packages/compiler-cli/ngcc/src/packages/entry_point_bundle.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fentry_point_bundle.ts",
            "raw_url": "https://github.com/angular/angular/raw/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fentry_point_bundle.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fentry_point_bundle.ts?ref=a87951a28f6527d30b9115e9bafc01ee80c6d53c",
            "patch": "@@ -50,7 +50,7 @@ export function makeEntryPointBundle(\n   const rootDir = entryPoint.packagePath;\n   const options: ts\n       .CompilerOptions = {allowJs: true, maxNodeModuleJsDepth: Infinity, rootDir, ...pathMappings};\n-  const srcHost = new NgccSourcesCompilerHost(fs, options, entryPoint.path);\n+  const srcHost = new NgccSourcesCompilerHost(fs, options, entryPoint.packagePath);\n   const dtsHost = new NgtscCompilerHost(fs, options);\n \n   // Create the bundle programs, as necessary.\n@@ -63,7 +63,7 @@ export function makeEntryPointBundle(\n       [];\n   const dts = transformDts ? makeBundleProgram(\n                                  fs, isCore, entryPoint.packagePath, typingsPath, 'r3_symbols.d.ts',\n-                                 options, dtsHost, additionalDtsFiles) :\n+                                 {...options, allowJs: false}, dtsHost, additionalDtsFiles) :\n                              null;\n   const isFlatCore = isCore && src.r3SymbolsFile === null;\n "
        },
        {
            "sha": "4c5d62f767e3d8f26c35a4a73726d3c30d2ba1d7",
            "filename": "packages/compiler-cli/ngcc/src/packages/ngcc_compiler_host.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fngcc_compiler_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fngcc_compiler_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fngcc_compiler_host.ts?ref=a87951a28f6527d30b9115e9bafc01ee80c6d53c",
            "patch": "@@ -7,7 +7,8 @@\n  */\n import * as ts from 'typescript';\n \n-import {FileSystem, NgtscCompilerHost} from '../../../src/ngtsc/file_system';\n+import {AbsoluteFsPath, FileSystem, NgtscCompilerHost} from '../../../src/ngtsc/file_system';\n+import {isWithinPackage} from '../analysis/util';\n import {isRelativePath} from '../utils';\n \n /**\n@@ -20,7 +21,7 @@ export class NgccSourcesCompilerHost extends NgtscCompilerHost {\n   private cache = ts.createModuleResolutionCache(\n       this.getCurrentDirectory(), file => this.getCanonicalFileName(file));\n \n-  constructor(fs: FileSystem, options: ts.CompilerOptions, protected entryPointPath: string) {\n+  constructor(fs: FileSystem, options: ts.CompilerOptions, protected packagePath: AbsoluteFsPath) {\n     super(fs, options);\n   }\n \n@@ -36,13 +37,24 @@ export class NgccSourcesCompilerHost extends NgtscCompilerHost {\n       // file was in the same directory. This is undesirable, as we need to have the actual\n       // JavaScript being present in the program. This logic recognizes this scenario and rewrites\n       // the resolved .d.ts declaration file to its .js counterpart, if it exists.\n-      if (resolvedModule !== undefined && resolvedModule.extension === ts.Extension.Dts &&\n-          containingFile.endsWith('.js') && isRelativePath(moduleName)) {\n+      if (resolvedModule?.extension === ts.Extension.Dts && containingFile.endsWith('.js') &&\n+          isRelativePath(moduleName)) {\n         const jsFile = resolvedModule.resolvedFileName.replace(/\\.d\\.ts$/, '.js');\n         if (this.fileExists(jsFile)) {\n           return {...resolvedModule, resolvedFileName: jsFile, extension: ts.Extension.Js};\n         }\n       }\n+\n+      // Prevent loading JavaScript source files outside of the package root, which would happen for\n+      // packages that don't have .d.ts files. As ngcc should only operate on the .js files\n+      // contained within the package, any files outside the package are simply discarded. This does\n+      // result in a partial program with error diagnostics, however ngcc won't gather diagnostics\n+      // for the program it creates so these diagnostics won't be reported.\n+      if (resolvedModule?.extension === ts.Extension.Js &&\n+          !isWithinPackage(this.packagePath, this.fs.resolve(resolvedModule.resolvedFileName))) {\n+        return undefined;\n+      }\n+\n       return resolvedModule;\n     });\n   }"
        },
        {
            "sha": "75a23805543c580707de82d9cfa8d2bb66d258a7",
            "filename": "packages/compiler-cli/ngcc/test/helpers/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhelpers%2Futils.ts?ref=a87951a28f6527d30b9115e9bafc01ee80c6d53c",
            "patch": "@@ -68,7 +68,7 @@ export function makeTestBundleProgram(\n   const rootDir = fs.dirname(entryPointPath);\n   const options: ts.CompilerOptions =\n       {allowJs: true, maxNodeModuleJsDepth: Infinity, checkJs: false, rootDir, rootDirs: [rootDir]};\n-  const host = new NgccSourcesCompilerHost(fs, options, entryPointPath);\n+  const host = new NgccSourcesCompilerHost(fs, options, rootDir);\n   return makeBundleProgram(\n       fs, isCore, rootDir, path, 'r3_symbols.js', options, host, additionalFiles);\n }"
        },
        {
            "sha": "edbc73262129961a03f358ddcf3b01dd5f28cf76",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 115,
            "deletions": 0,
            "changes": 115,
            "blob_url": "https://github.com/angular/angular/blob/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=a87951a28f6527d30b9115e9bafc01ee80c6d53c",
            "patch": "@@ -401,6 +401,121 @@ runInEachFileSystem(() => {\n       expect(es5Contents).toContain('ɵngcc0.ɵɵtext(0, \"a - b - 3 - 4\")');\n     });\n \n+    it('should not crash when scanning for ModuleWithProviders needs to evaluate code from an external package',\n+       () => {\n+         // Regression test for https://github.com/angular/angular/issues/37508\n+         // During `ModuleWithProviders` analysis, return statements in methods are evaluated using\n+         // the partial evaluator to identify whether they correspond with a `ModuleWithProviders`\n+         // function. If an arbitrary method has a return statement that calls into an external\n+         // module which doesn't have declaration files, ngcc would attempt to reflect on said\n+         // module using the reflection host of the entry-point. This would crash in the case where\n+         // e.g. the entry-point is UMD and the external module would be CommonJS, as the UMD\n+         // reflection host would throw because it is unable to deal with CommonJS.\n+\n+         // Setup a non-TS package with CommonJS module format\n+         loadTestFiles([\n+           {\n+             name: _(`/node_modules/identity/package.json`),\n+             contents: `{\"name\": \"identity\", \"main\": \"./index.js\"}`,\n+           },\n+           {\n+             name: _(`/node_modules/identity/index.js`),\n+             contents: `\n+            function identity(x) { return x; };\n+            exports.identity = identity;\n+            module.exports = identity;\n+          `,\n+           },\n+         ]);\n+\n+         // Setup an Angular entry-point with UMD module format that references an export of the\n+         // CommonJS package.\n+         loadTestFiles([\n+           {\n+             name: _('/node_modules/test-package/package.json'),\n+             contents: '{\"name\": \"test-package\", \"main\": \"./index.js\", \"typings\": \"./index.d.ts\"}'\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.js'),\n+             contents: `\n+            (function (global, factory) {\n+              typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('identity')) :\n+              typeof define === 'function' && define.amd ? define('test', ['exports', 'identity'], factory) :\n+              (factory(global.test, global.identity));\n+            }(this, (function (exports, identity) { 'use strict';\n+              function Foo(x) {\n+                // The below statement is analyzed for 'ModuleWithProviders', so is evaluated\n+                // by ngcc. The reference into the non-TS CommonJS package used to crash ngcc.\n+                return identity.identity(x);\n+              }\n+              exports.Foo = Foo;\n+            })));\n+          `\n+           },\n+           {\n+             name: _('/node_modules/test-package/index.d.ts'),\n+             contents: 'export declare class Foo { static doSomething(x: any): any; }'\n+           },\n+           {name: _('/node_modules/test-package/index.metadata.json'), contents: 'DUMMY DATA'},\n+         ]);\n+\n+         expect(() => mainNgcc({\n+                  basePath: '/node_modules',\n+                  targetEntryPointPath: 'test-package',\n+                  propertiesToConsider: ['main'],\n+                }))\n+             .not.toThrow();\n+       });\n+\n+    it('should not be able to evaluate code in external packages when no .d.ts files are present',\n+       () => {\n+         loadTestFiles([\n+           {\n+             name: _(`/node_modules/external/package.json`),\n+             contents: `{\"name\": \"external\", \"main\": \"./index.js\"}`,\n+           },\n+           {\n+             name: _(`/node_modules/external/index.js`),\n+             contents: `\n+            export const selector = 'my-selector';\n+          `,\n+           },\n+         ]);\n+\n+         compileIntoApf('test-package', {\n+           '/index.ts': `\n+          import {NgModule, Component} from '@angular/core';\n+          import {selector} from 'external';\n+\n+          @Component({\n+            selector,\n+            template: ''\n+          })\n+          export class FooComponent {\n+          }\n+\n+          @NgModule({\n+            declarations: [FooComponent],\n+          })\n+          export class FooModule {}\n+        `,\n+         });\n+\n+         try {\n+           mainNgcc({\n+             basePath: '/node_modules',\n+             targetEntryPointPath: 'test-package',\n+             propertiesToConsider: ['esm2015', 'esm5'],\n+           });\n+           fail('should have thrown');\n+         } catch (e) {\n+           expect(e.message).toContain(\n+               'Failed to compile entry-point test-package (esm2015 as esm2015) due to compilation errors:');\n+           expect(e.message).toContain('NG1010');\n+           expect(e.message).toContain('selector must be a string');\n+         }\n+       });\n+\n     it('should add ɵfac but not duplicate ɵprov properties on injectables', () => {\n       compileIntoFlatEs2015Package('test-package', {\n         '/index.ts': `"
        },
        {
            "sha": "8eb133ed0a23a9b2b225fabce3c4e36e8553e898",
            "filename": "packages/compiler-cli/ngcc/test/packages/entry_point_bundle_spec.ts",
            "status": "modified",
            "additions": 102,
            "deletions": 1,
            "changes": 103,
            "blob_url": "https://github.com/angular/angular/blob/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_bundle_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a87951a28f6527d30b9115e9bafc01ee80c6d53c/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_bundle_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fpackages%2Fentry_point_bundle_spec.ts?ref=a87951a28f6527d30b9115e9bafc01ee80c6d53c",
            "patch": "@@ -13,8 +13,12 @@ import {makeEntryPointBundle} from '../../src/packages/entry_point_bundle';\n \n runInEachFileSystem(() => {\n   describe('entry point bundle', () => {\n+    let _: typeof absoluteFrom;\n+    beforeEach(() => {\n+      _ = absoluteFrom;\n+    });\n+\n     function setupMockFileSystem(): void {\n-      const _ = absoluteFrom;\n       loadTestFiles([\n         {\n           name: _('/node_modules/test/package.json'),\n@@ -210,6 +214,103 @@ runInEachFileSystem(() => {\n              ].map(p => absoluteFrom(p).toString())));\n        });\n \n+    it('does not include .js files outside of the package when no .d.ts file is available', () => {\n+      // Declare main \"test\" package with \"entry\" entry-point that imports all sorts of\n+      // internal and external modules.\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test/entry/package.json'),\n+          contents: `{\"name\": \"test\", \"main\": \"./index.js\", \"typings\": \"./index.d.ts\"}`,\n+        },\n+        {\n+          name: _('/node_modules/test/entry/index.d.ts'),\n+          contents: `\n+              import 'external-js';\n+              import 'external-ts';\n+              import 'nested-js';\n+              import './local';\n+              import '../package';\n+          `,\n+        },\n+        {\n+          name: _('/node_modules/test/entry/index.js'),\n+          contents: `\n+              import 'external-js';\n+              import 'external-ts';\n+              import 'nested-js';\n+              import './local';\n+              import '../package';\n+            `,\n+        },\n+        {name: _('/node_modules/test/entry/local.d.ts'), contents: `export {};`},\n+        {name: _('/node_modules/test/entry/local.js'), contents: `export {};`},\n+        {name: _('/node_modules/test/package.d.ts'), contents: `export {};`},\n+        {name: _('/node_modules/test/package.js'), contents: `export {};`},\n+      ]);\n+\n+      // Declare \"external-js\" package outside of the \"test\" package without .d.ts files, should\n+      // not be included in the program.\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/external-js/package.json'),\n+          contents: `{\"name\": \"external-js\", \"main\": \"./index.js\"}`,\n+        },\n+        {name: _('/node_modules/external-js/index.js'), contents: 'export {};'},\n+      ]);\n+\n+      // Same as \"external-js\" but located in a nested node_modules directory, which should also\n+      // not be included in the program.\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/test/node_modules/nested-js/package.json'),\n+          contents: `{\"name\": \"nested-js\", \"main\": \"./index.js\"}`,\n+        },\n+        {name: _('/node_modules/test/node_modules/nested-js/index.js'), contents: 'export {}'},\n+      ]);\n+\n+      // Declare \"external-ts\" which does have .d.ts files, so the .d.ts should be\n+      // loaded into the program.\n+      loadTestFiles([\n+        {\n+          name: _('/node_modules/external-ts/package.json'),\n+          contents: `{\"name\": \"external-ts\", \"main\": \"./index.js\", \"typings\": \"./index.d.ts\"}`,\n+        },\n+        {name: _('/node_modules/external-ts/index.d.ts'), contents: 'export {};'},\n+        {name: _('/node_modules/external-ts/index.js'), contents: 'export {};'},\n+      ]);\n+\n+      const fs = getFileSystem();\n+      const entryPoint: EntryPoint = {\n+        name: 'test/entry',\n+        path: absoluteFrom('/node_modules/test/entry'),\n+        packageName: 'test',\n+        packagePath: absoluteFrom('/node_modules/test'),\n+        packageJson: {name: 'test/entry'},\n+        typings: absoluteFrom('/node_modules/test/entry/index.d.ts'),\n+        compiledByAngular: true,\n+        ignoreMissingDependencies: false,\n+        generateDeepReexports: false,\n+      };\n+      const esm5bundle = makeEntryPointBundle(\n+          fs, entryPoint, './index.js', false, 'esm5', /* transformDts */ true,\n+          /* pathMappings */ undefined, /* mirrorDtsFromSrc */ true);\n+\n+      expect(esm5bundle.src.program.getSourceFiles().map(sf => _(sf.fileName)))\n+          .toEqual(jasmine.arrayWithExactContents([\n+            _('/node_modules/test/entry/index.js'),\n+            _('/node_modules/test/entry/local.js'),\n+            _('/node_modules/test/package.js'),\n+            _('/node_modules/external-ts/index.d.ts'),\n+          ]));\n+      expect(esm5bundle.dts!.program.getSourceFiles().map(sf => _(sf.fileName)))\n+          .toEqual(jasmine.arrayWithExactContents([\n+            _('/node_modules/test/entry/index.d.ts'),\n+            _('/node_modules/test/entry/local.d.ts'),\n+            _('/node_modules/test/package.d.ts'),\n+            _('/node_modules/external-ts/index.d.ts'),\n+          ]));\n+    });\n+\n     describe(\n         'including equivalently named, internally imported, src files in the typings program',\n         () => {"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 236,
        "deletions": 8
    }
}