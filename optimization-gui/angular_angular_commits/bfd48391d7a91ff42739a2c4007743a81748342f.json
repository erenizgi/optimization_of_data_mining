{
    "author": "devversion",
    "message": "fix(dev-infra): browser archive rule should handle `.dmg` files (#42992)\n\nWe recently reworked our browser archive extraction to happen\nat analysis time for better caching. This resulted in us breaking\nthe extraction of macOS dmg files so that Firefox is currently\nnot usable for local testing on macOS. We implement a similar special\nlogic for `.dmg` files to what has been done within the Bazel\nwebtesting rules.\n\nPR Close #42992",
    "sha": "bfd48391d7a91ff42739a2c4007743a81748342f",
    "files": [
        {
            "sha": "c51c40336e84c9cf712156f6f17eb136bdb6f461",
            "filename": "dev-infra/bazel/browsers/browser_archive_repo.bzl",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/bfd48391d7a91ff42739a2c4007743a81748342f/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_archive_repo.bzl",
            "raw_url": "https://github.com/angular/angular/raw/bfd48391d7a91ff42739a2c4007743a81748342f/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_archive_repo.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fbazel%2Fbrowsers%2Fbrowser_archive_repo.bzl?ref=bfd48391d7a91ff42739a2c4007743a81748342f",
            "patch": "@@ -1,11 +1,27 @@\n \"\"\"Implementation of the `browser_archive` rule.\"\"\"\n \n def _browser_archive_impl(ctx):\n-    ctx.report_progress(\"Downloading browser archive from: %s\" % ctx.attr.url)\n-    ctx.download_and_extract(\n-        url = ctx.attr.url,\n-        sha256 = ctx.attr.sha256,\n-    )\n+    url = ctx.attr.url\n+    sha256 = ctx.attr.sha256\n+\n+    # If the URL resolves to a `.dmg` file, then we need to convert the file\n+    # to a zip so that we can extract the actual binaries. We use the `convert_dmg`\n+    # script provided by the webtesting Bazel rules.\n+    if url.endswith(\".dmg\"):\n+        download_file_name = \"_download_file_%s.dmg\" % ctx.attr.name\n+        result_zip_name = \"_converted_file_%s.zip\" % ctx.attr.name\n+\n+        ctx.download(url, download_file_name, sha256)\n+        ctx.execute([ctx.path(Label(\"@io_bazel_rules_webtesting//web/internal:convert_dmg.sh\")), download_file_name, result_zip_name])\n+        ctx.extract(result_zip_name)\n+\n+        ctx.delete(result_zip_name)\n+        ctx.delete(download_file_name)\n+    else:\n+        ctx.download_and_extract(\n+            url = url,\n+            sha256 = sha256,\n+        )\n \n     # The browser archive has been downloaded and extracted. We now generate a repository\n     # `BUILD.bazel` file that exposes the archive files, together with the specified"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 21,
        "deletions": 5
    }
}