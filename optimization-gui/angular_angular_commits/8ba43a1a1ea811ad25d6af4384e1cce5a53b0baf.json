{
    "author": "dario-piotrowicz",
    "message": "fix(animations): retain triggers values for moved tracked list items (#44578)\n\nwhen reordering a list with animations the list items lose their current\ntriggers values, that is because the reordering of an item is implemented\nas follows (_note:_ the following implementation has been added in PR #23534)\n - the item is removed and marked _setForRemoval_\n - the item is re-inserted, and the _setForRemoval_ is changed to _setForMove_\n - the player set for animating the removal is destroyed when _setForMove_ is detected\n\nthe above steps allow the element not to be animated and to keep its styling but the\ntriggers values get lost since the removal transition/player has already been initialized,\nso this change adds a _previousTriggersValues_ map in the _REMOVAL_FLAG_ field in order to\nrestore the triggers values if/when the removal turns out to be a move, changing the above steps to:\n - the item is removed and marked setForRemoval __and its current triggers values are saved as well__\n - the item is re-inserted, and the setForRemoval is changed to setForMove\n - the player set for animating the removal is destroyed when setForMove is detected __and the\n   trigger values are re-applied in the engine's statesByElement map__\n\nresolves #29526\n\nPR Close #44578",
    "sha": "8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf",
    "files": [
        {
            "sha": "bc27085f54ca37bb65c4c0abd83e11895123a1a3",
            "filename": "packages/animations/browser/src/render/transition_animation_engine.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 5,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts",
            "raw_url": "https://github.com/angular/angular/raw/8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts?ref=8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf",
            "patch": "@@ -65,6 +65,7 @@ export interface ElementAnimationState {\n   hasAnimation: boolean;\n   namespaceId: string;\n   removedBeforeQueried: boolean;\n+  previousTriggersValues?: Map<string, string>;\n }\n \n export class StateValue {\n@@ -344,9 +345,11 @@ export class AnimationTransitionNamespace {\n       element: any, context: any, destroyAfterComplete?: boolean,\n       defaultToFallback?: boolean): boolean {\n     const triggerStates = this._engine.statesByElement.get(element);\n+    const previousTriggersValues = new Map<string, string>();\n     if (triggerStates) {\n       const players: TransitionAnimationPlayer[] = [];\n       Object.keys(triggerStates).forEach(triggerName => {\n+        previousTriggersValues.set(triggerName, triggerStates[triggerName].value);\n         // this check is here in the event that an element is removed\n         // twice (both on the host level and the component level)\n         if (this._triggers[triggerName]) {\n@@ -358,7 +361,7 @@ export class AnimationTransitionNamespace {\n       });\n \n       if (players.length) {\n-        this._engine.markElementAsRemoved(this.id, element, true, context);\n+        this._engine.markElementAsRemoved(this.id, element, true, context, previousTriggersValues);\n         if (destroyAfterComplete) {\n           optimizeGroupPlayer(players).onDone(() => this._engine.processLeaveNode(element));\n         }\n@@ -755,10 +758,17 @@ export class TransitionAnimationEngine {\n     }\n   }\n \n-  markElementAsRemoved(namespaceId: string, element: any, hasAnimation?: boolean, context?: any) {\n+  markElementAsRemoved(\n+      namespaceId: string, element: any, hasAnimation?: boolean, context?: any,\n+      previousTriggersValues?: Map<string, string>) {\n     this.collectedLeaveElements.push(element);\n-    element[REMOVAL_FLAG] =\n-        {namespaceId, setForRemoval: context, hasAnimation, removedBeforeQueried: false};\n+    element[REMOVAL_FLAG] = {\n+      namespaceId,\n+      setForRemoval: context,\n+      hasAnimation,\n+      removedBeforeQueried: false,\n+      previousTriggersValues\n+    };\n   }\n \n   listen(\n@@ -991,8 +1001,21 @@ export class TransitionAnimationEngine {\n \n         if (this.collectedEnterElements.length) {\n           const details = element[REMOVAL_FLAG] as ElementAnimationState;\n-          // move animations are currently not supported...\n+          // animations for move operations (elements being removed and reinserted,\n+          // e.g. when the order of an *ngFor list changes) are currently not supported\n           if (details && details.setForMove) {\n+            if (details.previousTriggersValues &&\n+                details.previousTriggersValues.has(entry.triggerName)) {\n+              const previousValue = details.previousTriggersValues.get(entry.triggerName) as string;\n+\n+              // we need to restore the previous trigger value since the element has\n+              // only been moved and hasn't actually left the DOM\n+              const triggersWithStates = this.statesByElement.get(entry.element);\n+              if (triggersWithStates && triggersWithStates[entry.triggerName]) {\n+                triggersWithStates[entry.triggerName].value = previousValue;\n+              }\n+            }\n+\n             player.destroy();\n             return;\n           }"
        },
        {
            "sha": "a5691ae1ce8033ace2a0524343b03c10f8f637ff",
            "filename": "packages/core/test/animation/animation_integration_spec.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_integration_spec.ts?ref=8ba43a1a1ea811ad25d6af4384e1cce5a53b0baf",
            "patch": "@@ -1644,6 +1644,70 @@ describe('animation tests', function() {\n          }\n        });\n \n+    it('should keep/restore the trigger value when there are move operations (with *ngFor + trackBy)',\n+       fakeAsync(() => {\n+         @Component({\n+           selector: 'ani-cmp',\n+           template: `\n+          <div *ngFor=\"let item of items, trackBy: trackItem\"\n+               @myAnimation (@myAnimation.start)=\"cb($event)\">\n+            item{{ item }}\n+          </div>\n+        `,\n+           animations: [trigger('myAnimation', [])]\n+         })\n+         class Cmp {\n+           public items: number[] = [];\n+\n+           log: string[] = [];\n+           cb(event: AnimationEvent) {\n+             this.log.push(\n+                 `[${event.element.innerText.trim()}] ${event.fromState} => ${event.toState}`);\n+           }\n+\n+           trackItem(_index: number, item: number) {\n+             return item.toString();\n+           }\n+           addItem() {\n+             this.items.push(this.items.length);\n+           }\n+           removeItem() {\n+             this.items.pop();\n+           }\n+           reverseItems() {\n+             this.items = this.items.reverse();\n+           }\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [Cmp]});\n+\n+         const engine = TestBed.inject(ÉµAnimationEngine);\n+         const fixture = TestBed.createComponent(Cmp);\n+         const cmp = fixture.componentInstance;\n+         fixture.detectChanges();\n+\n+         const completeAnimations = () => {\n+           fixture.detectChanges();\n+           flushMicrotasks();\n+           engine.players.forEach(player => player.finish());\n+         };\n+\n+         cmp.log = [];\n+         [0, 1, 2].forEach(() => cmp.addItem());\n+         completeAnimations();\n+         expect(cmp.log).toEqual(\n+             ['[item0] void => null', '[item1] void => null', '[item2] void => null']);\n+\n+         cmp.reverseItems();\n+         completeAnimations();\n+\n+         cmp.log = [];\n+         [0, 1, 2].forEach(() => cmp.removeItem());\n+         completeAnimations();\n+         expect(cmp.log).toEqual(\n+             ['[item2] null => void', '[item1] null => void', '[item0] null => void']);\n+       }));\n+\n     it('should animate removals of nodes to the `void` state for each animation trigger, but treat all auto styles as pre styles',\n        () => {\n          @Component({"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 92,
        "deletions": 5
    }
}