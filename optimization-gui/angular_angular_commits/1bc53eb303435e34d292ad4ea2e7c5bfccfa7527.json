{
    "author": "AndrewKushnir",
    "message": "fix(forms): more precise control cleanup (#39623)\n\nCurrently when an instance of the `FormControlName` directive is destroyed, the Forms package invokes\nthe `cleanUpControl` to clear all directive-specific logic (such as validators, onChange handlers,\netc) from a bound control. The logic of the `cleanUpControl` function should revert all setup\nperformed by the `setUpControl` function. However the `cleanUpControl` is too aggressive and removes\nall callbacks related to the onChange and disabled state handling. This is causing problems when\na form control is bound to multiple FormControlName` directives, causing other instances of that\ndirective to stop working correctly when the first one is destroyed.\n\nThis commit updates the cleanup logic to only remove callbacks added while setting up a control\nfor a given directive instance.\n\nThe fix is needed to allow adding `cleanUpControl` function to other places where cleanup is needed\n(missing this function calls in some other places causes memory leak issues).\n\nPR Close #39623",
    "sha": "1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
    "files": [
        {
            "sha": "8c26c0a4898b6fe60b9e164db4e5c10b92b9a38d",
            "filename": "goldens/circular-deps/packages.json",
            "status": "modified",
            "additions": 54,
            "deletions": 44,
            "changes": 98,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/goldens%2Fcircular-deps%2Fpackages.json",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/goldens%2Fcircular-deps%2Fpackages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fcircular-deps%2Fpackages.json?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -1003,73 +1003,51 @@\n     \"packages/core/testing/src/test_bed.ts\"\n   ],\n   [\n-    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/control_container.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n-  ],\n-  [\n-    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n-  ],\n-  [\n-    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n+    \"packages/forms/src/directives/abstract_control_directive.ts\",\n+    \"packages/forms/src/model.ts\",\n     \"packages/forms/src/directives/shared.ts\"\n   ],\n   [\n-    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n+    \"packages/forms/src/directives/abstract_control_directive.ts\",\n+    \"packages/forms/src/model.ts\",\n     \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/control_container.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n-  ],\n-  [\n     \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/ng_control.ts\",\n-    \"packages/forms/src/directives/control_container.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n+    \"packages/forms/src/directives/control_container.ts\"\n   ],\n   [\n-    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n+    \"packages/forms/src/directives/abstract_control_directive.ts\",\n+    \"packages/forms/src/model.ts\",\n     \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\"\n+    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n+    \"packages/forms/src/directives/control_container.ts\",\n+    \"packages/forms/src/directives/form_interface.ts\",\n+    \"packages/forms/src/directives/ng_control.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n     \"packages/forms/src/directives/control_container.ts\",\n     \"packages/forms/src/directives/form_interface.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n     \"packages/forms/src/directives/control_container.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n+    \"packages/forms/src/directives/form_interface.ts\",\n+    \"packages/forms/src/model.ts\",\n+    \"packages/forms/src/directives/shared.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n+    \"packages/forms/src/directives/shared.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_control_name.ts\"\n+    \"packages/forms/src/model.ts\",\n+    \"packages/forms/src/directives/shared.ts\"\n   ],\n   [\n-    \"packages/forms/src/directives/abstract_form_group_directive.ts\",\n-    \"packages/forms/src/directives/shared.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n-    \"packages/forms/src/directives/reactive_directives/form_control_name.ts\",\n     \"packages/forms/src/directives/control_container.ts\",\n-    \"packages/forms/src/directives/form_interface.ts\"\n+    \"packages/forms/src/directives/form_interface.ts\",\n+    \"packages/forms/src/directives/ng_control.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/ng_form.ts\",\n@@ -1087,17 +1065,32 @@\n     \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_control_name.ts\"\n   ],\n+  [\n+    \"packages/forms/src/directives/reactive_directives/form_control_directive.ts\",\n+    \"packages/forms/src/model.ts\",\n+    \"packages/forms/src/directives/shared.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_control_name.ts\"\n+  ],\n+  [\n+    \"packages/forms/src/directives/reactive_directives/form_control_name.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\"\n+  ],\n   [\n     \"packages/forms/src/directives/reactive_directives/form_control_name.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/reactive_directives/form_control_name.ts\",\n+    \"packages/forms/src/directives/shared.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\"\n   ],\n   [\n     \"packages/forms/src/directives/reactive_directives/form_control_name.ts\",\n+    \"packages/forms/src/model.ts\",\n     \"packages/forms/src/directives/shared.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\"\n@@ -1111,23 +1104,40 @@\n     \"packages/forms/src/directives/shared.ts\",\n     \"packages/forms/src/directives/reactive_directives/form_group_name.ts\"\n   ],\n+  [\n+    \"packages/forms/src/directives/reactive_directives/form_group_directive.ts\",\n+    \"packages/forms/src/model.ts\",\n+    \"packages/forms/src/directives/shared.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\"\n+  ],\n   [\n     \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n     \"packages/forms/src/directives/shared.ts\"\n   ],\n   [\n-    \"packages/forms/src/directives/validators.ts\",\n+    \"packages/forms/src/directives/reactive_directives/form_group_name.ts\",\n+    \"packages/forms/src/model.ts\",\n+    \"packages/forms/src/directives/shared.ts\"\n+  ],\n+  [\n+    \"packages/forms/src/directives/shared.ts\",\n     \"packages/forms/src/model.ts\"\n   ],\n   [\n+    \"packages/forms/src/directives/shared.ts\",\n+    \"packages/forms/src/validators.ts\",\n     \"packages/forms/src/directives/validators.ts\",\n-    \"packages/forms/src/validators.ts\"\n+    \"packages/forms/src/model.ts\"\n   ],\n   [\n-    \"packages/forms/src/directives/validators.ts\",\n+    \"packages/forms/src/directives/shared.ts\",\n     \"packages/forms/src/validators.ts\",\n     \"packages/forms/src/model.ts\"\n   ],\n+  [\n+    \"packages/forms/src/directives/validators.ts\",\n+    \"packages/forms/src/validators.ts\"\n+  ],\n   [\n     \"packages/language-service/src/completions.ts\",\n     \"packages/language-service/src/template.ts\","
        },
        {
            "sha": "89c55a2bcc39855c4d7d4c9edf371ebb9fba33d4",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -1455,10 +1455,10 @@\n     \"name\": \"remove\"\n   },\n   {\n-    \"name\": \"removeDir\"\n+    \"name\": \"removeFromArray\"\n   },\n   {\n-    \"name\": \"removeFromArray\"\n+    \"name\": \"removeListItem\"\n   },\n   {\n     \"name\": \"renderComponent\""
        },
        {
            "sha": "e1fb2c6e02d8dceab65bcbc0a7ab84ccf6fa803e",
            "filename": "packages/forms/src/directives/abstract_control_directive.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Fabstract_control_directive.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Fabstract_control_directive.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fabstract_control_directive.ts?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -230,6 +230,30 @@ export abstract class AbstractControlDirective {\n     return this._composedAsyncValidatorFn || null;\n   }\n \n+  /*\n+   * The set of callbacks to be invoked when directive instance is being destroyed.\n+   */\n+  private _onDestroyCallbacks: (() => void)[] = [];\n+\n+  /**\n+   * Internal function to register callbacks that should be invoked\n+   * when directive instance is being destroyed.\n+   * @internal\n+   */\n+  _registerOnDestroy(fn: () => void): void {\n+    this._onDestroyCallbacks.push(fn);\n+  }\n+\n+  /**\n+   * Internal function to invoke all registered \"on destroy\" callbacks.\n+   * Note: calling this function also clears the list of callbacks.\n+   * @internal\n+   */\n+  _invokeOnDestroyCallbacks(): void {\n+    this._onDestroyCallbacks.forEach(fn => fn());\n+    this._onDestroyCallbacks = [];\n+  }\n+\n   /**\n    * @description\n    * Resets the control with the provided value if the control is present."
        },
        {
            "sha": "b91cf567868d093246ee987ef6917aab27c2a6ac",
            "filename": "packages/forms/src/directives/ng_form.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Fng_form.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Fng_form.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fng_form.ts?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -16,7 +16,7 @@ import {Form} from './form_interface';\n import {NgControl} from './ng_control';\n import {NgModel} from './ng_model';\n import {NgModelGroup} from './ng_model_group';\n-import {removeDir, setUpControl, setUpFormContainer, syncPendingControls} from './shared';\n+import {removeListItem, setUpControl, setUpFormContainer, syncPendingControls} from './shared';\n import {AsyncValidator, AsyncValidatorFn, Validator, ValidatorFn} from './validators';\n \n export const formDirectiveProvider: any = {\n@@ -217,7 +217,7 @@ export class NgForm extends ControlContainer implements Form, AfterViewInit {\n       if (container) {\n         container.removeControl(dir.name);\n       }\n-      removeDir<NgModel>(this._directives, dir);\n+      removeListItem(this._directives, dir);\n     });\n   }\n "
        },
        {
            "sha": "b6a8f8f148fdc03ef3900ae4a1816e6e2a3eddf4",
            "filename": "packages/forms/src/directives/reactive_directives/form_group_directive.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -13,7 +13,7 @@ import {NG_ASYNC_VALIDATORS, NG_VALIDATORS} from '../../validators';\n import {ControlContainer} from '../control_container';\n import {Form} from '../form_interface';\n import {ReactiveErrors} from '../reactive_errors';\n-import {cleanUpControl, cleanUpValidators, removeDir, setUpControl, setUpFormContainer, setUpValidators, syncPendingControls} from '../shared';\n+import {cleanUpControl, cleanUpValidators, removeListItem, setUpControl, setUpFormContainer, setUpValidators, syncPendingControls} from '../shared';\n import {AsyncValidator, AsyncValidatorFn, Validator, ValidatorFn} from '../validators';\n \n import {FormControlName} from './form_control_name';\n@@ -161,7 +161,7 @@ export class FormGroupDirective extends ControlContainer implements Form, OnChan\n    * @param dir The `FormControlName` directive instance.\n    */\n   removeControl(dir: FormControlName): void {\n-    removeDir<FormControlName>(this.directives, dir);\n+    removeListItem(this.directives, dir);\n   }\n \n   /**"
        },
        {
            "sha": "3a6996044753439f882dacaae723c75f6789e9ee",
            "filename": "packages/forms/src/directives/shared.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 8,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Fshared.ts?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -47,11 +47,7 @@ export function setUpControl(control: FormControl, dir: NgControl): void {\n \n   setUpBlurPipeline(control, dir);\n \n-  if (dir.valueAccessor!.setDisabledState) {\n-    control.registerOnDisabledChange((isDisabled: boolean) => {\n-      dir.valueAccessor!.setDisabledState!(isDisabled);\n-    });\n-  }\n+  setUpDisabledChangeHandler(control, dir);\n }\n \n export function cleanUpControl(control: FormControl|null, dir: NgControl) {\n@@ -66,7 +62,10 @@ export function cleanUpControl(control: FormControl|null, dir: NgControl) {\n \n   cleanUpValidators(control, dir, /* handleOnValidatorChange */ true);\n \n-  if (control) control._clearChangeFns();\n+  if (control) {\n+    dir._invokeOnDestroyCallbacks();\n+    control._registerOnCollectionChange(() => {});\n+  }\n }\n \n function registerOnValidatorChange<V>(validators: (V|Validator)[], onChange: () => void): void {\n@@ -76,6 +75,28 @@ function registerOnValidatorChange<V>(validators: (V|Validator)[], onChange: ()\n   });\n }\n \n+/**\n+ * Sets up disabled change handler function on a given form control if ControlValueAccessor\n+ * associated with a given directive instance supports the `setDisabledState` call.\n+ *\n+ * @param control Form control where disabled change handler should be setup.\n+ * @param dir Corresponding directive instance associated with this control.\n+ */\n+export function setUpDisabledChangeHandler(control: FormControl, dir: NgControl): void {\n+  if (dir.valueAccessor!.setDisabledState) {\n+    const onDisabledChange = (isDisabled: boolean) => {\n+      dir.valueAccessor!.setDisabledState!(isDisabled);\n+    };\n+    control.registerOnDisabledChange(onDisabledChange);\n+\n+    // Register a callback function to cleanup disabled change handler\n+    // from a control instance when a directive is destroyed.\n+    dir._registerOnDestroy(() => {\n+      control._unregisterOnDisabledChange(onDisabledChange);\n+    });\n+  }\n+}\n+\n /**\n  * Sets up sync and async directive validators on provided form control.\n  * This function merges validators from the directive into the validators of the control.\n@@ -185,12 +206,19 @@ function updateControl(control: FormControl, dir: NgControl): void {\n }\n \n function setUpModelChangePipeline(control: FormControl, dir: NgControl): void {\n-  control.registerOnChange((newValue: any, emitModelEvent: boolean) => {\n+  const onChange = (newValue: any, emitModelEvent: boolean) => {\n     // control -> view\n     dir.valueAccessor!.writeValue(newValue);\n \n     // control -> ngModel\n     if (emitModelEvent) dir.viewToModelUpdate(newValue);\n+  };\n+  control.registerOnChange(onChange);\n+\n+  // Register a callback function to cleanup onChange handler\n+  // from a control instance when a directive is destroyed.\n+  dir._registerOnDestroy(() => {\n+    control._unregisterOnChange(onChange);\n   });\n }\n \n@@ -287,7 +315,7 @@ export function selectValueAccessor(\n   return null;\n }\n \n-export function removeDir<T>(list: T[], el: T): void {\n+export function removeListItem<T>(list: T[], el: T): void {\n   const index = list.indexOf(el);\n   if (index > -1) list.splice(index, 1);\n }"
        },
        {
            "sha": "a4cc280c2f4d1a989c10016fb46d42378872ea5a",
            "filename": "packages/forms/src/model.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fmodel.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Fsrc%2Fmodel.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fmodel.ts?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -9,6 +9,7 @@\n import {EventEmitter} from '@angular/core';\n import {Observable} from 'rxjs';\n \n+import {removeListItem} from './directives/shared';\n import {AsyncValidatorFn, ValidationErrors, ValidatorFn} from './directives/validators';\n import {composeAsyncValidators, composeValidators, toObservable} from './validators';\n \n@@ -1269,12 +1270,11 @@ export class FormControl extends AbstractControl {\n   }\n \n   /**\n+   * Internal function to unregister a change events listener.\n    * @internal\n    */\n-  _clearChangeFns(): void {\n-    this._onChange = [];\n-    this._onDisabledChange = [];\n-    this._onCollectionChange = () => {};\n+  _unregisterOnChange(fn: Function): void {\n+    removeListItem(this._onChange, fn);\n   }\n \n   /**\n@@ -1286,6 +1286,14 @@ export class FormControl extends AbstractControl {\n     this._onDisabledChange.push(fn);\n   }\n \n+  /**\n+   * Internal function to unregister a disabled event listener.\n+   * @internal\n+   */\n+  _unregisterOnDisabledChange(fn: (isDisabled: boolean) => void): void {\n+    removeListItem(this._onDisabledChange, fn);\n+  }\n+\n   /**\n    * @internal\n    */"
        },
        {
            "sha": "389042c4bad23bf9725c61e37302a163335d0817",
            "filename": "packages/forms/test/reactive_integration_spec.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 1,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1bc53eb303435e34d292ad4ea2e7c5bfccfa7527/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts?ref=1bc53eb303435e34d292ad4ea2e7c5bfccfa7527",
            "patch": "@@ -2594,7 +2594,7 @@ import {MyInput, MyInputForm} from './value_accessor_integration_spec';\n         expectValidatorsToBeCalled(newValidatorSpy, newAsyncValidatorSpy, {ctx: control, count: 1});\n       });\n \n-      it('should cleanup validators on a control used for multiple `formControlName` directive',\n+      it('should cleanup validators on a control used for multiple `formControlName` directives',\n          () => {\n            const fixture =\n                initTest(NgForFormControlWithValidators, MyCustomValidator, MyCustomAsyncValidator);\n@@ -2643,6 +2643,40 @@ import {MyInput, MyInputForm} from './value_accessor_integration_spec';\n            // of controls (one for each element in the `logins` array).\n            expectValidatorsToBeCalled(validatorSpy, asyncValidatorSpy, {ctx: newControl, count: 6});\n          });\n+\n+      it('should cleanup directive-specific callbacks only', () => {\n+        const fixture = initTest(MultipleFormControls, MyCustomValidator, MyCustomAsyncValidator);\n+        fixture.detectChanges();\n+\n+        const sharedControl = fixture.componentInstance.control;\n+\n+        const validatorSpy = validatorSpyOn(MyCustomValidator);\n+        const asyncValidatorSpy = validatorSpyOn(MyCustomAsyncValidator);\n+\n+        sharedControl.setValue('b');\n+        fixture.detectChanges();\n+\n+        // Check that validators were called for each `formControlName` directive instance\n+        // (2 times total).\n+        expectValidatorsToBeCalled(validatorSpy, asyncValidatorSpy, {ctx: sharedControl, count: 2});\n+\n+        // Replace formA with a new instance. This will trigger destroy operation for the\n+        // `formControlName` directive that is bound to the `control` FormControl instance.\n+        const newFormA = new FormGroup({login: new FormControl('new-a')});\n+        fixture.componentInstance.formA = newFormA;\n+        fixture.detectChanges();\n+\n+        validatorSpy.calls.reset();\n+        asyncValidatorSpy.calls.reset();\n+\n+        // Update control with a new value.\n+        sharedControl.setValue('d');\n+        fixture.detectChanges();\n+\n+        // We should still see an update to the second <input>.\n+        expect(fixture.nativeElement.querySelector('#login').value).toBe('d');\n+        expectValidatorsToBeCalled(validatorSpy, asyncValidatorSpy, {ctx: sharedControl, count: 1});\n+      });\n     });\n   });\n }\n@@ -2920,6 +2954,34 @@ class FormControlWithValidators {\n   form = new FormGroup({login: new FormControl('INITIAL')});\n }\n \n+@Component({\n+  selector: 'ngfor-form-controls-with-validators',\n+  template: `\n+    <div [formGroup]=\"formA\">\n+      <input\n+        type=\"radio\"\n+        formControlName=\"login\"\n+        my-custom-validator\n+        my-custom-async-validator\n+      />\n+    </div>\n+    <div [formGroup]=\"formB\">\n+      <input\n+        id=\"login\"\n+        type=\"text\"\n+        formControlName=\"login\"\n+        my-custom-validator\n+        my-custom-async-validator\n+      />\n+    </div>\n+  `\n+})\n+class MultipleFormControls {\n+  control = new FormControl('a');\n+  formA = new FormGroup({login: this.control});\n+  formB = new FormGroup({login: this.control});\n+}\n+\n @Component({\n   selector: 'ngfor-form-controls-with-validators',\n   template: `"
        }
    ],
    "stats": {
        "total": 258,
        "additions": 195,
        "deletions": 63
    }
}