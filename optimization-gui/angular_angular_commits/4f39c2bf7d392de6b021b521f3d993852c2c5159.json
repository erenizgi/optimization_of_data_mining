{
    "author": "gkalpak",
    "message": "feat(docs-infra): create undo functions for all pre-deploy actions (#43963)\n\nCreate functions to undo the changes made by any pre-deploy action.\nIn a future commit, this will allow deploying a build to multiple\nprojects/sites with different small tweaks for each.\n\nPR Close #43963",
    "sha": "4f39c2bf7d392de6b021b521f3d993852c2c5159",
    "files": [
        {
            "sha": "2f6d0a27ea534029e66dcf1c78048ea7d859f332",
            "filename": "aio/scripts/deploy-to-firebase/pre-deploy-actions.mjs",
            "status": "modified",
            "additions": 54,
            "deletions": 5,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/4f39c2bf7d392de6b021b521f3d993852c2c5159/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs",
            "raw_url": "https://github.com/angular/angular/raw/4f39c2bf7d392de6b021b521f3d993852c2c5159/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs?ref=4f39c2bf7d392de6b021b521f3d993852c2c5159",
            "patch": "@@ -1,13 +1,26 @@\n+import fs from 'fs';\n import sh from 'shelljs';\n import u from './utils.mjs';\n \n \n+// Constants\n+const DIST_DIR = 'dist';\n+const FIREBASE_JSON_PATH = 'firebase.json';\n+const NGSW_JSON_PATH = `${DIST_DIR}/ngsw.json`;\n+const NGSW_JSON_BAK_PATH = `${NGSW_JSON_PATH}.bak`;\n+\n // Exports\n const exp = {\n   build,\n   checkPayloadSize,\n   disableServiceWorker,\n   redirectToAngularIo,\n+  undo: {\n+    build: undoBuild,\n+    checkPayloadSize: undoCheckPayloadSize,\n+    disableServiceWorker: undoDisableServiceWorker,\n+    redirectToAngularIo: undoRedirectToAngularIo,\n+  },\n };\n export default exp;\n \n@@ -17,7 +30,7 @@ function build({deployedUrl, deployEnv}) {\n   u.yarn(`build --configuration=${deployEnv} --progress=false`);\n \n   u.logSectionHeader('Add any mode-specific files into the AIO distribution.');\n-  sh.cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+  sh.cp('-rf', `src/extra-files/${deployEnv}/.`, DIST_DIR);\n \n   u.logSectionHeader('Update opensearch descriptor for AIO with `deployedUrl`.');\n   u.yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`); // The URL must end with `/`.\n@@ -33,7 +46,15 @@ function disableServiceWorker() {\n \n   // Rename the SW manifest (`ngsw.json`). This will cause the ServiceWorker to unregister itself.\n   // See https://angular.io/guide/service-worker-devops#fail-safe.\n-  sh.mv('dist/ngsw.json', 'dist/ngsw.json.bak');\n+  sh.mv(NGSW_JSON_PATH, NGSW_JSON_BAK_PATH);\n+}\n+\n+function escapeForRegex(str) {\n+  return str.replace(/[.?*+\\\\|^$()[\\]{}]/g, '\\\\$&');\n+}\n+\n+function getFirebaseRedirectRuleTo(origin) {\n+  return `{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"${origin}:1\"}`;\n }\n \n function redirectToAngularIo() {\n@@ -42,7 +63,35 @@ function redirectToAngularIo() {\n   // Update the Firebase hosting configuration to redirect all non-file requests (i.e. requests that\n   // do not contain a dot in their last path segment) to `angular.io`.\n   // See https://firebase.google.com/docs/hosting/full-config#redirects.\n-  const redirectRule =\n-      '{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"}';\n-  sh.sed('-i', /(\\s*)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`, 'firebase.json');\n+  const redirectRule = getFirebaseRedirectRuleTo('https://angular.io');\n+  const oldContent = fs.readFileSync(FIREBASE_JSON_PATH, 'utf8');\n+  const newContent = oldContent.replace(/( *)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`);\n+\n+  fs.writeFileSync(FIREBASE_JSON_PATH, newContent);\n+}\n+\n+function undoBuild() {\n+  u.logSectionHeader('Remove the build artifacts.');\n+  sh.rm('-rf', DIST_DIR);\n+}\n+\n+function undoCheckPayloadSize() {\n+  // Nothing to undo.\n+}\n+\n+function undoDisableServiceWorker() {\n+  u.logSectionHeader('Re-enable the ServiceWorker.');\n+  sh.mv(NGSW_JSON_BAK_PATH, NGSW_JSON_PATH);\n+}\n+\n+function undoRedirectToAngularIo() {\n+  u.logSectionHeader('Remove Firebase hosting redirect to https://angular.io/.');\n+\n+  const redirectRule = getFirebaseRedirectRuleTo('https://angular.io');\n+  const oldContent = fs.readFileSync(FIREBASE_JSON_PATH, 'utf8');\n+  const newContent = oldContent.replace(\n+      new RegExp(`(( *)\"redirects\": \\\\[)\\\\n\\\\2  ${escapeForRegex(redirectRule)},\\\\n`),\n+      '$1');\n+\n+  fs.writeFileSync(FIREBASE_JSON_PATH, newContent);\n }"
        },
        {
            "sha": "844e50a0479bf39f8e45f7a6fe68b240ff0c4ea7",
            "filename": "aio/scripts/deploy-to-firebase/pre-deploy-actions.spec.mjs",
            "status": "modified",
            "additions": 134,
            "deletions": 4,
            "changes": 138,
            "blob_url": "https://github.com/angular/angular/blob/4f39c2bf7d392de6b021b521f3d993852c2c5159/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/4f39c2bf7d392de6b021b521f3d993852c2c5159/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs?ref=4f39c2bf7d392de6b021b521f3d993852c2c5159",
            "patch": "@@ -1,3 +1,4 @@\n+import fs from 'fs';\n import sh from 'shelljs';\n import pre from './pre-deploy-actions.mjs';\n import u from './utils.mjs';\n@@ -6,6 +7,16 @@ import u from './utils.mjs';\n describe('deploy-to-firebase/pre-deploy-actions:', () => {\n   beforeEach(() => spyOn(u, 'logSectionHeader'));\n \n+  it('should define an undo function for each exported function', () => {\n+    const exportedFunctionNames = Object.keys(pre).filter(name => typeof pre[name] === 'function');\n+\n+    for (const name of exportedFunctionNames) {\n+      expect(pre.undo[name]).\n+          withContext(`Testing for 'undo.${name}()'`).\n+          toEqual(jasmine.any(Function));\n+    }\n+  });\n+\n   describe('build()', () => {\n     let cpSpy;\n     let yarnSpy;\n@@ -22,7 +33,7 @@ describe('deploy-to-firebase/pre-deploy-actions:', () => {\n \n     it('should add mode-specific files into the distribution', () => {\n       pre.build({deployedUrl: 'http://example.com/foo/', deployEnv: 'bar'});\n-      expect(cpSpy).toHaveBeenCalledWith('-rf', 'src/extra-files/bar/.', 'dist/');\n+      expect(cpSpy).toHaveBeenCalledWith('-rf', 'src/extra-files/bar/.', 'dist');\n     });\n \n     it('should update the opensearch descriptor', () => {\n@@ -46,7 +57,7 @@ describe('deploy-to-firebase/pre-deploy-actions:', () => {\n       pre.build({deployedUrl: 'http://example.com/foo/', deployEnv: 'bar'});\n       expect(logs).toEqual([\n         'yarn build --configuration=bar --progress=false',\n-        'cp -rf src/extra-files/bar/. dist/',\n+        'cp -rf src/extra-files/bar/. dist',\n         'yarn set-opensearch-url http://example.com/foo/',\n       ]);\n     });\n@@ -75,7 +86,126 @@ describe('deploy-to-firebase/pre-deploy-actions:', () => {\n   });\n \n   describe('redirectToAngularIo()', () => {\n-    // TODO(gkalpak): Add tests for this function.\n-    it('should have tests');\n+    let readFileSpy;\n+    let writeFileSpy;\n+\n+    beforeEach(() => {\n+      readFileSpy = spyOn(fs, 'readFileSync').and.returnValue('Test file content.');\n+      writeFileSpy = spyOn(fs, 'writeFileSync');\n+    });\n+\n+    it('should read from and write to the Firebase config file', () => {\n+      pre.redirectToAngularIo();\n+\n+      expect(readFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'utf8');\n+      expect(writeFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'Test file content.');\n+    });\n+\n+    it('should add a redirect rule to `angular.io`', () => {\n+      readFileSpy.and.returnValue(`\n+        {\n+          \"foo\": \"bar\",\n+          \"hosting\": {\n+            \"baz\": \"qux\",\n+            \"redirects\": [\n+              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+            ]\n+          }\n+        }\n+      `);\n+\n+      pre.redirectToAngularIo();\n+\n+      expect(writeFileSpy.calls.first().args[1]).toBe(`\n+        {\n+          \"foo\": \"bar\",\n+          \"hosting\": {\n+            \"baz\": \"qux\",\n+            \"redirects\": [\n+              {\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"},\n+\n+              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+            ]\n+          }\n+        }\n+      `);\n+    });\n+  });\n+\n+  describe('undo.build()', () => {\n+    let rmSpy;\n+\n+    beforeEach(() => rmSpy = spyOn(sh, 'rm'));\n+\n+    it('should undo `build()`', () => {\n+      pre.undo.build();\n+      expect(rmSpy).toHaveBeenCalledWith('-rf', 'dist');\n+    });\n+  });\n+\n+  describe('undo.checkPayloadSize()', () => {\n+    // This is a no-op, so nothing to test.\n+  });\n+\n+  describe('undo.disableServiceWorker()', () => {\n+    let mvSpy;\n+\n+    beforeEach(() => mvSpy = spyOn(sh, 'mv'));\n+\n+    it('should undo `disableServiceWorker()`', () => {\n+      pre.undo.disableServiceWorker();\n+      expect(mvSpy).toHaveBeenCalledWith('dist/ngsw.json.bak', 'dist/ngsw.json');\n+    });\n+  });\n+\n+  describe('undo.redirectToAngularIo()', () => {\n+    let readFileSpy;\n+    let writeFileSpy;\n+\n+    beforeEach(() => {\n+      readFileSpy = spyOn(fs, 'readFileSync').and.returnValue('Test file content.');\n+      writeFileSpy = spyOn(fs, 'writeFileSync');\n+    });\n+\n+    it('should read from and write to the Firebase config file', () => {\n+      pre.undo.redirectToAngularIo();\n+\n+      expect(readFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'utf8');\n+      expect(writeFileSpy).toHaveBeenCalledOnceWith('firebase.json', 'Test file content.');\n+    });\n+\n+    it('should remove a redirect rule to `angular.io`', () => {\n+      readFileSpy.and.returnValue(`\n+        {\n+          \"foo\": \"bar\",\n+          \"hosting\": {\n+            \"baz\": \"qux\",\n+            \"redirects\": [\n+              {\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"},\n+\n+              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+            ]\n+          }\n+        }\n+      `);\n+\n+      pre.undo.redirectToAngularIo();\n+\n+      expect(writeFileSpy.calls.first().args[1]).toBe(`\n+        {\n+          \"foo\": \"bar\",\n+          \"hosting\": {\n+            \"baz\": \"qux\",\n+            \"redirects\": [\n+              {\"type\": 301, \"regex\": \"/source/1\", \"destination\": \"/destination/1\"},\n+              {\"type\": 301, \"source\": \"/source/2\", \"destination\": \"/destination/2\"},\n+            ]\n+          }\n+        }\n+      `);\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 197,
        "additions": 188,
        "deletions": 9
    }
}