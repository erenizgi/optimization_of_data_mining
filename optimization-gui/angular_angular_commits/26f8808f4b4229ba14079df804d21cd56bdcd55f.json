{
    "author": "mgechev",
    "message": "refactor(devtools): remove MutationObserver and rename observer to execution hooks",
    "sha": "26f8808f4b4229ba14079df804d21cd56bdcd55f",
    "files": [
        {
            "sha": "8c7debecc29d5d8abb44683e5b97843dfd880a4c",
            "filename": "projects/ng-devtools-backend/src/lib/client-event-subscribers.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "raw_url": "https://github.com/angular/angular/raw/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fclient-event-subscribers.ts?ref=26f8808f4b4229ba14079df804d21cd56bdcd55f",
            "patch": "@@ -10,7 +10,7 @@ import {\n   ComponentExplorerViewQuery,\n } from 'protocol';\n import { ComponentTreeNode, getLatestComponentState, queryDirectiveForest, updateState } from './component-tree';\n-import { start as startProfiling, stop as stopProfiling } from './observer/capture';\n+import { start as startProfiling, stop as stopProfiling } from './hooks/capture';\n import { serializeDirectiveState } from './state-serializer/state-serializer';\n import { ComponentInspector, ComponentInspectorOptions } from './component-inspector/component-inspector';\n import { setConsoleReference } from './set-console-reference';\n@@ -22,7 +22,7 @@ import {\n   appIsAngularIvy,\n } from './angular-check';\n import { debounceTime } from 'rxjs/operators';\n-import { disableTimingAPI, enableTimingAPI, initializeOrGetDirectiveForestObserver } from './observer';\n+import { disableTimingAPI, enableTimingAPI, initializeOrGetDirectiveForestHooks } from './hooks';\n import { runOutsideAngular } from './utils';\n \n export const subscribeToClientEvents = (messageBus: MessageBus<Events>): void => {\n@@ -51,7 +51,7 @@ export const subscribeToClientEvents = (messageBus: MessageBus<Events>): void =>\n     // update requests, instead we want to request an update at most\n     // every 250ms\n     runOutsideAngular(() => {\n-      initializeOrGetDirectiveForestObserver()\n+      initializeOrGetDirectiveForestHooks()\n         .changeDetection$.pipe(debounceTime(250))\n         .subscribe(() => messageBus.emit('componentTreeDirty'));\n     });\n@@ -71,18 +71,18 @@ const getLatestComponentExplorerViewCallback = (messageBus: MessageBus<Events>)\n ) => {\n   // We want to force re-indexing of the component tree.\n   // Pressing the refresh button means the user saw stuck UI.\n-  initializeOrGetDirectiveForestObserver().indexForest();\n+  initializeOrGetDirectiveForestHooks().indexForest();\n   if (!query) {\n     messageBus.emit('latestComponentExplorerView', [\n       {\n-        forest: prepareForestForSerialization(initializeOrGetDirectiveForestObserver().getDirectiveForest()),\n+        forest: prepareForestForSerialization(initializeOrGetDirectiveForestHooks().getDirectiveForest()),\n       },\n     ]);\n     return;\n   }\n   messageBus.emit('latestComponentExplorerView', [\n     {\n-      forest: prepareForestForSerialization(initializeOrGetDirectiveForestObserver().getDirectiveForest()),\n+      forest: prepareForestForSerialization(initializeOrGetDirectiveForestHooks().getDirectiveForest()),\n       properties: getLatestComponentState(query),\n     },\n   ]);\n@@ -100,7 +100,7 @@ const stopProfilingCallback = (messageBus: MessageBus<Events>) => () => {\n };\n \n const selectedComponentCallback = (position: ElementPosition) => {\n-  const node = queryDirectiveForest(position, initializeOrGetDirectiveForestObserver().getDirectiveForest());\n+  const node = queryDirectiveForest(position, initializeOrGetDirectiveForestHooks().getDirectiveForest());\n   setConsoleReference({ node, position });\n };\n \n@@ -109,7 +109,7 @@ const getNestedPropertiesCallback = (messageBus: MessageBus<Events>) => (\n   propPath: string[]\n ) => {\n   const emitEmpty = () => messageBus.emit('nestedProperties', [position, { props: {} }, propPath]);\n-  const node = queryDirectiveForest(position.element, initializeOrGetDirectiveForestObserver().getDirectiveForest());\n+  const node = queryDirectiveForest(position.element, initializeOrGetDirectiveForestHooks().getDirectiveForest());\n   if (!node) {\n     return emitEmpty();\n   }\n@@ -138,7 +138,7 @@ const checkForAngular = (messageBus: MessageBus<Events>, attempt = 0): void => {\n     return;\n   }\n   if (appIsIvy) {\n-    initializeOrGetDirectiveForestObserver();\n+    initializeOrGetDirectiveForestHooks();\n   }\n   messageBus.emit('ngAvailability', [\n     { version: ngVersion.toString(), devMode: appIsAngularInDevMode(), ivy: appIsIvy },\n@@ -192,12 +192,12 @@ export const prepareForestForSerialization = (roots: ComponentTreeNode[]): Seria\n         ? {\n             name: node.component.name,\n             isElement: node.component.isElement,\n-            id: initializeOrGetDirectiveForestObserver().getDirectiveId(node.component.instance),\n+            id: initializeOrGetDirectiveForestHooks().getDirectiveId(node.component.instance),\n           }\n         : null,\n       directives: node.directives.map((d) => ({\n         name: d.name,\n-        id: initializeOrGetDirectiveForestObserver().getDirectiveId(d.instance),\n+        id: initializeOrGetDirectiveForestHooks().getDirectiveId(d.instance),\n       })),\n       children: prepareForestForSerialization(node.children),\n     } as SerializableComponentTreeNode;"
        },
        {
            "sha": "8a9db23383fe5ccb6b2380dd4f81f23a05616bee",
            "filename": "projects/ng-devtools-backend/src/lib/component-inspector/component-inspector.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-inspector%2Fcomponent-inspector.ts",
            "raw_url": "https://github.com/angular/angular/raw/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-inspector%2Fcomponent-inspector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fcomponent-inspector%2Fcomponent-inspector.ts?ref=26f8808f4b4229ba14079df804d21cd56bdcd55f",
            "patch": "@@ -2,7 +2,7 @@ import { unHighlight, highlight, findComponentAndHost } from '../highlighter';\n import { Type } from '@angular/core';\n import { buildDirectiveForest, ComponentTreeNode, findNodeInForest } from '../component-tree';\n import { ElementPosition } from 'protocol';\n-import { initializeOrGetDirectiveForestObserver } from '../observer';\n+import { initializeOrGetDirectiveForestHooks } from '../hooks';\n \n export interface ComponentInspectorOptions {\n   onComponentEnter: (id: number) => void;\n@@ -46,9 +46,7 @@ export class ComponentInspector {\n     e.preventDefault();\n \n     if (this._selectedComponent.component && this._selectedComponent.host) {\n-      this._onComponentSelect(\n-        initializeOrGetDirectiveForestObserver().getDirectiveId(this._selectedComponent.component)\n-      );\n+      this._onComponentSelect(initializeOrGetDirectiveForestHooks().getDirectiveId(this._selectedComponent.component));\n     }\n   }\n \n@@ -63,9 +61,7 @@ export class ComponentInspector {\n     unHighlight();\n     if (this._selectedComponent.component && this._selectedComponent.host) {\n       highlight(this._selectedComponent.host);\n-      this._onComponentEnter(\n-        initializeOrGetDirectiveForestObserver().getDirectiveId(this._selectedComponent.component)\n-      );\n+      this._onComponentEnter(initializeOrGetDirectiveForestHooks().getDirectiveId(this._selectedComponent.component));\n     }\n   }\n "
        },
        {
            "sha": "7fc9115cb0c662c63436bafcbb9592b7a002951d",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/capture.ts",
            "status": "renamed",
            "additions": 17,
            "deletions": 17,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fcapture.ts",
            "raw_url": "https://github.com/angular/angular/raw/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fcapture.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fcapture.ts?ref=26f8808f4b4229ba14079df804d21cd56bdcd55f",
            "patch": "@@ -1,31 +1,31 @@\n-import { DirectiveForestObserver, Hooks } from './observer';\n+import { DirectiveForestHooks, Hooks } from './hooks';\n import { ElementPosition, ProfilerFrame, ElementProfile, DirectiveProfile, LifecycleProfile } from 'protocol';\n import { runOutsideAngular, isCustomElement } from '../utils';\n import { getDirectiveName } from '../highlighter';\n import { ComponentTreeNode } from '../component-tree';\n-import { initializeOrGetDirectiveForestObserver } from '.';\n+import { initializeOrGetDirectiveForestHooks } from '.';\n \n let inProgress = false;\n let inChangeDetection = false;\n let eventMap: Map<any, DirectiveProfile>;\n let frameDuration = 0;\n-let observerHooks: Partial<Hooks> = {};\n+let hooks: Partial<Hooks> = {};\n \n export const start = (onFrame: (frame: ProfilerFrame) => void): void => {\n   if (inProgress) {\n     throw new Error('Recording already in progress');\n   }\n   eventMap = new Map<any, DirectiveProfile>();\n   inProgress = true;\n-  observerHooks = getObserverHooks(onFrame);\n-  initializeOrGetDirectiveForestObserver().subscribe(observerHooks);\n+  hooks = getHooks(onFrame);\n+  initializeOrGetDirectiveForestHooks().subscribe(hooks);\n };\n \n export const stop = (): ProfilerFrame => {\n-  const observer = initializeOrGetDirectiveForestObserver();\n-  const result = flushBuffer(observer);\n-  initializeOrGetDirectiveForestObserver().unsubscribe(observerHooks);\n-  observerHooks = {};\n+  const directiveForestHooks = initializeOrGetDirectiveForestHooks();\n+  const result = flushBuffer(directiveForestHooks);\n+  initializeOrGetDirectiveForestHooks().unsubscribe(hooks);\n+  hooks = {};\n   inProgress = false;\n   return result;\n };\n@@ -42,7 +42,7 @@ const getEventStart = (map: { [key: string]: number }, directive: any, label: st\n   return map[key];\n };\n \n-const getObserverHooks = (onFrame: (frame: ProfilerFrame) => void) => {\n+const getHooks = (onFrame: (frame: ProfilerFrame) => void) => {\n   const timeStartMap: { [key: string]: number } = {};\n   return {\n     // We flush here because it's possible the current node to overwrite\n@@ -63,7 +63,7 @@ const getObserverHooks = (onFrame: (frame: ProfilerFrame) => void) => {\n         runOutsideAngular(() => {\n           Promise.resolve().then(() => {\n             inChangeDetection = false;\n-            onFrame(flushBuffer(initializeOrGetDirectiveForestObserver(), source));\n+            onFrame(flushBuffer(initializeOrGetDirectiveForestHooks(), source));\n           });\n         });\n       }\n@@ -196,14 +196,14 @@ const prepareInitialFrame = (source: string, duration: number) => {\n     duration,\n     directives: [],\n   };\n-  const observer = initializeOrGetDirectiveForestObserver();\n-  const directiveForest = observer.getDirectiveForest();\n+  const directiveForestHooks = initializeOrGetDirectiveForestHooks();\n+  const directiveForest = directiveForestHooks.getDirectiveForest();\n   const traverse = (node: ComponentTreeNode, children = frame.directives) => {\n     let position: ElementPosition | undefined;\n     if (node.component) {\n-      position = observer.getDirectivePosition(node.component.instance);\n+      position = directiveForestHooks.getDirectivePosition(node.component.instance);\n     } else {\n-      position = observer.getDirectivePosition(node.directives[0].instance);\n+      position = directiveForestHooks.getDirectivePosition(node.directives[0].instance);\n     }\n     if (position === undefined) {\n       return;\n@@ -235,12 +235,12 @@ const prepareInitialFrame = (source: string, duration: number) => {\n   return frame;\n };\n \n-const flushBuffer = (obs: DirectiveForestObserver, source: string = '') => {\n+const flushBuffer = (directiveForestHooks: DirectiveForestHooks, source: string = '') => {\n   const items = Array.from(eventMap.keys());\n   const positions: ElementPosition[] = [];\n   const positionDirective = new Map<ElementPosition, any>();\n   items.forEach((dir) => {\n-    const position = obs.getDirectivePosition(dir);\n+    const position = directiveForestHooks.getDirectivePosition(dir);\n     if (position === undefined) {\n       return;\n     }",
            "previous_filename": "projects/ng-devtools-backend/src/lib/observer/capture.ts"
        },
        {
            "sha": "f1256e7be5d00653a2c04bb7a9c67cb7d641b092",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/hooks.ts",
            "status": "renamed",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts",
            "raw_url": "https://github.com/angular/angular/raw/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fhooks.ts?ref=26f8808f4b4229ba14079df804d21cd56bdcd55f",
            "patch": "@@ -102,15 +102,10 @@ const getLifeCycleName = (obj: {}, fn: any): keyof LifecycleProfile | 'unknown'\n };\n \n /**\n- * This is a temporal \"polyfill\" until we receive more comprehensive framework\n- * debugging APIs. This observer checks for new elements added. When it detects\n- * this has happened, it checks if any of the elements in the tree with root\n- * the added element is a component. If it is, it throws a creation event.\n- * The polyfill also patches the tView template function reference to allow\n- * tracking of how much time we spend in the particular component in change detection.\n+ * This is a temporal \"polyfill\" until we receive\n+ * more comprehensive framework debugging APIs.\n  */\n-export class DirectiveForestObserver {\n-  private _mutationObserver = new MutationObserver(this._onMutation.bind(this));\n+export class DirectiveForestHooks {\n   private _patched = new Map<any, () => void>();\n   private _undoLifecyclePatch: (() => void)[] = [];\n   private _lastChangeDetection = new Map<any, number>();\n@@ -150,15 +145,10 @@ export class DirectiveForestObserver {\n   }\n \n   initialize(): void {\n-    this._mutationObserver.observe(document, {\n-      subtree: true,\n-      childList: true,\n-    });\n     this.indexForest();\n   }\n \n   destroy(): void {\n-    this._mutationObserver.disconnect();\n     this._lastChangeDetection = new Map<any, number>();\n     this._tracker.destroy();\n ",
            "previous_filename": "projects/ng-devtools-backend/src/lib/observer/observer.ts"
        },
        {
            "sha": "9d96c755e154e59b4b84f16b500c68e4198de3e5",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/identity-tracker.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/angular/angular/blob/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fidentity-tracker.ts",
            "raw_url": "https://github.com/angular/angular/raw/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fidentity-tracker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Fidentity-tracker.ts?ref=26f8808f4b4229ba14079df804d21cd56bdcd55f",
            "previous_filename": "projects/ng-devtools-backend/src/lib/observer/identity-tracker.ts"
        },
        {
            "sha": "0a7eaccb9a8b7ce6f0578cbf0fc8674818f8d45a",
            "filename": "projects/ng-devtools-backend/src/lib/hooks/index.ts",
            "status": "renamed",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/26f8808f4b4229ba14079df804d21cd56bdcd55f/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fng-devtools-backend%2Fsrc%2Flib%2Fhooks%2Findex.ts?ref=26f8808f4b4229ba14079df804d21cd56bdcd55f",
            "patch": "@@ -1,5 +1,5 @@\n import { getDirectiveName } from '../highlighter';\n-import { DirectiveForestObserver } from './observer';\n+import { DirectiveForestHooks } from './hooks';\n import { LifecycleProfile } from 'protocol';\n \n const markName = (s: string, method: Method) => `ðŸ…°ï¸ ${s}#${method}`;\n@@ -36,12 +36,12 @@ export const disableTimingAPI = () => (timingAPIFlag = false);\n \n const timingAPIEnabled = () => timingAPIFlag;\n \n-export let observer: DirectiveForestObserver;\n-export const initializeOrGetDirectiveForestObserver = () => {\n-  if (observer) {\n-    return observer;\n+export let directiveForestHooks: DirectiveForestHooks;\n+export const initializeOrGetDirectiveForestHooks = () => {\n+  if (directiveForestHooks) {\n+    return directiveForestHooks;\n   }\n-  observer = new DirectiveForestObserver({\n+  directiveForestHooks = new DirectiveForestHooks({\n     onChangeDetectionStart(component: any): void {\n       if (!timingAPIEnabled()) {\n         return;\n@@ -67,6 +67,6 @@ export const initializeOrGetDirectiveForestObserver = () => {\n       endMark(getDirectiveName(component), lifecyle);\n     },\n   });\n-  observer.initialize();\n-  return observer;\n+  directiveForestHooks.initialize();\n+  return directiveForestHooks;\n };",
            "previous_filename": "projects/ng-devtools-backend/src/lib/observer/index.ts"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 42,
        "deletions": 56
    }
}