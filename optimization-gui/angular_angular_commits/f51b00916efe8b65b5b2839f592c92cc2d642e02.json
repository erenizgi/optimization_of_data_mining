{
    "author": "devversion",
    "message": "build: fix integration test size trackings not running after recent refactoring (#44430)\n\nFixes that the integration test size trackings stopped working due to\nthe recent refactorings (switch to the rule from `@angular/dev-infra-private`).\n\nThe size-tracking does not integrate very-well into Bazel and needs\na better solution in the future, allowing for RBE and Windows support,\nbut currently with the new rule/setup/structure the tracking does not\nvalidate sizes because:\n\n* The `dist/*.js` argument to the tracking script got expanded and\n  messed up the indices. It should be passed as a literal. This now\n  surfaced because the new rule runs commands in a shell.\n\n* The name for the size goldens were not computed properly because they\n  were based on `ctx.attr.name`, but given the new structure, the test\n  targets are always named `test`.\n\nPR Close #44430",
    "sha": "f51b00916efe8b65b5b2839f592c92cc2d642e02",
    "files": [
        {
            "sha": "317f3bf7925dd1945f64c08ee8e3103101299e84",
            "filename": "integration/cli-hello-world-ivy-compat/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-ivy-compat%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-ivy-compat%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fcli-hello-world-ivy-compat%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,6 +2,6 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    commands = \"payload_size_tracking\",\n     setup_chromium = True,\n+    track_payload_size = \"cli-hello-world-ivy-compat\",\n )"
        },
        {
            "sha": "f7c03388c9a8f46b876a5f15bba5990f896d796c",
            "filename": "integration/cli-hello-world-ivy-i18n/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-ivy-i18n%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-ivy-i18n%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fcli-hello-world-ivy-i18n%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,6 +2,6 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    commands = \"payload_size_tracking\",\n     setup_chromium = True,\n+    track_payload_size = \"cli-hello-world-ivy-i18n\",\n )"
        },
        {
            "sha": "069e20d79264f8a2ba5673e3eb00ad242f5aa2f0",
            "filename": "integration/cli-hello-world-ivy-minimal/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-ivy-minimal%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-ivy-minimal%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fcli-hello-world-ivy-minimal%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,6 +2,6 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    commands = \"payload_size_tracking\",\n     setup_chromium = True,\n+    track_payload_size = \"cli-hello-world-ivy-minimal\",\n )"
        },
        {
            "sha": "c33a1cce355d6de0f017740d9ae7f79d32eb21f2",
            "filename": "integration/cli-hello-world-lazy/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-lazy%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world-lazy%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fcli-hello-world-lazy%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,6 +2,6 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    commands = \"payload_size_tracking\",\n     setup_chromium = True,\n+    track_payload_size = \"cli-hello-world-lazy\",\n )"
        },
        {
            "sha": "04ee97fe99768ed3a103d43b7e974dd24af09add",
            "filename": "integration/cli-hello-world/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fcli-hello-world%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fcli-hello-world%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,6 +2,6 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    commands = \"payload_size_tracking\",\n     setup_chromium = True,\n+    track_payload_size = \"cli-hello-world\",\n )"
        },
        {
            "sha": "6fc3fef04f9487400ab67943dceba77ea311d680",
            "filename": "integration/forms/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fforms%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fforms%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fforms%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,6 +2,6 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    commands = \"payload_size_tracking\",\n     setup_chromium = True,\n+    track_payload_size = \"forms\",\n )"
        },
        {
            "sha": "905707ba692e154273bbacad48c03d06f4b92c13",
            "filename": "integration/hello_world__closure/BUILD.bazel",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fhello_world__closure%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Fhello_world__closure%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Fhello_world__closure%2FBUILD.bazel?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -2,10 +2,10 @@ load(\"//integration:index.bzl\", \"ng_integration_test\")\n \n ng_integration_test(\n     name = \"test\",\n-    # TODO: Re-enable the payload_size_tracking command:\n+    # TODO: Re-enable size-tracking:\n     # We should define ngDevMode to false in Closure, but --define only works in the global scope.\n     # With ngDevMode not being set to false, this size tracking test provides little value but a lot of\n     # headache to continue updating the size.\n-    # commands = \"payload_size_tracking\",\n+    # track_payload_size = \"hello_world_closure\",\n     setup_chromium = True,\n )"
        },
        {
            "sha": "866fb6ccc0341d361b016084ed863b5c3530981c",
            "filename": "integration/index.bzl",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Findex.bzl",
            "raw_url": "https://github.com/angular/angular/raw/f51b00916efe8b65b5b2839f592c92cc2d642e02/integration%2Findex.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/integration%2Findex.bzl?ref=f51b00916efe8b65b5b2839f592c92cc2d642e02",
            "patch": "@@ -38,6 +38,7 @@ def _ng_integration_test(name, setup_chromium = False, **kwargs):\n     use_view_engine_packages = kwargs.pop(\"use_view_engine_packages\", [])\n     toolchains = kwargs.pop(\"toolchains\", [])\n     environment = kwargs.pop(\"environment\", {})\n+    track_payload_size = kwargs.pop(\"track_payload_size\", None)\n     data = kwargs.pop(\"data\", [])\n \n     data += [\n@@ -56,18 +57,16 @@ def _ng_integration_test(name, setup_chromium = False, **kwargs):\n \n     # By default run `yarn install` followed by `yarn test` using the tools linked\n     # into the integration tests (using the `tool_mappings` attribute).\n-    commands = [\n+    commands = kwargs.pop(\"commands\", [\n         \"yarn install --cache-folder ./.yarn_local_cache\",\n         \"yarn test\",\n-    ]\n-\n-    command_type = kwargs.pop(\"commands\", \"default\")\n+    ])\n \n-    if command_type == \"payload_size_tracking\":\n+    if track_payload_size:\n         commands += [\n             \"yarn build\",\n             # TODO: Replace the track payload-size script with a RBE and Windows-compatible script.\n-            \"$(rootpath //:scripts/ci/track-payload-size.sh) %s dist/*.js true $${RUNFILES}/angular/$(rootpath //goldens:size-tracking/integration-payloads.json)\" % name,\n+            \"$(rootpath //:scripts/ci/track-payload-size.sh) %s 'dist/*.js' true $${RUNFILES}/angular/$(rootpath //goldens:size-tracking/integration-payloads.json)\" % track_payload_size,\n         ]\n         data += [\n             \"//goldens:size-tracking/integration-payloads.json\","
        }
    ],
    "stats": {
        "total": 27,
        "additions": 13,
        "deletions": 14
    }
}