{
    "author": "josephperrott",
    "message": "feat(dev-infra): verify breaking changes are properly labeled before merging (#41546)\n\nDuring merging with `ng-dev pr merge` tooling will ensure that pull requests are\nproperly labeled for breaking changes.  Pull requests with commits noting breaking\nchanges must also be labeled as such, additionally pull requests with breaking\nchange labels must contain commits noting breaking changes.\n\nFixes #38776\n\nPR Close #41546",
    "sha": "4a69a7b95244a6d01143b6b8da11816c268c68da",
    "files": [
        {
            "sha": "5d86f09a9f9317e3fa3ed1f45287570b7e8f8764",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 35,
            "deletions": 8,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=4a69a7b95244a6d01143b6b8da11816c268c68da",
            "patch": "@@ -3365,6 +3365,16 @@ var PullRequestFailure = /** @class */ (function () {\n             'or \"target: major\" label.';\n         return new this(message);\n     };\n+    PullRequestFailure.missingBreakingChangeLabel = function () {\n+        var message = 'Pull Request has at least one commit containing a breaking change note, but ' +\n+            'does not have a breaking change label.';\n+        return new this(message);\n+    };\n+    PullRequestFailure.missingBreakingChangeCommit = function () {\n+        var message = 'Pull Request has a breaking change label, but does not contain any commits ' +\n+            'with breaking change notes.';\n+        return new this(message);\n+    };\n     return PullRequestFailure;\n }());\n \n@@ -3391,6 +3401,8 @@ function getTargettedBranchesConfirmationPromptMessage(pullRequest) {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+/** The default label for labeling pull requests containing a breaking change. */\n+var BreakingChangeLabel = 'breaking changes';\n /**\n  * Loads and validates the specified pull request against the given configuration.\n  * If the pull requests fails, a pull request failure is returned.\n@@ -3399,7 +3411,7 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n     var git = _a.git, config = _a.config;\n     if (ignoreNonFatalFailures === void 0) { ignoreNonFatalFailures = false; }\n     return tslib.__awaiter(this, void 0, void 0, function () {\n-        var prData, labels, targetLabel, commitMessages, state, githubTargetBranch, requiredBaseSha, needsCommitMessageFixup, hasCaretakerNote, targetBranches, error_1;\n+        var prData, labels, targetLabel, commitsInPr, state, githubTargetBranch, requiredBaseSha, needsCommitMessageFixup, hasCaretakerNote, targetBranches, error_1;\n         return tslib.__generator(this, function (_b) {\n             switch (_b.label) {\n                 case 0: return [4 /*yield*/, fetchPullRequestFromGithub(git, prNumber)];\n@@ -3424,9 +3436,10 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                         }\n                         throw error;\n                     }\n+                    commitsInPr = prData.commits.nodes.map(function (n) { return parseCommitMessage(n.commit.message); });\n                     try {\n-                        commitMessages = prData.commits.nodes.map(function (n) { return n.commit.message; });\n-                        assertChangesAllowForTargetLabel(commitMessages, targetLabel, config);\n+                        assertChangesAllowForTargetLabel(commitsInPr, targetLabel, config);\n+                        assertCorrectBreakingChangeLabeling(commitsInPr, labels, config);\n                     }\n                     catch (error) {\n                         return [2 /*return*/, error];\n@@ -3531,16 +3544,14 @@ function isPullRequest(v) {\n  * Assert the commits provided are allowed to merge to the provided target label, throwing a\n  * PullRequestFailure otherwise.\n  */\n-function assertChangesAllowForTargetLabel(rawCommits, label, config) {\n+function assertChangesAllowForTargetLabel(commits, label, config) {\n     /**\n      * List of commit scopes which are exempted from target label content requirements. i.e. no `feat`\n      * scopes in patch branches, no breaking changes in minor or patch changes.\n      */\n     var exemptedScopes = config.targetLabelExemptScopes || [];\n-    /** List of parsed commits which are subject to content requirements for the target label. */\n-    var commits = rawCommits.map(parseCommitMessage).filter(function (commit) {\n-        return !exemptedScopes.includes(commit.scope);\n-    });\n+    /** List of commits which are subject to content requirements for the target label. */\n+    commits = commits.filter(function (commit) { return !exemptedScopes.includes(commit.scope); });\n     switch (label.pattern) {\n         case 'target: major':\n             break;\n@@ -3567,6 +3578,22 @@ function assertChangesAllowForTargetLabel(rawCommits, label, config) {\n             break;\n     }\n }\n+/**\n+ * Assert the pull request has the proper label for breaking changes if there are breaking change\n+ * commits, and only has the label if there are breaking change commits.\n+ */\n+function assertCorrectBreakingChangeLabeling(commits, labels, config) {\n+    /** Whether the PR has a label noting a breaking change. */\n+    var hasLabel = labels.includes(config.breakingChangeLabel || BreakingChangeLabel);\n+    //** Whether the PR has at least one commit which notes a breaking change. */\n+    var hasCommit = commits.some(function (commit) { return commit.breakingChanges.length !== 0; });\n+    if (!hasLabel && hasCommit) {\n+        throw PullRequestFailure.missingBreakingChangeLabel();\n+    }\n+    if (hasLabel && !hasCommit) {\n+        throw PullRequestFailure.missingBreakingChangeCommit();\n+    }\n+}\n \n /**\n  * @license"
        },
        {
            "sha": "b34df2ed24b53ad8328c5d81e7d5ec5c710b5acf",
            "filename": "dev-infra/pr/merge/config.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "raw_url": "https://github.com/angular/angular/raw/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fconfig.ts?ref=4a69a7b95244a6d01143b6b8da11816c268c68da",
            "patch": "@@ -64,6 +64,8 @@ export interface MergeConfig {\n   caretakerNoteLabel?: string|RegExp;\n   /** Label which can be applied to fixup commit messages in the merge script. */\n   commitMessageFixupLabel: string|RegExp;\n+  /** Label that is applied when a breaking change is made in the pull request. */\n+  breakingChangeLabel?: string;\n   /**\n    * Whether pull requests should be merged using the Github API. This can be enabled\n    * if projects want to have their pull requests show up as `Merged` in the Github UI."
        },
        {
            "sha": "5675eb5ad03e9be984a07ec930ea3567f1394bd6",
            "filename": "dev-infra/pr/merge/failures.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "raw_url": "https://github.com/angular/angular/raw/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ffailures.ts?ref=4a69a7b95244a6d01143b6b8da11816c268c68da",
            "patch": "@@ -87,4 +87,16 @@ export class PullRequestFailure {\n         'or \"target: major\" label.';\n     return new this(message);\n   }\n+\n+  static missingBreakingChangeLabel() {\n+    const message = 'Pull Request has at least one commit containing a breaking change note, but ' +\n+        'does not have a breaking change label.';\n+    return new this(message);\n+  }\n+\n+  static missingBreakingChangeCommit() {\n+    const message = 'Pull Request has a breaking change label, but does not contain any commits ' +\n+        'with breaking change notes.';\n+    return new this(message);\n+  }\n }"
        },
        {
            "sha": "07988287b96cf8cac50ca7b8934226416f736a6d",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 9,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/4a69a7b95244a6d01143b6b8da11816c268c68da/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=4a69a7b95244a6d01143b6b8da11816c268c68da",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {params, types as graphQLTypes} from 'typed-graphqlify';\n-import {parseCommitMessage} from '../../commit-message/parse';\n+import {Commit, parseCommitMessage} from '../../commit-message/parse';\n import {red, warn} from '../../utils/console';\n \n import {GitClient} from '../../utils/git/index';\n@@ -19,6 +19,9 @@ import {matchesPattern} from './string-pattern';\n import {getBranchesFromTargetLabel, getTargetLabelFromPullRequest, InvalidTargetBranchError, InvalidTargetLabelError} from './target-label';\n import {PullRequestMergeTask} from './task';\n \n+/** The default label for labeling pull requests containing a breaking change. */\n+const BreakingChangeLabel = 'breaking changes';\n+\n /** Interface that describes a pull request. */\n export interface PullRequest {\n   /** URL to the pull request. */\n@@ -75,10 +78,12 @@ export async function loadAndValidatePullRequest(\n     throw error;\n   }\n \n+  /** List of parsed commits for all of the commits in the pull request. */\n+  const commitsInPr = prData.commits.nodes.map(n => parseCommitMessage(n.commit.message));\n+\n   try {\n-    /** Commit message strings for all commits in the pull request. */\n-    const commitMessages = prData.commits.nodes.map(n => n.commit.message);\n-    assertChangesAllowForTargetLabel(commitMessages, targetLabel, config);\n+    assertChangesAllowForTargetLabel(commitsInPr, targetLabel, config);\n+    assertCorrectBreakingChangeLabeling(commitsInPr, labels, config);\n   } catch (error) {\n     return error;\n   }\n@@ -182,16 +187,14 @@ export function isPullRequest(v: PullRequestFailure|PullRequest): v is PullReque\n  * PullRequestFailure otherwise.\n  */\n function assertChangesAllowForTargetLabel(\n-    rawCommits: string[], label: TargetLabel, config: MergeConfig) {\n+    commits: Commit[], label: TargetLabel, config: MergeConfig) {\n   /**\n    * List of commit scopes which are exempted from target label content requirements. i.e. no `feat`\n    * scopes in patch branches, no breaking changes in minor or patch changes.\n    */\n   const exemptedScopes = config.targetLabelExemptScopes || [];\n-  /** List of parsed commits which are subject to content requirements for the target label. */\n-  let commits = rawCommits.map(parseCommitMessage).filter(commit => {\n-    return !exemptedScopes.includes(commit.scope);\n-  });\n+  /** List of commits which are subject to content requirements for the target label. */\n+  commits = commits.filter(commit => !exemptedScopes.includes(commit.scope));\n   switch (label.pattern) {\n     case 'target: major':\n       break;\n@@ -218,3 +221,23 @@ function assertChangesAllowForTargetLabel(\n       break;\n   }\n }\n+\n+/**\n+ * Assert the pull request has the proper label for breaking changes if there are breaking change\n+ * commits, and only has the label if there are breaking change commits.\n+ */\n+function assertCorrectBreakingChangeLabeling(\n+    commits: Commit[], labels: string[], config: MergeConfig) {\n+  /** Whether the PR has a label noting a breaking change. */\n+  const hasLabel = labels.includes(config.breakingChangeLabel || BreakingChangeLabel);\n+  //** Whether the PR has at least one commit which notes a breaking change. */\n+  const hasCommit = commits.some(commit => commit.breakingChanges.length !== 0);\n+\n+  if (!hasLabel && hasCommit) {\n+    throw PullRequestFailure.missingBreakingChangeLabel();\n+  }\n+\n+  if (hasLabel && !hasCommit) {\n+    throw PullRequestFailure.missingBreakingChangeCommit();\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 81,
        "deletions": 17
    }
}