{
    "author": "crisbeto",
    "message": "feat(localize): add scripts to migrate away from legacy message IDs (#41026)\n\nAdds a new flag to `localize-extract` called `--migrateMapFile` which will generate a JSON file\nthat can be used to map legacy message IDs to cannonical ones.\n\nAlso includes a new script called `localize-migrate` that can take the mapping file which was\ngenerated by `localize-extract` and migrate all of the IDs in the files that were passed in.\n\nPR Close #41026",
    "sha": "17354304768f3c2b272c4c5d5636b5709287276f",
    "files": [
        {
            "sha": "ed947cb3355ba01cc1f2648a07fb5339e2bb6db9",
            "filename": "packages/localize/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fpackage.json?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -4,7 +4,8 @@\n   \"description\": \"Angular - library for localizing messages\",\n   \"bin\": {\n     \"localize-translate\": \"./src/tools/src/translate/main.js\",\n-    \"localize-extract\": \"./src/tools/src/extract/main.js\"\n+    \"localize-extract\": \"./src/tools/src/extract/main.js\",\n+    \"localize-migrate\": \"./src/tools/src/migrate/main.js\"\n   },\n   \"author\": \"angular\",\n   \"license\": \"MIT\","
        },
        {
            "sha": "ee1bd2d1cd142fe3a08ca24990064e3c15117cfd",
            "filename": "packages/localize/src/tools/src/extract/main.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 9,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -12,7 +12,7 @@ import {ɵParsedMessage} from '@angular/localize';\n import * as glob from 'glob';\n import * as yargs from 'yargs';\n \n-import {DiagnosticHandlingStrategy} from '../diagnostics';\n+import {Diagnostics, DiagnosticHandlingStrategy} from '../diagnostics';\n \n import {checkDuplicateMessages} from './duplicates';\n import {MessageExtractor} from './extraction';\n@@ -23,6 +23,7 @@ import {Xliff1TranslationSerializer} from './translation_files/xliff1_translatio\n import {Xliff2TranslationSerializer} from './translation_files/xliff2_translation_serializer';\n import {XmbTranslationSerializer} from './translation_files/xmb_translation_serializer';\n import {FormatOptions, parseFormatOptions} from './translation_files/format_options';\n+import {LegacyMessageIdMigrationSerializer} from './translation_files/legacy_message_id_migration_serializer';\n \n if (require.main === module) {\n   process.title = 'Angular Localization Message Extractor (localize-extract)';\n@@ -53,7 +54,9 @@ if (require.main === module) {\n           .option('f', {\n             alias: 'format',\n             required: true,\n-            choices: ['xmb', 'xlf', 'xlif', 'xliff', 'xlf2', 'xlif2', 'xliff2', 'json'],\n+            choices: [\n+              'xmb', 'xlf', 'xlif', 'xliff', 'xlf2', 'xlif2', 'xliff2', 'json', 'legacy-migrate'\n+            ],\n             describe: 'The format of the translation file.',\n             type: 'string',\n           })\n@@ -108,17 +111,17 @@ if (require.main === module) {\n   const logger = new ConsoleLogger(logLevel ? LogLevel[logLevel] : LogLevel.warn);\n   const duplicateMessageHandling = options.d as DiagnosticHandlingStrategy;\n   const formatOptions = parseFormatOptions(options.formatOptions);\n-\n+  const format = options.f;\n \n   extractTranslations({\n     rootPath,\n     sourceFilePaths,\n     sourceLocale: options.l,\n-    format: options.f,\n+    format,\n     outputPath: options.o,\n     logger,\n     useSourceMaps: options.useSourceMaps,\n-    useLegacyIds: options.useLegacyIds,\n+    useLegacyIds: format === 'legacy-migrate' || options.useLegacyIds,\n     duplicateMessageHandling,\n     formatOptions,\n     fileSystem,\n@@ -202,8 +205,8 @@ export function extractTranslations({\n   }\n \n   const outputPath = fs.resolve(rootPath, output);\n-  const serializer =\n-      getSerializer(format, sourceLocale, fs.dirname(outputPath), useLegacyIds, formatOptions, fs);\n+  const serializer = getSerializer(\n+      format, sourceLocale, fs.dirname(outputPath), useLegacyIds, formatOptions, fs, diagnostics);\n   const translationFile = serializer.serialize(messages);\n   fs.ensureDir(fs.dirname(outputPath));\n   fs.writeFile(outputPath, translationFile);\n@@ -213,9 +216,10 @@ export function extractTranslations({\n   }\n }\n \n-export function getSerializer(\n+function getSerializer(\n     format: string, sourceLocale: string, rootPath: AbsoluteFsPath, useLegacyIds: boolean,\n-    formatOptions: FormatOptions = {}, fs: PathManipulation): TranslationSerializer {\n+    formatOptions: FormatOptions = {}, fs: PathManipulation,\n+    diagnostics: Diagnostics): TranslationSerializer {\n   switch (format) {\n     case 'xlf':\n     case 'xlif':\n@@ -233,6 +237,8 @@ export function getSerializer(\n       return new SimpleJsonTranslationSerializer(sourceLocale);\n     case 'arb':\n       return new ArbTranslationSerializer(sourceLocale, rootPath, fs);\n+    case 'legacy-migrate':\n+      return new LegacyMessageIdMigrationSerializer(diagnostics);\n   }\n   throw new Error(`No translation serializer can handle the provided format: ${format}`);\n }"
        },
        {
            "sha": "601cba08ce0a4c1208e3af57f338e1234fc4fc8e",
            "filename": "packages/localize/src/tools/src/extract/translation_files/legacy_message_id_migration_serializer.ts",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Flegacy_message_id_migration_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Flegacy_message_id_migration_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Flegacy_message_id_migration_serializer.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,50 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {ɵParsedMessage as ParsedMessage} from '@angular/localize';\n+import {Diagnostics} from '../../diagnostics';\n+import {TranslationSerializer} from './translation_serializer';\n+\n+\n+/**\n+ * A translation serializer that generates the mapping file for the legacy message ID migration.\n+ * The file is used by the `localize-migrate` script to migrate existing translation files from\n+ * the legacy message IDs to the canonical ones.\n+ */\n+export class LegacyMessageIdMigrationSerializer implements TranslationSerializer {\n+  constructor(private _diagnostics: Diagnostics) {}\n+\n+  serialize(messages: ParsedMessage[]): string {\n+    let hasMessages = false;\n+    const mapping = messages.reduce((output, message) => {\n+      if (shouldMigrate(message)) {\n+        for (const legacyId of message.legacyIds!) {\n+          if (output.hasOwnProperty(legacyId)) {\n+            this._diagnostics.warn(`Detected duplicate legacy ID ${legacyId}.`);\n+          }\n+\n+          output[legacyId] = message.id;\n+          hasMessages = true;\n+        }\n+      }\n+      return output;\n+    }, {} as Record<string, string>);\n+\n+    if (!hasMessages) {\n+      this._diagnostics.warn(\n+          'Could not find any legacy message IDs in source files while generating ' +\n+          'the legacy message migration file.');\n+    }\n+\n+    return JSON.stringify(mapping, null, 2);\n+  }\n+}\n+\n+/** Returns true if a message needs to be migrated. */\n+function shouldMigrate(message: ParsedMessage): boolean {\n+  return !message.customId && !!message.legacyIds && message.legacyIds.length > 0;\n+}"
        },
        {
            "sha": "266131ce60dc9ba443677398de2bc8a1ac59a3eb",
            "filename": "packages/localize/src/tools/src/migrate/main.ts",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fmigrate%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fmigrate%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fmigrate%2Fmain.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,94 @@\n+#!/usr/bin/env node\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {getFileSystem, NodeJSFileSystem, setFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {ConsoleLogger, Logger, LogLevel} from '@angular/compiler-cli/src/ngtsc/logging';\n+import * as glob from 'glob';\n+import * as yargs from 'yargs';\n+import {migrateFile, MigrationMapping} from './migrate';\n+\n+if (require.main === module) {\n+  const args = process.argv.slice(2);\n+  const options =\n+      yargs\n+          .option('r', {\n+            alias: 'root',\n+            default: '.',\n+            describe: 'The root path for other paths provided in these options.\\n' +\n+                'This should either be absolute or relative to the current working directory.',\n+            type: 'string',\n+          })\n+          .option('f', {\n+            alias: 'files',\n+            required: true,\n+            describe:\n+                'A glob pattern indicating what files to migrate. This should be relative to the root path',\n+            type: 'string',\n+          })\n+          .option('m', {\n+            alias: 'mapFile',\n+            required: true,\n+            describe:\n+                'Path to the migration mapping file generated by `localize-extract`. This should be relative to the root path.',\n+            type: 'string',\n+          })\n+          .strict()\n+          .help()\n+          .parse(args);\n+\n+  const fs = new NodeJSFileSystem();\n+  setFileSystem(fs);\n+\n+  const rootPath = options.r;\n+  const translationFilePaths = glob.sync(options.f, {cwd: rootPath, nodir: true});\n+  const logger = new ConsoleLogger(LogLevel.warn);\n+\n+  migrateFiles({rootPath, translationFilePaths, mappingFilePath: options.m, logger});\n+  process.exit(0);\n+}\n+\n+export interface MigrateFilesOptions {\n+  /**\n+   * The base path for other paths provided in these options.\n+   * This should either be absolute or relative to the current working directory.\n+   */\n+  rootPath: string;\n+\n+  /** Paths to the files that should be migrated. Should be relative to the `rootPath`. */\n+  translationFilePaths: string[];\n+\n+  /** Path to the file containing the message ID mappings. Should be relative to the `rootPath`. */\n+  mappingFilePath: string;\n+\n+  /** Logger to use for diagnostic messages. */\n+  logger: Logger;\n+}\n+\n+/** Migrates the legacy message IDs based on the passed in configuration. */\n+export function migrateFiles({\n+  rootPath,\n+  translationFilePaths,\n+  mappingFilePath,\n+  logger,\n+}: MigrateFilesOptions) {\n+  const fs = getFileSystem();\n+  const absoluteMappingPath = fs.resolve(rootPath, mappingFilePath);\n+  const mapping = JSON.parse(fs.readFile(absoluteMappingPath)) as MigrationMapping;\n+\n+  if (Object.keys(mapping).length === 0) {\n+    logger.warn(\n+        `Mapping file at ${absoluteMappingPath} is empty. Either there are no messages ` +\n+        `that need to be migrated, or the extraction step failed to find them.`);\n+  } else {\n+    translationFilePaths.forEach(path => {\n+      const absolutePath = fs.resolve(rootPath, path);\n+      const sourceCode = fs.readFile(absolutePath);\n+      fs.writeFile(absolutePath, migrateFile(sourceCode, mapping));\n+    });\n+  }\n+}"
        },
        {
            "sha": "4cf269f390e4698634f8ca3a2a609b196059df62",
            "filename": "packages/localize/src/tools/src/migrate/migrate.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fmigrate%2Fmigrate.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fmigrate%2Fmigrate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fmigrate%2Fmigrate.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,30 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/** Mapping between legacy message IDs and their cannonical counterparts. */\n+export type MigrationMapping = {\n+  [legacyId: string]: string;\n+};\n+\n+/** Migrates the legacy message IDs within a single file. */\n+export function migrateFile(sourceCode: string, mapping: MigrationMapping) {\n+  const legacyIds = Object.keys(mapping);\n+\n+  for (const legacyId of legacyIds) {\n+    const cannonicalId = mapping[legacyId];\n+    const pattern = new RegExp(escapeRegExp(legacyId), 'g');\n+    sourceCode = sourceCode.replace(pattern, cannonicalId);\n+  }\n+\n+  return sourceCode;\n+}\n+\n+/** Escapes special regex characters in a string. */\n+function escapeRegExp(str: string): string {\n+  return str.replace(/([.*+?^=!:${}()|[\\]\\/\\\\])/g, '\\\\$1');\n+}"
        },
        {
            "sha": "00b84e43a23939ffcc9ba0a6c28e380fb14ffe74",
            "filename": "packages/localize/src/tools/test/extract/integration/main_spec.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -494,6 +494,49 @@ runInNativeFileSystem(() => {\n           `}`,\n         ].join('\\n'));\n       });\n+\n+      it('should generate the migration map file, if requested', () => {\n+        extractTranslations({\n+          rootPath,\n+          sourceLocale: 'en',\n+          sourceFilePaths: [sourceFilePath],\n+          format: 'legacy-migrate',\n+          outputPath,\n+          logger,\n+          useSourceMaps: false,\n+          useLegacyIds: true,\n+          duplicateMessageHandling: 'ignore',\n+          fileSystem: fs\n+        });\n+        expect(fs.readFile(outputPath)).toEqual([\n+          `{`,\n+          `  \"1234567890123456789012345678901234567890\": \"273296103957933077\",`,\n+          `  \"12345678901234567890\": \"273296103957933077\"`,\n+          `}`,\n+        ].join('\\n'));\n+      });\n+\n+      it('should log a warning if there are no legacy message IDs to migrate', () => {\n+        extractTranslations({\n+          rootPath,\n+          sourceLocale: 'en',\n+          sourceFilePaths: [textFile1],\n+          format: 'legacy-migrate',\n+          outputPath,\n+          logger,\n+          useSourceMaps: false,\n+          useLegacyIds: true,\n+          duplicateMessageHandling: 'ignore',\n+          fileSystem: fs\n+        });\n+\n+        expect(fs.readFile(outputPath)).toBe('{}');\n+        expect(logger.logs.warn).toEqual([[\n+          'Messages extracted with warnings\\n' +\n+          'WARNINGS:\\n' +\n+          ' - Could not find any legacy message IDs in source files while generating the legacy message migration file.'\n+        ]]);\n+      });\n     });\n   });\n });"
        },
        {
            "sha": "3c284d9a98aaf65abee1f24ff39d659885f729af",
            "filename": "packages/localize/src/tools/test/extract/translation_files/legacy_message_id_migration_serializer_spec.ts",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Flegacy_message_id_migration_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Flegacy_message_id_migration_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Flegacy_message_id_migration_serializer_spec.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,79 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {ɵParsedMessage} from '@angular/localize';\n+import {Diagnostics} from '../../../src/diagnostics';\n+import {LegacyMessageIdMigrationSerializer} from '../../../src/extract/translation_files/legacy_message_id_migration_serializer';\n+import {mockMessage} from './mock_message';\n+\n+// Doesn't need to run in each file system since it doesn't interact with the file system.\n+\n+describe('LegacyMessageIdMigrationSerializer', () => {\n+  let serializer: LegacyMessageIdMigrationSerializer;\n+\n+  beforeEach(() => {\n+    serializer = new LegacyMessageIdMigrationSerializer(new Diagnostics());\n+  });\n+\n+  it('should convert a set of parsed messages into a migration mapping file', () => {\n+    const messages: ɵParsedMessage[] = [\n+      mockMessage('one', [], [], {legacyIds: ['legacy-one', 'other-legacy-one']}),\n+      mockMessage('two', [], [], {legacyIds: ['legacy-two']}),\n+      mockMessage('three', [], [], {legacyIds: ['legacy-three', 'other-legacy-three']}),\n+    ];\n+    const output = serializer.serialize(messages);\n+    expect(output.split('\\n')).toEqual([\n+      '{',\n+      '  \"legacy-one\": \"one\",',\n+      '  \"other-legacy-one\": \"one\",',\n+      '  \"legacy-two\": \"two\",',\n+      '  \"legacy-three\": \"three\",',\n+      '  \"other-legacy-three\": \"three\"',\n+      '}',\n+    ]);\n+  });\n+\n+  it('should not include messages that have a custom ID', () => {\n+    const messages: ɵParsedMessage[] = [\n+      mockMessage('one', [], [], {legacyIds: ['legacy-one']}),\n+      mockMessage('two', [], [], {legacyIds: ['legacy-two'], customId: 'custom-two'}),\n+      mockMessage('three', [], [], {legacyIds: ['legacy-three']}),\n+    ];\n+    const output = serializer.serialize(messages);\n+    expect(output.split('\\n')).toEqual([\n+      '{',\n+      '  \"legacy-one\": \"one\",',\n+      '  \"legacy-three\": \"three\"',\n+      '}',\n+    ]);\n+  });\n+\n+  it('should not include messages that do not have legacy IDs', () => {\n+    const messages: ɵParsedMessage[] = [\n+      mockMessage('one', [], [], {legacyIds: ['legacy-one']}),\n+      mockMessage('two', [], [], {}),\n+      mockMessage('three', [], [], {legacyIds: ['legacy-three']}),\n+    ];\n+    const output = serializer.serialize(messages);\n+    expect(output.split('\\n')).toEqual([\n+      '{',\n+      '  \"legacy-one\": \"one\",',\n+      '  \"legacy-three\": \"three\"',\n+      '}',\n+    ]);\n+  });\n+\n+  it('should produce an empty file if none of the messages need to be migrated', () => {\n+    const messages: ɵParsedMessage[] = [\n+      mockMessage('one', [], [], {legacyIds: ['legacy-one'], customId: 'custom-one'}),\n+      mockMessage('two', [], [], {}),\n+      mockMessage('three', [], [], {legacyIds: []}),\n+    ];\n+    const output = serializer.serialize(messages);\n+    expect(output).toBe('{}');\n+  });\n+});"
        },
        {
            "sha": "1b3e056fecacd26f305ad71ee8c6091495e33d68",
            "filename": "packages/localize/src/tools/test/migrate/integration/BUILD.bazel",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2FBUILD.bazel?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,40 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+load(\"@build_bazel_rules_nodejs//:index.bzl\", \"copy_to_bin\")\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = glob(\n+        [\"**/*_spec.ts\"],\n+    ),\n+    deps = [\n+        \"//packages:types\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/logging\",\n+        \"//packages/compiler-cli/src/ngtsc/logging/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"//packages/localize/src/tools\",\n+        \"//packages/localize/src/tools/test:test_lib\",\n+        \"//packages/localize/src/tools/test/helpers\",\n+    ],\n+)\n+\n+# Use copy_to_bin since filegroup doesn't seem to work on Windows.\n+copy_to_bin(\n+    name = \"test_files\",\n+    srcs = glob([\"test_files/**/*\"]),\n+)\n+\n+jasmine_node_test(\n+    name = \"integration\",\n+    bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n+    data = [\n+        \":test_files\",\n+    ],\n+    deps = [\n+        \":test_lib\",\n+        \"@npm//glob\",\n+        \"@npm//yargs\",\n+    ],\n+)"
        },
        {
            "sha": "9972cd4df92ff3c4e35d080c43e295aef4335a5e",
            "filename": "packages/localize/src/tools/test/migrate/integration/main_spec.ts",
            "status": "added",
            "additions": 196,
            "deletions": 0,
            "changes": 196,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Fmain_spec.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,196 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {MockLogger} from '@angular/compiler-cli/src/ngtsc/logging/testing';\n+import {loadTestDirectory} from '@angular/compiler-cli/src/ngtsc/testing';\n+import {migrateFiles} from '../../../src/migrate/main';\n+import {runInNativeFileSystem} from '../../helpers';\n+\n+runInNativeFileSystem(() => {\n+  let fs: FileSystem;\n+  let logger: MockLogger;\n+  let rootPath: AbsoluteFsPath;\n+  let mappingFilePath: AbsoluteFsPath;\n+\n+  beforeEach(() => {\n+    fs = getFileSystem();\n+    logger = new MockLogger();\n+    rootPath = absoluteFrom('/project');\n+    mappingFilePath = fs.resolve(rootPath, 'test_files/mapping.json');\n+\n+    loadTestDirectory(fs, __dirname + '/test_files', absoluteFrom('/project/test_files'));\n+  });\n+\n+  describe('migrateFiles()', () => {\n+    it('should log a warning if the migration file is empty', () => {\n+      const emptyMappingPath = fs.resolve(rootPath, 'test_files/empty-mapping.json');\n+      migrateFiles({\n+        rootPath,\n+        translationFilePaths: ['test_files/messages.json'],\n+        logger,\n+        mappingFilePath: emptyMappingPath,\n+      });\n+\n+      expect(logger.logs.warn).toEqual([\n+        [`Mapping file at ${emptyMappingPath} is empty. Either there are no messages ` +\n+         `that need to be migrated, or the extraction step failed to find them.`]\n+      ]);\n+    });\n+\n+    it('should migrate a json message file', () => {\n+      const filePath = 'test_files/messages.json';\n+      migrateFiles({\n+        rootPath,\n+        translationFilePaths: [filePath],\n+        logger,\n+        mappingFilePath,\n+      });\n+\n+      expect(readAndNormalize(fs.resolve(rootPath, filePath))).toEqual([\n+        `{`,\n+        `  \"locale\": \"en-GB\",`,\n+        `  \"translations\": {`,\n+        `    \"9876543\": \"Hello\",`,\n+        `    \"custom-id\": \"Custom id message\",`,\n+        `    \"987654321098765\": \"Goodbye\"`,\n+        `  }`,\n+        `}`,\n+      ].join('\\n'));\n+    });\n+\n+    it('should migrate an arb message file', () => {\n+      const filePath = 'test_files/messages.arb';\n+      migrateFiles({\n+        rootPath,\n+        translationFilePaths: [filePath],\n+        logger,\n+        mappingFilePath,\n+      });\n+      expect(readAndNormalize(fs.resolve(rootPath, filePath))).toEqual([\n+        `{`,\n+        `  \"@@locale\": \"en-GB\",`,\n+        `  \"9876543\": \"Hello\",`,\n+        `  \"@9876543\": {`,\n+        `    \"x-locations\": [`,\n+        `      {`,\n+        `        \"file\": \"test.js\",`,\n+        `        \"start\": { \"line\": \"1\", \"column\": \"0\" },`,\n+        `        \"end\": { \"line\": \"1\", \"column\": \"0\" }`,\n+        `      }`,\n+        `    ]`,\n+        `  },`,\n+        `  \"custom-id\": \"Custom id message\",`,\n+        `  \"@custom-id\": {`,\n+        `    \"x-locations\": [`,\n+        `      {`,\n+        `        \"file\": \"test.js\",`,\n+        `        \"start\": { \"line\": \"2\", \"column\": \"0\" },`,\n+        `        \"end\": { \"line\": \"2\", \"column\": \"0\" }`,\n+        `      }`,\n+        `    ]`,\n+        `  },`,\n+        `  \"987654321098765\": \"Goodbye\",`,\n+        `  \"@987654321098765\": {`,\n+        `    \"x-locations\": [`,\n+        `      {`,\n+        `        \"file\": \"test.js\",`,\n+        `        \"start\": { \"line\": \"3\", \"column\": \"0\" },`,\n+        `        \"end\": { \"line\": \"3\", \"column\": \"0\" }`,\n+        `      }`,\n+        `    ]`,\n+        `  }`,\n+        `}`,\n+      ].join('\\n'));\n+    });\n+\n+    it('should migrate an xmb message file', () => {\n+      const filePath = 'test_files/messages.xmb';\n+      migrateFiles({\n+        rootPath,\n+        translationFilePaths: [filePath],\n+        logger,\n+        mappingFilePath,\n+      });\n+      expect(readAndNormalize(fs.resolve(rootPath, filePath))).toEqual([\n+        `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+        `<!DOCTYPE messagebundle [`,\n+        `<!ELEMENT messagebundle (msg)*>`,\n+        `<!ATTLIST messagebundle class CDATA #IMPLIED>`,\n+        ``,\n+        `<!ELEMENT msg (#PCDATA|ph|source)*>`,\n+        `<!ATTLIST msg id CDATA #IMPLIED>`,\n+        `<!ATTLIST msg seq CDATA #IMPLIED>`,\n+        `<!ATTLIST msg name CDATA #IMPLIED>`,\n+        `<!ATTLIST msg desc CDATA #IMPLIED>`,\n+        `<!ATTLIST msg meaning CDATA #IMPLIED>`,\n+        `<!ATTLIST msg obsolete (obsolete) #IMPLIED>`,\n+        `<!ATTLIST msg xml:space (default|preserve) \"default\">`,\n+        `<!ATTLIST msg is_hidden CDATA #IMPLIED>`,\n+        ``,\n+        `<!ELEMENT source (#PCDATA)>`,\n+        ``,\n+        `<!ELEMENT ph (#PCDATA|ex)*>`,\n+        `<!ATTLIST ph name CDATA #REQUIRED>`,\n+        ``,\n+        `<!ELEMENT ex (#PCDATA)>`,\n+        `]>`,\n+        `<messagebundle>`,\n+        `  <msg id=\"9876543\"><source>test.js:1</source>Hello</msg>`,\n+        `  <msg id=\"custom-id\"><source>test.js:2</source>Custom id message</msg>`,\n+        `  <msg id=\"987654321098765\"><source>test.js:3</source>Goodbye</msg>`,\n+        `</messagebundle>`,\n+      ].join('\\n'));\n+    });\n+\n+    it('should migrate an xlf message file', () => {\n+      const filePath = 'test_files/messages.xlf';\n+      migrateFiles({\n+        rootPath,\n+        translationFilePaths: [filePath],\n+        logger,\n+        mappingFilePath,\n+      });\n+      expect(readAndNormalize(fs.resolve(rootPath, filePath))).toEqual([\n+        `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+        `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en-GB\">`,\n+        `  <file id=\"ngi18n\" original=\"ng.template\" xml:space=\"preserve\">`,\n+        `    <unit id=\"9876543\">`,\n+        `      <notes>`,\n+        `        <note category=\"location\">test.js:1</note>`,\n+        `      </notes>`,\n+        `      <segment>`,\n+        `        <source>Hello</source>`,\n+        `      </segment>`,\n+        `    </unit>`,\n+        `    <unit id=\"custom-id\">`,\n+        `      <notes>`,\n+        `        <note category=\"location\">test.js:2</note>`,\n+        `      </notes>`,\n+        `      <segment>`,\n+        `        <source>Custom id message</source>`,\n+        `      </segment>`,\n+        `    </unit>`,\n+        `    <unit id=\"987654321098765\">`,\n+        `      <notes>`,\n+        `        <note category=\"location\">test.js:3</note>`,\n+        `      </notes>`,\n+        `      <segment>`,\n+        `        <source>Goodbye</source>`,\n+        `      </segment>`,\n+        `    </unit>`,\n+        `  </file>`,\n+        `</xliff>`,\n+      ].join('\\n'));\n+    });\n+\n+    /** Reads a path from the file system and normalizes the line endings. */\n+    function readAndNormalize(path: AbsoluteFsPath): string {\n+      return fs.readFile(path).replace(/\\r?\\n/g, '\\n');\n+    }\n+  });\n+});"
        },
        {
            "sha": "9e26dfeeb6e641a33dae4961196235bdb965b21b",
            "filename": "packages/localize/src/tools/test/migrate/integration/test_files/empty-mapping.json",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fempty-mapping.json",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fempty-mapping.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fempty-mapping.json?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1 @@\n+{}\n\\ No newline at end of file"
        },
        {
            "sha": "4676f978815c5a07b9275da8d0f6148668051f9b",
            "filename": "packages/localize/src/tools/test/migrate/integration/test_files/mapping.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmapping.json",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmapping.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmapping.json?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,4 @@\n+{\n+  \"1234567890123456789012345678901234567890\": \"987654321098765\",\n+  \"12345678901234567890\": \"9876543\"\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "7eb93a730f7ee56026b28978703b702856530a5f",
            "filename": "packages/localize/src/tools/test/migrate/integration/test_files/messages.arb",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.arb",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.arb",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.arb?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,33 @@\n+{\n+  \"@@locale\": \"en-GB\",\n+  \"12345678901234567890\": \"Hello\",\n+  \"@12345678901234567890\": {\n+    \"x-locations\": [\n+      {\n+        \"file\": \"test.js\",\n+        \"start\": { \"line\": \"1\", \"column\": \"0\" },\n+        \"end\": { \"line\": \"1\", \"column\": \"0\" }\n+      }\n+    ]\n+  },\n+  \"custom-id\": \"Custom id message\",\n+  \"@custom-id\": {\n+    \"x-locations\": [\n+      {\n+        \"file\": \"test.js\",\n+        \"start\": { \"line\": \"2\", \"column\": \"0\" },\n+        \"end\": { \"line\": \"2\", \"column\": \"0\" }\n+      }\n+    ]\n+  },\n+  \"1234567890123456789012345678901234567890\": \"Goodbye\",\n+  \"@1234567890123456789012345678901234567890\": {\n+    \"x-locations\": [\n+      {\n+        \"file\": \"test.js\",\n+        \"start\": { \"line\": \"3\", \"column\": \"0\" },\n+        \"end\": { \"line\": \"3\", \"column\": \"0\" }\n+      }\n+    ]\n+  }\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "deaaf2030ff13cf8f1efbc7119cbfeafebfe7107",
            "filename": "packages/localize/src/tools/test/migrate/integration/test_files/messages.json",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.json",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.json?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,8 @@\n+{\n+  \"locale\": \"en-GB\",\n+  \"translations\": {\n+    \"12345678901234567890\": \"Hello\",\n+    \"custom-id\": \"Custom id message\",\n+    \"1234567890123456789012345678901234567890\": \"Goodbye\"\n+  }\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "c0afe96041026068f111fdc861048b5d4851155b",
            "filename": "packages/localize/src/tools/test/migrate/integration/test_files/messages.xlf",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.xlf",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.xlf",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.xlf?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,29 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en-GB\">\n+  <file id=\"ngi18n\" original=\"ng.template\" xml:space=\"preserve\">\n+    <unit id=\"12345678901234567890\">\n+      <notes>\n+        <note category=\"location\">test.js:1</note>\n+      </notes>\n+      <segment>\n+        <source>Hello</source>\n+      </segment>\n+    </unit>\n+    <unit id=\"custom-id\">\n+      <notes>\n+        <note category=\"location\">test.js:2</note>\n+      </notes>\n+      <segment>\n+        <source>Custom id message</source>\n+      </segment>\n+    </unit>\n+    <unit id=\"1234567890123456789012345678901234567890\">\n+      <notes>\n+        <note category=\"location\">test.js:3</note>\n+      </notes>\n+      <segment>\n+        <source>Goodbye</source>\n+      </segment>\n+    </unit>\n+  </file>\n+</xliff>\n\\ No newline at end of file"
        },
        {
            "sha": "87bc4cace0d58068d02efdb099d633920fa6676c",
            "filename": "packages/localize/src/tools/test/migrate/integration/test_files/messages.xmb",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.xmb",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.xmb",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fintegration%2Ftest_files%2Fmessages.xmb?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,27 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n+<!DOCTYPE messagebundle [\n+<!ELEMENT messagebundle (msg)*>\n+<!ATTLIST messagebundle class CDATA #IMPLIED>\n+\n+<!ELEMENT msg (#PCDATA|ph|source)*>\n+<!ATTLIST msg id CDATA #IMPLIED>\n+<!ATTLIST msg seq CDATA #IMPLIED>\n+<!ATTLIST msg name CDATA #IMPLIED>\n+<!ATTLIST msg desc CDATA #IMPLIED>\n+<!ATTLIST msg meaning CDATA #IMPLIED>\n+<!ATTLIST msg obsolete (obsolete) #IMPLIED>\n+<!ATTLIST msg xml:space (default|preserve) \"default\">\n+<!ATTLIST msg is_hidden CDATA #IMPLIED>\n+\n+<!ELEMENT source (#PCDATA)>\n+\n+<!ELEMENT ph (#PCDATA|ex)*>\n+<!ATTLIST ph name CDATA #REQUIRED>\n+\n+<!ELEMENT ex (#PCDATA)>\n+]>\n+<messagebundle>\n+  <msg id=\"12345678901234567890\"><source>test.js:1</source>Hello</msg>\n+  <msg id=\"custom-id\"><source>test.js:2</source>Custom id message</msg>\n+  <msg id=\"1234567890123456789012345678901234567890\"><source>test.js:3</source>Goodbye</msg>\n+</messagebundle>\n\\ No newline at end of file"
        },
        {
            "sha": "46f55fda2aa2599196c81f12cfb44f5fa855b351",
            "filename": "packages/localize/src/tools/test/migrate/migrate_spec.ts",
            "status": "added",
            "additions": 136,
            "deletions": 0,
            "changes": 136,
            "blob_url": "https://github.com/angular/angular/blob/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fmigrate_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/17354304768f3c2b272c4c5d5636b5709287276f/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fmigrate_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fmigrate%2Fmigrate_spec.ts?ref=17354304768f3c2b272c4c5d5636b5709287276f",
            "patch": "@@ -0,0 +1,136 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {migrateFile} from '../../src/migrate/migrate';\n+\n+describe('migrateFile', () => {\n+  it('should migrate all of the legacy message IDs', () => {\n+    const source = `\n+      <xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">\n+        <file source-language=\"fr-FR\" datatype=\"plaintext\" original=\"ng2.template\">\n+          <body>\n+            <trans-unit id=\"123hello-legacy\" datatype=\"html\">\n+              <source>Hello</source>\n+              <target>Bonjour</target>\n+            </trans-unit>\n+\n+            <trans-unit id=\"456goodbye-legacy\" datatype=\"html\">\n+              <source>Goodbye</source>\n+              <target>Au revoir</target>\n+            </trans-unit>\n+          </body>\n+        </file>\n+      </xliff>\n+    `;\n+\n+    const result = migrateFile(source, {\n+      '123hello-legacy': 'hello-migrated',\n+      '456goodbye-legacy': 'goodbye-migrated',\n+    });\n+\n+    expect(result).toContain('<trans-unit id=\"hello-migrated\" datatype=\"html\">');\n+    expect(result).toContain('<trans-unit id=\"goodbye-migrated\" datatype=\"html\">');\n+  });\n+\n+  it('should migrate messages whose ID contains special regex characters', () => {\n+    const source = `\n+      <xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">\n+        <file source-language=\"fr-FR\" datatype=\"plaintext\" original=\"ng2.template\">\n+          <body>\n+            <trans-unit id=\"123hello(.*legacy\" datatype=\"html\">\n+              <source>Hello</source>\n+              <target>Bonjour</target>\n+            </trans-unit>\n+          </body>\n+        </file>\n+      </xliff>\n+    `;\n+\n+    const result = migrateFile(source, {'123hello(.*legacy': 'hello-migrated'});\n+    expect(result).toContain('<trans-unit id=\"hello-migrated\" datatype=\"html\">');\n+  });\n+\n+  it('should not migrate messages that are not in the mapping', () => {\n+    const source = `\n+      <xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">\n+        <file source-language=\"fr-FR\" datatype=\"plaintext\" original=\"ng2.template\">\n+          <body>\n+            <trans-unit id=\"123hello-legacy\" datatype=\"html\">\n+              <source>Hello</source>\n+              <target>Bonjour</target>\n+            </trans-unit>\n+\n+            <trans-unit id=\"456goodbye\" datatype=\"html\">\n+              <source>Goodbye</source>\n+              <target>Au revoir</target>\n+            </trans-unit>\n+          </body>\n+        </file>\n+      </xliff>\n+    `;\n+\n+    const result = migrateFile(source, {'123hello-legacy': 'hello-migrated'});\n+    expect(result).toContain('<trans-unit id=\"hello-migrated\" datatype=\"html\">');\n+    expect(result).toContain('<trans-unit id=\"456goodbye\" datatype=\"html\">');\n+  });\n+\n+  it('should not modify the file if none of the mappings match', () => {\n+    const source = `\n+      <xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">\n+        <file source-language=\"fr-FR\" datatype=\"plaintext\" original=\"ng2.template\">\n+          <body>\n+            <trans-unit id=\"123hello-legacy\" datatype=\"html\">\n+              <source>Hello</source>\n+              <target>Bonjour</target>\n+            </trans-unit>\n+\n+            <trans-unit id=\"456goodbye-legacy\" datatype=\"html\">\n+              <source>Goodbye</source>\n+              <target>Au revoir</target>\n+            </trans-unit>\n+          </body>\n+        </file>\n+      </xliff>\n+    `;\n+\n+    const result = migrateFile(source, {\n+      'does-not-match': 'migrated-does-not-match',\n+      'also-does-not-match': 'migrated-also-does-not-match',\n+    });\n+\n+    expect(result).toBe(source);\n+  });\n+\n+  // Note: it shouldn't be possible for the ID to be repeated multiple times, but\n+  // this assertion is here to make sure that it behaves as expected if it does.\n+  it('should migrate if an ID appears in more than one place', () => {\n+    const source = `\n+      <xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">\n+        <file source-language=\"fr-FR\" datatype=\"plaintext\" original=\"ng2.template\">\n+          <body>\n+            <trans-unit id=\"123hello-legacy\" datatype=\"html\">\n+              <source>Hello</source>\n+              <target>Bonjour</target>\n+            </trans-unit>\n+\n+            <made-up-tag datatype=\"html\" belongs-to=\"123hello-legacy\">\n+              <source id=\"123hello-legacy\">Hello</source>\n+              <target target-id=\"123hello-legacy\">Bonjour</target>\n+            </mage-up-tag>\n+          </body>\n+        </file>\n+      </xliff>\n+    `;\n+\n+    const result = migrateFile(source, {'123hello-legacy': 'hello-migrated'});\n+    expect(result).toContain('<trans-unit id=\"hello-migrated\" datatype=\"html\">');\n+    expect(result).toContain('<made-up-tag datatype=\"html\" belongs-to=\"hello-migrated\">');\n+    expect(result).toContain('<source id=\"hello-migrated\">');\n+    expect(result).toContain('<target target-id=\"hello-migrated\">Bonjour</target>');\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 797,
        "additions": 787,
        "deletions": 10
    }
}