{
    "author": "petebacondarwin",
    "message": "fix(localize): enable whitespace preservation marker in XLIFF files (#38737)\n\nWhitespace can be relevant in extracted XLIFF translation files.\nSome i18n tools - e.g. CAT tool (OmegaT) - will reformat\nthe file to collapse whitespace if there is no indication to tell it\nnot to.\n\nThis commit adds the ability to specify \"format options\" that are passed\nto the translation file serializer. The XLIFF 1.2 and 2.0 seralizers have\nbeen updated to accept `{\"xml:space\":\"preserve\"}` format option which will\nby added to the `<file>` element in the serialized translation file during\nextraction.\n\nFixes #38679\n\nPR Close #38737",
    "sha": "4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
    "files": [
        {
            "sha": "27d50f6212ae88eb4eeb0524785a1b18b0ddb69f",
            "filename": "packages/localize/src/tools/src/extract/main.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 5,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Fmain.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -21,6 +21,7 @@ import {SimpleJsonTranslationSerializer} from './translation_files/json_translat\n import {Xliff1TranslationSerializer} from './translation_files/xliff1_translation_serializer';\n import {Xliff2TranslationSerializer} from './translation_files/xliff2_translation_serializer';\n import {XmbTranslationSerializer} from './translation_files/xmb_translation_serializer';\n+import {FormatOptions, parseFormatOptions} from './translation_files/format_options';\n \n if (require.main === module) {\n   const args = process.argv.slice(2);\n@@ -54,6 +55,13 @@ if (require.main === module) {\n             describe: 'The format of the translation file.',\n             type: 'string',\n           })\n+          .option('formatOptions', {\n+            describe:\n+                'Additional options to pass to the translation file serializer, in the form of JSON formatted key-value string pairs:\\n' +\n+                'For example: `--formatOptions {\"xml:space\":\"preserve\"}.\\n' +\n+                'The meaning of the options is specific to the format being serialized.',\n+            type: 'string'\n+          })\n           .option('o', {\n             alias: 'outputPath',\n             required: true,\n@@ -97,6 +105,7 @@ if (require.main === module) {\n   const logLevel = options.loglevel as (keyof typeof LogLevel) | undefined;\n   const logger = new ConsoleLogger(logLevel ? LogLevel[logLevel] : LogLevel.warn);\n   const duplicateMessageHandling = options.d as DiagnosticHandlingStrategy;\n+  const formatOptions = parseFormatOptions(options.formatOptions);\n \n \n   extractTranslations({\n@@ -109,6 +118,7 @@ if (require.main === module) {\n     useSourceMaps: options.useSourceMaps,\n     useLegacyIds: options.useLegacyIds,\n     duplicateMessageHandling,\n+    formatOptions,\n   });\n }\n \n@@ -152,6 +162,10 @@ export interface ExtractTranslationsOptions {\n    * How to handle messages with the same id but not the same text.\n    */\n   duplicateMessageHandling: DiagnosticHandlingStrategy;\n+  /**\n+   * A collection of formatting options to pass to the translation file serializer.\n+   */\n+  formatOptions?: FormatOptions;\n }\n \n export function extractTranslations({\n@@ -164,6 +178,7 @@ export function extractTranslations({\n   useSourceMaps,\n   useLegacyIds,\n   duplicateMessageHandling,\n+  formatOptions = {},\n }: ExtractTranslationsOptions) {\n   const fs = getFileSystem();\n   const basePath = fs.resolve(rootPath);\n@@ -180,7 +195,8 @@ export function extractTranslations({\n   }\n \n   const outputPath = fs.resolve(rootPath, output);\n-  const serializer = getSerializer(format, sourceLocale, fs.dirname(outputPath), useLegacyIds);\n+  const serializer =\n+      getSerializer(format, sourceLocale, fs.dirname(outputPath), useLegacyIds, formatOptions);\n   const translationFile = serializer.serialize(messages);\n   fs.ensureDir(fs.dirname(outputPath));\n   fs.writeFile(outputPath, translationFile);\n@@ -191,17 +207,17 @@ export function extractTranslations({\n }\n \n export function getSerializer(\n-    format: string, sourceLocale: string, rootPath: AbsoluteFsPath,\n-    useLegacyIds: boolean): TranslationSerializer {\n+    format: string, sourceLocale: string, rootPath: AbsoluteFsPath, useLegacyIds: boolean,\n+    formatOptions: FormatOptions): TranslationSerializer {\n   switch (format) {\n     case 'xlf':\n     case 'xlif':\n     case 'xliff':\n-      return new Xliff1TranslationSerializer(sourceLocale, rootPath, useLegacyIds);\n+      return new Xliff1TranslationSerializer(sourceLocale, rootPath, useLegacyIds, formatOptions);\n     case 'xlf2':\n     case 'xlif2':\n     case 'xliff2':\n-      return new Xliff2TranslationSerializer(sourceLocale, rootPath, useLegacyIds);\n+      return new Xliff2TranslationSerializer(sourceLocale, rootPath, useLegacyIds, formatOptions);\n     case 'xmb':\n       return new XmbTranslationSerializer(rootPath, useLegacyIds);\n     case 'json':"
        },
        {
            "sha": "43113678bb2da6dfde09b1df99707442d867a765",
            "filename": "packages/localize/src/tools/src/extract/translation_files/format_options.ts",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fformat_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fformat_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fformat_options.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -0,0 +1,44 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export type FormatOptions = Record<string, string>;\n+export type ValidOption = [key: string, values: string[]];\n+export type ValidOptions = ValidOption[];\n+\n+/**\n+ * Check that the given `options` are allowed based on the given `validOptions`.\n+ * @param name The name of the serializer that is receiving the options.\n+ * @param validOptions An array of valid options and their allowed values.\n+ * @param options The options to be validated.\n+ */\n+export function validateOptions(name: string, validOptions: ValidOptions, options: FormatOptions) {\n+  const validOptionsMap = new Map<ValidOption[0], ValidOption[1]>(validOptions);\n+  for (const option in options) {\n+    if (!validOptionsMap.has(option)) {\n+      throw new Error(\n+          `Invalid format option for ${name}: \"${option}\".\\n` +\n+          `Allowed options are ${JSON.stringify(Array.from(validOptionsMap.keys()))}.`);\n+    }\n+    const validOptionValues = validOptionsMap.get(option)!;\n+    const optionValue = options[option];\n+    if (!validOptionValues.includes(optionValue)) {\n+      throw new Error(\n+          `Invalid format option value for ${name}: \"${option}\".\\n` +\n+          `Allowed option values are ${JSON.stringify(validOptionValues)} but received \"${\n+              optionValue}\".`);\n+    }\n+  }\n+}\n+\n+/**\n+ * Parse the given `optionString` into a collection of `FormatOptions`.\n+ * @param optionString The string to parse.\n+ */\n+export function parseFormatOptions(optionString: string = '{}'): FormatOptions {\n+  return JSON.parse(optionString);\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "f56a4addf214e44743e447d2d82f722fa23326dd",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff1_translation_serializer.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -8,6 +8,7 @@\n import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n+import {FormatOptions, validateOptions} from './format_options';\n import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n import {XmlFile} from './xml_file';\n@@ -25,8 +26,10 @@ const LEGACY_XLIFF_MESSAGE_LENGTH = 40;\n  */\n export class Xliff1TranslationSerializer implements TranslationSerializer {\n   constructor(\n-      private sourceLocale: string, private basePath: AbsoluteFsPath,\n-      private useLegacyIds: boolean) {}\n+      private sourceLocale: string, private basePath: AbsoluteFsPath, private useLegacyIds: boolean,\n+      private formatOptions: FormatOptions) {\n+    validateOptions('Xliff1TranslationSerializer', [['xml:space', ['preserve']]], formatOptions);\n+  }\n \n   serialize(messages: ɵParsedMessage[]): string {\n     const ids = new Set<string>();\n@@ -43,6 +46,7 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n       'source-language': this.sourceLocale,\n       'datatype': 'plaintext',\n       'original': 'ng2.template',\n+      ...this.formatOptions,\n     });\n     xml.startTag('body');\n     for (const message of messages) {"
        },
        {
            "sha": "395e4c1bbea2ec637748f683a4a52d77fdcd1845",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff2_translation_serializer.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -8,6 +8,7 @@\n import {AbsoluteFsPath, relative} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n+import {FormatOptions, validateOptions} from './format_options';\n import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n import {XmlFile} from './xml_file';\n@@ -25,8 +26,10 @@ const MAX_LEGACY_XLIFF_2_MESSAGE_LENGTH = 20;\n export class Xliff2TranslationSerializer implements TranslationSerializer {\n   private currentPlaceholderId = 0;\n   constructor(\n-      private sourceLocale: string, private basePath: AbsoluteFsPath,\n-      private useLegacyIds: boolean) {}\n+      private sourceLocale: string, private basePath: AbsoluteFsPath, private useLegacyIds: boolean,\n+      private formatOptions: FormatOptions) {\n+    validateOptions('Xliff1TranslationSerializer', [['xml:space', ['preserve']]], formatOptions);\n+  }\n \n   serialize(messages: ɵParsedMessage[]): string {\n     const ids = new Set<string>();\n@@ -41,8 +44,9 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n     // We could compute the file from the `message.location` property, but there could\n     // be multiple values for this in the collection of `messages`. In that case we would probably\n     // need to change the serializer to output a new `<file>` element for each collection of\n-    // messages that come from a particular original file, and the translation file parsers may not\n-    xml.startTag('file', {'id': 'ngi18n', 'original': 'ng.template'});\n+    // messages that come from a particular original file, and the translation file parsers may\n+    // not\n+    xml.startTag('file', {'id': 'ngi18n', 'original': 'ng.template', ...this.formatOptions});\n     for (const message of messages) {\n       const id = this.getMessageId(message);\n       if (ids.has(id)) {"
        },
        {
            "sha": "705826ea14bc8533ac11d8d342b352821f3f6432",
            "filename": "packages/localize/src/tools/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2FBUILD.bazel?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     srcs = glob(\n         [\"**/*.ts\"],\n     ),\n+    visibility = [\"//packages/localize/src/tools/test:__subpackages__\"],\n     deps = [\n         \"//packages:types\",\n         \"//packages/compiler\","
        },
        {
            "sha": "37d9fdc252412f0f49b201dc642b95a69b4f82b3",
            "filename": "packages/localize/src/tools/test/extract/integration/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2FBUILD.bazel?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -14,6 +14,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/logging/testing\",\n         \"//packages/compiler-cli/test/helpers\",\n         \"//packages/localize/src/tools\",\n+        \"//packages/localize/src/tools/test:test_lib\",\n     ],\n )\n "
        },
        {
            "sha": "d93bb690208f49eccd1110199cdba29ca4c40d0a",
            "filename": "packages/localize/src/tools/test/extract/integration/main_spec.ts",
            "status": "modified",
            "additions": 146,
            "deletions": 137,
            "changes": 283,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -11,6 +11,8 @@ import {MockLogger} from '@angular/compiler-cli/src/ngtsc/logging/testing';\n import {loadTestDirectory} from '@angular/compiler-cli/test/helpers';\n \n import {extractTranslations} from '../../../src/extract/main';\n+import {FormatOptions} from '../../../src/extract/translation_files/format_options';\n+import {toAttributes} from '../translation_files/utils';\n \n runInEachFileSystem(() => {\n   let fs: FileSystem;\n@@ -134,145 +136,152 @@ runInEachFileSystem(() => {\n           ].join('\\n'));\n         });\n \n-        it('should extract translations from source code, and write as XLIFF 1.2 format', () => {\n-          extractTranslations({\n-            rootPath,\n-            sourceLocale: 'en-CA',\n-            sourceFilePaths: [sourceFilePath],\n-            format: 'xliff',\n-            outputPath,\n-            logger,\n-            useSourceMaps: false,\n-            useLegacyIds,\n-            duplicateMessageHandling: 'ignore',\n-          });\n-          expect(fs.readFile(outputPath)).toEqual([\n-            `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n-            `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n-            `  <file source-language=\"en-CA\" datatype=\"plaintext\" original=\"ng2.template\">`,\n-            `    <body>`,\n-            `      <trans-unit id=\"3291030485717846467\" datatype=\"html\">`,\n-            `        <source>Hello, <x id=\"PH\" equiv-text=\"name\"/>!</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n-            `          <context context-type=\"linenumber\">2</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"8669027859022295761\" datatype=\"html\">`,\n-            `        <source>try<x id=\"PH\" equiv-text=\"40 + 2\"/>me</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n-            `          <context context-type=\"linenumber\">3</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"custom-id\" datatype=\"html\">`,\n-            `        <source>Custom id message</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n-            `          <context context-type=\"linenumber\">4</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"${\n-                useLegacyIds ? '1234567890123456789012345678901234567890' :\n-                               '273296103957933077'}\" datatype=\"html\">`,\n-            `        <source>Legacy id message</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n-            `          <context context-type=\"linenumber\">6</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"custom-id-2\" datatype=\"html\">`,\n-            `        <source>Custom and legacy message</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n-            `          <context context-type=\"linenumber\">8</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"2932901491976224757\" datatype=\"html\">`,\n-            `        <source>pre<x id=\"START_TAG_SPAN\" equiv-text=\"&apos;&lt;span&gt;&apos;\"/>` +\n-                `inner-pre<x id=\"START_BOLD_TEXT\" equiv-text=\"&apos;&lt;b&gt;&apos;\"/>bold<x id=\"CLOSE_BOLD_TEXT\" equiv-text=\"&apos;&lt;/b&gt;&apos;\"/>` +\n-                `inner-post<x id=\"CLOSE_TAG_SPAN\" equiv-text=\"&apos;&lt;/span&gt;&apos;\"/>post</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n-            `          <context context-type=\"linenumber\">9,10</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `    </body>`,\n-            `  </file>`,\n-            `</xliff>\\n`,\n-          ].join('\\n'));\n-        });\n+        for (const formatOptions of [{}, {'xml:space': 'preserve'}] as FormatOptions[]) {\n+          it(`should extract translations from source code, and write as XLIFF 1.2 format${\n+                 formatOptions['xml:space'] ? '[with xml:space attribute]' : ''}`,\n+             () => {\n+               extractTranslations({\n+                 rootPath,\n+                 sourceLocale: 'en-CA',\n+                 sourceFilePaths: [sourceFilePath],\n+                 format: 'xliff',\n+                 outputPath,\n+                 logger,\n+                 useSourceMaps: false,\n+                 useLegacyIds,\n+                 duplicateMessageHandling: 'ignore',\n+                 formatOptions,\n+               });\n+               expect(fs.readFile(outputPath)).toEqual([\n+                 `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+                 `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n+                 `  <file source-language=\"en-CA\" datatype=\"plaintext\" original=\"ng2.template\"${\n+                     toAttributes(formatOptions)}>`,\n+                 `    <body>`,\n+                 `      <trans-unit id=\"3291030485717846467\" datatype=\"html\">`,\n+                 `        <source>Hello, <x id=\"PH\" equiv-text=\"name\"/>!</source>`,\n+                 `        <context-group purpose=\"location\">`,\n+                 `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n+                 `          <context context-type=\"linenumber\">2</context>`,\n+                 `        </context-group>`,\n+                 `      </trans-unit>`,\n+                 `      <trans-unit id=\"8669027859022295761\" datatype=\"html\">`,\n+                 `        <source>try<x id=\"PH\" equiv-text=\"40 + 2\"/>me</source>`,\n+                 `        <context-group purpose=\"location\">`,\n+                 `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n+                 `          <context context-type=\"linenumber\">3</context>`,\n+                 `        </context-group>`,\n+                 `      </trans-unit>`,\n+                 `      <trans-unit id=\"custom-id\" datatype=\"html\">`,\n+                 `        <source>Custom id message</source>`,\n+                 `        <context-group purpose=\"location\">`,\n+                 `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n+                 `          <context context-type=\"linenumber\">4</context>`,\n+                 `        </context-group>`,\n+                 `      </trans-unit>`,\n+                 `      <trans-unit id=\"${\n+                     useLegacyIds ? '1234567890123456789012345678901234567890' :\n+                                    '273296103957933077'}\" datatype=\"html\">`,\n+                 `        <source>Legacy id message</source>`,\n+                 `        <context-group purpose=\"location\">`,\n+                 `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n+                 `          <context context-type=\"linenumber\">6</context>`,\n+                 `        </context-group>`,\n+                 `      </trans-unit>`,\n+                 `      <trans-unit id=\"custom-id-2\" datatype=\"html\">`,\n+                 `        <source>Custom and legacy message</source>`,\n+                 `        <context-group purpose=\"location\">`,\n+                 `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n+                 `          <context context-type=\"linenumber\">8</context>`,\n+                 `        </context-group>`,\n+                 `      </trans-unit>`,\n+                 `      <trans-unit id=\"2932901491976224757\" datatype=\"html\">`,\n+                 `        <source>pre<x id=\"START_TAG_SPAN\" equiv-text=\"&apos;&lt;span&gt;&apos;\"/>` +\n+                     `inner-pre<x id=\"START_BOLD_TEXT\" equiv-text=\"&apos;&lt;b&gt;&apos;\"/>bold<x id=\"CLOSE_BOLD_TEXT\" equiv-text=\"&apos;&lt;/b&gt;&apos;\"/>` +\n+                     `inner-post<x id=\"CLOSE_TAG_SPAN\" equiv-text=\"&apos;&lt;/span&gt;&apos;\"/>post</source>`,\n+                 `        <context-group purpose=\"location\">`,\n+                 `          <context context-type=\"sourcefile\">test_files/test.js</context>`,\n+                 `          <context context-type=\"linenumber\">9,10</context>`,\n+                 `        </context-group>`,\n+                 `      </trans-unit>`,\n+                 `    </body>`,\n+                 `  </file>`,\n+                 `</xliff>\\n`,\n+               ].join('\\n'));\n+             });\n \n-        it('should extract translations from source code, and write as XLIFF 2 format', () => {\n-          extractTranslations({\n-            rootPath,\n-            sourceLocale: 'en-AU',\n-            sourceFilePaths: [sourceFilePath],\n-            format: 'xliff2',\n-            outputPath,\n-            logger,\n-            useSourceMaps: false,\n-            useLegacyIds,\n-            duplicateMessageHandling: 'ignore',\n+          it('should extract translations from source code, and write as XLIFF 2 format', () => {\n+            extractTranslations({\n+              rootPath,\n+              sourceLocale: 'en-AU',\n+              sourceFilePaths: [sourceFilePath],\n+              format: 'xliff2',\n+              outputPath,\n+              logger,\n+              useSourceMaps: false,\n+              useLegacyIds,\n+              duplicateMessageHandling: 'ignore',\n+              formatOptions,\n+            });\n+            expect(fs.readFile(outputPath)).toEqual([\n+              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+              `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en-AU\">`,\n+              `  <file id=\"ngi18n\" original=\"ng.template\"${toAttributes(formatOptions)}>`,\n+              `    <unit id=\"3291030485717846467\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">test_files/test.js:2</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>Hello, <ph id=\"0\" equiv=\"PH\" disp=\"name\"/>!</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"8669027859022295761\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">test_files/test.js:3</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>try<ph id=\"0\" equiv=\"PH\" disp=\"40 + 2\"/>me</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"custom-id\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">test_files/test.js:4</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>Custom id message</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"${useLegacyIds ? '12345678901234567890' : '273296103957933077'}\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">test_files/test.js:6</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>Legacy id message</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"custom-id-2\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">test_files/test.js:8</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>Custom and legacy message</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"2932901491976224757\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">test_files/test.js:9,10</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>pre<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" dispStart=\"&apos;&lt;span&gt;&apos;\" dispEnd=\"&apos;&lt;/span&gt;&apos;\">` +\n+                  `inner-pre<pc id=\"1\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\" dispStart=\"&apos;&lt;b&gt;&apos;\" dispEnd=\"&apos;&lt;/b&gt;&apos;\">bold</pc>` +\n+                  `inner-post</pc>post</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `  </file>`,\n+              `</xliff>\\n`,\n+            ].join('\\n'));\n           });\n-          expect(fs.readFile(outputPath)).toEqual([\n-            `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n-            `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"en-AU\">`,\n-            `  <file id=\"ngi18n\" original=\"ng.template\">`,\n-            `    <unit id=\"3291030485717846467\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">test_files/test.js:2</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>Hello, <ph id=\"0\" equiv=\"PH\" disp=\"name\"/>!</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"8669027859022295761\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">test_files/test.js:3</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>try<ph id=\"0\" equiv=\"PH\" disp=\"40 + 2\"/>me</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"custom-id\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">test_files/test.js:4</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>Custom id message</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"${useLegacyIds ? '12345678901234567890' : '273296103957933077'}\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">test_files/test.js:6</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>Legacy id message</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"custom-id-2\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">test_files/test.js:8</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>Custom and legacy message</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"2932901491976224757\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">test_files/test.js:9,10</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>pre<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" dispStart=\"&apos;&lt;span&gt;&apos;\" dispEnd=\"&apos;&lt;/span&gt;&apos;\">` +\n-                `inner-pre<pc id=\"1\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\" dispStart=\"&apos;&lt;b&gt;&apos;\" dispEnd=\"&apos;&lt;/b&gt;&apos;\">bold</pc>` +\n-                `inner-post</pc>post</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `  </file>`,\n-            `</xliff>\\n`,\n-          ].join('\\n'));\n-        });\n+        }\n       });\n     }\n "
        },
        {
            "sha": "452e0d6250d8fcb69933227cb6a66d71b5dc3638",
            "filename": "packages/localize/src/tools/test/extract/translation_files/format_options_spec.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fformat_options_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fformat_options_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fformat_options_spec.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -0,0 +1,49 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {parseFormatOptions, validateOptions} from '../../../src/extract/translation_files/format_options';\n+\n+describe('format_options', () => {\n+  describe('validateOptions()', () => {\n+    it('should do nothing if there are no options', () => {\n+      expect(() => validateOptions('TestSerializer', [['key', ['value1', 'value2']]], {}))\n+          .not.toThrow();\n+    });\n+\n+    it('should do nothing if the options are valid', () => {\n+      expect(\n+          () => validateOptions('TestSerializer', [['key', ['value1', 'value2']]], {key: 'value1'}))\n+          .not.toThrow();\n+    });\n+\n+    it('should error if there is an unexpected option', () => {\n+      expect(\n+          () => validateOptions('TestSerializer', [['key', ['value1', 'value2']]], {wrong: 'xxx'}))\n+          .toThrowError(\n+              'Invalid format option for TestSerializer: \"wrong\".\\n' +\n+              'Allowed options are [\"key\"].');\n+    });\n+\n+    it('should error if there is an unexpected option value', () => {\n+      expect(\n+          () => validateOptions('TestSerializer', [['key', ['value1', 'value2']]], {key: 'other'}))\n+          .toThrowError(\n+              'Invalid format option value for TestSerializer: \"key\".\\n' +\n+              'Allowed option values are [\"value1\",\"value2\"] but received \"other\".');\n+    });\n+  });\n+\n+  describe('parseFormatOptions()', () => {\n+    it('should parse the string as JSON', () => {\n+      expect(parseFormatOptions('{\"a\": \"1\", \"b\": \"2\"}')).toEqual({a: '1', b: '2'});\n+    });\n+\n+    it('should parse undefined into an empty object', () => {\n+      expect(parseFormatOptions(undefined)).toEqual({});\n+    });\n+  });\n+});"
        },
        {
            "sha": "2fe55a6eb35801f615a2e65b7fe21cd4a8f5580f",
            "filename": "packages/localize/src/tools/test/extract/translation_files/utils.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Futils.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -0,0 +1,17 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {FormatOptions} from '../../../src/extract/translation_files/format_options';\n+\n+export function toAttributes(options: FormatOptions) {\n+  let result = '';\n+  for (const option in options) {\n+    result += ` ${option}=\"${options[option]}\"`;\n+  }\n+  return result;\n+}"
        },
        {
            "sha": "0ed91d10b33d601bf7d476eaedeaa4f70a386a41",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff1_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 120,
            "deletions": 115,
            "changes": 235,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -9,127 +9,132 @@ import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n+import {FormatOptions} from '../../../src/extract/translation_files/format_options';\n import {Xliff1TranslationSerializer} from '../../../src/extract/translation_files/xliff1_translation_serializer';\n \n import {mockMessage} from './mock_message';\n+import {toAttributes} from './utils';\n \n runInEachFileSystem(() => {\n   describe('Xliff1TranslationSerializer', () => {\n-    [false, true].forEach(useLegacyIds => {\n-      describe(`renderFile() [using ${useLegacyIds ? 'legacy' : 'canonical'} ids]`, () => {\n-        it('should convert a set of parsed messages into an XML string', () => {\n-          const phLocation: ɵSourceLocation = {\n-            start: {line: 0, column: 10},\n-            end: {line: 1, column: 15},\n-            file: absoluteFrom('/project/file.ts'),\n-            text: 'placeholder + 1'\n-          };\n-          const messagePartLocation: ɵSourceLocation = {\n-            start: {line: 0, column: 5},\n-            end: {line: 0, column: 10},\n-            file: absoluteFrom('/project/file.ts'),\n-            text: 'message part'\n-          };\n-          const messages: ɵParsedMessage[] = [\n-            mockMessage('12345', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n-              meaning: 'some meaning',\n-              location: {\n-                file: absoluteFrom('/project/file.ts'),\n-                start: {line: 5, column: 10},\n-                end: {line: 5, column: 12}\n-              },\n-              legacyIds: ['1234567890ABCDEF1234567890ABCDEF12345678', '615790887472569365'],\n-            }),\n-            mockMessage('54321', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n-              customId: 'someId',\n-              legacyIds: ['87654321FEDCBA0987654321FEDCBA0987654321', '563965274788097516'],\n-              messagePartLocations: [undefined, messagePartLocation, undefined],\n-              substitutionLocations: {'PH': phLocation, 'PH_1': undefined},\n-            }),\n-            mockMessage(\n-                '67890', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'],\n-                {description: 'some description'}),\n-            mockMessage('38705', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n-              location: {\n-                file: absoluteFrom('/project/file.ts'),\n-                start: {line: 2, column: 7},\n-                end: {line: 3, column: 2}\n-              }\n-            }),\n-            mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n-            mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n-            mockMessage('80808', ['multi\\nlines'], [], {}),\n-            mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n-            mockMessage(\n-                '100000',\n-                [\n-                  'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n-                ],\n-                [], {}),\n-            mockMessage(\n-                '100001',\n-                [\n-                  '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n-                ],\n-                [], {}),\n-          ];\n-          const serializer =\n-              new Xliff1TranslationSerializer('xx', absoluteFrom('/project'), useLegacyIds);\n-          const output = serializer.serialize(messages);\n-          expect(output).toEqual([\n-            `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n-            `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n-            `  <file source-language=\"xx\" datatype=\"plaintext\" original=\"ng2.template\">`,\n-            `    <body>`,\n-            `      <trans-unit id=\"${\n-                useLegacyIds ? '1234567890ABCDEF1234567890ABCDEF12345678' :\n-                               '12345'}\" datatype=\"html\">`,\n-            `        <source>a<x id=\"PH\"/>b<x id=\"PH_1\"/>c</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">file.ts</context>`,\n-            `          <context context-type=\"linenumber\">6</context>`,\n-            `        </context-group>`,\n-            `        <note priority=\"1\" from=\"meaning\">some meaning</note>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"someId\" datatype=\"html\">`,\n-            `        <source>a<x id=\"PH\" equiv-text=\"placeholder + 1\"/>b<x id=\"PH_1\"/>c</source>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"67890\" datatype=\"html\">`,\n-            `        <source>a<x id=\"START_TAG_SPAN\"/><x id=\"CLOSE_TAG_SPAN\"/>c</source>`,\n-            `        <note priority=\"1\" from=\"description\">some description</note>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"38705\" datatype=\"html\">`,\n-            `        <source>a<x id=\"START_TAG_SPAN\"/><x id=\"CLOSE_TAG_SPAN\"/>c</source>`,\n-            `        <context-group purpose=\"location\">`,\n-            `          <context context-type=\"sourcefile\">file.ts</context>`,\n-            `          <context context-type=\"linenumber\">3,4</context>`,\n-            `        </context-group>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"13579\" datatype=\"html\">`,\n-            `        <source><x id=\"START_BOLD_TEXT\"/>b<x id=\"CLOSE_BOLD_TEXT\"/></source>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"24680\" datatype=\"html\">`,\n-            `        <source>a</source>`,\n-            `        <note priority=\"1\" from=\"description\">and description</note>`,\n-            `        <note priority=\"1\" from=\"meaning\">meaning</note>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"80808\" datatype=\"html\">`,\n-            `        <source>multi`,\n-            `lines</source>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"90000\" datatype=\"html\">`,\n-            `        <source>&lt;escape<x id=\"double-quotes-&quot;\"/>me&gt;</source>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"100000\" datatype=\"html\">`,\n-            `        <source>pre-ICU {VAR_SELECT, select, a {a} b {<x id=\"INTERPOLATION\"/>} c {pre <x id=\"INTERPOLATION_1\"/> post}} post-ICU</source>`,\n-            `      </trans-unit>`,\n-            `      <trans-unit id=\"100001\" datatype=\"html\">`,\n-            `        <source>{VAR_PLURAL, plural, one {<x id=\"START_BOLD_TEXT\"/>something bold<x id=\"CLOSE_BOLD_TEXT\"/>} other {pre <x id=\"START_TAG_SPAN\"/>middle<x id=\"CLOSE_TAG_SPAN\"/> post}}</source>`,\n-            `      </trans-unit>`,\n-            `    </body>`,\n-            `  </file>`,\n-            `</xliff>\\n`,\n-          ].join('\\n'));\n+    ([{}, {'xml:space': 'preserve'}] as FormatOptions[]).forEach(options => {\n+      [false, true].forEach(useLegacyIds => {\n+        describe(`renderFile() [using ${useLegacyIds ? 'legacy' : 'canonical'} ids]`, () => {\n+          it('should convert a set of parsed messages into an XML string', () => {\n+            const phLocation: ɵSourceLocation = {\n+              start: {line: 0, column: 10},\n+              end: {line: 1, column: 15},\n+              file: absoluteFrom('/project/file.ts'),\n+              text: 'placeholder + 1'\n+            };\n+            const messagePartLocation: ɵSourceLocation = {\n+              start: {line: 0, column: 5},\n+              end: {line: 0, column: 10},\n+              file: absoluteFrom('/project/file.ts'),\n+              text: 'message part'\n+            };\n+            const messages: ɵParsedMessage[] = [\n+              mockMessage('12345', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n+                meaning: 'some meaning',\n+                location: {\n+                  file: absoluteFrom('/project/file.ts'),\n+                  start: {line: 5, column: 10},\n+                  end: {line: 5, column: 12}\n+                },\n+                legacyIds: ['1234567890ABCDEF1234567890ABCDEF12345678', '615790887472569365'],\n+              }),\n+              mockMessage('54321', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n+                customId: 'someId',\n+                legacyIds: ['87654321FEDCBA0987654321FEDCBA0987654321', '563965274788097516'],\n+                messagePartLocations: [undefined, messagePartLocation, undefined],\n+                substitutionLocations: {'PH': phLocation, 'PH_1': undefined},\n+              }),\n+              mockMessage(\n+                  '67890', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'],\n+                  {description: 'some description'}),\n+              mockMessage('38705', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n+                location: {\n+                  file: absoluteFrom('/project/file.ts'),\n+                  start: {line: 2, column: 7},\n+                  end: {line: 3, column: 2}\n+                }\n+              }),\n+              mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n+              mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n+              mockMessage('80808', ['multi\\nlines'], [], {}),\n+              mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n+              mockMessage(\n+                  '100000',\n+                  [\n+                    'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n+                  ],\n+                  [], {}),\n+              mockMessage(\n+                  '100001',\n+                  [\n+                    '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n+                  ],\n+                  [], {}),\n+            ];\n+            const serializer = new Xliff1TranslationSerializer(\n+                'xx', absoluteFrom('/project'), useLegacyIds, options);\n+            const output = serializer.serialize(messages);\n+            expect(output).toEqual([\n+              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+              `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n+              `  <file source-language=\"xx\" datatype=\"plaintext\" original=\"ng2.template\"${\n+                  toAttributes(options)}>`,\n+              `    <body>`,\n+              `      <trans-unit id=\"${\n+                  useLegacyIds ? '1234567890ABCDEF1234567890ABCDEF12345678' :\n+                                 '12345'}\" datatype=\"html\">`,\n+              `        <source>a<x id=\"PH\"/>b<x id=\"PH_1\"/>c</source>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file.ts</context>`,\n+              `          <context context-type=\"linenumber\">6</context>`,\n+              `        </context-group>`,\n+              `        <note priority=\"1\" from=\"meaning\">some meaning</note>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"someId\" datatype=\"html\">`,\n+              `        <source>a<x id=\"PH\" equiv-text=\"placeholder + 1\"/>b<x id=\"PH_1\"/>c</source>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"67890\" datatype=\"html\">`,\n+              `        <source>a<x id=\"START_TAG_SPAN\"/><x id=\"CLOSE_TAG_SPAN\"/>c</source>`,\n+              `        <note priority=\"1\" from=\"description\">some description</note>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"38705\" datatype=\"html\">`,\n+              `        <source>a<x id=\"START_TAG_SPAN\"/><x id=\"CLOSE_TAG_SPAN\"/>c</source>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file.ts</context>`,\n+              `          <context context-type=\"linenumber\">3,4</context>`,\n+              `        </context-group>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"13579\" datatype=\"html\">`,\n+              `        <source><x id=\"START_BOLD_TEXT\"/>b<x id=\"CLOSE_BOLD_TEXT\"/></source>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"24680\" datatype=\"html\">`,\n+              `        <source>a</source>`,\n+              `        <note priority=\"1\" from=\"description\">and description</note>`,\n+              `        <note priority=\"1\" from=\"meaning\">meaning</note>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"80808\" datatype=\"html\">`,\n+              `        <source>multi`,\n+              `lines</source>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"90000\" datatype=\"html\">`,\n+              `        <source>&lt;escape<x id=\"double-quotes-&quot;\"/>me&gt;</source>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"100000\" datatype=\"html\">`,\n+              `        <source>pre-ICU {VAR_SELECT, select, a {a} b {<x id=\"INTERPOLATION\"/>} c {pre <x id=\"INTERPOLATION_1\"/> post}} post-ICU</source>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"100001\" datatype=\"html\">`,\n+              `        <source>{VAR_PLURAL, plural, one {<x id=\"START_BOLD_TEXT\"/>something bold<x id=\"CLOSE_BOLD_TEXT\"/>} other {pre <x id=\"START_TAG_SPAN\"/>middle<x id=\"CLOSE_TAG_SPAN\"/> post}}</source>`,\n+              `      </trans-unit>`,\n+              `    </body>`,\n+              `  </file>`,\n+              `</xliff>\\n`,\n+            ].join('\\n'));\n+          });\n         });\n       });\n     });"
        },
        {
            "sha": "5d424ef4a7edd2274c595b31371471966699ff01",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff2_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 143,
            "deletions": 139,
            "changes": 282,
            "blob_url": "https://github.com/angular/angular/blob/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts?ref=4360eed9b724f1bbee3e78ca80e4bb0ecf3133e2",
            "patch": "@@ -9,151 +9,155 @@ import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n+import {FormatOptions} from '../../../src/extract/translation_files/format_options';\n import {Xliff2TranslationSerializer} from '../../../src/extract/translation_files/xliff2_translation_serializer';\n \n import {mockMessage} from './mock_message';\n+import {toAttributes} from './utils';\n \n runInEachFileSystem(() => {\n   describe('Xliff2TranslationSerializer', () => {\n-    [false, true].forEach(useLegacyIds => {\n-      describe(`renderFile() [using ${useLegacyIds ? 'legacy' : 'canonical'} ids]`, () => {\n-        it('should convert a set of parsed messages into an XML string', () => {\n-          const phLocation: ɵSourceLocation = {\n-            start: {line: 0, column: 10},\n-            end: {line: 1, column: 15},\n-            file: absoluteFrom('/project/file.ts'),\n-            text: 'placeholder + 1'\n-          };\n-          const messagePartLocation: ɵSourceLocation = {\n-            start: {line: 0, column: 5},\n-            end: {line: 0, column: 10},\n-            file: absoluteFrom('/project/file.ts'),\n-            text: 'message part'\n-          };\n-          const messages: ɵParsedMessage[] = [\n-            mockMessage('12345', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n-              meaning: 'some meaning',\n-              location: {\n-                file: absoluteFrom('/project/file.ts'),\n-                start: {line: 5, column: 0},\n-                end: {line: 5, column: 3}\n-              },\n-              legacyIds: ['1234567890ABCDEF1234567890ABCDEF12345678', '615790887472569365'],\n-            }),\n-            mockMessage('54321', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n-              customId: 'someId',\n-              legacyIds: ['87654321FEDCBA0987654321FEDCBA0987654321', '563965274788097516'],\n-              messagePartLocations: [undefined, messagePartLocation, undefined],\n-              substitutionLocations: {'PH': phLocation, 'PH_1': undefined},\n-            }),\n-            mockMessage('67890', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n-              description: 'some description',\n-              location: {\n-                file: absoluteFrom('/project/file.ts'),\n-                start: {line: 2, column: 7},\n-                end: {line: 3, column: 2}\n-              }\n-            }),\n-            mockMessage('location-only', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n-              location: {\n-                file: absoluteFrom('/project/file.ts'),\n-                start: {line: 2, column: 7},\n-                end: {line: 3, column: 2}\n-              }\n-            }),\n-            mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n-            mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n-            mockMessage('80808', ['multi\\nlines'], [], {}),\n-            mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n-            mockMessage(\n-                '100000',\n-                [\n-                  'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n-                ],\n-                [], {}),\n-            mockMessage(\n-                '100001',\n-                [\n-                  '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n-                ],\n-                [], {}),\n-          ];\n-          const serializer =\n-              new Xliff2TranslationSerializer('xx', absoluteFrom('/project'), useLegacyIds);\n-          const output = serializer.serialize(messages);\n-          expect(output).toEqual([\n-            `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n-            `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"xx\">`,\n-            `  <file id=\"ngi18n\" original=\"ng.template\">`,\n-            `    <unit id=\"${useLegacyIds ? '615790887472569365' : '12345'}\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">file.ts:6</note>`,\n-            `        <note category=\"meaning\">some meaning</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>a<ph id=\"0\" equiv=\"PH\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"someId\">`,\n-            `      <segment>`,\n-            `        <source>a<ph id=\"0\" equiv=\"PH\" disp=\"placeholder + 1\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"67890\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">file.ts:3,4</note>`,\n-            `        <note category=\"description\">some description</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\"></pc>c</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"location-only\">`,\n-            `      <notes>`,\n-            `        <note category=\"location\">file.ts:3,4</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\"></pc>c</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"13579\">`,\n-            `      <segment>`,\n-            `        <source><pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">b</pc></source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"24680\">`,\n-            `      <notes>`,\n-            `        <note category=\"description\">and description</note>`,\n-            `        <note category=\"meaning\">meaning</note>`,\n-            `      </notes>`,\n-            `      <segment>`,\n-            `        <source>a</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"80808\">`,\n-            `      <segment>`,\n-            `        <source>multi`,\n-            `lines</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"90000\">`,\n-            `      <segment>`,\n-            `        <source>&lt;escape<ph id=\"0\" equiv=\"double-quotes-&quot;\"/>me&gt;</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"100000\">`,\n-            `      <segment>`,\n-            `        <source>pre-ICU {VAR_SELECT, select, a {a} b {<ph id=\"0\" equiv=\"INTERPOLATION\"/>} c {pre <ph id=\"1\" equiv=\"INTERPOLATION_1\"/> post}} post-ICU</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `    <unit id=\"100001\">`,\n-            `      <segment>`,\n-            `        <source>{VAR_PLURAL, plural, one {<pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">something bold</pc>} other {pre <pc id=\"1\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\">middle</pc> post}}</source>`,\n-            `      </segment>`,\n-            `    </unit>`,\n-            `  </file>`,\n-            `</xliff>\\n`,\n-          ].join('\\n'));\n+    ([{}, {'xml:space': 'preserve'}] as FormatOptions[]).forEach(options => {\n+      [false, true].forEach(useLegacyIds => {\n+        describe(`renderFile() [using ${useLegacyIds ? 'legacy' : 'canonical'} ids]`, () => {\n+          it('should convert a set of parsed messages into an XML string', () => {\n+            const phLocation: ɵSourceLocation = {\n+              start: {line: 0, column: 10},\n+              end: {line: 1, column: 15},\n+              file: absoluteFrom('/project/file.ts'),\n+              text: 'placeholder + 1'\n+            };\n+            const messagePartLocation: ɵSourceLocation = {\n+              start: {line: 0, column: 5},\n+              end: {line: 0, column: 10},\n+              file: absoluteFrom('/project/file.ts'),\n+              text: 'message part'\n+            };\n+            const messages: ɵParsedMessage[] = [\n+              mockMessage('12345', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n+                meaning: 'some meaning',\n+                location: {\n+                  file: absoluteFrom('/project/file.ts'),\n+                  start: {line: 5, column: 0},\n+                  end: {line: 5, column: 3}\n+                },\n+                legacyIds: ['1234567890ABCDEF1234567890ABCDEF12345678', '615790887472569365'],\n+              }),\n+              mockMessage('54321', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n+                customId: 'someId',\n+                legacyIds: ['87654321FEDCBA0987654321FEDCBA0987654321', '563965274788097516'],\n+                messagePartLocations: [undefined, messagePartLocation, undefined],\n+                substitutionLocations: {'PH': phLocation, 'PH_1': undefined},\n+              }),\n+              mockMessage('67890', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n+                description: 'some description',\n+                location: {\n+                  file: absoluteFrom('/project/file.ts'),\n+                  start: {line: 2, column: 7},\n+                  end: {line: 3, column: 2}\n+                }\n+              }),\n+              mockMessage('location-only', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n+                location: {\n+                  file: absoluteFrom('/project/file.ts'),\n+                  start: {line: 2, column: 7},\n+                  end: {line: 3, column: 2}\n+                }\n+              }),\n+              mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n+              mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n+              mockMessage('80808', ['multi\\nlines'], [], {}),\n+              mockMessage('90000', ['<escape', 'me>'], ['double-quotes-\"'], {}),\n+              mockMessage(\n+                  '100000',\n+                  [\n+                    'pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU'\n+                  ],\n+                  [], {}),\n+              mockMessage(\n+                  '100001',\n+                  [\n+                    '{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}'\n+                  ],\n+                  [], {}),\n+            ];\n+            const serializer = new Xliff2TranslationSerializer(\n+                'xx', absoluteFrom('/project'), useLegacyIds, options);\n+            const output = serializer.serialize(messages);\n+            expect(output).toEqual([\n+              `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n+              `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"xx\">`,\n+              `  <file id=\"ngi18n\" original=\"ng.template\"${toAttributes(options)}>`,\n+              `    <unit id=\"${useLegacyIds ? '615790887472569365' : '12345'}\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file.ts:6</note>`,\n+              `        <note category=\"meaning\">some meaning</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a<ph id=\"0\" equiv=\"PH\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"someId\">`,\n+              `      <segment>`,\n+              `        <source>a<ph id=\"0\" equiv=\"PH\" disp=\"placeholder + 1\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"67890\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file.ts:3,4</note>`,\n+              `        <note category=\"description\">some description</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\"></pc>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"location-only\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file.ts:3,4</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\"></pc>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"13579\">`,\n+              `      <segment>`,\n+              `        <source><pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">b</pc></source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"24680\">`,\n+              `      <notes>`,\n+              `        <note category=\"description\">and description</note>`,\n+              `        <note category=\"meaning\">meaning</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"80808\">`,\n+              `      <segment>`,\n+              `        <source>multi`,\n+              `lines</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"90000\">`,\n+              `      <segment>`,\n+              `        <source>&lt;escape<ph id=\"0\" equiv=\"double-quotes-&quot;\"/>me&gt;</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"100000\">`,\n+              `      <segment>`,\n+              `        <source>pre-ICU {VAR_SELECT, select, a {a} b {<ph id=\"0\" equiv=\"INTERPOLATION\"/>} c {pre <ph id=\"1\" equiv=\"INTERPOLATION_1\"/> post}} post-ICU</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"100001\">`,\n+              `      <segment>`,\n+              `        <source>{VAR_PLURAL, plural, one {<pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\">something bold</pc>} other {pre <pc id=\"1\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\">middle</pc> post}}</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `  </file>`,\n+              `</xliff>\\n`,\n+            ].join('\\n'));\n+          });\n         });\n       });\n     });"
        }
    ],
    "stats": {
        "total": 958,
        "additions": 556,
        "deletions": 402
    }
}