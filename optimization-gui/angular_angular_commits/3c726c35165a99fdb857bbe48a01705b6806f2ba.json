{
    "author": "devversion",
    "message": "fix(compiler): unclear lexer error when using private identifier in expressions (#42027)\n\nTypeScript supports ECMAScript private identifiers. It can happen that\ndevelopers intend to access such members from within an expression.\n\nThis currently results in an unclear error from the lexer. e.g.\n\n```\n'Parser Error: Unexpected token # at column 1 in [{{#myField}}] in C:/test.ts@5:2\n```\n\nWe could improve such errors by tokenizing private identifiers similar to\nhow the TypeScript scanner processes them. Later we can report better\nerrors in the expression parser or in the typecheck block. This commit\ncauses all private identifier tokens to be disallowed, so it never\nreaches the type checker. This is done intentionally as private\nidentifiers should not be considered valid Angular syntax, especially\nbecause private fields are not guaranteed to be accessible from within\na component/directive definition (e.g. there cases where a template\nfunction is generated outside of the class; which results in private\nmembers not being accessible; and this results in mixed/confusing\nbehavior).\n\nFixes #36003.\n\nPR Close #42027",
    "sha": "3c726c35165a99fdb857bbe48a01705b6806f2ba",
    "files": [
        {
            "sha": "99c5a5bcd5360cc09cf0c2c785bd8e8151fd223b",
            "filename": "packages/compiler/src/expression_parser/lexer.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Flexer.ts?ref=3c726c35165a99fdb857bbe48a01705b6806f2ba",
            "patch": "@@ -11,6 +11,7 @@ import * as chars from '../chars';\n export enum TokenType {\n   Character,\n   Identifier,\n+  PrivateIdentifier,\n   Keyword,\n   String,\n   Operator,\n@@ -58,6 +59,10 @@ export class Token {\n     return this.type == TokenType.Identifier;\n   }\n \n+  isPrivateIdentifier(): boolean {\n+    return this.type == TokenType.PrivateIdentifier;\n+  }\n+\n   isKeyword(): boolean {\n     return this.type == TokenType.Keyword;\n   }\n@@ -104,6 +109,7 @@ export class Token {\n       case TokenType.Identifier:\n       case TokenType.Keyword:\n       case TokenType.Operator:\n+      case TokenType.PrivateIdentifier:\n       case TokenType.String:\n       case TokenType.Error:\n         return this.strValue;\n@@ -123,6 +129,10 @@ function newIdentifierToken(index: number, end: number, text: string): Token {\n   return new Token(index, end, TokenType.Identifier, 0, text);\n }\n \n+function newPrivateIdentifierToken(index: number, end: number, text: string): Token {\n+  return new Token(index, end, TokenType.PrivateIdentifier, 0, text);\n+}\n+\n function newKeywordToken(index: number, end: number, text: string): Token {\n   return new Token(index, end, TokenType.Keyword, 0, text);\n }\n@@ -204,6 +214,7 @@ class _Scanner {\n       case chars.$DQ:\n         return this.scanString();\n       case chars.$HASH:\n+        return this.scanPrivateIdentifier();\n       case chars.$PLUS:\n       case chars.$MINUS:\n       case chars.$STAR:\n@@ -279,6 +290,18 @@ class _Scanner {\n                                         newIdentifierToken(start, this.index, str);\n   }\n \n+  /** Scans an ECMAScript private identifier. */\n+  scanPrivateIdentifier(): Token {\n+    const start: number = this.index;\n+    this.advance();\n+    if (!isIdentifierStart(this.peek)) {\n+      return this.error('Invalid character [#]', -1);\n+    }\n+    while (isIdentifierPart(this.peek)) this.advance();\n+    const identifierName: string = this.input.substring(start, this.index);\n+    return newPrivateIdentifierToken(start, this.index, identifierName);\n+  }\n+\n   scanNumber(start: number): Token {\n     let simple: boolean = (this.index === start);\n     this.advance();  // Skip initial digit."
        },
        {
            "sha": "01dc54a1a9fe7cf8264d61fa248ab8df984d7c0c",
            "filename": "packages/compiler/src/expression_parser/parser.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fexpression_parser%2Fparser.ts?ref=3c726c35165a99fdb857bbe48a01705b6806f2ba",
            "patch": "@@ -548,7 +548,11 @@ export class _ParseAST {\n   expectIdentifierOrKeyword(): string|null {\n     const n = this.next;\n     if (!n.isIdentifier() && !n.isKeyword()) {\n-      this.error(`Unexpected ${this.prettyPrintToken(n)}, expected identifier or keyword`);\n+      if (n.isPrivateIdentifier()) {\n+        this._reportErrorForPrivateIdentifier(n, 'expected identifier or keyword');\n+      } else {\n+        this.error(`Unexpected ${this.prettyPrintToken(n)}, expected identifier or keyword`);\n+      }\n       return null;\n     }\n     this.advance();\n@@ -558,7 +562,12 @@ export class _ParseAST {\n   expectIdentifierOrKeywordOrString(): string {\n     const n = this.next;\n     if (!n.isIdentifier() && !n.isKeyword() && !n.isString()) {\n-      this.error(`Unexpected ${this.prettyPrintToken(n)}, expected identifier, keyword, or string`);\n+      if (n.isPrivateIdentifier()) {\n+        this._reportErrorForPrivateIdentifier(n, 'expected identifier, keyword or string');\n+      } else {\n+        this.error(\n+            `Unexpected ${this.prettyPrintToken(n)}, expected identifier, keyword, or string`);\n+      }\n       return '';\n     }\n     this.advance();\n@@ -899,6 +908,10 @@ export class _ParseAST {\n       this.advance();\n       return new LiteralPrimitive(this.span(start), this.sourceSpan(start), literalValue);\n \n+    } else if (this.next.isPrivateIdentifier()) {\n+      this._reportErrorForPrivateIdentifier(this.next, null);\n+      return new EmptyExpr(this.span(start), this.sourceSpan(start));\n+\n     } else if (this.index >= this.tokens.length) {\n       this.error(`Unexpected end of expression: ${this.input}`);\n       return new EmptyExpr(this.span(start), this.sourceSpan(start));\n@@ -1209,6 +1222,20 @@ export class _ParseAST {\n                                           `at the end of the expression`;\n   }\n \n+  /**\n+   * Records an error for an unexpected private identifier being discovered.\n+   * @param token Token representing a private identifier.\n+   * @param extraMessage Optional additional message being appended to the error.\n+   */\n+  private _reportErrorForPrivateIdentifier(token: Token, extraMessage: string|null) {\n+    let errorMessage =\n+        `Private identifiers are not supported. Unexpected private identifier: ${token}`;\n+    if (extraMessage !== null) {\n+      errorMessage += `, ${extraMessage}`;\n+    }\n+    this.error(errorMessage);\n+  }\n+\n   /**\n    * Error recovery should skip tokens until it encounters a recovery point.\n    *"
        },
        {
            "sha": "6946ff3d84b3d7dbbf9c7a1217cdf67a5d948225",
            "filename": "packages/compiler/test/expression_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 4,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Flexer_spec.ts?ref=3c726c35165a99fdb857bbe48a01705b6806f2ba",
            "patch": "@@ -47,6 +47,13 @@ function expectIdentifierToken(token: any, index: number, end: number, identifie\n   expect(token.toString()).toEqual(identifier);\n }\n \n+function expectPrivateIdentifierToken(token: any, index: number, end: number, identifier: string) {\n+  expectToken(token, index, end);\n+  expect(token.isPrivateIdentifier()).toBe(true);\n+  expect(token.toString()).toEqual(identifier);\n+}\n+\n+\n function expectKeywordToken(token: any, index: number, end: number, keyword: string) {\n   expectToken(token, index, end);\n   expect(token.isKeyword()).toBe(true);\n@@ -82,6 +89,31 @@ function expectErrorToken(token: Token, index: any, end: number, message: string\n         expectIdentifierToken(tokens[2], 2, 3, 'k');\n       });\n \n+      it('should tokenize a private identifier', () => {\n+        const tokens: number[] = lex('#a');\n+        expect(tokens.length).toEqual(1);\n+        expectPrivateIdentifierToken(tokens[0], 0, 2, '#a');\n+      });\n+\n+      it('should tokenize a property access with private identifier', () => {\n+        const tokens: number[] = lex('j.#k');\n+        expect(tokens.length).toEqual(3);\n+        expectIdentifierToken(tokens[0], 0, 1, 'j');\n+        expectCharacterToken(tokens[1], 1, 2, '.');\n+        expectPrivateIdentifierToken(tokens[2], 2, 4, '#k');\n+      });\n+\n+      it('should throw an invalid character error when a hash character is discovered but ' +\n+             'not indicating a private identifier',\n+         () => {\n+           expectErrorToken(\n+               lex('#')[0], 0, 1,\n+               `Lexer Error: Invalid character [#] at column 0 in expression [#]`);\n+           expectErrorToken(\n+               lex('#0')[0], 0, 1,\n+               `Lexer Error: Invalid character [#] at column 0 in expression [#0]`);\n+         });\n+\n       it('should tokenize an operator', () => {\n         const tokens: number[] = lex('j-k');\n         expect(tokens.length).toEqual(3);\n@@ -248,10 +280,6 @@ function expectErrorToken(token: Token, index: any, end: number, message: string\n             'Lexer Error: Invalid unicode escape [\\\\u1\\'\\'b] at column 2 in expression [\\'\\\\u1\\'\\'bla\\']');\n       });\n \n-      it('should tokenize hash as operator', () => {\n-        expectOperatorToken(lex('#')[0], 0, 1, '#');\n-      });\n-\n       it('should tokenize ?. as operator', () => {\n         expectOperatorToken(lex('?.')[0], 0, 2, '?.');\n       });"
        },
        {
            "sha": "f8134210591679b7796517ae5dbedc2db44b74c1",
            "filename": "packages/compiler/test/expression_parser/parser_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fexpression_parser%2Fparser_spec.ts?ref=3c726c35165a99fdb857bbe48a01705b6806f2ba",
            "patch": "@@ -120,6 +120,7 @@ describe('parser', () => {\n       it('should only allow identifier, string, or keyword as map key', () => {\n         expectActionError('{(:0}', 'expected identifier, keyword, or string');\n         expectActionError('{1234:0}', 'expected identifier, keyword, or string');\n+        expectActionError('{#myField:0}', 'expected identifier, keyword or string');\n       });\n     });\n \n@@ -130,11 +131,20 @@ describe('parser', () => {\n         checkAction('a.a');\n       });\n \n+      it('should error for private identifiers with implicit receiver', () => {\n+        checkActionWithError(\n+            '#privateField', '',\n+            'Private identifiers are not supported. Unexpected private identifier: #privateField at column 1');\n+      });\n+\n       it('should only allow identifier or keyword as member names', () => {\n         checkActionWithError('x.', 'x.', 'identifier or keyword');\n         checkActionWithError('x.(', 'x.', 'identifier or keyword');\n         checkActionWithError('x. 1234', 'x.', 'identifier or keyword');\n         checkActionWithError('x.\"foo\"', 'x.', 'identifier or keyword');\n+        checkActionWithError(\n+            'x.#privateField', 'x.',\n+            'Private identifiers are not supported. Unexpected private identifier: #privateField, expected identifier or keyword');\n       });\n \n       it('should parse safe field access', () => {\n@@ -511,6 +521,7 @@ describe('parser', () => {\n         expectBindingError('\"Foo\"|(', 'identifier or keyword');\n         expectBindingError('\"Foo\"|1234', 'identifier or keyword');\n         expectBindingError('\"Foo\"|\"uppercase\"', 'identifier or keyword');\n+        expectBindingError('\"Foo\"|#privateIdentifier\"', 'identifier or keyword');\n       });\n \n       it('should parse quoted expressions', () => {"
        },
        {
            "sha": "1c7a9116dc88a841df9efbccbf97c29c67e8c53d",
            "filename": "packages/compiler/test/template_parser/template_parser_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Ftest%2Ftemplate_parser%2Ftemplate_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3c726c35165a99fdb857bbe48a01705b6806f2ba/packages%2Fcompiler%2Ftest%2Ftemplate_parser%2Ftemplate_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Ftemplate_parser%2Ftemplate_parser_spec.ts?ref=3c726c35165a99fdb857bbe48a01705b6806f2ba",
            "patch": "@@ -1622,7 +1622,8 @@ Reference \"#a\" is defined several times (\"<div #a></div><div [ERROR ->]#a></div>\n     describe('inline templates', () => {\n       it('should report an error on variables declared with #', () => {\n         expect(() => humanizeTplAst(parse('<div *ngIf=\"#a=b\">', [])))\n-            .toThrowError(/Parser Error: Unexpected token # at column 1/);\n+            .toThrowError(\n+                /Parser Error: Private identifiers are not supported\\. Unexpected private identifier: #a at column 1/);\n       });\n \n       it('should parse variables via let ...', () => {"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 97,
        "deletions": 7
    }
}