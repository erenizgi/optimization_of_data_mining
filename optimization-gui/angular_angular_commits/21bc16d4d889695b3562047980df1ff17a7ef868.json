{
    "author": "H--o-l",
    "message": "fix(service-worker): handle error with console.error (#40236)\n\nThis commit reverts commit [_fix(service-worker): handle error with\nErrorHandler_](https://github.com/angular/angular/pull/39990/commits/552419d).\n\nWith Angular v11.0.4 and commit [_fix(service-worker): handle error with\nErrorHandler_](https://github.com/angular/angular/pull/39990/commits/552419d)\nAngular start to send all service worker registration errors to the Angular\nstandard `ErrorHandler#handleError()` interface, instead of logging them in the\nconsole.\nBut users existing `ErrorHandler#handleError()` implementations are not adapted\nto service worker registration errors and it might result in broken apps or\nbad UI.\nPassing to `ErrorHandler` is desirable for some and undesirable for others and\nthe same is true for passing to `console.error()`.\nBut `console.error()` was used for a long time and thus it is preferable to keep\nit as long as a good solution is not found with `ErrorHandler`.\n\nRight now it's hard to define a good solution for `ErrorHandler` because:\n\n1. Given the nature of the SW registration errors (usually outside the control\n   of the developer, different error messages on each browser/version, often\n   quite generic error messages, etc.), passing them to the `ErrorHandler` is\n   not particularly helpful.\n2. While `ErrorHandler#handleError()` accepts an argument of type `any` (so\n   theoretically we could pass any object without changing the public API), most\n   apps expect an `Error` instance, so many apps could break if we changed the\n   shape.\n3. Ideally, the Angular community want to re-think the `ErrorHandler` API\n   and add support for being able to pass additional metadata for each error\n   (such as the source of the error or some identifier, etc.). This change,\n   however, could potentially affect many apps out there, so the community must\n   put some thought into it and design it in a way that accounts for the needs\n   of all packages (not just the SW).\n4. Given that we want to more holistically revisit the `ErrorHandler` API, any\n   changes we make in the short term to address the issue just for the SW will\n   make it more difficult/breaky for people to move to a new API in the future.\n\nTo see the whole explanation see GitHub PR #40236.\n\nPR Close #40236",
    "sha": "21bc16d4d889695b3562047980df1ff17a7ef868",
    "files": [
        {
            "sha": "5f147181a696a3bd484a68291b0f5d12c206718a",
            "filename": "packages/service-worker/src/module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/21bc16d4d889695b3562047980df1ff17a7ef868/packages%2Fservice-worker%2Fsrc%2Fmodule.ts",
            "raw_url": "https://github.com/angular/angular/raw/21bc16d4d889695b3562047980df1ff17a7ef868/packages%2Fservice-worker%2Fsrc%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fsrc%2Fmodule.ts?ref=21bc16d4d889695b3562047980df1ff17a7ef868",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {isPlatformBrowser} from '@angular/common';\n-import {APP_INITIALIZER, ApplicationRef, ErrorHandler, InjectionToken, Injector, ModuleWithProviders, NgModule, NgZone, PLATFORM_ID} from '@angular/core';\n+import {APP_INITIALIZER, ApplicationRef, InjectionToken, Injector, ModuleWithProviders, NgModule, NgZone, PLATFORM_ID} from '@angular/core';\n import {merge, Observable, of} from 'rxjs';\n import {delay, filter, take} from 'rxjs/operators';\n \n@@ -128,10 +128,9 @@ export function ngswAppInitializer(\n     const ngZone = injector.get(NgZone);\n     ngZone.runOutsideAngular(\n         () => readyToRegister$.pipe(take(1)).subscribe(\n-            () => navigator.serviceWorker.register(script, {scope: options.scope}).catch(err => {\n-              const errorHandler = injector.get(ErrorHandler);\n-              errorHandler.handleError(err);\n-            })));\n+            () =>\n+                navigator.serviceWorker.register(script, {scope: options.scope})\n+                    .catch(err => console.error('Service worker registration failed with:', err))));\n   };\n   return initializer;\n }"
        },
        {
            "sha": "bb46214f3224afe7b5ad15d6a710ddee8dff6077",
            "filename": "packages/service-worker/test/module_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/21bc16d4d889695b3562047980df1ff17a7ef868/packages%2Fservice-worker%2Ftest%2Fmodule_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/21bc16d4d889695b3562047980df1ff17a7ef868/packages%2Fservice-worker%2Ftest%2Fmodule_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Ftest%2Fmodule_spec.ts?ref=21bc16d4d889695b3562047980df1ff17a7ef868",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ApplicationRef, ErrorHandler, PLATFORM_ID} from '@angular/core';\n+import {ApplicationRef, PLATFORM_ID} from '@angular/core';\n import {fakeAsync, flushMicrotasks, TestBed, tick} from '@angular/core/testing';\n import {Subject} from 'rxjs';\n import {filter, take} from 'rxjs/operators';\n@@ -21,7 +21,6 @@ describe('ServiceWorkerModule', () => {\n     return;\n   }\n \n-  let errorHandlerSpy: jasmine.Spy;\n   let swRegisterSpy: jasmine.Spy;\n \n   const untilStable = () => {\n@@ -35,14 +34,9 @@ describe('ServiceWorkerModule', () => {\n \n   describe('register()', () => {\n     const configTestBed = async (opts: SwRegistrationOptions) => {\n-      const errorHandler = {handleError: () => {}};\n-      errorHandlerSpy = spyOn(errorHandler, 'handleError');\n       TestBed.configureTestingModule({\n         imports: [ServiceWorkerModule.register('sw.js', opts)],\n-        providers: [\n-          {provide: ErrorHandler, useValue: errorHandler},\n-          {provide: PLATFORM_ID, useValue: 'browser'},\n-        ],\n+        providers: [{provide: PLATFORM_ID, useValue: 'browser'}],\n       });\n \n       await untilStable();\n@@ -77,10 +71,12 @@ describe('ServiceWorkerModule', () => {\n     });\n \n     it('catches and a logs registration errors', async () => {\n+      const consoleErrorSpy = spyOn(console, 'error');\n       swRegisterSpy.and.returnValue(Promise.reject('no reason'));\n \n       await configTestBed({enabled: true, scope: 'foo'});\n-      expect(errorHandlerSpy).toHaveBeenCalledWith('no reason');\n+      expect(consoleErrorSpy)\n+          .toHaveBeenCalledWith('Service worker registration failed with:', 'no reason');\n     });\n   });\n "
        }
    ],
    "stats": {
        "total": 23,
        "additions": 9,
        "deletions": 14
    }
}