{
    "author": "josephperrott",
    "message": "feat(dev-infra): tooling to check out pending PR (#38474)\n\nCreates a tool within ng-dev to checkout a pending PR from the upstream repository.  This automates\nan action that many developers on the Angular team need to do periodically in the process of testing\nand reviewing incoming PRs.\n\nExample usage:\n  ng-dev pr checkout <pr-number>\n\nPR Close #38474",
    "sha": "63ba74fe4e7f5ea9cb07b866647488cb76adf066",
    "files": [
        {
            "sha": "bd2aaaa512fcc77473cc8cc17817c1e68006cecc",
            "filename": "dev-infra/pr/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2FBUILD.bazel?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     module_name = \"@angular/dev-infra-private/pr\",\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n+        \"//dev-infra/pr/checkout\",\n         \"//dev-infra/pr/discover-new-conflicts\",\n         \"//dev-infra/pr/merge\",\n         \"//dev-infra/pr/rebase\","
        },
        {
            "sha": "b6ce76177dd358dadeff95322b5b63680dae98ba",
            "filename": "dev-infra/pr/checkout/BUILD.bazel",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcheckout%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcheckout%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheckout%2FBUILD.bazel?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -0,0 +1,13 @@\n+load(\"@npm_bazel_typescript//:index.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"checkout\",\n+    srcs = glob([\"*.ts\"]),\n+    module_name = \"@angular/dev-infra-private/pr/checkout\",\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/pr/common\",\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/yargs\",\n+    ],\n+)"
        },
        {
            "sha": "de9d8b59f8795c50b359913afd60527b48f0fc21",
            "filename": "dev-infra/pr/checkout/cli.ts",
            "status": "added",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcheckout%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcheckout%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcheckout%2Fcli.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -0,0 +1,50 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {Arguments, Argv, CommandModule} from 'yargs';\n+\n+import {error} from '../../utils/console';\n+import {checkOutPullRequestLocally} from '../common/checkout-pr';\n+\n+export interface CheckoutOptions {\n+  prNumber: number;\n+  'github-token'?: string;\n+}\n+\n+/** URL to the Github page where personal access tokens can be generated. */\n+export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens`;\n+\n+/** Builds the checkout pull request command. */\n+function builder(yargs: Argv) {\n+  return yargs.positional('prNumber', {type: 'number', demandOption: true}).option('github-token', {\n+    type: 'string',\n+    description: 'Github token. If not set, token is retrieved from the environment variables.'\n+  });\n+}\n+\n+/** Handles the checkout pull request command. */\n+async function handler({prNumber, 'github-token': token}: Arguments<CheckoutOptions>) {\n+  const githubToken = token || process.env.GITHUB_TOKEN || process.env.TOKEN;\n+  if (!githubToken) {\n+    error('No Github token set. Please set the `GITHUB_TOKEN` environment variable.');\n+    error('Alternatively, pass the `--github-token` command line flag.');\n+    error(`You can generate a token here: ${GITHUB_TOKEN_GENERATE_URL}`);\n+    process.exitCode = 1;\n+    return;\n+  }\n+  const prCheckoutOptions = {allowIfMaintainerCannotModify: true, branchName: `pr-${prNumber}`};\n+  await checkOutPullRequestLocally(prNumber, githubToken, prCheckoutOptions);\n+}\n+\n+/** yargs command module for checking out a PR  */\n+export const CheckoutCommandModule: CommandModule<{}, CheckoutOptions> = {\n+  handler,\n+  builder,\n+  command: 'checkout <pr-number>',\n+  describe: 'Checkout a PR from the upstream repo',\n+};"
        },
        {
            "sha": "fb080ed5c299b4536070dddfb824d9aff9ef52c5",
            "filename": "dev-infra/pr/cli.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcli.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -8,6 +8,7 @@\n \n import * as yargs from 'yargs';\n \n+import {CheckoutCommandModule} from './checkout/cli';\n import {buildDiscoverNewConflictsCommand, handleDiscoverNewConflictsCommand} from './discover-new-conflicts/cli';\n import {buildMergeCommand, handleMergeCommand} from './merge/cli';\n import {buildRebaseCommand, handleRebaseCommand} from './rebase/cli';\n@@ -24,7 +25,8 @@ export function buildPrParser(localYargs: yargs.Argv) {\n           buildDiscoverNewConflictsCommand, handleDiscoverNewConflictsCommand)\n       .command(\n           'rebase <pr-number>', 'Rebase a pending PR and push the rebased commits back to Github',\n-          buildRebaseCommand, handleRebaseCommand);\n+          buildRebaseCommand, handleRebaseCommand)\n+      .command(CheckoutCommandModule);\n }\n \n if (require.main === module) {"
        },
        {
            "sha": "a25c3b90eacdb8f65092264636ab0dd27e5d8ce8",
            "filename": "dev-infra/pr/common/BUILD.bazel",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcommon%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcommon%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcommon%2FBUILD.bazel?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -0,0 +1,12 @@\n+load(\"@npm_bazel_typescript//:index.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"common\",\n+    srcs = glob([\"*.ts\"]),\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/node\",\n+        \"@npm//typed-graphqlify\",\n+    ],\n+)"
        },
        {
            "sha": "5fd8a4a36fa3ef42337e8d7a6ea075a875fcd110",
            "filename": "dev-infra/pr/common/checkout-pr.ts",
            "status": "added",
            "additions": 135,
            "deletions": 0,
            "changes": 135,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fcommon%2Fcheckout-pr.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -0,0 +1,135 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {types as graphQLTypes} from 'typed-graphqlify';\n+import {URL} from 'url';\n+\n+import {info} from '../../utils/console';\n+import {GitClient} from '../../utils/git';\n+import {getPr} from '../../utils/github';\n+\n+/* GraphQL schema for the response body for a pending PR. */\n+const PR_SCHEMA = {\n+  state: graphQLTypes.string,\n+  maintainerCanModify: graphQLTypes.boolean,\n+  viewerDidAuthor: graphQLTypes.boolean,\n+  headRefOid: graphQLTypes.string,\n+  headRef: {\n+    name: graphQLTypes.string,\n+    repository: {\n+      url: graphQLTypes.string,\n+      nameWithOwner: graphQLTypes.string,\n+    },\n+  },\n+  baseRef: {\n+    name: graphQLTypes.string,\n+    repository: {\n+      url: graphQLTypes.string,\n+      nameWithOwner: graphQLTypes.string,\n+    },\n+  },\n+};\n+\n+\n+export class UnexpectedLocalChangesError extends Error {\n+  constructor(m: string) {\n+    super(m);\n+    Object.setPrototypeOf(this, UnexpectedLocalChangesError.prototype);\n+  }\n+}\n+\n+export class MaintainerModifyAccessError extends Error {\n+  constructor(m: string) {\n+    super(m);\n+    Object.setPrototypeOf(this, MaintainerModifyAccessError.prototype);\n+  }\n+}\n+\n+/** Options for checking out a PR */\n+export interface PullRequestCheckoutOptions {\n+  /** Whether the PR should be checked out if the maintainer cannot modify. */\n+  allowIfMaintainerCannotModify?: boolean;\n+}\n+\n+/**\n+ * Rebase the provided PR onto its merge target branch, and push up the resulting\n+ * commit to the PRs repository.\n+ */\n+export async function checkOutPullRequestLocally(\n+    prNumber: number, githubToken: string, opts: PullRequestCheckoutOptions = {}) {\n+  /** Authenticated Git client for git and Github interactions. */\n+  const git = new GitClient(githubToken);\n+\n+  // In order to preserve local changes, checkouts cannot occur if local changes are present in the\n+  // git environment. Checked before retrieving the PR to fail fast.\n+  if (git.hasLocalChanges()) {\n+    throw new UnexpectedLocalChangesError('Unable to checkout PR due to uncommitted changes.');\n+  }\n+\n+  /**\n+   * The branch or revision originally checked out before this method performed\n+   * any Git operations that may change the working branch.\n+   */\n+  const previousBranchOrRevision = git.getCurrentBranchOrRevision();\n+  /* The PR information from Github. */\n+  const pr = await getPr(PR_SCHEMA, prNumber, git);\n+  /** The branch name of the PR from the repository the PR came from. */\n+  const headRefName = pr.headRef.name;\n+  /** The full ref for the repository and branch the PR came from. */\n+  const fullHeadRef = `${pr.headRef.repository.nameWithOwner}:${headRefName}`;\n+  /** The full URL path of the repository the PR came from with github token as authentication. */\n+  const headRefUrl = addAuthenticationToUrl(pr.headRef.repository.url, githubToken);\n+  // Note: Since we use a detached head for rebasing the PR and therefore do not have\n+  // remote-tracking branches configured, we need to set our expected ref and SHA. This\n+  // allows us to use `--force-with-lease` for the detached head while ensuring that we\n+  // never accidentally override upstream changes that have been pushed in the meanwhile.\n+  // See:\n+  // https://git-scm.com/docs/git-push#Documentation/git-push.txt---force-with-leaseltrefnamegtltexpectgt\n+  /** Flag for a force push with leage back to upstream. */\n+  const forceWithLeaseFlag = `--force-with-lease=${headRefName}:${pr.headRefOid}`;\n+\n+  // If the PR does not allow maintainers to modify it, exit as the rebased PR cannot\n+  // be pushed up.\n+  if (!pr.maintainerCanModify && !pr.viewerDidAuthor && !opts.allowIfMaintainerCannotModify) {\n+    throw new MaintainerModifyAccessError('PR is not set to allow maintainers to modify the PR');\n+  }\n+\n+  try {\n+    // Fetch the branch at the commit of the PR, and check it out in a detached state.\n+    info(`Checking out PR #${prNumber} from ${fullHeadRef}`);\n+    git.run(['fetch', headRefUrl, headRefName]);\n+    git.run(['checkout', '--detach', 'FETCH_HEAD']);\n+  } catch (e) {\n+    git.checkout(previousBranchOrRevision, true);\n+    throw e;\n+  }\n+\n+  return {\n+    /**\n+     * Pushes the current local branch to the PR on the upstream repository.\n+     *\n+     * @returns true If the command did not fail causing a GitCommandError to be thrown.\n+     * @throws GitCommandError Thrown when the push back to upstream fails.\n+     */\n+    pushToUpstream: (): true => {\n+      git.run(['push', headRefUrl, `HEAD:${headRefName}`, forceWithLeaseFlag]);\n+      return true;\n+    },\n+    /** Restores the state of the local repository to before the PR checkout occured. */\n+    resetGitState: (): boolean => {\n+      return git.checkout(previousBranchOrRevision, true);\n+    }\n+  };\n+}\n+\n+/** Adds the provided token as username to the provided url. */\n+function addAuthenticationToUrl(urlString: string, token: string) {\n+  const url = new URL(urlString);\n+  url.username = token;\n+  return url.toString();\n+}"
        },
        {
            "sha": "c59f1a069823173fc89a968217c887ac7e800963",
            "filename": "dev-infra/pr/discover-new-conflicts/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -72,7 +72,7 @@ export async function discoverNewConflictsForPr(\n \n   info(`Requesting pending PRs from Github`);\n   /** List of PRs from github currently known as mergable. */\n-  const allPendingPRs = (await getPendingPrs(PR_SCHEMA, config.github)).map(processPr);\n+  const allPendingPRs = (await getPendingPrs(PR_SCHEMA, git)).map(processPr);\n   /** The PR which is being checked against. */\n   const requestedPr = allPendingPRs.find(pr => pr.number === newPrNumber);\n   if (requestedPr === undefined) {"
        },
        {
            "sha": "149de6513a2503be510f301f61a11111959bcebd",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -55,7 +55,7 @@ export async function rebasePr(\n    */\n   const previousBranchOrRevision = git.getCurrentBranchOrRevision();\n   /* Get the PR information from Github. */\n-  const pr = await getPr(PR_SCHEMA, prNumber, config.github);\n+  const pr = await getPr(PR_SCHEMA, prNumber, git);\n \n   const headRefName = pr.headRef.name;\n   const baseRefName = pr.baseRef.name;"
        },
        {
            "sha": "cea6979cd79e05a275306abbda762fc5b16ea862",
            "filename": "dev-infra/utils/git/github.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -26,7 +26,7 @@ export class GithubApiRequestError extends Error {\n  **/\n export class GithubClient extends Octokit {\n   /** The Github GraphQL (v4) API. */\n-  graqhql: GithubGraphqlClient;\n+  graphql: GithubGraphqlClient;\n \n   /** The current user based on checking against the Github API. */\n   private _currentUser: string|null = null;\n@@ -42,7 +42,7 @@ export class GithubClient extends Octokit {\n     });\n \n     // Create authenticated graphql client.\n-    this.graqhql = new GithubGraphqlClient(token);\n+    this.graphql = new GithubGraphqlClient(token);\n   }\n \n   /** Retrieve the login of the current user from Github. */\n@@ -51,7 +51,7 @@ export class GithubClient extends Octokit {\n     if (this._currentUser !== null) {\n       return this._currentUser;\n     }\n-    const result = await this.graqhql.query({\n+    const result = await this.graphql.query({\n       viewer: {\n         login: types.string,\n       }\n@@ -80,7 +80,7 @@ class GithubGraphqlClient {\n     // Set the default headers to include authorization with the provided token for all\n     // graphQL calls.\n     if (token) {\n-      this.graqhql.defaults({headers: {authorization: `token ${token}`}});\n+      this.graqhql = this.graqhql.defaults({headers: {authorization: `token ${token}`}});\n     }\n   }\n "
        },
        {
            "sha": "93364731adc0133cde7f88cbfa0bcf1997a82147",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -150,6 +150,25 @@ export class GitClient {\n     return value.replace(this._githubTokenRegex, '<TOKEN>');\n   }\n \n+  /**\n+   * Checks out a requested branch or revision, optionally cleaning the state of the repository\n+   * before attempting the checking. Returns a boolean indicating whether the branch or revision\n+   * was cleanly checked out.\n+   */\n+  checkout(branchOrRevision: string, cleanState: boolean): boolean {\n+    if (cleanState) {\n+      // Abort any outstanding ams.\n+      this.runGraceful(['am', '--abort'], {stdio: 'ignore'});\n+      // Abort any outstanding cherry-picks.\n+      this.runGraceful(['cherry-pick', '--abort'], {stdio: 'ignore'});\n+      // Abort any outstanding rebases.\n+      this.runGraceful(['rebase', '--abort'], {stdio: 'ignore'});\n+      // Clear any changes in the current repo.\n+      this.runGraceful(['reset', '--hard'], {stdio: 'ignore'});\n+    }\n+    return this.runGraceful(['checkout', branchOrRevision], {stdio: 'ignore'}).status === 0;\n+  }\n+\n   /**\n    * Assert the GitClient instance is using a token with permissions for the all of the\n    * provided OAuth scopes."
        },
        {
            "sha": "7e187a24a4d93be2e350e083f46df2515258aff2",
            "filename": "dev-infra/utils/github.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 49,
            "changes": 71,
            "blob_url": "https://github.com/angular/angular/blob/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Futils%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/63ba74fe4e7f5ea9cb07b866647488cb76adf066/dev-infra%2Futils%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgithub.ts?ref=63ba74fe4e7f5ea9cb07b866647488cb76adf066",
            "patch": "@@ -6,29 +6,15 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {graphql as unauthenticatedGraphql} from '@octokit/graphql';\n+import {params, types} from 'typed-graphqlify';\n \n-import {params, query as graphqlQuery, types} from 'typed-graphqlify';\n-import {NgDevConfig} from './config';\n-\n-/** The configuration required for github interactions. */\n-type GithubConfig = NgDevConfig['github'];\n-\n-/**\n- * Authenticated instance of Github GraphQl API service, relies on a\n- * personal access token being available in the TOKEN environment variable.\n- */\n-const graphql = unauthenticatedGraphql.defaults({\n-  headers: {\n-    // TODO(josephperrott): Remove reference to TOKEN environment variable as part of larger\n-    // effort to migrate to expecting tokens via GITHUB_ACCESS_TOKEN environment variables.\n-    authorization: `token ${process.env.TOKEN || process.env.GITHUB_ACCESS_TOKEN}`,\n-  }\n-});\n+import {GitClient} from './git';\n \n /** Get a PR from github  */\n-export async function getPr<PrSchema>(\n-    prSchema: PrSchema, prNumber: number, {owner, name}: GithubConfig) {\n+export async function getPr<PrSchema>(prSchema: PrSchema, prNumber: number, git: GitClient) {\n+  /** The owner and name of the repository */\n+  const {owner, name} = git.remoteConfig;\n+  /** The GraphQL query object to get a the PR */\n   const PR_QUERY = params(\n       {\n         $number: 'Int!',    // The PR number\n@@ -41,14 +27,15 @@ export async function getPr<PrSchema>(\n         })\n       });\n \n-  const result =\n-      await graphql(graphqlQuery(PR_QUERY), {number: prNumber, owner, name}) as typeof PR_QUERY;\n+  const result = (await git.github.graphql.query(PR_QUERY, {number: prNumber, owner, name}));\n   return result.repository.pullRequest;\n }\n \n /** Get all pending PRs from github  */\n-export async function getPendingPrs<PrSchema>(prSchema: PrSchema, {owner, name}: GithubConfig) {\n-  // The GraphQL query object to get a page of pending PRs\n+export async function getPendingPrs<PrSchema>(prSchema: PrSchema, git: GitClient) {\n+  /** The owner and name of the repository */\n+  const {owner, name} = git.remoteConfig;\n+  /** The GraphQL query object to get a page of pending PRs */\n   const PRS_QUERY = params(\n       {\n         $first: 'Int',      // How many entries to get with each request\n@@ -73,36 +60,22 @@ export async function getPendingPrs<PrSchema>(prSchema: PrSchema, {owner, name}:\n               }),\n         })\n       });\n-  const query = graphqlQuery('members', PRS_QUERY);\n-\n-  /**\n-   * Gets the query and queryParams for a specific page of entries.\n-   */\n-  const queryBuilder = (count: number, cursor?: string) => {\n-    return {\n-      query,\n-      params: {\n-        after: cursor || null,\n-        first: count,\n-        owner,\n-        name,\n-      },\n-    };\n-  };\n-\n-  // The current cursor\n+  /** The current cursor */\n   let cursor: string|undefined;\n-  // If an additional page of members is expected\n+  /** If an additional page of members is expected */\n   let hasNextPage = true;\n-  // Array of pending PRs\n+  /** Array of pending PRs */\n   const prs: Array<PrSchema> = [];\n \n-  // For each page of the response, get the page and add it to the\n-  // list of PRs\n+  // For each page of the response, get the page and add it to the list of PRs\n   while (hasNextPage) {\n-    const {query, params} = queryBuilder(100, cursor);\n-    const results = await graphql(query, params) as typeof PRS_QUERY;\n-\n+    const params = {\n+      after: cursor || null,\n+      first: 100,\n+      owner,\n+      name,\n+    };\n+    const results = await git.github.graphql.query(PRS_QUERY, params) as typeof PRS_QUERY;\n     prs.push(...results.repository.pullRequests.nodes);\n     hasNextPage = results.repository.pullRequests.pageInfo.hasNextPage;\n     cursor = results.repository.pullRequests.pageInfo.endCursor;"
        }
    ],
    "stats": {
        "total": 317,
        "additions": 261,
        "deletions": 56
    }
}