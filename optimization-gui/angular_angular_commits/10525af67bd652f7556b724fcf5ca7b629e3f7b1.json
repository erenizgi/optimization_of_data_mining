{
    "author": "petebacondarwin",
    "message": "test(compiler-cli): generate golden files for partial compilation (#39617)\n\nThis commit adds a JS script that can generate a partial golden file\nfor test cases in the compiler compliance tests.\n\nPR Close #39617",
    "sha": "10525af67bd652f7556b724fcf5ca7b629e3f7b1",
    "files": [
        {
            "sha": "f88cbea5711d8de0341bfe1ad6bfd48b1bb0f8b0",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -753,11 +753,11 @@ jobs:\n       - setup_win\n       - run:\n           name: Build all windows CI targets\n-          command: yarn bazel build --build_tag_filters=-ivy-only //packages/compiler-cli/... //tools/ts-api-guardian/...\n+          command: yarn bazel build --build_tag_filters=-ivy-only,-no-windows //packages/compiler-cli/... //tools/ts-api-guardian/...\n           no_output_timeout: 15m\n       - run:\n           name: Test all windows CI targets\n-          command: yarn bazel test --test_tag_filters=\"-ivy-only,-browser:chromium-local\" //packages/compiler-cli/... //tools/ts-api-guardian/...\n+          command: yarn bazel test --build_tag_filters=-no-windows --test_tag_filters=\"-ivy-only,-no-windows,-browser:chromium-local\" //packages/compiler-cli/... //tools/ts-api-guardian/...\n           no_output_timeout: 15m\n \n   test_ivy_aot_win:\n@@ -766,11 +766,11 @@ jobs:\n       - setup_win\n       - run:\n           name: Build all windows CI targets\n-          command: yarn bazel build --config=ivy --build_tag_filters=-no-ivy-aot,-fixme-ivy-aot //packages/compiler-cli/... //tools/ts-api-guardian/...\n+          command: yarn bazel build --config=ivy --build_tag_filters=-no-ivy-aot,-no-windows,-fixme-ivy-aot //packages/compiler-cli/... //tools/ts-api-guardian/...\n           no_output_timeout: 15m\n       - run:\n           name: Test all windows CI targets\n-          command: yarn bazel test --config=ivy --test_tag_filters=\"-no-ivy-aot,-fixme-ivy-aot,-browser:chromium-local\" //packages/compiler-cli/... //tools/ts-api-guardian/...\n+          command: yarn bazel test --config=ivy --build_tag_filters=-no-windows --test_tag_filters=\"-no-ivy-aot,-no-windows,-fixme-ivy-aot,-browser:chromium-local\" //packages/compiler-cli/... //tools/ts-api-guardian/...\n           no_output_timeout: 15m\n \n "
        },
        {
            "sha": "f9cee0317478331b466a04d3d6f3bb8c599bd331",
            "filename": "packages/compiler-cli/test/compliance/partial/BUILD.bazel",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2FBUILD.bazel?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -0,0 +1,19 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"generate_golden_partial_lib\",\n+    testonly = True,\n+    srcs = [\n+        \"cli.ts\",\n+        \"generate_golden_partial.ts\",\n+    ],\n+    visibility = [\"//packages/compiler-cli/test/compliance:__subpackages__\"],\n+    deps = [\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/test/compliance/test_helpers\",\n+    ],\n+)\n+\n+exports_files([\n+    \"cli.ts\",\n+])"
        },
        {
            "sha": "afcd0eb002a2384aad857112e2df9e3d6699c796",
            "filename": "packages/compiler-cli/test/compliance/partial/cli.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fcli.ts?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {generateGoldenPartial} from './generate_golden_partial';\n+\n+generateGoldenPartial(process.argv[2]);"
        },
        {
            "sha": "4daa4926e3e68ab2bcde4504a7991fd0fd883a4a",
            "filename": "packages/compiler-cli/test/compliance/partial/generate_golden_partial.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fgenerate_golden_partial.ts",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fgenerate_golden_partial.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fgenerate_golden_partial.ts?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -0,0 +1,59 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {FileSystem} from '../../../src/ngtsc/file_system';\n+import {compileTest, getBuildOutputDirectory, initMockTestFileSystem} from '../test_helpers/compile_test';\n+import {ComplianceTest, getComplianceTests} from '../test_helpers/get_compliance_tests';\n+import {PartiallyCompiledFile, renderGoldenPartial} from '../test_helpers/golden_partials';\n+\n+/**\n+ * Generate the golden partial output for the tests described in the `testConfigPath` config file.\n+ *\n+ * @param testConfigPath Path (relative to the `test_cases` directory) of the `TEST_CASES.json` file\n+ *     that describes the tests.\n+ */\n+export function generateGoldenPartial(testConfigPath: string): void {\n+  const files: PartiallyCompiledFile[] = [];\n+  const tests = getComplianceTests(testConfigPath);\n+  for (const test of tests) {\n+    const fs = initMockTestFileSystem(test.realTestPath);\n+    for (const file of compilePartials(fs, test)) {\n+      files.push(file);\n+    }\n+  }\n+  writeGoldenPartial(files);\n+}\n+\n+/**\n+ * Partially compile the source files specified by the given `test`.\n+ *\n+ * @param fs The mock file-system to use when compiling partials.\n+ * @param test The information about the test being compiled.\n+ */\n+function* compilePartials(fs: FileSystem, test: ComplianceTest): Generator<PartiallyCompiledFile> {\n+  const builtDirectory = getBuildOutputDirectory(fs);\n+  for (const generatedPath of compileTest(\n+           fs, test.inputFiles, test.compilerOptions,\n+           {compilationMode: 'partial', ...test.angularCompilerOptions})) {\n+    yield {\n+      path: fs.relative(builtDirectory, generatedPath),\n+      content: fs.readFile(generatedPath),\n+    };\n+  }\n+}\n+\n+/**\n+ * Write the partially compiled files to the appropriate output destination.\n+ *\n+ * For now just push the concatenated partial files to standard out.\n+ *\n+ * @param files The partially compiled files.\n+ */\n+function writeGoldenPartial(files: PartiallyCompiledFile[]): void {\n+  // tslint:disable-next-line: no-console\n+  console.log(renderGoldenPartial(files));\n+}"
        },
        {
            "sha": "edbf9029dc1cd9c78152c04e038eca3d77200aef",
            "filename": "packages/compiler-cli/test/compliance/partial/partial_compliance_goldens.bzl",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fpartial_compliance_goldens.bzl",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fpartial_compliance_goldens.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Fpartial%2Fpartial_compliance_goldens.bzl?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -0,0 +1,54 @@\n+load(\"@build_bazel_rules_nodejs//:index.bzl\", \"generated_file_test\", \"nodejs_binary\", \"npm_package_bin\")\n+\n+def partial_compliance_golden(filePath):\n+    \"\"\"Creates the generate and testing targets for partial compile results.\n+    \"\"\"\n+\n+    # Remove the \"TEST_CASES.json\" substring from the end of the provided path.\n+    path = filePath[:-len(\"/TEST_CASES.json\")]\n+\n+    nodejs_binary(\n+        name = \"_generate_%s\" % path,\n+        testonly = True,\n+        data = [\n+            \"//packages/compiler-cli/test/compliance/partial:generate_golden_partial_lib\",\n+            \"//packages/compiler-cli/test/compliance/test_cases\",\n+            \"//packages/compiler-cli/test/ngtsc/fake_core:npm_package\",\n+        ],\n+        visibility = [\":__pkg__\"],\n+        entry_point = \"//packages/compiler-cli/test/compliance/partial:cli.ts\",\n+        templated_args = [\n+            # \"--node_options=--inspect-brk\",\n+            filePath,\n+        ],\n+    )\n+\n+    npm_package_bin(\n+        name = \"_generated_%s\" % path,\n+        tool = \"_generate_%s\" % path,\n+        testonly = True,\n+        stdout = \"%s/this_file_should_not_be_committed\" % path,\n+        link_workspace_root = True,\n+        tags = [\n+            # TODO(josephperrott): Begin running these tests on windows after updating to rules_nodejs 3.0\n+            \"no-windows\",\n+        ],\n+        visibility = [\":__pkg__\"],\n+        data = [\n+            \"//packages/compiler-cli/test/compliance/partial:generate_golden_partial_lib\",\n+            \"//packages/compiler-cli/test/compliance/test_cases\",\n+            \"//packages/compiler-cli/test/ngtsc/fake_core:npm_package\",\n+        ],\n+    )\n+\n+    generated_file_test(\n+        visibility = [\"//visibility:public\"],\n+        tags = [\n+            \"ivy-only\",\n+            # TODO(josephperrott): Begin running these tests on windows after updating to rules_nodejs 3.0\n+            \"no-windows\",\n+        ],\n+        name = \"%s.golden\" % path,\n+        src = \"//packages/compiler-cli/test/compliance/test_cases:%s/GOLDEN_PARTIAL.js\" % path,\n+        generated = \"_generated_%s\" % path,\n+    )"
        },
        {
            "sha": "51d995fb081c38e956c9b00c515ef5f6209157cd",
            "filename": "packages/compiler-cli/test/compliance/test_cases/BUILD.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2FBUILD.bazel?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -1,4 +1,5 @@\n load(\"@build_bazel_rules_nodejs//:index.bzl\", \"copy_to_bin\")\n+load(\"//packages/compiler-cli/test/compliance/partial:partial_compliance_goldens.bzl\", \"partial_compliance_golden\")\n \n package(default_visibility = [\"//packages/compiler-cli/test/compliance:__subpackages__\"])\n \n@@ -9,3 +10,5 @@ copy_to_bin(\n     name = \"test_cases\",\n     srcs = glob([\"*/**\"]),\n )\n+\n+[partial_compliance_golden(filePath = path) for path in glob(include = [\"**/TEST_CASES.json\"])]"
        },
        {
            "sha": "579d9cdb06755af4fa5b88b5716ac1c431fcb3fd",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/golden_partials.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fgolden_partials.ts",
            "raw_url": "https://github.com/angular/angular/raw/10525af67bd652f7556b724fcf5ca7b629e3f7b1/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fgolden_partials.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fgolden_partials.ts?ref=10525af67bd652f7556b724fcf5ca7b629e3f7b1",
            "patch": "@@ -0,0 +1,49 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+const headerStart =\n+    '/****************************************************************************************************\\n' +\n+    ' * PARTIAL FILE: ';\n+\n+const headerEnd =\n+    '\\n ****************************************************************************************************/';\n+\n+/**\n+ * Render the partially compiled files into a single golden partial output string.\n+ *\n+ * @param files The partially compiled files to be rendered.\n+ */\n+export function renderGoldenPartial(files: PartiallyCompiledFile[]): string {\n+  return files.map(file => `${headerStart + file.path + headerEnd}\\n${file.content}`).join('\\n');\n+}\n+\n+/**\n+ * Parse the `partialContent` into a set of partially compiled files.\n+ *\n+ * The `partialContent` is a single string that can contains multiple files.\n+ * Each file is delimited by a header comment that also contains its original path.\n+ *\n+ * @param partialContent The partial content to parse.\n+ */\n+export function parseGoldenPartial(partialContent: string): PartiallyCompiledFile[] {\n+  const files: PartiallyCompiledFile[] = [];\n+  const partials = partialContent.split(headerStart);\n+  for (const partial of partials) {\n+    const [path, content] = partial.split(headerEnd);\n+    files.push({path, content});\n+  }\n+  return files;\n+}\n+\n+/**\n+ * Represents the path and contents of a partially compiled file.\n+ */\n+export interface PartiallyCompiledFile {\n+  path: string;\n+  content: string;\n+}"
        }
    ],
    "stats": {
        "total": 202,
        "additions": 198,
        "deletions": 4
    }
}