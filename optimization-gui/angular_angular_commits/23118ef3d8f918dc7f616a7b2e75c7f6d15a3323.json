{
    "author": "devversion",
    "message": "refactor(compiler-cli): fix ngcc cluster workers incorrectly being marked as busy with ESM (#43431)\n\nNgcc relies on cluster for distributing work. The master controller\nsends messages to the workers as soon as the worker becomes `online`.\nThe online event is sent as part of the NodeJS cluster logic itself.\n\nThis does not work well because technically `online` could emit before the\nworker started listening (this seems to be case now with ESM as the\nimports are loaded in a way where `online` emits too early; before the\nworker actually listens for messages).\n\nWe fix this by explicitly notifying the master when the worker\nis ready for retrieving IPC messages/or tasks. This is more safe\nanyway as it's not clearly specified when `online` emits.\n\nPR Close #43431",
    "sha": "23118ef3d8f918dc7f616a7b2e75c7f6d15a3323",
    "files": [
        {
            "sha": "4c8bc5d9c10758eea997eba2aff4777c814f801e",
            "filename": "packages/compiler-cli/ngcc/src/execution/cluster/api.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fapi.ts?ref=23118ef3d8f918dc7f616a7b2e75c7f6d15a3323",
            "patch": "@@ -11,6 +11,10 @@ import {JsonObject} from '../../packages/entry_point';\n import {PackageJsonChange} from '../../writing/package_json_updater';\n import {Task, TaskProcessingOutcome} from '../tasks/api';\n \n+/** A message reporting that the worker is ready for retrieving tasks. */\n+export interface ReadyMessage extends JsonObject {\n+  type: 'ready';\n+}\n \n /** A message reporting that an unrecoverable error occurred. */\n export interface ErrorMessage extends JsonObject {\n@@ -51,7 +55,7 @@ export interface UpdatePackageJsonMessage extends JsonObject {\n \n /** The type of messages sent from cluster workers to the cluster master. */\n export type MessageFromWorker =\n-    ErrorMessage|TaskCompletedMessage|TransformedFilesMessage|UpdatePackageJsonMessage;\n+    ReadyMessage|ErrorMessage|TaskCompletedMessage|TransformedFilesMessage|UpdatePackageJsonMessage;\n \n /** The type of messages sent from the cluster master to cluster workers. */\n export type MessageToWorker = ProcessTaskMessage;"
        },
        {
            "sha": "da775b6bba8b9297356b65fc9d65380d6da0a827",
            "filename": "packages/compiler-cli/ngcc/src/execution/cluster/master.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fmaster.ts",
            "raw_url": "https://github.com/angular/angular/raw/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fmaster.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fmaster.ts?ref=23118ef3d8f918dc7f616a7b2e75c7f6d15a3323",
            "patch": "@@ -56,8 +56,6 @@ export class ClusterMaster {\n     }\n \n     // Set up listeners for worker events (emitted on `cluster`).\n-    cluster.on('online', this.wrapEventHandler(worker => this.onWorkerOnline(worker.id)));\n-\n     cluster.on(\n         'message', this.wrapEventHandler((worker, msg) => this.onWorkerMessage(worker.id, msg)));\n \n@@ -199,6 +197,14 @@ export class ClusterMaster {\n \n   /** Handle a message from a worker. */\n   private onWorkerMessage(workerId: number, msg: MessageFromWorker): void {\n+    // A worker is now ready and can retrieve a processing task.\n+    if (msg.type === 'ready') {\n+      this.onWorkerReady(workerId);\n+      return;\n+    }\n+\n+    // All other messages except for `ready` are unexpected if the worker has\n+    // not notified the `ClusterMaster` about being ready.\n     if (!this.taskAssignments.has(workerId)) {\n       const knownWorkers = Array.from(this.taskAssignments.keys());\n       throw new Error(\n@@ -221,8 +227,8 @@ export class ClusterMaster {\n     }\n   }\n \n-  /** Handle a worker's coming online. */\n-  private onWorkerOnline(workerId: number): void {\n+  /** Handle a worker's coming online and ready for retrieving IPC messages. */\n+  private onWorkerReady(workerId: number): void {\n     if (this.taskAssignments.has(workerId)) {\n       throw new Error(`Invariant violated: Worker #${workerId} came online more than once.`);\n     }"
        },
        {
            "sha": "263e16d0907a2cd431a27d342131e529a7aaea0e",
            "filename": "packages/compiler-cli/ngcc/src/execution/cluster/worker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fworker.ts",
            "raw_url": "https://github.com/angular/angular/raw/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fworker.ts?ref=23118ef3d8f918dc7f616a7b2e75c7f6d15a3323",
            "patch": "@@ -28,7 +28,6 @@ export async function startWorker(logger: Logger, createCompileFn: CreateCompile\n       }),\n       (_task, outcome, message) => sendMessageToMaster({type: 'task-completed', outcome, message}));\n \n-\n   // Listen for `ProcessTaskMessage`s and process tasks.\n   cluster.worker.on('message', async (msg: MessageToWorker) => {\n     try {\n@@ -60,6 +59,10 @@ export async function startWorker(logger: Logger, createCompileFn: CreateCompile\n     }\n   });\n \n+  // Notify the master that the worker is now ready and can receive messages.\n+  await sendMessageToMaster({type: 'ready'});\n+\n+\n   // Return a promise that is never resolved.\n   return new Promise(() => undefined);\n }"
        },
        {
            "sha": "4b22d53f4118874c6807c1a2a3cbaf2290a85ab5",
            "filename": "packages/compiler-cli/ngcc/test/execution/cluster/worker_spec.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fexecution%2Fcluster%2Fworker_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/23118ef3d8f918dc7f616a7b2e75c7f6d15a3323/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fexecution%2Fcluster%2Fworker_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fexecution%2Fcluster%2Fworker_spec.ts?ref=23118ef3d8f918dc7f616a7b2e75c7f6d15a3323",
            "patch": "@@ -63,9 +63,19 @@ describe('startWorker()', () => {\n       expect(createCompileFnSpy).toHaveBeenCalledWith(jasmine.any(Function), jasmine.any(Function));\n     });\n \n+    it('should notify the cluster master once ready', () => {\n+      startWorker(mockLogger, createCompileFnSpy);\n+\n+      expect(processSendSpy).toHaveBeenCalledTimes(1);\n+      expect(processSendSpy).toHaveBeenCalledWith({type: 'ready'}, jasmine.any(Function));\n+    });\n+\n     it('should set up `compileFn()` to send `transformed-files` messages to master', () => {\n       startWorker(mockLogger, createCompileFnSpy);\n \n+      expect(processSendSpy).toHaveBeenCalledTimes(1);\n+      expect(processSendSpy).toHaveBeenCalledWith({type: 'ready'}, jasmine.any(Function));\n+\n       const mockTransformedFiles: FileToWrite[] = [\n         {path: '/foo' as AbsoluteFsPath, contents: 'FOO'},\n         {path: '/bar' as AbsoluteFsPath, contents: 'BAR'},\n@@ -75,7 +85,7 @@ describe('startWorker()', () => {\n \n       beforeWritingFiles(mockTransformedFiles);\n \n-      expect(processSendSpy).toHaveBeenCalledTimes(1);\n+      expect(processSendSpy).toHaveBeenCalledTimes(2);\n       expect(processSendSpy)\n           .toHaveBeenCalledWith(\n               {type: 'transformed-files', files: ['/foo', '/bar']}, jasmine.any(Function));\n@@ -85,6 +95,9 @@ describe('startWorker()', () => {\n       startWorker(mockLogger, createCompileFnSpy);\n       const onTaskCompleted: TaskCompletedCallback = createCompileFnSpy.calls.argsFor(0)[1];\n \n+      // Reset as we are not interested in the initial messages.\n+      processSendSpy.calls.reset();\n+\n       onTaskCompleted(null as any, TaskProcessingOutcome.Processed, null);\n       expect(processSendSpy).toHaveBeenCalledTimes(1);\n       expect(processSendSpy)\n@@ -131,7 +144,7 @@ describe('startWorker()', () => {\n       cluster.worker.emit('message', {type: 'process-task', task: mockTask});\n \n       expect(compileFnSpy).toHaveBeenCalledWith(mockTask);\n-      expect(processSendSpy).not.toHaveBeenCalled();\n+      expect(processSendSpy).toHaveBeenCalledOnceWith({type: 'ready'}, jasmine.any(Function));\n \n       expect(mockLogger.logs.debug[0]).toEqual([\n         '[Worker #42] Processing task: {entryPoint: foo, formatProperty: es2015, processDts: Yes}',\n@@ -189,7 +202,7 @@ describe('startWorker()', () => {\n \n         expect(mockLogger.logs.warn).toEqual([[`[Worker #42] ${noMemError.stack}`]]);\n         expect(processExitSpy).toHaveBeenCalledWith(1);\n-        expect(processSendSpy).not.toHaveBeenCalled();\n+        expect(processSendSpy).toHaveBeenCalledOnceWith({type: 'ready'}, jasmine.any(Function));\n       } finally {\n         uninstallProcessExitSpies();\n       }"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 35,
        "deletions": 9
    }
}