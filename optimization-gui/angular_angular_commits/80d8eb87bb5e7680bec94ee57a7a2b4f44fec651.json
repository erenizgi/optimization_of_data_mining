{
    "author": "gkalpak",
    "message": "build(docs-infra): validate computed deployments in `deploy-to-firebase` script (#43963)\n\nThe `deploy-to-firebase` script might have to deploy a single AIO build\nto multiple projects/sites (potentially with small tweaks between each).\n\nThis commit adds a step to validate the computed deployments to ensure\nthey are compatible with each other (for example, that there is exactly\none primary deployment that builds the app and sets the theme/mode and\nthat all secondary deployments are compatible with the primary one).\n\nPR Close #43963",
    "sha": "80d8eb87bb5e7680bec94ee57a7a2b4f44fec651",
    "files": [
        {
            "sha": "3931bf7f9939b19ca814f8c02306daa8f075b3a7",
            "filename": "aio/scripts/deploy-to-firebase/index.js",
            "status": "modified",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/angular/angular/blob/80d8eb87bb5e7680bec94ee57a7a2b4f44fec651/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/80d8eb87bb5e7680bec94ee57a7a2b4f44fec651/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.js?ref=80d8eb87bb5e7680bec94ee57a7a2b4f44fec651",
            "patch": "@@ -21,6 +21,8 @@ module.exports = {\n   computeMajorVersion,\n   getLatestCommit,\n   getMostRecentMinorBranch,\n+  skipDeployment,\n+  validateDeploymentsInfo,\n };\n \n // Run\n@@ -30,6 +32,8 @@ if (require.main === module) {\n   const deploymentsInfo = computeDeploymentsInfo(inputVars);\n   const totalDeployments = deploymentsInfo.length;\n \n+  validateDeploymentsInfo(deploymentsInfo);\n+\n   console.log(`Deployments (${totalDeployments}): ${listDeployTargetNames(deploymentsInfo)}`);\n \n   deploymentsInfo.forEach((deploymentInfo, idx) => {\n@@ -392,6 +396,83 @@ function testPwaScore({deployedUrl, minPwaScore}) {\n   yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n }\n \n+function validateDeploymentsInfo(deploymentsList) {\n+  const knownTargetTypes = ['primary', 'secondary', 'skipped'];\n+  const requiredPropertiesForSkipped = ['name', 'type', 'reason'];\n+  const requiredPropertiesForNonSkipped = [\n+    'name', 'type', 'deployEnv', 'projectId', 'siteId', 'deployedUrl', 'preDeployActions',\n+    'postDeployActions',\n+  ];\n+\n+  const primaryTargets = deploymentsList.filter(({type}) => type === 'primary');\n+  const secondaryTargets = deploymentsList.filter(({type}) => type === 'secondary');\n+  const skippedTargets = deploymentsList.filter(({type}) => type === 'skipped');\n+  const otherTargets = deploymentsList.filter(({type}) => !knownTargetTypes.includes(type));\n+\n+  // Check that all targets have a known `type`.\n+  if (otherTargets.length > 0) {\n+    throw new Error(\n+        `Expected all deploy targets to have a type of ${knownTargetTypes.join(' or ')}, but ` +\n+        `found ${otherTargets.length} targets with an unknown type: ` +\n+        otherTargets.map(({name = '<no name>', type}) => `${name} (type: ${type})`).join(', '));\n+  }\n+\n+  // Check that all targets have the required properties.\n+  for (const target of deploymentsList) {\n+    const requiredProperties = (target.type === 'skipped') ?\n+      requiredPropertiesForSkipped : requiredPropertiesForNonSkipped;\n+    const missingProperties = requiredProperties.filter(prop => target[prop] === undefined);\n+\n+    if (missingProperties.length > 0) {\n+      throw new Error(\n+          `Expected deploy target '${target.name || '<no name>'}' to have all required ` +\n+          `properties, but it is missing '${missingProperties.join('\\', \\'')}'.`);\n+    }\n+  }\n+\n+  // If there are skipped targets...\n+  if (skippedTargets.length > 0) {\n+    // ...check that exactly one target has been specified.\n+    if (deploymentsList.length > 1) {\n+      throw new Error(\n+          `Expected a single skipped deploy target, but found ${deploymentsList.length} targets ` +\n+          `in total: ${listDeployTargetNames(deploymentsList)}`);\n+    }\n+\n+    // There is only one skipped deploy target and it is valid (i.e. has all required properties).\n+    return;\n+  }\n+\n+  // Check that exactly one primary target has been specified.\n+  if (primaryTargets.length !== 1) {\n+    throw new Error(\n+        `Expected exactly one primary deploy target, but found ${primaryTargets.length}: ` +\n+        listDeployTargetNames(primaryTargets));\n+  }\n+\n+  const primaryTarget = primaryTargets[0];\n+  const primaryIndex = deploymentsList.indexOf(primaryTarget);\n+\n+  // Check that the primary target is the first item in the list.\n+  if (primaryIndex !== 0) {\n+    throw new Error(\n+        `Expected the primary target (${primaryTarget.name}) to be the first item in the deploy ` +\n+        `target list, but it was found at index ${primaryIndex} (0-based): ` +\n+        listDeployTargetNames(deploymentsList));\n+  }\n+\n+  const nonMatchingSecondaryTargets =\n+      secondaryTargets.filter(({deployEnv}) => deployEnv !== primaryTarget.deployEnv);\n+\n+  // Check that all secondary targets (if any) match the primary target's `deployEnv`.\n+  if (nonMatchingSecondaryTargets.length > 0) {\n+    throw new Error(\n+        'Expected all secondary deploy targets to match the primary target\\'s `deployEnv` ' +\n+        `(${primaryTarget.deployEnv}), but ${nonMatchingSecondaryTargets.length} targets do not: ` +\n+        nonMatchingSecondaryTargets.map(t => `${t.name} (deployEnv: ${t.deployEnv})`).join(', '));\n+  }\n+}\n+\n function yarn(cmd) {\n   // Using `--silent` to ensure no secret env variables are printed.\n   //"
        },
        {
            "sha": "f0f474b34fd8df2130de8656f9868da047973eec",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.js",
            "status": "modified",
            "additions": 174,
            "deletions": 0,
            "changes": 174,
            "blob_url": "https://github.com/angular/angular/blob/80d8eb87bb5e7680bec94ee57a7a2b4f44fec651/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/80d8eb87bb5e7680bec94ee57a7a2b4f44fec651/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.js?ref=80d8eb87bb5e7680bec94ee57a7a2b4f44fec651",
            "patch": "@@ -8,6 +8,8 @@ const {\n   computeMajorVersion,\n   getLatestCommit,\n   getMostRecentMinorBranch,\n+  skipDeployment,\n+  validateDeploymentsInfo,\n } = require('./index');\n \n \n@@ -29,6 +31,7 @@ describe('deploy-to-firebase:', () => {\n     (typeof val === 'function') ? `function:${val.name}` : val;\n   const getDeploymentsInfoFor = env => {\n     const deploymentsInfo = computeDeploymentsInfo(computeInputVars(env));\n+    validateDeploymentsInfo(deploymentsInfo);\n     return JSON.parse(JSON.stringify(deploymentsInfo, jsonFunctionReplacer));\n   };\n \n@@ -448,3 +451,174 @@ describe('deploy-to-firebase:', () => {\n         '                      https://next-angular-io-site.web.app/');\n   });\n });\n+\n+describe('validateDeploymentsInfo()', () => {\n+  const createTarget = (name, type) => ({\n+    name,\n+    type,\n+    deployEnv: 'deployEnv',\n+    projectId: 'projectId',\n+    siteId: 'siteId',\n+    deployedUrl: 'deployedUrl',\n+    preDeployActions: [],\n+    postDeployActions: [],\n+  });\n+\n+  it('should error if there are deploy targets with unknown types', () => {\n+    const targets = [\n+      createTarget('target-1', 'primary'),\n+      createTarget('target-2', 'tertiary'),\n+      createTarget('target-3', 'secondary'),\n+      createTarget(undefined, 'other'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+        'Expected all deploy targets to have a type of primary or secondary or skipped, but ' +\n+        'found 2 targets with an unknown type: target-2 (type: tertiary), <no name> (type: other)');\n+  });\n+\n+  it('should error if there are non-skipped targets missing required properties', () => {\n+    // With target missing `name`.\n+    const targets1 = [\n+      createTarget('target-1', 'primary'),\n+      createTarget(undefined, 'secondary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets1)).toThrowError(\n+        'Expected deploy target \\'<no name>\\' to have all required properties, but it is missing ' +\n+        '\\'name\\'.');\n+\n+    // With target missing multiple properties.\n+    const targets2 = [\n+      createTarget('target-1', 'primary'),\n+      {\n+        ...createTarget('target-2', 'secondary'),\n+        deployEnv: undefined,\n+        postDeployActions: undefined,\n+      },\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets2)).toThrowError(\n+        'Expected deploy target \\'target-2\\' to have all required properties, but it is missing ' +\n+        '\\'deployEnv\\', \\'postDeployActions\\'.');\n+  });\n+\n+  it('should error if there are skipped targets missing required properties', () => {\n+    // With target missing `name`.\n+    const targets1 = [\n+      createTarget('target-1', 'primary'),\n+      {...skipDeployment('just because'), name: undefined},\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets1)).toThrowError(\n+        'Expected deploy target \\'<no name>\\' to have all required properties, but it is missing ' +\n+        '\\'name\\'.');\n+\n+    // With target missing `reason`.\n+    const targets2 = [\n+      createTarget('target-1', 'primary'),\n+      skipDeployment(undefined),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets2)).toThrowError(\n+        'Expected deploy target \\'skipped\\' to have all required properties, but it is missing ' +\n+        '\\'reason\\'.');\n+  });\n+\n+  it('should error if there are both skipped and non-skipped targets', () => {\n+    const targets = [\n+      skipDeployment('just because'),\n+      createTarget('target-2', 'secondary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+        'Expected a single skipped deploy target, but found 2 targets in total: skipped, target-2');\n+  });\n+\n+  it('should error if there are multiple skipped targets', () => {\n+    const targets = [\n+      skipDeployment('just because'),\n+      skipDeployment('because why not'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+        'Expected a single skipped deploy target, but found 2 targets in total: skipped, skipped');\n+  });\n+\n+  it('should error if there is no primary target', () => {\n+    const targets = [\n+      createTarget('target-1', 'secondary'),\n+      createTarget('target-2', 'secondary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+        'Expected exactly one primary deploy target, but found 0: -');\n+  });\n+\n+  it('should error if there is more than one primary target', () => {\n+    const targets = [\n+      createTarget('target-1', 'primary'),\n+      createTarget('target-2', 'secondary'),\n+      createTarget('target-3', 'primary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+        'Expected exactly one primary deploy target, but found 2: target-1, target-3');\n+  });\n+\n+  it('should error if the primary target is not the first item in the list', () => {\n+    const targets = [\n+      createTarget('target-1', 'secondary'),\n+      createTarget('target-2', 'primary'),\n+      createTarget('target-3', 'secondary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+        'Expected the primary target (target-2) to be the first item in the deploy target list, ' +\n+        'but it was found at index 1 (0-based): target-1, target-2, target-3');\n+  });\n+\n+  it('should error if there are secondary targets with a different `deployEnv` than primary',\n+      () => {\n+        const targets = [\n+          {...createTarget('target-1', 'primary'), deployEnv: 'deploy-env-1'},\n+          {...createTarget('target-2', 'secondary'), deployEnv: 'deploy-env-1'},\n+          {...createTarget('target-3', 'secondary'), deployEnv: 'deploy-env-2'},\n+          {...createTarget('target-4', 'secondary'), deployEnv: 'deploy-env-1'},\n+          {...createTarget('target-5', 'secondary'), deployEnv: 'deploy-env-2'},\n+          {...createTarget('target-6', 'secondary'), deployEnv: 'deploy-env-3'},\n+        ];\n+\n+        expect(() => validateDeploymentsInfo(targets)).toThrowError(\n+            'Expected all secondary deploy targets to match the primary target\\'s `deployEnv` ' +\n+            '(deploy-env-1), but 3 targets do not: target-3 (deployEnv: deploy-env-2), target-5 ' +\n+            '(deployEnv: deploy-env-2), target-6 (deployEnv: deploy-env-3)');\n+      });\n+\n+  it('should succeed with a valid skipped target', () => {\n+    const targets = [\n+      skipDeployment('due to valid reasons'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).not.toThrow();\n+  });\n+\n+  it('should succeed with a valid non-skipped target', () => {\n+    const targets = [\n+      createTarget('target-1', 'primary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).not.toThrow();\n+  });\n+\n+  it('should succeed with multiple valid non-skipped targets', () => {\n+    const targets = [\n+      createTarget('target-1', 'primary'),\n+      createTarget('target-2', 'secondary'),\n+      createTarget('target-3', 'secondary'),\n+      createTarget('target-4', 'secondary'),\n+    ];\n+\n+    expect(() => validateDeploymentsInfo(targets)).not.toThrow();\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 255,
        "additions": 255,
        "deletions": 0
    }
}