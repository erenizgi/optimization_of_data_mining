{
    "author": "kyliau",
    "message": "fix(language-service): [ivy] do not retrieve ts.Program at startup (#38120)\n\nThis commit removes compiler instantiation at startup.\nThis is because the constructor is invoked during the plugin loading phase,\nin which the project has not been completely loaded.\n\nRetrieving `ts.Program` at startup will trigger an `updateGraph` operation,\nwhich could only be called after the Project has loaded completely.\nWithout this change, the Ivy LS cannot be loaded as a tsserver plugin.\n\nNote that the whole `Compiler` class is temporary, so changes made there are\nonly for development. Once we have proper integration with ngtsc the\n`Compiler` class would be removed.\n\nPR Close #38120",
    "sha": "e8896b9de3ed6a3370b1fb104f5fd0b01222ac88",
    "files": [
        {
            "sha": "9454666ffb20174bd8f56b8bb13c70f0f0fdfbb2",
            "filename": "packages/language-service/ivy/compiler/compiler.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 21,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/e8896b9de3ed6a3370b1fb104f5fd0b01222ac88/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/e8896b9de3ed6a3370b1fb104f5fd0b01222ac88/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts?ref=e8896b9de3ed6a3370b1fb104f5fd0b01222ac88",
            "patch": "@@ -17,44 +17,40 @@ import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {makeCompilerHostFromProject} from './compiler_host';\n \n+interface AnalysisResult {\n+  compiler: NgCompiler;\n+  program: ts.Program;\n+}\n+\n export class Compiler {\n   private tsCompilerHost: ts.CompilerHost;\n-  private lastKnownProgram: ts.Program;\n-  private compiler: NgCompiler;\n+  private lastKnownProgram: ts.Program|null = null;\n   private readonly strategy: TypeCheckingProgramStrategy;\n \n   constructor(private readonly project: ts.server.Project, private options: CompilerOptions) {\n     this.tsCompilerHost = makeCompilerHostFromProject(project);\n-    const ngCompilerHost = NgCompilerHost.wrap(\n-        this.tsCompilerHost,\n-        project.getRootFiles(),  // input files\n-        options,\n-        null,  // old program\n-    );\n     this.strategy = createTypeCheckingProgramStrategy(project);\n-    this.lastKnownProgram = this.strategy.getProgram();\n-    this.compiler = new NgCompiler(\n-        ngCompilerHost, options, this.lastKnownProgram, this.strategy,\n-        new PatchedProgramIncrementalBuildStrategy());\n+    // Do not retrieve the program in constructor because project is still in\n+    // the process of loading, and not all data members have been initialized.\n   }\n \n   setCompilerOptions(options: CompilerOptions) {\n     this.options = options;\n   }\n \n-  analyze(): ts.Program|undefined {\n+  analyze(): AnalysisResult|undefined {\n     const inputFiles = this.project.getRootFiles();\n     const ngCompilerHost =\n         NgCompilerHost.wrap(this.tsCompilerHost, inputFiles, this.options, this.lastKnownProgram);\n     const program = this.strategy.getProgram();\n-    this.compiler = new NgCompiler(\n+    const compiler = new NgCompiler(\n         ngCompilerHost, this.options, program, this.strategy,\n         new PatchedProgramIncrementalBuildStrategy(), this.lastKnownProgram);\n     try {\n       // This is the only way to force the compiler to update the typecheck file\n       // in the program. We have to do try-catch because the compiler immediately\n       // throws if it fails to parse any template in the entire program!\n-      const d = this.compiler.getDiagnostics();\n+      const d = compiler.getDiagnostics();\n       if (d.length) {\n         // There could be global compilation errors. It's useful to print them\n         // out in development.\n@@ -64,12 +60,11 @@ export class Compiler {\n       console.error('Failed to analyze program', e.message);\n       return;\n     }\n-    this.lastKnownProgram = this.compiler.getNextProgram();\n-    return this.lastKnownProgram;\n-  }\n-\n-  getDiagnostics(sourceFile: ts.SourceFile): ts.Diagnostic[] {\n-    return this.compiler.getDiagnostics(sourceFile);\n+    this.lastKnownProgram = compiler.getNextProgram();\n+    return {\n+      compiler,\n+      program: this.lastKnownProgram,\n+    };\n   }\n }\n "
        },
        {
            "sha": "b0b66997841697dc4819bc6fc8a6bff0f3887895",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e8896b9de3ed6a3370b1fb104f5fd0b01222ac88/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/e8896b9de3ed6a3370b1fb104f5fd0b01222ac88/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=e8896b9de3ed6a3370b1fb104f5fd0b01222ac88",
            "patch": "@@ -21,15 +21,16 @@ export class LanguageService {\n   }\n \n   getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n-    const program = this.compiler.analyze();\n-    if (!program) {\n+    const result = this.compiler.analyze();\n+    if (!result) {\n       return [];\n     }\n+    const {compiler, program} = result;\n     const sourceFile = program.getSourceFile(fileName);\n     if (!sourceFile) {\n       return [];\n     }\n-    return this.compiler.getDiagnostics(sourceFile);\n+    return compiler.getDiagnostics(sourceFile);\n   }\n \n   private watchConfigFile(project: ts.server.Project) {"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 20,
        "deletions": 24
    }
}