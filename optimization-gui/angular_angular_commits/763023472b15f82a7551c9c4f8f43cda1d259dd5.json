{
    "author": "josephperrott",
    "message": "fix(router): prevent calling unsubscribe on undefined subscription in RouterPreloader (#38344)\n\nPreviously, the `ngOnDestroy` method called `unsubscribe` regardless of if `subscription` had\nbeen initialized.  This can lead to an error attempting to call `unsubscribe` of undefined.\nThis change prevents this error, and instead only attempts `unsubscribe` when the subscription\nhas been defined.\n\nPR Close #38344",
    "sha": "763023472b15f82a7551c9c4f8f43cda1d259dd5",
    "files": [
        {
            "sha": "6b6da836bbd531cc21fd5536825830515c9125b0",
            "filename": "packages/router/src/router_preloader.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/763023472b15f82a7551c9c4f8f43cda1d259dd5/packages%2Frouter%2Fsrc%2Frouter_preloader.ts",
            "raw_url": "https://github.com/angular/angular/raw/763023472b15f82a7551c9c4f8f43cda1d259dd5/packages%2Frouter%2Fsrc%2Frouter_preloader.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter_preloader.ts?ref=763023472b15f82a7551c9c4f8f43cda1d259dd5",
            "patch": "@@ -74,8 +74,7 @@ export class NoPreloading implements PreloadingStrategy {\n @Injectable()\n export class RouterPreloader implements OnDestroy {\n   private loader: RouterConfigLoader;\n-  // TODO(issue/24571): remove '!'.\n-  private subscription!: Subscription;\n+  private subscription?: Subscription;\n \n   constructor(\n       private router: Router, moduleLoader: NgModuleFactoryLoader, compiler: Compiler,\n@@ -98,11 +97,10 @@ export class RouterPreloader implements OnDestroy {\n     return this.processRoutes(ngModule, this.router.config);\n   }\n \n-  // TODO(jasonaden): This class relies on code external to the class to call setUpPreloading. If\n-  // this hasn't been done, ngOnDestroy will fail as this.subscription will be undefined. This\n-  // should be refactored.\n   ngOnDestroy(): void {\n-    this.subscription.unsubscribe();\n+    if (this.subscription) {\n+      this.subscription.unsubscribe();\n+    }\n   }\n \n   private processRoutes(ngModule: NgModuleRef<any>, routes: Routes): Observable<void> {"
        },
        {
            "sha": "f186e1796b6884ff6ed935483167fdd028d409d4",
            "filename": "packages/router/test/router_preloader.spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/763023472b15f82a7551c9c4f8f43cda1d259dd5/packages%2Frouter%2Ftest%2Frouter_preloader.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/763023472b15f82a7551c9c4f8f43cda1d259dd5/packages%2Frouter%2Ftest%2Frouter_preloader.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Frouter_preloader.spec.ts?ref=763023472b15f82a7551c9c4f8f43cda1d259dd5",
            "patch": "@@ -19,6 +19,23 @@ describe('RouterPreloader', () => {\n   class LazyLoadedCmp {\n   }\n \n+  describe('should properly handle', () => {\n+    beforeEach(() => {\n+      TestBed.configureTestingModule({\n+        imports: [RouterTestingModule.withRoutes(\n+            [{path: 'lazy', loadChildren: 'expected', canLoad: ['someGuard']}])],\n+        providers: [{provide: PreloadingStrategy, useExisting: PreloadAllModules}]\n+      });\n+    });\n+\n+    it('being destroyed before expected', () => {\n+      const preloader: RouterPreloader = TestBed.get(RouterPreloader);\n+      // Calling the RouterPreloader's ngOnDestroy method is done to simulate what would happen if\n+      // the containing NgModule is destroyed.\n+      expect(() => preloader.ngOnDestroy()).not.toThrow();\n+    });\n+  });\n+\n   describe('should not load configurations with canLoad guard', () => {\n     @NgModule({\n       declarations: [LazyLoadedCmp],"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 21,
        "deletions": 6
    }
}