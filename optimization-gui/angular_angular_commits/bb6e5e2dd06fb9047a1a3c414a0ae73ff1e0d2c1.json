{
    "author": "alxhub",
    "message": "fix(language-service): don't show external template diagnostics in ts files (#41070)\n\nThe compiler considers template diagnostics to \"belong\" to the source file\nof the component using the template. This means that when diagnostics for\na source file are reported, it returns diagnostics of TS structures in the\nactual source file, diagnostics for any inline templates, and diagnostics of\nany external templates.\n\nThe Language Service uses a different model, and wants to show template\ndiagnostics in the actual .html file. Thus, it's not necessary (and in fact\nincorrect) to include such diagnostics for the actual .ts file as well.\nDoing this currently causes a bug where external diagnostics appear in the\nTS file with \"random\" source spans.\n\nThis commit changes the Language Service to filter the set of diagnostics\nreturned by the compiler and only include those diagnostics with spans\nactually within the .ts file itself.\n\nFixes #41032\n\nPR Close #41070",
    "sha": "bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1",
    "files": [
        {
            "sha": "21908703a967ba53c667aa76e5746a30782ee84a",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1",
            "patch": "@@ -70,7 +70,28 @@ export class LanguageService {\n       const program = compiler.getNextProgram();\n       const sourceFile = program.getSourceFile(fileName);\n       if (sourceFile) {\n-        diagnostics.push(...compiler.getDiagnosticsForFile(sourceFile, OptimizeFor.SingleFile));\n+        const ngDiagnostics = compiler.getDiagnosticsForFile(sourceFile, OptimizeFor.SingleFile);\n+        // There are several kinds of diagnostics returned by `NgCompiler` for a source file:\n+        //\n+        // 1. Angular-related non-template diagnostics from decorated classes within that file.\n+        // 2. Template diagnostics for components with direct inline templates (a string literal).\n+        // 3. Template diagnostics for components with indirect inline templates (templates computed\n+        //    by expression).\n+        // 4. Template diagnostics for components with external templates.\n+        //\n+        // When showing diagnostics for a TS source file, we want to only include kinds 1 and 2 -\n+        // those diagnostics which are reported at a location within the TS file itself. Diagnostics\n+        // for external templates will be shown when editing that template file (the `else` block)\n+        // below.\n+        //\n+        // Currently, indirect inline template diagnostics (kind 3) are not shown at all by the\n+        // Language Service, because there is no sensible location in the user's code for them. Such\n+        // templates are an edge case, though, and should not be common.\n+        //\n+        // TODO(alxhub): figure out a good user experience for indirect template diagnostics and\n+        // show them from within the Language Service.\n+        diagnostics.push(...ngDiagnostics.filter(\n+            diag => diag.file !== undefined && diag.file.fileName === sourceFile.fileName));\n       }\n     } else {\n       const components = compiler.getComponentsWithTemplateFile(fileName);"
        },
        {
            "sha": "33ba654ffbfa42cd52339daa50851e015597634a",
            "filename": "packages/language-service/ivy/test/compiler_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts?ref=bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1",
            "patch": "@@ -30,11 +30,11 @@ describe('language-service/compiler integration', () => {\n       'test.html': `<other-cmp>Test</other-cmp>`\n     });\n \n-    expect(project.getDiagnosticsForFile('test.ts').length).toBeGreaterThan(0);\n+    expect(project.getDiagnosticsForFile('test.html').length).toBeGreaterThan(0);\n \n     const tmplFile = project.openFile('test.html');\n     tmplFile.contents = '<div>Test</div>';\n-    expect(project.getDiagnosticsForFile('test.ts').length).toEqual(0);\n+    expect(project.getDiagnosticsForFile('test.html').length).toEqual(0);\n   });\n \n   it('should not produce errors from inline test declarations mixing with those of the app', () => {"
        },
        {
            "sha": "97f7239d33c59a37b2d37b8532af63eb5871b217",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 5,
            "changes": 54,
            "blob_url": "https://github.com/angular/angular/blob/bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=bb6e5e2dd06fb9047a1a3c414a0ae73ff1e0d2c1",
            "patch": "@@ -75,6 +75,44 @@ describe('getSemanticDiagnostics', () => {\n     expect(diags).toEqual([]);\n   });\n \n+  it('should not report external template diagnostics on the TS file', () => {\n+    const files = {\n+      'app.ts': `\n+        import {Component, NgModule} from '@angular/core';\n+\n+        @Component({\n+          templateUrl: './app.html'\n+        })\n+        export class AppComponent {}\n+      `,\n+      'app.html': '{{nope}}'\n+    };\n+\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.ts');\n+    expect(diags).toEqual([]);\n+  });\n+\n+  it('should report diagnostics in inline templates', () => {\n+    const files = {\n+      'app.ts': `\n+        import {Component, NgModule} from '@angular/core';\n+\n+        @Component({\n+          template: '{{nope}}',\n+        })\n+        export class AppComponent {}\n+      `\n+    };\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    const diags = project.getDiagnosticsForFile('app.ts');\n+    expect(diags.length).toBe(1);\n+    const {category, file, messageText} = diags[0];\n+    expect(category).toBe(ts.DiagnosticCategory.Error);\n+    expect(file?.fileName).toBe('/test/app.ts');\n+    expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n+  });\n+\n   it('should report member does not exist in external template', () => {\n     const files = {\n       'app.ts': `\n@@ -179,11 +217,17 @@ describe('getSemanticDiagnostics', () => {\n     };\n \n     const project = env.addProject('test', files);\n-    const diags = project.getDiagnosticsForFile('app.ts');\n-    expect(diags.map(x => x.messageText).sort()).toEqual([\n-      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = false}}] in /test/app1.html@0:0',\n-      'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}] in /test/app2.html@0:0'\n-    ]);\n+    const diags1 = project.getDiagnosticsForFile('app1.html');\n+    expect(diags1.length).toBe(1);\n+    expect(diags1[0].messageText)\n+        .toBe(\n+            'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = false}}] in /test/app1.html@0:0');\n+\n+    const diags2 = project.getDiagnosticsForFile('app2.html');\n+    expect(diags2.length).toBe(1);\n+    expect(diags2[0].messageText)\n+        .toBe(\n+            'Parser Error: Bindings cannot contain assignments at column 8 in [{{nope = true}}] in /test/app2.html@0:0');\n   });\n \n   it('reports a diagnostic for a component without a template', () => {"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 73,
        "deletions": 8
    }
}