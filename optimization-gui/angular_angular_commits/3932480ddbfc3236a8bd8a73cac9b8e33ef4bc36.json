{
    "author": "danieltre23",
    "message": "refactor(compiler-cli): add `ExtendedTemplateChecker` (#43107)\n\nChange the current way to run template checks to the\n`ExtendedTemplateChecker` instead of just the\n`getExtendedTemplateDiagnosticsForComponent` function. Refactored the\ntests that used the previous function to use the new class.\n\nRefs #42966\n\nPR Close #43107",
    "sha": "3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36",
    "files": [
        {
            "sha": "804d628bb22399500dec277dfef9d756ee904a19",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/api/extended_template_checker.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Fextended_template_checker.ts",
            "raw_url": "https://github.com/angular/angular/raw/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Fextended_template_checker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Fextended_template_checker.ts?ref=3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36",
            "patch": "@@ -0,0 +1,19 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+/**\n+ * Interface to generate extended template diangostics from the component tempaltes.\n+ */\n+export interface ExtendedTemplateChecker {\n+  /**\n+   * Run `TemplateCheck`s for a component and return the generated `ts.Diagnostic`s.\n+   */\n+  getExtendedTemplateDiagnosticsForComponent(component: ts.ClassDeclaration): ts.Diagnostic[];\n+}"
        },
        {
            "sha": "fdf52332af7606cbb73240b8d6cffe53a12ada3a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/api/index.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fapi%2Findex.ts?ref=3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './api';\n+export * from './extended_template_checker';"
        },
        {
            "sha": "81eef890c9efd92d25c708f1958ef3018465a59f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/extended_template_checker.ts",
            "status": "renamed",
            "additions": 28,
            "deletions": 25,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "raw_url": "https://github.com/angular/angular/raw/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Fextended_template_checker.ts?ref=3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36",
            "patch": "@@ -7,39 +7,42 @@\n  */\n \n import * as ts from 'typescript';\n+\n import {ErrorCode} from '../../../diagnostics';\n import {TemplateTypeChecker} from '../../api';\n-import {TemplateCheck, TemplateContext} from '../api/api';\n+import {ExtendedTemplateChecker, TemplateCheck, TemplateContext} from '../api';\n \n-/**\n- * Run all `TemplateChecks` for a component and return the generated `ts.Diagnostic`s.\n- * @param component the `@Component()` class from which the template is obtained\n- * @param templateTypeChecker interface to get information about template nodes\n- * @param typeChecker program's type checker\n- * @param templateChecks specific checks to be run\n- * @returns generated `ts.Diagnostic[]`\n- */\n-export function getExtendedTemplateDiagnosticsForComponent(\n-    component: ts.ClassDeclaration, templateTypeChecker: TemplateTypeChecker,\n-    typeChecker: ts.TypeChecker, templateChecks: TemplateCheck<ErrorCode>[]): ts.Diagnostic[] {\n-  const template = templateTypeChecker.getTemplate(component);\n-  // Skip checks if component has no template. This can happen if the user writes a\n-  // `@Component()` but doesn't add the template, could happen in the language service\n-  // when users are in the middle of typing code.\n-  if (template === null) {\n-    return [];\n-  }\n-  const diagnostics: ts.Diagnostic[] = [];\n+export class ExtendedTemplateCheckerImpl implements ExtendedTemplateChecker {\n+  constructor(\n+      private readonly templateTypeChecker: TemplateTypeChecker,\n+      private readonly typeChecker: ts.TypeChecker,\n+      private readonly templateChecks: TemplateCheck<ErrorCode>[]) {}\n+\n+  getExtendedTemplateDiagnosticsForComponent(component: ts.ClassDeclaration): ts.Diagnostic[] {\n+    const template = this.templateTypeChecker.getTemplate(component);\n+    // Skip checks if component has no template. This can happen if the user writes a\n+    // `@Component()` but doesn't add the template, could happen in the language service\n+    // when users are in the middle of typing code.\n+    if (template === null) {\n+      return [];\n+    }\n+    const diagnostics: ts.Diagnostic[] = [];\n \n-  const ctx = {templateTypeChecker, typeChecker, component} as TemplateContext;\n+    const ctx = {\n+      templateTypeChecker: this.templateTypeChecker,\n+      typeChecker: this.typeChecker,\n+      component\n+    } as TemplateContext;\n \n-  for (const check of templateChecks) {\n-    diagnostics.push(...deduplicateDiagnostics(check.run(ctx, template)));\n-  }\n+    for (const check of this.templateChecks) {\n+      diagnostics.push(...deduplicateDiagnostics(check.run(ctx, template)));\n+    }\n \n-  return diagnostics;\n+    return diagnostics;\n+  }\n }\n \n+\n // Filter out duplicated diagnostics, this is possible due to the way the compiler\n // handles desugaring and produces `AST`s. Ex.\n //",
            "previous_filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/template_checker.ts"
        },
        {
            "sha": "f782c544d454232496a4d89f502f37306bb284b3",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/src/template_checks/invalid_banana_in_box/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Ftemplate_checks%2Finvalid_banana_in_box%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Ftemplate_checks%2Finvalid_banana_in_box%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Fsrc%2Ftemplate_checks%2Finvalid_banana_in_box%2Findex.ts?ref=3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36",
            "patch": "@@ -9,7 +9,7 @@\n import {TmplAstBoundEvent, TmplAstNode, TmplAstRecursiveVisitor} from '@angular/compiler';\n import * as ts from 'typescript';\n import {ErrorCode} from '../../../../../diagnostics';\n-import {TemplateCheck, TemplateContext, TemplateDiagnostic} from '../../../api/api';\n+import {TemplateCheck, TemplateContext, TemplateDiagnostic} from '../../../api';\n \n /**\n  * Ensures the two-way binding syntax is correct."
        },
        {
            "sha": "2efe65b6ea0047aef67a9b8f18bf144f3490789e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/extended/test/template_checks/invalid_banana_in_box/spec.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 21,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Ftemplate_checks%2Finvalid_banana_in_box%2Fspec.ts",
            "raw_url": "https://github.com/angular/angular/raw/3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Ftemplate_checks%2Finvalid_banana_in_box%2Fspec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fextended%2Ftest%2Ftemplate_checks%2Finvalid_banana_in_box%2Fspec.ts?ref=3932480ddbfc3236a8bd8a73cac9b8e33ef4bc36",
            "patch": "@@ -12,7 +12,7 @@ import {absoluteFrom, getSourceFileOrError} from '../../../../../file_system';\n import {runInEachFileSystem} from '../../../../../file_system/testing';\n import {getSourceCodeForDiagnostic} from '../../../../../testing';\n import {getClass, setup} from '../../../../testing';\n-import {getExtendedTemplateDiagnosticsForComponent} from '../../../src/template_checker';\n+import {ExtendedTemplateCheckerImpl} from '../../../src/extended_template_checker';\n import {InvalidBananaInBoxCheck} from '../../../src/template_checks/invalid_banana_in_box/index';\n \n runInEachFileSystem(() => {\n@@ -22,35 +22,35 @@ runInEachFileSystem(() => {\n       const {program, templateTypeChecker} = setup([{\n         fileName,\n         templates: {\n-          'TestCmp': '<div ([input])=\"var1\"> </div>',\n+          'TestCmp': '<div ([notARealThing])=\"var1\"> </div>',\n         },\n         source: 'export class TestCmp { var1: string = \"text\"; }'\n       }]);\n       const sf = getSourceFileOrError(program, fileName);\n       const component = getClass(sf, 'TestCmp');\n-      const diags = getExtendedTemplateDiagnosticsForComponent(\n-          component, templateTypeChecker, program.getTypeChecker(),\n-          [new InvalidBananaInBoxCheck()]);\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new InvalidBananaInBoxCheck()]);\n+      const diags = extendedTemplateChecker.getExtendedTemplateDiagnosticsForComponent(component);\n       expect(diags.length).toBe(1);\n       expect(diags[0].category).toBe(ts.DiagnosticCategory.Warning);\n       expect(diags[0].code).toBe(ErrorCode.INVALID_BANANA_IN_BOX);\n-      expect(getSourceCodeForDiagnostic(diags[0])).toBe('([input])=\"var1\"');\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('([notARealThing])=\"var1\"');\n     });\n \n     it('should not produce invalid banana in a box warning if written correctly', () => {\n       const fileName = absoluteFrom('/main.ts');\n       const {program, templateTypeChecker} = setup([{\n         fileName,\n         templates: {\n-          'TestCmp': '<div [(input)]=\"var1\"> </div>',\n+          'TestCmp': '<div [(notARealThing)]=\"var1\"> </div>',\n         },\n         source: 'export class TestCmp { var1: string = \"text\"; }'\n       }]);\n       const sf = getSourceFileOrError(program, fileName);\n       const component = getClass(sf, 'TestCmp');\n-      const diags = getExtendedTemplateDiagnosticsForComponent(\n-          component, templateTypeChecker, program.getTypeChecker(),\n-          [new InvalidBananaInBoxCheck()]);\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new InvalidBananaInBoxCheck()]);\n+      const diags = extendedTemplateChecker.getExtendedTemplateDiagnosticsForComponent(component);\n       expect(diags.length).toBe(0);\n     });\n \n@@ -60,15 +60,16 @@ runInEachFileSystem(() => {\n          const {program, templateTypeChecker} = setup([{\n            fileName,\n            templates: {\n-             'TestCmp': '<div (abc[123]def)=\"var1\"> </div>',\n+             'TestCmp': '<div (not[AReal]Thing)=\"var1\"> </div>',\n            },\n            source: 'export class TestCmp { var1: string = \"text\"; }'\n          }]);\n          const sf = getSourceFileOrError(program, fileName);\n          const component = getClass(sf, 'TestCmp');\n-         const diags = getExtendedTemplateDiagnosticsForComponent(\n-             component, templateTypeChecker, program.getTypeChecker(),\n-             [new InvalidBananaInBoxCheck()]);\n+         const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+             templateTypeChecker, program.getTypeChecker(), [new InvalidBananaInBoxCheck()]);\n+         const diags =\n+             extendedTemplateChecker.getExtendedTemplateDiagnosticsForComponent(component);\n          expect(diags.length).toBe(0);\n        });\n \n@@ -78,8 +79,8 @@ runInEachFileSystem(() => {\n         fileName,\n         templates: {\n           'TestCmp': `<div> \n-             <div *ngIf=\"false\" ([foo])=\"var1\"> </div>\n-             <ng-template #elseBlock ([bar])=\"var1\">Content to render when condition is false.</ng-template>\n+             <div *ngIf=\"false\" ([notARealThing])=\"var1\"> </div>\n+             <ng-template #elseBlock ([notARealThing2])=\"var1\">Content to render when condition is false.</ng-template>\n            </div>`,\n         },\n         source: `export class TestCmp { \n@@ -88,16 +89,16 @@ runInEachFileSystem(() => {\n       }]);\n       const sf = getSourceFileOrError(program, fileName);\n       const component = getClass(sf, 'TestCmp');\n-      const diags = getExtendedTemplateDiagnosticsForComponent(\n-          component, templateTypeChecker, program.getTypeChecker(),\n-          [new InvalidBananaInBoxCheck()]);\n+      const extendedTemplateChecker = new ExtendedTemplateCheckerImpl(\n+          templateTypeChecker, program.getTypeChecker(), [new InvalidBananaInBoxCheck()]);\n+      const diags = extendedTemplateChecker.getExtendedTemplateDiagnosticsForComponent(component);\n       expect(diags.length).toBe(2);\n       expect(diags[0].category).toBe(ts.DiagnosticCategory.Warning);\n       expect(diags[0].code).toBe(ErrorCode.INVALID_BANANA_IN_BOX);\n-      expect(getSourceCodeForDiagnostic(diags[0])).toBe('([foo])=\"var1\"');\n+      expect(getSourceCodeForDiagnostic(diags[0])).toBe('([notARealThing])=\"var1\"');\n       expect(diags[1].category).toBe(ts.DiagnosticCategory.Warning);\n       expect(diags[1].code).toBe(ErrorCode.INVALID_BANANA_IN_BOX);\n-      expect(getSourceCodeForDiagnostic(diags[1])).toBe('([bar])=\"var1\"');\n+      expect(getSourceCodeForDiagnostic(diags[1])).toBe('([notARealThing2])=\"var1\"');\n     });\n   });\n });"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 80,
        "deletions": 47
    }
}