{
    "author": "atscott",
    "message": "fix(language-service): Support completions of two-way bindings (#40185)\n\nThis commit adds special handling to the completion builder by detecting\na two way binding context and ensuring that we filter out any `Input`s\nthat do not support two way binding.\n\nPR Close #40185",
    "sha": "7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6",
    "files": [
        {
            "sha": "0dace86de306c39e541ec2792d6c1cf1b2144b9f",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6",
            "patch": "@@ -31,6 +31,7 @@ export enum CompletionNodeContext {\n   ElementAttributeKey,\n   ElementAttributeValue,\n   EventValue,\n+  TwoWayBinding,\n }\n \n /**\n@@ -415,7 +416,8 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n   }\n \n   private isElementAttributeCompletion(): this is ElementAttributeCompletionBuilder {\n-    return this.nodeContext === CompletionNodeContext.ElementAttributeKey &&\n+    return (this.nodeContext === CompletionNodeContext.ElementAttributeKey ||\n+            this.nodeContext === CompletionNodeContext.TwoWayBinding) &&\n         (this.node instanceof TmplAstElement || this.node instanceof TmplAstBoundAttribute ||\n          this.node instanceof TmplAstTextAttribute || this.node instanceof TmplAstBoundEvent);\n   }\n@@ -460,6 +462,10 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n           if (this.node instanceof TmplAstBoundEvent) {\n             continue;\n           }\n+          if (!completion.twoWayBindingSupported &&\n+              this.nodeContext === CompletionNodeContext.TwoWayBinding) {\n+            continue;\n+          }\n           break;\n         case AttributeCompletionKind.DirectiveOutput:\n           if (this.node instanceof TmplAstBoundAttribute) {"
        },
        {
            "sha": "a735833a34e616402db3ad36a47392f2cfd11d01",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6",
            "patch": "@@ -133,6 +133,8 @@ export class LanguageService {\n       return null;\n     }\n \n+    // For two-way bindings, we actually only need to be concerned with the bound attribute because\n+    // the bindings in the template are written with the attribute name, not the event name.\n     const node = positionDetails.context.kind === TargetNodeKind.TwoWayBindingContext ?\n         positionDetails.context.nodes[0] :\n         positionDetails.context.node;\n@@ -272,6 +274,8 @@ function nodeContextFromTarget(target: TargetContext): CompletionNodeContext {\n     case TargetNodeKind.ElementInBodyContext:\n       // Completions in element bodies are for new attributes.\n       return CompletionNodeContext.ElementAttributeKey;\n+    case TargetNodeKind.TwoWayBindingContext:\n+      return CompletionNodeContext.TwoWayBinding;\n     case TargetNodeKind.AttributeInKeyContext:\n       return CompletionNodeContext.ElementAttributeKey;\n     case TargetNodeKind.AttributeInValueContext:"
        },
        {
            "sha": "3ab849be76584b831fcb7db5d10e49f4f82d55c9",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=7d74853a1d4f4a46057ae3b55e9d5a3fdbe44cc6",
            "patch": "@@ -39,6 +39,22 @@ const DIR_WITH_OUTPUT = {\n   `\n };\n \n+const DIR_WITH_TWO_WAY_BINDING = {\n+  'Dir': `\n+    @Directive({\n+      selector: '[dir]',\n+      inputs: ['model', 'otherInput'],\n+      outputs: ['modelChange', 'otherOutput'],\n+    })\n+    export class Dir {\n+      model!: any;\n+      modelChange!: any;\n+      otherInput!: any;\n+      otherOutput!: any;\n+    }\n+  `\n+};\n+\n const NG_FOR_DIR = {\n   'NgFor': `\n     @Directive({\n@@ -519,6 +535,27 @@ describe('completions', () => {\n             ['myOutput']);\n         expectReplacementText(completions, text, 'my');\n       });\n+\n+      it('should return completions inside an LHS of a partially complete two-way binding', () => {\n+        const {ngLS, fileName, cursor, text} =\n+            setup(`<h1 dir [(modÂ¦)]></h1>`, ``, DIR_WITH_TWO_WAY_BINDING);\n+        const completions =\n+            ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+        expectReplacementText(completions, text, 'mod');\n+\n+        expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['model']);\n+\n+        // The completions should not include the events (because the 'Change' suffix is not used in\n+        // the two way binding) or inputs that do not have a corresponding name+'Change' output.\n+        expectDoesNotContain(\n+            completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+            ['modelChange']);\n+        expectDoesNotContain(\n+            completions, ts.ScriptElementKind.memberVariableElement, ['otherInput']);\n+        expectDoesNotContain(\n+            completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+            ['otherOutput']);\n+      });\n     });\n   });\n "
        }
    ],
    "stats": {
        "total": 49,
        "additions": 48,
        "deletions": 1
    }
}