{
    "author": "arturovt",
    "message": "fix(core): remove application from the testability registry when the root view is removed (#39876)\n\nIn the new behavior Angular removes applications from the testability registry when the\nroot view gets destroyed. This eliminates a memory leak, because before that the\nTestabilityRegistry holds references to HTML elements, thus they cannot be GCed.\n\nPR Close #22106\n\nPR Close #39876",
    "sha": "df27027ecb0ac96d503eb97a02f606023f62f60a",
    "files": [
        {
            "sha": "38f8eedc642c769e6bc83a138b7d82f450a71a96",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -39,7 +39,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 2285,\n-        \"main-es2015\": 241879,\n+        \"main-es2015\": 242455,\n         \"polyfills-es2015\": 36709,\n         \"5-es2015\": 745\n       }"
        },
        {
            "sha": "d7f024bbb2c4bd7ef8352489ace80f91765a333a",
            "filename": "packages/core/src/application_ref.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 12,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Fapplication_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fapplication_ref.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -594,6 +594,7 @@ export class ApplicationRef {\n   private _runningTick: boolean = false;\n   private _enforceNoNewChanges: boolean = false;\n   private _stable = true;\n+  private _onMicrotaskEmptySubscription: Subscription;\n \n   /**\n    * Get a list of component types registered to this application.\n@@ -622,7 +623,7 @@ export class ApplicationRef {\n       private _initStatus: ApplicationInitStatus) {\n     this._enforceNoNewChanges = isDevMode();\n \n-    this._zone.onMicrotaskEmpty.subscribe({\n+    this._onMicrotaskEmptySubscription = this._zone.onMicrotaskEmpty.subscribe({\n       next: () => {\n         this._zone.run(() => {\n           this.tick();\n@@ -715,15 +716,20 @@ export class ApplicationRef {\n         isBoundToModule(componentFactory) ? undefined : this._injector.get(NgModuleRef);\n     const selectorOrNode = rootSelectorOrNode || componentFactory.selector;\n     const compRef = componentFactory.create(Injector.NULL, [], selectorOrNode, ngModule);\n+    const nativeElement = compRef.location.nativeElement;\n+    const testability = compRef.injector.get(Testability, null);\n+    const testabilityRegistry = testability && compRef.injector.get(TestabilityRegistry);\n+    if (testability && testabilityRegistry) {\n+      testabilityRegistry.registerApplication(nativeElement, testability);\n+    }\n \n     compRef.onDestroy(() => {\n-      this._unloadComponent(compRef);\n+      this.detachView(compRef.hostView);\n+      remove(this.components, compRef);\n+      if (testabilityRegistry) {\n+        testabilityRegistry.unregisterApplication(nativeElement);\n+      }\n     });\n-    const testability = compRef.injector.get(Testability, null);\n-    if (testability) {\n-      compRef.injector.get(TestabilityRegistry)\n-          .registerApplication(compRef.location.nativeElement, testability);\n-    }\n \n     this._loadComponent(compRef);\n     if (isDevMode()) {\n@@ -796,15 +802,11 @@ export class ApplicationRef {\n     listeners.forEach((listener) => listener(componentRef));\n   }\n \n-  private _unloadComponent(componentRef: ComponentRef<any>): void {\n-    this.detachView(componentRef.hostView);\n-    remove(this.components, componentRef);\n-  }\n-\n   /** @internal */\n   ngOnDestroy() {\n     // TODO(alxhub): Dispose of the NgZone.\n     this._views.slice().forEach((view) => view.destroy());\n+    this._onMicrotaskEmptySubscription.unsubscribe();\n   }\n \n   /**"
        },
        {
            "sha": "0c4ebfb686195f163f0eae193209bb70a2a74aad",
            "filename": "packages/core/src/render3/component_ref.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent_ref.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -248,7 +248,6 @@ export function injectComponentFactoryResolver(): viewEngine_ComponentFactoryRes\n  *\n  */\n export class ComponentRef<T> extends viewEngine_ComponentRef<T> {\n-  destroyCbs: (() => void)[]|null = [];\n   instance: T;\n   hostView: ViewRef<T>;\n   changeDetectorRef: ViewEngine_ChangeDetectorRef;\n@@ -269,16 +268,10 @@ export class ComponentRef<T> extends viewEngine_ComponentRef<T> {\n   }\n \n   destroy(): void {\n-    if (this.destroyCbs) {\n-      this.destroyCbs.forEach(fn => fn());\n-      this.destroyCbs = null;\n-      !this.hostView.destroyed && this.hostView.destroy();\n-    }\n+    this.hostView.destroy();\n   }\n \n   onDestroy(callback: () => void): void {\n-    if (this.destroyCbs) {\n-      this.destroyCbs.push(callback);\n-    }\n+    this.hostView.onDestroy(callback);\n   }\n }"
        },
        {
            "sha": "046787e22ac1974089d5edc5cf9d4bd239f2fe8a",
            "filename": "packages/core/src/render3/instructions/listener.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -19,7 +19,7 @@ import {assertTNodeType} from '../node_assert';\n import {getCurrentDirectiveDef, getCurrentTNode, getLView, getTView} from '../state';\n import {getComponentLViewByIndex, getNativeByTNode, unwrapRNode} from '../util/view_utils';\n \n-import {getLCleanup, handleError, loadComponentRenderer, markViewDirty} from './shared';\n+import {getLCleanup, getTViewCleanup, handleError, loadComponentRenderer, markViewDirty} from './shared';\n \n \n \n@@ -120,7 +120,7 @@ function listenerInternal(\n     eventTargetResolver?: GlobalTargetResolver): void {\n   const isTNodeDirectiveHost = isDirectiveHost(tNode);\n   const firstCreatePass = tView.firstCreatePass;\n-  const tCleanup: false|any[] = firstCreatePass && (tView.cleanup || (tView.cleanup = []));\n+  const tCleanup: false|any[] = firstCreatePass && getTViewCleanup(tView);\n \n   // When the ɵɵlistener instruction was generated and is executed we know that there is either a\n   // native listener or a directive output on this element. As such we we know that we will have to"
        },
        {
            "sha": "c0b11b180a1e575b73f5d6329021b28eebec0457",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -752,14 +752,26 @@ export function locateHostElement(\n  * On the first template pass, saves in TView:\n  * - Cleanup function\n  * - Index of context we just saved in LView.cleanupInstances\n+ *\n+ * This function can also be used to store instance specific cleanup fns. In that case the `context`\n+ * is `null` and the function is store in `LView` (rather than it `TView`).\n  */\n export function storeCleanupWithContext(\n     tView: TView, lView: LView, context: any, cleanupFn: Function): void {\n   const lCleanup = getLCleanup(lView);\n-  lCleanup.push(context);\n+  if (context === null) {\n+    // If context is null that this is instance specific callback. These callbacks can only be\n+    // inserted after template shared instances. For this reason in ngDevMode we freeze the TView.\n+    if (ngDevMode) {\n+      Object.freeze(getTViewCleanup(tView));\n+    }\n+    lCleanup.push(cleanupFn);\n+  } else {\n+    lCleanup.push(context);\n \n-  if (tView.firstCreatePass) {\n-    getTViewCleanup(tView).push(cleanupFn, lCleanup.length - 1);\n+    if (tView.firstCreatePass) {\n+      getTViewCleanup(tView).push(cleanupFn, lCleanup.length - 1);\n+    }\n   }\n }\n \n@@ -1997,7 +2009,7 @@ export function getLCleanup(view: LView): any[] {\n   return view[CLEANUP] || (view[CLEANUP] = ngDevMode ? new LCleanup() : []);\n }\n \n-function getTViewCleanup(tView: TView): any[] {\n+export function getTViewCleanup(tView: TView): any[] {\n   return tView.cleanup || (tView.cleanup = ngDevMode ? new TCleanup() : []);\n }\n "
        },
        {
            "sha": "5c5bc78cf2f25546cdad0f4eaa006ab22ce49bce",
            "filename": "packages/core/src/render3/interfaces/view.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fview.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fview.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fview.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -163,8 +163,11 @@ export interface LView extends Array<any> {\n    *\n    * These change per LView instance, so they cannot be stored on TView. Instead,\n    * TView.cleanup saves an index to the necessary context in this array.\n+   *\n+   * After `LView` is created it is possible to attach additional instance specific functions at the\n+   * end of the `lView[CLENUP]` because we know that no more `T` level cleanup functions will be\n+   * addeded here.\n    */\n-  // TODO: flatten into LView[]\n   [CLEANUP]: any[]|null;\n \n   /**"
        },
        {
            "sha": "8a8cdbe1bae7ca2b1992669aec30d5f5aab8754d",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -10,7 +10,7 @@ import {ViewEncapsulation} from '../metadata/view';\n import {Renderer2} from '../render/api';\n import {RendererStyleFlags2} from '../render/api_flags';\n import {addToArray, removeFromArray} from '../util/array_utils';\n-import {assertDefined, assertDomNode, assertEqual, assertString} from '../util/assert';\n+import {assertDefined, assertDomNode, assertEqual, assertFunction, assertString} from '../util/assert';\n import {assertLContainer, assertLView, assertTNodeForLView} from './assert';\n import {attachPatchData} from './context_discovery';\n import {icuContainerIterate} from './i18n/i18n_tree_shaking';\n@@ -418,7 +418,7 @@ function cleanUpView(tView: TView, lView: LView): void {\n     lView[FLAGS] |= LViewFlags.Destroyed;\n \n     executeOnDestroys(tView, lView);\n-    removeListeners(tView, lView);\n+    processCleanups(tView, lView);\n     // For component views only, the local renderer is destroyed at clean up time.\n     if (lView[TVIEW].type === TViewType.Component && isProceduralRenderer(lView[RENDERER])) {\n       ngDevMode && ngDevMode.rendererDestroy++;\n@@ -443,38 +443,49 @@ function cleanUpView(tView: TView, lView: LView): void {\n }\n \n /** Removes listeners and unsubscribes from output subscriptions */\n-function removeListeners(tView: TView, lView: LView): void {\n+function processCleanups(tView: TView, lView: LView): void {\n   const tCleanup = tView.cleanup;\n+  const lCleanup = lView[CLEANUP]!;\n+  // `LCleanup` contains both share information with `TCleanup` as well as instance specific\n+  // information appended at the end. We need to know where the end of the `TCleanup` information\n+  // is, and we track this with `lastLCleanupIndex`.\n+  let lastLCleanupIndex = -1;\n   if (tCleanup !== null) {\n-    const lCleanup = lView[CLEANUP]!;\n     for (let i = 0; i < tCleanup.length - 1; i += 2) {\n       if (typeof tCleanup[i] === 'string') {\n         // This is a native DOM listener\n         const idxOrTargetGetter = tCleanup[i + 1];\n         const target = typeof idxOrTargetGetter === 'function' ?\n             idxOrTargetGetter(lView) :\n             unwrapRNode(lView[idxOrTargetGetter]);\n-        const listener = lCleanup[tCleanup[i + 2]];\n+        const listener = lCleanup[lastLCleanupIndex = tCleanup[i + 2]];\n         const useCaptureOrSubIdx = tCleanup[i + 3];\n         if (typeof useCaptureOrSubIdx === 'boolean') {\n           // native DOM listener registered with Renderer3\n           target.removeEventListener(tCleanup[i], listener, useCaptureOrSubIdx);\n         } else {\n           if (useCaptureOrSubIdx >= 0) {\n             // unregister\n-            lCleanup[useCaptureOrSubIdx]();\n+            lCleanup[lastLCleanupIndex = useCaptureOrSubIdx]();\n           } else {\n             // Subscription\n-            lCleanup[-useCaptureOrSubIdx].unsubscribe();\n+            lCleanup[lastLCleanupIndex = -useCaptureOrSubIdx].unsubscribe();\n           }\n         }\n         i += 2;\n       } else {\n         // This is a cleanup function that is grouped with the index of its context\n-        const context = lCleanup[tCleanup[i + 1]];\n+        const context = lCleanup[lastLCleanupIndex = tCleanup[i + 1]];\n         tCleanup[i].call(context);\n       }\n     }\n+    if (lCleanup !== null) {\n+      for (let i = lastLCleanupIndex + 1; i < lCleanup.length; i++) {\n+        const instanceCleanupFn = lCleanup[i];\n+        ngDevMode && assertFunction(instanceCleanupFn, 'Expecting instance cleanup function.');\n+        instanceCleanupFn();\n+      }\n+    }\n     lView[CLEANUP] = null;\n   }\n }"
        },
        {
            "sha": "bf1092a99bd299ebbec2c29dbf197dfffd91cb9a",
            "filename": "packages/core/src/util/assert.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Futil%2Fassert.ts",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Fsrc%2Futil%2Fassert.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fassert.ts?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -31,6 +31,12 @@ export function assertString(actual: any, msg: string): asserts actual is string\n   }\n }\n \n+export function assertFunction(actual: any, msg: string): asserts actual is Function {\n+  if (!(typeof actual === 'function')) {\n+    throwError(msg, actual === null ? 'null' : typeof actual, 'function', '===');\n+  }\n+}\n+\n export function assertEqual<T>(actual: T, expected: T, msg: string) {\n   if (!(actual == expected)) {\n     throwError(msg, actual, expected, '==');"
        },
        {
            "sha": "036c745dba7696cbe9aa03df1f3075ecae7e0c5e",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/df27027ecb0ac96d503eb97a02f606023f62f60a/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=df27027ecb0ac96d503eb97a02f606023f62f60a",
            "patch": "@@ -1436,6 +1436,9 @@\n   {\n     \"name\": \"getTView\"\n   },\n+  {\n+    \"name\": \"getTViewCleanup\"\n+  },\n   {\n     \"name\": \"getToken\"\n   },"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 67,
        "deletions": 37
    }
}