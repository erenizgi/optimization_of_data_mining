{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): should invoke xhr send task when no response error occurs (#38836)\n\nClose #38795\n\nin the XMLHttpRequest patch, when get `readystatechange` event, zone.js try to\ninvoke `load` event listener first, then call `invokeTask` to finish the\n`XMLHttpRequest::send` macroTask, but if the request failed because the\nserver can not be reached, the `load` event listener will not be invoked,\nso the `invokeTask` of the `XMLHttpRequest::send` will not be triggered either,\nso we will have a non finished macroTask there which will make the Zone\nnot stable, also memory leak.\n\nSo in this PR, if the `XMLHttpRequest.status = 0` when we get the `readystatechange`\nevent, that means something wents wrong before we reached the server, we need to\ninvoke the task to finish the macroTask.\n\nPR Close #38836",
    "sha": "d92a0dd72f6adf3c8a145255bb1e08346780418e",
    "files": [
        {
            "sha": "bf6c4195280b99a98f57b99f09e3ff7fe377caca",
            "filename": "packages/zone.js/lib/browser/browser.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/d92a0dd72f6adf3c8a145255bb1e08346780418e/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts",
            "raw_url": "https://github.com/angular/angular/raw/d92a0dd72f6adf3c8a145255bb1e08346780418e/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts?ref=d92a0dd72f6adf3c8a145255bb1e08346780418e",
            "patch": "@@ -149,8 +149,12 @@ Zone.__load_patch('XHR', (global: any, Zone: ZoneType) => {\n             // check whether the xhr has registered onload listener\n             // if that is the case, the task should invoke after all\n             // onload listeners finish.\n+            // Also if the request failed without response (status = 0), the load event handler\n+            // will not be triggered, in that case, we should also invoke the placeholder callback\n+            // to close the XMLHttpRequest::send macroTask.\n+            // https://github.com/angular/angular/issues/38795\n             const loadTasks = target[Zone.__symbol__('loadfalse')];\n-            if (loadTasks && loadTasks.length > 0) {\n+            if (target.status !== 0 && loadTasks && loadTasks.length > 0) {\n               const oriInvoke = task.invoke;\n               task.invoke = function() {\n                 // need to load the tasks again, because in other"
        },
        {
            "sha": "da23b072ffad91810e03737a682332afc5d5116d",
            "filename": "packages/zone.js/test/browser/XMLHttpRequest.spec.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/d92a0dd72f6adf3c8a145255bb1e08346780418e/packages%2Fzone.js%2Ftest%2Fbrowser%2FXMLHttpRequest.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d92a0dd72f6adf3c8a145255bb1e08346780418e/packages%2Fzone.js%2Ftest%2Fbrowser%2FXMLHttpRequest.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fbrowser%2FXMLHttpRequest.spec.ts?ref=d92a0dd72f6adf3c8a145255bb1e08346780418e",
            "patch": "@@ -268,6 +268,30 @@ describe('XMLHttpRequest', function() {\n        });\n      });\n \n+  it('should close xhr request if error happened when connect', function(done) {\n+    const logs: boolean[] = [];\n+    Zone.current\n+        .fork({\n+          name: 'xhr',\n+          onHasTask:\n+              (delegate: ZoneDelegate, curr: Zone, target: Zone, taskState: HasTaskState) => {\n+                if (taskState.change === 'macroTask') {\n+                  logs.push(taskState.macroTask);\n+                }\n+                return delegate.hasTask(target, taskState);\n+              }\n+        })\n+        .run(function() {\n+          const req = new XMLHttpRequest();\n+          req.open('get', 'http://notexists.url', true);\n+          req.send();\n+          req.addEventListener('error', () => {\n+            expect(logs).toEqual([true, false]);\n+            done();\n+          });\n+        });\n+  });\n+\n   it('should trigger readystatechange if xhr request trigger cors error', (done) => {\n     const req = new XMLHttpRequest();\n     let err: any = null;"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 29,
        "deletions": 1
    }
}