{
    "author": "alxhub",
    "message": "fix(compiler-cli): handle property reads of `ThisReceiver` in the indexer (#44678)\n\nPreviously, the Angular Indexer made an assumption that in any binding to\na property of an `ImplicitReceiver`, the property name begins at the start\nof the binding. This is true for normal reads from `ImplicitReceiver` as\nthe implicit receiver has no representation in the template.\n\nHowever, `ThisReceiver` inherits from `ImplicitReceiver` and _does_ have a\ntemplate representation. Such a binding looks like `{{this.foo}}`. This\ncommit corrects the logic of the indexer to use the `nameSpan` of the\nproperty binding instead of its `sourceSpan` to locate the identifier.\n\nPR Close #44678",
    "sha": "f83fb3a5f9b146cb5025517950100e98895304ed",
    "files": [
        {
            "sha": "a3b1d78a4d52a5564a66296ff57d3eed85060cff",
            "filename": "packages/compiler-cli/src/ngtsc/indexer/src/template.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/f83fb3a5f9b146cb5025517950100e98895304ed/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Fsrc%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/f83fb3a5f9b146cb5025517950100e98895304ed/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Fsrc%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Fsrc%2Ftemplate.ts?ref=f83fb3a5f9b146cb5025517950100e98895304ed",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {AST, ASTWithSource, BoundTarget, ImplicitReceiver, ParseSourceSpan, PropertyRead, PropertyWrite, RecursiveAstVisitor, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstBoundText, TmplAstElement, TmplAstNode, TmplAstRecursiveVisitor, TmplAstReference, TmplAstTemplate, TmplAstVariable} from '@angular/compiler';\n+\n import {AbsoluteSourceSpan, AttributeIdentifier, ElementIdentifier, IdentifierKind, MethodIdentifier, PropertyIdentifier, ReferenceIdentifier, TemplateNodeIdentifier, TopLevelIdentifier, VariableIdentifier} from './api';\n import {ComponentMeta} from './context';\n \n@@ -93,7 +94,14 @@ class ExpressionVisitor extends RecursiveAstVisitor {\n     }\n \n     // The source span of the requested AST starts at a location that is offset from the expression.\n-    const identifierStart = ast.sourceSpan.start - this.absoluteOffset;\n+    let identifierStart = ast.sourceSpan.start - this.absoluteOffset;\n+\n+    if (ast instanceof PropertyRead || ast instanceof PropertyWrite) {\n+      // For `PropertyRead` and `PropertyWrite`, the identifier starts at the `nameSpan`, not\n+      // necessarily the `sourceSpan`.\n+      identifierStart = ast.nameSpan.start - this.absoluteOffset;\n+    }\n+\n     if (!this.expressionStr.substring(identifierStart).startsWith(ast.name)) {\n       throw new Error(`Impossible state: \"${ast.name}\" not found in \"${\n           this.expressionStr}\" at location ${identifierStart}`);"
        },
        {
            "sha": "b5a4b9379a6baebf78666abfb8c69d0c49800a07",
            "filename": "packages/compiler-cli/src/ngtsc/indexer/test/template_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/f83fb3a5f9b146cb5025517950100e98895304ed/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f83fb3a5f9b146cb5025517950100e98895304ed/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Findexer%2Ftest%2Ftemplate_spec.ts?ref=f83fb3a5f9b146cb5025517950100e98895304ed",
            "patch": "@@ -9,6 +9,7 @@\n import {AbsoluteSourceSpan, AttributeIdentifier, ElementIdentifier, IdentifierKind, ReferenceIdentifier, TemplateNodeIdentifier, TopLevelIdentifier, VariableIdentifier} from '..';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {getTemplateIdentifiers} from '../src/template';\n+\n import * as util from './util';\n \n function bind(template: string) {\n@@ -89,6 +90,20 @@ runInEachFileSystem(() => {\n         });\n       });\n \n+      it('should discover component properties read using \"this\" as a receiver', () => {\n+        const template = '{{this.foo}}';\n+        const refs = getTemplateIdentifiers(bind(template));\n+        expect(refs.size).toBe(1);\n+\n+        const [ref] = Array.from(refs);\n+        expect(ref).toEqual({\n+          name: 'foo',\n+          kind: IdentifierKind.Property,\n+          span: new AbsoluteSourceSpan(7, 10),\n+          target: null,\n+        });\n+      });\n+\n       it('should discover nested properties', () => {\n         const template = '<div><span>{{foo}}</span></div>';\n         const refs = getTemplateIdentifiers(bind(template));"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 24,
        "deletions": 1
    }
}