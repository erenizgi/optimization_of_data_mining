{
    "author": "krzysztof-grzybek",
    "message": "fix(router): reuse route strategy fix (#43791)\n\nCurrently, it's impossible to cache (detach/attach) parent route without caching child routes.\nThis produces a bug, when navigating from a/b to c, then to a/d, where a route is cached.\nOn the last navigation, we incorrectly restore a/b route instead of a/d.\nThis change introduces new behavior: if the route should be detached/attached,\nwe do so, but we check also child routes recursively.\n\nFixes #17333\n\nPR Close #43791",
    "sha": "45e4e60fd6b8ae30a18368ac613f8f8ff4da3718",
    "files": [
        {
            "sha": "b4b1e73a9d59ba4ba5b7487e491fd04807e54c64",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=45e4e60fd6b8ae30a18368ac613f8f8ff4da3718",
            "patch": "@@ -42,7 +42,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime\": 2843,\n-        \"main\": 238453,\n+        \"main\": 237895,\n         \"polyfills\": 37064,\n         \"src_app_lazy_lazy_module_ts\": 795\n       }"
        },
        {
            "sha": "a96f9b9336d0e48a2191807c2c55aacf58f13d6e",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=45e4e60fd6b8ae30a18368ac613f8f8ff4da3718",
            "patch": "@@ -941,9 +941,6 @@\n   {\n     \"name\": \"advanceActivatedRoute\"\n   },\n-  {\n-    \"name\": \"advanceActivatedRouteNodeAndItsChildren\"\n-  },\n   {\n     \"name\": \"allocExpando\"\n   },\n@@ -1922,9 +1919,6 @@\n   {\n     \"name\": \"setDirectiveInputsWhichShadowsStyling\"\n   },\n-  {\n-    \"name\": \"setFutureSnapshotsOfActivatedRoutes\"\n-  },\n   {\n     \"name\": \"setIncludeViewProviders\"\n   },"
        },
        {
            "sha": "f00d40f0ca1fb614f50a6f5ee16255514959f494",
            "filename": "packages/router/src/create_router_state.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 15,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts",
            "raw_url": "https://github.com/angular/angular/raw/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fcreate_router_state.ts?ref=45e4e60fd6b8ae30a18368ac613f8f8ff4da3718",
            "patch": "@@ -34,7 +34,8 @@ function createNode(\n       const detachedRouteHandle = routeReuseStrategy.retrieve(curr.value);\n       if (detachedRouteHandle !== null) {\n         const tree = (detachedRouteHandle as DetachedRouteHandleInternal).route;\n-        setFutureSnapshotsOfActivatedRoutes(curr, tree);\n+        tree.value._futureSnapshot = curr.value;\n+        tree.children = curr.children.map(c => createNode(routeReuseStrategy, c));\n         return tree;\n       }\n     }\n@@ -45,20 +46,6 @@ function createNode(\n   }\n }\n \n-function setFutureSnapshotsOfActivatedRoutes(\n-    curr: TreeNode<ActivatedRouteSnapshot>, result: TreeNode<ActivatedRoute>): void {\n-  if (curr.value.routeConfig !== result.value.routeConfig) {\n-    throw new Error('Cannot reattach ActivatedRouteSnapshot created from a different route');\n-  }\n-  if (curr.children.length !== result.children.length) {\n-    throw new Error('Cannot reattach ActivatedRouteSnapshot with a different number of children');\n-  }\n-  result.value._futureSnapshot = curr.value;\n-  for (let i = 0; i < curr.children.length; ++i) {\n-    setFutureSnapshotsOfActivatedRoutes(curr.children[i], result.children[i]);\n-  }\n-}\n-\n function createOrReuseChildren(\n     routeReuseStrategy: RouteReuseStrategy, curr: TreeNode<ActivatedRouteSnapshot>,\n     prevState: TreeNode<ActivatedRoute>) {"
        },
        {
            "sha": "3007441cb98771491690d8e0ebd6957ed8d0106d",
            "filename": "packages/router/src/operators/activate_routes.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Frouter%2Fsrc%2Foperators%2Factivate_routes.ts",
            "raw_url": "https://github.com/angular/angular/raw/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Frouter%2Fsrc%2Foperators%2Factivate_routes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Foperators%2Factivate_routes.ts?ref=45e4e60fd6b8ae30a18368ac613f8f8ff4da3718",
            "patch": "@@ -99,6 +99,13 @@ export class ActivateRoutes {\n   private detachAndStoreRouteSubtree(\n       route: TreeNode<ActivatedRoute>, parentContexts: ChildrenOutletContexts): void {\n     const context = parentContexts.getContext(route.value.outlet);\n+    const contexts = context && route.value.component ? context.children : parentContexts;\n+    const children: {[outletName: string]: TreeNode<ActivatedRoute>} = nodeChildrenAsMap(route);\n+\n+    for (const childOutlet of Object.keys(children)) {\n+      this.deactivateRouteAndItsChildren(children[childOutlet], contexts);\n+    }\n+\n     if (context && context.outlet) {\n       const componentRef = context.outlet.detach();\n       const contexts = context.children.onOutletDeactivated();\n@@ -179,7 +186,9 @@ export class ActivateRoutes {\n             // Otherwise attach from `RouterOutlet.ngOnInit` when it is instantiated\n             context.outlet.attach(stored.componentRef, stored.route.value);\n           }\n-          advanceActivatedRouteNodeAndItsChildren(stored.route);\n+\n+          advanceActivatedRoute(stored.route.value);\n+          this.activateChildRoutes(futureNode, null, context.children);\n         } else {\n           const config = parentLoadedConfig(future.snapshot);\n           const cmpFactoryResolver = config ? config.module.componentFactoryResolver : null;\n@@ -203,11 +212,6 @@ export class ActivateRoutes {\n   }\n }\n \n-function advanceActivatedRouteNodeAndItsChildren(node: TreeNode<ActivatedRoute>): void {\n-  advanceActivatedRoute(node.value);\n-  node.children.forEach(advanceActivatedRouteNodeAndItsChildren);\n-}\n-\n function parentLoadedConfig(snapshot: ActivatedRouteSnapshot): LoadedRouterConfig|null {\n   for (let s = snapshot.parent; s; s = s.parent) {\n     const route = s.routeConfig;"
        },
        {
            "sha": "4b03ab00f3fad6eadbedffb678c056a567767904",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 3,
            "changes": 70,
            "blob_url": "https://github.com/angular/angular/blob/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/45e4e60fd6b8ae30a18368ac613f8f8ff4da3718/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=45e4e60fd6b8ae30a18368ac613f8f8ff4da3718",
            "patch": "@@ -8,7 +8,7 @@\n \n import {APP_BASE_HREF, CommonModule, HashLocationStrategy, Location, LOCATION_INITIALIZED, LocationStrategy, PlatformLocation} from '@angular/common';\n import {SpyLocation} from '@angular/common/testing';\n-import {ChangeDetectionStrategy, Component, EventEmitter, Injectable, NgModule, NgModuleRef, NgZone, OnDestroy, ViewChild, ɵConsole as Console, ɵNoopNgZone as NoopNgZone} from '@angular/core';\n+import {ChangeDetectionStrategy, Component, EventEmitter, Inject, Injectable, InjectionToken, NgModule, NgModuleRef, NgZone, OnDestroy, ViewChild, ɵConsole as Console, ɵNoopNgZone as NoopNgZone} from '@angular/core';\n import {ComponentFixture, fakeAsync, inject, TestBed, tick} from '@angular/core/testing';\n import {By} from '@angular/platform-browser/src/dom/debug/by';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n@@ -5711,9 +5711,11 @@ describe('Integration', () => {\n   describe('Custom Route Reuse Strategy', () => {\n     class AttachDetachReuseStrategy implements RouteReuseStrategy {\n       stored: {[k: string]: DetachedRouteHandle} = {};\n+      pathsToDetach = ['a'];\n \n       shouldDetach(route: ActivatedRouteSnapshot): boolean {\n-        return route.routeConfig!.path === 'a';\n+        return typeof route.routeConfig!.path !== 'undefined' &&\n+            this.pathsToDetach.includes(route.routeConfig!.path);\n       }\n \n       store(route: ActivatedRouteSnapshot, detachedTree: DetachedRouteHandle): void {\n@@ -5827,6 +5829,7 @@ describe('Integration', () => {\n          const fixture = createRoot(router, RootCmp);\n \n          router.routeReuseStrategy = new AttachDetachReuseStrategy();\n+         (router.routeReuseStrategy as AttachDetachReuseStrategy).pathsToDetach = ['a', 'b'];\n          spyOn(router.routeReuseStrategy, 'retrieve').and.callThrough();\n \n          router.resetConfig([\n@@ -5857,7 +5860,7 @@ describe('Integration', () => {\n          router.navigateByUrl('/a;p=1/b;p=2');\n          advance(fixture);\n          // We retrieve both the stored route snapshots\n-         expect(router.routeReuseStrategy.retrieve).toHaveBeenCalledTimes(2);\n+         expect(router.routeReuseStrategy.retrieve).toHaveBeenCalledTimes(4);\n          const teamCmp2 = fixture.debugElement.children[1].componentInstance;\n          const simpleCmp2 = fixture.debugElement.children[1].children[1].componentInstance;\n          expect(location.path()).toEqual('/a;p=1/b;p=2');\n@@ -5868,6 +5871,7 @@ describe('Integration', () => {\n          expect(teamCmp.route.snapshot).toBe(router.routerState.snapshot.root.firstChild);\n          expect(teamCmp.route.snapshot.params).toEqual({p: '1'});\n          expect(teamCmp.route.firstChild.snapshot.params).toEqual({p: '2'});\n+         expect(teamCmp.recordedParams).toEqual([{}, {p: '1'}]);\n        })));\n \n     it('should support shorter lifecycles',\n@@ -6019,6 +6023,66 @@ describe('Integration', () => {\n          advance(fixture);\n          expect(fixture.debugElement.query(By.directive(SimpleCmp))).toBeTruthy();\n        }));\n+\n+    it('should allow to attach parent route with fresh child route', fakeAsync(() => {\n+         const CREATED_COMPS = new InjectionToken<string[]>('CREATED_COMPS');\n+\n+         @Component({selector: 'root', template: `<router-outlet></router-outlet>`})\n+         class Root {\n+         }\n+\n+         @Component({selector: 'parent', template: `<router-outlet></router-outlet>`})\n+         class Parent {\n+           constructor(@Inject(CREATED_COMPS) createdComps: string[]) {\n+             createdComps.push('parent');\n+           }\n+         }\n+\n+         @Component({selector: 'child', template: `child`})\n+         class Child {\n+           constructor(@Inject(CREATED_COMPS) createdComps: string[]) {\n+             createdComps.push('child');\n+           }\n+         }\n+\n+         @NgModule({\n+           declarations: [Root, Parent, Child],\n+           imports: [\n+             CommonModule,\n+             RouterTestingModule.withRoutes([\n+               {path: 'a', component: Parent, children: [{path: 'b', component: Child}]},\n+               {path: 'c', component: SimpleCmp}\n+             ]),\n+           ],\n+           providers: [\n+             {provide: RouteReuseStrategy, useClass: AttachDetachReuseStrategy},\n+             {provide: CREATED_COMPS, useValue: []}\n+           ]\n+         })\n+         class TestModule {\n+         }\n+         TestBed.configureTestingModule({imports: [TestModule]});\n+\n+         const router = TestBed.inject(Router);\n+         const fixture = createRoot(router, Root);\n+         const createdComps = TestBed.inject(CREATED_COMPS);\n+\n+         expect(createdComps).toEqual([]);\n+\n+         router.navigateByUrl('/a/b');\n+         advance(fixture);\n+         expect(createdComps).toEqual(['parent', 'child']);\n+\n+         router.navigateByUrl('/c');\n+         advance(fixture);\n+         expect(createdComps).toEqual(['parent', 'child']);\n+\n+         // 'a' parent route will be reused by the `RouteReuseStrategy`, child 'b' should be\n+         // recreated\n+         router.navigateByUrl('/a/b');\n+         advance(fixture);\n+         expect(createdComps).toEqual(['parent', 'child', 'child']);\n+       }));\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 111,
        "additions": 80,
        "deletions": 31
    }
}