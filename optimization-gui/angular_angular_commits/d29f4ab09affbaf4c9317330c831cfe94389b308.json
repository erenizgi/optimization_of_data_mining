{
    "author": "bjarkler",
    "message": "fix(docs-infra): fix simple Trusted Types violations (#42800)\n\nAlso introduce a dependency on the Trusted Types type definitions and a\nTrusted Types polyfill, safevalues. Create a security module for common,\nsecurity-reviewed transformations into Trusted Types.\n\nPR Close #42800",
    "sha": "d29f4ab09affbaf4c9317330c831cfe94389b308",
    "files": [
        {
            "sha": "c91c2e933dc4bee603c44f11080a2c23c25289ea",
            "filename": "aio/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fpackage.json?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -100,6 +100,7 @@\n     \"@angular/service-worker\": \"12.1.1\",\n     \"@webcomponents/custom-elements\": \"1.5.0\",\n     \"rxjs\": \"^6.6.7\",\n+    \"safevalues\": \"^0.1.8\",\n     \"tslib\": \"^2.2.0\",\n     \"zone.js\": \"~0.11.4\"\n   },\n@@ -117,6 +118,7 @@\n     \"@types/lunr\": \"^2.3.3\",\n     \"@types/node\": \"^12.7.9\",\n     \"@types/stemmer\": \"^1.0.2\",\n+    \"@types/trusted-types\": \"^2.0.2\",\n     \"@types/xregexp\": \"^4.3.0\",\n     \"@typescript-eslint/eslint-plugin\": \"4.31.0\",\n     \"@typescript-eslint/parser\": \"4.31.0\","
        },
        {
            "sha": "46315018ca0ffc27b4c60648f754161607c0196a",
            "filename": "aio/src/app/custom-elements/code/code-example.component.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fcode%2Fcode-example.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fcode%2Fcode-example.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fcode%2Fcode-example.component.ts?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -88,6 +88,6 @@ export class CodeExampleComponent implements AfterViewInit {\n   ngAfterViewInit() {\n     const contentElem = this.content.nativeElement;\n     this.aioCode.code = contentElem.innerHTML;\n-    contentElem.innerHTML = '';  // Remove DOM nodes that are no longer needed.\n+    contentElem.textContent = '';  // Remove DOM nodes that are no longer needed.\n   }\n }"
        },
        {
            "sha": "a69f45635d488f2b32bf6ddb2d3744b4364a9e85",
            "filename": "aio/src/app/custom-elements/code/code-tabs.component.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fcode%2Fcode-tabs.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fcode%2Fcode-tabs.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Fcode%2Fcode-tabs.component.ts?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -67,7 +67,7 @@ export class CodeTabsComponent implements OnInit, AfterViewInit {\n     // NOTE:\n     // In IE11, doing this also empties the `<code-pane>` nodes captured in `codeExamples` ¯\\_(ツ)_/¯\n     // Only remove the unnecessary nodes after having captured the `<code-pane>` contents.\n-    contentElem.innerHTML = '';\n+    contentElem.textContent = '';\n   }\n \n   ngAfterViewInit() {"
        },
        {
            "sha": "b063e2c73012f055f4abf8e40fcea9f1c18ee3b3",
            "filename": "aio/src/app/custom-elements/lazy-custom-element.component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fcustom-elements%2Flazy-custom-element.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fcustom-elements%2Flazy-custom-element.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fcustom-elements%2Flazy-custom-element.component.ts?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -21,7 +21,8 @@ export class LazyCustomElementComponent implements OnInit {\n       return;\n     }\n \n-    this.elementRef.nativeElement.innerHTML = `<${this.selector}></${this.selector}>`;\n+    this.elementRef.nativeElement.textContent = '';\n+    this.elementRef.nativeElement.appendChild(document.createElement(this.selector));\n     this.elementsLoader.loadCustomElement(this.selector);\n   }\n }"
        },
        {
            "sha": "8914497f249495e18d6f0f44748d04360bd45f9d",
            "filename": "aio/src/app/layout/doc-viewer/doc-viewer.component.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Flayout%2Fdoc-viewer%2Fdoc-viewer.component.ts",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Flayout%2Fdoc-viewer%2Fdoc-viewer.component.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Flayout%2Fdoc-viewer%2Fdoc-viewer.component.ts?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -100,7 +100,9 @@ export class DocViewerComponent implements OnDestroy {\n \n     if (titleEl && needsToc && !embeddedToc) {\n       // Add an embedded ToC if it's needed and there isn't one in the content already.\n-      titleEl.insertAdjacentHTML('afterend', '<aio-toc class=\"embedded\"></aio-toc>');\n+      const toc = document.createElement('aio-toc');\n+      toc.className = 'embedded';\n+      titleEl.parentNode!.insertBefore(toc, titleEl.nextSibling);\n     } else if (!needsToc && embeddedToc && embeddedToc.parentNode !== null) {\n       // Remove the embedded Toc if it's there and not needed.\n       // We cannot use ChildNode.remove() because of IE11\n@@ -145,7 +147,7 @@ export class DocViewerComponent implements OnDestroy {\n         catchError(err => {\n           const errorMessage = `${(err instanceof Error) ? err.stack : err}`;\n           this.logger.error(new Error(`[DocViewer] Error preparing document '${doc.id}': ${errorMessage}`));\n-          this.nextViewContainer.innerHTML = '';\n+          this.nextViewContainer.textContent = '';\n           this.setNoIndex(true);\n \n           // TODO(gkalpak): Remove this once gathering debug info is no longer needed.\n@@ -247,7 +249,7 @@ export class DocViewerComponent implements OnDestroy {\n           const prevViewContainer = this.currViewContainer;\n           this.currViewContainer = this.nextViewContainer;\n           this.nextViewContainer = prevViewContainer;\n-          this.nextViewContainer.innerHTML = '';  // Empty to release memory.\n+          this.nextViewContainer.textContent = '';  // Empty to release memory.\n         }),\n     );\n   }"
        },
        {
            "sha": "70bb11c3ba8161f12533c6d71f3abf11202465a0",
            "filename": "aio/src/app/shared/security.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fshared%2Fsecurity.ts",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fshared%2Fsecurity.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Fsecurity.ts?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -0,0 +1,11 @@\n+import { htmlFromStringKnownToSatisfyTypeContract } from 'safevalues/unsafe/reviewed';\n+\n+export function fromInnerHTML(el: Element): TrustedHTML {\n+  // SECURITY: Existing innerHTML content is already trusted.\n+  return htmlFromStringKnownToSatisfyTypeContract(el.innerHTML, '^');\n+}\n+\n+export function fromOuterHTML(el: Element): TrustedHTML {\n+  // SECURITY: Existing outerHTML content is already trusted.\n+  return htmlFromStringKnownToSatisfyTypeContract(el.outerHTML, '^');\n+}"
        },
        {
            "sha": "bf191d5776e7de8b6c842e20e837f34951ef6398",
            "filename": "aio/src/app/shared/toc.service.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fshared%2Ftoc.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fsrc%2Fapp%2Fshared%2Ftoc.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fshared%2Ftoc.service.ts?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -3,6 +3,8 @@ import { Inject, Injectable } from '@angular/core';\n import { DomSanitizer, SafeHtml } from '@angular/platform-browser';\n import { ReplaySubject } from 'rxjs';\n import { ScrollSpyInfo, ScrollSpyService } from 'app/shared/scroll-spy.service';\n+import { unwrapHtmlForSink } from 'safevalues';\n+import { fromInnerHTML } from './security';\n \n \n export interface TocItem {\n@@ -62,7 +64,7 @@ export class TocService {\n   //   - Mark the HTML as trusted to be used with `[innerHTML]`.\n   private extractHeadingSafeHtml(heading: HTMLHeadingElement) {\n     const div: HTMLDivElement = this.document.createElement('div');\n-    div.innerHTML = heading.innerHTML;\n+    div.innerHTML = unwrapHtmlForSink(fromInnerHTML(heading));\n \n     // Remove any `.github-links` or `.header-link` elements (along with their content).\n     querySelectorAll(div, '.github-links, .header-link').forEach(removeNode);"
        },
        {
            "sha": "00390f3b7ed69e7bb54e20445129bb35f7835508",
            "filename": "aio/tsconfig.app.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Ftsconfig.app.json",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Ftsconfig.app.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftsconfig.app.json?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -2,7 +2,9 @@\n   \"extends\": \"./tsconfig.json\",\n   \"compilerOptions\": {\n     \"outDir\": \"./out-tsc/app\",\n-    \"types\": []\n+    \"types\": [\n+      \"trusted-types\"\n+    ]\n   },\n   \"files\": [\n     \"src/main.ts\","
        },
        {
            "sha": "2ab1043967aa42d0c88f54f28ca50fabae83fb18",
            "filename": "aio/yarn.lock",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fyarn.lock",
            "raw_url": "https://github.com/angular/angular/raw/d29f4ab09affbaf4c9317330c831cfe94389b308/aio%2Fyarn.lock",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fyarn.lock?ref=d29f4ab09affbaf4c9317330c831cfe94389b308",
            "patch": "@@ -1850,6 +1850,11 @@\n   resolved \"https://registry.yarnpkg.com/@types/stemmer/-/stemmer-1.0.2.tgz#bd8354f50b3c9b87c351d169240e45cf1fa1f5e8\"\n   integrity sha512-2gWEIFqVZjjZxo8/TcugCAl7nW9Jd9ArEDpTAc5nH7d+ZUkreHA7GzuFcLZ0sflLrA5b1PZ+2yDyHJcuP9KWWw==\n \n+\"@types/trusted-types@^2.0.2\":\n+  version \"2.0.2\"\n+  resolved \"https://registry.yarnpkg.com/@types/trusted-types/-/trusted-types-2.0.2.tgz#fc25ad9943bcac11cceb8168db4f275e0e72e756\"\n+  integrity sha512-F5DIZ36YVLE+PN+Zwws4kJogq47hNgX3Nx6WyDJ3kcplxyke3XIzB8uK5n/Lpm1HBsbGzd6nmGehL8cPekP+Tg==\n+\n \"@types/unist@*\", \"@types/unist@^2.0.0\", \"@types/unist@^2.0.2\":\n   version \"2.0.6\"\n   resolved \"https://registry.yarnpkg.com/@types/unist/-/unist-2.0.6.tgz#250a7b16c3b91f672a24552ec64678eeb1d3a08d\"\n@@ -11376,6 +11381,11 @@ safeps@7.0.1:\n   resolved \"https://registry.yarnpkg.com/safer-buffer/-/safer-buffer-2.1.2.tgz#44fa161b0187b9549dd84bb91802f9bd8385cd6a\"\n   integrity sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==\n \n+safevalues@^0.1.8:\n+  version \"0.1.8\"\n+  resolved \"https://registry.yarnpkg.com/safevalues/-/safevalues-0.1.8.tgz#a8ab0c060ed40409fdc3df3e9f749964bcba1a8a\"\n+  integrity sha512-pasLBJ7X5L98TWlcaNgycheJAPWCvTH18QP+UjlJLPBNzRhwgtPKaK4bIAxr3cX4l+zXg77WoBLH5pYuEwOEqQ==\n+\n sass-loader@12.1.0:\n   version \"12.1.0\"\n   resolved \"https://registry.yarnpkg.com/sass-loader/-/sass-loader-12.1.0.tgz#b73324622231009da6fba61ab76013256380d201\""
        }
    ],
    "stats": {
        "total": 46,
        "additions": 38,
        "deletions": 8
    }
}