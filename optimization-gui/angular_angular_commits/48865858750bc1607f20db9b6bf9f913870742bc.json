{
    "author": "devversion",
    "message": "feat(bazel): create transition for enabling partial compilation (#43431)\n\nCreates, a currently still unused, Bazel transition that will control\na build setting that is enabling the partial compilation mode for\n`ng_module` rule targets. This is in preparation of implementing the\nAngular Package Format v13 (which should ship in partial compilation).\n\nNote: Various other approaches aside from the `transition` has been\nconsidered. Here is a small summary of the largest ideas that have\nbeen tried for the APF v13 partial compilation refactor.\n\n**Using an aspect for partial compilation in `ng_package`**\n\nSimilar to how we had an aspect for ESM5 compilation in the past,\nan aspect could be used to create partial compilation prodmode output\nfor packaging. The aspect would take the existing prodmode compilation\ndetails and \"replay\" the compilation with a modified tsconfig that\nenables partial compilation.\n\nThis _can_ work but requires lots of caution and is very prone to\nissues. In order to avoid conflicts with the existing prodmode output,\nthe partial compilation outputs would need to be written to a\nsub-directory. This makes module resolution extremely difficult when\n`ng_package` creates the FESM bundles. Also it is difficult to merge\nmultiple of these aspect-compiled folders into a single one for exposing\nthe non-bundled ESM output. It becomes especially difficult to ensure\nthat such an aspect target will actually use the _correct_ dependency\ntype definition when compiled.\n\ne.g. consider a case where a partial compiled target relies on another\nAngular target. The dependency will be compiled partially first, but\nthe other target _needs_ to rely on the partial compilation `d.ts`\noutput of the dependency (and *NOT* the devmode `.d.ts` output). This\nis incorrect and can cause other type-checking issues / or invalid\noutput. To make this work, the module resolution when invoking\ntsc_wrapped would also need to be updated/patched. This is out of scope\nand not reasonable to maintain.\n\n**Exposing a third output flavor directly in the rule**\n\nInstead of replying a compilation, we could expose an output flavor\nnext to `devmode` and `prodmode`. This sounded like the easiest\nsolution at first, but it will have the same problems as the aspect\napproach (in terms of module resoltion and avoiding conflicts of files).\n\nWe cannot control how TS emits `.d.ts` or `.js` files (without patching\ninto the compiler host), so we would need to store the compilation\noutput in a sub-folder similar to the aspect.. resulting in the same\nissues. This is do-able but would require module resolution to be\npatched and we do not have control over `@bazel/typescript`. Also,\n`@bazel/typescript` does not forsee a third output flavor, so that\nlogic would need to be changed significantly as well.\n\nPR Close #43431",
    "sha": "48865858750bc1607f20db9b6bf9f913870742bc",
    "files": [
        {
            "sha": "95ec943ee015706c76a3a6316c2e7ee0587d61a7",
            "filename": "packages/bazel/BUILD.bazel",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2FBUILD.bazel?ref=48865858750bc1607f20db9b6bf9f913870742bc",
            "patch": "@@ -8,13 +8,18 @@ pkg_npm(\n         exclude = [\"yarn.lock\"],\n     ) + [\n         \"//packages/bazel/src:package_assets\",\n+        \"//packages/bazel/src/ng_module:package_assets\",\n         \"//packages/bazel/src/api-extractor:package_assets\",\n         \"//packages/bazel/src/ng_package:package_assets\",\n         \"//packages/bazel/src/ngc-wrapped:package_assets\",\n         \"//packages/bazel/third_party/github.com/bazelbuild/bazel/src/main/protobuf:package_assets\",\n     ],\n     substitutions = {\n         \"(#|//)\\\\s+BEGIN-DEV-ONLY[\\\\w\\\\W]+?(#|//)\\\\s+END-DEV-ONLY\": \"\",\n+        # The partial compilation transition is applied in the user workspace. We do not want to require\n+        # users having to define the build setting, so we directly point the flag label to the place where\n+        # we expect `@angular/bazel` being located. Note: This expects the `@npm//` workspace to be used.\n+        \"//packages/bazel/src:partial_compilation\": \"@npm//@angular/bazel/src:partial_compilation\",\n         \"//packages/bazel/\": \"//@angular/bazel/\",\n         \"@npm//@bazel/typescript/internal:\": \"//@bazel/typescript/internal:\",\n     },"
        },
        {
            "sha": "6ebd35696e2d8c79b3629d682c7f2de94dc0714e",
            "filename": "packages/bazel/src/BUILD.bazel",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2Fsrc%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2Fsrc%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2FBUILD.bazel?ref=48865858750bc1607f20db9b6bf9f913870742bc",
            "patch": "@@ -1,3 +1,4 @@\n+load(\"//packages/bazel/src/ng_module:partial_compilation.bzl\", \"ng_partial_compilation_flag\")\n \n # BEGIN-DEV-ONLY\n package(default_visibility = [\"//packages/bazel:__subpackages__\"])\n@@ -7,3 +8,9 @@ filegroup(\n     srcs = glob([\"*\"]),\n )\n # END-DEV-ONLY\n+\n+ng_partial_compilation_flag(\n+    name = \"partial_compilation\",\n+    build_setting_default = False,\n+    visibility = [\"//visibility:public\"],\n+)"
        },
        {
            "sha": "ff253742bd62f967243c0046426b4f7cb85dba1d",
            "filename": "packages/bazel/src/ng_module/BUILD.bazel",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2Fsrc%2Fng_module%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2Fsrc%2Fng_module%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module%2FBUILD.bazel?ref=48865858750bc1607f20db9b6bf9f913870742bc",
            "patch": "@@ -0,0 +1,8 @@\n+# BEGIN-DEV-ONLY\n+package(default_visibility = [\"//packages/bazel:__subpackages__\"])\n+\n+filegroup(\n+    name = \"package_assets\",\n+    srcs = glob([\"*\"]),\n+)\n+# END-DEV-ONLY"
        },
        {
            "sha": "15b798454823d1ee291b6a1735ce035d57e5c419",
            "filename": "packages/bazel/src/ng_module/partial_compilation.bzl",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2Fsrc%2Fng_module%2Fpartial_compilation.bzl",
            "raw_url": "https://github.com/angular/angular/raw/48865858750bc1607f20db9b6bf9f913870742bc/packages%2Fbazel%2Fsrc%2Fng_module%2Fpartial_compilation.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module%2Fpartial_compilation.bzl?ref=48865858750bc1607f20db9b6bf9f913870742bc",
            "patch": "@@ -0,0 +1,25 @@\n+# Copyright Google LLC All Rights Reserved.\n+#\n+# Use of this source code is governed by an MIT-style license that can be\n+# found in the LICENSE file at https://angular.io/license\n+\n+NgPartialCompilationInfo = provider(\n+    fields = {\"enabled\": \"Whether partial compilation is enabled.\"},\n+)\n+\n+def _ng_partial_compilation_flag_impl(ctx):\n+    return NgPartialCompilationInfo(enabled = ctx.build_setting_value)\n+\n+ng_partial_compilation_flag = rule(\n+    implementation = _ng_partial_compilation_flag_impl,\n+    build_setting = config.bool(flag = True),\n+)\n+\n+def _partial_compilation_transition_impl(settings, attr):\n+    return {\"//packages/bazel/src:partial_compilation\": True}\n+\n+partial_compilation_transition = transition(\n+    implementation = _partial_compilation_transition_impl,\n+    inputs = [],\n+    outputs = [\"//packages/bazel/src:partial_compilation\"],\n+)"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 45,
        "deletions": 0
    }
}