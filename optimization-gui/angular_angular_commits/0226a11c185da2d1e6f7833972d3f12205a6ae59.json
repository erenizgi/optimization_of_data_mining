{
    "author": "atscott",
    "message": "fix(language-service): Only provide Angular property completions in templates (#41278)\n\nWhen possible, the @angular/language-service should only provide\ninformation related to Angular. When there is an embedded language, like\ninline templates, editor extensions should have the ability to create\nvirtual documents and forward the requests to the relevant providers for\nthat language type (see https://github.com/angular/vscode-ng-language-service/pull/1212).\n\nThis commit removes all dom schema completions in both inline and\nexternal templates and provides only the Angular syntax for property completions\non elements.\n\nPR Close #41278",
    "sha": "0226a11c185da2d1e6f7833972d3f12205a6ae59",
    "files": [
        {
            "sha": "4752c3983de3ae877aa6fe12855de8d02f70e696",
            "filename": "packages/language-service/ivy/attribute_completions.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 34,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts",
            "raw_url": "https://github.com/angular/angular/raw/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fattribute_completions.ts?ref=0226a11c185da2d1e6f7833972d3f12205a6ae59",
            "patch": "@@ -68,9 +68,11 @@ export interface DomAttributeCompletion {\n   attribute: string;\n \n   /**\n-   * Whether this attribute is also a DOM property.\n+   * Whether this attribute is also a DOM property. Note that this is required to be `true` because\n+   * we only want to provide DOM attributes when there is an Angular syntax associated with them\n+   * (`[propertyName]=\"\"`).\n    */\n-  isAlsoProperty: boolean;\n+  isAlsoProperty: true;\n }\n \n /**\n@@ -180,8 +182,7 @@ export type AttributeCompletion = DomAttributeCompletion|DomPropertyCompletion|\n  */\n export function buildAttributeCompletionTable(\n     component: ts.ClassDeclaration, element: TmplAstElement|TmplAstTemplate,\n-    checker: TemplateTypeChecker,\n-    includeDomSchemaAttributes: boolean): Map<string, AttributeCompletion> {\n+    checker: TemplateTypeChecker): Map<string, AttributeCompletion> {\n   const table = new Map<string, AttributeCompletion>();\n \n   // Use the `ElementSymbol` or `TemplateSymbol` to iterate over directives present on the node, and\n@@ -333,22 +334,16 @@ export function buildAttributeCompletionTable(\n   }\n \n   // Finally, add any DOM attributes not already covered by inputs.\n-  if (element instanceof TmplAstElement && includeDomSchemaAttributes) {\n+  if (element instanceof TmplAstElement) {\n     for (const {attribute, property} of checker.getPotentialDomBindings(element.name)) {\n       const isAlsoProperty = attribute === property;\n-      if (!table.has(attribute)) {\n+      if (!table.has(attribute) && isAlsoProperty) {\n         table.set(attribute, {\n           kind: AttributeCompletionKind.DomAttribute,\n           attribute,\n           isAlsoProperty,\n         });\n       }\n-      if (!isAlsoProperty && !table.has(property)) {\n-        table.set(property, {\n-          kind: AttributeCompletionKind.DomProperty,\n-          property,\n-        });\n-      }\n     }\n   }\n \n@@ -449,30 +444,14 @@ export function addAttributeCompletionEntries(\n       break;\n     }\n     case AttributeCompletionKind.DomAttribute: {\n-      if (isAttributeContext) {\n-        // Offer a completion of an attribute binding.\n-        entries.push({\n-          kind: unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n-          name: completion.attribute,\n-          sortText: completion.attribute,\n-          replacementSpan,\n-        });\n-        if (completion.isAlsoProperty) {\n-          // Offer a completion of a property binding to the DOM property.\n-          entries.push({\n-            kind: unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n-            name: `[${completion.attribute}]`,\n-            // In the case of DOM attributes, the property binding should sort after the attribute\n-            // binding.\n-            sortText: completion.attribute + '_1',\n-            replacementSpan,\n-          });\n-        }\n-      } else if (completion.isAlsoProperty) {\n+      if (isAttributeContext && completion.isAlsoProperty) {\n+        // Offer a completion of a property binding to the DOM property.\n         entries.push({\n           kind: unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n-          name: completion.attribute,\n-          sortText: completion.attribute,\n+          name: `[${completion.attribute}]`,\n+          // In the case of DOM attributes, the property binding should sort after the attribute\n+          // binding.\n+          sortText: completion.attribute + '_1',\n           replacementSpan,\n         });\n       }"
        },
        {
            "sha": "49f6b136824f97cf66af990ec64a6167c3819784",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=0226a11c185da2d1e6f7833972d3f12205a6ae59",
            "patch": "@@ -57,7 +57,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n   constructor(\n       private readonly tsLS: ts.LanguageService, private readonly compiler: NgCompiler,\n       private readonly component: ts.ClassDeclaration, private readonly node: N,\n-      private readonly targetDetails: TemplateTarget, private readonly inlineTemplate: boolean) {}\n+      private readonly targetDetails: TemplateTarget) {}\n \n   /**\n    * Analogue for `ts.LanguageService.getCompletionsAtPosition`.\n@@ -371,11 +371,9 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     const replacementSpan: ts.TextSpan = {start, length};\n \n     let potentialTags = Array.from(templateTypeChecker.getPotentialElementTags(this.component));\n-    if (!this.inlineTemplate) {\n-      // If we are in an external template, don't provide non-Angular tags (directive === null)\n-      // because we expect other extensions (i.e. Emmet) to provide those for HTML files.\n-      potentialTags = potentialTags.filter(([_, directive]) => directive !== null);\n-    }\n+    // Don't provide non-Angular tags (directive === null) because we expect other extensions (i.e.\n+    // Emmet) to provide those for HTML files.\n+    potentialTags = potentialTags.filter(([_, directive]) => directive !== null);\n     const entries: ts.CompletionEntry[] = potentialTags.map(([tag, directive]) => ({\n                                                               kind: tagCompletionKind(directive),\n                                                               name: tag,\n@@ -462,7 +460,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n \n     const attrTable = buildAttributeCompletionTable(\n-        this.component, element, this.compiler.getTemplateTypeChecker(), this.inlineTemplate);\n+        this.component, element, this.compiler.getTemplateTypeChecker());\n \n     let entries: ts.CompletionEntry[] = [];\n \n@@ -536,7 +534,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n \n     const attrTable = buildAttributeCompletionTable(\n-        this.component, element, this.compiler.getTemplateTypeChecker(), this.inlineTemplate);\n+        this.component, element, this.compiler.getTemplateTypeChecker());\n \n     if (!attrTable.has(name)) {\n       return undefined;\n@@ -603,7 +601,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     }\n \n     const attrTable = buildAttributeCompletionTable(\n-        this.component, element, this.compiler.getTemplateTypeChecker(), this.inlineTemplate);\n+        this.component, element, this.compiler.getTemplateTypeChecker());\n \n     if (!attrTable.has(name)) {\n       return undefined;"
        },
        {
            "sha": "3ac3d5ff49aae8e0794a15d88213110778349f00",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=0226a11c185da2d1e6f7833972d3f12205a6ae59",
            "patch": "@@ -211,8 +211,7 @@ export class LanguageService {\n         positionDetails.context.nodes[0] :\n         positionDetails.context.node;\n     return new CompletionBuilder(\n-        this.tsLS, compiler, templateInfo.component, node, positionDetails,\n-        isTypeScriptFile(fileName));\n+        this.tsLS, compiler, templateInfo.component, node, positionDetails);\n   }\n \n   getCompletionsAtPosition("
        },
        {
            "sha": "b881a614e7ce7702721973b55047afa125c6a5bb",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 8,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0226a11c185da2d1e6f7833972d3f12205a6ae59/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=0226a11c185da2d1e6f7833972d3f12205a6ae59",
            "patch": "@@ -308,11 +308,11 @@ describe('completions', () => {\n           ['div', 'span']);\n     });\n \n-    it('should return DOM completions', () => {\n+    it('should not return DOM completions for inline template', () => {\n       const {appFile} = setupInlineTemplate(`<div>`, '');\n       appFile.moveCursorToText('<div¦>');\n       const completions = appFile.getCompletionsAtPosition();\n-      expectContain(\n+      expectDoesNotContain(\n           completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ELEMENT),\n           ['div', 'span']);\n     });\n@@ -431,20 +431,25 @@ describe('completions', () => {\n \n     describe('element attribute scope', () => {\n       describe('dom completions', () => {\n-        it('should not return completions dom completions in external template', () => {\n+        it('should return dom property completions in external template', () => {\n           const {templateFile} = setup(`<input >`, '');\n           templateFile.moveCursorToText('<input ¦>');\n \n           const completions = templateFile.getCompletionsAtPosition();\n-          expect(completions?.entries.length).toBe(0);\n+          expectDoesNotContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n+              ['value']);\n+          expectContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n+              ['[value]']);\n         });\n \n-        it('should return completions for a new element attribute', () => {\n+        it('should return completions for a new element property', () => {\n           const {appFile} = setupInlineTemplate(`<input >`, '');\n           appFile.moveCursorToText('<input ¦>');\n \n           const completions = appFile.getCompletionsAtPosition();\n-          expectContain(\n+          expectDoesNotContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n           expectContain(\n@@ -457,7 +462,7 @@ describe('completions', () => {\n           appFile.moveCursorToText('<input val¦>');\n \n           const completions = appFile.getCompletionsAtPosition();\n-          expectContain(\n+          expectDoesNotContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n               ['value']);\n           expectContain(\n@@ -477,7 +482,7 @@ describe('completions', () => {\n           expectDoesNotContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['[value]']);\n-          expectContain(\n+          expectDoesNotContain(\n               completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PROPERTY),\n               ['value']);\n           expectReplacementText(completions, appFile.contents, 'val');"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 34,
        "deletions": 53
    }
}