{
    "author": "JoostK",
    "message": "refactor(compiler-cli): separate used components from used directives in partial declaration (#41104)\n\nThe partial declaration of a component includes the list of directives\nthat are used in its template, including some metadata of the directive\nwhich can be used during actual compilation of the component. Used\ncomponents are currently part of this list, as components are also\ndirectives. This commit splits the used components into a dedicate\nproperty in the partial declaration, which allows for template\ncompilation to optimize the generated code for components.\n\nPR Close #41104",
    "sha": "eb74a9693507415e191cd803623521e04d0c79c3",
    "files": [
        {
            "sha": "d2d0d09f004608c2f5ddef5289e4fc8d3a61f1da",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 27,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {compileComponentFromMetadata, ConstantPool, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig, makeBindingParser, parseTemplate, R3ComponentMetadata, R3DeclareComponentMetadata, R3PartialDeclaration, R3UsedDirectiveMetadata} from '@angular/compiler';\n+import {compileComponentFromMetadata, ConstantPool, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig, makeBindingParser, parseTemplate, R3ComponentMetadata, R3DeclareComponentMetadata, R3DeclareUsedDirectiveMetadata, R3PartialDeclaration, R3UsedDirectiveMetadata} from '@angular/compiler';\n import {ChangeDetectionStrategy, ViewEncapsulation} from '@angular/compiler/src/core';\n import * as o from '@angular/compiler/src/output/output_ast';\n \n@@ -74,34 +74,42 @@ export class PartialComponentLinkerVersion1<TStatement, TExpression> implements\n \n     let declarationListEmitMode = DeclarationListEmitMode.Direct;\n \n+    const collectUsedDirectives =\n+        (directives: AstValue<R3DeclareUsedDirectiveMetadata, TExpression>[]) => {\n+          return directives.map(directive => {\n+            const directiveExpr = directive.getObject();\n+            const type = directiveExpr.getValue('type');\n+            const selector = directiveExpr.getString('selector');\n+\n+            let typeExpr = type.getOpaque();\n+            const forwardRefType = extractForwardRef(type);\n+            if (forwardRefType !== null) {\n+              typeExpr = forwardRefType;\n+              declarationListEmitMode = DeclarationListEmitMode.Closure;\n+            }\n+\n+            return {\n+              type: typeExpr,\n+              selector: selector,\n+              inputs: directiveExpr.has('inputs') ?\n+                  directiveExpr.getArray('inputs').map(input => input.getString()) :\n+                  [],\n+              outputs: directiveExpr.has('outputs') ?\n+                  directiveExpr.getArray('outputs').map(input => input.getString()) :\n+                  [],\n+              exportAs: directiveExpr.has('exportAs') ?\n+                  directiveExpr.getArray('exportAs').map(exportAs => exportAs.getString()) :\n+                  null,\n+            };\n+          });\n+        };\n+\n     let directives: R3UsedDirectiveMetadata[] = [];\n+    if (metaObj.has('components')) {\n+      directives.push(...collectUsedDirectives(metaObj.getArray('components')));\n+    }\n     if (metaObj.has('directives')) {\n-      directives = metaObj.getArray('directives').map(directive => {\n-        const directiveExpr = directive.getObject();\n-        const type = directiveExpr.getValue('type');\n-        const selector = directiveExpr.getString('selector');\n-\n-        let typeExpr = type.getOpaque();\n-        const forwardRefType = extractForwardRef(type);\n-        if (forwardRefType !== null) {\n-          typeExpr = forwardRefType;\n-          declarationListEmitMode = DeclarationListEmitMode.Closure;\n-        }\n-\n-        return {\n-          type: typeExpr,\n-          selector: selector,\n-          inputs: directiveExpr.has('inputs') ?\n-              directiveExpr.getArray('inputs').map(input => input.getString()) :\n-              [],\n-          outputs: directiveExpr.has('outputs') ?\n-              directiveExpr.getArray('outputs').map(input => input.getString()) :\n-              [],\n-          exportAs: directiveExpr.has('exportAs') ?\n-              directiveExpr.getArray('exportAs').map(exportAs => exportAs.getString()) :\n-              null,\n-        };\n-      });\n+      directives.push(...collectUsedDirectives(metaObj.getArray('directives')));\n     }\n \n     let pipes = new Map<string, o.Expression>();"
        },
        {
            "sha": "8af31a6ed51daa8e2586160ef882f0d2ae2673dc",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -181,7 +181,7 @@ SomeComp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type:\n export class MyApp {\n }\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n-MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: '<some-comp [prop]=\"{}\" [otherProp]=\"{a: 1, b: 2}\"></some-comp>', isInline: true, directives: [{ type: SomeComp, selector: \"some-comp\", inputs: [\"prop\", \"otherProp\"] }] });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: '<some-comp [prop]=\"{}\" [otherProp]=\"{a: 1, b: 2}\"></some-comp>', isInline: true, components: [{ type: SomeComp, selector: \"some-comp\", inputs: [\"prop\", \"otherProp\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{ template: '<some-comp [prop]=\"{}\" [otherProp]=\"{a: 1, b: 2}\"></some-comp>' }]\n@@ -236,7 +236,7 @@ SomeComp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type:\n export class MyApp {\n }\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n-MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: '<some-comp [prop]=\"[]\" [otherProp]=\"[0, 1, 2]\"></some-comp>', isInline: true, directives: [{ type: SomeComp, selector: \"some-comp\", inputs: [\"prop\", \"otherProp\"] }] });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"ng-component\", ngImport: i0, template: '<some-comp [prop]=\"[]\" [otherProp]=\"[0, 1, 2]\"></some-comp>', isInline: true, components: [{ type: SomeComp, selector: \"some-comp\", inputs: [\"prop\", \"otherProp\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{ template: '<some-comp [prop]=\"[]\" [otherProp]=\"[0, 1, 2]\"></some-comp>' }]"
        },
        {
            "sha": "b79831460d03050adb675d5d41675d5afc7b0196",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/content_projection/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fcontent_projection%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fcontent_projection%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fcontent_projection%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -29,7 +29,7 @@ ComplexComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\n export class MyApp {\n }\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n-MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<simple>content</simple> <complex></complex>', isInline: true, directives: [{ type: SimpleComponent, selector: \"simple\" }, { type: ComplexComponent, selector: \"complex\" }] });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<simple>content</simple> <complex></complex>', isInline: true, components: [{ type: SimpleComponent, selector: \"simple\" }, { type: ComplexComponent, selector: \"complex\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{ selector: 'my-app', template: '<simple>content</simple> <complex></complex>' }]\n@@ -224,7 +224,7 @@ SimpleComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\"\n export class MyApp {\n }\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n-MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<simple><h1 ngProjectAs=\"[title]\"></h1></simple>', isInline: true, directives: [{ type: SimpleComponent, selector: \"simple\" }] });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<simple><h1 ngProjectAs=\"[title]\"></h1></simple>', isInline: true, components: [{ type: SimpleComponent, selector: \"simple\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{ selector: 'my-app', template: '<simple><h1 ngProjectAs=\"[title]\"></h1></simple>' }]\n@@ -273,7 +273,7 @@ SimpleComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\"\n export class MyApp {\n }\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n-MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<simple><h1 ngProjectAs=\"[title],[header]\"></h1></simple>', isInline: true, directives: [{ type: SimpleComponent, selector: \"simple\" }] });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<simple><h1 ngProjectAs=\"[title],[header]\"></h1></simple>', isInline: true, components: [{ type: SimpleComponent, selector: \"simple\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{ selector: 'my-app', template: '<simple><h1 ngProjectAs=\"[title],[header]\"></h1></simple>' }]"
        },
        {
            "sha": "3f5de1ea6f78de8de2d772e9148bcfc2f138889b",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/lifecycle_hooks/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Flifecycle_hooks%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Flifecycle_hooks%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Flifecycle_hooks%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -211,7 +211,7 @@ SimpleLayout.ɵfac = function SimpleLayout_Factory(t) { return new (t || SimpleL\n SimpleLayout.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: SimpleLayout, selector: \"simple-layout\", ngImport: i0, template: `\n     <lifecycle-comp [name]=\"name1\"></lifecycle-comp>\n     <lifecycle-comp [name]=\"name2\"></lifecycle-comp>\n-  `, isInline: true, directives: [{ type: LifecycleComp, selector: \"lifecycle-comp\", inputs: [\"name\"] }] });\n+  `, isInline: true, components: [{ type: LifecycleComp, selector: \"lifecycle-comp\", inputs: [\"name\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(SimpleLayout, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "b7cbcb9b75819fbf271de4d75e81dcc1bcc01da5",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/queries/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fqueries%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -365,7 +365,7 @@ MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: My\n     <content-query-component>\n       <div someDir></div>\n     </content-query-component>\n-  `, isInline: true, directives: [{ type: i0.forwardRef(function () { return ContentQueryComponent; }), selector: \"content-query-component\" }, { type: i0.forwardRef(function () { return SomeDirective; }), selector: \"[someDir]\" }] });\n+  `, isInline: true, components: [{ type: i0.forwardRef(function () { return ContentQueryComponent; }), selector: \"content-query-component\" }], directives: [{ type: i0.forwardRef(function () { return SomeDirective; }), selector: \"[someDir]\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{\n@@ -524,7 +524,7 @@ MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: My\n     <content-query-component>\n       <div someDir></div>\n     </content-query-component>\n-  `, isInline: true, directives: [{ type: i0.forwardRef(function () { return ContentQueryComponent; }), selector: \"content-query-component\" }, { type: i0.forwardRef(function () { return SomeDirective; }), selector: \"[someDir]\" }] });\n+  `, isInline: true, components: [{ type: i0.forwardRef(function () { return ContentQueryComponent; }), selector: \"content-query-component\" }], directives: [{ type: i0.forwardRef(function () { return SomeDirective; }), selector: \"[someDir]\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "b47646b927cd8c34db0ed58268984af429179573",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/components_and_directives/value_composition/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Fcomponents_and_directives%2Fvalue_composition%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -22,7 +22,7 @@ SomeDirective.ɵdir = i0.ɵɵngDeclareDirective({ version: \"0.0.0-PLACEHOLDER\",\n export class MyComponent {\n }\n MyComponent.ɵfac = function MyComponent_Factory(t) { return new (t || MyComponent)(); };\n-MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: '<child some-directive></child>!', isInline: true, directives: [{ type: ChildComponent, selector: \"child\" }, { type: SomeDirective, selector: \"[some-directive]\" }] });\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: '<child some-directive></child>!', isInline: true, components: [{ type: ChildComponent, selector: \"child\" }], directives: [{ type: SomeDirective, selector: \"[some-directive]\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n         type: Component,\n         args: [{ selector: 'my-component', template: '<child some-directive></child>!' }]\n@@ -329,7 +329,7 @@ export class MyApp {\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n   <my-comp [names]=\"['Nancy', customName]\"></my-comp>\n-`, isInline: true, directives: [{ type: MyComp, selector: \"my-comp\", inputs: [\"names\"] }] });\n+`, isInline: true, components: [{ type: MyComp, selector: \"my-comp\", inputs: [\"names\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{\n@@ -428,7 +428,7 @@ MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n   <my-comp [names]=\"['start-', n0, n1, n2, n3, n4, '-middle-', n5, n6, n7, n8, '-end']\">\n   </my-comp>\n-`, isInline: true, directives: [{ type: MyComp, selector: \"my-comp\", inputs: [\"names\"] }] });\n+`, isInline: true, components: [{ type: MyComp, selector: \"my-comp\", inputs: [\"names\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{\n@@ -509,7 +509,7 @@ export class MyApp {\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n   <object-comp [config]=\"{'duration': 500, animation: name}\"></object-comp>\n-`, isInline: true, directives: [{ type: ObjectComp, selector: \"object-comp\", inputs: [\"config\"] }] });\n+`, isInline: true, components: [{ type: ObjectComp, selector: \"object-comp\", inputs: [\"config\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{\n@@ -587,7 +587,7 @@ MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: `\n   <nested-comp [config]=\"{animation: name, actions: [{ opacity: 0, duration: 0}, {opacity: 1, duration: duration }]}\">\n   </nested-comp>\n-`, isInline: true, directives: [{ type: NestedComp, selector: \"nested-comp\", inputs: [\"config\"] }] });\n+`, isInline: true, components: [{ type: NestedComp, selector: \"nested-comp\", inputs: [\"config\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "7f38d8cf9da6767078a8641902cbbdaa9e7dc738",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/elements/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -62,7 +62,7 @@ InfinityCmp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", ty\n export class MyComponent {\n }\n MyComponent.ɵfac = function MyComponent_Factory(t) { return new (t || MyComponent)(); };\n-MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: '<div class=\"my-app\" title=\"Hello\"><math><infinity/></math><p>test</p></div>', isInline: true, directives: [{ type: MathCmp, selector: \"math\" }, { type: InfinityCmp, selector: \"infinity\" }] });\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: '<div class=\"my-app\" title=\"Hello\"><math><infinity/></math><p>test</p></div>', isInline: true, components: [{ type: MathCmp, selector: \"math\" }, { type: InfinityCmp, selector: \"infinity\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "715b3fc61ac30bb61f537a9f94dbb4e08d0568bb",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -9,7 +9,7 @@ export class MyApp {\n     }\n }\n MyApp.ɵfac = function MyApp_Factory(t) { return new (t || MyApp)(); };\n-MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<todo [data]=\"list\"></todo>', isInline: true, directives: [{ type: i0.forwardRef(function () { return TodoComponent; }), selector: \"todo\", inputs: [\"data\"] }] });\n+MyApp.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyApp, selector: \"my-app\", ngImport: i0, template: '<todo [data]=\"list\"></todo>', isInline: true, components: [{ type: i0.forwardRef(function () { return TodoComponent; }), selector: \"todo\", inputs: [\"data\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyApp, [{\n         type: Component,\n         args: [{ selector: 'my-app', template: '<todo [data]=\"list\"></todo>' }]"
        },
        {
            "sha": "27a2235efdbf0ce40e037019d155627669e5be06",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_bindings/attribute_bindings/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fattribute_bindings%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fattribute_bindings%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fattribute_bindings%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -158,7 +158,7 @@ MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", ty\n     <button [attr.title]=\"myTitle\" [attr.id]=\"buttonId\" [attr.tabindex]=\"1\"></button>\n     <span [attr.id]=\"1\" [attr.title]=\"'hello'\" [attr.some-attr]=\"1 + 2\"></span>\n     <custom-element [attr.some-attr]=\"'one'\" [attr.some-other-attr]=\"2\"></custom-element>\n-  `, isInline: true, directives: [{ type: CustomEl, selector: \"custom-element\" }] });\n+  `, isInline: true, components: [{ type: CustomEl, selector: \"custom-element\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "1be3bd873572fb59e7b799d94c7da32c742f6b1b",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_bindings/property_bindings/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fproperty_bindings%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fproperty_bindings%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_bindings%2Fproperty_bindings%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -519,7 +519,7 @@ MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", ty\n     <button [title]=\"myTitle\" [id]=\"buttonId\" [tabindex]=\"1\"></button>\n     <span [id]=\"1\" [title]=\"'hello'\" [someProp]=\"1 + 2\"></span>\n     <custom-element [prop]=\"'one'\" [otherProp]=\"2\"></custom-element>\n-  `, isInline: true, directives: [{ type: SpanDir, selector: \"span\", inputs: [\"someProp\"] }, { type: CustomEl, selector: \"custom-element\", inputs: [\"prop\", \"otherProp\"] }] });\n+  `, isInline: true, components: [{ type: CustomEl, selector: \"custom-element\", inputs: [\"prop\", \"otherProp\"] }], directives: [{ type: SpanDir, selector: \"span\", inputs: [\"someProp\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "f96b4a7bca92d95763d1c0cca847d219460276eb",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_listener/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_listener%2FGOLDEN_PARTIAL.js?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -54,7 +54,7 @@ export class MyComponent {\n     onClick(event) { }\n }\n MyComponent.ɵfac = function MyComponent_Factory(t) { return new (t || MyComponent)(); };\n-MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `<my-app (click)=\"onClick($event);\"></my-app>`, isInline: true, directives: [{ type: MyApp, selector: \"my-app\" }] });\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `<my-app (click)=\"onClick($event);\"></my-app>`, isInline: true, components: [{ type: MyApp, selector: \"my-app\" }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n         type: Component,\n         args: [{ selector: 'my-component', template: `<my-app (click)=\"onClick($event);\"></my-app>` }]\n@@ -268,7 +268,7 @@ MyComponent.ɵfac = function MyComponent_Factory(t) { return new (t || MyCompone\n MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `\n       <div (click)=\"click()\" (change)=\"change()\"></div>\n       <some-comp (update)=\"update()\" (delete)=\"delete()\"></some-comp>\n-    `, isInline: true, directives: [{ type: SomeComp, selector: \"some-comp\", outputs: [\"update\", \"delete\"] }] });\n+    `, isInline: true, components: [{ type: SomeComp, selector: \"some-comp\", outputs: [\"update\", \"delete\"] }] });\n (function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n         type: Component,\n         args: [{"
        },
        {
            "sha": "fa9e4d5895c6b763a8d58d75ca25f62386df5e80",
            "filename": "packages/compiler/src/render3/partial/api.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 27,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fapi.ts?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -134,38 +134,20 @@ export interface R3DeclareComponentMetadata extends R3DeclareDirectiveMetadata {\n   styles?: string[];\n \n   /**\n-   * List of directives which matched in the template, including sufficient\n+   * List of components which matched in the template, including sufficient\n    * metadata for each directive to attribute bindings and references within\n    * the template to each directive specifically, if the runtime instructions\n    * support this.\n    */\n-  directives?: {\n-    /**\n-     * Selector of the directive.\n-     */\n-    selector: string;\n-\n-    /**\n-     * Reference to the directive class (possibly a forward reference wrapped in a `forwardRef`\n-     * invocation).\n-     */\n-    type: o.Expression | (() => o.Expression);\n+  components?: R3DeclareUsedDirectiveMetadata[];\n \n-    /**\n-     * Property names of the directive's inputs.\n-     */\n-    inputs?: string[];\n-\n-    /**\n-     * Event names of the directive's outputs.\n-     */\n-    outputs?: string[];\n-\n-    /**\n-     * Names by which this directive exports itself for references.\n-     */\n-    exportAs?: string[];\n-  }[];\n+  /**\n+   * List of directives which matched in the template, including sufficient\n+   * metadata for each directive to attribute bindings and references within\n+   * the template to each directive specifically, if the runtime instructions\n+   * support this.\n+   */\n+  directives?: R3DeclareUsedDirectiveMetadata[];\n \n   /**\n    * A map of pipe names to an expression referencing the pipe type (possibly a forward reference\n@@ -206,6 +188,34 @@ export interface R3DeclareComponentMetadata extends R3DeclareDirectiveMetadata {\n   preserveWhitespaces?: boolean;\n }\n \n+export interface R3DeclareUsedDirectiveMetadata {\n+  /**\n+   * Selector of the directive.\n+   */\n+  selector: string;\n+\n+  /**\n+   * Reference to the directive class (possibly a forward reference wrapped in a `forwardRef`\n+   * invocation).\n+   */\n+  type: o.Expression|(() => o.Expression);\n+\n+  /**\n+   * Property names of the directive's inputs.\n+   */\n+  inputs?: string[];\n+\n+  /**\n+   * Event names of the directive's outputs.\n+   */\n+  outputs?: string[];\n+\n+  /**\n+   * Names by which this directive exports itself for references.\n+   */\n+  exportAs?: string[];\n+}\n+\n export interface R3DeclareQueryMetadata {\n   /**\n    * Name of the property on the class to update with query results."
        },
        {
            "sha": "d54f1e7b842d9178609dbbda699974ebcccdc0dd",
            "filename": "packages/compiler/src/render3/partial/component.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/eb74a9693507415e191cd803623521e04d0c79c3/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts?ref=eb74a9693507415e191cd803623521e04d0c79c3",
            "patch": "@@ -16,7 +16,7 @@ import {createComponentType} from '../view/compiler';\n import {ParsedTemplate} from '../view/template';\n import {DefinitionMap} from '../view/util';\n \n-import {R3DeclareComponentMetadata} from './api';\n+import {R3DeclareComponentMetadata, R3DeclareUsedDirectiveMetadata} from './api';\n import {createDirectiveDefinitionMap} from './directive';\n import {toOptionalLiteralArray} from './util';\n \n@@ -48,7 +48,12 @@ export function createComponentDefinitionMap(meta: R3ComponentMetadata, template\n   }\n \n   definitionMap.set('styles', toOptionalLiteralArray(meta.styles, o.literal));\n-  definitionMap.set('directives', compileUsedDirectiveMetadata(meta));\n+  definitionMap.set(\n+      'components',\n+      compileUsedDirectiveMetadata(meta, directive => directive.isComponent === true));\n+  definitionMap.set(\n+      'directives',\n+      compileUsedDirectiveMetadata(meta, directive => directive.isComponent !== true));\n   definitionMap.set('pipes', compileUsedPipeMetadata(meta));\n   definitionMap.set('viewProviders', meta.viewProviders);\n   definitionMap.set('animations', meta.animations);\n@@ -119,13 +124,16 @@ function computeEndLocation(file: ParseSourceFile, contents: string): ParseLocat\n  * Compiles the directives as registered in the component metadata into an array literal of the\n  * individual directives. If the component does not use any directives, then null is returned.\n  */\n-function compileUsedDirectiveMetadata(meta: R3ComponentMetadata): o.LiteralArrayExpr|null {\n+function compileUsedDirectiveMetadata(\n+    meta: R3ComponentMetadata,\n+    predicate: (directive: R3UsedDirectiveMetadata) => boolean): o.LiteralArrayExpr|null {\n   const wrapType = meta.declarationListEmitMode !== DeclarationListEmitMode.Direct ?\n       generateForwardRef :\n       (expr: o.Expression) => expr;\n \n-  return toOptionalLiteralArray(meta.directives, directive => {\n-    const dirMeta = new DefinitionMap<R3UsedDirectiveMetadata>();\n+  const directives = meta.directives.filter(predicate);\n+  return toOptionalLiteralArray(directives, directive => {\n+    const dirMeta = new DefinitionMap<R3DeclareUsedDirectiveMetadata>();\n     dirMeta.set('type', wrapType(directive.type));\n     dirMeta.set('selector', o.literal(directive.selector));\n     dirMeta.set('inputs', toOptionalLiteralArray(directive.inputs, o.literal));"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 104,
        "deletions": 78
    }
}