{
    "author": "atscott",
    "message": "refactor(compiler-cli): Add flag to TCB for non-diagnostic requests (#40071)\n\nThe TCB utility functions used to find nodes in the TCB are currently\nconfigured to ignore results when an ignore marker is found. However,\nthese ignore markers are only meant to affect diagnostics requests. The\nLanguage Service may have a need to find nodes with diagnostic ignore\nmarkers. The most common example of this would be finding references for\ngeneric directives. The reference appears to the generic directive's\nclass appears on the type ctor in the TCB, which is ignored for\ndiagnostic purposes.\nThese functions should only skip results when the request is in the\ncontext of a larger request for _diagnostics_. In all other cases, we\nshould get matches, even if a diagnostic ignore marker is encountered.\n\nPR Close #40071",
    "sha": "6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8",
    "files": [
        {
            "sha": "0a032a995c11b422e6d64cda046bd65eb5e2d378",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8",
            "patch": "@@ -121,12 +121,12 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       throw new Error(`Error: no shim file in program: ${shimPath}`);\n     }\n \n-    let tcb: ts.Node|null = findTypeCheckBlock(shimSf, id);\n+    let tcb: ts.Node|null = findTypeCheckBlock(shimSf, id, /*isDiagnosticsRequest*/ false);\n \n     if (tcb === null) {\n       // Try for an inline block.\n       const inlineSf = getSourceFileOrError(program, sfPath);\n-      tcb = findTypeCheckBlock(inlineSf, id);\n+      tcb = findTypeCheckBlock(inlineSf, id, /*isDiagnosticsRequest*/ false);\n     }\n \n     let data: TemplateData|null = null;\n@@ -194,7 +194,8 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     if (shimSf === undefined) {\n       return null;\n     }\n-    return getTemplateMapping(shimSf, positionInShimFile, fileRecord.sourceManager);\n+    return getTemplateMapping(\n+        shimSf, positionInShimFile, fileRecord.sourceManager, /*isDiagnosticsRequest*/ false);\n   }\n \n   generateAllTypeCheckBlocks() {"
        },
        {
            "sha": "cd828872b66cfa5fe7e0a41e4135bb74c66b9420",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/diagnostics.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts?ref=6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8",
            "patch": "@@ -91,7 +91,8 @@ export function translateDiagnostic(\n   if (diagnostic.file === undefined || diagnostic.start === undefined) {\n     return null;\n   }\n-  const fullMapping = getTemplateMapping(diagnostic.file, diagnostic.start, resolver);\n+  const fullMapping = getTemplateMapping(\n+      diagnostic.file, diagnostic.start, resolver, /*isDiagnosticsRequest*/ true);\n   if (fullMapping === null) {\n     return null;\n   }"
        },
        {
            "sha": "ac4f3cfb5e4c20bddf4460202b6469d505c479d9",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/tcb_util.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 11,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftcb_util.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftcb_util.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftcb_util.ts?ref=6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8",
            "patch": "@@ -54,10 +54,10 @@ export function requiresInlineTypeCheckBlock(node: ClassDeclaration<ts.ClassDecl\n \n /** Maps a shim position back to a template location. */\n export function getTemplateMapping(\n-    shimSf: ts.SourceFile, position: number, resolver: TemplateSourceResolver): FullTemplateMapping|\n-    null {\n+    shimSf: ts.SourceFile, position: number, resolver: TemplateSourceResolver,\n+    isDiagnosticRequest: boolean): FullTemplateMapping|null {\n   const node = getTokenAtPosition(shimSf, position);\n-  const sourceLocation = findSourceLocation(node, shimSf);\n+  const sourceLocation = findSourceLocation(node, shimSf, isDiagnosticRequest);\n   if (sourceLocation === null) {\n     return null;\n   }\n@@ -72,9 +72,10 @@ export function getTemplateMapping(\n   return {sourceLocation, templateSourceMapping: mapping, span};\n }\n \n-export function findTypeCheckBlock(file: ts.SourceFile, id: TemplateId): ts.Node|null {\n+export function findTypeCheckBlock(\n+    file: ts.SourceFile, id: TemplateId, isDiagnosticRequest: boolean): ts.Node|null {\n   for (const stmt of file.statements) {\n-    if (ts.isFunctionDeclaration(stmt) && getTemplateId(stmt, file) === id) {\n+    if (ts.isFunctionDeclaration(stmt) && getTemplateId(stmt, file, isDiagnosticRequest) === id) {\n       return stmt;\n     }\n   }\n@@ -84,12 +85,14 @@ export function findTypeCheckBlock(file: ts.SourceFile, id: TemplateId): ts.Node\n /**\n  * Traverses up the AST starting from the given node to extract the source location from comments\n  * that have been emitted into the TCB. If the node does not exist within a TCB, or if an ignore\n- * marker comment is found up the tree, this function returns null.\n+ * marker comment is found up the tree (and this is part of a diagnostic request), this function\n+ * returns null.\n  */\n-export function findSourceLocation(node: ts.Node, sourceFile: ts.SourceFile): SourceLocation|null {\n+export function findSourceLocation(\n+    node: ts.Node, sourceFile: ts.SourceFile, isDiagnosticsRequest: boolean): SourceLocation|null {\n   // Search for comments until the TCB's function declaration is encountered.\n   while (node !== undefined && !ts.isFunctionDeclaration(node)) {\n-    if (hasIgnoreForDiagnosticsMarker(node, sourceFile)) {\n+    if (hasIgnoreForDiagnosticsMarker(node, sourceFile) && isDiagnosticsRequest) {\n       // There's an ignore marker on this node, so the diagnostic should not be reported.\n       return null;\n     }\n@@ -98,7 +101,7 @@ export function findSourceLocation(node: ts.Node, sourceFile: ts.SourceFile): So\n     if (span !== null) {\n       // Once the positional information has been extracted, search further up the TCB to extract\n       // the unique id that is attached with the TCB's function declaration.\n-      const id = getTemplateId(node, sourceFile);\n+      const id = getTemplateId(node, sourceFile, isDiagnosticsRequest);\n       if (id === null) {\n         return null;\n       }\n@@ -111,10 +114,11 @@ export function findSourceLocation(node: ts.Node, sourceFile: ts.SourceFile): So\n   return null;\n }\n \n-function getTemplateId(node: ts.Node, sourceFile: ts.SourceFile): TemplateId|null {\n+function getTemplateId(\n+    node: ts.Node, sourceFile: ts.SourceFile, isDiagnosticRequest: boolean): TemplateId|null {\n   // Walk up to the function declaration of the TCB, the file information is attached there.\n   while (!ts.isFunctionDeclaration(node)) {\n-    if (hasIgnoreForDiagnosticsMarker(node, sourceFile)) {\n+    if (hasIgnoreForDiagnosticsMarker(node, sourceFile) && isDiagnosticRequest) {\n       // There's an ignore marker on this node, so the diagnostic should not be reported.\n       return null;\n     }"
        },
        {
            "sha": "eff89b6d50578b7437a06d67f338bdcf76f08cc6",
            "filename": "packages/language-service/ivy/test/references_spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Freferences_spec.ts?ref=6e4e68cb3012b848d2a90bd2722ffa1ea0e735d8",
            "patch": "@@ -713,6 +713,23 @@ describe('find references', () => {\n       assertTextSpans(refs, ['<div dir>', 'Dir', 'Dir2']);\n       assertFileNames(refs, ['app.ts', 'dir.ts', 'dir2.ts']);\n     });\n+\n+    it('should be able to request references for generic directives', () => {\n+      const {text, cursor} = extractCursorInfo(`\n+        import {Component, NgModule} from '@angular/core';\n+\n+        @Component({template: '<div *ngFÂ¦or=\"let item of items\"></div>'})\n+        export class AppCmp {\n+          items = [];\n+        }\n+      `);\n+      const appFile = {name: _('/app.ts'), contents: text};\n+      env = createModuleWithDeclarations([appFile]);\n+      const refs = getReferencesAtPosition(_('/app.ts'), cursor)!;\n+      expect(refs.length).toBe(6);\n+      assertTextSpans(refs, ['<div *ngFor=\"let item of items\"></div>', 'NgForOf']);\n+      assertFileNames(refs, ['index.d.ts', 'app.ts']);\n+    });\n   });\n \n   describe('components', () => {"
        }
    ],
    "stats": {
        "total": 53,
        "additions": 38,
        "deletions": 15
    }
}