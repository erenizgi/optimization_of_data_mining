{
    "author": "devversion",
    "message": "build: generate closure locale files using hard-coded list of locales (#42230)\n\nWith the refactoring from a Gulp task to a Bazel too, we tried switching\naway from the hard-coded list of locales and aliases for the Closure\nLocale file generation. After multiple attempts of landing this, it\nturned out that Closure Compiler/Closure Library relies on locale\nidentifiers CLDR does not capture within it's `availableLocales.json`\nor `aliases.json` data.\n\nClosure Library does not use any unknown locale identifiers here. The\nlocale identifiers can be resolved within CLDR using the bundle lookup\nalgorithm that is specified as part of CLDR; instead the problem is that\nthe locale identifiers do not follow any reasonable pattern and\ntherefore it's extremely difficult to generate them automatically (it's\nalmost like we'd need to build up _all_ possible combinations). Instead\nof doing that, we just use the hard-coded locales and aliases from the\nold Closure Locale generation script.\n\nPR Close #42230",
    "sha": "3b2f607cdad4edd01f08bab502db16849bbd8d95",
    "files": [
        {
            "sha": "75c08d63a2307ae35469c9a91c42dcde66fda9a1",
            "filename": "packages/common/locales/closure-locale.ts",
            "status": "modified",
            "additions": 821,
            "deletions": 9858,
            "changes": 10679,
            "blob_url": "https://github.com/angular/angular/blob/3b2f607cdad4edd01f08bab502db16849bbd8d95/packages%2Fcommon%2Flocales%2Fclosure-locale.ts",
            "raw_url": "https://github.com/angular/angular/raw/3b2f607cdad4edd01f08bab502db16849bbd8d95/packages%2Fcommon%2Flocales%2Fclosure-locale.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fclosure-locale.ts?ref=3b2f607cdad4edd01f08bab502db16849bbd8d95"
        },
        {
            "sha": "bcf72ea82a5d81be96ec4dad44a4203a35201b4d",
            "filename": "packages/common/locales/generate-locales-tool/closure-locale-file.ts",
            "status": "modified",
            "additions": 110,
            "deletions": 34,
            "changes": 144,
            "blob_url": "https://github.com/angular/angular/blob/3b2f607cdad4edd01f08bab502db16849bbd8d95/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts",
            "raw_url": "https://github.com/angular/angular/raw/3b2f607cdad4edd01f08bab502db16849bbd8d95/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcommon%2Flocales%2Fgenerate-locales-tool%2Fclosure-locale-file.ts?ref=3b2f607cdad4edd01f08bab502db16849bbd8d95",
            "patch": "@@ -12,74 +12,150 @@ import {BaseCurrencies} from './locale-base-currencies';\n import {generateLocale} from './locale-file';\n \n interface ClosureLocale {\n-  /** Locale name to match with a Closure-supported locale. */\n-  closureLocaleName: string;\n+  /** Closure-supported locale names that resolve to this locale. */\n+  closureLocaleNames: string[];\n+  /** Canonical locale name that is used to resolve the CLDR data. */\n+  canonicalLocaleName: string;\n   /** Locale data. Can have a different locale name if this captures an aliased locale. */\n   data: CldrLocaleData;\n }\n \n+/**\n+ * Locales used by closure that need to be captured within the Closure Locale file. Extracted from:\n+ * https://github.com/google/closure-library/blob/c7445058af72f679ef3273274e936d5d5f40b55a/closure/goog/i18n/datetimepatterns.js#L2450\n+ */\n+const closureLibraryLocales = [\n+  'af',    'am',    'ar',    'ar-DZ', 'az',    'be',    'bg',      'bn',         'br',      'bs',\n+  'ca',    'chr',   'cs',    'cy',    'da',    'de',    'de-AT',   'de-CH',      'el',      'en-AU',\n+  'en-CA', 'en-GB', 'en-IE', 'en-IN', 'en-SG', 'en-ZA', 'es',      'es-419',     'es-MX',   'es-US',\n+  'et',    'eu',    'fa',    'fi',    'fr',    'fr-CA', 'ga',      'gl',         'gsw',     'gu',\n+  'haw',   'hi',    'hr',    'hu',    'hy',    'id',    'is',      'it',         'he',      'ja',\n+  'ka',    'kk',    'km',    'kn',    'ko',    'ky',    'ln',      'lo',         'lt',      'lv',\n+  'mk',    'ml',    'mn',    'ro-MD', 'mr',    'ms',    'mt',      'my',         'ne',      'nl',\n+  'nb',    'or',    'pa',    'pl',    'pt',    'pt-PT', 'ro',      'ru',         'sr-Latn', 'si',\n+  'sk',    'sl',    'sq',    'sr',    'sv',    'sw',    'ta',      'te',         'th',      'fil',\n+  'tr',    'uk',    'ur',    'uz',    'vi',    'zh',    'zh-Hans', 'zh-Hant-HK', 'zh-Hant', 'zu'\n+] as const;\n+\n+/** Union type matching possible Closure Library locales. */\n+type ClosureLibraryLocaleName = typeof closureLibraryLocales[number];\n+\n+/**\n+ * Locale ID aliases to support deprecated locale ids used by Closure. Maps locales supported\n+ * by Closure library to a list of aliases that match the same locale data.\n+ */\n+const closureLibraryAliases: {[l in ClosureLibraryLocaleName]?: string[]} = {\n+  'id': ['in'],\n+  'he': ['iw'],\n+  'ro-MD': ['mo'],\n+  'nb': ['no', 'no-NO'],\n+  'sr-Latn': ['sh'],\n+  'fil': ['tl'],\n+  'pt': ['pt-BR'],\n+  'zh-Hans': ['zh-Hans-CN', 'zh-CN'],\n+  'zh-Hant-HK': ['zh-HK'],\n+  'zh-Hant': ['zh-Hant-TW', 'zh-TW'],\n+};\n+\n+\n /**\n  * Generate a file that contains all locale to import for closure.\n  * Tree shaking will only keep the data for the `goog.LOCALE` locale.\n  */\n export function generateClosureLocaleFile(cldrData: CldrData, baseCurrencies: BaseCurrencies) {\n-  const locales: ClosureLocale[] =\n-      [...cldrData.availableLocales.map(data => ({closureLocaleName: data.locale, data}))];\n-  const aliases = cldrData.getLanguageAliases();\n-\n-  // We also generate locale data for aliases known within CLDR. Closure compiler does not\n-  // limit its locale identifiers to CLDR-canonical identifiers/or BCP47 identifiers.\n-  // To ensure deprecated/historical locale identifiers which are supported by Closure\n-  // can work with closure-compiled Angular applications, we respect CLDR locale aliases.\n-  for (const [aliasName, data] of Object.entries(aliases)) {\n-    // We skip bibliographic aliases as those have never been supported by Closure compiler.\n-    if (data._reason === 'bibliographic') {\n-      continue;\n-    }\n+  const locales: ClosureLocale[] = closureLibraryLocales.map(localeName => {\n+    const data = cldrData.getLocaleData(localeName);\n \n-    const localeData = cldrData.getLocaleData(data._replacement);\n-\n-    // If CLDR does not provide data for the replacement locale, we skip this alias.\n-    if (localeData === null) {\n-      continue;\n+    if (data === null) {\n+      throw Error(`Missing locale data for Closure locale: ${localeName}`);\n     }\n \n-    locales.push({closureLocaleName: aliasName, data: localeData});\n-  }\n+    return {\n+      data,\n+      canonicalLocaleName: localeName,\n+      closureLocaleNames: computeEquivalentLocaleNames(localeName),\n+    };\n+  });\n \n   return `${fileHeader}\n \n import {registerLocaleData} from '../src/i18n/locale_data';\n \n const u = undefined;\n \n-${locales.map(locale => `${generateLocaleConstant(locale)}`).join('\\n')}\n+${locales.map(locale => generateLocaleConstants(locale)).join('\\n')}\n \n let l: any;\n+let locales: string[] = [];\n \n switch (goog.LOCALE) {\n ${locales.map(locale => generateCase(locale)).join('')}}\n \n if (l) {\n-  registerLocaleData(l);\n+  locales.forEach(locale => registerLocaleData(l, locale));\n }\n `;\n \n-  function generateLocaleConstant(locale: ClosureLocale): string {\n-    const localeNameFormattedForJs = formatLocale(locale.closureLocaleName);\n-    return generateLocale(locale.closureLocaleName, locale.data, baseCurrencies)\n+  /**\n+   * Generates locale data constants for all locale names within the specified\n+   * Closure Library locale.\n+   */\n+  function generateLocaleConstants(locale: ClosureLocale): string {\n+    // Closure Locale names contain both the dashed and underscore variant. We filter out\n+    // the dashed variant as otherwise we would end up with the same constant twice. e.g.\n+    // https://github.com/google/closure-library/blob/c7445058af72f679ef3273274e936d5d5f40b55a/closure/goog/i18n/datetimepatternsext.js#L11659-L11660.\n+    const localeConstantNames = locale.closureLocaleNames.filter(d => !d.includes('-'))\n+                                    .map(d => `locale_${formatLocale(d)}`);\n+    const dataConstantName = localeConstantNames[0];\n+    const otherAliasConstantNames = localeConstantNames.slice(1);\n+\n+    // We only generate the locale data once. All other constants just refer to the\n+    // first constant with the actual locale data. This reduces the Closure Locale file\n+    // size and potentially speeds up compilation with Closure Compiler.\n+    return `\n+${generateLocaleConstant(locale, dataConstantName)}\n+${otherAliasConstantNames.map(d => `export const ${d} = ${dataConstantName};`).join('\\n')}`;\n+  }\n+\n+  /** Generates a locale data constant for the specified locale. */\n+  function generateLocaleConstant(locale: ClosureLocale, constantName: string): string {\n+    return generateLocale(locale.canonicalLocaleName, locale.data, baseCurrencies)\n         .replace(`${fileHeader}\\n`, '')\n-        .replace('export default ', `export const locale_${localeNameFormattedForJs} = `)\n-        .replace('function plural', `function plural_${localeNameFormattedForJs}`)\n-        .replace(/,\\s+plural/, `, plural_${localeNameFormattedForJs}`)\n+        .replace('export default ', `export const ${constantName} = `)\n+        .replace('function plural', `function plural_${constantName}`)\n+        .replace(/,\\s+plural/, `, plural_${constantName}`)\n         .replace(/\\s*const u = undefined;\\s*/, '');\n   }\n \n-  function generateCase(locale: ClosureLocale) {\n-    return `case '${locale.closureLocaleName}':\\n` +\n-        `l = locale_${formatLocale(locale.closureLocaleName)};\\n` +\n-        `break;\\n`;\n+  /** Generates a TypeScript `switch` case for the specified locale. */\n+  function generateCase(locale: ClosureLocale): string {\n+    return `\n+${locale.closureLocaleNames.map(l => `case '${l}':`).join('\\n')}\n+  l = locale_${formatLocale(locale.canonicalLocaleName)};\n+  locales = [${locale.closureLocaleNames.map(n => `\"${n}\"`).join(', ')}];\n+  break;`;\n+  }\n+}\n+\n+function computeEquivalentLocaleNames(localeName: ClosureLibraryLocaleName): string[] {\n+  const equivalents = new Set<string>([localeName]);\n+\n+  if (localeName.includes('-')) {\n+    equivalents.add(localeName.replace(/-/g, '_'));\n+  }\n+\n+  const aliases = closureLibraryAliases[localeName];\n+  if (aliases !== undefined) {\n+    aliases.forEach(aliasName => {\n+      equivalents.add(aliasName);\n+\n+      if (aliasName.includes('-')) {\n+        equivalents.add(aliasName.replace(/-/g, '_'));\n+      }\n+    });\n   }\n+\n+  return Array.from(equivalents);\n }\n \n function formatLocale(locale: string): string {"
        }
    ],
    "stats": {
        "total": 10823,
        "additions": 931,
        "deletions": 9892
    }
}