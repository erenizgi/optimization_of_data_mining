{
    "author": "josephperrott",
    "message": "fix(dev-infra): require npm login for all publishes via wombat proxy (#41422)\n\nDue to an issue with wombat proxy returning the login state of the generated tokens,\nwe will need to require a login for all `ng-dev release publish` runs to ensure npm\nlogin has occured.\n\nPR Close #41422",
    "sha": "a43f36babd9508356084f47cc9f91f5116d73edb",
    "files": [
        {
            "sha": "1a2e42a04c613f62ae49989711189f02662ff918",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/a43f36babd9508356084f47cc9f91f5116d73edb/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/a43f36babd9508356084f47cc9f91f5116d73edb/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=a43f36babd9508356084f47cc9f91f5116d73edb",
            "patch": "@@ -6486,9 +6486,21 @@ class ReleaseTool {\n      * @returns a boolean indicating whether the user is logged into NPM.\n      */\n     _verifyNpmLoginState() {\n-        var _a;\n+        var _a, _b;\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n             const registry = `NPM at the ${(_a = this._config.publishRegistry) !== null && _a !== void 0 ? _a : 'default NPM'} registry`;\n+            // TODO(josephperrott): remove wombat specific block once wombot allows `npm whoami` check to\n+            // check the status of the local token in the .npmrc file.\n+            if ((_b = this._config.publishRegistry) === null || _b === void 0 ? void 0 : _b.includes('wombat-dressing-room.appspot.com')) {\n+                info('Unable to determine NPM login state for wombat proxy, requiring login now.');\n+                try {\n+                    yield npmLogin(this._config.publishRegistry);\n+                }\n+                catch (_c) {\n+                    return false;\n+                }\n+                return true;\n+            }\n             if (yield npmIsLoggedIn(this._config.publishRegistry)) {\n                 debug(`Already logged into ${registry}.`);\n                 return true;\n@@ -6500,7 +6512,7 @@ class ReleaseTool {\n                 try {\n                     yield npmLogin(this._config.publishRegistry);\n                 }\n-                catch (_b) {\n+                catch (_d) {\n                     return false;\n                 }\n                 return true;"
        },
        {
            "sha": "ea978ded8a7e0c63823e32b185463ba3a751912d",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/a43f36babd9508356084f47cc9f91f5116d73edb/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a43f36babd9508356084f47cc9f91f5116d73edb/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=a43f36babd9508356084f47cc9f91f5116d73edb",
            "patch": "@@ -150,6 +150,17 @@ export class ReleaseTool {\n    */\n   private async _verifyNpmLoginState(): Promise<boolean> {\n     const registry = `NPM at the ${this._config.publishRegistry ?? 'default NPM'} registry`;\n+    // TODO(josephperrott): remove wombat specific block once wombot allows `npm whoami` check to\n+    // check the status of the local token in the .npmrc file.\n+    if (this._config.publishRegistry?.includes('wombat-dressing-room.appspot.com')) {\n+      info('Unable to determine NPM login state for wombat proxy, requiring login now.');\n+      try {\n+        await npmLogin(this._config.publishRegistry);\n+      } catch {\n+        return false;\n+      }\n+      return true;\n+    }\n     if (await npmIsLoggedIn(this._config.publishRegistry)) {\n       debug(`Already logged into ${registry}.`);\n       return true;"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 25,
        "deletions": 2
    }
}