{
    "author": "devversion",
    "message": "refactor(dev-infra): improve type safety of NPM dist tags in release tool (#42133)\n\nInstead of passing `string` in the release tool for NPM dist tags, we\nshould use a union string type that limits the tags to `latest`, `next`\nand anything matching `v{number}-lts`. This avoids mistakes at\ncompilation-level if an invalid/unknown tag would be set by a release\naction.\n\nPR Close #42133",
    "sha": "48f49bacb43f9acc9204be178754743c3f6238df",
    "files": [
        {
            "sha": "6d799e12963c3c07dddb160eb269d22100354d2f",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -1120,7 +1120,7 @@ function fetchLongTermSupportBranchesFromNpm(config) {\n         // their corresponding branches. We assume that an LTS tagged version in NPM belongs to the\n         // last-minor branch of a given major (i.e. we assume there are no outdated LTS NPM dist tags).\n         for (const npmDistTag in distTags) {\n-            if (ltsNpmDistTagRegex.test(npmDistTag)) {\n+            if (isLtsDistTag(npmDistTag)) {\n                 const version = semver.parse(distTags[npmDistTag]);\n                 const branchName = `${version.major}.${version.minor}.x`;\n                 const majorReleaseDate = new Date(time[`${version.major}.0.0`]);\n@@ -1142,6 +1142,10 @@ function fetchLongTermSupportBranchesFromNpm(config) {\n         return { active, inactive };\n     });\n }\n+/** Gets whether the specified tag corresponds to a LTS dist tag. */\n+function isLtsDistTag(tagName) {\n+    return ltsNpmDistTagRegex.test(tagName);\n+}\n /**\n  * Computes the date when long-term support ends for a major released at the\n  * specified date.\n@@ -6269,7 +6273,7 @@ class ReleaseAction {\n     }\n     /**\n      * Builds and publishes the given version in the specified branch.\n-     * @param newVersion The new version to be published.\n+     * @param releaseNotes The release notes for the version being published.\n      * @param publishBranch Name of the branch that contains the new version.\n      * @param npmDistTag NPM dist tag where the version should be published to.\n      */"
        },
        {
            "sha": "8318bf8643988123bea6620065204b5f443b260a",
            "filename": "dev-infra/release/publish/actions.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Factions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -15,6 +15,7 @@ import {debug, error, green, info, promptConfirm, red, warn, yellow} from '../..\n import {getListCommitsInBranchUrl, getRepositoryGitUrl} from '../../utils/git/github-urls';\n import {GitClient} from '../../utils/git/index';\n import {BuiltPackage, ReleaseConfig} from '../config/index';\n+import {NpmDistTag} from '../versioning';\n import {ActiveReleaseTrains} from '../versioning/active-release-trains';\n import {runNpmPublish} from '../versioning/npm-publish';\n \n@@ -440,12 +441,12 @@ export abstract class ReleaseAction {\n \n   /**\n    * Builds and publishes the given version in the specified branch.\n-   * @param newVersion The new version to be published.\n+   * @param releaseNotes The release notes for the version being published.\n    * @param publishBranch Name of the branch that contains the new version.\n    * @param npmDistTag NPM dist tag where the version should be published to.\n    */\n   protected async buildAndPublish(\n-      releaseNotes: ReleaseNotes, publishBranch: string, npmDistTag: string) {\n+      releaseNotes: ReleaseNotes, publishBranch: string, npmDistTag: NpmDistTag) {\n     const versionBumpCommitSha = await this._getCommitOfBranch(publishBranch);\n \n     if (!await this._isCommitForVersionStaging(releaseNotes.version, versionBumpCommitSha)) {\n@@ -482,7 +483,7 @@ export abstract class ReleaseAction {\n   }\n \n   /** Publishes the given built package to NPM with the specified NPM dist tag. */\n-  private async _publishBuiltPackageToNpm(pkg: BuiltPackage, npmDistTag: string) {\n+  private async _publishBuiltPackageToNpm(pkg: BuiltPackage, npmDistTag: NpmDistTag) {\n     debug(`Starting publish of \"${pkg.name}\".`);\n     const spinner = ora.call(undefined).start(`Publishing \"${pkg.name}\"`);\n "
        },
        {
            "sha": "8777ca83295d44ea53f86c4a100eb8fbaaffcf21",
            "filename": "dev-infra/release/publish/actions/cut-lts-patch.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 12,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-lts-patch.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-lts-patch.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Factions%2Fcut-lts-patch.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -7,23 +7,12 @@\n  */\n \n import {ListChoiceOptions, prompt} from 'inquirer';\n-import * as semver from 'semver';\n \n import {ActiveReleaseTrains} from '../../versioning/active-release-trains';\n import {semverInc} from '../../versioning/inc-semver';\n-import {fetchLongTermSupportBranchesFromNpm} from '../../versioning/long-term-support';\n+import {fetchLongTermSupportBranchesFromNpm, LtsBranch} from '../../versioning/long-term-support';\n import {ReleaseAction} from '../actions';\n \n-/** Interface describing an LTS version branch. */\n-interface LtsBranch {\n-  /** Name of the branch. */\n-  name: string;\n-  /** Most recent version for the given LTS branch. */\n-  version: semver.SemVer;\n-  /** NPM dist tag for the LTS version. */\n-  npmDistTag: string;\n-}\n-\n /**\n  * Release action that cuts a new patch release for an active release-train in the long-term\n  * support phase. The patch segment is incremented. The changelog is generated for the new"
        },
        {
            "sha": "2683e3ce467c57966fef0084b2f0dcb707b8a3a6",
            "filename": "dev-infra/release/publish/external-commands.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fexternal-commands.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -12,6 +12,7 @@ import * as semver from 'semver';\n import {spawnWithDebugOutput} from '../../utils/child-process';\n import {error, green, info, red} from '../../utils/console';\n import {BuiltPackage} from '../config/index';\n+import {NpmDistTag} from '../versioning';\n \n import {FatalReleaseActionError} from './actions-error';\n \n@@ -36,7 +37,7 @@ import {FatalReleaseActionError} from './actions-error';\n  * Invokes the `ng-dev release set-dist-tag` command in order to set the specified\n  * NPM dist tag for all packages in the checked out branch to the given version.\n  */\n-export async function invokeSetNpmDistCommand(npmDistTag: string, version: semver.SemVer) {\n+export async function invokeSetNpmDistCommand(npmDistTag: NpmDistTag, version: semver.SemVer) {\n   try {\n     // Note: No progress indicator needed as that is the responsibility of the command.\n     await spawnWithDebugOutput("
        },
        {
            "sha": "8bed8d97cf8ed739a001e85b4ed39bc518bdde3e",
            "filename": "dev-infra/release/publish/test/common.spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -11,7 +11,7 @@ import {join} from 'path';\n import * as semver from 'semver';\n \n import {getBranchPushMatcher} from '../../../utils/testing';\n-import {_npmPackageInfoCache} from '../../versioning';\n+import {NpmDistTag} from '../../versioning';\n import {ActiveReleaseTrains} from '../../versioning/active-release-trains';\n import * as npm from '../../versioning/npm-publish';\n import {ReleaseTrain} from '../../versioning/release-trains';\n@@ -44,7 +44,7 @@ describe('common release action logic', () => {\n       fakeNpmPackageQueryRequest(releaseConfig.npmPackages[0], {'dist-tags': {}});\n \n       for (const actionCtor of actions) {\n-        if (await actionCtor.isActive(testReleaseTrain)) {\n+        if (await actionCtor.isActive(testReleaseTrain, releaseConfig)) {\n           const action = new actionCtor(testReleaseTrain, gitClient, releaseConfig, testTmpDir);\n           descriptions.push(await action.getDescription());\n         }\n@@ -151,7 +151,7 @@ class TestAction extends ReleaseAction {\n     throw Error('Not implemented.');\n   }\n \n-  async testBuildAndPublish(version: semver.SemVer, publishBranch: string, distTag: string) {\n+  async testBuildAndPublish(version: semver.SemVer, publishBranch: string, distTag: NpmDistTag) {\n     const releaseNotes = await ReleaseNotes.fromRange(version, '', '');\n     await this.buildAndPublish(releaseNotes, publishBranch, distTag);\n   }"
        },
        {
            "sha": "a2aa6f51a903b5daa1e01374be7ea7f91b349b21",
            "filename": "dev-infra/release/publish/test/test-utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Ftest-utils.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -17,7 +17,7 @@ import {getBranchPushMatcher, installVirtualGitClientSpies, VirtualGitClient} fr\n import {ReleaseConfig} from '../../config/index';\n import {ActiveReleaseTrains} from '../../versioning/active-release-trains';\n import * as npm from '../../versioning/npm-publish';\n-import {_npmPackageInfoCache, NpmPackageInfo} from '../../versioning/npm-registry';\n+import {_npmPackageInfoCache, NpmDistTag, NpmPackageInfo} from '../../versioning/npm-registry';\n import {ReleaseAction, ReleaseActionConstructor} from '../actions';\n import * as constants from '../constants';\n import * as externalCommands from '../external-commands';\n@@ -124,8 +124,8 @@ export function parse(version: string): semver.SemVer {\n \n export async function expectStagingAndPublishWithoutCherryPick(\n     action: TestReleaseAction, expectedBranch: string, expectedVersion: string,\n-    expectedNpmDistTag: string) {\n-  const {repo, fork, gitClient, releaseConfig} = action;\n+    expectedNpmDistTag: NpmDistTag) {\n+  const {repo, fork, gitClient} = action;\n   const expectedStagingForkBranch = `release-stage-${expectedVersion}`;\n   const expectedTagName = expectedVersion;\n \n@@ -173,7 +173,7 @@ export async function expectStagingAndPublishWithoutCherryPick(\n \n export async function expectStagingAndPublishWithCherryPick(\n     action: TestReleaseAction, expectedBranch: string, expectedVersion: string,\n-    expectedNpmDistTag: string) {\n+    expectedNpmDistTag: NpmDistTag) {\n   const {repo, fork, gitClient, releaseConfig} = action;\n   const expectedStagingForkBranch = `release-stage-${expectedVersion}`;\n   const expectedCherryPickForkBranch = `changelog-cherry-pick-${expectedVersion}`;"
        },
        {
            "sha": "676b85b2fd4c7251fdcc01ee00f047daa6bd8036",
            "filename": "dev-infra/release/versioning/long-term-support.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fversioning%2Flong-term-support.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fversioning%2Flong-term-support.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Flong-term-support.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -12,6 +12,9 @@ import {ReleaseConfig} from '../config/index';\n \n import {fetchProjectNpmPackageInfo} from './npm-registry';\n \n+/** Type describing a NPM dist tag indicating long-term support. */\n+export type LtsNpmDistTag = `v${number}-lts`;\n+\n /** Interface describing determined LTS branches. */\n export interface LtsBranches {\n   /** List of active LTS version branches. */\n@@ -27,7 +30,7 @@ export interface LtsBranch {\n   /** Most recent version for the given LTS branch. */\n   version: semver.SemVer;\n   /** NPM dist tag for the LTS version. */\n-  npmDistTag: string;\n+  npmDistTag: LtsNpmDistTag;\n }\n \n /**\n@@ -57,7 +60,7 @@ export async function fetchLongTermSupportBranchesFromNpm(config: ReleaseConfig)\n   // their corresponding branches. We assume that an LTS tagged version in NPM belongs to the\n   // last-minor branch of a given major (i.e. we assume there are no outdated LTS NPM dist tags).\n   for (const npmDistTag in distTags) {\n-    if (ltsNpmDistTagRegex.test(npmDistTag)) {\n+    if (isLtsDistTag(npmDistTag)) {\n       const version = semver.parse(distTags[npmDistTag])!;\n       const branchName = `${version.major}.${version.minor}.x`;\n       const majorReleaseDate = new Date(time[`${version.major}.0.0`]);\n@@ -80,6 +83,11 @@ export async function fetchLongTermSupportBranchesFromNpm(config: ReleaseConfig)\n   return {active, inactive};\n }\n \n+/** Gets whether the specified tag corresponds to a LTS dist tag. */\n+export function isLtsDistTag(tagName: string): tagName is LtsNpmDistTag {\n+  return ltsNpmDistTagRegex.test(tagName);\n+}\n+\n /**\n  * Computes the date when long-term support ends for a major released at the\n  * specified date.\n@@ -93,7 +101,7 @@ export function computeLtsEndDateOfMajor(majorReleaseDate: Date): Date {\n }\n \n /** Gets the long-term support NPM dist tag for a given major version. */\n-export function getLtsNpmDistTagOfMajor(major: number): string {\n+export function getLtsNpmDistTagOfMajor(major: number): LtsNpmDistTag {\n   // LTS versions should be tagged in NPM in the following format: `v{major}-lts`.\n-  return `v${major}-lts`;\n+  return `v${major}-lts` as const;\n }"
        },
        {
            "sha": "1f31c268a5855b61852ba9b3458d6afa86a6aa10",
            "filename": "dev-infra/release/versioning/npm-publish.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -8,13 +8,14 @@\n \n import * as semver from 'semver';\n import {spawnInteractiveCommand, spawnWithDebugOutput} from '../../utils/child-process';\n+import {NpmDistTag} from './npm-registry';\n \n /**\n  * Runs NPM publish within a specified package directory.\n  * @throws With the process log output if the publish failed.\n  */\n export async function runNpmPublish(\n-    packagePath: string, distTag: string, registryUrl: string|undefined) {\n+    packagePath: string, distTag: NpmDistTag, registryUrl: string|undefined) {\n   const args = ['publish', '--access', 'public', '--tag', distTag];\n   // If a custom registry URL has been specified, add the `--registry` flag.\n   if (registryUrl !== undefined) {"
        },
        {
            "sha": "de6daf0970e9e0c90d4822e2c152a752abb09d7f",
            "filename": "dev-infra/release/versioning/npm-registry.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fversioning%2Fnpm-registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/48f49bacb43f9acc9204be178754743c3f6238df/dev-infra%2Frelease%2Fversioning%2Fnpm-registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-registry.ts?ref=48f49bacb43f9acc9204be178754743c3f6238df",
            "patch": "@@ -10,6 +10,10 @@ import fetch from 'node-fetch';\n import * as semver from 'semver';\n \n import {ReleaseConfig} from '../config/index';\n+import {LtsNpmDistTag} from './long-term-support';\n+\n+/** Type describing the possible NPM dist tags used by Angular packages. */\n+export type NpmDistTag = 'latest'|'next'|LtsNpmDistTag;\n \n /** Type describing an NPM package fetched from the registry. */\n export interface NpmPackageInfo {"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 38,
        "deletions": 30
    }
}