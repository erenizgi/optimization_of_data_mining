{
    "author": "JoostK",
    "message": "perf(ngcc): reduce maximum worker count (#38840)\n\nRecent optimizations to ngcc have significantly reduced the total time\nit takes to process `node_modules`, to such extend that sharding across\nmultiple processes has become less effective. Previously, running\nngcc asynchronously would allow for up to 8 workers to be allocated,\nhowever these workers have to repeat work that could otherwise be shared.\nBecause ngcc is now able to reuse more shared computations, the overhead\nof multiple workers is increased and therefore becomes less effective.\nAs an additional benefit, having fewer workers requires less memory and\nless startup time.\n\nTo give an idea, using the following test setup:\n\n```bash\nnpx @angular/cli new perf-test\ncd perf-test\nyarn ng add @angular/material\n./node_modules/.bin/ngcc --properties es2015 module main \\\n  --first-only --create-ivy-entry-points\n```\n\nWe observe the following figures on CI:\n\n|                   | 10.1.1    | PR #38840 |\n| ----------------- | --------- | --------- |\n| Sync              | 85s       | 25s       |\n| Async (8 workers) | 22s       | 16s       |\n| Async (4 workers) | -         | 11s       |\n\nIn addition to changing the default number of workers, ngcc will now\nuse the environment variable `NGCC_MAX_WORKERS` that may be configured\nto either reduce or increase the number of workers.\n\nPR Close #38840",
    "sha": "fd44d84a331d246d4e63b8a48e8a55983e8237f8",
    "files": [
        {
            "sha": "b6d74e19df4d20b1ed9abd4cf9a62bc81788ca37",
            "filename": "packages/compiler-cli/ngcc/src/main.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 12,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/fd44d84a331d246d4e63b8a48e8a55983e8237f8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fmain.ts",
            "raw_url": "https://github.com/angular/angular/raw/fd44d84a331d246d4e63b8a48e8a55983e8237f8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fmain.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fmain.ts?ref=fd44d84a331d246d4e63b8a48e8a55983e8237f8",
            "patch": "@@ -8,8 +8,6 @@\n \n /// <reference types=\"node\" />\n \n-import * as os from 'os';\n-\n import {AbsoluteFsPath, FileSystem, resolve} from '../../src/ngtsc/file_system';\n import {Logger} from '../../src/ngtsc/logging';\n import {ParsedConfiguration} from '../../src/perform_compile';\n@@ -35,7 +33,7 @@ import {composeTaskCompletedCallbacks, createLogErrorHandler, createMarkAsProces\n import {AsyncLocker} from './locking/async_locker';\n import {LockFileWithChildProcess} from './locking/lock_file_with_child_process';\n import {SyncLocker} from './locking/sync_locker';\n-import {AsyncNgccOptions, getSharedSetup, SyncNgccOptions} from './ngcc_options';\n+import {AsyncNgccOptions, getMaxNumberOfWorkers, getSharedSetup, SyncNgccOptions} from './ngcc_options';\n import {NgccConfiguration} from './packages/configuration';\n import {EntryPointJsonProperty, SUPPORTED_FORMAT_PROPERTIES} from './packages/entry_point';\n import {EntryPointManifest, InvalidatingEntryPointManifest} from './packages/entry_point_manifest';\n@@ -92,10 +90,9 @@ export function mainNgcc(options: AsyncNgccOptions|SyncNgccOptions): void|Promis\n     return;\n   }\n \n-  // Execute in parallel, if async execution is acceptable and there are more than 2 CPU cores.\n-  // (One CPU core is always reserved for the master process and we need at least 2 worker processes\n-  // in order to run tasks in parallel.)\n-  const inParallel = async && (os.cpus().length > 2);\n+  // Determine the number of workers to use and whether ngcc should run in parallel.\n+  const workerCount = async ? getMaxNumberOfWorkers() : 1;\n+  const inParallel = workerCount > 1;\n \n   const analyzeEntryPoints = getAnalyzeEntryPointsFn(\n       logger, finder, fileSystem, supportedPropertiesToConsider, compileAllFormats,\n@@ -113,7 +110,7 @@ export function mainNgcc(options: AsyncNgccOptions|SyncNgccOptions): void|Promis\n   const createTaskCompletedCallback =\n       getCreateTaskCompletedCallback(pkgJsonUpdater, errorOnFailedEntryPoint, logger, fileSystem);\n   const executor = getExecutor(\n-      async, inParallel, logger, fileWriter, pkgJsonUpdater, fileSystem, config,\n+      async, workerCount, logger, fileWriter, pkgJsonUpdater, fileSystem, config,\n       createTaskCompletedCallback);\n \n   return executor.execute(analyzeEntryPoints, createCompileFn);\n@@ -153,17 +150,16 @@ function getCreateTaskCompletedCallback(\n }\n \n function getExecutor(\n-    async: boolean, inParallel: boolean, logger: Logger, fileWriter: FileWriter,\n+    async: boolean, workerCount: number, logger: Logger, fileWriter: FileWriter,\n     pkgJsonUpdater: PackageJsonUpdater, fileSystem: FileSystem, config: NgccConfiguration,\n     createTaskCompletedCallback: CreateTaskCompletedCallback): Executor {\n   const lockFile = new LockFileWithChildProcess(fileSystem, logger);\n   if (async) {\n     // Execute asynchronously (either serially or in parallel)\n     const {retryAttempts, retryDelay} = config.getLockingConfig();\n     const locker = new AsyncLocker(lockFile, logger, retryDelay, retryAttempts);\n-    if (inParallel) {\n-      // Execute in parallel. Use up to 8 CPU cores for workers, always reserving one for master.\n-      const workerCount = Math.min(8, os.cpus().length - 1);\n+    if (workerCount > 1) {\n+      // Execute in parallel.\n       return new ClusterExecutor(\n           workerCount, fileSystem, logger, fileWriter, pkgJsonUpdater, locker,\n           createTaskCompletedCallback);"
        },
        {
            "sha": "52fb3ab4d8cfc9f69d94cac891e3361d04f61d71",
            "filename": "packages/compiler-cli/ngcc/src/ngcc_options.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/fd44d84a331d246d4e63b8a48e8a55983e8237f8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fngcc_options.ts",
            "raw_url": "https://github.com/angular/angular/raw/fd44d84a331d246d4e63b8a48e8a55983e8237f8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fngcc_options.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fngcc_options.ts?ref=fd44d84a331d246d4e63b8a48e8a55983e8237f8",
            "patch": "@@ -5,6 +5,8 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import * as os from 'os';\n+\n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '../../src/ngtsc/file_system';\n import {ConsoleLogger, Logger, LogLevel} from '../../src/ngtsc/logging';\n import {ParsedConfiguration, readConfiguration} from '../../src/perform_compile';\n@@ -254,3 +256,26 @@ function checkForSolutionStyleTsConfig(\n         `  ngcc ... --tsconfig \"${fileSystem.relative(projectPath, tsConfig.project)}\"`);\n   }\n }\n+\n+/**\n+ * Determines the maximum number of workers to use for parallel execution. This can be set using the\n+ * NGCC_MAX_WORKERS environment variable, or is computed based on the number of available CPUs. One\n+ * CPU core is always reserved for the master process, so we take the number of CPUs minus one, with\n+ * a maximum of 4 workers. We don't scale the number of workers beyond 4 by default, as it takes\n+ * considerably more memory and CPU cycles while not offering a substantial improvement in time.\n+ */\n+export function getMaxNumberOfWorkers(): number {\n+  const maxWorkers = process.env.NGCC_MAX_WORKERS;\n+  if (maxWorkers === undefined) {\n+    // Use up to 4 CPU cores for workers, always reserving one for master.\n+    return Math.max(1, Math.min(4, os.cpus().length - 1));\n+  }\n+\n+  const numericMaxWorkers = +maxWorkers.trim();\n+  if (!Number.isInteger(numericMaxWorkers)) {\n+    throw new Error('NGCC_MAX_WORKERS should be an integer.');\n+  } else if (numericMaxWorkers < 1) {\n+    throw new Error('NGCC_MAX_WORKERS should be at least 1.');\n+  }\n+  return numericMaxWorkers;\n+}"
        },
        {
            "sha": "1ecb30b037955b8349669f9351cb232b5c773ab5",
            "filename": "packages/compiler-cli/ngcc/test/ngcc_options_spec.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 1,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/fd44d84a331d246d4e63b8a48e8a55983e8237f8/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/fd44d84a331d246d4e63b8a48e8a55983e8237f8/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts?ref=fd44d84a331d246d4e63b8a48e8a55983e8237f8",
            "patch": "@@ -5,12 +5,13 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import * as os from 'os';\n \n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '../../src/ngtsc/file_system';\n import {runInEachFileSystem} from '../../src/ngtsc/file_system/testing';\n import {MockLogger} from '../../src/ngtsc/logging/testing';\n \n-import {clearTsConfigCache, getSharedSetup, NgccOptions} from '../src/ngcc_options';\n+import {clearTsConfigCache, getMaxNumberOfWorkers, getSharedSetup, NgccOptions} from '../src/ngcc_options';\n \n \n \n@@ -100,6 +101,67 @@ runInEachFileSystem(() => {\n     });\n   });\n \n+  describe('getMaxNumberOfWorkers', () => {\n+    let processEnv: NodeJS.ProcessEnv;\n+    let cpuSpy: jasmine.Spy;\n+    beforeEach(() => {\n+      processEnv = process.env;\n+      process.env = {...process.env};\n+      cpuSpy = spyOn(os, 'cpus');\n+    });\n+    afterEach(() => {\n+      process.env = processEnv;\n+    });\n+\n+    it('should use NGCC_MAX_WORKERS environment variable if set', () => {\n+      process.env.NGCC_MAX_WORKERS = '16';\n+      expect(getMaxNumberOfWorkers()).toBe(16);\n+      process.env.NGCC_MAX_WORKERS = '8';\n+      expect(getMaxNumberOfWorkers()).toBe(8);\n+      process.env.NGCC_MAX_WORKERS = ' 8 ';\n+      expect(getMaxNumberOfWorkers()).toBe(8);\n+    });\n+\n+    it('should throw an error if NGCC_MAX_WORKERS is less than 1', () => {\n+      process.env.NGCC_MAX_WORKERS = '0';\n+      expect(() => getMaxNumberOfWorkers())\n+          .toThrow(new Error('NGCC_MAX_WORKERS should be at least 1.'));\n+      process.env.NGCC_MAX_WORKERS = '-1';\n+      expect(() => getMaxNumberOfWorkers())\n+          .toThrow(new Error('NGCC_MAX_WORKERS should be at least 1.'));\n+    });\n+\n+    it('should throw an error if NGCC_MAX_WORKERS is not an integer', () => {\n+      process.env.NGCC_MAX_WORKERS = 'a';\n+      expect(() => getMaxNumberOfWorkers())\n+          .toThrow(new Error('NGCC_MAX_WORKERS should be an integer.'));\n+      process.env.NGCC_MAX_WORKERS = '1.5';\n+      expect(() => getMaxNumberOfWorkers())\n+          .toThrow(new Error('NGCC_MAX_WORKERS should be an integer.'));\n+      process.env.NGCC_MAX_WORKERS = '-';\n+      expect(() => getMaxNumberOfWorkers())\n+          .toThrow(new Error('NGCC_MAX_WORKERS should be an integer.'));\n+    });\n+\n+    it('should fallback to the number of cpus, minus one (for the master process), with a maximum of 4 workers',\n+       () => {\n+         simulateNumberOfCpus(1);\n+         expect(getMaxNumberOfWorkers()).toBe(1);\n+         simulateNumberOfCpus(2);\n+         expect(getMaxNumberOfWorkers()).toBe(1);\n+         simulateNumberOfCpus(4);\n+         expect(getMaxNumberOfWorkers()).toBe(3);\n+         simulateNumberOfCpus(6);\n+         expect(getMaxNumberOfWorkers()).toBe(4);\n+         simulateNumberOfCpus(8);\n+         expect(getMaxNumberOfWorkers()).toBe(4);\n+       });\n+\n+    function simulateNumberOfCpus(cpus: number): void {\n+      cpuSpy.and.returnValue(new Array(cpus).fill({model: 'Mock CPU'} as any));\n+    }\n+  });\n+\n   /**\n    * This function creates an object that contains the minimal required properties for NgccOptions.\n    */"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 96,
        "deletions": 13
    }
}