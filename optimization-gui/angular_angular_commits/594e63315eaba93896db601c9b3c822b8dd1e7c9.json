{
    "author": "josephperrott",
    "message": "feat(dev-infra): add release notes generation to ng-dev (#42225)\n\nAdds tooling to create ad-hoc release note entries via `ng-dev release notes`.\n\nPR Close #42225",
    "sha": "594e63315eaba93896db601c9b3c822b8dd1e7c9",
    "files": [
        {
            "sha": "30cf3e2fe4e5212b3282b841cf437a3de6be5634",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 640,
            "deletions": 582,
            "changes": 1222,
            "blob_url": "https://github.com/angular/angular/blob/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=594e63315eaba93896db601c9b3c822b8dd1e7c9",
            "patch": "@@ -24,8 +24,8 @@ var cliProgress = require('cli-progress');\n var os = require('os');\n var shelljs = require('shelljs');\n var minimatch = require('minimatch');\n-var ora = require('ora');\n var ejs = require('ejs');\n+var ora = require('ora');\n var glob = require('glob');\n var ts = require('typescript');\n \n@@ -5235,75 +5235,207 @@ const ReleaseBuildCommandModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+/** List of types to be included in the release notes. */\n+const typesToIncludeInReleaseNotes = Object.values(COMMIT_TYPES)\n+    .filter(type => type.releaseNotesLevel === ReleaseNotesLevel.Visible)\n+    .map(type => type.name);\n+/** Context class used for rendering release notes. */\n+class RenderContext {\n+    constructor(data) {\n+        this.data = data;\n+        /** An array of group names in sort order if defined. */\n+        this.groupOrder = this.data.groupOrder || [];\n+        /** An array of scopes to hide from the release entry output. */\n+        this.hiddenScopes = this.data.hiddenScopes || [];\n+        /** The title of the release, or `false` if no title should be used. */\n+        this.title = this.data.title;\n+        /** An array of commits in the release period. */\n+        this.commits = this.data.commits;\n+        /** The version of the release. */\n+        this.version = this.data.version;\n+        /** The date stamp string for use in the release notes entry. */\n+        this.dateStamp = buildDateStamp(this.data.date);\n+    }\n+    /**\n+     * Organizes and sorts the commits into groups of commits.\n+     *\n+     * Groups are sorted either by default `Array.sort` order, or using the provided group order from\n+     * the configuration. Commits are order in the same order within each groups commit list as they\n+     * appear in the provided list of commits.\n+     * */\n+    asCommitGroups(commits) {\n+        /** The discovered groups to organize into. */\n+        const groups = new Map();\n+        // Place each commit in the list into its group.\n+        commits.forEach(commit => {\n+            const key = commit.npmScope ? `${commit.npmScope}/${commit.scope}` : commit.scope;\n+            const groupCommits = groups.get(key) || [];\n+            groups.set(key, groupCommits);\n+            groupCommits.push(commit);\n+        });\n+        /**\n+         * Array of CommitGroups containing the discovered commit groups. Sorted in alphanumeric order\n+         * of the group title.\n+         */\n+        const commitGroups = Array.from(groups.entries())\n+            .map(([title, commits]) => ({ title, commits }))\n+            .sort((a, b) => a.title > b.title ? 1 : a.title < b.title ? -1 : 0);\n+        // If the configuration provides a sorting order, updated the sorted list of group keys to\n+        // satisfy the order of the groups provided in the list with any groups not found in the list at\n+        // the end of the sorted list.\n+        if (this.groupOrder.length) {\n+            for (const groupTitle of this.groupOrder.reverse()) {\n+                const currentIdx = commitGroups.findIndex(k => k.title === groupTitle);\n+                if (currentIdx !== -1) {\n+                    const removedGroups = commitGroups.splice(currentIdx, 1);\n+                    commitGroups.splice(0, 0, ...removedGroups);\n+                }\n+            }\n+        }\n+        return commitGroups;\n+    }\n+    /**\n+     * A filter function for filtering a list of commits to only include commits which should appear\n+     * in release notes.\n+     */\n+    includeInReleaseNotes() {\n+        return (commit) => {\n+            if (!typesToIncludeInReleaseNotes.includes(commit.type)) {\n+                return false;\n+            }\n+            if (this.hiddenScopes.includes(commit.scope)) {\n+                return false;\n+            }\n+            return true;\n+        };\n+    }\n+    /**\n+     * A filter function for filtering a list of commits to only include commits which contain a\n+     * truthy value, or for arrays an array with 1 or more elements, for the provided field.\n+     */\n+    contains(field) {\n+        return (commit) => {\n+            const fieldValue = commit[field];\n+            if (!fieldValue) {\n+                return false;\n+            }\n+            if (Array.isArray(fieldValue) && fieldValue.length === 0) {\n+                return false;\n+            }\n+            return true;\n+        };\n+    }\n+    /**\n+     * A filter function for filtering a list of commits to only include commits which contain a\n+     * unique value for the provided field across all commits in the list.\n+     */\n+    unique(field) {\n+        const set = new Set();\n+        return (commit) => {\n+            const include = !set.has(commit[field]);\n+            set.add(commit[field]);\n+            return include;\n+        };\n+    }\n+}\n /**\n- * Spawns a given command with the specified arguments inside an interactive shell. All process\n- * stdin, stdout and stderr output is printed to the current console.\n+ * Builds a date stamp for stamping in release notes.\n  *\n- * @returns a Promise resolving on success, and rejecting on command failure with the status code.\n+ * Uses the current date, or a provided date in the format of YYYY-MM-DD, i.e. 1970-11-05.\n  */\n-function spawnInteractiveCommand(command, args, options) {\n-    if (options === void 0) { options = {}; }\n-    return new Promise(function (resolve, reject) {\n-        var commandText = command + \" \" + args.join(' ');\n-        debug(\"Executing command: \" + commandText);\n-        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: 'inherit' }));\n-        childProcess.on('exit', function (status) { return status === 0 ? resolve() : reject(status); });\n-    });\n+function buildDateStamp(date = new Date()) {\n+    const year = `${date.getFullYear()}`;\n+    const month = `${(date.getMonth() + 1)}`.padStart(2, '0');\n+    const day = `${date.getDate()}`.padStart(2, '0');\n+    return [year, month, day].join('-');\n }\n+\n /**\n- * Spawns a given command with the specified arguments inside a shell. All process stdout\n- * output is captured and returned as resolution on completion. Depending on the chosen\n- * output mode, stdout/stderr output is also printed to the console, or only on error.\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n  *\n- * @returns a Promise resolving with captured stdout and stderr on success. The promise\n- *   rejects on command failure.\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n  */\n-function spawnWithDebugOutput(command, args, options) {\n-    if (options === void 0) { options = {}; }\n-    return new Promise(function (resolve, reject) {\n-        var commandText = command + \" \" + args.join(' ');\n-        var outputMode = options.mode;\n-        debug(\"Executing command: \" + commandText);\n-        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: 'pipe' }));\n-        var logOutput = '';\n-        var stdout = '';\n-        var stderr = '';\n-        // Capture the stdout separately so that it can be passed as resolve value.\n-        // This is useful if commands return parsable stdout.\n-        childProcess.stderr.on('data', function (message) {\n-            stderr += message;\n-            logOutput += message;\n-            // If console output is enabled, print the message directly to the stderr. Note that\n-            // we intentionally print all output to stderr as stdout should not be polluted.\n-            if (outputMode === undefined || outputMode === 'enabled') {\n-                process.stderr.write(message);\n-            }\n-        });\n-        childProcess.stdout.on('data', function (message) {\n-            stdout += message;\n-            logOutput += message;\n-            // If console output is enabled, print the message directly to the stderr. Note that\n-            // we intentionally print all output to stderr as stdout should not be polluted.\n-            if (outputMode === undefined || outputMode === 'enabled') {\n-                process.stderr.write(message);\n-            }\n-        });\n-        childProcess.on('exit', function (status, signal) {\n-            var exitDescription = status !== null ? \"exit code \\\"\" + status + \"\\\"\" : \"signal \\\"\" + signal + \"\\\"\";\n-            var printFn = outputMode === 'on-error' ? error : debug;\n-            printFn(\"Command \\\"\" + commandText + \"\\\" completed with \" + exitDescription + \".\");\n-            printFn(\"Process output: \\n\" + logOutput);\n-            // On success, resolve the promise. Otherwise reject with the captured stderr\n-            // and stdout log output if the output mode was set to `silent`.\n-            if (status === 0) {\n-                resolve({ stdout: stdout, stderr: stderr });\n-            }\n-            else {\n-                reject(outputMode === 'silent' ? logOutput : undefined);\n-            }\n-        });\n-    });\n+var changelogTemplate = `\n+<a name=\"<%- version %>\"></a>\n+# <%- version %><% if (title) { %> \"<%- title %>\"<% } %> (<%- dateStamp %>)\n+\n+<%_\n+const commitsInChangelog = commits.filter(includeInReleaseNotes());\n+for (const group of asCommitGroups(commitsInChangelog)) {\n+_%>\n+\n+### <%- group.title %>\n+| Commit | Description |\n+| -- | -- |\n+<%_\n+  for (const commit of group.commits) {\n+_%>\n+| <%- commit.shortHash %> | <%- commit.header %> |\n+<%_\n+  }\n+}\n+_%>\n+\n+<%_\n+const breakingChanges = commits.filter(contains('breakingChanges'));\n+if (breakingChanges.length) {\n+_%>\n+## Breaking Changes\n+\n+<%_\n+  for (const group of asCommitGroups(breakingChanges)) {\n+_%>\n+### <%- group.title %>\n+\n+<%_\n+    for (const commit of group.commits) {\n+_%>\n+<%- commit.breakingChanges[0].text %>\n+\n+<%_\n+    }\n+  }\n+}\n+_%>\n+\n+<%_\n+const deprecations = commits.filter(contains('deprecations'));\n+if (deprecations.length) {\n+_%>\n+## Deprecations\n+<%_\n+  for (const group of asCommitGroups(deprecations)) {\n+_%>\n+### <%- group.title %>\n+\n+<%_\n+    for (const commit of group.commits) {\n+_%>\n+<%- commit.deprecations[0].text %>\n+<%_\n+    }\n+  }\n+}\n+_%>\n+\n+<%_\n+const authors = commits.filter(unique('author')).map(c => c.author).sort();\n+if (authors.length === 1) {\n+_%>\n+## Special Thanks:\n+<%- authors[0]%>\n+<%_\n }\n+if (authors.length > 1) {\n+_%>\n+## Special Thanks:\n+<%- authors.slice(0, -1).join(', ') %> and <%- authors.slice(-1)[0] %>\n+<%_\n+}\n+_%>\n+`;\n \n /**\n  * @license\n@@ -5312,93 +5444,221 @@ function spawnWithDebugOutput(command, args, options) {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-/**\n- * Runs NPM publish within a specified package directory.\n- * @throws With the process log output if the publish failed.\n- */\n-function runNpmPublish(packagePath, distTag, registryUrl) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['publish', '--access', 'public', '--tag', distTag];\n-        // If a custom registry URL has been specified, add the `--registry` flag.\n-        if (registryUrl !== undefined) {\n-            args.push('--registry', registryUrl);\n-        }\n-        yield spawnWithDebugOutput('npm', args, { cwd: packagePath, mode: 'silent' });\n-    });\n+var githubReleaseTemplate = `\n+<a name=\"<%- version %>\"></a>\n+# <%- version %><% if (title) { %> \"<%- title %>\"<% } %> (<%- dateStamp %>)\n+\n+<%_\n+const commitsInChangelog = commits.filter(includeInReleaseNotes());\n+for (const group of asCommitGroups(commitsInChangelog)) {\n+_%>\n+\n+### <%- group.title %>\n+| Commit | Description |\n+| -- | -- |\n+<%_\n+  for (const commit of group.commits) {\n+_%>\n+| <%- commit.shortHash %> | <%- commit.header %> |\n+<%_\n+  }\n }\n-/**\n- * Sets the NPM tag to the specified version for the given package.\n- * @throws With the process log output if the tagging failed.\n- */\n-function setNpmTagForPackage(packageName, distTag, version, registryUrl) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['dist-tag', 'add', `${packageName}@${version}`, distTag];\n-        // If a custom registry URL has been specified, add the `--registry` flag.\n-        if (registryUrl !== undefined) {\n-            args.push('--registry', registryUrl);\n-        }\n-        yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n-    });\n+_%>\n+\n+<%_\n+const breakingChanges = commits.filter(contains('breakingChanges'));\n+if (breakingChanges.length) {\n+_%>\n+## Breaking Changes\n+\n+<%_\n+  for (const group of asCommitGroups(breakingChanges)) {\n+_%>\n+### <%- group.title %>\n+\n+<%_\n+    for (const commit of group.commits) {\n+_%>\n+<%- commit.breakingChanges[0].text %>\n+\n+<%_\n+    }\n+  }\n }\n-/**\n- * Checks whether the user is currently logged into NPM.\n- * @returns Whether the user is currently logged into NPM.\n- */\n-function npmIsLoggedIn(registryUrl) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['whoami'];\n-        // If a custom registry URL has been specified, add the `--registry` flag.\n-        if (registryUrl !== undefined) {\n-            args.push('--registry', registryUrl);\n-        }\n-        try {\n-            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n-        }\n-        catch (e) {\n-            return false;\n-        }\n-        return true;\n-    });\n+_%>\n+\n+<%_\n+const deprecations = commits.filter(contains('deprecations'));\n+if (deprecations.length) {\n+_%>\n+## Deprecations\n+<%_\n+  for (const group of asCommitGroups(deprecations)) {\n+_%>\n+### <%- group.title %>\n+\n+<%_\n+    for (const commit of group.commits) {\n+_%>\n+<%- commit.deprecations[0].text %>\n+<%_\n+    }\n+  }\n+}\n+_%>\n+\n+<%_\n+const authors = commits.filter(unique('author')).map(c => c.author).sort();\n+if (authors.length === 1) {\n+_%>\n+## Special Thanks:\n+<%- authors[0]%>\n+<%_\n+}\n+if (authors.length > 1) {\n+_%>\n+## Special Thanks:\n+<%- authors.slice(0, -1).join(', ') %> and <%- authors.slice(-1)[0] %>\n+<%_\n+}\n+_%>\n+`;\n+\n+/** Release note generation. */\n+class ReleaseNotes {\n+    constructor(version, startingRef, endingRef) {\n+        this.version = version;\n+        this.startingRef = startingRef;\n+        this.endingRef = endingRef;\n+        /** An instance of GitClient. */\n+        this.git = GitClient.getInstance();\n+        /** A promise resolving to a list of Commits since the latest semver tag on the branch. */\n+        this.commits = this.getCommitsInRange(this.startingRef, this.endingRef);\n+        /** The configuration for release notes. */\n+        this.config = this.getReleaseConfig().releaseNotes;\n+    }\n+    static fromRange(version, startingRef, endingRef) {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return new ReleaseNotes(version, startingRef, endingRef);\n+        });\n+    }\n+    /** Retrieve the release note generated for a Github Release. */\n+    getGithubReleaseEntry() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return ejs.render(githubReleaseTemplate, yield this.generateRenderContext(), { rmWhitespace: true });\n+        });\n+    }\n+    /** Retrieve the release note generated for a CHANGELOG entry. */\n+    getChangelogEntry() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return ejs.render(changelogTemplate, yield this.generateRenderContext(), { rmWhitespace: true });\n+        });\n+    }\n+    /**\n+     * Prompt the user for a title for the release, if the project's configuration is defined to use a\n+     * title.\n+     */\n+    promptForReleaseTitle() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            if (this.title === undefined) {\n+                if (this.config.useReleaseTitle) {\n+                    this.title = yield promptInput('Please provide a title for the release:');\n+                }\n+                else {\n+                    this.title = false;\n+                }\n+            }\n+            return this.title;\n+        });\n+    }\n+    /** Build the render context data object for constructing the RenderContext instance. */\n+    generateRenderContext() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            if (!this.renderContext) {\n+                this.renderContext = new RenderContext({\n+                    commits: yield this.commits,\n+                    github: this.git.remoteConfig,\n+                    version: this.version.format(),\n+                    groupOrder: this.config.groupOrder,\n+                    hiddenScopes: this.config.hiddenScopes,\n+                    title: yield this.promptForReleaseTitle(),\n+                });\n+            }\n+            return this.renderContext;\n+        });\n+    }\n+    // These methods are used for access to the utility functions while allowing them to be\n+    // overwritten in subclasses during testing.\n+    getCommitsInRange(from, to) {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            return getCommitsInRange(from, to);\n+        });\n+    }\n+    getReleaseConfig(config) {\n+        return getReleaseConfig(config);\n+    }\n }\n+\n /**\n- * Log into NPM at a provided registry.\n- * @throws With the `npm login` status code if the login failed.\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n  */\n-function npmLogin(registryUrl) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['login', '--no-browser'];\n-        // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n-        // must be spliced into the correct place in the command as npm expects it to be the flag\n-        // immediately following the login subcommand.\n-        if (registryUrl !== undefined) {\n-            args.splice(1, 0, '--registry', registryUrl);\n-        }\n-        // The login command prompts for username, password and other profile information. Hence\n-        // the process needs to be interactive (i.e. respecting current TTYs stdin).\n-        yield spawnInteractiveCommand('npm', args);\n+/** Yargs command builder for configuring the `ng-dev release build` command. */\n+function builder$8(argv) {\n+    return argv\n+        .option('releaseVersion', { type: 'string', default: '0.0.0', coerce: (version) => new semver.SemVer(version) })\n+        .option('from', {\n+        type: 'string',\n+        description: 'The git tag or ref to start the changelog entry from',\n+        defaultDescription: 'The latest semver tag',\n+    })\n+        .option('to', {\n+        type: 'string',\n+        description: 'The git tag or ref to end the changelog entry with',\n+        default: 'HEAD',\n+    })\n+        .option('type', {\n+        type: 'string',\n+        description: 'The type of release notes to create',\n+        choices: ['github-release', 'changelog'],\n+        default: 'changelog',\n+    })\n+        .option('outFile', {\n+        type: 'string',\n+        description: 'File location to write the generated release notes to',\n+        coerce: (filePath) => filePath ? path.join(process.cwd(), filePath) : undefined\n     });\n }\n-/**\n- * Log out of NPM at a provided registry.\n- * @returns Whether the user was logged out of NPM.\n- */\n-function npmLogout(registryUrl) {\n+/** Yargs command handler for generating release notes. */\n+function handler$8({ releaseVersion, from, to, outFile, type }) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['logout'];\n-        // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n-        // must be spliced into the correct place in the command as npm expects it to be the flag\n-        // immediately following the logout subcommand.\n-        if (registryUrl !== undefined) {\n-            args.splice(1, 0, '--registry', registryUrl);\n-        }\n-        try {\n-            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+        // Since `yargs` evaluates defaults even if a value as been provided, if no value is provided to\n+        // the handler, the latest semver tag on the branch is used.\n+        from = from || GitClient.getInstance().getLatestSemverTag().format();\n+        /** The ReleaseNotes instance to generate release notes. */\n+        const releaseNotes = yield ReleaseNotes.fromRange(releaseVersion, from, to);\n+        /** The requested release notes entry. */\n+        const releaseNotesEntry = yield (type === 'changelog' ? releaseNotes.getChangelogEntry() :\n+            releaseNotes.getGithubReleaseEntry());\n+        if (outFile) {\n+            fs.writeFileSync(outFile, releaseNotesEntry);\n+            info(`Generated release notes for \"${releaseVersion}\" written to ${outFile}`);\n         }\n-        finally {\n-            return npmIsLoggedIn(registryUrl);\n+        else {\n+            process.stdout.write(releaseNotesEntry);\n         }\n     });\n }\n+/** CLI command module for generating release notes. */\n+const ReleaseNotesCommandModule = {\n+    builder: builder$8,\n+    handler: handler$8,\n+    command: 'notes',\n+    describe: 'Generate release notes',\n+};\n \n /**\n  * @license\n@@ -5408,87 +5668,73 @@ function npmLogout(registryUrl) {\n  * found in the LICENSE file at https://angular.io/license\n  */\n /**\n- * Prints the active release trains to the console.\n- * @params active Active release trains that should be printed.\n- * @params config Release configuration used for querying NPM on published versions.\n+ * Spawns a given command with the specified arguments inside an interactive shell. All process\n+ * stdin, stdout and stderr output is printed to the current console.\n+ *\n+ * @returns a Promise resolving on success, and rejecting on command failure with the status code.\n  */\n-function printActiveReleaseTrains(active, config) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const { releaseCandidate, next, latest } = active;\n-        const isNextPublishedToNpm = yield isVersionPublishedToNpm(next.version, config);\n-        const nextTrainType = next.isMajor ? 'major' : 'minor';\n-        const ltsBranches = yield fetchLongTermSupportBranchesFromNpm(config);\n-        info();\n-        info(blue('Current version branches in the project:'));\n-        // Print information for release trains in the feature-freeze/release-candidate phase.\n-        if (releaseCandidate !== null) {\n-            const rcVersion = releaseCandidate.version;\n-            const rcTrainType = releaseCandidate.isMajor ? 'major' : 'minor';\n-            const rcTrainPhase = rcVersion.prerelease[0] === 'next' ? 'feature-freeze' : 'release-candidate';\n-            info(` • ${bold(releaseCandidate.branchName)} contains changes for an upcoming ` +\n-                `${rcTrainType} that is currently in ${bold(rcTrainPhase)} phase.`);\n-            info(`   Most recent pre-release for this branch is \"${bold(`v${rcVersion}`)}\".`);\n-        }\n-        // Print information about the release-train in the latest phase. i.e. the patch branch.\n-        info(` • ${bold(latest.branchName)} contains changes for the most recent patch.`);\n-        info(`   Most recent patch version for this branch is \"${bold(`v${latest.version}`)}\".`);\n-        // Print information about the release-train in the next phase.\n-        info(` • ${bold(next.branchName)} contains changes for a ${nextTrainType} ` +\n-            `currently in active development.`);\n-        // Note that there is a special case for versions in the next release-train. The version in\n-        // the next branch is not always published to NPM. This can happen when we recently branched\n-        // off for a feature-freeze release-train. More details are in the next pre-release action.\n-        if (isNextPublishedToNpm) {\n-            info(`   Most recent pre-release version for this branch is \"${bold(`v${next.version}`)}\".`);\n-        }\n-        else {\n-            info(`   Version is currently set to \"${bold(`v${next.version}`)}\", but has not been ` +\n-                `published yet.`);\n-        }\n-        // If no release-train in release-candidate or feature-freeze phase is active,\n-        // we print a message as last bullet point to make this clear.\n-        if (releaseCandidate === null) {\n-            info(' • No release-candidate or feature-freeze branch currently active.');\n-        }\n-        info();\n-        info(blue('Current active LTS version branches:'));\n-        // Print all active LTS branches (each branch as own bullet point).\n-        if (ltsBranches.active.length !== 0) {\n-            for (const ltsBranch of ltsBranches.active) {\n-                info(` • ${bold(ltsBranch.name)} is currently in active long-term support phase.`);\n-                info(`   Most recent patch version for this branch is \"${bold(`v${ltsBranch.version}`)}\".`);\n-            }\n-        }\n-        info();\n+function spawnInteractiveCommand(command, args, options) {\n+    if (options === void 0) { options = {}; }\n+    return new Promise(function (resolve, reject) {\n+        var commandText = command + \" \" + args.join(' ');\n+        debug(\"Executing command: \" + commandText);\n+        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: 'inherit' }));\n+        childProcess.on('exit', function (status) { return status === 0 ? resolve() : reject(status); });\n     });\n }\n-\n /**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n+ * Spawns a given command with the specified arguments inside a shell. All process stdout\n+ * output is captured and returned as resolution on completion. Depending on the chosen\n+ * output mode, stdout/stderr output is also printed to the console, or only on error.\n  *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n+ * @returns a Promise resolving with captured stdout and stderr on success. The promise\n+ *   rejects on command failure.\n  */\n-/** Error that will be thrown if the user manually aborted a release action. */\n-class UserAbortedReleaseActionError extends Error {\n-    constructor() {\n-        super();\n-        // Set the prototype explicitly because in ES5, the prototype is accidentally lost due to\n-        // a limitation in down-leveling.\n-        // https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work.\n-        Object.setPrototypeOf(this, UserAbortedReleaseActionError.prototype);\n-    }\n-}\n-/** Error that will be thrown if the action has been aborted due to a fatal error. */\n-class FatalReleaseActionError extends Error {\n-    constructor() {\n-        super();\n-        // Set the prototype explicitly because in ES5, the prototype is accidentally lost due to\n-        // a limitation in down-leveling.\n-        // https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work.\n-        Object.setPrototypeOf(this, FatalReleaseActionError.prototype);\n-    }\n+function spawnWithDebugOutput(command, args, options) {\n+    if (options === void 0) { options = {}; }\n+    return new Promise(function (resolve, reject) {\n+        var commandText = command + \" \" + args.join(' ');\n+        var outputMode = options.mode;\n+        debug(\"Executing command: \" + commandText);\n+        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: 'pipe' }));\n+        var logOutput = '';\n+        var stdout = '';\n+        var stderr = '';\n+        // Capture the stdout separately so that it can be passed as resolve value.\n+        // This is useful if commands return parsable stdout.\n+        childProcess.stderr.on('data', function (message) {\n+            stderr += message;\n+            logOutput += message;\n+            // If console output is enabled, print the message directly to the stderr. Note that\n+            // we intentionally print all output to stderr as stdout should not be polluted.\n+            if (outputMode === undefined || outputMode === 'enabled') {\n+                process.stderr.write(message);\n+            }\n+        });\n+        childProcess.stdout.on('data', function (message) {\n+            stdout += message;\n+            logOutput += message;\n+            // If console output is enabled, print the message directly to the stderr. Note that\n+            // we intentionally print all output to stderr as stdout should not be polluted.\n+            if (outputMode === undefined || outputMode === 'enabled') {\n+                process.stderr.write(message);\n+            }\n+        });\n+        childProcess.on('exit', function (status, signal) {\n+            var exitDescription = status !== null ? \"exit code \\\"\" + status + \"\\\"\" : \"signal \\\"\" + signal + \"\\\"\";\n+            var printFn = outputMode === 'on-error' ? error : debug;\n+            printFn(\"Command \\\"\" + commandText + \"\\\" completed with \" + exitDescription + \".\");\n+            printFn(\"Process output: \\n\" + logOutput);\n+            // On success, resolve the promise. Otherwise reject with the captured stderr\n+            // and stdout log output if the output mode was set to `silent`.\n+            if (status === 0) {\n+                resolve({ stdout: stdout, stderr: stderr });\n+            }\n+            else {\n+                reject(outputMode === 'silent' ? logOutput : undefined);\n+            }\n+        });\n+    });\n }\n \n /**\n@@ -5499,222 +5745,92 @@ class FatalReleaseActionError extends Error {\n  * found in the LICENSE file at https://angular.io/license\n  */\n /**\n- * Increments a specified SemVer version. Compared to the original increment in SemVer,\n- * the version is cloned to not modify the original version instance.\n+ * Runs NPM publish within a specified package directory.\n+ * @throws With the process log output if the publish failed.\n  */\n-function semverInc(version, release, identifier) {\n-    const clone = new semver.SemVer(version.version);\n-    return clone.inc(release, identifier);\n+function runNpmPublish(packagePath, distTag, registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['publish', '--access', 'public', '--tag', distTag];\n+        // If a custom registry URL has been specified, add the `--registry` flag.\n+        if (registryUrl !== undefined) {\n+            args.push('--registry', registryUrl);\n+        }\n+        yield spawnWithDebugOutput('npm', args, { cwd: packagePath, mode: 'silent' });\n+    });\n }\n-\n /**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n+ * Sets the NPM tag to the specified version for the given package.\n+ * @throws With the process log output if the tagging failed.\n  */\n-/** List of types to be included in the release notes. */\n-const typesToIncludeInReleaseNotes = Object.values(COMMIT_TYPES)\n-    .filter(type => type.releaseNotesLevel === ReleaseNotesLevel.Visible)\n-    .map(type => type.name);\n-/** Context class used for rendering release notes. */\n-class RenderContext {\n-    constructor(data) {\n-        this.data = data;\n-        /** An array of group names in sort order if defined. */\n-        this.groupOrder = this.data.groupOrder || [];\n-        /** An array of scopes to hide from the release entry output. */\n-        this.hiddenScopes = this.data.hiddenScopes || [];\n-        /** The title of the release, or `false` if no title should be used. */\n-        this.title = this.data.title;\n-        /** An array of commits in the release period. */\n-        this.commits = this.data.commits;\n-        /** The version of the release. */\n-        this.version = this.data.version;\n-        /** The date stamp string for use in the release notes entry. */\n-        this.dateStamp = buildDateStamp(this.data.date);\n-    }\n-    /**\n-     * Organizes and sorts the commits into groups of commits.\n-     *\n-     * Groups are sorted either by default `Array.sort` order, or using the provided group order from\n-     * the configuration. Commits are order in the same order within each groups commit list as they\n-     * appear in the provided list of commits.\n-     * */\n-    asCommitGroups(commits) {\n-        /** The discovered groups to organize into. */\n-        const groups = new Map();\n-        // Place each commit in the list into its group.\n-        commits.forEach(commit => {\n-            const key = commit.npmScope ? `${commit.npmScope}/${commit.scope}` : commit.scope;\n-            const groupCommits = groups.get(key) || [];\n-            groups.set(key, groupCommits);\n-            groupCommits.push(commit);\n-        });\n-        /**\n-         * Array of CommitGroups containing the discovered commit groups. Sorted in alphanumeric order\n-         * of the group title.\n-         */\n-        const commitGroups = Array.from(groups.entries())\n-            .map(([title, commits]) => ({ title, commits }))\n-            .sort((a, b) => a.title > b.title ? 1 : a.title < b.title ? -1 : 0);\n-        // If the configuration provides a sorting order, updated the sorted list of group keys to\n-        // satisfy the order of the groups provided in the list with any groups not found in the list at\n-        // the end of the sorted list.\n-        if (this.groupOrder.length) {\n-            for (const groupTitle of this.groupOrder.reverse()) {\n-                const currentIdx = commitGroups.findIndex(k => k.title === groupTitle);\n-                if (currentIdx !== -1) {\n-                    const removedGroups = commitGroups.splice(currentIdx, 1);\n-                    commitGroups.splice(0, 0, ...removedGroups);\n-                }\n-            }\n+function setNpmTagForPackage(packageName, distTag, version, registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['dist-tag', 'add', `${packageName}@${version}`, distTag];\n+        // If a custom registry URL has been specified, add the `--registry` flag.\n+        if (registryUrl !== undefined) {\n+            args.push('--registry', registryUrl);\n         }\n-        return commitGroups;\n-    }\n-    /**\n-     * A filter function for filtering a list of commits to only include commits which should appear\n-     * in release notes.\n-     */\n-    includeInReleaseNotes() {\n-        return (commit) => {\n-            if (!typesToIncludeInReleaseNotes.includes(commit.type)) {\n-                return false;\n-            }\n-            if (this.hiddenScopes.includes(commit.scope)) {\n-                return false;\n-            }\n-            return true;\n-        };\n-    }\n-    /**\n-     * A filter function for filtering a list of commits to only include commits which contain a\n-     * truthy value, or for arrays an array with 1 or more elements, for the provided field.\n-     */\n-    contains(field) {\n-        return (commit) => {\n-            const fieldValue = commit[field];\n-            if (!fieldValue) {\n-                return false;\n-            }\n-            if (Array.isArray(fieldValue) && fieldValue.length === 0) {\n-                return false;\n-            }\n-            return true;\n-        };\n-    }\n-    /**\n-     * A filter function for filtering a list of commits to only include commits which contain a\n-     * unique value for the provided field across all commits in the list.\n-     */\n-    unique(field) {\n-        const set = new Set();\n-        return (commit) => {\n-            const include = !set.has(commit[field]);\n-            set.add(commit[field]);\n-            return include;\n-        };\n-    }\n+        yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+    });\n }\n /**\n- * Builds a date stamp for stamping in release notes.\n- *\n- * Uses the current date, or a provided date in the format of YYYY-MM-DD, i.e. 1970-11-05.\n+ * Checks whether the user is currently logged into NPM.\n+ * @returns Whether the user is currently logged into NPM.\n  */\n-function buildDateStamp(date = new Date()) {\n-    const year = `${date.getFullYear()}`;\n-    const month = `${(date.getMonth() + 1)}`.padStart(2, '0');\n-    const day = `${date.getDate()}`.padStart(2, '0');\n-    return [year, month, day].join('-');\n+function npmIsLoggedIn(registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['whoami'];\n+        // If a custom registry URL has been specified, add the `--registry` flag.\n+        if (registryUrl !== undefined) {\n+            args.push('--registry', registryUrl);\n+        }\n+        try {\n+            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+        }\n+        catch (e) {\n+            return false;\n+        }\n+        return true;\n+    });\n }\n-\n /**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n+ * Log into NPM at a provided registry.\n+ * @throws With the `npm login` status code if the login failed.\n  */\n-var changelogTemplate = `\n-<a name=\"<%- version %>\"></a>\n-# <%- version %><% if (title) { %> \"<%- title %>\"<% } %> (<%- dateStamp %>)\n-\n-<%_\n-const commitsInChangelog = commits.filter(includeInReleaseNotes());\n-for (const group of asCommitGroups(commitsInChangelog)) {\n-_%>\n-\n-### <%- group.title %>\n-| Commit | Description |\n-| -- | -- |\n-<%_\n-  for (const commit of group.commits) {\n-_%>\n-| <%- commit.shortHash %> | <%- commit.header %> |\n-<%_\n-  }\n-}\n-_%>\n-\n-<%_\n-const breakingChanges = commits.filter(contains('breakingChanges'));\n-if (breakingChanges.length) {\n-_%>\n-## Breaking Changes\n-\n-<%_\n-  for (const group of asCommitGroups(breakingChanges)) {\n-_%>\n-### <%- group.title %>\n-\n-<%_\n-    for (const commit of group.commits) {\n-_%>\n-<%- commit.breakingChanges[0].text %>\n-\n-<%_\n-    }\n-  }\n-}\n-_%>\n-\n-<%_\n-const deprecations = commits.filter(contains('deprecations'));\n-if (deprecations.length) {\n-_%>\n-## Deprecations\n-<%_\n-  for (const group of asCommitGroups(deprecations)) {\n-_%>\n-### <%- group.title %>\n-\n-<%_\n-    for (const commit of group.commits) {\n-_%>\n-<%- commit.deprecations[0].text %>\n-<%_\n-    }\n-  }\n-}\n-_%>\n-\n-<%_\n-const authors = commits.filter(unique('author')).map(c => c.author).sort();\n-if (authors.length === 1) {\n-_%>\n-## Special Thanks:\n-<%- authors[0]%>\n-<%_\n-}\n-if (authors.length > 1) {\n-_%>\n-## Special Thanks:\n-<%- authors.slice(0, -1).join(', ') %> and <%- authors.slice(-1)[0] %>\n-<%_\n+function npmLogin(registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['login', '--no-browser'];\n+        // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n+        // must be spliced into the correct place in the command as npm expects it to be the flag\n+        // immediately following the login subcommand.\n+        if (registryUrl !== undefined) {\n+            args.splice(1, 0, '--registry', registryUrl);\n+        }\n+        // The login command prompts for username, password and other profile information. Hence\n+        // the process needs to be interactive (i.e. respecting current TTYs stdin).\n+        yield spawnInteractiveCommand('npm', args);\n+    });\n+}\n+/**\n+ * Log out of NPM at a provided registry.\n+ * @returns Whether the user was logged out of NPM.\n+ */\n+function npmLogout(registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['logout'];\n+        // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n+        // must be spliced into the correct place in the command as npm expects it to be the flag\n+        // immediately following the logout subcommand.\n+        if (registryUrl !== undefined) {\n+            args.splice(1, 0, '--registry', registryUrl);\n+        }\n+        try {\n+            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+        }\n+        finally {\n+            return npmIsLoggedIn(registryUrl);\n+        }\n+    });\n }\n-_%>\n-`;\n \n /**\n  * @license\n@@ -5723,165 +5839,104 @@ _%>\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-var githubReleaseTemplate = `\n-<a name=\"<%- version %>\"></a>\n-# <%- version %><% if (title) { %> \"<%- title %>\"<% } %> (<%- dateStamp %>)\n-\n-<%_\n-const commitsInChangelog = commits.filter(includeInReleaseNotes());\n-for (const group of asCommitGroups(commitsInChangelog)) {\n-_%>\n-\n-### <%- group.title %>\n-| Commit | Description |\n-| -- | -- |\n-<%_\n-  for (const commit of group.commits) {\n-_%>\n-| <%- commit.shortHash %> | <%- commit.header %> |\n-<%_\n-  }\n+/**\n+ * Prints the active release trains to the console.\n+ * @params active Active release trains that should be printed.\n+ * @params config Release configuration used for querying NPM on published versions.\n+ */\n+function printActiveReleaseTrains(active, config) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const { releaseCandidate, next, latest } = active;\n+        const isNextPublishedToNpm = yield isVersionPublishedToNpm(next.version, config);\n+        const nextTrainType = next.isMajor ? 'major' : 'minor';\n+        const ltsBranches = yield fetchLongTermSupportBranchesFromNpm(config);\n+        info();\n+        info(blue('Current version branches in the project:'));\n+        // Print information for release trains in the feature-freeze/release-candidate phase.\n+        if (releaseCandidate !== null) {\n+            const rcVersion = releaseCandidate.version;\n+            const rcTrainType = releaseCandidate.isMajor ? 'major' : 'minor';\n+            const rcTrainPhase = rcVersion.prerelease[0] === 'next' ? 'feature-freeze' : 'release-candidate';\n+            info(` • ${bold(releaseCandidate.branchName)} contains changes for an upcoming ` +\n+                `${rcTrainType} that is currently in ${bold(rcTrainPhase)} phase.`);\n+            info(`   Most recent pre-release for this branch is \"${bold(`v${rcVersion}`)}\".`);\n+        }\n+        // Print information about the release-train in the latest phase. i.e. the patch branch.\n+        info(` • ${bold(latest.branchName)} contains changes for the most recent patch.`);\n+        info(`   Most recent patch version for this branch is \"${bold(`v${latest.version}`)}\".`);\n+        // Print information about the release-train in the next phase.\n+        info(` • ${bold(next.branchName)} contains changes for a ${nextTrainType} ` +\n+            `currently in active development.`);\n+        // Note that there is a special case for versions in the next release-train. The version in\n+        // the next branch is not always published to NPM. This can happen when we recently branched\n+        // off for a feature-freeze release-train. More details are in the next pre-release action.\n+        if (isNextPublishedToNpm) {\n+            info(`   Most recent pre-release version for this branch is \"${bold(`v${next.version}`)}\".`);\n+        }\n+        else {\n+            info(`   Version is currently set to \"${bold(`v${next.version}`)}\", but has not been ` +\n+                `published yet.`);\n+        }\n+        // If no release-train in release-candidate or feature-freeze phase is active,\n+        // we print a message as last bullet point to make this clear.\n+        if (releaseCandidate === null) {\n+            info(' • No release-candidate or feature-freeze branch currently active.');\n+        }\n+        info();\n+        info(blue('Current active LTS version branches:'));\n+        // Print all active LTS branches (each branch as own bullet point).\n+        if (ltsBranches.active.length !== 0) {\n+            for (const ltsBranch of ltsBranches.active) {\n+                info(` • ${bold(ltsBranch.name)} is currently in active long-term support phase.`);\n+                info(`   Most recent patch version for this branch is \"${bold(`v${ltsBranch.version}`)}\".`);\n+            }\n+        }\n+        info();\n+    });\n }\n-_%>\n-\n-<%_\n-const breakingChanges = commits.filter(contains('breakingChanges'));\n-if (breakingChanges.length) {\n-_%>\n-## Breaking Changes\n \n-<%_\n-  for (const group of asCommitGroups(breakingChanges)) {\n-_%>\n-### <%- group.title %>\n-\n-<%_\n-    for (const commit of group.commits) {\n-_%>\n-<%- commit.breakingChanges[0].text %>\n-\n-<%_\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Error that will be thrown if the user manually aborted a release action. */\n+class UserAbortedReleaseActionError extends Error {\n+    constructor() {\n+        super();\n+        // Set the prototype explicitly because in ES5, the prototype is accidentally lost due to\n+        // a limitation in down-leveling.\n+        // https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work.\n+        Object.setPrototypeOf(this, UserAbortedReleaseActionError.prototype);\n     }\n-  }\n }\n-_%>\n-\n-<%_\n-const deprecations = commits.filter(contains('deprecations'));\n-if (deprecations.length) {\n-_%>\n-## Deprecations\n-<%_\n-  for (const group of asCommitGroups(deprecations)) {\n-_%>\n-### <%- group.title %>\n-\n-<%_\n-    for (const commit of group.commits) {\n-_%>\n-<%- commit.deprecations[0].text %>\n-<%_\n+/** Error that will be thrown if the action has been aborted due to a fatal error. */\n+class FatalReleaseActionError extends Error {\n+    constructor() {\n+        super();\n+        // Set the prototype explicitly because in ES5, the prototype is accidentally lost due to\n+        // a limitation in down-leveling.\n+        // https://github.com/Microsoft/TypeScript/wiki/FAQ#why-doesnt-extending-built-ins-like-error-array-and-map-work.\n+        Object.setPrototypeOf(this, FatalReleaseActionError.prototype);\n     }\n-  }\n-}\n-_%>\n-\n-<%_\n-const authors = commits.filter(unique('author')).map(c => c.author).sort();\n-if (authors.length === 1) {\n-_%>\n-## Special Thanks:\n-<%- authors[0]%>\n-<%_\n-}\n-if (authors.length > 1) {\n-_%>\n-## Special Thanks:\n-<%- authors.slice(0, -1).join(', ') %> and <%- authors.slice(-1)[0] %>\n-<%_\n }\n-_%>\n-`;\n \n-/** Project-relative path for the changelog file. */\n-const changelogPath = 'CHANGELOG.md';\n-/** Gets the path for the changelog file in a given project. */\n-function getLocalChangelogFilePath(projectDir) {\n-    return path.join(projectDir, changelogPath);\n-}\n-/** Release note generation. */\n-class ReleaseNotes {\n-    constructor(version, startingRef, endingRef) {\n-        this.version = version;\n-        this.startingRef = startingRef;\n-        this.endingRef = endingRef;\n-        /** An instance of GitClient. */\n-        this.git = GitClient.getInstance();\n-        /** A promise resolving to a list of Commits since the latest semver tag on the branch. */\n-        this.commits = this.getCommitsInRange(this.startingRef, this.endingRef);\n-        /** The configuration for release notes. */\n-        this.config = this.getReleaseConfig().releaseNotes;\n-    }\n-    static fromRange(version, startingRef, endingRef) {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            return new ReleaseNotes(version, startingRef, endingRef);\n-        });\n-    }\n-    /** Retrieve the release note generated for a Github Release. */\n-    getGithubReleaseEntry() {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            return ejs.render(githubReleaseTemplate, yield this.generateRenderContext(), { rmWhitespace: true });\n-        });\n-    }\n-    /** Retrieve the release note generated for a CHANGELOG entry. */\n-    getChangelogEntry() {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            return ejs.render(changelogTemplate, yield this.generateRenderContext(), { rmWhitespace: true });\n-        });\n-    }\n-    /**\n-     * Prompt the user for a title for the release, if the project's configuration is defined to use a\n-     * title.\n-     */\n-    promptForReleaseTitle() {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            if (this.title === undefined) {\n-                if (this.config.useReleaseTitle) {\n-                    this.title = yield promptInput('Please provide a title for the release:');\n-                }\n-                else {\n-                    this.title = false;\n-                }\n-            }\n-            return this.title;\n-        });\n-    }\n-    /** Build the render context data object for constructing the RenderContext instance. */\n-    generateRenderContext() {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            if (!this.renderContext) {\n-                this.renderContext = new RenderContext({\n-                    commits: yield this.commits,\n-                    github: this.git.remoteConfig,\n-                    version: this.version.format(),\n-                    groupOrder: this.config.groupOrder,\n-                    hiddenScopes: this.config.hiddenScopes,\n-                    title: yield this.promptForReleaseTitle(),\n-                });\n-            }\n-            return this.renderContext;\n-        });\n-    }\n-    // These methods are used for access to the utility functions while allowing them to be\n-    // overwritten in subclasses during testing.\n-    getCommitsInRange(from, to) {\n-        return tslib.__awaiter(this, void 0, void 0, function* () {\n-            return getCommitsInRange(from, to);\n-        });\n-    }\n-    getReleaseConfig(config) {\n-        return getReleaseConfig(config);\n-    }\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/**\n+ * Increments a specified SemVer version. Compared to the original increment in SemVer,\n+ * the version is cloned to not modify the original version instance.\n+ */\n+function semverInc(version, release, identifier) {\n+    const clone = new semver.SemVer(version.version);\n+    return clone.inc(release, identifier);\n }\n \n /**\n@@ -5918,6 +5973,8 @@ function getReleaseNoteCherryPickCommitMessage(newVersion) {\n  */\n /** Project-relative path for the \"package.json\" file. */\n const packageJsonPath = 'package.json';\n+/** Project-relative path for the changelog file. */\n+const changelogPath = 'CHANGELOG.md';\n /** Default interval in milliseconds to check whether a pull request has been merged. */\n const waitForPullRequestInterval = 10000;\n \n@@ -6357,7 +6414,7 @@ class ReleaseAction {\n      */\n     prependReleaseNotesToChangelog(releaseNotes) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n-            const localChangelogPath = getLocalChangelogFilePath(this.projectDir);\n+            const localChangelogPath = path.join(this.projectDir, changelogPath);\n             const localChangelog = yield fs.promises.readFile(localChangelogPath, 'utf8');\n             const releaseNotesEntry = yield releaseNotes.getChangelogEntry();\n             yield fs.promises.writeFile(localChangelogPath, `${releaseNotesEntry}\\n\\n${localChangelog}`);\n@@ -7223,11 +7280,11 @@ class ReleaseTool {\n  * found in the LICENSE file at https://angular.io/license\n  */\n /** Yargs command builder for configuring the `ng-dev release publish` command. */\n-function builder$8(argv) {\n+function builder$9(argv) {\n     return addGithubTokenOption(argv);\n }\n /** Yargs command handler for staging a release. */\n-function handler$8() {\n+function handler$9() {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         const git = GitClient.getInstance();\n         const config = getConfig();\n@@ -7252,8 +7309,8 @@ function handler$8() {\n }\n /** CLI command module for publishing a release. */\n const ReleasePublishCommandModule = {\n-    builder: builder$8,\n-    handler: handler$8,\n+    builder: builder$9,\n+    handler: handler$9,\n     command: 'publish',\n     describe: 'Publish new releases and configure version branches.',\n };\n@@ -7265,7 +7322,7 @@ const ReleasePublishCommandModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-function builder$9(args) {\n+function builder$a(args) {\n     return args\n         .positional('tagName', {\n         type: 'string',\n@@ -7279,7 +7336,7 @@ function builder$9(args) {\n     });\n }\n /** Yargs command handler for building a release. */\n-function handler$9(args) {\n+function handler$a(args) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         const { targetVersion: rawVersion, tagName } = args;\n         const { npmPackages, publishRegistry } = getReleaseConfig();\n@@ -7311,8 +7368,8 @@ function handler$9(args) {\n }\n /** CLI command module for setting an NPM dist tag. */\n const ReleaseSetDistTagCommand = {\n-    builder: builder$9,\n-    handler: handler$9,\n+    builder: builder$a,\n+    handler: handler$a,\n     command: 'set-dist-tag <tag-name> <target-version>',\n     describe: 'Sets a given NPM dist tag for all release packages.',\n };\n@@ -7392,22 +7449,22 @@ function getCurrentGitUser() {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-function builder$a(args) {\n+function builder$b(args) {\n     return args.option('mode', {\n         demandOption: true,\n         description: 'Whether the env-stamp should be built for a snapshot or release',\n         choices: ['snapshot', 'release']\n     });\n }\n-function handler$a({ mode }) {\n+function handler$b({ mode }) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         buildEnvStamp(mode);\n     });\n }\n /** CLI command module for building the environment stamp. */\n const BuildEnvStampCommand = {\n-    builder: builder$a,\n-    handler: handler$a,\n+    builder: builder$b,\n+    handler: handler$b,\n     command: 'build-env-stamp',\n     describe: 'Build the environment stamping information',\n };\n@@ -7420,7 +7477,8 @@ function buildReleaseParser(localYargs) {\n         .command(ReleasePublishCommandModule)\n         .command(ReleaseBuildCommandModule)\n         .command(ReleaseSetDistTagCommand)\n-        .command(BuildEnvStampCommand);\n+        .command(BuildEnvStampCommand)\n+        .command(ReleaseNotesCommandModule);\n }\n \n /**"
        },
        {
            "sha": "16e5b3287e790a039539af85164c009d3cc70ff1",
            "filename": "dev-infra/release/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2FBUILD.bazel?ref=594e63315eaba93896db601c9b3c822b8dd1e7c9",
            "patch": "@@ -9,6 +9,7 @@ ts_library(\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n         \"//dev-infra/release/build\",\n+        \"//dev-infra/release/notes\",\n         \"//dev-infra/release/publish\",\n         \"//dev-infra/release/set-dist-tag\",\n         \"//dev-infra/utils\","
        },
        {
            "sha": "ce21ae02f19ee8aaa8a92b59035d8ae3a594c219",
            "filename": "dev-infra/release/cli.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fcli.ts?ref=594e63315eaba93896db601c9b3c822b8dd1e7c9",
            "patch": "@@ -8,6 +8,7 @@\n import * as yargs from 'yargs';\n \n import {ReleaseBuildCommandModule} from './build/cli';\n+import {ReleaseNotesCommandModule} from './notes/cli';\n import {ReleasePublishCommandModule} from './publish/cli';\n import {ReleaseSetDistTagCommand} from './set-dist-tag/cli';\n import {BuildEnvStampCommand} from './stamping/cli';\n@@ -20,5 +21,6 @@ export function buildReleaseParser(localYargs: yargs.Argv) {\n       .command(ReleasePublishCommandModule)\n       .command(ReleaseBuildCommandModule)\n       .command(ReleaseSetDistTagCommand)\n-      .command(BuildEnvStampCommand);\n+      .command(BuildEnvStampCommand)\n+      .command(ReleaseNotesCommandModule);\n }"
        },
        {
            "sha": "bc14aeec631a54c8db1459f582885a2a5bca0c78",
            "filename": "dev-infra/release/notes/cli.ts",
            "status": "added",
            "additions": 84,
            "deletions": 0,
            "changes": 84,
            "blob_url": "https://github.com/angular/angular/blob/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2Fnotes%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2Fnotes%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fnotes%2Fcli.ts?ref=594e63315eaba93896db601c9b3c822b8dd1e7c9",
            "patch": "@@ -0,0 +1,84 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {writeFileSync} from 'fs';\n+import {join} from 'path';\n+import {SemVer} from 'semver';\n+import {Arguments, Argv, CommandModule} from 'yargs';\n+\n+import {debug, info} from '../../utils/console';\n+import {GitClient} from '../../utils/git/index';\n+\n+import {ReleaseNotes} from './release-notes';\n+\n+/** Command line options for building a release. */\n+export interface ReleaseNotesOptions {\n+  from?: string;\n+  to: string;\n+  outFile?: string;\n+  releaseVersion: SemVer;\n+  type: 'github-release'|'changelog';\n+}\n+\n+/** Yargs command builder for configuring the `ng-dev release build` command. */\n+function builder(argv: Argv): Argv<ReleaseNotesOptions> {\n+  return argv\n+      .option(\n+          'releaseVersion',\n+          {type: 'string', default: '0.0.0', coerce: (version: string) => new SemVer(version)})\n+      .option('from', {\n+        type: 'string',\n+        description: 'The git tag or ref to start the changelog entry from',\n+        defaultDescription: 'The latest semver tag',\n+      })\n+      .option('to', {\n+        type: 'string',\n+        description: 'The git tag or ref to end the changelog entry with',\n+        default: 'HEAD',\n+      })\n+      .option('type', {\n+        type: 'string',\n+        description: 'The type of release notes to create',\n+        choices: ['github-release', 'changelog'] as const,\n+        default: 'changelog' as const,\n+      })\n+      .option('outFile', {\n+        type: 'string',\n+        description: 'File location to write the generated release notes to',\n+        coerce: (filePath?: string) => filePath ? join(process.cwd(), filePath) : undefined\n+      });\n+}\n+\n+/** Yargs command handler for generating release notes. */\n+async function handler({releaseVersion, from, to, outFile, type}: Arguments<ReleaseNotesOptions>) {\n+  // Since `yargs` evaluates defaults even if a value as been provided, if no value is provided to\n+  // the handler, the latest semver tag on the branch is used.\n+  from = from || GitClient.getInstance().getLatestSemverTag().format();\n+  /** The ReleaseNotes instance to generate release notes. */\n+  const releaseNotes = await ReleaseNotes.fromRange(releaseVersion, from, to);\n+\n+  /** The requested release notes entry. */\n+  const releaseNotesEntry = await (\n+      type === 'changelog' ? releaseNotes.getChangelogEntry() :\n+                             releaseNotes.getGithubReleaseEntry());\n+\n+  if (outFile) {\n+    writeFileSync(outFile, releaseNotesEntry);\n+    info(`Generated release notes for \"${releaseVersion}\" written to ${outFile}`);\n+  } else {\n+    process.stdout.write(releaseNotesEntry);\n+  }\n+}\n+\n+/** CLI command module for generating release notes. */\n+export const ReleaseNotesCommandModule: CommandModule<{}, ReleaseNotesOptions> = {\n+  builder,\n+  handler,\n+  command: 'notes',\n+  describe: 'Generate release notes',\n+};"
        },
        {
            "sha": "263ca3f51f941134a701a2e4bf0374636eef4546",
            "filename": "dev-infra/release/publish/test/common.spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/594e63315eaba93896db601c9b3c822b8dd1e7c9/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Ftest%2Fcommon.spec.ts?ref=594e63315eaba93896db601c9b3c822b8dd1e7c9",
            "patch": "@@ -11,13 +11,14 @@ import {join} from 'path';\n import * as semver from 'semver';\n \n import {getBranchPushMatcher} from '../../../utils/testing';\n-import {changelogPath, ReleaseNotes} from '../../notes/release-notes';\n+import {ReleaseNotes} from '../../notes/release-notes';\n import {NpmDistTag} from '../../versioning';\n import {ActiveReleaseTrains} from '../../versioning/active-release-trains';\n import * as npm from '../../versioning/npm-publish';\n import {ReleaseTrain} from '../../versioning/release-trains';\n import {ReleaseAction} from '../actions';\n import {actions} from '../actions/index';\n+import {changelogPath} from '../constants';\n \n import {fakeNpmPackageQueryRequest, getTestingMocksForReleaseAction, parse, setupReleaseActionForTesting, testTmpDir} from './test-utils';\n "
        }
    ],
    "stats": {
        "total": 1314,
        "additions": 730,
        "deletions": 584
    }
}