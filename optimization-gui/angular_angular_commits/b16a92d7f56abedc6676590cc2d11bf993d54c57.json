{
    "author": "gkalpak",
    "message": "refactor(docs-infra): move `deploy-to-firebase` pre-deploy actions to a separate file (#43963)\n\nMove some functions that are used as pre-deploy actions from\n`deploy-to-firebase/index.mjs` to a separate file\n(`deploy-to-firebase/pre-deploy-actions.mjs`) to keep `index.mjs` small\nand easier to maintain.\n\nAlso, rename the `removeServiceWorker()` function to\n`disableServiceWorker()`, which is a little more accurate.\n\nNOTE:\nWhile not strictly necessary atm, `pre-deploy-actions.mjs` uses the same\ndefault export pattern for consistency with `utils.mjs`.\n\nPR Close #43963",
    "sha": "b16a92d7f56abedc6676590cc2d11bf993d54c57",
    "files": [
        {
            "sha": "a6ecc34cadd2e8bbdad2951c4cc2308f5b6f73f7",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "modified",
            "additions": 6,
            "deletions": 36,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=b16a92d7f56abedc6676590cc2d11bf993d54c57",
            "patch": "@@ -5,6 +5,7 @@\n \n import sh from 'shelljs';\n import {fileURLToPath} from 'url';\n+import pre from './pre-deploy-actions.mjs';\n import u from './utils.mjs';\n \n sh.set('-e');\n@@ -62,22 +63,6 @@ if (fileURLToPath(import.meta.url) === process.argv[1]) {\n }\n \n // Helpers\n-function build({deployedUrl, deployEnv}) {\n-  u.logSectionHeader('Build the AIO app.');\n-  u.yarn(`build --configuration=${deployEnv} --progress=false`);\n-\n-  u.logSectionHeader('Add any mode-specific files into the AIO distribution.');\n-  sh.cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n-\n-  u.logSectionHeader('Update opensearch descriptor for AIO with `deployedUrl`.');\n-  u.yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`); // The URL must end with `/`.\n-}\n-\n-function checkPayloadSize() {\n-  u.logSectionHeader('Check payload size and upload the numbers to Firebase DB.');\n-  u.yarn('payload-size');\n-}\n-\n function computeDeploymentsInfo(\n     {currentBranch, currentCommit, isPullRequest, repoName, repoOwner, stableBranch}) {\n   // Do not deploy if we are running in a fork.\n@@ -114,7 +99,7 @@ function computeDeploymentsInfo(\n       projectId: 'angular-io',\n       siteId: 'next-angular-io-site',\n       deployedUrl: 'https://next.angular.io/',\n-      preDeployActions: [build, checkPayloadSize],\n+      preDeployActions: [pre.build, pre.checkPayloadSize],\n       postDeployActions: [testPwaScore],\n     },\n     rc: {\n@@ -124,7 +109,7 @@ function computeDeploymentsInfo(\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n-      preDeployActions: [build, checkPayloadSize],\n+      preDeployActions: [pre.build, pre.checkPayloadSize],\n       postDeployActions: [testPwaScore],\n     },\n     stable: {\n@@ -134,7 +119,7 @@ function computeDeploymentsInfo(\n       projectId: 'angular-io',\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: 'https://angular.io/',\n-      preDeployActions: [build, checkPayloadSize],\n+      preDeployActions: [pre.build, pre.checkPayloadSize],\n       postDeployActions: [testPwaScore],\n     },\n     archive: {\n@@ -144,7 +129,7 @@ function computeDeploymentsInfo(\n       projectId: 'angular-io',\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n-      preDeployActions: [build, checkPayloadSize],\n+      preDeployActions: [pre.build, pre.checkPayloadSize],\n       postDeployActions: [testPwaScore],\n     },\n \n@@ -165,7 +150,7 @@ function computeDeploymentsInfo(\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n-      preDeployActions: [removeServiceWorker, redirectToAngularIo],\n+      preDeployActions: [pre.disableServiceWorker, pre.redirectToAngularIo],\n       postDeployActions: [testNoActiveRcDeployment],\n     },\n   };\n@@ -286,21 +271,6 @@ function listDeployTargetNames(deploymentsList) {\n   return deploymentsList.map(({name = '<no name>'}) => name).join(', ') || '-';\n }\n \n-function redirectToAngularIo() {\n-  // Update the Firebase hosting configuration redirect all non-file requests (i.e. requests that do\n-  // not contain a dot in their last path segment) to `angular.io`.\n-  // See https://firebase.google.com/docs/hosting/full-config#redirects.\n-  const redirectRule =\n-      '{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"}';\n-  sh.sed('-i', /(\\s*)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`, 'firebase.json');\n-}\n-\n-function removeServiceWorker() {\n-  // Rename the SW manifest (`ngsw.json`). This will cause the ServiceWorker to unregister itself.\n-  // See https://angular.io/guide/service-worker-devops#fail-safe.\n-  sh.mv('dist/ngsw.json', 'dist/ngsw.json.bak');\n-}\n-\n function serializeActions(actions) {\n   return actions.map(fn => fn.name).join(', ');\n }"
        },
        {
            "sha": "40b55a4bf685e02c01b572346399afcf52c53833",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.mjs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs?ref=b16a92d7f56abedc6676590cc2d11bf993d54c57",
            "patch": "@@ -157,7 +157,7 @@ describe('deploy-to-firebase:', () => {\n         projectId: 'angular-io',\n         siteId: 'rc-angular-io-site',\n         deployedUrl: 'https://rc.angular.io/',\n-        preDeployActions: ['function:removeServiceWorker', 'function:redirectToAngularIo'],\n+        preDeployActions: ['function:disableServiceWorker', 'function:redirectToAngularIo'],\n         postDeployActions: ['function:testNoActiveRcDeployment'],\n       },\n     ]);"
        },
        {
            "sha": "1ef665fd03ff4b085ee177b46390eff992b62c52",
            "filename": "aio/scripts/deploy-to-firebase/pre-deploy-actions.mjs",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs",
            "raw_url": "https://github.com/angular/angular/raw/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.mjs?ref=b16a92d7f56abedc6676590cc2d11bf993d54c57",
            "patch": "@@ -0,0 +1,48 @@\n+import sh from 'shelljs';\n+import u from './utils.mjs';\n+\n+\n+// Exports\n+const exp = {\n+  build,\n+  checkPayloadSize,\n+  disableServiceWorker,\n+  redirectToAngularIo,\n+};\n+export default exp;\n+\n+// Helpers\n+function build({deployedUrl, deployEnv}) {\n+  u.logSectionHeader('Build the AIO app.');\n+  u.yarn(`build --configuration=${deployEnv} --progress=false`);\n+\n+  u.logSectionHeader('Add any mode-specific files into the AIO distribution.');\n+  sh.cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+\n+  u.logSectionHeader('Update opensearch descriptor for AIO with `deployedUrl`.');\n+  u.yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`); // The URL must end with `/`.\n+}\n+\n+function checkPayloadSize() {\n+  u.logSectionHeader('Check payload size and upload the numbers to Firebase DB.');\n+  u.yarn('payload-size');\n+}\n+\n+function disableServiceWorker() {\n+  u.logSectionHeader('Disable the ServiceWorker.');\n+\n+  // Rename the SW manifest (`ngsw.json`). This will cause the ServiceWorker to unregister itself.\n+  // See https://angular.io/guide/service-worker-devops#fail-safe.\n+  sh.mv('dist/ngsw.json', 'dist/ngsw.json.bak');\n+}\n+\n+function redirectToAngularIo() {\n+  u.logSectionHeader('Configure Firebase hosting to redirect to https://angular.io/.');\n+\n+  // Update the Firebase hosting configuration to redirect all non-file requests (i.e. requests that\n+  // do not contain a dot in their last path segment) to `angular.io`.\n+  // See https://firebase.google.com/docs/hosting/full-config#redirects.\n+  const redirectRule =\n+      '{\"type\": 302, \"regex\": \"^(.*/[^./]*)$\", \"destination\": \"https://angular.io:1\"}';\n+  sh.sed('-i', /(\\s*)\"redirects\": \\[/, `$&\\n$1  ${redirectRule},\\n`, 'firebase.json');\n+}"
        },
        {
            "sha": "a3c694248ddd462dfe4982384d75a5adfe4dc07b",
            "filename": "aio/scripts/deploy-to-firebase/pre-deploy-actions.spec.mjs",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/angular/angular/blob/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/b16a92d7f56abedc6676590cc2d11bf993d54c57/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Fpre-deploy-actions.spec.mjs?ref=b16a92d7f56abedc6676590cc2d11bf993d54c57",
            "patch": "@@ -0,0 +1,81 @@\n+import sh from 'shelljs';\n+import pre from './pre-deploy-actions.mjs';\n+import u from './utils.mjs';\n+\n+\n+describe('deploy-to-firebase/pre-deploy-actions:', () => {\n+  beforeEach(() => spyOn(u, 'logSectionHeader'));\n+\n+  describe('build()', () => {\n+    let cpSpy;\n+    let yarnSpy;\n+\n+    beforeEach(() => {\n+      cpSpy = spyOn(sh, 'cp');\n+      yarnSpy = spyOn(u, 'yarn');\n+    });\n+\n+    it('should build the app for the appropriate mode', () => {\n+      pre.build({deployedUrl: 'http://example.com/foo/', deployEnv: 'bar'});\n+      expect(yarnSpy).toHaveBeenCalledWith('build --configuration=bar --progress=false');\n+    });\n+\n+    it('should add mode-specific files into the distribution', () => {\n+      pre.build({deployedUrl: 'http://example.com/foo/', deployEnv: 'bar'});\n+      expect(cpSpy).toHaveBeenCalledWith('-rf', 'src/extra-files/bar/.', 'dist/');\n+    });\n+\n+    it('should update the opensearch descriptor', () => {\n+      pre.build({deployedUrl: 'http://example.com/foo/', deployEnv: 'bar'});\n+      expect(yarnSpy).toHaveBeenCalledWith('set-opensearch-url http://example.com/foo/');\n+    });\n+\n+    it('should add a trailing `/` to the opensearch descriptor URL (if necessary)', () => {\n+      pre.build({deployedUrl: '/foo', deployEnv: 'bar'});\n+      expect(yarnSpy).toHaveBeenCalledWith('set-opensearch-url /foo/');\n+\n+      pre.build({deployedUrl: '/baz/', deployEnv: 'qux'});\n+      expect(yarnSpy).toHaveBeenCalledWith('set-opensearch-url /baz/');\n+    });\n+\n+    it('should execute the operations in the correct order', () => {\n+      let logs = [];\n+      yarnSpy.and.callFake(cmd => logs.push(`yarn ${cmd}`));\n+      cpSpy.and.callFake((opts, from, to) => logs.push(`cp ${opts} ${from} ${to}`));\n+\n+      pre.build({deployedUrl: 'http://example.com/foo/', deployEnv: 'bar'});\n+      expect(logs).toEqual([\n+        'yarn build --configuration=bar --progress=false',\n+        'cp -rf src/extra-files/bar/. dist/',\n+        'yarn set-opensearch-url http://example.com/foo/',\n+      ]);\n+    });\n+  });\n+\n+  describe('checkPayloadSize()', () => {\n+    let yarnSpy;\n+\n+    beforeEach(() => yarnSpy = spyOn(u, 'yarn'));\n+\n+    it('should check the payload size', () => {\n+      pre.checkPayloadSize();\n+      expect(yarnSpy).toHaveBeenCalledWith('payload-size');\n+    });\n+  });\n+\n+  describe('disableServiceWorker()', () => {\n+    let mvSpy;\n+\n+    beforeEach(() => mvSpy = spyOn(sh, 'mv'));\n+\n+    it('should disable the ServiceWorker by renaming the `ngsw.json` manifest', () => {\n+      pre.disableServiceWorker();\n+      expect(mvSpy).toHaveBeenCalledWith('dist/ngsw.json', 'dist/ngsw.json.bak');\n+    });\n+  });\n+\n+  describe('redirectToAngularIo()', () => {\n+    // TODO(gkalpak): Add tests for this function.\n+    it('should have tests');\n+  });\n+});"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 136,
        "deletions": 37
    }
}