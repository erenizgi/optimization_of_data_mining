{
    "author": "gkalpak",
    "message": "ci: improve angular.io deployment process for the master branch (#43963)\n\nPreviously, the master branch was only deployed to the\n`next-angular-io-site` Firebase site, which is connected to the\n`next.angular.io` domain. However, if the master major version was\nhigher than the stable major version (or the RC major version in case\nthere was an active RC), we also had to manually configure (via the\nFirebase console and/or DNS records) the `v<X>.angular.io` domain to\nredirect to `next.angular.io`. Then, once `<X>` became the new stable or\nRC version, we had to manually remove the redirect (to let\n`v<X>.angular.io` be redirected to `angular.io` or `rc.angular.io`).\n\nThis commit is part of a new process that reduces the manual steps as\nfollows (the steps below only apply when the master major version is\nhigher than the current stable and RC (if applicable)):\n- A `v<X>-angular-io-site` Firebase site will be created as soon as the\n  version in the `master` branch's `package.json` is updated to a new\n  major.\n- The `v<X>.angular.io` domain will be connected to that new Firebase\n  site.\n- When deploying from the master branch, we will deploy to both\n  `next-angular-io-site` and `v<X>-angular-io-site`. In addition, the\n  deployment to `v<X>-angular-io-site` will update the Firebase config\n  file to redirect to `next.angular.io`.\n- When the master version becomes the new stable/RC, we will start\n  deploying to `v<X>-angular-io-site` from the stable/RC branch, which\n  will update the Firebase config to stop redirecting to\n  `next.angular.io` and redirect to `(rc.)angular.io` instead (without\n  requiring changes in the Firebase console or DNS).\n\nPR Close #43963",
    "sha": "8d8cdc1991e26358ded644c51a8449f3869016ca",
    "files": [
        {
            "sha": "c544fca778637954bd76da61b2eda328c9e49227",
            "filename": "aio/scripts/deploy-to-firebase/index.mjs",
            "status": "modified",
            "additions": 43,
            "deletions": 9,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "raw_url": "https://github.com/angular/angular/raw/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.mjs?ref=8d8cdc1991e26358ded644c51a8449f3869016ca",
            "patch": "@@ -28,14 +28,16 @@\n  * | from?     |        |                                 | redirectVersionDomainToRc(*)    |\n  * |           |--------|---------------------------------|---------------------------------|\n  * |           | MASTER | next                            | next                            |\n- * |           |        |                                 |                                 |\n+ * |           |        | redirectVersionDomainToNext(**) | redirectVersionDomainToNext(**) |\n  * |-----------|--------|---------------------------------|---------------------------------|\n  *\n  * (*):  Only if `v<RC>` > `v<STABLE>`.\n+ * (**): Only if (no active RC and `v<NEXT>` > `v<STABLE>`) or (active RC and `v<NEXT>` > `v<RC>`).\n  *\n  * NOTES:\n  *   - The `v<X>-angular-io-site` Firebase site should be created (and connected to the\n- *     `v<X>.angular.io` subdomain) before a new RC branch is created.\n+ *     `v<X>.angular.io` subdomain) before the version in the `master` branch's `package.json` is\n+ *     updated to a new major.\n  *   - When a new major version is released, the deploy CI jobs for the new stable branch (prev. RC\n  *     or next) and the old stable branch must be run AFTER the new stable version has been\n  *     published to NPM, because the NPM info is used to determine what the stable version is.\n@@ -57,6 +59,7 @@ sh.set('-e');\n \n // Constants\n const DIRNAME = u.getDirname(import.meta.url);\n+const ROOT_PKG_PATH = `${DIRNAME}/../../../package.json`;\n \n // Exports\n export {\n@@ -129,7 +132,10 @@ function computeDeploymentsInfo(\n   }\n \n   // The deployment mode is computed based on the branch we are building.\n-  const currentBranchMajorVersion = u.computeMajorVersion(currentBranch);\n+  const currentVersionPattern =  /^\\d+\\.\\d+\\.x$/.test(currentBranch) ?\n+    currentBranch :  // The current branch name is a version pattern.\n+    u.loadJson(ROOT_PKG_PATH).version;  // We need to retrieve the version from `package.json`.\n+  const currentBranchMajorVersion = u.computeMajorVersion(currentVersionPattern);\n   const stableBranchMajorVersion = u.computeMajorVersion(stableBranch);\n   const deploymentInfoPerTarget = {\n     // PRIMARY DEPLOY TARGETS\n@@ -189,6 +195,16 @@ function computeDeploymentsInfo(\n     // Since there can be multiple secondary deployments (each tweaking the primary one in different\n     // ways), it is a good idea to ensure that any pre-deploy actions are undone in the post-deploy\n     // phase.\n+    redirectVersionDomainToNext: {\n+      name: 'redirectVersionDomainToNext',\n+      type: 'secondary',\n+      deployEnv: 'next',\n+      projectId: 'angular-io',\n+      siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n+      deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+      preDeployActions: [pre.redirectAllToNext],\n+      postDeployActions: [pre.undo.redirectAllToNext, post.testRedirectToNext],\n+    },\n     redirectVersionDomainToRc: {\n       name: 'redirectVersionDomainToRc',\n       type: 'secondary',\n@@ -228,15 +244,33 @@ function computeDeploymentsInfo(\n     },\n   };\n \n-  // If the current branch is `master`, deploy as `next`.\n-  if (currentBranch === 'master') {\n-    return [deploymentInfoPerTarget.next];\n-  }\n-\n   // Determine if there is an active RC version by checking whether the most recent minor branch is\n   // the stable branch or not.\n   const mostRecentMinorBranch = u.getMostRecentMinorBranch();\n   const rcBranch = (mostRecentMinorBranch !== stableBranch) ? mostRecentMinorBranch : null;\n+  const isRcActive = rcBranch !== null;\n+\n+  // If the current branch is `master`, deploy as `next`.\n+  if (currentBranch === 'master') {\n+    // In order to determine whether to also deploy to `v<NEXT>-angular-io-site` we need to compare\n+    // `v<NEXT>` with either `v<RC>` (if there is an active RC) or `v<STABLE>`.\n+    const otherVersion = isRcActive ? u.computeMajorVersion(rcBranch) : stableBranchMajorVersion;\n+\n+    return (currentBranchMajorVersion > otherVersion) ?\n+      // The next major version is greater than the RC or stable major version.\n+      // Deploy to both `next-angular-io-site` and `v<NEXT>-angular-io-site`.\n+      [\n+        deploymentInfoPerTarget.next,\n+        deploymentInfoPerTarget.redirectVersionDomainToNext,\n+      ] :\n+      // The next major version is not greater than the RC or stable major version.\n+      // Only deploy to `next-angular-io-site` (since `v<NEXT>-angular-io-site` is probably\n+      // `v<RC>-angular-io-site` or `v<STABLE>-angular-io-site` and we don't want to overwrite the\n+      // RC or stable deployment).\n+      [\n+        deploymentInfoPerTarget.next,\n+      ];\n+  }\n \n   // If the current branch is the RC branch, deploy as `rc`.\n   if (currentBranch === rcBranch) {\n@@ -257,7 +291,7 @@ function computeDeploymentsInfo(\n \n   // If the current branch is the stable branch, deploy as `stable`.\n   if (currentBranch === stableBranch) {\n-    return (rcBranch !== null) ?\n+    return isRcActive ?\n       // There is an active RC version. Only deploy to the `stable` projects/sites.\n       [\n         deploymentInfoPerTarget.stable,"
        },
        {
            "sha": "b627d4195fdfb3100e51807b2acc950311cf9582",
            "filename": "aio/scripts/deploy-to-firebase/index.spec.mjs",
            "status": "modified",
            "additions": 109,
            "deletions": 1,
            "changes": 110,
            "blob_url": "https://github.com/angular/angular/blob/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Findex.spec.mjs?ref=8d8cdc1991e26358ded644c51a8449f3869016ca",
            "patch": "@@ -79,7 +79,50 @@ describe('deploy-to-firebase:', () => {\n     ]);\n   });\n \n-  it('master - deploy success', () => {\n+  it('master - deploy success - no active RC, major higher than stable', () => {\n+    const mostRecentMajorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+    const fakeMasterMajorVersion = mostRecentMajorVersion + 1;\n+\n+    // Fake the `package.json` version.\n+    spyOn(u, 'loadJson').and.returnValue({version: `${fakeMasterMajorVersion}.0.0-next.42`});\n+\n+    expect(getDeploymentsInfoFor({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: 'master',\n+      CI_STABLE_BRANCH: mostRecentMinorBranch,\n+      CI_COMMIT: latestCommits.master,\n+    })).toEqual([\n+      {\n+        name: 'next',\n+        type: 'primary',\n+        deployEnv: 'next',\n+        projectId: 'angular-io',\n+        siteId: 'next-angular-io-site',\n+        deployedUrl: 'https://next.angular.io/',\n+        preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+        postDeployActions: ['function:testPwaScore'],\n+      },\n+      {\n+        name: 'redirectVersionDomainToNext',\n+        type: 'secondary',\n+        deployEnv: 'next',\n+        projectId: 'angular-io',\n+        siteId: `v${fakeMasterMajorVersion}-angular-io-site`,\n+        deployedUrl: `https://v${fakeMasterMajorVersion}.angular.io/`,\n+        preDeployActions: ['function:redirectAllToNext'],\n+        postDeployActions: ['function:undoRedirectAllToNext', 'function:testRedirectToNext'],\n+      },\n+    ]);\n+  });\n+\n+  it('master - deploy success - no active RC, major same as stable', () => {\n+    const mostRecentMajorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+\n+    // Fake the `package.json` version.\n+    spyOn(u, 'loadJson').and.returnValue({version: `${mostRecentMajorVersion}.42.0`});\n+\n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n@@ -101,6 +144,71 @@ describe('deploy-to-firebase:', () => {\n     ]);\n   });\n \n+  it('master - deploy success - active RC, major higher than RC and stable', () => {\n+    const mostRecentMajorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+    const fakeMasterMajorVersion = mostRecentMajorVersion + 1;\n+\n+    // Fake the `package.json` version.\n+    spyOn(u, 'loadJson').and.returnValue({version: `${fakeMasterMajorVersion}.0.0-next.42`});\n+\n+    expect(getDeploymentsInfoFor({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: 'master',\n+      CI_STABLE_BRANCH: '4.4.x',\n+      CI_COMMIT: latestCommits.master,\n+    })).toEqual([\n+      {\n+        name: 'next',\n+        type: 'primary',\n+        deployEnv: 'next',\n+        projectId: 'angular-io',\n+        siteId: 'next-angular-io-site',\n+        deployedUrl: 'https://next.angular.io/',\n+        preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+        postDeployActions: ['function:testPwaScore'],\n+      },\n+      {\n+        name: 'redirectVersionDomainToNext',\n+        type: 'secondary',\n+        deployEnv: 'next',\n+        projectId: 'angular-io',\n+        siteId: `v${fakeMasterMajorVersion}-angular-io-site`,\n+        deployedUrl: `https://v${fakeMasterMajorVersion}.angular.io/`,\n+        preDeployActions: ['function:redirectAllToNext'],\n+        postDeployActions: ['function:undoRedirectAllToNext', 'function:testRedirectToNext'],\n+      },\n+    ]);\n+  });\n+\n+  it('master - deploy success - active RC, major same as RC and higher than stable', () => {\n+    const mostRecentMajorVersion = u.computeMajorVersion(mostRecentMinorBranch);\n+\n+    // Fake the `package.json` version.\n+    spyOn(u, 'loadJson').and.returnValue({version: `${mostRecentMajorVersion}.0.0-next.42`});\n+\n+    expect(getDeploymentsInfoFor({\n+      CI_REPO_OWNER: 'angular',\n+      CI_REPO_NAME: 'angular',\n+      CI_PULL_REQUEST: 'false',\n+      CI_BRANCH: 'master',\n+      CI_STABLE_BRANCH: '4.4.x',\n+      CI_COMMIT: latestCommits.master,\n+    })).toEqual([\n+      {\n+        name: 'next',\n+        type: 'primary',\n+        deployEnv: 'next',\n+        projectId: 'angular-io',\n+        siteId: 'next-angular-io-site',\n+        deployedUrl: 'https://next.angular.io/',\n+        preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+        postDeployActions: ['function:testPwaScore'],\n+      },\n+    ]);\n+  });\n+\n   it('master - skip deploy - commit not HEAD', () => {\n     expect(getDeploymentsInfoFor({\n       CI_REPO_OWNER: 'angular',"
        },
        {
            "sha": "8096cdbd48203f93d7762baa3beeb3c7d93cd8ff",
            "filename": "aio/scripts/deploy-to-firebase/utils.mjs",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.mjs",
            "raw_url": "https://github.com/angular/angular/raw/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.mjs?ref=8d8cdc1991e26358ded644c51a8449f3869016ca",
            "patch": "@@ -1,3 +1,4 @@\n+import fs from 'fs';\n import {dirname} from 'path';\n import sh from 'shelljs';\n import {fileURLToPath} from 'url';\n@@ -25,15 +26,16 @@ const exp = {\n   getLatestCommit,\n   getMostRecentMinorBranch,\n   getRemoteRefs,\n+  loadJson,\n   logSectionHeader,\n   nameFunction,\n   yarn,\n };\n export default exp;\n \n // Helpers\n-function computeMajorVersion(branchName) {\n-  return +branchName.split('.', 1)[0];\n+function computeMajorVersion(versionPattern) {\n+  return +versionPattern.split('.', 1)[0];\n }\n \n function getDirname(fileUrl) {\n@@ -82,6 +84,10 @@ function getLatestCommit(branchName, options = undefined) {\n   return exp.getRemoteRefs(branchName, options)[0].slice(0, 40);\n }\n \n+function loadJson(filePath) {\n+  return JSON.parse(fs.readFileSync(filePath, 'utf8'));\n+}\n+\n function logSectionHeader(message) {\n   console.log(`\\n\\n\\n==== ${message} ====\\n`);\n }"
        },
        {
            "sha": "df6be6dd4a586c1a23d07d4a291713aeb330a750",
            "filename": "aio/scripts/deploy-to-firebase/utils.spec.mjs",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.spec.mjs",
            "raw_url": "https://github.com/angular/angular/raw/8d8cdc1991e26358ded644c51a8449f3869016ca/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.spec.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase%2Futils.spec.mjs?ref=8d8cdc1991e26358ded644c51a8449f3869016ca",
            "patch": "@@ -1,3 +1,4 @@\n+import fs from 'fs';\n import sh from 'shelljs';\n import u from './utils.mjs';\n \n@@ -226,6 +227,17 @@ describe('deploy-to-firebase/utils:', () => {\n     });\n   });\n \n+  describe('loadJson()', () => {\n+    let readFileSyncSpy;\n+\n+    beforeEach(() => readFileSyncSpy = spyOn(fs, 'readFileSync'));\n+\n+    it('should load and parse a JSON file', () => {\n+      readFileSyncSpy.withArgs('/foo/bar.json', 'utf8').and.returnValue('{\"foo\": \"bar\"}');\n+      expect(u.loadJson('/foo/bar.json')).toEqual({foo: 'bar'});\n+    });\n+  });\n+\n   describe('logSectionHeader()', () => {\n     let logSpy;\n "
        }
    ],
    "stats": {
        "total": 184,
        "additions": 172,
        "deletions": 12
    }
}