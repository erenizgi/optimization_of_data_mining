{
    "author": "petebacondarwin",
    "message": "build(docs-infra): use case-insensitive encoding for content files (#42414)\n\nTo avoid having content files that have the same file path on case-insensitive\nfile-systems, we now encode the paths to remove uppercase characters.\n\nPR Close #42414",
    "sha": "b0592c1be6a65c5074a4a0967075b28b8e054b54",
    "files": [
        {
            "sha": "8b083e391ba84f09d1d6c183ce9f2c7fe17721d0",
            "filename": "aio/src/app/documents/document.service.spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 24,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.spec.ts?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -67,29 +67,17 @@ describe('DocumentService', () => {\n       expect(latestDocument).toEqual(doc1);\n     });\n \n-    // HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n-    it('should attempt disambiguated document paths if the document is not found on the server', () => {\n-      let currentDocument: DocumentContents|undefined;\n-      const notFoundDoc = { id: FILE_NOT_FOUND_ID, contents: '<h1>Page Not Found</h1>' };\n-      const { docService, logger } = getServices('missing/Doc-1');\n-      docService.currentDocument.subscribe(doc => currentDocument = doc);\n-\n-      // Initial request return 404.\n-      httpMock.expectOne({url: 'generated/docs/missing/Doc-1.json'}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n-      httpMock.expectOne({url: 'generated/docs/missing/d_oc-1.json'}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n-      httpMock.expectOne({url: 'generated/docs/missing/d_oc.json'}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n-      expect(logger.output.error).toEqual([\n-        [jasmine.any(Error)]\n-      ]);\n-      expect(logger.output.error[0][0].message).toEqual(`Document file not found at 'missing/Doc-1'`);\n-\n-      // Subsequent request for not-found document.\n-      logger.output.error = [];\n-      httpMock.expectOne(CONTENT_URL_PREFIX + 'file-not-found.json').flush(notFoundDoc);\n-      expect(logger.output.error).toEqual([]); // does not report repeated errors\n-      expect(currentDocument).toEqual(notFoundDoc);\n+    it('should encode the request path to be case-insensitive', () => {\n+      const { docService, locationService } = getServices('initial/Doc');\n+      docService.currentDocument.subscribe();\n+      httpMock.expectOne(CONTENT_URL_PREFIX + 'initial/d_oc.json').flush({});\n+      locationService.go('NEW/Doc');\n+      httpMock.expectOne(CONTENT_URL_PREFIX + 'n_e_w_/d_oc.json').flush({});\n+      locationService.go('doc_with_underscores');\n+      httpMock.expectOne(CONTENT_URL_PREFIX + 'doc__with__underscores.json').flush({});\n+      locationService.go('DOC_WITH_UNDERSCORES');\n+      httpMock.expectOne(CONTENT_URL_PREFIX + 'd_o_c___w_i_t_h___u_n_d_e_r_s_c_o_r_e_s_.json').flush({});\n     });\n-    // END HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n \n     it('should emit the not-found document if the document is not found on the server', () => {\n       let currentDocument: DocumentContents|undefined;\n@@ -119,7 +107,7 @@ describe('DocumentService', () => {\n \n       docService.currentDocument.subscribe(doc => currentDocument = doc);\n \n-      httpMock.expectOne({}).flush(null, { status: 404, statusText: 'NOT FOUND'});\n+      httpMock.expectOne({}).flush(null, {status: 404, statusText: 'NOT FOUND'});\n       expect(currentDocument).toEqual(hardCodedNotFoundDoc);\n \n       // now check that we haven't killed the currentDocument observable sequence\n@@ -143,7 +131,7 @@ describe('DocumentService', () => {\n         [jasmine.any(Error)]\n       ]);\n       expect(logger.output.error[0][0].message)\n-          .toEqual(`Error fetching document 'initial/doc': (Http failure response for generated/docs/initial/doc.json: 500 Server Error)`);\n+        .toEqual(`Error fetching document 'initial/doc': (Http failure response for generated/docs/initial/doc.json: 500 Server Error)`);\n \n       locationService.go('new/doc');\n       httpMock.expectOne({}).flush(doc1);"
        },
        {
            "sha": "73ab9a0ec3e12d701cdf6544e643c18b1261507f",
            "filename": "aio/src/app/documents/document.service.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 31,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.ts",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fdocuments%2Fdocument.service.ts?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -1,7 +1,7 @@\n import { Injectable } from '@angular/core';\n import { HttpClient, HttpErrorResponse } from '@angular/common/http';\n \n-import { AsyncSubject, Observable, of, throwError } from 'rxjs';\n+import { AsyncSubject, Observable, of } from 'rxjs';\n import { catchError, switchMap, tap } from 'rxjs/operators';\n \n import { DocumentContents } from './document-contents';\n@@ -53,7 +53,7 @@ export class DocumentService {\n   }\n \n   private fetchDocument(id: string): Observable<DocumentContents> {\n-    const requestPath = `${DOC_CONTENT_URL_PREFIX}${id}.json`;\n+    const requestPath = `${DOC_CONTENT_URL_PREFIX}${encodeToLowercase(id)}.json`;\n     const subject = new AsyncSubject<DocumentContents>();\n \n     this.logger.log('fetching document from', requestPath);\n@@ -66,20 +66,6 @@ export class DocumentService {\n             throw Error('Invalid data');\n           }\n         }),\n-        // HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n-        catchError((error: HttpErrorResponse) => {\n-          const encodedPath = encodeToLowercase(requestPath);\n-          return error.status === 404 && encodedPath !== requestPath ?\n-              this.http.get<DocumentContents>(encodedPath) :\n-              throwError(error);\n-        }),\n-        catchError((error: HttpErrorResponse) => {\n-          const disambiguatedPath = convertDisambiguatedPath(requestPath);\n-          return error.status === 404 && disambiguatedPath !== requestPath ?\n-              this.http.get<DocumentContents>(disambiguatedPath) :\n-              throwError(error);\n-        }),\n-        // END HACK: PREPARE FOR CHANGING TO CASE-INSENSITIVE URLS\n         catchError((error: HttpErrorResponse) => {\n           return error.status === 404 ? this.getFileNotFoundDoc(id) : this.getErrorDoc(id, error);\n         }),\n@@ -123,18 +109,3 @@ export class DocumentService {\n function encodeToLowercase(str: string): string {\n   return str.replace(/[A-Z_]/g, char => char.toLowerCase() + '_');\n }\n-\n-/**\n- * A temporary function to deal with a future change to URL disambiguation.\n- *\n- * Currently there are disambiguated URLs such as `INJECTOR-0` and `Injector-1`, which\n- * will attempt to load their document contents from `injector-0.json` and `injector-1.json`\n- * respectively. In a future version of the AIO app, the disambiguation will be changed to\n- * escape the upper-case characters instead.\n- *\n- * This function will be called if the current AIO is trying to request documents from a\n- * server that has been updated to use the new disambiguated URLs.\n- */\n-function convertDisambiguatedPath(str: string): string {\n-  return encodeToLowercase(str.replace(/-\\d+\\.json$/, '.json'));\n-}"
        },
        {
            "sha": "2d58484fc6c606b49a7266d057e01bbf39981acd",
            "filename": "aio/tests/deployment/e2e/smoke-tests.e2e-spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftests%2Fdeployment%2Fe2e%2Fsmoke-tests.e2e-spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftests%2Fdeployment%2Fe2e%2Fsmoke-tests.e2e-spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Fe2e%2Fsmoke-tests.e2e-spec.ts?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -62,7 +62,7 @@ describe(browser.baseUrl, () => {\n \n     describe('(api docs pages)', () => {\n       const textPerUrl: { [key: string]: string } = {\n-        /* Class */ 'api/core/Injector-0': 'class injector',\n+        /* Class */ 'api/core/Injector': 'class injector',\n         /* Const */ 'api/forms/NG_VALIDATORS': 'const ng_validators',\n         /* Decorator */ 'api/core/Component': '@component',\n         /* Directive */ 'api/common/NgIf': 'class ngif',"
        },
        {
            "sha": "5c0f4a595df67f2c590cad015d5218ed95572116",
            "filename": "aio/tools/transforms/angular-base-package/processors/disambiguateDocPaths.js",
            "status": "modified",
            "additions": 13,
            "deletions": 38,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.js",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.js?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -2,7 +2,7 @@\n  * @dgProcessor disambiguateDocPathsProcessor\n  * @description\n  *\n- * Ensures that docs that have the same path, other than case changes,\n+ * Ensures that docs that have the same output path, other than case changes,\n  * are disambiguated.\n  *\n  * For example in Angular there is the `ROUTES` const and a `Routes` type.\n@@ -14,55 +14,30 @@\n  * ```\n  *\n  * but in a case-insensitive file-system these two paths point to the same file!\n+ *\n+ * So this processor will encode the paths into lower case that is not affected\n+ * by case-insensitive file-systems.\n  */\n-module.exports = function disambiguateDocPathsProcessor(log) {\n+module.exports = function disambiguateDocPathsProcessor() {\n   return {\n     $runAfter: ['paths-computed'],\n     $runBefore: ['rendering-docs', 'createSitemap'],\n     $process(docs) {\n-      // Collect all the ambiguous docs, whose outputPath is are only different by casing.\n-      const ambiguousDocMap = new Map();\n       for (const doc of docs) {\n         if (!doc.outputPath) {\n           continue;\n         }\n-        const outputPath = doc.outputPath.toLowerCase();\n-        if (!ambiguousDocMap.has(outputPath)) {\n-          ambiguousDocMap.set(outputPath, []);\n-        }\n-        const ambiguousDocs = ambiguousDocMap.get(outputPath);\n-        ambiguousDocs.push(doc);\n-      }\n-\n-      // Create a disambiguator doc for each set of such ambiguous docs,\n-      // and update the ambiguous docs to have unique `path` and `outputPath` properties.\n-      for (const [outputPath, ambiguousDocs] of ambiguousDocMap) {\n-        if (ambiguousDocs.length === 1) {\n-          continue;\n-        }\n-\n-        log.debug('Docs with ambiguous outputPath:' + ambiguousDocs.map((d, i) => `\\n - ${d.id}: \"${d.outputPath}\" replaced with \"${convertPath(d.outputPath, i)}\".`));\n-\n-        const doc = ambiguousDocs[0];\n-        const path = doc.path;\n-        const id = `${doc.id.toLowerCase()}-disambiguator`;\n-        const title = `${doc.id.toLowerCase()} (disambiguation)`;\n-        const aliases = [id];\n-        docs.push({ docType: 'disambiguator', id, title, aliases, path, outputPath, docs: ambiguousDocs });\n-\n-        // Update the paths\n-        let count = 0;\n-        for (const doc of ambiguousDocs) {\n-          doc.path = convertPath(doc.path, count);\n-          doc.outputPath = convertPath(doc.outputPath, count);\n-          count += 1;\n-        }\n+        doc.outputPath = encodeToLowercase(doc.outputPath);\n       }\n     }\n   };\n };\n \n-function convertPath(path, count) {\n-  // Add the counter before any extension\n-  return path.replace(/(\\.[^.]*)?$/, `-${count}$1`);\n+/**\n+ * To avoid collisions on case-insensitive file-systems, we encode the path to the content in\n+ * a deterministic case-insensitive form - converting all uppercase letters to lowercase followed\n+ * by an underscore.\n+ */\n+function encodeToLowercase(str) {\n+  return str.replace(/[A-Z_]/g, char => char.toLowerCase() + '_');\n }"
        },
        {
            "sha": "45691df274d1f694c1e4312bbb41b2119835ebd4",
            "filename": "aio/tools/transforms/angular-base-package/processors/disambiguateDocPaths.spec.js",
            "status": "modified",
            "additions": 24,
            "deletions": 43,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.spec.js?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -9,12 +9,14 @@ describe('disambiguateDocPaths processor', () => {\n     injector = dgeni.configureInjector();\n     processor = injector.get('disambiguateDocPathsProcessor');\n     docs = [\n-      {docType: 'test-doc', id: 'test-doc', path: 'test/doc', outputPath: 'test/doc.json'},\n-      {docType: 'test-doc', id: 'TEST-DOC', path: 'TEST/DOC', outputPath: 'TEST/DOC.json'},\n-      {docType: 'test-doc', id: 'test-Doc', path: 'test/Doc', outputPath: 'test/Doc.xml'},\n-      {docType: 'test-doc', id: 'unique-doc', path: 'unique/doc', outputPath: 'unique/doc.json'},\n-      {docType: 'test-doc', id: 'other-doc', path: 'other/doc', outputPath: 'other/doc.json'},\n-      {docType: 'test-doc', id: 'other-DOC', path: 'other/DOC', outputPath: 'other/DOC.json'},\n+      { docType: 'test-doc', id: 'test-doc', path: 'test/doc', outputPath: 'test/doc.json' },\n+      { docType: 'test-doc', id: 'TEST-DOC', path: 'TEST/DOC', outputPath: 'TEST/DOC.json' },\n+      { docType: 'test-doc', id: 'test-Doc', path: 'test/Doc', outputPath: 'test/Doc.xml' },\n+      { docType: 'test-doc', id: 'unique-doc', path: 'unique/doc', outputPath: 'unique/doc.json' },\n+      { docType: 'test-doc', id: 'other-doc', path: 'other/doc', outputPath: 'other/doc.json' },\n+      { docType: 'test-doc', id: 'other-DOC', path: 'other/DOC', outputPath: 'other/DOC.json' },\n+      { docType: 'test-doc', id: 'has_underscore', path: 'has_underscore', outputPath: 'has_underscore.json' },\n+      { docType: 'test-doc', id: 'HAS_UNDERSCORE', path: 'HAS_UNDERSCORE', outputPath: 'HAS_UNDERSCORE.json' },\n     ];\n   });\n \n@@ -26,44 +28,23 @@ describe('disambiguateDocPaths processor', () => {\n     expect(processor.$runBefore).toContain('createSitemap');\n   });\n \n-  it('should create `disambiguator` documents for docs that have ambiguous outputPaths', () => {\n-    const numDocs = docs.length;\n+  it('should update the path and outputPath properties of each doc to be unambiguous on case-insensitive file-systems', () => {\n     processor.$process(docs);\n-    expect(docs.length).toEqual(numDocs + 2);\n-    expect(docs[docs.length - 2]).toEqual({\n-      docType: 'disambiguator',\n-      id: 'test-doc-disambiguator',\n-      title: 'test-doc (disambiguation)',\n-      aliases: ['test-doc-disambiguator'],\n-      path: 'test/doc',\n-      outputPath: 'test/doc.json',\n-      docs: [docs[0], docs[1]],\n-    });\n-    expect(docs[docs.length - 1]).toEqual({\n-      docType: 'disambiguator',\n-      id: 'other-doc-disambiguator',\n-      title: 'other-doc (disambiguation)',\n-      aliases: ['other-doc-disambiguator'],\n-      path: 'other/doc',\n-      outputPath: 'other/doc.json',\n-      docs: [docs[4], docs[5]],\n-    });\n-  });\n-\n-  it('should update the path and outputPath properties of each ambiguous doc', () => {\n-    processor.$process(docs);\n-    expect(docs[0].path).toEqual('test/doc-0');\n-    expect(docs[0].outputPath).toEqual('test/doc-0.json');\n-    expect(docs[1].path).toEqual('TEST/DOC-1');\n-    expect(docs[1].outputPath).toEqual('TEST/DOC-1.json');\n-\n-    // The non-ambiguous docs are left alone\n-    expect(docs[2].outputPath).toEqual('test/Doc.xml');\n+    expect(docs[0].path).toEqual('test/doc');\n+    expect(docs[0].outputPath).toEqual('test/doc.json');\n+    expect(docs[1].path).toEqual('TEST/DOC');\n+    expect(docs[1].outputPath).toEqual('t_e_s_t_/d_o_c_.json');\n+    expect(docs[2].path).toEqual('test/Doc');\n+    expect(docs[2].outputPath).toEqual('test/d_oc.xml');\n+    expect(docs[3].path).toEqual('unique/doc');\n     expect(docs[3].outputPath).toEqual('unique/doc.json');\n-\n-    expect(docs[4].path).toEqual('other/doc-0');\n-    expect(docs[4].outputPath).toEqual('other/doc-0.json');\n-    expect(docs[5].path).toEqual('other/DOC-1');\n-    expect(docs[5].outputPath).toEqual('other/DOC-1.json');\n+    expect(docs[4].path).toEqual('other/doc');\n+    expect(docs[4].outputPath).toEqual('other/doc.json');\n+    expect(docs[5].path).toEqual('other/DOC');\n+    expect(docs[5].outputPath).toEqual('other/d_o_c_.json');\n+    expect(docs[6].path).toEqual('has_underscore');\n+    expect(docs[6].outputPath).toEqual('has__underscore.json');\n+    expect(docs[7].path).toEqual('HAS_UNDERSCORE');\n+    expect(docs[7].outputPath).toEqual('h_a_s___u_n_d_e_r_s_c_o_r_e_.json');\n   });\n });"
        },
        {
            "sha": "525ea7a702b7a52d476dffb001e86b207e4ea1a1",
            "filename": "aio/tools/transforms/authors-package/index.spec.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftools%2Ftransforms%2Fauthors-package%2Findex.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/aio%2Ftools%2Ftransforms%2Fauthors-package%2Findex.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fauthors-package%2Findex.spec.js?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -71,14 +71,14 @@ describe('authors-package (integration tests)', () => {\n   it('should generate API doc if the \"fileChanged\" is an API doc', () => {\n     return generateDocs('packages/forms/src/form_builder.ts', { silent: true }).then(() => {\n       expect(fs.writeFile).toHaveBeenCalled();\n-      expect(files).toContain(resolve(DOCS_OUTPUT_PATH, 'api/forms/FormBuilder.json'));\n+      expect(files).toContain(resolve(DOCS_OUTPUT_PATH, 'api/forms/f_ormb_uilder.json'));\n     });\n   }, 16000);\n \n   it('should generate API doc if the \"fileChanged\" is an API example', () => {\n     return generateDocs('packages/examples/forms/ts/formBuilder/form_builder_example.ts', { silent: true }).then(() => {\n       expect(fs.writeFile).toHaveBeenCalled();\n-      expect(files).toContain(resolve(DOCS_OUTPUT_PATH, 'api/forms/FormBuilder.json'));\n+      expect(files).toContain(resolve(DOCS_OUTPUT_PATH, 'api/forms/f_ormb_uilder.json'));\n     });\n   }, 16000);\n });"
        },
        {
            "sha": "53b1d231a847c262148d3d093e4d516a4e842947",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b0592c1be6a65c5074a4a0967075b28b8e054b54/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/b0592c1be6a65c5074a4a0967075b28b8e054b54/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=b0592c1be6a65c5074a4a0967075b28b8e054b54",
            "patch": "@@ -3,7 +3,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2017\": 4619,\n-        \"main-es2017\": 456795,\n+        \"main-es2017\": 456578,\n         \"polyfills-es2017\": 55210\n       }\n     }"
        }
    ],
    "stats": {
        "total": 195,
        "additions": 55,
        "deletions": 140
    }
}