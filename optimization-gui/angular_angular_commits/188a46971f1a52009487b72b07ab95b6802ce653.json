{
    "author": "uraj",
    "message": "build: Use aspects to gather srcs and deps for tsec_test. (#43108)\n\nThis is to replace the implicitly created ts_library_forwared rules and\nkeep changes related to tsec/bazel integration solely in tools/tsec.bzl.\n\nPR Close #43108",
    "sha": "188a46971f1a52009487b72b07ab95b6802ce653",
    "files": [
        {
            "sha": "b0549c382a5999e241bed8baf3e48831eb5173ce",
            "filename": "tools/defaults.bzl",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/188a46971f1a52009487b72b07ab95b6802ce653/tools%2Fdefaults.bzl",
            "raw_url": "https://github.com/angular/angular/raw/188a46971f1a52009487b72b07ab95b6802ce653/tools%2Fdefaults.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fdefaults.bzl?ref=188a46971f1a52009487b72b07ab95b6802ce653",
            "patch": "@@ -12,7 +12,6 @@ load(\"@npm//typescript:index.bzl\", \"tsc\")\n load(\"//packages/bazel:index.bzl\", _ng_module = \"ng_module\", _ng_package = \"ng_package\")\n load(\"@npm//@angular/dev-infra-private/bazel/benchmark/ng_rollup_bundle:ng_rollup_bundle.bzl\", _ng_rollup_bundle = \"ng_rollup_bundle\")\n load(\"//tools:ng_benchmark.bzl\", _ng_benchmark = \"ng_benchmark\")\n-load(\"//tools:tsec.bzl\", _get_forwarded_target_name = \"get_forwarded_target_name\", _ts_library_forwarded = \"ts_library_forwarded\")\n load(\"@npm//@angular/dev-infra-private/bazel/api-golden:index.bzl\", _api_golden_test = \"api_golden_test\", _api_golden_test_npm_package = \"api_golden_test_npm_package\")\n load(\"@npm//@angular/dev-infra-private/bazel:extract_js_module_output.bzl\", \"extract_js_module_output\")\n \n@@ -129,16 +128,6 @@ def ts_library(name, tsconfig = None, testonly = False, deps = [], module_name =\n         **kwargs\n     )\n \n-    # Forward `srcs` and `deps` to an implicitly create rule so that\n-    # `tsec_test` can get those arguments from its `target` argument.\n-    _ts_library_forwarded(\n-        name = _get_forwarded_target_name(name),\n-        testonly = True,\n-        srcs = kwargs.get(\"srcs\", []),\n-        deps = deps,\n-        tags = [\"tsec\"],\n-    )\n-\n     # Select the es5 .js output of the ts_library for use in downstream boostrap targets\n     # with `output_group = \"es5_sources\"`. This exposes an internal detail of ts_library\n     # that is not ideal.\n@@ -192,16 +181,6 @@ def ng_module(name, tsconfig = None, entry_point = None, testonly = False, deps\n         **kwargs\n     )\n \n-    # Forward `srcs` and `deps` to an implicitly create rule so that\n-    # `tsec_test` can get those arguments from its `target` argument.\n-    _ts_library_forwarded(\n-        name = _get_forwarded_target_name(name),\n-        testonly = True,\n-        srcs = kwargs.get(\"srcs\", []),\n-        deps = deps,\n-        tags = [\"tsec\"],\n-    )\n-\n def ng_package(name, readme_md = None, license_banner = None, deps = [], **kwargs):\n     \"\"\"Default values for ng_package\"\"\"\n     if not readme_md:"
        },
        {
            "sha": "a4c36212e0c38956baeca1b3cd655252498a5ef0",
            "filename": "tools/tsec.bzl",
            "status": "modified",
            "additions": 9,
            "deletions": 19,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/188a46971f1a52009487b72b07ab95b6802ce653/tools%2Ftsec.bzl",
            "raw_url": "https://github.com/angular/angular/raw/188a46971f1a52009487b72b07ab95b6802ce653/tools%2Ftsec.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Ftsec.bzl?ref=188a46971f1a52009487b72b07ab95b6802ce653",
            "patch": "@@ -60,24 +60,14 @@ tsec_config = rule(\n \n TsLibInfo = provider(fields = [\"srcs\", \"deps\"])\n \n-def _ts_library_forwarded_impl(ctx):\n+def _capture_tsec_deps_aspect_impl(target, ctx):\n     \"\"\"Forward `srcs` and `deps` of `ts_library` and `ng_module` macros to `_tsec_test`.\"\"\"\n-    return [TsLibInfo(srcs = ctx.attr.srcs, deps = ctx.attr.deps)]\n+    return [TsLibInfo(srcs = ctx.rule.attr.srcs, deps = ctx.rule.attr.deps)]\n \n-ts_library_forwarded = rule(\n-    implementation = _ts_library_forwarded_impl,\n-    attrs = {\n-        \"srcs\": attr.label_list(allow_files = [\".ts\", \".tsx\"]),\n-        \"deps\": attr.label_list(),\n-    },\n-    doc = \"\"\"A rule-in-the-middle to forward `srcs` and `deps` to _src_and_deps, to avoid repeating these arguments in tsec_test.\n-\n-Should only be used by the `ts_library` and `ng_module` macros in tools/default.bzel.\"\"\",\n+_capture_tsec_deps_aspect = aspect(\n+    implementation = _capture_tsec_deps_aspect_impl,\n )\n \n-def get_forwarded_target_name(name):\n-    return \"%s_forwarded\" % name\n-\n def _all_transitive_deps_impl(ctx):\n     files = []\n \n@@ -90,10 +80,10 @@ def _all_transitive_deps_impl(ctx):\n         files.append(tsec_tsconfig_info.exemption)\n     files.extend(tsec_tsconfig_info.deps)\n \n-    if TsLibInfo not in ctx.attr.forwarded_ts_target:\n-        fail(\"`target` must be a ts_library_forwarded target\")\n+    if TsLibInfo not in ctx.attr.ts_target:\n+        fail(\"`target` must be a ts_library or ng_module target\")\n \n-    ts_target_info = ctx.attr.forwarded_ts_target[TsLibInfo]\n+    ts_target_info = ctx.attr.ts_target[TsLibInfo]\n     for s in ts_target_info.srcs:\n         if hasattr(s, \"files\"):\n             files.extend(s.files.to_list())\n@@ -110,7 +100,7 @@ _all_transitive_deps = rule(\n     implementation = _all_transitive_deps_impl,\n     attrs = {\n         \"tsconfig\": attr.label(),\n-        \"forwarded_ts_target\": attr.label(),\n+        \"ts_target\": attr.label(aspects = [_capture_tsec_deps_aspect]),\n     },\n     doc = \"\"\"Expand all transitive dependencies needed to run `_tsec_test`.\"\"\",\n )\n@@ -131,7 +121,7 @@ def tsec_test(name, target, tsconfig):\n         name = all_transitive_deps_name,\n         testonly = True,\n         tsconfig = tsconfig,\n-        forwarded_ts_target = get_forwarded_target_name(target),\n+        ts_target = target,\n         tags = [\"tsec\"],\n     )\n "
        }
    ],
    "stats": {
        "total": 49,
        "additions": 9,
        "deletions": 40
    }
}