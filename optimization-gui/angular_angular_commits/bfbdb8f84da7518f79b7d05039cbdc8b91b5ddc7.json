{
    "author": "JoostK",
    "message": "refactor(compiler-cli): cleanup redundant storage of reuse `ts.Program` (#41289)\n\nIn the compiler, the `NgtscProgram` is responsible for creating the\n`ts.Program` instance to use, potentially using a `ts.Program` from a\nprior compilation to enable incremental compilation. It used to track\na `reuseTsProgram` for this purpose, however the `ts.Program` that\nshould be used as reuse program is also tracked by the `NgCompiler`\ninstance that is used by `NgtscProgram`. The `NgtscProgram` can leverage\nthe state from `NgCompiler` instead of keeping track of it by itself.\n\nPR Close #41289",
    "sha": "bfbdb8f84da7518f79b7d05039cbdc8b91b5ddc7",
    "files": [
        {
            "sha": "356cbc8451b60f250e04ee612f168058c173eb31",
            "filename": "packages/compiler-cli/src/ngtsc/program.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 22,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/bfbdb8f84da7518f79b7d05039cbdc8b91b5ddc7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/bfbdb8f84da7518f79b7d05039cbdc8b91b5ddc7/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts?ref=bfbdb8f84da7518f79b7d05039cbdc8b91b5ddc7",
            "patch": "@@ -38,20 +38,6 @@ export class NgtscProgram implements api.Program {\n    */\n   private tsProgram: ts.Program;\n \n-  /**\n-   * The TypeScript program to use for the next incremental compilation.\n-   *\n-   * Once a TS program is used to create another (an incremental compilation operation), it can no\n-   * longer be used to do so again.\n-   *\n-   * Since template type-checking uses the primary program to create a type-checking program, after\n-   * this happens the primary program is no longer suitable for starting a subsequent compilation,\n-   * and the template type-checking program should be used instead.\n-   *\n-   * Thus, the program which should be used for the next incremental compilation is tracked in\n-   * `reuseTsProgram`, separately from the \"primary\" program which is always used for emit.\n-   */\n-  private reuseTsProgram: ts.Program;\n   private closureCompilerEnabled: boolean;\n   private host: NgCompilerHost;\n   private incrementalStrategy: TrackedIncrementalBuildStrategy;\n@@ -70,7 +56,7 @@ export class NgtscProgram implements api.Program {\n \n     this.closureCompilerEnabled = !!options.annotateForClosureCompiler;\n \n-    const reuseProgram = oldProgram?.reuseTsProgram;\n+    const reuseProgram = oldProgram?.compiler.getCurrentProgram();\n     this.host = NgCompilerHost.wrap(delegateHost, rootNames, options, reuseProgram ?? null);\n \n     if (reuseProgram !== undefined) {\n@@ -84,7 +70,6 @@ export class NgtscProgram implements api.Program {\n     this.tsProgram = perfRecorder.inPhase(\n         PerfPhase.TypeScriptProgramCreate,\n         () => ts.createProgram(this.host.inputFiles, options, this.host, reuseProgram));\n-    this.reuseTsProgram = this.tsProgram;\n \n     perfRecorder.phase(PerfPhase.Unaccounted);\n     perfRecorder.memory(PerfCheckpoint.TypeScriptProgramCreate);\n@@ -137,7 +122,7 @@ export class NgtscProgram implements api.Program {\n   }\n \n   getReuseTsProgram(): ts.Program {\n-    return this.reuseTsProgram;\n+    return this.compiler.getCurrentProgram();\n   }\n \n   getTsOptionDiagnostics(cancellationToken?: ts.CancellationToken|\n@@ -220,11 +205,11 @@ export class NgtscProgram implements api.Program {\n       }\n     }\n \n-    const diagnostics = sf === undefined ?\n-        this.compiler.getDiagnostics() :\n-        this.compiler.getDiagnosticsForFile(sf, OptimizeFor.WholeProgram);\n-    this.reuseTsProgram = this.compiler.getCurrentProgram();\n-    return diagnostics;\n+    if (sf === undefined) {\n+      return this.compiler.getDiagnostics();\n+    } else {\n+      return this.compiler.getDiagnosticsForFile(sf, OptimizeFor.WholeProgram);\n+    }\n   }\n \n   /**"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 7,
        "deletions": 22
    }
}