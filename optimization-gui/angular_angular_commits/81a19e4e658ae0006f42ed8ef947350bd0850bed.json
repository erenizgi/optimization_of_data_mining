{
    "author": "josephperrott",
    "message": "feat(dev-infra): update pullapprove verification to ensure all groups have reviewers (#42614)\n\nUpdate the pullapprove verification tooling to ensure a reviewer is defined for\neach group. This is being done in preparation for the upcoming change to how\npullapprove billing works. The new billing will work on a seats based approach\nrather than flat usage.\n\nPR Close #42614",
    "sha": "81a19e4e658ae0006f42ed8ef947350bd0850bed",
    "files": [
        {
            "sha": "127ea81814ceb0f54dbcb9bec65c1c2658548a95",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/angular/angular/blob/81a19e4e658ae0006f42ed8ef947350bd0850bed/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/81a19e4e658ae0006f42ed8ef947350bd0850bed/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=81a19e4e658ae0006f42ed8ef947350bd0850bed",
            "patch": "@@ -4917,11 +4917,13 @@ const FALLBACK_GROUP_NAME = 'fallback';\n /** A PullApprove group to be able to test files against. */\n class PullApproveGroup {\n     constructor(groupName, config, precedingGroups = []) {\n+        var _a;\n         this.groupName = groupName;\n         this.precedingGroups = precedingGroups;\n         /** List of conditions for the group. */\n         this.conditions = [];\n         this._captureConditions(config);\n+        this.reviewers = (_a = config.reviewers) !== null && _a !== void 0 ? _a : { users: [], teams: [] };\n     }\n     _captureConditions(config) {\n         if (config.conditions && this.groupName !== FALLBACK_GROUP_NAME) {\n@@ -5063,12 +5065,16 @@ function verify$1() {\n      * Whether all group condition lines match at least one file and all files\n      * are matched by at least one group.\n      */\n-    const verificationSucceeded = resultsByGroup.every(r => !r.unmatchedCount) && !unmatchedFiles.length;\n+    const allGroupConditionsValid = resultsByGroup.every(r => !r.unmatchedCount) && !unmatchedFiles.length;\n+    /** Whether all groups have at least one reviewer user or team defined.  */\n+    const groupsWithoutReviewers = groups.filter(group => Object.keys(group.reviewers).length === 0);\n+    /** The overall result of the verifcation. */\n+    const overallResult = allGroupConditionsValid && groupsWithoutReviewers.length === 0;\n     /**\n      * Overall result\n      */\n     logHeader('Overall Result');\n-    if (verificationSucceeded) {\n+    if (overallResult) {\n         info('PullApprove verification succeeded!');\n     }\n     else {\n@@ -5078,6 +5084,16 @@ function verify$1() {\n         info(`files/directories have owners and all patterns that appear in`);\n         info(`the file correspond to actual files/directories in the repo.`);\n     }\n+    /** Reviewers check */\n+    logHeader(`Group Reviewers Check`);\n+    if (groupsWithoutReviewers.length === 0) {\n+        info('All group contain at least one reviewer user or team.');\n+    }\n+    else {\n+        info.group(`Discovered ${groupsWithoutReviewers.length} group(s) without a reviewer defined`);\n+        groupsWithoutReviewers.forEach(g => info(g.groupName));\n+        info.groupEnd();\n+    }\n     /**\n      * File by file Summary\n      */\n@@ -5108,7 +5124,7 @@ function verify$1() {\n     unverifiableConditionsInGroups.forEach(group => logGroup(group, 'unverifiableConditions'));\n     info.groupEnd();\n     // Provide correct exit code based on verification success.\n-    process.exit(verificationSucceeded ? 0 : 1);\n+    process.exit(overallResult ? 0 : 1);\n }\n \n /** Build the parser for the pullapprove commands. */"
        },
        {
            "sha": "ec135d52a9cf1aa7a75bdcd81bee26be5c639712",
            "filename": "dev-infra/pullapprove/group.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/81a19e4e658ae0006f42ed8ef947350bd0850bed/dev-infra%2Fpullapprove%2Fgroup.ts",
            "raw_url": "https://github.com/angular/angular/raw/81a19e4e658ae0006f42ed8ef947350bd0850bed/dev-infra%2Fpullapprove%2Fgroup.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpullapprove%2Fgroup.ts?ref=81a19e4e658ae0006f42ed8ef947350bd0850bed",
            "patch": "@@ -19,6 +19,11 @@ interface GroupCondition {\n   unverifiable: boolean;\n }\n \n+interface GroupReviewers {\n+  users?: string[];\n+  teams?: string[];\n+}\n+\n /** Result of testing files against the group. */\n export interface PullApproveGroupResult {\n   groupName: string;\n@@ -40,12 +45,15 @@ const FALLBACK_GROUP_NAME = 'fallback';\n /** A PullApprove group to be able to test files against. */\n export class PullApproveGroup {\n   /** List of conditions for the group. */\n-  conditions: GroupCondition[] = [];\n+  readonly conditions: GroupCondition[] = [];\n+  /** List of reviewers for the group. */\n+  readonly reviewers: GroupReviewers;\n \n   constructor(\n       public groupName: string, config: PullApproveGroupConfig,\n       readonly precedingGroups: PullApproveGroup[] = []) {\n     this._captureConditions(config);\n+    this.reviewers = config.reviewers ?? {users: [], teams: []};\n   }\n \n   private _captureConditions(config: PullApproveGroupConfig) {"
        },
        {
            "sha": "93bfe9948ec2c156e6b58d94391ca86550d86fa4",
            "filename": "dev-infra/pullapprove/verify.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/81a19e4e658ae0006f42ed8ef947350bd0850bed/dev-infra%2Fpullapprove%2Fverify.ts",
            "raw_url": "https://github.com/angular/angular/raw/81a19e4e658ae0006f42ed8ef947350bd0850bed/dev-infra%2Fpullapprove%2Fverify.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpullapprove%2Fverify.ts?ref=81a19e4e658ae0006f42ed8ef947350bd0850bed",
            "patch": "@@ -49,14 +49,18 @@ export function verify() {\n    * Whether all group condition lines match at least one file and all files\n    * are matched by at least one group.\n    */\n-  const verificationSucceeded =\n+  const allGroupConditionsValid =\n       resultsByGroup.every(r => !r.unmatchedCount) && !unmatchedFiles.length;\n+  /** Whether all groups have at least one reviewer user or team defined.  */\n+  const groupsWithoutReviewers = groups.filter(group => Object.keys(group.reviewers).length === 0);\n+  /** The overall result of the verifcation. */\n+  const overallResult = allGroupConditionsValid && groupsWithoutReviewers.length === 0;\n \n   /**\n    * Overall result\n    */\n   logHeader('Overall Result');\n-  if (verificationSucceeded) {\n+  if (overallResult) {\n     info('PullApprove verification succeeded!');\n   } else {\n     info(`PullApprove verification failed.`);\n@@ -65,6 +69,15 @@ export function verify() {\n     info(`files/directories have owners and all patterns that appear in`);\n     info(`the file correspond to actual files/directories in the repo.`);\n   }\n+  /** Reviewers check */\n+  logHeader(`Group Reviewers Check`);\n+  if (groupsWithoutReviewers.length === 0) {\n+    info('All group contain at least one reviewer user or team.');\n+  } else {\n+    info.group(`Discovered ${groupsWithoutReviewers.length} group(s) without a reviewer defined`);\n+    groupsWithoutReviewers.forEach(g => info(g.groupName));\n+    info.groupEnd();\n+  }\n   /**\n    * File by file Summary\n    */\n@@ -97,5 +110,5 @@ export function verify() {\n   info.groupEnd();\n \n   // Provide correct exit code based on verification success.\n-  process.exit(verificationSucceeded ? 0 : 1);\n+  process.exit(overallResult ? 0 : 1);\n }"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 44,
        "deletions": 7
    }
}