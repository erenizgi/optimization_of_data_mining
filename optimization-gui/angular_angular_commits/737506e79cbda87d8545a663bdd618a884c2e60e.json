{
    "author": "mhevery",
    "message": "fix(core): Allow modification of lifecycle hooks any time before bootstrap (#35464)\n\nCurrently we read lifecycle hooks eagerly during `ɵɵdefineComponent`.\nThe result is that it is not possible to do any sort of meta-programing\nsuch as mixins or adding lifecycle hooks using custom decorators since\nany such code executes after `ɵɵdefineComponent` has extracted the\nlifecycle hooks from the prototype. Additionally the behavior is\ninconsistent between AOT and JIT mode. In JIT mode overriding lifecycle\nhooks is possible because the whole `ɵɵdefineComponent` is placed in\ngetter which is executed lazily. This is because JIT mode must compile a\ntemplate which can be specified as `templateURL` and those we are\nwaiting for its resolution.\n\n- `+` `ɵɵdefineComponent` becomes smaller as it no longer needs to copy\n  lifecycle hooks from prototype to `ComponentDef`\n- `-` `ɵɵNgOnChangesFeature` feature is now always included with the\n  codebase as it is no longer tree shakable.\n\nPreviously we have read lifecycle hooks from prototype in the\n`ɵɵdefineComponent` so that lifecycle hook access would be monomorphic.\nThis decision was made before we had `T*` data structures. By not\nreading the lifecycle hooks we are moving the megamorhic read form\n`ɵɵdefineComponent` to instructions. However, the reads happen on\n`firstTemplatePass` only and are subsequently cached in the `T*` data\nstructures. The result is that the overall performance should be same\n(or slightly better as the intermediate `ComponentDef` has been\nremoved.)\n\n- [ ] Remove `ɵɵNgOnChangesFeature` from compiler. (It will no longer\n      be a feature.)\n- [ ] Discuss the future of `Features` as they hinder meta-programing.\n\nFix #30497\n\nPR Close #35464",
    "sha": "737506e79cbda87d8545a663bdd618a884c2e60e",
    "files": [
        {
            "sha": "dfb7c9cdf3aa53838339b23c55e03807a6e571f2",
            "filename": "goldens/public-api/core/core.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -894,7 +894,7 @@ export declare function ɵɵnextContext<T = any>(level?: number): T;\n \n export declare type ɵɵNgModuleDefWithMeta<T, Declarations, Imports, Exports> = ɵNgModuleDef<T>;\n \n-export declare function ɵɵNgOnChangesFeature<T>(definition: ɵDirectiveDef<T>): void;\n+export declare function ɵɵNgOnChangesFeature<T>(): DirectiveDefFeature;\n \n export declare function ɵɵpipe(index: number, pipeName: string): any;\n \n@@ -1056,7 +1056,7 @@ export declare function ɵɵstylePropInterpolateV(prop: string, values: any[], v\n \n export declare function ɵɵtemplate(index: number, templateFn: ComponentTemplate<any> | null, decls: number, vars: number, tagName?: string | null, attrsIndex?: number | null, localRefsIndex?: number | null, localRefExtractor?: LocalRefExtractor): void;\n \n-export declare function ɵɵtemplateRefExtractor(tNode: TNode, currentView: ɵangular_packages_core_core_bo): TemplateRef<unknown> | null;\n+export declare function ɵɵtemplateRefExtractor(tNode: TNode, currentView: ɵangular_packages_core_core_bp): TemplateRef<unknown> | null;\n \n export declare function ɵɵtext(index: number, value?: string): void;\n "
        },
        {
            "sha": "4dbcab337436e4ba51a2ad0a03aeb0ad832a5bc3",
            "filename": "goldens/size-tracking/aio-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/goldens%2Fsize-tracking%2Faio-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/goldens%2Fsize-tracking%2Faio-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Faio-payloads.json?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -12,7 +12,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 2987,\n-        \"main-es2015\": 450883,\n+        \"main-es2015\": 450301,\n         \"polyfills-es2015\": 52630\n       }\n     }\n@@ -26,4 +26,4 @@\n       }\n     }\n   }\n-}\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "6535e3d4b61182228aecabd8119132bf1f29bce8",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -12,16 +12,16 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n-        \"main-es2015\": 16959,\n-        \"polyfills-es2015\": 36938\n+        \"main-es2015\": 17362,\n+        \"polyfills-es2015\": 36657\n       }\n     }\n   },\n   \"cli-hello-world-ivy-compat\": {\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n-        \"main-es2015\": 147314,\n+        \"main-es2015\": 147573,\n         \"polyfills-es2015\": 36571\n       }\n     }\n@@ -30,7 +30,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n-        \"main-es2015\": 135533,\n+        \"main-es2015\": 136168,\n         \"polyfills-es2015\": 37248\n       }\n     }\n@@ -39,7 +39,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime-es2015\": 2289,\n-        \"main-es2015\": 246044,\n+        \"main-es2015\": 245351,\n         \"polyfills-es2015\": 36938,\n         \"5-es2015\": 751\n       }\n@@ -66,4 +66,4 @@\n       }\n     }\n   }\n-}\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "74fa4237b6e917fbfd26d9f9501f47c61bccc5f8",
            "filename": "packages/core/src/render3/definition.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 66,
            "changes": 125,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Fdefinition.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Fdefinition.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fdefinition.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -290,72 +290,65 @@ export function ɵɵdefineComponent<T>(componentDefinition: {\n   schemas?: SchemaMetadata[] | null;\n }): never {\n   return noSideEffects(() => {\n-    // Initialize ngDevMode. This must be the first statement in ɵɵdefineComponent.\n-    // See the `initNgDevMode` docstring for more information.\n-    (typeof ngDevMode === 'undefined' || ngDevMode) && initNgDevMode();\n-\n-    const type = componentDefinition.type;\n-    const typePrototype = type.prototype;\n-    const declaredInputs: {[key: string]: string} = {} as any;\n-    const def: Mutable<ComponentDef<any>, keyof ComponentDef<any>> = {\n-      type: type,\n-      providersResolver: null,\n-      decls: componentDefinition.decls,\n-      vars: componentDefinition.vars,\n-      factory: null,\n-      template: componentDefinition.template || null!,\n-      consts: componentDefinition.consts || null,\n-      ngContentSelectors: componentDefinition.ngContentSelectors,\n-      hostBindings: componentDefinition.hostBindings || null,\n-      hostVars: componentDefinition.hostVars || 0,\n-      hostAttrs: componentDefinition.hostAttrs || null,\n-      contentQueries: componentDefinition.contentQueries || null,\n-      declaredInputs: declaredInputs,\n-      inputs: null!,   // assigned in noSideEffects\n-      outputs: null!,  // assigned in noSideEffects\n-      exportAs: componentDefinition.exportAs || null,\n-      onChanges: null,\n-      onInit: typePrototype.ngOnInit || null,\n-      doCheck: typePrototype.ngDoCheck || null,\n-      afterContentInit: typePrototype.ngAfterContentInit || null,\n-      afterContentChecked: typePrototype.ngAfterContentChecked || null,\n-      afterViewInit: typePrototype.ngAfterViewInit || null,\n-      afterViewChecked: typePrototype.ngAfterViewChecked || null,\n-      onDestroy: typePrototype.ngOnDestroy || null,\n-      onPush: componentDefinition.changeDetection === ChangeDetectionStrategy.OnPush,\n-      directiveDefs: null!,  // assigned in noSideEffects\n-      pipeDefs: null!,       // assigned in noSideEffects\n-      selectors: componentDefinition.selectors || EMPTY_ARRAY,\n-      viewQuery: componentDefinition.viewQuery || null,\n-      features: componentDefinition.features as DirectiveDefFeature[] || null,\n-      data: componentDefinition.data || {},\n-      // TODO(misko): convert ViewEncapsulation into const enum so that it can be used directly in\n-      // the next line. Also `None` should be 0 not 2.\n-      encapsulation: componentDefinition.encapsulation || ViewEncapsulation.Emulated,\n-      id: 'c',\n-      styles: componentDefinition.styles || EMPTY_ARRAY,\n-      _: null as never,\n-      setInput: null,\n-      schemas: componentDefinition.schemas || null,\n-      tView: null,\n-    };\n-    const directiveTypes = componentDefinition.directives!;\n-    const feature = componentDefinition.features;\n-    const pipeTypes = componentDefinition.pipes!;\n-    def.id += _renderCompCount++;\n-    def.inputs = invertObject(componentDefinition.inputs, declaredInputs),\n-    def.outputs = invertObject(componentDefinition.outputs),\n-    feature && feature.forEach((fn) => fn(def));\n-    def.directiveDefs = directiveTypes ?\n-        () => (typeof directiveTypes === 'function' ? directiveTypes() : directiveTypes)\n-                  .map(extractDirectiveDef) :\n-        null;\n-    def.pipeDefs = pipeTypes ?\n-        () => (typeof pipeTypes === 'function' ? pipeTypes() : pipeTypes).map(extractPipeDef) :\n-        null;\n-\n-    return def as never;\n-  });\n+           // Initialize ngDevMode. This must be the first statement in ɵɵdefineComponent.\n+           // See the `initNgDevMode` docstring for more information.\n+           (typeof ngDevMode === 'undefined' || ngDevMode) && initNgDevMode();\n+\n+           const type = componentDefinition.type;\n+           const typePrototype = type.prototype;\n+           const declaredInputs: {[key: string]: string} = {} as any;\n+           const def: Mutable<ComponentDef<any>, keyof ComponentDef<any>> = {\n+             type: type,\n+             providersResolver: null,\n+             decls: componentDefinition.decls,\n+             vars: componentDefinition.vars,\n+             factory: null,\n+             template: componentDefinition.template || null!,\n+             consts: componentDefinition.consts || null,\n+             ngContentSelectors: componentDefinition.ngContentSelectors,\n+             hostBindings: componentDefinition.hostBindings || null,\n+             hostVars: componentDefinition.hostVars || 0,\n+             hostAttrs: componentDefinition.hostAttrs || null,\n+             contentQueries: componentDefinition.contentQueries || null,\n+             declaredInputs: declaredInputs,\n+             inputs: null!,   // assigned in noSideEffects\n+             outputs: null!,  // assigned in noSideEffects\n+             exportAs: componentDefinition.exportAs || null,\n+             onPush: componentDefinition.changeDetection === ChangeDetectionStrategy.OnPush,\n+             directiveDefs: null!,  // assigned in noSideEffects\n+             pipeDefs: null!,       // assigned in noSideEffects\n+             selectors: componentDefinition.selectors || EMPTY_ARRAY,\n+             viewQuery: componentDefinition.viewQuery || null,\n+             features: componentDefinition.features as DirectiveDefFeature[] || null,\n+             data: componentDefinition.data || {},\n+             // TODO(misko): convert ViewEncapsulation into const enum so that it can be used\n+             // directly in the next line. Also `None` should be 0 not 2.\n+             encapsulation: componentDefinition.encapsulation || ViewEncapsulation.Emulated,\n+             id: 'c',\n+             styles: componentDefinition.styles || EMPTY_ARRAY,\n+             _: null as never,\n+             setInput: null,\n+             schemas: componentDefinition.schemas || null,\n+             tView: null,\n+           };\n+           const directiveTypes = componentDefinition.directives!;\n+           const feature = componentDefinition.features;\n+           const pipeTypes = componentDefinition.pipes!;\n+           def.id += _renderCompCount++;\n+           def.inputs = invertObject(componentDefinition.inputs, declaredInputs),\n+           def.outputs = invertObject(componentDefinition.outputs),\n+           feature && feature.forEach((fn) => fn(def));\n+           def.directiveDefs = directiveTypes ?\n+               () => (typeof directiveTypes === 'function' ? directiveTypes() : directiveTypes)\n+                         .map(extractDirectiveDef) :\n+               null;\n+           def.pipeDefs = pipeTypes ?\n+               () =>\n+                   (typeof pipeTypes === 'function' ? pipeTypes() : pipeTypes).map(extractPipeDef) :\n+               null;\n+\n+           return def as never;\n+         }) as never;\n }\n \n /**"
        },
        {
            "sha": "891a2b9a922ff69dae05590493ea12dbdaf33c39",
            "filename": "packages/core/src/render3/features/inherit_definition_feature.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Ffeatures%2Finherit_definition_feature.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Ffeatures%2Finherit_definition_feature.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Ffeatures%2Finherit_definition_feature.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -78,17 +78,6 @@ export function ɵɵInheritDefinitionFeature(definition: DirectiveDef<any>|Compo\n           const defData = (definition as ComponentDef<any>).data;\n           defData.animation = (defData.animation || []).concat(superDef.data.animation);\n         }\n-\n-        // Inherit hooks\n-        // Assume super class inheritance feature has already run.\n-        writeableDef.afterContentChecked =\n-            writeableDef.afterContentChecked || superDef.afterContentChecked;\n-        writeableDef.afterContentInit = definition.afterContentInit || superDef.afterContentInit;\n-        writeableDef.afterViewChecked = definition.afterViewChecked || superDef.afterViewChecked;\n-        writeableDef.afterViewInit = definition.afterViewInit || superDef.afterViewInit;\n-        writeableDef.doCheck = definition.doCheck || superDef.doCheck;\n-        writeableDef.onDestroy = definition.onDestroy || superDef.onDestroy;\n-        writeableDef.onInit = definition.onInit || superDef.onInit;\n       }\n \n       // Run parent features"
        },
        {
            "sha": "a4b82c0df8cf9821023c05cc014af5ab8397f984",
            "filename": "packages/core/src/render3/features/ng_onchanges_feature.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 27,
            "changes": 62,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Ffeatures%2Fng_onchanges_feature.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Ffeatures%2Fng_onchanges_feature.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Ffeatures%2Fng_onchanges_feature.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -11,14 +11,6 @@ import {SimpleChange, SimpleChanges} from '../../interface/simple_change';\n import {EMPTY_OBJ} from '../empty';\n import {DirectiveDef, DirectiveDefFeature} from '../interfaces/definition';\n \n-const PRIVATE_PREFIX = '__ngOnChanges_';\n-\n-type OnChangesExpando = OnChanges&{\n-  __ngOnChanges_: SimpleChanges|null|undefined;\n-  // tslint:disable-next-line:no-any Can hold any value\n-  [key: string]: any;\n-};\n-\n /**\n  * The NgOnChangesFeature decorates a component with support for the ngOnChanges\n  * lifecycle hook, so it should be included in any component that implements\n@@ -41,12 +33,15 @@ type OnChangesExpando = OnChanges&{\n  *\n  * @codeGenApi\n  */\n+export function ɵɵNgOnChangesFeature<T>(): DirectiveDefFeature {\n+  return NgOnChangesFeatureImpl;\n+}\n \n-export function ɵɵNgOnChangesFeature<T>(definition: DirectiveDef<T>): void {\n+export function NgOnChangesFeatureImpl<T>(definition: DirectiveDef<T>) {\n   if (definition.type.prototype.ngOnChanges) {\n     definition.setInput = ngOnChangesSetInput;\n-    (definition as {onChanges: Function}).onChanges = wrapOnChanges();\n   }\n+  return rememberChangeHistoryAndInvokeOnChangesHook;\n }\n \n // This option ensures that the ngOnChanges lifecycle hook will be inherited\n@@ -55,28 +50,37 @@ export function ɵɵNgOnChangesFeature<T>(definition: DirectiveDef<T>): void {\n // tslint:disable-next-line:no-toplevel-property-access\n (ɵɵNgOnChangesFeature as DirectiveDefFeature).ngInherit = true;\n \n-function wrapOnChanges() {\n-  return function wrapOnChangesHook_inPreviousChangesStorage(this: OnChanges) {\n-    const simpleChangesStore = getSimpleChangesStore(this);\n-    const current = simpleChangesStore && simpleChangesStore.current;\n+/**\n+ * This is a synthetic lifecycle hook which gets inserted into `TView.preOrderHooks` to simulate\n+ * `ngOnChanges`.\n+ *\n+ * The hook reads the `NgSimpleChangesStore` data from the component instance and if changes are\n+ * found it invokes `ngOnChanges` on the component instance.\n+ *\n+ * @param this Component instance. Because this function gets inserted into `TView.preOrderHooks`,\n+ *     it is guaranteed to be called with component instance.\n+ */\n+function rememberChangeHistoryAndInvokeOnChangesHook(this: OnChanges) {\n+  const simpleChangesStore = getSimpleChangesStore(this);\n+  const current = simpleChangesStore?.current;\n \n-    if (current) {\n-      const previous = simpleChangesStore!.previous;\n-      if (previous === EMPTY_OBJ) {\n-        simpleChangesStore!.previous = current;\n-      } else {\n-        // New changes are copied to the previous store, so that we don't lose history for inputs\n-        // which were not changed this time\n-        for (let key in current) {\n-          previous[key] = current[key];\n-        }\n+  if (current) {\n+    const previous = simpleChangesStore!.previous;\n+    if (previous === EMPTY_OBJ) {\n+      simpleChangesStore!.previous = current;\n+    } else {\n+      // New changes are copied to the previous store, so that we don't lose history for inputs\n+      // which were not changed this time\n+      for (let key in current) {\n+        previous[key] = current[key];\n       }\n-      simpleChangesStore!.current = null;\n-      this.ngOnChanges(current);\n     }\n-  };\n+    simpleChangesStore!.current = null;\n+    this.ngOnChanges(current);\n+  }\n }\n \n+\n function ngOnChangesSetInput<T>(\n     this: DirectiveDef<T>, instance: T, value: any, publicName: string, privateName: string): void {\n   const simpleChangesStore = getSimpleChangesStore(instance) ||\n@@ -102,6 +106,10 @@ function setSimpleChangesStore(instance: any, store: NgSimpleChangesStore): NgSi\n   return instance[SIMPLE_CHANGES_STORE] = store;\n }\n \n+/**\n+ * Data structure which is monkey-patched on the component instance and used by `ngOnChanges`\n+ * life-cycle hook to track previous input values.\n+ */\n interface NgSimpleChangesStore {\n   previous: SimpleChanges;\n   current: SimpleChanges|null;"
        },
        {
            "sha": "5bcf1bacc6b35f749a500bfbdf90dd8c79015884",
            "filename": "packages/core/src/render3/hooks.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 23,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Fhooks.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Fhooks.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fhooks.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -6,9 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {AfterContentChecked, AfterContentInit, AfterViewChecked, AfterViewInit, DoCheck, OnChanges, OnDestroy, OnInit} from '../interface/lifecycle_hooks';\n import {assertEqual, assertNotEqual} from '../util/assert';\n-\n import {assertFirstCreatePass} from './assert';\n+import {NgOnChangesFeatureImpl} from './features/ng_onchanges_feature';\n import {DirectiveDef} from './interfaces/definition';\n import {TNode} from './interfaces/node';\n import {FLAGS, HookData, InitPhaseState, LView, LViewFlags, PREORDER_HOOK_FLAGS, PreOrderHookFlags, TView} from './interfaces/view';\n@@ -31,20 +32,23 @@ import {getCheckNoChangesMode} from './state';\n export function registerPreOrderHooks(\n     directiveIndex: number, directiveDef: DirectiveDef<any>, tView: TView): void {\n   ngDevMode && assertFirstCreatePass(tView);\n-  const {onChanges, onInit, doCheck} = directiveDef;\n+  const {ngOnChanges, ngOnInit, ngDoCheck} =\n+      directiveDef.type.prototype as OnChanges & OnInit & DoCheck;\n \n-  if (onChanges) {\n-    (tView.preOrderHooks || (tView.preOrderHooks = [])).push(directiveIndex, onChanges);\n-    (tView.preOrderCheckHooks || (tView.preOrderCheckHooks = [])).push(directiveIndex, onChanges);\n+  if (ngOnChanges as Function | undefined) {\n+    const wrappedOnChanges = NgOnChangesFeatureImpl(directiveDef);\n+    (tView.preOrderHooks || (tView.preOrderHooks = [])).push(directiveIndex, wrappedOnChanges);\n+    (tView.preOrderCheckHooks || (tView.preOrderCheckHooks = []))\n+        .push(directiveIndex, wrappedOnChanges);\n   }\n \n-  if (onInit) {\n-    (tView.preOrderHooks || (tView.preOrderHooks = [])).push(-directiveIndex, onInit);\n+  if (ngOnInit) {\n+    (tView.preOrderHooks || (tView.preOrderHooks = [])).push(0 - directiveIndex, ngOnInit);\n   }\n \n-  if (doCheck) {\n-    (tView.preOrderHooks || (tView.preOrderHooks = [])).push(directiveIndex, doCheck);\n-    (tView.preOrderCheckHooks || (tView.preOrderCheckHooks = [])).push(directiveIndex, doCheck);\n+  if (ngDoCheck) {\n+    (tView.preOrderHooks || (tView.preOrderHooks = [])).push(directiveIndex, ngDoCheck);\n+    (tView.preOrderCheckHooks || (tView.preOrderCheckHooks = [])).push(directiveIndex, ngDoCheck);\n   }\n }\n \n@@ -73,27 +77,36 @@ export function registerPostOrderHooks(tView: TView, tNode: TNode): void {\n   // hooks for projected components and directives must be called *before* their hosts.\n   for (let i = tNode.directiveStart, end = tNode.directiveEnd; i < end; i++) {\n     const directiveDef = tView.data[i] as DirectiveDef<any>;\n-    if (directiveDef.afterContentInit) {\n-      (tView.contentHooks || (tView.contentHooks = [])).push(-i, directiveDef.afterContentInit);\n+    const lifecycleHooks: AfterContentInit&AfterContentChecked&AfterViewInit&AfterViewChecked&\n+        OnDestroy = directiveDef.type.prototype;\n+    const {\n+      ngAfterContentInit,\n+      ngAfterContentChecked,\n+      ngAfterViewInit,\n+      ngAfterViewChecked,\n+      ngOnDestroy\n+    } = lifecycleHooks;\n+\n+    if (ngAfterContentInit) {\n+      (tView.contentHooks || (tView.contentHooks = [])).push(-i, ngAfterContentInit);\n     }\n \n-    if (directiveDef.afterContentChecked) {\n-      (tView.contentHooks || (tView.contentHooks = [])).push(i, directiveDef.afterContentChecked);\n-      (tView.contentCheckHooks || (tView.contentCheckHooks = []))\n-          .push(i, directiveDef.afterContentChecked);\n+    if (ngAfterContentChecked) {\n+      (tView.contentHooks || (tView.contentHooks = [])).push(i, ngAfterContentChecked);\n+      (tView.contentCheckHooks || (tView.contentCheckHooks = [])).push(i, ngAfterContentChecked);\n     }\n \n-    if (directiveDef.afterViewInit) {\n-      (tView.viewHooks || (tView.viewHooks = [])).push(-i, directiveDef.afterViewInit);\n+    if (ngAfterViewInit) {\n+      (tView.viewHooks || (tView.viewHooks = [])).push(-i, ngAfterViewInit);\n     }\n \n-    if (directiveDef.afterViewChecked) {\n-      (tView.viewHooks || (tView.viewHooks = [])).push(i, directiveDef.afterViewChecked);\n-      (tView.viewCheckHooks || (tView.viewCheckHooks = [])).push(i, directiveDef.afterViewChecked);\n+    if (ngAfterViewChecked) {\n+      (tView.viewHooks || (tView.viewHooks = [])).push(i, ngAfterViewChecked);\n+      (tView.viewCheckHooks || (tView.viewCheckHooks = [])).push(i, ngAfterViewChecked);\n     }\n \n-    if (directiveDef.onDestroy != null) {\n-      (tView.destroyHooks || (tView.destroyHooks = [])).push(i, directiveDef.onDestroy);\n+    if (ngOnDestroy != null) {\n+      (tView.destroyHooks || (tView.destroyHooks = [])).push(i, ngOnDestroy);\n     }\n   }\n }"
        },
        {
            "sha": "22b86913fa19404374488869c456a72f8a1c119d",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -7,6 +7,7 @@\n  */\n import {Injector} from '../../di';\n import {ErrorHandler} from '../../error_handler';\n+import {DoCheck, OnChanges, OnInit} from '../../interface/lifecycle_hooks';\n import {CUSTOM_ELEMENTS_SCHEMA, NO_ERRORS_SCHEMA, SchemaMetadata} from '../../metadata/schema';\n import {ViewEncapsulation} from '../../metadata/view';\n import {validateAgainstEventAttributes, validateAgainstEventProperties} from '../../sanitization/sanitization';\n@@ -1166,17 +1167,19 @@ export function resolveDirectives(\n         if (def.hostBindings !== null || def.hostAttrs !== null || def.hostVars !== 0)\n           tNode.flags |= TNodeFlags.hasHostBindings;\n \n+        const lifeCycleHooks: OnChanges&OnInit&DoCheck = def.type.prototype;\n         // Only push a node index into the preOrderHooks array if this is the first\n         // pre-order hook found on this node.\n-        if (!preOrderHooksFound && (def.onChanges || def.onInit || def.doCheck)) {\n+        if (!preOrderHooksFound &&\n+            (lifeCycleHooks.ngOnChanges || lifeCycleHooks.ngOnInit || lifeCycleHooks.ngDoCheck)) {\n           // We will push the actual hook function into this array later during dir instantiation.\n           // We cannot do it now because we must ensure hooks are registered in the same\n           // order that directives are created (i.e. injection order).\n           (tView.preOrderHooks || (tView.preOrderHooks = [])).push(tNode.index - HEADER_OFFSET);\n           preOrderHooksFound = true;\n         }\n \n-        if (!preOrderCheckHooksFound && (def.onChanges || def.doCheck)) {\n+        if (!preOrderCheckHooksFound && (lifeCycleHooks.ngOnChanges || lifeCycleHooks.ngDoCheck)) {\n           (tView.preOrderCheckHooks || (tView.preOrderCheckHooks = []))\n               .push(tNode.index - HEADER_OFFSET);\n           preOrderCheckHooksFound = true;"
        },
        {
            "sha": "a48cb77732bd7ddc5ea2a9381ddb4a028682ebf3",
            "filename": "packages/core/src/render3/interfaces/definition.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fdefinition.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fdefinition.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fdefinition.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -250,16 +250,6 @@ export interface DirectiveDef<T> {\n    */\n   readonly factory: FactoryFn<T>|null;\n \n-  /* The following are lifecycle hooks for this component */\n-  readonly onChanges: (() => void)|null;\n-  readonly onInit: (() => void)|null;\n-  readonly doCheck: (() => void)|null;\n-  readonly afterContentInit: (() => void)|null;\n-  readonly afterContentChecked: (() => void)|null;\n-  readonly afterViewInit: (() => void)|null;\n-  readonly afterViewChecked: (() => void)|null;\n-  readonly onDestroy: (() => void)|null;\n-\n   /**\n    * The features applied to this directive\n    */"
        },
        {
            "sha": "d0ab6fec68a7b12989cb8de5b0ad0c02b6d92f18",
            "filename": "packages/core/test/acceptance/lifecycle_spec.ts",
            "status": "modified",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Facceptance%2Flifecycle_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Facceptance%2Flifecycle_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Flifecycle_spec.ts?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -1124,6 +1124,100 @@ describe('onChanges', () => {\n   });\n });\n \n+describe('meta-programing', () => {\n+  it('should allow adding lifecycle hook methods any time before first instance creation', () => {\n+    const events: any[] = [];\n+\n+    @Component({template: `<child name=\"value\"></child>`})\n+    class App {\n+    }\n+\n+    @Component({selector: 'child', template: `empty`})\n+    class Child {\n+      @Input() name: string = '';\n+    }\n+\n+    const ChildPrototype = Child.prototype as any;\n+    ChildPrototype.ngOnInit = () => events.push('onInit');\n+    ChildPrototype.ngOnChanges = (e: SimpleChanges) => {\n+      const name = e['name'];\n+      expect(name.previousValue).toEqual(undefined);\n+      expect(name.currentValue).toEqual('value');\n+      expect(name.firstChange).toEqual(true);\n+      events.push('ngOnChanges');\n+    };\n+    ChildPrototype.ngDoCheck = () => events.push('ngDoCheck');\n+    ChildPrototype.ngAfterContentInit = () => events.push('ngAfterContentInit');\n+    ChildPrototype.ngAfterContentChecked = () => events.push('ngAfterContentChecked');\n+    ChildPrototype.ngAfterViewInit = () => events.push('ngAfterViewInit');\n+    ChildPrototype.ngAfterViewChecked = () => events.push('ngAfterViewChecked');\n+    ChildPrototype.ngOnDestroy = () => events.push('ngOnDestroy');\n+\n+    TestBed.configureTestingModule({\n+      declarations: [App, Child],\n+    });\n+    const fixture = TestBed.createComponent(App);\n+    fixture.detectChanges();\n+    fixture.destroy();\n+    expect(events).toEqual([\n+      'ngOnChanges', 'onInit', 'ngDoCheck', 'ngAfterContentInit', 'ngAfterContentChecked',\n+      'ngAfterViewInit', 'ngAfterViewChecked', 'ngOnDestroy'\n+    ]);\n+  });\n+\n+  it('should allow adding lifecycle hook methods with inheritance any time before first instance creation',\n+     () => {\n+       const events: any[] = [];\n+\n+       @Component({template: `<child name=\"value\"></child>`})\n+       class App {\n+       }\n+\n+       class BaseChild {}\n+\n+       @Component({selector: 'child', template: `empty`})\n+       class Child extends BaseChild {\n+         @Input() name: string = '';\n+       }\n+\n+       // These are defined on the base class\n+       const BasePrototype = BaseChild.prototype as any;\n+       BasePrototype.ngOnInit = () => events.push('onInit');\n+       BasePrototype.ngOnChanges = (e: SimpleChanges) => {\n+         const name = e['name'];\n+         expect(name.previousValue).toEqual(undefined);\n+         expect(name.currentValue).toEqual('value');\n+         expect(name.firstChange).toEqual(true);\n+         events.push('ngOnChanges');\n+       };\n+\n+       // These will be overwritten later\n+       BasePrototype.ngDoCheck = () => events.push('Expected to be overbidden');\n+       BasePrototype.ngAfterContentInit = () => events.push('Expected to be overbidden');\n+\n+\n+       // These are define on the concrete class\n+       const ChildPrototype = Child.prototype as any;\n+       ChildPrototype.ngDoCheck = () => events.push('ngDoCheck');\n+       ChildPrototype.ngAfterContentInit = () => events.push('ngAfterContentInit');\n+       ChildPrototype.ngAfterContentChecked = () => events.push('ngAfterContentChecked');\n+       ChildPrototype.ngAfterViewInit = () => events.push('ngAfterViewInit');\n+       ChildPrototype.ngAfterViewChecked = () => events.push('ngAfterViewChecked');\n+       ChildPrototype.ngOnDestroy = () => events.push('ngOnDestroy');\n+\n+       TestBed.configureTestingModule({\n+         declarations: [App, Child],\n+       });\n+       const fixture = TestBed.createComponent(App);\n+       fixture.detectChanges();\n+       fixture.destroy();\n+       expect(events).toEqual([\n+         'ngOnChanges', 'onInit', 'ngDoCheck', 'ngAfterContentInit', 'ngAfterContentChecked',\n+         'ngAfterViewInit', 'ngAfterViewChecked', 'ngOnDestroy'\n+       ]);\n+     });\n+});\n+\n it('should call all hooks in correct order when several directives on same node', () => {\n   let log: string[] = [];\n "
        },
        {
            "sha": "d012b3be33246e65eea5d241cdcd87ed47b70c2b",
            "filename": "packages/core/test/bundling/cyclic_import/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Fbundling%2Fcyclic_import%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Fbundling%2Fcyclic_import%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fcyclic_import%2Fbundle.golden_symbols.json?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -200,6 +200,9 @@\n   {\n     \"name\": \"getPreviousOrParentTNode\"\n   },\n+  {\n+    \"name\": \"getSimpleChangesStore\"\n+  },\n   {\n     \"name\": \"getTView\"\n   },\n@@ -281,6 +284,9 @@\n   {\n     \"name\": \"nextNgElementId\"\n   },\n+  {\n+    \"name\": \"ngOnChangesSetInput\"\n+  },\n   {\n     \"name\": \"noSideEffects\"\n   },\n@@ -293,6 +299,9 @@\n   {\n     \"name\": \"refreshView\"\n   },\n+  {\n+    \"name\": \"rememberChangeHistoryAndInvokeOnChangesHook\"\n+  },\n   {\n     \"name\": \"renderComponent\"\n   },"
        },
        {
            "sha": "f7d1fe5780c6cfcb50ade34befd0f0847e6e710d",
            "filename": "packages/core/test/bundling/hello_world/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fhello_world%2Fbundle.golden_symbols.json?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -137,6 +137,9 @@\n   {\n     \"name\": \"getPreviousOrParentTNode\"\n   },\n+  {\n+    \"name\": \"getSimpleChangesStore\"\n+  },\n   {\n     \"name\": \"includeViewProviders\"\n   },\n@@ -176,6 +179,9 @@\n   {\n     \"name\": \"nextNgElementId\"\n   },\n+  {\n+    \"name\": \"ngOnChangesSetInput\"\n+  },\n   {\n     \"name\": \"refreshComponent\"\n   },\n@@ -185,6 +191,9 @@\n   {\n     \"name\": \"refreshView\"\n   },\n+  {\n+    \"name\": \"rememberChangeHistoryAndInvokeOnChangesHook\"\n+  },\n   {\n     \"name\": \"renderComponent\"\n   },"
        },
        {
            "sha": "0d6e14706ba3a88e14087865e38c7944210540bf",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/737506e79cbda87d8545a663bdd618a884c2e60e/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=737506e79cbda87d8545a663bdd618a884c2e60e",
            "patch": "@@ -392,6 +392,9 @@\n   {\n     \"name\": \"getSelectedIndex\"\n   },\n+  {\n+    \"name\": \"getSimpleChangesStore\"\n+  },\n   {\n     \"name\": \"getSymbolIterator\"\n   },\n@@ -548,6 +551,9 @@\n   {\n     \"name\": \"nextNgElementId\"\n   },\n+  {\n+    \"name\": \"ngOnChangesSetInput\"\n+  },\n   {\n     \"name\": \"noSideEffects\"\n   },\n@@ -569,6 +575,9 @@\n   {\n     \"name\": \"registerPostOrderHooks\"\n   },\n+  {\n+    \"name\": \"rememberChangeHistoryAndInvokeOnChangesHook\"\n+  },\n   {\n     \"name\": \"removeFromArray\"\n   },"
        }
    ],
    "stats": {
        "total": 415,
        "additions": 266,
        "deletions": 149
    }
}