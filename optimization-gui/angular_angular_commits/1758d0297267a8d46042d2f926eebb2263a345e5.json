{
    "author": "iRealNirmal",
    "message": "feat(compiler): support directive selectors with attributes containing `$` (#41567)\n\nThis commit adds support for `$` in when selecting attributes.\n\nResolves #41244.\n\ntest(language-service): Add test to expose bug caused by source file change (#41500)\n\nThis commit adds a test to expose the bug caused by source file change in\nbetween typecheck programs.\n\nPR Close #41500\n\nPR Close #41567",
    "sha": "1758d0297267a8d46042d2f926eebb2263a345e5",
    "files": [
        {
            "sha": "1460206d8decb333106b0dce005dfbd0892ba3e1",
            "filename": "packages/compiler/src/selector.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 7,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/1758d0297267a8d46042d2f926eebb2263a345e5/packages%2Fcompiler%2Fsrc%2Fselector.ts",
            "raw_url": "https://github.com/angular/angular/raw/1758d0297267a8d46042d2f926eebb2263a345e5/packages%2Fcompiler%2Fsrc%2Fselector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fselector.ts?ref=1758d0297267a8d46042d2f926eebb2263a345e5",
            "patch": "@@ -13,11 +13,11 @@ const _SELECTOR_REGEXP = new RegExp(\n         '(([\\\\.\\\\#]?)[-\\\\w]+)|' +  // 2: \"tag\"; 3: \".\"/\"#\";\n         // \"-\" should appear first in the regexp below as FF31 parses \"[.-\\w]\" as a range\n         // 4: attribute; 5: attribute_string; 6: attribute_value\n-        '(?:\\\\[([-.\\\\w*]+)(?:=([\\\"\\']?)([^\\\\]\\\"\\']*)\\\\5)?\\\\])|' +  // \"[name]\", \"[name=value]\",\n-                                                                   // \"[name=\"value\"]\",\n-                                                                   // \"[name='value']\"\n-        '(\\\\))|' +                                                 // 7: \")\"\n-        '(\\\\s*,\\\\s*)',                                             // 8: \",\"\n+        '(?:\\\\[([-.\\\\w*\\\\\\\\$]+)(?:=([\\\"\\']?)([^\\\\]\\\"\\']*)\\\\5)?\\\\])|' +  // \"[name]\", \"[name=value]\",\n+                                                                        // \"[name=\"value\"]\",\n+                                                                        // \"[name='value']\"\n+        '(\\\\))|' +                                                      // 7: \")\"\n+        '(\\\\s*,\\\\s*)',                                                  // 8: \",\"\n     'g');\n \n /**\n@@ -94,8 +94,10 @@ export class CssSelector {\n         }\n       }\n       const attribute = match[SelectorRegexp.ATTRIBUTE];\n+\n       if (attribute) {\n-        current.addAttribute(attribute, match[SelectorRegexp.ATTRIBUTE_VALUE]);\n+        current.addAttribute(\n+            current.unescapeAttribute(attribute), match[SelectorRegexp.ATTRIBUTE_VALUE]);\n       }\n       if (match[SelectorRegexp.NOT_END]) {\n         inNot = false;\n@@ -113,6 +115,50 @@ export class CssSelector {\n     return results;\n   }\n \n+  /**\n+   * Unescape `\\$` sequences from the CSS attribute selector.\n+   *\n+   * This is needed because `$` can have a special meaning in CSS selectors,\n+   * but we might want to match an attribute that contains `$`.\n+   * [MDN web link for more\n+   * info](https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors).\n+   * @param attr the attribute to unescape.\n+   * @returns the unescaped string.\n+   */\n+  unescapeAttribute(attr: string): string {\n+    let result = '';\n+    let escaping = false;\n+    for (let i = 0; i < attr.length; i++) {\n+      const char = attr.charAt(i);\n+      if (char === '\\\\') {\n+        escaping = true;\n+        continue;\n+      }\n+      if (char === '$' && !escaping) {\n+        throw new Error(\n+            `Error in attribute selector \"${attr}\". ` +\n+            `Unescaped \"$\" is not supported. Please escape with \"\\\\$\".`);\n+      }\n+      escaping = false;\n+      result += char;\n+    }\n+    return result;\n+  }\n+\n+  /**\n+   * Escape `$` sequences from the CSS attribute selector.\n+   *\n+   * This is needed because `$` can have a special meaning in CSS selectors,\n+   * with this method we are escaping `$` with `\\$'.\n+   * [MDN web link for more\n+   * info](https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors).\n+   * @param attr the attribute to escape.\n+   * @returns the escaped string. \n+   */\n+  escapeAttribute(attr: string): string {\n+    return attr.replace(/\\\\/g, '\\\\\\\\').replace(/\\$/g, '\\\\$');\n+  }\n+\n   isElementSelector(): boolean {\n     return this.hasElementSelector() && this.classNames.length == 0 && this.attrs.length == 0 &&\n         this.notSelectors.length === 0;\n@@ -165,7 +211,7 @@ export class CssSelector {\n     }\n     if (this.attrs) {\n       for (let i = 0; i < this.attrs.length; i += 2) {\n-        const name = this.attrs[i];\n+        const name = this.escapeAttribute(this.attrs[i]);\n         const value = this.attrs[i + 1];\n         res += `[${name}${value ? '=' + value : ''}]`;\n       }"
        },
        {
            "sha": "47ece1e724e1b4431a49dda9519190f6859ae842",
            "filename": "packages/compiler/test/selector/selector_spec.ts",
            "status": "modified",
            "additions": 90,
            "deletions": 0,
            "changes": 90,
            "blob_url": "https://github.com/angular/angular/blob/1758d0297267a8d46042d2f926eebb2263a345e5/packages%2Fcompiler%2Ftest%2Fselector%2Fselector_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1758d0297267a8d46042d2f926eebb2263a345e5/packages%2Fcompiler%2Ftest%2Fselector%2Fselector_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fselector%2Fselector_spec.ts?ref=1758d0297267a8d46042d2f926eebb2263a345e5",
            "patch": "@@ -126,6 +126,67 @@ import {el} from '@angular/platform-browser/testing/src/browser_util';\n       expect(matched).toEqual([s1[0], 1]);\n     });\n \n+    it('should support \"$\" in attribute names', () => {\n+      matcher.addSelectables(s1 = CssSelector.parse('[someAttr\\\\$]'), 1);\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['someAttr', '']]}), selectableCollector))\n+          .toEqual(false);\n+      expect(matched).toEqual([]);\n+      reset();\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['someAttr$', '']]}), selectableCollector))\n+          .toEqual(true);\n+      expect(matched).toEqual([s1[0], 1]);\n+      reset();\n+\n+      matcher.addSelectables(s1 = CssSelector.parse('[some\\\\$attr]'), 1);\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['someattr', '']]}), selectableCollector))\n+          .toEqual(false);\n+      expect(matched).toEqual([]);\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['some$attr', '']]}), selectableCollector))\n+          .toEqual(true);\n+      expect(matched).toEqual([s1[0], 1]);\n+      reset();\n+\n+      matcher.addSelectables(s1 = CssSelector.parse('[\\\\$someAttr]'), 1);\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['someAttr', '']]}), selectableCollector))\n+          .toEqual(false);\n+      expect(matched).toEqual([]);\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['$someAttr', '']]}), selectableCollector))\n+          .toEqual(true);\n+      expect(matched).toEqual([s1[0], 1]);\n+      reset();\n+\n+      matcher.addSelectables(s1 = CssSelector.parse('[some-\\\\$Attr]'), 1);\n+      matcher.addSelectables(s2 = CssSelector.parse('[some-\\\\$Attr][some-\\\\$-attr]'), 2);\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['some\\\\$Attr', '']]}), selectableCollector))\n+          .toEqual(false);\n+      expect(matched).toEqual([]);\n+\n+      expect(matcher.match(\n+                 getSelectorFor({attrs: [['some-$-attr', 'someValue'], ['some-$Attr', '']]}),\n+                 selectableCollector))\n+          .toEqual(true);\n+      expect(matched).toEqual([s1[0], 1, s2[0], 2]);\n+      reset();\n+\n+\n+      expect(matcher.match(getSelectorFor({attrs: [['someattr$', '']]}), selectableCollector))\n+          .toEqual(false);\n+      expect(matched).toEqual([]);\n+\n+      expect(matcher.match(\n+                 getSelectorFor({attrs: [['some-simple-attr', '']]}), selectableCollector))\n+          .toEqual(false);\n+      expect(matched).toEqual([]);\n+      reset();\n+    });\n+\n     it('should select by attr name only once if the value is from the DOM', () => {\n       matcher.addSelectables(s1 = CssSelector.parse('[some-decor]'), 1);\n \n@@ -307,6 +368,35 @@ import {el} from '@angular/platform-browser/testing/src/browser_util';\n       expect(cssSelector.toString()).toEqual('sometag');\n     });\n \n+    it('should detect attr names with escaped $', () => {\n+      let cssSelector = CssSelector.parse('[attrname\\\\$]')[0];\n+      expect(cssSelector.attrs).toEqual(['attrname$', '']);\n+      expect(cssSelector.toString()).toEqual('[attrname\\\\$]');\n+\n+      cssSelector = CssSelector.parse('[\\\\$attrname]')[0];\n+      expect(cssSelector.attrs).toEqual(['$attrname', '']);\n+      expect(cssSelector.toString()).toEqual('[\\\\$attrname]');\n+\n+      cssSelector = CssSelector.parse('[foo\\\\$bar]')[0];\n+      expect(cssSelector.attrs).toEqual(['foo$bar', '']);\n+      expect(cssSelector.toString()).toEqual('[foo\\\\$bar]');\n+    });\n+\n+    it('should error on attr names with unescaped $', () => {\n+      expect(() => CssSelector.parse('[attrname$]'))\n+          .toThrowError(\n+              'Error in attribute selector \"attrname$\". Unescaped \"$\" is not supported. Please escape with \"\\\\$\".');\n+      expect(() => CssSelector.parse('[$attrname]'))\n+          .toThrowError(\n+              'Error in attribute selector \"$attrname\". Unescaped \"$\" is not supported. Please escape with \"\\\\$\".');\n+      expect(() => CssSelector.parse('[foo$bar]'))\n+          .toThrowError(\n+              'Error in attribute selector \"foo$bar\". Unescaped \"$\" is not supported. Please escape with \"\\\\$\".');\n+      expect(() => CssSelector.parse('[foo\\\\$bar$]'))\n+          .toThrowError(\n+              'Error in attribute selector \"foo\\\\$bar$\". Unescaped \"$\" is not supported. Please escape with \"\\\\$\".');\n+    });\n+\n     it('should detect class names', () => {\n       const cssSelector = CssSelector.parse('.someClass')[0];\n       expect(cssSelector.classNames).toEqual(['someclass']);"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 143,
        "deletions": 7
    }
}