{
    "author": "dgp1130",
    "message": "docs: update CLI builder to be platform agnostic (#42371)\n\nFixes #35373.\n\nThis changes the example from \"run an arbitrary process\" to \"copy a file\". This should make it a bit easier to follow, require less background knowledge to understand, and not use any platform-specific commands that won't work for Windows users.\n\nThe most glaring issue with this change is that this doc does not explictly specify how to build and run a builder. I've updated some of the files to hint at this a bit more (such as the `\"implementation\": \"./dist/my-builder.js\"`), but another pass is required to figure out the best way to compile a builder and how we want to structure this example to best communicate that.\n\nPR Close #42371",
    "sha": "e0381a87c9850a3c05478ca91847d8ac4d312390",
    "files": [
        {
            "sha": "ab6a074e3835def81aef3afbd8ae655d07d5ca4a",
            "filename": "aio/content/examples/cli-builder/src/my-builder.spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 14,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/e0381a87c9850a3c05478ca91847d8ac4d312390/aio%2Fcontent%2Fexamples%2Fcli-builder%2Fsrc%2Fmy-builder.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0381a87c9850a3c05478ca91847d8ac4d312390/aio%2Fcontent%2Fexamples%2Fcli-builder%2Fsrc%2Fmy-builder.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fcli-builder%2Fsrc%2Fmy-builder.spec.ts?ref=e0381a87c9850a3c05478ca91847d8ac4d312390",
            "patch": "@@ -1,9 +1,10 @@\n // #docregion\n import { Architect } from '@angular-devkit/architect';\n import { TestingArchitectHost } from '@angular-devkit/architect/testing';\n-import { logging, schema } from '@angular-devkit/core';\n+import { schema } from '@angular-devkit/core';\n+import { promises as fs } from 'fs';\n \n-describe('Command Runner Builder', () => {\n+describe('Copy File Builder', () => {\n   let architect: Architect;\n   let architectHost: TestingArchitectHost;\n \n@@ -21,17 +22,12 @@ describe('Command Runner Builder', () => {\n     await architectHost.addBuilderFromPackage('..');\n   });\n \n-  it('can run node', async () => {\n-    // Create a logger that keeps an array of all messages that were logged.\n-    const logger = new logging.Logger('');\n-    const logs = [];\n-    logger.subscribe(ev => logs.push(ev.message));\n-\n+  it('can copy files', async () => {\n     // A \"run\" can have multiple outputs, and contains progress information.\n-    const run = await architect.scheduleBuilder('@example/command-runner:command', {\n-      command: 'node',\n-      args: ['--print', '\\'foo\\''],\n-    }, { logger });  // We pass the logger for checking later.\n+    const run = await architect.scheduleBuilder('@example/copy-file:copy', {\n+      source: 'package.json',\n+      destination: 'package-copy.json',\n+    });\n \n     // The \"result\" member (of type BuilderOutput) is the next output.\n     const output = await run.result;\n@@ -41,8 +37,10 @@ describe('Command Runner Builder', () => {\n     // to be scheduled.\n     await run.stop();\n \n-    // Expect that foo was logged\n-    expect(logs).toContain('foo');\n+    // Expect that the copied file is the same as its source.\n+    const sourceContent = await fs.readFile('package.json', 'utf8');\n+    const destinationContent = await fs.readFile('package-copy.json', 'utf8');\n+    expect(destinationContent).toBe(sourceContent);\n   });\n });\n // #enddocregion"
        },
        {
            "sha": "b7603078d47b9ebfb4d140bed173efed7947c586",
            "filename": "aio/content/examples/cli-builder/src/my-builder.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 29,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/e0381a87c9850a3c05478ca91847d8ac4d312390/aio%2Fcontent%2Fexamples%2Fcli-builder%2Fsrc%2Fmy-builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/e0381a87c9850a3c05478ca91847d8ac4d312390/aio%2Fcontent%2Fexamples%2Fcli-builder%2Fsrc%2Fmy-builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fexamples%2Fcli-builder%2Fsrc%2Fmy-builder.ts?ref=e0381a87c9850a3c05478ca91847d8ac4d312390",
            "patch": "@@ -3,44 +3,42 @@\n import { BuilderContext, BuilderOutput, createBuilder } from '@angular-devkit/architect';\n import { JsonObject } from '@angular-devkit/core';\n // #enddocregion builder-skeleton\n-import * as childProcess from 'child_process';\n+import { promises as fs } from 'fs';\n // #docregion builder-skeleton\n \n interface Options extends JsonObject {\n-  command: string;\n-  args: string[];\n+  source: string;\n+  destination: string;\n }\n \n-export default createBuilder(commandBuilder);\n+export default createBuilder(copyFileBuilder);\n \n-function commandBuilder(\n+async function copyFileBuilder(\n   options: Options,\n   context: BuilderContext,\n-  ): Promise<BuilderOutput> {\n-    // #enddocregion builder, builder-skeleton, handling-output\n-    // #docregion report-status\n-    context.reportStatus(`Executing \"${options.command}\"...`);\n-    // #docregion builder, handling-output\n-    const child = childProcess.spawn(options.command, options.args);\n-    // #enddocregion builder, report-status\n-\n-    child.stdout.on('data', data => {\n-      context.logger.info(data.toString());\n-    });\n-    child.stderr.on('data', data => {\n-      context.logger.error(data.toString());\n-    });\n-\n+): Promise<BuilderOutput> {\n+  // #enddocregion builder, builder-skeleton, handling-output\n+  // #docregion report-status\n+  context.reportStatus(`Copying ${options.source} to ${options.destination}.`);\n+  // #docregion builder, handling-output\n+  try {\n+    await fs.copyFile(options.source, options.destination);\n+  } catch (err) {\n+    // #enddocregion builder\n+    context.logger.error('Failed to copy file.');\n     // #docregion builder\n-    return new Promise(resolve => {\n-      // #enddocregion builder, handling-output\n-      context.reportStatus(`Done.`);\n-      // #docregion builder, handling-output\n-      child.on('close', code => {\n-        resolve({ success: code === 0 });\n-      });\n-    });\n-    // #docregion builder-skeleton\n+    return {\n+      success: false,\n+      error: err.message,\n+    };\n+  }\n+\n+  // #enddocregion builder, handling-output\n+  context.reportStatus('Done.');\n+  // #docregion builder, handling-output\n+  return { success: true };\n+  // #enddocregion report-status\n+  // #docregion builder-skeleton\n }\n \n // #enddocregion builder, builder-skeleton, handling-output, progress-reporting"
        },
        {
            "sha": "76ee813b00669ba060102354d0ccc7c947947948",
            "filename": "aio/content/guide/cli-builder.md",
            "status": "modified",
            "additions": 49,
            "deletions": 49,
            "changes": 98,
            "blob_url": "https://github.com/angular/angular/blob/e0381a87c9850a3c05478ca91847d8ac4d312390/aio%2Fcontent%2Fguide%2Fcli-builder.md",
            "raw_url": "https://github.com/angular/angular/raw/e0381a87c9850a3c05478ca91847d8ac4d312390/aio%2Fcontent%2Fguide%2Fcli-builder.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fcontent%2Fguide%2Fcli-builder.md?ref=e0381a87c9850a3c05478ca91847d8ac4d312390",
            "patch": "@@ -56,7 +56,7 @@ npm install @example/my-builder\n \n ## Creating a builder\n \n-As an example, let's create a builder that executes a shell command.\n+As an example, let's create a builder that copies a file.\n To create a builder, use the `createBuilder()` CLI Builder function, and return a `Promise<BuilderOutput>` object.\n \n <code-example\n@@ -65,9 +65,10 @@ To create a builder, use the `createBuilder()` CLI Builder function, and return\n   region=\"builder-skeleton\">\n </code-example>\n \n-Now let’s add some logic to it.\n-The following code retrieves the command and arguments from the user options, spawns the new process, and waits for the process to finish.\n-If the process is successful (returns a code of 0), it resolves the return value.\n+Now let’s add some logic to it. The following code retrieves the source and destination file paths\n+from user options and copies the file from the source to the destination (leveraging the\n+[Promise version of the built-in NodeJS `copyFile()` function](https://nodejs.org/api/fs.html#fs_fspromises_copyfile_src_dest_mode)).\n+If the copy operation fails, it returns an error with a message about the underlying problem.\n \n <code-example\n   path=\"cli-builder/src/my-builder.ts\"\n@@ -77,11 +78,13 @@ If the process is successful (returns a code of 0), it resolves the return value\n \n ### Handling output\n \n-By default, the `spawn()` method outputs everything to the process standard output and error.\n-To make it easier to test and debug, we can forward the output to the CLI Builder logger instead.\n-This also allows the builder itself to be executed in a separate process, even if the standard output and error are deactivated (as in an [Electron app](https://electronjs.org/)).\n+By default, `copyFile()` does not print anything to the process standard output or error. If an\n+error occurs, it may be difficult to understand exactly what the builder was trying to do when the\n+problem occurred. We can add some additional context by logging additional information using the\n+`Logger` API. This also allows the builder itself to be executed in a separate process, even if the\n+standard output and error are deactivated (as in an [Electron app](https://electronjs.org/)).\n \n-We can retrieve a Logger instance from the context.\n+We can retrieve a `Logger` instance from the context.\n \n <code-example\n   path=\"cli-builder/src/my-builder.ts\"\n@@ -99,7 +102,7 @@ The status string is unmodified unless you pass in a new string value.\n \n You can see an [example](https://github.com/angular/angular-cli/blob/ba21c855c0c8b778005df01d4851b5a2176edc6f/packages/angular_devkit/build_angular/src/tslint/index.ts#L107) of how the `tslint` builder reports progress.\n \n-In our example, the shell command either finishes or is still executing, so there’s no need for a progress report, but we can report status so that a parent builder that called our builder would know what’s going on.\n+In our example, the copy operation either finishes or is still executing, so there’s no need for a progress report, but we can report status so that a parent builder that called our builder would know what’s going on.\n Use the `context.reportStatus()` method to generate a status string of any length.\n (Note that there’s no guarantee that a long string will be shown entirely; it could be cut to fit the UI that displays it.)\n Pass an empty string to remove the status.\n@@ -121,23 +124,21 @@ You define builder inputs in a JSON schema associated with that builder.\n The Architect tool collects the resolved input values into an `options` object, and validates their types against the schema before passing them to the builder function.\n (The Schematics library does the same kind of validation of user input.)\n \n-For our example builder, we expect the `options` value to be a `JsonObject` with two keys: a `command` that is a string, and an `args` array of string values.\n+For our example builder, we expect the `options` value to be a `JsonObject` with two keys: a\n+`source` and a `destination`, each of which are a string.\n \n We can provide the following schema for type validation of these values.\n \n-<code-example language=\"json\" header=\"command/schema.json\">\n+<code-example language=\"json\" header=\"src/schema.json\">\n {\n   \"$schema\": \"http://json-schema.org/schema\",\n   \"type\": \"object\",\n   \"properties\": {\n-    \"command\": {\n+    \"source\": {\n       \"type\": \"string\"\n     },\n-    \"args\": {\n-      \"type\": \"array\",\n-      \"items\": {\n-        \"type\": \"string\"\n-      }\n+    \"destination\": {\n+      \"type\": \"string\"\n     }\n   }\n }\n@@ -159,10 +160,10 @@ Create a file named `builders.json` that looks like this:\n \n {\n   \"builders\": {\n-    \"command\": {\n-      \"implementation\": \"./command\",\n-      \"schema\": \"./command/schema.json\",\n-      \"description\": \"Runs any command line in the operating system.\"\n+    \"copy\": {\n+      \"implementation\": \"./dist/my-builder.js\",\n+      \"schema\": \"./src/schema.json\",\n+      \"description\": \"Copies a file.\"\n     }\n   }\n }\n@@ -174,21 +175,22 @@ In the `package.json` file, add a `builders` key that tells the Architect tool w\n <code-example language=\"json\" header=\"package.json\">\n \n {\n-  \"name\": \"@example/command-runner\",\n+  \"name\": \"@example/copy-file\",\n   \"version\": \"1.0.0\",\n-  \"description\": \"Builder for Command Runner\",\n+  \"description\": \"Builder for copying files\",\n   \"builders\": \"builders.json\",\n-  \"devDependencies\": {\n-    \"@angular-devkit/architect\": \"^1.0.0\"\n+  \"dependencies\": {\n+    \"@angular-devkit/architect\": \"~0.1200.0\",\n+    \"@angular-devkit/core\": \"^12.0.0\"\n   }\n }\n \n </code-example>\n \n-The official name of our builder is now ` @example/command-runner:command`.\n+The official name of our builder is now ` @example/copy-file:copy`.\n The first part of this is the package name (resolved using node resolution), and the second part is the builder name (resolved using the `builders.json` file).\n \n-Using one of our `options` is very straightforward, we did this in the previous section when we accessed `options.command`.\n+Using one of our `options` is very straightforward, we did this in the previous section when we accessed `options.source` and `options.destination`.\n \n <code-example\n   path=\"cli-builder/src/my-builder.ts\"\n@@ -288,7 +290,7 @@ We can publish the builder to npm (see [Publishing your Library](guide/creating-\n \n <code-example language=\"sh\">\n \n-npm install @example/command-runner\n+npm install @example/copy-file\n \n </code-example>\n \n@@ -333,32 +335,30 @@ If we create a new project with `ng new builder-test`, the generated `angular.js\n \n ### Adding a target\n \n-Let's add a new target that will run our builder to execute a particular command.\n-This target will tell the builder to run `touch` on a file, in order to update its modified date.\n+Let's add a new target that will run our builder to copy a file.\n+This target will tell the builder to copy the `package.json` file.\n \n We need to update the `angular.json` file to add a target for this builder to the \"architect\" section of our new project.\n \n * We'll add a new target section to the \"architect\" object for our project.\n \n-* The target named \"touch\" uses our builder, which we published to `@example/command-runner`. (See [Publishing your Library](guide/creating-libraries#publishing-your-library).)\n+* The target named \"copy-package\" uses our builder, which we published to `@example/copy-file`. (See [Publishing your Library](guide/creating-libraries#publishing-your-library))\n \n-* The options object provides default values for the two inputs that we defined; `command`, which is the Unix command to execute, and `args`, an array that contains the file to operate on.\n+* The options object provides default values for the two inputs that we defined; `source`, which is the existing file we are copying, and `destination`, the path we want to copy to.\n \n-* The configurations key is optional, we'll leave it out for now.\n+* The `configurations` key is optional, we'll leave it out for now.\n \n <code-example language=\"json\" header=\"angular.json\">\n \n {\n   \"projects\": {\n     \"builder-test\": {\n       \"architect\": {\n-        \"touch\": {\n-          \"builder\": \"@example/command-runner:command\",\n+        \"copy-package\": {\n+          \"builder\": \"@example/copy-file:copy\",\n           \"options\": {\n-            \"command\": \"touch\",\n-            \"args\": [\n-              \"src/main.ts\"\n-            ]\n+            \"source\": \"package.json\",\n+            \"destination\": \"package-copy.json\"\n           }\n         },\n         \"build\": {\n@@ -393,38 +393,38 @@ We need to update the `angular.json` file to add a target for this builder to th\n \n ### Running the builder\n \n-To run our builder with the new target's default configuration, use the following CLI command in a Linux shell.\n+To run our builder with the new target's default configuration, use the following CLI command.\n \n <code-example language=\"sh\">\n \n-   ng run builder-test:touch\n+ng run builder-test:copy-package\n \n </code-example>\n \n-This will run the `touch` command on the `src/main.ts` file.\n+This will copy the `package.json` file to `package-copy.json`.\n \n You can use command-line arguments to override the configured defaults.\n-For example, to run with a different `command` value, use the following CLI command.\n+For example, to run with a different `destination` value, use the following CLI command.\n \n <code-example language=\"sh\">\n \n-ng run builder-test:touch --command=ls\n+ng run builder-test:copy-package --destination=package-other.json\n \n </code-example>\n \n-This will call the `ls` command instead of the `touch` command.\n-Because we did not override the *args* option, it will list information about the `src/main.ts` file (the default value provided for the target).\n+This will copy the file to `package-other.json` instead of `package-copy.json`.\n+Because we did not override the *source* option, it will copy from the `package.json` file (the default value provided for the target).\n \n ## Testing a builder\n \n Use integration testing for your builder, so that you can use the Architect scheduler to create a context, as in this [example](https://github.com/mgechev/cli-builders-demo).\n \n * In the builder source directory, we have created a new test file `my-builder.spec.ts`. The code creates new instances of `JsonSchemaRegistry` (for schema validation), `TestingArchitectHost` (an in-memory implementation of `ArchitectHost`), and `Architect`.\n \n-* We've added a `builders.json` file next to the builder's [`package.json` file](https://github.com/mgechev/cli-builders-demo/blob/master/command-builder/builders.json), and modified the package file to point to it.\n+* We've added a `builders.json` file next to the builder's `package.json` file, and modified the package file to point to it.\n \n-Here’s an example of a test that runs the command builder.\n-The test uses the builder to run the `node --print 'foo'` command, then validates that the `logger` contains an entry for `foo`.\n+Here’s an example of a test that runs the copy file builder.\n+The test uses the builder to copy the `package.json` file and validates that the copied file's contents are the same as the source.\n \n <code-example\n   path=\"cli-builder/src/my-builder.spec.ts\""
        }
    ],
    "stats": {
        "total": 180,
        "additions": 88,
        "deletions": 92
    }
}