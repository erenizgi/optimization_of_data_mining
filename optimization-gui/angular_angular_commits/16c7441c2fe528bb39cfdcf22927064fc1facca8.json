{
    "author": "alxhub",
    "message": "refactor(compiler-cli): introduce the TemplateTypeChecker abstraction (#38105)\n\nThis commit significantly refactors the 'typecheck' package to introduce a\nnew abstraction, the `TemplateTypeChecker`. To achieve this:\n\n* a 'typecheck:api' package is introduced, containing common interfaces that\n  consumers of the template type-checking infrastructure can depend on\n  without incurring a dependency on the template type-checking machinery as\n  a whole.\n* interfaces for `TemplateTypeChecker` and `TypeCheckContext` are introduced\n  which contain the abstract operations supported by the implementation\n  classes `TemplateTypeCheckerImpl` and `TypeCheckContextImpl` respectively.\n* the `TemplateTypeChecker` interface supports diagnostics on a whole\n  program basis to start with, but the implementation is purposefully\n  designed to support incremental diagnostics at a per-file or per-component\n  level.\n* `TemplateTypeChecker` supports direct access to the type check block of a\n  component.\n* the testing utility is refactored to be a lot more useful, and new tests\n  are added for the new abstraction.\n\nPR Close #38105",
    "sha": "16c7441c2fe528bb39cfdcf22927064fc1facca8",
    "files": [
        {
            "sha": "7d951acba3dbdc77b5d9314b5b2a1ab7af718f06",
            "filename": "packages/compiler-cli/ngcc/src/analysis/ngcc_trait_compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fngcc_trait_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fngcc_trait_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fngcc_trait_compiler.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -90,4 +90,6 @@ class NoIncrementalBuild implements IncrementalBuild<any, any> {\n   priorTypeCheckingResultsFor(): null {\n     return null;\n   }\n+\n+  recordSuccessfulTypeCheck(): void {}\n }"
        },
        {
            "sha": "b2687e727d10a3660bfc15a2156f8e875a933ee9",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -22,7 +22,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/shims:api\",\n         \"//packages/compiler-cli/src/ngtsc/transform\",\n-        \"//packages/compiler-cli/src/ngtsc/typecheck\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\","
        },
        {
            "sha": "c2b5559f6ac317ecba2231d2973b799de4b084b9",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -21,7 +21,7 @@ import {EnumValue, PartialEvaluator} from '../../partial_evaluator';\n import {ClassDeclaration, Decorator, ReflectionHost, reflectObjectLiteral} from '../../reflection';\n import {ComponentScopeReader, LocalModuleScopeRegistry} from '../../scope';\n import {AnalysisOutput, CompileResult, DecoratorHandler, DetectResult, HandlerFlags, HandlerPrecedence, ResolveResult} from '../../transform';\n-import {TemplateSourceMapping, TypeCheckContext} from '../../typecheck';\n+import {TemplateSourceMapping, TypeCheckContext} from '../../typecheck/api';\n import {tsSourceMapBug29300Fixed} from '../../util/src/ts_source_map_bug_29300';\n import {SubsetOfKeys} from '../../util/src/typescript';\n \n@@ -426,10 +426,10 @@ export class ComponentDecoratorHandler implements\n       schemas = scope.schemas;\n     }\n \n-    const bound = new R3TargetBinder(matcher).bind({template: meta.template.diagNodes});\n+    const binder = new R3TargetBinder(matcher);\n     ctx.addTemplate(\n-        new Reference(node), bound, pipes, schemas, meta.template.sourceMapping,\n-        meta.template.file);\n+        new Reference(node), binder, meta.template.diagNodes, pipes, schemas,\n+        meta.template.sourceMapping, meta.template.file);\n   }\n \n   resolve(node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>):"
        },
        {
            "sha": "e6b2d8fe54465b29421dcc23be6bd4ce245ed359",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -33,6 +33,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/switch\",\n         \"//packages/compiler-cli/src/ngtsc/transform\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "6c63f028460c02b091a7dc03860e2a539fdb6b2c",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -13,7 +13,7 @@ import {ComponentDecoratorHandler, DirectiveDecoratorHandler, InjectableDecorato\n import {CycleAnalyzer, ImportGraph} from '../../cycles';\n import {ErrorCode, ngErrorCode} from '../../diagnostics';\n import {checkForPrivateExports, ReferenceGraph} from '../../entry_point';\n-import {getSourceFileOrError, LogicalFileSystem} from '../../file_system';\n+import {LogicalFileSystem} from '../../file_system';\n import {AbsoluteModuleStrategy, AliasingHost, AliasStrategy, DefaultImportTracker, ImportRewriter, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NoopImportRewriter, PrivateExportAliasingHost, R3SymbolsImportRewriter, Reference, ReferenceEmitStrategy, ReferenceEmitter, RelativePathStrategy, UnifiedModulesAliasingHost, UnifiedModulesStrategy} from '../../imports';\n import {IncrementalBuildStrategy, IncrementalDriver} from '../../incremental';\n import {generateAnalysis, IndexedComponent, IndexingContext} from '../../indexer';\n@@ -28,7 +28,8 @@ import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeRe\n import {generatedFactoryTransform} from '../../shims';\n import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n-import {isTemplateDiagnostic, TemplateTypeChecker, TypeCheckContext, TypeCheckingConfig, TypeCheckingProgramStrategy} from '../../typecheck';\n+import {isTemplateDiagnostic, TemplateTypeCheckerImpl} from '../../typecheck';\n+import {TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy} from '../../typecheck/api';\n import {getSourceFileOrNull, isDtsPath, resolveModuleName} from '../../util/src/typescript';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n \n@@ -209,6 +210,10 @@ export class NgCompiler {\n     return this.nextProgram;\n   }\n \n+  getTemplateTypeChecker(): TemplateTypeChecker {\n+    return this.ensureAnalyzed().templateTypeChecker;\n+  }\n+\n   /**\n    * Perform Angular's analysis step (as a precursor to `getDiagnostics` or `prepareEmit`)\n    * asynchronously.\n@@ -494,12 +499,6 @@ export class NgCompiler {\n \n     const compilation = this.ensureAnalyzed();\n \n-    // Execute the typeCheck phase of each decorator in the program.\n-    const prepSpan = this.perfRecorder.start('typeCheckPrep');\n-    const results = compilation.templateTypeChecker.refresh();\n-    this.incrementalDriver.recordSuccessfulTypeCheck(results.perFileData);\n-    this.perfRecorder.stop(prepSpan);\n-\n     // Get the diagnostics.\n     const typeCheckSpan = this.perfRecorder.start('typeCheckDiagnostics');\n     const diagnostics: ts.Diagnostic[] = [];\n@@ -734,7 +733,7 @@ export class NgCompiler {\n         handlers, reflector, this.perfRecorder, this.incrementalDriver,\n         this.options.compileNonExportedClasses !== false, dtsTransforms);\n \n-    const templateTypeChecker = new TemplateTypeChecker(\n+    const templateTypeChecker = new TemplateTypeCheckerImpl(\n         this.tsProgram, this.typeCheckingProgramStrategy, traitCompiler,\n         this.getTypeCheckingConfig(), refEmitter, reflector, this.adapter, this.incrementalDriver);\n "
        },
        {
            "sha": "cb4589494b69c40b32f926bcd3c0dda80ede1152",
            "filename": "packages/compiler-cli/src/ngtsc/core/test/compiler_test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Ftest%2Fcompiler_test.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -11,7 +11,7 @@ import * as ts from 'typescript';\n import {absoluteFrom as _, FileSystem, getFileSystem, getSourceFileOrError, NgtscCompilerHost, setFileSystem} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {NoopIncrementalBuildStrategy} from '../../incremental';\n-import {ReusedProgramStrategy} from '../../typecheck/src/augmented_program';\n+import {ReusedProgramStrategy} from '../../typecheck';\n import {NgCompilerOptions} from '../api';\n import {NgCompiler} from '../src/compiler';\n import {NgCompilerHost} from '../src/host';"
        },
        {
            "sha": "10a222e2bd2d6cbcbb63fb673f31f987c78d9b3f",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fapi.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -27,6 +27,12 @@ export interface IncrementalBuild<AnalysisT, FileTypeCheckDataT> {\n    * Retrieve the prior type-checking work, if any, that's been done for the given source file.\n    */\n   priorTypeCheckingResultsFor(fileSf: ts.SourceFile): FileTypeCheckDataT|null;\n+\n+  /**\n+   * Reports that template type-checking has completed successfully, with a map of type-checking\n+   * data for each user file which can be reused in a future incremental iteration.\n+   */\n+  recordSuccessfulTypeCheck(results: Map<AbsoluteFsPath, FileTypeCheckDataT>): void;\n }\n \n /**"
        },
        {
            "sha": "4f4803232e532cf7309cf62209111316e2c3ea38",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/noop.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fnoop.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fnoop.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fnoop.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -11,4 +11,5 @@ import {IncrementalBuild} from '../api';\n export const NOOP_INCREMENTAL_BUILD: IncrementalBuild<any, any> = {\n   priorWorkFor: () => null,\n   priorTypeCheckingResultsFor: () => null,\n+  recordSuccessfulTypeCheck: () => {},\n };"
        },
        {
            "sha": "dbcb93ef34275f4d488f9193dbba8137aa733b84",
            "filename": "packages/compiler-cli/src/ngtsc/incremental/src/state.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fincremental%2Fsrc%2Fstate.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -10,7 +10,7 @@ import * as ts from 'typescript';\n \n import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {ClassRecord, TraitCompiler} from '../../transform';\n-import {FileTypeCheckingData} from '../../typecheck/src/context';\n+import {FileTypeCheckingData} from '../../typecheck/src/checker';\n import {IncrementalBuild} from '../api';\n \n import {FileDependencyGraph} from './dependency_tracking';"
        },
        {
            "sha": "2f118839536bd6561fd99c0faf93b43e7f6209f0",
            "filename": "packages/compiler-cli/src/ngtsc/program.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fprogram.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -28,7 +28,7 @@ import {ReusedProgramStrategy} from './typecheck';\n  * command-line main() function or the Angular CLI.\n  */\n export class NgtscProgram implements api.Program {\n-  private compiler: NgCompiler;\n+  readonly compiler: NgCompiler;\n \n   /**\n    * The primary TypeScript program, which is used for analysis and emit."
        },
        {
            "sha": "2662e5b47ff2973fecc400449cc53c70ea40bec0",
            "filename": "packages/compiler-cli/src/ngtsc/scope/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fscope%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -13,7 +13,6 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/imports\",\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n-        \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "ea7ca9453afa74924e9d07cba7503925c1ec6ace",
            "filename": "packages/compiler-cli/src/ngtsc/transform/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -18,7 +18,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/perf\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n-        \"//packages/compiler-cli/src/ngtsc/typecheck\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "d6651f5c444f0d228e6b9fae489cab8c533fd70b",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/api.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -13,7 +13,7 @@ import {Reexport} from '../../imports';\n import {IndexingContext} from '../../indexer';\n import {ClassDeclaration, Decorator} from '../../reflection';\n import {ImportManager} from '../../translator';\n-import {TypeCheckContext} from '../../typecheck';\n+import {TypeCheckContext} from '../../typecheck/api';\n \n export enum HandlerPrecedence {\n   /**"
        },
        {
            "sha": "812fdfabb7476c47c30eb3ffaa965165c6c5444b",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/compilation.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -14,7 +14,7 @@ import {IncrementalBuild} from '../../incremental/api';\n import {IndexingContext} from '../../indexer';\n import {PerfRecorder} from '../../perf';\n import {ClassDeclaration, Decorator, ReflectionHost} from '../../reflection';\n-import {ProgramTypeCheckAdapter, TypeCheckContext} from '../../typecheck';\n+import {ProgramTypeCheckAdapter, TypeCheckContext} from '../../typecheck/api';\n import {getSourceFile, isExported} from '../../util/src/typescript';\n \n import {AnalysisOutput, CompileResult, DecoratorHandler, HandlerFlags, HandlerPrecedence, ResolveResult} from './api';"
        },
        {
            "sha": "9676cb540f0bccaa7aa6e3543bd38698217ece08",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/BUILD.bazel",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -4,7 +4,9 @@ package(default_visibility = [\"//visibility:public\"])\n \n ts_library(\n     name = \"typecheck\",\n-    srcs = glob([\"**/*.ts\"]),\n+    srcs = glob(\n+        [\"**/*.ts\"],\n+    ),\n     deps = [\n         \"//packages:types\",\n         \"//packages/compiler\",\n@@ -17,6 +19,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/shims:api\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\","
        },
        {
            "sha": "aa34cc2d9502cc22d1a5164df88ce3f20c25a981",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/BUILD.bazel",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -0,0 +1,18 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"api\",\n+    srcs = glob([\"**/*.ts\"]),\n+    module_name = \"@angular/compiler-cli/src/ngtsc/typecheck/api\",\n+    deps = [\n+        \"//packages:types\",\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/imports\",\n+        \"//packages/compiler-cli/src/ngtsc/metadata\",\n+        \"//packages/compiler-cli/src/ngtsc/reflection\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "cc674c33c53d90b794be18f8cd7d4fb14c7fa79f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/api.ts",
            "status": "renamed",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -13,7 +13,6 @@ import {AbsoluteFsPath} from '../../file_system';\n import {Reference} from '../../imports';\n import {TemplateGuardMeta} from '../../metadata';\n import {ClassDeclaration} from '../../reflection';\n-import {ComponentToShimMappingStrategy} from './context';\n \n \n /**\n@@ -278,6 +277,25 @@ export interface ExternalTemplateSourceMapping {\n   templateUrl: string;\n }\n \n+/**\n+ * Abstracts the operation of determining which shim file will host a particular component's\n+ * template type-checking code.\n+ *\n+ * Different consumers of the type checking infrastructure may choose different approaches to\n+ * optimize for their specific use case (for example, the command-line compiler optimizes for\n+ * efficient `ts.Program` reuse in watch mode).\n+ */\n+export interface ComponentToShimMappingStrategy {\n+  /**\n+   * Given a component, determine a path to the shim file into which that component's type checking\n+   * code will be generated.\n+   *\n+   * A major constraint is that components in different input files must not share the same shim\n+   * file. The behavior of the template type-checking system is undefined if this is violated.\n+   */\n+  shimPathForComponent(node: ts.ClassDeclaration): AbsoluteFsPath;\n+}\n+\n /**\n  * Strategy used to manage a `ts.Program` which contains template type-checking code and update it\n  * over time.",
            "previous_filename": "packages/compiler-cli/src/ngtsc/typecheck/src/api.ts"
        },
        {
            "sha": "47a3646b861026cb84c35bba1684470c009792b4",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -0,0 +1,43 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {TmplAstNode} from '@angular/compiler';\n+\n+import * as ts from 'typescript';\n+\n+/**\n+ * Interface to the Angular Template Type Checker to extract diagnostics and intelligence from the\n+ * compiler's understanding of component templates.\n+ *\n+ * This interface is analogous to TypeScript's own `ts.TypeChecker` API.\n+ *\n+ * In general, this interface supports two kinds of operations:\n+ *  - updating Type Check Blocks (TCB)s that capture the template in the form of TypeScript code\n+ *  - querying information about available TCBs, including diagnostics\n+ *\n+ * Once a TCB is available, information about it can be queried. If no TCB is available to answer a\n+ * query, depending on the method either `null` will be returned or an error will be thrown.\n+ */\n+export interface TemplateTypeChecker {\n+  /**\n+   * Get all `ts.Diagnostic`s currently available for the given `ts.SourceFile`.\n+   *\n+   * This method will fail (throw) if there are components within the `ts.SourceFile` that do not\n+   * have TCBs available.\n+   */\n+  getDiagnosticsForFile(sf: ts.SourceFile): ts.Diagnostic[];\n+\n+  /**\n+   * Retrieve the top-level node representing the TCB for the given component.\n+   *\n+   * This can return `null` if there is no TCB available for the component.\n+   *\n+   * This method always runs in `OptimizeFor.SingleFile` mode.\n+   */\n+  getTypeCheckBlock(component: ts.ClassDeclaration): ts.Node|null;\n+}"
        },
        {
            "sha": "9895075cd4df9e1a8fa55691a51c0be31851b8d6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/context.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcontext.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -0,0 +1,52 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n+import * as ts from 'typescript';\n+\n+import {Reference} from '../../imports';\n+import {ClassDeclaration} from '../../reflection';\n+\n+import {TemplateSourceMapping, TypeCheckableDirectiveMeta} from './api';\n+\n+/**\n+ * A currently pending type checking operation, into which templates for type-checking can be\n+ * registered.\n+ */\n+export interface TypeCheckContext {\n+  /**\n+   * Register a template to potentially be type-checked.\n+   *\n+   * Templates registered via `addTemplate` are available for checking, but might be skipped if\n+   * checking of that component is not required. This can happen for a few reasons, including if\n+   * the component was previously checked and the prior results are still valid.\n+   *\n+   * @param ref a `Reference` to the component class which yielded this template.\n+   * @param binder an `R3TargetBinder` which encapsulates the scope of this template, including all\n+   * available directives.\n+   * @param template the original template AST of this component.\n+   * @param pipes a `Map` of pipes available within the scope of this template.\n+   * @param schemas any schemas which apply to this template.\n+   * @param sourceMapping a `TemplateSourceMapping` instance which describes the origin of the\n+   * template text described by the AST.\n+   * @param file the `ParseSourceFile` associated with the template.\n+   */\n+  addTemplate(\n+      ref: Reference<ClassDeclaration<ts.ClassDeclaration>>,\n+      binder: R3TargetBinder<TypeCheckableDirectiveMeta>, template: TmplAstNode[],\n+      pipes: Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>,\n+      schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping, file: ParseSourceFile): void;\n+}\n+\n+/**\n+ * Interface to trigger generation of type-checking code for a program given a new\n+ * `TypeCheckContext`.\n+ */\n+export interface ProgramTypeCheckAdapter {\n+  typeCheck(sf: ts.SourceFile, ctx: TypeCheckContext): void;\n+}"
        },
        {
            "sha": "5a59d80402113d0f397b413f09dc3a1c6adf75e3",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/index.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Findex.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './api';\n+export * from './checker';\n+export * from './context';"
        },
        {
            "sha": "6c81aae86609fbbd4daa25fd91a4d98b33f6fee6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -6,11 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-export * from './src/api';\n export {ReusedProgramStrategy} from './src/augmented_program';\n-export {TemplateTypeChecker, ProgramTypeCheckAdapter} from './src/checker';\n-export {TypeCheckContext} from './src/context';\n-export {TemplateDiagnostic, isTemplateDiagnostic} from './src/diagnostics';\n-export {TypeCheckShimGenerator} from './src/shim';\n+export {FileTypeCheckingData, TemplateTypeCheckerImpl} from './src/checker';\n+export {TypeCheckContextImpl} from './src/context';\n+export {isTemplateDiagnostic, TemplateDiagnostic} from './src/diagnostics';\n export {TypeCheckProgramHost} from './src/host';\n+export {TypeCheckShimGenerator} from './src/shim';\n export {typeCheckFilePath} from './src/type_check_file';"
        },
        {
            "sha": "b2c6f535ca90a08aecc8d75d37f01703908f7bf9",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/augmented_program.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -10,8 +10,8 @@ import * as ts from 'typescript';\n \n import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {retagAllTsFiles, untagAllTsFiles} from '../../shims';\n+import {TypeCheckingProgramStrategy, UpdateMode} from '../api';\n \n-import {TypeCheckingProgramStrategy, UpdateMode} from './api';\n import {TypeCheckProgramHost} from './host';\n import {TypeCheckShimGenerator} from './shim';\n "
        },
        {
            "sha": "e4cdac6f266f998ea2b608bedab920916f4ca1d7",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 181,
            "deletions": 58,
            "changes": 239,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -13,99 +13,160 @@ import {ReferenceEmitter} from '../../imports';\n import {IncrementalBuild} from '../../incremental/api';\n import {ReflectionHost} from '../../reflection';\n import {isShim} from '../../shims';\n+import {getSourceFileOrNull} from '../../util/src/typescript';\n+import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n \n-import {TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from './api';\n-import {FileTypeCheckingData, TypeCheckContext, TypeCheckRequest} from './context';\n-import {shouldReportDiagnostic, TemplateSourceResolver, translateDiagnostic} from './diagnostics';\n-\n-/**\n- * Interface to trigger generation of type-checking code for a program given a new\n- * `TypeCheckContext`.\n- */\n-export interface ProgramTypeCheckAdapter {\n-  typeCheck(sf: ts.SourceFile, ctx: TypeCheckContext): void;\n-}\n+import {ShimTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from './context';\n+import {findTypeCheckBlock, shouldReportDiagnostic, TemplateSourceResolver, translateDiagnostic} from './diagnostics';\n+import {TemplateSourceManager} from './source';\n \n /**\n  * Primary template type-checking engine, which performs type-checking using a\n  * `TypeCheckingProgramStrategy` for type-checking program maintenance, and the\n  * `ProgramTypeCheckAdapter` for generation of template type-checking code.\n  */\n-export class TemplateTypeChecker {\n-  private files = new Map<AbsoluteFsPath, FileTypeCheckingData>();\n+export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n+  private state = new Map<AbsoluteFsPath, FileTypeCheckingData>();\n+  private isComplete = false;\n \n   constructor(\n       private originalProgram: ts.Program,\n-      private typeCheckingStrategy: TypeCheckingProgramStrategy,\n+      readonly typeCheckingStrategy: TypeCheckingProgramStrategy,\n       private typeCheckAdapter: ProgramTypeCheckAdapter, private config: TypeCheckingConfig,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n       private priorBuild: IncrementalBuild<unknown, FileTypeCheckingData>) {}\n \n-  /**\n-   * Reset the internal type-checking program by generating type-checking code from the user's\n-   * program.\n-   */\n-  refresh(): TypeCheckRequest {\n-    this.files.clear();\n-\n-    const ctx = new TypeCheckContext(\n-        this.config, this.compilerHost, this.typeCheckingStrategy, this.refEmitter, this.reflector);\n-\n-    // Typecheck all the files.\n-    for (const sf of this.originalProgram.getSourceFiles()) {\n-      if (sf.isDeclarationFile || isShim(sf)) {\n-        continue;\n-      }\n-\n-      const previousResults = this.priorBuild.priorTypeCheckingResultsFor(sf);\n-      if (previousResults === null) {\n-        // Previous results were not available, so generate new type-checking code for this file.\n-        this.typeCheckAdapter.typeCheck(sf, ctx);\n-      } else {\n-        // Previous results were available, and can be adopted into the current build.\n-        ctx.adoptPriorResults(sf, previousResults);\n-      }\n-    }\n-\n-    const results = ctx.finalize();\n-    this.typeCheckingStrategy.updateFiles(results.updates, UpdateMode.Complete);\n-    for (const [file, fileData] of results.perFileData) {\n-      this.files.set(file, fileData);\n-    }\n-\n-    return results;\n-  }\n-\n   /**\n    * Retrieve type-checking diagnostics from the given `ts.SourceFile` using the most recent\n    * type-checking program.\n    */\n   getDiagnosticsForFile(sf: ts.SourceFile): ts.Diagnostic[] {\n-    const path = absoluteFromSourceFile(sf);\n-    if (!this.files.has(path)) {\n-      return [];\n-    }\n-    const fileRecord = this.files.get(path)!;\n+    this.ensureAllShimsForAllFiles();\n+\n+    const sfPath = absoluteFromSourceFile(sf);\n+    const fileRecord = this.state.get(sfPath)!;\n \n     const typeCheckProgram = this.typeCheckingStrategy.getProgram();\n \n     const diagnostics: (ts.Diagnostic|null)[] = [];\n     if (fileRecord.hasInlines) {\n-      const inlineSf = getSourceFileOrError(typeCheckProgram, path);\n+      const inlineSf = getSourceFileOrError(typeCheckProgram, sfPath);\n       diagnostics.push(...typeCheckProgram.getSemanticDiagnostics(inlineSf).map(\n-          diag => convertDiagnostic(diag, fileRecord.sourceResolver)));\n+          diag => convertDiagnostic(diag, fileRecord.sourceManager)));\n     }\n+\n     for (const [shimPath, shimRecord] of fileRecord.shimData) {\n       const shimSf = getSourceFileOrError(typeCheckProgram, shimPath);\n-\n       diagnostics.push(...typeCheckProgram.getSemanticDiagnostics(shimSf).map(\n-          diag => convertDiagnostic(diag, fileRecord.sourceResolver)));\n+          diag => convertDiagnostic(diag, fileRecord.sourceManager)));\n       diagnostics.push(...shimRecord.genesisDiagnostics);\n     }\n \n+\n     return diagnostics.filter((diag: ts.Diagnostic|null): diag is ts.Diagnostic => diag !== null);\n   }\n+\n+  getTypeCheckBlock(component: ts.ClassDeclaration): ts.Node|null {\n+    this.ensureAllShimsForAllFiles();\n+\n+    const program = this.typeCheckingStrategy.getProgram();\n+    const filePath = absoluteFromSourceFile(component.getSourceFile());\n+    const shimPath = this.typeCheckingStrategy.shimPathForComponent(component);\n+\n+    if (!this.state.has(filePath)) {\n+      throw new Error(`Error: no data for source file: ${filePath}`);\n+    }\n+    const fileRecord = this.state.get(filePath)!;\n+    const id = fileRecord.sourceManager.getTemplateId(component);\n+\n+    const shimSf = getSourceFileOrNull(program, shimPath);\n+    if (shimSf === null) {\n+      throw new Error(`Error: no shim file in program: ${shimPath}`);\n+    }\n+\n+    let node: ts.Node|null = findTypeCheckBlock(shimSf, id);\n+    if (node === null) {\n+      // Try for an inline block.\n+      const inlineSf = getSourceFileOrError(program, filePath);\n+      node = findTypeCheckBlock(inlineSf, id);\n+    }\n+\n+    return node;\n+  }\n+\n+  private maybeAdoptPriorResultsForFile(sf: ts.SourceFile): void {\n+    const sfPath = absoluteFromSourceFile(sf);\n+    if (this.state.has(sfPath)) {\n+      const existingResults = this.state.get(sfPath)!;\n+\n+      if (existingResults.isComplete) {\n+        // All data for this file has already been generated, so no need to adopt anything.\n+        return;\n+      }\n+    }\n+\n+    const previousResults = this.priorBuild.priorTypeCheckingResultsFor(sf);\n+    if (previousResults === null || !previousResults.isComplete) {\n+      return;\n+    }\n+\n+    this.state.set(sfPath, previousResults);\n+  }\n+\n+  private ensureAllShimsForAllFiles(): void {\n+    if (this.isComplete) {\n+      return;\n+    }\n+\n+    const host = new WholeProgramTypeCheckingHost(this);\n+    const ctx = this.newContext(host);\n+\n+    for (const sf of this.originalProgram.getSourceFiles()) {\n+      if (sf.isDeclarationFile || isShim(sf)) {\n+        continue;\n+      }\n+\n+      this.maybeAdoptPriorResultsForFile(sf);\n+\n+      const sfPath = absoluteFromSourceFile(sf);\n+      const fileData = this.getFileData(sfPath);\n+      if (fileData.isComplete) {\n+        continue;\n+      }\n+\n+      this.typeCheckAdapter.typeCheck(sf, ctx);\n+\n+      fileData.isComplete = true;\n+    }\n+\n+    this.updateFromContext(ctx);\n+    this.isComplete = true;\n+  }\n+\n+  private newContext(host: TypeCheckingHost): TypeCheckContextImpl {\n+    return new TypeCheckContextImpl(\n+        this.config, this.compilerHost, this.typeCheckingStrategy, this.refEmitter, this.reflector,\n+        host);\n+  }\n+\n+  private updateFromContext(ctx: TypeCheckContextImpl): void {\n+    const updates = ctx.finalize();\n+    this.typeCheckingStrategy.updateFiles(updates, UpdateMode.Incremental);\n+    this.priorBuild.recordSuccessfulTypeCheck(this.state);\n+  }\n+\n+  getFileData(path: AbsoluteFsPath): FileTypeCheckingData {\n+    if (!this.state.has(path)) {\n+      this.state.set(path, {\n+        hasInlines: false,\n+        sourceManager: new TemplateSourceManager(),\n+        isComplete: false,\n+        shimData: new Map(),\n+      });\n+    }\n+    return this.state.get(path)!;\n+  }\n }\n \n function convertDiagnostic(\n@@ -115,3 +176,65 @@ function convertDiagnostic(\n   }\n   return translateDiagnostic(diag, sourceResolver);\n }\n+\n+/**\n+ * Data for template type-checking related to a specific input file in the user's program (which\n+ * contains components to be checked).\n+ */\n+export interface FileTypeCheckingData {\n+  /**\n+   * Whether the type-checking shim required any inline changes to the original file, which affects\n+   * whether the shim can be reused.\n+   */\n+  hasInlines: boolean;\n+\n+  /**\n+   * Source mapping information for mapping diagnostics from inlined type check blocks back to the\n+   * original template.\n+   */\n+  sourceManager: TemplateSourceManager;\n+\n+  /**\n+   * Data for each shim generated from this input file.\n+   *\n+   * A single input file will generate one or more shim files that actually contain template\n+   * type-checking code.\n+   */\n+  shimData: Map<AbsoluteFsPath, ShimTypeCheckingData>;\n+\n+  /**\n+   * Whether the template type-checker is certain that all components from this input file have had\n+   * type-checking code generated into shims.\n+   */\n+  isComplete: boolean;\n+}\n+\n+/**\n+ * Drives a `TypeCheckContext` to generate type-checking code for every component in the program.\n+ */\n+class WholeProgramTypeCheckingHost implements TypeCheckingHost {\n+  constructor(private impl: TemplateTypeCheckerImpl) {}\n+\n+  getSourceManager(sfPath: AbsoluteFsPath): TemplateSourceManager {\n+    return this.impl.getFileData(sfPath).sourceManager;\n+  }\n+\n+  shouldCheckComponent(node: ts.ClassDeclaration): boolean {\n+    const fileData = this.impl.getFileData(absoluteFromSourceFile(node.getSourceFile()));\n+    const shimPath = this.impl.typeCheckingStrategy.shimPathForComponent(node);\n+    // The component needs to be checked unless the shim which would contain it already exists.\n+    return !fileData.shimData.has(shimPath);\n+  }\n+\n+  recordShimData(sfPath: AbsoluteFsPath, data: ShimTypeCheckingData): void {\n+    const fileData = this.impl.getFileData(sfPath);\n+    fileData.shimData.set(data.path, data);\n+    if (data.hasInlines) {\n+      fileData.hasInlines = true;\n+    }\n+  }\n+\n+  recordComplete(sfPath: AbsoluteFsPath): void {\n+    this.impl.getFileData(sfPath).isComplete = true;\n+  }\n+}"
        },
        {
            "sha": "7e92d49a4e8bd10ca915ecf41aa415ffba25e0ff",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 107,
            "changes": 157,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -6,16 +6,15 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {BoundTarget, ParseSourceFile, SchemaMetadata} from '@angular/compiler';\n+import {ParseSourceFile, R3TargetBinder, SchemaMetadata, TmplAstNode} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {absoluteFromSourceFile, AbsoluteFsPath} from '../../file_system';\n import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n+import {ComponentToShimMappingStrategy, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n \n-import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, TypeCtorMetadata} from './api';\n-import {TemplateSourceResolver} from './diagnostics';\n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n import {Environment} from './environment';\n import {OutOfBandDiagnosticRecorder, OutOfBandDiagnosticRecorderImpl} from './oob';\n@@ -24,55 +23,6 @@ import {generateTypeCheckBlock, requiresInlineTypeCheckBlock} from './type_check\n import {TypeCheckFile} from './type_check_file';\n import {generateInlineTypeCtor, requiresInlineTypeCtor} from './type_constructor';\n \n-/**\n- * Complete type-checking code generated for the user's program, ready for input into the\n- * type-checking engine.\n- */\n-export interface TypeCheckRequest {\n-  /**\n-   * Map of source filenames to new contents for those files.\n-   *\n-   * This includes both contents of type-checking shim files, as well as changes to any user files\n-   * which needed to be made to support template type-checking.\n-   */\n-  updates: Map<AbsoluteFsPath, string>;\n-\n-  /**\n-   * Map containing additional data for each type-checking shim that is required to support\n-   * generation of diagnostics.\n-   */\n-  perFileData: Map<AbsoluteFsPath, FileTypeCheckingData>;\n-}\n-\n-/**\n- * Data for template type-checking related to a specific input file in the user's program (which\n- * contains components to be checked).\n- */\n-export interface FileTypeCheckingData {\n-  /**\n-   * Whether the type-checking shim required any inline changes to the original file, which affects\n-   * whether the shim can be reused.\n-   */\n-  hasInlines: boolean;\n-\n-  /**\n-   * Source mapping information for mapping diagnostics from inlined type check blocks back to the\n-   * original template.\n-   */\n-  sourceResolver: TemplateSourceResolver;\n-\n-  /**\n-   * Data for each shim generated from this input file.\n-   *\n-   * A single input file will generate one or more shim files that actually contain template\n-   * type-checking code.\n-   */\n-  shimData: Map<AbsoluteFsPath, ShimTypeCheckingData>;\n-}\n-\n-/**\n- * Data specific to a single shim generated from an input file.\n- */\n export interface ShimTypeCheckingData {\n   /**\n    * Path to the shim file.\n@@ -85,6 +35,11 @@ export interface ShimTypeCheckingData {\n    * Some diagnostics are produced during creation time and are tracked here.\n    */\n   genesisDiagnostics: ts.Diagnostic[];\n+\n+  /**\n+   * Whether any inline operations for the input file were required to generate this shim.\n+   */\n+  hasInlines: boolean;\n }\n \n /**\n@@ -126,38 +81,55 @@ export interface PendingShimData {\n }\n \n /**\n- * Abstracts the operation of determining which shim file will host a particular component's\n- * template type-checking code.\n+ * Adapts the `TypeCheckContextImpl` to the larger template type-checking system.\n  *\n- * Different consumers of the type checking infrastructure may choose different approaches to\n- * optimize for their specific use case (for example, the command-line compiler optimizes for\n- * efficient `ts.Program` reuse in watch mode).\n+ * Through this interface, a single `TypeCheckContextImpl` (which represents one \"pass\" of template\n+ * type-checking) requests information about the larger state of type-checking, as well as reports\n+ * back its results once finalized.\n  */\n-export interface ComponentToShimMappingStrategy {\n+export interface TypeCheckingHost {\n   /**\n-   * Given a component, determine a path to the shim file into which that component's type checking\n-   * code will be generated.\n+   * Retrieve the `TemplateSourceManager` responsible for components in the given input file path.\n+   */\n+  getSourceManager(sfPath: AbsoluteFsPath): TemplateSourceManager;\n+\n+  /**\n+   * Whether a particular component class should be included in the current type-checking pass.\n    *\n-   * A major constraint is that components in different input files must not share the same shim\n-   * file. The behavior of the template type-checking system is undefined if this is violated.\n+   * Not all components offered to the `TypeCheckContext` for checking may require processing. For\n+   * example, the component may have results already available from a prior pass or from a previous\n+   * program.\n+   */\n+  shouldCheckComponent(node: ts.ClassDeclaration): boolean;\n+\n+  /**\n+   * Report data from a shim generated from the given input file path.\n+   */\n+  recordShimData(sfPath: AbsoluteFsPath, data: ShimTypeCheckingData): void;\n+\n+  /**\n+   * Record that all of the components within the given input file path had code generated - that\n+   * is, coverage for the file can be considered complete.\n    */\n-  shimPathForComponent(node: ts.ClassDeclaration): AbsoluteFsPath;\n+  recordComplete(sfPath: AbsoluteFsPath): void;\n }\n \n+\n /**\n  * A template type checking context for a program.\n  *\n  * The `TypeCheckContext` allows registration of components and their templates which need to be\n  * type checked.\n  */\n-export class TypeCheckContext {\n+export class TypeCheckContextImpl implements TypeCheckContext {\n   private fileMap = new Map<AbsoluteFsPath, PendingFileTypeCheckingData>();\n \n   constructor(\n       private config: TypeCheckingConfig,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n       private componentMappingStrategy: ComponentToShimMappingStrategy,\n-      private refEmitter: ReferenceEmitter, private reflector: ReflectionHost) {}\n+      private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n+      private host: TypeCheckingHost) {}\n \n   /**\n    * A `Map` of `ts.SourceFile`s that the context has seen to the operations (additions of methods\n@@ -171,22 +143,6 @@ export class TypeCheckContext {\n    */\n   private typeCtorPending = new Set<ts.ClassDeclaration>();\n \n-  /**\n-   * Map of data for file paths which was adopted from a prior compilation.\n-   *\n-   * This data allows the `TypeCheckContext` to generate a `TypeCheckRequest` which can interpret\n-   * diagnostics from type-checking shims included in the prior compilation.\n-   */\n-  private adoptedFiles = new Map<AbsoluteFsPath, FileTypeCheckingData>();\n-\n-  /**\n-   * Record the `FileTypeCheckingData` from a previous program that's associated with a particular\n-   * source file.\n-   */\n-  adoptPriorResults(sf: ts.SourceFile, data: FileTypeCheckingData): void {\n-    this.adoptedFiles.set(absoluteFromSourceFile(sf), data);\n-  }\n-\n   /**\n    * Record a template for the given component `node`, with a `SelectorMatcher` for directive\n    * matching.\n@@ -197,12 +153,17 @@ export class TypeCheckContext {\n    */\n   addTemplate(\n       ref: Reference<ClassDeclaration<ts.ClassDeclaration>>,\n-      boundTarget: BoundTarget<TypeCheckableDirectiveMeta>,\n+      binder: R3TargetBinder<TypeCheckableDirectiveMeta>, template: TmplAstNode[],\n       pipes: Map<string, Reference<ClassDeclaration<ts.ClassDeclaration>>>,\n       schemas: SchemaMetadata[], sourceMapping: TemplateSourceMapping,\n       file: ParseSourceFile): void {\n+    if (!this.host.shouldCheckComponent(ref.node)) {\n+      return;\n+    }\n+\n     const fileData = this.dataForFile(ref.node.getSourceFile());\n     const shimData = this.pendingShimForComponent(ref.node);\n+    const boundTarget = binder.bind({template});\n     // Get all of the directives used in the template and record type constructors for all of them.\n     for (const dir of boundTarget.getUsedDirectives()) {\n       const dirRef = dir.ref as Reference<ClassDeclaration<ts.ClassDeclaration>>;\n@@ -308,7 +269,7 @@ export class TypeCheckContext {\n     return code;\n   }\n \n-  finalize(): TypeCheckRequest {\n+  finalize(): Map<AbsoluteFsPath, string> {\n     // First, build the map of updates to source files.\n     const updates = new Map<AbsoluteFsPath, string>();\n     for (const originalSf of this.opMap.keys()) {\n@@ -318,39 +279,23 @@ export class TypeCheckContext {\n       }\n     }\n \n-    const results: TypeCheckRequest = {\n-      updates: updates,\n-      perFileData: new Map<AbsoluteFsPath, FileTypeCheckingData>(),\n-    };\n-\n     // Then go through each input file that has pending code generation operations.\n     for (const [sfPath, pendingFileData] of this.fileMap) {\n-      const fileData: FileTypeCheckingData = {\n-        hasInlines: pendingFileData.hasInlines,\n-        shimData: new Map(),\n-        sourceResolver: pendingFileData.sourceManager,\n-      };\n-\n       // For each input file, consider generation operations for each of its shims.\n-      for (const [shimPath, pendingShimData] of pendingFileData.shimData) {\n-        updates.set(pendingShimData.file.fileName, pendingShimData.file.render());\n-        fileData.shimData.set(shimPath, {\n+      for (const pendingShimData of pendingFileData.shimData.values()) {\n+        this.host.recordShimData(sfPath, {\n           genesisDiagnostics: [\n             ...pendingShimData.domSchemaChecker.diagnostics,\n             ...pendingShimData.oobRecorder.diagnostics,\n           ],\n+          hasInlines: pendingFileData.hasInlines,\n           path: pendingShimData.file.fileName,\n         });\n+        updates.set(pendingShimData.file.fileName, pendingShimData.file.render());\n       }\n-\n-      results.perFileData.set(sfPath, fileData);\n-    }\n-\n-    for (const [sfPath, fileData] of this.adoptedFiles.entries()) {\n-      results.perFileData.set(sfPath, fileData);\n     }\n \n-    return results;\n+    return updates;\n   }\n \n   private addInlineTypeCheckBlock(\n@@ -385,12 +330,10 @@ export class TypeCheckContext {\n   private dataForFile(sf: ts.SourceFile): PendingFileTypeCheckingData {\n     const sfPath = absoluteFromSourceFile(sf);\n \n-    const sourceManager = new TemplateSourceManager();\n-\n     if (!this.fileMap.has(sfPath)) {\n       const data: PendingFileTypeCheckingData = {\n         hasInlines: false,\n-        sourceManager,\n+        sourceManager: this.host.getSourceManager(sfPath),\n         shimData: new Map(),\n       };\n       this.fileMap.set(sfPath, data);"
        },
        {
            "sha": "584dabd98488c0d5f5e2bcdc6255e23e1fb5e472",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/diagnostics.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -9,8 +9,8 @@ import {AbsoluteSourceSpan, ParseSourceSpan} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {getTokenAtPosition} from '../../util/src/typescript';\n+import {ExternalTemplateSourceMapping, TemplateId, TemplateSourceMapping} from '../api';\n \n-import {ExternalTemplateSourceMapping, TemplateId, TemplateSourceMapping} from './api';\n \n /**\n  * A `ts.Diagnostic` with additional information about the diagnostic related to template\n@@ -28,6 +28,8 @@ export interface TemplateDiagnostic extends ts.Diagnostic {\n  * in a TCB and map them back to original locations in the template.\n  */\n export interface TemplateSourceResolver {\n+  getTemplateId(node: ts.ClassDeclaration): TemplateId;\n+\n   /**\n    * For the given template id, retrieve the original source mapping which describes how the offsets\n    * in the template should be interpreted.\n@@ -140,6 +142,15 @@ export function translateDiagnostic(\n       mapping, span, diagnostic.category, diagnostic.code, diagnostic.messageText);\n }\n \n+export function findTypeCheckBlock(file: ts.SourceFile, id: TemplateId): ts.Node|null {\n+  for (const stmt of file.statements) {\n+    if (ts.isFunctionDeclaration(stmt) && getTemplateId(stmt, file) === id) {\n+      return stmt;\n+    }\n+  }\n+  return null;\n+}\n+\n /**\n  * Constructs a `ts.Diagnostic` for a given `ParseSourceSpan` within a template.\n  */"
        },
        {
            "sha": "3a4f43af3a0ebe10e4834b7f9539e27e5f1365a6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/dom.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -10,8 +10,8 @@ import {DomElementSchemaRegistry, ParseSourceSpan, SchemaMetadata, TmplAstElemen\n import * as ts from 'typescript';\n \n import {ErrorCode, ngErrorCode} from '../../diagnostics';\n+import {TemplateId} from '../api';\n \n-import {TemplateId} from './api';\n import {makeTemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n \n const REGISTRY = new DomElementSchemaRegistry();"
        },
        {
            "sha": "e0d8bb1905e7714fb813eda1176b13046ec55f9d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/environment.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fenvironment.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fenvironment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fenvironment.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -12,8 +12,8 @@ import * as ts from 'typescript';\n import {ImportFlags, NOOP_DEFAULT_IMPORT_RECORDER, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager, translateExpression, translateType} from '../../translator';\n+import {TypeCheckableDirectiveMeta, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n \n-import {TypeCheckableDirectiveMeta, TypeCheckingConfig, TypeCtorMetadata} from './api';\n import {tsDeclareVariable} from './ts_util';\n import {generateTypeCtorDeclarationFn, requiresInlineTypeCtor} from './type_constructor';\n import {TypeParameterEmitter} from './type_parameter_emitter';"
        },
        {
            "sha": "e068cecb87f0561da492242bc7221252cc254f1b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/expression.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fexpression.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -8,8 +8,8 @@\n \n import {AST, AstVisitor, ASTWithSource, Binary, BindingPipe, Chain, Conditional, EmptyExpr, FunctionCall, ImplicitReceiver, Interpolation, KeyedRead, KeyedWrite, LiteralArray, LiteralMap, LiteralPrimitive, MethodCall, NonNullAssert, PrefixNot, PropertyRead, PropertyWrite, Quote, SafeMethodCall, SafePropertyRead} from '@angular/compiler';\n import * as ts from 'typescript';\n+import {TypeCheckingConfig} from '../api';\n \n-import {TypeCheckingConfig} from './api';\n import {addParseSpanInfo, wrapForDiagnostics} from './diagnostics';\n import {tsCastToAny} from './ts_util';\n "
        },
        {
            "sha": "77b0807f5061338e9a45fb8869efe9f92549b08c",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/oob.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -10,8 +10,8 @@ import {BindingPipe, PropertyWrite, TmplAstReference, TmplAstVariable} from '@an\n import * as ts from 'typescript';\n \n import {ErrorCode, ngErrorCode} from '../../diagnostics';\n+import {TemplateId} from '../api';\n \n-import {TemplateId} from './api';\n import {makeTemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n \n "
        },
        {
            "sha": "2401cc8aae4573d2677077890643bf90b53d9cc1",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/source.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -8,8 +8,8 @@\n \n import {AbsoluteSourceSpan, ParseLocation, ParseSourceFile, ParseSourceSpan} from '@angular/compiler';\n import * as ts from 'typescript';\n+import {TemplateId, TemplateSourceMapping} from '../api';\n \n-import {TemplateId, TemplateSourceMapping} from './api';\n import {TemplateSourceResolver} from './diagnostics';\n import {computeLineStartsMap, getLineAndCharacterFromPosition} from './line_mappings';\n \n@@ -55,6 +55,10 @@ export class TemplateSourceManager implements TemplateSourceResolver {\n    */\n   private templateSources = new Map<TemplateId, TemplateSource>();\n \n+  getTemplateId(node: ts.ClassDeclaration): TemplateId {\n+    return getTemplateId(node);\n+  }\n+\n   captureSource(node: ts.ClassDeclaration, mapping: TemplateSourceMapping, file: ParseSourceFile):\n       TemplateId {\n     const id = getTemplateId(node);"
        },
        {
            "sha": "d51a075bd0c2f0d9bdda0eff0182ad48755e1b62",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_semantics.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_semantics.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_semantics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_semantics.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -8,7 +8,8 @@\n \n import {AST, BoundTarget, ImplicitReceiver, PropertyWrite, RecursiveAstVisitor, TmplAstVariable} from '@angular/compiler';\n \n-import {TemplateId} from './api';\n+import {TemplateId} from '../api';\n+\n import {OutOfBandDiagnosticRecorder} from './oob';\n \n /**"
        },
        {
            "sha": "014ff17e02dc06ee914873c2380b485fac8dd7bf",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -11,8 +11,8 @@ import * as ts from 'typescript';\n \n import {Reference} from '../../imports';\n import {ClassDeclaration} from '../../reflection';\n+import {TemplateId, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata} from '../api';\n \n-import {TemplateId, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata} from './api';\n import {addParseSpanInfo, addTemplateId, ignoreDiagnostics, wrapForDiagnostics} from './diagnostics';\n import {DomSchemaChecker} from './dom';\n import {Environment} from './environment';"
        },
        {
            "sha": "767f78e861b829b4dba568701b933193dc6e4cfc",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_file.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_file.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -11,8 +11,8 @@ import {AbsoluteFsPath, join} from '../../file_system';\n import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n+import {TypeCheckBlockMetadata, TypeCheckingConfig} from '../api';\n \n-import {TypeCheckBlockMetadata, TypeCheckingConfig} from './api';\n import {DomSchemaChecker} from './dom';\n import {Environment} from './environment';\n import {OutOfBandDiagnosticRecorder} from './oob';"
        },
        {
            "sha": "139ec6a232c342d153b574ff1f25d5479ff1cf4e",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_constructor.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_constructor.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_constructor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_constructor.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -9,8 +9,8 @@\n import * as ts from 'typescript';\n \n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n+import {TypeCtorMetadata} from '../api';\n \n-import {TypeCtorMetadata} from './api';\n import {TypeParameterEmitter} from './type_parameter_emitter';\n \n export function generateTypeCtorDeclarationFn("
        },
        {
            "sha": "bbf0bb0cf64540458cf4b2e675a33776faec96b0",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -19,6 +19,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "2aa048eeff931151fee3bd400567beebe5441594",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/diagnostics_spec.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 28,
            "changes": 76,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fdiagnostics_spec.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -8,10 +8,11 @@\n \n import * as ts from 'typescript';\n \n+import {absoluteFrom, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem, TestFile} from '../../file_system/testing';\n-import {TypeCheckingConfig} from '../src/api';\n+import {TypeCheckingConfig} from '../api';\n \n-import {ngForDeclaration, ngForDts, TestDeclaration, typecheck} from './test_utils';\n+import {ngForDeclaration, ngForDts, setup, TestDeclaration} from './test_utils';\n \n runInEachFileSystem(() => {\n   describe('template diagnostics', () => {\n@@ -35,7 +36,7 @@ runInEachFileSystem(() => {\n           }]);\n \n       expect(messages).toEqual(\n-          [`synthetic.html(1, 10): Type 'string' is not assignable to type 'number'.`]);\n+          [`TestComponent.html(1, 10): Type 'string' is not assignable to type 'number'.`]);\n     });\n \n     it('infers type of template variables', () => {\n@@ -49,7 +50,7 @@ runInEachFileSystem(() => {\n           [ngForDeclaration()], [ngForDts()]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 62): Argument of type 'number' is not assignable to parameter of type 'string'.`,\n+        `TestComponent.html(1, 62): Argument of type 'number' is not assignable to parameter of type 'string'.`,\n       ]);\n     });\n \n@@ -83,7 +84,7 @@ runInEachFileSystem(() => {\n           }]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 24): Argument of type 'HTMLDivElement' is not assignable to parameter of type 'string'.`,\n+        `TestComponent.html(1, 24): Argument of type 'HTMLDivElement' is not assignable to parameter of type 'string'.`,\n       ]);\n     });\n \n@@ -104,7 +105,7 @@ runInEachFileSystem(() => {\n           }]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 31): Argument of type 'Dir' is not assignable to parameter of type 'string'.`,\n+        `TestComponent.html(1, 31): Argument of type 'Dir' is not assignable to parameter of type 'string'.`,\n       ]);\n     });\n \n@@ -115,7 +116,7 @@ runInEachFileSystem(() => {\n       }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 30): Argument of type 'TemplateRef<any>' is not assignable to parameter of type 'string'.`,\n+        `TestComponent.html(1, 30): Argument of type 'TemplateRef<any>' is not assignable to parameter of type 'string'.`,\n       ]);\n     });\n \n@@ -130,7 +131,7 @@ runInEachFileSystem(() => {\n           [ngForDeclaration()], [ngForDts()]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 47): Property 'namme' does not exist on type '{ name: string; }'. Did you mean 'name'?`,\n+        `TestComponent.html(1, 47): Property 'namme' does not exist on type '{ name: string; }'. Did you mean 'name'?`,\n       ]);\n     });\n \n@@ -151,8 +152,8 @@ runInEachFileSystem(() => {\n       }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 29): Property 'heihgt' does not exist on type 'TestComponent'. Did you mean 'height'?`,\n-        `synthetic.html(1, 6): Can't bind to 'srcc' since it isn't a known property of 'img'.`,\n+        `TestComponent.html(1, 29): Property 'heihgt' does not exist on type 'TestComponent'. Did you mean 'height'?`,\n+        `TestComponent.html(1, 6): Can't bind to 'srcc' since it isn't a known property of 'img'.`,\n       ]);\n     });\n \n@@ -171,7 +172,7 @@ runInEachFileSystem(() => {\n           }]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 10): Type '\"drak\"' is not assignable to type '\"dark\" | \"light\"'.`,\n+        `TestComponent.html(1, 10): Type '\"drak\"' is not assignable to type '\"dark\" | \"light\"'.`,\n       ]);\n     });\n \n@@ -190,7 +191,7 @@ runInEachFileSystem(() => {\n           [{type: 'pipe', name: 'Pipe', pipeName: 'pipe'}]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 28): Argument of type 'number' is not assignable to parameter of type 'string'.`,\n+        `TestComponent.html(1, 28): Argument of type 'number' is not assignable to parameter of type 'string'.`,\n       ]);\n     });\n \n@@ -204,8 +205,8 @@ runInEachFileSystem(() => {\n          }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 4): Property 'personn' does not exist on type 'TestComponent'. Did you mean 'person'?`,\n-        `synthetic.html(1, 24): Property 'personn' does not exist on type 'TestComponent'. Did you mean 'person'?`,\n+        `TestComponent.html(1, 4): Property 'personn' does not exist on type 'TestComponent'. Did you mean 'person'?`,\n+        `TestComponent.html(1, 24): Property 'personn' does not exist on type 'TestComponent'. Did you mean 'person'?`,\n       ]);\n     });\n \n@@ -230,7 +231,7 @@ runInEachFileSystem(() => {\n           }]);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 14): Property 'personn' does not exist on type 'TestComponent'. Did you mean 'person'?`,\n+        `TestComponent.html(1, 14): Property 'personn' does not exist on type 'TestComponent'. Did you mean 'person'?`,\n       ]);\n     });\n \n@@ -260,7 +261,7 @@ runInEachFileSystem(() => {\n             [{type: 'directive', name: 'Dir', selector: '[dir]', outputs: {'out': 'event'}}]);\n \n         expect(messages).toEqual([\n-          `synthetic.html(1, 31): Argument of type 'number' is not assignable to parameter of type 'string'.`,\n+          `TestComponent.html(1, 31): Argument of type 'number' is not assignable to parameter of type 'string'.`,\n         ]);\n       });\n \n@@ -271,7 +272,7 @@ runInEachFileSystem(() => {\n           }`);\n \n         expect(messages).toEqual([\n-          `synthetic.html(1, 41): Argument of type 'AnimationEvent' is not assignable to parameter of type 'string'.`,\n+          `TestComponent.html(1, 41): Argument of type 'AnimationEvent' is not assignable to parameter of type 'string'.`,\n         ]);\n       });\n \n@@ -283,7 +284,7 @@ runInEachFileSystem(() => {\n           }`);\n \n         expect(messages).toEqual([\n-          `synthetic.html(1, 27): Argument of type 'MouseEvent' is not assignable to parameter of type 'string'.`,\n+          `TestComponent.html(1, 27): Argument of type 'MouseEvent' is not assignable to parameter of type 'string'.`,\n         ]);\n       });\n \n@@ -329,7 +330,7 @@ runInEachFileSystem(() => {\n           };\n         }`);\n \n-        expect(messages).toEqual([`synthetic.html(1, 41): Object is possibly 'undefined'.`]);\n+        expect(messages).toEqual([`TestComponent.html(1, 41): Object is possibly 'undefined'.`]);\n       });\n \n       it('does not produce diagnostic for checked property access', () => {\n@@ -362,8 +363,8 @@ class TestComponent {\n }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(3, 15): Property 'srcc' does not exist on type 'TestComponent'. Did you mean 'src'?`,\n-        `synthetic.html(4, 18): Property 'heihgt' does not exist on type 'TestComponent'. Did you mean 'height'?`,\n+        `TestComponent.html(3, 15): Property 'srcc' does not exist on type 'TestComponent'. Did you mean 'src'?`,\n+        `TestComponent.html(4, 18): Property 'heihgt' does not exist on type 'TestComponent'. Did you mean 'height'?`,\n       ]);\n     });\n   });\n@@ -378,7 +379,7 @@ class TestComponent {\n         }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 11): Property 'getNName' does not exist on type '{ getName(): string; }'. Did you mean 'getName'?`\n+        `TestComponent.html(1, 11): Property 'getNName' does not exist on type '{ getName(): string; }'. Did you mean 'getName'?`\n       ]);\n     });\n \n@@ -390,7 +391,7 @@ class TestComponent {\n           };\n         }`);\n \n-      expect(messages).toEqual([`synthetic.html(1, 19): Expected 0 arguments, but got 1.`]);\n+      expect(messages).toEqual([`TestComponent.html(1, 19): Expected 0 arguments, but got 1.`]);\n     });\n   });\n \n@@ -404,7 +405,7 @@ class TestComponent {\n         }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 12): Property 'getNName' does not exist on type '{ getName(): string; }'. Did you mean 'getName'?`\n+        `TestComponent.html(1, 12): Property 'getNName' does not exist on type '{ getName(): string; }'. Did you mean 'getName'?`\n       ]);\n     });\n \n@@ -416,7 +417,7 @@ class TestComponent {\n           };\n         }`);\n \n-      expect(messages).toEqual([`synthetic.html(1, 20): Expected 0 arguments, but got 1.`]);\n+      expect(messages).toEqual([`TestComponent.html(1, 20): Expected 0 arguments, but got 1.`]);\n     });\n   });\n \n@@ -430,7 +431,7 @@ class TestComponent {\n         }`);\n \n       expect(messages).toEqual([\n-        `synthetic.html(1, 22): Property 'nname' does not exist on type '{ name: string; }'. Did you mean 'name'?`\n+        `TestComponent.html(1, 22): Property 'nname' does not exist on type '{ name: string; }'. Did you mean 'name'?`\n       ]);\n     });\n \n@@ -443,7 +444,7 @@ class TestComponent {\n         }`);\n \n       expect(messages).toEqual(\n-          [`synthetic.html(1, 15): Type '2' is not assignable to type 'string'.`]);\n+          [`TestComponent.html(1, 15): Type '2' is not assignable to type 'string'.`]);\n     });\n   });\n });\n@@ -452,7 +453,26 @@ function diagnose(\n     template: string, source: string, declarations?: TestDeclaration[],\n     additionalSources: TestFile[] = [], config?: Partial<TypeCheckingConfig>,\n     options?: ts.CompilerOptions): string[] {\n-  const diagnostics = typecheck(template, source, declarations, additionalSources, config, options);\n+  const sfPath = absoluteFrom('/main.ts');\n+  const {program, templateTypeChecker} = setup(\n+      [\n+        {\n+          fileName: sfPath,\n+          templates: {\n+            'TestComponent': template,\n+          },\n+          source,\n+          declarations,\n+        },\n+        ...additionalSources.map(testFile => ({\n+                                   fileName: testFile.name,\n+                                   source: testFile.contents,\n+                                   templates: {},\n+                                 })),\n+      ],\n+      {config, options});\n+  const sf = getSourceFileOrError(program, sfPath);\n+  const diagnostics = templateTypeChecker.getDiagnosticsForFile(sf);\n   return diagnostics.map(diag => {\n     const text =\n         typeof diag.messageText === 'string' ? diag.messageText : diag.messageText.messageText;"
        },
        {
            "sha": "f367e1687e84ad0559f6b5e29becc1f938534cf5",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/program_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Fprogram_spec.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -12,16 +12,23 @@ import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError} from '../../file_sys\n import {runInEachFileSystem} from '../../file_system/testing';\n import {sfExtensionData, ShimReferenceTagger} from '../../shims';\n import {expectCompleteReuse, makeProgram} from '../../testing';\n-import {UpdateMode} from '../src/api';\n+import {UpdateMode} from '../api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n \n-import {createProgramWithNoTemplates} from './test_utils';\n+import {setup} from './test_utils';\n \n runInEachFileSystem(() => {\n   describe('template type-checking program', () => {\n     it('should not be created if no components need to be checked', () => {\n-      const {program, templateTypeChecker, programStrategy} = createProgramWithNoTemplates();\n-      templateTypeChecker.refresh();\n+      const fileName = absoluteFrom('/main.ts');\n+      const {program, templateTypeChecker, programStrategy} = setup([{\n+        fileName,\n+        templates: {},\n+        source: `export class NotACmp {}`,\n+      }]);\n+      const sf = getSourceFileOrError(program, fileName);\n+\n+      templateTypeChecker.getDiagnosticsForFile(sf);\n       // expect() here would create a really long error message, so this is checked manually.\n       if (programStrategy.getProgram() !== program) {\n         fail('Template type-checking created a new ts.Program even though it had no changes.');"
        },
        {
            "sha": "7fc09368fa76898871b7b365744bd59765a70038",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 111,
            "deletions": 63,
            "changes": 174,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -9,20 +9,22 @@\n import {CssSelector, ParseSourceFile, ParseSourceSpan, parseTemplate, R3TargetBinder, SchemaMetadata, SelectorMatcher, TmplAstElement, TmplAstReference, Type} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {absoluteFrom, AbsoluteFsPath, LogicalFileSystem} from '../../file_system';\n+import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError, LogicalFileSystem} from '../../file_system';\n import {TestFile} from '../../file_system/testing';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n import {NOOP_INCREMENTAL_BUILD} from '../../incremental';\n import {ClassDeclaration, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n-import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, UpdateMode} from '../src/api';\n+import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '../api';\n+\n+import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, UpdateMode} from '../api/api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n-import {ProgramTypeCheckAdapter, TemplateTypeChecker} from '../src/checker';\n-import {TypeCheckContext} from '../src/context';\n+import {TemplateTypeCheckerImpl} from '../src/checker';\n import {DomSchemaChecker} from '../src/dom';\n import {Environment} from '../src/environment';\n import {OutOfBandDiagnosticRecorder} from '../src/oob';\n+import {TypeCheckShimGenerator} from '../src/shim';\n import {generateTypeCheckBlock} from '../src/type_check_block';\n \n export function typescriptLibDts(): TestFile {\n@@ -235,32 +237,88 @@ export function tcb(\n   return res.replace(/\\s+/g, ' ');\n }\n \n-export interface TemplateTestEnvironment {\n-  sf: ts.SourceFile;\n-  program: ts.Program;\n-  templateTypeChecker: TemplateTypeChecker;\n-  programStrategy: ReusedProgramStrategy;\n+/**\n+ * A file in the test program, along with any template information for components within the file.\n+ */\n+export interface TypeCheckingTarget {\n+  /**\n+   * Path to the file in the virtual test filesystem.\n+   */\n+  fileName: AbsoluteFsPath;\n+\n+  /**\n+   * Raw source code for the file.\n+   *\n+   * If this is omitted, source code for the file will be generated based on any expected component\n+   * classes.\n+   */\n+  source?: string;\n+\n+  /**\n+   * A map of component class names to string templates for that component.\n+   */\n+  templates: {[className: string]: string};\n+\n+  /**\n+   * Any declarations (e.g. directives) which should be considered as part of the scope for the\n+   * components in this file.\n+   */\n+  declarations?: TestDeclaration[];\n }\n \n-function setupTemplateTypeChecking(\n-    source: string, additionalSources: {name: AbsoluteFsPath; contents: string}[],\n-    config: Partial<TypeCheckingConfig>, opts: ts.CompilerOptions,\n-    makeTypeCheckAdapterFn: (program: ts.Program, sf: ts.SourceFile) =>\n-        ProgramTypeCheckAdapter): TemplateTestEnvironment {\n-  const typeCheckFilePath = absoluteFrom('/main.ngtypecheck.ts');\n+/**\n+ * Create a testing environment for template type-checking which contains a number of given test\n+ * targets.\n+ *\n+ * A full Angular environment is not necessary to exercise the template type-checking system.\n+ * Components only need to be classes which exist, with templates specified in the target\n+ * configuration. In many cases, it's not even necessary to include source code for test files, as\n+ * that can be auto-generated based on the provided target configuration.\n+ */\n+export function setup(targets: TypeCheckingTarget[], overrides: {\n+  config?: Partial<TypeCheckingConfig>,\n+  options?: ts.CompilerOptions,\n+} = {}): {\n+  templateTypeChecker: TemplateTypeChecker,\n+  program: ts.Program,\n+  programStrategy: ReusedProgramStrategy,\n+} {\n   const files = [\n     typescriptLibDts(),\n     angularCoreDts(),\n     angularAnimationsDts(),\n-    // Add the typecheck file to the program, as the typecheck program is created with the\n-    // assumption that the typecheck file was already a root file in the original program.\n-    {name: typeCheckFilePath, contents: 'export const TYPECHECK = true;'},\n-    {name: absoluteFrom('/main.ts'), contents: source},\n-    ...additionalSources,\n   ];\n-  const {program, host, options} =\n-      makeProgram(files, {strictNullChecks: true, noImplicitAny: true, ...opts}, undefined, false);\n-  const sf = program.getSourceFile(absoluteFrom('/main.ts'))!;\n+\n+  for (const target of targets) {\n+    let contents: string;\n+    if (target.source !== undefined) {\n+      contents = target.source;\n+    } else {\n+      contents = `// generated from templates\\n\\nexport const MODULE = true;\\n\\n`;\n+      for (const className of Object.keys(target.templates)) {\n+        contents += `export class ${className} {}\\n`;\n+      }\n+    }\n+\n+    files.push({\n+      name: target.fileName,\n+      contents,\n+    });\n+\n+    if (!target.fileName.endsWith('.d.ts')) {\n+      files.push({\n+        name: TypeCheckShimGenerator.shimFor(target.fileName),\n+        contents: 'export const MODULE = true;',\n+      });\n+    }\n+  }\n+\n+  const opts = overrides.options ?? {};\n+  const config = overrides.config ?? {};\n+\n+  const {program, host, options} = makeProgram(\n+      files, {strictNullChecks: true, noImplicitAny: true, ...opts}, /* host */ undefined,\n+      /* checkForErrors */ false);\n   const checker = program.getTypeChecker();\n   const logicalFs = new LogicalFileSystem(getRootDirs(host, options), host);\n   const reflectionHost = new TypeScriptReflectionHost(checker);\n@@ -274,22 +332,18 @@ function setupTemplateTypeChecking(\n   ]);\n   const fullConfig = {...ALL_ENABLED_CONFIG, ...config};\n \n-  const checkAdapter = makeTypeCheckAdapterFn(program, sf);\n-  const programStrategy = new ReusedProgramStrategy(program, host, options, []);\n-  const templateTypeChecker = new TemplateTypeChecker(\n-      program, programStrategy, checkAdapter, fullConfig, emitter, reflectionHost, host,\n-      NOOP_INCREMENTAL_BUILD);\n+  const checkAdapter = createTypeCheckAdapter((sf, ctx) => {\n+    for (const target of targets) {\n+      if (getSourceFileOrError(program, target.fileName) !== sf) {\n+        continue;\n+      }\n \n-  return {program, sf, templateTypeChecker, programStrategy};\n-}\n+      const declarations = target.declarations ?? [];\n \n-export function typecheck(\n-    template: string, source: string, declarations: TestDeclaration[] = [],\n-    additionalSources: {name: AbsoluteFsPath; contents: string}[] = [],\n-    config: Partial<TypeCheckingConfig> = {}, opts: ts.CompilerOptions = {}): ts.Diagnostic[] {\n-  const {sf, templateTypeChecker} =\n-      setupTemplateTypeChecking(source, additionalSources, config, opts, (program, sf) => {\n-        const templateUrl = 'synthetic.html';\n+      for (const className of Object.keys(target.templates)) {\n+        const classDecl = getClass(sf, className);\n+        const template = target.templates[className];\n+        const templateUrl = `${className}.html`;\n         const templateFile = new ParseSourceFile(template, templateUrl);\n         const {nodes, errors} = parseTemplate(template, templateUrl);\n         if (errors !== undefined) {\n@@ -307,44 +361,38 @@ export function typecheck(\n           return getClass(declFile, decl.name);\n         });\n         const binder = new R3TargetBinder(matcher);\n-        const boundTarget = binder.bind({template: nodes});\n-        const clazz = new Reference(getClass(sf, 'TestComponent'));\n+        const classRef = new Reference(classDecl);\n \n         const sourceMapping: TemplateSourceMapping = {\n           type: 'external',\n           template,\n           templateUrl,\n-          componentClass: clazz.node,\n+          componentClass: classRef.node,\n           // Use the class's name for error mappings.\n-          node: clazz.node.name,\n+          node: classRef.node.name,\n         };\n \n-        return createTypeCheckAdapter((ctx: TypeCheckContext) => {\n-          ctx.addTemplate(clazz, boundTarget, pipes, [], sourceMapping, templateFile);\n-        });\n-      });\n-\n-  templateTypeChecker.refresh();\n-  return templateTypeChecker.getDiagnosticsForFile(sf);\n-}\n-\n-export function createProgramWithNoTemplates(): TemplateTestEnvironment {\n-  return setupTemplateTypeChecking(\n-      'export const NOT_A_COMPONENT = true;', [], {}, {}, () => createTypeCheckAdapter(() => {}));\n-}\n+        ctx.addTemplate(classRef, binder, nodes, pipes, [], sourceMapping, templateFile);\n+      }\n+    }\n+  });\n \n-function createTypeCheckAdapter(fn: (ctx: TypeCheckContext) => void): ProgramTypeCheckAdapter {\n-  let called = false;\n+  const programStrategy = new ReusedProgramStrategy(program, host, options, ['ngtypecheck']);\n+  const templateTypeChecker = new TemplateTypeCheckerImpl(\n+      program, programStrategy, checkAdapter, fullConfig, emitter, reflectionHost, host,\n+      NOOP_INCREMENTAL_BUILD);\n   return {\n-    typeCheck: (sf: ts.SourceFile, ctx: TypeCheckContext) => {\n-      if (!called) {\n-        fn(ctx);\n-      }\n-      called = true;\n-    },\n+    templateTypeChecker,\n+    program,\n+    programStrategy,\n   };\n }\n \n+function createTypeCheckAdapter(fn: (sf: ts.SourceFile, ctx: TypeCheckContext) => void):\n+    ProgramTypeCheckAdapter {\n+  return {typeCheck: fn};\n+}\n+\n function prepareDeclarations(\n     declarations: TestDeclaration[],\n     resolveDeclaration: (decl: TestDeclaration) => ClassDeclaration<ts.ClassDeclaration>) {\n@@ -386,7 +434,7 @@ export function getClass(sf: ts.SourceFile, name: string): ClassDeclaration<ts.C\n       return stmt;\n     }\n   }\n-  throw new Error(`Class ${name} not found in file`);\n+  throw new Error(`Class ${name} not found in file: ${sf.fileName}: ${sf.text}`);\n }\n \n class FakeEnvironment /* implements Environment */ {"
        },
        {
            "sha": "e9586441c1335676b2fa2be8a5cf334f4b8fff38",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {TypeCheckingConfig} from '../src/api';\n+import {TypeCheckingConfig} from '../api';\n \n import {ALL_ENABLED_CONFIG, tcb, TestDeclaration, TestDirective} from './test_utils';\n "
        },
        {
            "sha": "79a5a678df2807e781cfd6dfedd3930ae2da92f9",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker_spec.ts",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -0,0 +1,47 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom, getSourceFileOrError} from '../../file_system';\n+import {runInEachFileSystem} from '../../file_system/testing';\n+\n+import {getClass, setup} from './test_utils';\n+\n+runInEachFileSystem(() => {\n+  describe('TemplateTypeChecker', () => {\n+    it('should batch diagnostic operations when requested in WholeProgram mode', () => {\n+      const file1 = absoluteFrom('/file1.ts');\n+      const file2 = absoluteFrom('/file2.ts');\n+      const {program, templateTypeChecker, programStrategy} = setup([\n+        {fileName: file1, templates: {'Cmp1': '<div></div>'}},\n+        {fileName: file2, templates: {'Cmp2': '<span></span>'}}\n+      ]);\n+\n+      templateTypeChecker.getDiagnosticsForFile(getSourceFileOrError(program, file1));\n+      const ttcProgram1 = programStrategy.getProgram();\n+      templateTypeChecker.getDiagnosticsForFile(getSourceFileOrError(program, file2));\n+      const ttcProgram2 = programStrategy.getProgram();\n+\n+      expect(ttcProgram1).toBe(ttcProgram2);\n+    });\n+\n+    it('should allow access to the type-check block of a component', () => {\n+      const file1 = absoluteFrom('/file1.ts');\n+      const file2 = absoluteFrom('/file2.ts');\n+      const {program, templateTypeChecker, programStrategy} = setup([\n+        {fileName: file1, templates: {'Cmp1': '<div></div>'}},\n+        {fileName: file2, templates: {'Cmp2': '<span></span>'}}\n+      ]);\n+\n+      const cmp1 = getClass(getSourceFileOrError(program, file1), 'Cmp1');\n+      const block = templateTypeChecker.getTypeCheckBlock(cmp1);\n+      expect(block).not.toBeNull();\n+      expect(block!.getText()).toMatch(/: i[0-9]\\.Cmp1/);\n+      expect(block!.getText()).toContain(`document.createElement(\"div\")`);\n+    });\n+  });\n+});"
        },
        {
            "sha": "57ec025f1df627be9a9d8490afb714cbabd39a37",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_constructor_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 12,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -10,16 +10,16 @@ import * as ts from 'typescript';\n import {absoluteFrom, AbsoluteFsPath, getFileSystem, getSourceFileOrError, LogicalFileSystem, NgtscCompilerHost} from '../../file_system';\n import {runInEachFileSystem, TestFile} from '../../file_system/testing';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n-import {isNamedClassDeclaration, ReflectionHost, TypeScriptReflectionHost} from '../../reflection';\n+import {isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {getDeclaration, makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n-import {UpdateMode} from '../src/api';\n+import {ComponentToShimMappingStrategy, UpdateMode} from '../api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n-import {ComponentToShimMappingStrategy, PendingFileTypeCheckingData, TypeCheckContext} from '../src/context';\n+import {PendingFileTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from '../src/context';\n import {TemplateSourceManager} from '../src/source';\n import {TypeCheckFile} from '../src/type_check_file';\n \n-import {ALL_ENABLED_CONFIG, NoopOobRecorder} from './test_utils';\n+import {ALL_ENABLED_CONFIG} from './test_utils';\n \n runInEachFileSystem(() => {\n   describe('ngtsc typechecking', () => {\n@@ -72,8 +72,9 @@ TestClass.ngTypeCtor({value: 'test'});\n           new AbsoluteModuleStrategy(program, checker, moduleResolver, reflectionHost),\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n-        const ctx = new TypeCheckContext(\n-            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost);\n+        const ctx = new TypeCheckContextImpl(\n+            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n+            new TestTypeCheckingHost());\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         const pendingFile = makePendingFile();\n@@ -110,8 +111,9 @@ TestClass.ngTypeCtor({value: 'test'});\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n         const pendingFile = makePendingFile();\n-        const ctx = new TypeCheckContext(\n-            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost);\n+        const ctx = new TypeCheckContextImpl(\n+            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n+            new TestTypeCheckingHost());\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -126,7 +128,7 @@ TestClass.ngTypeCtor({value: 'test'});\n               coercedInputFields: new Set(),\n             });\n         const programStrategy = new ReusedProgramStrategy(program, host, options, []);\n-        programStrategy.updateFiles(ctx.finalize().updates, UpdateMode.Complete);\n+        programStrategy.updateFiles(ctx.finalize(), UpdateMode.Complete);\n         const TestClassWithCtor = getDeclaration(\n             programStrategy.getProgram(), _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         const typeCtor = TestClassWithCtor.members.find(isTypeCtor)!;\n@@ -154,8 +156,9 @@ TestClass.ngTypeCtor({value: 'test'});\n           new LogicalProjectStrategy(reflectionHost, logicalFs),\n         ]);\n         const pendingFile = makePendingFile();\n-        const ctx = new TypeCheckContext(\n-            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost);\n+        const ctx = new TypeCheckContextImpl(\n+            ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n+            new TestTypeCheckingHost());\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -170,7 +173,7 @@ TestClass.ngTypeCtor({value: 'test'});\n               coercedInputFields: new Set(['bar']),\n             });\n         const programStrategy = new ReusedProgramStrategy(program, host, options, []);\n-        programStrategy.updateFiles(ctx.finalize().updates, UpdateMode.Complete);\n+        programStrategy.updateFiles(ctx.finalize(), UpdateMode.Complete);\n         const TestClassWithCtor = getDeclaration(\n             programStrategy.getProgram(), _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         const typeCtor = TestClassWithCtor.members.find(isTypeCtor)!;\n@@ -194,6 +197,25 @@ function makePendingFile(): PendingFileTypeCheckingData {\n   };\n }\n \n+class TestTypeCheckingHost implements TypeCheckingHost {\n+  private sourceManager = new TemplateSourceManager();\n+\n+  getSourceManager(): TemplateSourceManager {\n+    return this.sourceManager;\n+  }\n+\n+  shouldCheckComponent(): boolean {\n+    return true;\n+  }\n+\n+  getTemplateOverride(): null {\n+    return null;\n+  }\n+  recordShimData(): void {}\n+\n+  recordComplete(): void {}\n+}\n+\n class TestMappingStrategy implements ComponentToShimMappingStrategy {\n   shimPathForComponent(): AbsoluteFsPath {\n     return absoluteFrom('/typecheck.ts');"
        },
        {
            "sha": "22c25e3ba19b92109954f5bb1d35b211629a1b87",
            "filename": "packages/language-service/ivy/compiler/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Flanguage-service%2Fivy%2Fcompiler%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Flanguage-service%2Fivy%2Fcompiler%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler%2FBUILD.bazel?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -11,6 +11,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "91de6c4282c86cac73c45a2dfa931adbf973ab28",
            "filename": "packages/language-service/ivy/compiler/compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/16c7441c2fe528bb39cfdcf22927064fc1facca8/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts?ref=16c7441c2fe528bb39cfdcf22927064fc1facca8",
            "patch": "@@ -11,7 +11,8 @@ import {CompilerOptions} from '@angular/compiler-cli';\n import {NgCompiler, NgCompilerHost} from '@angular/compiler-cli/src/ngtsc/core';\n import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {PatchedProgramIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n-import {TypeCheckingProgramStrategy, TypeCheckShimGenerator, UpdateMode} from '@angular/compiler-cli/src/ngtsc/typecheck';\n+import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n+import {TypeCheckingProgramStrategy, UpdateMode} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {makeCompilerHostFromProject} from './compiler_host';"
        }
    ],
    "stats": {
        "total": 1007,
        "additions": 694,
        "deletions": 313
    }
}