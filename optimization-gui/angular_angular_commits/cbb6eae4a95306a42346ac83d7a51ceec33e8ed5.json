{
    "author": "alxhub",
    "message": "feat(language-service): autocomplete pipe binding expressions (#40032)\n\nThis commit adds autocompletion for pipe expressions, built on existing APIs\nfor checking which pipes are in scope.\n\nPR Close #40032",
    "sha": "cbb6eae4a95306a42346ac83d7a51ceec33e8ed5",
    "files": [
        {
            "sha": "4a72808aaeb6446b380c376969a0873f6a56a8a2",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/cbb6eae4a95306a42346ac83d7a51ceec33e8ed5/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/cbb6eae4a95306a42346ac83d7a51ceec33e8ed5/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=cbb6eae4a95306a42346ac83d7a51ceec33e8ed5",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, EmptyExpr, ImplicitReceiver, LiteralPrimitive, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, BindingPipe, EmptyExpr, ImplicitReceiver, LiteralPrimitive, MethodCall, ParseSourceSpan, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {CompletionKind, DirectiveInScope, TemplateDeclarationSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {BoundEvent} from '@angular/compiler/src/render3/r3_ast';\n@@ -23,6 +23,7 @@ type PropertyExpressionCompletionBuilder =\n type ElementAttributeCompletionBuilder =\n     CompletionBuilder<TmplAstElement|TmplAstBoundAttribute|TmplAstTextAttribute|TmplAstBoundEvent>;\n \n+type PipeCompletionBuilder = CompletionBuilder<BindingPipe>;\n \n export enum CompletionNodeContext {\n   None,\n@@ -65,6 +66,8 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       return this.getElementTagCompletion();\n     } else if (this.isElementAttributeCompletion()) {\n       return this.getElementAttributeCompletions();\n+    } else if (this.isPipeCompletion()) {\n+      return this.getPipeCompletions();\n     } else {\n       return undefined;\n     }\n@@ -577,6 +580,34 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     const completion = attrTable.get(name)!;\n     return getAttributeCompletionSymbol(completion, this.typeChecker) ?? undefined;\n   }\n+\n+  private isPipeCompletion(): this is PipeCompletionBuilder {\n+    return this.node instanceof BindingPipe;\n+  }\n+\n+  private getPipeCompletions(this: PipeCompletionBuilder):\n+      ts.WithMetadata<ts.CompletionInfo>|undefined {\n+    const pipes = this.templateTypeChecker.getPipesInScope(this.component);\n+    if (pipes === null) {\n+      return undefined;\n+    }\n+\n+    const replacementSpan = makeReplacementSpanFromAst(this.node);\n+\n+    const entries: ts.CompletionEntry[] =\n+        pipes.map(pipe => ({\n+                    name: pipe.name,\n+                    sortText: pipe.name,\n+                    kind: unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PIPE),\n+                    replacementSpan,\n+                  }));\n+    return {\n+      entries,\n+      isGlobalCompletion: false,\n+      isMemberCompletion: false,\n+      isNewIdentifierLocation: false,\n+    };\n+  }\n }\n \n function makeReplacementSpanFromParseSourceSpan(span: ParseSourceSpan): ts.TextSpan {\n@@ -587,7 +618,7 @@ function makeReplacementSpanFromParseSourceSpan(span: ParseSourceSpan): ts.TextS\n }\n \n function makeReplacementSpanFromAst(node: PropertyRead|PropertyWrite|MethodCall|SafePropertyRead|\n-                                    SafeMethodCall): ts.TextSpan {\n+                                    SafeMethodCall|BindingPipe): ts.TextSpan {\n   return {\n     start: node.nameSpan.start,\n     length: node.nameSpan.end - node.nameSpan.start,"
        },
        {
            "sha": "09ff4573304eabf141c4faab021efe7843e95ea6",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 48,
            "deletions": 4,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/cbb6eae4a95306a42346ac83d7a51ceec33e8ed5/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/cbb6eae4a95306a42346ac83d7a51ceec33e8ed5/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=cbb6eae4a95306a42346ac83d7a51ceec33e8ed5",
            "patch": "@@ -51,6 +51,19 @@ const DIR_WITH_SELECTED_INPUT = {\n   `\n };\n \n+const SOME_PIPE = {\n+  'SomePipe': `\n+    @Pipe({\n+      name: 'somePipe',\n+    })\n+    export class SomePipe {\n+      transform(value: string): string {\n+        return value;\n+      }\n+    }\n+   `\n+};\n+\n describe('completions', () => {\n   beforeEach(() => {\n     initMockFileSystem('Native');\n@@ -445,6 +458,37 @@ describe('completions', () => {\n       });\n     });\n   });\n+\n+  describe('pipe scope', () => {\n+    it('should complete a pipe binding', () => {\n+      const {ngLS, fileName, cursor, text} = setup(`{{ foo | some¦ }}`, '', SOME_PIPE);\n+      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      expectContain(\n+          completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PIPE),\n+          ['somePipe']);\n+      expectReplacementText(completions, text, 'some');\n+    });\n+\n+    // TODO(alxhub): currently disabled as the template targeting system identifies the cursor\n+    // position as the entire Interpolation node, not the BindingPipe node. This happens because the\n+    // BindingPipe node's span ends at the '|' character. To make this case work, the targeting\n+    // system will need to artificially expand the BindingPipe's span to encompass any trailing\n+    // spaces, which will be done in a future PR.\n+    xit('should complete an empty pipe binding', () => {\n+      const {ngLS, fileName, cursor, text} = setup(`{{ foo | ¦ }}`, '', SOME_PIPE);\n+      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      expectContain(\n+          completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.PIPE),\n+          ['somePipe']);\n+      expectReplacementText(completions, text, 'some');\n+    });\n+\n+    it('should not return extraneous completions', () => {\n+      const {ngLS, fileName, cursor, text} = setup(`{{ foo | some¦ }}`, '');\n+      const completions = ngLS.getCompletionsAtPosition(fileName, cursor, /* options */ undefined);\n+      expect(completions?.entries.length).toBe(0);\n+    });\n+  });\n });\n \n function expectContain(\n@@ -495,7 +539,7 @@ function toText(displayParts?: ts.SymbolDisplayPart[]): string {\n \n function setup(\n     templateWithCursor: string, classContents: string,\n-    otherDirectives: {[name: string]: string} = {}): {\n+    otherDeclarations: {[name: string]: string} = {}): {\n   env: LanguageServiceTestEnvironment,\n   fileName: AbsoluteFsPath,\n   AppCmp: ts.ClassDeclaration,\n@@ -507,15 +551,15 @@ function setup(\n   const codePath = absoluteFrom('/test.ts');\n   const templatePath = absoluteFrom('/test.html');\n \n-  const decls = ['AppCmp', ...Object.keys(otherDirectives)];\n+  const decls = ['AppCmp', ...Object.keys(otherDeclarations)];\n \n-  const otherDirectiveClassDecls = Object.values(otherDirectives).join('\\n\\n');\n+  const otherDirectiveClassDecls = Object.values(otherDeclarations).join('\\n\\n');\n \n   const env = LanguageServiceTestEnvironment.setup([\n     {\n       name: codePath,\n       contents: `\n-        import {Component, Directive, NgModule} from '@angular/core';\n+        import {Component, Directive, NgModule, Pipe} from '@angular/core';\n \n         @Component({\n           templateUrl: './test.html',"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 81,
        "deletions": 6
    }
}