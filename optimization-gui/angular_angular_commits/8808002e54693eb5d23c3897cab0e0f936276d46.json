{
    "author": "atscott",
    "message": "refactor(language-service): migrate gettcb_spec to new testing package (#40966)\n\nrefactor(language-service): migrate gettcb_spec to new testing package\n\nPR Close #40966",
    "sha": "8808002e54693eb5d23c3897cab0e0f936276d46",
    "files": [
        {
            "sha": "a753550881cce02e30f21636fbcacd2ce8417519",
            "filename": "packages/language-service/ivy/test/gettcb_spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 27,
            "changes": 60,
            "blob_url": "https://github.com/angular/angular/blob/8808002e54693eb5d23c3897cab0e0f936276d46/packages%2Flanguage-service%2Fivy%2Ftest%2Fgettcb_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8808002e54693eb5d23c3897cab0e0f936276d46/packages%2Flanguage-service%2Fivy%2Ftest%2Fgettcb_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fgettcb_spec.ts?ref=8808002e54693eb5d23c3897cab0e0f936276d46",
            "patch": "@@ -6,32 +6,34 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n-import {extractCursorInfo} from './env';\n-import {createModuleWithDeclarations} from './test_utils';\n+import {createModuleAndProjectWithDeclarations, LanguageServiceTestEnv} from '../testing';\n \n describe('get typecheck block', () => {\n   beforeEach(() => {\n     initMockFileSystem('Native');\n   });\n \n   it('should find the typecheck block for an inline template', () => {\n-    const {text, cursor} = extractCursorInfo(`\n+    const files = {\n+      'app.ts': `\n       import {Component} from '@angular/core';\n \n       @Component({\n-        template: '<div>{{ my¦Prop }}</div>',\n+        template: '<div>{{ myProp }}</div>',\n       })\n       export class AppCmp {\n         myProp!: string;\n-      }`);\n-    const appFi = absoluteFrom('/app.ts');\n-    const env = createModuleWithDeclarations([{name: appFi, contents: text}]);\n+      }`\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n \n-    env.expectNoSourceDiagnostics();\n-    const result = env.ngLS.getTcb(appFi, cursor);\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('{{ my¦Prop }}');\n+    const result = appFile.getTcb();\n     if (result === undefined) {\n       fail('Expected a valid TCB response');\n       return;\n@@ -43,12 +45,8 @@ describe('get typecheck block', () => {\n   });\n \n   it('should find the typecheck block for an external template', () => {\n-    const {text, cursor} = extractCursorInfo(`<div>{{ my¦Prop }}</div>`);\n-    const templateFi = absoluteFrom('/app.html');\n-    const env = createModuleWithDeclarations(\n-        [{\n-          name: absoluteFrom('/app.ts'),\n-          contents: `\n+    const files = {\n+      'app.ts': `\n             import {Component} from '@angular/core';\n \n             @Component({\n@@ -57,11 +55,15 @@ describe('get typecheck block', () => {\n             export class AppCmp {\n               myProp!: string;\n             }`,\n-        }],\n-        [{name: templateFi, contents: text}]);\n+      'app.html': '<div>{{ myProp }}</div>'\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n \n-    env.expectNoSourceDiagnostics();\n-    const result = env.ngLS.getTcb(templateFi, cursor);\n+    const htmlFile = project.openFile('app.html');\n+    htmlFile.moveCursorToText('{{ my¦Prop }}');\n+    const result = htmlFile.getTcb();\n     if (result === undefined) {\n       fail('Expected a valid TCB response');\n       return;\n@@ -73,20 +75,24 @@ describe('get typecheck block', () => {\n   });\n \n   it('should not find typecheck blocks outside a template', () => {\n-    const {text, cursor} = extractCursorInfo(`\n+    const files = {\n+      'app.ts': `\n       import {Component} from '@angular/core';\n \n       @Component({\n         template: '<div>{{ myProp }}</div>',\n       })\n       export class AppCmp {\n-        my¦Prop!: string;\n-      }`);\n-    const appFi = absoluteFrom('/app.ts');\n-    const env = createModuleWithDeclarations([{name: appFi, contents: text}]);\n+        myProp!: string;\n+      }`\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n \n-    env.expectNoSourceDiagnostics();\n-    const result = env.ngLS.getTcb(appFi, cursor);\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('my¦Prop!: string;');\n+    const result = appFile.getTcb();\n     expect(result).toBeUndefined();\n   });\n });"
        },
        {
            "sha": "1664349891fbc3e025f61fb7b232d367e128ea1c",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/8808002e54693eb5d23c3897cab0e0f936276d46/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/8808002e54693eb5d23c3897cab0e0f936276d46/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=8808002e54693eb5d23c3897cab0e0f936276d46",
            "patch": "@@ -76,4 +76,8 @@ export class OpenBuffer {\n     return this.ngLS.getCompletionEntryDetails(\n         this.scriptInfo.fileName, this._cursor, entryName, formatOptions, preferences);\n   }\n+\n+  getTcb() {\n+    return this.ngLS.getTcb(this.scriptInfo.fileName, this._cursor);\n+  }\n }"
        },
        {
            "sha": "6c5dfccf0682d80cd62408001b4b61dda56278c1",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/8808002e54693eb5d23c3897cab0e0f936276d46/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/8808002e54693eb5d23c3897cab0e0f936276d46/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=8808002e54693eb5d23c3897cab0e0f936276d46",
            "patch": "@@ -8,6 +8,7 @@\n \n import {StrictTemplateOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import { OptimizeFor } from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n import {LanguageService} from '../../language_service';\n import {OpenBuffer} from './buffer';\n@@ -119,4 +120,38 @@ export class Project {\n     diagnostics.push(...this.ngLS.getSemanticDiagnostics(fileName));\n     return diagnostics;\n   }\n+\n+  expectNoSourceDiagnostics(): void {\n+    const program = this.tsLS.getProgram();\n+    if (program === undefined) {\n+      throw new Error(`Expected to get a ts.Program`);\n+    }\n+\n+    const ngCompiler = this.ngLS.compilerFactory.getOrCreate();\n+\n+    for (const sf of program.getSourceFiles()) {\n+      if (sf.isDeclarationFile || sf.fileName.endsWith('.ngtypecheck.ts')) {\n+        continue;\n+      }\n+\n+      const syntactic = program.getSyntacticDiagnostics(sf);\n+      expect(syntactic.map(diag => diag.messageText)).toEqual([]);\n+      if (syntactic.length > 0) {\n+        continue;\n+      }\n+\n+      const semantic = program.getSemanticDiagnostics(sf);\n+      expect(semantic.map(diag => diag.messageText)).toEqual([]);\n+      if (semantic.length > 0) {\n+        continue;\n+      }\n+\n+      // It's more efficient to optimize for WholeProgram since we call this with every file in the\n+      // program.\n+      const ngDiagnostics = ngCompiler.getDiagnosticsForFile(sf, OptimizeFor.WholeProgram);\n+      expect(ngDiagnostics.map(diag => diag.messageText)).toEqual([]);\n+    }\n+\n+    this.ngLS.compilerFactory.registerLastKnownProgram();\n+  }\n }"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 72,
        "deletions": 27
    }
}