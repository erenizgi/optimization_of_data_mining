{
    "author": "atscott",
    "message": "fix(router): Allow renavigating to failed URLs (#43424)\n\nThere are situations where the Router does not currently clean up failed navigations\ncorrectly. While this is problematic on its own, we can mitigate some of\nthe damage by processing any URL when we get a navigation request when\nthe internal router state is out of sync.\n\nEach of the added tests would fail without this change.\n\nfixes #34795\n\nPR Close #43424",
    "sha": "0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc",
    "files": [
        {
            "sha": "1f65636025443155b234511ee2c7990dbe77db89",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc",
            "patch": "@@ -654,14 +654,14 @@ export class Router {\n                        };\n                      }),\n                      switchMap(t => {\n+                       const browserUrlTree = this.browserUrlTree.toString();\n                        const urlTransition = !this.navigated ||\n-                           t.extractedUrl.toString() !== this.browserUrlTree.toString();\n-                       /* || this.browserUrlTree.toString() !== this.currentUrlTree.toString() */\n-                       // TODO(atscott): Run TGP to see if the above change can be made. There are\n-                       // situations where a navigation is canceled _after_ browserUrlTree is\n-                       // updated. For example, urlUpdateStrategy === 'eager': if a new\n-                       // navigation happens (i.e. in a guard), this would cause the router to\n-                       // be in an invalid state of tracking.\n+                           t.extractedUrl.toString() !== browserUrlTree ||\n+                           // Navigations which succeed or ones which fail and are cleaned up\n+                           // correctly should result in `browserUrlTree` and `currentUrlTree`\n+                           // matching. If this is not the case, assume something went wrong and try\n+                           // processing the URL again.\n+                           browserUrlTree !== this.currentUrlTree.toString();\n                        const processCurrentUrl =\n                            (this.onSameUrlNavigation === 'reload' ? true : urlTransition) &&\n                            this.urlHandlingStrategy.shouldProcessUrl(t.rawUrl);"
        },
        {
            "sha": "611194e487003b0fd27984463248f8d24d30291a",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 121,
            "deletions": 11,
            "changes": 132,
            "blob_url": "https://github.com/angular/angular/blob/0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=0e8548f667e5fdefa3ac7cdf1ba47e3e17011ffc",
            "patch": "@@ -871,17 +871,36 @@ describe('Integration', () => {\n      })));\n \n   describe('\"eager\" urlUpdateStrategy', () => {\n+    @Injectable()\n+    class AuthGuard implements CanActivate {\n+      canActivateResult = true;\n+\n+      canActivate() {\n+        return this.canActivateResult;\n+      }\n+    }\n+    @Injectable()\n+    class DelayedGuard implements CanActivate {\n+      canActivate() {\n+        return of('').pipe(delay(1000), mapTo(true));\n+      }\n+    }\n+\n     beforeEach(() => {\n       const serializer = new DefaultUrlSerializer();\n       TestBed.configureTestingModule({\n-        providers: [{\n-          provide: 'authGuardFail',\n-          useValue: (a: any, b: any) => {\n-            return new Promise(res => {\n-              setTimeout(() => res(serializer.parse('/login')), 1);\n-            });\n-          }\n-        }]\n+        providers: [\n+          {\n+            provide: 'authGuardFail',\n+            useValue: (a: any, b: any) => {\n+              return new Promise(res => {\n+                setTimeout(() => res(serializer.parse('/login')), 1);\n+              });\n+            }\n+          },\n+          AuthGuard,\n+          DelayedGuard,\n+        ]\n       });\n     });\n \n@@ -1028,6 +1047,58 @@ describe('Integration', () => {\n          expect(navigation.extras.state).toBeDefined();\n          expect(navigation.extras.state).toEqual({foo: 'bar'});\n        })));\n+\n+    it('can renavigate to rejected URL', fakeAsync(() => {\n+         const router = TestBed.inject(Router);\n+         const canActivate = TestBed.inject(AuthGuard);\n+         const location = TestBed.inject(Location) as SpyLocation;\n+         router.urlUpdateStrategy = 'eager';\n+         router.resetConfig([\n+           {path: '', component: BlankCmp},\n+           {path: 'simple', component: SimpleCmp, canActivate: [AuthGuard]},\n+         ]);\n+         const fixture = createRoot(router, RootCmp);\n+\n+         // Try to navigate to /simple but guard rejects\n+         canActivate.canActivateResult = false;\n+         router.navigateByUrl('/simple');\n+         advance(fixture);\n+         expect(location.path()).toEqual('/');\n+         expect(fixture.nativeElement.innerHTML).not.toContain('simple');\n+\n+         // Renavigate to /simple without guard rejection, should succeed.\n+         canActivate.canActivateResult = true;\n+         router.navigateByUrl('/simple');\n+         advance(fixture);\n+         expect(location.path()).toEqual('/simple');\n+         expect(fixture.nativeElement.innerHTML).toContain('simple');\n+       }));\n+\n+    it('can renavigate to same URL during in-flight navigation', fakeAsync(() => {\n+         const router = TestBed.inject(Router);\n+         const location = TestBed.inject(Location) as SpyLocation;\n+         router.urlUpdateStrategy = 'eager';\n+         router.resetConfig([\n+           {path: '', component: BlankCmp},\n+           {path: 'simple', component: SimpleCmp, canActivate: [DelayedGuard]},\n+         ]);\n+         const fixture = createRoot(router, RootCmp);\n+\n+         // Start navigating to /simple, but do not flush the guard delay\n+         router.navigateByUrl('/simple');\n+         tick();\n+         // eager update strategy so URL is already updated.\n+         expect(location.path()).toEqual('/simple');\n+         expect(fixture.nativeElement.innerHTML).not.toContain('simple');\n+\n+         // Start an additional navigation to /simple and ensure at least one of those succeeds.\n+         // It's not super important which one gets processed, but in the past, the router would\n+         // cancel the in-flight one and not process the new one.\n+         router.navigateByUrl('/simple');\n+         tick(1000);\n+         expect(location.path()).toEqual('/simple');\n+         expect(fixture.nativeElement.innerHTML).toContain('simple');\n+       }));\n   });\n \n   it('should navigate back and forward',\n@@ -1568,6 +1639,33 @@ describe('Integration', () => {\n          expect(locationUrlBeforeEmittingError).toEqual('/simple');\n        }));\n \n+    it('can renavigate to throwing component', fakeAsync(() => {\n+         const router = TestBed.inject(Router);\n+         const location = TestBed.inject(Location) as SpyLocation;\n+         router.urlUpdateStrategy = 'eager';\n+         router.resetConfig([\n+           {path: '', component: BlankCmp},\n+           {path: 'throwing', component: ConditionalThrowingCmp},\n+         ]);\n+         const fixture = createRoot(router, RootCmp);\n+\n+         // Try navigating to a component which throws an error during activation.\n+         ConditionalThrowingCmp.throwError = true;\n+         expect(() => {\n+           router.navigateByUrl('/throwing');\n+           advance(fixture);\n+         }).toThrow();\n+         expect(location.path()).toEqual('/');\n+         expect(fixture.nativeElement.innerHTML).not.toContain('throwing');\n+\n+         // Ensure we can re-navigate to that same URL and succeed.\n+         ConditionalThrowingCmp.throwError = false;\n+         router.navigateByUrl('/throwing');\n+         advance(fixture);\n+         expect(location.path()).toEqual('/throwing');\n+         expect(fixture.nativeElement.innerHTML).toContain('throwing');\n+       }));\n+\n     it('should reset the url with the right state when navigation errors', fakeAsync(() => {\n          const router: Router = TestBed.inject(Router);\n          const location = TestBed.inject(Location) as SpyLocation;\n@@ -6222,6 +6320,15 @@ class ThrowingCmp {\n     throw new Error('Throwing Cmp');\n   }\n }\n+@Component({selector: 'conditional-throwing-cmp', template: 'conditional throwing'})\n+class ConditionalThrowingCmp {\n+  static throwError = true;\n+  constructor() {\n+    if (ConditionalThrowingCmp.throwError) {\n+      throw new Error('Throwing Cmp');\n+    }\n+  }\n+}\n \n \n \n@@ -6272,7 +6379,8 @@ class LazyComponent {\n     RootCmpWithTwoOutlets,\n     RootCmpWithNamedOutlet,\n     EmptyQueryParamsCmp,\n-    ThrowingCmp\n+    ThrowingCmp,\n+    ConditionalThrowingCmp,\n   ],\n \n \n@@ -6304,7 +6412,8 @@ class LazyComponent {\n     RootCmpWithTwoOutlets,\n     RootCmpWithNamedOutlet,\n     EmptyQueryParamsCmp,\n-    ThrowingCmp\n+    ThrowingCmp,\n+    ConditionalThrowingCmp,\n   ],\n \n \n@@ -6337,7 +6446,8 @@ class LazyComponent {\n     RootCmpWithTwoOutlets,\n     RootCmpWithNamedOutlet,\n     EmptyQueryParamsCmp,\n-    ThrowingCmp\n+    ThrowingCmp,\n+    ConditionalThrowingCmp,\n   ]\n })\n class TestModule {"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 128,
        "deletions": 18
    }
}