{
    "author": "crisbeto",
    "message": "fix(core): error if DebugRenderer2.destroyNode is called twice in a row (#41565)\n\nFixes an error that will be thrown if  `DebugRenderer2.destroyNode` is called with a node that has already been destroyed. The error happened, because we had a non-null assertion, even though the value can be null.\n\nNote that this fix applies only to ViewEngine, because Ivy doesn't provide the `DebugRenderer2`. I decided to resolve it, because it fix is straightforward and this error has been showing up in our logs for a long time now, making actual errors harder to find.\n\nPR Close #41565",
    "sha": "aa0e54fe971b1cb7e0372674ff59eed47f835f41",
    "files": [
        {
            "sha": "d62efa68eae7ba6b3d7f686a688b0d30189f3c3d",
            "filename": "packages/core/src/view/services.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/aa0e54fe971b1cb7e0372674ff59eed47f835f41/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa0e54fe971b1cb7e0372674ff59eed47f835f41/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts?ref=aa0e54fe971b1cb7e0372674ff59eed47f835f41",
            "patch": "@@ -703,11 +703,15 @@ export class DebugRenderer2 implements Renderer2 {\n   }\n \n   destroyNode(node: any) {\n-    const debugNode = getDebugNode(node)!;\n-    removeDebugNodeFromIndex(debugNode);\n-    if (debugNode instanceof DebugNode__PRE_R3__) {\n-      debugNode.listeners.length = 0;\n+    const debugNode = getDebugNode(node);\n+\n+    if (debugNode) {\n+      removeDebugNodeFromIndex(debugNode);\n+      if (debugNode instanceof DebugNode__PRE_R3__) {\n+        debugNode.listeners.length = 0;\n+      }\n     }\n+\n     if (this.delegate.destroyNode) {\n       this.delegate.destroyNode(node);\n     }"
        },
        {
            "sha": "ca44fa61871e552c0c3edd4ba02288e38b93dc7c",
            "filename": "packages/core/test/debug/debug_node_spec.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/aa0e54fe971b1cb7e0372674ff59eed47f835f41/packages%2Fcore%2Ftest%2Fdebug%2Fdebug_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/aa0e54fe971b1cb7e0372674ff59eed47f835f41/packages%2Fcore%2Ftest%2Fdebug%2Fdebug_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fdebug%2Fdebug_node_spec.ts?ref=aa0e54fe971b1cb7e0372674ff59eed47f835f41",
            "patch": "@@ -208,6 +208,7 @@ class TestApp {\n   width = 200;\n   color = 'red';\n   isClosed = true;\n+  constructor(public renderer: Renderer2) {}\n }\n \n @Component({selector: 'test-cmpt', template: ``})\n@@ -618,6 +619,22 @@ class TestCmptWithPropInterpolation {\n       expect(fixture.debugElement.query(By.css('.myclass'))).toBeTruthy();\n     });\n \n+    it('should not throw when calling DebugRenderer2.destroyNode twice in a row', () => {\n+      const fixture = TestBed.createComponent(TestApp);\n+      fixture.detectChanges();\n+      const firstChild = fixture.debugElement.children[0];\n+      const renderer = fixture.componentInstance.renderer;\n+\n+      expect(firstChild).toBeTruthy();\n+      expect(() => {\n+        // `destroyNode` needs to be null checked, because only ViewEngine provides a\n+        // `DebugRenderer2` which has the behavior we're testing for. Ivy provides\n+        // `BaseAnimationRenderer` which doesn't have the issue.\n+        renderer.destroyNode?.(firstChild);\n+        renderer.destroyNode?.(firstChild);\n+      }).not.toThrow();\n+    });\n+\n     describe('DebugElement.query with dynamically created descendant elements', () => {\n       let fixture: ComponentFixture<{}>;\n       beforeEach(() => {"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 25,
        "deletions": 4
    }
}