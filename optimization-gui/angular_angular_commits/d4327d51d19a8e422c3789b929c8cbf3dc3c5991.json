{
    "author": "JoostK",
    "message": "feat(compiler-cli): JIT compilation of component declarations (#40127)\n\nThe `ɵɵngDeclareComponent` calls are designed to be translated to fully\nAOT compiled code during a build transform, but in cases this is not\ndone it is still possible to compile the declaration object in the\nbrowser using the JIT compiler. This commit adds a runtime\nimplementation of `ɵɵngDeclareComponent` which invokes the JIT compiler\nusing the declaration object, such that a compiled component definition\nis made available to the Ivy runtime.\n\nPR Close #40127",
    "sha": "d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
    "files": [
        {
            "sha": "d309596fb479307b9970c7b811166f17d7af7d76",
            "filename": "packages/compiler-cli/linker/src/file_linker/partial_linkers/partial_component_linker_1.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Ffile_linker%2Fpartial_linkers%2Fpartial_component_linker_1.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {compileComponentFromMetadata, ConstantPool, DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig, makeBindingParser, parseTemplate, R3ComponentMetadata, R3DeclareComponentMetadata, R3PartialDeclaration, R3UsedDirectiveMetadata} from '@angular/compiler';\n+import {compileComponentFromMetadata, ConstantPool, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig, makeBindingParser, parseTemplate, R3ComponentMetadata, R3DeclareComponentMetadata, R3PartialDeclaration, R3UsedDirectiveMetadata} from '@angular/compiler';\n import {ChangeDetectionStrategy, ViewEncapsulation} from '@angular/compiler/src/core';\n import * as o from '@angular/compiler/src/output/output_ast';\n \n@@ -63,7 +63,7 @@ export function toR3ComponentMeta<TExpression>(\n         templateSource.expression, `Errors found in the template:\\n${errors}`);\n   }\n \n-  let wrapDirectivesAndPipesInClosure = false;\n+  let declarationListEmitMode = DeclarationListEmitMode.Direct;\n \n   let directives: R3UsedDirectiveMetadata[] = [];\n   if (metaObj.has('directives')) {\n@@ -76,7 +76,7 @@ export function toR3ComponentMeta<TExpression>(\n       const forwardRefType = extractForwardRef(type);\n       if (forwardRefType !== null) {\n         typeExpr = forwardRefType;\n-        wrapDirectivesAndPipesInClosure = true;\n+        declarationListEmitMode = DeclarationListEmitMode.Closure;\n       }\n \n       return {\n@@ -100,7 +100,7 @@ export function toR3ComponentMeta<TExpression>(\n     pipes = metaObj.getObject('pipes').toMap(pipe => {\n       const forwardRefType = extractForwardRef(pipe);\n       if (forwardRefType !== null) {\n-        wrapDirectivesAndPipesInClosure = true;\n+        declarationListEmitMode = DeclarationListEmitMode.Closure;\n         return forwardRefType;\n       } else {\n         return pipe.getOpaque();\n@@ -115,7 +115,7 @@ export function toR3ComponentMeta<TExpression>(\n       nodes: template.nodes,\n       ngContentSelectors: template.ngContentSelectors,\n     },\n-    wrapDirectivesAndPipesInClosure,\n+    declarationListEmitMode,\n     styles: metaObj.has('styles') ? metaObj.getArray('styles').map(entry => entry.getString()) : [],\n     encapsulation: metaObj.has('encapsulation') ?\n         parseEncapsulation(metaObj.getValue('encapsulation')) :"
        },
        {
            "sha": "7c2979297bc9348fcfffb5edc868017c307899d1",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {compileComponentFromMetadata, compileDeclareComponentFromMetadata, ConstantPool, CssSelector, DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Expression, ExternalExpr, Identifiers, InterpolationConfig, LexerRange, makeBindingParser, ParsedTemplate, ParseSourceFile, parseTemplate, R3ComponentDef, R3ComponentMetadata, R3FactoryTarget, R3TargetBinder, R3UsedDirectiveMetadata, SelectorMatcher, Statement, syntaxError, TmplAstNode, WrappedNodeExpr} from '@angular/compiler';\n+import {compileComponentFromMetadata, compileDeclareComponentFromMetadata, ConstantPool, CssSelector, DeclarationListEmitMode, DEFAULT_INTERPOLATION_CONFIG, DomElementSchemaRegistry, Expression, ExternalExpr, Identifiers, InterpolationConfig, LexerRange, makeBindingParser, ParsedTemplate, ParseSourceFile, parseTemplate, R3ComponentDef, R3ComponentMetadata, R3FactoryTarget, R3TargetBinder, R3UsedDirectiveMetadata, SelectorMatcher, Statement, TmplAstNode, WrappedNodeExpr} from '@angular/compiler';\n import * as ts from 'typescript';\n \n import {CycleAnalyzer} from '../../cycles';\n@@ -42,7 +42,7 @@ const EMPTY_ARRAY: any[] = [];\n  * be included here.\n  */\n export type ComponentMetadataResolvedFields =\n-    SubsetOfKeys<R3ComponentMetadata, 'directives'|'pipes'|'wrapDirectivesAndPipesInClosure'>;\n+    SubsetOfKeys<R3ComponentMetadata, 'directives'|'pipes'|'declarationListEmitMode'>;\n \n export interface ComponentAnalysisData {\n   /**\n@@ -451,7 +451,7 @@ export class ComponentDecoratorHandler implements\n     const data: ComponentResolutionData = {\n       directives: EMPTY_ARRAY,\n       pipes: EMPTY_MAP,\n-      wrapDirectivesAndPipesInClosure: false,\n+      declarationListEmitMode: DeclarationListEmitMode.Direct,\n     };\n \n     if (scope !== null && (!scope.compilation.isPoisoned || this.usePoisonedData)) {\n@@ -549,7 +549,9 @@ export class ComponentDecoratorHandler implements\n \n         data.directives = usedDirectives;\n         data.pipes = new Map(usedPipes.map(pipe => [pipe.pipeName, pipe.expression]));\n-        data.wrapDirectivesAndPipesInClosure = wrapDirectivesAndPipesInClosure;\n+        data.declarationListEmitMode = wrapDirectivesAndPipesInClosure ?\n+            DeclarationListEmitMode.Closure :\n+            DeclarationListEmitMode.Direct;\n       } else {\n         // Declaring the directiveDefs/pipeDefs arrays directly would require imports that would\n         // create a cycle. Instead, mark this component as requiring remote scoping, so that the"
        },
        {
            "sha": "55051b92a41230df786ea2e50833dd7220a4d821",
            "filename": "packages/compiler/src/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fcompiler_facade_interface.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -42,6 +42,9 @@ export interface CompilerFacade {\n       declaration: R3DeclareDirectiveFacade): any;\n   compileComponent(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3ComponentMetadataFacade): any;\n+  compileComponentDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      declaration: R3DeclareComponentFacade): any;\n   compileFactory(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3FactoryDefMetadataFacade): any;\n \n@@ -187,6 +190,24 @@ export interface R3DeclareDirectiveFacade {\n   usesOnChanges?: boolean;\n }\n \n+export interface R3DeclareComponentFacade extends R3DeclareDirectiveFacade {\n+  template: {source: string; isInline: boolean;};\n+  styles?: string[];\n+  directives?: {\n+    selector: string; type: OpaqueValue | (() => OpaqueValue);\n+    inputs?: string[];\n+    outputs?: string[];\n+    exportAs?: string[];\n+  }[];\n+  pipes?: {[pipeName: string]: OpaqueValue|(() => OpaqueValue)};\n+  viewProviders?: OpaqueValue;\n+  animations?: OpaqueValue;\n+  changeDetection?: ChangeDetectionStrategy;\n+  encapsulation?: ViewEncapsulation;\n+  interpolation?: [string, string];\n+  preserveWhitespaces?: boolean;\n+}\n+\n export interface R3UsedDirectiveMetadata {\n   selector: string;\n   inputs: string[];"
        },
        {
            "sha": "5ee1c6328c36f45420d05aa5afe18a5b5c29fe01",
            "filename": "packages/compiler/src/jit_compiler_facade.ts",
            "status": "modified",
            "additions": 95,
            "deletions": 23,
            "changes": 118,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fjit_compiler_facade.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -7,9 +7,9 @@\n  */\n \n \n-import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareDirectiveFacade, R3DeclareQueryMetadataFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n+import {CompilerFacade, CoreEnvironment, ExportedCompilerFacade, OpaqueValue, R3ComponentMetadataFacade, R3DeclareComponentFacade, R3DeclareDirectiveFacade, R3DeclareQueryMetadataFacade, R3DependencyMetadataFacade, R3DirectiveMetadataFacade, R3FactoryDefMetadataFacade, R3InjectableMetadataFacade, R3InjectorMetadataFacade, R3NgModuleMetadataFacade, R3PipeMetadataFacade, R3QueryMetadataFacade, StringMap, StringMapWithRename} from './compiler_facade_interface';\n import {ConstantPool} from './constant_pool';\n-import {HostBinding, HostListener, Input, Output, Type} from './core';\n+import {ChangeDetectionStrategy, HostBinding, HostListener, Input, Output, Type, ViewEncapsulation} from './core';\n import {Identifiers} from './identifiers';\n import {compileInjectable} from './injectable_compiler_2';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from './ml_parser/interpolation_config';\n@@ -21,7 +21,7 @@ import {R3JitReflector} from './render3/r3_jit';\n import {compileInjector, compileNgModule, R3InjectorMetadata, R3NgModuleMetadata} from './render3/r3_module_compiler';\n import {compilePipeFromMetadata, R3PipeMetadata} from './render3/r3_pipe_compiler';\n import {R3Reference} from './render3/util';\n-import {R3ComponentMetadata, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata} from './render3/view/api';\n+import {DeclarationListEmitMode, R3ComponentMetadata, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata, R3UsedDirectiveMetadata} from './render3/view/api';\n import {compileComponentFromMetadata, compileDirectiveFromMetadata, ParsedHostBindings, parseHostBindings, verifyHostBindings} from './render3/view/compiler';\n import {makeBindingParser, parseTemplate} from './render3/view/template';\n import {ResourceLoader} from './resource_loader';\n@@ -132,44 +132,48 @@ export class CompilerFacadeImpl implements CompilerFacade {\n   compileComponent(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n       facade: R3ComponentMetadataFacade): any {\n-    // The ConstantPool is a requirement of the JIT'er.\n-    const constantPool = new ConstantPool();\n-\n-    const interpolationConfig = facade.interpolation ?\n-        InterpolationConfig.fromArray(facade.interpolation) :\n-        DEFAULT_INTERPOLATION_CONFIG;\n     // Parse the template and check for errors.\n-    const template = parseTemplate(\n-        facade.template, sourceMapUrl,\n-        {preserveWhitespaces: facade.preserveWhitespaces, interpolationConfig});\n-    if (template.errors !== null) {\n-      const errors = template.errors.map(err => err.toString()).join(', ');\n-      throw new Error(`Errors during JIT compilation of template for ${facade.name}: ${errors}`);\n-    }\n+    const {template, interpolation} = parseJitTemplate(\n+        facade.template, facade.name, sourceMapUrl, facade.preserveWhitespaces,\n+        facade.interpolation);\n \n     // Compile the component metadata, including template, into an expression.\n-    // TODO(alxhub): implement inputs, outputs, queries, etc.\n-    const metadata: R3ComponentMetadata = {\n+    const meta: R3ComponentMetadata = {\n       ...facade as R3ComponentMetadataFacadeNoPropAndWhitespace,\n       ...convertDirectiveFacadeToMetadata(facade),\n       selector: facade.selector || this.elementSchemaRegistry.getDefaultComponentElementName(),\n       template,\n-      wrapDirectivesAndPipesInClosure: false,\n+      declarationListEmitMode: DeclarationListEmitMode.Direct,\n       styles: [...facade.styles, ...template.styles],\n       encapsulation: facade.encapsulation as any,\n-      interpolation: interpolationConfig,\n+      interpolation,\n       changeDetection: facade.changeDetection,\n       animations: facade.animations != null ? new WrappedNodeExpr(facade.animations) : null,\n       viewProviders: facade.viewProviders != null ? new WrappedNodeExpr(facade.viewProviders) :\n                                                     null,\n       relativeContextFilePath: '',\n       i18nUseExternalIds: true,\n     };\n-    const res = compileComponentFromMetadata(\n-        metadata, constantPool, makeBindingParser(interpolationConfig));\n     const jitExpressionSourceMap = `ng:///${facade.name}.js`;\n+    return this.compileComponentFromMeta(angularCoreEnv, jitExpressionSourceMap, meta);\n+  }\n+\n+  compileComponentDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      declaration: R3DeclareComponentFacade): any {\n+    const typeSourceSpan =\n+        this.createParseSourceSpan('Component', declaration.type.name, sourceMapUrl);\n+    const meta = convertDeclareComponentFacadeToMetadata(declaration, typeSourceSpan, sourceMapUrl);\n+    return this.compileComponentFromMeta(angularCoreEnv, sourceMapUrl, meta);\n+  }\n+\n+  private compileComponentFromMeta(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3ComponentMetadata): any {\n+    const constantPool = new ConstantPool();\n+    const bindingParser = makeBindingParser(meta.interpolation);\n+    const res = compileComponentFromMetadata(meta, constantPool, bindingParser);\n     return this.jitExpression(\n-        res.expression, angularCoreEnv, jitExpressionSourceMap, constantPool.statements);\n+        res.expression, angularCoreEnv, sourceMapUrl, constantPool.statements);\n   }\n \n   compileFactory(\n@@ -337,6 +341,74 @@ function convertOpaqueValuesToExpressions(obj: {[key: string]: OpaqueValue}):\n   return result;\n }\n \n+function convertDeclareComponentFacadeToMetadata(\n+    declaration: R3DeclareComponentFacade, typeSourceSpan: ParseSourceSpan,\n+    sourceMapUrl: string): R3ComponentMetadata {\n+  const {template, interpolation} = parseJitTemplate(\n+      declaration.template.source, declaration.type.name, sourceMapUrl,\n+      declaration.preserveWhitespaces ?? false, declaration.interpolation);\n+\n+  return {\n+    ...convertDeclareDirectiveFacadeToMetadata(declaration, typeSourceSpan),\n+    template,\n+    styles: declaration.styles ?? [],\n+    directives: (declaration.directives ?? []).map(convertUsedDirectiveDeclarationToMetadata),\n+    pipes: convertUsedPipesToMetadata(declaration.pipes),\n+    viewProviders: declaration.viewProviders !== undefined ?\n+        new WrappedNodeExpr(declaration.viewProviders) :\n+        null,\n+    animations: declaration.animations !== undefined ? new WrappedNodeExpr(declaration.animations) :\n+                                                       null,\n+    changeDetection: declaration.changeDetection ?? ChangeDetectionStrategy.Default,\n+    encapsulation: declaration.encapsulation ?? ViewEncapsulation.Emulated,\n+    interpolation,\n+    declarationListEmitMode: DeclarationListEmitMode.ClosureResolved,\n+    relativeContextFilePath: '',\n+    i18nUseExternalIds: true,\n+  };\n+}\n+\n+function convertUsedDirectiveDeclarationToMetadata(\n+    declaration: NonNullable<R3DeclareComponentFacade['directives']>[number]):\n+    R3UsedDirectiveMetadata {\n+  return {\n+    selector: declaration.selector,\n+    type: new WrappedNodeExpr(declaration.type),\n+    inputs: declaration.inputs ?? [],\n+    outputs: declaration.outputs ?? [],\n+    exportAs: declaration.exportAs ?? null,\n+  };\n+}\n+\n+function convertUsedPipesToMetadata(declaredPipes: R3DeclareComponentFacade['pipes']):\n+    Map<string, Expression> {\n+  const pipes = new Map<string, Expression>();\n+  if (declaredPipes === undefined) {\n+    return pipes;\n+  }\n+\n+  for (const pipeName of Object.keys(declaredPipes)) {\n+    const pipeType = declaredPipes[pipeName];\n+    pipes.set(pipeName, new WrappedNodeExpr(pipeType));\n+  }\n+  return pipes;\n+}\n+\n+function parseJitTemplate(\n+    template: string, typeName: string, sourceMapUrl: string, preserveWhitespaces: boolean,\n+    interpolation: [string, string]|undefined) {\n+  const interpolationConfig =\n+      interpolation ? InterpolationConfig.fromArray(interpolation) : DEFAULT_INTERPOLATION_CONFIG;\n+  // Parse the template and check for errors.\n+  const parsed = parseTemplate(\n+      template, sourceMapUrl, {preserveWhitespaces: preserveWhitespaces, interpolationConfig});\n+  if (parsed.errors !== null) {\n+    const errors = parsed.errors.map(err => err.toString()).join(', ');\n+    throw new Error(`Errors during JIT compilation of template for ${typeName}: ${errors}`);\n+  }\n+  return {template: parsed, interpolation: interpolationConfig};\n+}\n+\n // This seems to be needed to placate TS v3.0 only\n type R3DirectiveMetadataFacadeNoPropAndWhitespace =\n     Pick<R3DirectiveMetadataFacade, Exclude<keyof R3DirectiveMetadataFacade, 'propMetadata'>>;"
        },
        {
            "sha": "87de9be5c12d1e827d2803c33e2a8ba384c89a63",
            "filename": "packages/compiler/src/render3/partial/component.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fcomponent.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -9,7 +9,7 @@ import * as core from '../../core';\n import {DEFAULT_INTERPOLATION_CONFIG} from '../../ml_parser/interpolation_config';\n import * as o from '../../output/output_ast';\n import {Identifiers as R3} from '../r3_identifiers';\n-import {R3ComponentDef, R3ComponentMetadata, R3UsedDirectiveMetadata} from '../view/api';\n+import {DeclarationListEmitMode, R3ComponentDef, R3ComponentMetadata, R3UsedDirectiveMetadata} from '../view/api';\n import {createComponentType} from '../view/compiler';\n import {ParsedTemplate} from '../view/template';\n import {DefinitionMap} from '../view/util';\n@@ -91,8 +91,9 @@ function compileTemplateDefinition(template: ParsedTemplate): o.LiteralMapExpr {\n  * individual directives. If the component does not use any directives, then null is returned.\n  */\n function compileUsedDirectiveMetadata(meta: R3ComponentMetadata): o.LiteralArrayExpr|null {\n-  const wrapType =\n-      meta.wrapDirectivesAndPipesInClosure ? generateForwardRef : (expr: o.Expression) => expr;\n+  const wrapType = meta.declarationListEmitMode !== DeclarationListEmitMode.Direct ?\n+      generateForwardRef :\n+      (expr: o.Expression) => expr;\n \n   return toOptionalLiteralArray(meta.directives, directive => {\n     const dirMeta = new DefinitionMap<R3UsedDirectiveMetadata>();\n@@ -115,8 +116,9 @@ function compileUsedPipeMetadata(meta: R3ComponentMetadata): o.LiteralMapExpr|nu\n     return null;\n   }\n \n-  const wrapType =\n-      meta.wrapDirectivesAndPipesInClosure ? generateForwardRef : (expr: o.Expression) => expr;\n+  const wrapType = meta.declarationListEmitMode !== DeclarationListEmitMode.Direct ?\n+      generateForwardRef :\n+      (expr: o.Expression) => expr;\n \n   const entries = [];\n   for (const [name, pipe] of meta.pipes) {"
        },
        {
            "sha": "c4cb1d17711f4cbc73f69a89b66cf0ad22ed5949",
            "filename": "packages/compiler/src/render3/r3_identifiers.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fr3_identifiers.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -230,6 +230,7 @@ export class Identifiers {\n       o.ExternalReference = {name: 'ɵɵtemplateRefExtractor', moduleName: CORE};\n \n   static forwardRef: o.ExternalReference = {name: 'forwardRef', moduleName: CORE};\n+  static resolveForwardRef: o.ExternalReference = {name: 'resolveForwardRef', moduleName: CORE};\n \n   static resolveWindow: o.ExternalReference = {name: 'ɵɵresolveWindow', moduleName: CORE};\n   static resolveDocument: o.ExternalReference = {name: 'ɵɵresolveDocument', moduleName: CORE};"
        },
        {
            "sha": "4a207cc1a6e82f3bbb98863d2dc0fb4bb475e973",
            "filename": "packages/compiler/src/render3/view/api.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 4,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fapi.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -119,6 +119,50 @@ export interface R3DirectiveMetadata {\n   providers: o.Expression|null;\n }\n \n+/**\n+ * Specifies how a list of declaration type references should be emitted into the generated code.\n+ */\n+export const enum DeclarationListEmitMode {\n+  /**\n+   * The list of declarations is emitted into the generated code as is.\n+   *\n+   * ```\n+   * directives: [MyDir],\n+   * ```\n+   */\n+  Direct,\n+\n+  /**\n+   * The list of declarations is emitted into the generated code wrapped inside a closure, which\n+   * is needed when at least one declaration is a forward reference.\n+   *\n+   * ```\n+   * directives: function () { return [MyDir, ForwardDir]; },\n+   * ```\n+   */\n+  Closure,\n+\n+  /**\n+   * Similar to `Closure`, with the addition that the list of declarations can contain individual\n+   * items that are themselves forward references. This is relevant for JIT compilations, as\n+   * unwrapping the forwardRef cannot be done statically so must be deferred. This mode emits\n+   * the declaration list using a mapping transform through `resolveForwardRef` to ensure that\n+   * any forward references within the list are resolved when the outer closure is invoked.\n+   *\n+   * Consider the case where the runtime has captured two declarations in two distinct values:\n+   * ```\n+   * const dirA = MyDir;\n+   * const dirB = forwardRef(function() { return ForwardRef; });\n+   * ```\n+   *\n+   * This mode would emit the declarations captured in `dirA` and `dirB` as follows:\n+   * ```\n+   * directives: function () { return [dirA, dirB].map(ng.resolveForwardRef); },\n+   * ```\n+   */\n+  ClosureResolved,\n+}\n+\n /**\n  * Information needed to compile a component for the render3 runtime.\n  */\n@@ -152,11 +196,9 @@ export interface R3ComponentMetadata extends R3DirectiveMetadata {\n   directives: R3UsedDirectiveMetadata[];\n \n   /**\n-   * Whether to wrap the 'directives' and/or `pipes` array, if one is generated, in a closure.\n-   *\n-   * This is done when the directives or pipes contain forward references.\n+   * Specifies how the 'directives' and/or `pipes` array, if generated, need to be emitted.\n    */\n-  wrapDirectivesAndPipesInClosure: boolean;\n+  declarationListEmitMode: DeclarationListEmitMode;\n \n   /**\n    * A collection of styling data that will be applied and scoped to the component."
        },
        {
            "sha": "a6eb649a32309a611997dc1ff8709447d4dd501b",
            "filename": "packages/compiler/src/render3/view/compiler.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 10,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -27,7 +27,7 @@ import {Identifiers as R3} from '../r3_identifiers';\n import {Render3ParseResult} from '../r3_template_transform';\n import {prepareSyntheticListenerFunctionName, prepareSyntheticPropertyName, typeWithParameters} from '../util';\n \n-import {R3ComponentDef, R3ComponentMetadata, R3DirectiveDef, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata} from './api';\n+import {DeclarationListEmitMode, R3ComponentDef, R3ComponentMetadata, R3DirectiveDef, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata} from './api';\n import {MIN_STYLING_BINDING_SLOTS_REQUIRED, StylingBuilder, StylingInstructionCall} from './styling_builder';\n import {BindingScope, makeBindingParser, prepareEventListenerParameters, renderFlagCheckIfStmt, resolveSanitizationFn, TemplateDefinitionBuilder, ValueConverter} from './template';\n import {asLiteral, chainedInstruction, conditionallyCreateMapObjectLiteral, CONTEXT_NAME, DefinitionMap, getQueryPredicate, RENDER_FLAGS, TEMPORARY_NAME, temporaryAllocator} from './util';\n@@ -213,19 +213,15 @@ export function compileComponentFromMetadata(\n \n   // e.g. `directives: [MyDirective]`\n   if (directivesUsed.size) {\n-    let directivesExpr: o.Expression = o.literalArr(Array.from(directivesUsed));\n-    if (meta.wrapDirectivesAndPipesInClosure) {\n-      directivesExpr = o.fn([], [new o.ReturnStatement(directivesExpr)]);\n-    }\n+    const directivesList = o.literalArr(Array.from(directivesUsed));\n+    const directivesExpr = compileDeclarationList(directivesList, meta.declarationListEmitMode);\n     definitionMap.set('directives', directivesExpr);\n   }\n \n   // e.g. `pipes: [MyPipe]`\n   if (pipesUsed.size) {\n-    let pipesExpr: o.Expression = o.literalArr(Array.from(pipesUsed));\n-    if (meta.wrapDirectivesAndPipesInClosure) {\n-      pipesExpr = o.fn([], [new o.ReturnStatement(pipesExpr)]);\n-    }\n+    const pipesList = o.literalArr(Array.from(pipesUsed));\n+    const pipesExpr = compileDeclarationList(pipesList, meta.declarationListEmitMode);\n     definitionMap.set('pipes', pipesExpr);\n   }\n \n@@ -277,6 +273,26 @@ export function createComponentType(meta: R3ComponentMetadata): o.Type {\n   return o.expressionType(o.importExpr(R3.ComponentDefWithMeta, typeParams));\n }\n \n+/**\n+ * Compiles the array literal of declarations into an expression according to the provided emit\n+ * mode.\n+ */\n+function compileDeclarationList(\n+    list: o.LiteralArrayExpr, mode: DeclarationListEmitMode): o.Expression {\n+  switch (mode) {\n+    case DeclarationListEmitMode.Direct:\n+      // directives: [MyDir],\n+      return list;\n+    case DeclarationListEmitMode.Closure:\n+      // directives: function () { return [MyDir]; }\n+      return o.fn([], [new o.ReturnStatement(list)]);\n+    case DeclarationListEmitMode.ClosureResolved:\n+      // directives: function () { return [MyDir].map(ng.resolveForwardRef); }\n+      const resolvedList = list.callMethod('map', [o.importExpr(R3.resolveForwardRef)]);\n+      return o.fn([], [new o.ReturnStatement(resolvedList)]);\n+  }\n+}\n+\n /**\n  * A wrapper around `compileDirective` which depends on render2 global analysis data as its input\n  * instead of the `R3DirectiveMetadata`.\n@@ -335,7 +351,7 @@ export function compileComponentFromRender2(\n     directives: [],\n     pipes: typeMapToExpressionMap(pipeTypeByName, outputCtx),\n     viewQueries: queriesFromGlobalMetadata(component.viewQueries, outputCtx),\n-    wrapDirectivesAndPipesInClosure: false,\n+    declarationListEmitMode: DeclarationListEmitMode.Direct,\n     styles: (summary.template && summary.template.styles) || EMPTY_ARRAY,\n     encapsulation:\n         (summary.template && summary.template.encapsulation) || core.ViewEncapsulation.Emulated,"
        },
        {
            "sha": "ebb49c9c29f6b725e504aec2ff5c375a3784687e",
            "filename": "packages/compiler/test/compiler_facade_interface_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fcompiler_facade_interface_spec.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -108,6 +108,16 @@ const coreR3DeclareDirectiveFacade: core.R3DeclareDirectiveFacade =\n const compilerR3DeclareDirectiveFacade: compiler.R3DeclareDirectiveFacade =\n     null! as core.R3DeclareDirectiveFacade;\n \n+const coreR3DeclareComponentFacade: core.R3DeclareComponentFacade =\n+    null! as compiler.R3DeclareComponentFacade;\n+const compilerR3DeclareComponentFacade: compiler.R3DeclareComponentFacade =\n+    null! as core.R3DeclareComponentFacade;\n+\n+const coreR3UsedDirectiveMetadata: core.R3UsedDirectiveMetadata =\n+    null! as compiler.R3UsedDirectiveMetadata;\n+const compilerR3UsedDirectiveMetadata: compiler.R3UsedDirectiveMetadata =\n+    null! as core.R3UsedDirectiveMetadata;\n+\n const coreViewEncapsulation: core.ViewEncapsulation = null! as compiler.ViewEncapsulation;\n const compilerViewEncapsulation: compiler.ViewEncapsulation = null! as core.ViewEncapsulation;\n "
        },
        {
            "sha": "55051b92a41230df786ea2e50833dd7220a4d821",
            "filename": "packages/core/src/compiler/compiler_facade_interface.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcompiler%2Fcompiler_facade_interface.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -42,6 +42,9 @@ export interface CompilerFacade {\n       declaration: R3DeclareDirectiveFacade): any;\n   compileComponent(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3ComponentMetadataFacade): any;\n+  compileComponentDeclaration(\n+      angularCoreEnv: CoreEnvironment, sourceMapUrl: string,\n+      declaration: R3DeclareComponentFacade): any;\n   compileFactory(\n       angularCoreEnv: CoreEnvironment, sourceMapUrl: string, meta: R3FactoryDefMetadataFacade): any;\n \n@@ -187,6 +190,24 @@ export interface R3DeclareDirectiveFacade {\n   usesOnChanges?: boolean;\n }\n \n+export interface R3DeclareComponentFacade extends R3DeclareDirectiveFacade {\n+  template: {source: string; isInline: boolean;};\n+  styles?: string[];\n+  directives?: {\n+    selector: string; type: OpaqueValue | (() => OpaqueValue);\n+    inputs?: string[];\n+    outputs?: string[];\n+    exportAs?: string[];\n+  }[];\n+  pipes?: {[pipeName: string]: OpaqueValue|(() => OpaqueValue)};\n+  viewProviders?: OpaqueValue;\n+  animations?: OpaqueValue;\n+  changeDetection?: ChangeDetectionStrategy;\n+  encapsulation?: ViewEncapsulation;\n+  interpolation?: [string, string];\n+  preserveWhitespaces?: boolean;\n+}\n+\n export interface R3UsedDirectiveMetadata {\n   selector: string;\n   inputs: string[];"
        },
        {
            "sha": "97ec1d822a0f43c2939a509caa09f6e804d279ea",
            "filename": "packages/core/src/render3/jit/environment.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fenvironment.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fenvironment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fenvironment.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {forwardRef} from '../../di/forward_ref';\n+import {forwardRef, resolveForwardRef} from '../../di/forward_ref';\n import {ɵɵinject, ɵɵinvalidFactoryDep} from '../../di/injector_compatibility';\n import {ɵɵdefineInjectable, ɵɵdefineInjector} from '../../di/interface/defs';\n import * as sanitization from '../../sanitization/sanitization';\n@@ -170,4 +170,5 @@ export const angularCoreEnv: {[name: string]: Function} =\n        'ɵɵtrustConstantResourceUrl': sanitization.ɵɵtrustConstantResourceUrl,\n \n        'forwardRef': forwardRef,\n+       'resolveForwardRef': resolveForwardRef,\n      }))();"
        },
        {
            "sha": "7a2b359d0460027c4eb15cec9d2e6a49738ef813",
            "filename": "packages/core/src/render3/jit/partial.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fjit%2Fpartial.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getCompilerFacade, R3DeclareDirectiveFacade} from '../../compiler/compiler_facade';\n+import {getCompilerFacade, R3DeclareComponentFacade, R3DeclareDirectiveFacade} from '../../compiler/compiler_facade';\n import {angularCoreEnv} from './environment';\n \n /**\n@@ -25,6 +25,8 @@ export function ɵɵngDeclareDirective(decl: R3DeclareDirectiveFacade): unknown\n  *\n  * @codeGenApi\n  */\n-export function ɵɵngDeclareComponent(decl: unknown): unknown {\n-  throw new Error('Not yet implemented');\n+export function ɵɵngDeclareComponent(decl: R3DeclareComponentFacade): unknown {\n+  const compiler = getCompilerFacade();\n+  return compiler.compileComponentDeclaration(\n+      angularCoreEnv, `ng:///${decl.type.name}/ɵcmp.js`, decl);\n }"
        },
        {
            "sha": "baa07488c552d2b838bdae7f7d6779d173aacec0",
            "filename": "packages/core/test/render3/jit/declare_component_spec.ts",
            "status": "added",
            "additions": 539,
            "deletions": 0,
            "changes": 539,
            "blob_url": "https://github.com/angular/angular/blob/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_component_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d4327d51d19a8e422c3789b929c8cbf3dc3c5991/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_component_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fjit%2Fdeclare_component_spec.ts?ref=d4327d51d19a8e422c3789b929c8cbf3dc3c5991",
            "patch": "@@ -0,0 +1,539 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ChangeDetectionStrategy, Directive, ElementRef, forwardRef, Pipe, Type, ViewEncapsulation, ɵɵngDeclareComponent} from '@angular/core';\n+import {AttributeMarker, ComponentDef} from '../../../src/render3';\n+import {functionContaining} from './matcher';\n+\n+describe('component declaration jit compilation', () => {\n+  it('should compile a minimal component declaration', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate(`<div></div>`),\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      template: functionContaining([\n+        /element[^(]*\\(0,'div'\\)/,\n+      ]),\n+    });\n+  });\n+\n+  it('should compile a selector', () => {\n+    const def =\n+        ɵɵngDeclareComponent(\n+            {type: TestClass, template: createTemplate('<div></div>'), selector: '[dir], test'}) as\n+        ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      selectors: [['', 'dir', ''], ['test']],\n+    });\n+  });\n+\n+  it('should compile inputs and outputs', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  inputs: {\n+                    minifiedProperty: 'property',\n+                    minifiedClassProperty: ['bindingName', 'classProperty'],\n+                  },\n+                  outputs: {\n+                    minifiedEventName: 'eventBindingName',\n+                  },\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      inputs: {\n+        'property': 'minifiedProperty',\n+        'bindingName': 'minifiedClassProperty',\n+      },\n+      declaredInputs: {\n+        'property': 'property',\n+        'bindingName': 'classProperty',\n+      },\n+      outputs: {\n+        'eventBindingName': 'minifiedEventName',\n+      },\n+    });\n+  });\n+\n+  it('should compile exportAs', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  exportAs: ['a', 'b'],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      exportAs: ['a', 'b'],\n+    });\n+  });\n+\n+  it('should compile providers', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  providers: [\n+                    {provide: 'token', useValue: 123},\n+                  ],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      features: [jasmine.any(Function)],\n+      providersResolver: jasmine.any(Function),\n+    });\n+  });\n+\n+  it('should compile view providers', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  viewProviders: [\n+                    {provide: 'token', useValue: 123},\n+                  ],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      features: [jasmine.any(Function)],\n+      providersResolver: jasmine.any(Function),\n+    });\n+  });\n+\n+  it('should compile content queries', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  queries: [\n+                    {\n+                      propertyName: 'byRef',\n+                      predicate: ['ref'],\n+                    },\n+                    {\n+                      propertyName: 'byToken',\n+                      predicate: String,\n+                      descendants: true,\n+                      static: true,\n+                      first: true,\n+                      read: ElementRef,\n+                    }\n+                  ],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      contentQueries: functionContaining([\n+        // \"byRef\" should use `contentQuery` with `false` for descendants flag without a read token,\n+        // and bind to the full query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:contentQuery|anonymous)[^(]*\\(dirIndex,_c0,false\\)/,\n+        '(ctx.byRef = _t)',\n+\n+        // \"byToken\" should use `staticContentQuery` with `true` for descendants flag and\n+        // `ElementRef` as read token, and bind to the first result in the query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:staticContentQuery|anonymous)[^(]*\\(dirIndex,[^,]*String[^,]*,true,[^)]*ElementRef[^)]*\\)/,\n+        '(ctx.byToken = _t.first)',\n+      ]),\n+    });\n+  });\n+\n+  it('should compile view queries', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  viewQueries: [\n+                    {\n+                      propertyName: 'byRef',\n+                      predicate: ['ref'],\n+                    },\n+                    {\n+                      propertyName: 'byToken',\n+                      predicate: String,\n+                      descendants: true,\n+                      static: true,\n+                      first: true,\n+                      read: ElementRef,\n+                    }\n+                  ],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      viewQuery: functionContaining([\n+        // \"byRef\" should use `viewQuery` with `false` for descendants flag without a read token,\n+        // and bind to the full query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:viewQuery|anonymous)[^(]*\\(_c0,false\\)/,\n+        '(ctx.byRef = _t)',\n+\n+        // \"byToken\" should use `staticViewQuery` with `true` for descendants flag and\n+        // `ElementRef` as read token, and bind to the first result in the query result.\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:staticViewQuery|anonymous)[^(]*\\([^,]*String[^,]*,true,[^)]*ElementRef[^)]*\\)/,\n+        '(ctx.byToken = _t.first)',\n+      ]),\n+    });\n+  });\n+\n+  it('should compile host bindings', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  host: {\n+                    attributes: {\n+                      'attr': 'value',\n+                    },\n+                    listeners: {\n+                      'event': 'handleEvent($event)',\n+                    },\n+                    properties: {\n+                      'foo': 'foo.prop',\n+                      'attr.bar': 'bar.prop',\n+                    },\n+                    classAttribute: 'foo bar',\n+                    styleAttribute: 'width: 100px;',\n+                  },\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      hostAttrs: [\n+        'attr', 'value', AttributeMarker.Classes, 'foo', 'bar', AttributeMarker.Styles, 'width',\n+        '100px'\n+      ],\n+      hostBindings: functionContaining([\n+        'return ctx.handleEvent($event)',\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:hostProperty|anonymous)[^(]*\\('foo',ctx\\.foo\\.prop\\)/,\n+        /(?:attribute|anonymous)[^(]*\\('bar',ctx\\.bar\\.prop\\)/,\n+      ]),\n+      hostVars: 2,\n+    });\n+  });\n+\n+  it('should compile components with inheritance', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  usesInheritance: true,\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      features: [functionContaining(['ɵɵInheritDefinitionFeature'])],\n+    });\n+  });\n+\n+  it('should compile components with onChanges lifecycle hook', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  usesOnChanges: true,\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      features: [functionContaining(['ɵɵNgOnChangesFeature'])],\n+    });\n+  });\n+\n+  it('should compile components with OnPush change detection strategy', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  changeDetection: ChangeDetectionStrategy.OnPush,\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      onPush: true,\n+    });\n+  });\n+\n+  it('should compile components with styles', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  styles: ['div {}'],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      styles: ['div[_ngcontent-%COMP%] {}'],\n+      encapsulation: ViewEncapsulation.Emulated,\n+    });\n+  });\n+\n+  it('should compile components with view encapsulation', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  styles: ['div {}'],\n+                  encapsulation: ViewEncapsulation.ShadowDom,\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      styles: ['div {}'],\n+      encapsulation: ViewEncapsulation.ShadowDom,\n+    });\n+  });\n+\n+  it('should compile components with animations', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div></div>'),\n+                  animations: [{type: 'trigger'}],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      data: {\n+        animation: [{type: 'trigger'}],\n+      },\n+    });\n+  });\n+\n+  it('should honor preserveWhitespaces', () => {\n+    const template = createTemplate('<div>    Foo    </div>');\n+    const whenTrue = ɵɵngDeclareComponent({\n+                       type: TestClass,\n+                       template,\n+                       preserveWhitespaces: true,\n+                     }) as ComponentDef<TestClass>;\n+    const whenOmitted = ɵɵngDeclareComponent({\n+                          type: TestClass,\n+                          template,\n+                        }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(whenTrue, {\n+      template: functionContaining([\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:elementStart|anonymous)[^(]*\\(0,'div'\\)/,\n+        /(?:text|anonymous)[^(]*\\(1,'    Foo    '\\)/,\n+      ]),\n+    });\n+    expectComponentDef(whenOmitted, {\n+      template: functionContaining([\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:elementStart|anonymous)[^(]*\\(0,'div'\\)/,\n+        /(?:text|anonymous)[^(]*\\(1,' Foo '\\)/,\n+      ]),\n+    });\n+  });\n+\n+  it('should honor custom interpolation config', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('{% foo %}'),\n+                  interpolation: ['{%', '%}'],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      template: functionContaining([\n+        // NOTE: the `anonymous` match is to support IE11, as functions don't have a name there.\n+        /(?:textInterpolate|anonymous)[^(]*\\(ctx.foo\\)/,\n+      ]),\n+    });\n+  });\n+\n+  it('should compile used directives', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div dir></div>'),\n+                  directives: [{\n+                    type: TestDir,\n+                    selector: '[dir]',\n+                  }],\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      directives: [TestDir],\n+    });\n+  });\n+\n+  it('should compile forward declared directives', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div forward></div>'),\n+                  directives: [{\n+                    type: forwardRef(function() {\n+                      return ForwardDir;\n+                    }),\n+                    selector: '[forward]',\n+                  }],\n+                }) as ComponentDef<TestClass>;\n+\n+    @Directive({selector: '[forward]'})\n+    class ForwardDir {\n+    }\n+\n+    expectComponentDef(def, {\n+      directives: [ForwardDir],\n+    });\n+  });\n+\n+  it('should compile mixed forward and direct declared directives', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('<div dir forward></div>'),\n+                  directives: [\n+                    {\n+                      type: TestDir,\n+                      selector: '[dir]',\n+                    },\n+                    {\n+                      type: forwardRef(function() {\n+                        return ForwardDir;\n+                      }),\n+                      selector: '[forward]',\n+                    }\n+                  ],\n+                }) as ComponentDef<TestClass>;\n+\n+    @Directive({selector: '[forward]'})\n+    class ForwardDir {\n+    }\n+\n+    expectComponentDef(def, {\n+      directives: [TestDir, ForwardDir],\n+    });\n+  });\n+\n+  it('should compile used pipes', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('{{ expr | test }}'),\n+                  pipes: {\n+                    'test': TestPipe,\n+                  },\n+                }) as ComponentDef<TestClass>;\n+\n+    expectComponentDef(def, {\n+      pipes: [TestPipe],\n+    });\n+  });\n+\n+  it('should compile forward declared pipes', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('{{ expr | forward }}'),\n+                  pipes: {\n+                    'forward': forwardRef(function() {\n+                      return ForwardPipe;\n+                    }),\n+                  },\n+                }) as ComponentDef<TestClass>;\n+\n+    @Pipe({name: 'forward'})\n+    class ForwardPipe {\n+    }\n+\n+    expectComponentDef(def, {\n+      pipes: [ForwardPipe],\n+    });\n+  });\n+\n+  it('should compile mixed forward and direct declared pipes', () => {\n+    const def = ɵɵngDeclareComponent({\n+                  type: TestClass,\n+                  template: createTemplate('{{ expr | forward | test }}'),\n+                  pipes: {\n+                    'test': TestPipe,\n+                    'forward': forwardRef(function() {\n+                      return ForwardPipe;\n+                    }),\n+                  },\n+                }) as ComponentDef<TestClass>;\n+\n+    @Pipe({name: 'forward'})\n+    class ForwardPipe {\n+    }\n+\n+    expectComponentDef(def, {\n+      pipes: [TestPipe, ForwardPipe],\n+    });\n+  });\n+});\n+\n+function createTemplate(template: string) {\n+  return {source: template, isInline: true};\n+}\n+\n+type ComponentDefExpectations = jasmine.Expected<Pick<\n+    ComponentDef<unknown>,\n+    'selectors'|'template'|'inputs'|'declaredInputs'|'outputs'|'features'|'hostAttrs'|\n+    'hostBindings'|'hostVars'|'contentQueries'|'viewQuery'|'exportAs'|'providersResolver'|\n+    'encapsulation'|'onPush'|'styles'|'data'>>&{\n+  directives: Type<unknown>[]|null;\n+  pipes: Type<unknown>[]|null;\n+};\n+\n+\n+/**\n+ * Asserts that the provided component definition is according to the provided expectation.\n+ * Definition fields for which no expectation is present are verified to be initialized to their\n+ * default value.\n+ */\n+function expectComponentDef(\n+    actual: ComponentDef<unknown>, expected: Partial<ComponentDefExpectations>): void {\n+  const expectation: ComponentDefExpectations = {\n+    selectors: [],\n+    template: jasmine.any(Function),\n+    inputs: {},\n+    declaredInputs: {},\n+    outputs: {},\n+    features: null,\n+    hostAttrs: null,\n+    hostBindings: null,\n+    hostVars: 0,\n+    contentQueries: null,\n+    viewQuery: null,\n+    exportAs: null,\n+    providersResolver: null,\n+    // Although the default view encapsulation is `Emulated`, the default expected view\n+    // encapsulation is `None` as this is chosen when no styles are present.\n+    encapsulation: ViewEncapsulation.None,\n+    onPush: false,\n+    styles: [],\n+    directives: null,\n+    pipes: null,\n+    data: {},\n+    ...expected,\n+  };\n+\n+  expect(actual.type).toBe(TestClass);\n+  expect(actual.selectors).toEqual(expectation.selectors);\n+  expect(actual.template).toEqual(expectation.template);\n+  expect(actual.inputs).toEqual(expectation.inputs);\n+  expect(actual.declaredInputs).toEqual(expectation.declaredInputs);\n+  expect(actual.outputs).toEqual(expectation.outputs);\n+  expect(actual.features).toEqual(expectation.features);\n+  expect(actual.hostAttrs).toEqual(expectation.hostAttrs);\n+  expect(actual.hostBindings).toEqual(expectation.hostBindings);\n+  expect(actual.hostVars).toEqual(expectation.hostVars);\n+  expect(actual.contentQueries).toEqual(expectation.contentQueries);\n+  expect(actual.viewQuery).toEqual(expectation.viewQuery);\n+  expect(actual.exportAs).toEqual(expectation.exportAs);\n+  expect(actual.providersResolver).toEqual(expectation.providersResolver);\n+  expect(actual.encapsulation).toEqual(expectation.encapsulation);\n+  expect(actual.onPush).toEqual(expectation.onPush);\n+  expect(actual.styles).toEqual(expectation.styles);\n+  expect(actual.data).toEqual(expectation.data);\n+\n+  const directiveDefs =\n+      typeof actual.directiveDefs === 'function' ? actual.directiveDefs() : actual.directiveDefs;\n+  const directiveTypes = directiveDefs !== null ? directiveDefs.map(def => def.type) : null;\n+  expect(directiveTypes).toEqual(expectation.directives);\n+\n+  const pipeDefs = typeof actual.pipeDefs === 'function' ? actual.pipeDefs() : actual.pipeDefs;\n+  const pipeTypes = pipeDefs !== null ? pipeDefs.map(def => def.type) : null;\n+  expect(pipeTypes).toEqual(expectation.pipes);\n+}\n+\n+class TestClass {}\n+\n+@Directive({selector: '[dir]'})\n+class TestDir {\n+}\n+\n+@Pipe({name: 'test'})\n+class TestPipe {\n+}"
        }
    ],
    "stats": {
        "total": 839,
        "additions": 784,
        "deletions": 55
    }
}