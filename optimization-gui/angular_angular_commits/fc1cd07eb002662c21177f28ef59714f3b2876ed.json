{
    "author": "mhevery",
    "message": "fix(core): Call `onDestroy` in production mode as well (#40120)\n\nPR #39876 introduced an error where the `onDestroy` of `ComponentRef`\nwould only get called if `ngDevMode` was set to true. This was because\nin dev mode we would freeze `TCleanup` to verify that no more\nstatic cleanup would get added to `TCleanup` array. This ensured\nthat `TCleanup` was always present in dev mode. In production the\n`TCleanup` would get created only when needed. The resulting cleanup\ncode was incorrectly indented and would only run if `TCleanup` was\npresent causing this issue.\n\nFix #40105\n\nPR Close #40120",
    "sha": "fc1cd07eb002662c21177f28ef59714f3b2876ed",
    "files": [
        {
            "sha": "de3b2c6e35ae9b3d45ba4f0b2e07c42fb6afb50e",
            "filename": "packages/core/src/render3/instructions/listener.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -19,7 +19,7 @@ import {assertTNodeType} from '../node_assert';\n import {getCurrentDirectiveDef, getCurrentTNode, getLView, getTView} from '../state';\n import {getComponentLViewByIndex, getNativeByTNode, unwrapRNode} from '../util/view_utils';\n \n-import {getLCleanup, getTViewCleanup, handleError, loadComponentRenderer, markViewDirty} from './shared';\n+import {getOrCreateLViewCleanup, getOrCreateTViewCleanup, handleError, loadComponentRenderer, markViewDirty} from './shared';\n \n \n \n@@ -120,12 +120,12 @@ function listenerInternal(\n     eventTargetResolver?: GlobalTargetResolver): void {\n   const isTNodeDirectiveHost = isDirectiveHost(tNode);\n   const firstCreatePass = tView.firstCreatePass;\n-  const tCleanup: false|any[] = firstCreatePass && getTViewCleanup(tView);\n+  const tCleanup: false|any[] = firstCreatePass && getOrCreateTViewCleanup(tView);\n \n   // When the ɵɵlistener instruction was generated and is executed we know that there is either a\n   // native listener or a directive output on this element. As such we we know that we will have to\n   // register a listener and store its cleanup function on LView.\n-  const lCleanup = getLCleanup(lView);\n+  const lCleanup = getOrCreateLViewCleanup(lView);\n \n   ngDevMode && assertTNodeType(tNode, TNodeType.AnyRNode | TNodeType.AnyContainer);\n "
        },
        {
            "sha": "9cb7bfe4cad3641d7e8f17f7eb11f604665da677",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -759,19 +759,19 @@ export function locateHostElement(\n  */\n export function storeCleanupWithContext(\n     tView: TView, lView: LView, context: any, cleanupFn: Function): void {\n-  const lCleanup = getLCleanup(lView);\n+  const lCleanup = getOrCreateLViewCleanup(lView);\n   if (context === null) {\n     // If context is null that this is instance specific callback. These callbacks can only be\n     // inserted after template shared instances. For this reason in ngDevMode we freeze the TView.\n     if (ngDevMode) {\n-      Object.freeze(getTViewCleanup(tView));\n+      Object.freeze(getOrCreateTViewCleanup(tView));\n     }\n     lCleanup.push(cleanupFn);\n   } else {\n     lCleanup.push(context);\n \n     if (tView.firstCreatePass) {\n-      getTViewCleanup(tView).push(cleanupFn, lCleanup.length - 1);\n+      getOrCreateTViewCleanup(tView).push(cleanupFn, lCleanup.length - 1);\n     }\n   }\n }\n@@ -2006,12 +2006,12 @@ export function storePropertyBindingMetadata(\n \n export const CLEAN_PROMISE = _CLEAN_PROMISE;\n \n-export function getLCleanup(view: LView): any[] {\n+export function getOrCreateLViewCleanup(view: LView): any[] {\n   // top level variables should not be exported for performance reasons (PERF_NOTES.md)\n   return view[CLEANUP] || (view[CLEANUP] = ngDevMode ? new LCleanup() : []);\n }\n \n-export function getTViewCleanup(tView: TView): any[] {\n+export function getOrCreateTViewCleanup(tView: TView): any[] {\n   return tView.cleanup || (tView.cleanup = ngDevMode ? new TCleanup() : []);\n }\n "
        },
        {
            "sha": "5178445c4794b040eb5a5d8f2b1ec543cec463fd",
            "filename": "packages/core/src/render3/node_manipulation.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fnode_manipulation.ts?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -480,12 +480,12 @@ function processCleanups(tView: TView, lView: LView): void {\n         tCleanup[i].call(context);\n       }\n     }\n-    if (lCleanup !== null) {\n-      for (let i = lastLCleanupIndex + 1; i < lCleanup.length; i++) {\n-        const instanceCleanupFn = lCleanup[i];\n-        ngDevMode && assertFunction(instanceCleanupFn, 'Expecting instance cleanup function.');\n-        instanceCleanupFn();\n-      }\n+  }\n+  if (lCleanup !== null) {\n+    for (let i = lastLCleanupIndex + 1; i < lCleanup.length; i++) {\n+      const instanceCleanupFn = lCleanup[i];\n+      ngDevMode && assertFunction(instanceCleanupFn, 'Expecting instance cleanup function.');\n+      instanceCleanupFn();\n     }\n     lView[CLEANUP] = null;\n   }"
        },
        {
            "sha": "41c8208b78294c28d50cdaf0ad1dc63e9357ce33",
            "filename": "packages/core/test/acceptance/component_spec.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 49,
            "changes": 114,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fcomponent_spec.ts?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -303,55 +303,71 @@ describe('component', () => {\n        expect(wrapperEls.length).toBe(2);  // other elements are preserved\n      });\n \n-  it('should invoke `onDestroy` callbacks of dynamically created component', () => {\n-    let wasOnDestroyCalled = false;\n-    @Component({\n-      selector: '[comp]',\n-      template: 'comp content',\n-    })\n-    class DynamicComponent {\n-    }\n-\n-    @NgModule({\n-      declarations: [DynamicComponent],\n-      entryComponents: [DynamicComponent],  // needed only for ViewEngine\n-    })\n-    class TestModule {\n-    }\n-\n-    @Component({\n-      selector: 'button',\n-      template: '<div id=\"app-root\" #anchor></div>',\n-    })\n-    class App {\n-      @ViewChild('anchor', {read: ViewContainerRef}) anchor!: ViewContainerRef;\n-\n-      constructor(private cfr: ComponentFactoryResolver, private injector: Injector) {}\n-\n-      create() {\n-        const factory = this.cfr.resolveComponentFactory(DynamicComponent);\n-        const componentRef = factory.create(this.injector);\n-        componentRef.onDestroy(() => {\n-          wasOnDestroyCalled = true;\n-        });\n-        this.anchor.insert(componentRef.hostView);\n-      }\n-\n-      clear() {\n-        this.anchor.clear();\n-      }\n-    }\n-\n-    TestBed.configureTestingModule({imports: [TestModule], declarations: [App]});\n-    const fixture = TestBed.createComponent(App);\n-    fixture.detectChanges();\n-\n-    // Add ComponentRef to ViewContainerRef instance.\n-    fixture.componentInstance.create();\n-    // Clear ViewContainerRef to invoke `onDestroy` callbacks on ComponentRef.\n-    fixture.componentInstance.clear();\n-\n-    expect(wasOnDestroyCalled).toBeTrue();\n+  describe('with ngDevMode', () => {\n+    const _global: {ngDevMode: any} = global as any;\n+    let saveNgDevMode!: typeof ngDevMode;\n+    beforeEach(() => saveNgDevMode = ngDevMode);\n+    afterEach(() => _global.ngDevMode = saveNgDevMode);\n+    // In dev mode we have some additional logic to freeze `TView.cleanup` array\n+    // (see `storeCleanupWithContext` function).\n+    // The tests below verify that this action doesn't trigger any change in behaviour\n+    // for prod mode. See https://github.com/angular/angular/issues/40105.\n+    ['ngDevMode off', 'ngDevMode on'].forEach((mode) => {\n+      it('should invoke `onDestroy` callbacks of dynamically created component with ' + mode,\n+         () => {\n+           if (mode === 'ngDevMode off') {\n+             _global.ngDevMode = false;\n+           }\n+           let wasOnDestroyCalled = false;\n+           @Component({\n+             selector: '[comp]',\n+             template: 'comp content',\n+           })\n+           class DynamicComponent {\n+           }\n+\n+           @NgModule({\n+             declarations: [DynamicComponent],\n+             entryComponents: [DynamicComponent],  // needed only for ViewEngine\n+           })\n+           class TestModule {\n+           }\n+\n+           @Component({\n+             selector: 'button',\n+             template: '<div id=\"app-root\" #anchor></div>',\n+           })\n+           class App {\n+             @ViewChild('anchor', {read: ViewContainerRef}) anchor!: ViewContainerRef;\n+\n+             constructor(private cfr: ComponentFactoryResolver, private injector: Injector) {}\n+\n+             create() {\n+               const factory = this.cfr.resolveComponentFactory(DynamicComponent);\n+               const componentRef = factory.create(this.injector);\n+               componentRef.onDestroy(() => {\n+                 wasOnDestroyCalled = true;\n+               });\n+               this.anchor.insert(componentRef.hostView);\n+             }\n+\n+             clear() {\n+               this.anchor.clear();\n+             }\n+           }\n+\n+           TestBed.configureTestingModule({imports: [TestModule], declarations: [App]});\n+           const fixture = TestBed.createComponent(App);\n+           fixture.detectChanges();\n+\n+           // Add ComponentRef to ViewContainerRef instance.\n+           fixture.componentInstance.create();\n+           // Clear ViewContainerRef to invoke `onDestroy` callbacks on ComponentRef.\n+           fixture.componentInstance.clear();\n+\n+           expect(wasOnDestroyCalled).toBeTrue();\n+         });\n+    });\n   });\n \n   describe('invalid host element', () => {"
        },
        {
            "sha": "1bf49380ee20135c3a839e6dc6d9e5fe025526d8",
            "filename": "packages/core/test/bundling/forms/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Fforms%2Fbundle.golden_symbols.json?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -1019,9 +1019,6 @@\n   {\n     \"name\": \"getInjectorIndex\"\n   },\n-  {\n-    \"name\": \"getLCleanup\"\n-  },\n   {\n     \"name\": \"getLView\"\n   },\n@@ -1052,6 +1049,9 @@\n   {\n     \"name\": \"getOrCreateInjectable\"\n   },\n+  {\n+    \"name\": \"getOrCreateLViewCleanup\"\n+  },\n   {\n     \"name\": \"getOrCreateNodeInjectorForNode\"\n   },"
        },
        {
            "sha": "0f88828941602fab25d4eff5abcc84bd3d8954e7",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -1334,9 +1334,6 @@\n   {\n     \"name\": \"getInjectorIndex\"\n   },\n-  {\n-    \"name\": \"getLCleanup\"\n-  },\n   {\n     \"name\": \"getLView\"\n   },\n@@ -1367,6 +1364,9 @@\n   {\n     \"name\": \"getOrCreateInjectable\"\n   },\n+  {\n+    \"name\": \"getOrCreateLViewCleanup\"\n+  },\n   {\n     \"name\": \"getOrCreateNodeInjectorForNode\"\n   },\n@@ -1376,6 +1376,9 @@\n   {\n     \"name\": \"getOrCreateTNode\"\n   },\n+  {\n+    \"name\": \"getOrCreateTViewCleanup\"\n+  },\n   {\n     \"name\": \"getOrCreateViewRefs\"\n   },\n@@ -1442,9 +1445,6 @@\n   {\n     \"name\": \"getTView\"\n   },\n-  {\n-    \"name\": \"getTViewCleanup\"\n-  },\n   {\n     \"name\": \"getToken\"\n   },"
        },
        {
            "sha": "2062b31ee311a76ad5e2ca6b0acd01543533334c",
            "filename": "packages/core/test/bundling/todo/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/fc1cd07eb002662c21177f28ef59714f3b2876ed/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Ftodo%2Fbundle.golden_symbols.json?ref=fc1cd07eb002662c21177f28ef59714f3b2876ed",
            "patch": "@@ -377,9 +377,6 @@\n   {\n     \"name\": \"getInjectorIndex\"\n   },\n-  {\n-    \"name\": \"getLCleanup\"\n-  },\n   {\n     \"name\": \"getLView\"\n   },\n@@ -404,6 +401,9 @@\n   {\n     \"name\": \"getOrCreateInjectable\"\n   },\n+  {\n+    \"name\": \"getOrCreateLViewCleanup\"\n+  },\n   {\n     \"name\": \"getOrCreateNodeInjectorForNode\"\n   },"
        }
    ],
    "stats": {
        "total": 166,
        "additions": 91,
        "deletions": 75
    }
}