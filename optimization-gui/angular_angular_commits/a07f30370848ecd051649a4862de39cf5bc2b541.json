{
    "author": "mgechev",
    "message": "feat(core): introduce getDirectiveMetadata global debugging utility (#41525)\n\nThis commit introduces a global debugging method\n`ng.getDirectiveMetadata` which returns the metadata for a directive or\ncomponent instance.\n\nPR Close #41525",
    "sha": "a07f30370848ecd051649a4862de39cf5bc2b541",
    "files": [
        {
            "sha": "5fbf67baf3c8e0d8f7ba1a9daaf00ce899265f79",
            "filename": "goldens/public-api/core/global_utils.d.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/goldens%2Fpublic-api%2Fcore%2Fglobal_utils.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/goldens%2Fpublic-api%2Fcore%2Fglobal_utils.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Fglobal_utils.d.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -1,10 +1,22 @@\n export declare function applyChanges(component: {}): void;\n \n+export interface ComponentDebugMetadata extends DirectiveDebugMetadata {\n+    changeDetection: ChangeDetectionStrategy;\n+    encapsulation: ViewEncapsulation;\n+}\n+\n+export interface DirectiveDebugMetadata {\n+    inputs: Record<string, string>;\n+    outputs: Record<string, string>;\n+}\n+\n export declare function getComponent<T>(element: Element): T | null;\n \n export declare function getContext<T>(element: Element): T | null;\n \n-export declare function getDirectives(element: Element): {}[];\n+export declare function getDirectiveMetadata(directiveOrComponentInstance: any): ComponentDebugMetadata | DirectiveDebugMetadata | null;\n+\n+export declare function getDirectives(node: Node): {}[];\n \n export declare function getHostElement(componentOrDirective: {}): Element;\n "
        },
        {
            "sha": "b74bedf4afc4cc63c388c451f23cb81cc101bb87",
            "filename": "packages/core/src/render3/global_utils_api.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Fglobal_utils_api.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Fglobal_utils_api.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fglobal_utils_api.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -16,4 +16,4 @@\n  */\n \n export {applyChanges} from './util/change_detection_utils';\n-export {getComponent, getContext, getDirectives, getHostElement, getInjector, getListeners, getOwningComponent, getRootComponents, Listener} from './util/discovery_utils';\n+export {ComponentDebugMetadata, DirectiveDebugMetadata, getComponent, getContext, getDirectiveMetadata, getDirectives, getHostElement, getInjector, getListeners, getOwningComponent, getRootComponents, Listener} from './util/discovery_utils';"
        },
        {
            "sha": "9480c645691fbc3c240cf4d8dc07162c92d7cbe3",
            "filename": "packages/core/src/render3/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Findex.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -13,7 +13,7 @@ import {ɵɵNgOnChangesFeature} from './features/ng_onchanges_feature';\n import {ɵɵProvidersFeature} from './features/providers_feature';\n import {ComponentDef, ComponentTemplate, ComponentType, DirectiveDef, DirectiveType, PipeDef} from './interfaces/definition';\n import {ɵɵComponentDeclaration, ɵɵDirectiveDeclaration, ɵɵFactoryDeclaration, ɵɵInjectorDeclaration, ɵɵNgModuleDeclaration, ɵɵPipeDeclaration} from './interfaces/public_definitions';\n-import {getComponent, getDirectives, getHostElement, getRenderedText} from './util/discovery_utils';\n+import {ComponentDebugMetadata, DirectiveDebugMetadata, getComponent, getDirectiveMetadata, getDirectives, getHostElement, getRenderedText} from './util/discovery_utils';\n \n export {NgModuleType} from '../metadata/ng_module_def';\n export {ComponentFactory, ComponentFactoryResolver, ComponentRef, injectComponentFactoryResolver} from './component_ref';\n@@ -176,12 +176,15 @@ export { ɵɵtemplateRefExtractor} from './view_engine_compatibility_prebound';\n // clang-format on\n \n export {\n+  ComponentDebugMetadata,\n   ComponentDef,\n   ComponentTemplate,\n   ComponentType,\n+  DirectiveDebugMetadata,\n   DirectiveDef,\n   DirectiveType,\n   getComponent,\n+  getDirectiveMetadata,\n   getDirectives,\n   getHostElement,\n   getRenderedText,"
        },
        {
            "sha": "db5d760ff198f6f04e04bbf13500eae1ac403a19",
            "filename": "packages/core/src/render3/util/discovery_utils.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -6,10 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {ChangeDetectionStrategy} from '../../change_detection/constants';\n import {Injector} from '../../di/injector';\n+import {ViewEncapsulation} from '../../metadata/view';\n import {assertEqual} from '../../util/assert';\n import {assertLView} from '../assert';\n import {discoverLocalRefs, getComponentAtNodeIndex, getDirectivesAtNodeIndex, getLContext} from '../context_discovery';\n+import {getComponentDef, getDirectiveDef} from '../definition';\n import {NodeInjector} from '../di';\n import {buildDebugNode} from '../instructions/lview_debug';\n import {LContext} from '../interfaces/context';\n@@ -203,6 +206,70 @@ export function getDirectives(element: Element): {}[] {\n   return context.directives === null ? [] : [...context.directives];\n }\n \n+/**\n+ * Partial metadata for a given directive instance.\n+ * This information might be useful for debugging purposes or tooling.\n+ * Currently only `inputs` and `outputs` metadata is available.\n+ *\n+ * @publicApi\n+ */\n+export interface DirectiveDebugMetadata {\n+  inputs: Record<string, string>;\n+  outputs: Record<string, string>;\n+}\n+\n+/**\n+ * Partial metadata for a given component instance.\n+ * This information might be useful for debugging purposes or tooling.\n+ * Currently the following fields are available:\n+ *  - inputs\n+ *  - outputs\n+ *  - encapsulation\n+ *  - changeDetection\n+ *\n+ * @publicApi\n+ */\n+export interface ComponentDebugMetadata extends DirectiveDebugMetadata {\n+  encapsulation: ViewEncapsulation;\n+  changeDetection: ChangeDetectionStrategy;\n+}\n+\n+/**\n+ * Returns the debug (partial) metadata for a particular directive or component instance.\n+ * The function accepts an instance of a directive or component and returns the corresponding\n+ * metadata.\n+ *\n+ * @param directiveOrComponentInstance Instance of a directive or component\n+ * @returns metadata of the passed directive or component\n+ *\n+ * @publicApi\n+ * @globalApi ng\n+ */\n+export function getDirectiveMetadata(directiveOrComponentInstance: any): ComponentDebugMetadata|\n+    DirectiveDebugMetadata|null {\n+  const {constructor} = directiveOrComponentInstance;\n+  if (!constructor) {\n+    throw new Error('Unable to find the instance constructor');\n+  }\n+  // In case a component inherits from a directive, we may have component and directive metadata\n+  // To ensure we don't get the metadata of the directive, we want to call `getComponentDef` first.\n+  const componentDef = getComponentDef(constructor);\n+  if (componentDef) {\n+    return {\n+      inputs: componentDef.inputs,\n+      outputs: componentDef.outputs,\n+      encapsulation: componentDef.encapsulation,\n+      changeDetection: componentDef.onPush ? ChangeDetectionStrategy.OnPush :\n+                                             ChangeDetectionStrategy.Default\n+    };\n+  }\n+  const directiveDef = getDirectiveDef(constructor);\n+  if (directiveDef) {\n+    return {inputs: directiveDef.inputs, outputs: directiveDef.outputs};\n+  }\n+  return null;\n+}\n+\n /**\n  * Returns LContext associated with a target passed as an argument.\n  * Throws if a given target doesn't have associated LContext."
        },
        {
            "sha": "ad886077919c9432411f37fe0d2875849f02c25c",
            "filename": "packages/core/src/render3/util/global_utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fglobal_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fglobal_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fglobal_utils.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -9,7 +9,7 @@ import {assertDefined} from '../../util/assert';\n import {global} from '../../util/global';\n import {setProfiler} from '../profiler';\n import {applyChanges} from './change_detection_utils';\n-import {getComponent, getContext, getDirectives, getHostElement, getInjector, getListeners, getOwningComponent, getRootComponents} from './discovery_utils';\n+import {getComponent, getContext, getDirectiveMetadata, getDirectives, getHostElement, getInjector, getListeners, getOwningComponent, getRootComponents} from './discovery_utils';\n \n \n \n@@ -48,6 +48,7 @@ export function publishDefaultGlobalUtils() {\n      * removed completely.\n      */\n     publishGlobalUtil('ɵsetProfiler', setProfiler);\n+    publishGlobalUtil('getDirectiveMetadata', getDirectiveMetadata);\n     publishGlobalUtil('getComponent', getComponent);\n     publishGlobalUtil('getContext', getContext);\n     publishGlobalUtil('getListeners', getListeners);"
        },
        {
            "sha": "5af464f790260a7470fbac3decfbae529e3eacdc",
            "filename": "packages/core/test/acceptance/discover_utils_spec.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 2,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -7,6 +7,9 @@\n  */\n import {CommonModule} from '@angular/common';\n import {Component, Directive, HostBinding, InjectionToken, ViewChild} from '@angular/core';\n+import {ChangeDetectionStrategy} from '@angular/core/src/change_detection';\n+import {EventEmitter} from '@angular/core/src/event_emitter';\n+import {Input, Output, ViewEncapsulation} from '@angular/core/src/metadata';\n import {isLView} from '@angular/core/src/render3/interfaces/type_checks';\n import {CONTEXT} from '@angular/core/src/render3/interfaces/view';\n import {ComponentFixture, TestBed} from '@angular/core/testing';\n@@ -15,13 +18,13 @@ import {expect} from '@angular/core/testing/src/testing_internal';\n import {onlyInIvy} from '@angular/private/testing';\n \n import {getHostElement, markDirty} from '../../src/render3/index';\n-import {getComponent, getComponentLView, getContext, getDebugNode, getDirectives, getInjectionTokens, getInjector, getListeners, getLocalRefs, getOwningComponent, getRootComponents, loadLContext} from '../../src/render3/util/discovery_utils';\n+import {ComponentDebugMetadata, getComponent, getComponentLView, getContext, getDebugNode, getDirectiveMetadata, getDirectives, getInjectionTokens, getInjector, getListeners, getLocalRefs, getOwningComponent, getRootComponents, loadLContext} from '../../src/render3/util/discovery_utils';\n \n onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n   let fixture: ComponentFixture<MyApp>;\n   let myApp: MyApp;\n   let dirA: DirectiveA[];\n-  let childComponent: DirectiveA[];\n+  let childComponent: (DirectiveA|Child)[];\n   let child: NodeListOf<Element>;\n   let span: NodeListOf<Element>;\n   let div: NodeListOf<Element>;\n@@ -55,6 +58,8 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n \n   @Directive({selector: '[dirA]', exportAs: 'dirA'})\n   class DirectiveA {\n+    @Input('a') b = 2;\n+    @Output('c') d = new EventEmitter();\n     constructor() {\n       dirA.push(this);\n     }\n@@ -73,6 +78,8 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n   })\n   class MyApp {\n     text: string = 'INIT';\n+    @Input('a') b = 2;\n+    @Output('c') d = new EventEmitter();\n     constructor() {\n       myApp = this;\n     }\n@@ -288,6 +295,23 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils', () => {\n       expect(lContext.native as any).toBe(ngContainerComment);\n     });\n   });\n+\n+  describe('getDirectiveMetadata', () => {\n+    it('should work with components', () => {\n+      const metadata = getDirectiveMetadata(myApp);\n+      expect(metadata!.inputs).toEqual({a: 'b'});\n+      expect(metadata!.outputs).toEqual({c: 'd'});\n+      expect((metadata as ComponentDebugMetadata).changeDetection)\n+          .toBe(ChangeDetectionStrategy.Default);\n+      expect((metadata as ComponentDebugMetadata).encapsulation).toBe(ViewEncapsulation.None);\n+    });\n+\n+    it('should work with directives', () => {\n+      const metadata = getDirectiveMetadata(getDirectives(div[0])[0]);\n+      expect(metadata!.inputs).toEqual({a: 'b'});\n+      expect(metadata!.outputs).toEqual({c: 'd'});\n+    });\n+  });\n });\n \n onlyInIvy('Ivy-specific utilities').describe('discovery utils deprecated', () => {\n@@ -359,6 +383,14 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils deprecated', () =>\n       const elm2Dirs = getDirectives(elm2);\n       expect(elm2Dirs).toContain(fixture.componentInstance.myDir3Instance!);\n     });\n+\n+    it('should not throw if it cannot find LContext', () => {\n+      let result: any;\n+      expect(() => {\n+        result = getDirectives(document.createElement('div'));\n+      }).not.toThrow();\n+      expect(result).toEqual([]);\n+    });\n   });\n \n   describe('getInjector', () => {"
        },
        {
            "sha": "dfb1aca5a463c59da2d9d2cd1b3de73654f2b7ac",
            "filename": "packages/core/test/render3/global_utils_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Ftest%2Frender3%2Fglobal_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a07f30370848ecd051649a4862de39cf5bc2b541/packages%2Fcore%2Ftest%2Frender3%2Fglobal_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fglobal_utils_spec.ts?ref=a07f30370848ecd051649a4862de39cf5bc2b541",
            "patch": "@@ -8,7 +8,7 @@\n \n import {setProfiler} from '@angular/core/src/render3/profiler';\n import {applyChanges} from '../../src/render3/util/change_detection_utils';\n-import {getComponent, getContext, getDirectives, getHostElement, getInjector, getListeners, getOwningComponent, getRootComponents} from '../../src/render3/util/discovery_utils';\n+import {getComponent, getContext, getDirectiveMetadata, getDirectives, getHostElement, getInjector, getListeners, getOwningComponent, getRootComponents} from '../../src/render3/util/discovery_utils';\n import {GLOBAL_PUBLISH_EXPANDO_KEY, GlobalDevModeContainer, publishDefaultGlobalUtils, publishGlobalUtil} from '../../src/render3/util/global_utils';\n import {global} from '../../src/util/global';\n \n@@ -62,6 +62,10 @@ describe('global utils', () => {\n       assertPublished('applyChanges', applyChanges);\n     });\n \n+    it('should publish getDirectiveMetadata', () => {\n+      assertPublished('getDirectiveMetadata', getDirectiveMetadata);\n+    });\n+\n     it('should publish ɵsetProfiler', () => {\n       assertPublished('ɵsetProfiler', setProfiler);\n     });"
        }
    ],
    "stats": {
        "total": 133,
        "additions": 126,
        "deletions": 7
    }
}