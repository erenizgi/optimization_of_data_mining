{
    "author": "ivanwonder",
    "message": "feat(language-service): support completions for animation (#44630)\n\nSupport completions for animation.\n\nPR Close #44630",
    "sha": "af2a1317cbfba985233f510bbe9e49016968307c",
    "files": [
        {
            "sha": "40291512cb7b8bcf8f7af2b36d7830b119673701",
            "filename": "packages/language-service/src/attribute_completions.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Fsrc%2Fattribute_completions.ts",
            "raw_url": "https://github.com/angular/angular/raw/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Fsrc%2Fattribute_completions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fattribute_completions.ts?ref=af2a1317cbfba985233f510bbe9e49016968307c",
            "patch": "@@ -621,3 +621,16 @@ function getStructuralAttributes(meta: TypeCheckableDirectiveMeta): string[] {\n \n   return structuralAttributes;\n }\n+\n+export function buildAnimationCompletionEntries(\n+    animations: string[], replacementSpan: ts.TextSpan,\n+    kind: DisplayInfoKind): ts.CompletionEntry[] {\n+  return animations.map(animation => {\n+    return {\n+      kind: unsafeCastDisplayInfoKindToScriptElementKind(kind),\n+      name: animation,\n+      sortText: animation,\n+      replacementSpan,\n+    };\n+  });\n+}"
        },
        {
            "sha": "81350caafec4841f52ce8cc62785f01d1561e1d8",
            "filename": "packages/language-service/src/completions.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 4,
            "changes": 89,
            "blob_url": "https://github.com/angular/angular/blob/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Fsrc%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Fsrc%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fcompletions.ts?ref=af2a1317cbfba985233f510bbe9e49016968307c",
            "patch": "@@ -6,16 +6,16 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AST, ASTWithSource, BindingPipe, Call, EmptyExpr, ImplicitReceiver, LiteralPrimitive, ParseSourceSpan, PropertyRead, PropertyWrite, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n+import {AST, ASTWithSource, BindingPipe, BindingType, Call, EmptyExpr, ImplicitReceiver, LiteralPrimitive, ParsedEventType, ParseSourceSpan, PropertyRead, PropertyWrite, SafePropertyRead, TmplAstBoundAttribute, TmplAstBoundEvent, TmplAstElement, TmplAstNode, TmplAstReference, TmplAstTemplate, TmplAstText, TmplAstTextAttribute, TmplAstVariable} from '@angular/compiler';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {CompletionKind, DirectiveInScope, SymbolKind, TemplateDeclarationSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {BoundEvent, TextAttribute} from '@angular/compiler/src/render3/r3_ast';\n import ts from 'typescript';\n \n-import {addAttributeCompletionEntries, AttributeCompletionKind, buildAttributeCompletionTable, getAttributeCompletionSymbol} from './attribute_completions';\n+import {addAttributeCompletionEntries, AttributeCompletionKind, buildAnimationCompletionEntries, buildAttributeCompletionTable, getAttributeCompletionSymbol} from './attribute_completions';\n import {DisplayInfo, DisplayInfoKind, getDirectiveDisplayInfo, getSymbolDisplayInfo, getTsSymbolDisplayInfo, unsafeCastDisplayInfoKindToScriptElementKind} from './display_parts';\n import {TargetContext, TargetNodeKind, TemplateTarget} from './template_target';\n-import {filterAliasImports, isBoundEventWithSyntheticHandler} from './utils';\n+import {filterAliasImports, isBoundEventWithSyntheticHandler, isWithin} from './utils';\n \n type PropertyExpressionCompletionBuilder =\n     CompletionBuilder<PropertyRead|PropertyWrite|EmptyExpr|SafePropertyRead|TmplAstBoundEvent>;\n@@ -27,6 +27,8 @@ type PipeCompletionBuilder = CompletionBuilder<BindingPipe>;\n \n type LiteralCompletionBuilder = CompletionBuilder<LiteralPrimitive|TextAttribute>;\n \n+type ElementAnimationCompletionBuilder = CompletionBuilder<TmplAstBoundAttribute|TmplAstBoundEvent>;\n+\n export enum CompletionNodeContext {\n   None,\n   ElementTag,\n@@ -36,6 +38,8 @@ export enum CompletionNodeContext {\n   TwoWayBinding,\n }\n \n+const ANIMATION_PHASES = ['start', 'done'];\n+\n /**\n  * Performs autocompletion operations on a given node in the template.\n  *\n@@ -70,7 +74,11 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     } else if (this.isElementTagCompletion()) {\n       return this.getElementTagCompletion();\n     } else if (this.isElementAttributeCompletion()) {\n-      return this.getElementAttributeCompletions(options);\n+      if (this.isAnimationCompletion()) {\n+        return this.getAnimationCompletions();\n+      } else {\n+        return this.getElementAttributeCompletions(options);\n+      }\n     } else if (this.isPipeCompletion()) {\n       return this.getPipeCompletions();\n     } else if (this.isLiteralCompletion()) {\n@@ -531,6 +539,68 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n     return directive?.tsSymbol;\n   }\n \n+  private isAnimationCompletion(): this is ElementAnimationCompletionBuilder {\n+    return (this.node instanceof TmplAstBoundAttribute &&\n+            this.node.type === BindingType.Animation) ||\n+        (this.node instanceof TmplAstBoundEvent && this.node.type === ParsedEventType.Animation);\n+  }\n+\n+  private getAnimationCompletions(this: ElementAnimationCompletionBuilder):\n+      ts.WithMetadata<ts.CompletionInfo>|undefined {\n+    if (this.node instanceof TmplAstBoundAttribute) {\n+      const animations = this.compiler.getTemplateTypeChecker()\n+                             .getDirectiveMetadata(this.component)\n+                             ?.animationTriggerNames?.staticTriggerNames;\n+      const replacementSpan = makeReplacementSpanFromParseSourceSpan(this.node.keySpan);\n+\n+      if (animations === undefined) {\n+        return undefined;\n+      }\n+\n+      const entries = buildAnimationCompletionEntries(\n+          [...animations, '.disabled'], replacementSpan, DisplayInfoKind.ATTRIBUTE);\n+      return {\n+        entries,\n+        isGlobalCompletion: false,\n+        isMemberCompletion: false,\n+        isNewIdentifierLocation: true,\n+      };\n+    } else {\n+      const animationNameSpan = buildAnimationNameSpan(this.node);\n+      const phaseSpan = buildAnimationPhaseSpan(this.node);\n+      if (isWithin(this.position, animationNameSpan)) {\n+        const animations = this.compiler.getTemplateTypeChecker()\n+                               .getDirectiveMetadata(this.component)\n+                               ?.animationTriggerNames?.staticTriggerNames;\n+        const replacementSpan = makeReplacementSpanFromParseSourceSpan(animationNameSpan);\n+\n+        if (animations === undefined) {\n+          return undefined;\n+        }\n+\n+        const entries =\n+            buildAnimationCompletionEntries(animations, replacementSpan, DisplayInfoKind.EVENT);\n+        return {\n+          entries,\n+          isGlobalCompletion: false,\n+          isMemberCompletion: false,\n+          isNewIdentifierLocation: true,\n+        };\n+      }\n+      if (phaseSpan !== null && isWithin(this.position, phaseSpan)) {\n+        const replacementSpan = makeReplacementSpanFromParseSourceSpan(phaseSpan);\n+        const entries = buildAnimationCompletionEntries(\n+            ANIMATION_PHASES, replacementSpan, DisplayInfoKind.EVENT);\n+        return {\n+          entries,\n+          isGlobalCompletion: false,\n+          isMemberCompletion: false,\n+          isNewIdentifierLocation: true,\n+        };\n+      }\n+    }\n+  }\n+\n   private isElementAttributeCompletion(): this is ElementAttributeCompletionBuilder {\n     return (this.nodeContext === CompletionNodeContext.ElementAttributeKey ||\n             this.nodeContext === CompletionNodeContext.TwoWayBinding) &&\n@@ -884,3 +954,14 @@ function nodeContextFromTarget(target: TargetContext): CompletionNodeContext {\n       return CompletionNodeContext.None;\n   }\n }\n+\n+function buildAnimationNameSpan(node: TmplAstBoundEvent): ParseSourceSpan {\n+  return new ParseSourceSpan(node.keySpan.start, node.keySpan.start.moveBy(node.name.length));\n+}\n+\n+function buildAnimationPhaseSpan(node: TmplAstBoundEvent): ParseSourceSpan|null {\n+  if (node.phase !== null) {\n+    return new ParseSourceSpan(node.keySpan.end.moveBy(-node.phase.length), node.keySpan.end);\n+  }\n+  return null;\n+}"
        },
        {
            "sha": "bac291623fc6b486edcf4a632e83a73e15a6890e",
            "filename": "packages/language-service/src/template_target.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Fsrc%2Ftemplate_target.ts",
            "raw_url": "https://github.com/angular/angular/raw/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Fsrc%2Ftemplate_target.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Ftemplate_target.ts?ref=af2a1317cbfba985233f510bbe9e49016968307c",
            "patch": "@@ -370,8 +370,10 @@ class TemplateTargetVisitor implements t.Visitor {\n   }\n \n   visitBoundAttribute(attribute: t.BoundAttribute) {\n-    const visitor = new ExpressionVisitor(this.position);\n-    visitor.visit(attribute.value, this.path);\n+    if (attribute.valueSpan !== undefined) {\n+      const visitor = new ExpressionVisitor(this.position);\n+      visitor.visit(attribute.value, this.path);\n+    }\n   }\n \n   visitBoundEvent(event: t.BoundEvent) {"
        },
        {
            "sha": "8414432bfa16348ba7cd88fdcdf70b1caa69c8d6",
            "filename": "packages/language-service/test/completions_spec.ts",
            "status": "modified",
            "additions": 99,
            "deletions": 1,
            "changes": 100,
            "blob_url": "https://github.com/angular/angular/blob/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/af2a1317cbfba985233f510bbe9e49016968307c/packages%2Flanguage-service%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fcompletions_spec.ts?ref=af2a1317cbfba985233f510bbe9e49016968307c",
            "patch": "@@ -141,6 +141,14 @@ const UNION_TYPE_PIPE = {\n     `\n };\n \n+const ANIMATION_TRIGGER_FUNCTION = `\n+function trigger(name: string) {\n+  return {name};\n+}\n+`;\n+\n+const ANIMATION_METADATA = `animations: [trigger('animationName')],`;\n+\n describe('completions', () => {\n   beforeEach(() => {\n     initMockFileSystem('Native');\n@@ -682,6 +690,92 @@ describe('completions', () => {\n         });\n       });\n \n+      describe('animations', () => {\n+        it('should return animation names for the property binding', () => {\n+          const {templateFile} =\n+              setup(`<input [@my]>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+          templateFile.moveCursorToText('[@my¦]');\n+\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n+              ['animationName']);\n+          expectReplacementText(completions, templateFile.contents, 'my');\n+        });\n+\n+        it('should return animation names when the property binding animation name is empty',\n+           () => {\n+             const {templateFile} =\n+                 setup(`<input [@]>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+             templateFile.moveCursorToText('[@¦]');\n+\n+             const completions = templateFile.getCompletionsAtPosition();\n+             expectContain(\n+                 completions,\n+                 unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n+                 ['animationName']);\n+           });\n+\n+        it('should return the special animation control binding called @.disabled ', () => {\n+          const {templateFile} =\n+              setup(`<input [@.dis]>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+          templateFile.moveCursorToText('[@.dis¦]');\n+\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.ATTRIBUTE),\n+              ['.disabled']);\n+          expectReplacementText(completions, templateFile.contents, '.dis');\n+        });\n+\n+        it('should return animation names for the event binding', () => {\n+          const {templateFile} =\n+              setup(`<input (@my)>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+          templateFile.moveCursorToText('(@my¦)');\n+\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+              ['animationName']);\n+          expectReplacementText(completions, templateFile.contents, 'my');\n+        });\n+\n+        it('should return animation names when the event binding animation name is empty', () => {\n+          const {templateFile} =\n+              setup(`<input (@)>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+          templateFile.moveCursorToText('(@¦)');\n+\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+              ['animationName']);\n+        });\n+\n+        it('should return the animation phase for the event binding', () => {\n+          const {templateFile} =\n+              setup(`<input (@my.do)>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+          templateFile.moveCursorToText('(@my.do¦)');\n+\n+          const completions = templateFile.getCompletionsAtPosition();\n+          expectContain(\n+              completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+              ['done']);\n+          expectReplacementText(completions, templateFile.contents, 'do');\n+        });\n+\n+        it('should return the animation phase when the event binding animation phase is empty',\n+           () => {\n+             const {templateFile} =\n+                 setup(`<input (@my.)>`, '', {}, ANIMATION_TRIGGER_FUNCTION, ANIMATION_METADATA);\n+             templateFile.moveCursorToText('(@my.¦)');\n+\n+             const completions = templateFile.getCompletionsAtPosition();\n+             expectContain(\n+                 completions, unsafeCastDisplayInfoKindToScriptElementKind(DisplayInfoKind.EVENT),\n+                 ['done']);\n+           });\n+      });\n+\n       it('should return input completions for a partial attribute', () => {\n         const {templateFile} = setup(`<input my>`, '', DIR_WITH_SELECTED_INPUT);\n         templateFile.moveCursorToText('my¦>');\n@@ -1178,7 +1272,8 @@ function toText(displayParts?: ts.SymbolDisplayPart[]): string {\n }\n \n function setup(\n-    template: string, classContents: string, otherDeclarations: {[name: string]: string} = {}): {\n+    template: string, classContents: string, otherDeclarations: {[name: string]: string} = {},\n+    functionDeclarations: string = '', componentMetadata: string = ''): {\n   templateFile: OpenBuffer,\n } {\n   const decls = ['AppCmp', ...Object.keys(otherDeclarations)];\n@@ -1190,9 +1285,12 @@ function setup(\n     'test.ts': `\n          import {Component, Directive, NgModule, Pipe, TemplateRef} from '@angular/core';\n  \n+         ${functionDeclarations}\n+\n          @Component({\n            templateUrl: './test.html',\n            selector: 'app-cmp',\n+           ${componentMetadata}\n          })\n          export class AppCmp {\n            ${classContents}"
        }
    ],
    "stats": {
        "total": 208,
        "additions": 201,
        "deletions": 7
    }
}