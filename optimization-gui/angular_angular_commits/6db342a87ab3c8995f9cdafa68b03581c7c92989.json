{
    "author": "JoostK",
    "message": "test(compiler-cli): reset i18n message index in compliance test macro (#40529)\n\nThe compliance test runner has various macros that process the\nexpectation files before actually checking their contents. Among those\nmacros are i18n helpers, which uses a global message counter to be able\nto uniquely identify ICU variables.\n\nBecause of the global nature of this message index, it was susceptible\nto ordering issues which could result in flaky tests, although it failed\nvery infrequently.\n\nThis commit resets the global message counter before applying the macros.\nAs a result of this change an expectation file had to be updated; this\nis actually a bug fix as said test used to fail if run in isolation (if\n`focusTest: true` was set for that particular testcase).\n\nPR Close #40529",
    "sha": "6db342a87ab3c8995f9cdafa68b03581c7c92989",
    "files": [
        {
            "sha": "e2f0887ebfd562775df11b7b46e9c010e4928193",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/icu_logic/html_content.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/6db342a87ab3c8995f9cdafa68b03581c7c92989/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fhtml_content.js",
            "raw_url": "https://github.com/angular/angular/raw/6db342a87ab3c8995f9cdafa68b03581c7c92989/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fhtml_content.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Ficu_logic%2Fhtml_content.js?ref=6db342a87ab3c8995f9cdafa68b03581c7c92989",
            "patch": "@@ -2,7 +2,7 @@ decls: 5,\n vars: 1,\n consts: function() {\n   __i18nIcuMsg__('{VAR_SELECT, select, male {male - {START_BOLD_TEXT}male{CLOSE_BOLD_TEXT}} female {female {START_BOLD_TEXT}female{CLOSE_BOLD_TEXT}} other {{START_TAG_DIV}{START_ITALIC_TEXT}other{CLOSE_ITALIC_TEXT}{CLOSE_TAG_DIV}}}', [['VAR_SELECT', String.raw`\\uFFFD0\\uFFFD`], ['START_BOLD_TEXT', '<b>'], ['CLOSE_BOLD_TEXT', '</b>'], ['START_ITALIC_TEXT', '<i>'], ['CLOSE_ITALIC_TEXT', '</i>'], ['START_TAG_DIV', '<div class=\\\\\"other\\\\\">'], ['CLOSE_TAG_DIV', '</div>'],])\n-  __i18nMsg__(' {$icu} {$startBoldText}Other content{$closeBoldText}{$startTagDiv}{$startItalicText}Another content{$closeItalicText}{$closeTagDiv}', [['startBoldText', String.raw`\\uFFFD#2\\uFFFD`], ['closeBoldText', String.raw`\\uFFFD/#2\\uFFFD`], ['startTagDiv', String.raw`\\uFFFD#3\\uFFFD`], ['startItalicText', String.raw`\\uFFFD#4\\uFFFD`], ['closeItalicText', String.raw`\\uFFFD/#4\\uFFFD`], ['closeTagDiv', String.raw`\\uFFFD/#3\\uFFFD`], ['icu', '$I18N_0$']], {})\n+  __i18nMsg__(' {$icu} {$startBoldText}Other content{$closeBoldText}{$startTagDiv}{$startItalicText}Another content{$closeItalicText}{$closeTagDiv}', [['startBoldText', String.raw`\\uFFFD#2\\uFFFD`], ['closeBoldText', String.raw`\\uFFFD/#2\\uFFFD`], ['startTagDiv', String.raw`\\uFFFD#3\\uFFFD`], ['startItalicText', String.raw`\\uFFFD#4\\uFFFD`], ['closeItalicText', String.raw`\\uFFFD/#4\\uFFFD`], ['closeTagDiv', String.raw`\\uFFFD/#3\\uFFFD`], ['icu', '$I18N_1$']], {})\n   return [\n     $i18n_1$,\n     [__AttributeMarker.Classes__, \"other\"]"
        },
        {
            "sha": "fdfcfb19fa7c55a49bd54a3166cbdb2bb8f86c4e",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/expected_file_macros.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6db342a87ab3c8995f9cdafa68b03581c7c92989/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fexpected_file_macros.ts",
            "raw_url": "https://github.com/angular/angular/raw/6db342a87ab3c8995f9cdafa68b03581c7c92989/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fexpected_file_macros.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fexpected_file_macros.ts?ref=6db342a87ab3c8995f9cdafa68b03581c7c92989",
            "patch": "@@ -7,7 +7,7 @@\n  */\n import {AttributeMarker, SelectorFlags} from '@angular/compiler/src/core';\n import {QueryFlags} from '@angular/compiler/src/render3/view/compiler';\n-import {i18nIcuMsg, i18nMsg, i18nMsgWithPostprocess, Placeholder} from './i18n_helpers';\n+import {i18nIcuMsg, i18nMsg, i18nMsgWithPostprocess, Placeholder, resetMessageIndex} from './i18n_helpers';\n \n const EXPECTED_FILE_MACROS: [RegExp, (...args: string[]) => string][] = [\n   [\n@@ -47,6 +47,8 @@ const EXPECTED_FILE_MACROS: [RegExp, (...args: string[]) => string][] = [\n  * @param expectedContent The content to process.\n  */\n export function replaceMacros(expectedContent: string): string {\n+  resetMessageIndex();\n+\n   for (const [regex, replacer] of EXPECTED_FILE_MACROS) {\n     expectedContent = expectedContent.replace(regex, replacer);\n   }"
        },
        {
            "sha": "b2da418764753f3df5db871c0356904f64865629",
            "filename": "packages/compiler-cli/test/compliance/test_helpers/i18n_helpers.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6db342a87ab3c8995f9cdafa68b03581c7c92989/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fi18n_helpers.ts",
            "raw_url": "https://github.com/angular/angular/raw/6db342a87ab3c8995f9cdafa68b03581c7c92989/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fi18n_helpers.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_helpers%2Fi18n_helpers.ts?ref=6db342a87ab3c8995f9cdafa68b03581c7c92989",
            "patch": "@@ -12,6 +12,10 @@\n  */\n let msgIndex = 0;\n \n+export function resetMessageIndex(): void {\n+  msgIndex = 0;\n+}\n+\n /**\n  * Generate a string that represents expected i18n block content for a simple message.\n  */"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 8,
        "deletions": 2
    }
}