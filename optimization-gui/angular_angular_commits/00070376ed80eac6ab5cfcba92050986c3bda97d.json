{
    "author": "crisbeto",
    "message": "fix(router): stop emitting to event observable on destroy (#40638)\n\nNo longer emits to `Router.events` after the router has been destroyed. Also\nreturns a resolved promise to the navigation methods.\n\nFixes #40502.\n\nPR Close #40638",
    "sha": "00070376ed80eac6ab5cfcba92050986c3bda97d",
    "files": [
        {
            "sha": "cc41b81ae74da1a9e4285ff9853714aa100fac9b",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/00070376ed80eac6ab5cfcba92050986c3bda97d/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/00070376ed80eac6ab5cfcba92050986c3bda97d/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=00070376ed80eac6ab5cfcba92050986c3bda97d",
            "patch": "@@ -377,6 +377,7 @@ export class Router {\n   private navigations: Observable<NavigationTransition>;\n   private lastSuccessfulNavigation: Navigation|null = null;\n   private currentNavigation: Navigation|null = null;\n+  private disposed = false;\n \n   private locationSubscription?: SubscriptionLike;\n   /**\n@@ -1043,10 +1044,12 @@ export class Router {\n \n   /** Disposes of the router. */\n   dispose(): void {\n+    this.transitions.complete();\n     if (this.locationSubscription) {\n       this.locationSubscription.unsubscribe();\n       this.locationSubscription = undefined;\n     }\n+    this.disposed = true;\n   }\n \n   /**\n@@ -1251,6 +1254,9 @@ export class Router {\n       rawUrl: UrlTree, source: NavigationTrigger, restoredState: RestoredState|null,\n       extras: NavigationExtras,\n       priorPromise?: {resolve: any, reject: any, promise: Promise<boolean>}): Promise<boolean> {\n+    if (this.disposed) {\n+      return Promise.resolve(false);\n+    }\n     // * Imperative navigations (router.navigate) might trigger additional navigations to the same\n     //   URL via a popstate event and the locationChangeListener. We should skip these duplicate\n     //   navs. Duplicates may also be triggered by attempts to sync AngularJS and Angular router"
        },
        {
            "sha": "be145567be437588ea03bd7fa632cb59db040ebb",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/00070376ed80eac6ab5cfcba92050986c3bda97d/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/00070376ed80eac6ab5cfcba92050986c3bda97d/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=00070376ed80eac6ab5cfcba92050986c3bda97d",
            "patch": "@@ -4504,6 +4504,52 @@ describe('Integration', () => {\n \n          expect(navigateSpy.calls.mostRecent().args[1]!.queryParams);\n        })));\n+\n+\n+    it('should stop emitting events after the router is destroyed',\n+       fakeAsync(inject([Router], (router: Router) => {\n+         const fixture = createRoot(router, RootCmp);\n+         router.resetConfig([{path: 'user/:name', component: UserCmp}]);\n+\n+         let events = 0;\n+         const subscription = router.events.subscribe(() => events++);\n+\n+         router.navigateByUrl('/user/frodo');\n+         advance(fixture);\n+         expect(events).toBeGreaterThan(0);\n+\n+         const previousCount = events;\n+         router.dispose();\n+         router.navigateByUrl('/user/bilbo');\n+         advance(fixture);\n+\n+         expect(events).toBe(previousCount);\n+         subscription.unsubscribe();\n+       })));\n+\n+    it('should resolve navigation promise with false after the router is destroyed',\n+       fakeAsync(inject([Router], (router: Router) => {\n+         const fixture = createRoot(router, RootCmp);\n+         let result = null as boolean | null;\n+         const callback = (r: boolean) => result = r;\n+         router.resetConfig([{path: 'user/:name', component: UserCmp}]);\n+\n+         router.navigateByUrl('/user/frodo').then(callback);\n+         advance(fixture);\n+         expect(result).toBe(true);\n+         result = null as boolean | null;\n+\n+         router.dispose();\n+\n+         router.navigateByUrl('/user/bilbo').then(callback);\n+         advance(fixture);\n+         expect(result).toBe(false);\n+         result = null as boolean | null;\n+\n+         router.navigate(['/user/bilbo']).then(callback);\n+         advance(fixture);\n+         expect(result).toBe(false);\n+       })));\n   });\n \n   describe('routerLinkActive', () => {"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 52,
        "deletions": 0
    }
}