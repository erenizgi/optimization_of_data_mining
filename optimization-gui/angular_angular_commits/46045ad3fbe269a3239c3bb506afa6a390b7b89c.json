{
    "author": "devversion",
    "message": "refactor(bazel): add module interop for CJS/ESM compiler-cli package (#43431)\n\nIn the current Bazel setup, we run CommonJS as devmode output, and ESM\nfor prodmode output. This means that consumers of the\n`@angular/bazel` package will end up using the prodmode-built ESM\npackage of the compiler-cli. This commit adds interop logic to be able\nto load the compiler-cli as strict ESM package.\n\nWe cannot switch devmode to ESM, as this would require some changes\nin `rules_nodejs` and potentially the reduction of both output flavors\ninto a single one (which is a future project anyway). This is out of\nscope for now and inside g3, there is still devmode output as well.\n\nPR Close #43431",
    "sha": "46045ad3fbe269a3239c3bb506afa6a390b7b89c",
    "files": [
        {
            "sha": "3b5588a7e1f39aecd0f4f45c53840f36f5441723",
            "filename": "packages/bazel/src/ngc-wrapped/index.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 23,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/46045ad3fbe269a3239c3bb506afa6a390b7b89c/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/46045ad3fbe269a3239c3bb506afa6a390b7b89c/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Findex.ts?ref=46045ad3fbe269a3239c3bb506afa6a390b7b89c",
            "patch": "@@ -6,13 +6,16 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as ng from '@angular/compiler-cli';\n-import {PerfPhase} from '@angular/compiler-cli/private/bazel';\n+import type {AngularCompilerOptions, CompilerHost as NgCompilerHost, TsEmitCallback, Program, Diagnostics, Diagnostic as NgDiagnostic, CompilerOptions} from '@angular/compiler-cli';\n import {BazelOptions, CachedFileLoader, CompilerHost, constructManifest, debug, FileCache, FileLoader, parseTsconfig, resolveNormalizedPath, runAsWorker, runWorkerLoop, UncachedFileLoader} from '@bazel/typescript';\n import * as fs from 'fs';\n import * as path from 'path';\n import * as tsickle from 'tsickle';\n import ts from 'typescript';\n+import {pathToFileURL} from 'url';\n+\n+type CompilerCliModule =\n+    typeof import('@angular/compiler-cli')&typeof import('@angular/compiler-cli/private/bazel');\n \n const EXT = /(\\.ts|\\.d\\.ts|\\.js|\\.jsx|\\.tsx)$/;\n const NGC_GEN_FILES = /^(.*?)\\.(ngfactory|ngsummary|ngstyle|shim\\.ngstyle)(.*)$/;\n@@ -27,23 +30,53 @@ const ALL_DEPS_COMPILED_WITH_BAZEL = false;\n \n const NODE_MODULES = 'node_modules/';\n \n-export function main(args) {\n+export async function main(args) {\n   if (runAsWorker(args)) {\n-    runWorkerLoop(runOneBuild);\n+    await runWorkerLoop(runOneBuild);\n   } else {\n-    return runOneBuild(args) ? 0 : 1;\n+    return await runOneBuild(args) ? 0 : 1;\n   }\n   return 0;\n }\n \n /** The one FileCache instance used in this process. */\n const fileCache = new FileCache<ts.SourceFile>(debug);\n \n-export function runOneBuild(args: string[], inputs?: {[path: string]: string}): boolean {\n+/**\n+ * Loads a module that can either be CommonJS or an ESModule. This is done\n+ * as interop with the current devmode CommonJS and prodmode ESM output.\n+ */\n+async function loadModuleInterop<T>(moduleName: string): Promise<T> {\n+  // Note: This assumes that there are no conditional exports switching between `import`\n+  // or `require`. We cannot fully rely on the dynamic import expression here because the\n+  // Bazel NodeJS rules do not patch the `import` NodeJS module resolution, and this would\n+  // make ngc-wrapped dependent on the linker. The linker is not enabled when the `ngc-wrapped`\n+  // binary is shipped in the NPM package and is not available in Google3 either.\n+  const resolvedUrl = pathToFileURL(require.resolve(moduleName));\n+  const exports: Partial<T>&{default?: T} =\n+      await new Function('m', `return import(m);`)(resolvedUrl);\n+  return exports.default ?? exports as T;\n+}\n+\n+export async function runOneBuild(\n+    args: string[], inputs?: {[path: string]: string}): Promise<boolean> {\n   if (args[0] === '-p') args.shift();\n   // Strip leading at-signs, used to indicate a params file\n   const project = args[0].replace(/^@+/, '');\n \n+  // Note: We load the compiler-cli package dynamically using `loadModuleInterop` as\n+  // this script runs as CommonJS module but the compiler-cli could be built as strict ESM\n+  // package. Unfortunately we have a mix of CommonJS and ESM output here because the devmode\n+  // output is still using CommonJS and this is primarily used for testing. Also inside G3,\n+  // the devmode output will remain CommonJS regardless for now.\n+  // TODO: Fix this up once devmode and prodmode are combined and we use ESM everywhere.\n+  const compilerExports =\n+      await loadModuleInterop<typeof import('@angular/compiler-cli')>('@angular/compiler-cli');\n+  const compilerPrivateExports =\n+      await loadModuleInterop<typeof import('@angular/compiler-cli/private/bazel')>(\n+          '@angular/compiler-cli/private/bazel');\n+  const ng = {...compilerExports, ...compilerPrivateExports};\n+\n   const [parsedOptions, errors] = parseTsconfig(project);\n   if (errors?.length) {\n     console.error(ng.formatDiagnostics(errors));\n@@ -83,7 +116,7 @@ export function runOneBuild(args: string[], inputs?: {[path: string]: string}):\n                               return obj;\n                             }, {});\n \n-  const compilerOpts: ng.AngularCompilerOptions = {\n+  const compilerOpts: AngularCompilerOptions = {\n     ...userOverrides,\n     ...config['angularCompilerOptions'],\n     ...tsOptions,\n@@ -103,6 +136,7 @@ export function runOneBuild(args: string[], inputs?: {[path: string]: string}):\n     bazelOpts,\n     files,\n     inputs,\n+    ng,\n   });\n   if (diagnostics.length) {\n     console.error(ng.formatDiagnostics(diagnostics));\n@@ -131,17 +165,18 @@ export function compile({\n   inputs,\n   expectedOuts,\n   gatherDiagnostics,\n-  bazelHost\n+  bazelHost,\n+  ng,\n }: {\n   allDepsCompiledWithBazel?: boolean,\n-  useManifestPathsAsModuleName?: boolean, compilerOpts: ng.CompilerOptions, tsHost: ts.CompilerHost,\n+  useManifestPathsAsModuleName?: boolean, compilerOpts: CompilerOptions, tsHost: ts.CompilerHost,\n   inputs?: {[path: string]: string},\n         bazelOpts: BazelOptions,\n         files: string[],\n         expectedOuts: string[],\n-  gatherDiagnostics?: (program: ng.Program) => ng.Diagnostics,\n-  bazelHost?: CompilerHost,\n-}): {diagnostics: ng.Diagnostics, program: ng.Program} {\n+  gatherDiagnostics?: (program: Program) => Diagnostics,\n+  bazelHost?: CompilerHost, ng: CompilerCliModule,\n+}): {diagnostics: Diagnostics, program: Program} {\n   let fileLoader: FileLoader;\n \n   if (bazelOpts.maxCacheSizeMb !== undefined) {\n@@ -321,7 +356,7 @@ export function compile({\n     console.error('Check that it\\'s included in the `assets` attribute of the `ng_module` rule.\\n');\n   };\n \n-  const emitCallback: ng.TsEmitCallback = ({\n+  const emitCallback: TsEmitCallback = ({\n     program,\n     targetSourceFile,\n     writeFile,\n@@ -339,7 +374,7 @@ export function compile({\n \n   if (!gatherDiagnostics) {\n     gatherDiagnostics = (program) =>\n-        gatherDiagnosticsForInputsOnly(compilerOpts, bazelOpts, program);\n+        gatherDiagnosticsForInputsOnly(compilerOpts, bazelOpts, program, ng);\n   }\n   const {diagnostics, emitResult, program} = ng.performCompilation({\n     rootNames: files,\n@@ -369,7 +404,8 @@ export function compile({\n   if (!bazelOpts.nodeModulesPrefix) {\n     // If there is no node modules, then metadata.json should be emitted since\n     // there is no other way to obtain the information\n-    generateMetadataJson(program.getTsProgram(), files, compilerOpts.rootDirs, bazelBin, tsHost);\n+    generateMetadataJson(\n+        program.getTsProgram(), files, compilerOpts.rootDirs, bazelBin, tsHost, ng);\n   }\n \n   if (bazelOpts.tsickleExternsPath) {\n@@ -396,7 +432,7 @@ export function compile({\n  */\n function generateMetadataJson(\n     program: ts.Program, files: string[], rootDirs: string[], bazelBin: string,\n-    tsHost: ts.CompilerHost) {\n+    tsHost: ts.CompilerHost, ng: CompilerCliModule) {\n   const collector = new ng.MetadataCollector();\n   for (let i = 0; i < files.length; i++) {\n     const file = files[i];\n@@ -424,16 +460,16 @@ function convertToForwardSlashPath(filePath: string): string {\n }\n \n function gatherDiagnosticsForInputsOnly(\n-    options: ng.CompilerOptions, bazelOpts: BazelOptions,\n-    ngProgram: ng.Program): (ng.Diagnostic|ts.Diagnostic)[] {\n+    options: CompilerOptions, bazelOpts: BazelOptions, ngProgram: Program,\n+    ng: CompilerCliModule): (NgDiagnostic|ts.Diagnostic)[] {\n   const tsProgram = ngProgram.getTsProgram();\n \n   // For the Ivy compiler, track the amount of time spent fetching TypeScript diagnostics.\n-  let previousPhase = PerfPhase.Unaccounted;\n+  let previousPhase = ng.PerfPhase.Unaccounted;\n   if (ngProgram instanceof ng.NgtscProgram) {\n-    previousPhase = ngProgram.compiler.perfRecorder.phase(PerfPhase.TypeScriptDiagnostics);\n+    previousPhase = ngProgram.compiler.perfRecorder.phase(ng.PerfPhase.TypeScriptDiagnostics);\n   }\n-  const diagnostics: (ng.Diagnostic|ts.Diagnostic)[] = [];\n+  const diagnostics: (NgDiagnostic|ts.Diagnostic)[] = [];\n   // These checks mirror ts.getPreEmitDiagnostics, with the important\n   // exception of avoiding b/30708240, which is that if you call\n   // program.getDeclarationDiagnostics() it somehow corrupts the emit.\n@@ -462,7 +498,10 @@ function gatherDiagnosticsForInputsOnly(\n }\n \n if (require.main === module) {\n-  process.exitCode = main(process.argv.slice(2));\n+  main(process.argv.slice(2)).then(exitCode => process.exitCode = exitCode).catch(e => {\n+    console.error(e);\n+    process.exitCode = 1;\n+  });\n }\n \n /**\n@@ -474,7 +513,7 @@ if (require.main === module) {\n  * correctly.\n  */\n export function patchNgHostWithFileNameToModuleName(\n-    ngHost: ng.CompilerHost, compilerOpts: ng.CompilerOptions, bazelOpts: BazelOptions,\n+    ngHost: NgCompilerHost, compilerOpts: CompilerOptions, bazelOpts: BazelOptions,\n     useManifestPathsAsModuleName: boolean): void {\n   const fileNameToModuleNameCache = new Map<string, string>();\n   ngHost.fileNameToModuleName = (importedFilePath: string, containingFilePath?: string) => {"
        },
        {
            "sha": "a8ecb10c8b94f48b2367c78243fa56698ad21989",
            "filename": "packages/bazel/test/ngc-wrapped/index_test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/46045ad3fbe269a3239c3bb506afa6a390b7b89c/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Findex_test.ts",
            "raw_url": "https://github.com/angular/angular/raw/46045ad3fbe269a3239c3bb506afa6a390b7b89c/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Findex_test.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Findex_test.ts?ref=46045ad3fbe269a3239c3bb506afa6a390b7b89c",
            "patch": "@@ -11,7 +11,7 @@ import * as path from 'path';\n import {setup} from './test_support';\n \n describe('ngc_wrapped', () => {\n-  it('should work', () => {\n+  it('should work', async () => {\n     const {read, write, runOneBuild, writeConfig, shouldExist, basePath, typesRoots} = setup();\n \n     write('some_project/index.ts', `\n@@ -34,7 +34,7 @@ describe('ngc_wrapped', () => {\n     });\n \n     // expect no error\n-    expect(runOneBuild()).toBe(true);\n+    expect(await runOneBuild()).toBe(true);\n \n     shouldExist('bazel-bin/some_project/index.js');\n "
        },
        {
            "sha": "8ed4aac1d02014d62aed59aa7c23f776ff4b97c3",
            "filename": "packages/bazel/test/ngc-wrapped/test_support.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/46045ad3fbe269a3239c3bb506afa6a390b7b89c/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Ftest_support.ts",
            "raw_url": "https://github.com/angular/angular/raw/46045ad3fbe269a3239c3bb506afa6a390b7b89c/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Ftest_support.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Ftest%2Fngc-wrapped%2Ftest_support.ts?ref=46045ad3fbe269a3239c3bb506afa6a390b7b89c",
            "patch": "@@ -32,7 +32,7 @@ export interface TestSupport {\n   writeFiles(...mockDirs: {[fileName: string]: string}[]): void;\n   shouldExist(fileName: string): void;\n   shouldNotExist(fileName: string): void;\n-  runOneBuild(): boolean;\n+  runOneBuild(): Promise<boolean>;\n }\n \n export function setup({\n@@ -161,7 +161,7 @@ export function setup({\n     }\n   }\n \n-  function runOneBuildImpl(): boolean {\n+  async function runOneBuildImpl(): Promise<boolean> {\n     return runOneBuild(['@' + tsConfigJsonPath]);\n   }\n }"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 66,
        "deletions": 27
    }
}