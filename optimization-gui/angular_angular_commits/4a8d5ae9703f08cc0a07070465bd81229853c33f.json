{
    "author": "JiaLiPassion",
    "message": "fix(core): markDirty() should only mark flags when really scheduling tick. (#39316)\n\nClose #39296\n\nFix an issue that `markDirty()` will not trigger change detection.\n\nThe case is for example we have the following component.\n\n```\nexport class AppComponent implements OnInit {\n  constructor(private router: Router) {}\n\n  ngOnInit() {\n    this.router.events\n      .pipe(filter((e) => e instanceof NavigationEnd))\n      .subscribe(() => ɵmarkDirty(this));\n  }\n}\n\nexport class CounterComponent implements OnInit, OnDestroy {\n  ngOnInit() {\n    this.countSubject.pipe(takeUntil(this.destroy)).subscribe((count) => {\n      this.count = count;\n      ɵmarkDirty(this);\n    });\n  }\n```\n\nThen the app navigate from `AppComponent` to `CounterComponent`,\nso there are 2 `markDirty()` call at in a row.\n\nThe `1st` call is from `AppComponent` when router changed, the\n`2nd` call is from `CounterComponent.ngOnInit()`.\n\nAnd the `markDirty()->scheduleTick()` code look like this\n\n```\nfunction scheduleTick(rootContext, flags) {\n    const nothingScheduled = rootContext.flags === 0 /* Empty */;\n    rootContext.flags |= flags;\n    if (nothingScheduled && rootContext.clean == _CLEAN_PROMISE) {\n      rootContext.schedule(() => {\n\t...\n        if (rootContext.flags & RootContextFlags.DetectChanges)\n          rootContext.flags &= ~RootContextFlags.DetectChanges;\n          tickContext();\n\n        rootContext.clean = _CLEAN_PROMISE;\n        ...\n      });\n```\n\nSo in this case, the `1st` markDirty() will\n1. set rootContext.flags = 1\n2. before `tickContext()`, reset rootContext.flags = 0\n3. inside `tickContext()`, it will call `CounterComponent.ngOnint()`,\n   so the `2nd` markDirty() is called.\n4. and the `2nd` scheduleTick is called, `nothingScheduled` is true,\n   but rootContext.clean is not `_CLEAN_PROMISE` yet, since the `1st` markDirty tick\n   is still running.\n5. So nowhere will reset the `rootContext.flags`.\n6. then in the future, any other `markDirty()` call will not trigger the tick, since\n   `nothingScheduled` is always false.\n\nSo `nothingScheduled` means no tick is scheduled, `rootContext.clean === _CLEAN_PROMISE`\nmeans no tick is running.\nSo we should set the flags to `rootContext` only when `no tick is scheudled or running`.\n\nPR Close #39316",
    "sha": "4a8d5ae9703f08cc0a07070465bd81229853c33f",
    "files": [
        {
            "sha": "16836af5242493d14f74dc62637f94c484d2e557",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/4a8d5ae9703f08cc0a07070465bd81229853c33f/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/4a8d5ae9703f08cc0a07070465bd81229853c33f/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=4a8d5ae9703f08cc0a07070465bd81229853c33f",
            "patch": "@@ -1851,9 +1851,10 @@ export function markViewDirty(lView: LView): LView|null {\n  */\n export function scheduleTick(rootContext: RootContext, flags: RootContextFlags) {\n   const nothingScheduled = rootContext.flags === RootContextFlags.Empty;\n-  rootContext.flags |= flags;\n-\n   if (nothingScheduled && rootContext.clean == _CLEAN_PROMISE) {\n+    // https://github.com/angular/angular/issues/39296\n+    // should only attach the flags when really scheduling a tick\n+    rootContext.flags |= flags;\n     let res: null|((val: null) => void);\n     rootContext.clean = new Promise<null>((r) => res = r);\n     rootContext.scheduler(() => {"
        },
        {
            "sha": "65a67aa43f93864054359c6c176f56ec2389f959",
            "filename": "packages/core/test/render3/change_detection_spec.ts",
            "status": "modified",
            "additions": 101,
            "deletions": 3,
            "changes": 104,
            "blob_url": "https://github.com/angular/angular/blob/4a8d5ae9703f08cc0a07070465bd81229853c33f/packages%2Fcore%2Ftest%2Frender3%2Fchange_detection_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4a8d5ae9703f08cc0a07070465bd81229853c33f/packages%2Fcore%2Ftest%2Frender3%2Fchange_detection_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fchange_detection_spec.ts?ref=4a8d5ae9703f08cc0a07070465bd81229853c33f",
            "patch": "@@ -8,18 +8,20 @@\n \n import {withBody} from '@angular/private/testing';\n \n-import {ChangeDetectionStrategy, DoCheck} from '../../src/core';\n+import {ChangeDetectionStrategy, DoCheck, OnInit} from '../../src/core';\n import {whenRendered} from '../../src/render3/component';\n-import {getRenderedText, LifecycleHooksFeature, ɵɵadvance, ɵɵdefineComponent, ɵɵgetCurrentView, ɵɵproperty, ɵɵtextInterpolate1, ɵɵtextInterpolate2} from '../../src/render3/index';\n-import {detectChanges, markDirty, tick, ɵɵelement, ɵɵelementEnd, ɵɵelementStart, ɵɵlistener, ɵɵtext, ɵɵtextInterpolate} from '../../src/render3/instructions/all';\n+import {AttributeMarker, getRenderedText, LifecycleHooksFeature, ɵɵadvance, ɵɵdefineComponent, ɵɵgetCurrentView, ɵɵproperty, ɵɵtextInterpolate1, ɵɵtextInterpolate2} from '../../src/render3/index';\n+import {detectChanges, markDirty, tick, ɵɵelement, ɵɵelementEnd, ɵɵelementStart, ɵɵlistener, ɵɵtemplate, ɵɵtext, ɵɵtextInterpolate} from '../../src/render3/instructions/all';\n import {RenderFlags} from '../../src/render3/interfaces/definition';\n import {Renderer3, RendererFactory3} from '../../src/render3/interfaces/renderer';\n import {FLAGS, LViewFlags} from '../../src/render3/interfaces/view';\n \n+import {NgIf} from './common_with_def';\n import {containerEl, createComponent, renderComponent, requestAnimationFrame} from './render_util';\n \n describe('change detection', () => {\n   describe('markDirty, detectChanges, whenRendered, getRenderedText', () => {\n+    let mycompOninit: MyComponentWithOnInit;\n     class MyComponent implements DoCheck {\n       value: string = 'works';\n       doCheckCount = 0;\n@@ -48,6 +50,84 @@ describe('change detection', () => {\n       });\n     }\n \n+    class MyComponentWithOnInit implements OnInit, DoCheck {\n+      value: string = 'works';\n+      doCheckCount = 0;\n+\n+      ngOnInit() {\n+        markDirty(this);\n+      }\n+\n+      ngDoCheck(): void {\n+        this.doCheckCount++;\n+      }\n+\n+      click() {\n+        this.value = 'click works';\n+        markDirty(this);\n+      }\n+\n+      static ɵfac = () => mycompOninit = new MyComponentWithOnInit();\n+      static ɵcmp = ɵɵdefineComponent({\n+        type: MyComponentWithOnInit,\n+        selectors: [['my-comp-oninit']],\n+        decls: 2,\n+        vars: 1,\n+        template:\n+            (rf: RenderFlags, ctx: MyComponentWithOnInit) => {\n+              if (rf & RenderFlags.Create) {\n+                ɵɵelementStart(0, 'span');\n+                ɵɵtext(1);\n+                ɵɵelementEnd();\n+              }\n+              if (rf & RenderFlags.Update) {\n+                ɵɵadvance(1);\n+                ɵɵtextInterpolate(ctx.value);\n+              }\n+            }\n+      });\n+    }\n+\n+    class MyParentComponent implements OnInit {\n+      show = false;\n+      value = 'parent';\n+      mycomp: any = undefined;\n+\n+      ngOnInit() {}\n+\n+      click() {\n+        this.show = true;\n+        markDirty(this);\n+      }\n+\n+      static ɵfac = () => new MyParentComponent();\n+      static ɵcmp = ɵɵdefineComponent({\n+        type: MyParentComponent,\n+        selectors: [['my-parent-comp']],\n+        decls: 2,\n+        vars: 1,\n+        directives: [NgIf, MyComponentWithOnInit],\n+        consts: [[AttributeMarker.Template, 'ngIf']],\n+        template:\n+            (rf: RenderFlags, ctx: MyParentComponent) => {\n+              if (rf & RenderFlags.Create) {\n+                ɵɵtext(0, ' -->\\n');\n+                ɵɵtemplate(1, (rf, ctx) => {\n+                  if (rf & RenderFlags.Create) {\n+                    ɵɵelementStart(0, 'div');\n+                    ɵɵelement(1, 'my-comp-oninit');\n+                    ɵɵelementEnd();\n+                  }\n+                }, 2, 0, 'div', 0);\n+              }\n+              if (rf & RenderFlags.Update) {\n+                ɵɵadvance(1);\n+                ɵɵproperty('ngIf', ctx.show);\n+              }\n+            }\n+      });\n+    }\n+\n     it('should mark a component dirty and schedule change detection', withBody('my-comp', () => {\n          const myComp = renderComponent(MyComponent, {hostFeatures: [LifecycleHooksFeature]});\n          expect(getRenderedText(myComp)).toEqual('works');\n@@ -66,6 +146,24 @@ describe('change detection', () => {\n          expect(getRenderedText(myComp)).toEqual('updated');\n        }));\n \n+    it('should detectChanges after markDirty is called multiple times within ngOnInit',\n+       withBody('my-comp-oninit', () => {\n+         const myParentComp =\n+             renderComponent(MyParentComponent, {hostFeatures: [LifecycleHooksFeature]});\n+         expect(myParentComp.show).toBe(false);\n+         myParentComp.click();\n+         requestAnimationFrame.flush();\n+         expect(myParentComp.show).toBe(true);\n+         const myComp = mycompOninit;\n+         expect(getRenderedText(myComp)).toEqual('works');\n+         expect(myComp.doCheckCount).toBe(1);\n+         myComp.click();\n+         expect(getRenderedText(myComp)).toEqual('works');\n+         requestAnimationFrame.flush();\n+         expect(getRenderedText(myComp)).toEqual('click works');\n+         expect(myComp.doCheckCount).toBe(2);\n+       }));\n+\n     it('should detectChanges only once if markDirty is called multiple times',\n        withBody('my-comp', () => {\n          const myComp = renderComponent(MyComponent, {hostFeatures: [LifecycleHooksFeature]});"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 104,
        "deletions": 5
    }
}