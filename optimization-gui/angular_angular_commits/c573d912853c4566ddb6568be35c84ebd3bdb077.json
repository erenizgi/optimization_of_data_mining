{
    "author": "alxhub",
    "message": "refactor(compiler-cli): allow program strategies to opt out of inlining (#38105)\n\nThe template type-checking engine relies on the abstraction interface\n`TypeCheckingProgramStrategy` to create updated `ts.Program`s for\ntemplate type-checking. The basic API is that the type-checking engine\nrequests changes to certain files in the program, and the strategy provides\nan updated `ts.Program`.\n\nTypically, such changes are made to 'ngtypecheck' shim files, but certain\nconditions can cause template type-checking to require \"inline\" operations,\nwhich change user .ts files instead. The strategy used by 'ngc' (the\n`ReusedProgramStrategy`) supports these kinds of updates, but other clients\nsuch as the language service might not always support modifying user files.\n\nTo accommodate this, the `TypeCheckingProgramStrategy` interface was\nmodified to include a `supportsInlineOperations` flag. If an implementation\nspecifies `false` for inline support, the template type-checking system will\nreturn diagnostics on components which would otherwise require inline\noperations.\n\nCloses #38059\n\nPR Close #38105",
    "sha": "c573d912853c4566ddb6568be35c84ebd3bdb077",
    "files": [
        {
            "sha": "41ad7164771fee8f8e29d2596cf9bc0fbf0f6044",
            "filename": "goldens/public-api/compiler-cli/error_code.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -32,5 +32,7 @@ export declare enum ErrorCode {\n     MISSING_PIPE = 8004,\n     WRITE_TO_READ_ONLY_VARIABLE = 8005,\n     DUPLICATE_VARIABLE_DECLARATION = 8006,\n+    INLINE_TCB_REQUIRED = 8900,\n+    INLINE_TYPE_CTOR_REQUIRED = 8901,\n     INJECTABLE_DUPLICATE_PROV = 9001\n }"
        },
        {
            "sha": "91eb8123840cd8b428a861e4f371350db9d79534",
            "filename": "packages/compiler-cli/src/ngtsc/diagnostics/src/error_code.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fdiagnostics%2Fsrc%2Ferror_code.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -138,6 +138,18 @@ export enum ErrorCode {\n    */\n   DUPLICATE_VARIABLE_DECLARATION = 8006,\n \n+  /**\n+   * The template type-checking engine would need to generate an inline type check block for a\n+   * component, but the current type-checking environment doesn't support it.\n+   */\n+  INLINE_TCB_REQUIRED = 8900,\n+\n+  /**\n+   * The template type-checking engine would need to generate an inline type constructor for a\n+   * directive or component, but the current type-checking environment doesn't support it.\n+   */\n+  INLINE_TYPE_CTOR_REQUIRED = 8901,\n+\n   /**\n    * An injectable already has a `Éµprov` property.\n    */"
        },
        {
            "sha": "b7db3f0f6d8419b768f83796f573ec12681021ef",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fapi.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -304,6 +304,12 @@ export interface ComponentToShimMappingStrategy {\n  * implement efficient template type-checking using common infrastructure.\n  */\n export interface TypeCheckingProgramStrategy extends ComponentToShimMappingStrategy {\n+  /**\n+   * Whether this strategy supports modifying user files (inline modifications) in addition to\n+   * modifying type-checking shims.\n+   */\n+  readonly supportsInlineOperations: boolean;\n+\n   /**\n    * Retrieve the latest version of the program, containing all the updates made thus far.\n    */"
        },
        {
            "sha": "6176b36a12a817df2bfd58b37acadfff8684ebad",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/augmented_program.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Faugmented_program.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -34,6 +34,8 @@ export class ReusedProgramStrategy implements TypeCheckingProgramStrategy {\n       private originalProgram: ts.Program, private originalHost: ts.CompilerHost,\n       private options: ts.CompilerOptions, private shimExtensionPrefixes: string[]) {}\n \n+  readonly supportsInlineOperations = true;\n+\n   getProgram(): ts.Program {\n     return this.program;\n   }"
        },
        {
            "sha": "53fa546853af939cefa2759f3f7218f3776f3dec",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -16,7 +16,7 @@ import {isShim} from '../../shims';\n import {getSourceFileOrNull} from '../../util/src/typescript';\n import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n \n-import {ShimTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from './context';\n+import {InliningMode, ShimTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from './context';\n import {findTypeCheckBlock, shouldReportDiagnostic, TemplateSourceResolver, translateDiagnostic} from './diagnostics';\n import {TemplateSourceManager} from './source';\n \n@@ -145,9 +145,11 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n   }\n \n   private newContext(host: TypeCheckingHost): TypeCheckContextImpl {\n+    const inlining = this.typeCheckingStrategy.supportsInlineOperations ? InliningMode.InlineOps :\n+                                                                          InliningMode.Error;\n     return new TypeCheckContextImpl(\n         this.config, this.compilerHost, this.typeCheckingStrategy, this.refEmitter, this.reflector,\n-        host);\n+        host, inlining);\n   }\n \n   private updateFromContext(ctx: TypeCheckContextImpl): void {"
        },
        {
            "sha": "e5a155321dea985b217bf435a8521f376a3c142a",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 2,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -114,6 +114,20 @@ export interface TypeCheckingHost {\n   recordComplete(sfPath: AbsoluteFsPath): void;\n }\n \n+/**\n+ * How a type-checking context should handle operations which would require inlining.\n+ */\n+export enum InliningMode {\n+  /**\n+   * Use inlining operations when required.\n+   */\n+  InlineOps,\n+\n+  /**\n+   * Produce diagnostics if an operation would require inlining.\n+   */\n+  Error,\n+}\n \n /**\n  * A template type checking context for a program.\n@@ -129,7 +143,7 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n       private componentMappingStrategy: ComponentToShimMappingStrategy,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n-      private host: TypeCheckingHost) {}\n+      private host: TypeCheckingHost, private inlining: InliningMode) {}\n \n   /**\n    * A `Map` of `ts.SourceFile`s that the context has seen to the operations (additions of methods\n@@ -161,6 +175,10 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       return;\n     }\n \n+    // Accumulate a list of any directives which could not have type constructors generated due to\n+    // unsupported inlining operations.\n+    let missingInlines: ClassDeclaration[] = [];\n+\n     const fileData = this.dataForFile(ref.node.getSourceFile());\n     const shimData = this.pendingShimForComponent(ref.node);\n     const boundTarget = binder.bind({template});\n@@ -169,6 +187,11 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       const dirRef = dir.ref as Reference<ClassDeclaration<ts.ClassDeclaration>>;\n       const dirNode = dirRef.node;\n       if (requiresInlineTypeCtor(dirNode, this.reflector)) {\n+        if (this.inlining === InliningMode.Error) {\n+          missingInlines.push(dirNode);\n+          continue;\n+        }\n+\n         // Add a type constructor operation for the directive.\n         this.addInlineTypeCtor(fileData, dirNode.getSourceFile(), dirRef, {\n           fnName: 'ngTypeCtor',\n@@ -186,13 +209,34 @@ export class TypeCheckContextImpl implements TypeCheckContext {\n       }\n     }\n \n+    const tcbRequiresInline = requiresInlineTypeCheckBlock(ref.node);\n+\n+    // If inlining is not supported, but is required for either the TCB or one of its directive\n+    // dependencies, then exit here with an error.\n+    if (this.inlining === InliningMode.Error && (tcbRequiresInline || missingInlines.length > 0)) {\n+      // This template cannot be supported because the underlying strategy does not support inlining\n+      // and inlining would be required.\n+\n+      // Record diagnostics to indicate the issues with this template.\n+      if (tcbRequiresInline) {\n+        shimData.oobRecorder.requiresInlineTcb(ref.node);\n+      }\n+\n+      if (missingInlines.length > 0) {\n+        shimData.oobRecorder.requiresInlineTypeConstructors(ref.node, missingInlines);\n+      }\n+\n+      // Checking this template would be unsupported, so don't try.\n+      return;\n+    }\n+\n     const meta = {\n       id: fileData.sourceManager.captureSource(ref.node, sourceMapping, file),\n       boundTarget,\n       pipes,\n       schemas,\n     };\n-    if (requiresInlineTypeCheckBlock(ref.node)) {\n+    if (tcbRequiresInline) {\n       // This class didn't meet the requirements for external type checking, so generate an inline\n       // TCB for the class.\n       this.addInlineTypeCheckBlock(fileData, shimData, ref, meta);"
        },
        {
            "sha": "1e728be7c35f0abeb3e5265a33bcee3b58cf65a8",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/oob.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -9,7 +9,8 @@\n import {BindingPipe, PropertyWrite, TmplAstReference, TmplAstVariable} from '@angular/compiler';\n import * as ts from 'typescript';\n \n-import {ErrorCode, ngErrorCode} from '../../diagnostics';\n+import {ErrorCode, makeDiagnostic, makeRelatedInformation, ngErrorCode} from '../../diagnostics';\n+import {ClassDeclaration} from '../../reflection';\n import {TemplateId} from '../api';\n \n import {makeTemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n@@ -61,6 +62,10 @@ export interface OutOfBandDiagnosticRecorder {\n    */\n   duplicateTemplateVar(\n       templateId: TemplateId, variable: TmplAstVariable, firstDecl: TmplAstVariable): void;\n+\n+  requiresInlineTcb(node: ClassDeclaration): void;\n+\n+  requiresInlineTypeConstructors(node: ClassDeclaration, directives: ClassDeclaration[]): void;\n }\n \n export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecorder {\n@@ -133,4 +138,26 @@ export class OutOfBandDiagnosticRecorderImpl implements OutOfBandDiagnosticRecor\n           span: firstDecl.sourceSpan,\n         }));\n   }\n+\n+  requiresInlineTcb(node: ClassDeclaration): void {\n+    this._diagnostics.push(makeDiagnostic(\n+        ErrorCode.INLINE_TCB_REQUIRED, node.name,\n+        `This component requires inline template type-checking, which is not supported by the current environment.`));\n+  }\n+\n+  requiresInlineTypeConstructors(node: ClassDeclaration, directives: ClassDeclaration[]): void {\n+    let message: string;\n+    if (directives.length > 1) {\n+      message =\n+          `This component uses directives which require inline type constructors, which are not supported by the current environment.`;\n+    } else {\n+      message =\n+          `This component uses a directive which requires an inline type constructor, which is not supported by the current environment.`;\n+    }\n+\n+    this._diagnostics.push(makeDiagnostic(\n+        ErrorCode.INLINE_TYPE_CTOR_REQUIRED, node.name, message,\n+        directives.map(\n+            dir => makeRelatedInformation(dir.name, `Requires an inline type constructor.`))));\n+  }\n }"
        },
        {
            "sha": "cf18524f6334dc5ea2e9e5de04ce12c9aca903af",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -11,6 +11,7 @@ ts_library(\n     deps = [\n         \"//packages:types\",\n         \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n         \"//packages/compiler-cli/src/ngtsc/imports\","
        },
        {
            "sha": "a0dee2a11888c71b002357c2a76cc8d48c1bf6e2",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -17,7 +17,6 @@ import {ClassDeclaration, isNamedClassDeclaration, TypeScriptReflectionHost} fro\n import {makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '../api';\n-\n import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, UpdateMode} from '../api/api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n import {TemplateTypeCheckerImpl} from '../src/checker';\n@@ -278,6 +277,7 @@ export interface TypeCheckingTarget {\n export function setup(targets: TypeCheckingTarget[], overrides: {\n   config?: Partial<TypeCheckingConfig>,\n   options?: ts.CompilerOptions,\n+  inlining?: boolean,\n } = {}): {\n   templateTypeChecker: TemplateTypeChecker,\n   program: ts.Program,\n@@ -378,6 +378,10 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n   });\n \n   const programStrategy = new ReusedProgramStrategy(program, host, options, ['ngtypecheck']);\n+  if (overrides.inlining !== undefined) {\n+    (programStrategy as any).supportsInlineOperations = overrides.inlining;\n+  }\n+\n   const templateTypeChecker = new TemplateTypeCheckerImpl(\n       program, programStrategy, checkAdapter, fullConfig, emitter, reflectionHost, host,\n       NOOP_INCREMENTAL_BUILD);\n@@ -501,4 +505,6 @@ export class NoopOobRecorder implements OutOfBandDiagnosticRecorder {\n   missingPipe(): void {}\n   illegalAssignmentToTemplateVar(): void {}\n   duplicateTemplateVar(): void {}\n+  requiresInlineTcb(): void {}\n+  requiresInlineTypeConstructors(): void {}\n }"
        },
        {
            "sha": "2c1ee6b751c883a856c57e84496cd2cd833f4249",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker_spec.ts",
            "status": "modified",
            "additions": 87,
            "deletions": 1,
            "changes": 88,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker_spec.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -6,7 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {absoluteFrom, getSourceFileOrError} from '../../file_system';\n+import {ErrorCode, ngErrorCode} from '../../diagnostics';\n+import {absoluteFrom, absoluteFromSourceFile, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n \n import {getClass, setup} from './test_utils';\n@@ -43,5 +44,90 @@ runInEachFileSystem(() => {\n       expect(block!.getText()).toMatch(/: i[0-9]\\.Cmp1/);\n       expect(block!.getText()).toContain(`document.createElement(\"div\")`);\n     });\n+\n+    describe('when inlining is unsupported', () => {\n+      it('should not produce errors for components that do not require inlining', () => {\n+        const fileName = absoluteFrom('/main.ts');\n+        const dirFile = absoluteFrom('/dir.ts');\n+        const {program, templateTypeChecker} = setup(\n+            [\n+              {\n+                fileName,\n+                source: `export class Cmp {}`,\n+                templates: {'Cmp': '<div dir></div>'},\n+                declarations: [{\n+                  name: 'TestDir',\n+                  selector: '[dir]',\n+                  file: dirFile,\n+                  type: 'directive',\n+                }]\n+              },\n+              {\n+                fileName: dirFile,\n+                source: `export class TestDir {}`,\n+                templates: {},\n+              }\n+            ],\n+            {inlining: false});\n+        const sf = getSourceFileOrError(program, fileName);\n+        const diags = templateTypeChecker.getDiagnosticsForFile(sf);\n+        expect(diags.length).toBe(0);\n+      });\n+\n+      it('should produce errors for components that require TCB inlining', () => {\n+        const fileName = absoluteFrom('/main.ts');\n+        const {program, templateTypeChecker} = setup(\n+            [{\n+              fileName,\n+              source: `class Cmp {} // not exported, so requires inline`,\n+              templates: {'Cmp': '<div></div>'}\n+            }],\n+            {inlining: false});\n+        const sf = getSourceFileOrError(program, fileName);\n+        const diags = templateTypeChecker.getDiagnosticsForFile(sf);\n+        expect(diags.length).toBe(1);\n+        expect(diags[0].code).toBe(ngErrorCode(ErrorCode.INLINE_TCB_REQUIRED));\n+      });\n+\n+      it('should produce errors for components that require type constructor inlining', () => {\n+        const fileName = absoluteFrom('/main.ts');\n+        const dirFile = absoluteFrom('/dir.ts');\n+        const {program, templateTypeChecker} = setup(\n+            [\n+              {\n+                fileName,\n+                source: `export class Cmp {}`,\n+                templates: {'Cmp': '<div dir></div>'},\n+                declarations: [{\n+                  name: 'TestDir',\n+                  selector: '[dir]',\n+                  file: dirFile,\n+                  type: 'directive',\n+                }]\n+              },\n+              {\n+                fileName: dirFile,\n+                source: `\n+                  // A non-exported interface used as a type bound for a generic directive causes\n+                  // an inline type constructor to be required.\n+                  interface NotExported {}\n+                  export class TestDir<T extends NotExported> {}`,\n+                templates: {},\n+              }\n+            ],\n+            {inlining: false});\n+        const sf = getSourceFileOrError(program, fileName);\n+        const diags = templateTypeChecker.getDiagnosticsForFile(sf);\n+        expect(diags.length).toBe(1);\n+        expect(diags[0].code).toBe(ngErrorCode(ErrorCode.INLINE_TYPE_CTOR_REQUIRED));\n+\n+        // The relatedInformation of the diagnostic should point to the directive which required the\n+        // inline type constructor.\n+        expect(diags[0].relatedInformation).not.toBeUndefined();\n+        expect(diags[0].relatedInformation!.length).toBe(1);\n+        expect(diags[0].relatedInformation![0].file).not.toBeUndefined();\n+        expect(absoluteFromSourceFile(diags[0].relatedInformation![0].file!)).toBe(dirFile);\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "54c399f1ba988a469997acf1da53f8291d3350a0",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_constructor_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_constructor_spec.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -15,7 +15,7 @@ import {getDeclaration, makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {ComponentToShimMappingStrategy, UpdateMode} from '../api';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n-import {PendingFileTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from '../src/context';\n+import {InliningMode, PendingFileTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from '../src/context';\n import {TemplateSourceManager} from '../src/source';\n import {TypeCheckFile} from '../src/type_check_file';\n \n@@ -74,7 +74,7 @@ TestClass.ngTypeCtor({value: 'test'});\n         ]);\n         const ctx = new TypeCheckContextImpl(\n             ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n-            new TestTypeCheckingHost());\n+            new TestTypeCheckingHost(), InliningMode.InlineOps);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         const pendingFile = makePendingFile();\n@@ -113,7 +113,7 @@ TestClass.ngTypeCtor({value: 'test'});\n         const pendingFile = makePendingFile();\n         const ctx = new TypeCheckContextImpl(\n             ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n-            new TestTypeCheckingHost());\n+            new TestTypeCheckingHost(), InliningMode.InlineOps);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor(\n@@ -158,7 +158,7 @@ TestClass.ngTypeCtor({value: 'test'});\n         const pendingFile = makePendingFile();\n         const ctx = new TypeCheckContextImpl(\n             ALL_ENABLED_CONFIG, host, new TestMappingStrategy(), emitter, reflectionHost,\n-            new TestTypeCheckingHost());\n+            new TestTypeCheckingHost(), InliningMode.InlineOps);\n         const TestClass =\n             getDeclaration(program, _('/main.ts'), 'TestClass', isNamedClassDeclaration);\n         ctx.addInlineTypeCtor("
        },
        {
            "sha": "37f73f0efe6b085c17559bdd77f7489da5102712",
            "filename": "packages/language-service/ivy/compiler/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/c573d912853c4566ddb6568be35c84ebd3bdb077/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler%2Fcompiler.ts?ref=c573d912853c4566ddb6568be35c84ebd3bdb077",
            "patch": "@@ -76,6 +76,7 @@ export class Compiler {\n function createTypeCheckingProgramStrategy(project: ts.server.Project):\n     TypeCheckingProgramStrategy {\n   return {\n+    supportsInlineOperations: false,\n     shimPathForComponent(component: ts.ClassDeclaration): AbsoluteFsPath {\n       return TypeCheckShimGenerator.shimFor(absoluteFromSourceFile(component.getSourceFile()));\n     },"
        }
    ],
    "stats": {
        "total": 211,
        "additions": 200,
        "deletions": 11
    }
}