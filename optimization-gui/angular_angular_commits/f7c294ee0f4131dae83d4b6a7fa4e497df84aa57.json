{
    "author": "crisbeto",
    "message": "feat(core): support `forwardRef` in `providedIn` of `Injectable` declaration (#41426)\n\nAdds support for using a `forwardRef` inside of the `providedIn` of an `Injectable` declaration.\n\nFixes #41205.\n\nPR Close #41426",
    "sha": "f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
    "files": [
        {
            "sha": "a18743add78da7c00c2e6ae5bea11e71b317aa5b",
            "filename": "packages/compiler-cli/test/ngc_spec.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngc_spec.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -2303,6 +2303,22 @@ describe('ngc transformer command-line', () => {\n       `);\n       expect(source).toMatch(/new Service\\(i0\\.ɵɵinject\\(exports\\.TOKEN\\)\\);/);\n     });\n+\n+    it('compiles an injectable using `forwardRef` inside `providedIn`', () => {\n+      const source = compileService(`\n+        import {Injectable, forwardRef} from '@angular/core';\n+        import {Module} from './module';\n+\n+        @Injectable({\n+          providedIn: forwardRef(() => Module),\n+        })\n+        export class Service {}\n+      `);\n+\n+      expect(source).toMatch(/ɵprov = .+\\.ɵɵdefineInjectable\\(/);\n+      expect(source).toMatch(/ɵprov.*token: Service/);\n+      expect(source).toMatch(/ɵprov.*providedIn: .+\\.Module/);\n+    });\n   });\n \n   it('libraries should not break strictMetadataEmit', () => {"
        },
        {
            "sha": "95c0ef5209ccf201192b9208d09acc5980cc3a13",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -183,6 +183,41 @@ function allTests(os: string) {\n       expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Service, never>;');\n     });\n \n+    it('should compile Injectables with providedIn using forwardRef without errors', () => {\n+      env.write('test.ts', `\n+        import {Injectable, NgModule, forwardRef} from '@angular/core';\n+\n+        @Injectable()\n+        export class Dep {}\n+\n+        @Injectable({ providedIn: forwardRef(() => Mod) })\n+        export class Service {\n+          constructor(dep: Dep) {}\n+        }\n+\n+        @NgModule()\n+        export class Mod {}\n+    `);\n+\n+      env.driveMain();\n+\n+      const jsContents = env.getContents('test.js');\n+      expect(jsContents).toContain('Dep.ɵprov =');\n+      expect(jsContents).toContain('Service.ɵprov =');\n+      expect(jsContents).toContain('Mod.ɵmod =');\n+      expect(jsContents)\n+          .toContain(\n+              'Service.ɵfac = function Service_Factory(t) { return new (t || Service)(i0.ɵɵinject(Dep)); };');\n+      expect(jsContents).toContain('providedIn: forwardRef(function () { return Mod; }) })');\n+      expect(jsContents).not.toContain('__decorate');\n+      const dtsContents = env.getContents('test.d.ts');\n+      expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDef<Dep>;');\n+      expect(dtsContents).toContain('static ɵprov: i0.ɵɵInjectableDef<Service>;');\n+      expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Dep, never>;');\n+      expect(dtsContents).toContain('static ɵfac: i0.ɵɵFactoryDeclaration<Service, never>;');\n+      expect(dtsContents).toContain('i0.ɵɵFactoryDeclaration<Mod, never>;');\n+    });\n+\n     it('should compile @Injectable with an @Optional dependency', () => {\n       env.write('test.ts', `\n       import {Injectable, Optional as Opt} from '@angular/core';"
        },
        {
            "sha": "50cc2a6dacc6cbb64825d37ab66c5af13e1bff33",
            "filename": "packages/core/src/di/injector.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fdi%2Finjector.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fdi%2Finjector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Finjector.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -166,7 +166,7 @@ export class StaticInjector implements Injector {\n       // This means we have never seen this record, see if it is tree shakable provider.\n       const injectableDef = getInjectableDef(token);\n       if (injectableDef) {\n-        const providedIn = injectableDef && injectableDef.providedIn;\n+        const providedIn = injectableDef && resolveForwardRef(injectableDef.providedIn);\n         if (providedIn === 'any' || providedIn != null && providedIn === this.scope) {\n           records.set(\n               token,"
        },
        {
            "sha": "1cf239b9a7dc49a265a0241f75acbab96c263d0c",
            "filename": "packages/core/src/di/r3_injector.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fdi%2Fr3_injector.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fdi%2Fr3_injector.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fdi%2Fr3_injector.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -420,10 +420,12 @@ export class R3Injector {\n   private injectableDefInScope(def: ɵɵInjectableDef<any>): boolean {\n     if (!def.providedIn) {\n       return false;\n-    } else if (typeof def.providedIn === 'string') {\n-      return def.providedIn === 'any' || (def.providedIn === this.scope);\n+    }\n+    const providedIn = resolveForwardRef(def.providedIn);\n+    if (typeof providedIn === 'string') {\n+      return providedIn === 'any' || (providedIn === this.scope);\n     } else {\n-      return this.injectorDefTypes.has(def.providedIn);\n+      return this.injectorDefTypes.has(providedIn);\n     }\n   }\n }"
        },
        {
            "sha": "1c038d78aee172c6c66ae925e39931fcaccba618",
            "filename": "packages/core/src/view/ng_module.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fview%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fview%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fview%2Fng_module.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -138,7 +138,7 @@ function moduleTransitivelyPresent(ngModule: NgModuleData, scope: any): boolean\n }\n \n function targetsModule(ngModule: NgModuleData, def: ɵɵInjectableDef<any>): boolean {\n-  const providedIn = def.providedIn;\n+  const providedIn = resolveForwardRef(def.providedIn);\n   return providedIn != null &&\n       (providedIn === 'any' || providedIn === ngModule._def.scope ||\n        moduleTransitivelyPresent(ngModule, providedIn));"
        },
        {
            "sha": "98796467582a611388f7944bb32874963472e0e7",
            "filename": "packages/core/src/view/services.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fview%2Fservices.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {DebugElement__PRE_R3__, DebugEventListener, DebugNode__PRE_R3__, getDebugNode, indexDebugNode, removeDebugNodeFromIndex} from '../debug/debug_node';\n-import {Injector} from '../di';\n+import {Injector, resolveForwardRef} from '../di';\n import {getInjectableDef, InjectableType, ɵɵInjectableDef} from '../di/interface/defs';\n import {ErrorHandler} from '../error_handler';\n import {Type} from '../interface/type';\n@@ -282,7 +282,7 @@ function applyProviderOverridesToNgModule(def: NgModuleDefinition): NgModuleDefi\n     });\n     def.modules.forEach(module => {\n       providerOverridesWithScope.forEach((override, token) => {\n-        if (getInjectableDef(token)!.providedIn === module) {\n+        if (resolveForwardRef(getInjectableDef(token)!.providedIn) === module) {\n           hasOverrides = true;\n           hasDeprecatedOverrides = hasDeprecatedOverrides || override.deprecatedBehavior;\n         }\n@@ -310,7 +310,7 @@ function applyProviderOverridesToNgModule(def: NgModuleDefinition): NgModuleDefi\n     if (providerOverridesWithScope.size > 0) {\n       let moduleSet = new Set<any>(def.modules);\n       providerOverridesWithScope.forEach((override, token) => {\n-        if (moduleSet.has(getInjectableDef(token)!.providedIn)) {\n+        if (moduleSet.has(resolveForwardRef(getInjectableDef(token)!.providedIn))) {\n           let provider = {\n             token: token,\n             flags:"
        },
        {
            "sha": "69cda5ce1bac900d7b54336ae884b74829ab34dc",
            "filename": "packages/core/test/acceptance/di_spec.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdi_spec.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -1951,6 +1951,34 @@ describe('di', () => {\n       const platformService = childInjector.get(PlatformService);\n       expect(platformService.injector.get(ɵINJECTOR_SCOPE)).toBe('platform');\n     });\n+\n+    it('should create a provider that uses `forwardRef` inside `providedIn`', () => {\n+      @Injectable()\n+      class ProviderDep {\n+        getNumber() {\n+          return 3;\n+        }\n+      }\n+\n+      @Injectable({providedIn: forwardRef(() => Module)})\n+      class Provider {\n+        constructor(private _dep: ProviderDep) {}\n+        value = this._dep.getNumber() + 2;\n+      }\n+\n+      @Component({template: ''})\n+      class Comp {\n+        constructor(public provider: Provider) {}\n+      }\n+\n+      @NgModule({declarations: [Comp], exports: [Comp], providers: [ProviderDep]})\n+      class Module {\n+      }\n+\n+      TestBed.configureTestingModule({imports: [Module]});\n+      const fixture = TestBed.createComponent(Comp);\n+      expect(fixture.componentInstance.provider.value).toBe(5);\n+    });\n   });\n \n   describe('service injection', () => {"
        },
        {
            "sha": "f5efc15cabdf7e22c86f20fedb5c54531e877f8a",
            "filename": "packages/core/testing/src/r3_test_bed_compiler.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7c294ee0f4131dae83d4b6a7fa4e497df84aa57/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftesting%2Fsrc%2Fr3_test_bed_compiler.ts?ref=f7c294ee0f4131dae83d4b6a7fa4e497df84aa57",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {ResourceLoader} from '@angular/compiler';\n-import {ApplicationInitStatus, Compiler, COMPILER_OPTIONS, Component, Directive, Injector, InjectorType, LOCALE_ID, ModuleWithComponentFactories, ModuleWithProviders, NgModule, NgModuleFactory, NgZone, Pipe, PlatformRef, Provider, Type, ɵcompileComponent as compileComponent, ɵcompileDirective as compileDirective, ɵcompileNgModuleDefs as compileNgModuleDefs, ɵcompilePipe as compilePipe, ɵDEFAULT_LOCALE_ID as DEFAULT_LOCALE_ID, ɵDirectiveDef as DirectiveDef, ɵgetInjectableDef as getInjectableDef, ɵNG_COMP_DEF as NG_COMP_DEF, ɵNG_DIR_DEF as NG_DIR_DEF, ɵNG_INJ_DEF as NG_INJ_DEF, ɵNG_MOD_DEF as NG_MOD_DEF, ɵNG_PIPE_DEF as NG_PIPE_DEF, ɵNgModuleFactory as R3NgModuleFactory, ɵNgModuleTransitiveScopes as NgModuleTransitiveScopes, ɵNgModuleType as NgModuleType, ɵpatchComponentDefWithScope as patchComponentDefWithScope, ɵRender3ComponentFactory as ComponentFactory, ɵRender3NgModuleRef as NgModuleRef, ɵsetLocaleId as setLocaleId, ɵtransitiveScopesFor as transitiveScopesFor, ɵɵInjectableDef as InjectableDef} from '@angular/core';\n+import {ApplicationInitStatus, Compiler, COMPILER_OPTIONS, Component, Directive, Injector, InjectorType, LOCALE_ID, ModuleWithComponentFactories, ModuleWithProviders, NgModule, NgModuleFactory, NgZone, Pipe, PlatformRef, Provider, resolveForwardRef, Type, ɵcompileComponent as compileComponent, ɵcompileDirective as compileDirective, ɵcompileNgModuleDefs as compileNgModuleDefs, ɵcompilePipe as compilePipe, ɵDEFAULT_LOCALE_ID as DEFAULT_LOCALE_ID, ɵDirectiveDef as DirectiveDef, ɵgetInjectableDef as getInjectableDef, ɵNG_COMP_DEF as NG_COMP_DEF, ɵNG_DIR_DEF as NG_DIR_DEF, ɵNG_INJ_DEF as NG_INJ_DEF, ɵNG_MOD_DEF as NG_MOD_DEF, ɵNG_PIPE_DEF as NG_PIPE_DEF, ɵNgModuleFactory as R3NgModuleFactory, ɵNgModuleTransitiveScopes as NgModuleTransitiveScopes, ɵNgModuleType as NgModuleType, ɵpatchComponentDefWithScope as patchComponentDefWithScope, ɵRender3ComponentFactory as ComponentFactory, ɵRender3NgModuleRef as NgModuleRef, ɵsetLocaleId as setLocaleId, ɵtransitiveScopesFor as transitiveScopesFor, ɵɵInjectableDef as InjectableDef} from '@angular/core';\n \n import {clearResolutionOfComponentResourcesQueue, isComponentDefPendingResolution, resolveComponentResources, restoreComponentResolutionQueue} from '../../src/metadata/resource_loading';\n \n@@ -176,19 +176,19 @@ export class R3TestBedCompiler {\n \n     const injectableDef: InjectableDef<any>|null =\n         typeof token !== 'string' ? getInjectableDef(token) : null;\n-    const isRoot = injectableDef !== null && injectableDef.providedIn === 'root';\n-    const overridesBucket = isRoot ? this.rootProviderOverrides : this.providerOverrides;\n+    const providedIn = injectableDef === null ? null : resolveForwardRef(injectableDef.providedIn);\n+    const overridesBucket =\n+        providedIn === 'root' ? this.rootProviderOverrides : this.providerOverrides;\n     overridesBucket.push(providerDef);\n \n     // Keep overrides grouped by token as well for fast lookups using token\n     this.providerOverridesByToken.set(token, providerDef);\n-    if (injectableDef !== null && injectableDef.providedIn !== null &&\n-        typeof injectableDef.providedIn !== 'string') {\n-      const existingOverrides = this.providerOverridesByModule.get(injectableDef.providedIn);\n+    if (injectableDef !== null && providedIn !== null && typeof providedIn !== 'string') {\n+      const existingOverrides = this.providerOverridesByModule.get(providedIn);\n       if (existingOverrides !== undefined) {\n         existingOverrides.push(providerDef);\n       } else {\n-        this.providerOverridesByModule.set(injectableDef.providedIn, [providerDef]);\n+        this.providerOverridesByModule.set(providedIn, [providerDef]);\n       }\n     }\n   }"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 96,
        "deletions": 15
    }
}