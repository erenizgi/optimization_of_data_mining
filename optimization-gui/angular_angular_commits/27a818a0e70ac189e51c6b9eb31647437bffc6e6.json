{
    "author": "josephperrott",
    "message": "fix(dev-infra): check and validate npm login state for release publishing (#40485)\n\nCheck and require logging into NPM before beginning the release process.\n\nPR Close #40485",
    "sha": "27a818a0e70ac189e51c6b9eb31647437bffc6e6",
    "files": [
        {
            "sha": "d1c5377088622b2a9f157467d1437413a57d5183",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 195,
            "deletions": 98,
            "changes": 293,
            "blob_url": "https://github.com/angular/angular/blob/27a818a0e70ac189e51c6b9eb31647437bffc6e6/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/27a818a0e70ac189e51c6b9eb31647437bffc6e6/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=27a818a0e70ac189e51c6b9eb31647437bffc6e6",
            "patch": "@@ -5008,6 +5008,159 @@ const ReleaseBuildCommandModule = {\n     describe: 'Builds the release output for the current branch.',\n };\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/**\n+ * Spawns a given command with the specified arguments inside a shell. All process stdout\n+ * output is captured and returned as resolution on completion. Depending on the chosen\n+ * output mode, stdout/stderr output is also printed to the console, or only on error.\n+ *\n+ * @returns a Promise resolving with captured stdout on success. The promise\n+ *   rejects on command failure.\n+ */\n+function spawnWithDebugOutput(command, args, options) {\n+    if (options === void 0) { options = {}; }\n+    return new Promise(function (resolve, reject) {\n+        var commandText = command + \" \" + args.join(' ');\n+        var outputMode = options.mode;\n+        debug(\"Executing command: \" + commandText);\n+        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: ['inherit', 'pipe', 'pipe'] }));\n+        var logOutput = '';\n+        var stdout = '';\n+        // Capture the stdout separately so that it can be passed as resolve value.\n+        // This is useful if commands return parsable stdout.\n+        childProcess.stderr.on('data', function (message) {\n+            logOutput += message;\n+            // If console output is enabled, print the message directly to the stderr. Note that\n+            // we intentionally print all output to stderr as stdout should not be polluted.\n+            if (outputMode === undefined || outputMode === 'enabled') {\n+                process.stderr.write(message);\n+            }\n+        });\n+        childProcess.stdout.on('data', function (message) {\n+            stdout += message;\n+            logOutput += message;\n+            // If console output is enabled, print the message directly to the stderr. Note that\n+            // we intentionally print all output to stderr as stdout should not be polluted.\n+            if (outputMode === undefined || outputMode === 'enabled') {\n+                process.stderr.write(message);\n+            }\n+        });\n+        childProcess.on('exit', function (status, signal) {\n+            var exitDescription = status !== null ? \"exit code \\\"\" + status + \"\\\"\" : \"signal \\\"\" + signal + \"\\\"\";\n+            var printFn = outputMode === 'on-error' ? error : debug;\n+            printFn(\"Command \\\"\" + commandText + \"\\\" completed with \" + exitDescription + \".\");\n+            printFn(\"Process output: \\n\" + logOutput);\n+            // On success, resolve the promise. Otherwise reject with the captured stderr\n+            // and stdout log output if the output mode was set to `silent`.\n+            if (status === 0) {\n+                resolve({ stdout: stdout });\n+            }\n+            else {\n+                reject(outputMode === 'silent' ? logOutput : undefined);\n+            }\n+        });\n+    });\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/**\n+ * Runs NPM publish within a specified package directory.\n+ * @throws With the process log output if the publish failed.\n+ */\n+function runNpmPublish(packagePath, distTag, registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['publish', '--access', 'public', '--tag', distTag];\n+        // If a custom registry URL has been specified, add the `--registry` flag.\n+        if (registryUrl !== undefined) {\n+            args.push('--registry', registryUrl);\n+        }\n+        yield spawnWithDebugOutput('npm', args, { cwd: packagePath, mode: 'silent' });\n+    });\n+}\n+/**\n+ * Sets the NPM tag to the specified version for the given package.\n+ * @throws With the process log output if the tagging failed.\n+ */\n+function setNpmTagForPackage(packageName, distTag, version, registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['dist-tag', 'add', `${packageName}@${version}`, distTag];\n+        // If a custom registry URL has been specified, add the `--registry` flag.\n+        if (registryUrl !== undefined) {\n+            args.push('--registry', registryUrl);\n+        }\n+        yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+    });\n+}\n+/**\n+ * Checks whether the user is currently logged into NPM.\n+ * @returns Whether the user is currently logged into NPM.\n+ */\n+function npmIsLoggedIn(registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['whoami'];\n+        // If a custom registry URL has been specified, add the `--registry` flag.\n+        if (registryUrl !== undefined) {\n+            args.push('--registry', registryUrl);\n+        }\n+        try {\n+            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+        }\n+        catch (e) {\n+            return false;\n+        }\n+        return true;\n+    });\n+}\n+/**\n+ * Log into NPM at a provided registry.\n+ * @throws With the process log output if the login fails.\n+ */\n+function npmLogin(registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['login', '--no-browser'];\n+        // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n+        // must be spliced into the correct place in the command as npm expects it to be the flag\n+        // immediately following the login subcommand.\n+        if (registryUrl !== undefined) {\n+            args.splice(1, 0, '--registry', registryUrl);\n+        }\n+        yield spawnWithDebugOutput('npm', args);\n+    });\n+}\n+/**\n+ * Log out of NPM at a provided registry.\n+ * @returns Whether the user was logged out of NPM.\n+ */\n+function npmLogout(registryUrl) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        const args = ['logout'];\n+        // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n+        // must be spliced into the correct place in the command as npm expects it to be the flag\n+        // immediately following the logout subcommand.\n+        if (registryUrl !== undefined) {\n+            args.splice(1, 0, '--registry', registryUrl);\n+        }\n+        try {\n+            yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n+        }\n+        finally {\n+            return npmIsLoggedIn(registryUrl);\n+        }\n+    });\n+}\n+\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -5115,102 +5268,6 @@ function semverInc(version, release, identifier) {\n     return clone.inc(release, identifier);\n }\n \n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-/**\n- * Spawns a given command with the specified arguments inside a shell. All process stdout\n- * output is captured and returned as resolution on completion. Depending on the chosen\n- * output mode, stdout/stderr output is also printed to the console, or only on error.\n- *\n- * @returns a Promise resolving with captured stdout on success. The promise\n- *   rejects on command failure.\n- */\n-function spawnWithDebugOutput(command, args, options) {\n-    if (options === void 0) { options = {}; }\n-    return new Promise(function (resolve, reject) {\n-        var commandText = command + \" \" + args.join(' ');\n-        var outputMode = options.mode;\n-        debug(\"Executing command: \" + commandText);\n-        var childProcess = child_process.spawn(command, args, tslib.__assign(tslib.__assign({}, options), { shell: true, stdio: ['inherit', 'pipe', 'pipe'] }));\n-        var logOutput = '';\n-        var stdout = '';\n-        // Capture the stdout separately so that it can be passed as resolve value.\n-        // This is useful if commands return parsable stdout.\n-        childProcess.stderr.on('data', function (message) {\n-            logOutput += message;\n-            // If console output is enabled, print the message directly to the stderr. Note that\n-            // we intentionally print all output to stderr as stdout should not be polluted.\n-            if (outputMode === undefined || outputMode === 'enabled') {\n-                process.stderr.write(message);\n-            }\n-        });\n-        childProcess.stdout.on('data', function (message) {\n-            stdout += message;\n-            logOutput += message;\n-            // If console output is enabled, print the message directly to the stderr. Note that\n-            // we intentionally print all output to stderr as stdout should not be polluted.\n-            if (outputMode === undefined || outputMode === 'enabled') {\n-                process.stderr.write(message);\n-            }\n-        });\n-        childProcess.on('exit', function (status, signal) {\n-            var exitDescription = status !== null ? \"exit code \\\"\" + status + \"\\\"\" : \"signal \\\"\" + signal + \"\\\"\";\n-            var printFn = outputMode === 'on-error' ? error : debug;\n-            printFn(\"Command \\\"\" + commandText + \"\\\" completed with \" + exitDescription + \".\");\n-            printFn(\"Process output: \\n\" + logOutput);\n-            // On success, resolve the promise. Otherwise reject with the captured stderr\n-            // and stdout log output if the output mode was set to `silent`.\n-            if (status === 0) {\n-                resolve({ stdout: stdout });\n-            }\n-            else {\n-                reject(outputMode === 'silent' ? logOutput : undefined);\n-            }\n-        });\n-    });\n-}\n-\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-/**\n- * Runs NPM publish within a specified package directory.\n- * @throws With the process log output if the publish failed.\n- */\n-function runNpmPublish(packagePath, distTag, registryUrl) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['publish', '--access', 'public', '--tag', distTag];\n-        // If a custom registry URL has been specified, add the `--registry` flag.\n-        if (registryUrl !== undefined) {\n-            args.push('--registry', registryUrl);\n-        }\n-        yield spawnWithDebugOutput('npm', args, { cwd: packagePath, mode: 'silent' });\n-    });\n-}\n-/**\n- * Sets the NPM tag to the specified version for the given package.\n- * @throws With the process log output if the tagging failed.\n- */\n-function setNpmTagForPackage(packageName, distTag, version, registryUrl) {\n-    return tslib.__awaiter(this, void 0, void 0, function* () {\n-        const args = ['dist-tag', 'add', `${packageName}@${version}`, distTag];\n-        // If a custom registry URL has been specified, add the `--registry` flag.\n-        if (registryUrl !== undefined) {\n-            args.push('--registry', registryUrl);\n-        }\n-        yield spawnWithDebugOutput('npm', args, { mode: 'silent' });\n-    });\n-}\n-\n /**\n  * @license\n  * Copyright Google LLC All Rights Reserved.\n@@ -6383,6 +6440,8 @@ class ReleaseTool {\n         this._projectRoot = _projectRoot;\n         /** Client for interacting with the Github API and the local Git command. */\n         this._git = new GitClient(this._githubToken, { github: this._github }, this._projectRoot);\n+        /** The previous git commit to return back to after the release tool runs. */\n+        this.previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n     }\n     /** Runs the interactive release tool. */\n     run() {\n@@ -6395,14 +6454,16 @@ class ReleaseTool {\n             if (!(yield this._verifyNoUncommittedChanges()) || !(yield this._verifyRunningFromNextBranch())) {\n                 return CompletionState.FATAL_ERROR;\n             }\n+            if (!(yield this._verifyNpmLoginState())) {\n+                return CompletionState.MANUALLY_ABORTED;\n+            }\n             const { owner, name } = this._github;\n             const repo = { owner, name, api: this._git.github };\n             const releaseTrains = yield fetchActiveReleaseTrains(repo);\n             // Print the active release trains so that the caretaker can access\n             // the current project branching state without switching context.\n             yield printActiveReleaseTrains(releaseTrains, this._config);\n             const action = yield this._promptForReleaseAction(releaseTrains);\n-            const previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n             try {\n                 yield action.perform();\n             }\n@@ -6418,11 +6479,20 @@ class ReleaseTool {\n                 return CompletionState.FATAL_ERROR;\n             }\n             finally {\n-                this._git.checkout(previousGitBranchOrRevision, true);\n+                yield this.cleanup();\n             }\n             return CompletionState.SUCCESS;\n         });\n     }\n+    /** Run post release tool cleanups. */\n+    cleanup() {\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            // Return back to the git state from before the release tool ran.\n+            this._git.checkout(this.previousGitBranchOrRevision, true);\n+            // Ensure log out of NPM.\n+            yield npmLogout(this._config.publishRegistry);\n+        });\n+    }\n     /** Prompts the caretaker for a release action that should be performed. */\n     _promptForReleaseAction(activeTrains) {\n         return tslib.__awaiter(this, void 0, void 0, function* () {\n@@ -6473,6 +6543,33 @@ class ReleaseTool {\n             return true;\n         });\n     }\n+    /**\n+     * Verifies that the user is logged into NPM at the correct registry, if defined for the release.\n+     * @returns a boolean indicating whether the user is logged into NPM.\n+     */\n+    _verifyNpmLoginState() {\n+        var _a;\n+        return tslib.__awaiter(this, void 0, void 0, function* () {\n+            const registry = `NPM at the ${(_a = this._config.publishRegistry) !== null && _a !== void 0 ? _a : 'default NPM'} registry`;\n+            if (yield npmIsLoggedIn(this._config.publishRegistry)) {\n+                debug(`Already logged into ${registry}.`);\n+                return true;\n+            }\n+            error(red(`  ✘   Not currently logged into ${registry}.`));\n+            const shouldLogin = yield promptConfirm('Would you like to log into NPM now?');\n+            if (shouldLogin) {\n+                debug('Starting NPM login.');\n+                try {\n+                    yield npmLogin(this._config.publishRegistry);\n+                }\n+                catch (_b) {\n+                    return false;\n+                }\n+                return true;\n+            }\n+            return false;\n+        });\n+    }\n }\n \n /**"
        },
        {
            "sha": "7bb2c1a225be708464ff15f9f907e51a2dbbf3ca",
            "filename": "dev-infra/release/publish/index.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 3,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/27a818a0e70ac189e51c6b9eb31647437bffc6e6/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/27a818a0e70ac189e51c6b9eb31647437bffc6e6/dev-infra%2Frelease%2Fpublish%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Findex.ts?ref=27a818a0e70ac189e51c6b9eb31647437bffc6e6",
            "patch": "@@ -9,10 +9,11 @@\n import {ListChoiceOptions, prompt} from 'inquirer';\n \n import {GithubConfig} from '../../utils/config';\n-import {error, info, log, red, yellow} from '../../utils/console';\n+import {debug, error, info, log, promptConfirm, red, yellow} from '../../utils/console';\n import {GitClient} from '../../utils/git/index';\n import {ReleaseConfig} from '../config';\n import {ActiveReleaseTrains, fetchActiveReleaseTrains, nextBranchName} from '../versioning/active-release-trains';\n+import {npmIsLoggedIn, npmLogin, npmLogout} from '../versioning/npm-publish';\n import {printActiveReleaseTrains} from '../versioning/print-active-trains';\n import {GithubRepoWithApi} from '../versioning/version-branches';\n \n@@ -29,6 +30,8 @@ export enum CompletionState {\n export class ReleaseTool {\n   /** Client for interacting with the Github API and the local Git command. */\n   private _git = new GitClient(this._githubToken, {github: this._github}, this._projectRoot);\n+  /** The previous git commit to return back to after the release tool runs. */\n+  private previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n \n   constructor(\n       protected _config: ReleaseConfig, protected _github: GithubConfig,\n@@ -46,6 +49,10 @@ export class ReleaseTool {\n       return CompletionState.FATAL_ERROR;\n     }\n \n+    if (!await this._verifyNpmLoginState()) {\n+      return CompletionState.MANUALLY_ABORTED;\n+    }\n+\n     const {owner, name} = this._github;\n     const repo: GithubRepoWithApi = {owner, name, api: this._git.github};\n     const releaseTrains = await fetchActiveReleaseTrains(repo);\n@@ -55,7 +62,6 @@ export class ReleaseTool {\n     await printActiveReleaseTrains(releaseTrains, this._config);\n \n     const action = await this._promptForReleaseAction(releaseTrains);\n-    const previousGitBranchOrRevision = this._git.getCurrentBranchOrRevision();\n \n     try {\n       await action.perform();\n@@ -70,12 +76,20 @@ export class ReleaseTool {\n       }\n       return CompletionState.FATAL_ERROR;\n     } finally {\n-      this._git.checkout(previousGitBranchOrRevision, true);\n+      await this.cleanup();\n     }\n \n     return CompletionState.SUCCESS;\n   }\n \n+  /** Run post release tool cleanups. */\n+  private async cleanup(): Promise<void> {\n+    // Return back to the git state from before the release tool ran.\n+    this._git.checkout(this.previousGitBranchOrRevision, true);\n+    // Ensure log out of NPM.\n+    await npmLogout(this._config.publishRegistry);\n+  }\n+\n   /** Prompts the caretaker for a release action that should be performed. */\n   private async _promptForReleaseAction(activeTrains: ActiveReleaseTrains) {\n     const choices: ListChoiceOptions[] = [];\n@@ -129,4 +143,28 @@ export class ReleaseTool {\n     }\n     return true;\n   }\n+\n+  /**\n+   * Verifies that the user is logged into NPM at the correct registry, if defined for the release.\n+   * @returns a boolean indicating whether the user is logged into NPM.\n+   */\n+  private async _verifyNpmLoginState(): Promise<boolean> {\n+    const registry = `NPM at the ${this._config.publishRegistry ?? 'default NPM'} registry`;\n+    if (await npmIsLoggedIn(this._config.publishRegistry)) {\n+      debug(`Already logged into ${registry}.`);\n+      return true;\n+    }\n+    error(red(`  ✘   Not currently logged into ${registry}.`));\n+    const shouldLogin = await promptConfirm('Would you like to log into NPM now?');\n+    if (shouldLogin) {\n+      debug('Starting NPM login.');\n+      try {\n+        await npmLogin(this._config.publishRegistry);\n+      } catch {\n+        return false;\n+      }\n+      return true;\n+    }\n+    return false;\n+  }\n }"
        },
        {
            "sha": "c163b928e63320edc62fc8b8f812de91cb689c8f",
            "filename": "dev-infra/release/versioning/npm-publish.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/angular/angular/blob/27a818a0e70ac189e51c6b9eb31647437bffc6e6/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "raw_url": "https://github.com/angular/angular/raw/27a818a0e70ac189e51c6b9eb31647437bffc6e6/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts?ref=27a818a0e70ac189e51c6b9eb31647437bffc6e6",
            "patch": "@@ -36,3 +36,55 @@ export async function setNpmTagForPackage(\n   }\n   await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n }\n+\n+/**\n+ * Checks whether the user is currently logged into NPM.\n+ * @returns Whether the user is currently logged into NPM.\n+ */\n+export async function npmIsLoggedIn(registryUrl: string|undefined): Promise<boolean> {\n+  const args = ['whoami'];\n+  // If a custom registry URL has been specified, add the `--registry` flag.\n+  if (registryUrl !== undefined) {\n+    args.push('--registry', registryUrl);\n+  }\n+  try {\n+    await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n+  } catch (e) {\n+    return false;\n+  }\n+  return true;\n+}\n+\n+/**\n+ * Log into NPM at a provided registry.\n+ * @throws With the process log output if the login fails.\n+ */\n+export async function npmLogin(registryUrl: string|undefined) {\n+  const args = ['login', '--no-browser'];\n+  // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n+  // must be spliced into the correct place in the command as npm expects it to be the flag\n+  // immediately following the login subcommand.\n+  if (registryUrl !== undefined) {\n+    args.splice(1, 0, '--registry', registryUrl);\n+  }\n+  await spawnWithDebugOutput('npm', args);\n+}\n+\n+/**\n+ * Log out of NPM at a provided registry.\n+ * @returns Whether the user was logged out of NPM.\n+ */\n+export async function npmLogout(registryUrl: string|undefined): Promise<boolean> {\n+  const args = ['logout'];\n+  // If a custom registry URL has been specified, add the `--registry` flag. The `--registry` flag\n+  // must be spliced into the correct place in the command as npm expects it to be the flag\n+  // immediately following the logout subcommand.\n+  if (registryUrl !== undefined) {\n+    args.splice(1, 0, '--registry', registryUrl);\n+  }\n+  try {\n+    await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n+  } finally {\n+    return npmIsLoggedIn(registryUrl);\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 389,
        "additions": 288,
        "deletions": 101
    }
}