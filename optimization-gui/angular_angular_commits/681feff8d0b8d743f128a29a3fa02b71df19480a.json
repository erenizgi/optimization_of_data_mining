{
    "author": "mgechev",
    "message": "fix(devtools): recognize app after reopening devtools\n\nPreviously, Angular DevTools did not recognize the Angular application the second time the user reopens the extension tab. Webpack was preventing us to invoke twice a module with the same name. This PR changes the `content-script` to a library, allowing us to invoke it multiple times.",
    "sha": "681feff8d0b8d743f128a29a3fa02b71df19480a",
    "files": [
        {
            "sha": "2782715b108402f4b8aeac47c75c87a1c7bb2e48",
            "filename": "projects/shell-chrome/shell-chrome-webpack.config.js",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/681feff8d0b8d743f128a29a3fa02b71df19480a/projects%2Fshell-chrome%2Fshell-chrome-webpack.config.js",
            "raw_url": "https://github.com/angular/angular/raw/681feff8d0b8d743f128a29a3fa02b71df19480a/projects%2Fshell-chrome%2Fshell-chrome-webpack.config.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshell-chrome%2Fshell-chrome-webpack.config.js?ref=681feff8d0b8d743f128a29a3fa02b71df19480a",
            "patch": "@@ -2,7 +2,16 @@ const webpack = require('webpack');\n \n module.exports = {\n   entry: {\n-    'content-script': 'projects/shell-chrome/src/app/content-script.ts',\n+    // Use library so that the background script can invoke the content\n+    // script multiple times. Alternatively, webpack is preventing us to do so.\n+    'content-script': {\n+      import: 'projects/shell-chrome/src/app/content-script.ts',\n+      library: {\n+        name: '___devToolsContentScript',\n+        type: 'umd',\n+        umdNamedDefine: true,\n+      },\n+    },\n     'ng-validate': 'projects/shell-chrome/src/app/ng-validate.ts',\n     background: 'projects/shell-chrome/src/app/background.ts',\n     backend: 'projects/shell-chrome/src/app/backend.ts',"
        },
        {
            "sha": "3242aa0fb78c50cafea7653c54def5cb8a3c532a",
            "filename": "projects/shell-chrome/src/app/background.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/681feff8d0b8d743f128a29a3fa02b71df19480a/projects%2Fshell-chrome%2Fsrc%2Fapp%2Fbackground.ts",
            "raw_url": "https://github.com/angular/angular/raw/681feff8d0b8d743f128a29a3fa02b71df19480a/projects%2Fshell-chrome%2Fsrc%2Fapp%2Fbackground.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshell-chrome%2Fsrc%2Fapp%2Fbackground.ts?ref=681feff8d0b8d743f128a29a3fa02b71df19480a",
            "patch": "@@ -64,7 +64,13 @@ const isNumeric = (str: string): boolean => {\n \n const installContentScript = (tabId: number) => {\n   console.log('Installing the content-script');\n-  chrome.tabs.executeScript(tabId, { file: '/content-script.js' }, () => {});\n+  // We first inject the content-script and after that\n+  // invoke the global that it exposes.\n+  chrome.tabs.executeScript(tabId, { file: '/content-script.js' }, (result) => {\n+    chrome.tabs.executeScript(tabId, {\n+      code: '___devToolsContentScript.main()',\n+    });\n+  });\n };\n \n const doublePipe = (devtoolsPort: chrome.runtime.Port | null, contentScriptPort: chrome.runtime.Port, tab: string) => {"
        },
        {
            "sha": "c8b3c3b210b0473398400ca8332f7870fe4a7c4b",
            "filename": "projects/shell-chrome/src/app/content-script.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 40,
            "changes": 83,
            "blob_url": "https://github.com/angular/angular/blob/681feff8d0b8d743f128a29a3fa02b71df19480a/projects%2Fshell-chrome%2Fsrc%2Fapp%2Fcontent-script.ts",
            "raw_url": "https://github.com/angular/angular/raw/681feff8d0b8d743f128a29a3fa02b71df19480a/projects%2Fshell-chrome%2Fsrc%2Fapp%2Fcontent-script.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/projects%2Fshell-chrome%2Fsrc%2Fapp%2Fcontent-script.ts?ref=681feff8d0b8d743f128a29a3fa02b71df19480a",
            "patch": "@@ -1,48 +1,51 @@\n import { ChromeMessageBus } from './chrome-message-bus';\n import { SamePageMessageBus } from './same-page-message-bus';\n \n-let backgroundDisconnected = false;\n-let backendInitialized = false;\n-\n-// console.log('Content script executing');\n-\n-const port = chrome.runtime.connect({\n-  name: 'content-script',\n-});\n+export const main = () => {\n+  let backgroundDisconnected = false;\n+  let backendInitialized = false;\n+\n+  // console.log('Content script executing', (window as any));\n+\n+  const port = chrome.runtime.connect({\n+    name: 'content-script',\n+  });\n+\n+  const handleDisconnect = (): void => {\n+    // console.log('Background disconnected', new Date());\n+    localMessageBus.emit('shutdown');\n+    localMessageBus.destroy();\n+    chromeMessageBus.destroy();\n+    backgroundDisconnected = true;\n+  };\n \n-const handleDisconnect = (): void => {\n-  // console.log('Background disconnected');\n-  localMessageBus.emit('shutdown');\n-  localMessageBus.destroy();\n-  chromeMessageBus.destroy();\n-  backgroundDisconnected = true;\n-};\n+  port.onDisconnect.addListener(handleDisconnect);\n \n-port.onDisconnect.addListener(handleDisconnect);\n+  const localMessageBus = new SamePageMessageBus('angular-devtools-content-script', 'angular-devtools-backend');\n+  const chromeMessageBus = new ChromeMessageBus(port);\n \n-const localMessageBus = new SamePageMessageBus('angular-devtools-content-script', 'angular-devtools-backend');\n-const chromeMessageBus = new ChromeMessageBus(port);\n+  const handshakeWithBackend = (): void => {\n+    localMessageBus.emit('handshake');\n+  };\n \n-const handshakeWithBackend = (): void => {\n-  localMessageBus.emit('handshake');\n+  chromeMessageBus.onAny((topic, args) => {\n+    localMessageBus.emit(topic, args);\n+  });\n+\n+  localMessageBus.onAny((topic, args) => {\n+    backendInitialized = true;\n+    chromeMessageBus.emit(topic, args);\n+  });\n+\n+  if (!backendInitialized) {\n+    console.log('Attempting initialization', new Date());\n+    const retry = () => {\n+      if (backendInitialized || backgroundDisconnected) {\n+        return;\n+      }\n+      handshakeWithBackend();\n+      setTimeout(retry, 500);\n+    };\n+    retry();\n+  }\n };\n-\n-chromeMessageBus.onAny((topic, args) => {\n-  localMessageBus.emit(topic, args);\n-});\n-\n-localMessageBus.onAny((topic, args) => {\n-  backendInitialized = true;\n-  chromeMessageBus.emit(topic, args);\n-});\n-\n-if (!backendInitialized) {\n-  const retry = () => {\n-    if (backendInitialized || backgroundDisconnected) {\n-      return;\n-    }\n-    handshakeWithBackend();\n-    setTimeout(retry, 500);\n-  };\n-  retry();\n-}"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 60,
        "deletions": 42
    }
}