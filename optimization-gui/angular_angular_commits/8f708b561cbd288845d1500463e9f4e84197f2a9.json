{
    "author": "zzmp",
    "message": "fix(router): defer loading of wildcard module until needed (#38348)\n\nDefer loading the wildcard module so that it is not loaded until\nsubscribed to. This fixes an issue where it was being eagerly loaded.\nAs an example, wildcard module loading should only occur after all other potential\nmatches have been exhausted. A test case for this was also added to\ndemonstrate the fix.\n\nFixes #25494\n\nPR Close #38348",
    "sha": "8f708b561cbd288845d1500463e9f4e84197f2a9",
    "files": [
        {
            "sha": "5eb40504737c0e32c35eb67b9bc875360274b1c1",
            "filename": "packages/router/src/apply_redirects.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/8f708b561cbd288845d1500463e9f4e84197f2a9/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f708b561cbd288845d1500463e9f4e84197f2a9/packages%2Frouter%2Fsrc%2Fapply_redirects.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fapply_redirects.ts?ref=8f708b561cbd288845d1500463e9f4e84197f2a9",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {Injector, NgModuleRef} from '@angular/core';\n-import {EmptyError, Observable, Observer, of} from 'rxjs';\n+import {defer, EmptyError, Observable, Observer, of} from 'rxjs';\n import {catchError, concatAll, first, map, mergeMap, tap} from 'rxjs/operators';\n \n import {LoadedRouterConfig, Route, Routes} from './config';\n@@ -247,11 +247,12 @@ class ApplyRedirects {\n       segments: UrlSegment[]): Observable<UrlSegmentGroup> {\n     if (route.path === '**') {\n       if (route.loadChildren) {\n-        return this.configLoader.load(ngModule.injector, route)\n-            .pipe(map((cfg: LoadedRouterConfig) => {\n-              route._loadedConfig = cfg;\n-              return new UrlSegmentGroup(segments, {});\n-            }));\n+        return defer(\n+            () => this.configLoader.load(ngModule.injector, route)\n+                      .pipe(map((cfg: LoadedRouterConfig) => {\n+                        route._loadedConfig = cfg;\n+                        return new UrlSegmentGroup(segments, {});\n+                      })));\n       }\n \n       return of(new UrlSegmentGroup(segments, {}));"
        },
        {
            "sha": "d564727a880ebf9c6a18ac0b7019cf3c2d207118",
            "filename": "packages/router/test/apply_redirects.spec.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/8f708b561cbd288845d1500463e9f4e84197f2a9/packages%2Frouter%2Ftest%2Fapply_redirects.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8f708b561cbd288845d1500463e9f4e84197f2a9/packages%2Frouter%2Ftest%2Fapply_redirects.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fapply_redirects.spec.ts?ref=8f708b561cbd288845d1500463e9f4e84197f2a9",
            "patch": "@@ -9,6 +9,7 @@\n import {NgModuleRef} from '@angular/core';\n import {TestBed} from '@angular/core/testing';\n import {Observable, of} from 'rxjs';\n+import {delay} from 'rxjs/operators';\n \n import {applyRedirects} from '../src/apply_redirects';\n import {LoadedRouterConfig, Route, Routes} from '../src/config';\n@@ -435,6 +436,25 @@ describe('applyRedirects', () => {\n           });\n     });\n \n+    it('should not load the configuration of a wildcard route if there is a match', () => {\n+      const loadedConfig = new LoadedRouterConfig([{path: '', component: ComponentB}], testModule);\n+\n+      const loader = jasmine.createSpyObj('loader', ['load']);\n+      loader.load.and.returnValue(of(loadedConfig).pipe(delay(0)));\n+\n+      const config: Routes = [\n+        {path: '', loadChildren: 'matchChildren'},\n+        {path: '**', loadChildren: 'children'},\n+      ];\n+\n+      applyRedirects(testModule.injector, <any>loader, serializer, tree(''), config).forEach(r => {\n+        expect(loader.load.calls.count()).toEqual(1);\n+        expect(loader.load.calls.first().args).not.toContain(jasmine.objectContaining({\n+          loadChildren: 'children'\n+        }));\n+      });\n+    });\n+\n     it('should load the configuration after a local redirect from a wildcard route', () => {\n       const loadedConfig = new LoadedRouterConfig([{path: '', component: ComponentB}], testModule);\n "
        }
    ],
    "stats": {
        "total": 33,
        "additions": 27,
        "deletions": 6
    }
}