{
    "author": "JoostK",
    "message": "refactor(compiler-cli): extract compilation utilities for partial compilation of components (#39707)\n\nThis commit is a precursor to supporting the partial compilation of\ncomponents, which leverages some of the compilation infrastructure that\nis in place for directives.\n\nPR Close #39707",
    "sha": "6c7eb351d4659c0b9100bc9e8e4f05033ee1a370",
    "files": [
        {
            "sha": "06879c7608bfd8c14ced0d8234ab7fa9eb569fa9",
            "filename": "packages/compiler/src/render3/partial/directive.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 27,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/6c7eb351d4659c0b9100bc9e8e4f05033ee1a370/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/6c7eb351d4659c0b9100bc9e8e4f05033ee1a370/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Fdirective.ts?ref=6c7eb351d4659c0b9100bc9e8e4f05033ee1a370",
            "patch": "@@ -8,8 +8,9 @@\n import * as o from '../../output/output_ast';\n import {Identifiers as R3} from '../r3_identifiers';\n import {R3DirectiveDef, R3DirectiveMetadata, R3HostMetadata, R3QueryMetadata} from '../view/api';\n-import {createDirectiveTypeParams} from '../view/compiler';\n+import {createDirectiveType} from '../view/compiler';\n import {asLiteral, conditionallyCreateMapObjectLiteral, DefinitionMap} from '../view/util';\n+import {toOptionalLiteralMap} from './util';\n \n \n /**\n@@ -19,9 +20,7 @@ export function compileDeclareDirectiveFromMetadata(meta: R3DirectiveMetadata):\n   const definitionMap = createDirectiveDefinitionMap(meta);\n \n   const expression = o.importExpr(R3.declareDirective).callFn([definitionMap.toLiteralMap()]);\n-\n-  const typeParams = createDirectiveTypeParams(meta);\n-  const type = o.expressionType(o.importExpr(R3.DirectiveDefWithMeta, typeParams));\n+  const type = createDirectiveType(meta);\n \n   return {expression, type};\n }\n@@ -118,26 +117,3 @@ function compileHostMetadata(meta: R3HostMetadata): o.LiteralMapExpr|null {\n     return null;\n   }\n }\n-\n-/**\n- * Creates an object literal expression from the given object, mapping all values to an expression\n- * using the provided mapping function. If the object has no keys, then null is returned.\n- *\n- * @param object The object to transfer into an object literal expression.\n- * @param mapper The logic to use for creating an expression for the object's values.\n- * @returns An object literal expression representing `object`, or null if `object` does not have\n- * any keys.\n- */\n-function toOptionalLiteralMap<T>(\n-    object: {[key: string]: T}, mapper: (value: T) => o.Expression): o.LiteralMapExpr|null {\n-  const entries = Object.keys(object).map(key => {\n-    const value = object[key];\n-    return {key, value: mapper(value), quoted: true};\n-  });\n-\n-  if (entries.length > 0) {\n-    return o.literalMap(entries);\n-  } else {\n-    return null;\n-  }\n-}"
        },
        {
            "sha": "c99168a979fa4dcd7cd8ab830ab0b9af32b4ef7e",
            "filename": "packages/compiler/src/render3/partial/util.ts",
            "status": "added",
            "additions": 48,
            "deletions": 0,
            "changes": 48,
            "blob_url": "https://github.com/angular/angular/blob/6c7eb351d4659c0b9100bc9e8e4f05033ee1a370/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/6c7eb351d4659c0b9100bc9e8e4f05033ee1a370/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fpartial%2Futil.ts?ref=6c7eb351d4659c0b9100bc9e8e4f05033ee1a370",
            "patch": "@@ -0,0 +1,48 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import * as o from '../../output/output_ast';\n+\n+/**\n+ * Creates an array literal expression from the given array, mapping all values to an expression\n+ * using the provided mapping function. If the array is empty or null, then null is returned.\n+ *\n+ * @param values The array to transfer into literal array expression.\n+ * @param mapper The logic to use for creating an expression for the array's values.\n+ * @returns An array literal expression representing `values`, or null if `values` is empty or\n+ * is itself null.\n+ */\n+export function toOptionalLiteralArray<T>(\n+    values: T[]|null, mapper: (value: T) => o.Expression): o.LiteralArrayExpr|null {\n+  if (values === null || values.length === 0) {\n+    return null;\n+  }\n+  return o.literalArr(values.map(value => mapper(value)));\n+}\n+\n+/**\n+ * Creates an object literal expression from the given object, mapping all values to an expression\n+ * using the provided mapping function. If the object has no keys, then null is returned.\n+ *\n+ * @param object The object to transfer into an object literal expression.\n+ * @param mapper The logic to use for creating an expression for the object's values.\n+ * @returns An object literal expression representing `object`, or null if `object` does not have\n+ * any keys.\n+ */\n+export function toOptionalLiteralMap<T>(\n+    object: {[key: string]: T}, mapper: (value: T) => o.Expression): o.LiteralMapExpr|null {\n+  const entries = Object.keys(object).map(key => {\n+    const value = object[key];\n+    return {key, value: mapper(value), quoted: true};\n+  });\n+\n+  if (entries.length > 0) {\n+    return o.literalMap(entries);\n+  } else {\n+    return null;\n+  }\n+}"
        },
        {
            "sha": "c0a4ced77609ed3887163229613ef46d8d0eb6f5",
            "filename": "packages/compiler/src/render3/view/compiler.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/6c7eb351d4659c0b9100bc9e8e4f05033ee1a370/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/6c7eb351d4659c0b9100bc9e8e4f05033ee1a370/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fcompiler.ts?ref=6c7eb351d4659c0b9100bc9e8e4f05033ee1a370",
            "patch": "@@ -22,7 +22,7 @@ import {CONTENT_ATTR, HOST_ATTR} from '../../style_compiler';\n import {BindingParser} from '../../template_parser/binding_parser';\n import {error, OutputContext} from '../../util';\n import {BoundEvent} from '../r3_ast';\n-import {compileFactoryFunction, R3DependencyMetadata, R3FactoryTarget, R3ResolvedDependencyType} from '../r3_factory';\n+import {compileFactoryFunction, R3FactoryTarget} from '../r3_factory';\n import {Identifiers as R3} from '../r3_identifiers';\n import {Render3ParseResult} from '../r3_template_transform';\n import {prepareSyntheticListenerFunctionName, prepareSyntheticPropertyName, typeWithParameters} from '../util';\n@@ -123,9 +123,7 @@ export function compileDirectiveFromMetadata(\n   const definitionMap = baseDirectiveFields(meta, constantPool, bindingParser);\n   addFeatures(definitionMap, meta);\n   const expression = o.importExpr(R3.defineDirective).callFn([definitionMap.toLiteralMap()]);\n-\n-  const typeParams = createDirectiveTypeParams(meta);\n-  const type = o.expressionType(o.importExpr(R3.DirectiveDefWithMeta, typeParams));\n+  const type = createDirectiveType(meta);\n \n   return {expression, type};\n }\n@@ -264,13 +262,19 @@ export function compileComponentFromMetadata(\n   }\n \n   const expression = o.importExpr(R3.defineComponent).callFn([definitionMap.toLiteralMap()]);\n+  const type = createComponentType(meta);\n \n+  return {expression, type};\n+}\n \n+/**\n+ * Creates the type specification from the component meta. This type is inserted into .d.ts files\n+ * to be consumed by upstream compilations.\n+ */\n+export function createComponentType(meta: R3ComponentMetadata): o.Type {\n   const typeParams = createDirectiveTypeParams(meta);\n   typeParams.push(stringArrayAsType(meta.template.ngContentSelectors));\n-  const type = o.expressionType(o.importExpr(R3.ComponentDefWithMeta, typeParams));\n-\n-  return {expression, type};\n+  return o.expressionType(o.importExpr(R3.ComponentDefWithMeta, typeParams));\n }\n \n /**\n@@ -507,6 +511,15 @@ export function createDirectiveTypeParams(meta: R3DirectiveMetadata): o.Type[] {\n   ];\n }\n \n+/**\n+ * Creates the type specification from the directive meta. This type is inserted into .d.ts files\n+ * to be consumed by upstream compilations.\n+ */\n+export function createDirectiveType(meta: R3DirectiveMetadata): o.Type {\n+  const typeParams = createDirectiveTypeParams(meta);\n+  return o.expressionType(o.importExpr(R3.DirectiveDefWithMeta, typeParams));\n+}\n+\n // Define and update any view queries\n function createViewQueriesFunction(\n     viewQueries: R3QueryMetadata[], constantPool: ConstantPool, name?: string): o.Expression {"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 71,
        "deletions": 34
    }
}