{
    "author": "AndrewKushnir",
    "message": "fix(compiler): avoid duplicate i18n blocks for i18n attrs on elements with structural directives (#40077)\n\nCurrently when `ɵɵtemplate` and `ɵɵelement` instructions are generated by compiler, all static attributes are\nduplicated for both instructions. As a part of this duplication, i18n translation blocks for static i18n attributes\nare generated twice as well, causing duplicate entries in extracted translation files (when Ivy extraction mechanisms\nare used). This commit fixes this issue by introducing a cache for i18n translation blocks (for static attributes\nonly).\n\nAlso this commit further aligns `ɵɵtemplate` and `ɵɵelement` instruction attributes, which should help implement\nmore effective attributes deduplication logic.\n\nCloses #39942.\n\nPR Close #40077",
    "sha": "caa466633506df7118710e2e6ac2c7dbf9911988",
    "files": [
        {
            "sha": "d726080ed26e797e4210cbf36c99d830defa3683",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FGOLDEN_PARTIAL.js?ref=caa466633506df7118710e2e6ac2c7dbf9911988",
            "patch": "@@ -394,6 +394,53 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDef<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: static_attributes_structural.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyComponent {\n+    constructor() {\n+        this.exp = true;\n+    }\n+}\n+MyComponent.ɵfac = function MyComponent_Factory(t) { return new (t || MyComponent)(); };\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: { source: `\n+    <div *ngIf=\"exp\" id=\"static\" i18n-title=\"m|d\" title=\"introduction\"></div>\n+  `, isInline: true } });\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n+        type: Component,\n+        args: [{\n+                selector: 'my-component',\n+                template: `\n+    <div *ngIf=\"exp\" id=\"static\" i18n-title=\"m|d\" title=\"introduction\"></div>\n+  `\n+            }]\n+    }], null, null); })();\n+export class MyModule {\n+}\n+MyModule.ɵmod = i0.ɵɵdefineNgModule({ type: MyModule });\n+MyModule.ɵinj = i0.ɵɵdefineInjector({ factory: function MyModule_Factory(t) { return new (t || MyModule)(); } });\n+(function () { (typeof ngJitMode === \"undefined\" || ngJitMode) && i0.ɵɵsetNgModuleScope(MyModule, { declarations: [MyComponent] }); })();\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyModule, [{\n+        type: NgModule,\n+        args: [{ declarations: [MyComponent] }]\n+    }], null, null); })();\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: static_attributes_structural.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyComponent {\n+    exp: boolean;\n+    static ɵfac: i0.ɵɵFactoryDef<MyComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDefWithMeta<MyComponent, \"my-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵmod: i0.ɵɵNgModuleDefWithMeta<MyModule, [typeof MyComponent], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDef<MyModule>;\n+}\n+\n /****************************************************************************************************\n  * PARTIAL FILE: interpolation_basic.js\n  ****************************************************************************************************/"
        },
        {
            "sha": "6d84fd7bcc65dacb7ce866d52bdb743697eba540",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/TEST_CASES.json",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2FTEST_CASES.json?ref=caa466633506df7118710e2e6ac2c7dbf9911988",
            "patch": "@@ -113,6 +113,20 @@\n         }\n       ]\n     },\n+    {\n+      \"description\": \"should translate static attributes when used on an element with structural directive\",\n+      \"inputFiles\": [\n+        \"static_attributes_structural.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"extraChecks\": [\n+            \"verifyPlaceholdersIntegrity\",\n+            \"verifyUniqueConsts\"\n+          ]\n+        }\n+      ]\n+    },\n     {\n       \"description\": \"should support interpolation\",\n       \"inputFiles\": ["
        },
        {
            "sha": "d5553054b6125d00f10a20f9efeefd1d2bb2d441",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/static_attributes_structural.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fstatic_attributes_structural.js",
            "raw_url": "https://github.com/angular/angular/raw/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fstatic_attributes_structural.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fstatic_attributes_structural.js?ref=caa466633506df7118710e2e6ac2c7dbf9911988",
            "patch": "@@ -0,0 +1,21 @@\n+function MyComponent_div_0_Template(rf, ctx) {\n+  if (rf & 1) {\n+    $r3$.ɵɵelement(0, \"div\", 1);\n+  }\n+}\n+…\n+consts: function() {\n+  __i18nMsg__('introduction', [], {meaning: 'm', desc: 'd'})\n+  return [\n+    [\"id\", \"static\", \"title\", $i18n_0$, __AttributeMarker.Template__, \"ngIf\"],\n+    [\"id\", \"static\", \"title\", $i18n_0$]\n+  ];\n+},\n+template: function MyComponent_Template(rf, ctx) {\n+  if (rf & 1) {\n+    $r3$.ɵɵtemplate(0, MyComponent_div_0_Template, 1, 0, \"div\", 0);\n+  }\n+  if (rf & 2) {\n+    $r3$.ɵɵproperty(\"ngIf\", ctx.exp);\n+  }\n+}"
        },
        {
            "sha": "a0adbb98c74ecc41741cb55ad50b8625c8da9ee8",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/element_attributes/static_attributes_structural.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fstatic_attributes_structural.ts",
            "raw_url": "https://github.com/angular/angular/raw/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fstatic_attributes_structural.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Felement_attributes%2Fstatic_attributes_structural.ts?ref=caa466633506df7118710e2e6ac2c7dbf9911988",
            "patch": "@@ -0,0 +1,15 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  selector: 'my-component',\n+  template: `\n+    <div *ngIf=\"exp\" id=\"static\" i18n-title=\"m|d\" title=\"introduction\"></div>\n+  `\n+})\n+export class MyComponent {\n+  exp = true;\n+}\n+\n+@NgModule({declarations: [MyComponent]})\n+export class MyModule {\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "429b1b7938b47b6ab7824c6064b332157c227006",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 4,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=caa466633506df7118710e2e6ac2c7dbf9911988",
            "patch": "@@ -108,15 +108,31 @@ export function prepareEventListenerParameters(\n }\n \n // Collects information needed to generate `consts` field of the ComponentDef.\n-// When a constant requires some pre-processing, the `prepareStatements` section\n-// contains corresponding statements.\n export interface ComponentDefConsts {\n+  /**\n+   * When a constant requires some pre-processing (e.g. i18n translation block that includes\n+   * goog.getMsg and $localize calls), the `prepareStatements` section contains corresponding\n+   * statements.\n+   */\n   prepareStatements: o.Statement[];\n+\n+  /**\n+   * Actual expressions that represent constants.\n+   */\n   constExpressions: o.Expression[];\n+\n+  /**\n+   * Cache to avoid generating duplicated i18n translation blocks.\n+   */\n+  i18nVarRefsCache: Map<i18n.I18nMeta, o.ReadVarExpr>;\n }\n \n function createComponentDefConsts(): ComponentDefConsts {\n-  return {prepareStatements: [], constExpressions: []};\n+  return {\n+    prepareStatements: [],\n+    constExpressions: [],\n+    i18nVarRefsCache: new Map(),\n+  };\n }\n \n export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver {\n@@ -1300,7 +1316,20 @@ export class TemplateDefinitionBuilder implements t.Visitor<void>, LocalResolver\n       // Note that static i18n attributes aren't in the i18n array,\n       // because they're treated in the same way as regular attributes.\n       if (attr.i18n) {\n-        attrExprs.push(o.literal(attr.name), this.i18nTranslate(attr.i18n as i18n.Message));\n+        // When i18n attributes are present on elements with structural directives\n+        // (e.g. `<div *ngIf title=\"Hello\" i18n-title>`), we want to avoid generating\n+        // duplicate i18n translation blocks for `ɵɵtemplate` and `ɵɵelement` instruction\n+        // attributes. So we do a cache lookup to see if suitable i18n translation block\n+        // already exists.\n+        const {i18nVarRefsCache} = this._constants;\n+        let i18nVarRef: o.ReadVarExpr;\n+        if (i18nVarRefsCache.has(attr.i18n)) {\n+          i18nVarRef = i18nVarRefsCache.get(attr.i18n)!;\n+        } else {\n+          i18nVarRef = this.i18nTranslate(attr.i18n as i18n.Message);\n+          i18nVarRefsCache.set(attr.i18n, i18nVarRef);\n+        }\n+        attrExprs.push(o.literal(attr.name), i18nVarRef);\n       } else {\n         attrExprs.push(\n             ...getAttributeNameLiterals(attr.name), trustedConstAttribute(elementName, attr));"
        },
        {
            "sha": "cc7fb156ce2c014f1c541181713e6e6971e54c85",
            "filename": "packages/core/test/acceptance/i18n_spec.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/caa466633506df7118710e2e6ac2c7dbf9911988/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts?ref=caa466633506df7118710e2e6ac2c7dbf9911988",
            "patch": "@@ -1730,6 +1730,27 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n       expect(titleDirInstances[0].title).toBe('Bonjour');\n     });\n \n+    it('should support static i18n attributes on inline templates', () => {\n+      loadTranslations({[computeMsgId('Hello')]: 'Bonjour'});\n+      @Component({\n+        selector: 'my-cmp',\n+        template: `\n+          <div *ngIf=\"true\" i18n-title title=\"Hello\"></div>\n+        `,\n+      })\n+      class Cmp {\n+      }\n+\n+      TestBed.configureTestingModule({\n+        imports: [CommonModule],\n+        declarations: [Cmp],\n+      });\n+      const fixture = TestBed.createComponent(Cmp);\n+      fixture.detectChanges();\n+\n+      expect(fixture.nativeElement.firstChild.title).toBe('Bonjour');\n+    });\n+\n     it('should allow directive inputs (as an interpolated prop) on <ng-template>', () => {\n       loadTranslations({[computeMsgId('Hello {$INTERPOLATION}')]: 'Bonjour {$INTERPOLATION}'});\n "
        }
    ],
    "stats": {
        "total": 155,
        "additions": 151,
        "deletions": 4
    }
}