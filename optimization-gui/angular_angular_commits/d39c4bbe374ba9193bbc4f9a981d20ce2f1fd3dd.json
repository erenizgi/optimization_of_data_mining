{
    "author": "ayazhafiz",
    "message": "refactor(language-service): language_service_adapter -> adapters (#39619)\n\nThis rename is done because we know have a file system adapter over a\nproject as well as the compiler adapter.\n\nPR Close #39619",
    "sha": "d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd",
    "files": [
        {
            "sha": "cde0281fc22d811b5670e35594d98a1ee7f3a383",
            "filename": "packages/compiler-cli/src/perform_compile.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "raw_url": "https://github.com/angular/angular/raw/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fperform_compile.ts?ref=d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd",
            "patch": "@@ -108,9 +108,10 @@ export function formatDiagnostics(\n   }\n }\n \n+/** Used to read configuration files. */\n // TODO(ayazhafiz): split FileSystem into a ReadonlyFileSystem and make this a\n // subset of that.\n-export type ParseConfigurationHost =\n+export type ConfigurationHost =\n     Pick<FileSystem, 'readFile'|'exists'|'lstat'|'resolve'|'join'|'dirname'|'extname'|'pwd'>;\n \n export interface ParsedConfiguration {\n@@ -119,11 +120,11 @@ export interface ParsedConfiguration {\n   rootNames: string[];\n   projectReferences?: readonly ts.ProjectReference[]|undefined;\n   emitFlags: api.EmitFlags;\n-  errors: Diagnostics;\n+  errors: ts.Diagnostic[];\n }\n \n export function calcProjectFileAndBasePath(\n-    project: string, host: ParseConfigurationHost = getFileSystem()):\n+    project: string, host: ConfigurationHost = getFileSystem()):\n     {projectFile: AbsoluteFsPath, basePath: AbsoluteFsPath} {\n   const absProject = host.resolve(project);\n   const projectIsDir = host.lstat(absProject).isDirectory();\n@@ -145,7 +146,7 @@ export function createNgCompilerOptions(\n \n export function readConfiguration(\n     project: string, existingOptions?: ts.CompilerOptions,\n-    host: ParseConfigurationHost = getFileSystem()): ParsedConfiguration {\n+    host: ConfigurationHost = getFileSystem()): ParsedConfiguration {\n   try {\n     const {projectFile, basePath} = calcProjectFileAndBasePath(project, host);\n \n@@ -223,11 +224,14 @@ export function readConfiguration(\n       emitFlags\n     };\n   } catch (e) {\n-    const errors: Diagnostics = [{\n+    const errors: ts.Diagnostic[] = [{\n       category: ts.DiagnosticCategory.Error,\n       messageText: e.stack,\n-      source: api.SOURCE,\n-      code: api.UNKNOWN_ERROR_CODE\n+      file: undefined,\n+      start: undefined,\n+      length: undefined,\n+      source: 'angular',\n+      code: api.UNKNOWN_ERROR_CODE,\n     }];\n     return {project: '', errors, rootNames: [], options: {}, emitFlags: api.EmitFlags.Default};\n   }"
        },
        {
            "sha": "c95d3266888e4e724ae8540f8c559b43734afc92",
            "filename": "packages/language-service/ivy/adapters.ts",
            "status": "renamed",
            "additions": 11,
            "deletions": 10,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "raw_url": "https://github.com/angular/angular/raw/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Fadapters.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fadapters.ts?ref=d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd",
            "patch": "@@ -6,7 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {ParseConfigurationHost} from '@angular/compiler-cli';\n+/** @fileoverview provides adapters for communicating with the ng compiler */\n+\n+import {ConfigurationHost} from '@angular/compiler-cli';\n import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n import {absoluteFrom, AbsoluteFsPath, FileStats, PathSegment, PathString} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n@@ -88,14 +90,13 @@ export class LanguageServiceAdapter implements NgCompilerAdapter {\n  * because signatures of calls like `FileSystem#readFile` are a bit stricter\n  * than those on the adapter.\n  */\n-export class LSParseConfigHost implements ParseConfigurationHost {\n-  private readonly host: ts.server.ServerHost = this.project.projectService.host;\n-  constructor(private readonly project: ts.server.Project) {}\n+export class LSParseConfigHost implements ConfigurationHost {\n+  constructor(private readonly serverHost: ts.server.ServerHost) {}\n   exists(path: AbsoluteFsPath): boolean {\n-    return this.project.fileExists(path) || this.project.directoryExists(path);\n+    return this.serverHost.fileExists(path) || this.serverHost.directoryExists(path);\n   }\n   readFile(path: AbsoluteFsPath): string {\n-    const content = this.project.readFile(path);\n+    const content = this.serverHost.readFile(path);\n     if (content === undefined) {\n       throw new Error(`LanguageServiceFS#readFile called on unavailable file ${path}`);\n     }\n@@ -104,24 +105,24 @@ export class LSParseConfigHost implements ParseConfigurationHost {\n   lstat(path: AbsoluteFsPath): FileStats {\n     return {\n       isFile: () => {\n-        return this.project.fileExists(path);\n+        return this.serverHost.fileExists(path);\n       },\n       isDirectory: () => {\n-        return this.project.directoryExists(path);\n+        return this.serverHost.directoryExists(path);\n       },\n       isSymbolicLink: () => {\n         throw new Error(`LanguageServiceFS#lstat#isSymbolicLink not implemented`);\n       },\n     };\n   }\n   pwd(): AbsoluteFsPath {\n-    return this.project.getCurrentDirectory() as AbsoluteFsPath;\n+    return this.serverHost.getCurrentDirectory() as AbsoluteFsPath;\n   }\n   extname(path: AbsoluteFsPath|PathSegment): string {\n     return p.extname(path);\n   }\n   resolve(...paths: string[]): AbsoluteFsPath {\n-    return this.host.resolvePath(this.join(paths[0], ...paths.slice(1))) as AbsoluteFsPath;\n+    return this.serverHost.resolvePath(this.join(paths[0], ...paths.slice(1))) as AbsoluteFsPath;\n   }\n   dirname<T extends PathString>(file: T): T {\n     return p.dirname(file) as T;",
            "previous_filename": "packages/language-service/ivy/language_service_adapter.ts"
        },
        {
            "sha": "af2498d16e803cb2fef42a99d0b210a7ef20b6fb",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd",
            "patch": "@@ -12,7 +12,7 @@ import {TrackedIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/i\n import {TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {LanguageServiceAdapter} from './language_service_adapter';\n+import {LanguageServiceAdapter} from './adapters';\n import {isExternalTemplate} from './utils';\n \n /**"
        },
        {
            "sha": "b5d4f1d08a09a509141f8f861c4db5879173d973",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd",
            "patch": "@@ -6,15 +6,15 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {CompilerOptions, formatDiagnostics, ParseConfigurationHost, readConfiguration} from '@angular/compiler-cli';\n+import {CompilerOptions, ConfigurationHost, readConfiguration} from '@angular/compiler-cli';\n import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n+import {LanguageServiceAdapter, LSParseConfigHost} from './adapters';\n import {CompilerFactory} from './compiler_factory';\n import {DefinitionBuilder} from './definitions';\n-import {LanguageServiceAdapter, LSParseConfigHost} from './language_service_adapter';\n import {QuickInfoBuilder} from './quick_info';\n import {getTargetAtPosition} from './template_target';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n@@ -27,7 +27,7 @@ export class LanguageService {\n   private readonly parseConfigHost: LSParseConfigHost;\n \n   constructor(project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n-    this.parseConfigHost = new LSParseConfigHost(project);\n+    this.parseConfigHost = new LSParseConfigHost(project.projectService.host);\n     this.options = parseNgCompilerOptions(project, this.parseConfigHost);\n     this.strategy = createTypeCheckingProgramStrategy(project);\n     this.adapter = new LanguageServiceAdapter(project);\n@@ -116,15 +116,15 @@ export class LanguageService {\n   }\n }\n \n-export function parseNgCompilerOptions(\n-    project: ts.server.Project, host: ParseConfigurationHost): CompilerOptions {\n+function parseNgCompilerOptions(\n+    project: ts.server.Project, host: ConfigurationHost): CompilerOptions {\n   if (!(project instanceof ts.server.ConfiguredProject)) {\n     return {};\n   }\n   const {options, errors} =\n       readConfiguration(project.getConfigFilePath(), /* existingOptions */ undefined, host);\n   if (errors.length > 0) {\n-    project.error(formatDiagnostics(errors));\n+    project.setProjectErrors(errors);\n   }\n \n   return options;"
        },
        {
            "sha": "32d9f4e8be729ae5c695258ac7938725a2bb0d9b",
            "filename": "packages/language-service/ivy/test/legacy/language_service_adapter_spec.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_adapter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/64c3135be7c5d1007945074478c894b71b229cea/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_adapter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Flanguage_service_adapter_spec.ts?ref=64c3135be7c5d1007945074478c894b71b229cea",
            "patch": "@@ -1,41 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-import * as ts from 'typescript/lib/tsserverlibrary';\n-\n-import {LanguageServiceAdapter} from '../../language_service_adapter';\n-\n-import {MockService, setup, TEST_TEMPLATE} from './mock_host';\n-\n-describe('Language service adapter', () => {\n-  let project: ts.server.Project;\n-  let service: MockService;\n-\n-  beforeAll(() => {\n-    const {project: _project, service: _service} = setup();\n-    project = _project;\n-    service = _service;\n-  });\n-\n-  it('should mark template dirty if it has not seen the template before', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeTrue();\n-  });\n-\n-  it('should not mark template dirty if template has not changed', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    adapter.readResource(TEST_TEMPLATE);\n-    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeFalse();\n-  });\n-\n-  it('should mark template dirty if template has changed', () => {\n-    const adapter = new LanguageServiceAdapter(project);\n-    service.overwrite(TEST_TEMPLATE, '<p>Hello World</p>');\n-    expect(adapter.isTemplateDirty(TEST_TEMPLATE)).toBeTrue();\n-  });\n-});"
        },
        {
            "sha": "d76d4d6ea018ee13ce2af05e8c2904a6e56eeaf5",
            "filename": "packages/language-service/ivy/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd/packages%2Flanguage-service%2Fivy%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Futils.ts?ref=d39c4bbe374ba9193bbc4f9a981d20ce2f1fd3dd",
            "patch": "@@ -10,6 +10,7 @@ import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n import {isExternalResource} from '@angular/compiler-cli/src/ngtsc/metadata';\n import {DeclarationNode} from '@angular/compiler-cli/src/ngtsc/reflection';\n import {DirectiveSymbol} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import {Diagnostic as ngDiagnostic, isNgDiagnostic} from '@angular/compiler-cli/src/transformers/api';\n import * as e from '@angular/compiler/src/expression_parser/ast';  // e for expression AST\n import * as t from '@angular/compiler/src/render3/r3_ast';         // t for template AST\n import * as ts from 'typescript';"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 30,
        "deletions": 65
    }
}