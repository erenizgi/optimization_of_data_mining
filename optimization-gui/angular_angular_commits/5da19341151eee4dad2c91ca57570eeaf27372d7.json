{
    "author": "petebacondarwin",
    "message": "fix(localize): render context of translation file parse errors (#38673)\n\nPreviously the position of the error in a translation file when parsing\nit was not displayed. Just the error message.\n\nNow the position (line and column) and some context is displayed\nalong with the error messages.\n\nFixes #38377\n\nPR Close #38673",
    "sha": "5da19341151eee4dad2c91ca57570eeaf27372d7",
    "files": [
        {
            "sha": "af0fd9c3a75e987dc7698133a1eadbabcc77c137",
            "filename": "packages/localize/src/tools/src/translate/translation_files/message_serialization/message_serializer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Fmessage_serialization%2Fmessage_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Fmessage_serialization%2Fmessage_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Fmessage_serialization%2Fmessage_serializer.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -13,7 +13,7 @@ import {getAttribute, getAttrOrThrow} from '../translation_parsers/translation_u\n \n import {MessageRenderer} from './message_renderer';\n \n-interface MessageSerializerConfig {\n+export interface MessageSerializerConfig {\n   inlineElements: string[];\n   placeholder?: {elementName: string; nameAttribute: string; bodyAttribute?: string;};\n   placeholderContainer?: {elementName: string; startAttribute: string; endAttribute: string;};"
        },
        {
            "sha": "df247b1801fd2702d7403189895ac97b5e138ca2",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/serialize_translation_message.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fserialize_translation_message.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fserialize_translation_message.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fserialize_translation_message.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -0,0 +1,32 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import {Element, ParseError} from '@angular/compiler';\n+import {ɵParsedTranslation} from '@angular/localize';\n+\n+import {MessageSerializer, MessageSerializerConfig} from '../message_serialization/message_serializer';\n+import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n+\n+import {parseInnerRange} from './translation_utils';\n+\n+/**\n+ * Serialize the given `element` into a parsed translation using the given `serializer`.\n+ */\n+export function serializeTranslationMessage(element: Element, config: MessageSerializerConfig): {\n+  translation: ɵParsedTranslation|null,\n+  parseErrors: ParseError[],\n+  serializeErrors: ParseError[]\n+} {\n+  const {rootNodes, errors: parseErrors} = parseInnerRange(element);\n+  try {\n+    const serializer = new MessageSerializer(new TargetMessageRenderer(), config);\n+    const translation = serializer.serialize(rootNodes);\n+    return {translation, parseErrors, serializeErrors: []};\n+  } catch (e) {\n+    return {translation: null, parseErrors, serializeErrors: [e]};\n+  }\n+}"
        },
        {
            "sha": "7fc6adfc67d2295cca7113dfbf2ac7f3b2f73650",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/translation_parse_error.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 10,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_parse_error.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_parse_error.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_parse_error.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -14,17 +14,15 @@ export class TranslationParseError extends Error {\n   constructor(\n       public span: ParseSourceSpan, public msg: string,\n       public level: ParseErrorLevel = ParseErrorLevel.ERROR) {\n-    super(msg);\n-  }\n-\n-  contextualMessage(): string {\n-    const ctx = this.span.start.getContext(100, 3);\n-    return ctx ? `${this.msg} (\"${ctx.before}[${ParseErrorLevel[this.level]} ->]${ctx.after}\")` :\n-                 this.msg;\n+    super(contextualMessage(span, msg, level));\n   }\n+}\n \n-  toString(): string {\n-    const details = this.span.details ? `, ${this.span.details}` : '';\n-    return `${this.contextualMessage()}: ${this.span.start}${details}`;\n+function contextualMessage(span: ParseSourceSpan, msg: string, level: ParseErrorLevel): string {\n+  const ctx = span.start.getContext(100, 2);\n+  msg += `\\nAt ${span.start}${span.details ? `, ${span.details}` : ''}:\\n`;\n+  if (ctx) {\n+    msg += `...${ctx.before}[${ParseErrorLevel[level]} ->]${ctx.after}...\\n`;\n   }\n+  return msg;\n }"
        },
        {
            "sha": "f44cd87e93919559fdea353e33ba8113856ed403",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/translation_utils.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 8,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Ftranslation_utils.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -5,10 +5,12 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {Element, LexerRange, Node, ParseError, ParseErrorLevel, ParseSourceSpan, XmlParser} from '@angular/compiler';\n+import {Element, LexerRange, Node, ParseError, ParseErrorLevel, ParseSourceSpan, ParseTreeResult, XmlParser} from '@angular/compiler';\n+\n import {Diagnostics} from '../../../diagnostics';\n+\n import {TranslationParseError} from './translation_parse_error';\n-import {ParseAnalysis} from './translation_parser';\n+import {ParseAnalysis, ParsedTranslationBundle} from './translation_parser';\n \n export function getAttrOrThrow(element: Element, attrName: string): string {\n   const attrValue = getAttribute(element, attrName);\n@@ -30,17 +32,15 @@ export function getAttribute(element: Element, attrName: string): string|undefin\n  * This would be equivalent to parsing the `innerHTML` string of an HTML document.\n  *\n  * @param element The element whose inner range we want to parse.\n- * @returns a collection of XML `Node` objects that were parsed from the element's contents.\n+ * @returns a collection of XML `Node` objects and any errors that were parsed from the element's\n+ *     contents.\n  */\n-export function parseInnerRange(element: Element): Node[] {\n+export function parseInnerRange(element: Element): ParseTreeResult {\n   const xmlParser = new XmlParser();\n   const xml = xmlParser.parse(\n       element.sourceSpan.start.file.content, element.sourceSpan.start.file.url,\n       {tokenizeExpansionForms: true, range: getInnerRange(element)});\n-  if (xml.errors.length) {\n-    throw xml.errors.map(e => new TranslationParseError(e.span, e.msg).toString()).join('\\n');\n-  }\n-  return xml.rootNodes;\n+  return xml;\n }\n \n /**\n@@ -155,3 +155,12 @@ export function addParseError(diagnostics: Diagnostics, parseError: ParseError):\n     diagnostics.warn(parseError.toString());\n   }\n }\n+\n+/**\n+ * Add the provided `errors` to the `bundle` diagnostics.\n+ */\n+export function addErrorsToBundle(bundle: ParsedTranslationBundle, errors: ParseError[]): void {\n+  for (const error of errors) {\n+    addParseError(bundle.diagnostics, error);\n+  }\n+}"
        },
        {
            "sha": "7ac869632f3706b77a3aae90543bca07821d5377",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/xliff1_translation_parser.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 21,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -6,15 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {Element, ParseErrorLevel, visitAll} from '@angular/compiler';\n-import {ɵParsedTranslation} from '@angular/localize';\n \n import {Diagnostics} from '../../../diagnostics';\n import {BaseVisitor} from '../base_visitor';\n-import {MessageSerializer} from '../message_serialization/message_serializer';\n-import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n \n+import {serializeTranslationMessage} from './serialize_translation_message';\n import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n-import {addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedElement, parseInnerRange, XmlTranslationParserHint} from './translation_utils';\n+import {addErrorsToBundle, addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedElement, XmlTranslationParserHint} from './translation_utils';\n \n /**\n  * A translation parser that can load XLIFF 1.2 files.\n@@ -150,23 +148,14 @@ class XliffTranslationVisitor extends BaseVisitor {\n       return;\n     }\n \n-    try {\n-      bundle.translations[id] = serializeTargetMessage(targetMessage);\n-    } catch (e) {\n-      // Capture any errors from serialize the target message\n-      if (e.span && e.msg && e.level) {\n-        addParseDiagnostic(bundle.diagnostics, e.span, e.msg, e.level);\n-      } else {\n-        throw e;\n-      }\n+    const {translation, parseErrors, serializeErrors} = serializeTranslationMessage(targetMessage, {\n+      inlineElements: ['g', 'bx', 'ex', 'bpt', 'ept', 'ph', 'it', 'mrk'],\n+      placeholder: {elementName: 'x', nameAttribute: 'id'}\n+    });\n+    if (translation !== null) {\n+      bundle.translations[id] = translation;\n     }\n+    addErrorsToBundle(bundle, parseErrors);\n+    addErrorsToBundle(bundle, serializeErrors);\n   }\n }\n-\n-function serializeTargetMessage(source: Element): ɵParsedTranslation {\n-  const serializer = new MessageSerializer(new TargetMessageRenderer(), {\n-    inlineElements: ['g', 'bx', 'ex', 'bpt', 'ept', 'ph', 'it', 'mrk'],\n-    placeholder: {elementName: 'x', nameAttribute: 'id'}\n-  });\n-  return serializer.serialize(parseInnerRange(source));\n-}"
        },
        {
            "sha": "622ab2d26d1bc94b866dd8899ba335c8e7c55fb7",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/xliff2_translation_parser.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 23,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -6,15 +6,13 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {Element, Node, ParseErrorLevel, visitAll} from '@angular/compiler';\n-import {ɵParsedTranslation} from '@angular/localize';\n \n import {Diagnostics} from '../../../diagnostics';\n import {BaseVisitor} from '../base_visitor';\n-import {MessageSerializer} from '../message_serialization/message_serializer';\n-import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n \n+import {serializeTranslationMessage} from './serialize_translation_message';\n import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n-import {addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedElement, parseInnerRange, XmlTranslationParserHint} from './translation_utils';\n+import {addErrorsToBundle, addParseDiagnostic, addParseError, canParseXml, getAttribute, isNamedElement, XmlTranslationParserHint} from './translation_utils';\n \n /**\n  * A translation parser that can load translations from XLIFF 2 files.\n@@ -141,29 +139,20 @@ class Xliff2TranslationVisitor extends BaseVisitor {\n       return;\n     }\n \n-    try {\n-      bundle.translations[unit] = serializeTargetMessage(targetMessage);\n-    } catch (e) {\n-      // Capture any errors from serialize the target message\n-      if (e.span && e.msg && e.level) {\n-        addParseDiagnostic(bundle.diagnostics, e.span, e.msg, e.level);\n-      } else {\n-        throw e;\n-      }\n+    const {translation, parseErrors, serializeErrors} = serializeTranslationMessage(targetMessage, {\n+      inlineElements: ['cp', 'sc', 'ec', 'mrk', 'sm', 'em'],\n+      placeholder: {elementName: 'ph', nameAttribute: 'equiv', bodyAttribute: 'disp'},\n+      placeholderContainer:\n+          {elementName: 'pc', startAttribute: 'equivStart', endAttribute: 'equivEnd'}\n+    });\n+    if (translation !== null) {\n+      bundle.translations[unit] = translation;\n     }\n+    addErrorsToBundle(bundle, parseErrors);\n+    addErrorsToBundle(bundle, serializeErrors);\n   }\n }\n \n-function serializeTargetMessage(source: Element): ɵParsedTranslation {\n-  const serializer = new MessageSerializer(new TargetMessageRenderer(), {\n-    inlineElements: ['cp', 'sc', 'ec', 'mrk', 'sm', 'em'],\n-    placeholder: {elementName: 'ph', nameAttribute: 'equiv', bodyAttribute: 'disp'},\n-    placeholderContainer:\n-        {elementName: 'pc', startAttribute: 'equivStart', endAttribute: 'equivEnd'}\n-  });\n-  return serializer.serialize(parseInnerRange(source));\n-}\n-\n function isFileElement(node: Node): node is Element {\n   return node instanceof Element && node.name === 'file';\n }"
        },
        {
            "sha": "d1b8bca8396588cee414826c47e4c5bd9f24b4de",
            "filename": "packages/localize/src/tools/src/translate/translation_files/translation_parsers/xtb_translation_parser.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 23,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -5,17 +5,15 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {Element, ParseErrorLevel, visitAll} from '@angular/compiler';\n-import {ɵParsedTranslation} from '@angular/localize';\n+import {Element, ParseError, ParseErrorLevel, visitAll} from '@angular/compiler';\n import {extname} from 'path';\n \n import {Diagnostics} from '../../../diagnostics';\n import {BaseVisitor} from '../base_visitor';\n-import {MessageSerializer} from '../message_serialization/message_serializer';\n-import {TargetMessageRenderer} from '../message_serialization/target_message_renderer';\n \n+import {serializeTranslationMessage} from './serialize_translation_message';\n import {ParseAnalysis, ParsedTranslationBundle, TranslationParser} from './translation_parser';\n-import {addParseDiagnostic, addParseError, canParseXml, getAttribute, parseInnerRange, XmlTranslationParserHint} from './translation_utils';\n+import {addErrorsToBundle, addParseDiagnostic, addParseError, canParseXml, getAttribute, XmlTranslationParserHint} from './translation_utils';\n \n \n /**\n@@ -103,20 +101,17 @@ class XtbVisitor extends BaseVisitor {\n           return;\n         }\n \n-        try {\n-          bundle.translations[id] = serializeTargetMessage(element);\n-        } catch (error) {\n-          if (typeof error === 'string') {\n-            bundle.diagnostics.warn(\n-                `Could not parse message with id \"${\n-                    id}\" - perhaps it has an unrecognised ICU format?\\n` +\n-                error);\n-          } else if (error.span && error.msg && error.level) {\n-            addParseDiagnostic(bundle.diagnostics, error.span, error.msg, error.level);\n-          } else {\n-            throw error;\n-          }\n+        const {translation, parseErrors, serializeErrors} = serializeTranslationMessage(\n+            element, {inlineElements: [], placeholder: {elementName: 'ph', nameAttribute: 'name'}});\n+        if (parseErrors.length) {\n+          // We only want to warn (not error) if there were problems parsing the translation for\n+          // XTB formatted files. See https://github.com/angular/angular/issues/14046.\n+          bundle.diagnostics.warn(computeParseWarning(id, parseErrors));\n+        } else if (translation !== null) {\n+          // Only store the translation if there were no parse errors\n+          bundle.translations[id] = translation;\n         }\n+        addErrorsToBundle(bundle, serializeErrors);\n         break;\n \n       default:\n@@ -127,9 +122,8 @@ class XtbVisitor extends BaseVisitor {\n   }\n }\n \n-function serializeTargetMessage(source: Element): ɵParsedTranslation {\n-  const serializer = new MessageSerializer(\n-      new TargetMessageRenderer(),\n-      {inlineElements: [], placeholder: {elementName: 'ph', nameAttribute: 'name'}});\n-  return serializer.serialize(parseInnerRange(source));\n+function computeParseWarning(id: string, errors: ParseError[]): string {\n+  const msg = errors.map(e => e.toString()).join('\\n');\n+  return `Could not parse message with id \"${id}\" - perhaps it has an unrecognised ICU format?\\n` +\n+      msg;\n }"
        },
        {
            "sha": "9f475e54e8f694fc382c63a499c1c0e707bf5dbe",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xliff1_translation_parser_spec.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 13,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff1_translation_parser_spec.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -621,7 +621,7 @@ describe('Xliff1TranslationParser', () => {\n       });\n \n       describe('[structure errors]', () => {\n-        it('should throw when a trans-unit has no translation', () => {\n+        it('should fail when a trans-unit has no translation', () => {\n           const XLIFF = [\n             `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n             `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n@@ -646,7 +646,7 @@ describe('Xliff1TranslationParser', () => {\n         });\n \n \n-        it('should throw when a trans-unit has no id attribute', () => {\n+        it('should fail when a trans-unit has no id attribute', () => {\n           const XLIFF = [\n             `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n             `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n@@ -671,7 +671,7 @@ describe('Xliff1TranslationParser', () => {\n           ].join('\\n'));\n         });\n \n-        it('should throw on duplicate trans-unit id', () => {\n+        it('should fail on duplicate trans-unit id', () => {\n           const XLIFF = [\n             `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n             `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n@@ -703,7 +703,7 @@ describe('Xliff1TranslationParser', () => {\n       });\n \n       describe('[message errors]', () => {\n-        it('should throw on unknown message tags', () => {\n+        it('should fail on unknown message tags', () => {\n           const XLIFF = [\n             `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n             `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n@@ -719,17 +719,18 @@ describe('Xliff1TranslationParser', () => {\n           ].join('\\n');\n \n           expectToFail('/some/file.xlf', XLIFF, /Invalid element found in message/, [\n-            `Invalid element found in message. (\"`,\n-            `      <trans-unit id=\"deadbeef\" datatype=\"html\">`,\n+            `Error: Invalid element found in message.`,\n+            `At /some/file.xlf@6:16:`,\n+            `...`,\n             `        <source/>`,\n             `        <target>[ERROR ->]<b>msg should contain only ph tags</b></target>`,\n             `      </trans-unit>`,\n-            `    </body>`,\n-            `\"): /some/file.xlf@6:16`,\n+            `...`,\n+            ``,\n           ].join('\\n'));\n         });\n \n-        it('should throw when a placeholder misses an id attribute', () => {\n+        it('should fail when a placeholder misses an id attribute', () => {\n           const XLIFF = [\n             `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n             `<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">`,\n@@ -745,13 +746,14 @@ describe('Xliff1TranslationParser', () => {\n           ].join('\\n');\n \n           expectToFail('/some/file.xlf', XLIFF, /required \"id\" attribute/gi, [\n-            `Missing required \"id\" attribute: (\"`,\n-            `      <trans-unit id=\"deadbeef\" datatype=\"html\">`,\n+            `Error: Missing required \"id\" attribute:`,\n+            `At /some/file.xlf@6:16:`,\n+            `...`,\n             `        <source/>`,\n             `        <target>[ERROR ->]<x/></target>`,\n             `      </trans-unit>`,\n-            `    </body>`,\n-            `\"): /some/file.xlf@6:16`,\n+            `...`,\n+            ``,\n           ].join('\\n'));\n         });\n       });"
        },
        {
            "sha": "d9b412c8bc4865d7cd28e8439556a315e59b05cf",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xliff2_translation_parser_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxliff2_translation_parser_spec.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -650,13 +650,14 @@ describe(\n                   ].join('\\n');\n \n                   expectToFail('/some/file.xlf', XLIFF, /Invalid element found in message/, [\n-                    `Invalid element found in message. (\"`,\n-                    `      <segment>`,\n+                    `Error: Invalid element found in message.`,\n+                    `At /some/file.xlf@6:16:`,\n+                    `...`,\n                     `        <source/>`,\n                     `        <target>[ERROR ->]<b>msg should contain only ph and pc tags</b></target>`,\n                     `      </segment>`,\n-                    `    </unit>`,\n-                    `\"): /some/file.xlf@6:16`,\n+                    `...`,\n+                    ``,\n                   ].join('\\n'));\n                 });\n \n@@ -677,13 +678,14 @@ describe(\n                      ].join('\\n');\n \n                      expectToFail('/some/file.xlf', XLIFF, /Missing required \"equiv\" attribute/, [\n-                       `Missing required \"equiv\" attribute: (\"`,\n-                       `      <segment>`,\n+                       `Error: Missing required \"equiv\" attribute:`,\n+                       `At /some/file.xlf@6:16:`,\n+                       `...`,\n                        `        <source/>`,\n                        `        <target>[ERROR ->]<ph/></target>`,\n                        `      </segment>`,\n-                       `    </unit>`,\n-                       `\"): /some/file.xlf@6:16`,\n+                       `...`,\n+                       ``,\n                      ].join('\\n'));\n                    });\n               });"
        },
        {
            "sha": "bc91e87d8e80b0496c170e97da4f46bad7863c76",
            "filename": "packages/localize/src/tools/test/translate/translation_files/translation_parsers/xtb_translation_parser_spec.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 8,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5da19341151eee4dad2c91ca57570eeaf27372d7/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Ftranslate%2Ftranslation_files%2Ftranslation_parsers%2Fxtb_translation_parser_spec.ts?ref=5da19341151eee4dad2c91ca57570eeaf27372d7",
            "patch": "@@ -312,10 +312,14 @@ describe('XtbTranslationParser', () => {\n         expect(result.translations['invalid']).toBeUndefined();\n         expect(result.diagnostics.messages).toContain({\n           type: 'warning',\n-          message:\n-              `Could not parse message with id \"invalid\" - perhaps it has an unrecognised ICU format?\\n` +\n-              `Error: Unexpected character \"EOF\" (Do you have an unescaped \"{\" in your template? Use \"{{ '{' }}\") to escape it.)\\n` +\n-              `Error: Invalid ICU message. Missing '}'.`\n+          message: [\n+            `Could not parse message with id \"invalid\" - perhaps it has an unrecognised ICU format?`,\n+            `Unexpected character \"EOF\" (Do you have an unescaped \"{\" in your template? Use \"{{ '{' }}\") to escape it.) (\"id\">{REGION_COUNT_1, plural, =0 {unused plural form} =1 {1 region} other {{REGION_COUNT_2} regions}}[ERROR ->]</translation>`,\n+            `</translationbundle>\"): /some/file.xtb@2:124`,\n+            `Invalid ICU message. Missing '}'. (\"n>`,\n+            `  <translation id=\"invalid\">{REGION_COUNT_1, plural, =0 {unused plural form} =1 {1 region} other [ERROR ->]{{REGION_COUNT_2} regions}}</translation>`,\n+            `</translationbundle>\"): /some/file.xtb@2:97`,\n+          ].join('\\n')\n         });\n       });\n \n@@ -371,11 +375,14 @@ describe('XtbTranslationParser', () => {\n           ].join('\\n');\n \n           expectToFail('/some/file.xtb', XTB, /Invalid element found in message/, [\n-            `Invalid element found in message. (\"<translationbundle>`,\n+            `Error: Invalid element found in message.`,\n+            `At /some/file.xtb@2:4:`,\n+            `...`,\n             `  <translation id=\"deadbeef\">`,\n             `    [ERROR ->]<source/>`,\n             `  </translation>`,\n-            `</translationbundle>\"): /some/file.xtb@2:4`,\n+            `...`,\n+            ``,\n           ].join('\\n'));\n         });\n \n@@ -387,9 +394,12 @@ describe('XtbTranslationParser', () => {\n           ].join('\\n');\n \n           expectToFail('/some/file.xtb', XTB, /required \"name\" attribute/gi, [\n-            `Missing required \"name\" attribute: (\"<translationbundle>`,\n+            `Error: Missing required \"name\" attribute:`,\n+            `At /some/file.xtb@1:29:`,\n+            `...<translationbundle>`,\n             `  <translation id=\"deadbeef\">[ERROR ->]<ph/></translation>`,\n-            `</translationbundle>\"): /some/file.xtb@1:29`,\n+            `</translationbundle>...`,\n+            ``,\n           ].join('\\n'));\n         });\n       });"
        }
    ],
    "stats": {
        "total": 255,
        "additions": 140,
        "deletions": 115
    }
}