{
    "author": "AndrewKushnir",
    "message": "fix(forms): properly handle the change to the FormGroup shape (#40829)\n\nCurrently the code in the `FormGroupDirective` assumes that the shape of the underlying `FormGroup` never\nchanges and `FormControl`s are not replaced with other types. In practice this is possible and Forms code\nshould be able to process such changes in FormGroup shape.\n\nThis commit adds extra check to the `FormGroupDirective` class to avoid applying FormControl-specific to\nother types.\n\nFixes #13788.\n\nPR Close #40829",
    "sha": "8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc",
    "files": [
        {
            "sha": "fb339db9970f396a5678df4bf8673af2459c1ff6",
            "filename": "packages/forms/src/directives/reactive_directives/form_group_directive.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Fsrc%2Fdirectives%2Freactive_directives%2Fform_group_directive.ts?ref=8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc",
            "patch": "@@ -295,13 +295,22 @@ export class FormGroupDirective extends ControlContainer implements Form, OnChan\n   /** @internal */\n   _updateDomValue() {\n     this.directives.forEach(dir => {\n-      const newCtrl: any = this.form.get(dir.path);\n-      if (dir.control !== newCtrl) {\n+      const oldCtrl = dir.control;\n+      const newCtrl = this.form.get(dir.path);\n+      if (oldCtrl !== newCtrl) {\n         // Note: the value of the `dir.control` may not be defined, for example when it's a first\n         // `FormControl` that is added to a `FormGroup` instance (via `addControl` call).\n-        cleanUpControl(dir.control || null, dir);\n-        if (newCtrl) setUpControl(newCtrl, dir);\n-        (dir as {control: FormControl}).control = newCtrl;\n+        cleanUpControl(oldCtrl || null, dir);\n+\n+        // Check whether new control at the same location inside the corresponding `FormGroup` is an\n+        // instance of `FormControl` and perform control setup only if that's the case.\n+        // Note: we don't need to clear the list of directives (`this.directives`) here, it would be\n+        // taken care of in the `removeControl` method invoked when corresponding `formControlName`\n+        // directive instance is being removed (invoked from `FormControlName.ngOnDestroy`).\n+        if (newCtrl instanceof FormControl) {\n+          setUpControl(newCtrl, dir);\n+          (dir as {control: FormControl}).control = newCtrl;\n+        }\n       }\n     });\n "
        },
        {
            "sha": "7cecc14201c7d7a7ab22304ca48bb1d037aa5561",
            "filename": "packages/forms/test/reactive_integration_spec.ts",
            "status": "modified",
            "additions": 183,
            "deletions": 0,
            "changes": 183,
            "blob_url": "https://github.com/angular/angular/blob/8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fforms%2Ftest%2Freactive_integration_spec.ts?ref=8a9fe49a2abe6499b2c84fe22f6214e2a7b9befc",
            "patch": "@@ -663,6 +663,189 @@ const ValueAccessorB = createControlValueAccessor('[cva-b]');\n           expect(input.nativeElement.getAttribute('disabled')).toBe(null);\n         });\n       });\n+\n+      describe('dynamic change of FormGroup and FormArray shapes', () => {\n+        it('should handle FormControl and FormGroup swap', () => {\n+          @Component({\n+            template: `\n+              <form [formGroup]=\"form\">\n+                <input formControlName=\"name\" id=\"standalone-id\" *ngIf=\"!showAsGroup\">\n+                <ng-container formGroupName=\"name\" *ngIf=\"showAsGroup\">\n+                  <input formControlName=\"control\" id=\"inside-group-id\">\n+                </ng-container>\n+              </form>\n+            `\n+          })\n+          class App {\n+            showAsGroup = false;\n+            form!: FormGroup;\n+\n+            useStandaloneControl() {\n+              this.showAsGroup = false;\n+              this.form = new FormGroup({\n+                name: new FormControl('standalone'),\n+              });\n+            }\n+\n+            useControlInsideGroup() {\n+              this.showAsGroup = true;\n+              this.form = new FormGroup({\n+                name: new FormGroup({\n+                  control: new FormControl('inside-group'),\n+                })\n+              });\n+            }\n+          }\n+\n+          const fixture = initTest(App);\n+          fixture.componentInstance.useStandaloneControl();\n+          fixture.detectChanges();\n+\n+          let input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('standalone-id');\n+          expect(input.value).toBe('standalone');\n+\n+          // Replace `FormControl` with `FormGroup` at the same location\n+          // in data model and trigger change detection.\n+          fixture.componentInstance.useControlInsideGroup();\n+          fixture.detectChanges();\n+\n+          input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('inside-group-id');\n+          expect(input.value).toBe('inside-group');\n+\n+          // Swap `FormGroup` with `FormControl` back at the same location\n+          // in data model and trigger change detection.\n+          fixture.componentInstance.useStandaloneControl();\n+          fixture.detectChanges();\n+\n+          input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('standalone-id');\n+          expect(input.value).toBe('standalone');\n+        });\n+\n+        it('should handle FormControl and FormArray swap', () => {\n+          @Component({\n+            template: `\n+              <form [formGroup]=\"form\">\n+                <input formControlName=\"name\" id=\"standalone-id\" *ngIf=\"!showAsArray\">\n+                <ng-container formArrayName=\"name\" *ngIf=\"showAsArray\">\n+                  <input formControlName=\"0\" id=\"inside-array-id\">\n+                </ng-container>\n+              </form>\n+            `\n+          })\n+          class App {\n+            showAsArray = false;\n+            form!: FormGroup;\n+\n+            useStandaloneControl() {\n+              this.showAsArray = false;\n+              this.form = new FormGroup({\n+                name: new FormControl('standalone'),\n+              });\n+            }\n+\n+            useControlInsideArray() {\n+              this.showAsArray = true;\n+              this.form = new FormGroup({\n+                name: new FormArray([\n+                  new FormControl('inside-array')  //\n+                ])\n+              });\n+            }\n+          }\n+\n+          const fixture = initTest(App);\n+          fixture.componentInstance.useStandaloneControl();\n+          fixture.detectChanges();\n+\n+          let input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('standalone-id');\n+          expect(input.value).toBe('standalone');\n+\n+          // Replace `FormControl` with `FormArray` at the same location\n+          // in data model and trigger change detection.\n+          fixture.componentInstance.useControlInsideArray();\n+          fixture.detectChanges();\n+\n+          input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('inside-array-id');\n+          expect(input.value).toBe('inside-array');\n+\n+          // Swap `FormArray` with `FormControl` back at the same location\n+          // in data model and trigger change detection.\n+          fixture.componentInstance.useStandaloneControl();\n+          fixture.detectChanges();\n+\n+          input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('standalone-id');\n+          expect(input.value).toBe('standalone');\n+        });\n+\n+        it('should handle FormGroup and FormArray swap', () => {\n+          @Component({\n+            template: `\n+              <form [formGroup]=\"form\">\n+                <ng-container formGroupName=\"name\" *ngIf=\"!showAsArray\">\n+                  <input formControlName=\"control\" id=\"inside-group-id\">\n+                </ng-container>\n+                <ng-container formArrayName=\"name\" *ngIf=\"showAsArray\">\n+                  <input formControlName=\"0\" id=\"inside-array-id\">\n+                </ng-container>\n+              </form>\n+            `\n+          })\n+          class App {\n+            showAsArray = false;\n+            form!: FormGroup;\n+\n+            useControlInsideGroup() {\n+              this.showAsArray = false;\n+              this.form = new FormGroup({\n+                name: new FormGroup({\n+                  control: new FormControl('inside-group'),\n+                })\n+              });\n+            }\n+\n+            useControlInsideArray() {\n+              this.showAsArray = true;\n+              this.form = new FormGroup({\n+                name: new FormArray([\n+                  new FormControl('inside-array')  //\n+                ])\n+              });\n+            }\n+          }\n+\n+          const fixture = initTest(App);\n+          fixture.componentInstance.useControlInsideGroup();\n+          fixture.detectChanges();\n+\n+          let input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('inside-group-id');\n+          expect(input.value).toBe('inside-group');\n+\n+          // Replace `FormGroup` with `FormArray` at the same location\n+          // in data model and trigger change detection.\n+          fixture.componentInstance.useControlInsideArray();\n+          fixture.detectChanges();\n+\n+          input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('inside-array-id');\n+          expect(input.value).toBe('inside-array');\n+\n+          // Swap `FormArray` with `FormGroup` back at the same location\n+          // in data model and trigger change detection.\n+          fixture.componentInstance.useControlInsideGroup();\n+          fixture.detectChanges();\n+\n+          input = fixture.nativeElement.querySelector('input');\n+          expect(input.id).toBe('inside-group-id');\n+          expect(input.value).toBe('inside-group');\n+        });\n+      });\n     });\n \n     describe('user input', () => {"
        }
    ],
    "stats": {
        "total": 202,
        "additions": 197,
        "deletions": 5
    }
}