{
    "author": "atscott",
    "message": "refactor(compiler-cli): Store inline templates and styles in the resource registry (#39482)\n\nThe Language Service is not only interested in external resources, but\nalso inline styles and templates. By storing the expression of the\ninline resources, we can more easily determine if a given position is\npart of the inline template/style expression.\n\nPR Close #39482",
    "sha": "beb935613e348f5995241c45b933ad7fc426f8fa",
    "files": [
        {
            "sha": "07225e8546a25071de78e46fb98b3809e5161e46",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 12,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=beb935613e348f5995241c45b933ad7fc426f8fa",
            "patch": "@@ -262,7 +262,7 @@ export class ComponentDecoratorHandler implements\n       }\n     }\n     const templateResource = template.isInline ?\n-        null :\n+        {path: null, expression: component.get('template')!} :\n         {path: absoluteFrom(template.templateUrl), expression: template.sourceMapping.node};\n \n     let diagnostics: ts.Diagnostic[]|undefined = undefined;\n@@ -666,21 +666,30 @@ export class ComponentDecoratorHandler implements\n \n   private _extractStyleResources(component: Map<string, ts.Expression>, containingFile: string):\n       ReadonlySet<Resource> {\n+    const styles = new Set<Resource>();\n+    function stringLiteralElements(array: ts.ArrayLiteralExpression): ts.StringLiteralLike[] {\n+      return array.elements.filter(\n+          (e: ts.Expression): e is ts.StringLiteralLike => ts.isStringLiteralLike(e));\n+    }\n+\n+    // If styleUrls is a literal array, process each resource url individually and\n+    // register ones that are string literals.\n     const styleUrlsExpr = component.get('styleUrls');\n-    // If styleUrls is a literal array of strings, process each resource url individually and\n-    // register them. Otherwise, give up and return an empty set.\n-    if (styleUrlsExpr === undefined || !ts.isArrayLiteralExpression(styleUrlsExpr) ||\n-        !styleUrlsExpr.elements.every(e => ts.isStringLiteralLike(e))) {\n-      return new Set();\n+    if (styleUrlsExpr !== undefined && ts.isArrayLiteralExpression(styleUrlsExpr)) {\n+      for (const expression of stringLiteralElements(styleUrlsExpr)) {\n+        const resourceUrl = this.resourceLoader.resolve(expression.text, containingFile);\n+        styles.add({path: absoluteFrom(resourceUrl), expression});\n+      }\n     }\n \n-    const externalStyles = new Set<Resource>();\n-    for (const expression of styleUrlsExpr.elements) {\n-      const resourceUrl =\n-          this.resourceLoader.resolve((expression as ts.StringLiteralLike).text, containingFile);\n-      externalStyles.add({path: absoluteFrom(resourceUrl), expression});\n+    const stylesExpr = component.get('styles');\n+    if (stylesExpr !== undefined && ts.isArrayLiteralExpression(stylesExpr)) {\n+      for (const expression of stringLiteralElements(stylesExpr)) {\n+        styles.add({path: null, expression});\n+      }\n     }\n-    return externalStyles;\n+\n+    return styles;\n   }\n \n   private _preloadAndParseTemplate("
        },
        {
            "sha": "903745ba1cf31f8c7e3b07f743b890c33bfffb43",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 135,
            "deletions": 30,
            "changes": 165,
            "blob_url": "https://github.com/angular/angular/blob/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=beb935613e348f5995241c45b933ad7fc426f8fa",
            "patch": "@@ -18,18 +18,49 @@ import {getDeclaration, makeProgram} from '../../testing';\n import {ResourceLoader} from '../src/api';\n import {ComponentDecoratorHandler} from '../src/component';\n \n-export class NoopResourceLoader implements ResourceLoader {\n-  resolve(): string {\n-    throw new Error('Not implemented.');\n+export class StubResourceLoader implements ResourceLoader {\n+  resolve(v: string): string {\n+    return v;\n   }\n   canPreload = false;\n-  load(): string {\n-    throw new Error('Not implemented');\n+  load(v: string): string {\n+    return '';\n   }\n   preload(): Promise<void>|undefined {\n     throw new Error('Not implemented');\n   }\n }\n+\n+function setup(program: ts.Program, options: ts.CompilerOptions, host: ts.CompilerHost) {\n+  const checker = program.getTypeChecker();\n+  const reflectionHost = new TypeScriptReflectionHost(checker);\n+  const evaluator = new PartialEvaluator(reflectionHost, checker, /* dependencyTracker */ null);\n+  const moduleResolver =\n+      new ModuleResolver(program, options, host, /* moduleResolutionCache */ null);\n+  const importGraph = new ImportGraph(moduleResolver);\n+  const cycleAnalyzer = new CycleAnalyzer(importGraph);\n+  const metaRegistry = new LocalMetadataRegistry();\n+  const dtsReader = new DtsMetadataReader(checker, reflectionHost);\n+  const scopeRegistry = new LocalModuleScopeRegistry(\n+      metaRegistry, new MetadataDtsModuleScopeResolver(dtsReader, null), new ReferenceEmitter([]),\n+      null);\n+  const metaReader = new CompoundMetadataReader([metaRegistry, dtsReader]);\n+  const refEmitter = new ReferenceEmitter([]);\n+  const injectableRegistry = new InjectableClassRegistry(reflectionHost);\n+  const resourceRegistry = new ResourceRegistry();\n+\n+  const handler = new ComponentDecoratorHandler(\n+      reflectionHost, evaluator, metaRegistry, metaReader, scopeRegistry, scopeRegistry,\n+      resourceRegistry,\n+      /* isCore */ false, new StubResourceLoader(), /* rootDirs */['/'],\n+      /* defaultPreserveWhitespaces */ false, /* i18nUseExternalIds */ true,\n+      /* enableI18nLegacyMessageIdFormat */ false,\n+      /* i18nNormalizeLineEndingsInICUs */ undefined, moduleResolver, cycleAnalyzer, refEmitter,\n+      NOOP_DEFAULT_IMPORT_RECORDER, /* depTracker */ null, injectableRegistry,\n+      /* annotateForClosureCompiler */ false);\n+  return {reflectionHost, handler};\n+}\n+\n runInEachFileSystem(() => {\n   describe('ComponentDecoratorHandler', () => {\n     let _: typeof absoluteFrom;\n@@ -51,31 +82,7 @@ runInEachFileSystem(() => {\n       `\n         },\n       ]);\n-      const checker = program.getTypeChecker();\n-      const reflectionHost = new TypeScriptReflectionHost(checker);\n-      const evaluator = new PartialEvaluator(reflectionHost, checker, /* dependencyTracker */ null);\n-      const moduleResolver =\n-          new ModuleResolver(program, options, host, /* moduleResolutionCache */ null);\n-      const importGraph = new ImportGraph(moduleResolver);\n-      const cycleAnalyzer = new CycleAnalyzer(importGraph);\n-      const metaRegistry = new LocalMetadataRegistry();\n-      const dtsReader = new DtsMetadataReader(checker, reflectionHost);\n-      const scopeRegistry = new LocalModuleScopeRegistry(\n-          metaRegistry, new MetadataDtsModuleScopeResolver(dtsReader, null),\n-          new ReferenceEmitter([]), null);\n-      const metaReader = new CompoundMetadataReader([metaRegistry, dtsReader]);\n-      const refEmitter = new ReferenceEmitter([]);\n-      const injectableRegistry = new InjectableClassRegistry(reflectionHost);\n-\n-      const handler = new ComponentDecoratorHandler(\n-          reflectionHost, evaluator, metaRegistry, metaReader, scopeRegistry, scopeRegistry,\n-          new ResourceRegistry(),\n-          /* isCore */ false, new NoopResourceLoader(), /* rootDirs */[''],\n-          /* defaultPreserveWhitespaces */ false, /* i18nUseExternalIds */ true,\n-          /* enableI18nLegacyMessageIdFormat */ false,\n-          /* i18nNormalizeLineEndingsInICUs */ undefined, moduleResolver, cycleAnalyzer, refEmitter,\n-          NOOP_DEFAULT_IMPORT_RECORDER, /* depTracker */ null, injectableRegistry,\n-          /* annotateForClosureCompiler */ false);\n+      const {reflectionHost, handler} = setup(program, options, host);\n       const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n       const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n       if (detected === undefined) {\n@@ -94,6 +101,104 @@ runInEachFileSystem(() => {\n         expect(diag.start).toBe(detected.metadata.args![0].getStart());\n       }\n     });\n+\n+    it('should keep track of inline template', () => {\n+      const template = '<span>inline</span>';\n+      const {program, options, host} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Component: any;',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: `\n+          import {Component} from '@angular/core';\n+\n+          @Component({\n+            template: '${template}',\n+          }) class TestCmp {}\n+      `\n+        },\n+      ]);\n+      const {reflectionHost, handler} = setup(program, options, host);\n+      const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n+      const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n+      if (detected === undefined) {\n+        return fail('Failed to recognize @Component');\n+      }\n+      const {analysis} = handler.analyze(TestCmp, detected.metadata);\n+      expect(analysis?.resources.template.path).toBeNull();\n+      expect(analysis?.resources.template.expression.getText()).toEqual(`'${template}'`);\n+    });\n+\n+    it('should keep track of external template', () => {\n+      const templateUrl = '/myTemplate.ng.html';\n+      const {program, options, host} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Component: any;',\n+        },\n+        {\n+          name: _(templateUrl),\n+          contents: '<div>hello world</div>',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: `\n+          import {Component} from '@angular/core';\n+\n+          @Component({\n+            templateUrl: '${templateUrl}',\n+          }) class TestCmp {}\n+      `\n+        },\n+      ]);\n+      const {reflectionHost, handler} = setup(program, options, host);\n+      const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n+      const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n+      if (detected === undefined) {\n+        return fail('Failed to recognize @Component');\n+      }\n+      const {analysis} = handler.analyze(TestCmp, detected.metadata);\n+      expect(analysis?.resources.template.path).toContain(templateUrl);\n+      expect(analysis?.resources.template.expression.getText()).toContain(`'${templateUrl}'`);\n+    });\n+\n+    it('should keep track of internal and external styles', () => {\n+      const {program, options, host} = makeProgram([\n+        {\n+          name: _('/node_modules/@angular/core/index.d.ts'),\n+          contents: 'export const Component: any;',\n+        },\n+        {\n+          name: _('/myStyle.css'),\n+          contents: '<div>hello world</div>',\n+        },\n+        {\n+          name: _('/entry.ts'),\n+          contents: `\n+          import {Component} from '@angular/core';\n+\n+          // These are ignored because we only attempt to store string literals\n+          const ignoredStyleUrl = 'asdlfkj';\n+          const ignoredStyle = '';\n+          @Component({\n+            template: '',\n+            styleUrls: ['/myStyle.css', ignoredStyleUrl],\n+            styles: ['a { color: red; }', 'b { color: blue; }', ignoredStyle, ...[ignoredStyle]],\n+          }) class TestCmp {}\n+      `\n+        },\n+      ]);\n+      const {reflectionHost, handler} = setup(program, options, host);\n+      const TestCmp = getDeclaration(program, _('/entry.ts'), 'TestCmp', isNamedClassDeclaration);\n+      const detected = handler.detect(TestCmp, reflectionHost.getDecoratorsOfDeclaration(TestCmp));\n+      if (detected === undefined) {\n+        return fail('Failed to recognize @Component');\n+      }\n+      const {analysis} = handler.analyze(TestCmp, detected.metadata);\n+      expect(analysis?.resources.styles.size).toBe(3);\n+    });\n   });\n \n   function ivyCode(code: ErrorCode): number {"
        },
        {
            "sha": "4a26f2f9a8a511952208041673c35410e8237585",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=beb935613e348f5995241c45b933ad7fc426f8fa",
            "patch": "@@ -261,6 +261,9 @@ export class NgCompiler {\n     const {resourceRegistry} = this.ensureAnalyzed();\n     const styles = resourceRegistry.getStyles(classDecl);\n     const template = resourceRegistry.getTemplate(classDecl);\n+    if (template === null) {\n+      return null;\n+    }\n \n     return {styles, template};\n   }"
        },
        {
            "sha": "24547bd96879cd7a388f9dc85e10eb18b6ebb38a",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/resource_registry.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 18,
            "changes": 41,
            "blob_url": "https://github.com/angular/angular/blob/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts",
            "raw_url": "https://github.com/angular/angular/raw/beb935613e348f5995241c45b933ad7fc426f8fa/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Fresource_registry.ts?ref=beb935613e348f5995241c45b933ad7fc426f8fa",
            "patch": "@@ -12,23 +12,24 @@ import {AbsoluteFsPath} from '../../file_system';\n import {ClassDeclaration} from '../../reflection';\n \n /**\n- * Represents an external resource for a component and contains the `AbsoluteFsPath`\n+ * Represents an resource for a component and contains the `AbsoluteFsPath`\n  * to the file which was resolved by evaluating the `ts.Expression` (generally, a relative or\n  * absolute string path to the resource).\n+ *\n+ * If the resource is inline, the `path` will be `null`.\n  */\n export interface Resource {\n-  path: AbsoluteFsPath;\n+  path: AbsoluteFsPath|null;\n   expression: ts.Expression;\n }\n \n /**\n- * Represents the external resources of a component.\n+ * Represents the either inline or external resources of a component.\n  *\n- * If the component uses an inline template, the template resource will be `null`.\n- * If the component does not have external styles, the `styles` `Set` will be empty.\n+ * A resource with a `path` of `null` is considered inline.\n  */\n export interface ComponentResources {\n-  template: Resource|null;\n+  template: Resource;\n   styles: ReadonlySet<Resource>;\n }\n \n@@ -40,17 +41,17 @@ export interface ComponentResources {\n  * assistance.\n  */\n export class ResourceRegistry {\n-  private templateToComponentsMap = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n+  private externalTemplateToComponentsMap = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n   private componentToTemplateMap = new Map<ClassDeclaration, Resource>();\n   private componentToStylesMap = new Map<ClassDeclaration, Set<Resource>>();\n-  private styleToComponentsMap = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n+  private externalStyleToComponentsMap = new Map<AbsoluteFsPath, Set<ClassDeclaration>>();\n \n   getComponentsWithTemplate(template: AbsoluteFsPath): ReadonlySet<ClassDeclaration> {\n-    if (!this.templateToComponentsMap.has(template)) {\n+    if (!this.externalTemplateToComponentsMap.has(template)) {\n       return new Set();\n     }\n \n-    return this.templateToComponentsMap.get(template)!;\n+    return this.externalTemplateToComponentsMap.get(template)!;\n   }\n \n   registerResources(resources: ComponentResources, component: ClassDeclaration) {\n@@ -64,10 +65,12 @@ export class ResourceRegistry {\n \n   registerTemplate(templateResource: Resource, component: ClassDeclaration): void {\n     const {path} = templateResource;\n-    if (!this.templateToComponentsMap.has(path)) {\n-      this.templateToComponentsMap.set(path, new Set());\n+    if (path !== null) {\n+      if (!this.externalTemplateToComponentsMap.has(path)) {\n+        this.externalTemplateToComponentsMap.set(path, new Set());\n+      }\n+      this.externalTemplateToComponentsMap.get(path)!.add(component);\n     }\n-    this.templateToComponentsMap.get(path)!.add(component);\n     this.componentToTemplateMap.set(component, templateResource);\n   }\n \n@@ -83,10 +86,12 @@ export class ResourceRegistry {\n     if (!this.componentToStylesMap.has(component)) {\n       this.componentToStylesMap.set(component, new Set());\n     }\n-    if (!this.styleToComponentsMap.has(path)) {\n-      this.styleToComponentsMap.set(path, new Set());\n+    if (path !== null) {\n+      if (!this.externalStyleToComponentsMap.has(path)) {\n+        this.externalStyleToComponentsMap.set(path, new Set());\n+      }\n+      this.externalStyleToComponentsMap.get(path)!.add(component);\n     }\n-    this.styleToComponentsMap.get(path)!.add(component);\n     this.componentToStylesMap.get(component)!.add(styleResource);\n   }\n \n@@ -98,10 +103,10 @@ export class ResourceRegistry {\n   }\n \n   getComponentsWithStyle(styleUrl: AbsoluteFsPath): ReadonlySet<ClassDeclaration> {\n-    if (!this.styleToComponentsMap.has(styleUrl)) {\n+    if (!this.externalStyleToComponentsMap.has(styleUrl)) {\n       return new Set();\n     }\n \n-    return this.styleToComponentsMap.get(styleUrl)!;\n+    return this.externalStyleToComponentsMap.get(styleUrl)!;\n   }\n }"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 182,
        "deletions": 60
    }
}