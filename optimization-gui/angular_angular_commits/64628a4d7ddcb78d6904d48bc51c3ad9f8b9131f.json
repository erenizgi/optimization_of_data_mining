{
    "author": "josephperrott",
    "message": "fix(dev-infra): write to unique log file for `FATAL_ERROR`s in release tooling (#40524)\n\nWrite to the unique log file, to prevent being overwritten, for `FATAL_ERROR`\nfailures in the release tooling.  This will help to assist in determining where\nsomething goes wrong in the process as well as being able to resume the action.\n\nPR Close #40524",
    "sha": "64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f",
    "files": [
        {
            "sha": "80451d2834d95230b170b0a6cca6a57b896a7e4c",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f",
            "patch": "@@ -387,7 +387,9 @@ function captureLogOutputForCommand(argv) {\n     LOGGED_TEXT += headerLine + \"\\nCommand: \" + argv.$0 + \" \" + argv._.join(' ') + \"\\nRan at: \" + now + \"\\n\";\n     // On process exit, write the logged output to the appropriate log files\n     process.on('exit', function (code) {\n-        LOGGED_TEXT += \"Command ran in \" + (new Date().getTime() - now.getTime()) + \"ms\";\n+        LOGGED_TEXT += headerLine + \"\\n\";\n+        LOGGED_TEXT += \"Command ran in \" + (new Date().getTime() - now.getTime()) + \"ms\\n\";\n+        LOGGED_TEXT += \"Exit Code: \" + code + \"\\n\";\n         /** Path to the log file location. */\n         var logFilePath = path.join(getRepoBaseDir(), '.ng-dev.log');\n         // Strip ANSI escape codes from log outputs.\n@@ -396,7 +398,9 @@ function captureLogOutputForCommand(argv) {\n         // For failure codes greater than 1, the new logged lines should be written to a specific log\n         // file for the command run failure.\n         if (code > 1) {\n-            fs.writeFileSync(path.join(getRepoBaseDir(), \".ng-dev.err-\" + now.getTime() + \".log\"), LOGGED_TEXT);\n+            var logFileName = \".ng-dev.err-\" + now.getTime() + \".log\";\n+            console.error(\"Exit code: \" + code + \". Writing full log to \" + logFileName);\n+            fs.writeFileSync(path.join(getRepoBaseDir(), logFileName), LOGGED_TEXT);\n         }\n     });\n     // Mark file logging as enabled to prevent the function from executing multiple times.\n@@ -6489,10 +6493,11 @@ function handler$9(args) {\n         switch (result) {\n             case CompletionState.FATAL_ERROR:\n                 error(red(`Release action has been aborted due to fatal errors. See above.`));\n-                process.exitCode = 1;\n+                process.exitCode = 2;\n                 break;\n             case CompletionState.MANUALLY_ABORTED:\n                 info(yellow(`Release action has been manually aborted.`));\n+                process.exitCode = 1;\n                 break;\n             case CompletionState.SUCCESS:\n                 info(green(`Release action has completed successfully.`));"
        },
        {
            "sha": "068f2cf93e5959989c33313e0bbbeaa6e4637e66",
            "filename": "dev-infra/release/publish/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f/dev-infra%2Frelease%2Fpublish%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f/dev-infra%2Frelease%2Fpublish%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fpublish%2Fcli.ts?ref=64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f",
            "patch": "@@ -36,10 +36,11 @@ async function handler(args: Arguments<ReleasePublishOptions>) {\n   switch (result) {\n     case CompletionState.FATAL_ERROR:\n       error(red(`Release action has been aborted due to fatal errors. See above.`));\n-      process.exitCode = 1;\n+      process.exitCode = 2;\n       break;\n     case CompletionState.MANUALLY_ABORTED:\n       info(yellow(`Release action has been manually aborted.`));\n+      process.exitCode = 1;\n       break;\n     case CompletionState.SUCCESS:\n       info(green(`Release action has completed successfully.`));"
        },
        {
            "sha": "283aeec98268856f7744ed2e1ad5ccf3daff7d4d",
            "filename": "dev-infra/utils/console.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f/dev-infra%2Futils%2Fconsole.ts",
            "raw_url": "https://github.com/angular/angular/raw/64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f/dev-infra%2Futils%2Fconsole.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fconsole.ts?ref=64628a4d7ddcb78d6904d48bc51c3ad9f8b9131f",
            "patch": "@@ -193,7 +193,9 @@ export function captureLogOutputForCommand(argv: Arguments) {\n \n   // On process exit, write the logged output to the appropriate log files\n   process.on('exit', (code: number) => {\n-    LOGGED_TEXT += `Command ran in ${new Date().getTime() - now.getTime()}ms`;\n+    LOGGED_TEXT += `${headerLine}\\n`;\n+    LOGGED_TEXT += `Command ran in ${new Date().getTime() - now.getTime()}ms\\n`;\n+    LOGGED_TEXT += `Exit Code: ${code}\\n`;\n     /** Path to the log file location. */\n     const logFilePath = join(getRepoBaseDir(), '.ng-dev.log');\n \n@@ -205,7 +207,9 @@ export function captureLogOutputForCommand(argv: Arguments) {\n     // For failure codes greater than 1, the new logged lines should be written to a specific log\n     // file for the command run failure.\n     if (code > 1) {\n-      writeFileSync(join(getRepoBaseDir(), `.ng-dev.err-${now.getTime()}.log`), LOGGED_TEXT);\n+      const logFileName = `.ng-dev.err-${now.getTime()}.log`;\n+      console.error(`Exit code: ${code}. Writing full log to ${logFileName}`);\n+      writeFileSync(join(getRepoBaseDir(), logFileName), LOGGED_TEXT);\n     }\n   });\n "
        }
    ],
    "stats": {
        "total": 22,
        "additions": 16,
        "deletions": 6
    }
}