{
    "author": "devversion",
    "message": "fix(dev-infra): merge tool should ensure that token has `workflow` oauth scope (#41989)\n\nCurrently if a PR modifies any file that configures a Github action\n(e.g. a workflow file), the caretaker might face an error when merging\nsuch PR:\n\n```\n! [remote rejected]       merge_pr_target_11.2.x -> 11.2.x (refusing to allow a Personal Access Token to create or update workflow\n```\n\nThis happens because Github requires the token being used for the\npush operation to have the `workflow` scope set. This is a special\nscope added by Github to ensure that no changes can be made on\nupstream branches that might expose the `GITHUB_TOKEN` environment\nvariable, which is available for push builds and could cause the\ntoken being leaked.\n\nWith this commit we enforce that the caretaker adds the workflow\nscope to their github token. Since PRs can only be merged if reviewed\nthoroughly, it's acceptable to allow workflow file changes being\nmerged through the merge tool by the caretaker (especially since we\nalso allow CircleCI config files being merged with the default\n`repo`/`public_repo` scope).\n\nPR Close #41989",
    "sha": "2843f15e8c30faf6e396413356936295cfe7a141",
    "files": [
        {
            "sha": "9a73ddbc3149653b4dcd9b0ae21a5fd185c785b6",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/2843f15e8c30faf6e396413356936295cfe7a141/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/2843f15e8c30faf6e396413356936295cfe7a141/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=2843f15e8c30faf6e396413356936295cfe7a141",
            "patch": "@@ -4215,6 +4215,14 @@ var PullRequestMergeTask = /** @class */ (function () {\n                                     missing.push('public_repo');\n                                 }\n                             }\n+                            // Pull requests can modify Github action workflow files. In such cases Github requires us to\n+                            // push with a token that has the `workflow` oauth scope set. To avoid errors when the\n+                            // caretaker intends to merge such PRs, we ensure the scope is always set on the token before\n+                            // the merge process starts.\n+                            // https://docs.github.com/en/developers/apps/scopes-for-oauth-apps#available-scopes\n+                            if (!scopes.includes('workflow')) {\n+                                missing.push('workflow');\n+                            }\n                         })];\n                     case 1:\n                         hasOauthScopes = _c.sent();"
        },
        {
            "sha": "759bd8b942e7249645c851273366fca046efd24b",
            "filename": "dev-infra/pr/merge/task.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/2843f15e8c30faf6e396413356936295cfe7a141/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "raw_url": "https://github.com/angular/angular/raw/2843f15e8c30faf6e396413356936295cfe7a141/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftask.ts?ref=2843f15e8c30faf6e396413356936295cfe7a141",
            "patch": "@@ -74,6 +74,15 @@ export class PullRequestMergeTask {\n           missing.push('public_repo');\n         }\n       }\n+\n+      // Pull requests can modify Github action workflow files. In such cases Github requires us to\n+      // push with a token that has the `workflow` oauth scope set. To avoid errors when the\n+      // caretaker intends to merge such PRs, we ensure the scope is always set on the token before\n+      // the merge process starts.\n+      // https://docs.github.com/en/developers/apps/scopes-for-oauth-apps#available-scopes\n+      if (!scopes.includes('workflow')) {\n+        missing.push('workflow');\n+      }\n     });\n \n     if (hasOauthScopes !== true) {"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 17,
        "deletions": 0
    }
}