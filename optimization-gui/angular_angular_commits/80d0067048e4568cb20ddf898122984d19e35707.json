{
    "author": "Manduro",
    "message": "fix(router): `RouterLinkActive` should run CD when setting `isActive` (#21411)\n\nWhen using the routerLinkActive directive inside a component that is using ChangeDetectionStrategy.OnPush and lazy loaded module routes the routerLinkActive directive does not update after clicking a link to a lazy loaded route that has not already been loaded.\n\nAlso the OnPush nav component does not set routerLinkActive correctly when the default route loads, the non-OnPush nav component works fine.\n\nregression caused by #15943\ncloses #19934\n\nPR Close #21411",
    "sha": "80d0067048e4568cb20ddf898122984d19e35707",
    "files": [
        {
            "sha": "f83df4d485d1e202df42760428db2d02b2b446ff",
            "filename": "goldens/public-api/router/router.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/80d0067048e4568cb20ddf898122984d19e35707/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/80d0067048e4568cb20ddf898122984d19e35707/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Frouter%2Frouter.d.ts?ref=80d0067048e4568cb20ddf898122984d19e35707",
            "patch": "@@ -398,7 +398,7 @@ export declare class RouterLinkActive implements OnChanges, OnDestroy, AfterCont\n     routerLinkActiveOptions: {\n         exact: boolean;\n     };\n-    constructor(router: Router, element: ElementRef, renderer: Renderer2, link?: RouterLink | undefined, linkWithHref?: RouterLinkWithHref | undefined);\n+    constructor(router: Router, element: ElementRef, renderer: Renderer2, cdr: ChangeDetectorRef, link?: RouterLink | undefined, linkWithHref?: RouterLinkWithHref | undefined);\n     ngAfterContentInit(): void;\n     ngOnChanges(changes: SimpleChanges): void;\n     ngOnDestroy(): void;"
        },
        {
            "sha": "2e5a8986655c16abe2679503b3acf46b9d4f2068",
            "filename": "packages/router/src/directives/router_link_active.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/80d0067048e4568cb20ddf898122984d19e35707/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "raw_url": "https://github.com/angular/angular/raw/80d0067048e4568cb20ddf898122984d19e35707/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fdirectives%2Frouter_link_active.ts?ref=80d0067048e4568cb20ddf898122984d19e35707",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {AfterContentInit, ContentChildren, Directive, ElementRef, Input, OnChanges, OnDestroy, Optional, QueryList, Renderer2, SimpleChanges} from '@angular/core';\n+import {AfterContentInit, ChangeDetectorRef, ContentChildren, Directive, ElementRef, Input, OnChanges, OnDestroy, Optional, QueryList, Renderer2, SimpleChanges} from '@angular/core';\n import {Subscription} from 'rxjs';\n \n import {Event, NavigationEnd} from '../events';\n@@ -91,7 +91,7 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n \n   constructor(\n       private router: Router, private element: ElementRef, private renderer: Renderer2,\n-      @Optional() private link?: RouterLink,\n+      private readonly cdr: ChangeDetectorRef, @Optional() private link?: RouterLink,\n       @Optional() private linkWithHref?: RouterLinkWithHref) {\n     this.subscription = router.events.subscribe((s: Event) => {\n       if (s instanceof NavigationEnd) {\n@@ -126,6 +126,7 @@ export class RouterLinkActive implements OnChanges, OnDestroy, AfterContentInit\n       const hasActiveLinks = this.hasActiveLinks();\n       if (this.isActive !== hasActiveLinks) {\n         (this as any).isActive = hasActiveLinks;\n+        this.cdr.markForCheck();\n         this.classes.forEach((c) => {\n           if (hasActiveLinks) {\n             this.renderer.addClass(this.element.nativeElement, c);"
        },
        {
            "sha": "3dbf4eaf686941aa539a5a5d5eb9a68f6fc6376d",
            "filename": "packages/router/test/regression_integration.spec.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/80d0067048e4568cb20ddf898122984d19e35707/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/80d0067048e4568cb20ddf898122984d19e35707/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts?ref=80d0067048e4568cb20ddf898122984d19e35707",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {CommonModule} from '@angular/common';\n-import {Component, ContentChild, NgModule, TemplateRef, Type, ViewChild, ViewContainerRef} from '@angular/core';\n+import {ChangeDetectionStrategy, Component, ContentChild, NgModule, TemplateRef, Type, ViewChild, ViewContainerRef} from '@angular/core';\n import {ComponentFixture, fakeAsync, TestBed, tick} from '@angular/core/testing';\n import {Router} from '@angular/router';\n import {RouterTestingModule} from '@angular/router/testing';\n@@ -109,6 +109,35 @@ describe('Integration', () => {\n \n          expect(fixture.nativeElement.innerHTML).toContain('isActive: false');\n        }));\n+\n+    it('should set isActive with OnPush change detection - #19934', fakeAsync(() => {\n+         @Component({\n+           template: `\n+             <div routerLink=\"/simple\" #rla=\"routerLinkActive\" routerLinkActive>\n+               isActive: {{rla.isActive}}\n+             </div>\n+           `,\n+           changeDetection: ChangeDetectionStrategy.OnPush\n+         })\n+         class OnPushComponent {\n+         }\n+\n+         @Component({template: 'simple'})\n+         class SimpleCmp {\n+         }\n+\n+         TestBed.configureTestingModule({\n+           imports: [RouterTestingModule.withRoutes([{path: 'simple', component: SimpleCmp}])],\n+           declarations: [OnPushComponent, SimpleCmp]\n+         });\n+\n+         const router: Router = TestBed.get(Router);\n+         const fixture = createRoot(router, OnPushComponent);\n+         router.navigateByUrl('/simple');\n+         advance(fixture);\n+\n+         expect(fixture.nativeElement.innerHTML).toContain('isActive: true');\n+       }));\n   });\n });\n "
        }
    ],
    "stats": {
        "total": 38,
        "additions": 34,
        "deletions": 4
    }
}