{
    "author": "gkalpak",
    "message": "test(docs-infra): allow excluding certain docs examples from tests (#42660)\n\nThis commit adds support for excluding certain docs examples from the\ncommand used to run tests. This is useful to run extra tests on CI that\nmight not be compatible with all examples (for example, run tests with\ndifferent versions of a dependency).\n\nIn a subsequent commit, this will be used to run tests against RxJS v7\nas a quick way to catch potential regressions.\n\nPR Close #42660",
    "sha": "188a73852ef65ed56c2d4cd956080370d7462631",
    "files": [
        {
            "sha": "95793c3bb68c4c198c8d9b624249390faa7923ed",
            "filename": "aio/tools/examples/run-example-e2e.js",
            "status": "modified",
            "additions": 24,
            "deletions": 8,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/188a73852ef65ed56c2d4cd956080370d7462631/aio%2Ftools%2Fexamples%2Frun-example-e2e.js",
            "raw_url": "https://github.com/angular/angular/raw/188a73852ef65ed56c2d4cd956080370d7462631/aio%2Ftools%2Fexamples%2Frun-example-e2e.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fexamples%2Frun-example-e2e.js?ref=188a73852ef65ed56c2d4cd956080370d7462631",
            "patch": "@@ -25,9 +25,15 @@ const IGNORED_EXAMPLES = [];\n  * Run Protractor End-to-End Tests for Doc Samples\n  *\n  * Flags\n- *  --filter to filter/select _example app subdir names\n+ *  --filter to filter/select example app subdir names\n+ *    Can be used multiple times to include multiple patterns.\n  *    e.g. --filter=foo  // all example apps with 'foo' in their folder names.\n  *\n+ *  --exclude to exclude example app subdir names\n+ *    Can be used multiple times to exclude multiple patterns.\n+ *    NOTE: `--exclude` is always cosidered after `--filter`.\n+ *    e.g. --exclude=bar  // Exclude all example apps with 'bar' in their folder names.\n+ *\n  *  --setup to run yarn install, copy boilerplate and update webdriver\n  *    e.g. --setup\n  *\n@@ -60,7 +66,7 @@ function runE2e() {\n   return Promise.resolve()\n       .then(\n           () => findAndRunE2eTests(\n-              argv.filter, outputFile, argv.shard,\n+              argv.filter, argv.exclude, outputFile, argv.shard,\n               argv.cliSpecsConcurrency || DEFAULT_CLI_SPECS_CONCURRENCY, argv.retry || 1))\n       .then((status) => {\n         reportStatus(status, outputFile);\n@@ -76,15 +82,18 @@ function runE2e() {\n \n // Finds all of the *e2e-spec.tests under the examples folder along with the corresponding apps\n // that they should run under. Then run each app/spec collection sequentially.\n-function findAndRunE2eTests(filter, outputFile, shard, cliSpecsConcurrency, maxAttempts) {\n+function findAndRunE2eTests(\n+    includeFilter, excludeFilter, outputFile, shard, cliSpecsConcurrency, maxAttempts) {\n+  const filter = {include: includeFilter, exclude: excludeFilter};\n   const shardParts = shard ? shard.split('/') : [0, 1];\n   const shardModulo = parseInt(shardParts[0], 10);\n   const shardDivider = parseInt(shardParts[1], 10);\n \n   // create an output file with header.\n   const startTime = new Date().getTime();\n   let header = `Doc Sample Protractor Results on ${new Date().toLocaleString()}\\n`;\n-  header += `  Filter: ${filter ? filter : 'All tests'}\\n\\n`;\n+  header += `  Include: ${filter.include || 'All tests'}\\n`;\n+  header += `  Exclude: ${filter.exclude || 'No tests'}\\n\\n`;\n   fs.writeFileSync(outputFile, header);\n \n   const status = {passed: [], failed: []};\n@@ -378,16 +387,23 @@ function getE2eSpecs(basePath, filter) {\n // Find all e2e specs in a given example folder.\n function getE2eSpecsFor(basePath, specFile, filter) {\n   // Only get spec file at the example root.\n-  // The formatter doesn't understand nested template string expressions (honestly, neither do I).\n-  // clang-format off\n-  const e2eSpecGlob = `${filter ? `*${filter}*` : '*'}/${specFile}`;\n-  // clang-format on\n+  const e2eSpecGlob = [\n+    `${filter.include ? filterToGlob(filter.include) : '*'}/${specFile}`,\n+    `!${filter.exclude ? filterToGlob(filter.exclude) : ''}/${specFile}`,\n+  ];\n   return globby(e2eSpecGlob, {cwd: basePath, nodir: true})\n       .then(\n           paths => paths.filter(file => !IGNORED_EXAMPLES.some(ignored => file.startsWith(ignored)))\n                        .map(file => path.join(basePath, file)));\n }\n \n+function filterToGlob(filter) {\n+  // `filter` can be either a string (if there is one occurrence of the corresponding option) or an\n+  // array (if there are two or more occurrences of the corresponding option). In other words, if\n+  // `filter` is an array, it will have more than one element.\n+  return Array.isArray(filter) ? `*{${filter.join(',')}}*` : `*${filter}*`;\n+}\n+\n // Load configuration for an example. Used for SystemJS\n function loadExampleConfig(exampleFolder) {\n   // Default config."
        }
    ],
    "stats": {
        "total": 32,
        "additions": 24,
        "deletions": 8
    }
}