{
    "author": "JiaLiPassion",
    "message": "fix(zone.js): should continue to executue listeners when throw error (#41562)\n\nClose #41522\n\n`zone.js` patches event listeners and run all event listeners together, if\none event handler throws error, the listeners afterward may not be invoked.\n\nReproduction:\n\n```\nexport class AppComponent implements AfterViewInit {\n  @ViewChild('btn') btn: ElementRef;\n  title = 'event-error';\n\n  constructor(private ngZone: NgZone) {}\n\n  ngAfterViewInit() {\n    this.ngZone.runOutsideAngular(() => {\n      this.btn.nativeElement.addEventListener('click', () => {\n        throw new Error('test1');\n      });\n      this.btn.nativeElement.addEventListener('click', () => {\n        console.log('add eventlistener click');\n      });\n    });\n  }\n}\n```\n\nUntil now no Angular users report this issue becuase in the `ngZone`, all\nerror will be caught and will not rethrow, so the event listeners afterward\nwill still continue to execute, but if the event handlers are outside of `ngZone`,\nthe error will break the execution.\n\nThis commit catch all errors, and after all event listeners finished invocation,\nrethrow the errors in seperate `microTasks`, the reason I am using `microTask` here\nis to handle multiple errors case.\n\nPR Close #41562",
    "sha": "008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
    "files": [
        {
            "sha": "88521a71f6649af525813bc6a4e4f0e3e6529eda",
            "filename": "packages/zone.js/lib/browser/browser.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -66,7 +66,7 @@ Zone.__load_patch('EventTarget', (global: any, Zone: ZoneType, api: _ZonePrivate\n   // patch XMLHttpRequestEventTarget's addEventListener/removeEventListener\n   const XMLHttpRequestEventTarget = (global as any)['XMLHttpRequestEventTarget'];\n   if (XMLHttpRequestEventTarget && XMLHttpRequestEventTarget.prototype) {\n-    api.patchEventTarget(global, [XMLHttpRequestEventTarget.prototype]);\n+    api.patchEventTarget(global, api, [XMLHttpRequestEventTarget.prototype]);\n   }\n });\n "
        },
        {
            "sha": "5bebb2c395e0374b6073da3e79fb75cf8ea0f6e9",
            "filename": "packages/zone.js/lib/browser/event-target-legacy.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fevent-target-legacy.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fevent-target-legacy.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fevent-target-legacy.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -112,7 +112,7 @@ export function eventTargetLegacyPatch(_global: any, api: _ZonePrivate) {\n   }\n   // vh is validateHandler to check event handler\n   // is valid or not(for security check)\n-  api.patchEventTarget(_global, apiTypes, {\n+  api.patchEventTarget(_global, api, apiTypes, {\n     vh: checkIEAndCrossContext,\n     transferEventName: (eventName: string) => {\n       const pointerEventName = pointerEventsMap[eventName];"
        },
        {
            "sha": "215ac3d13ef038063dfc1dc2a75e8054817d8ab6",
            "filename": "packages/zone.js/lib/browser/event-target.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fevent-target.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fevent-target.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fevent-target.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -29,7 +29,7 @@ export function eventTargetPatch(_global: any, api: _ZonePrivate) {\n   if (!EVENT_TARGET || !EVENT_TARGET.prototype) {\n     return;\n   }\n-  api.patchEventTarget(_global, [EVENT_TARGET && EVENT_TARGET.prototype]);\n+  api.patchEventTarget(_global, api, [EVENT_TARGET && EVENT_TARGET.prototype]);\n \n   return true;\n }"
        },
        {
            "sha": "ef3e0c9192db143579e3422e6c2b79a22b1db51f",
            "filename": "packages/zone.js/lib/browser/shadydom.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fshadydom.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fshadydom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fshadydom.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -20,7 +20,7 @@ Zone.__load_patch('shadydom', (global: any, Zone: ZoneType, api: _ZonePrivate) =\n     if (proto && proto.hasOwnProperty('addEventListener')) {\n       proto[Zone.__symbol__('addEventListener')] = null;\n       proto[Zone.__symbol__('removeEventListener')] = null;\n-      api.patchEventTarget(global, [proto]);\n+      api.patchEventTarget(global, api, [proto]);\n     }\n   });\n });"
        },
        {
            "sha": "9ee71dea5c8af948225ce3cdc0bb4b149a9307b0",
            "filename": "packages/zone.js/lib/browser/webapis-rtc-peer-connection.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fwebapis-rtc-peer-connection.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fwebapis-rtc-peer-connection.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fwebapis-rtc-peer-connection.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -22,5 +22,5 @@ Zone.__load_patch('RTCPeerConnection', (global: any, Zone: ZoneType, api: _ZoneP\n   RTCPeerConnection.prototype[addSymbol] = null;\n   RTCPeerConnection.prototype[removeSymbol] = null;\n \n-  api.patchEventTarget(global, [RTCPeerConnection.prototype], {useG: false});\n+  api.patchEventTarget(global, api, [RTCPeerConnection.prototype], {useG: false});\n });"
        },
        {
            "sha": "fecb81496644ef56c077e0e3d68a34245565456a",
            "filename": "packages/zone.js/lib/browser/websocket.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fwebsocket.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fbrowser%2Fwebsocket.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fwebsocket.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -13,7 +13,7 @@ export function apply(api: _ZonePrivate, _global: any) {\n   // On Safari window.EventTarget doesn't exist so need to patch WS add/removeEventListener\n   // On older Chrome, no need since EventTarget was already patched\n   if (!(<any>_global).EventTarget) {\n-    api.patchEventTarget(_global, [WS.prototype]);\n+    api.patchEventTarget(_global, api, [WS.prototype]);\n   }\n   (<any>_global).WebSocket = function(x: any, y: any) {\n     const socket = arguments.length > 1 ? new WS(x, y) : new WS(x);"
        },
        {
            "sha": "d96100fb2ae00c9e90aa9ea212664affd63f50f9",
            "filename": "packages/zone.js/lib/common/events.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 35,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fcommon%2Fevents.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fcommon%2Fevents.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fcommon%2Fevents.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -86,7 +86,7 @@ export interface PatchEventTargetOptions {\n }\n \n export function patchEventTarget(\n-    _global: any, apis: any[], patchOptions?: PatchEventTargetOptions) {\n+    _global: any, api: _ZonePrivate, apis: any[], patchOptions?: PatchEventTargetOptions) {\n   const ADD_EVENT_LISTENER = (patchOptions && patchOptions.add) || ADD_EVENT_LISTENER_STR;\n   const REMOVE_EVENT_LISTENER = (patchOptions && patchOptions.rm) || REMOVE_EVENT_LISTENER_STR;\n \n@@ -114,7 +114,15 @@ export function patchEventTarget(\n       task.originalDelegate = delegate;\n     }\n     // invoke static task.invoke\n-    task.invoke(task, target, [event]);\n+    // need to try/catch error here, otherwise, the error in one event listener\n+    // will break the executions of the other event listeners. Also error will\n+    // not remove the event listener when `once` options is true.\n+    let error;\n+    try {\n+      task.invoke(task, target, [event]);\n+    } catch (err) {\n+      error = err;\n+    }\n     const options = task.options;\n     if (options && typeof options === 'object' && options.once) {\n       // if options.once is true, after invoke once remove listener here\n@@ -123,10 +131,10 @@ export function patchEventTarget(\n       const delegate = task.originalDelegate ? task.originalDelegate : task.callback;\n       target[REMOVE_EVENT_LISTENER].call(target, event.type, delegate, options);\n     }\n+    return error;\n   };\n \n-  // global shared zoneAwareCallback to handle all event callback with capture = false\n-  const globalZoneAwareCallback = function(this: unknown, event: Event) {\n+  function globalCallback(context: unknown, event: Event, isCapture: boolean) {\n     // https://github.com/angular/zone.js/issues/911, in IE, sometimes\n     // event will be undefined, so we need to use window.event\n     event = event || _global.event;\n@@ -135,8 +143,8 @@ export function patchEventTarget(\n     }\n     // event.target is needed for Samsung TV and SourceBuffer\n     // || global is needed https://github.com/angular/zone.js/issues/190\n-    const target: any = this || event.target || _global;\n-    const tasks = target[zoneSymbolEventNames[event.type][FALSE_STR]];\n+    const target: any = context || event.target || _global;\n+    const tasks = target[zoneSymbolEventNames[event.type][isCapture ? TRUE_STR : FALSE_STR]];\n     if (tasks) {\n       // invoke all tasks which attached to current target with given event.type and capture = false\n       // for performance concern, if task.length === 1, just invoke\n@@ -147,46 +155,32 @@ export function patchEventTarget(\n         // copy the tasks array before invoke, to avoid\n         // the callback will remove itself or other listener\n         const copyTasks = tasks.slice();\n+        const errors = [];\n         for (let i = 0; i < copyTasks.length; i++) {\n           if (event && (event as any)[IMMEDIATE_PROPAGATION_SYMBOL] === true) {\n             break;\n           }\n-          invokeTask(copyTasks[i], target, event);\n+          const err = invokeTask(copyTasks[i], target, event);\n+          err && errors.push(err);\n+        }\n+        for (let i = 0; i < errors.length; i++) {\n+          const err = errors[i];\n+          api.nativeScheduleMicroTask(() => {\n+            throw err;\n+          });\n         }\n       }\n     }\n+  }\n+\n+  // global shared zoneAwareCallback to handle all event callback with capture = false\n+  const globalZoneAwareCallback = function(this: unknown, event: Event) {\n+    return globalCallback(this, event, false);\n   };\n \n   // global shared zoneAwareCallback to handle all event callback with capture = true\n   const globalZoneAwareCaptureCallback = function(this: unknown, event: Event) {\n-    // https://github.com/angular/zone.js/issues/911, in IE, sometimes\n-    // event will be undefined, so we need to use window.event\n-    event = event || _global.event;\n-    if (!event) {\n-      return;\n-    }\n-    // event.target is needed for Samsung TV and SourceBuffer\n-    // || global is needed https://github.com/angular/zone.js/issues/190\n-    const target: any = this || event.target || _global;\n-    const tasks = target[zoneSymbolEventNames[event.type][TRUE_STR]];\n-    if (tasks) {\n-      // invoke all tasks which attached to current target with given event.type and capture = false\n-      // for performance concern, if task.length === 1, just invoke\n-      if (tasks.length === 1) {\n-        invokeTask(tasks[0], target, event);\n-      } else {\n-        // https://github.com/angular/zone.js/issues/836\n-        // copy the tasks array before invoke, to avoid\n-        // the callback will remove itself or other listener\n-        const copyTasks = tasks.slice();\n-        for (let i = 0; i < copyTasks.length; i++) {\n-          if (event && (event as any)[IMMEDIATE_PROPAGATION_SYMBOL] === true) {\n-            break;\n-          }\n-          invokeTask(copyTasks[i], target, event);\n-        }\n-      }\n-    }\n+    return globalCallback(this, event, true);\n   };\n \n   function patchEventTargetMethods(obj: any, patchOptions?: PatchEventTargetOptions) {"
        },
        {
            "sha": "696065aeab5faec7e5c573c11d6c1923db336521",
            "filename": "packages/zone.js/lib/extra/socket-io.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fextra%2Fsocket-io.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fextra%2Fsocket-io.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fextra%2Fsocket-io.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -8,7 +8,7 @@\n Zone.__load_patch('socketio', (global: any, Zone: ZoneType, api: _ZonePrivate) => {\n   (Zone as any)[Zone.__symbol__('socketio')] = function patchSocketIO(io: any) {\n     // patch io.Socket.prototype event listener related method\n-    api.patchEventTarget(global, [io.Socket.prototype], {\n+    api.patchEventTarget(global, api, [io.Socket.prototype], {\n       useG: false,\n       chkDup: false,\n       rt: true,"
        },
        {
            "sha": "d2e6832bba58a3a311cfdf4d64e2ea5756ffb42a",
            "filename": "packages/zone.js/lib/node/events.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fnode%2Fevents.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fnode%2Fevents.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fnode%2Fevents.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -8,7 +8,7 @@\n \n import {patchEventTarget} from '../common/events';\n \n-Zone.__load_patch('EventEmitter', (global: any) => {\n+Zone.__load_patch('EventEmitter', (global: any, Zone: ZoneType, api: _ZonePrivate) => {\n   // For EventEmitter\n   const EE_ADD_LISTENER = 'addListener';\n   const EE_PREPEND_LISTENER = 'prependListener';\n@@ -34,7 +34,7 @@ Zone.__load_patch('EventEmitter', (global: any) => {\n   };\n \n   function patchEventEmitterMethods(obj: any) {\n-    const result = patchEventTarget(global, [obj], {\n+    const result = patchEventTarget(global, api, [obj], {\n       useG: false,\n       add: EE_ADD_LISTENER,\n       rm: EE_REMOVE_LISTENER,"
        },
        {
            "sha": "59f23745b808e829fcbfbca0a36d4df29c3fe06b",
            "filename": "packages/zone.js/lib/zone.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 18,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fzone.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Flib%2Fzone.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fzone.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -337,7 +337,7 @@ interface _ZonePrivate {\n   onUnhandledError: (error: Error) => void;\n   microtaskDrainDone: () => void;\n   showUncaughtError: () => boolean;\n-  patchEventTarget: (global: any, apis: any[], options?: any) => boolean[];\n+  patchEventTarget: (global: any, api: _ZonePrivate, apis: any[], options?: any) => boolean[];\n   patchOnProperties: (obj: any, properties: string[]|null, prototype?: any) => void;\n   patchThen: (ctro: Function) => void;\n   patchMethod:\n@@ -359,6 +359,7 @@ interface _ZonePrivate {\n   filterProperties: (target: any, onProperties: string[], ignoreProperties: any[]) => string[];\n   attachOriginToPatched: (target: any, origin: any) => void;\n   _redefineProperty: (target: any, callback: string, desc: any) => void;\n+  nativeScheduleMicroTask: (func: Function) => void;\n   patchCallbacks:\n       (api: _ZonePrivate, target: any, targetName: string, method: string,\n        callbacks: string[]) => void;\n@@ -1343,27 +1344,31 @@ const Zone: ZoneType = (function(global: any) {\n   let _isDrainingMicrotaskQueue: boolean = false;\n   let nativeMicroTaskQueuePromise: any;\n \n+  function nativeScheduleMicroTask(func: Function) {\n+    if (!nativeMicroTaskQueuePromise) {\n+      if (global[symbolPromise]) {\n+        nativeMicroTaskQueuePromise = global[symbolPromise].resolve(0);\n+      }\n+    }\n+    if (nativeMicroTaskQueuePromise) {\n+      let nativeThen = nativeMicroTaskQueuePromise[symbolThen];\n+      if (!nativeThen) {\n+        // native Promise is not patchable, we need to use `then` directly\n+        // issue 1078\n+        nativeThen = nativeMicroTaskQueuePromise['then'];\n+      }\n+      nativeThen.call(nativeMicroTaskQueuePromise, func);\n+    } else {\n+      global[symbolSetTimeout](func, 0);\n+    }\n+  }\n+\n   function scheduleMicroTask(task?: MicroTask) {\n     // if we are not running in any task, and there has not been anything scheduled\n     // we must bootstrap the initial task creation by manually scheduling the drain\n     if (_numberOfNestedTaskFrames === 0 && _microTaskQueue.length === 0) {\n       // We are not running in Task, so we need to kickstart the microtask queue.\n-      if (!nativeMicroTaskQueuePromise) {\n-        if (global[symbolPromise]) {\n-          nativeMicroTaskQueuePromise = global[symbolPromise].resolve(0);\n-        }\n-      }\n-      if (nativeMicroTaskQueuePromise) {\n-        let nativeThen = nativeMicroTaskQueuePromise[symbolThen];\n-        if (!nativeThen) {\n-          // native Promise is not patchable, we need to use `then` directly\n-          // issue 1078\n-          nativeThen = nativeMicroTaskQueuePromise['then'];\n-        }\n-        nativeThen.call(nativeMicroTaskQueuePromise, drainMicroTaskQueue);\n-      } else {\n-        global[symbolSetTimeout](drainMicroTaskQueue, 0);\n-      }\n+      nativeScheduleMicroTask(drainMicroTaskQueue);\n     }\n     task && _microTaskQueue.push(task);\n   }\n@@ -1428,7 +1433,8 @@ const Zone: ZoneType = (function(global: any) {\n     filterProperties: () => [],\n     attachOriginToPatched: () => noop,\n     _redefineProperty: () => noop,\n-    patchCallbacks: () => noop\n+    patchCallbacks: () => noop,\n+    nativeScheduleMicroTask: nativeScheduleMicroTask\n   };\n   let _currentZoneFrame: _ZoneFrame = {parent: null, zone: new Zone(null, null)};\n   let _currentTask: Task|null = null;"
        },
        {
            "sha": "7eea07815f3c75dd939b0056b8092ba2d9c2835b",
            "filename": "packages/zone.js/test/browser/browser.spec.ts",
            "status": "modified",
            "additions": 92,
            "deletions": 2,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Ftest%2Fbrowser%2Fbrowser.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9/packages%2Fzone.js%2Ftest%2Fbrowser%2Fbrowser.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fbrowser%2Fbrowser.spec.ts?ref=008eaf3b7df90b2cdd9c83e229d23d4014d6dbc9",
            "patch": "@@ -348,7 +348,7 @@ describe('Zone', function() {\n \n                 (HTMLSpanElement.prototype as any)[zoneSymbol('addEventListener')] = null;\n \n-                patchEventTarget(window, [HTMLSpanElement.prototype]);\n+                patchEventTarget(window, null as any, [HTMLSpanElement.prototype]);\n \n                 const span = document.createElement('span');\n                 document.body.appendChild(span);\n@@ -1037,7 +1037,7 @@ describe('Zone', function() {\n          }));\n \n       it('should change options to boolean if not support passive', () => {\n-        patchEventTarget(window, [TestEventListener.prototype]);\n+        patchEventTarget(window, null as any, [TestEventListener.prototype]);\n         const testEventListener = new TestEventListener();\n \n         const listener = function() {};\n@@ -2490,6 +2490,96 @@ describe('Zone', function() {\n            expect(hookSpy).not.toHaveBeenCalled();\n            expect(logs).toEqual([]);\n          }));\n+\n+      it('should be able to continue to invoke remaining listeners even some listener throw error',\n+         function(done: DoneFn) {\n+           let logs: string[] = [];\n+           const listener1 = function() {\n+             logs.push('listener1');\n+           };\n+           const listener2 = function() {\n+             throw new Error('test1');\n+           };\n+           const listener3 = function() {\n+             throw new Error('test2');\n+           };\n+           const listener4 = {\n+             handleEvent: function() {\n+               logs.push('listener2');\n+             }\n+           };\n+\n+           button.addEventListener('click', listener1);\n+           button.addEventListener('click', listener2);\n+           button.addEventListener('click', listener3);\n+           button.addEventListener('click', listener4);\n+\n+           const mouseEvent = document.createEvent('MouseEvent');\n+           mouseEvent.initEvent('click', true, true);\n+\n+           const unhandledRejection = (e: PromiseRejectionEvent) => {\n+             logs.push(e.reason.message);\n+           };\n+           window.addEventListener('unhandledrejection', unhandledRejection);\n+\n+           button.dispatchEvent(mouseEvent);\n+           expect(logs).toEqual(['listener1', 'listener2']);\n+\n+           setTimeout(() => {\n+             expect(logs).toEqual(['listener1', 'listener2', 'test1', 'test2']);\n+             window.removeEventListener('unhandledrejection', unhandledRejection);\n+             done()\n+           });\n+         });\n+\n+      it('should be able to continue to invoke remaining listeners even some listener throw error in the different zones',\n+         function(done: DoneFn) {\n+           let logs: string[] = [];\n+           const zone1 = Zone.current.fork({\n+             name: 'zone1',\n+             onHandleError: (delegate, curr, target, error) => {\n+               logs.push(error.message);\n+               return false;\n+             }\n+           });\n+           const listener1 = function() {\n+             logs.push('listener1');\n+           };\n+           const listener2 = function() {\n+             throw new Error('test1');\n+           };\n+           const listener3 = function() {\n+             throw new Error('test2');\n+           };\n+           const listener4 = {\n+             handleEvent: function() {\n+               logs.push('listener2');\n+             }\n+           };\n+\n+           button.addEventListener('click', listener1);\n+           zone1.run(() => {\n+             button.addEventListener('click', listener2);\n+           });\n+           button.addEventListener('click', listener3);\n+           button.addEventListener('click', listener4);\n+\n+           const mouseEvent = document.createEvent('MouseEvent');\n+           mouseEvent.initEvent('click', true, true);\n+\n+           const unhandledRejection = (e: PromiseRejectionEvent) => {\n+             logs.push(e.reason.message);\n+           };\n+           window.addEventListener('unhandledrejection', unhandledRejection);\n+\n+           button.dispatchEvent(mouseEvent);\n+           expect(logs).toEqual(['listener1', 'test1', 'listener2']);\n+\n+           setTimeout(() => {\n+             expect(logs).toEqual(['listener1', 'test1', 'listener2', 'test2']);\n+             done()\n+           });\n+         });\n     });\n \n     // TODO: Re-enable via https://github.com/angular/angular/pull/41526"
        }
    ],
    "stats": {
        "total": 218,
        "additions": 154,
        "deletions": 64
    }
}