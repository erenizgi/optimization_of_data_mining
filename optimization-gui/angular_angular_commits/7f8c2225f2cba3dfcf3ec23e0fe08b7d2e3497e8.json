{
    "author": "dgp1130",
    "message": "fix(compiler): mark `NgModuleFactory` construction as not side effectful (#38147)\n\nThis allows Closure compiler to tree shake unused constructor calls to `NgModuleFactory`, which is otherwise considered\nside-effectful. The Angular compiler generates factory objects which are exported but typically not used, as they are\nonly needed for compatibility with View Engine. This results in top-level constructor calls, such as:\n\n```typescript\nexport const FooNgFactory = new NgModuleFactory(Foo);\n```\n\n`NgModuleFactory` has a side-effecting constructor, so this statement cannot be tree shaken, even if `FooNgFactory` is\nnever imported. The `NgModuleFactory` continues to reference its associated `NgModule` and prevents the module and all\nits unused dependencies from being tree shaken. This effectively prevents all components from being tree shaken, making\nClosure builds significantly larger than they should be.\n\nThe fix here is to wrap `NgModuleFactory` constructor with `noSideEffects(() => /* ... */)`, which tricks the Closure\ncompiler into assuming that the invoked function has no side effects. This allows it to tree-shake unused\n`NgModuleFactory()` constructors when they aren't imported. Since the factory can be removed, the module can also be\nremoved (if nothing else references it), thus tree shaking unused components as expected.\n\nPR Close #38147",
    "sha": "7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
    "files": [
        {
            "sha": "eae858337bbe7101a0b90daeff02d37952137675",
            "filename": "packages/compiler-cli/src/ngtsc/imports/src/core.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fimports%2Fsrc%2Fcore.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fimports%2Fsrc%2Fcore.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fimports%2Fsrc%2Fcore.ts?ref=7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
            "patch": "@@ -65,6 +65,7 @@ const CORE_SUPPORTED_SYMBOLS = new Map<string, string>([\n   ['ɵɵInjectorDef', 'ɵɵInjectorDef'],\n   ['ɵɵNgModuleDefWithMeta', 'ɵɵNgModuleDefWithMeta'],\n   ['ɵNgModuleFactory', 'NgModuleFactory'],\n+  ['ɵnoSideEffects', 'ɵnoSideEffects'],\n ]);\n \n const CORE_MODULE = '@angular/core';"
        },
        {
            "sha": "08f633f056041299ac24357fc2de4796afafd96e",
            "filename": "packages/compiler-cli/src/ngtsc/shims/src/factory_generator.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fshims%2Fsrc%2Ffactory_generator.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fshims%2Fsrc%2Ffactory_generator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fshims%2Fsrc%2Ffactory_generator.ts?ref=7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
            "patch": "@@ -63,7 +63,8 @@ export class FactoryGenerator implements PerFileShimGenerator, FactoryTracker {\n       // because it won't miss any that do.\n       const varLines = symbolNames.map(\n           name => `export const ${\n-              name}NgFactory: i0.ɵNgModuleFactory<any> = new i0.ɵNgModuleFactory(${name});`);\n+              name}NgFactory: i0.ɵNgModuleFactory<any> = i0.ɵnoSideEffects(() => new i0.ɵNgModuleFactory(${\n+              name}));`);\n       sourceText += [\n         // This might be incorrect if the current package being compiled is Angular core, but it's\n         // okay to leave in at type checking time. TypeScript can handle this reference via its path"
        },
        {
            "sha": "bcbb9b026187a9d4da0d6fb662b465357f595301",
            "filename": "packages/compiler-cli/test/ngtsc/fake_core/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ffake_core%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ffake_core%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ffake_core%2Findex.ts?ref=7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
            "patch": "@@ -103,3 +103,5 @@ export interface QueryList<T>/* implements Iterable<T> */ {\n export type NgIterable<T> = Array<T>|Iterable<T>;\n \n export class NgZone {}\n+\n+export declare function ɵnoSideEffects<T>(fn: () => T): T;"
        },
        {
            "sha": "7af46bfd7ca920f4f53cd875867e0efeaa8b9b0f",
            "filename": "packages/compiler-cli/test/ngtsc/ngtsc_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Fngtsc_spec.ts?ref=7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
            "patch": "@@ -3538,7 +3538,9 @@ runInEachFileSystem(os => {\n       expect(factoryContents).toContain(`import * as i0 from '@angular/core';`);\n       expect(factoryContents).toContain(`import { NotAModule, TestModule } from './test';`);\n       expect(factoryContents)\n-          .toContain(`export var TestModuleNgFactory = new i0.\\u0275NgModuleFactory(TestModule);`);\n+          .toContain(\n+              'export var TestModuleNgFactory = ' +\n+              'i0.ɵnoSideEffects(function () { return new i0.\\u0275NgModuleFactory(TestModule); });');\n       expect(factoryContents).not.toContain(`NotAModuleNgFactory`);\n       expect(factoryContents).not.toContain('\\u0275NonEmptyModule');\n \n@@ -3677,11 +3679,14 @@ runInEachFileSystem(os => {\n         env.driveMain();\n \n         const factoryContents = env.getContents('test.ngfactory.js');\n-        expect(normalize(factoryContents)).toBe(normalize(`\n-        import * as i0 from \"./r3_symbols\";\n-        import { TestModule } from './test';\n-        export var TestModuleNgFactory = new i0.NgModuleFactory(TestModule);\n-      `));\n+        expect(normalize(factoryContents))\n+            .toBe(\n+                'import * as i0 from \"./r3_symbols\"; ' +\n+                'import { TestModule } from \\'./test\\'; ' +\n+                'export var TestModuleNgFactory = ' +\n+                'i0.\\u0275noSideEffects(function () { ' +\n+                'return new i0.NgModuleFactory(TestModule); ' +\n+                '});');\n       });\n \n       describe('file-level comments', () => {"
        },
        {
            "sha": "01f844c3518a90423f2f702ee9ddc42fe6a62325",
            "filename": "packages/core/src/core_render3_private_export.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fcore_render3_private_export.ts?ref=7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
            "patch": "@@ -292,5 +292,6 @@ export {\n   ɵɵsanitizeUrl,\n   ɵɵsanitizeUrlOrResourceUrl,\n } from './sanitization/sanitization';\n+export {noSideEffects as ɵnoSideEffects} from './util/closure';\n \n // clang-format on"
        },
        {
            "sha": "1ee3762e8381a60c6d595e13e7d9662dba6d4f97",
            "filename": "packages/core/src/r3_symbols.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcore%2Fsrc%2Fr3_symbols.ts",
            "raw_url": "https://github.com/angular/angular/raw/7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8/packages%2Fcore%2Fsrc%2Fr3_symbols.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fr3_symbols.ts?ref=7f8c2225f2cba3dfcf3ec23e0fe08b7d2e3497e8",
            "patch": "@@ -28,6 +28,7 @@ export {ɵɵdefineNgModule} from './render3/definition';\n export {ɵɵFactoryDef} from './render3/interfaces/definition';\n export {setClassMetadata} from './render3/metadata';\n export {NgModuleFactory} from './render3/ng_module_ref';\n+export {noSideEffects as ɵnoSideEffects} from './util/closure';\n \n \n "
        }
    ],
    "stats": {
        "total": 25,
        "additions": 18,
        "deletions": 7
    }
}