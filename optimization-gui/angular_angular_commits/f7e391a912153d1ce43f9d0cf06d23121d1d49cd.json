{
    "author": "mgechev",
    "message": "perf(core): optimize getDirectives (#41525)\n\nThis commit introduces the following optimizations:\n\n1. We return an empty array for text nodes in `getDirectives` because\nAngular does not support attaching logic to them. This optimization\nimproves performance of `getDirectives` significantly because text nodes\noften result in expensive calls to `loadLContext` since we can't resolve\nit from a parent node.\n1. `getDirectives` now calls `loadLContext` with second argument `false`\nso it doesn't throw an error. This brings another significant\nimprovement because prevents the VM from deoptimizing calls.\n\nBREAKING CHANGE:\n\nPreviously the `ng.getDirectives` function threw an error in case a\ngiven DOM node had no Angular context associated with it (for example\nif a function was called for a DOM element outside of an Angular app).\nThis behavior was inconsistent with other debugging utilities under `ng`\nnamespace, which handled this situation without raising an exception.\nNow calling the `ng.getDirectives` function for such DOM nodes would\nresult in an empty array returned from that function.\n\nPR Close #41525",
    "sha": "f7e391a912153d1ce43f9d0cf06d23121d1d49cd",
    "files": [
        {
            "sha": "0546b62029750ab8067e853cab9e255d970b1216",
            "filename": "packages/core/src/render3/util/discovery_utils.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 7,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/f7e391a912153d1ce43f9d0cf06d23121d1d49cd/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7e391a912153d1ce43f9d0cf06d23121d1d49cd/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fdiscovery_utils.ts?ref=f7e391a912153d1ce43f9d0cf06d23121d1d49cd",
            "patch": "@@ -172,7 +172,7 @@ export function getInjectionTokens(element: Element): any[] {\n }\n \n /**\n- * Retrieves directive instances associated with a given DOM element. Does not include\n+ * Retrieves directive instances associated with a given DOM node. Does not include\n  * component instances.\n  *\n  * @usageNotes\n@@ -184,21 +184,35 @@ export function getInjectionTokens(element: Element): any[] {\n  * </my-app>\n  * ```\n  * Calling `getDirectives` on `<button>` will return an array with an instance of the `MyButton`\n- * directive that is associated with the DOM element.\n+ * directive that is associated with the DOM node.\n  *\n  * Calling `getDirectives` on `<my-comp>` will return an empty array.\n  *\n- * @param element DOM element for which to get the directives.\n- * @returns Array of directives associated with the element.\n+ * @param node DOM node for which to get the directives.\n+ * @returns Array of directives associated with the node.\n  *\n  * @publicApi\n  * @globalApi ng\n  */\n-export function getDirectives(element: Element): {}[] {\n-  const context = loadLContext(element)!;\n+export function getDirectives(node: Node): {}[] {\n+  // Skip text nodes because we can't have directives associated with them.\n+  if (node instanceof Text) {\n+    return [];\n+  }\n+\n+  const context = loadLContext(node, false);\n+  if (context === null) {\n+    return [];\n+  }\n \n+  const lView = context.lView;\n+  const tView = lView[TVIEW];\n+  const nodeIndex = context.nodeIndex;\n+  if (!tView?.data[nodeIndex]) {\n+    return [];\n+  }\n   if (context.directives === undefined) {\n-    context.directives = getDirectivesAtNodeIndex(context.nodeIndex, context.lView, false);\n+    context.directives = getDirectivesAtNodeIndex(nodeIndex, lView, false);\n   }\n \n   // The `directives` in this case are a named array called `LComponentView`. Clone the"
        },
        {
            "sha": "07ae86691d91009d0aacb664c9ec4086aecfd16b",
            "filename": "packages/core/test/acceptance/discover_utils_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/f7e391a912153d1ce43f9d0cf06d23121d1d49cd/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/f7e391a912153d1ce43f9d0cf06d23121d1d49cd/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fdiscover_utils_spec.ts?ref=f7e391a912153d1ce43f9d0cf06d23121d1d49cd",
            "patch": "@@ -386,9 +386,11 @@ onlyInIvy('Ivy-specific utilities').describe('discovery utils deprecated', () =>\n \n     it('should not throw if it cannot find LContext', () => {\n       let result: any;\n+\n       expect(() => {\n         result = getDirectives(document.createElement('div'));\n       }).not.toThrow();\n+\n       expect(result).toEqual([]);\n     });\n   });"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 23,
        "deletions": 7
    }
}