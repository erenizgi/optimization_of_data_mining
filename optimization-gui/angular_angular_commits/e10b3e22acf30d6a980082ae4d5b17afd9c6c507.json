{
    "author": "atscott",
    "message": "refactor(compiler): Add ngModule to directive symbol (#39099)\n\nThis is needed so that the Language Service can provide the module name\nin the quick info for a directive/component.\nTo accomplish this, the compiler's `LocalModuleScope` is provided to the\n`TemplateTypeCheckerImpl`.  This will also allow the `TemplateTypeChecker` to\nprovide more completions in the future, giving it a way to determine all the\ndirectives/pipes/etc. available to a template.\n\nPR Close #39099",
    "sha": "e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
    "files": [
        {
            "sha": "1fc88bb792173deb2b9a48abfd9f91ac5ae76213",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -21,7 +21,7 @@ import {CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, Inj\n import {ModuleWithProvidersScanner} from '../../modulewithproviders';\n import {PartialEvaluator} from '../../partial_evaluator';\n import {NOOP_PERF_RECORDER, PerfRecorder} from '../../perf';\n-import {TypeScriptReflectionHost} from '../../reflection';\n+import {ClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n import {AdapterResourceLoader} from '../../resource';\n import {entryPointKeyFor, NgModuleRouteAnalyzer} from '../../routing';\n import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../scope';\n@@ -780,7 +780,8 @@ export class NgCompiler {\n \n     const templateTypeChecker = new TemplateTypeCheckerImpl(\n         this.tsProgram, this.typeCheckingProgramStrategy, traitCompiler,\n-        this.getTypeCheckingConfig(), refEmitter, reflector, this.adapter, this.incrementalDriver);\n+        this.getTypeCheckingConfig(), refEmitter, reflector, this.adapter, this.incrementalDriver,\n+        scopeRegistry);\n \n     return {\n       isCore,"
        },
        {
            "sha": "f1553346ed9786edd26ae0f0af482ee0bc51a53d",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -16,6 +16,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental:api\",\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n+        \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/shims:api\",\n         \"//packages/compiler-cli/src/ngtsc/translator\","
        },
        {
            "sha": "58428c7ae6fcc91400bf34d660ed7a8b5915cc34",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/symbols.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fsymbols.ts",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fsymbols.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fsymbols.ts?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -10,6 +10,7 @@ import {TmplAstElement, TmplAstReference, TmplAstTemplate, TmplAstVariable} from\n import * as ts from 'typescript';\n \n import {AbsoluteFsPath} from '../../file_system';\n+import {ClassDeclaration} from '../../reflection';\n \n export enum SymbolKind {\n   Input,\n@@ -238,6 +239,9 @@ export interface DirectiveSymbol {\n \n   /** `true` if this `DirectiveSymbol` is for a @Component. */\n   isComponent: boolean;\n+\n+  /** The `NgModule` that this directive is declared in or `null` if it could not be determined. */\n+  ngModule: ClassDeclaration|null;\n }\n \n /**"
        },
        {
            "sha": "b2b2343ae1f68e3999b6d1d60c5cda1f5069e419",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -13,6 +13,7 @@ import {absoluteFromSourceFile, AbsoluteFsPath, getSourceFileOrError} from '../.\n import {ReferenceEmitter} from '../../imports';\n import {IncrementalBuild} from '../../incremental/api';\n import {ReflectionHost} from '../../reflection';\n+import {ComponentScopeReader} from '../../scope';\n import {isShim} from '../../shims';\n import {getSourceFileOrNull} from '../../util/src/typescript';\n import {OptimizeFor, ProgramTypeCheckAdapter, Symbol, TemplateId, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n@@ -38,7 +39,8 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       private typeCheckAdapter: ProgramTypeCheckAdapter, private config: TypeCheckingConfig,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n       private compilerHost: Pick<ts.CompilerHost, 'getCanonicalFileName'>,\n-      private priorBuild: IncrementalBuild<unknown, FileTypeCheckingData>) {}\n+      private priorBuild: IncrementalBuild<unknown, FileTypeCheckingData>,\n+      private readonly componentScopeReader: ComponentScopeReader) {}\n \n   resetOverrides(): void {\n     for (const fileRecord of this.state.values()) {\n@@ -372,7 +374,8 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n       return null;\n     }\n \n-    return new SymbolBuilder(typeChecker, shimPath, tcb, data).getSymbol(node);\n+    return new SymbolBuilder(typeChecker, shimPath, tcb, data, this.componentScopeReader)\n+        .getSymbol(node);\n   }\n }\n "
        },
        {
            "sha": "20f28b58a86502c562945a1225f62c723ebe5518",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 5,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -10,6 +10,8 @@ import {AST, ASTWithSource, BindingPipe, MethodCall, PropertyWrite, SafeMethodCa\n import * as ts from 'typescript';\n \n import {AbsoluteFsPath} from '../../file_system';\n+import {ClassDeclaration} from '../../reflection';\n+import {ComponentScopeReader} from '../../scope';\n import {isAssignment} from '../../util/src/typescript';\n import {DirectiveSymbol, DomBindingSymbol, ElementSymbol, ExpressionSymbol, InputBindingSymbol, OutputBindingSymbol, ReferenceSymbol, Symbol, SymbolKind, TemplateSymbol, TsNodeSymbolInfo, TypeCheckableDirectiveMeta, VariableSymbol} from '../api';\n \n@@ -24,8 +26,12 @@ import {TcbDirectiveOutputsOp} from './type_check_block';\n  */\n export class SymbolBuilder {\n   constructor(\n-      private readonly typeChecker: ts.TypeChecker, private readonly shimPath: AbsoluteFsPath,\n-      private readonly typeCheckBlock: ts.Node, private readonly templateData: TemplateData) {}\n+      private readonly typeChecker: ts.TypeChecker,\n+      private readonly shimPath: AbsoluteFsPath,\n+      private readonly typeCheckBlock: ts.Node,\n+      private readonly templateData: TemplateData,\n+      private readonly componentScopeReader: ComponentScopeReader,\n+  ) {}\n \n   getSymbol(node: TmplAstTemplate|TmplAstElement): TemplateSymbol|ElementSymbol|null;\n   getSymbol(node: TmplAstReference|TmplAstVariable): ReferenceSymbol|VariableSymbol|null;\n@@ -99,21 +105,24 @@ export class SymbolBuilder {\n         .map(node => {\n           const symbol = this.getSymbolOfTsNode(node.parent);\n           if (symbol === null || symbol.tsSymbol === null ||\n-              symbol.tsSymbol.declarations.length === 0) {\n+              symbol.tsSymbol.valueDeclaration === undefined ||\n+              !ts.isClassDeclaration(symbol.tsSymbol.valueDeclaration)) {\n             return null;\n           }\n-          const meta = this.getDirectiveMeta(element, symbol.tsSymbol.declarations[0]);\n+          const meta = this.getDirectiveMeta(element, symbol.tsSymbol.valueDeclaration);\n           if (meta === null) {\n             return null;\n           }\n \n+          const ngModule = this.getDirectiveModule(symbol.tsSymbol.valueDeclaration);\n           const selector = meta.selector ?? null;\n           const isComponent = meta.isComponent ?? null;\n           const directiveSymbol: DirectiveSymbol = {\n             ...symbol,\n             tsSymbol: symbol.tsSymbol,\n             selector,\n             isComponent,\n+            ngModule,\n             kind: SymbolKind.Directive\n           };\n           return directiveSymbol;\n@@ -132,6 +141,14 @@ export class SymbolBuilder {\n     return directives.find(m => m.ref.node === directiveDeclaration) ?? null;\n   }\n \n+  private getDirectiveModule(declaration: ts.ClassDeclaration): ClassDeclaration|null {\n+    const scope = this.componentScopeReader.getScopeForComponent(declaration as ClassDeclaration);\n+    if (scope === null || scope === 'error') {\n+      return null;\n+    }\n+    return scope.ngModule;\n+  }\n+\n   private getSymbolOfBoundEvent(eventBinding: TmplAstBoundEvent): OutputBindingSymbol|null {\n     // Outputs are a `ts.CallExpression` that look like one of the two:\n     // * _outputHelper(_t1[\"outputField\"]).subscribe(handler);\n@@ -239,17 +256,21 @@ export class SymbolBuilder {\n     }\n \n     const symbol = this.getSymbolOfTsNode(declaration);\n-    if (symbol === null || symbol.tsSymbol === null) {\n+    if (symbol === null || symbol.tsSymbol === null ||\n+        symbol.tsSymbol.valueDeclaration === undefined ||\n+        !ts.isClassDeclaration(symbol.tsSymbol.valueDeclaration)) {\n       return null;\n     }\n \n+    const ngModule = this.getDirectiveModule(symbol.tsSymbol.valueDeclaration);\n     return {\n       kind: SymbolKind.Directive,\n       tsSymbol: symbol.tsSymbol,\n       tsType: symbol.tsType,\n       shimLocation: symbol.shimLocation,\n       isComponent,\n       selector,\n+      ngModule,\n     };\n   }\n "
        },
        {
            "sha": "958d0c02fb2ecdd432352a3b42a494c0c0e01e40",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -18,6 +18,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/incremental\",\n         \"//packages/compiler-cli/src/ngtsc/metadata\",\n         \"//packages/compiler-cli/src/ngtsc/reflection\",\n+        \"//packages/compiler-cli/src/ngtsc/scope\",\n         \"//packages/compiler-cli/src/ngtsc/shims\",\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\","
        },
        {
            "sha": "a8eb8cf6dc85a40586359773fb09c62d0ea40adc",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -11,10 +11,11 @@ import * as ts from 'typescript';\n \n import {absoluteFrom, AbsoluteFsPath, getSourceFileOrError, LogicalFileSystem} from '../../file_system';\n import {TestFile} from '../../file_system/testing';\n-import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reference, ReferenceEmitter} from '../../imports';\n+import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, Reexport, Reference, ReferenceEmitter} from '../../imports';\n import {NOOP_INCREMENTAL_BUILD} from '../../incremental';\n import {ClassPropertyMapping} from '../../metadata';\n import {ClassDeclaration, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n+import {ComponentScopeReader, ScopeData} from '../../scope';\n import {makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '../api';\n@@ -404,9 +405,32 @@ export function setup(targets: TypeCheckingTarget[], overrides: {\n     (programStrategy as any).supportsInlineOperations = overrides.inlining;\n   }\n \n+  const fakeScopeReader = {\n+    getRequiresRemoteScope() {\n+      return null;\n+    },\n+    // If there is a module with [className] + 'Module' in the same source file, returns\n+    // `LocalModuleScope` with the ngModule class and empty arrays for everything else.\n+    getScopeForComponent(clazz: ClassDeclaration) {\n+      try {\n+        const ngModule = getClass(clazz.getSourceFile(), `${clazz.name.getText()}Module`);\n+        const stubScopeData = {directives: [], ngModules: [], pipes: []};\n+        return {\n+          ngModule,\n+          compilation: stubScopeData,\n+          reexports: [],\n+          schemas: [],\n+          exported: stubScopeData\n+        };\n+      } catch (e) {\n+        return null;\n+      }\n+    }\n+  };\n+\n   const templateTypeChecker = new TemplateTypeCheckerImpl(\n       program, programStrategy, checkAdapter, fullConfig, emitter, reflectionHost, host,\n-      NOOP_INCREMENTAL_BUILD);\n+      NOOP_INCREMENTAL_BUILD, fakeScopeReader);\n   return {\n     templateTypeChecker,\n     program,"
        },
        {
            "sha": "1deb4dc9a9780539fc4becbc5697666651553f06",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e10b3e22acf30d6a980082ae4d5b17afd9c6c507/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=e10b3e22acf30d6a980082ae4d5b17afd9c6c507",
            "patch": "@@ -1304,7 +1304,11 @@ runInEachFileSystem(() => {\n                 fileName: dirFile,\n                 source: `\n               export class TestDir {}\n+              // Allow the fake ComponentScopeReader to return a module for TestDir\n+              export class TestDirModule {}\n               export class TestDir2 {}\n+              // Allow the fake ComponentScopeReader to return a module for TestDir2\n+              export class TestDir2Module {}\n               export class TestDirAllDivs {}\n             `,\n                 templates: {},\n@@ -1327,6 +1331,15 @@ runInEachFileSystem(() => {\n         const expectedSelectors = ['[dir]', '[dir2]', 'div'].sort();\n         const actualSelectors = symbol.directives.map(dir => dir.selector).sort();\n         expect(actualSelectors).toEqual(expectedSelectors);\n+\n+        // Testing this fully requires an integration test with a real `NgCompiler` (like in the\n+        // Language Service, which uses the ngModule name for quick info). However, this path does\n+        // assert that we are able to handle when the scope reader returns `null` or a class from\n+        // the fake implementation.\n+        const expectedModules = new Set([null, 'TestDirModule', 'TestDir2Module']);\n+        const actualModules =\n+            new Set(symbol.directives.map(dir => dir.ngModule?.name.getText() ?? null));\n+        expect(actualModules).toEqual(expectedModules);\n       });\n     });\n "
        }
    ],
    "stats": {
        "total": 90,
        "additions": 79,
        "deletions": 11
    }
}