{
    "author": "atscott",
    "message": "refactor(compiler-cli): produce binding access when checkTypeOfOutputEvents is false (#39515)\n\nWhen `checkTypeOfOutputEvents` is `false`, we still need to produce the access\nto the `EventEmitter` so the Language Service can still get the\ntype information about the field. That is, in a template `<div\n(output)=\"handle($event)\"`, we still want to be able to grab information\nwhen the cursor is inside the \"output\" parens. The flag is intended only\nto affect whether the compiler produces diagnostics for the inferred\ntype of the `$event`.\n\nPR Close #39515",
    "sha": "269a775287069eaa30d8c99812631672ae4aef61",
    "files": [
        {
            "sha": "86cb34e882c7cbdcae99ecb26837895ceba63105",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=269a775287069eaa30d8c99812631672ae4aef61",
            "patch": "@@ -165,9 +165,11 @@ export class SymbolBuilder {\n   }\n \n   private getSymbolOfBoundEvent(eventBinding: TmplAstBoundEvent): OutputBindingSymbol|null {\n-    // Outputs are a `ts.CallExpression` that look like one of the two:\n+    // Outputs in the TCB look like one of the two:\n     // * _outputHelper(_t1[\"outputField\"]).subscribe(handler);\n     // * _t1.addEventListener(handler);\n+    // Even with strict null checks disabled, we still produce the access as a separate statement\n+    // so that it can be found here.\n     const outputFieldAccess = findFirstMatchingNode(\n         this.typeCheckBlock, {withSpan: eventBinding.keySpan, filter: isAccessExpression});\n     if (outputFieldAccess === null) {"
        },
        {
            "sha": "ba3a23d08340cf7b63e6e74e02fcaf3d1a2ebb05",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=269a775287069eaa30d8c99812631672ae4aef61",
            "patch": "@@ -865,6 +865,11 @@ export class TcbDirectiveOutputsOp extends TcbOp {\n       // TODO(alxhub): consider supporting multiple fields with the same property name for outputs.\n       const field = outputs.getByBindingPropertyName(output.name)![0].classPropertyName;\n \n+      if (dirId === null) {\n+        dirId = this.scope.resolve(this.node, this.dir);\n+      }\n+      const outputField = ts.createElementAccess(dirId, ts.createStringLiteral(field));\n+      addParseSpanInfo(outputField, output.keySpan);\n       if (this.tcb.env.config.checkTypeOfOutputEvents) {\n         // For strict checking of directive events, generate a call to the `subscribe` method\n         // on the directive's output field to let type information flow into the handler function's\n@@ -877,21 +882,20 @@ export class TcbDirectiveOutputsOp extends TcbOp {\n         // specially crafted set of signatures, to effectively cast `EventEmitter<T>` to something\n         // that has a `subscribe` method that properly carries the `T` into the handler function.\n         const handler = tcbCreateEventHandler(output, this.tcb, this.scope, EventParamType.Infer);\n-\n-        if (dirId === null) {\n-          dirId = this.scope.resolve(this.node, this.dir);\n-        }\n-        const outputField = ts.createElementAccess(dirId, ts.createStringLiteral(field));\n-        addParseSpanInfo(outputField, output.keySpan);\n         const outputHelper =\n             ts.createCall(this.tcb.env.declareOutputHelper(), undefined, [outputField]);\n         const subscribeFn = ts.createPropertyAccess(outputHelper, 'subscribe');\n         const call = ts.createCall(subscribeFn, /* typeArguments */ undefined, [handler]);\n         addParseSpanInfo(call, output.sourceSpan);\n         this.scope.addStatement(ts.createExpressionStatement(call));\n       } else {\n-        // If strict checking of directive events is disabled, emit a handler function where the\n-        // `$event` parameter has an explicit `any` type.\n+        // If strict checking of directive events is disabled:\n+        //\n+        // * We still generate the access to the output field as a statement in the TCB so consumers\n+        //   of the `TemplateTypeChecker` can still find the node for the class member for the\n+        //   output.\n+        // * Emit a handler function where the `$event` parameter has an explicit `any` type.\n+        this.scope.addStatement(ts.createExpressionStatement(outputField));\n         const handler = tcbCreateEventHandler(output, this.tcb, this.scope, EventParamType.Any);\n         this.scope.addStatement(ts.createExpressionStatement(handler));\n       }"
        },
        {
            "sha": "8e2b580d7a13e5afc40289f47136a3cec87b5546",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=269a775287069eaa30d8c99812631672ae4aef61",
            "patch": "@@ -839,7 +839,7 @@ describe('type check blocks', () => {\n         expect(block).toContain('function ($event: any): any { (ctx).foo($event); }');\n         // Note that DOM events are still checked, that is controlled by `checkTypeOfDomEvents`\n         expect(block).toContain(\n-            '_t1.addEventListener(\"nonDirOutput\", function ($event): any { (ctx).foo($event); });');\n+            'addEventListener(\"nonDirOutput\", function ($event): any { (ctx).foo($event); });');\n       });\n     });\n "
        },
        {
            "sha": "23bb5912e79fc50be176e9daa99ba4f765fbe0de",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__get_symbol_of_template_node_spec.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/269a775287069eaa30d8c99812631672ae4aef61/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__get_symbol_of_template_node_spec.ts?ref=269a775287069eaa30d8c99812631672ae4aef61",
            "patch": "@@ -1271,7 +1271,7 @@ runInEachFileSystem(() => {\n            assertExpressionSymbol(eventSymbol);\n          });\n \n-      it('returns empty list when checkTypeOfOutputEvents is false', () => {\n+      it('still returns binding when checkTypeOfOutputEvents is false', () => {\n         const fileName = absoluteFrom('/main.ts');\n         const dirFile = absoluteFrom('/dir.ts');\n         const {program, templateTypeChecker} = setup(\n@@ -1302,9 +1302,14 @@ runInEachFileSystem(() => {\n         const nodes = templateTypeChecker.getTemplate(cmp)!;\n \n         const outputABinding = (nodes[0] as TmplAstElement).outputs[0];\n-        const symbol = templateTypeChecker.getSymbolOfNode(outputABinding, cmp);\n-        // TODO(atscott): should type checker still generate the subscription in this case?\n-        expect(symbol).toBeNull();\n+        const symbol = templateTypeChecker.getSymbolOfNode(outputABinding, cmp)!;\n+        assertOutputBindingSymbol(symbol);\n+        expect(\n+            (symbol.bindings[0].tsSymbol!.declarations[0] as ts.PropertyDeclaration).name.getText())\n+            .toEqual('outputA');\n+        expect((symbol.bindings[0].tsSymbol!.declarations[0] as ts.PropertyDeclaration)\n+                   .parent.name?.text)\n+            .toEqual('TestDir');\n       });\n     });\n "
        },
        {
            "sha": "b6c91786b105b4a60b582e3dba9bf4045158bb35",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/269a775287069eaa30d8c99812631672ae4aef61/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/269a775287069eaa30d8c99812631672ae4aef61/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=269a775287069eaa30d8c99812631672ae4aef61",
            "patch": "@@ -496,6 +496,17 @@ describe('quick info', () => {\n         expectedDisplayString: '(property) TestComponent.name: string'\n       });\n     });\n+\n+    it('can still get quick info when strictOutputEventTypes is false', () => {\n+      initMockFileSystem('Native');\n+      env = LanguageServiceTestEnvironment.setup(\n+          quickInfoSkeleton(), {strictOutputEventTypes: false});\n+      expectQuickInfo({\n+        templateOverride: `<test-comp (teÂ¦st)=\"myClick($event)\"></test-comp>`,\n+        expectedSpanText: 'test',\n+        expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<string>'\n+      });\n+    });\n   });\n \n   function expectQuickInfo("
        }
    ],
    "stats": {
        "total": 50,
        "additions": 36,
        "deletions": 14
    }
}