{
    "author": "alan-agius4",
    "message": "refactor(bazel): use `readConfiguration` to read config file (#40694)\n\nWith this change we clean up the parsing of tsconfig files.\n\nPR Close #40694",
    "sha": "719f9ef7acc8236e82febb9e954b26c579bd997f",
    "files": [
        {
            "sha": "44dd4b11000c92915ae0b55876a82445b4edd856",
            "filename": "packages/bazel/src/ngc-wrapped/index.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 65,
            "changes": 103,
            "blob_url": "https://github.com/angular/angular/blob/719f9ef7acc8236e82febb9e954b26c579bd997f/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/719f9ef7acc8236e82febb9e954b26c579bd997f/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fngc-wrapped%2Findex.ts?ref=719f9ef7acc8236e82febb9e954b26c579bd997f",
            "patch": "@@ -44,81 +44,54 @@ export function runOneBuild(args: string[], inputs?: {[path: string]: string}):\n   const project = args[0].replace(/^@+/, '');\n \n   const [parsedOptions, errors] = parseTsconfig(project);\n-  if (errors && errors.length) {\n+  if (errors?.length) {\n     console.error(ng.formatDiagnostics(errors));\n     return false;\n   }\n-  const {options: tsOptions, bazelOpts, files, config} = parsedOptions;\n-  const angularCompilerOptions: {[k: string]: unknown} = config['angularCompilerOptions'] || {};\n-\n-  // Allow Bazel users to control some of the bazel options.\n-  // Since TypeScript's \"extends\" mechanism applies only to \"compilerOptions\"\n-  // we have to repeat some of their logic to get the user's \"angularCompilerOptions\".\n-  if (config['extends']) {\n-    // Load the user's config file\n-    // Note: this doesn't handle recursive extends so only a user's top level\n-    // `angularCompilerOptions` will be considered. As this code is going to be\n-    // removed with Ivy, the added complication of handling recursive extends\n-    // is likely not needed.\n-    let userConfigFile = resolveNormalizedPath(path.dirname(project), config['extends']);\n-    if (!userConfigFile.endsWith('.json')) userConfigFile += '.json';\n-    const {config: userConfig, error} = ts.readConfigFile(userConfigFile, ts.sys.readFile);\n-    if (error) {\n-      console.error(ng.formatDiagnostics([error]));\n-      return false;\n-    }\n \n-    // All user angularCompilerOptions values that a user has control\n-    // over should be collected here\n-    if (userConfig.angularCompilerOptions) {\n-      angularCompilerOptions['diagnostics'] =\n-          angularCompilerOptions['diagnostics'] || userConfig.angularCompilerOptions.diagnostics;\n-      angularCompilerOptions['trace'] =\n-          angularCompilerOptions['trace'] || userConfig.angularCompilerOptions.trace;\n-\n-      angularCompilerOptions['disableExpressionLowering'] =\n-          angularCompilerOptions['disableExpressionLowering'] ||\n-          userConfig.angularCompilerOptions.disableExpressionLowering;\n-      angularCompilerOptions['disableTypeScriptVersionCheck'] =\n-          angularCompilerOptions['disableTypeScriptVersionCheck'] ||\n-          userConfig.angularCompilerOptions.disableTypeScriptVersionCheck;\n-\n-      angularCompilerOptions['i18nOutLocale'] = angularCompilerOptions['i18nOutLocale'] ||\n-          userConfig.angularCompilerOptions.i18nOutLocale;\n-      angularCompilerOptions['i18nOutFormat'] = angularCompilerOptions['i18nOutFormat'] ||\n-          userConfig.angularCompilerOptions.i18nOutFormat;\n-      angularCompilerOptions['i18nOutFile'] =\n-          angularCompilerOptions['i18nOutFile'] || userConfig.angularCompilerOptions.i18nOutFile;\n-\n-      angularCompilerOptions['i18nInFormat'] =\n-          angularCompilerOptions['i18nInFormat'] || userConfig.angularCompilerOptions.i18nInFormat;\n-      angularCompilerOptions['i18nInLocale'] =\n-          angularCompilerOptions['i18nInLocale'] || userConfig.angularCompilerOptions.i18nInLocale;\n-      angularCompilerOptions['i18nInFile'] =\n-          angularCompilerOptions['i18nInFile'] || userConfig.angularCompilerOptions.i18nInFile;\n-\n-      angularCompilerOptions['i18nInMissingTranslations'] =\n-          angularCompilerOptions['i18nInMissingTranslations'] ||\n-          userConfig.angularCompilerOptions.i18nInMissingTranslations;\n-      angularCompilerOptions['i18nUseExternalIds'] = angularCompilerOptions['i18nUseExternalIds'] ||\n-          userConfig.angularCompilerOptions.i18nUseExternalIds;\n-\n-      angularCompilerOptions['preserveWhitespaces'] =\n-          angularCompilerOptions['preserveWhitespaces'] ||\n-          userConfig.angularCompilerOptions.preserveWhitespaces;\n-\n-      angularCompilerOptions.createExternalSymbolFactoryReexports =\n-          angularCompilerOptions.createExternalSymbolFactoryReexports ||\n-          userConfig.angularCompilerOptions.createExternalSymbolFactoryReexports;\n-    }\n+  const {bazelOpts, options: tsOptions, files, config} = parsedOptions;\n+  const {errors: userErrors, options: userOptions} = ng.readConfiguration(project);\n+\n+  if (userErrors?.length) {\n+    console.error(ng.formatDiagnostics(userErrors));\n+    return false;\n   }\n \n+  const allowedNgCompilerOptionsOverrides = new Set<string>([\n+    'diagnostics',\n+    'trace',\n+    'disableExpressionLowering',\n+    'disableTypeScriptVersionCheck',\n+    'i18nOutLocale',\n+    'i18nOutFormat',\n+    'i18nOutFile',\n+    'i18nInLocale',\n+    'i18nInFile',\n+    'i18nInFormat',\n+    'i18nUseExternalIds',\n+    'i18nInMissingTranslations',\n+    'preserveWhitespaces',\n+    'createExternalSymbolFactoryReexports',\n+  ]);\n+\n+  const userOverrides = Object.entries(userOptions)\n+                            .filter(([key]) => allowedNgCompilerOptionsOverrides.has(key))\n+                            .reduce((obj, [key, value]) => {\n+                              obj[key] = value;\n+\n+                              return obj;\n+                            }, {});\n+\n+  const compilerOpts: ng.AngularCompilerOptions = {\n+    ...userOverrides,\n+    ...config['angularCompilerOptions'],\n+    ...tsOptions,\n+  };\n+\n   // These are options passed through from the `ng_module` rule which aren't supported\n   // by the `@angular/compiler-cli` and are only intended for `ngc-wrapped`.\n   const {expectedOut, _useManifestPathsAsModuleName} = config['angularCompilerOptions'];\n \n-  const {basePath} = ng.calcProjectFileAndBasePath(project);\n-  const compilerOpts = ng.createNgCompilerOptions(basePath, config, tsOptions);\n   const tsHost = ts.createCompilerHost(compilerOpts, true);\n   const {diagnostics} = compile({\n     allDepsCompiledWithBazel: ALL_DEPS_COMPILED_WITH_BAZEL,"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 38,
        "deletions": 65
    }
}