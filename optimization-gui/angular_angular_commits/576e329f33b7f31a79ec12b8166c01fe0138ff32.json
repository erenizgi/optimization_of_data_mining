{
    "author": "devversion",
    "message": "feat(dev-infra): provide github API instance to lazy merge configuration (#38223)\n\nThe merge script currently accepts a configuration function that will\nbe invoked _only_ when the `ng-dev merge` command is executed. This\nhas been done that way because the merge tooling usually relies on\nexternal requests to Git or NPM for constructing the branch configurations.\n\nWe do not want to perform these slow external queries on any `ng-dev` command\nthough, so this became a lazily invoked function.\n\nThis commit adds support for these configuration functions to run\nasynchronously (by returning a Promise that will be awaited), so that\nrequests could also be made to the Github API. This is benefical as it\ncould avoid dependence on the local Git state and the HTTP requests\nare more powerful/faster.\n\nAdditionally, in order to be able to perform Github API requests\nwith an authenticated instance, the merge tool will pass through\na `GithubClient` instance that uses the specified `--github-token`\n(or from the environment). This ensures that all API requests use\nthe same `GithubClient` instance and can be authenticated (mitigating\npotential rate limits).\n\nPR Close #38223",
    "sha": "576e329f33b7f31a79ec12b8166c01fe0138ff32",
    "files": [
        {
            "sha": "5ac8cfaee8f09b099876cd61ba79e0039d7f53c6",
            "filename": "dev-infra/pr/merge/config.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 16,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "raw_url": "https://github.com/angular/angular/raw/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Fpr%2Fmerge%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fconfig.ts?ref=576e329f33b7f31a79ec12b8166c01fe0138ff32",
            "patch": "@@ -6,10 +6,14 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {getConfig, GitClientConfig, NgDevConfig} from '../../utils/config';\n+import {GitClientConfig, NgDevConfig} from '../../utils/config';\n+import {GithubClient} from '../../utils/git/github';\n \n import {GithubApiMergeStrategyConfig} from './strategies/api-merge';\n \n+/** Describes possible values that can be returned for `branches` of a target label. */\n+export type TargetLabelBranchResult = string[]|Promise<string[]>;\n+\n /**\n  * Possible merge methods supported by the Github API.\n  * https://developer.github.com/v3/pulls/#merge-a-pull-request-merge-button.\n@@ -28,7 +32,7 @@ export interface TargetLabel {\n    * Can also be wrapped in a function that accepts the target branch specified in the\n    * Github Web UI. This is useful for supporting labels like `target: development-branch`.\n    */\n-  branches: string[]|((githubTargetBranch: string) => string[]);\n+  branches: TargetLabelBranchResult|((githubTargetBranch: string) => TargetLabelBranchResult);\n }\n \n /**\n@@ -72,12 +76,13 @@ export interface MergeConfig {\n  * on branch name computations. We don't want to run these immediately whenever\n  * the dev-infra configuration is loaded as that could slow-down other commands.\n  */\n-export type DevInfraMergeConfig = NgDevConfig<{'merge': () => MergeConfig}>;\n+export type DevInfraMergeConfig =\n+    NgDevConfig<{'merge': (api: GithubClient) => MergeConfig | Promise<MergeConfig>}>;\n \n /** Loads and validates the merge configuration. */\n-export function loadAndValidateConfig(): {config?: MergeConfigWithRemote, errors?: string[]} {\n-  const config: Partial<DevInfraMergeConfig> = getConfig();\n-\n+export async function loadAndValidateConfig(\n+    config: Partial<DevInfraMergeConfig>,\n+    api: GithubClient): Promise<{config?: MergeConfig, errors?: string[]}> {\n   if (config.merge === undefined) {\n     return {errors: ['No merge configuration found. Set the `merge` configuration.']};\n   }\n@@ -86,22 +91,14 @@ export function loadAndValidateConfig(): {config?: MergeConfigWithRemote, errors\n     return {errors: ['Expected merge configuration to be defined lazily through a function.']};\n   }\n \n-  const mergeConfig = config.merge();\n+  const mergeConfig = await config.merge(api);\n   const errors = validateMergeConfig(mergeConfig);\n \n   if (errors.length) {\n     return {errors};\n   }\n \n-  if (mergeConfig.remote) {\n-    mergeConfig.remote = {...config.github, ...mergeConfig.remote};\n-  } else {\n-    mergeConfig.remote = config.github;\n-  }\n-\n-  // We always set the `remote` option, so we can safely cast the\n-  // config to `MergeConfigWithRemote`.\n-  return {config: mergeConfig as MergeConfigWithRemote};\n+  return {config: mergeConfig};\n }\n \n /** Validates the specified configuration. Returns a list of failure messages. */"
        },
        {
            "sha": "816aa679d2715d577455a4b688ae4ff3b4f47d83",
            "filename": "dev-infra/pr/merge/index.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 16,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Fpr%2Fmerge%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Findex.ts?ref=576e329f33b7f31a79ec12b8166c01fe0138ff32",
            "patch": "@@ -7,11 +7,12 @@\n  */\n \n \n-import {getRepoBaseDir} from '../../utils/config';\n+import {getConfig, getRepoBaseDir} from '../../utils/config';\n import {error, green, info, promptConfirm, red, yellow} from '../../utils/console';\n-import {GithubApiRequestError} from '../../utils/git';\n+import {GitClient} from '../../utils/git';\n+import {GithubApiRequestError} from '../../utils/git/github';\n \n-import {loadAndValidateConfig, MergeConfigWithRemote} from './config';\n+import {loadAndValidateConfig, MergeConfig, MergeConfigWithRemote} from './config';\n import {MergeResult, MergeStatus, PullRequestMergeTask} from './task';\n \n /** URL to the Github page where personal access tokens can be generated. */\n@@ -34,19 +35,7 @@ export const GITHUB_TOKEN_GENERATE_URL = `https://github.com/settings/tokens`;\n export async function mergePullRequest(\n     prNumber: number, githubToken: string, projectRoot: string = getRepoBaseDir(),\n     config?: MergeConfigWithRemote) {\n-  // If no explicit configuration has been specified, we load and validate\n-  // the configuration from the shared dev-infra configuration.\n-  if (config === undefined) {\n-    const {config: _config, errors} = loadAndValidateConfig();\n-    if (errors) {\n-      error(red('Invalid configuration:'));\n-      errors.forEach(desc => error(yellow(`  -  ${desc}`)));\n-      process.exit(1);\n-    }\n-    config = _config!;\n-  }\n-\n-  const api = new PullRequestMergeTask(projectRoot, config, githubToken);\n+  const api = await createPullRequestMergeTask(githubToken, projectRoot, config);\n \n   // Perform the merge. Force mode can be activated through a command line flag.\n   // Alternatively, if the merge fails with non-fatal failures, the script\n@@ -132,3 +121,33 @@ export async function mergePullRequest(\n     }\n   }\n }\n+\n+/**\n+ * Creates the pull request merge task from the given Github token, project root\n+ * and optional explicit configuration. An explicit configuration can be specified\n+ * when the merge script is used outside of a `ng-dev` configured repository.\n+ */\n+async function createPullRequestMergeTask(\n+    githubToken: string, projectRoot: string, explicitConfig?: MergeConfigWithRemote) {\n+  if (explicitConfig !== undefined) {\n+    const git = new GitClient(githubToken, {github: explicitConfig.remote}, projectRoot);\n+    return new PullRequestMergeTask(explicitConfig, git);\n+  }\n+\n+  const devInfraConfig = getConfig();\n+  const git = new GitClient(githubToken, devInfraConfig, projectRoot);\n+  const {config, errors} = await loadAndValidateConfig(devInfraConfig, git.github);\n+\n+  if (errors) {\n+    error(red('Invalid merge configuration:'));\n+    errors.forEach(desc => error(yellow(`  -  ${desc}`)));\n+    process.exit(1);\n+  }\n+\n+  // Set the remote so that the merge tool has access to information about\n+  // the remote it intends to merge to.\n+  config!.remote = devInfraConfig.github;\n+  // We can cast this to a merge config with remote because we always set the\n+  // remote above.\n+  return new PullRequestMergeTask(config! as MergeConfigWithRemote, git);\n+}"
        },
        {
            "sha": "4d20d2a338e2921da8de83b0a2b0098f4477da01",
            "filename": "dev-infra/pr/merge/task.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "raw_url": "https://github.com/angular/angular/raw/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftask.ts?ref=576e329f33b7f31a79ec12b8166c01fe0138ff32",
            "patch": "@@ -9,7 +9,7 @@\n import {promptConfirm} from '../../utils/console';\n import {GitClient, GitCommandError} from '../../utils/git';\n \n-import {MergeConfigWithRemote} from './config';\n+import {MergeConfig, MergeConfigWithRemote} from './config';\n import {PullRequestFailure} from './failures';\n import {getCaretakerNotePromptMessage} from './messages';\n import {isPullRequest, loadAndValidatePullRequest,} from './pull-request';\n@@ -40,12 +40,7 @@ export interface MergeResult {\n  * labels that have been resolved through the merge script configuration.\n  */\n export class PullRequestMergeTask {\n-  /** Git client that can be used to execute Git commands. */\n-  git = new GitClient(this._githubToken, {github: this.config.remote});\n-\n-  constructor(\n-      public projectRoot: string, public config: MergeConfigWithRemote,\n-      private _githubToken: string) {}\n+  constructor(public config: MergeConfigWithRemote, public git: GitClient) {}\n \n   /**\n    * Merges the given pull request and pushes it upstream."
        },
        {
            "sha": "85d061435868f331991c075daf56d136053bba5b",
            "filename": "dev-infra/utils/git/github.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "raw_url": "https://github.com/angular/angular/raw/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Futils%2Fgit%2Fgithub.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Fgithub.ts?ref=576e329f33b7f31a79ec12b8166c01fe0138ff32",
            "patch": "@@ -6,13 +6,6 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-/****************************************************************************\n- ****************************************************************************\n- ** DO NOT IMPORT THE GithubClient DIRECTLY, INSTEAD IMPORT GitClient from **\n- ** ./index.ts and access the GithubClient via the `.github` member.       **\n- ****************************************************************************\n- ****************************************************************************/\n-\n import {graphql} from '@octokit/graphql';\n import * as Octokit from '@octokit/rest';\n import {RequestParameters} from '@octokit/types';\n@@ -28,10 +21,10 @@ export class GithubApiRequestError extends Error {\n /**\n  * A Github client for interacting with the Github APIs.\n  *\n- * Additionally, provides convienience methods for actions which require multiple requests, or\n+ * Additionally, provides convenience methods for actions which require multiple requests, or\n  * would provide value from memoized style responses.\n  **/\n-export class _GithubClient extends Octokit {\n+export class GithubClient extends Octokit {\n   /** The Github GraphQL (v4) API. */\n   graqhql: GithubGraphqlClient;\n ",
            "previous_filename": "dev-infra/utils/git/_github.ts"
        },
        {
            "sha": "030a25c4cada6896844979894d87587c0d613a60",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/576e329f33b7f31a79ec12b8166c01fe0138ff32/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=576e329f33b7f31a79ec12b8166c01fe0138ff32",
            "patch": "@@ -11,10 +11,7 @@ import {spawnSync, SpawnSyncOptions, SpawnSyncReturns} from 'child_process';\n \n import {getConfig, getRepoBaseDir, NgDevConfig} from '../config';\n import {info, yellow} from '../console';\n-import {_GithubClient} from './_github';\n-\n-// Re-export GithubApiRequestError\n-export {GithubApiRequestError} from './_github';\n+import {GithubClient} from './github';\n \n /** Github response type extended to include the `x-oauth-scopes` headers presence. */\n type RateLimitResponseWithOAuthScopeHeader = Octokit.Response<Octokit.RateLimitGetResponse>&{\n@@ -54,10 +51,8 @@ export class GitClient {\n       `https://${this._githubToken}@github.com/${this.remoteConfig.owner}/${\n           this.remoteConfig.name}.git`;\n   /** Instance of the authenticated Github octokit API. */\n-  github = new _GithubClient(this._githubToken);\n+  github = new GithubClient(this._githubToken);\n \n-  /** The file path of project's root directory. */\n-  private _projectRoot = getRepoBaseDir();\n   /** The OAuth scopes available for the provided Github token. */\n   private _oauthScopes: Promise<string[]>|null = null;\n   /**\n@@ -67,7 +62,8 @@ export class GitClient {\n   private _githubTokenRegex: RegExp|null = null;\n \n   constructor(\n-      private _githubToken?: string, private _config: Pick<NgDevConfig, 'github'> = getConfig()) {\n+      private _githubToken?: string, private _config: Pick<NgDevConfig, 'github'> = getConfig(),\n+      private _projectRoot = getRepoBaseDir()) {\n     // If a token has been specified (and is not empty), pass it to the Octokit API and\n     // also create a regular expression that can be used for sanitizing Git command output\n     // so that it does not print the token accidentally."
        }
    ],
    "stats": {
        "total": 112,
        "additions": 56,
        "deletions": 56
    }
}