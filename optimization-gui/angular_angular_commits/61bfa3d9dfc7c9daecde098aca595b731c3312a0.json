{
    "author": "kyliau",
    "message": "test(language-service): Add test to expose bug caused by source file change (#41500)\n\nThis commit adds a test to expose the bug caused by source file change in\nbetween typecheck programs.\n\nPR Close #41500",
    "sha": "61bfa3d9dfc7c9daecde098aca595b731c3312a0",
    "files": [
        {
            "sha": "02dcf23224073b29998d43f559a7697dcb44f854",
            "filename": "packages/language-service/ivy/test/compiler_spec.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/61bfa3d9dfc7c9daecde098aca595b731c3312a0/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/61bfa3d9dfc7c9daecde098aca595b731c3312a0/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompiler_spec.ts?ref=61bfa3d9dfc7c9daecde098aca595b731c3312a0",
            "patch": "@@ -173,4 +173,44 @@ describe('language-service/compiler integration', () => {\n     const ngDiagsAfter = project.getDiagnosticsForFile('mod.ts').filter(isNgSpecificDiagnostic);\n     expect(ngDiagsAfter.length).toBe(0);\n   });\n+\n+  it('detects source file change in between typecheck programs', () => {\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = env.addProject('test', {\n+      'module.ts': `\n+        import {NgModule} from '@angular/core';\n+        import {BarCmp} from './bar';\n+\n+        @NgModule({\n+          declarations: [BarCmp],\n+        })\n+        export class AppModule {}\n+      `,\n+      'bar.ts': `\n+        import {Component} from '@angular/core';\n+\n+        @Component({\n+          template: '{{ bar }}',\n+        })\n+        export class BarCmp {\n+          readonly bar = 'bar';\n+        }\n+      `,\n+    });\n+    // The opening of 'bar.ts' causes its version to change, because the internal\n+    // representation switches from TextStorage to ScriptVersionCache.\n+    const bar = project.openFile('bar.ts');\n+    // When getDiagnostics is called, NgCompiler calls ensureAllShimsForOneFile\n+    // and caches the source file for 'bar.ts' in the input program.\n+    // The input program has not picked up the version change because the project\n+    // is clean (rightly so since there's no user-initiated change).\n+    expect(project.getDiagnosticsForFile('bar.ts').length).toBe(0);\n+    // A new program is generated due to addition of typecheck file. During\n+    // program creation, TS language service does a sweep of all source files,\n+    // and detects the version change. Consequently, it creates a new source\n+    // file for 'bar.ts'. This is a violation of our assumption that a SourceFile\n+    // will never change in between typecheck programs.\n+    bar.moveCursorToText(`template: '{{ bÂ¦ar }}'`);\n+    expect(bar.getQuickInfoAtPosition()).toBeDefined();\n+  });\n });"
        },
        {
            "sha": "307eadf66de04e5a3b6336704b2419bb98651725",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/61bfa3d9dfc7c9daecde098aca595b731c3312a0/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/61bfa3d9dfc7c9daecde098aca595b731c3312a0/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=61bfa3d9dfc7c9daecde098aca595b731c3312a0",
            "patch": "@@ -103,6 +103,7 @@ export class Project {\n       // Mark the project as dirty because the act of opening a file may result in the version\n       // changing since TypeScript will `switchToScriptVersionCache` when a file is opened.\n       // Note that this emulates what we have to do in the server/extension as well.\n+      // TODO: remove this once PR #41475 lands\n       this.tsProject.markAsDirty();\n \n       scriptInfo = this.tsProject.getScriptInfo(fileName);"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 41,
        "deletions": 0
    }
}