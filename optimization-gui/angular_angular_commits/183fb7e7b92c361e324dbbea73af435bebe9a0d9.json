{
    "author": "kyliau",
    "message": "fix(language-service): return all typecheck files via getExternalFiles (#40162)\n\nWe need a means to preserve typecheck files when a project is reloaded,\notherwise the Ivy compiler will throw an error when it's unable to find\nthem. This commit implements `getExternalFiles()` called by the langauge\nserver to achieve this goal.\n\nFor more info see https://github.com/angular/vscode-ng-language-service/issues/1030\n\nPR Close #40162",
    "sha": "183fb7e7b92c361e324dbbea73af435bebe9a0d9",
    "files": [
        {
            "sha": "8d8989f95807cd4d808986b2509ee3ff5187aaed",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=183fb7e7b92c361e324dbbea73af435bebe9a0d9",
            "patch": "@@ -242,9 +242,11 @@ function getOrCreateTypeCheckScriptInfo(\n     // attempt to fetch the content from disk and fail.\n     scriptInfo = projectService.getOrCreateScriptInfoForNormalizedPath(\n         ts.server.toNormalizedPath(tcf),\n-        true,              // openedByClient\n-        '',                // fileContent\n-        ts.ScriptKind.TS,  // scriptKind\n+        true,  // openedByClient\n+        '',    // fileContent\n+        // script info added by plugins should be marked as external, see\n+        // https://github.com/microsoft/TypeScript/blob/b217f22e798c781f55d17da72ed099a9dee5c650/src/compiler/program.ts#L1897-L1899\n+        ts.ScriptKind.External,  // scriptKind\n     );\n     if (!scriptInfo) {\n       throw new Error(`Failed to create script info for ${tcf}`);"
        },
        {
            "sha": "d825907e417dfcbfe5e2d7c929881cfa1d79110c",
            "filename": "packages/language-service/ivy/test/legacy/mock_host.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fmock_host.ts?ref=183fb7e7b92c361e324dbbea73af435bebe9a0d9",
            "patch": "@@ -243,9 +243,9 @@ export class MockService {\n     }\n     const newScriptInfo = this.ps.getOrCreateScriptInfoForNormalizedPath(\n         ts.server.toNormalizedPath(fileName),\n-        true,                    // openedByClient\n-        '',                      // fileContent\n-        ts.ScriptKind.External,  // scriptKind\n+        true,                   // openedByClient\n+        '',                     // fileContent\n+        ts.ScriptKind.Unknown,  // scriptKind\n     );\n     if (!newScriptInfo) {\n       throw new Error(`Failed to create new script info for ${fileName}`);"
        },
        {
            "sha": "ce6f75fc7527e910d498bf969701070572f0000b",
            "filename": "packages/language-service/ivy/test/legacy/ts_plugin_spec.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fts_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fts_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flegacy%2Fts_plugin_spec.ts?ref=183fb7e7b92c361e324dbbea73af435bebe9a0d9",
            "patch": "@@ -0,0 +1,29 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {LanguageService} from '../../language_service';\n+import {getExternalFiles} from '../../ts_plugin';\n+\n+import {APP_COMPONENT, setup} from './mock_host';\n+\n+describe('getExternalFiles()', () => {\n+  it('should return all typecheck files', () => {\n+    const {project, tsLS} = setup();\n+    let externalFiles = getExternalFiles(project);\n+    // Initially there are no external files because Ivy compiler hasn't done\n+    // a global analysis\n+    expect(externalFiles).toEqual([]);\n+    // Trigger global analysis\n+    const ngLS = new LanguageService(project, tsLS);\n+    ngLS.getSemanticDiagnostics(APP_COMPONENT);\n+    // Now that global analysis is run, we should have all the typecheck files\n+    externalFiles = getExternalFiles(project);\n+    expect(externalFiles.length).toBe(1);\n+    expect(externalFiles[0].endsWith('app.component.ngtypecheck.ts')).toBeTrue();\n+  });\n+});"
        },
        {
            "sha": "b48adc87bdb2816e276c6a2ce71cca59b29db2b9",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/183fb7e7b92c361e324dbbea73af435bebe9a0d9/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=183fb7e7b92c361e324dbbea73af435bebe9a0d9",
            "patch": "@@ -120,3 +120,19 @@ export function create(info: ts.server.PluginCreateInfo): ts.LanguageService {\n     getCompletionEntrySymbol,\n   };\n }\n+\n+export function getExternalFiles(project: ts.server.Project): string[] {\n+  if (!project.hasRoots()) {\n+    return [];  // project has not been initialized\n+  }\n+  const typecheckFiles: string[] = [];\n+  for (const scriptInfo of project.getScriptInfos()) {\n+    if (scriptInfo.scriptKind === ts.ScriptKind.External) {\n+      // script info for typecheck file is marked as external, see\n+      // getOrCreateTypeCheckScriptInfo() in\n+      // packages/language-service/ivy/language_service.ts\n+      typecheckFiles.push(scriptInfo.fileName);\n+    }\n+  }\n+  return typecheckFiles;\n+}"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 53,
        "deletions": 6
    }
}