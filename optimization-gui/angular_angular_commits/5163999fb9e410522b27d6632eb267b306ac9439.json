{
    "author": "atscott",
    "message": "test(router): Add tests to document expected behavior (#43449)\n\nPR #43102 broke some use-cases. These tests document expected behavior\nand would have prevented #43446 and #43447. Recent changes have already\naddressed these issues, but it would still be a good idea to cover these\nuse-cases in tests as well.\n\nPR Close #43449",
    "sha": "5163999fb9e410522b27d6632eb267b306ac9439",
    "files": [
        {
            "sha": "3f2c909b52b8c6464162ebbf174eb57891d5d335",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/5163999fb9e410522b27d6632eb267b306ac9439/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5163999fb9e410522b27d6632eb267b306ac9439/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=5163999fb9e410522b27d6632eb267b306ac9439",
            "patch": "@@ -1288,23 +1288,16 @@ describe('Integration', () => {\n          const fixture = createRoot(router, RootCmp);\n \n          router.resetConfig([\n-           {path: 'blocked', component: SimpleCmp, canActivate: [RedirectingGuard]},\n+           {path: 'blocked', component: BlankCmp, canActivate: [RedirectingGuard]},\n            {path: 'simple', component: SimpleCmp}\n          ]);\n          router.navigateByUrl('/simple');\n          advance(fixture);\n \n-         const recordedEvents = [] as Event[];\n-         router.events.forEach(e => onlyNavigationStartAndEnd(e) && recordedEvents.push(e));\n-\n          location.simulateHashChange('/blocked');\n \n          advance(fixture);\n-         expectEvents(recordedEvents, [\n-           [NavigationStart, '/blocked'],\n-           [NavigationStart, '/simple'],\n-           [NavigationEnd, '/simple'],\n-         ]);\n+         expect(fixture.nativeElement.innerHTML).toContain('simple');\n        }));\n   });\n "
        },
        {
            "sha": "0137504214349af1f7dff356d6df89cc91db4728",
            "filename": "packages/router/test/regression_integration.spec.ts",
            "status": "modified",
            "additions": 75,
            "deletions": 6,
            "changes": 81,
            "blob_url": "https://github.com/angular/angular/blob/5163999fb9e410522b27d6632eb267b306ac9439/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/5163999fb9e410522b27d6632eb267b306ac9439/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts?ref=5163999fb9e410522b27d6632eb267b306ac9439",
            "patch": "@@ -8,10 +8,12 @@\n \n import {CommonModule, Location} from '@angular/common';\n import {SpyLocation} from '@angular/common/testing';\n-import {ChangeDetectionStrategy, ChangeDetectorRef, Component, NgModule, TemplateRef, Type, ViewChild, ViewContainerRef} from '@angular/core';\n+import {ChangeDetectionStrategy, ChangeDetectorRef, Component, Injectable, NgModule, TemplateRef, Type, ViewChild, ViewContainerRef} from '@angular/core';\n import {ComponentFixture, fakeAsync, TestBed, tick} from '@angular/core/testing';\n-import {Router} from '@angular/router';\n+import {Resolve, Router} from '@angular/router';\n import {RouterTestingModule} from '@angular/router/testing';\n+import {of} from 'rxjs';\n+import {delay, mapTo} from 'rxjs/operators';\n \n describe('Integration', () => {\n   describe('routerLinkActive', () => {\n@@ -238,13 +240,16 @@ describe('Integration', () => {\n          @Component({template: 'simple'})\n          class SimpleCmp {\n          }\n+         @Component({template: 'one'})\n+         class OneCmp {\n+         }\n \n          TestBed.configureTestingModule({\n            imports: [RouterTestingModule.withRoutes([\n              {path: '', component: SimpleCmp},\n-             {path: 'one', component: SimpleCmp, canActivate: ['returnRootUrlTree']}\n+             {path: 'one', component: OneCmp, canActivate: ['returnRootUrlTree']}\n            ])],\n-           declarations: [SimpleCmp, RootCmp],\n+           declarations: [SimpleCmp, RootCmp, OneCmp],\n            providers: [\n              {\n                provide: 'returnRootUrlTree',\n@@ -267,8 +272,72 @@ describe('Integration', () => {\n          advance(fixture);\n \n          expect(location.path()).toEqual('/');\n-         const urlChanges = ['replace: /', 'hash: /one', 'replace: /'];\n-         expect(location.urlChanges).toEqual(urlChanges);\n+         expect(fixture.nativeElement.innerHTML).toContain('one');\n+       }));\n+  });\n+\n+  describe('duplicate navigation handling (#43447, #43446)', () => {\n+    let location: SpyLocation;\n+    let router: Router;\n+    let fixture: ComponentFixture<{}>;\n+\n+    beforeEach(fakeAsync(() => {\n+      @Injectable()\n+      class DelayedResolve implements Resolve<{}> {\n+        resolve() {\n+          return of('').pipe(delay(1000), mapTo(true));\n+        }\n+      }\n+      @Component({selector: 'root-cmp', template: `<router-outlet></router-outlet>`})\n+      class RootCmp {\n+      }\n+\n+      @Component({template: 'simple'})\n+      class SimpleCmp {\n+      }\n+      @Component({template: 'one'})\n+      class OneCmp {\n+      }\n+      TestBed.configureTestingModule({\n+        imports: [RouterTestingModule.withRoutes(\n+            [\n+              {path: '', component: SimpleCmp},\n+              {path: 'one', component: OneCmp, resolve: {x: DelayedResolve}}\n+            ],\n+            {useHash: true})],\n+        declarations: [SimpleCmp, RootCmp, OneCmp],\n+        providers: [DelayedResolve],\n+      });\n+\n+      router = TestBed.inject(Router);\n+      location = TestBed.inject(Location) as SpyLocation;\n+\n+      router.navigateByUrl('/');\n+      // Will setup location change listeners\n+      fixture = createRoot(router, RootCmp);\n+    }));\n+\n+    it('duplicate navigation to same url', fakeAsync(() => {\n+         location.simulateHashChange('/one');\n+         tick(100);\n+         location.simulateHashChange('/one');\n+         tick(1000);\n+         advance(fixture);\n+\n+         expect(location.path()).toEqual('/one');\n+         expect(fixture.nativeElement.innerHTML).toContain('one');\n+       }));\n+\n+    it('works with a duplicate popstate/hashchange navigation (as seen in firefox)',\n+       fakeAsync(() => {\n+         (location as any)._subject.emit({'url': 'one', 'pop': true, 'type': 'popstate'});\n+         tick(1);\n+         (location as any)._subject.emit({'url': 'one', 'pop': true, 'type': 'hashchange'});\n+         tick(1000);\n+         advance(fixture);\n+\n+         expect(router.routerState.toString()).toContain(`url:'one'`);\n+         expect(fixture.nativeElement.innerHTML).toContain('one');\n        }));\n   });\n });"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 77,
        "deletions": 15
    }
}