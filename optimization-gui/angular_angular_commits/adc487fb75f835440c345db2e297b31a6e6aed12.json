{
    "author": "dario-piotrowicz",
    "message": "fix(animations): apply setStyles to only rootTimelines (#44515)\n\nduring keyframe building only consider the root element's timelines\nfor the style setting, so that the states styles (applied with '*')\ncan be applied correctly\n\nresolves #32133\nresolves #28654\n\nPR Close #44515",
    "sha": "adc487fb75f835440c345db2e297b31a6e6aed12",
    "files": [
        {
            "sha": "7db64525c860bc68cc9a5a0af9deb2b0a2fe3631",
            "filename": "packages/animations/browser/src/dsl/animation_timeline_builder.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/adc487fb75f835440c345db2e297b31a6e6aed12/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_timeline_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/adc487fb75f835440c345db2e297b31a6e6aed12/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_timeline_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Fdsl%2Fanimation_timeline_builder.ts?ref=adc487fb75f835440c345db2e297b31a6e6aed12",
            "patch": "@@ -130,10 +130,22 @@ export class AnimationTimelineBuilderVisitor implements AstVisitor {\n \n     // this checks to see if an actual animation happened\n     const timelines = context.timelines.filter(timeline => timeline.containsAnimation());\n-    if (timelines.length && Object.keys(finalStyles).length) {\n-      const tl = timelines[timelines.length - 1];\n-      if (!tl.allowOnlyTimelineStyles()) {\n-        tl.setStyles([finalStyles], null, context.errors, options);\n+\n+    if (Object.keys(finalStyles).length) {\n+      // note: we just want to apply the final styles for the rootElement, so we do not\n+      //       just apply the styles to the last timeline but the last timeline which\n+      //       element is the root one (basically `*`-styles are replaced with the actual\n+      //       state style values only for the root element)\n+      let lastRootTimeline: TimelineBuilder|undefined;\n+      for (let i = timelines.length - 1; i >= 0; i--) {\n+        const timeline = timelines[i];\n+        if (timeline.element === rootElement) {\n+          lastRootTimeline = timeline;\n+          break;\n+        }\n+      }\n+      if (lastRootTimeline && !lastRootTimeline.allowOnlyTimelineStyles()) {\n+        lastRootTimeline.setStyles([finalStyles], null, context.errors, options);\n       }\n     }\n "
        },
        {
            "sha": "7d38041bd325edc853cbd2663d6d38c9b013ed16",
            "filename": "packages/core/test/animation/animation_query_integration_spec.ts",
            "status": "modified",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/angular/angular/blob/adc487fb75f835440c345db2e297b31a6e6aed12/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_query_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/adc487fb75f835440c345db2e297b31a6e6aed12/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_query_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_query_integration_spec.ts?ref=adc487fb75f835440c345db2e297b31a6e6aed12",
            "patch": "@@ -3393,6 +3393,128 @@ describe('animation query tests', function() {\n          children = fixture.debugElement.nativeElement.querySelectorAll('.child');\n          expect(children.length).toEqual(0);\n        }));\n+\n+    it('should correctly animate state styles of the root element applied via animate inside a group (independently of the order)',\n+       () => {\n+         @Component({\n+        selector: 'cmp',\n+        template: `\n+          <div class=\"parent\" [@parent]=\"exp\">\n+            <div class=\"child\" *ngIf=\"exp\"></div>\n+          </div>\n+        `,\n+        animations: [\n+          trigger('parent', [\n+            state('true', style({ backgroundColor: 'red' })),\n+            state('false', style({ backgroundColor: 'blue' })),\n+            transition('true <=> false', [\n+              group([\n+                animate(500),\n+                query(':leave', [\n+                  animate(500, style({ opacity: 0 }))\n+                ], { optional: true }),\n+                query(':enter', [\n+                  style({ opacity: 0 }),\n+                  animate(500, style({ opacity: '*' }))\n+                ], { optional: true }),\n+              ])\n+            ])\n+          ])\n+        ]\n+      })\n+      class Cmp {\n+           public exp = true;\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [Cmp]});\n+\n+         const fixture = TestBed.createComponent(Cmp);\n+         const cmp = fixture.componentInstance;\n+         fixture.detectChanges();\n+\n+         cmp.exp = false;\n+         fixture.detectChanges();\n+\n+         const players = getLog();\n+         expect(players.length).toEqual(3);\n+         // players:\n+         //  - _pp1 (parent player 1): player for parent animation (from background red to red)\n+         //  - pp2 (parent player 2): player for parent animation (from background red to blue)\n+         //  - _cp (child player): player for child animation (from current opacity to 0)\n+         const [_pp1, pp2, _cp] = players;\n+\n+         expect(pp2.element.classList.contains('parent')).toBeTruthy();\n+         const expectedKeyframes = [\n+           {backgroundColor: 'red', offset: 0},\n+           {\n+             backgroundColor:\n+                 'blue',  // note: this test's purpose is to make sure that this is not '*'\n+             offset: 1\n+           },\n+         ];\n+         expect(pp2.keyframes).toEqual(expectedKeyframes);\n+       });\n+\n+    it('should correctly animate state styles of the root element applied via animate inside a sequence (independently of the order)',\n+       () => {\n+         @Component({\n+        selector: 'cmp',\n+        template: `\n+          <div class=\"parent\" [@parent]=\"exp\">\n+            <div class=\"child\" *ngIf=\"exp\"></div>\n+          </div>\n+        `,\n+        animations: [\n+          trigger('parent', [\n+            state('true', style({ backgroundColor: 'red' })),\n+            state('false', style({ backgroundColor: 'blue' })),\n+            transition('true <=> false', [\n+              sequence([\n+                query(':enter', [\n+                  style({ opacity: 0 }),\n+                  animate(500, style({ opacity: '*' }))\n+                ], { optional: true }),\n+                animate(500),\n+                query(':leave', [\n+                  animate(500, style({ opacity: 0 }))\n+                ], { optional: true }),\n+              ])\n+            ])\n+          ])\n+        ]\n+      })\n+      class Cmp {\n+           public exp = false;\n+         }\n+\n+         TestBed.configureTestingModule({declarations: [Cmp]});\n+\n+         const fixture = TestBed.createComponent(Cmp);\n+         const cmp = fixture.componentInstance;\n+         fixture.detectChanges();\n+\n+         cmp.exp = true;\n+         fixture.detectChanges();\n+\n+         const players = getLog();\n+         expect(players.length).toEqual(3);\n+         // players:\n+         //  - _pp1 (parent player 1): player for parent animation (from background blue to blue)\n+         //  - _cp (child player): player for child animation (from opacity 0 to *)\n+         //  - pp2 (parent player 2): player for parent animation (from background blue to red)\n+         const [_pp1, _cp, pp2] = players;\n+\n+         expect(pp2.element.classList.contains('parent')).toBeTruthy();\n+         const expectedKeyframes = [\n+           {backgroundColor: 'blue', offset: 0},\n+           {\n+             backgroundColor:\n+                 'red',  // note: this test's purpose is to make sure that this is not '*'\n+             offset: 1\n+           },\n+         ];\n+         expect(pp2.keyframes).toEqual(expectedKeyframes);\n+       });\n   });\n \n   describe('animation control flags', () => {"
        }
    ],
    "stats": {
        "total": 142,
        "additions": 138,
        "deletions": 4
    }
}