{
    "author": "matsko",
    "message": "fix(animations): properly track listeners for a removed element (#40712)\n\nPrior to this patch, if an element was removed multiple times (due\nto the nature of parent/child elements), the leave listeners may\nhave been fired for an element that was already removed. This patch\nadds a guard within the animations code to prevent this.\n\nPR Close #40712",
    "sha": "4ce44eac3389f2c36972b0d8ce341e59042a5fd6",
    "files": [
        {
            "sha": "d6f7547991803d2dcbc184dee4b34b9c68c37b20",
            "filename": "packages/animations/browser/src/render/transition_animation_engine.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/4ce44eac3389f2c36972b0d8ce341e59042a5fd6/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts",
            "raw_url": "https://github.com/angular/angular/raw/4ce44eac3389f2c36972b0d8ce341e59042a5fd6/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fanimations%2Fbrowser%2Fsrc%2Frender%2Ftransition_animation_engine.ts?ref=4ce44eac3389f2c36972b0d8ce341e59042a5fd6",
            "patch": "@@ -370,7 +370,11 @@ export class AnimationTransitionNamespace {\n \n   prepareLeaveAnimationListeners(element: any) {\n     const listeners = this._elementListeners.get(element);\n-    if (listeners) {\n+    const elementStates = this._engine.statesByElement.get(element);\n+\n+    // if this statement fails then it means that the element was picked up\n+    // by an earlier flush (or there are no listeners at all to track the leave).\n+    if (listeners && elementStates) {\n       const visitedTriggers = new Set<string>();\n       listeners.forEach(listener => {\n         const triggerName = listener.name;\n@@ -379,7 +383,6 @@ export class AnimationTransitionNamespace {\n \n         const trigger = this._triggers[triggerName];\n         const transition = trigger.fallbackTransition;\n-        const elementStates = this._engine.statesByElement.get(element)!;\n         const fromState = elementStates[triggerName] || DEFAULT_STATE_VALUE;\n         const toState = new StateValue(VOID_VALUE);\n         const player = new TransitionAnimationPlayer(this.id, triggerName, element);\n@@ -400,7 +403,6 @@ export class AnimationTransitionNamespace {\n \n   removeNode(element: any, context: any): void {\n     const engine = this._engine;\n-\n     if (element.childElementCount) {\n       this._signalRemovalForInnerTriggers(element, context);\n     }"
        },
        {
            "sha": "bc4e911b9e64f430510aff951756d00f3a4fbf8e",
            "filename": "packages/core/test/acceptance/integration_spec.ts",
            "status": "modified",
            "additions": 219,
            "deletions": 1,
            "changes": 220,
            "blob_url": "https://github.com/angular/angular/blob/4ce44eac3389f2c36972b0d8ce341e59042a5fd6/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4ce44eac3389f2c36972b0d8ce341e59042a5fd6/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fintegration_spec.ts?ref=4ce44eac3389f2c36972b0d8ce341e59042a5fd6",
            "patch": "@@ -5,12 +5,16 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {animate, AnimationEvent, state, style, transition, trigger} from '@angular/animations';\n+import {AnimationDriver} from '@angular/animations/browser';\n+import {MockAnimationDriver, MockAnimationPlayer} from '@angular/animations/browser/testing';\n import {CommonModule} from '@angular/common';\n import {Component, ContentChild, Directive, ElementRef, EventEmitter, HostBinding, HostListener, Input, NgModule, OnInit, Output, Pipe, QueryList, TemplateRef, ViewChild, ViewChildren, ViewContainerRef} from '@angular/core';\n+import {Inject} from '@angular/core/src/di';\n import {TVIEW} from '@angular/core/src/render3/interfaces/view';\n import {getLView} from '@angular/core/src/render3/state';\n import {ngDevModeResetPerfCounters} from '@angular/core/src/util/ng_dev_mode';\n-import {TestBed} from '@angular/core/testing';\n+import {fakeAsync, flushMicrotasks, TestBed} from '@angular/core/testing';\n import {By} from '@angular/platform-browser';\n import {expect} from '@angular/platform-browser/testing/src/matchers';\n import {ivyEnabled, onlyInIvy} from '@angular/private/testing';\n@@ -2017,4 +2021,218 @@ describe('acceptance integration tests', () => {\n               assertAttrValues(elements[2], 'post-update-pass');\n             });\n   });\n+\n+  describe('animations', () => {\n+    it('should apply triggers for a list of items when they are sorted and reSorted',\n+       fakeAsync(() => {\n+         interface Item {\n+           value: any;\n+           id: number;\n+         }\n+\n+         @Component({\n+           template: `\n+          <div *ngIf=\"showWarningMessage; else listOfItems\">\n+            Nooo!\n+          </div>\n+\n+          <ng-template #listOfItems>\n+            <animation-comp *ngFor=\"let item of items; trackBy: itemTrackFn\">\n+              {{ item.value }}\n+            </animation-comp>\n+          </ng-template>\n+        `\n+         })\n+         class Cmp {\n+           showWarningMessage = false;\n+\n+           items: Item[] = [\n+             {value: 1, id: 1},\n+             {value: 2, id: 2},\n+             {value: 3, id: 3},\n+             {value: 4, id: 4},\n+             {value: 5, id: 5},\n+           ];\n+\n+           itemTrackFn(value: Item) {\n+             return value.id;\n+           }\n+         }\n+\n+         @Component({\n+           selector: 'animation-comp',\n+           animations: [\n+             trigger(\n+                 'host',\n+                 [\n+                   state('void', style({height: '0px'})),\n+                   transition(\n+                       '* => *',\n+                       [\n+                         animate('1s'),\n+                       ]),\n+                 ]),\n+           ],\n+           template: `\n+                  <ng-content></ng-content>\n+                `\n+         })\n+         class AnimationComp {\n+           @HostBinding('@host') public hostState = '';\n+\n+           @HostListener('@host.start', ['$event'])\n+           onLeaveStart(event: AnimationEvent) {\n+             // we just want to register the listener\n+           }\n+         }\n+\n+         TestBed.configureTestingModule({\n+           declarations: [Cmp, AnimationComp],\n+           providers: [{provide: AnimationDriver, useClass: MockAnimationDriver}],\n+         });\n+         const fixture = TestBed.createComponent(Cmp);\n+         fixture.detectChanges();\n+\n+         let elements = queryAll(fixture.nativeElement, 'animation-comp');\n+         expect(elements.length).toEqual(5);\n+         expect(elements.map(e => e.textContent?.trim())).toEqual(['1', '2', '3', '4', '5']);\n+\n+         const items = fixture.componentInstance.items;\n+         arraySwap(items, 2, 0);  // 3 2 1 4 5\n+         arraySwap(items, 2, 1);  // 3 1 2 4 5\n+         const first = items.shift()!;\n+         items.push(first);  // 1 2 4 5 3\n+         fixture.detectChanges();\n+\n+         elements = queryAll(fixture.nativeElement, 'animation-comp');\n+         expect(elements.length).toEqual(5);\n+         expect(elements.map(e => e.textContent?.trim())).toEqual(['1', '2', '4', '5', '3']);\n+         completeAnimations();\n+\n+         fixture.componentInstance.showWarningMessage = true;\n+         fixture.detectChanges();\n+         completeAnimations();\n+\n+         elements = queryAll(fixture.nativeElement, 'animation-comp');\n+         expect(elements.length).toEqual(0);\n+         expect(fixture.nativeElement.textContent.trim()).toEqual('Nooo!');\n+\n+         fixture.componentInstance.showWarningMessage = false;\n+         fixture.detectChanges();\n+\n+         elements = queryAll(fixture.nativeElement, 'animation-comp');\n+         expect(elements.length).toEqual(5);\n+       }));\n+\n+    it('should insert and remove views in the correct order when animations are present',\n+       fakeAsync(() => {\n+         @Component({\n+           animations: [\n+             trigger('root', [transition('* => *', [])]),\n+             trigger('outer', [transition('* => *', [])]),\n+             trigger('inner', [transition('* => *', [])]),\n+           ],\n+           template: `\n+          <div *ngIf=\"showRoot\" (@root.start)=\"track('root', $event)\" @root>\n+            <div *ngIf=\"showIfContents; else innerCompList\" (@outer.start)=\"track('outer', $event)\" @outer>\n+              Nooo!\n+            </div>\n+\n+            <ng-template #innerCompList>\n+              <inner-comp *ngFor=\"let item of items; trackBy: itemTrackFn\" (@inner.start)=\"track('inner', $event)\" @inner>\n+                {{ item.value }}\n+              </inner-comp>\n+            </ng-template>\n+          </div>\n+        `\n+         })\n+         class Cmp {\n+           showRoot = true;\n+           showIfContents = true;\n+           items = [1];\n+           log: string[] = [];\n+\n+           track(name: string, event: AnimationEvent) {\n+             this.log.push(name);\n+           }\n+         }\n+\n+         @Component({\n+           selector: 'inner-comp',\n+           animations: [\n+             trigger('host', [transition('* => *', [])]),\n+           ],\n+           template: `\n+                  <ng-content></ng-content>\n+                `\n+         })\n+         class InnerComp {\n+           @HostBinding('@host') public hostState = '';\n+\n+           constructor(@Inject(Cmp) private parent: Cmp) {}\n+\n+           @HostListener('@host.start', ['$event'])\n+           onLeaveStart(event: AnimationEvent) {\n+             this.parent.log.push('host');\n+           }\n+         }\n+\n+         TestBed.configureTestingModule({\n+           declarations: [Cmp, InnerComp],\n+           providers: [{provide: AnimationDriver, useClass: MockAnimationDriver}],\n+         });\n+         const fixture = TestBed.createComponent(Cmp);\n+         fixture.detectChanges();\n+         completeAnimations();\n+\n+         const comp = fixture.componentInstance;\n+         expect(comp.log).toEqual([\n+           'root',   // insertion of the inner-comp content\n+           'outer',  // insertion of the default ngIf\n+         ]);\n+\n+         comp.log = [];\n+         comp.showIfContents = false;\n+         fixture.detectChanges();\n+         completeAnimations();\n+\n+         expect(comp.log).toEqual([\n+           'host',   // insertion of the inner-comp content\n+           'outer',  // insertion of the template into the ngIf\n+           'inner'   // insertion of the inner comp element\n+         ]);\n+\n+         comp.log = [];\n+         comp.showRoot = false;\n+         fixture.detectChanges();\n+         completeAnimations();\n+\n+         expect(comp.log).toEqual([\n+           'root',  // removal the root div container\n+           'host',  // removal of the inner-comp content\n+           'inner'  // removal of the inner comp element\n+         ]);\n+       }));\n+  });\n });\n+\n+function completeAnimations() {\n+  flushMicrotasks();\n+  const log = MockAnimationDriver.log as MockAnimationPlayer[];\n+  log.forEach(player => player.finish());\n+  flushMicrotasks();\n+}\n+\n+function arraySwap(arr: any[], indexA: number, indexB: number): void {\n+  const item = arr[indexA];\n+  arr[indexA] = arr[indexB];\n+  arr[indexB] = item;\n+}\n+\n+/**\n+ * Queries the provided `root` element for sub elements by the selector and casts the result as an\n+ * array of elements\n+ */\n+function queryAll(root: HTMLElement, selector: string): HTMLElement[] {\n+  return Array.from(root.querySelectorAll(selector));\n+}"
        },
        {
            "sha": "a73d1539773b08baed3fcfb453eb0c3f808330c2",
            "filename": "packages/core/test/animation/animation_integration_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/4ce44eac3389f2c36972b0d8ce341e59042a5fd6/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_integration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/4ce44eac3389f2c36972b0d8ce341e59042a5fd6/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_integration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fanimation%2Fanimation_integration_spec.ts?ref=4ce44eac3389f2c36972b0d8ce341e59042a5fd6",
            "patch": "@@ -8,7 +8,6 @@\n import {animate, animateChild, AnimationEvent, AnimationOptions, AUTO_STYLE, group, keyframes, query, state, style, transition, trigger, ɵPRE_STYLE as PRE_STYLE} from '@angular/animations';\n import {AnimationDriver, ɵAnimationEngine, ɵNoopAnimationDriver as NoopAnimationDriver} from '@angular/animations/browser';\n import {MockAnimationDriver, MockAnimationPlayer} from '@angular/animations/browser/testing';\n-import {ɵgetDOM as getDOM} from '@angular/common';\n import {ChangeDetectorRef, Component, HostBinding, HostListener, Inject, RendererFactory2, ViewChild} from '@angular/core';\n import {fakeAsync, flushMicrotasks, TestBed} from '@angular/core/testing';\n import {ɵDomRendererFactory2} from '@angular/platform-browser';"
        }
    ],
    "stats": {
        "total": 229,
        "additions": 224,
        "deletions": 5
    }
}