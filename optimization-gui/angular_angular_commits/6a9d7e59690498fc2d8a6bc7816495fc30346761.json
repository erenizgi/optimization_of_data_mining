{
    "author": "bjarkler",
    "message": "refactor(core): express trusted constants with tagged template literals (#40082)\n\nThe trustConstantHtml and trustConstantResourceUrl functions are only\nmeant to be passed constant strings extracted from Angular application\ntemplates, as passing other strings or variables could introduce XSS\nvulnerabilities.\n\nTo better protect these APIs, turn them into template tags. This makes\nit possible to assert that the associated template literals do not\ncontain any interpolation, and thus must be constant.\n\nAlso add tests for the change to prevent regression.\n\nPR Close #40082",
    "sha": "6a9d7e59690498fc2d8a6bc7816495fc30346761",
    "files": [
        {
            "sha": "4b24ff82d199979501eceedcf2724187ae24314b",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/elements/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FGOLDEN_PARTIAL.js?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -555,3 +555,64 @@ export declare class MyModule {\n     static ɵinj: i0.ɵɵInjectorDef<MyModule>;\n }\n \n+/****************************************************************************************************\n+ * PARTIAL FILE: security_sensitive_constant_attributes.js\n+ ****************************************************************************************************/\n+import { Component, NgModule } from '@angular/core';\n+import * as i0 from \"@angular/core\";\n+export class MyComponent {\n+}\n+MyComponent.ɵfac = function MyComponent_Factory(t) { return new (t || MyComponent)(); };\n+MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: { source: `\n+    <!-- A couple of security-sensitive attributes with constant values -->\n+    <embed src=\"https://angular.io/\" />\n+    <iframe srcdoc=\"<h1>Angular</h1>\"></iframe>\n+    <object data=\"https://angular.io/\" codebase=\"/\"></object>\n+\n+    <!-- Repeated element to make sure attribute deduplication works properly -->\n+    <embed src=\"https://angular.io/\" />\n+\n+    <!-- Another element with a src attribute that is not security sensitive -->\n+    <img src=\"https://angular.io/\" />\n+  `, isInline: true } });\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyComponent, [{\n+        type: Component,\n+        args: [{\n+                selector: 'my-component',\n+                template: `\n+    <!-- A couple of security-sensitive attributes with constant values -->\n+    <embed src=\"https://angular.io/\" />\n+    <iframe srcdoc=\"<h1>Angular</h1>\"></iframe>\n+    <object data=\"https://angular.io/\" codebase=\"/\"></object>\n+\n+    <!-- Repeated element to make sure attribute deduplication works properly -->\n+    <embed src=\"https://angular.io/\" />\n+\n+    <!-- Another element with a src attribute that is not security sensitive -->\n+    <img src=\"https://angular.io/\" />\n+  `\n+            }]\n+    }], null, null); })();\n+export class MyModule {\n+}\n+MyModule.ɵmod = i0.ɵɵdefineNgModule({ type: MyModule });\n+MyModule.ɵinj = i0.ɵɵdefineInjector({ factory: function MyModule_Factory(t) { return new (t || MyModule)(); } });\n+(function () { (typeof ngJitMode === \"undefined\" || ngJitMode) && i0.ɵɵsetNgModuleScope(MyModule, { declarations: [MyComponent] }); })();\n+(function () { (typeof ngDevMode === \"undefined\" || ngDevMode) && i0.ɵsetClassMetadata(MyModule, [{\n+        type: NgModule,\n+        args: [{ declarations: [MyComponent] }]\n+    }], null, null); })();\n+\n+/****************************************************************************************************\n+ * PARTIAL FILE: security_sensitive_constant_attributes.d.ts\n+ ****************************************************************************************************/\n+import * as i0 from \"@angular/core\";\n+export declare class MyComponent {\n+    static ɵfac: i0.ɵɵFactoryDef<MyComponent, never>;\n+    static ɵcmp: i0.ɵɵComponentDefWithMeta<MyComponent, \"my-component\", never, {}, {}, never, never>;\n+}\n+export declare class MyModule {\n+    static ɵmod: i0.ɵɵNgModuleDefWithMeta<MyModule, [typeof MyComponent], never, never>;\n+    static ɵinj: i0.ɵɵInjectorDef<MyModule>;\n+}\n+"
        },
        {
            "sha": "e8fdcfccbdf5558961d38086a2aa22308b14e70f",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/elements/TEST_CASES.json",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FTEST_CASES.json",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FTEST_CASES.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2FTEST_CASES.json?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -226,6 +226,17 @@\n           \"failureMessage\": \"Incorrect generated template.\"\n         }\n       ]\n+    },\n+    {\n+      \"description\": \"should specify security-sensitive constant attributes as template literals\",\n+      \"inputFiles\": [\n+        \"security_sensitive_constant_attributes.ts\"\n+      ],\n+      \"expectations\": [\n+        {\n+          \"failureMessage\": \"Incorrect generated template.\"\n+        }\n+      ]\n     }\n   ]\n }"
        },
        {
            "sha": "c4df9fcd411ef05277bd3af22eca72d6d004d93e",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/elements/deduplicate_attributes.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fdeduplicate_attributes.ts",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fdeduplicate_attributes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fdeduplicate_attributes.ts?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -12,4 +12,4 @@ export class MyComponent {\n \n @NgModule({declarations: [MyComponent]})\n export class MyModule {\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "eb77b0fdecef8ff2da4e0e57b4d05f2feb73a1da",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/elements/security_sensitive_constant_attributes.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fsecurity_sensitive_constant_attributes.js",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fsecurity_sensitive_constant_attributes.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fsecurity_sensitive_constant_attributes.js?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -0,0 +1,16 @@\n+consts: [\n+  [\"src\", i0.ɵɵtrustConstantResourceUrl `https://angular.io/`],\n+  [\"srcdoc\", i0.ɵɵtrustConstantHtml `<h1>Angular</h1>`],\n+  [\"data\", i0.ɵɵtrustConstantResourceUrl `https://angular.io/`, \"codebase\", i0.ɵɵtrustConstantResourceUrl `/`],\n+  [\"src\", \"https://angular.io/\"]\n+],\n+template: function MyComponent_Template(rf, ctx) {\n+  if (rf & 1) {\n+    $r3$.ɵɵelement(0, \"embed\", 0);\n+    $r3$.ɵɵelement(1, \"iframe\", 1);\n+    $r3$.ɵɵelement(2, \"object\", 2);\n+    $r3$.ɵɵelement(3, \"embed\", 0);\n+    $r3$.ɵɵelement(4, \"img\", 3);\n+  }\n+  …\n+}"
        },
        {
            "sha": "45d01e41493d2b51c39ceb13956834c0739ec612",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_compiler_compliance/elements/security_sensitive_constant_attributes.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fsecurity_sensitive_constant_attributes.ts",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fsecurity_sensitive_constant_attributes.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_compiler_compliance%2Felements%2Fsecurity_sensitive_constant_attributes.ts?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -0,0 +1,23 @@\n+import {Component, NgModule} from '@angular/core';\n+\n+@Component({\n+  selector: 'my-component',\n+  template: `\n+    <!-- A couple of security-sensitive attributes with constant values -->\n+    <embed src=\"https://angular.io/\" />\n+    <iframe srcdoc=\"<h1>Angular</h1>\"></iframe>\n+    <object data=\"https://angular.io/\" codebase=\"/\"></object>\n+\n+    <!-- Repeated element to make sure attribute deduplication works properly -->\n+    <embed src=\"https://angular.io/\" />\n+\n+    <!-- Another element with a src attribute that is not security sensitive -->\n+    <img src=\"https://angular.io/\" />\n+  `\n+})\n+export class MyComponent {\n+}\n+\n+@NgModule({declarations: [MyComponent]})\n+export class MyModule {\n+}"
        },
        {
            "sha": "e5fafe611f4fd142973a05762e4fb43db3dd01d5",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -2193,10 +2193,16 @@ function trustedConstAttribute(tagName: string, attr: t.TextAttribute): o.Expres\n   if (isTrustedTypesSink(tagName, attr.name)) {\n     switch (elementRegistry.securityContext(tagName, attr.name, /* isAttribute */ true)) {\n       case core.SecurityContext.HTML:\n-        return o.importExpr(R3.trustConstantHtml).callFn([value], attr.valueSpan);\n+        return o.taggedTemplate(\n+            o.importExpr(R3.trustConstantHtml),\n+            new o.TemplateLiteral([new o.TemplateLiteralElement(attr.value)], []), undefined,\n+            attr.valueSpan);\n       // NB: no SecurityContext.SCRIPT here, as the corresponding tags are stripped by the compiler.\n       case core.SecurityContext.RESOURCE_URL:\n-        return o.importExpr(R3.trustConstantResourceUrl).callFn([value], attr.valueSpan);\n+        return o.taggedTemplate(\n+            o.importExpr(R3.trustConstantResourceUrl),\n+            new o.TemplateLiteral([new o.TemplateLiteralElement(attr.value)], []), undefined,\n+            attr.valueSpan);\n       default:\n         return value;\n     }"
        },
        {
            "sha": "c30b079cd1d81cf74de5d7e08eb868aa2e5808af",
            "filename": "packages/core/src/sanitization/sanitization.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 8,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Fsanitization.ts?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -145,8 +145,10 @@ export function ɵɵsanitizeScript(unsafeScript: any): TrustedScript|string {\n }\n \n /**\n- * Promotes the given constant string to a TrustedHTML.\n- * @param html constant string containing trusted HTML.\n+ * A template tag function for promoting the associated constant literal to a\n+ * TrustedHTML. Interpolation is explicitly not allowed.\n+ *\n+ * @param html constant template literal containing trusted HTML.\n  * @returns TrustedHTML wrapping `html`.\n  *\n  * @security This is a security-sensitive function and should only be used to\n@@ -155,13 +157,24 @@ export function ɵɵsanitizeScript(unsafeScript: any): TrustedScript|string {\n  *\n  * @codeGenApi\n  */\n-export function ɵɵtrustConstantHtml(html: string): TrustedHTML|string {\n-  return trustedHTMLFromString(html);\n+export function ɵɵtrustConstantHtml(html: TemplateStringsArray): TrustedHTML|string {\n+  // The following runtime check ensures that the function was called as a\n+  // template tag (e.g. ɵɵtrustConstantHtml`content`), without any interpolation\n+  // (e.g. not ɵɵtrustConstantHtml`content ${variable}`). A TemplateStringsArray\n+  // is an array with a `raw` property that is also an array. The associated\n+  // template literal has no interpolation if and only if the length of the\n+  // TemplateStringsArray is 1.\n+  if (ngDevMode && (!Array.isArray(html) || !Array.isArray(html.raw) || html.length !== 1)) {\n+    throw new Error(`Unexpected interpolation in trusted HTML constant: ${html.join('?')}`);\n+  }\n+  return trustedHTMLFromString(html[0]);\n }\n \n /**\n- * Promotes the given constant string to a TrustedScriptURL.\n- * @param url constant string containing a trusted script URL.\n+ * A template tag function for promoting the associated constant literal to a\n+ * TrustedScriptURL. Interpolation is explicitly not allowed.\n+ *\n+ * @param url constant template literal containing a trusted script URL.\n  * @returns TrustedScriptURL wrapping `url`.\n  *\n  * @security This is a security-sensitive function and should only be used to\n@@ -170,8 +183,17 @@ export function ɵɵtrustConstantHtml(html: string): TrustedHTML|string {\n  *\n  * @codeGenApi\n  */\n-export function ɵɵtrustConstantResourceUrl(url: string): TrustedScriptURL|string {\n-  return trustedScriptURLFromString(url);\n+export function ɵɵtrustConstantResourceUrl(url: TemplateStringsArray): TrustedScriptURL|string {\n+  // The following runtime check ensures that the function was called as a\n+  // template tag (e.g. ɵɵtrustConstantResourceUrl`content`), without any\n+  // interpolation (e.g. not ɵɵtrustConstantResourceUrl`content ${variable}`). A\n+  // TemplateStringsArray is an array with a `raw` property that is also an\n+  // array. The associated template literal has no interpolation if and only if\n+  // the length of the TemplateStringsArray is 1.\n+  if (ngDevMode && (!Array.isArray(url) || !Array.isArray(url.raw) || url.length !== 1)) {\n+    throw new Error(`Unexpected interpolation in trusted URL constant: ${url.join('?')}`);\n+  }\n+  return trustedScriptURLFromString(url[0]);\n }\n \n /**"
        },
        {
            "sha": "2ce9a6447c210abb662f57e2d3b0c86e043f55f6",
            "filename": "packages/core/test/sanitization/sanitization_spec.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6a9d7e59690498fc2d8a6bc7816495fc30346761/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fsanitization%2Fsanitization_spec.ts?ref=6a9d7e59690498fc2d8a6bc7816495fc30346761",
            "patch": "@@ -12,7 +12,7 @@ import {LView} from '@angular/core/src/render3/interfaces/view';\n import {enterView, leaveView} from '@angular/core/src/render3/state';\n \n import {bypassSanitizationTrustHtml, bypassSanitizationTrustResourceUrl, bypassSanitizationTrustScript, bypassSanitizationTrustStyle, bypassSanitizationTrustUrl} from '../../src/sanitization/bypass';\n-import {getUrlSanitizer, ɵɵsanitizeHtml, ɵɵsanitizeResourceUrl, ɵɵsanitizeScript, ɵɵsanitizeStyle, ɵɵsanitizeUrl, ɵɵsanitizeUrlOrResourceUrl} from '../../src/sanitization/sanitization';\n+import {getUrlSanitizer, ɵɵsanitizeHtml, ɵɵsanitizeResourceUrl, ɵɵsanitizeScript, ɵɵsanitizeStyle, ɵɵsanitizeUrl, ɵɵsanitizeUrlOrResourceUrl, ɵɵtrustConstantHtml, ɵɵtrustConstantResourceUrl} from '../../src/sanitization/sanitization';\n import {SecurityContext} from '../../src/sanitization/security';\n \n function fakeLView(): LView {\n@@ -134,4 +134,13 @@ describe('sanitization', () => {\n     expect(ɵɵsanitizeUrlOrResourceUrl(bypassSanitizationTrustUrl('javascript:true'), 'a', 'href'))\n         .toEqual('javascript:true');\n   });\n+\n+  it('should only trust constant strings from template literal tags without interpolation', () => {\n+    expect(ɵɵtrustConstantHtml`<h1>good</h1>`.toString()).toEqual('<h1>good</h1>');\n+    expect(ɵɵtrustConstantResourceUrl`http://good.com`.toString()).toEqual('http://good.com');\n+    expect(() => (ɵɵtrustConstantHtml as any) `<h1>${'evil'}</h1>`)\n+        .toThrowError(/Unexpected interpolation in trusted HTML constant/);\n+    expect(() => (ɵɵtrustConstantResourceUrl as any) `http://${'evil'}.com`)\n+        .toThrowError(/Unexpected interpolation in trusted URL constant/);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 172,
        "additions": 160,
        "deletions": 12
    }
}