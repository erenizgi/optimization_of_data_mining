{
    "author": "petebacondarwin",
    "message": "build(docs-infra): fail if we attempt to autolink to a private doc (#40404)\n\nPreviously we only logged a warning if we attempted to auto-link\nto a doc that had no `path` property, which implies that it is private\nand is not rendered.\n\nNow we fail hard during full doc-gen, although when running the\n`yarn serv-and-sync` command it should not fail if changes are\nonly made to guides, which is what authors who use this tool\nare most likely to do.\n\nPR Close #40404",
    "sha": "a7a2123ade7ec71319b2df55ce64616a5aafe75f",
    "files": [
        {
            "sha": "4fcb0c46312d9012be91f01afdbddbb2fd645b68",
            "filename": "aio/tools/transforms/angular-base-package/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/a7a2123ade7ec71319b2df55ce64616a5aafe75f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/a7a2123ade7ec71319b2df55ce64616a5aafe75f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js?ref=a7a2123ade7ec71319b2df55ce64616a5aafe75f",
            "patch": "@@ -140,6 +140,7 @@ module.exports = new Package('angular-base', [\n   .config(function(postProcessHtml, addImageDimensions, autoLinkCode, filterPipes, filterAmbiguousDirectiveAliases, ignoreHttpInUrls, ignoreGenericWords) {\n     addImageDimensions.basePath = path.resolve(AIO_PATH, 'src');\n     autoLinkCode.customFilters = [ignoreGenericWords, ignoreHttpInUrls, filterPipes, filterAmbiguousDirectiveAliases];\n+    autoLinkCode.failOnMissingDocPath = true;\n     postProcessHtml.plugins = [\n       require('./post-processors/autolink-headings'),\n       addImageDimensions,"
        },
        {
            "sha": "91bfbf6330c3a59af189c8445f14898d11ffcc64",
            "filename": "aio/tools/transforms/angular-base-package/post-processors/auto-link-code.js",
            "status": "modified",
            "additions": 34,
            "deletions": 17,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/a7a2123ade7ec71319b2df55ce64616a5aafe75f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.js",
            "raw_url": "https://github.com/angular/angular/raw/a7a2123ade7ec71319b2df55ce64616a5aafe75f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.js?ref=a7a2123ade7ec71319b2df55ce64616a5aafe75f",
            "patch": "@@ -19,12 +19,23 @@ const textContent = require('hast-util-to-string');\n  * @property codeElements an array of strings.\n  * Only text contained in these elements will be linked to.\n  * Usually set to \"code\" but also \"code-example\" for angular.io.\n+ *\n+ * @property ignoredLanguages an array of languages that should not be auto-linked\n+ *\n+ * @property ignoredLanguages an array of languages that should not be auto-linked\n+ *\n+ * @property failOnMissingDocPath if set to true then this post-processor will cause the doc-gen\n+ * to fail when it attempts to auto-link to a doc that has no `doc.path` property, which implies\n+ * that it exists but is not public (nor rendered).\n+ *\n  */\n module.exports = function autoLinkCode(getDocFromAlias) {\n   autoLinkCodeImpl.docTypes = [];\n   autoLinkCodeImpl.customFilters = [];\n   autoLinkCodeImpl.codeElements = ['code'];\n   autoLinkCodeImpl.ignoredLanguages = ['bash', 'sh', 'shell', 'json', 'markdown'];\n+  autoLinkCodeImpl.failOnMissingDocPath = false;\n+\n   return autoLinkCodeImpl;\n \n   function autoLinkCodeImpl() {\n@@ -64,8 +75,10 @@ module.exports = function autoLinkCode(getDocFromAlias) {\n     // * do not have an ignored language\n     // * are not inside links\n     const isCodeElement = autoLinkCodeImpl.codeElements.some(elementType => is(node, elementType));\n-    const hasNoAutoLink = node.properties.className && node.properties.className.includes('no-auto-link');\n-    const isLanguageSupported = !autoLinkCodeImpl.ignoredLanguages.includes(node.properties.language);\n+    const hasNoAutoLink =\n+        node.properties.className && node.properties.className.includes('no-auto-link');\n+    const isLanguageSupported =\n+        !autoLinkCodeImpl.ignoredLanguages.includes(node.properties.language);\n     const isInLink = isInsideLink(ancestors);\n     return isCodeElement && !hasNoAutoLink && isLanguageSupported && !isInLink;\n   }\n@@ -76,19 +89,19 @@ module.exports = function autoLinkCode(getDocFromAlias) {\n \n   function getNodes(node, file) {\n     return textContent(node)\n-      .split(/([A-Za-z0-9_.-]+)/)\n-      .filter(word => word.length)\n-      .map((word, index, words) => {\n-        // remove docs that fail the custom filter tests\n-        const filteredDocs = autoLinkCodeImpl.customFilters.reduce(\n-            (docs, filter) => filter(docs, words, index), getDocFromAlias(word));\n-\n-        return foundValidDoc(filteredDocs, word, file) ?\n-            // Create a link wrapping the text node.\n-            createLinkNode(filteredDocs[0], word) :\n-            // this is just text so push a new text node\n-            {type: 'text', value: word};\n-      });\n+        .split(/([A-Za-z0-9_.-]+)/)\n+        .filter(word => word.length)\n+        .map((word, index, words) => {\n+          // remove docs that fail the custom filter tests\n+          const filteredDocs = autoLinkCodeImpl.customFilters.reduce(\n+              (docs, filter) => filter(docs, words, index), getDocFromAlias(word));\n+\n+          return foundValidDoc(filteredDocs, word, file) ?\n+              // Create a link wrapping the text node.\n+              createLinkNode(filteredDocs[0], word) :\n+              // this is just text so push a new text node\n+              {type: 'text', value: word};\n+        });\n   }\n \n   /**\n@@ -112,12 +125,16 @@ module.exports = function autoLinkCode(getDocFromAlias) {\n       return false;\n     }\n \n-    if (doc.path === '') {\n+    if (!doc.path) {\n       var message = `\n       autoLinkCode: Doc path is empty for \"${doc.id}\" - link will not be generated for \"${keyword}\".\n       Please make sure if the doc should be public. If not, it should probably not be referenced in the docs.`;\n \n-      file.message(message);\n+      if (autoLinkCodeImpl.failOnMissingDocPath) {\n+        file.fail(message);\n+      } else {\n+        file.message(message);\n+      }\n       return false;\n     }\n "
        },
        {
            "sha": "e36203a5af119fe33595a3935d729a32e5f70cd1",
            "filename": "aio/tools/transforms/angular-base-package/post-processors/auto-link-code.spec.js",
            "status": "modified",
            "additions": 24,
            "deletions": 12,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/a7a2123ade7ec71319b2df55ce64616a5aafe75f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/a7a2123ade7ec71319b2df55ce64616a5aafe75f/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fpost-processors%2Fauto-link-code.spec.js?ref=a7a2123ade7ec71319b2df55ce64616a5aafe75f",
            "patch": "@@ -2,7 +2,7 @@ var createTestPackage = require('../../helpers/test-package');\n var Dgeni = require('dgeni');\n \n describe('autoLinkCode post-processor', () => {\n-  let processor, autoLinkCode, aliasMap, filterPipes;\n+  let processor, autoLinkCode, aliasMap, filterPipes, log;\n \n   beforeEach(() => {\n     const testPackage = createTestPackage('angular-base-package');\n@@ -15,6 +15,7 @@ describe('autoLinkCode post-processor', () => {\n     processor.docTypes = ['test-doc'];\n     processor.plugins = [autoLinkCode];\n     filterPipes = injector.get('filterPipes');\n+    log = injector.get('log');\n   });\n \n   it('should insert an anchor into every code item that matches the id of an API doc', () => {\n@@ -126,19 +127,9 @@ describe('autoLinkCode post-processor', () => {\n     expect(doc.renderedContent).toEqual('<code>MyClass</code>');\n   });\n \n-  it('should ignore code items that match an API doc but have no path set',\n-     () => {\n-       aliasMap.addDoc(\n-           {docType: 'class', id: 'MyClass', aliases: ['MyClass'], path: ''});\n-       const doc = {docType: 'test-doc', renderedContent: '<code>MyClass</code>'};\n-       processor.$process([doc]);\n-       expect(doc.renderedContent).toEqual('<code>MyClass</code>');\n-     });\n-\n   it('should ignore documents when the `docType` is set to `member` and the keyword doesn\\'t include `.`',\n      () => {\n-       aliasMap.addDoc(\n-           {docType: 'member', id: 'MyEnum', aliases: ['MyEnum'], path: 'a/b/c'});\n+       aliasMap.addDoc({docType: 'member', id: 'MyEnum', aliases: ['MyEnum'], path: 'a/b/c'});\n        const doc = {docType: 'test-doc', renderedContent: '<code>MyEnum</code>'};\n        processor.$process([doc]);\n        expect(doc.renderedContent).toEqual('<code>MyEnum</code>');\n@@ -193,4 +184,25 @@ describe('autoLinkCode post-processor', () => {\n     processor.$process([doc]);\n     expect(doc.renderedContent).toEqual('<code language=\"bash\">MyClass</code>');\n   });\n+\n+  it('should record a warning if the autolinked doc has no `path` and `failOnMissingDocPath` is false',\n+     () => {\n+       aliasMap.addDoc({docType: 'class', id: 'MyClass', aliases: ['MyClass']});\n+       const doc = {docType: 'test-doc', renderedContent: '<code>MyClass</code>'};\n+       autoLinkCode.failOnMissingDocPath = false;\n+       processor.$process([doc]);\n+\n+       expect(log.warn).toHaveBeenCalledWith(`\n+      autoLinkCode: Doc path is empty for \"MyClass\" - link will not be generated for \"MyClass\".\n+      Please make sure if the doc should be public. If not, it should probably not be referenced in the docs. - doc (test-doc) `);\n+     });\n+\n+  it('should fail if the autolinked doc has no `path` and `failOnMissingDocPath` is true', () => {\n+    aliasMap.addDoc({docType: 'class', id: 'MyClass', aliases: ['MyClass']});\n+    const doc = {docType: 'test-doc', renderedContent: '<code>MyClass</code>'};\n+    autoLinkCode.failOnMissingDocPath = true;\n+    expect(() => processor.$process([doc])).toThrowError(`\n+      autoLinkCode: Doc path is empty for \"MyClass\" - link will not be generated for \"MyClass\".\n+      Please make sure if the doc should be public. If not, it should probably not be referenced in the docs. - doc (test-doc) `);\n+  });\n });"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 59,
        "deletions": 29
    }
}