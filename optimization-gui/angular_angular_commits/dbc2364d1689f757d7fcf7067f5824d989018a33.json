{
    "author": "devversion",
    "message": "fix(dev-infra): support running scripts from within a detached head (#37737)\n\nScripts provided in the `ng-dev` command might use local `git`\ncommands. For such scripts, we keep track of the branch that\nhas been checked out before the command has been invoked.\n\nWe do this so that we can later (upon command completion)\nrestore back to the original branch. We do not want to\nleave the Git repository in a dirty state.\n\nIt looks like this logic currently only deals with branches\nbut does not work properly when a command is invoked from\na detached head. We can make it work by just checking out\nthe previous revision (if no branch is checked out).\n\nPR Close #37737",
    "sha": "dbc2364d1689f757d7fcf7067f5824d989018a33",
    "files": [
        {
            "sha": "790d809438437b32f12d7a99cf47293c35023c42",
            "filename": "dev-infra/pr/discover-new-conflicts/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fdiscover-new-conflicts%2Findex.ts?ref=dbc2364d1689f757d7fcf7067f5824d989018a33",
            "patch": "@@ -63,8 +63,8 @@ export async function discoverNewConflictsForPr(\n     process.exit(1);\n   }\n \n-  /** The active github branch when the run began. */\n-  const originalBranch = git.getCurrentBranch();\n+  /** The active github branch or revision before we performed any Git commands. */\n+  const previousBranchOrRevision = git.getCurrentBranchOrRevision();\n   /* Progress bar to indicate progress. */\n   const progressBar = new Bar({format: `[{bar}] ETA: {eta}s | {value}/{total}`});\n   /* PRs which were found to be conflicting. */\n@@ -103,7 +103,7 @@ export async function discoverNewConflictsForPr(\n   const result = exec(`git rebase FETCH_HEAD`);\n   if (result.code) {\n     error('The requested PR currently has conflicts');\n-    cleanUpGitState(originalBranch);\n+    cleanUpGitState(previousBranchOrRevision);\n     process.exit(1);\n   }\n \n@@ -130,7 +130,7 @@ export async function discoverNewConflictsForPr(\n   info();\n   info(`Result:`);\n \n-  cleanUpGitState(originalBranch);\n+  cleanUpGitState(previousBranchOrRevision);\n \n   // If no conflicts are found, exit successfully.\n   if (conflicts.length === 0) {\n@@ -147,14 +147,14 @@ export async function discoverNewConflictsForPr(\n   process.exit(1);\n }\n \n-/** Reset git back to the provided branch. */\n-export function cleanUpGitState(branch: string) {\n+/** Reset git back to the provided branch or revision. */\n+export function cleanUpGitState(previousBranchOrRevision: string) {\n   // Ensure that any outstanding rebases are aborted.\n   exec(`git rebase --abort`);\n   // Ensure that any changes in the current repo state are cleared.\n   exec(`git reset --hard`);\n   // Checkout the original branch from before the run began.\n-  exec(`git checkout ${branch}`);\n+  exec(`git checkout ${previousBranchOrRevision}`);\n   // Delete the generated branch.\n   exec(`git branch -D ${tempWorkingBranch}`);\n }"
        },
        {
            "sha": "e304ed98bd294a8fc73dba4d8a953bd2a32e8937",
            "filename": "dev-infra/pr/merge/strategies/autosquash-merge.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fautosquash-merge.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fautosquash-merge.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fautosquash-merge.ts?ref=dbc2364d1689f757d7fcf7067f5824d989018a33",
            "patch": "@@ -59,7 +59,7 @@ export class AutosquashMergeStrategy extends MergeStrategy {\n     // is desired, we set the `GIT_SEQUENCE_EDITOR` environment variable to `true` so that\n     // the rebase seems interactive to Git, while it's not interactive to the user.\n     // See: https://github.com/git/git/commit/891d4a0313edc03f7e2ecb96edec5d30dc182294.\n-    const branchBeforeRebase = this.git.getCurrentBranch();\n+    const branchOrRevisionBeforeRebase = this.git.getCurrentBranchOrRevision();\n     const rebaseEnv =\n         needsCommitMessageFixup ? undefined : {...process.env, GIT_SEQUENCE_EDITOR: 'true'};\n     this.git.run(\n@@ -69,9 +69,9 @@ export class AutosquashMergeStrategy extends MergeStrategy {\n     // Update pull requests commits to reference the pull request. This matches what\n     // Github does when pull requests are merged through the Web UI. The motivation is\n     // that it should be easy to determine which pull request contained a given commit.\n-    // **Note**: The filter-branch command relies on the working tree, so we want to make\n-    // sure that we are on the initial branch where the merge script has been run.\n-    this.git.run(['checkout', '-f', branchBeforeRebase]);\n+    // Note: The filter-branch command relies on the working tree, so we want to make sure\n+    // that we are on the initial branch or revision where the merge script has been invoked.\n+    this.git.run(['checkout', '-f', branchOrRevisionBeforeRebase]);\n     this.git.run(\n         ['filter-branch', '-f', '--msg-filter', `${MSG_FILTER_SCRIPT} ${prNumber}`, revisionRange]);\n "
        },
        {
            "sha": "5a1778473865778cdb35d0210ba600a5ffb58234",
            "filename": "dev-infra/pr/merge/task.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Fmerge%2Ftask.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ftask.ts?ref=dbc2364d1689f757d7fcf7067f5824d989018a33",
            "patch": "@@ -87,14 +87,14 @@ export class PullRequestMergeTask {\n         new GithubApiMergeStrategy(this.git, this.config.githubApiMerge) :\n         new AutosquashMergeStrategy(this.git);\n \n-    // Branch that is currently checked out so that we can switch back to it once\n-    // the pull request has been merged.\n-    let previousBranch: null|string = null;\n+    // Branch or revision that is currently checked out so that we can switch back to\n+    // it once the pull request has been merged.\n+    let previousBranchOrRevision: null|string = null;\n \n     // The following block runs Git commands as child processes. These Git commands can fail.\n     // We want to capture these command errors and return an appropriate merge request status.\n     try {\n-      previousBranch = this.git.getCurrentBranch();\n+      previousBranchOrRevision = this.git.getCurrentBranchOrRevision();\n \n       // Run preparations for the merge (e.g. fetching branches).\n       await strategy.prepare(pullRequest);\n@@ -107,7 +107,7 @@ export class PullRequestMergeTask {\n \n       // Switch back to the previous branch. We need to do this before deleting the temporary\n       // branches because we cannot delete branches which are currently checked out.\n-      this.git.run(['checkout', '-f', previousBranch]);\n+      this.git.run(['checkout', '-f', previousBranchOrRevision]);\n \n       await strategy.cleanup(pullRequest);\n \n@@ -123,8 +123,8 @@ export class PullRequestMergeTask {\n     } finally {\n       // Always try to restore the branch if possible. We don't want to leave\n       // the repository in a different state than before.\n-      if (previousBranch !== null) {\n-        this.git.runGraceful(['checkout', '-f', previousBranch]);\n+      if (previousBranchOrRevision !== null) {\n+        this.git.runGraceful(['checkout', '-f', previousBranchOrRevision]);\n       }\n     }\n   }"
        },
        {
            "sha": "8c0af93324c7ba4222aa523487704d74f5b2ed58",
            "filename": "dev-infra/pr/rebase/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Fpr%2Frebase%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Frebase%2Findex.ts?ref=dbc2364d1689f757d7fcf7067f5824d989018a33",
            "patch": "@@ -50,10 +50,10 @@ export async function rebasePr(\n   }\n \n   /**\n-   * The branch originally checked out before this method performs any Git\n-   * operations that may change the working branch.\n+   * The branch or revision originally checked out before this method performed\n+   * any Git operations that may change the working branch.\n    */\n-  const originalBranch = git.getCurrentBranch();\n+  const previousBranchOrRevision = git.getCurrentBranchOrRevision();\n   /* Get the PR information from Github. */\n   const pr = await getPr(PR_SCHEMA, prNumber, config.github);\n \n@@ -121,7 +121,7 @@ export async function rebasePr(\n     info();\n     info(`To abort the rebase and return to the state of the repository before this command`);\n     info(`run the following command:`);\n-    info(` $ git rebase --abort && git reset --hard && git checkout ${originalBranch}`);\n+    info(` $ git rebase --abort && git reset --hard && git checkout ${previousBranchOrRevision}`);\n     process.exit(1);\n   } else {\n     info(`Cleaning up git state, and restoring previous state.`);\n@@ -137,7 +137,7 @@ export async function rebasePr(\n     // Ensure that any changes in the current repo state are cleared.\n     git.runGraceful(['reset', '--hard'], {stdio: 'ignore'});\n     // Checkout the original branch from before the run began.\n-    git.runGraceful(['checkout', originalBranch], {stdio: 'ignore'});\n+    git.runGraceful(['checkout', previousBranchOrRevision], {stdio: 'ignore'});\n   }\n }\n "
        },
        {
            "sha": "3a15b5a098259f5ca25e4368272af9597126ef29",
            "filename": "dev-infra/utils/git/index.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Futils%2Fgit%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/dbc2364d1689f757d7fcf7067f5824d989018a33/dev-infra%2Futils%2Fgit%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fgit%2Findex.ts?ref=dbc2364d1689f757d7fcf7067f5824d989018a33",
            "patch": "@@ -119,9 +119,16 @@ export class GitClient {\n     return this.run(['branch', branchName, '--contains', sha]).stdout !== '';\n   }\n \n-  /** Gets the currently checked out branch. */\n-  getCurrentBranch(): string {\n-    return this.run(['rev-parse', '--abbrev-ref', 'HEAD']).stdout.trim();\n+  /** Gets the currently checked out branch or revision. */\n+  getCurrentBranchOrRevision(): string {\n+    const branchName = this.run(['rev-parse', '--abbrev-ref', 'HEAD']).stdout.trim();\n+    // If no branch name could be resolved. i.e. `HEAD` has been returned, then Git\n+    // is currently in a detached state. In those cases, we just want to return the\n+    // currently checked out revision/SHA.\n+    if (branchName === 'HEAD') {\n+      return this.run(['rev-parse', 'HEAD']).stdout.trim();\n+    }\n+    return branchName;\n   }\n \n   /** Gets whether the current Git repository has uncommitted changes. */"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 33,
        "deletions": 26
    }
}