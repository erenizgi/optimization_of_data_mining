{
    "author": "petebacondarwin",
    "message": "fix(localize): ensure extracted messages are serialized in a consistent order (#40192)\n\nThe CLI integration can provide code files in a non-deterministic\norder, which led to the extracted translation files having\nmessages in a non-consistent order between extractions.\n\nThis commit fixes this by ensuring that serialized messages\nare ordered by their location.\n\nFixes #39262\n\nPR Close #40192",
    "sha": "212245f19708790a7a5e285577448f8b5513b5ad",
    "files": [
        {
            "sha": "5577e675e572f14087fbde85ebc6f4d175bf26aa",
            "filename": "packages/localize/src/tools/src/extract/translation_files/arb_translation_serializer.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Farb_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Farb_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Farb_translation_serializer.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -48,12 +48,13 @@ export class ArbTranslationSerializer implements TranslationSerializer {\n       private sourceLocale: string, private basePath: AbsoluteFsPath, private fs: FileSystem) {}\n \n   serialize(messages: ɵParsedMessage[]): string {\n-    const messageMap = consolidateMessages(messages, message => message.customId || message.id);\n+    const messageGroups = consolidateMessages(messages, message => getMessageId(message));\n \n     let output = `{\\n  \"@@locale\": ${JSON.stringify(this.sourceLocale)}`;\n \n-    for (const [id, duplicateMessages] of messageMap.entries()) {\n+    for (const duplicateMessages of messageGroups) {\n       const message = duplicateMessages[0];\n+      const id = getMessageId(message);\n       output += this.serializeMessage(id, message);\n       output += this.serializeMeta(\n           id, message.description, duplicateMessages.filter(hasLocation).map(m => m.location));\n@@ -98,3 +99,7 @@ export class ArbTranslationSerializer implements TranslationSerializer {\n     ].join('\\n');\n   }\n }\n+\n+function getMessageId(message: ɵParsedMessage): string {\n+  return message.customId || message.id;\n+}"
        },
        {
            "sha": "389a80b43ed5492afdbe52f9a64543a70c05541e",
            "filename": "packages/localize/src/tools/src/extract/translation_files/json_translation_serializer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fjson_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fjson_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fjson_translation_serializer.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -7,6 +7,7 @@\n  */\n import {ɵMessageId, ɵParsedMessage, ɵSourceMessage} from '@angular/localize';\n import {TranslationSerializer} from './translation_serializer';\n+import {consolidateMessages} from './utils';\n \n \n interface SimpleJsonTranslationFile {\n@@ -24,7 +25,7 @@ export class SimpleJsonTranslationSerializer implements TranslationSerializer {\n   constructor(private sourceLocale: string) {}\n   serialize(messages: ɵParsedMessage[]): string {\n     const fileObj: SimpleJsonTranslationFile = {locale: this.sourceLocale, translations: {}};\n-    for (const message of messages) {\n+    for (const [message] of consolidateMessages(messages, message => message.id)) {\n       fileObj.translations[message.id] = message.text;\n     }\n     return JSON.stringify(fileObj, null, 2);"
        },
        {
            "sha": "0e09389ed5b6d36a9f5b9c401c8b283c7803ebe9",
            "filename": "packages/localize/src/tools/src/extract/translation_files/utils.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 7,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Futils.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -8,24 +8,40 @@\n import {ɵMessageId, ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n /**\n- * Consolidate an array of messages into a map from message id to an array of messages with that id.\n+ * Consolidate messages into groups that have the same id.\n+ *\n+ * Messages with the same id are grouped together so that we can quickly deduplicate messages when\n+ * rendering into translation files.\n+ *\n+ * To ensure that messages are rendered in a deterministic order:\n+ *  - the messages within a group are sorted by location (file path, then start position)\n+ *  - the groups are sorted by the location of the first message in the group\n  *\n  * @param messages the messages to consolidate.\n  * @param getMessageId a function that will compute the message id of a message.\n+ * @returns an array of message groups, where each group is an array of messages that have the same\n+ *     id.\n  */\n export function consolidateMessages(\n     messages: ɵParsedMessage[],\n-    getMessageId: (message: ɵParsedMessage) => string): Map<ɵMessageId, ɵParsedMessage[]> {\n-  const consolidateMessages = new Map<ɵMessageId, ɵParsedMessage[]>();\n+    getMessageId: (message: ɵParsedMessage) => string): ɵParsedMessage[][] {\n+  const messageGroups = new Map<ɵMessageId, ɵParsedMessage[]>();\n   for (const message of messages) {\n     const id = getMessageId(message);\n-    if (!consolidateMessages.has(id)) {\n-      consolidateMessages.set(id, [message]);\n+    if (!messageGroups.has(id)) {\n+      messageGroups.set(id, [message]);\n     } else {\n-      consolidateMessages.get(id)!.push(message);\n+      messageGroups.get(id)!.push(message);\n     }\n   }\n-  return consolidateMessages;\n+\n+  // Here we sort the messages within a group into location order.\n+  // Note that `Array.sort()` will mutate the array in-place.\n+  for (const messages of messageGroups.values()) {\n+    messages.sort(compareLocations);\n+  }\n+  // Now we sort the groups by location of the first message in the group.\n+  return Array.from(messageGroups.values()).sort((a1, a2) => compareLocations(a1[0], a2[0]));\n }\n \n /**\n@@ -35,3 +51,26 @@ export function hasLocation(message: ɵParsedMessage): message is ɵParsedMessag\n     {location: ɵSourceLocation} {\n   return message.location !== undefined;\n }\n+\n+export function compareLocations(\n+    {location: location1}: ɵParsedMessage, {location: location2}: ɵParsedMessage): number {\n+  if (location1 === location2) {\n+    return 0;\n+  }\n+  if (location1 === undefined) {\n+    return -1;\n+  }\n+  if (location2 === undefined) {\n+    return 1;\n+  }\n+  if (location1.file !== location2.file) {\n+    return location1.file < location2.file ? -1 : 1;\n+  }\n+  if (location1.start.line !== location2.start.line) {\n+    return location1.start.line < location2.start.line ? -1 : 1;\n+  }\n+  if (location1.start.column !== location2.start.column) {\n+    return location1.start.column < location2.start.column ? -1 : 1;\n+  }\n+  return 0;\n+}"
        },
        {
            "sha": "b2262c7cb00de7b7c7c027e4f8f6146dff852743",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff1_translation_serializer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -34,7 +34,7 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n   }\n \n   serialize(messages: ɵParsedMessage[]): string {\n-    const messageMap = consolidateMessages(messages, message => this.getMessageId(message));\n+    const messageGroups = consolidateMessages(messages, message => this.getMessageId(message));\n     const xml = new XmlFile();\n     xml.startTag('xliff', {'version': '1.2', 'xmlns': 'urn:oasis:names:tc:xliff:document:1.2'});\n     // NOTE: the `original` property is set to the legacy `ng2.template` value for backward\n@@ -51,8 +51,9 @@ export class Xliff1TranslationSerializer implements TranslationSerializer {\n       ...this.formatOptions,\n     });\n     xml.startTag('body');\n-    for (const [id, duplicateMessages] of messageMap.entries()) {\n+    for (const duplicateMessages of messageGroups) {\n       const message = duplicateMessages[0];\n+      const id = this.getMessageId(message);\n \n       xml.startTag('trans-unit', {id, datatype: 'html'});\n       xml.startTag('source', {}, {preserveWhitespace: true});"
        },
        {
            "sha": "9b8b8079596cc4bfdfefe3488fc2d8682ceb5745",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xliff2_translation_serializer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -34,7 +34,7 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n   }\n \n   serialize(messages: ɵParsedMessage[]): string {\n-    const messageMap = consolidateMessages(messages, message => this.getMessageId(message));\n+    const messageGroups = consolidateMessages(messages, message => this.getMessageId(message));\n     const xml = new XmlFile();\n     xml.startTag('xliff', {\n       'version': '2.0',\n@@ -49,8 +49,9 @@ export class Xliff2TranslationSerializer implements TranslationSerializer {\n     // messages that come from a particular original file, and the translation file parsers may\n     // not\n     xml.startTag('file', {'id': 'ngi18n', 'original': 'ng.template', ...this.formatOptions});\n-    for (const [id, duplicateMessages] of messageMap.entries()) {\n+    for (const duplicateMessages of messageGroups) {\n       const message = duplicateMessages[0];\n+      const id = this.getMessageId(message);\n \n       xml.startTag('unit', {id});\n       const messagesWithLocations = duplicateMessages.filter(hasLocation);"
        },
        {
            "sha": "183c6c6b7b6ffb0dfa645a87817b776143258c0d",
            "filename": "packages/localize/src/tools/src/extract/translation_files/xmb_translation_serializer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Fsrc%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -10,6 +10,7 @@ import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n import {extractIcuPlaceholders} from './icu_parsing';\n import {TranslationSerializer} from './translation_serializer';\n+import {consolidateMessages} from './utils';\n import {XmlFile} from './xml_file';\n \n /**\n@@ -26,7 +27,7 @@ export class XmbTranslationSerializer implements TranslationSerializer {\n       private fs: FileSystem = getFileSystem()) {}\n \n   serialize(messages: ɵParsedMessage[]): string {\n-    const ids = new Set<string>();\n+    const messageGroups = consolidateMessages(messages, message => this.getMessageId(message));\n     const xml = new XmlFile();\n     xml.rawText(\n         `<!DOCTYPE messagebundle [\\n` +\n@@ -51,13 +52,9 @@ export class XmbTranslationSerializer implements TranslationSerializer {\n         `<!ELEMENT ex (#PCDATA)>\\n` +\n         `]>\\n`);\n     xml.startTag('messagebundle');\n-    for (const message of messages) {\n+    for (const duplicateMessages of messageGroups) {\n+      const message = duplicateMessages[0];\n       const id = this.getMessageId(message);\n-      if (ids.has(id)) {\n-        // Do not render the same message more than once\n-        continue;\n-      }\n-      ids.add(id);\n       xml.startTag(\n           'msg', {id, desc: message.description, meaning: message.meaning},\n           {preserveWhitespace: true});"
        },
        {
            "sha": "fca98d89a70d31ea5e84fc07218c71831b530892",
            "filename": "packages/localize/src/tools/test/extract/integration/main_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Fintegration%2Fmain_spec.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -464,7 +464,7 @@ runInEachFileSystem(() => {\n           `  \"locale\": \"en-GB\",`,\n           `  \"translations\": {`,\n           `    \"message-1\": \"message {$PH} contents\",`,\n-          `    \"message-2\": \"different message contents\"`,\n+          `    \"message-2\": \"message contents\"`,\n           `  }`,\n           `}`,\n         ].join('\\n'));\n@@ -489,7 +489,7 @@ runInEachFileSystem(() => {\n           `  \"locale\": \"en-GB\",`,\n           `  \"translations\": {`,\n           `    \"message-1\": \"message {$PH} contents\",`,\n-          `    \"message-2\": \"different message contents\"`,\n+          `    \"message-2\": \"message contents\"`,\n           `  }`,\n           `}`,\n         ].join('\\n'));"
        },
        {
            "sha": "061643400949f64d85d2896305c457630cd93531",
            "filename": "packages/localize/src/tools/test/extract/translation_files/arb_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 97,
            "deletions": 27,
            "changes": 124,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Farb_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Farb_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Farb_translation_serializer_spec.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -7,11 +7,11 @@\n  */\n import {absoluteFrom, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {runInEachFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n-import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n+import {ɵParsedMessage} from '@angular/localize';\n \n import {ArbTranslationSerializer} from '../../../src/extract/translation_files/arb_translation_serializer';\n \n-import {mockMessage} from './mock_message';\n+import {location, mockMessage} from './mock_message';\n \n runInEachFileSystem(() => {\n   let fs: FileSystem;\n@@ -25,30 +25,18 @@ runInEachFileSystem(() => {\n         const messages: ɵParsedMessage[] = [\n           mockMessage('12345', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n             meaning: 'some meaning',\n-            location: {\n-              file: absoluteFrom('/project/file.ts'),\n-              start: {line: 5, column: 10},\n-              end: {line: 5, column: 12}\n-            },\n+            location: location('/project/file.ts', 5, 10, 5, 12),\n           }),\n           mockMessage('54321', ['a', 'b', 'c'], ['PH', 'PH_1'], {\n             customId: 'someId',\n           }),\n           mockMessage('67890', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n             description: 'some description',\n-            location: {\n-              file: absoluteFrom('/project/file.ts'),\n-              start: {line: 5, column: 10},\n-              end: {line: 5, column: 12}\n-            },\n+            location: location('/project/file.ts', 5, 10, 5, 12)\n           }),\n           mockMessage('67890', ['a', '', 'c'], ['START_TAG_SPAN', 'CLOSE_TAG_SPAN'], {\n             description: 'some description',\n-            location: {\n-              file: absoluteFrom('/project/other.ts'),\n-              start: {line: 2, column: 10},\n-              end: {line: 3, column: 12}\n-            },\n+            location: location('/project/other.ts', 2, 10, 3, 12)\n           }),\n           mockMessage('13579', ['', 'b', ''], ['START_BOLD_TEXT', 'CLOSE_BOLD_TEXT'], {}),\n           mockMessage('24680', ['a'], [], {meaning: 'meaning', description: 'and description'}),\n@@ -72,6 +60,16 @@ runInEachFileSystem(() => {\n         expect(output.split('\\n')).toEqual([\n           '{',\n           '  \"@@locale\": \"xx\",',\n+          '  \"someId\": \"a{$PH}b{$PH_1}c\",',\n+          '  \"13579\": \"{$START_BOLD_TEXT}b{$CLOSE_BOLD_TEXT}\",',\n+          '  \"24680\": \"a\",',\n+          '  \"@24680\": {',\n+          '    \"description\": \"and description\"',\n+          '  },',\n+          '  \"80808\": \"multi\\\\nlines\",',\n+          '  \"90000\": \"<escape{$double-quotes-\\\\\"}me>\",',\n+          '  \"100000\": \"pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU\",',\n+          '  \"100001\": \"{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}\",',\n           '  \"12345\": \"a{$PH}b{$PH_1}c\",',\n           '  \"@12345\": {',\n           '    \"x-locations\": [',\n@@ -82,7 +80,6 @@ runInEachFileSystem(() => {\n           '      }',\n           '    ]',\n           '  },',\n-          '  \"someId\": \"a{$PH}b{$PH_1}c\",',\n           '  \"67890\": \"a{$START_TAG_SPAN}{$CLOSE_TAG_SPAN}c\",',\n           '  \"@67890\": {',\n           '    \"description\": \"some description\",',\n@@ -98,16 +95,89 @@ runInEachFileSystem(() => {\n           '        \"end\": { \"line\": \"3\", \"column\": \"12\" }',\n           '      }',\n           '    ]',\n+          '  }',\n+          '}',\n+        ]);\n+      });\n+\n+      it('should consistently order serialized messages by location', () => {\n+        const messages: ɵParsedMessage[] = [\n+          mockMessage('1', ['message-1'], [], {location: location('/root/c-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/c-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 8, 0, 10, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 8, 0, 10, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/a-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/a-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 20, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 20, 5, 12)}),\n+        ];\n+        const serializer = new ArbTranslationSerializer('xx', fs.resolve('/root'), fs);\n+        const output = serializer.serialize(messages);\n+        expect(output.split('\\n')).toEqual([\n+          '{',\n+          '  \"@@locale\": \"xx\",',\n+          '  \"1\": \"message-1\",',\n+          '  \"@1\": {',\n+          '    \"x-locations\": [',\n+          '      {',\n+          '        \"file\": \"a-1.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"10\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"b-1.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"10\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"b-1.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"20\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"b-1.ts\",',\n+          '        \"start\": { \"line\": \"8\", \"column\": \"0\" },',\n+          '        \"end\": { \"line\": \"10\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"c-1.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"10\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      }',\n+          '    ]',\n           '  },',\n-          '  \"13579\": \"{$START_BOLD_TEXT}b{$CLOSE_BOLD_TEXT}\",',\n-          '  \"24680\": \"a\",',\n-          '  \"@24680\": {',\n-          '    \"description\": \"and description\"',\n-          '  },',\n-          '  \"80808\": \"multi\\\\nlines\",',\n-          '  \"90000\": \"<escape{$double-quotes-\\\\\"}me>\",',\n-          '  \"100000\": \"pre-ICU {VAR_SELECT, select, a {a} b {{INTERPOLATION}} c {pre {INTERPOLATION_1} post}} post-ICU\",',\n-          '  \"100001\": \"{VAR_PLURAL, plural, one {{START_BOLD_TEXT}something bold{CLOSE_BOLD_TEXT}} other {pre {START_TAG_SPAN}middle{CLOSE_TAG_SPAN} post}}\"',\n+          '  \"2\": \"message-1\",',\n+          '  \"@2\": {',\n+          '    \"x-locations\": [',\n+          '      {',\n+          '        \"file\": \"a-2.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"10\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"b-2.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"10\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"b-2.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"20\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"b-2.ts\",',\n+          '        \"start\": { \"line\": \"8\", \"column\": \"0\" },',\n+          '        \"end\": { \"line\": \"10\", \"column\": \"12\" }',\n+          '      },',\n+          '      {',\n+          '        \"file\": \"c-2.ts\",',\n+          '        \"start\": { \"line\": \"5\", \"column\": \"10\" },',\n+          '        \"end\": { \"line\": \"5\", \"column\": \"12\" }',\n+          '      }',\n+          '    ]',\n+          '  }',\n           '}',\n         ]);\n       });"
        },
        {
            "sha": "9fc0409e66abe7d59ad41528649f5870ab75d9a6",
            "filename": "packages/localize/src/tools/test/extract/translation_files/mock_message.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fmock_message.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fmock_message.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fmock_message.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -5,6 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {ɵParsedMessage} from '@angular/localize';\n import {MessageId, SourceLocation} from '@angular/localize/src/utils';\n \n@@ -38,3 +39,13 @@ export function mockMessage(\n     placeholderNames,\n   };\n }\n+\n+export function location(\n+    file: string, startLine: number, startCol: number, endLine: number,\n+    endCol: number): SourceLocation {\n+  return {\n+    file: absoluteFrom(file),\n+    start: {line: startLine, column: startCol},\n+    end: {line: endLine, column: endCol}\n+  };\n+}"
        },
        {
            "sha": "80335ec221604d24338e23b854b77b30b9a160b3",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff1_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 93,
            "deletions": 18,
            "changes": 111,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff1_translation_serializer_spec.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -12,7 +12,7 @@ import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n import {FormatOptions} from '../../../src/extract/translation_files/format_options';\n import {Xliff1TranslationSerializer} from '../../../src/extract/translation_files/xliff1_translation_serializer';\n \n-import {mockMessage} from './mock_message';\n+import {location, mockMessage} from './mock_message';\n import {toAttributes} from './utils';\n \n runInEachFileSystem(() => {\n@@ -85,30 +85,13 @@ runInEachFileSystem(() => {\n               `  <file source-language=\"xx\" datatype=\"plaintext\" original=\"ng2.template\"${\n                   toAttributes(options)}>`,\n               `    <body>`,\n-              `      <trans-unit id=\"${\n-                  useLegacyIds ? '1234567890ABCDEF1234567890ABCDEF12345678' :\n-                                 '12345'}\" datatype=\"html\">`,\n-              `        <source>a<x id=\"PH\"/>b<x id=\"PH_1\"/>c</source>`,\n-              `        <context-group purpose=\"location\">`,\n-              `          <context context-type=\"sourcefile\">file.ts</context>`,\n-              `          <context context-type=\"linenumber\">6</context>`,\n-              `        </context-group>`,\n-              `        <note priority=\"1\" from=\"meaning\">some meaning</note>`,\n-              `      </trans-unit>`,\n               `      <trans-unit id=\"someId\" datatype=\"html\">`,\n               `        <source>a<x id=\"PH\" equiv-text=\"placeholder + 1\"/>b<x id=\"PH_1\"/>c</source>`,\n               `      </trans-unit>`,\n               `      <trans-unit id=\"67890\" datatype=\"html\">`,\n               `        <source>a<x id=\"START_TAG_SPAN\" ctype=\"x-span\"/><x id=\"CLOSE_TAG_SPAN\" ctype=\"x-span\"/>c</source>`,\n               `        <note priority=\"1\" from=\"description\">some description</note>`,\n               `      </trans-unit>`,\n-              `      <trans-unit id=\"38705\" datatype=\"html\">`,\n-              `        <source>a<x id=\"START_TAG_SPAN\" ctype=\"x-span\"/><x id=\"CLOSE_TAG_SPAN\" ctype=\"x-span\"/>c</source>`,\n-              `        <context-group purpose=\"location\">`,\n-              `          <context context-type=\"sourcefile\">file.ts</context>`,\n-              `          <context context-type=\"linenumber\">3,4</context>`,\n-              `        </context-group>`,\n-              `      </trans-unit>`,\n               `      <trans-unit id=\"13579\" datatype=\"html\">`,\n               `        <source><x id=\"START_BOLD_TEXT\" ctype=\"x-b\"/>b<x id=\"CLOSE_BOLD_TEXT\" ctype=\"x-b\"/></source>`,\n               `      </trans-unit>`,\n@@ -130,6 +113,23 @@ runInEachFileSystem(() => {\n               `      <trans-unit id=\"100001\" datatype=\"html\">`,\n               `        <source>{VAR_PLURAL, plural, one {<x id=\"START_BOLD_TEXT\" ctype=\"x-b\"/>something bold<x id=\"CLOSE_BOLD_TEXT\" ctype=\"x-b\"/>} other {pre <x id=\"START_TAG_SPAN\" ctype=\"x-span\"/>middle<x id=\"CLOSE_TAG_SPAN\" ctype=\"x-span\"/> post}}</source>`,\n               `      </trans-unit>`,\n+              `      <trans-unit id=\"38705\" datatype=\"html\">`,\n+              `        <source>a<x id=\"START_TAG_SPAN\" ctype=\"x-span\"/><x id=\"CLOSE_TAG_SPAN\" ctype=\"x-span\"/>c</source>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file.ts</context>`,\n+              `          <context context-type=\"linenumber\">3,4</context>`,\n+              `        </context-group>`,\n+              `      </trans-unit>`,\n+              `      <trans-unit id=\"${\n+                  useLegacyIds ? '1234567890ABCDEF1234567890ABCDEF12345678' :\n+                                 '12345'}\" datatype=\"html\">`,\n+              `        <source>a<x id=\"PH\"/>b<x id=\"PH_1\"/>c</source>`,\n+              `        <context-group purpose=\"location\">`,\n+              `          <context context-type=\"sourcefile\">file.ts</context>`,\n+              `          <context context-type=\"linenumber\">6</context>`,\n+              `        </context-group>`,\n+              `        <note priority=\"1\" from=\"meaning\">some meaning</note>`,\n+              `      </trans-unit>`,\n               `    </body>`,\n               `  </file>`,\n               `</xliff>\\n`,\n@@ -291,5 +291,80 @@ runInEachFileSystem(() => {\n         });\n       });\n     });\n+\n+    describe('renderFile()', () => {\n+      it('should consistently order serialized messages by location', () => {\n+        const messages: ɵParsedMessage[] = [\n+          mockMessage('1', ['message-1'], [], {location: location('/root/c-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/c-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 8, 0, 10, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 8, 0, 10, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/a-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/a-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 20, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 20, 5, 12)}),\n+        ];\n+        const serializer = new Xliff1TranslationSerializer('xx', absoluteFrom('/root'), false, {});\n+        const output = serializer.serialize(messages);\n+        expect(output.split('\\n')).toEqual([\n+          '<?xml version=\"1.0\" encoding=\"UTF-8\" ?>',\n+          '<xliff version=\"1.2\" xmlns=\"urn:oasis:names:tc:xliff:document:1.2\">',\n+          '  <file source-language=\"xx\" datatype=\"plaintext\" original=\"ng2.template\">',\n+          '    <body>',\n+          '      <trans-unit id=\"1\" datatype=\"html\">',\n+          '        <source>message-1</source>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">a-1.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">b-1.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">b-1.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">b-1.ts</context>',\n+          '          <context context-type=\"linenumber\">9,11</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">c-1.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '      </trans-unit>',\n+          '      <trans-unit id=\"2\" datatype=\"html\">',\n+          '        <source>message-1</source>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">a-2.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">b-2.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">b-2.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">b-2.ts</context>',\n+          '          <context context-type=\"linenumber\">9,11</context>',\n+          '        </context-group>',\n+          '        <context-group purpose=\"location\">',\n+          '          <context context-type=\"sourcefile\">c-2.ts</context>',\n+          '          <context context-type=\"linenumber\">6</context>',\n+          '        </context-group>',\n+          '      </trans-unit>',\n+          '    </body>',\n+          '  </file>',\n+          '</xliff>',\n+          '',\n+        ]);\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "247184be8212dbfbebd1f8b0f4830a0370695443",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xliff2_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 78,
            "deletions": 27,
            "changes": 105,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxliff2_translation_serializer_spec.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -12,7 +12,7 @@ import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n import {FormatOptions} from '../../../src/extract/translation_files/format_options';\n import {Xliff2TranslationSerializer} from '../../../src/extract/translation_files/xliff2_translation_serializer';\n \n-import {mockMessage} from './mock_message';\n+import {location, mockMessage} from './mock_message';\n import {toAttributes} from './utils';\n \n runInEachFileSystem(() => {\n@@ -88,37 +88,11 @@ runInEachFileSystem(() => {\n               `<?xml version=\"1.0\" encoding=\"UTF-8\" ?>`,\n               `<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"xx\">`,\n               `  <file id=\"ngi18n\" original=\"ng.template\"${toAttributes(options)}>`,\n-              `    <unit id=\"${useLegacyIds ? '615790887472569365' : '12345'}\">`,\n-              `      <notes>`,\n-              `        <note category=\"location\">file.ts:6</note>`,\n-              `        <note category=\"meaning\">some meaning</note>`,\n-              `      </notes>`,\n-              `      <segment>`,\n-              `        <source>a<ph id=\"0\" equiv=\"PH\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n-              `      </segment>`,\n-              `    </unit>`,\n               `    <unit id=\"someId\">`,\n               `      <segment>`,\n               `        <source>a<ph id=\"0\" equiv=\"PH\" disp=\"placeholder + 1\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n               `      </segment>`,\n               `    </unit>`,\n-              `    <unit id=\"67890\">`,\n-              `      <notes>`,\n-              `        <note category=\"location\">file.ts:3,4</note>`,\n-              `        <note category=\"description\">some description</note>`,\n-              `      </notes>`,\n-              `      <segment>`,\n-              `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"other\"></pc>c</source>`,\n-              `      </segment>`,\n-              `    </unit>`,\n-              `    <unit id=\"location-only\">`,\n-              `      <notes>`,\n-              `        <note category=\"location\">file.ts:3,4</note>`,\n-              `      </notes>`,\n-              `      <segment>`,\n-              `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"other\"></pc>c</source>`,\n-              `      </segment>`,\n-              `    </unit>`,\n               `    <unit id=\"13579\">`,\n               `      <segment>`,\n               `        <source><pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\" type=\"fmt\">b</pc></source>`,\n@@ -154,6 +128,32 @@ runInEachFileSystem(() => {\n               `        <source>{VAR_PLURAL, plural, one {<pc id=\"0\" equivStart=\"START_BOLD_TEXT\" equivEnd=\"CLOSE_BOLD_TEXT\" type=\"fmt\">something bold</pc>} other {pre <pc id=\"1\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"other\">middle</pc> post}}</source>`,\n               `      </segment>`,\n               `    </unit>`,\n+              `    <unit id=\"67890\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file.ts:3,4</note>`,\n+              `        <note category=\"description\">some description</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"other\"></pc>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"location-only\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file.ts:3,4</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a<pc id=\"0\" equivStart=\"START_TAG_SPAN\" equivEnd=\"CLOSE_TAG_SPAN\" type=\"other\"></pc>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n+              `    <unit id=\"${useLegacyIds ? '615790887472569365' : '12345'}\">`,\n+              `      <notes>`,\n+              `        <note category=\"location\">file.ts:6</note>`,\n+              `        <note category=\"meaning\">some meaning</note>`,\n+              `      </notes>`,\n+              `      <segment>`,\n+              `        <source>a<ph id=\"0\" equiv=\"PH\"/>b<ph id=\"1\" equiv=\"PH_1\"/>c</source>`,\n+              `      </segment>`,\n+              `    </unit>`,\n               `  </file>`,\n               `</xliff>\\n`,\n             ].join('\\n'));\n@@ -304,5 +304,56 @@ runInEachFileSystem(() => {\n         });\n       });\n     });\n+\n+    describe('renderFile()', () => {\n+      it('should consistently order serialized messages by location', () => {\n+        const messages: ɵParsedMessage[] = [\n+          mockMessage('1', ['message-1'], [], {location: location('/root/c-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/c-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 8, 0, 10, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 8, 0, 10, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/a-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/a-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 10, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 10, 5, 12)}),\n+          mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 20, 5, 12)}),\n+          mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 20, 5, 12)}),\n+        ];\n+        const serializer = new Xliff2TranslationSerializer('xx', absoluteFrom('/root'), false, {});\n+        const output = serializer.serialize(messages);\n+        expect(output.split('\\n')).toEqual([\n+          '<?xml version=\"1.0\" encoding=\"UTF-8\" ?>',\n+          '<xliff version=\"2.0\" xmlns=\"urn:oasis:names:tc:xliff:document:2.0\" srcLang=\"xx\">',\n+          '  <file id=\"ngi18n\" original=\"ng.template\">',\n+          '    <unit id=\"1\">',\n+          '      <notes>',\n+          '        <note category=\"location\">a-1.ts:6</note>',\n+          '        <note category=\"location\">b-1.ts:6</note>',\n+          '        <note category=\"location\">b-1.ts:6</note>',\n+          '        <note category=\"location\">b-1.ts:9,11</note>',\n+          '        <note category=\"location\">c-1.ts:6</note>',\n+          '      </notes>',\n+          '      <segment>',\n+          '        <source>message-1</source>',\n+          '      </segment>',\n+          '    </unit>',\n+          '    <unit id=\"2\">',\n+          '      <notes>',\n+          '        <note category=\"location\">a-2.ts:6</note>',\n+          '        <note category=\"location\">b-2.ts:6</note>',\n+          '        <note category=\"location\">b-2.ts:6</note>',\n+          '        <note category=\"location\">b-2.ts:9,11</note>',\n+          '        <note category=\"location\">c-2.ts:6</note>',\n+          '      </notes>',\n+          '      <segment>',\n+          '        <source>message-1</source>',\n+          '      </segment>',\n+          '    </unit>',\n+          '  </file>',\n+          '</xliff>',\n+          '',\n+        ]);\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "1a4593d783d210ec15543588f646508462be7724",
            "filename": "packages/localize/src/tools/test/extract/translation_files/xmb_translation_serializer_spec.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 1,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/212245f19708790a7a5e285577448f8b5513b5ad/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flocalize%2Fsrc%2Ftools%2Ftest%2Fextract%2Ftranslation_files%2Fxmb_translation_serializer_spec.ts?ref=212245f19708790a7a5e285577448f8b5513b5ad",
            "patch": "@@ -11,7 +11,7 @@ import {ɵParsedMessage, ɵSourceLocation} from '@angular/localize';\n \n import {XmbTranslationSerializer} from '../../../src/extract/translation_files/xmb_translation_serializer';\n \n-import {mockMessage} from './mock_message';\n+import {location, mockMessage} from './mock_message';\n \n runInEachFileSystem(() => {\n   let fs: FileSystem;\n@@ -86,4 +86,52 @@ runInEachFileSystem(() => {\n       });\n     });\n   });\n+\n+  describe('renderFile()', () => {\n+    it('should consistently order serialized messages by location', () => {\n+      const messages: ɵParsedMessage[] = [\n+        mockMessage('1', ['message-1'], [], {location: location('/root/c-1.ts', 5, 10, 5, 12)}),\n+        mockMessage('2', ['message-1'], [], {location: location('/root/c-2.ts', 5, 10, 5, 12)}),\n+        mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 8, 0, 10, 12)}),\n+        mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 8, 0, 10, 12)}),\n+        mockMessage('1', ['message-1'], [], {location: location('/root/a-1.ts', 5, 10, 5, 12)}),\n+        mockMessage('2', ['message-1'], [], {location: location('/root/a-2.ts', 5, 10, 5, 12)}),\n+        mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 10, 5, 12)}),\n+        mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 10, 5, 12)}),\n+        mockMessage('1', ['message-1'], [], {location: location('/root/b-1.ts', 5, 20, 5, 12)}),\n+        mockMessage('2', ['message-1'], [], {location: location('/root/b-2.ts', 5, 20, 5, 12)}),\n+      ];\n+      const serializer = new XmbTranslationSerializer(absoluteFrom('/root'), false);\n+      const output = serializer.serialize(messages);\n+      expect(output.split('\\n')).toEqual([\n+        '<?xml version=\"1.0\" encoding=\"UTF-8\" ?>',\n+        '<!DOCTYPE messagebundle [',\n+        '<!ELEMENT messagebundle (msg)*>',\n+        '<!ATTLIST messagebundle class CDATA #IMPLIED>',\n+        '',\n+        '<!ELEMENT msg (#PCDATA|ph|source)*>',\n+        '<!ATTLIST msg id CDATA #IMPLIED>',\n+        '<!ATTLIST msg seq CDATA #IMPLIED>',\n+        '<!ATTLIST msg name CDATA #IMPLIED>',\n+        '<!ATTLIST msg desc CDATA #IMPLIED>',\n+        '<!ATTLIST msg meaning CDATA #IMPLIED>',\n+        '<!ATTLIST msg obsolete (obsolete) #IMPLIED>',\n+        '<!ATTLIST msg xml:space (default|preserve) \"default\">',\n+        '<!ATTLIST msg is_hidden CDATA #IMPLIED>',\n+        '',\n+        '<!ELEMENT source (#PCDATA)>',\n+        '',\n+        '<!ELEMENT ph (#PCDATA|ex)*>',\n+        '<!ATTLIST ph name CDATA #REQUIRED>',\n+        '',\n+        '<!ELEMENT ex (#PCDATA)>',\n+        ']>',\n+        '<messagebundle>',\n+        '  <msg id=\"1\"><source>a-1.ts:5</source>message-1</msg>',\n+        '  <msg id=\"2\"><source>a-2.ts:5</source>message-1</msg>',\n+        '</messagebundle>',\n+        '',\n+      ]);\n+    });\n+  });\n });"
        }
    ],
    "stats": {
        "total": 491,
        "additions": 395,
        "deletions": 96
    }
}