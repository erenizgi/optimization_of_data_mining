{
    "author": "petebacondarwin",
    "message": "feat(docs-infra): improve search query processing (#41368)\n\nThis commit tries to improve the search results by processing\nthe query and attempting progressively less restrictive searches\nuntil a non-zero set of pages is matched.\n\nThe new procesing includes:\n\n* stripping off quote marks, which were causing searches to fail\n* first attempting to match pages where ALL the query terms exist\n* second attempting to match pages where ANY of the query terms exist\n* third attempting to match pages where the title contains partial word matches\n\nThe first query attempt approximates, quite well, the idea of searching\nfor multi-word phrases. This is given the technical nature of the terms\nand the fairly small size of the corpus.\n\nPR Close #41368",
    "sha": "55f7f1d446e6280541ea525490ba36fe1db2d7ab",
    "files": [
        {
            "sha": "5c15cd1c6baac0ca9e03b637892db03d5e5d38a0",
            "filename": "aio/src/app/search/search.worker.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/55f7f1d446e6280541ea525490ba36fe1db2d7ab/aio%2Fsrc%2Fapp%2Fsearch%2Fsearch.worker.ts",
            "raw_url": "https://github.com/angular/angular/raw/55f7f1d446e6280541ea525490ba36fe1db2d7ab/aio%2Fsrc%2Fapp%2Fsearch%2Fsearch.worker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fsrc%2Fapp%2Fsearch%2Fsearch.worker.ts?ref=55f7f1d446e6280541ea525490ba36fe1db2d7ab",
            "patch": "@@ -84,22 +84,33 @@ function loadIndex(pagesData: PageInfo[]): IndexLoader {\n \n // Query the index and return the processed results\n function queryIndex(query: string): PageInfo[] {\n+  // Strip off quotes\n+  query = query.replace(/^[\"']|['\"]$/g, '');\n   try {\n     if (query.length) {\n-      let results = index.search(query);\n+      // First try a query where every term must be present\n+      const queryAll = query.replace(/(^|\\s)([^\\s]+)/g, '$1+$2');\n+      let results = index.search(queryAll);\n+\n+      // If that was too restrictive just query for any term to be present\n       if (results.length === 0) {\n-        // Add a relaxed search in the title for the first word in the query\n-        // E.g. if the search is \"ngCont guide\" then we search for \"ngCont guide titleWords:ngCont*\"\n-        const titleQuery = 'titleWords:*' + query.split(' ', 1)[0] + '*';\n+        results = index.search(query);\n+      }\n+\n+      // If that is still too restrictive then search in the title for the first word in the query\n+      if (results.length === 0) {\n+        // E.g. if the search is \"ngCont guide\" then we search for \"ngCont guide title:ngCont*\"\n+        const titleQuery = 'title:*' + query.split(' ', 1)[0] + '*';\n         results = index.search(query + ' ' + titleQuery);\n       }\n+\n       // Map the hits into info about each page to be returned as results\n       return results.map(hit => pages[hit.ref]);\n     }\n   } catch (e) {\n     // If the search query cannot be parsed the index throws an error\n     // Log it and recover\n-    console.log(e);\n+    console.error(e);\n   }\n   return [];\n }"
        },
        {
            "sha": "2d58484fc6c606b49a7266d057e01bbf39981acd",
            "filename": "aio/tests/deployment/e2e/smoke-tests.e2e-spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/55f7f1d446e6280541ea525490ba36fe1db2d7ab/aio%2Ftests%2Fdeployment%2Fe2e%2Fsmoke-tests.e2e-spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/55f7f1d446e6280541ea525490ba36fe1db2d7ab/aio%2Ftests%2Fdeployment%2Fe2e%2Fsmoke-tests.e2e-spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fdeployment%2Fe2e%2Fsmoke-tests.e2e-spec.ts?ref=55f7f1d446e6280541ea525490ba36fe1db2d7ab",
            "patch": "@@ -103,11 +103,10 @@ describe(browser.baseUrl, () => {\n     });\n \n     it('should show relevant results on 404', async () => {\n-      await page.goTo('http/router');\n+      await page.goTo('common/http');\n       const results = await page.getSearchResults();\n \n-      expect(results).toContain('HttpClient');\n-      expect(results).toContain('Router');\n+      expect(results).toContain('common/http package');\n     });\n   });\n });"
        },
        {
            "sha": "e341324858dc58132beae33326e17bf7e1ed90c8",
            "filename": "aio/tests/e2e/src/app.e2e-spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/55f7f1d446e6280541ea525490ba36fe1db2d7ab/aio%2Ftests%2Fe2e%2Fsrc%2Fapp.e2e-spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/55f7f1d446e6280541ea525490ba36fe1db2d7ab/aio%2Ftests%2Fe2e%2Fsrc%2Fapp.e2e-spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftests%2Fe2e%2Fsrc%2Fapp.e2e-spec.ts?ref=55f7f1d446e6280541ea525490ba36fe1db2d7ab",
            "patch": "@@ -217,11 +217,10 @@ describe('site App', () => {\n     });\n \n     it('should search the index for words found in the url', async () => {\n-      await page.navigateTo('http/router');\n+      await page.navigateTo('common/http');\n       const results = await page.getSearchResults();\n \n-      expect(results).toContain('HttpRequest');\n-      expect(results).toContain('Router');\n+      expect(results).toContain('common/http package');\n     });\n   });\n "
        }
    ],
    "stats": {
        "total": 31,
        "additions": 20,
        "deletions": 11
    }
}