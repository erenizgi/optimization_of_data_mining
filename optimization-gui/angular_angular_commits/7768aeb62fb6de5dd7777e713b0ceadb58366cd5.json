{
    "author": "unknown",
    "message": "fix(platform-server): Resolve absolute URL from baseUrl (#39334)\n\nThis commit fixes a bug when `useAbsoluteUrl` is set to true and\n`ServerPlatformLocation` infers the base url from the supplied\n`url`. User should explicitly set the `baseUrl` when they turn on\n`useAbsoluteUrl`.\n\nBreaking change:\nIf you use `useAbsoluteUrl` to setup `platform-server`, you now need to\nalso specify `baseUrl`.\nWe are intentionally making this a breaking change in a minor release,\nbecause if `useAbsoluteUrl` is set to `true` then the behavior of the\napplication could be unpredictable, resulting in issues that are hard to\ndiscover but could be affecting production environments.\n\nPR Close #39334",
    "sha": "7768aeb62fb6de5dd7777e713b0ceadb58366cd5",
    "files": [
        {
            "sha": "490599c709a5a793a5b73d2278c98bce14c0edd0",
            "filename": "goldens/public-api/platform-server/platform-server.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/goldens%2Fpublic-api%2Fplatform-server%2Fplatform-server.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/goldens%2Fpublic-api%2Fplatform-server%2Fplatform-server.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fplatform-server%2Fplatform-server.d.ts?ref=7768aeb62fb6de5dd7777e713b0ceadb58366cd5",
            "patch": "@@ -3,6 +3,7 @@ export declare const BEFORE_APP_SERIALIZED: InjectionToken<(() => void | Promise\n export declare const INITIAL_CONFIG: InjectionToken<PlatformConfig>;\n \n export declare interface PlatformConfig {\n+    baseUrl?: string;\n     document?: string;\n     url?: string;\n     useAbsoluteUrl?: boolean;"
        },
        {
            "sha": "054e4f85ba8559011f162048a2ce386437daab13",
            "filename": "packages/platform-server/src/location.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/packages%2Fplatform-server%2Fsrc%2Flocation.ts",
            "raw_url": "https://github.com/angular/angular/raw/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/packages%2Fplatform-server%2Fsrc%2Flocation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Flocation.ts?ref=7768aeb62fb6de5dd7777e713b0ceadb58366cd5",
            "patch": "@@ -12,7 +12,6 @@ import {Subject} from 'rxjs';\n import * as url from 'url';\n import {INITIAL_CONFIG, PlatformConfig} from './tokens';\n \n-\n function parseUrl(urlStr: string) {\n   const parsedUrl = url.parse(urlStr);\n   return {\n@@ -43,16 +42,28 @@ export class ServerPlatformLocation implements PlatformLocation {\n   constructor(\n       @Inject(DOCUMENT) private _doc: any, @Optional() @Inject(INITIAL_CONFIG) _config: any) {\n     const config = _config as PlatformConfig | null;\n-    if (!!config && !!config.url) {\n-      const parsedUrl = parseUrl(config.url);\n-      this.hostname = parsedUrl.hostname;\n-      this.protocol = parsedUrl.protocol;\n-      this.port = parsedUrl.port;\n-      this.pathname = parsedUrl.pathname;\n-      this.search = parsedUrl.search;\n-      this.hash = parsedUrl.hash;\n+    if (!config) {\n+      return;\n+    }\n+    if (config.url) {\n+      const url = parseUrl(config.url);\n+      this.protocol = url.protocol;\n+      this.hostname = url.hostname;\n+      this.port = url.port;\n+      this.pathname = url.pathname;\n+      this.search = url.search;\n+      this.hash = url.hash;\n       this.href = _doc.location.href;\n     }\n+    if (config.useAbsoluteUrl) {\n+      if (!config.baseUrl) {\n+        throw new Error(`\"PlatformConfig.baseUrl\" must be set if \"useAbsoluteUrl\" is true`);\n+      }\n+      const url = parseUrl(config.baseUrl);\n+      this.protocol = url.protocol;\n+      this.hostname = url.hostname;\n+      this.port = url.port;\n+    }\n   }\n \n   getBaseHrefFromDOM(): string {"
        },
        {
            "sha": "7a937bc5647fcbd075f5c6a8ae7f7fdb78de65e4",
            "filename": "packages/platform-server/src/tokens.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/packages%2Fplatform-server%2Fsrc%2Ftokens.ts",
            "raw_url": "https://github.com/angular/angular/raw/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/packages%2Fplatform-server%2Fsrc%2Ftokens.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Fsrc%2Ftokens.ts?ref=7768aeb62fb6de5dd7777e713b0ceadb58366cd5",
            "patch": "@@ -20,19 +20,26 @@ export interface PlatformConfig {\n    */\n   document?: string;\n   /**\n-   * The URL for the current application state. This is\n-   * used for initializing the platform's location and\n-   * for setting absolute URL resolution for HTTP requests.\n+   * The URL for the current application state. This is used for initializing\n+   * the platform's location. `protocol`, `hostname`, and `port` will be\n+   * overridden if `baseUrl` is set.\n    * @default none\n    */\n   url?: string;\n   /**\n-   * Whether to append the absolute URL to any relative HTTP\n-   * requests. If set to true, this logic executes prior to\n-   * any HTTP interceptors that may run later on in the request.\n+   * Whether to append the absolute URL to any relative HTTP requests. If set to\n+   * true, this logic executes prior to any HTTP interceptors that may run later\n+   * on in the request. `baseUrl` must be supplied if this flag is enabled.\n    * @default false\n    */\n   useAbsoluteUrl?: boolean;\n+  /**\n+   * The base URL for resolving absolute URL for HTTP requests. It must be set\n+   * if `useAbsoluteUrl` is true, and must consist of protocol, hostname,\n+   * and optional port. This option has no effect if `useAbsoluteUrl` is not\n+   * enabled.\n+   */\n+  baseUrl?: string;\n }\n \n /**"
        },
        {
            "sha": "34740d10acba3e0451196709afa9b187ac8540b4",
            "filename": "packages/platform-server/test/integration_spec.ts",
            "status": "modified",
            "additions": 85,
            "deletions": 9,
            "changes": 94,
            "blob_url": "https://github.com/angular/angular/blob/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/packages%2Fplatform-server%2Ftest%2Fintegration_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7768aeb62fb6de5dd7777e713b0ceadb58366cd5/packages%2Fplatform-server%2Ftest%2Fintegration_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fplatform-server%2Ftest%2Fintegration_spec.ts?ref=7768aeb62fb6de5dd7777e713b0ceadb58366cd5",
            "patch": "@@ -794,10 +794,62 @@ describe('platform-server integration', () => {\n        }));\n \n     describe('relative requests', () => {\n+      it('will throw if \"useAbsoluteUrl\" is true but \"baseUrl\" is not provided', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          },\n+        }]);\n+        const appRef = await platform.bootstrapModule(HttpClientExampleModule);\n+        expect(() => appRef.injector.get(PlatformLocation))\n+            .toThrowError(/\"PlatformConfig\\.baseUrl\" must be set if \"useAbsoluteUrl\" is true/);\n+      });\n+\n+      it('will resolve absolute url using \"baseUrl\"', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost',\n+            useAbsoluteUrl: true,\n+            baseUrl: 'https://angular.io:8080',\n+          },\n+        }]);\n+        const appRef = await platform.bootstrapModule(HttpClientExampleModule);\n+        const location = appRef.injector.get(PlatformLocation);\n+        expect(location.protocol).toBe('https:');\n+        expect(location.hostname).toBe('angular.io');\n+        expect(location.port).toBe('8080');\n+      });\n+\n+      it('\"baseUrl\" has no effect if \"useAbsoluteUrl\" is not enabled', async () => {\n+        const platform = platformDynamicServer([{\n+          provide: INITIAL_CONFIG,\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost',\n+            baseUrl: 'https://angular.io:8080',\n+          },\n+        }]);\n+        const appRef = await platform.bootstrapModule(HttpClientExampleModule);\n+        const location = appRef.injector.get(PlatformLocation);\n+        expect(location.protocol).toBe('http:');\n+        expect(location.hostname).toBe('localhost');\n+        expect(location.port).toBe('');\n+      });\n+\n       it('correctly maps to absolute URL request with base config', async () => {\n         const platform = platformDynamicServer([{\n           provide: INITIAL_CONFIG,\n-          useValue: {document: '<app></app>', url: 'http://localhost', useAbsoluteUrl: true}\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost',\n+            baseUrl: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          }\n         }]);\n         const ref = await platform.bootstrapModule(HttpClientExampleModule);\n         const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n@@ -831,7 +883,12 @@ describe('platform-server integration', () => {\n       it('correctly maps to absolute URL request with port', async () => {\n         const platform = platformDynamicServer([{\n           provide: INITIAL_CONFIG,\n-          useValue: {document: '<app></app>', url: 'http://localhost:5000', useAbsoluteUrl: true}\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost:5000',\n+            baseUrl: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          }\n         }]);\n         const ref = await platform.bootstrapModule(HttpClientExampleModule);\n         const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n@@ -848,7 +905,12 @@ describe('platform-server integration', () => {\n       it('correctly maps to absolute URL request with two slashes', async () => {\n         const platform = platformDynamicServer([{\n           provide: INITIAL_CONFIG,\n-          useValue: {document: '<app></app>', url: 'http://localhost/', useAbsoluteUrl: true}\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost/',\n+            baseUrl: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          }\n         }]);\n         const ref = await platform.bootstrapModule(HttpClientExampleModule);\n         const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n@@ -865,7 +927,12 @@ describe('platform-server integration', () => {\n       it('correctly maps to absolute URL request with no slashes', async () => {\n         const platform = platformDynamicServer([{\n           provide: INITIAL_CONFIG,\n-          useValue: {document: '<app></app>', url: 'http://localhost', useAbsoluteUrl: true}\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost',\n+            baseUrl: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          }\n         }]);\n         const ref = await platform.bootstrapModule(HttpClientExampleModule);\n         const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n@@ -882,8 +949,12 @@ describe('platform-server integration', () => {\n       it('correctly maps to absolute URL request with longer url and no slashes', async () => {\n         const platform = platformDynamicServer([{\n           provide: INITIAL_CONFIG,\n-          useValue:\n-              {document: '<app></app>', url: 'http://localhost/path/page', useAbsoluteUrl: true}\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost/path/page',\n+            baseUrl: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          }\n         }]);\n         const ref = await platform.bootstrapModule(HttpClientExampleModule);\n         const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n@@ -900,8 +971,12 @@ describe('platform-server integration', () => {\n       it('correctly maps to absolute URL request with longer url and slashes', async () => {\n         const platform = platformDynamicServer([{\n           provide: INITIAL_CONFIG,\n-          useValue:\n-              {document: '<app></app>', url: 'http://localhost/path/page', useAbsoluteUrl: true}\n+          useValue: {\n+            document: '<app></app>',\n+            url: 'http://localhost/path/page',\n+            baseUrl: 'http://localhost',\n+            useAbsoluteUrl: true,\n+          }\n         }]);\n         const ref = await platform.bootstrapModule(HttpClientExampleModule);\n         const mock = ref.injector.get(HttpTestingController) as HttpTestingController;\n@@ -922,7 +997,8 @@ describe('platform-server integration', () => {\n              useValue: {\n                document: '<base href=\"http://other\"><app></app>',\n                url: 'http://localhost/path/page',\n-               useAbsoluteUrl: true\n+               baseUrl: 'http://localhost',\n+               useAbsoluteUrl: true,\n              }\n            }]);\n            const ref = await platform.bootstrapModule(HttpClientExampleModule);"
        }
    ],
    "stats": {
        "total": 143,
        "additions": 119,
        "deletions": 24
    }
}