{
    "author": "gkalpak",
    "message": "fix(docs-infra): correctly generate CLI commands docs when the overview page moves (#38365)\n\nPreviously, the [processCliCommands][1] dgeni processor, which is used\nto generate the docs pages for the CLI commands, expected the CLI\ncommands overview page (with a URL of `cli`) to exist as a child of a\ntop-level navigation section (`CLI Commands`). If one tried to move the\n`CLI Commands` section inside another section, `processCliCommnads`\nwould fail to find it and thus fail to generate the CLI commands docs.\nThis problem came up in #38353.\n\nThis commit updates the `processCliCommands` processor to be able to\nfind it regardless of the position of the `CLI Commands` section inside\nthe navigation doc.\n\n[1]:\nhttps://github.com/angular/angular/blob/dca4443a8ed65d341356fe62f6df9934e6314dfe/aio/tools/transforms/cli-docs-package/processors/processCliCommands.js#L7-L9\n\nPR Close #38365",
    "sha": "0551fbdf889dc1a7a509c3ebb19789b231b10917",
    "files": [
        {
            "sha": "5b6e5448b14a84dab261bde44cf6750627989340",
            "filename": "aio/tools/transforms/cli-docs-package/processors/processCliCommands.js",
            "status": "modified",
            "additions": 31,
            "deletions": 5,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/0551fbdf889dc1a7a509c3ebb19789b231b10917/aio%2Ftools%2Ftransforms%2Fcli-docs-package%2Fprocessors%2FprocessCliCommands.js",
            "raw_url": "https://github.com/angular/angular/raw/0551fbdf889dc1a7a509c3ebb19789b231b10917/aio%2Ftools%2Ftransforms%2Fcli-docs-package%2Fprocessors%2FprocessCliCommands.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fcli-docs-package%2Fprocessors%2FprocessCliCommands.js?ref=0551fbdf889dc1a7a509c3ebb19789b231b10917",
            "patch": "@@ -4,11 +4,9 @@ module.exports = function processCliCommands(createDocMessage) {\n     $runBefore: ['rendering-docs'],\n     $process(docs) {\n       const navigationDoc = docs.find(doc => doc.docType === 'navigation-json');\n-      const navigationNode = navigationDoc &&\n-          navigationDoc.data['SideNav'].find(\n-              node => node.children && node.children.length && node.children[0].url === 'cli');\n+      const cliCommandsNode = navigationDoc && findCliCommandsNode(navigationDoc.data['SideNav']);\n \n-      if (!navigationNode) {\n+      if (!cliCommandsNode) {\n         throw new Error(createDocMessage(\n             'Missing `cli` url - CLI Commands must include a first child node with url set at `cli`',\n             navigationDoc));\n@@ -24,13 +22,41 @@ module.exports = function processCliCommands(createDocMessage) {\n           doc.optionKeywords = Array.from(optionKeywords).join(' ');\n \n           // Add to navigation doc\n-          navigationNode.children.push({url: doc.path, title: `ng ${doc.name}`});\n+          cliCommandsNode.children.push({url: doc.path, title: `ng ${doc.name}`});\n         }\n       });\n     }\n   };\n };\n \n+// Look for the `CLI Commands` navigation node. It is the node whose first child has `url: 'cli'`.\n+// (NOTE: Using the URL instead of the title, because it is more robust.)\n+function findCliCommandsNode(nodes) {\n+  // We will \"recursively\" check all navigation nodes and their children (in breadth-first order),\n+  // until we find the `CLI Commands` node. Keep a list of nodes lists to check.\n+  // (NOTE: Each item in the list is a LIST of nodes.)\n+  const nodesList = [nodes];\n+\n+  while (nodesList.length > 0) {\n+    // Get the first item from the list of nodes lists.\n+    const currentNodes = nodesList.shift();\n+    const cliCommandsNode = currentNodes.find(isCliCommandsNode);\n+\n+    // One of the nodes in `currentNodes` was the `CLI Commands` node. Return it.\n+    if (cliCommandsNode) return cliCommandsNode;\n+\n+    // The `CLI Commands` node is not in `currentNodes`. Check each node's children (if any).\n+    currentNodes.forEach(node => node.children && nodesList.push(node.children));\n+  }\n+\n+  // We checked all navigation nodes and their children and did not find the `CLI Commands` node.\n+  return undefined;\n+}\n+\n+function isCliCommandsNode(node) {\n+  return node.children && node.children.length && node.children[0].url === 'cli';\n+}\n+\n function processOptions(container, options, optionKeywords) {\n   container.positionalOptions = [];\n   container.namedOptions = [];"
        },
        {
            "sha": "79e0dbb0eca29826a788e5fcd0d96cb9be6b4776",
            "filename": "aio/tools/transforms/cli-docs-package/processors/processCliCommands.spec.js",
            "status": "modified",
            "additions": 54,
            "deletions": 5,
            "changes": 59,
            "blob_url": "https://github.com/angular/angular/blob/0551fbdf889dc1a7a509c3ebb19789b231b10917/aio%2Ftools%2Ftransforms%2Fcli-docs-package%2Fprocessors%2FprocessCliCommands.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/0551fbdf889dc1a7a509c3ebb19789b231b10917/aio%2Ftools%2Ftransforms%2Fcli-docs-package%2Fprocessors%2FprocessCliCommands.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fcli-docs-package%2Fprocessors%2FprocessCliCommands.spec.js?ref=0551fbdf889dc1a7a509c3ebb19789b231b10917",
            "patch": "@@ -258,14 +258,15 @@ describe('processCliCommands processor', () => {\n          docType: 'navigation-json',\n          data: {\n            SideNav: [\n-             {url: 'some/page', title: 'Some Page'}, {\n+             {url: 'some/page', title: 'Some Page'},\n+             {\n                title: 'CLI Commands',\n                tooltip: 'Angular CLI command reference',\n-               children: [{'title': 'Overview', 'url': 'cli'}]\n+               children: [{'title': 'Overview', 'url': 'cli'}],\n              },\n-             {url: 'other/page', title: 'Other Page'}\n-           ]\n-         }\n+             {url: 'other/page', title: 'Other Page'},\n+           ],\n+         },\n        };\n        processor.$process([command, navigation]);\n        expect(navigation.data.SideNav[1].title).toEqual('CLI Commands');\n@@ -275,6 +276,54 @@ describe('processCliCommands processor', () => {\n        ]);\n      });\n \n+  it('should detect the CLI node if it is nested in another node (as long as there is a first child node with a `cli` url',\n+     () => {\n+       const command = {\n+         docType: 'cli-command',\n+         name: 'command1',\n+         commandAliases: ['alias1', 'alias2'],\n+         options: [],\n+         path: 'cli/command1',\n+       };\n+       const navigation = {\n+         docType: 'navigation-json',\n+         data: {\n+           SideNav: [\n+             {url: 'some/page', title: 'Some Page'},\n+             {\n+               title: 'CLI Commands Grandparent',\n+               children: [\n+                 {url: 'some/nested/page', title: 'Some Nested Page'},\n+                 {\n+                   title: 'CLI Commands Parent',\n+                   children: [\n+                     {url: 'some/more/nested/page', title: 'Some More Nested Page'},\n+                     {\n+                       title: 'CLI Commands',\n+                       tooltip: 'Angular CLI command reference',\n+                       children: [{'title': 'Overview', 'url': 'cli'}],\n+                     },\n+                     {url: 'other/more/nested/page', title: 'Other More Nested Page'},\n+                   ],\n+                 },\n+                 {url: 'other/nested/page', title: 'Other Nested Page'},\n+               ],\n+             },\n+             {url: 'other/page', title: 'Other Page'},\n+           ],\n+         },\n+       };\n+\n+       processor.$process([command, navigation]);\n+\n+       const cliCommandsNode = navigation.data.SideNav[1].children[1].children[1];\n+       expect(cliCommandsNode.title).toEqual('CLI Commands');\n+       expect(cliCommandsNode.children).toEqual([\n+         {url: 'cli', title: 'Overview'},\n+         {url: 'cli/command1', title: 'ng command1'},\n+       ]);\n+     });\n+\n   it('should complain if there is no child with `cli` url', () => {\n     const command = {\n       docType: 'cli-command',"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 85,
        "deletions": 10
    }
}