{
    "author": "zelliott",
    "message": "fix(router): properly assign ExtraOptions to Router in RouterTestingModule (#39096)\n\nPreviously, RouterTestingModule only assigned two of the options within ExtraOptions to the Router.\nNow, it assigns the same options as RouterModule does (with the exception of enableTracing) via a\nnew shared function assignExtraOptionsToRouter.\n\nFixes #23347\n\nPR Close #39096",
    "sha": "d8c05347c341b2375644aef60baf371dbf02c3c6",
    "files": [
        {
            "sha": "8fe6e9068677937d24b8a39e1d1be3064bf68b3e",
            "filename": "packages/router/src/private_export.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Fsrc%2Fprivate_export.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Fsrc%2Fprivate_export.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Fprivate_export.ts?ref=d8c05347c341b2375644aef60baf371dbf02c3c6",
            "patch": "@@ -8,5 +8,5 @@\n \n \n export {ɵEmptyOutletComponent} from './components/empty_outlet';\n-export {ROUTER_PROVIDERS as ɵROUTER_PROVIDERS} from './router_module';\n+export {assignExtraOptionsToRouter as ɵassignExtraOptionsToRouter, ROUTER_PROVIDERS as ɵROUTER_PROVIDERS} from './router_module';\n export {flatten as ɵflatten} from './utils/collection';"
        },
        {
            "sha": "bf2d216f639513ce368fe4ecdd3dfb6bb83c619e",
            "filename": "packages/router/src/router_module.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 12,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Fsrc%2Frouter_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Fsrc%2Frouter_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter_module.ts?ref=d8c05347c341b2375644aef60baf371dbf02c3c6",
            "patch": "@@ -448,13 +448,7 @@ export function setupRouter(\n     router.routeReuseStrategy = routeReuseStrategy;\n   }\n \n-  if (opts.errorHandler) {\n-    router.errorHandler = opts.errorHandler;\n-  }\n-\n-  if (opts.malformedUriErrorHandler) {\n-    router.malformedUriErrorHandler = opts.malformedUriErrorHandler;\n-  }\n+  assignExtraOptionsToRouter(opts, router);\n \n   if (opts.enableTracing) {\n     const dom = getDOM();\n@@ -466,6 +460,18 @@ export function setupRouter(\n     });\n   }\n \n+  return router;\n+}\n+\n+export function assignExtraOptionsToRouter(opts: ExtraOptions, router: Router): void {\n+  if (opts.errorHandler) {\n+    router.errorHandler = opts.errorHandler;\n+  }\n+\n+  if (opts.malformedUriErrorHandler) {\n+    router.malformedUriErrorHandler = opts.malformedUriErrorHandler;\n+  }\n+\n   if (opts.onSameUrlNavigation) {\n     router.onSameUrlNavigation = opts.onSameUrlNavigation;\n   }\n@@ -474,15 +480,13 @@ export function setupRouter(\n     router.paramsInheritanceStrategy = opts.paramsInheritanceStrategy;\n   }\n \n-  if (opts.urlUpdateStrategy) {\n-    router.urlUpdateStrategy = opts.urlUpdateStrategy;\n-  }\n-\n   if (opts.relativeLinkResolution) {\n     router.relativeLinkResolution = opts.relativeLinkResolution;\n   }\n \n-  return router;\n+  if (opts.urlUpdateStrategy) {\n+    router.urlUpdateStrategy = opts.urlUpdateStrategy;\n+  }\n }\n \n export function rootRoute(router: Router): ActivatedRoute {"
        },
        {
            "sha": "4884edf0075e1c8b434d136079dd0c7dcded20e5",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 16,
            "changes": 56,
            "blob_url": "https://github.com/angular/angular/blob/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=d8c05347c341b2375644aef60baf371dbf02c3c6",
            "patch": "@@ -5625,30 +5625,54 @@ describe('Integration', () => {\n });\n \n describe('Testing router options', () => {\n-  describe('paramsInheritanceStrategy', () => {\n-    beforeEach(() => {\n+  describe('should configure the router', () => {\n+    it('assigns errorHandler', () => {\n+      function errorHandler(error: any) {\n+        throw error;\n+      }\n       TestBed.configureTestingModule(\n-          {imports: [RouterTestingModule.withRoutes([], {paramsInheritanceStrategy: 'always'})]});\n+          {imports: [RouterTestingModule.withRoutes([], {errorHandler})]});\n+      const router: Router = TestBed.inject(Router);\n+      expect(router.errorHandler).toBe(errorHandler);\n     });\n \n-    it('should configure the router', fakeAsync(inject([Router], (router: Router) => {\n-         expect(router.paramsInheritanceStrategy).toEqual('always');\n-       })));\n-  });\n+    it('assigns malformedUriErrorHandler', () => {\n+      function malformedUriErrorHandler(e: URIError, urlSerializer: UrlSerializer, url: string) {\n+        return urlSerializer.parse('/error');\n+      }\n+      TestBed.configureTestingModule(\n+          {imports: [RouterTestingModule.withRoutes([], {malformedUriErrorHandler})]});\n+      const router: Router = TestBed.inject(Router);\n+      expect(router.malformedUriErrorHandler).toBe(malformedUriErrorHandler);\n+    });\n \n-  describe('malformedUriErrorHandler', () => {\n-    function malformedUriErrorHandler(e: URIError, urlSerializer: UrlSerializer, url: string) {\n-      return urlSerializer.parse('/error');\n-    }\n+    it('assigns onSameUrlNavigation', () => {\n+      TestBed.configureTestingModule(\n+          {imports: [RouterTestingModule.withRoutes([], {onSameUrlNavigation: 'reload'})]});\n+      const router: Router = TestBed.inject(Router);\n+      expect(router.onSameUrlNavigation).toBe('reload');\n+    });\n \n-    beforeEach(() => {\n+    it('assigns paramsInheritanceStrategy', () => {\n       TestBed.configureTestingModule(\n-          {imports: [RouterTestingModule.withRoutes([], {malformedUriErrorHandler})]});\n+          {imports: [RouterTestingModule.withRoutes([], {paramsInheritanceStrategy: 'always'})]});\n+      const router: Router = TestBed.inject(Router);\n+      expect(router.paramsInheritanceStrategy).toBe('always');\n     });\n \n-    it('should configure the router', fakeAsync(inject([Router], (router: Router) => {\n-         expect(router.malformedUriErrorHandler).toBe(malformedUriErrorHandler);\n-       })));\n+    it('assigns relativeLinkResolution', () => {\n+      TestBed.configureTestingModule(\n+          {imports: [RouterTestingModule.withRoutes([], {relativeLinkResolution: 'corrected'})]});\n+      const router: Router = TestBed.inject(Router);\n+      expect(router.relativeLinkResolution).toBe('corrected');\n+    });\n+\n+    it('assigns urlUpdateStrategy', () => {\n+      TestBed.configureTestingModule(\n+          {imports: [RouterTestingModule.withRoutes([], {urlUpdateStrategy: 'eager'})]});\n+      const router: Router = TestBed.inject(Router);\n+      expect(router.urlUpdateStrategy).toBe('eager');\n+    });\n   });\n });\n "
        },
        {
            "sha": "e7dc95e23ad2f33a2841d1896d17be15b827bc46",
            "filename": "packages/router/testing/src/router_testing_module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Ftesting%2Fsrc%2Frouter_testing_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/d8c05347c341b2375644aef60baf371dbf02c3c6/packages%2Frouter%2Ftesting%2Fsrc%2Frouter_testing_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftesting%2Fsrc%2Frouter_testing_module.ts?ref=d8c05347c341b2375644aef60baf371dbf02c3c6",
            "patch": "@@ -9,7 +9,7 @@\n import {Location, LocationStrategy} from '@angular/common';\n import {MockLocationStrategy, SpyLocation} from '@angular/common/testing';\n import {Compiler, Injectable, Injector, ModuleWithProviders, NgModule, NgModuleFactory, NgModuleFactoryLoader, Optional} from '@angular/core';\n-import {ChildrenOutletContexts, ExtraOptions, NoPreloading, PreloadingStrategy, provideRoutes, Route, Router, ROUTER_CONFIGURATION, RouterModule, ROUTES, Routes, UrlHandlingStrategy, UrlSerializer, ɵflatten as flatten, ɵROUTER_PROVIDERS as ROUTER_PROVIDERS} from '@angular/router';\n+import {ChildrenOutletContexts, ExtraOptions, NoPreloading, PreloadingStrategy, provideRoutes, Route, Router, ROUTER_CONFIGURATION, RouterModule, ROUTES, Routes, UrlHandlingStrategy, UrlSerializer, ɵassignExtraOptionsToRouter as assignExtraOptionsToRouter, ɵflatten as flatten, ɵROUTER_PROVIDERS as ROUTER_PROVIDERS} from '@angular/router';\n \n \n \n@@ -124,14 +124,7 @@ export function setupTestingRouter(\n       router.urlHandlingStrategy = opts;\n     } else {\n       // Handle ExtraOptions\n-\n-      if (opts.malformedUriErrorHandler) {\n-        router.malformedUriErrorHandler = opts.malformedUriErrorHandler;\n-      }\n-\n-      if (opts.paramsInheritanceStrategy) {\n-        router.paramsInheritanceStrategy = opts.paramsInheritanceStrategy;\n-      }\n+      assignExtraOptionsToRouter(opts, router);\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 97,
        "additions": 59,
        "deletions": 38
    }
}