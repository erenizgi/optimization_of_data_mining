{
    "author": "petebacondarwin",
    "message": "feat(compiler-cli): add `SourceFile.getOriginalLocation()` to sourcemaps package (#32912)\n\nThis method will allow us to find the original location given a\ngenerated location, which is useful in fine grained work with\nsource-mapping. E.g. in `$localize` tooling.\n\nPR Close #32912",
    "sha": "6abb8d0d915edb01fd03bd458abf427f98bdd470",
    "files": [
        {
            "sha": "02589d6470ad45189c087a96bfc601a1cc871cb6",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/src/source_file.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/6abb8d0d915edb01fd03bd458abf427f98bdd470/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/6abb8d0d915edb01fd03bd458abf427f98bdd470/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Fsrc%2Fsource_file.ts?ref=6abb8d0d915edb01fd03bd458abf427f98bdd470",
            "patch": "@@ -87,6 +87,48 @@ export class SourceFile {\n     return sourceMap;\n   }\n \n+  /**\n+   * Find the original mapped location for the given `line` and `column` in the generated file.\n+   *\n+   * First we search for a mapping whose generated segment is at or directly before the given\n+   * location. Then we compute the offset between the given location and the matching generated\n+   * segment. Finally we apply this offset to the original source segment to get the desired\n+   * original location.\n+   */\n+  getOriginalLocation(line: number, column: number):\n+      {file: AbsoluteFsPath, line: number, column: number}|null {\n+    if (this.flattenedMappings.length === 0) {\n+      return null;\n+    }\n+\n+    let position: number;\n+    if (line < this.startOfLinePositions.length) {\n+      position = this.startOfLinePositions[line] + column;\n+    } else {\n+      // The line is off the end of the file, so just assume we are at the end of the file.\n+      position = this.contents.length;\n+    }\n+\n+    const locationSegment: SegmentMarker = {line, column, position, next: undefined};\n+\n+    let mappingIndex =\n+        findLastMappingIndexBefore(this.flattenedMappings, locationSegment, false, 0);\n+    if (mappingIndex < 0) {\n+      mappingIndex = 0;\n+    }\n+    const {originalSegment, originalSource, generatedSegment} =\n+        this.flattenedMappings[mappingIndex];\n+    const offset = locationSegment.position - generatedSegment.position;\n+    const offsetOriginalSegment =\n+        offsetSegment(originalSource.startOfLinePositions, originalSegment, offset);\n+\n+    return {\n+      file: originalSource.sourcePath,\n+      line: offsetOriginalSegment.line,\n+      column: offsetOriginalSegment.column,\n+    };\n+  }\n+\n   /**\n    * Flatten the parsed mappings for this source file, so that all the mappings are to pure original\n    * source files with no transitive source maps."
        },
        {
            "sha": "e11fd8248892afa424ede8d6835552eafab137d2",
            "filename": "packages/compiler-cli/src/ngtsc/sourcemaps/test/source_file_spec.ts",
            "status": "modified",
            "additions": 143,
            "deletions": 0,
            "changes": 143,
            "blob_url": "https://github.com/angular/angular/blob/6abb8d0d915edb01fd03bd458abf427f98bdd470/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6abb8d0d915edb01fd03bd458abf427f98bdd470/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fsourcemaps%2Ftest%2Fsource_file_spec.ts?ref=6abb8d0d915edb01fd03bd458abf427f98bdd470",
            "patch": "@@ -518,6 +518,149 @@ runInEachFileSystem(() => {\n           expect(aTocSourceMap.mappings).toEqual(aToBSourceMap.mappings);\n         });\n       });\n+\n+      describe('getOriginalLocation()', () => {\n+        it('should return null for source files with no flattened mappings', () => {\n+          const sourceFile =\n+              new SourceFile(_('/foo/src/index.js'), 'index contents', null, false, []);\n+          expect(sourceFile.getOriginalLocation(1, 1)).toEqual(null);\n+        });\n+\n+        it('should return offset locations in multiple flattened original source files', () => {\n+          const cSource = new SourceFile(_('/foo/src/c.js'), 'bcd123', null, false, []);\n+          const dSource = new SourceFile(_('/foo/src/d.js'), 'aef', null, false, []);\n+\n+          const bSourceMap: RawSourceMap = {\n+            mappings: encode([\n+              [\n+                [0, 1, 0, 0],  // \"a\" is in d.js [source 1]\n+                [1, 0, 0, 0],  // \"bcd\" are in c.js [source 0]\n+                [4, 1, 0, 1],  // \"ef\" are in d.js [source 1]\n+              ],\n+            ]),\n+            names: [],\n+            sources: ['c.js', 'd.js'],\n+            version: 3\n+          };\n+          const bSource =\n+              new SourceFile(_('/foo/src/b.js'), 'abcdef', bSourceMap, false, [cSource, dSource]);\n+\n+          const aSourceMap: RawSourceMap = {\n+            mappings: encode([\n+              [\n+                [0, 0, 0, 0], [2, 0, 0, 3],  // \"c\" is missing from first line\n+              ],\n+              [\n+                [4, 0, 0, 2],  // second line has new indentation, and starts with \"c\"\n+                [5, 0, 0, 5],  // \"f\" is here\n+              ],\n+            ]),\n+            names: [],\n+            sources: ['b.js'],\n+            version: 3\n+          };\n+          const aSource =\n+              new SourceFile(_('/foo/src/a.js'), 'abde\\n    cf', aSourceMap, false, [bSource]);\n+\n+          // Line 0\n+          expect(aSource.getOriginalLocation(0, 0))  // a\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 0});\n+          expect(aSource.getOriginalLocation(0, 1))  // b\n+              .toEqual({file: cSource.sourcePath, line: 0, column: 0});\n+          expect(aSource.getOriginalLocation(0, 2))  // d\n+              .toEqual({file: cSource.sourcePath, line: 0, column: 2});\n+          expect(aSource.getOriginalLocation(0, 3))  // e\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 1});\n+          expect(aSource.getOriginalLocation(0, 4))  // off the end of the line\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 2});\n+\n+          // Line 1\n+          expect(aSource.getOriginalLocation(1, 0))  // indent\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 3});\n+          expect(aSource.getOriginalLocation(1, 1))  // indent\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 4});\n+          expect(aSource.getOriginalLocation(1, 2))  // indent\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 5});\n+          expect(aSource.getOriginalLocation(1, 3))  // indent\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 6});\n+          expect(aSource.getOriginalLocation(1, 4))  // c\n+              .toEqual({file: cSource.sourcePath, line: 0, column: 1});\n+          expect(aSource.getOriginalLocation(1, 5))  // f\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 2});\n+          expect(aSource.getOriginalLocation(1, 6))  // off the end of the line\n+              .toEqual({file: dSource.sourcePath, line: 0, column: 3});\n+        });\n+\n+        it('should return offset locations across multiple lines', () => {\n+          const originalSource =\n+              new SourceFile(_('/foo/src/original.js'), 'abcdef\\nghijk\\nlmnop', null, false, []);\n+          const generatedSourceMap: RawSourceMap = {\n+            mappings: encode([\n+              [\n+                [0, 0, 0, 0],  // \"ABC\" [0,0] => [0,0]\n+              ],\n+              [\n+                [0, 0, 1, 0],  // \"GHIJ\" [1, 0] => [1,0]\n+                [4, 0, 0, 3],  // \"DEF\" [1, 4] => [0,3]\n+                [7, 0, 1, 4],  // \"K\" [1, 7] => [1,4]\n+              ],\n+              [\n+                [0, 0, 2, 0],  // \"LMNOP\" [2,0] => [2,0]\n+              ],\n+            ]),\n+            names: [],\n+            sources: ['original.js'],\n+            version: 3\n+          };\n+          const generatedSource = new SourceFile(\n+              _('/foo/src/generated.js'), 'ABC\\nGHIJDEFK\\nLMNOP', generatedSourceMap, false,\n+              [originalSource]);\n+\n+          // Line 0\n+          expect(generatedSource.getOriginalLocation(0, 0))  // A\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 0});\n+          expect(generatedSource.getOriginalLocation(0, 1))  // B\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 1});\n+          expect(generatedSource.getOriginalLocation(0, 2))  // C\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 2});\n+          expect(generatedSource.getOriginalLocation(0, 3))  // off the end of line 0\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 3});\n+\n+          // Line 1\n+          expect(generatedSource.getOriginalLocation(1, 0))  // G\n+              .toEqual({file: originalSource.sourcePath, line: 1, column: 0});\n+          expect(generatedSource.getOriginalLocation(1, 1))  // H\n+              .toEqual({file: originalSource.sourcePath, line: 1, column: 1});\n+          expect(generatedSource.getOriginalLocation(1, 2))  // I\n+              .toEqual({file: originalSource.sourcePath, line: 1, column: 2});\n+          expect(generatedSource.getOriginalLocation(1, 3))  // J\n+              .toEqual({file: originalSource.sourcePath, line: 1, column: 3});\n+          expect(generatedSource.getOriginalLocation(1, 4))  // D\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 3});\n+          expect(generatedSource.getOriginalLocation(1, 5))  // E\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 4});\n+          expect(generatedSource.getOriginalLocation(1, 6))  // F\n+              .toEqual({file: originalSource.sourcePath, line: 0, column: 5});\n+          expect(generatedSource.getOriginalLocation(1, 7))  // K\n+              .toEqual({file: originalSource.sourcePath, line: 1, column: 4});\n+          expect(generatedSource.getOriginalLocation(1, 8))  // off the end of line 1\n+              .toEqual({file: originalSource.sourcePath, line: 1, column: 5});\n+\n+          // Line 2\n+          expect(generatedSource.getOriginalLocation(2, 0))  // L\n+              .toEqual({file: originalSource.sourcePath, line: 2, column: 0});\n+          expect(generatedSource.getOriginalLocation(2, 1))  // M\n+              .toEqual({file: originalSource.sourcePath, line: 2, column: 1});\n+          expect(generatedSource.getOriginalLocation(2, 2))  // N\n+              .toEqual({file: originalSource.sourcePath, line: 2, column: 2});\n+          expect(generatedSource.getOriginalLocation(2, 3))  // O\n+              .toEqual({file: originalSource.sourcePath, line: 2, column: 3});\n+          expect(generatedSource.getOriginalLocation(2, 4))  // P\n+              .toEqual({file: originalSource.sourcePath, line: 2, column: 4});\n+          expect(generatedSource.getOriginalLocation(2, 5))  // off the end of line 2\n+              .toEqual({file: originalSource.sourcePath, line: 2, column: 5});\n+        });\n+      });\n     });\n \n     describe('computeStartOfLinePositions()', () => {"
        }
    ],
    "stats": {
        "total": 185,
        "additions": 185,
        "deletions": 0
    }
}