{
    "author": "petebacondarwin",
    "message": "build(docs-infra): support overriding boilerplate files in examples (#43216)\n\nIt is now possible to specify file paths in the `\"boilerplate-override\"`\nproperty of `example-config.json` files to tell the example boilerplate\nsystem to use the file in the example directory rather than overwriting the\nexample file with that from the boilerplate directory.\n\nPR Close #43216",
    "sha": "79aa78416874f6059a4373844025c81217ed9a9a",
    "files": [
        {
            "sha": "8351866fdd7195b41eed22000d6cadabc8f532b7",
            "filename": "aio/tools/examples/README.md",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2FREADME.md",
            "raw_url": "https://github.com/angular/angular/raw/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2FREADME.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fexamples%2FREADME.md?ref=79aa78416874f6059a4373844025c81217ed9a9a",
            "patch": "@@ -68,6 +68,9 @@ The file is expected to contain a JSON object with zero or more of the following\n   Default: `\"cli\"`\n - `useCommonBoilerplate: boolean`: Whether to include common boilerplate from the [common/](./shared/boilerplate/common) folder.\n   Default: `true`\n+- `\"overrideBoilerplate\": string[]`: A list of paths to boilerplate files that are overridden by custom files in this example.\n+  Commonly this is used when a boilerplate file is referenced in a guide and so needs to have doc-regions added.\n+  When adding such overrides, ensure that the file is \"unignored\" by adding an appropriate negation pattern to the `content/examples/.gitignore` file.\n \n **SystemJS-only properties:**\n - `build: string`: The npm script to run in order to build the example app.\n@@ -127,13 +130,15 @@ yarn protractor [--params.outputFile=path/to/logfile.txt]\n \n ### `example-boilerplate.js`\n \n-The [example-boilerplate.js](./example-boilerplate.js) script installs the dependencies for all examples, creates the `node_modules/` symlinks and copies the necessary boilerplate files into example folders.\n-\n-It also contains a function to remove all the boilerplate.\n-It uses `git clean -xdf` to do the job.\n-It will remove all files that are not tracked by git, **including any new files that you are working on that haven't been staged yet.**\n-So, be sure to commit your work before removing the boilerplate.\n+The [example-boilerplate.js](./example-boilerplate.js) script manages the dependencies for all examples.\n \n+- `example-boilerplate.js add`: create the `node_modules/` symlinks and copy the necessary boilerplate files into example folders.\n+- `example-boilerplate.js remove`: remove all the boilerplate files from examples.\n+  It uses `git clean -xdf` to do the job.\n+  It will remove all files that are not tracked by git, **including any new files that you are working on that haven't been staged yet.**\n+  So, be sure to commit your work before removing the boilerplate.\n+- `example-boilerplate.js list-overrides`: print out a list of all example files that override boilerplate files.\n+  This is useful when updating the boilerplate files to a new version of Angular.\n \n ### `run-example-e2e.mjs`\n "
        },
        {
            "sha": "a5174d5cf746bfdcecbe3d56faefa58d82fdb3e6",
            "filename": "aio/tools/examples/UPDATING.md",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2FUPDATING.md",
            "raw_url": "https://github.com/angular/angular/raw/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2FUPDATING.md",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fexamples%2FUPDATING.md?ref=79aa78416874f6059a4373844025c81217ed9a9a",
            "patch": "@@ -47,6 +47,12 @@ Any necessary changes to boilerplate files will be done automatically through mi\n - Ensure any changes to [cli/tslint.json](./shared/boilerplate/cli/tslint.json) are ported over to [systemjs/tslint.json](./shared/boilerplate/systemjs/tslint.json) and also [aio/content/examples/tslint.json](../../content/examples/tslint.json).\n   This last part is important, since this file is used to lint example code on CI.\n \n+- Run the following command to list all the boilerplate files that are overridden in specific examples.\n+  ```sh\n+  node example-boilerplate.js list-overrides\n+  ```\n+  Inspect each of these files to determine whether they need to be updated.\n+\n - Inspect the changes and determine whether some of them need to be applied to the `systemjs` boilerplate files.\n \n - Inspect the changes and determine whether any updates to guides are necessary."
        },
        {
            "sha": "83b89d9efee66aa0dd86036e7d4d5684204981c5",
            "filename": "aio/tools/examples/example-boilerplate.js",
            "status": "modified",
            "additions": 39,
            "deletions": 1,
            "changes": 40,
            "blob_url": "https://github.com/angular/angular/blob/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2Fexample-boilerplate.js",
            "raw_url": "https://github.com/angular/angular/raw/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2Fexample-boilerplate.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fexamples%2Fexample-boilerplate.js?ref=79aa78416874f6059a4373844025c81217ed9a9a",
            "patch": "@@ -21,7 +21,6 @@ class ExampleBoilerPlate {\n     const exampleFolders =\n         this.getFoldersContaining(EXAMPLES_BASE_PATH, EXAMPLE_CONFIG_FILENAME, 'node_modules');\n     const gitignore = ignore().add(fs.readFileSync(path.resolve(BOILERPLATE_BASE_PATH, '.gitignore'), 'utf8'));\n-    const isPathIgnored = absolutePath => gitignore.ignores(path.relative(BOILERPLATE_BASE_PATH, absolutePath));\n \n     if (!fs.existsSync(SHARED_NODE_MODULES_PATH)) {\n       throw new Error(\n@@ -34,6 +33,16 @@ class ExampleBoilerPlate {\n     exampleFolders.forEach(exampleFolder => {\n       const exampleConfig = this.loadJsonFile(path.resolve(exampleFolder, EXAMPLE_CONFIG_FILENAME));\n \n+      // Compute additional boilerplate files that should not be copied over for this specific example\n+      // This allows the example to override boilerplate files locally, perhaps to include doc-regions specific to the example.\n+      const overrideBoilerplate = exampleConfig['overrideBoilerplate'] || [];\n+      const boilerplateIgnore = ignore().add(gitignore).add(\n+        // Note that the `*` here is to skip over the boilerplate folder itself.\n+        // E.g. if the override is `a/b` then we what to match `cli/a/b` and `i18n/a/b` etc.\n+        overrideBoilerplate.map(p => path.join('*', p))\n+      );\n+      const isPathIgnored = absolutePath => boilerplateIgnore.ignores(path.relative(BOILERPLATE_BASE_PATH, absolutePath));\n+\n       // Link the node modules - requires admin access (on Windows) because it adds symlinks\n       const destinationNodeModules = path.resolve(exampleFolder, 'node_modules');\n       fs.ensureSymlinkSync(SHARED_NODE_MODULES_PATH, destinationNodeModules);\n@@ -63,10 +72,39 @@ class ExampleBoilerPlate {\n    */\n   remove() { shelljs.exec('git clean -xdfq', {cwd: EXAMPLES_BASE_PATH}); }\n \n+  listOverrides() {\n+    const exampleFolders =\n+        this.getFoldersContaining(EXAMPLES_BASE_PATH, EXAMPLE_CONFIG_FILENAME, 'node_modules');\n+\n+    const overriddenFiles = [];\n+    exampleFolders.forEach(exampleFolder => {\n+      const exampleConfig = this.loadJsonFile(path.resolve(exampleFolder, EXAMPLE_CONFIG_FILENAME));\n+      const overrideBoilerplate = exampleConfig['overrideBoilerplate'] || [];\n+      if (overrideBoilerplate.length > 0) {\n+        for (const file of overrideBoilerplate) {\n+          overriddenFiles.push(path.relative(EXAMPLES_BASE_PATH, path.resolve(exampleFolder, file)));\n+        }\n+      }\n+    });\n+\n+    if (overriddenFiles.length > 0) {\n+      console.log(`Boilerplate files that have been overridden in examples:`);\n+      for (const file of overriddenFiles) {\n+        console.log(` - ${file}`);\n+      }\n+      console.log(`(All these paths are relative to ${EXAMPLES_BASE_PATH}.)`);\n+      console.log('If you are updating the boilerplate files then also consider updating these too.');\n+    } else {\n+      console.log('No boilerplate files have been overridden in examples.');\n+      console.log('You are safe to update the boilerplate files.');\n+    }\n+  }\n+\n   main() {\n     yargs.usage('$0 <cmd> [args]')\n         .command('add', 'add the boilerplate to each example', yrgs => this.add())\n         .command('remove', 'remove the boilerplate from each example', () => this.remove())\n+        .command('list-overrides', 'list all the boilerplate files that have been overridden in examples', () => this.listOverrides())\n         .demandCommand(1, 'Please supply a command from the list above')\n         .argv;\n   }"
        },
        {
            "sha": "db1204d91d2a62a464b3f5f2411a94d575b30938",
            "filename": "aio/tools/examples/example-boilerplate.spec.js",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2Fexample-boilerplate.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/79aa78416874f6059a4373844025c81217ed9a9a/aio%2Ftools%2Fexamples%2Fexample-boilerplate.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fexamples%2Fexample-boilerplate.spec.js?ref=79aa78416874f6059a4373844025c81217ed9a9a",
            "patch": "@@ -127,6 +127,19 @@ describe('example-boilerplate tool', () => {\n       ]);\n     });\n \n+    it('should not copy boilerplate files that are match `overrideBoilerplate` in the example-config.json file', () => {\n+      const boilerplateDir = path.resolve(sharedDir, 'boilerplate');\n+      exampleBoilerPlate.loadJsonFile.and.returnValue({\n+        'overrideBoilerplate': [ 'c/d' ]\n+      });\n+\n+      exampleBoilerPlate.add();\n+\n+      const isPathIgnored = exampleBoilerPlate.copyDirectoryContents.calls.first().args[2];\n+      expect(isPathIgnored(`${boilerplateDir}/cli/a/b`)).toBe(false);\n+      expect(isPathIgnored(`${boilerplateDir}/cli/c/d`)).toBe(true);\n+    });\n+\n     it('should try to load the example config file', () => {\n       exampleBoilerPlate.add();\n       expect(exampleBoilerPlate.loadJsonFile).toHaveBeenCalledTimes(exampleFolders.length);\n@@ -143,6 +156,44 @@ describe('example-boilerplate tool', () => {\n     });\n   });\n \n+  describe('listOverrides', () => {\n+    const examplesDir = path.resolve(__dirname, '../../content/examples');\n+    const exampleFolders = ['a/b', 'c/d', 'e/f'];\n+    beforeEach(() => {\n+      spyOn(exampleBoilerPlate, 'getFoldersContaining').and.returnValue(exampleFolders);\n+      spyOn(console, 'log');\n+    });\n+\n+    it('should list all files that are overridden in examples', () => {\n+      spyOn(exampleBoilerPlate, 'loadJsonFile').and.returnValues(\n+        {\"overrideBoilerplate\": [\"angular.json\", \"tsconfig.json\"]}, // a/b/example-config.json\n+        {\"overrideBoilerplate\": []}, // c/d/example-config.json\n+        {}, // e/f/example-config.json\n+      );\n+      exampleBoilerPlate.listOverrides();\n+      expect(exampleBoilerPlate.getFoldersContaining)\n+          .toHaveBeenCalledWith(examplesDir, 'example-config.json', 'node_modules');\n+      expect(console.log).toHaveBeenCalledWith('Boilerplate files that have been overridden in examples:');\n+      expect(console.log).toHaveBeenCalledWith(' - ../../a/b/angular.json');\n+      expect(console.log).toHaveBeenCalledWith(' - ../../a/b/tsconfig.json');\n+      expect(console.log).toHaveBeenCalledWith(`(All these paths are relative to ${examplesDir}.)`);\n+      expect(console.log).toHaveBeenCalledWith('If you are updating the boilerplate files then also consider updating these too.');\n+    });\n+\n+    it('should display a helpful message if there are no overridden files', () => {\n+      spyOn(exampleBoilerPlate, 'loadJsonFile').and.returnValues(\n+        {\"overrideBoilerplate\": null}, // a/b/example-config.json\n+        {\"overrideBoilerplate\": []}, // c/d/example-config.json\n+        {}, // e/f/example-config.json\n+      );\n+      exampleBoilerPlate.listOverrides();\n+      expect(exampleBoilerPlate.getFoldersContaining)\n+          .toHaveBeenCalledWith(examplesDir, 'example-config.json', 'node_modules');\n+      expect(console.log).toHaveBeenCalledWith('No boilerplate files have been overridden in examples.');\n+      expect(console.log).toHaveBeenCalledWith('You are safe to update the boilerplate files.');\n+    });\n+  });\n+\n   describe('getFoldersContaining', () => {\n     it('should use glob.sync', () => {\n       spyOn(glob, 'sync').and.returnValue(['a/b/config.json', 'c/d/config.json']);"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 107,
        "deletions": 7
    }
}