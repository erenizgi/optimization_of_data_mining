{
    "author": "alxhub",
    "message": "refactor(compiler-cli): split out template diagnostics package (#38576)\n\nThe template type-checking engine includes utilities for creating\n`ts.Diagnostic`s for component templates. Previously only the template type-\nchecker itself created such diagnostics. However, the template parser also\nproduces errors which should be represented as template diagnostics.\n\nThis commit prepares for that conversion by extracting the machinery for\nproducing template diagnostics into its own sub-package, so that other parts\nof the compiler can depend on it without depending on the entire template\ntype-checker.\n\nPR Close #38576",
    "sha": "3e97435f1c42f71a1e9b8269397fcac88fb3da75",
    "files": [
        {
            "sha": "b9ed59e4694ca903593ee57226726545e62685bf",
            "filename": "goldens/public-api/compiler-cli/error_code.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcompiler-cli%2Ferror_code.d.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -19,6 +19,7 @@ export declare enum ErrorCode {\n     CONFIG_FLAT_MODULE_NO_INDEX = 4001,\n     CONFIG_STRICT_TEMPLATES_IMPLIES_FULL_TEMPLATE_TYPECHECK = 4002,\n     HOST_BINDING_PARSE_ERROR = 5001,\n+    TEMPLATE_PARSE_ERROR = 5002,\n     NGMODULE_INVALID_DECLARATION = 6001,\n     NGMODULE_INVALID_IMPORT = 6002,\n     NGMODULE_INVALID_EXPORT = 6003,"
        },
        {
            "sha": "ce0cef9979c2c6757648683ee1e3b3ba064ebffc",
            "filename": "packages/compiler-cli/src/ngtsc/core/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2FBUILD.bazel?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -34,6 +34,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/transform\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "97b676c20967647491df8d72fc955629a0a3243f",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -28,8 +28,9 @@ import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeRe\n import {generatedFactoryTransform} from '../../shims';\n import {ivySwitchTransform} from '../../switch';\n import {aliasTransformFactory, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n-import {isTemplateDiagnostic, TemplateTypeCheckerImpl} from '../../typecheck';\n+import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy} from '../../typecheck/api';\n+import {isTemplateDiagnostic} from '../../typecheck/diagnostics';\n import {getSourceFileOrNull, isDtsPath, resolveModuleName} from '../../util/src/typescript';\n import {LazyRoute, NgCompilerAdapter, NgCompilerOptions} from '../api';\n "
        },
        {
            "sha": "b9c2e93c72a2c481ccd1f321fb4a6bd32286bfce",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2FBUILD.bazel?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -20,6 +20,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/shims:api\",\n         \"//packages/compiler-cli/src/ngtsc/translator\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\","
        },
        {
            "sha": "e9c8b1e10b336062609cf8fb5722e379b5fd1717",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/diagnostics/BUILD.bazel",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2FBUILD.bazel?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -0,0 +1,15 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//visibility:public\"])\n+\n+ts_library(\n+    name = \"diagnostics\",\n+    srcs = glob([\"**/*.ts\"]),\n+    module_name = \"@angular/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n+    deps = [\n+        \"//packages:types\",\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "9d996df98fd8a2a8116298f7eef0161ba2dc2eed",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/diagnostics/index.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Findex.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './src/diagnostic';\n+export * from './src/id';"
        },
        {
            "sha": "4070a47a7a4df0946cd6b70a3f7ea5c7b58aad92",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/diagnostics/src/diagnostic.ts",
            "status": "added",
            "additions": 128,
            "deletions": 0,
            "changes": 128,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fdiagnostic.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fdiagnostic.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fdiagnostic.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -0,0 +1,128 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ParseSourceSpan} from '@angular/compiler';\n+import * as ts from 'typescript';\n+\n+import {ExternalTemplateSourceMapping, TemplateId, TemplateSourceMapping} from '../../api';\n+\n+/**\n+ * A `ts.Diagnostic` with additional information about the diagnostic related to template\n+ * type-checking.\n+ */\n+export interface TemplateDiagnostic extends ts.Diagnostic {\n+  /**\n+   * The component with the template that resulted in this diagnostic.\n+   */\n+  componentFile: ts.SourceFile;\n+\n+  /**\n+   * The template id of the component that resulted in this diagnostic.\n+   */\n+  templateId: TemplateId;\n+}\n+\n+/**\n+ * Constructs a `ts.Diagnostic` for a given `ParseSourceSpan` within a template.\n+ */\n+export function makeTemplateDiagnostic(\n+    templateId: TemplateId, mapping: TemplateSourceMapping, span: ParseSourceSpan,\n+    category: ts.DiagnosticCategory, code: number, messageText: string|ts.DiagnosticMessageChain,\n+    relatedMessage?: {\n+      text: string,\n+      span: ParseSourceSpan,\n+    }): TemplateDiagnostic {\n+  if (mapping.type === 'direct') {\n+    let relatedInformation: ts.DiagnosticRelatedInformation[]|undefined = undefined;\n+    if (relatedMessage !== undefined) {\n+      relatedInformation = [{\n+        category: ts.DiagnosticCategory.Message,\n+        code: 0,\n+        file: mapping.node.getSourceFile(),\n+        start: relatedMessage.span.start.offset,\n+        length: relatedMessage.span.end.offset - relatedMessage.span.start.offset,\n+        messageText: relatedMessage.text,\n+      }];\n+    }\n+    // For direct mappings, the error is shown inline as ngtsc was able to pinpoint a string\n+    // constant within the `@Component` decorator for the template. This allows us to map the error\n+    // directly into the bytes of the source file.\n+    return {\n+      source: 'ngtsc',\n+      code,\n+      category,\n+      messageText,\n+      file: mapping.node.getSourceFile(),\n+      componentFile: mapping.node.getSourceFile(),\n+      templateId,\n+      start: span.start.offset,\n+      length: span.end.offset - span.start.offset,\n+      relatedInformation,\n+    };\n+  } else if (mapping.type === 'indirect' || mapping.type === 'external') {\n+    // For indirect mappings (template was declared inline, but ngtsc couldn't map it directly\n+    // to a string constant in the decorator), the component's file name is given with a suffix\n+    // indicating it's not the TS file being displayed, but a template.\n+    // For external temoplates, the HTML filename is used.\n+    const componentSf = mapping.componentClass.getSourceFile();\n+    const componentName = mapping.componentClass.name.text;\n+    // TODO(alxhub): remove cast when TS in g3 supports this narrowing.\n+    const fileName = mapping.type === 'indirect' ?\n+        `${componentSf.fileName} (${componentName} template)` :\n+        (mapping as ExternalTemplateSourceMapping).templateUrl;\n+    // TODO(alxhub): investigate creating a fake `ts.SourceFile` here instead of invoking the TS\n+    // parser against the template (HTML is just really syntactically invalid TypeScript code ;).\n+    // Also investigate caching the file to avoid running the parser multiple times.\n+    const sf = ts.createSourceFile(\n+        fileName, mapping.template, ts.ScriptTarget.Latest, false, ts.ScriptKind.JSX);\n+\n+    let relatedInformation: ts.DiagnosticRelatedInformation[] = [];\n+    if (relatedMessage !== undefined) {\n+      relatedInformation.push({\n+        category: ts.DiagnosticCategory.Message,\n+        code: 0,\n+        file: sf,\n+        start: relatedMessage.span.start.offset,\n+        length: relatedMessage.span.end.offset - relatedMessage.span.start.offset,\n+        messageText: relatedMessage.text,\n+      });\n+    }\n+\n+    relatedInformation.push({\n+      category: ts.DiagnosticCategory.Message,\n+      code: 0,\n+      file: componentSf,\n+      // mapping.node represents either the 'template' or 'templateUrl' expression. getStart()\n+      // and getEnd() are used because they don't include surrounding whitespace.\n+      start: mapping.node.getStart(),\n+      length: mapping.node.getEnd() - mapping.node.getStart(),\n+      messageText: `Error occurs in the template of component ${componentName}.`,\n+    });\n+\n+    return {\n+      source: 'ngtsc',\n+      category,\n+      code,\n+      messageText,\n+      file: sf,\n+      componentFile: componentSf,\n+      templateId,\n+      start: span.start.offset,\n+      length: span.end.offset - span.start.offset,\n+      // Show a secondary message indicating the component whose template contains the error.\n+      relatedInformation,\n+    };\n+  } else {\n+    throw new Error(`Unexpected source mapping type: ${(mapping as {type: string}).type}`);\n+  }\n+}\n+\n+export function isTemplateDiagnostic(diagnostic: ts.Diagnostic): diagnostic is TemplateDiagnostic {\n+  return diagnostic.hasOwnProperty('componentFile') &&\n+      ts.isSourceFile((diagnostic as any).componentFile);\n+}"
        },
        {
            "sha": "b7ae05a833e28a04434a06347f8f76651b985ce6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/diagnostics/src/id.ts",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fid.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fid.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fdiagnostics%2Fsrc%2Fid.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -0,0 +1,38 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript';\n+\n+import {TemplateId} from '../../api';\n+\n+\n+const TEMPLATE_ID = Symbol('ngTemplateId');\n+const NEXT_TEMPLATE_ID = Symbol('ngNextTemplateId');\n+\n+interface HasTemplateId {\n+  [TEMPLATE_ID]: TemplateId;\n+}\n+\n+interface HasNextTemplateId {\n+  [NEXT_TEMPLATE_ID]: number;\n+}\n+\n+export function getTemplateId(clazz: ts.Declaration): TemplateId {\n+  const node = clazz as ts.Declaration & Partial<HasTemplateId>;\n+  if (node[TEMPLATE_ID] === undefined) {\n+    node[TEMPLATE_ID] = allocateTemplateId(node.getSourceFile());\n+  }\n+  return node[TEMPLATE_ID]!;\n+}\n+\n+function allocateTemplateId(sf: ts.SourceFile&Partial<HasNextTemplateId>): TemplateId {\n+  if (sf[NEXT_TEMPLATE_ID] === undefined) {\n+    sf[NEXT_TEMPLATE_ID] = 1;\n+  }\n+  return (`tcb${sf[NEXT_TEMPLATE_ID]!++}`) as TemplateId;\n+}"
        },
        {
            "sha": "aaa0b33c998e403e2df136f9ec766cb800f9f0a5",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Findex.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -9,7 +9,6 @@\n export {ReusedProgramStrategy} from './src/augmented_program';\n export {FileTypeCheckingData, TemplateTypeCheckerImpl} from './src/checker';\n export {TypeCheckContextImpl} from './src/context';\n-export {isTemplateDiagnostic, TemplateDiagnostic} from './src/diagnostics';\n export {TypeCheckProgramHost} from './src/host';\n export {TypeCheckShimGenerator} from './src/shim';\n export {typeCheckFilePath} from './src/type_check_file';"
        },
        {
            "sha": "ac29846329d640488a1e098c87fc29eeb70ff140",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -16,9 +16,10 @@ import {ReflectionHost} from '../../reflection';\n import {isShim} from '../../shims';\n import {getSourceFileOrNull} from '../../util/src/typescript';\n import {OptimizeFor, ProgramTypeCheckAdapter, TemplateId, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy, UpdateMode} from '../api';\n+import {TemplateDiagnostic} from '../diagnostics';\n \n import {InliningMode, ShimTypeCheckingData, TypeCheckContextImpl, TypeCheckingHost} from './context';\n-import {findTypeCheckBlock, shouldReportDiagnostic, TemplateDiagnostic, TemplateSourceResolver, translateDiagnostic} from './diagnostics';\n+import {findTypeCheckBlock, shouldReportDiagnostic, TemplateSourceResolver, translateDiagnostic} from './diagnostics';\n import {TemplateSourceManager} from './source';\n \n /**"
        },
        {
            "sha": "fc37c26b78f3324d63fd5ae3295bff04ac0a9ca8",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcontext.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -14,8 +14,8 @@ import {NoopImportRewriter, Reference, ReferenceEmitter} from '../../imports';\n import {ClassDeclaration, ReflectionHost} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {ComponentToShimMappingStrategy, TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckContext, TypeCheckingConfig, TypeCtorMetadata} from '../api';\n+import {TemplateDiagnostic} from '../diagnostics';\n \n-import {TemplateDiagnostic} from './diagnostics';\n import {DomSchemaChecker, RegistryDomSchemaChecker} from './dom';\n import {Environment} from './environment';\n import {OutOfBandDiagnosticRecorder, OutOfBandDiagnosticRecorderImpl} from './oob';"
        },
        {
            "sha": "99476d31e2dc8e37797e8d2168a7745003d6bb30",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/diagnostics.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 117,
            "changes": 118,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdiagnostics.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -10,23 +10,7 @@ import * as ts from 'typescript';\n \n import {getTokenAtPosition} from '../../util/src/typescript';\n import {ExternalTemplateSourceMapping, TemplateId, TemplateSourceMapping} from '../api';\n-\n-\n-/**\n- * A `ts.Diagnostic` with additional information about the diagnostic related to template\n- * type-checking.\n- */\n-export interface TemplateDiagnostic extends ts.Diagnostic {\n-  /**\n-   * The component with the template that resulted in this diagnostic.\n-   */\n-  componentFile: ts.SourceFile;\n-\n-  /**\n-   * The template id of the component that resulted in this diagnostic.\n-   */\n-  templateId: TemplateId;\n-}\n+import {makeTemplateDiagnostic, TemplateDiagnostic} from '../diagnostics';\n \n /**\n  * Adapter interface which allows the template type-checking diagnostics code to interpret offsets\n@@ -157,101 +141,6 @@ export function findTypeCheckBlock(file: ts.SourceFile, id: TemplateId): ts.Node\n   return null;\n }\n \n-/**\n- * Constructs a `ts.Diagnostic` for a given `ParseSourceSpan` within a template.\n- */\n-export function makeTemplateDiagnostic(\n-    templateId: TemplateId, mapping: TemplateSourceMapping, span: ParseSourceSpan,\n-    category: ts.DiagnosticCategory, code: number, messageText: string|ts.DiagnosticMessageChain,\n-    relatedMessage?: {\n-      text: string,\n-      span: ParseSourceSpan,\n-    }): TemplateDiagnostic {\n-  if (mapping.type === 'direct') {\n-    let relatedInformation: ts.DiagnosticRelatedInformation[]|undefined = undefined;\n-    if (relatedMessage !== undefined) {\n-      relatedInformation = [{\n-        category: ts.DiagnosticCategory.Message,\n-        code: 0,\n-        file: mapping.node.getSourceFile(),\n-        start: relatedMessage.span.start.offset,\n-        length: relatedMessage.span.end.offset - relatedMessage.span.start.offset,\n-        messageText: relatedMessage.text,\n-      }];\n-    }\n-    // For direct mappings, the error is shown inline as ngtsc was able to pinpoint a string\n-    // constant within the `@Component` decorator for the template. This allows us to map the error\n-    // directly into the bytes of the source file.\n-    return {\n-      source: 'ngtsc',\n-      code,\n-      category,\n-      messageText,\n-      file: mapping.node.getSourceFile(),\n-      componentFile: mapping.node.getSourceFile(),\n-      templateId,\n-      start: span.start.offset,\n-      length: span.end.offset - span.start.offset,\n-      relatedInformation,\n-    };\n-  } else if (mapping.type === 'indirect' || mapping.type === 'external') {\n-    // For indirect mappings (template was declared inline, but ngtsc couldn't map it directly\n-    // to a string constant in the decorator), the component's file name is given with a suffix\n-    // indicating it's not the TS file being displayed, but a template.\n-    // For external temoplates, the HTML filename is used.\n-    const componentSf = mapping.componentClass.getSourceFile();\n-    const componentName = mapping.componentClass.name.text;\n-    // TODO(alxhub): remove cast when TS in g3 supports this narrowing.\n-    const fileName = mapping.type === 'indirect' ?\n-        `${componentSf.fileName} (${componentName} template)` :\n-        (mapping as ExternalTemplateSourceMapping).templateUrl;\n-    // TODO(alxhub): investigate creating a fake `ts.SourceFile` here instead of invoking the TS\n-    // parser against the template (HTML is just really syntactically invalid TypeScript code ;).\n-    // Also investigate caching the file to avoid running the parser multiple times.\n-    const sf = ts.createSourceFile(\n-        fileName, mapping.template, ts.ScriptTarget.Latest, false, ts.ScriptKind.JSX);\n-\n-    let relatedInformation: ts.DiagnosticRelatedInformation[] = [];\n-    if (relatedMessage !== undefined) {\n-      relatedInformation.push({\n-        category: ts.DiagnosticCategory.Message,\n-        code: 0,\n-        file: sf,\n-        start: relatedMessage.span.start.offset,\n-        length: relatedMessage.span.end.offset - relatedMessage.span.start.offset,\n-        messageText: relatedMessage.text,\n-      });\n-    }\n-\n-    relatedInformation.push({\n-      category: ts.DiagnosticCategory.Message,\n-      code: 0,\n-      file: componentSf,\n-      // mapping.node represents either the 'template' or 'templateUrl' expression. getStart()\n-      // and getEnd() are used because they don't include surrounding whitespace.\n-      start: mapping.node.getStart(),\n-      length: mapping.node.getEnd() - mapping.node.getStart(),\n-      messageText: `Error occurs in the template of component ${componentName}.`,\n-    });\n-\n-    return {\n-      source: 'ngtsc',\n-      category,\n-      code,\n-      messageText,\n-      file: sf,\n-      componentFile: componentSf,\n-      templateId,\n-      start: span.start.offset,\n-      length: span.end.offset - span.start.offset,\n-      // Show a secondary message indicating the component whose template contains the error.\n-      relatedInformation,\n-    };\n-  } else {\n-    throw new Error(`Unexpected source mapping type: ${(mapping as {type: string}).type}`);\n-  }\n-}\n-\n interface SourceLocation {\n   id: TemplateId;\n   span: AbsoluteSourceSpan;\n@@ -338,8 +227,3 @@ function hasIgnoreMarker(node: ts.Node, sourceFile: ts.SourceFile): boolean {\n     return commentText === IGNORE_MARKER;\n   }) === true;\n }\n-\n-export function isTemplateDiagnostic(diagnostic: ts.Diagnostic): diagnostic is TemplateDiagnostic {\n-  return diagnostic.hasOwnProperty('componentFile') &&\n-      ts.isSourceFile((diagnostic as any).componentFile);\n-}"
        },
        {
            "sha": "4d22fd92fb44e277dddc07212282fb48f4d43dd6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/dom.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fdom.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -11,8 +11,9 @@ import * as ts from 'typescript';\n \n import {ErrorCode, ngErrorCode} from '../../diagnostics';\n import {TemplateId} from '../api';\n+import {makeTemplateDiagnostic, TemplateDiagnostic} from '../diagnostics';\n \n-import {makeTemplateDiagnostic, TemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n+import {TemplateSourceResolver} from './diagnostics';\n \n const REGISTRY = new DomElementSchemaRegistry();\n const REMOVE_XHTML_REGEX = /^:xhtml:/;"
        },
        {
            "sha": "2b7cbd02e5340a2f40b33386432de05b2f3d4ddf",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/oob.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Foob.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -12,8 +12,9 @@ import * as ts from 'typescript';\n import {ErrorCode, makeDiagnostic, makeRelatedInformation, ngErrorCode} from '../../diagnostics';\n import {ClassDeclaration} from '../../reflection';\n import {TemplateId} from '../api';\n+import {makeTemplateDiagnostic, TemplateDiagnostic} from '../diagnostics';\n \n-import {makeTemplateDiagnostic, TemplateDiagnostic, TemplateSourceResolver} from './diagnostics';\n+import {TemplateSourceResolver} from './diagnostics';\n \n \n "
        },
        {
            "sha": "6d0c7486fee9e299abe2ff3461b82f3ea80c3396",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/source.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 25,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fsource.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -8,7 +8,9 @@\n \n import {AbsoluteSourceSpan, ParseLocation, ParseSourceFile, ParseSourceSpan} from '@angular/compiler';\n import * as ts from 'typescript';\n+\n import {TemplateId, TemplateSourceMapping} from '../api';\n+import {getTemplateId} from '../diagnostics';\n \n import {TemplateSourceResolver} from './diagnostics';\n import {computeLineStartsMap, getLineAndCharacterFromPosition} from './line_mappings';\n@@ -81,28 +83,3 @@ export class TemplateSourceManager implements TemplateSourceResolver {\n     return templateSource.toParseSourceSpan(span.start, span.end);\n   }\n }\n-\n-const TEMPLATE_ID = Symbol('ngTemplateId');\n-const NEXT_TEMPLATE_ID = Symbol('ngNextTemplateId');\n-\n-interface HasTemplateId {\n-  [TEMPLATE_ID]: TemplateId;\n-}\n-\n-interface HasNextTemplateId {\n-  [NEXT_TEMPLATE_ID]: number;\n-}\n-\n-function getTemplateId(node: ts.ClassDeclaration&Partial<HasTemplateId>): TemplateId {\n-  if (node[TEMPLATE_ID] === undefined) {\n-    node[TEMPLATE_ID] = allocateTemplateId(node.getSourceFile());\n-  }\n-  return node[TEMPLATE_ID]!;\n-}\n-\n-function allocateTemplateId(sf: ts.SourceFile&Partial<HasNextTemplateId>): TemplateId {\n-  if (sf[NEXT_TEMPLATE_ID] === undefined) {\n-    sf[NEXT_TEMPLATE_ID] = 1;\n-  }\n-  return (`tcb${sf[NEXT_TEMPLATE_ID]!++}`) as TemplateId;\n-}"
        },
        {
            "sha": "6e8e8b2f145d9e72b713e359564610c46467fc2f",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2FBUILD.bazel?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -21,6 +21,7 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck\",\n         \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/diagnostics\",\n         \"//packages/compiler-cli/src/ngtsc/util\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "3c8a5c96b8c26c287398c7d73602f16c61a2aa73",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/3e97435f1c42f71a1e9b8269397fcac88fb3da75/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=3e97435f1c42f71a1e9b8269397fcac88fb3da75",
            "patch": "@@ -18,9 +18,9 @@ import {makeProgram} from '../../testing';\n import {getRootDirs} from '../../util/src/typescript';\n import {ProgramTypeCheckAdapter, TemplateTypeChecker, TypeCheckContext} from '../api';\n import {TemplateId, TemplateSourceMapping, TypeCheckableDirectiveMeta, TypeCheckBlockMetadata, TypeCheckingConfig, UpdateMode} from '../api/api';\n+import {TemplateDiagnostic} from '../diagnostics';\n import {ReusedProgramStrategy} from '../src/augmented_program';\n import {TemplateTypeCheckerImpl} from '../src/checker';\n-import {TemplateDiagnostic} from '../src/diagnostics';\n import {DomSchemaChecker} from '../src/dom';\n import {Environment} from '../src/environment';\n import {OutOfBandDiagnosticRecorder} from '../src/oob';"
        }
    ],
    "stats": {
        "total": 357,
        "additions": 208,
        "deletions": 149
    }
}