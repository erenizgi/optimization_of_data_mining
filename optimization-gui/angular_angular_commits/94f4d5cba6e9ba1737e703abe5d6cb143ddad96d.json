{
    "author": "JoostK",
    "message": "refactor(compiler-cli): remove event output helper from TCB (#40738)\n\nIn 5c547675b11a24b16c20df1718583a0e7ed49cbd the `EventEmitter.subscribe`\nAPI was extended with a new signature that allows the emitter's generic\ntype `T` to flow into the subscribe callback. This new signature removes\nthe need for the special `_outputHelper` function that used to be\nemitted into TCBs when `strictOutputEventTypes`/`strictTemplates` is\nenabled.\n\nPR Close #40738",
    "sha": "94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
    "files": [
        {
            "sha": "73d589ecc7883b3c603b49e8af45f33ea9791aea",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/environment.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 91,
            "changes": 91,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fenvironment.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fenvironment.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fenvironment.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -41,9 +41,6 @@ export class Environment {\n   private pipeInsts = new Map<ClassDeclaration, ts.Expression>();\n   protected pipeInstStatements: ts.Statement[] = [];\n \n-  private outputHelperIdent: ts.Identifier|null = null;\n-  protected helperStatements: ts.Statement[] = [];\n-\n   constructor(\n       readonly config: TypeCheckingConfig, protected importManager: ImportManager,\n       private refEmitter: ReferenceEmitter, private reflector: ReflectionHost,\n@@ -113,93 +110,6 @@ export class Environment {\n     return pipeInstId;\n   }\n \n-  /**\n-   * Declares a helper function to be able to cast directive outputs of type `EventEmitter<T>` to\n-   * have an accurate `subscribe()` method that properly carries over the generic type `T` into the\n-   * listener function passed as argument to `subscribe`. This is done to work around a typing\n-   * deficiency in `EventEmitter.subscribe`, where the listener function is typed as any.\n-   */\n-  declareOutputHelper(): ts.Expression {\n-    if (this.outputHelperIdent !== null) {\n-      return this.outputHelperIdent;\n-    }\n-\n-    const outputHelperIdent = ts.createIdentifier('_outputHelper');\n-    const genericTypeDecl = ts.createTypeParameterDeclaration('T');\n-    const genericTypeRef = ts.createTypeReferenceNode('T', /* typeParameters */ undefined);\n-\n-    const eventEmitter = this.referenceExternalType(\n-        '@angular/core', 'EventEmitter', [new ExpressionType(new WrappedNodeExpr(genericTypeRef))]);\n-\n-    // Declare a type that has a `subscribe` method that carries over type `T` as parameter\n-    // into the callback. The below code generates the following type literal:\n-    // `{subscribe(cb: (event: T) => any): void;}`\n-    const observableLike = ts.createTypeLiteralNode([ts.createMethodSignature(\n-        /* typeParameters */ undefined,\n-        /* parameters */[ts.createParameter(\n-            /* decorators */ undefined,\n-            /* modifiers */ undefined,\n-            /* dotDotDotToken */ undefined,\n-            /* name */ 'cb',\n-            /* questionToken */ undefined,\n-            /* type */\n-            ts.createFunctionTypeNode(\n-                /* typeParameters */ undefined,\n-                /* parameters */[ts.createParameter(\n-                    /* decorators */ undefined,\n-                    /* modifiers */ undefined,\n-                    /* dotDotDotToken */ undefined,\n-                    /* name */ 'event',\n-                    /* questionToken */ undefined,\n-                    /* type */ genericTypeRef)],\n-                /* type */ ts.createKeywordTypeNode(ts.SyntaxKind.AnyKeyword)))],\n-        /* type */ ts.createKeywordTypeNode(ts.SyntaxKind.VoidKeyword),\n-        /* name */ 'subscribe',\n-        /* questionToken */ undefined)]);\n-\n-    // Declares the first signature of `_outputHelper` that matches arguments of type\n-    // `EventEmitter`, to convert them into `observableLike` defined above. The following\n-    // statement is generated:\n-    // `declare function _outputHelper<T>(output: EventEmitter<T>): observableLike;`\n-    this.helperStatements.push(ts.createFunctionDeclaration(\n-        /* decorators */ undefined,\n-        /* modifiers */[ts.createModifier(ts.SyntaxKind.DeclareKeyword)],\n-        /* asteriskToken */ undefined,\n-        /* name */ outputHelperIdent,\n-        /* typeParameters */[genericTypeDecl],\n-        /* parameters */[ts.createParameter(\n-            /* decorators */ undefined,\n-            /* modifiers */ undefined,\n-            /* dotDotDotToken */ undefined,\n-            /* name */ 'output',\n-            /* questionToken */ undefined,\n-            /* type */ eventEmitter)],\n-        /* type */ observableLike,\n-        /* body */ undefined));\n-\n-    // Declares the second signature of `_outputHelper` that matches all other argument types,\n-    // i.e. ensures type identity for output types other than `EventEmitter`. This corresponds\n-    // with the following statement:\n-    // `declare function _outputHelper<T>(output: T): T;`\n-    this.helperStatements.push(ts.createFunctionDeclaration(\n-        /* decorators */ undefined,\n-        /* modifiers */[ts.createModifier(ts.SyntaxKind.DeclareKeyword)],\n-        /* asteriskToken */ undefined,\n-        /* name */ outputHelperIdent,\n-        /* typeParameters */[genericTypeDecl],\n-        /* parameters */[ts.createParameter(\n-            /* decorators */ undefined,\n-            /* modifiers */ undefined,\n-            /* dotDotDotToken */ undefined,\n-            /* name */ 'output',\n-            /* questionToken */ undefined,\n-            /* type */ genericTypeRef)],\n-        /* type */ genericTypeRef,\n-        /* body */ undefined));\n-\n-    return this.outputHelperIdent = outputHelperIdent;\n-  }\n-\n   /**\n    * Generate a `ts.Expression` that references the given node.\n    *\n@@ -250,7 +160,6 @@ export class Environment {\n \n   getPreludeStatements(): ts.Statement[] {\n     return [\n-      ...this.helperStatements,\n       ...this.pipeInstStatements,\n       ...this.typeCtorStatements,\n     ];"
        },
        {
            "sha": "cd7bc32c27b0755087c1371d7a8364424cfd6b5b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/template_symbol_builder.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftemplate_symbol_builder.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -174,7 +174,7 @@ export class SymbolBuilder {\n     }\n \n     // Outputs in the TCB look like one of the two:\n-    // * _outputHelper(_t1[\"outputField\"]).subscribe(handler);\n+    // * _t1[\"outputField\"].subscribe(handler);\n     // * _t1.addEventListener(handler);\n     // Even with strict null checks disabled, we still produce the access as a separate statement\n     // so that it can be found here."
        },
        {
            "sha": "4ee589a5f1d5550828b8e323eaf81254861447fb",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_block.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_block.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -874,17 +874,8 @@ export class TcbDirectiveOutputsOp extends TcbOp {\n         // For strict checking of directive events, generate a call to the `subscribe` method\n         // on the directive's output field to let type information flow into the handler function's\n         // `$event` parameter.\n-        //\n-        // Note that the `EventEmitter<T>` type from '@angular/core' that is typically used for\n-        // outputs has a typings deficiency in its `subscribe` method. The generic type `T` is not\n-        // carried into the handler function, which is vital for inference of the type of `$event`.\n-        // As a workaround, the directive's field is passed into a helper function that has a\n-        // specially crafted set of signatures, to effectively cast `EventEmitter<T>` to something\n-        // that has a `subscribe` method that properly carries the `T` into the handler function.\n         const handler = tcbCreateEventHandler(output, this.tcb, this.scope, EventParamType.Infer);\n-        const outputHelper =\n-            ts.createCall(this.tcb.env.declareOutputHelper(), undefined, [outputField]);\n-        const subscribeFn = ts.createPropertyAccess(outputHelper, 'subscribe');\n+        const subscribeFn = ts.createPropertyAccess(outputField, 'subscribe');\n         const call = ts.createCall(subscribeFn, /* typeArguments */ undefined, [handler]);\n         addParseSpanInfo(call, output.sourceSpan);\n         this.scope.addStatement(ts.createExpressionStatement(call));"
        },
        {
            "sha": "5b2996b8c4432687ed77ff0ddb828db68c537a95",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/type_check_file.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_file.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_file.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Ftype_check_file.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -56,9 +56,6 @@ export class TypeCheckFile extends Environment {\n         '\\n\\n';\n     const printer = ts.createPrinter();\n     source += '\\n';\n-    for (const stmt of this.helperStatements) {\n-      source += printer.printNode(ts.EmitHint.Unspecified, stmt, this.contextFile) + '\\n';\n-    }\n     for (const stmt of this.pipeInstStatements) {\n       source += printer.printNode(ts.EmitHint.Unspecified, stmt, this.contextFile) + '\\n';\n     }"
        },
        {
            "sha": "23b82d9fcdf4a41980f6594f00a6f8e3c38e6e51",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/test_utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftest_utils.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -593,10 +593,6 @@ class FakeEnvironment /* implements Environment */ {\n     return ts.createParen(ts.createAsExpression(ts.createNull(), this.referenceType(ref)));\n   }\n \n-  declareOutputHelper(): ts.Expression {\n-    return ts.createIdentifier('_outputHelper');\n-  }\n-\n   reference(ref: Reference<ClassDeclaration<ts.ClassDeclaration>>): ts.Expression {\n     return ref.node.name;\n   }"
        },
        {
            "sha": "3c9e7ef0e91cc0a313c2c9f7702edb4bbc7e9cbc",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_check_block_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_check_block_spec.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -666,7 +666,7 @@ describe('type check blocks', () => {\n       const TEMPLATE = `<div dir (dirOutput)=\"foo($event)\"></div>`;\n       const block = tcb(TEMPLATE, DIRECTIVES);\n       expect(block).toContain(\n-          '_outputHelper(_t1[\"outputField\"]).subscribe(function ($event): any { (ctx).foo($event); });');\n+          '_t1[\"outputField\"].subscribe(function ($event): any { (ctx).foo($event); });');\n     });\n \n     it('should emit a listener function with AnimationEvent for animation events', () => {\n@@ -828,7 +828,7 @@ describe('type check blocks', () => {\n       it('should check types of directive outputs when enabled', () => {\n         const block = tcb(TEMPLATE, DIRECTIVES);\n         expect(block).toContain(\n-            '_outputHelper(_t1[\"outputField\"]).subscribe(function ($event): any { (ctx).foo($event); });');\n+            '_t1[\"outputField\"].subscribe(function ($event): any { (ctx).foo($event); });');\n         expect(block).toContain(\n             '_t2.addEventListener(\"nonDirOutput\", function ($event): any { (ctx).foo($event); });');\n       });\n@@ -865,7 +865,7 @@ describe('type check blocks', () => {\n       it('should check types of DOM events when enabled', () => {\n         const block = tcb(TEMPLATE, DIRECTIVES);\n         expect(block).toContain(\n-            '_outputHelper(_t1[\"outputField\"]).subscribe(function ($event): any { (ctx).foo($event); });');\n+            '_t1[\"outputField\"].subscribe(function ($event): any { (ctx).foo($event); });');\n         expect(block).toContain(\n             '_t2.addEventListener(\"nonDirOutput\", function ($event): any { (ctx).foo($event); });');\n       });\n@@ -875,7 +875,7 @@ describe('type check blocks', () => {\n         // Note that directive outputs are still checked, that is controlled by\n         // `checkTypeOfOutputEvents`\n         expect(block).toContain(\n-            '_outputHelper(_t1[\"outputField\"]).subscribe(function ($event): any { (ctx).foo($event); });');\n+            '_t1[\"outputField\"].subscribe(function ($event): any { (ctx).foo($event); });');\n         expect(block).toContain('function ($event: any): any { (ctx).foo($event); }');\n       });\n     });"
        },
        {
            "sha": "e8cf459ed5398b3dd89e3da3f0805f5e85b8c636",
            "filename": "packages/language-service/ivy/definitions.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "raw_url": "https://github.com/angular/angular/raw/94f4d5cba6e9ba1737e703abe5d6cb143ddad96d/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fdefinitions.ts?ref=94f4d5cba6e9ba1737e703abe5d6cb143ddad96d",
            "patch": "@@ -48,7 +48,7 @@ export class DefinitionBuilder {\n     const definitions: ts.DefinitionInfo[] = [];\n     for (const definitionMeta of definitionMetas) {\n       // The `$event` of event handlers would point to the $event parameter in the shim file, as in\n-      // `_outputHelper(_t3[\"x\"]).subscribe(function ($event): any { $event }) ;`\n+      // `_t3[\"x\"].subscribe(function ($event): any { $event }) ;`\n       // If we wanted to return something for this, it would be more appropriate for something like\n       // `getTypeDefinition`.\n       if (isDollarEvent(definitionMeta.node)) {"
        }
    ],
    "stats": {
        "total": 121,
        "additions": 7,
        "deletions": 114
    }
}