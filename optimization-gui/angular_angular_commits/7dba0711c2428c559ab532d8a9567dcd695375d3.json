{
    "author": "josephperrott",
    "message": "feat(dev-infra): prevent merges for PRs with invalid breaking changes or commit types (#41459)\n\nCheck commits in pull requests to ensure the pr can be merged into the target branch. Confirms\nthat prs targeting minor do not contain breaking changes, and prs targeting patch or lts do not\ncontain breaking changes or `feat` commits.\n\nPR Close #41459",
    "sha": "7dba0711c2428c559ab532d8a9567dcd695375d3",
    "files": [
        {
            "sha": "69807d13081e9f57ef3584407b0eb14881080544",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 50,
            "deletions": 0,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/7dba0711c2428c559ab532d8a9567dcd695375d3/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/7dba0711c2428c559ab532d8a9567dcd695375d3/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=7dba0711c2428c559ab532d8a9567dcd695375d3",
            "patch": "@@ -3353,6 +3353,17 @@ var PullRequestFailure = /** @class */ (function () {\n             \"your auth token has write access.\"; }\n         return new this(message);\n     };\n+    PullRequestFailure.hasBreakingChanges = function (label) {\n+        var message = \"Cannot merge into branch for \\\"\" + label.pattern + \"\\\" as the pull request has \" +\n+            \"breaking changes.  Breaking changes can only be merged with the \\\"target: major\\\" label.\";\n+        return new this(message);\n+    };\n+    PullRequestFailure.hasFeatureCommits = function (label) {\n+        var message = \"Cannot merge into branch for \\\"\" + label.pattern + \"\\\" as the pull request has \" +\n+            'commits with the \"feat\" type.  New features can only be merged with the \"target: minor\" or ' +\n+            '\"target: major\" label.';\n+        return new this(message);\n+    };\n     return PullRequestFailure;\n }());\n \n@@ -3412,6 +3423,12 @@ function loadAndValidatePullRequest(_a, prNumber, ignoreNonFatalFailures) {\n                         }\n                         throw error;\n                     }\n+                    try {\n+                        assertCorrectTargetForChanges(prData.commits.nodes.map(function (n) { return n.commit.message; }), targetLabel);\n+                    }\n+                    catch (error) {\n+                        return [2 /*return*/, error];\n+                    }\n                     state = prData.commits.nodes.slice(-1)[0].commit.status.state;\n                     if (state === 'FAILURE' && !ignoreNonFatalFailures) {\n                         return [2 /*return*/, PullRequestFailure.failingCiJobs()];\n@@ -3503,6 +3520,39 @@ function fetchPullRequestFromGithub(git, prNumber) {\n function isPullRequest(v) {\n     return v.targetBranches !== undefined;\n }\n+/**\n+ * Assert the commits provided are allowed to merge to the provided target label, throwing a\n+ * PullRequestFailure otherwise.\n+ */\n+function assertCorrectTargetForChanges(rawCommits, label) {\n+    /** List of ParsedCommits for all of the commits in the pull request. */\n+    var commits = rawCommits.map(parseCommitMessage);\n+    switch (label.pattern) {\n+        case 'target: major':\n+            break;\n+        case 'target: minor':\n+            // Check if any commits in the PR contains a breaking change.\n+            if (commits.some(function (commit) { return commit.breakingChanges.length !== 0; })) {\n+                throw PullRequestFailure.hasBreakingChanges(label);\n+            }\n+            break;\n+        case 'target: patch':\n+        case 'target: lts':\n+            // Check if any commits in the PR contains a breaking change.\n+            if (commits.some(function (commit) { return commit.breakingChanges.length !== 0; })) {\n+                throw PullRequestFailure.hasBreakingChanges(label);\n+            }\n+            // Check if any commits in the PR contains a commit type of \"feat\".\n+            if (commits.some(function (commit) { return commit.type === 'feat'; })) {\n+                throw PullRequestFailure.hasFeatureCommits(label);\n+            }\n+            break;\n+        default:\n+            warn(red('WARNING: Unable to confirm all commits in the PR are eligible to be merged'));\n+            warn(red(\"into the target branch: \" + label.pattern));\n+            break;\n+    }\n+}\n \n /**\n  * @license"
        },
        {
            "sha": "94b6f378b0ca41512cd09a145aa6dfc2a6a8f74f",
            "filename": "dev-infra/pr/merge/failures.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/7dba0711c2428c559ab532d8a9567dcd695375d3/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dba0711c2428c559ab532d8a9567dcd695375d3/dev-infra%2Fpr%2Fmerge%2Ffailures.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Ffailures.ts?ref=7dba0711c2428c559ab532d8a9567dcd695375d3",
            "patch": "@@ -6,6 +6,8 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n+import {TargetLabel} from './config';\n+\n /**\n  * Class that can be used to describe pull request failures. A failure\n  * is described through a human-readable message and a flag indicating\n@@ -72,4 +74,17 @@ export class PullRequestFailure {\n           `your auth token has write access.`) {\n     return new this(message);\n   }\n+\n+  static hasBreakingChanges(label: TargetLabel) {\n+    const message = `Cannot merge into branch for \"${label.pattern}\" as the pull request has ` +\n+        `breaking changes.  Breaking changes can only be merged with the \"target: major\" label.`;\n+    return new this(message);\n+  }\n+\n+  static hasFeatureCommits(label: TargetLabel) {\n+    const message = `Cannot merge into branch for \"${label.pattern}\" as the pull request has ` +\n+        'commits with the \"feat\" type.  New features can only be merged with the \"target: minor\" ' +\n+        'or \"target: major\" label.';\n+    return new this(message);\n+  }\n }"
        },
        {
            "sha": "e3ff09fc636de3b4f3b315ef4d8ac1743422c160",
            "filename": "dev-infra/pr/merge/pull-request.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 1,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/7dba0711c2428c559ab532d8a9567dcd695375d3/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "raw_url": "https://github.com/angular/angular/raw/7dba0711c2428c559ab532d8a9567dcd695375d3/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fpull-request.ts?ref=7dba0711c2428c559ab532d8a9567dcd695375d3",
            "patch": "@@ -7,6 +7,8 @@\n  */\n \n import {params, types as graphQLTypes} from 'typed-graphqlify';\n+import {parseCommitMessage} from '../../commit-message/parse';\n+import {red, warn} from '../../utils/console';\n \n import {GitClient} from '../../utils/git/index';\n import {getPr} from '../../utils/github';\n@@ -73,6 +75,11 @@ export async function loadAndValidatePullRequest(\n     throw error;\n   }\n \n+  try {\n+    assertCorrectTargetForChanges(prData.commits.nodes.map(n => n.commit.message), targetLabel);\n+  } catch (error) {\n+    return error;\n+  }\n \n   const state = prData.commits.nodes.slice(-1)[0].commit.status.state;\n   if (state === 'FAILURE' && !ignoreNonFatalFailures) {\n@@ -126,7 +133,7 @@ const PR_SCHEMA = {\n     nodes: [{\n       commit: {\n         status: {\n-          state: graphQLTypes.oneOf(['FAILURE' as const, 'PENDING' as const, 'SUCCESS' as const]),\n+          state: graphQLTypes.oneOf(['FAILURE', 'PENDING', 'SUCCESS'] as const),\n         },\n         message: graphQLTypes.string,\n       },\n@@ -162,3 +169,37 @@ async function fetchPullRequestFromGithub(\n export function isPullRequest(v: PullRequestFailure|PullRequest): v is PullRequest {\n   return (v as PullRequest).targetBranches !== undefined;\n }\n+\n+/**\n+ * Assert the commits provided are allowed to merge to the provided target label, throwing a\n+ * PullRequestFailure otherwise.\n+ */\n+function assertCorrectTargetForChanges(rawCommits: string[], label: TargetLabel) {\n+  /** List of ParsedCommits for all of the commits in the pull request. */\n+  const commits = rawCommits.map(parseCommitMessage);\n+  switch (label.pattern) {\n+    case 'target: major':\n+      break;\n+    case 'target: minor':\n+      // Check if any commits in the PR contains a breaking change.\n+      if (commits.some(commit => commit.breakingChanges.length !== 0)) {\n+        throw PullRequestFailure.hasBreakingChanges(label);\n+      }\n+      break;\n+    case 'target: patch':\n+    case 'target: lts':\n+      // Check if any commits in the PR contains a breaking change.\n+      if (commits.some(commit => commit.breakingChanges.length !== 0)) {\n+        throw PullRequestFailure.hasBreakingChanges(label);\n+      }\n+      // Check if any commits in the PR contains a commit type of \"feat\".\n+      if (commits.some(commit => commit.type === 'feat')) {\n+        throw PullRequestFailure.hasFeatureCommits(label);\n+      }\n+      break;\n+    default:\n+      warn(red('WARNING: Unable to confirm all commits in the PR are eligible to be merged'));\n+      warn(red(`into the target branch: ${label.pattern}`));\n+      break;\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 107,
        "deletions": 1
    }
}