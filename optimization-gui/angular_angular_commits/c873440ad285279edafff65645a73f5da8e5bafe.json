{
    "author": "petebacondarwin",
    "message": "fix(compiler): do not allow unterminated interpolation to leak into later tokens (#42605)\n\nWhen consuming a text token, the lexer tracks whether it is reading characters\nfrom inside an interpolation so that it can identify invalid ICU expressions.\nInside an interpolation there will be no ICU expression so it is safe to\nhave unmatched `{` characters, but outside an interpolation this is an error.\n\nPreviously, if an interpolation was started, by an opening marker (e.g. `{{`)\nin a text token but the text came to an end before the closing marker (e.g. `}}`)\nthen the lexer was not clearing its internal state that tracked that it was\ninside an interpolation. When the next text token was being consumed,\nthe lexer, incorrectly thought it was already within an interpolation.\nThis resulted in invalid ICU expression errors not being reported.\n\nFor example, in the following snippet, the first text block has a prematurely\nended interpolation, and the second text block contains an invalid `{` character.\n\n```\n<div>{{</div>\n<div>{</div>\n```\n\nPreviously, the lexer would not have identified this as an error. Now there\nwill be an EOF error that looks like:\n\n```\nTS-995002: Unexpected character \"EOF\"\n(Do you have an unescaped \"{\" in your template? Use \"{{ '{' }}\") to escape it.)\n```\n\nPR Close #42605",
    "sha": "c873440ad285279edafff65645a73f5da8e5bafe",
    "files": [
        {
            "sha": "75da6732e5a50d4b19ce5f7d16a66445db08855f",
            "filename": "packages/compiler/src/ml_parser/lexer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/c873440ad285279edafff65645a73f5da8e5bafe/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "raw_url": "https://github.com/angular/angular/raw/c873440ad285279edafff65645a73f5da8e5bafe/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fml_parser%2Flexer.ts?ref=c873440ad285279edafff65645a73f5da8e5bafe",
            "patch": "@@ -713,6 +713,10 @@ class _Tokenizer {\n       }\n     } while (!this._isTextEnd());\n \n+    // It is possible that an interpolation was started but not ended inside this text token.\n+    // Make sure that we reset the state of the lexer correctly.\n+    this._inInterpolation = false;\n+\n     this._endToken([this._processCarriageReturns(parts.join(''))]);\n   }\n "
        },
        {
            "sha": "00c19418ee5667e0b89a0c584dcbb5636983c0d8",
            "filename": "packages/compiler/test/ml_parser/lexer_spec.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/c873440ad285279edafff65645a73f5da8e5bafe/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/c873440ad285279edafff65645a73f5da8e5bafe/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Fml_parser%2Flexer_spec.ts?ref=c873440ad285279edafff65645a73f5da8e5bafe",
            "patch": "@@ -1208,6 +1208,18 @@ import {ParseLocation, ParseSourceFile, ParseSourceSpan} from '../../src/parse_u\n             ]]);\n       });\n \n+      it('should report unescaped \"{\" as an error, even after a prematurely terminated interpolation',\n+         () => {\n+           expect(tokenizeAndHumanizeErrors(\n+                      `<code>{{b}<!---->}</code><pre>import {a} from 'a';</pre>`,\n+                      {tokenizeExpansionForms: true}))\n+               .toEqual([[\n+                 lex.TokenType.RAW_TEXT,\n+                 `Unexpected character \"EOF\" (Do you have an unescaped \"{\" in your template? Use \"{{ '{' }}\") to escape it.)`,\n+                 '0:56',\n+               ]]);\n+         });\n+\n       it('should include 2 lines of context in message', () => {\n         const src = '111\\n222\\n333\\nE\\n444\\n555\\n666\\n';\n         const file = new ParseSourceFile(src, 'file://');"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 16,
        "deletions": 0
    }
}