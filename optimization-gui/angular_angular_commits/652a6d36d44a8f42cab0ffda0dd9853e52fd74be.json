{
    "author": "devversion",
    "message": "ci: avoid failures when yarn unlinks bazelisk in windows jobs (#43373)\n\nWindows disallows removal of files which are currently being used.\ni.e. have active handles. This currently can result in permission denied\nfailures on the Windows CI jobs where `yarn bazel` resolves to the local\nbazelisk installation that can be unlinked by `yarn_install` repository\nfetching as part of the Bazel invocation, resulting in errors like:\n\n```\nERROR: An error occurred during the fetch of repository 'npm':\n   yarn_install failed: $ node tools/yarn/check-yarn.js\n...\n[4/5] Linking dependencies...\ninfo If you think this is a bug, please open a bug report with the information provided in \"C:\\\\users\\\\circleci\\\\ng\\\\yarn-error.log\".\ninfo Visit https://yarnpkg.com/en/docs/cli/install for documentation about this command.\n (warning \" > tsickle@0.34.3\" has incorrect peer dependency \"typescript@~3.3.1\".\nerror An unexpected error occurred: \"EPERM: operation not permitted, unlink 'C:\\\\users\\\\circleci\\\\ng\\\\node_modules\\\\@bazel\\\\bazel-win32_x64\\\\bazel-0.27.0-windows-x86_64.exe'\".\nProcess stalled\nActive handles:\n  - Socket\n  - Socket\n  - Socket\n)\n```\n\nWe workarund this in order to improve CI stability in case the node modules are\nbeing invalidated by Bazel, or through Yarns integrity checking.\n\nPR Close #43373",
    "sha": "652a6d36d44a8f42cab0ffda0dd9853e52fd74be",
    "files": [
        {
            "sha": "795dccc415d609e098a09721c574199a127a4c0c",
            "filename": ".circleci/config.yml",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/652a6d36d44a8f42cab0ffda0dd9853e52fd74be/.circleci%2Fconfig.yml",
            "raw_url": "https://github.com/angular/angular/raw/652a6d36d44a8f42cab0ffda0dd9853e52fd74be/.circleci%2Fconfig.yml",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/.circleci%2Fconfig.yml?ref=652a6d36d44a8f42cab0ffda0dd9853e52fd74be",
            "patch": "@@ -213,6 +213,10 @@ commands:\n           keys:\n             - *cache_key_win\n             - *cache_key_win_fallback\n+      # Install @bazel/bazelisk globally and use that for the first run.\n+      # Workaround for https://github.com/bazelbuild/rules_nodejs/issues/894\n+      # NB: the issue was for @bazel/bazel but the same problem applies to @bazel/bazelisk\n+      - run: yarn global add @bazel/bazelisk@$env:BAZELISK_VERSION\n       # On Windows `~/` is not resolved when using as a CLI value. `../` results in the same path.\n       - run: yarn install --frozen-lockfile --non-interactive --cache-folder ../.cache/yarn\n \n@@ -799,11 +803,11 @@ jobs:\n       - setup_win\n       - run:\n           name: Build all windows CI targets\n-          command: yarn bazel build --build_tag_filters=-ivy-only //packages/compiler-cli/...\n+          command: bazel build --build_tag_filters=-ivy-only //packages/compiler-cli/...\n           no_output_timeout: 15m\n       - run:\n           name: Test all windows CI targets\n-          command: yarn bazel test --test_tag_filters=\"-ivy-only,-browser:chromium-local\" //packages/compiler-cli/...\n+          command: bazel test --test_tag_filters=\"-ivy-only,-browser:chromium-local\" //packages/compiler-cli/...\n           no_output_timeout: 15m\n \n   test_ivy_aot_win:\n@@ -812,11 +816,11 @@ jobs:\n       - setup_win\n       - run:\n           name: Build all windows CI targets\n-          command: yarn bazel build --config=ivy --build_tag_filters=-no-ivy-aot,-fixme-ivy-aot //packages/compiler-cli/...\n+          command: bazel build --config=ivy --build_tag_filters=-no-ivy-aot,-fixme-ivy-aot //packages/compiler-cli/...\n           no_output_timeout: 15m\n       - run:\n           name: Test all windows CI targets\n-          command: yarn bazel test --config=ivy --test_tag_filters=\"-no-ivy-aot,-fixme-ivy-aot,-browser:chromium-local\" //packages/compiler-cli/... //packages/localize/...\n+          command: bazel test --config=ivy --test_tag_filters=\"-no-ivy-aot,-fixme-ivy-aot,-browser:chromium-local\" //packages/compiler-cli/... //packages/localize/...\n           no_output_timeout: 15m\n       # Save dependencies to use on subsequent runs.\n       - save_cache:"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 8,
        "deletions": 4
    }
}