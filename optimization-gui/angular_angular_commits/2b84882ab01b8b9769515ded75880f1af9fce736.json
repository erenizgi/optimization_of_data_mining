{
    "author": "kyliau",
    "message": "fix(language-service): do not return external template that does not exist (#39898)\n\nThere is a bug in tsserver that causes it to crash when it tries to create\nscript info for an external template that does not exist.\n\nI've submitted an upstream PR\nhttps://github.com/microsoft/TypeScript/pull/41737 to fix this, but before\nthe commit lands in the stable release, we'll have to workaround the issue\nin language service.\n\nClose https://github.com/angular/vscode-ng-language-service/issues/1001\n\nPR Close #39898",
    "sha": "2b84882ab01b8b9769515ded75880f1af9fce736",
    "files": [
        {
            "sha": "fbf21b0b21a22b5b34c4fe0b5bdd12b61a2cf1bd",
            "filename": "packages/language-service/src/ts_plugin.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/2b84882ab01b8b9769515ded75880f1af9fce736/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b84882ab01b8b9769515ded75880f1af9fce736/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts?ref=2b84882ab01b8b9769515ded75880f1af9fce736",
            "patch": "@@ -29,8 +29,16 @@ export function getExternalFiles(project: tss.server.Project): string[] {\n     return [];\n   }\n   const ngLsHost = PROJECT_MAP.get(project);\n-  ngLsHost?.getAnalyzedModules();\n-  return ngLsHost?.getExternalTemplates() || [];\n+  if (ngLsHost === undefined) {\n+    return [];\n+  }\n+  ngLsHost.getAnalyzedModules();\n+  return ngLsHost.getExternalTemplates().filter(fileName => {\n+    // TODO(kyliau): Remove this when the following PR lands on the version of\n+    // TypeScript used in this repo.\n+    // https://github.com/microsoft/TypeScript/pull/41737\n+    return project.fileExists(fileName);\n+  });\n }\n \n export function create(info: tss.server.PluginCreateInfo): tss.LanguageService {"
        },
        {
            "sha": "099146c6aedd7a7dcb01b2d93dd9eaf650483658",
            "filename": "packages/language-service/test/ts_plugin_spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/2b84882ab01b8b9769515ded75880f1af9fce736/packages%2Flanguage-service%2Ftest%2Fts_plugin_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/2b84882ab01b8b9769515ded75880f1af9fce736/packages%2Flanguage-service%2Ftest%2Fts_plugin_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Fts_plugin_spec.ts?ref=2b84882ab01b8b9769515ded75880f1af9fce736",
            "patch": "@@ -21,6 +21,7 @@ const mockProject = {\n     },\n   },\n   hasRoots: () => true,\n+  fileExists: () => true,\n } as any;\n \n describe('plugin', () => {\n@@ -136,6 +137,12 @@ describe('plugin', () => {\n       '/app/test.ng',\n     ]);\n   });\n+\n+  it('should not return external template that does not exist', () => {\n+    spyOn(mockProject, 'fileExists').and.returnValue(false);\n+    const externalTemplates = getExternalFiles(mockProject);\n+    expect(externalTemplates.length).toBe(0);\n+  });\n });\n \n describe(`with config 'angularOnly = true`, () => {"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 17,
        "deletions": 2
    }
}