{
    "author": "devversion",
    "message": "feat(dev-infra): add release command for setting NPM dist tag (#38656)\n\nIntroduces a new command for `ng-dev release`, so that the NPM\ndist tag can be set for all configured NPM packages. This command\ncan be useful in case a manual tag needs to be set, but it is\nprimarily used by the release tooling when a new stable version\nis cut, and when the previous patch branch needs to be set as LTS\nversion through a `v{major}-lts` dist tag.\n\nIt is necessary to have this as a command so that the release tool\ncan execute it for old branches where other packages might have been\nconfigured. This is similar to the separate `ng-dev build` command\nthat we created.\n\nNote that we also added logic for spawning a process conveniently\nwith different \"console output\" modes. This will be useful for\nother command invocations in the release tool and it's generally\nbetter than directly using native `child_process` as that one doesn't\nlog to the dev-infra debug log file.\n\nPR Close #38656",
    "sha": "372a6cf8d7690053d3a905a94a3f633bdb170488",
    "files": [
        {
            "sha": "43fdf65f1b50030e30c79ebc15eebc0041849a19",
            "filename": "dev-infra/release/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2FBUILD.bazel?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -9,6 +9,7 @@ ts_library(\n     visibility = [\"//dev-infra:__subpackages__\"],\n     deps = [\n         \"//dev-infra/release/build\",\n+        \"//dev-infra/release/set-dist-tag\",\n         \"//dev-infra/utils\",\n         \"@npm//@types/yargs\",\n         \"@npm//yargs\","
        },
        {
            "sha": "3593b15299a08a762d94173bf5e0fb4eb6b3d3c4",
            "filename": "dev-infra/release/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fcli.ts?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -8,6 +8,7 @@\n import * as yargs from 'yargs';\n \n import {ReleaseBuildCommandModule} from './build/cli';\n+import {ReleaseSetDistTagCommand} from './set-dist-tag/cli';\n import {buildEnvStamp} from './stamping/env-stamp';\n \n /** Build the parser for the release commands. */\n@@ -16,6 +17,7 @@ export function buildReleaseParser(localYargs: yargs.Argv) {\n       .strict()\n       .demandCommand()\n       .command(ReleaseBuildCommandModule)\n+      .command(ReleaseSetDistTagCommand)\n       .command(\n           'build-env-stamp', 'Build the environment stamping information', {},\n           () => buildEnvStamp());"
        },
        {
            "sha": "37f47f8cbe0dd320aaec40fcd0ea1d84391bdefc",
            "filename": "dev-infra/release/set-dist-tag/BUILD.bazel",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fset-dist-tag%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fset-dist-tag%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fset-dist-tag%2FBUILD.bazel?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -0,0 +1,44 @@\n+load(\"@npm_bazel_typescript//:index.bzl\", \"ts_library\")\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\")\n+\n+ts_library(\n+    name = \"set-dist-tag\",\n+    srcs = glob(\n+        [\n+            \"**/*.ts\",\n+        ],\n+        exclude = [\"*.spec.ts\"],\n+    ),\n+    module_name = \"@angular/dev-infra-private/release/set-dist-tag\",\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/release/versioning\",\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/node\",\n+        \"@npm//@types/semver\",\n+        \"@npm//@types/yargs\",\n+        \"@npm//ora\",\n+        \"@npm//semver\",\n+    ],\n+)\n+\n+ts_library(\n+    name = \"test_lib\",\n+    srcs = glob([\n+        \"*.spec.ts\",\n+    ]),\n+    deps = [\n+        \":set-dist-tag\",\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/release/versioning\",\n+        \"//dev-infra/utils/testing\",\n+        \"@npm//@types/jasmine\",\n+        \"@npm//@types/node\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    deps = [\":test_lib\"],\n+)"
        },
        {
            "sha": "61ded8baecdf34e4d5e775dfe03d188dc81683e8",
            "filename": "dev-infra/release/set-dist-tag/cli.ts",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fset-dist-tag%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fset-dist-tag%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fset-dist-tag%2Fcli.ts?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -0,0 +1,78 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as Ora from 'ora';\n+import * as semver from 'semver';\n+import {Arguments, Argv, CommandModule} from 'yargs';\n+\n+import {bold, debug, error, green, info, red} from '../../utils/console';\n+import {getReleaseConfig} from '../config/index';\n+import {setNpmTagForPackage} from '../versioning/npm-publish';\n+\n+\n+/** Command line options for setting a NPM dist tag. */\n+export interface ReleaseSetDistTagOptions {\n+  tagName: string;\n+  targetVersion: string;\n+}\n+\n+function builder(args: Argv): Argv<ReleaseSetDistTagOptions> {\n+  return args\n+      .positional('tagName', {\n+        type: 'string',\n+        demandOption: true,\n+        description: 'Name of the NPM dist tag.',\n+      })\n+      .positional('targetVersion', {\n+        type: 'string',\n+        demandOption: true,\n+        description: 'Version to which the dist tag should be set.'\n+      });\n+}\n+\n+/** Yargs command handler for building a release. */\n+async function handler(args: Arguments<ReleaseSetDistTagOptions>) {\n+  const {targetVersion: rawVersion, tagName} = args;\n+  const {npmPackages, publishRegistry} = getReleaseConfig();\n+  const version = semver.parse(rawVersion);\n+\n+  if (version === null) {\n+    error(red(`Invalid version specified. Unable to set NPM dist tag.`));\n+    process.exit(1);\n+  }\n+\n+  const spinner = Ora().start();\n+  debug(`Setting \"${tagName}\" NPM dist tag for release packages to v${version}.`);\n+\n+  for (const pkgName of npmPackages) {\n+    spinner.text = `Setting NPM dist tag for \"${pkgName}\"`;\n+    spinner.render();\n+\n+    try {\n+      await setNpmTagForPackage(pkgName, tagName, version!, publishRegistry);\n+      debug(`Successfully set \"${tagName}\" NPM dist tag for \"${pkgName}\".`);\n+    } catch (e) {\n+      spinner.stop();\n+      error(e);\n+      error(red(`  ✘   An error occurred while setting the NPM dist tag for \"${pkgName}\".`));\n+      process.exit(1);\n+    }\n+  }\n+\n+  spinner.stop();\n+  info(green(`  ✓   Set NPM dist tag for all release packages.`));\n+  info(green(`      ${bold(tagName)} will now point to ${bold(`v${version}`)}.`));\n+}\n+\n+/** CLI command module for setting a NPM dist tag. */\n+export const ReleaseSetDistTagCommand: CommandModule<{}, ReleaseSetDistTagOptions> = {\n+  builder,\n+  handler,\n+  command: 'set-dist-tag <tag-name> <target-version>',\n+  describe: 'Sets a given NPM dist tag for all release packages.',\n+};"
        },
        {
            "sha": "488c4455c2850d8dcc3ebca48bc66b861f4ab730",
            "filename": "dev-infra/release/set-dist-tag/set-dist-tag.spec.ts",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fset-dist-tag%2Fset-dist-tag.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fset-dist-tag%2Fset-dist-tag.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fset-dist-tag%2Fset-dist-tag.spec.ts?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -0,0 +1,73 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {matchesVersion} from '../../utils/testing/semver-matchers';\n+import * as releaseConfig from '../config/index';\n+import * as npm from '../versioning/npm-publish';\n+\n+import {ReleaseSetDistTagCommand} from './cli';\n+\n+describe('ng-dev release set-dist-tag', () => {\n+  let npmPackages: string[];\n+  let publishRegistry: string|undefined;\n+\n+  beforeEach(() => {\n+    npmPackages = ['@angular/pkg1', '@angular/pkg2'];\n+    publishRegistry = undefined;\n+\n+    spyOn(npm, 'setNpmTagForPackage');\n+    // We need to stub out the `process.exit` function during tests as the\n+    // CLI handler calls those in case of failures.\n+    spyOn(process, 'exit');\n+  });\n+\n+  /** Invokes the `set-dist-tag` command handler. */\n+  async function invokeCommand(tagName: string, targetVersion: string) {\n+    spyOn(releaseConfig, 'getReleaseConfig').and.returnValue({\n+      npmPackages,\n+      publishRegistry,\n+      buildPackages: async () => [],\n+      generateReleaseNotesForHead: async () => {}\n+    });\n+    await ReleaseSetDistTagCommand.handler({tagName, targetVersion, $0: '', _: []});\n+  }\n+\n+  it('should invoke \"npm dist-tag\" command for all configured packages', async () => {\n+    await invokeCommand('latest', '10.0.0');\n+    expect(npm.setNpmTagForPackage).toHaveBeenCalledTimes(2);\n+    expect(npm.setNpmTagForPackage)\n+        .toHaveBeenCalledWith('@angular/pkg1', 'latest', matchesVersion('10.0.0'), undefined);\n+    expect(npm.setNpmTagForPackage)\n+        .toHaveBeenCalledWith('@angular/pkg2', 'latest', matchesVersion('10.0.0'), undefined);\n+  });\n+\n+  it('should support a configured custom NPM registry', async () => {\n+    publishRegistry = 'https://my-custom-registry.angular.io';\n+    await invokeCommand('latest', '10.0.0');\n+\n+    expect(npm.setNpmTagForPackage).toHaveBeenCalledTimes(2);\n+    expect(npm.setNpmTagForPackage)\n+        .toHaveBeenCalledWith(\n+            '@angular/pkg1', 'latest', matchesVersion('10.0.0'),\n+            'https://my-custom-registry.angular.io');\n+    expect(npm.setNpmTagForPackage)\n+        .toHaveBeenCalledWith(\n+            '@angular/pkg2', 'latest', matchesVersion('10.0.0'),\n+            'https://my-custom-registry.angular.io');\n+  });\n+\n+  it('should error if an invalid version has been specified', async () => {\n+    spyOn(console, 'error');\n+    await invokeCommand('latest', '10.0');\n+\n+    expect(console.error)\n+        .toHaveBeenCalledWith('Invalid version specified. Unable to set NPM dist tag.');\n+    expect(process.exit).toHaveBeenCalledWith(1);\n+    expect(process.exit).toHaveBeenCalledTimes(1);\n+  });\n+});"
        },
        {
            "sha": "05dfbb856209e5043eab5489389883c4b021ebbc",
            "filename": "dev-infra/release/versioning/npm-publish.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Frelease%2Fversioning%2Fnpm-publish.ts?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -0,0 +1,24 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as semver from 'semver';\n+import {spawnWithDebugOutput} from '../../utils/child-process';\n+\n+/**\n+ * Sets the NPM tag to the specified version for the given package.\n+ * @throws With the process log output if the tagging failed.\n+ */\n+export async function setNpmTagForPackage(\n+    packageName: string, distTag: string, version: semver.SemVer, registryUrl: string|undefined) {\n+  const args = ['dist-tag', 'add', `${packageName}@${version}`, distTag];\n+  // If a custom registry URL has been specified, add the `--registry` flag.\n+  if (registryUrl !== undefined) {\n+    args.push('--registry', registryUrl);\n+  }\n+  await spawnWithDebugOutput('npm', args, {mode: 'silent'});\n+}"
        },
        {
            "sha": "c68f82402a5327e9cc024ab824e8c494fd9b3aaf",
            "filename": "dev-infra/utils/child-process.ts",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/angular/angular/blob/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Futils%2Fchild-process.ts",
            "raw_url": "https://github.com/angular/angular/raw/372a6cf8d7690053d3a905a94a3f633bdb170488/dev-infra%2Futils%2Fchild-process.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Futils%2Fchild-process.ts?ref=372a6cf8d7690053d3a905a94a3f633bdb170488",
            "patch": "@@ -0,0 +1,82 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {spawn, SpawnOptions} from 'child_process';\n+import {debug, error} from './console';\n+\n+/** Interface describing the options for spawning a process. */\n+export interface SpawnedProcessOptions extends Omit<SpawnOptions, 'stdio'> {\n+  /** Console output mode. Defaults to \"enabled\". */\n+  mode?: 'enabled'|'silent'|'on-error';\n+}\n+\n+/** Interface describing the result of a spawned process. */\n+export interface SpawnedProcessResult {\n+  /** Captured stdout in string format. */\n+  stdout: string;\n+}\n+\n+/**\n+ * Spawns a given command with the specified arguments inside a shell. All process stdout\n+ * output is captured and returned as resolution on completion. Depending on the chosen\n+ * output mode, stdout/stderr output is also printed to the console, or only on error.\n+ *\n+ * @returns a Promise resolving with captured stdout on success. The promise\n+ *   rejects on command failure.\n+ */\n+export function spawnWithDebugOutput(\n+    command: string, args: string[],\n+    options: SpawnedProcessOptions = {}): Promise<SpawnedProcessResult> {\n+  return new Promise((resolve, reject) => {\n+    const commandText = `${command} ${args.join(' ')}`;\n+    const outputMode = options.mode;\n+\n+    debug(`Executing command: ${commandText}`);\n+\n+    const childProcess =\n+        spawn(command, args, {...options, shell: true, stdio: ['inherit', 'pipe', 'pipe']});\n+    let logOutput = '';\n+    let stdout = '';\n+\n+    // Capture the stdout separately so that it can be passed as resolve value.\n+    // This is useful if commands return parsable stdout.\n+    childProcess.stderr.on('data', message => {\n+      logOutput += message;\n+      // If console output is enabled, print the message directly to the stderr. Note that\n+      // we intentionally print all output to stderr as stderr should not be polluted.\n+      if (outputMode === undefined || outputMode === 'enabled') {\n+        process.stderr.write(message);\n+      }\n+    });\n+    childProcess.stdout.on('data', message => {\n+      stdout += message;\n+      logOutput += message;\n+      // If console output is enabled, print the message directly to the stderr. Note that\n+      // we intentionally print all output to stderr as stderr should not be polluted.\n+      if (outputMode === undefined || outputMode === 'enabled') {\n+        process.stderr.write(message);\n+      }\n+    });\n+\n+    childProcess.on('exit', (status, signal) => {\n+      const exitDescription = status !== null ? `exit code \"${status}\"` : `signal \"${signal}\"`;\n+      const printFn = outputMode === 'on-error' ? error : debug;\n+\n+      printFn(`Command ${commandText} completed with ${exitDescription}.`);\n+      printFn(`Process output: \\n${logOutput}`);\n+\n+      // On success, resolve the promise. Otherwise reject with the captured stderr\n+      // and stdout log output if the output mode was set to `silent`.\n+      if (status === 0) {\n+        resolve({stdout});\n+      } else {\n+        reject(outputMode === 'silent' ? logOutput : undefined);\n+      }\n+    });\n+  });\n+}"
        }
    ],
    "stats": {
        "total": 304,
        "additions": 304,
        "deletions": 0
    }
}