{
    "author": "devversion",
    "message": "refactor(compiler-cli): do not use `__filename` or `__dirname` global for ESM compatibility (#43431)\n\nSwitches the compiler-cli usage of `__filename` to `import.meta.url`\nwhen ESM bundles are generated. Unfortunately we cannot start using\nonly `import.meta` yet as we still build and run all code in Angular\nin CommonJS module output for devmode tests.\n\nThis commit also fixes various instances where a jasmine spy was applied on\na namespace export that will break with ES module (and the interop for\nCommonJS output). We fix these spies by using a default import.\n\nPR Close #43431",
    "sha": "b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
    "files": [
        {
            "sha": "28931d8e288c0dea60ed47f23f3f3dcff6ee8f29",
            "filename": "packages/compiler-cli/BUILD.bazel",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2FBUILD.bazel?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -68,6 +68,11 @@ ts_config(\n     deps = [\"//packages:tsconfig-build.json\"],\n )\n \n+ts_library(\n+    name = \"import_meta_url_types\",\n+    srcs = [\"import_meta_url.d.ts\"],\n+)\n+\n ts_library(\n     name = \"compiler-cli\",\n     srcs = glob(\n@@ -76,11 +81,13 @@ ts_library(\n             \"src/**/*.ts\",\n         ],\n         exclude = [\n+            \"import_meta_url.d.ts\",\n             \"src/integrationtest/**/*.ts\",\n         ],\n     ),\n     tsconfig = \":tsconfig\",\n     deps = [\n+        \":import_meta_url_types\",\n         \"//packages/compiler\",\n         \"//packages/compiler-cli/src/ngtsc/core\",\n         \"//packages/compiler-cli/src/ngtsc/core:api\","
        },
        {
            "sha": "ae46c8b1a1b0061fbf9d29bb0feac21f528869f0",
            "filename": "packages/compiler-cli/import_meta_url.d.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fimport_meta_url.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fimport_meta_url.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fimport_meta_url.d.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -0,0 +1,14 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+\n+// Note: The `__ESM_IMPORT_META_URL__` identifier will be defined as part of bundling.\n+// We cannot use `import.meta.url` directly as this code currently still runs in CommonJS\n+// for devmode. This is a solution allowing for both ESModule and CommonJS to run this file.\n+// TODO(devversion): replace all of this with `import.meta.url` once devmode is using ESM.\n+declare const __ESM_IMPORT_META_URL__: string;\n\\ No newline at end of file"
        },
        {
            "sha": "7c1ddf6cb8e4283aca1a9a3bc184e36be2b0dd17",
            "filename": "packages/compiler-cli/ngcc/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2FBUILD.bazel?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -13,6 +13,7 @@ ts_library(\n         \"//packages:types\",\n         \"//packages/compiler\",\n         \"//packages/compiler-cli\",\n+        \"//packages/compiler-cli:import_meta_url_types\",\n         \"//packages/compiler-cli/src/ngtsc/annotations\",\n         \"//packages/compiler-cli/src/ngtsc/cycles\",\n         \"//packages/compiler-cli/src/ngtsc/diagnostics\","
        },
        {
            "sha": "686431070e5fb1f664347a347953086ffe990c55",
            "filename": "packages/compiler-cli/ngcc/index.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Findex.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -6,7 +6,9 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {join} from 'path';\n+import {dirname, join} from 'path';\n+import {fileURLToPath} from 'url';\n+\n import {NodeJSFileSystem, setFileSystem} from '../src/ngtsc/file_system';\n \n import {mainNgcc} from './src/main';\n@@ -23,10 +25,17 @@ export function process(options: AsyncNgccOptions|SyncNgccOptions): void|Promise\n   return mainNgcc(options);\n }\n \n+\n+// CommonJS/ESM interop for determining the current file name and containing\n+// directory. These path is needed for providing an absolute path to the ngcc\n+// command line entry-point script (for the CLI).\n+export const containingDirPath =\n+    typeof __dirname !== 'undefined' ? __dirname : dirname(fileURLToPath(__ESM_IMPORT_META_URL__));\n+\n /**\n- * Absolute file path that points to the `ngcc` entry-point.\n+ * Absolute file path that points to the `ngcc` command line entry-point.\n  *\n  * This can be used by the Angular CLI to spawn a process running ngcc using\n  * command line options.\n  */\n-export const ngccMainFilePath = join(__dirname, './main-ngcc.js');\n+export const ngccMainFilePath = join(containingDirPath, './main-ngcc.js');"
        },
        {
            "sha": "77d84aec9e6ddd181724ce14bd34911cb01998ad",
            "filename": "packages/compiler-cli/ngcc/src/execution/cluster/master.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fmaster.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fmaster.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fexecution%2Fcluster%2Fmaster.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -9,6 +9,7 @@\n /// <reference types=\"node\" />\n \n import cluster from 'cluster';\n+import module from 'module';\n \n import {AbsoluteFsPath, PathManipulation} from '../../../../src/ngtsc/file_system';\n import {Logger} from '../../../../src/ngtsc/logging';\n@@ -21,7 +22,6 @@ import {stringifyTask} from '../tasks/utils';\n import {MessageFromWorker, TaskCompletedMessage, TransformedFilesMessage, UpdatePackageJsonMessage} from './api';\n import {Deferred, sendMessageToWorker} from './utils';\n \n-\n /**\n  * The cluster master is responsible for analyzing all entry-points, planning the work that needs to\n  * be done, distributing it to worker-processes and collecting/post-processing the results.\n@@ -44,7 +44,7 @@ export class ClusterMaster {\n     }\n \n     // Set the worker entry-point\n-    cluster.setupMaster({exec: this.fileSystem.resolve(__dirname, 'ngcc_cluster_worker.js')});\n+    cluster.setupMaster({exec: getClusterWorkerScriptPath(fileSystem)});\n \n     this.taskQueue = analyzeEntryPoints();\n     this.onTaskCompleted = createTaskCompletedCallback(this.taskQueue);\n@@ -330,3 +330,16 @@ export class ClusterMaster {\n     };\n   }\n }\n+\n+/** Gets the absolute file path to the cluster worker script. */\n+export function getClusterWorkerScriptPath(fileSystem: PathManipulation): AbsoluteFsPath {\n+  // This is an interop allowing for the worker script to be determined in both\n+  // a CommonJS module, or an ES module which does not come with `require` by default.\n+  const requireFn =\n+      typeof require !== 'undefined' ? require : module.createRequire(__ESM_IMPORT_META_URL__);\n+  // We resolve the worker script using module resolution as in the package output,\n+  // the worker might be bundled but exposed through a subpath export mapping.\n+  const workerScriptPath =\n+      requireFn.resolve('@angular/compiler-cli/ngcc/src/execution/cluster/ngcc_cluster_worker');\n+  return fileSystem.resolve(workerScriptPath);\n+}"
        },
        {
            "sha": "839c42edebebbdf911775a1e8f132b1ae47e1443",
            "filename": "packages/compiler-cli/ngcc/src/locking/lock_file_with_child_process/index.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file_with_child_process%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file_with_child_process%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Flocking%2Flock_file_with_child_process%2Findex.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {ChildProcess, fork} from 'child_process';\n+import module from 'module';\n \n import {AbsoluteFsPath, FileSystem} from '../../../../src/ngtsc/file_system';\n import {Logger, LogLevel} from '../../../../src/ngtsc/logging';\n@@ -78,7 +79,7 @@ export class LockFileWithChildProcess implements LockFile {\n         this.logger.level !== undefined ? this.logger.level.toString() : LogLevel.info.toString();\n     const isWindows = process.platform === 'win32';\n     const unlocker = fork(\n-        __dirname + '/ngcc_lock_unlocker.js', [path, logLevel],\n+        getLockFileUnlockerScriptPath(this.fs), [path, logLevel],\n         {detached: true, stdio: isWindows ? 'pipe' : 'inherit'});\n     if (isWindows) {\n       unlocker.stdout?.on('data', process.stdout.write.bind(process.stdout));\n@@ -87,3 +88,16 @@ export class LockFileWithChildProcess implements LockFile {\n     return unlocker;\n   }\n }\n+\n+/** Gets the absolute file path to the lock file unlocker script. */\n+export function getLockFileUnlockerScriptPath(fileSystem: FileSystem): AbsoluteFsPath {\n+  // This is an interop allowing for the unlocking script to be determined in both\n+  // a CommonJS module, or an ES module which does not come with `require` by default.\n+  const requireFn =\n+      typeof require !== 'undefined' ? require : module.createRequire(__ESM_IMPORT_META_URL__);\n+  // We resolve the worker script using module resolution as in the package output,\n+  // the worker might be bundled but exposed through a subpath export mapping.\n+  const unlockerScriptPath = requireFn.resolve(\n+      '@angular/compiler-cli/ngcc/src/locking/lock_file_with_child_process/ngcc_lock_unlocker');\n+  return fileSystem.resolve(unlockerScriptPath);\n+}"
        },
        {
            "sha": "13f3c857534896b61f5c5396c384773fb879a77b",
            "filename": "packages/compiler-cli/ngcc/src/packages/configuration.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fconfiguration.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fconfiguration.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fpackages%2Fconfiguration.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -6,6 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {createHash} from 'crypto';\n+import module from 'module';\n import semver from 'semver';\n import * as vm from 'vm';\n \n@@ -267,6 +268,11 @@ export const DEFAULT_NGCC_CONFIG: NgccProjectConfig = {\n \n const NGCC_CONFIG_FILENAME = 'ngcc.config.js';\n \n+// CommonJS/ESM interop for determining the current file name and containing\n+// directory. The path is needed for loading the user configuration.\n+const isCommonJS = typeof require !== 'undefined';\n+const currentFileUrl = isCommonJS ? null : __ESM_IMPORT_META_URL__;\n+\n /**\n  * The processed package level configuration as a result of processing a raw package level config.\n  */\n@@ -435,12 +441,13 @@ export class NgccConfiguration {\n   }\n \n   private evalSrcFile(srcPath: AbsoluteFsPath): any {\n+    const requireFn = isCommonJS ? require : module.createRequire(currentFileUrl!);\n     const src = this.fs.readFile(srcPath);\n     const theExports = {};\n     const sandbox = {\n       module: {exports: theExports},\n       exports: theExports,\n-      require,\n+      require: requireFn,\n       __dirname: this.fs.dirname(srcPath),\n       __filename: srcPath\n     };"
        },
        {
            "sha": "c80ec6ae5d2f2777725243f8f425c4420b2bf1dc",
            "filename": "packages/compiler-cli/ngcc/test/integration/ngcc_spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fintegration%2Fngcc_spec.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n /// <reference types=\"node\" />\n-import {readFileSync} from 'fs';\n-import * as os from 'os';\n+import realFs from 'fs';\n+import os from 'os';\n \n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '../../../src/ngtsc/file_system';\n import {Folder, MockFileSystem, runInEachFileSystem, TestFile} from '../../../src/ngtsc/file_system/testing';\n@@ -69,7 +69,7 @@ runInEachFileSystem(() => {\n       fs.ensureDir(fs.join(pkgPath, 'fesm5'));\n       fs.writeFile(\n           fs.join(pkgPath, 'fesm5/core.js'),\n-          readFileSync(require.resolve('../fesm5_angular_core.js'), 'utf8'));\n+          realFs.readFileSync(require.resolve('../fesm5_angular_core.js'), 'utf8'));\n \n       pkgJson.esm5 = './fesm5/core.js';\n       pkgJson.fesm5 = './fesm5/core.js';"
        },
        {
            "sha": "f28c0a3a927b7cb77314b792d51d4de31254d4cf",
            "filename": "packages/compiler-cli/ngcc/test/ngcc_options_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fngcc_options_spec.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -5,7 +5,10 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import * as os from 'os';\n+// Note: We do not use a namespace import here because this will result in the\n+// named exports being modified if we apply jasmine spies on `realFs`. Using\n+// the default export gives us an object where we can patch properties on.\n+import os from 'os';\n \n import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '../../src/ngtsc/file_system';\n import {runInEachFileSystem} from '../../src/ngtsc/file_system/testing';"
        },
        {
            "sha": "a9d5b1577bd215690882a989b63a1d0a9fb1c08b",
            "filename": "packages/compiler-cli/package.json",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fpackage.json",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fpackage.json?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -40,6 +40,12 @@\n     \"./private/migrations\": {\n       \"types\": \"./private/migrations.d.ts\",\n       \"default\": \"./bundles/private/migrations.js\"\n+    },\n+    \"./ngcc/src/execution/cluster/ngcc_cluster_worker\": {\n+      \"default\": \"./bundles/ngcc/src/execution/cluster/ngcc_cluster_worker.js\"\n+    },\n+    \"./ngcc/src/locking/lock_file_with_child_process/ngcc_lock_unlocker\": {\n+      \"default\": \"./bundles/ngcc/src/locking/lock_file_with_child_process/ngcc_lock_unlocker.js\"\n     }\n   },\n   \"dependencies\": {"
        },
        {
            "sha": "bc181642c3f1e7f98ce7621fb6c65d863410e2c7",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/BUILD.bazel",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2FBUILD.bazel?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -8,6 +8,9 @@ ts_library(\n         \"src/**/*.ts\",\n     ]),\n     deps = [\n+        # Allows for the `import.meta.url` constant to be used. This is\n+        # a temporary interop until devmode is switched to ESM.\n+        \"//packages/compiler-cli:import_meta_url_types\",\n         \"@npm//@types/node\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "b926c95126f5c907cdc12fbdb0f7a78e2562f696",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/src/node_js_file_system.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Fsrc%2Fnode_js_file_system.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -7,7 +7,10 @@\n  */\n /// <reference types=\"node\" />\n import * as fs from 'fs';\n+import module from 'module';\n import * as p from 'path';\n+import {fileURLToPath} from 'url';\n+\n import {AbsoluteFsPath, FileStats, FileSystem, PathManipulation, PathSegment, PathString, ReadonlyFileSystem} from './types';\n \n /**\n@@ -51,6 +54,14 @@ export class NodeJSPathManipulation implements PathManipulation {\n   }\n }\n \n+// CommonJS/ESM interop for determining the current file name and containing\n+// directory. These paths are needed for detecting whether the file system\n+// is case sensitive, or for finding the TypeScript default libraries.\n+// TODO(devversion): Simplify this in the future if devmode uses ESM as well.\n+const isCommonJS = typeof __filename !== 'undefined';\n+const currentFileUrl = isCommonJS ? null : __ESM_IMPORT_META_URL__;\n+const currentFileName = isCommonJS ? __filename : fileURLToPath(currentFileUrl!);\n+\n /**\n  * A wrapper around the Node.js file-system that supports readonly operations and path manipulation.\n  */\n@@ -60,7 +71,7 @@ export class NodeJSReadonlyFileSystem extends NodeJSPathManipulation implements\n     if (this._caseSensitive === undefined) {\n       // Note the use of the real file-system is intentional:\n       // `this.exists()` relies upon `isCaseSensitive()` so that would cause an infinite recursion.\n-      this._caseSensitive = !fs.existsSync(this.normalize(toggleCase(__filename)));\n+      this._caseSensitive = !fs.existsSync(this.normalize(toggleCase(currentFileName)));\n     }\n     return this._caseSensitive;\n   }\n@@ -86,7 +97,9 @@ export class NodeJSReadonlyFileSystem extends NodeJSPathManipulation implements\n     return this.resolve(fs.realpathSync(path));\n   }\n   getDefaultLibLocation(): AbsoluteFsPath {\n-    return this.resolve(require.resolve('typescript'), '..');\n+    // TODO(devversion): Once devmode output uses ESM, we can simplify this.\n+    const requireFn = isCommonJS ? require : module.createRequire(currentFileUrl!);\n+    return this.resolve(requireFn.resolve('typescript'), '..');\n   }\n }\n "
        },
        {
            "sha": "b973d201aa55afc5f63afeeb03285f50870754c8",
            "filename": "packages/compiler-cli/src/ngtsc/file_system/test/node_js_file_system_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftest%2Fnode_js_file_system_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftest%2Fnode_js_file_system_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ffile_system%2Ftest%2Fnode_js_file_system_spec.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -5,8 +5,12 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import * as realFs from 'fs';\n+// Note: We do not use a namespace import here because this will result in the\n+// named exports being modified if we apply jasmine spies on `realFs`. Using\n+// the default export gives us an object where we can patch properties on.\n+import realFs from 'fs';\n import * as os from 'os';\n+\n import {NodeJSFileSystem, NodeJSPathManipulation, NodeJSReadonlyFileSystem} from '../src/node_js_file_system';\n import {AbsoluteFsPath, PathSegment} from '../src/types';\n "
        },
        {
            "sha": "79850af500bf7fb05e307a4a15c305483616a804",
            "filename": "packages/language-service/test/reflector_host_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Flanguage-service%2Ftest%2Freflector_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Flanguage-service%2Ftest%2Freflector_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Freflector_host_spec.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as path from 'path';\n+import path from 'path';\n import ts from 'typescript';\n \n import {ReflectorHost} from '../src/reflector_host';"
        },
        {
            "sha": "e549e01eb9c227b19479f31000b6b2823c614639",
            "filename": "packages/language-service/test/typescript_host_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Flanguage-service%2Ftest%2Ftypescript_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4/packages%2Flanguage-service%2Ftest%2Ftypescript_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Ftest%2Ftypescript_host_spec.ts?ref=b1d6fad5e3727fef705c2e5a7bfcc82ab515c9d4",
            "patch": "@@ -6,7 +6,10 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as path from 'path';\n+// Note: We do not use a namespace import here because this will result in the\n+// named exports being modified if we apply jasmine spies on `path`. Using\n+// the default export gives us an object where we can patch properties on.\n+import path from 'path';\n import ts from 'typescript';\n \n import {TypeScriptServiceHost} from '../src/typescript_host';"
        }
    ],
    "stats": {
        "total": 129,
        "additions": 113,
        "deletions": 16
    }
}