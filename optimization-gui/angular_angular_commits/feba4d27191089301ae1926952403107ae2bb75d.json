{
    "author": "petebacondarwin",
    "message": "fix(compiler): include leading whitespace in source-spans of i18n messages (#43132)\n\nPreviously, the way templates were tokenized meant that we lost information\nabout the location of interpolations if the template contained encoded HTML\nentities. This meant that the mapping back to the source interpolated strings\ncould be offset incorrectly.\n\nAlso, the source-span assigned to an i18n message did not include leading\nwhitespace. This confused the output source-mappings so that the first text\nnodes of the message stopped at the first non-whitespace character.\n\nThis commit makes use of the previous refactorings, where more fine grain\ninformation was provided in text tokens, to enable the parser to identify\nthe location of the interpolations in the original source more accurately.\n\nFixes #41034\n\nPR Close #43132",
    "sha": "feba4d27191089301ae1926952403107ae2bb75d",
    "files": [
        {
            "sha": "bfbf5afe806b8d0409fe5c7c3f8a987bee6d710e",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/localize_legacy_message_ids/GOLDEN_PARTIAL.js",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2FGOLDEN_PARTIAL.js",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2FGOLDEN_PARTIAL.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2FGOLDEN_PARTIAL.js?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -7,14 +7,28 @@ export class MyComponent {\n }\n MyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });\n MyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", type: MyComponent, selector: \"my-component\", ngImport: i0, template: `\n-  <div i18n>Some Message</div>\n+  <div i18n-title title=\"Some &amp; attribute\"></div>\n+  <div i18n>Some &amp; message</div>\n+  <div i18n-title title=\"Some &amp; {{'interpolated'}} attribute\"></div>\n+  <div i18n>Some &amp; {{'interpolated' }} message</div>\n+  <div i18n>&amp;</div>\n+  <div i18n>&amp;&quot;</div>\n+  <div i18n-title title=\"&quot;\"></div>\n+  <div i18n-title title=\"&quot;&quot;\"></div>\n `, isInline: true });\n i0.ɵɵngDeclareClassMetadata({ minVersion: \"12.0.0\", version: \"0.0.0-PLACEHOLDER\", ngImport: i0, type: MyComponent, decorators: [{\n             type: Component,\n             args: [{\n                     selector: 'my-component',\n                     template: `\n-  <div i18n>Some Message</div>\n+  <div i18n-title title=\"Some &amp; attribute\"></div>\n+  <div i18n>Some &amp; message</div>\n+  <div i18n-title title=\"Some &amp; {{'interpolated'}} attribute\"></div>\n+  <div i18n>Some &amp; {{'interpolated' }} message</div>\n+  <div i18n>&amp;</div>\n+  <div i18n>&amp;&quot;</div>\n+  <div i18n-title title=\"&quot;\"></div>\n+  <div i18n-title title=\"&quot;&quot;\"></div>\n `\n                 }]\n         }] });"
        },
        {
            "sha": "edaa4dac2efa12d7ae40d5fae239bd03a6301c4b",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/localize_legacy_message_ids/legacy_enabled.js",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2Flegacy_enabled.js",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2Flegacy_enabled.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2Flegacy_enabled.js?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -1,5 +1,11 @@\n-let $I18N_0$;\n-if (typeof ngI18nClosureMode !== \"undefined\" && ngI18nClosureMode) { … }\n-else {\n-    $I18N_0$ = $localize `:␟ec93160d6d6a8822214060dd7938bf821c22b226␟6795333002533525253:Some Message`;\n-}\n+$localize `:␟82ec661067f503a3357ecc159b2128325e9208cd␟2908931752694090721:Some & attribute`;\n+…\n+$localize `:␟10adaf0ad7b8ba40200cd3c0e7c8d0f13280d522␟4700340487900776701:Some & message`;\n+…\n+$localize `:␟57ebd20267116c04cc1dbd7be0b73bf56484f45d␟2334195497629636162:Some & ${\"\\uFFFD0\\uFFFD\"}:INTERPOLATION: attribute`;\n+…\n+$localize `:␟28d558ca32556f1da67a333e3dada321a97212cd␟3204054277547499090:Some & ${\"\\uFFFD0\\uFFFD\"}:INTERPOLATION: message`;\n+…\n+$localize `:␟0b3dff7b9382b6217ac97c99f9b04df04381bfdd␟2406634758623728945:&`;\n+…\n+$localize `:␟25b7cbf210e59a931423097cb7f2e1b72991a687␟4156372478368653226:&\"`;\n\\ No newline at end of file"
        },
        {
            "sha": "85971f20037068d035c8c32ae8e624e01576947f",
            "filename": "packages/compiler-cli/test/compliance/test_cases/r3_view_compiler_i18n/localize_legacy_message_ids/legacy_enabled.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2Flegacy_enabled.ts",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2Flegacy_enabled.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fr3_view_compiler_i18n%2Flocalize_legacy_message_ids%2Flegacy_enabled.ts?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -3,12 +3,19 @@ import {Component, NgModule} from '@angular/core';\n @Component({\n   selector: 'my-component',\n   template: `\n-  <div i18n>Some Message</div>\n+  <div i18n-title title=\"Some &amp; attribute\"></div>\n+  <div i18n>Some &amp; message</div>\n+  <div i18n-title title=\"Some &amp; {{'interpolated'}} attribute\"></div>\n+  <div i18n>Some &amp; {{'interpolated' }} message</div>\n+  <div i18n>&amp;</div>\n+  <div i18n>&amp;&quot;</div>\n+  <div i18n-title title=\"&quot;\"></div>\n+  <div i18n-title title=\"&quot;&quot;\"></div>\n `\n })\n export class MyComponent {\n }\n \n @NgModule({declarations: [MyComponent]})\n export class MyModule {\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "c396b26efecf67957825940ad9aec17918c22fa1",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_element_whitespace.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace.js",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace.js?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -1,19 +1,19 @@\n-` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"pre-p\\\\n  \"\n+` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  pre-p\\\\n  \"\n …\n-\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n …\n-}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"in-p\\\\n  \"\n+}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n    in-p\\\\n  \"\n …\n \"\\uFFFD/#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</p>\"\n …\n-}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"post-p\\\\n\"\n+}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  post-p\\\\n\"\n …\n \n i0.ɵɵelementStart(0, \"div\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n …\n i0.ɵɵi18nStart(1, 0) // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n …\n-i0.ɵɵelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+i0.ɵɵelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n …\n i0.ɵɵi18nEnd() // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</div>\"\n …"
        },
        {
            "sha": "ccdff3a1e4dbb673e5e6ca98bc6371cc33092a8c",
            "filename": "packages/compiler-cli/test/compliance/test_cases/source_mapping/inline_templates/i18n_message_element_whitespace_partial.js",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace_partial.js",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace_partial.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fcompliance%2Ftest_cases%2Fsource_mapping%2Finline_templates%2Fi18n_message_element_whitespace_partial.js?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -1,19 +1,19 @@\n-$localize` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"pre-p\\\\n  \"\n+$localize` pre-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  pre-p\\\\n  \"\n …\n-\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+\"\\uFFFD#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n …\n-}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"in-p\\\\n  \"\n+}:START_PARAGRAPH: in-p ${ // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n    in-p\\\\n  \"\n …\n-\"\\uFFFD/#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</p>\\\\n  \"\n+\"\\uFFFD/#2\\uFFFD\" // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</p>\"\n …\n-}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"post-p\\\\n\"\n+}:CLOSE_PARAGRAPH: post-p\\n` // SOURCE: \"/i18n_message_element_whitespace.ts\" \"\\\\n  post-p\\\\n\"\n …\n \n-.ɵɵelementStart(0, \"div\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\\\\n  \"\n+.ɵɵelementStart(0, \"div\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n …\n-.ɵɵi18nStart(1, 0) // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\\\\n  \"\n+.ɵɵi18nStart(1, 0) // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<div i18n>\"\n …\n-.ɵɵelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\\\\n    \"\n+.ɵɵelement(2, \"p\") // SOURCE: \"/i18n_message_element_whitespace.ts\" \"<p>\"\n …\n .ɵɵi18nEnd() // SOURCE: \"/i18n_message_element_whitespace.ts\" \"</div>'\"\n …"
        },
        {
            "sha": "02cfcede57a425dbd85d8f58d8af1b2d205b95d0",
            "filename": "packages/compiler-cli/test/ngtsc/template_mapping_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_mapping_spec.ts?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -464,27 +464,27 @@ runInEachFileSystem((os) => {\n              // $localize expressions\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: 'pre-p\\n  ',\n+               source: '\\n  pre-p\\n  ',\n                generated: '` pre-p ${',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: '<p>\\n    ',\n+               source: '<p>',\n                generated: '\"\\\\uFFFD#2\\\\uFFFD\"',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: 'in-p\\n  ',\n+               source: '\\n    in-p\\n  ',\n                generated: '}:START_PARAGRAPH: in-p ${',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: '</p>\\n  ',\n+               source: '</p>',\n                generated: '\"\\\\uFFFD/#2\\\\uFFFD\"',\n              });\n              expectMapping(mappings, {\n                sourceUrl: '../test.ts',\n-               source: 'post-p\\n',\n+               source: '\\n  post-p\\n',\n                generated: '}:CLOSE_PARAGRAPH: post-p\\n`',\n              });\n              // ivy instructions"
        },
        {
            "sha": "c24dd7c0a1d57e337e10e40b6803babe02908a00",
            "filename": "packages/compiler/src/i18n/i18n_parser.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 66,
            "changes": 118,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Fi18n%2Fi18n_parser.ts?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -7,10 +7,11 @@\n  */\n \n import {Lexer as ExpressionLexer} from '../expression_parser/lexer';\n-import {InterpolationPiece, Parser as ExpressionParser} from '../expression_parser/parser';\n+import {Parser as ExpressionParser} from '../expression_parser/parser';\n import * as html from '../ml_parser/ast';\n import {getHtmlTagDefinition} from '../ml_parser/html_tags';\n import {InterpolationConfig} from '../ml_parser/interpolation_config';\n+import {Token, TokenType} from '../ml_parser/lexer';\n import {ParseSourceSpan} from '../parse_util';\n \n import * as i18n from './i18n_ast';\n@@ -105,13 +106,18 @@ class _I18nVisitor implements html.Visitor {\n   }\n \n   visitAttribute(attribute: html.Attribute, context: I18nMessageVisitorContext): i18n.Node {\n-    const node = this._visitTextWithInterpolation(\n-        attribute.value, attribute.valueSpan || attribute.sourceSpan, context, attribute.i18n);\n+    const node = attribute.valueTokens === undefined || attribute.valueTokens.length === 1 ?\n+        new i18n.Text(attribute.value, attribute.valueSpan || attribute.sourceSpan) :\n+        this._visitTextWithInterpolation(\n+            attribute.valueTokens, attribute.valueSpan || attribute.sourceSpan, context,\n+            attribute.i18n);\n     return context.visitNodeFn(attribute, node);\n   }\n \n   visitText(text: html.Text, context: I18nMessageVisitorContext): i18n.Node {\n-    const node = this._visitTextWithInterpolation(text.value, text.sourceSpan, context, text.i18n);\n+    const node = text.tokens.length === 1 ?\n+        new i18n.Text(text.value, text.sourceSpan) :\n+        this._visitTextWithInterpolation(text.tokens, text.sourceSpan, context, text.i18n);\n     return context.visitNodeFn(text, node);\n   }\n \n@@ -165,66 +171,54 @@ class _I18nVisitor implements html.Visitor {\n    * @param previousI18n Any i18n metadata associated with this `text` from a previous pass.\n    */\n   private _visitTextWithInterpolation(\n-      text: string, sourceSpan: ParseSourceSpan, context: I18nMessageVisitorContext,\n+      tokens: Token[], sourceSpan: ParseSourceSpan, context: I18nMessageVisitorContext,\n       previousI18n: i18n.I18nMeta|undefined): i18n.Node {\n-    const {strings, expressions} = this._expressionParser.splitInterpolation(\n-        text, sourceSpan.start.toString(), this._interpolationConfig);\n-\n-    // No expressions, return a single text.\n-    if (expressions.length === 0) {\n-      return new i18n.Text(text, sourceSpan);\n-    }\n-\n     // Return a sequence of `Text` and `Placeholder` nodes grouped in a `Container`.\n     const nodes: i18n.Node[] = [];\n-    for (let i = 0; i < strings.length - 1; i++) {\n-      this._addText(nodes, strings[i], sourceSpan);\n-      this._addPlaceholder(nodes, context, expressions[i], sourceSpan);\n+    // We will only create a container if there are actually interpolations,\n+    // so this flag tracks that.\n+    let hasInterpolation = false;\n+    for (const token of tokens) {\n+      switch (token.type) {\n+        case TokenType.INTERPOLATION:\n+        case TokenType.ATTR_VALUE_INTERPOLATION:\n+          hasInterpolation = true;\n+          const expression = token.parts[1];\n+          const baseName = extractPlaceholderName(expression) || 'INTERPOLATION';\n+          const phName = context.placeholderRegistry.getPlaceholderName(baseName, expression);\n+          context.placeholderToContent[phName] = {\n+            text: token.parts.join(''),\n+            sourceSpan: token.sourceSpan\n+          };\n+          nodes.push(new i18n.Placeholder(expression, phName, token.sourceSpan));\n+          break;\n+        default:\n+          if (token.parts[0].length > 0) {\n+            // This token is text or an encoded entity.\n+            // If it is following on from a previous text node then merge it into that node\n+            // Otherwise, if it is following an interpolation, then add a new node.\n+            const previous = nodes[nodes.length - 1];\n+            if (previous instanceof i18n.Text) {\n+              previous.value += token.parts[0];\n+              previous.sourceSpan = new ParseSourceSpan(\n+                  previous.sourceSpan.start, token.sourceSpan.end, previous.sourceSpan.fullStart,\n+                  previous.sourceSpan.details);\n+            } else {\n+              nodes.push(new i18n.Text(token.parts[0], token.sourceSpan));\n+            }\n+          }\n+          break;\n+      }\n     }\n-    // The last index contains no expression\n-    this._addText(nodes, strings[strings.length - 1], sourceSpan);\n-\n-    // Whitespace removal may have invalidated the interpolation source-spans.\n-    reusePreviousSourceSpans(nodes, previousI18n);\n-\n-    return new i18n.Container(nodes, sourceSpan);\n-  }\n \n-  /**\n-   * Create a new `Text` node from the `textPiece` and add it to the `nodes` collection.\n-   *\n-   * @param nodes The nodes to which the created `Text` node should be added.\n-   * @param textPiece The text and relative span information for this `Text` node.\n-   * @param interpolationSpan The span of the whole interpolated text.\n-   */\n-  private _addText(\n-      nodes: i18n.Node[], textPiece: InterpolationPiece, interpolationSpan: ParseSourceSpan): void {\n-    if (textPiece.text.length > 0) {\n-      // No need to add empty strings\n-      const stringSpan = getOffsetSourceSpan(interpolationSpan, textPiece);\n-      nodes.push(new i18n.Text(textPiece.text, stringSpan));\n+    if (hasInterpolation) {\n+      // Whitespace removal may have invalidated the interpolation source-spans.\n+      reusePreviousSourceSpans(nodes, previousI18n);\n+      return new i18n.Container(nodes, sourceSpan);\n+    } else {\n+      return nodes[0];\n     }\n   }\n-\n-  /**\n-   * Create a new `Placeholder` node from the `expression` and add it to the `nodes` collection.\n-   *\n-   * @param nodes The nodes to which the created `Text` node should be added.\n-   * @param context The current context of the visitor, used to compute and store placeholders.\n-   * @param expression The expression text and relative span information for this `Placeholder`\n-   *     node.\n-   * @param interpolationSpan The span of the whole interpolated text.\n-   */\n-  private _addPlaceholder(\n-      nodes: i18n.Node[], context: I18nMessageVisitorContext, expression: InterpolationPiece,\n-      interpolationSpan: ParseSourceSpan): void {\n-    const sourceSpan = getOffsetSourceSpan(interpolationSpan, expression);\n-    const baseName = extractPlaceholderName(expression.text) || 'INTERPOLATION';\n-    const phName = context.placeholderRegistry.getPlaceholderName(baseName, expression.text);\n-    const text = this._interpolationConfig.start + expression.text + this._interpolationConfig.end;\n-    context.placeholderToContent[phName] = {text, sourceSpan};\n-    nodes.push(new i18n.Placeholder(expression.text, phName, sourceSpan));\n-  }\n }\n \n /**\n@@ -247,7 +241,7 @@ function reusePreviousSourceSpans(nodes: i18n.Node[], previousI18n: i18n.I18nMet\n \n   if (previousI18n instanceof i18n.Container) {\n     // The `previousI18n` is a `Container`, which means that this is a second i18n extraction pass\n-    // after whitespace has been removed from the AST ndoes.\n+    // after whitespace has been removed from the AST nodes.\n     assertEquivalentNodes(previousI18n.children, nodes);\n \n     // Reuse the source-spans from the first pass.\n@@ -282,14 +276,6 @@ function assertEquivalentNodes(previousNodes: i18n.Node[], nodes: i18n.Node[]):\n   }\n }\n \n-/**\n- * Create a new `ParseSourceSpan` from the `sourceSpan`, offset by the `start` and `end` values.\n- */\n-function getOffsetSourceSpan(\n-    sourceSpan: ParseSourceSpan, {start, end}: InterpolationPiece): ParseSourceSpan {\n-  return new ParseSourceSpan(sourceSpan.fullStart.moveBy(start), sourceSpan.fullStart.moveBy(end));\n-}\n-\n const _CUSTOM_PH_EXP =\n     /\\/\\/[\\s\\S]*i18n[\\s\\S]*\\([\\s\\S]*ph[\\s\\S]*=[\\s\\S]*(\"|')([\\s\\S]*?)\\1[\\s\\S]*\\)/g;\n "
        },
        {
            "sha": "7579d3ebb8894fca56ba581f18302e1a5b970b46",
            "filename": "packages/compiler/src/render3/view/i18n/localize_utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Flocalize_utils.ts?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -35,7 +35,10 @@ class LocalizeSerializerVisitor implements i18n.Visitor {\n       // Two literal pieces in a row means that there was some comment node in-between.\n       context[context.length - 1].text += text.value;\n     } else {\n-      context.push(new o.LiteralPiece(text.value, text.sourceSpan));\n+      const sourceSpan = new ParseSourceSpan(\n+          text.sourceSpan.fullStart, text.sourceSpan.end, text.sourceSpan.fullStart,\n+          text.sourceSpan.details);\n+      context.push(new o.LiteralPiece(text.value, sourceSpan));\n     }\n   }\n \n@@ -90,7 +93,7 @@ function getSourceSpan(message: i18n.Message): ParseSourceSpan {\n   const startNode = message.nodes[0];\n   const endNode = message.nodes[message.nodes.length - 1];\n   return new ParseSourceSpan(\n-      startNode.sourceSpan.start, endNode.sourceSpan.end, startNode.sourceSpan.fullStart,\n+      startNode.sourceSpan.fullStart, endNode.sourceSpan.end, startNode.sourceSpan.fullStart,\n       startNode.sourceSpan.details);\n }\n "
        },
        {
            "sha": "25a1a9c0d87549ec92a40c2ea77c47abbe2e79cc",
            "filename": "packages/compiler/test/render3/view/i18n_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/feba4d27191089301ae1926952403107ae2bb75d/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Ftest%2Frender3%2Fview%2Fi18n_spec.ts?ref=feba4d27191089301ae1926952403107ae2bb75d",
            "patch": "@@ -478,7 +478,7 @@ describe('serializeI18nMessageForLocalize', () => {\n        expect(messageParts[3].text).toEqual('');\n        expect(messageParts[3].sourceSpan.toString()).toEqual('');\n        expect(messageParts[4].text).toEqual(' D');\n-       expect(messageParts[4].sourceSpan.toString()).toEqual('D');\n+       expect(messageParts[4].sourceSpan.toString()).toEqual(' D');\n \n        expect(placeHolders[0].text).toEqual('START_TAG_SPAN');\n        expect(placeHolders[0].sourceSpan.toString()).toEqual('<span>');"
        }
    ],
    "stats": {
        "total": 208,
        "additions": 112,
        "deletions": 96
    }
}