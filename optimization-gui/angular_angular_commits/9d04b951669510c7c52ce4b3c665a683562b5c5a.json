{
    "author": "JoostK",
    "message": "refactor(compiler-cli): setup compilation mode to enable generating linker code (#38938)\n\nThis is a precursor to introducing the Angular linker. As an initial\nstep, a compiler option to configure the compilation mode is introduced.\nThis option is initially internal until the linker is considered ready.\n\nPR Close #38938",
    "sha": "9d04b951669510c7c52ce4b3c665a683562b5c5a",
    "files": [
        {
            "sha": "bfda1dbeffd165dda4d3cea93aa45f0622915855",
            "filename": "packages/compiler-cli/ngcc/src/analysis/ngcc_trait_compiler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fngcc_trait_compiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fngcc_trait_compiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fngcc_trait_compiler.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -10,7 +10,7 @@ import * as ts from 'typescript';\n import {IncrementalBuild} from '../../../src/ngtsc/incremental/api';\n import {NOOP_PERF_RECORDER} from '../../../src/ngtsc/perf';\n import {ClassDeclaration, Decorator} from '../../../src/ngtsc/reflection';\n-import {DecoratorHandler, DtsTransformRegistry, HandlerFlags, Trait, TraitCompiler} from '../../../src/ngtsc/transform';\n+import {CompilationMode, DecoratorHandler, DtsTransformRegistry, HandlerFlags, Trait, TraitCompiler} from '../../../src/ngtsc/transform';\n import {NgccReflectionHost} from '../host/ngcc_host';\n import {isDefined} from '../utils';\n \n@@ -26,7 +26,7 @@ export class NgccTraitCompiler extends TraitCompiler {\n       private ngccReflector: NgccReflectionHost) {\n     super(\n         handlers, ngccReflector, NOOP_PERF_RECORDER, new NoIncrementalBuild(),\n-        /* compileNonExportedClasses */ true, new DtsTransformRegistry());\n+        /* compileNonExportedClasses */ true, CompilationMode.FULL, new DtsTransformRegistry());\n   }\n \n   get analyzedFiles(): ts.SourceFile[] {"
        },
        {
            "sha": "6acdb86a579f035e54d030ccf5fbbf94ec5268c7",
            "filename": "packages/compiler-cli/ngcc/test/analysis/decoration_analyzer_spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fdecoration_analyzer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fdecoration_analyzer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fdecoration_analyzer_spec.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -48,7 +48,7 @@ runInEachFileSystem(() => {\n           'analyze',\n           'register',\n           'resolve',\n-          'compile',\n+          'compileFull',\n         ]);\n         // Only detect the Component and Directive decorators\n         handler.detect.and.callFake(\n@@ -95,7 +95,7 @@ runInEachFileSystem(() => {\n         });\n         // The \"test\" compilation result is just the name of the decorator being compiled\n         // (suffixed with `(compiled)`)\n-        (handler.compile as any).and.callFake((decl: ts.Declaration, analysis: any) => {\n+        (handler.compileFull as any).and.callFake((decl: ts.Declaration, analysis: any) => {\n           logs.push(`compile: ${(decl as any).name.text}@${analysis.decoratorName} (resolved: ${\n               analysis.resolved})`);\n           return `@${analysis.decoratorName} (compiled)`;\n@@ -414,7 +414,7 @@ runInEachFileSystem(() => {\n           expect(testHandler.analyze).toHaveBeenCalled();\n           expect(testHandler.register).not.toHaveBeenCalled();\n           expect(testHandler.resolve).not.toHaveBeenCalled();\n-          expect(testHandler.compile).not.toHaveBeenCalled();\n+          expect(testHandler.compileFull).not.toHaveBeenCalled();\n         });\n \n         it('should report resolve diagnostics to the `diagnosticHandler` callback', () => {\n@@ -436,7 +436,7 @@ runInEachFileSystem(() => {\n           expect(testHandler.analyze).toHaveBeenCalled();\n           expect(testHandler.register).toHaveBeenCalled();\n           expect(testHandler.resolve).toHaveBeenCalled();\n-          expect(testHandler.compile).not.toHaveBeenCalled();\n+          expect(testHandler.compileFull).not.toHaveBeenCalled();\n         });\n       });\n \n@@ -452,7 +452,7 @@ runInEachFileSystem(() => {\n             analyze(): AnalysisOutput<unknown> {\n               throw new Error('analyze should not have been called');\n             }\n-            compile(): CompileResult {\n+            compileFull(): CompileResult {\n               throw new Error('compile should not have been called');\n             }\n           }"
        },
        {
            "sha": "b4053aca9787bd6ec2cad13c452116cc7078716d",
            "filename": "packages/compiler-cli/ngcc/test/analysis/migration_host_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fmigration_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fmigration_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fmigration_host_spec.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -209,7 +209,7 @@ class DetectDecoratorHandler implements DecoratorHandler<unknown, unknown, unkno\n     return {};\n   }\n \n-  compile(node: ClassDeclaration): CompileResult|CompileResult[] {\n+  compileFull(node: ClassDeclaration): CompileResult|CompileResult[] {\n     return [];\n   }\n }\n@@ -227,7 +227,7 @@ class DiagnosticProducingHandler implements DecoratorHandler<unknown, unknown, u\n     return {diagnostics: [makeDiagnostic(9999, node, 'test diagnostic')]};\n   }\n \n-  compile(node: ClassDeclaration): CompileResult|CompileResult[] {\n+  compileFull(node: ClassDeclaration): CompileResult|CompileResult[] {\n     return [];\n   }\n }"
        },
        {
            "sha": "ab09980e3a2d945f0ac8d967ab88e42f7f63ce39",
            "filename": "packages/compiler-cli/ngcc/test/analysis/ngcc_trait_compiler_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fngcc_trait_compiler_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fngcc_trait_compiler_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Fngcc_trait_compiler_spec.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -309,7 +309,7 @@ class TestHandler implements DecoratorHandler<unknown, unknown, unknown> {\n     return {};\n   }\n \n-  compile(node: ClassDeclaration): CompileResult|CompileResult[] {\n+  compileFull(node: ClassDeclaration): CompileResult|CompileResult[] {\n     this.log.push(this.name + ':compile:' + node.name.text);\n     return [];\n   }"
        },
        {
            "sha": "d96802001185c7204d9dd13b4bbb852bf816e42f",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/component.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fcomponent.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -585,7 +585,7 @@ export class ComponentDecoratorHandler implements\n     return {data};\n   }\n \n-  compile(\n+  compileFull(\n       node: ClassDeclaration, analysis: Readonly<ComponentAnalysisData>,\n       resolution: Readonly<ComponentResolutionData>, pool: ConstantPool): CompileResult[] {\n     const meta: R3ComponentMetadata = {...analysis.meta, ...resolution};"
        },
        {
            "sha": "89b3b4e26ac89d95377d158642362d06ef163f9e",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/directive.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fdirective.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -151,7 +151,7 @@ export class DirectiveDecoratorHandler implements\n     return {diagnostics: diagnostics.length > 0 ? diagnostics : undefined};\n   }\n \n-  compile(\n+  compileFull(\n       node: ClassDeclaration, analysis: Readonly<DirectiveHandlerData>,\n       resolution: Readonly<unknown>, pool: ConstantPool): CompileResult[] {\n     const meta = analysis.meta;"
        },
        {
            "sha": "a9fbbe86cec9ff6ab775be2c057537738ca41553",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/injectable.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Finjectable.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -87,7 +87,7 @@ export class InjectableDecoratorHandler implements\n     this.injectableRegistry.registerInjectable(node);\n   }\n \n-  compile(node: ClassDeclaration, analysis: Readonly<InjectableHandlerData>): CompileResult[] {\n+  compileFull(node: ClassDeclaration, analysis: Readonly<InjectableHandlerData>): CompileResult[] {\n     const res = compileIvyInjectable(analysis.meta);\n     const statements = res.statements;\n     const results: CompileResult[] = [];"
        },
        {
            "sha": "3cc6ece9f5dabd0a60746a27bb9e624da7d83bfa",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/ng_module.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fng_module.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -371,7 +371,7 @@ export class NgModuleDecoratorHandler implements\n     }\n   }\n \n-  compile(\n+  compileFull(\n       node: ClassDeclaration, analysis: Readonly<NgModuleAnalysis>,\n       resolution: Readonly<NgModuleResolution>): CompileResult[] {\n     //  Merge the injector imports (which are 'exports' that were later found to be NgModules)"
        },
        {
            "sha": "2bbc29719a88a858fa50abd1cc19a3004e4f4dbc",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/src/pipe.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fpipe.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fpipe.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Fsrc%2Fpipe.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -133,7 +133,7 @@ export class PipeDecoratorHandler implements DecoratorHandler<Decorator, PipeHan\n     return {};\n   }\n \n-  compile(node: ClassDeclaration, analysis: Readonly<PipeHandlerData>): CompileResult[] {\n+  compileFull(node: ClassDeclaration, analysis: Readonly<PipeHandlerData>): CompileResult[] {\n     const meta = analysis.meta;\n     const res = compilePipeFromMetadata(meta);\n     const factoryRes = compileNgFactoryDefField({"
        },
        {
            "sha": "eab3b82aa6bda1d9574136b4ca2403eb09b3dce0",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/injectable_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Finjectable_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Finjectable_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Finjectable_spec.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -22,7 +22,7 @@ runInEachFileSystem(() => {\n            const {handler, TestClass, ɵprov, analysis} =\n                setupHandler(/* errorOnDuplicateProv */ true);\n            try {\n-             handler.compile(TestClass, analysis);\n+             handler.compileFull(TestClass, analysis);\n              return fail('Compilation should have failed');\n            } catch (err) {\n              if (!(err instanceof FatalDiagnosticError)) {\n@@ -39,7 +39,7 @@ runInEachFileSystem(() => {\n          () => {\n            const {handler, TestClass, ɵprov, analysis} =\n                setupHandler(/* errorOnDuplicateProv */ false);\n-           const res = handler.compile(TestClass, analysis);\n+           const res = handler.compileFull(TestClass, analysis);\n            expect(res).not.toContain(jasmine.objectContaining({name: 'ɵprov'}));\n          });\n     });"
        },
        {
            "sha": "2b168db5400f66891486d1642d91f98064e6a7fa",
            "filename": "packages/compiler-cli/src/ngtsc/core/api/src/options.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Foptions.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fapi%2Fsrc%2Foptions.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -48,6 +48,22 @@ export interface TestOnlyOptions {\n   tracePerformance?: string;\n }\n \n+/**\n+ * Options that specify compilation target.\n+ */\n+export interface TargetOptions {\n+  /**\n+   * Specifies the compilation mode to use. The following modes are available:\n+   * - 'full': generates fully AOT compiled code using Ivy instructions.\n+   * - 'partial': generates code in a stable, but intermediate form suitable to be published to NPM.\n+   *\n+   * To become public once the linker is ready.\n+   *\n+   * @internal\n+   */\n+  compilationMode?: 'full'|'partial';\n+}\n+\n /**\n  * A merged interface of all of the various Angular compiler options, as well as the standard\n  * `ts.CompilerOptions`.\n@@ -56,4 +72,5 @@ export interface TestOnlyOptions {\n  */\n export interface NgCompilerOptions extends ts.CompilerOptions, LegacyNgcOptions, BazelAndG3Options,\n                                            NgcCompatibilityOptions, StrictTemplateOptions,\n-                                           TestOnlyOptions, I18nOptions, MiscOptions {}\n+                                           TestOnlyOptions, I18nOptions, TargetOptions,\n+                                           MiscOptions {}"
        },
        {
            "sha": "f783c8ae601659c3855a81ff85b333df877cd520",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -27,7 +27,7 @@ import {entryPointKeyFor, NgModuleRouteAnalyzer} from '../../routing';\n import {ComponentScopeReader, LocalModuleScopeRegistry, MetadataDtsModuleScopeResolver} from '../../scope';\n import {generatedFactoryTransform} from '../../shims';\n import {ivySwitchTransform} from '../../switch';\n-import {aliasTransformFactory, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n+import {aliasTransformFactory, CompilationMode, declarationTransformFactory, DecoratorHandler, DtsTransformRegistry, ivyTransformFactory, TraitCompiler} from '../../transform';\n import {TemplateTypeCheckerImpl} from '../../typecheck';\n import {OptimizeFor, TemplateTypeChecker, TypeCheckingConfig, TypeCheckingProgramStrategy} from '../../typecheck/api';\n import {isTemplateDiagnostic} from '../../typecheck/diagnostics';\n@@ -761,9 +761,11 @@ export class NgCompiler {\n           this.closureCompilerEnabled, injectableRegistry, this.options.i18nInLocale),\n     ];\n \n+    const compilationMode =\n+        this.options.compilationMode === 'partial' ? CompilationMode.PARTIAL : CompilationMode.FULL;\n     const traitCompiler = new TraitCompiler(\n         handlers, reflector, this.perfRecorder, this.incrementalDriver,\n-        this.options.compileNonExportedClasses !== false, dtsTransforms);\n+        this.options.compileNonExportedClasses !== false, compilationMode, dtsTransforms);\n \n     const templateTypeChecker = new TemplateTypeCheckerImpl(\n         this.tsProgram, this.typeCheckingProgramStrategy, traitCompiler,"
        },
        {
            "sha": "fe097179664d650e40ec2cf174ef1c850b4f2481",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/api.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 1,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fapi.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -15,6 +15,21 @@ import {ClassDeclaration, Decorator} from '../../reflection';\n import {ImportManager} from '../../translator';\n import {TypeCheckContext} from '../../typecheck/api';\n \n+/**\n+ * Specifies the compilation mode that is used for the compilation.\n+ */\n+export enum CompilationMode {\n+  /**\n+   * Generates fully AOT compiled code using Ivy instructions.\n+   */\n+  FULL,\n+\n+  /**\n+   * Generates code using a stable, but intermediate format suitable to be published to NPM.\n+   */\n+  PARTIAL,\n+}\n+\n export enum HandlerPrecedence {\n   /**\n    * Handler with PRIMARY precedence cannot overlap - there can only be one on a given class.\n@@ -147,10 +162,25 @@ export interface DecoratorHandler<D, A, R> {\n   /**\n    * Generate a description of the field which should be added to the class, including any\n    * initialization code to be generated.\n+   *\n+   * If the compilation mode is configured as partial, and an implementation of `compilePartial` is\n+   * provided, then this method is not called.\n    */\n-  compile(\n+  compileFull(\n       node: ClassDeclaration, analysis: Readonly<A>, resolution: Readonly<R>,\n       constantPool: ConstantPool): CompileResult|CompileResult[];\n+\n+  /**\n+   * Generates code for the decorator using a stable, but intermediate format suitable to be\n+   * published to NPM. This code is meant to be processed by the linker to achieve the final AOT\n+   * compiled code.\n+   *\n+   * If present, this method is used if the compilation mode is configured as partial, otherwise\n+   * `compileFull` is.\n+   */\n+  compilePartial?\n+      (node: ClassDeclaration, analysis: Readonly<A>, resolution: Readonly<R>): CompileResult\n+      |CompileResult[];\n }\n \n /**"
        },
        {
            "sha": "ec479bc32d5cad7fc2ea8c77f73b128dd789eb6a",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/compilation.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fcompilation.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -17,7 +17,7 @@ import {ClassDeclaration, Decorator, ReflectionHost} from '../../reflection';\n import {ProgramTypeCheckAdapter, TypeCheckContext} from '../../typecheck/api';\n import {getSourceFile, isExported} from '../../util/src/typescript';\n \n-import {AnalysisOutput, CompileResult, DecoratorHandler, HandlerFlags, HandlerPrecedence, ResolveResult} from './api';\n+import {AnalysisOutput, CompilationMode, CompileResult, DecoratorHandler, HandlerFlags, HandlerPrecedence, ResolveResult} from './api';\n import {DtsTransformRegistry} from './declaration';\n import {PendingTrait, Trait, TraitState} from './trait';\n \n@@ -88,7 +88,8 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n       private handlers: DecoratorHandler<unknown, unknown, unknown>[],\n       private reflector: ReflectionHost, private perf: PerfRecorder,\n       private incrementalBuild: IncrementalBuild<ClassRecord, unknown>,\n-      private compileNonExportedClasses: boolean, private dtsTransforms: DtsTransformRegistry) {\n+      private compileNonExportedClasses: boolean, private compilationMode: CompilationMode,\n+      private dtsTransforms: DtsTransformRegistry) {\n     for (const handler of handlers) {\n       this.handlersByName.set(handler.name, handler);\n     }\n@@ -479,8 +480,17 @@ export class TraitCompiler implements ProgramTypeCheckAdapter {\n       }\n \n       const compileSpan = this.perf.start('compileClass', original);\n-      const compileMatchRes =\n-          trait.handler.compile(clazz, trait.analysis, trait.resolution, constantPool);\n+\n+      let compileRes: CompileResult|CompileResult[];\n+      if (this.compilationMode === CompilationMode.PARTIAL &&\n+          trait.handler.compilePartial !== undefined) {\n+        compileRes = trait.handler.compilePartial(clazz, trait.analysis, trait.resolution);\n+      } else {\n+        compileRes =\n+            trait.handler.compileFull(clazz, trait.analysis, trait.resolution, constantPool);\n+      }\n+\n+      const compileMatchRes = compileRes;\n       this.perf.stop(compileSpan);\n       if (Array.isArray(compileMatchRes)) {\n         for (const result of compileMatchRes) {"
        },
        {
            "sha": "4d655636b0250f8379759494f29589639419c772",
            "filename": "packages/compiler-cli/src/ngtsc/transform/test/compilation_spec.ts",
            "status": "modified",
            "additions": 129,
            "deletions": 5,
            "changes": 134,
            "blob_url": "https://github.com/angular/angular/blob/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Ftest%2Fcompilation_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9d04b951669510c7c52ce4b3c665a683562b5c5a/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Ftest%2Fcompilation_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Ftest%2Fcompilation_spec.ts?ref=9d04b951669510c7c52ce4b3c665a683562b5c5a",
            "patch": "@@ -5,13 +5,16 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n+import {ConstantPool} from '@angular/compiler';\n+import * as o from '@angular/compiler/src/output/output_ast';\n+\n import {absoluteFrom} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n import {NOOP_INCREMENTAL_BUILD} from '../../incremental';\n import {NOOP_PERF_RECORDER} from '../../perf';\n-import {TypeScriptReflectionHost} from '../../reflection';\n-import {makeProgram} from '../../testing';\n-import {DtsTransformRegistry, TraitCompiler} from '../../transform';\n+import {ClassDeclaration, Decorator, isNamedClassDeclaration, TypeScriptReflectionHost} from '../../reflection';\n+import {getDeclaration, makeProgram} from '../../testing';\n+import {CompilationMode, DetectResult, DtsTransformRegistry, TraitCompiler} from '../../transform';\n import {AnalysisOutput, CompileResult, DecoratorHandler, HandlerPrecedence} from '../src/api';\n \n runInEachFileSystem(() => {\n@@ -30,7 +33,7 @@ runInEachFileSystem(() => {\n         analyze(): AnalysisOutput<unknown> {\n           throw new Error('analyze should not have been called');\n         }\n-        compile(): CompileResult {\n+        compileFull(): CompileResult {\n           throw new Error('compile should not have been called');\n         }\n       }\n@@ -43,12 +46,133 @@ runInEachFileSystem(() => {\n       const reflectionHost = new TypeScriptReflectionHost(checker);\n       const compiler = new TraitCompiler(\n           [new FakeDecoratorHandler()], reflectionHost, NOOP_PERF_RECORDER, NOOP_INCREMENTAL_BUILD,\n-          true, new DtsTransformRegistry());\n+          true, CompilationMode.FULL, new DtsTransformRegistry());\n       const sourceFile = program.getSourceFile('lib.d.ts')!;\n       const analysis = compiler.analyzeSync(sourceFile);\n \n       expect(sourceFile.isDeclarationFile).toBe(true);\n       expect(analysis).toBeFalsy();\n     });\n+\n+    describe('compilation mode', () => {\n+      class PartialDecoratorHandler implements DecoratorHandler<{}, {}, unknown> {\n+        name = 'PartialDecoratorHandler';\n+        precedence = HandlerPrecedence.PRIMARY;\n+\n+        detect(node: ClassDeclaration, decorators: Decorator[]|null): DetectResult<{}>|undefined {\n+          if (node.name.text !== 'Partial') {\n+            return undefined;\n+          }\n+          return {trigger: node, decorator: null, metadata: {}};\n+        }\n+\n+        analyze(): AnalysisOutput<unknown> {\n+          return {analysis: {}};\n+        }\n+\n+        compileFull(): CompileResult {\n+          return {\n+            name: 'compileFull',\n+            initializer: o.literal(true),\n+            statements: [],\n+            type: o.BOOL_TYPE\n+          };\n+        }\n+\n+        compilePartial(): CompileResult {\n+          return {\n+            name: 'compilePartial',\n+            initializer: o.literal(true),\n+            statements: [],\n+            type: o.BOOL_TYPE\n+          };\n+        }\n+      }\n+\n+      class FullDecoratorHandler implements DecoratorHandler<{}, {}, unknown> {\n+        name = 'FullDecoratorHandler';\n+        precedence = HandlerPrecedence.PRIMARY;\n+\n+        detect(node: ClassDeclaration, decorators: Decorator[]|null): DetectResult<{}>|undefined {\n+          if (node.name.text !== 'Full') {\n+            return undefined;\n+          }\n+          return {trigger: node, decorator: null, metadata: {}};\n+        }\n+\n+        analyze(): AnalysisOutput<unknown> {\n+          return {analysis: {}};\n+        }\n+\n+        compileFull(): CompileResult {\n+          return {\n+            name: 'compileFull',\n+            initializer: o.literal(true),\n+            statements: [],\n+            type: o.BOOL_TYPE\n+          };\n+        }\n+      }\n+\n+      it('should run partial compilation when implemented if compilation mode is partial', () => {\n+        const {program} = makeProgram([{\n+          name: _('/test.ts'),\n+          contents: `\n+            export class Full {}\n+            export class Partial {}\n+          `,\n+        }]);\n+        const checker = program.getTypeChecker();\n+        const reflectionHost = new TypeScriptReflectionHost(checker);\n+        const compiler = new TraitCompiler(\n+            [new PartialDecoratorHandler(), new FullDecoratorHandler()], reflectionHost,\n+            NOOP_PERF_RECORDER, NOOP_INCREMENTAL_BUILD, true, CompilationMode.PARTIAL,\n+            new DtsTransformRegistry());\n+        const sourceFile = program.getSourceFile('test.ts')!;\n+        compiler.analyzeSync(sourceFile);\n+        compiler.resolve();\n+\n+        const partialDecl =\n+            getDeclaration(program, _('/test.ts'), 'Partial', isNamedClassDeclaration);\n+        const partialResult = compiler.compile(partialDecl, new ConstantPool())!;\n+        expect(partialResult.length).toBe(1);\n+        expect(partialResult[0].name).toBe('compilePartial');\n+\n+        const fullDecl = getDeclaration(program, _('/test.ts'), 'Full', isNamedClassDeclaration);\n+        const fullResult = compiler.compile(fullDecl, new ConstantPool())!;\n+        expect(fullResult.length).toBe(1);\n+        expect(fullResult[0].name).toBe('compileFull');\n+      });\n+\n+      it('should run full compilation if compilation mode is full', () => {\n+        const {program} = makeProgram([{\n+          name: _('/test.ts'),\n+          contents: `\n+            export class Full {}\n+            export class Partial {}\n+          `,\n+        }]);\n+        const checker = program.getTypeChecker();\n+        const reflectionHost = new TypeScriptReflectionHost(checker);\n+        const compiler = new TraitCompiler(\n+            [new PartialDecoratorHandler(), new FullDecoratorHandler()], reflectionHost,\n+            NOOP_PERF_RECORDER, NOOP_INCREMENTAL_BUILD, true, CompilationMode.FULL,\n+            new DtsTransformRegistry());\n+        const sourceFile = program.getSourceFile('test.ts')!;\n+        compiler.analyzeSync(sourceFile);\n+        compiler.resolve();\n+\n+        const partialDecl =\n+            getDeclaration(program, _('/test.ts'), 'Partial', isNamedClassDeclaration);\n+        const partialResult = compiler.compile(partialDecl, new ConstantPool())!;\n+        expect(partialResult.length).toBe(1);\n+        expect(partialResult[0].name).toBe('compileFull');\n+\n+        const fullDecl = getDeclaration(program, _('/test.ts'), 'Full', isNamedClassDeclaration);\n+        const fullResult = compiler.compile(fullDecl, new ConstantPool())!;\n+        expect(fullResult.length).toBe(1);\n+        expect(fullResult[0].name).toBe('compileFull');\n+      });\n+    });\n   });\n });"
        }
    ],
    "stats": {
        "total": 243,
        "additions": 213,
        "deletions": 30
    }
}