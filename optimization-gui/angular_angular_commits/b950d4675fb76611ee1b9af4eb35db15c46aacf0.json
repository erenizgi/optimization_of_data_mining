{
    "author": "peruukki",
    "message": "fix(core): do not trigger CSP alert/report in Firefox and Chrome (#36578) (#36578)\n\nIf [innerHTML] is used in a component and a Content-Security-Policy is set\nthat does not allow inline styles then Firefox and Chrome show the following\nmessage:\n\n> Content Security Policy: The page’s settings observed the loading of a\nresource at self (“default-src”). A CSP report is being sent.\n\nThis message is caused because Angular is creating an inline style tag to\ntest for a browser bug that we use to decide what sanitization strategy to\nuse, which causes CSP violation errors if inline CSS is prohibited.\n\nThis test is no longer necessary, since the `DOMParser` is now safe to use\nand the `style` based check is redundant.\n\nIn this fix, we default to using `DOMParser` if it is available and fall back\nto `createHTMLDocument()` if needed. This is the approach used by DOMPurify\ntoo.\n\nThe related unit tests in `html_sanitizer_spec.ts`, \"should not allow\nJavaScript execution when creating inert document\" and \"should not allow\nJavaScript hidden in badly formed HTML to get through sanitization (Firefox\nbug)\", are left untouched to assert that the behavior hasn't changed in\nthose scenarios.\n\nFixes #25214.\n\nPR Close #36578",
    "sha": "b950d4675fb76611ee1b9af4eb35db15c46aacf0",
    "files": [
        {
            "sha": "e859f8af5a69bfb3027958bcbdac44fab8b3c93b",
            "filename": "packages/core/src/sanitization/inert_body.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 59,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/b950d4675fb76611ee1b9af4eb35db15c46aacf0/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts",
            "raw_url": "https://github.com/angular/angular/raw/b950d4675fb76611ee1b9af4eb35db15c46aacf0/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fsanitization%2Finert_body.ts?ref=b950d4675fb76611ee1b9af4eb35db15c46aacf0",
            "patch": "@@ -9,49 +9,26 @@\n /**\n  * This helper class is used to get hold of an inert tree of DOM elements containing dirty HTML\n  * that needs sanitizing.\n- * Depending upon browser support we must use one of three strategies for doing this.\n- * Support: Safari 10.x -> XHR strategy\n- * Support: Firefox -> DomParser strategy\n- * Default: InertDocument strategy\n+ * Depending upon browser support we use one of two strategies for doing this.\n+ * Default: DomParser strategy\n+ * Fallback: InertDocument strategy\n  */\n export class InertBodyHelper {\n   private inertDocument: Document;\n \n   constructor(private defaultDoc: Document) {\n     this.inertDocument = this.defaultDoc.implementation.createHTMLDocument('sanitization-inert');\n-    let inertBodyElement = this.inertDocument.body;\n-\n-    if (inertBodyElement == null) {\n+    if (this.inertDocument.body == null) {\n       // usually there should be only one body element in the document, but IE doesn't have any, so\n       // we need to create one.\n       const inertHtml = this.inertDocument.createElement('html');\n       this.inertDocument.appendChild(inertHtml);\n-      inertBodyElement = this.inertDocument.createElement('body');\n+      const inertBodyElement = this.inertDocument.createElement('body');\n       inertHtml.appendChild(inertBodyElement);\n     }\n \n-    inertBodyElement.innerHTML = '<svg><g onload=\"this.parentNode.remove()\"></g></svg>';\n-    if (inertBodyElement.querySelector && !inertBodyElement.querySelector('svg')) {\n-      // We just hit the Safari 10.1 bug - which allows JS to run inside the SVG G element\n-      // so use the XHR strategy.\n-      this.getInertBodyElement = this.getInertBodyElement_XHR;\n-      return;\n-    }\n-\n-    inertBodyElement.innerHTML = '<svg><p><style><img src=\"</style><img src=x onerror=alert(1)//\">';\n-    if (inertBodyElement.querySelector && inertBodyElement.querySelector('svg img')) {\n-      // We just hit the Firefox bug - which prevents the inner img JS from being sanitized\n-      // so use the DOMParser strategy, if it is available.\n-      // If the DOMParser is not available then we are not in Firefox (Server/WebWorker?) so we\n-      // fall through to the default strategy below.\n-      if (isDOMParserAvailable()) {\n-        this.getInertBodyElement = this.getInertBodyElement_DOMParser;\n-        return;\n-      }\n-    }\n-\n-    // None of the bugs were hit so it is safe for us to use the default InertDocument strategy\n-    this.getInertBodyElement = this.getInertBodyElement_InertDocument;\n+    this.getInertBodyElement = isDOMParserAvailable() ? this.getInertBodyElement_DOMParser :\n+                                                        this.getInertBodyElement_InertDocument;\n   }\n \n   /**\n@@ -61,33 +38,7 @@ export class InertBodyHelper {\n   getInertBodyElement: (html: string) => HTMLElement | null;\n \n   /**\n-   * Use XHR to create and fill an inert body element (on Safari 10.1)\n-   * See\n-   * https://github.com/cure53/DOMPurify/blob/a992d3a75031cb8bb032e5ea8399ba972bdf9a65/src/purify.js#L439-L449\n-   */\n-  private getInertBodyElement_XHR(html: string) {\n-    // We add these extra elements to ensure that the rest of the content is parsed as expected\n-    // e.g. leading whitespace is maintained and tags like `<meta>` do not get hoisted to the\n-    // `<head>` tag.\n-    html = '<body><remove></remove>' + html + '</body>';\n-    try {\n-      html = encodeURI(html);\n-    } catch {\n-      return null;\n-    }\n-    const xhr = new XMLHttpRequest();\n-    xhr.responseType = 'document';\n-    xhr.open('GET', 'data:text/html;charset=utf-8,' + html, false);\n-    xhr.send(undefined);\n-    const body: HTMLBodyElement = xhr.response.body;\n-    body.removeChild(body.firstChild!);\n-    return body;\n-  }\n-\n-  /**\n-   * Use DOMParser to create and fill an inert body element (on Firefox)\n-   * See https://github.com/cure53/DOMPurify/releases/tag/0.6.7\n-   *\n+   * Use DOMParser to create and fill an inert body element in browsers that support it.\n    */\n   private getInertBodyElement_DOMParser(html: string) {\n     // We add these extra elements to ensure that the rest of the content is parsed as expected\n@@ -107,8 +58,7 @@ export class InertBodyHelper {\n   /**\n    * Use an HTML5 `template` element, if supported, or an inert body element created via\n    * `createHtmlDocument` to create and fill an inert DOM element.\n-   * This is the default sane strategy to use if the browser does not require one of the specialised\n-   * strategies above.\n+   * This is the fallback strategy if the browser does not support DOMParser.\n    */\n   private getInertBodyElement_InertDocument(html: string) {\n     // Prefer using <template> element if supported."
        }
    ],
    "stats": {
        "total": 68,
        "additions": 9,
        "deletions": 59
    }
}