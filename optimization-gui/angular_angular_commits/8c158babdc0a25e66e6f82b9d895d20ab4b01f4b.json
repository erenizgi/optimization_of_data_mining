{
    "author": "devversion",
    "message": "fix(dev-infra): formatting errors not reported with failure message (#42202)\n\nCurrently if formatting for a file fails due a formatter error,\nthe `ng-dev` tool reports that formatting failed, but no actual\nerror (or involved file) is printed out. This commit prints out\nthe failed files with their error message.\n\nPR Close #42202",
    "sha": "8c158babdc0a25e66e6f82b9d895d20ab4b01f4b",
    "files": [
        {
            "sha": "7f05348148c0b3ac47209dcb8903fa67867bb222",
            "filename": "dev-infra/format/format.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/8c158babdc0a25e66e6f82b9d895d20ab4b01f4b/dev-infra%2Fformat%2Fformat.ts",
            "raw_url": "https://github.com/angular/angular/raw/8c158babdc0a25e66e6f82b9d895d20ab4b01f4b/dev-infra%2Fformat%2Fformat.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fformat%2Fformat.ts?ref=8c158babdc0a25e66e6f82b9d895d20ab4b01f4b",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {error, info, promptConfirm} from '../utils/console';\n+import {error, info, promptConfirm, red} from '../utils/console';\n \n import {runFormatterInParallel} from './run-commands-parallel';\n \n@@ -24,7 +24,11 @@ export async function formatFiles(files: string[]) {\n \n   // The process should exit as a failure if any of the files failed to format.\n   if (failures.length !== 0) {\n-    error(`Formatting failed, see errors above for more information.`);\n+    error(red(`The following files could not be formatted:`));\n+    failures.forEach(({filePath, message}) => {\n+      info(`  • ${filePath}: ${message}`);\n+    });\n+    error(red(`Formatting failed, see errors above for more information.`));\n     process.exit(1);\n   }\n   info(`√  Formatting complete.`);\n@@ -46,8 +50,8 @@ export async function checkFiles(files: string[]) {\n   if (failures.length) {\n     // Provide output expressing which files are failing formatting.\n     info.group('\\nThe following files are out of format:');\n-    for (const file of failures) {\n-      info(`  - ${file}`);\n+    for (const {filePath} of failures) {\n+      info(`  • ${filePath}`);\n     }\n     info.groupEnd();\n     info();\n@@ -60,7 +64,7 @@ export async function checkFiles(files: string[]) {\n \n     if (runFormatter) {\n       // Format the failing files as requested.\n-      await formatFiles(failures);\n+      await formatFiles(failures.map(f => f.filePath));\n       process.exit(0);\n     } else {\n       // Inform user how to format files in the future."
        },
        {
            "sha": "5671d9486ad7e2b56fd8178c44939548bdb3fca2",
            "filename": "dev-infra/format/run-commands-parallel.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/8c158babdc0a25e66e6f82b9d895d20ab4b01f4b/dev-infra%2Fformat%2Frun-commands-parallel.ts",
            "raw_url": "https://github.com/angular/angular/raw/8c158babdc0a25e66e6f82b9d895d20ab4b01f4b/dev-infra%2Fformat%2Frun-commands-parallel.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fformat%2Frun-commands-parallel.ts?ref=8c158babdc0a25e66e6f82b9d895d20ab4b01f4b",
            "patch": "@@ -17,6 +17,14 @@ import {Formatter, FormatterAction, getActiveFormatters} from './formatters/inde\n \n const AVAILABLE_THREADS = Math.max(cpus().length - 1, 1);\n \n+/** Interface describing a failure occurred during formatting of a file. */\n+export interface FormatFailure {\n+  /** Path to the file that failed. */\n+  filePath: string;\n+  /** Error message reported by the formatter. */\n+  message: string;\n+}\n+\n /**\n  * Run the provided commands in parallel for each provided file.\n  *\n@@ -30,9 +38,9 @@ const AVAILABLE_THREADS = Math.max(cpus().length - 1, 1);\n  * The promise resolves with a list of failures, or `false` if no formatters have matched.\n  */\n export function runFormatterInParallel(allFiles: string[], action: FormatterAction) {\n-  return new Promise<false|string[]>((resolve) => {\n+  return new Promise<false|FormatFailure[]>((resolve) => {\n     const formatters = getActiveFormatters();\n-    const failures: string[] = [];\n+    const failures: FormatFailure[] = [];\n     const pendingCommands: {formatter: Formatter, file: string}[] = [];\n \n     for (const formatter of formatters) {\n@@ -85,7 +93,7 @@ export function runFormatterInParallel(allFiles: string[], action: FormatterActi\n             // Run the provided callback function.\n             const failed = formatter.callbackFor(action)(file, code, stdout, stderr);\n             if (failed) {\n-              failures.push(file);\n+              failures.push({filePath: file, message: stderr});\n             }\n             // Note in the progress bar another file being completed.\n             progressBar.increment(1);"
        },
        {
            "sha": "962be84f099ee709a34f3509304db4abd8dc3512",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/angular/angular/blob/8c158babdc0a25e66e6f82b9d895d20ab4b01f4b/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/8c158babdc0a25e66e6f82b9d895d20ab4b01f4b/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=8c158babdc0a25e66e6f82b9d895d20ab4b01f4b",
            "patch": "@@ -2591,7 +2591,7 @@ function runFormatterInParallel(allFiles, action) {\n                 // Run the provided callback function.\n                 const failed = formatter.callbackFor(action)(file, code, stdout, stderr);\n                 if (failed) {\n-                    failures.push(file);\n+                    failures.push({ filePath: file, message: stderr });\n                 }\n                 // Note in the progress bar another file being completed.\n                 progressBar.increment(1);\n@@ -2639,7 +2639,11 @@ function formatFiles(files) {\n         }\n         // The process should exit as a failure if any of the files failed to format.\n         if (failures.length !== 0) {\n-            error(`Formatting failed, see errors above for more information.`);\n+            error(red(`The following files could not be formatted:`));\n+            failures.forEach(({ filePath, message }) => {\n+                info(`  • ${filePath}: ${message}`);\n+            });\n+            error(red(`Formatting failed, see errors above for more information.`));\n             process.exit(1);\n         }\n         info(`√  Formatting complete.`);\n@@ -2660,8 +2664,8 @@ function checkFiles(files) {\n         if (failures.length) {\n             // Provide output expressing which files are failing formatting.\n             info.group('\\nThe following files are out of format:');\n-            for (const file of failures) {\n-                info(`  - ${file}`);\n+            for (const { filePath } of failures) {\n+                info(`  • ${filePath}`);\n             }\n             info.groupEnd();\n             info();\n@@ -2672,7 +2676,7 @@ function checkFiles(files) {\n             }\n             if (runFormatter) {\n                 // Format the failing files as requested.\n-                yield formatFiles(failures);\n+                yield formatFiles(failures.map(f => f.filePath));\n                 process.exit(0);\n             }\n             else {"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 29,
        "deletions": 13
    }
}