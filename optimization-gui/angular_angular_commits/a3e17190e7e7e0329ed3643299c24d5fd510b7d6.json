{
    "author": "crisbeto",
    "message": "fix(core): allow EmbeddedViewRef context to be updated (#40360)\n\nCurrently `EmbeddedViewRef.context` is read-only which means that the only way to update\nit is to mutate the object which can lead to some undesirable outcomes if the template\nand the context are provided by an external consumer (see #24515).\n\nThese changes make the property writeable since there doesn't appear to be a specific\nreason why it was readonly to begin with.\n\nPR Close #40360",
    "sha": "a3e17190e7e7e0329ed3643299c24d5fd510b7d6",
    "files": [
        {
            "sha": "a9f381b6390ddeda841aef633cc83db840d58298",
            "filename": "goldens/public-api/core/core.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts?ref=a3e17190e7e7e0329ed3643299c24d5fd510b7d6",
            "patch": "@@ -301,7 +301,7 @@ export declare class ElementRef<T = any> {\n }\n \n export declare abstract class EmbeddedViewRef<C> extends ViewRef {\n-    abstract get context(): C;\n+    abstract context: C;\n     abstract get rootNodes(): any[];\n }\n "
        },
        {
            "sha": "315f86e6d77129c40fc15d90736258a63a576be6",
            "filename": "packages/core/src/linker/view_ref.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Fsrc%2Flinker%2Fview_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Fsrc%2Flinker%2Fview_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Flinker%2Fview_ref.ts?ref=a3e17190e7e7e0329ed3643299c24d5fd510b7d6",
            "patch": "@@ -93,7 +93,7 @@ export abstract class EmbeddedViewRef<C> extends ViewRef {\n   /**\n    * The context for this view, inherited from the anchor element.\n    */\n-  abstract get context(): C;\n+  abstract context: C;\n \n   /**\n    * The root nodes for this embedded view."
        },
        {
            "sha": "8f7fdc72fa08b852249a6ea8e47e0c58a37ba52e",
            "filename": "packages/core/src/render3/view_ref.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fview_ref.ts?ref=a3e17190e7e7e0329ed3643299c24d5fd510b7d6",
            "patch": "@@ -61,6 +61,10 @@ export class ViewRef<T> implements viewEngine_EmbeddedViewRef<T>, viewEngine_Int\n     return this._lView[CONTEXT] as T;\n   }\n \n+  set context(value: T) {\n+    this._lView[CONTEXT] = value;\n+  }\n+\n   get destroyed(): boolean {\n     return (this._lView[FLAGS] & LViewFlags.Destroyed) === LViewFlags.Destroyed;\n   }"
        },
        {
            "sha": "b724fcc8003e64d15600d81cd8afe76de71dd7f9",
            "filename": "packages/core/src/view/refs.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Fsrc%2Fview%2Frefs.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Fsrc%2Fview%2Frefs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fview%2Frefs.ts?ref=a3e17190e7e7e0329ed3643299c24d5fd510b7d6",
            "patch": "@@ -264,6 +264,10 @@ export class ViewRef_ implements EmbeddedViewRef<any>, InternalViewRef {\n     return this._view.context;\n   }\n \n+  set context(value: any) {\n+    this._view.context = value;\n+  }\n+\n   get destroyed(): boolean {\n     return (this._view.state & ViewState.Destroyed) !== 0;\n   }"
        },
        {
            "sha": "84ed32d582858cb8c7689dfe7c46bbaa037a31d5",
            "filename": "packages/core/test/acceptance/template_ref_spec.ts",
            "status": "modified",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/angular/angular/blob/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Ftest%2Facceptance%2Ftemplate_ref_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/a3e17190e7e7e0329ed3643299c24d5fd510b7d6/packages%2Fcore%2Ftest%2Facceptance%2Ftemplate_ref_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Ftemplate_ref_spec.ts?ref=a3e17190e7e7e0329ed3643299c24d5fd510b7d6",
            "patch": "@@ -273,4 +273,87 @@ describe('TemplateRef', () => {\n          });\n     });\n   });\n+\n+  describe('context', () => {\n+    @Component({\n+      template: `\n+      <ng-template #templateRef let-name=\"name\">{{name}}</ng-template>\n+      <ng-container #containerRef></ng-container>\n+    `\n+    })\n+    class App {\n+      @ViewChild('templateRef') templateRef!: TemplateRef<any>;\n+      @ViewChild('containerRef', {read: ViewContainerRef}) containerRef!: ViewContainerRef;\n+    }\n+\n+    it('should update if the context of a view ref is mutated', () => {\n+      TestBed.configureTestingModule({declarations: [App]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+      const context = {name: 'Frodo'};\n+      const viewRef = fixture.componentInstance.templateRef.createEmbeddedView(context);\n+      fixture.componentInstance.containerRef.insert(viewRef);\n+      fixture.detectChanges();\n+\n+      expect(fixture.nativeElement.textContent).toBe('Frodo');\n+\n+      context.name = 'Bilbo';\n+      fixture.detectChanges();\n+\n+      expect(fixture.nativeElement.textContent).toBe('Bilbo');\n+    });\n+\n+    it('should update if the context of a view ref is replaced', () => {\n+      TestBed.configureTestingModule({declarations: [App]});\n+      const fixture = TestBed.createComponent(App);\n+      fixture.detectChanges();\n+      const viewRef = fixture.componentInstance.templateRef.createEmbeddedView({name: 'Frodo'});\n+      fixture.componentInstance.containerRef.insert(viewRef);\n+      fixture.detectChanges();\n+\n+      expect(fixture.nativeElement.textContent).toBe('Frodo');\n+\n+      viewRef.context = {name: 'Bilbo'};\n+      fixture.detectChanges();\n+\n+      expect(fixture.nativeElement.textContent).toBe('Bilbo');\n+    });\n+\n+    it('should use the latest context information inside template listeners', () => {\n+      const events: string[] = [];\n+\n+      @Component({\n+        template: `\n+          <ng-template #templateRef let-name=\"name\">\n+            <button (click)=\"log(name)\"></button>\n+          </ng-template>\n+          <ng-container #containerRef></ng-container>\n+        `\n+      })\n+      class ListenerTest {\n+        @ViewChild('templateRef') templateRef!: TemplateRef<any>;\n+        @ViewChild('containerRef', {read: ViewContainerRef}) containerRef!: ViewContainerRef;\n+\n+        log(name: string) {\n+          events.push(name);\n+        }\n+      }\n+\n+      TestBed.configureTestingModule({declarations: [ListenerTest]});\n+      const fixture = TestBed.createComponent(ListenerTest);\n+      fixture.detectChanges();\n+      const viewRef = fixture.componentInstance.templateRef.createEmbeddedView({name: 'Frodo'});\n+      fixture.componentInstance.containerRef.insert(viewRef);\n+      fixture.detectChanges();\n+\n+      const button = fixture.nativeElement.querySelector('button');\n+      button.click();\n+      expect(events).toEqual(['Frodo']);\n+\n+      viewRef.context = {name: 'Bilbo'};\n+      fixture.detectChanges();\n+      button.click();\n+      expect(events).toEqual(['Frodo', 'Bilbo']);\n+    });\n+  });\n });"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 93,
        "deletions": 2
    }
}