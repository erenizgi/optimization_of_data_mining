{
    "author": "alxhub",
    "message": "test(language-service): introduce new, more configurable testing env (#40679)\n\nThe Ivy Language Service codebase testing suite contains a few testing\nutilities which allow for assertions of Language Service operations against\nan in-memory project. However, this existing utility lacks the flexibility\nto test more complex scenarios, such as those involving multiple TS projects\nwith dependencies between them.\n\nThis commit introduces a new 'testing' package for the Ivy LS which attempts\nto more faithfully represent the possible states of an IDE, and allows for\ntesting of more advanced scenarios. The new utility borrows from the prior\nversion and is geared towards more ergonomic testing. Only basic\nfunctionality is present in this initial implementation, but this will grow\nover time.\n\nPR Close #40679",
    "sha": "c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
    "files": [
        {
            "sha": "73b88e66385eea8bf01e71aee169c522f162fab1",
            "filename": "packages/language-service/ivy/test/env.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -18,6 +18,8 @@ import {LanguageService} from '../language_service';\n \n import {MockServerHost} from './mock_host';\n \n+// TODO(alxhub): replace this environment with //packages/language-service/ivy/testing\n+\n function writeTsconfig(\n     fs: FileSystem, entryFiles: AbsoluteFsPath[], options: TestableOptions): void {\n   fs.writeFile("
        },
        {
            "sha": "d01f85dd8ede30c874a4e3d9bc2a07c611ec7e71",
            "filename": "packages/language-service/ivy/testing/BUILD.bazel",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2FBUILD.bazel?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,19 @@\n+load(\"//tools:defaults.bzl\", \"ts_library\")\n+\n+package(default_visibility = [\"//packages/language-service:__subpackages__\"])\n+\n+ts_library(\n+    name = \"testing\",\n+    testonly = True,\n+    srcs = glob([\"**/*.ts\"]),\n+    deps = [\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/language-service/ivy\",\n+        \"@npm//typescript\",\n+    ],\n+)"
        },
        {
            "sha": "b3e62e601959011e319a781392884ed7c3431187",
            "filename": "packages/language-service/ivy/testing/index.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Findex.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+export * from './src/buffer';\n+export * from './src/env';\n+export * from './src/project';\n+export * from './src/util';"
        },
        {
            "sha": "2e3cc7302b541bda1932db39b3151ceaab4977c9",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "added",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,64 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+import {Project} from './project';\n+import {extractCursorInfo} from './util';\n+\n+/**\n+ * A file that is currently open in the `ts.Project`, with a cursor position.\n+ */\n+export class OpenBuffer {\n+  private _cursor: number = 0;\n+\n+  constructor(\n+      private project: Project, private projectFileName: string,\n+      private scriptInfo: ts.server.ScriptInfo) {}\n+\n+  get cursor(): number {\n+    return this._cursor;\n+  }\n+\n+  get contents(): string {\n+    const snapshot = this.scriptInfo.getSnapshot();\n+    return snapshot.getText(0, snapshot.getLength());\n+  }\n+\n+  set contents(newContents: string) {\n+    const snapshot = this.scriptInfo.getSnapshot();\n+    this.scriptInfo.editContent(0, snapshot.getLength(), newContents);\n+    // If the cursor goes beyond the new length of the buffer, clamp it to the end of the buffer.\n+    if (this._cursor > newContents.length) {\n+      this._cursor = newContents.length;\n+    }\n+  }\n+\n+  /**\n+   * Find a snippet of text within the given buffer and position the cursor within it.\n+   *\n+   * @param snippetWithCursor a snippet of text which contains the '¦' symbol, representing where\n+   *     the cursor should be placed within the snippet when located in the larger buffer.\n+   */\n+  moveCursorToText(snippetWithCursor: string): void {\n+    const {text: snippet, cursor} = extractCursorInfo(snippetWithCursor);\n+    const snippetIndex = this.contents.indexOf(snippet);\n+    if (snippetIndex === -1) {\n+      throw new Error(`Snippet ${snippet} not found in ${this.projectFileName}`);\n+    }\n+    this._cursor = snippetIndex + cursor;\n+  }\n+\n+  /**\n+   * Execute the `getDefinitionAndBoundSpan` operation in the Language Service at the cursor\n+   * location in this buffer.\n+   */\n+  getDefinitionAndBoundSpan(): ts.DefinitionInfoAndBoundSpan|undefined {\n+    return this.project.ngLS.getDefinitionAndBoundSpan(this.scriptInfo.fileName, this._cursor);\n+  }\n+}"
        },
        {
            "sha": "1a69f3c302dc1c213932a2013dd8ea35f2a4df8f",
            "filename": "packages/language-service/ivy/testing/src/env.ts",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fenv.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,87 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {MockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {loadStandardTestFiles} from '@angular/compiler-cli/src/ngtsc/testing';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+import {MockServerHost} from './host';\n+import {Project, ProjectFiles} from './project';\n+\n+/**\n+ * Testing environment for the Angular Language Service, which creates an in-memory tsserver\n+ * instance that backs a Language Service to emulate an IDE that uses the LS.\n+ */\n+export class LanguageServiceTestEnv {\n+  static setup(): LanguageServiceTestEnv {\n+    const fs = getFileSystem();\n+    if (!(fs instanceof MockFileSystem)) {\n+      throw new Error(`LanguageServiceTestEnvironment only works with a mock filesystem`);\n+    }\n+    fs.init(loadStandardTestFiles({\n+      fakeCore: true,\n+      fakeCommon: true,\n+    }));\n+\n+    const host = new MockServerHost(fs);\n+\n+    const projectService = new ts.server.ProjectService({\n+      logger,\n+      cancellationToken: ts.server.nullCancellationToken,\n+      host,\n+      typingsInstaller: ts.server.nullTypingsInstaller,\n+\n+      useInferredProjectPerProjectRoot: true,\n+      useSingleInferredProject: true,\n+    });\n+\n+    return new LanguageServiceTestEnv(host, projectService);\n+  }\n+\n+  private projects = new Map<string, Project>();\n+\n+  constructor(private host: MockServerHost, private projectService: ts.server.ProjectService) {}\n+\n+  addProject(name: string, files: ProjectFiles): Project {\n+    if (this.projects.has(name)) {\n+      throw new Error(`Project ${name} is already defined`);\n+    }\n+\n+    const project = Project.initialize(name, this.projectService, files);\n+    this.projects.set(name, project);\n+    return project;\n+  }\n+\n+  getTextFromTsSpan(fileName: string, span: ts.TextSpan): string|null {\n+    const scriptInfo = this.projectService.getScriptInfo(fileName);\n+    if (scriptInfo === undefined) {\n+      return null;\n+    }\n+    return scriptInfo.getSnapshot().getText(span.start, span.start + span.length);\n+  }\n+}\n+\n+const logger: ts.server.Logger = {\n+  close(): void{},\n+  hasLevel(level: ts.server.LogLevel): boolean {\n+    return false;\n+  },\n+  loggingEnabled(): boolean {\n+    return false;\n+  },\n+  perftrc(s: string): void{},\n+  info(s: string): void{},\n+  startGroup(): void{},\n+  endGroup(): void{},\n+  msg(s: string, type?: ts.server.Msg): void{},\n+  getLogFileName(): string |\n+      undefined {\n+        return;\n+      },\n+};"
        },
        {
            "sha": "51fdea238c2b78fd76f1296bf2f294833bde0673",
            "filename": "packages/language-service/ivy/testing/src/host.ts",
            "status": "added",
            "additions": 118,
            "deletions": 0,
            "changes": 118,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fhost.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fhost.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fhost.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,118 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {MockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+const NOOP_FILE_WATCHER: ts.FileWatcher = {\n+  close() {}\n+};\n+\n+export class MockServerHost implements ts.server.ServerHost {\n+  constructor(private fs: MockFileSystem) {}\n+\n+  get newLine(): string {\n+    return '\\n';\n+  }\n+\n+  get useCaseSensitiveFileNames(): boolean {\n+    return this.fs.isCaseSensitive();\n+  }\n+\n+  readFile(path: string, encoding?: string): string|undefined {\n+    return this.fs.readFile(absoluteFrom(path));\n+  }\n+\n+  resolvePath(path: string): string {\n+    return this.fs.resolve(path);\n+  }\n+\n+  fileExists(path: string): boolean {\n+    const absPath = absoluteFrom(path);\n+    return this.fs.exists(absPath) && this.fs.lstat(absPath).isFile();\n+  }\n+\n+  directoryExists(path: string): boolean {\n+    const absPath = absoluteFrom(path);\n+    return this.fs.exists(absPath) && this.fs.lstat(absPath).isDirectory();\n+  }\n+\n+  createDirectory(path: string): void {\n+    this.fs.ensureDir(absoluteFrom(path));\n+  }\n+\n+  getExecutingFilePath(): string {\n+    // This is load-bearing, as TypeScript uses the result of this call to locate the directory in\n+    // which it expects to find .d.ts files for the \"standard libraries\" - DOM, ES2015, etc.\n+    return '/node_modules/typescript/lib/tsserver.js';\n+  }\n+\n+  getCurrentDirectory(): string {\n+    return '/';\n+  }\n+\n+  createHash(data: string): string {\n+    return ts.sys.createHash!(data);\n+  }\n+\n+  get args(): string[] {\n+    throw new Error('Property not implemented.');\n+  }\n+\n+  watchFile(\n+      path: string, callback: ts.FileWatcherCallback, pollingInterval?: number,\n+      options?: ts.WatchOptions): ts.FileWatcher {\n+    return NOOP_FILE_WATCHER;\n+  }\n+\n+  watchDirectory(\n+      path: string, callback: ts.DirectoryWatcherCallback, recursive?: boolean,\n+      options?: ts.WatchOptions): ts.FileWatcher {\n+    return NOOP_FILE_WATCHER;\n+  }\n+\n+  setTimeout(callback: (...args: any[]) => void, ms: number, ...args: any[]) {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  clearTimeout(timeoutId: any): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  setImmediate(callback: (...args: any[]) => void, ...args: any[]) {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  clearImmediate(timeoutId: any): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  write(s: string): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  writeFile(path: string, data: string, writeByteOrderMark?: boolean): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  getDirectories(path: string): string[] {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  readDirectory(\n+      path: string, extensions?: readonly string[], exclude?: readonly string[],\n+      include?: readonly string[], depth?: number): string[] {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  exit(exitCode?: number): void {\n+    throw new Error('Method not implemented.');\n+  }\n+}"
        },
        {
            "sha": "0a40ed6a47b50f24ea2c632a36d362d16a6238fe",
            "filename": "packages/language-service/ivy/testing/src/project.ts",
            "status": "added",
            "additions": 122,
            "deletions": 0,
            "changes": 122,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fproject.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,122 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {StrictTemplateOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+import {LanguageService} from '../../language_service';\n+import {OpenBuffer} from './buffer';\n+\n+export type ProjectFiles = {\n+  [fileName: string]: string;\n+};\n+\n+function writeTsconfig(\n+    fs: FileSystem, tsConfigPath: AbsoluteFsPath, entryFiles: AbsoluteFsPath[],\n+    options: StrictTemplateOptions): void {\n+  fs.writeFile(\n+      tsConfigPath,\n+      JSON.stringify(\n+          {\n+            compilerOptions: {\n+              strict: true,\n+              experimentalDecorators: true,\n+              moduleResolution: 'node',\n+              target: 'es2015',\n+              rootDir: '.',\n+              lib: [\n+                'dom',\n+                'es2015',\n+              ],\n+            },\n+            files: entryFiles,\n+            angularCompilerOptions: {\n+              strictTemplates: true,\n+              ...options,\n+            }\n+          },\n+          null, 2));\n+}\n+\n+\n+export class Project {\n+  private tsProject: ts.server.Project;\n+  private tsLS: ts.LanguageService;\n+  readonly ngLS: LanguageService;\n+  private buffers = new Map<string, OpenBuffer>();\n+\n+  static initialize(name: string, projectService: ts.server.ProjectService, files: ProjectFiles):\n+      Project {\n+    const fs = getFileSystem();\n+    const tsConfigPath = absoluteFrom(`/${name}/tsconfig.json`);\n+\n+    const entryFiles: AbsoluteFsPath[] = [];\n+    for (const projectFilePath of Object.keys(files)) {\n+      const contents = files[projectFilePath];\n+      const filePath = absoluteFrom(`/${name}/${projectFilePath}`);\n+      const dirPath = fs.dirname(filePath);\n+      fs.ensureDir(dirPath);\n+      fs.writeFile(filePath, contents);\n+      if (projectFilePath.endsWith('.ts')) {\n+        entryFiles.push(filePath);\n+      }\n+    }\n+\n+    writeTsconfig(fs, tsConfigPath, entryFiles, {});\n+\n+    // Ensure the project is live in the ProjectService.\n+    projectService.openClientFile(entryFiles[0]);\n+    projectService.closeClientFile(entryFiles[0]);\n+\n+    return new Project(name, projectService, tsConfigPath);\n+  }\n+\n+  constructor(\n+      readonly name: string, private projectService: ts.server.ProjectService,\n+      private tsConfigPath: AbsoluteFsPath) {\n+    // LS for project\n+    const tsProject = projectService.findProject(tsConfigPath);\n+    if (tsProject === undefined) {\n+      throw new Error(`Failed to create project for ${tsConfigPath}`);\n+    }\n+\n+    this.tsProject = tsProject;\n+\n+    // The following operation forces a ts.Program to be created.\n+    this.tsLS = tsProject.getLanguageService();\n+    this.ngLS = new LanguageService(tsProject, this.tsLS);\n+  }\n+\n+  openFile(projectFileName: string): OpenBuffer {\n+    if (!this.buffers.has(projectFileName)) {\n+      const fileName = absoluteFrom(`/${this.name}/${projectFileName}`);\n+      this.projectService.openClientFile(fileName);\n+\n+      const scriptInfo = this.tsProject.getScriptInfo(fileName);\n+      if (scriptInfo === undefined) {\n+        throw new Error(\n+            `Unable to open ScriptInfo for ${projectFileName} in project ${this.tsConfigPath}`);\n+      }\n+      this.buffers.set(projectFileName, new OpenBuffer(this, projectFileName, scriptInfo));\n+    }\n+\n+    return this.buffers.get(projectFileName)!;\n+  }\n+\n+  getDiagnosticsForFile(projectFileName: string): ts.Diagnostic[] {\n+    const fileName = absoluteFrom(`/${this.name}/${projectFileName}`);\n+    const diagnostics: ts.Diagnostic[] = [];\n+    if (fileName.endsWith('.ts')) {\n+      diagnostics.push(...this.tsLS.getSyntacticDiagnostics(fileName));\n+      diagnostics.push(...this.tsLS.getSemanticDiagnostics(fileName));\n+    }\n+\n+    diagnostics.push(...this.ngLS.getSemanticDiagnostics(fileName));\n+    return diagnostics;\n+  }\n+}"
        },
        {
            "sha": "e8990cfe025ed23b5e40b3624684c82ec68b5315",
            "filename": "packages/language-service/ivy/testing/src/util.ts",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/c9879deded34a0b7e90a4e6a1dff33aadc11b35a/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Futil.ts?ref=c9879deded34a0b7e90a4e6a1dff33aadc11b35a",
            "patch": "@@ -0,0 +1,51 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/**\n+ * Given a text snippet which contains exactly one cursor symbol ('¦'), extract both the offset of\n+ * that cursor within the text as well as the text snippet without the cursor.\n+ */\n+export function extractCursorInfo(textWithCursor: string): {cursor: number, text: string} {\n+  const cursor = textWithCursor.indexOf('¦');\n+  if (cursor === -1 || textWithCursor.indexOf('¦', cursor + 1) !== -1) {\n+    throw new Error(`Expected to find exactly one cursor symbol '¦'`);\n+  }\n+\n+  return {\n+    cursor,\n+    text: textWithCursor.substr(0, cursor) + textWithCursor.substr(cursor + 1),\n+  };\n+}\n+\n+function last<T>(array: T[]): T {\n+  return array[array.length - 1];\n+}\n+\n+/**\n+ * Expect that a list of objects with a `fileName` property matches a set of expected files by only\n+ * comparing the file names and not any path prefixes.\n+ *\n+ * This assertion is independent of the order of either list.\n+ */\n+export function assertFileNames(refs: Array<{fileName: string}>, expectedFileNames: string[]) {\n+  const actualPaths = refs.map(r => r.fileName);\n+  const actualFileNames = actualPaths.map(p => last(p.split('/')));\n+  expect(new Set(actualFileNames)).toEqual(new Set(expectedFileNames));\n+}\n+\n+/**\n+ * Returns whether the given `ts.Diagnostic` is of a type only produced by the Angular compiler (as\n+ * opposed to being an upstream TypeScript diagnostic).\n+ *\n+ * Template type-checking diagnostics are not \"ng-specific\" in this sense, since they are plain\n+ * TypeScript diagnostics that are produced from expressions in the template by way of a TCB.\n+ */\n+export function isNgSpecificDiagnostic(diag: ts.Diagnostic): boolean {\n+  // Angular-specific diagnostics use a negative code space.\n+  return diag.code < 0;\n+}"
        }
    ],
    "stats": {
        "total": 475,
        "additions": 475,
        "deletions": 0
    }
}