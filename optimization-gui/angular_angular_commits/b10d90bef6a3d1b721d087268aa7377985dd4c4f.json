{
    "author": "atscott",
    "message": "feat(language-service): Add method for retrieving the component template at the cursor location (#43208)\n\nThis method is the @angular/language-service side of the implementation\nfor https://github.com/angular/vscode-ng-language-service/issues/1485\n\nGiven a location in a file, if the location is inside a component,\n`getTemplateLocationForComponent` will return the `DocumentSpan` of the\ninline `template` or the `DocumentSpan` for the file that the\n`templateUrl` points to.\n\nPR Close #43208",
    "sha": "b10d90bef6a3d1b721d087268aa7377985dd4c4f",
    "files": [
        {
            "sha": "54e7a15beecf6f59a33f5c33c22437fadb593954",
            "filename": "packages/language-service/api.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fapi.ts",
            "raw_url": "https://github.com/angular/angular/raw/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fapi.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fapi.ts?ref=b10d90bef6a3d1b721d087268aa7377985dd4c4f",
            "patch": "@@ -52,6 +52,7 @@ export type GetTcbResponse = {\n };\n \n export type GetComponentLocationsForTemplateResponse = ts.DocumentSpan[];\n+export type GetTemplateLocationForComponentResponse = ts.DocumentSpan|undefined;\n \n /**\n  * `NgLanguageService` describes an instance of an Angular language service,\n@@ -60,6 +61,8 @@ export type GetComponentLocationsForTemplateResponse = ts.DocumentSpan[];\n export interface NgLanguageService extends ts.LanguageService {\n   getTcb(fileName: string, position: number): GetTcbResponse|undefined;\n   getComponentLocationsForTemplate(fileName: string): GetComponentLocationsForTemplateResponse;\n+  getTemplateLocationForComponent(fileName: string, position: number):\n+      GetTemplateLocationForComponentResponse;\n }\n \n export function isNgLanguageService(ls: ts.LanguageService|"
        },
        {
            "sha": "3515dc8c6dcbd7e220db91a06a98dc90d4baa210",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 2,
            "changes": 36,
            "blob_url": "https://github.com/angular/angular/blob/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=b10d90bef6a3d1b721d087268aa7377985dd4c4f",
            "patch": "@@ -19,7 +19,7 @@ import {OptimizeFor} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import {findFirstMatchingNode} from '@angular/compiler-cli/src/ngtsc/typecheck/src/comments';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {GetComponentLocationsForTemplateResponse, GetTcbResponse} from '../api';\n+import {GetComponentLocationsForTemplateResponse, GetTcbResponse, GetTemplateLocationForComponentResponse} from '../api';\n \n import {LanguageServiceAdapter, LSParseConfigHost} from './adapters';\n import {CompilerFactory} from './compiler_factory';\n@@ -30,7 +30,7 @@ import {ReferencesBuilder, RenameBuilder} from './references_and_rename';\n import {createLocationKey} from './references_and_rename_utils';\n import {getSignatureHelp} from './signature_help';\n import {getTargetAtPosition, TargetContext, TargetNodeKind} from './template_target';\n-import {findTightestNode, getClassDeclFromDecoratorProp, getPropertyAssignmentFromValue} from './ts_utils';\n+import {findTightestNode, getClassDeclFromDecoratorProp, getParentClassDeclaration, getPropertyAssignmentFromValue} from './ts_utils';\n import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n \n interface LanguageServiceConfig {\n@@ -312,6 +312,38 @@ export class LanguageService {\n         });\n   }\n \n+  getTemplateLocationForComponent(fileName: string, position: number):\n+      GetTemplateLocationForComponentResponse {\n+    return this.withCompilerAndPerfTracing<GetTemplateLocationForComponentResponse>(\n+        PerfPhase.LsComponentLocations, (compiler) => {\n+          const nearestNode =\n+              findTightestNodeAtPosition(this.programDriver.getProgram(), fileName, position);\n+          if (nearestNode === undefined) {\n+            return undefined;\n+          }\n+          const classDeclaration = getParentClassDeclaration(nearestNode);\n+          if (classDeclaration === undefined) {\n+            return undefined;\n+          }\n+          const resources = compiler.getComponentResources(classDeclaration);\n+          if (resources === null) {\n+            return undefined;\n+          }\n+          const {template} = resources;\n+          let templateFileName: string;\n+          let span: ts.TextSpan;\n+          if (template.path !== null) {\n+            span = ts.createTextSpanFromBounds(0, 0);\n+            templateFileName = template.path;\n+          } else {\n+            span = ts.createTextSpanFromBounds(\n+                template.expression.getStart(), template.expression.getEnd());\n+            templateFileName = template.expression.getSourceFile().fileName;\n+          }\n+          return {fileName: templateFileName, textSpan: span, contextSpan: span};\n+        });\n+  }\n+\n   getTcb(fileName: string, position: number): GetTcbResponse|undefined {\n     return this.withCompilerAndPerfTracing<GetTcbResponse|undefined>(PerfPhase.LsTcb, compiler => {\n       const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);"
        },
        {
            "sha": "1332077d533634e9ce72b0ba46443fa236c6f9a1",
            "filename": "packages/language-service/ivy/test/get_template_location_for_component_spec.ts",
            "status": "added",
            "additions": 154,
            "deletions": 0,
            "changes": 154,
            "blob_url": "https://github.com/angular/angular/blob/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Ftest%2Fget_template_location_for_component_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Ftest%2Fget_template_location_for_component_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fget_template_location_for_component_spec.ts?ref=b10d90bef6a3d1b721d087268aa7377985dd4c4f",
            "patch": "@@ -0,0 +1,154 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {initMockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import {assertFileNames, createModuleAndProjectWithDeclarations, humanizeDocumentSpanLike, LanguageServiceTestEnv} from '../testing';\n+\n+describe('get template location for component', () => {\n+  beforeEach(() => {\n+    initMockFileSystem('Native');\n+  });\n+\n+  it('finds location of inline template', () => {\n+    const files = {\n+      'app.ts': `\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        template: '<div>{{ myProp }}</div>',\n+      })\n+      export class AppCmp {\n+        myProp!: string;\n+      }`\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n+\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('my¦Prop!: string');\n+    const result = appFile.getTemplateLocationForComponent()!;\n+    assertFileNames([result], ['app.ts']);\n+    expect(humanizeDocumentSpanLike(result, env).textSpan).toEqual(`'<div>{{ myProp }}</div>'`);\n+  });\n+\n+  it('finds location of external template', () => {\n+    const files = {\n+      'app.ts': `\n+            import {Component} from '@angular/core';\n+\n+            @Component({\n+              templateUrl: './app.html',\n+            })\n+            export class AppCmp {\n+              myProp!: string;\n+            }`,\n+      'app.html': '<div>{{ myProp }}</div>'\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n+\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('my¦Prop!: string');\n+    const result = appFile.getTemplateLocationForComponent()!;\n+    assertFileNames([result], ['app.html']);\n+  });\n+\n+  it('finds correct location when there are multiple components in one file', () => {\n+    const files = {\n+      'app.ts': `\n+      import {Component} from '@angular/core';\n+\n+      @Component({\n+        templateUrl: './template1.html',\n+      })\n+      export class Template1 {\n+      }\n+      @Component({\n+        templateUrl: './template2.html',\n+      })\n+      export class Template2 {\n+      }\n+      `,\n+      'template1.html': '',\n+      'template2.html': ''\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n+\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('export class Temp¦late1');\n+    const result1 = appFile.getTemplateLocationForComponent()!;\n+    assertFileNames([result1], ['template1.html']);\n+\n+    appFile.moveCursorToText('export class Temp¦late2');\n+    const result2 = appFile.getTemplateLocationForComponent()!;\n+    assertFileNames([result2], ['template2.html']);\n+  });\n+\n+  it('returns nothing when cursor is not in a component', () => {\n+    const files = {\n+      'app.ts': `\n+      import {Directive} from '@angular/core';\n+\n+      @Directive({selector: 'my-dir'})\n+      export class MyDir {\n+      }`,\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n+\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('MyDir¦');\n+    expect(appFile.getTemplateLocationForComponent()).toBeUndefined();\n+  });\n+\n+  it('returns nothing when cursor is not in a component', () => {\n+    const files = {\n+      'app.ts': `\n+      import {Component} from '@angular/core';\n+\n+      const x = 1;\n+\n+      @Component({template: 'abc'})\n+      export class MyDir {\n+      }`,\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n+\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('const x¦');\n+    expect(appFile.getTemplateLocationForComponent()).toBeUndefined();\n+  });\n+\n+  it('returns template when cursor is on `class` keyword', () => {\n+    const files = {\n+      'app.ts': `\n+      import {Component} from '@angular/core';\n+\n+      @Component({template: 'abc'})\n+      export class MyDir {\n+      }`,\n+    };\n+    const env = LanguageServiceTestEnv.setup();\n+    const project = createModuleAndProjectWithDeclarations(env, 'test', files);\n+    project.expectNoSourceDiagnostics();\n+\n+    const appFile = project.openFile('app.ts');\n+    appFile.moveCursorToText('cla¦ss');\n+    const result = appFile.getTemplateLocationForComponent()!;\n+    assertFileNames([result], ['app.ts']);\n+    expect(humanizeDocumentSpanLike(result, env).textSpan).toEqual(`'abc'`);\n+  });\n+});"
        },
        {
            "sha": "717729ee5e7363c5d737212b5047c2e42279add6",
            "filename": "packages/language-service/ivy/testing/src/buffer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "raw_url": "https://github.com/angular/angular/raw/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftesting%2Fsrc%2Fbuffer.ts?ref=b10d90bef6a3d1b721d087268aa7377985dd4c4f",
            "patch": "@@ -80,6 +80,10 @@ export class OpenBuffer {\n     return this.ngLS.getTcb(this.scriptInfo.fileName, this._cursor);\n   }\n \n+  getTemplateLocationForComponent() {\n+    return this.ngLS.getTemplateLocationForComponent(this.scriptInfo.fileName, this._cursor);\n+  }\n+\n   getQuickInfoAtPosition() {\n     return this.ngLS.getQuickInfoAtPosition(this.scriptInfo.fileName, this._cursor);\n   }"
        },
        {
            "sha": "a2772ef9914f4cb1b307b3c13df94c68464d6414",
            "filename": "packages/language-service/ivy/ts_plugin.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fts_plugin.ts?ref=b10d90bef6a3d1b721d087268aa7377985dd4c4f",
            "patch": "@@ -8,7 +8,7 @@\n \n import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {GetComponentLocationsForTemplateResponse, GetTcbResponse, NgLanguageService} from '../api';\n+import {GetComponentLocationsForTemplateResponse, GetTcbResponse, GetTemplateLocationForComponentResponse, NgLanguageService} from '../api';\n \n import {LanguageService} from './language_service';\n \n@@ -155,6 +155,15 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     return ngLS.getComponentLocationsForTemplate(fileName);\n   }\n \n+  /**\n+   * Given a location inside a component, finds the location of the inline template or the file for\n+   * the `templateUrl`.\n+   */\n+  function getTemplateLocationForComponent(\n+      fileName: string, position: number): GetTemplateLocationForComponentResponse {\n+    return ngLS.getTemplateLocationForComponent(fileName, position);\n+  }\n+\n   return {\n     ...tsLS,\n     getSemanticDiagnostics,\n@@ -171,6 +180,7 @@ export function create(info: ts.server.PluginCreateInfo): NgLanguageService {\n     getCompilerOptionsDiagnostics,\n     getComponentLocationsForTemplate,\n     getSignatureHelpItems,\n+    getTemplateLocationForComponent,\n   };\n }\n "
        },
        {
            "sha": "8c8123602944bd7dac691668776e01fbb855d00b",
            "filename": "packages/language-service/src/ts_plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "raw_url": "https://github.com/angular/angular/raw/b10d90bef6a3d1b721d087268aa7377985dd4c4f/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fsrc%2Fts_plugin.ts?ref=b10d90bef6a3d1b721d087268aa7377985dd4c4f",
            "patch": "@@ -124,6 +124,11 @@ export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n     return undefined;\n   }\n \n+  function getTemplateLocationForComponent(fileName: string, position: number) {\n+    // Not implemented in VE Language Service\n+    return undefined;\n+  }\n+\n   function getComponentLocationsForTemplate(fileName: string) {\n     // Not implemented in VE Language Service\n     return [];\n@@ -140,5 +145,6 @@ export function create(info: tss.server.PluginCreateInfo): NgLanguageService {\n     getDefinitionAndBoundSpan,\n     getTcb,\n     getComponentLocationsForTemplate,\n+    getTemplateLocationForComponent,\n   };\n }"
        }
    ],
    "stats": {
        "total": 215,
        "additions": 212,
        "deletions": 3
    }
}