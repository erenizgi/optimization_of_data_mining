{
    "author": "JoostK",
    "message": "perf(compiler-cli): use bound symbol in import graph in favor of module resolution (#40948)\n\nThe import graph scans source files for its import and export statements\nto extract the source files that it imports/exports. Such statements\ncontain a module specifier string and this module specifier used to be\nresolved to the actual source file using an explicit module resolution\nstep. This is especially expensive in incremental rebuilds, as the\nmodule resolution cache has not been primed during program creation\n(assuming that the incremental program was able to reuse the module\nresolution results from a prior compilation). This meant that all module\nresolution requests would have to hit the filesystem, which is\nrelatively slow.\n\nThis commit is able to replace the module resolution with TypeScript's\nbound symbol of the module specifier. This symbol corresponds with the\n`ts.SourceFile` that is being imported/exported, which is exactly what\nthe import graph was interested in. As a result, no filesystem accesses\nare done anymore.\n\nPR Close #40948",
    "sha": "9cec94a008dfeaa5a81b21071be55af4588b4fe2",
    "files": [
        {
            "sha": "b2fb42c1135b3d530326361935bda4858d075d77",
            "filename": "packages/compiler-cli/ngcc/src/analysis/decoration_analyzer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -89,7 +89,7 @@ export class DecorationAnalyzer {\n   fullRegistry = new CompoundMetadataRegistry([this.metaRegistry, this.scopeRegistry]);\n   evaluator =\n       new PartialEvaluator(this.reflectionHost, this.typeChecker, /* dependencyTracker */ null);\n-  importGraph = new ImportGraph(this.moduleResolver);\n+  importGraph = new ImportGraph(this.typeChecker);\n   cycleAnalyzer = new CycleAnalyzer(this.importGraph);\n   injectableRegistry = new InjectableClassRegistry(this.reflectionHost);\n   typeCheckScopeRegistry = new TypeCheckScopeRegistry(this.scopeRegistry, this.fullMetaReader);"
        },
        {
            "sha": "da3f93532d651ab31f18b02dba8dcec33ec6969a",
            "filename": "packages/compiler-cli/src/ngtsc/annotations/test/component_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fannotations%2Ftest%2Fcomponent_spec.ts?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -41,7 +41,7 @@ function setup(program: ts.Program, options: ts.CompilerOptions, host: ts.Compil\n   const evaluator = new PartialEvaluator(reflectionHost, checker, /* dependencyTracker */ null);\n   const moduleResolver =\n       new ModuleResolver(program, options, host, /* moduleResolutionCache */ null);\n-  const importGraph = new ImportGraph(moduleResolver);\n+  const importGraph = new ImportGraph(checker);\n   const cycleAnalyzer = new CycleAnalyzer(importGraph);\n   const metaRegistry = new LocalMetadataRegistry();\n   const dtsReader = new DtsMetadataReader(checker, reflectionHost);"
        },
        {
            "sha": "7a5b8ed90d27e056c0b633fe494568a44553e330",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/compiler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fcompiler.ts?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -322,7 +322,7 @@ export class NgCompiler {\n     this.moduleResolver =\n         new ModuleResolver(tsProgram, this.options, this.adapter, moduleResolutionCache);\n     this.resourceManager = new AdapterResourceLoader(adapter, this.options);\n-    this.cycleAnalyzer = new CycleAnalyzer(new ImportGraph(this.moduleResolver));\n+    this.cycleAnalyzer = new CycleAnalyzer(new ImportGraph(tsProgram.getTypeChecker()));\n     this.incrementalStrategy.setIncrementalDriver(this.incrementalDriver, tsProgram);\n \n     this.ignoreForDiagnostics ="
        },
        {
            "sha": "78a4cbf391a560b9863d8e10d8eec6bb80ca4e8f",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2FBUILD.bazel?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -9,7 +9,6 @@ ts_library(\n     ]),\n     module_name = \"@angular/compiler-cli/src/ngtsc/cycles\",\n     deps = [\n-        \"//packages/compiler-cli/src/ngtsc/imports\",\n         \"@npm//typescript\",\n     ],\n )"
        },
        {
            "sha": "1696cab7a2b694222dda6a52e8074e899fb82860",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/src/imports.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 16,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Fsrc%2Fimports.ts?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -8,8 +8,6 @@\n \n import * as ts from 'typescript';\n \n-import {ModuleResolver} from '../../imports';\n-\n /**\n  * A cached graph of imports in the `ts.Program`.\n  *\n@@ -19,7 +17,7 @@ import {ModuleResolver} from '../../imports';\n export class ImportGraph {\n   private map = new Map<ts.SourceFile, Set<ts.SourceFile>>();\n \n-  constructor(private resolver: ModuleResolver) {}\n+  constructor(private checker: ts.TypeChecker) {}\n \n   /**\n    * List the direct (not transitive) imports of a given `ts.SourceFile`.\n@@ -102,25 +100,30 @@ export class ImportGraph {\n \n   private scanImports(sf: ts.SourceFile): Set<ts.SourceFile> {\n     const imports = new Set<ts.SourceFile>();\n-    // Look through the source file for import statements.\n-    sf.statements.forEach(stmt => {\n-      if ((ts.isImportDeclaration(stmt) || ts.isExportDeclaration(stmt)) &&\n-          stmt.moduleSpecifier !== undefined && ts.isStringLiteral(stmt.moduleSpecifier)) {\n-        // Resolve the module to a file, and check whether that file is in the ts.Program.\n-        const moduleName = stmt.moduleSpecifier.text;\n-        const moduleFile = this.resolver.resolveModule(moduleName, sf.fileName);\n-        if (moduleFile !== null && isLocalFile(moduleFile)) {\n-          // Record this local import.\n-          imports.add(moduleFile);\n-        }\n+    // Look through the source file for import and export statements.\n+    for (const stmt of sf.statements) {\n+      if ((!ts.isImportDeclaration(stmt) && !ts.isExportDeclaration(stmt)) ||\n+          stmt.moduleSpecifier === undefined) {\n+        continue;\n       }\n-    });\n+\n+      const symbol = this.checker.getSymbolAtLocation(stmt.moduleSpecifier);\n+      if (symbol === undefined || symbol.valueDeclaration === undefined) {\n+        // No symbol could be found to skip over this import/export.\n+        continue;\n+      }\n+      const moduleFile = symbol.valueDeclaration;\n+      if (ts.isSourceFile(moduleFile) && isLocalFile(moduleFile)) {\n+        // Record this local import.\n+        imports.add(moduleFile);\n+      }\n+    }\n     return imports;\n   }\n }\n \n function isLocalFile(sf: ts.SourceFile): boolean {\n-  return !sf.fileName.endsWith('.d.ts');\n+  return !sf.isDeclarationFile;\n }\n \n /**"
        },
        {
            "sha": "8ba04d7446451d1eae8cc4be987a6f0d4cd9410c",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/BUILD.bazel",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2FBUILD.bazel?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -13,7 +13,6 @@ ts_library(\n         \"//packages/compiler-cli/src/ngtsc/cycles\",\n         \"//packages/compiler-cli/src/ngtsc/file_system\",\n         \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n-        \"//packages/compiler-cli/src/ngtsc/imports\",\n         \"//packages/compiler-cli/src/ngtsc/testing\",\n         \"@npm//typescript\",\n     ],"
        },
        {
            "sha": "388a1d9b6b6acdb6ee99fb1f0a708168e2923187",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/analyzer_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fanalyzer_spec.ts?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -8,7 +8,6 @@\n import * as ts from 'typescript';\n import {absoluteFrom, getFileSystem, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n-import {ModuleResolver} from '../../imports';\n import {Cycle, CycleAnalyzer} from '../src/analyzer';\n import {ImportGraph} from '../src/imports';\n import {importPath, makeProgramFromGraph} from './util';\n@@ -73,12 +72,10 @@ runInEachFileSystem(() => {\n   });\n \n   function makeAnalyzer(graph: string): {program: ts.Program, analyzer: CycleAnalyzer} {\n-    const {program, options, host} = makeProgramFromGraph(getFileSystem(), graph);\n-    const moduleResolver =\n-        new ModuleResolver(program, options, host, /* moduleResolutionCache */ null);\n+    const {program} = makeProgramFromGraph(getFileSystem(), graph);\n     return {\n       program,\n-      analyzer: new CycleAnalyzer(new ImportGraph(moduleResolver)),\n+      analyzer: new CycleAnalyzer(new ImportGraph(program.getTypeChecker())),\n     };\n   }\n });"
        },
        {
            "sha": "e4713f44f63d66ee1da3032ae8e552e952d0acc3",
            "filename": "packages/compiler-cli/src/ngtsc/cycles/test/imports_spec.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fimports_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/9cec94a008dfeaa5a81b21071be55af4588b4fe2/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fimports_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcycles%2Ftest%2Fimports_spec.ts?ref=9cec94a008dfeaa5a81b21071be55af4588b4fe2",
            "patch": "@@ -8,7 +8,6 @@\n import * as ts from 'typescript';\n import {absoluteFrom, getFileSystem, getSourceFileOrError} from '../../file_system';\n import {runInEachFileSystem} from '../../file_system/testing';\n-import {ModuleResolver} from '../../imports';\n import {ImportGraph} from '../src/imports';\n import {importPath, makeProgramFromGraph} from './util';\n \n@@ -84,12 +83,10 @@ runInEachFileSystem(() => {\n   });\n \n   function makeImportGraph(graph: string): {program: ts.Program, graph: ImportGraph} {\n-    const {program, options, host} = makeProgramFromGraph(getFileSystem(), graph);\n-    const moduleResolver =\n-        new ModuleResolver(program, options, host, /* moduleResolutionCache */ null);\n+    const {program} = makeProgramFromGraph(getFileSystem(), graph);\n     return {\n       program,\n-      graph: new ImportGraph(moduleResolver),\n+      graph: new ImportGraph(program.getTypeChecker()),\n     };\n   }\n "
        }
    ],
    "stats": {
        "total": 57,
        "additions": 26,
        "deletions": 31
    }
}