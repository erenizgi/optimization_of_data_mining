{
    "author": "kyliau",
    "message": "feat(language-service): [Ivy] getSemanticDiagnostics for external templates (#39065)\n\nThis PR enables `getSemanticDiagnostics()` to be called on external templates.\n\nSeveral changes are needed to land this feature:\n\n1. The adapter needs to implement two additional methods:\n   a. `readResource()`\n       Load the template from snapshot instead of reading from disk\n   b. `getModifiedResourceFiles()`\n       Inform the compiler that external templates have changed so that the\n       loader could invalidate its internal cache.\n2. Create `ScriptInfo` for external templates in MockHost.\n   Prior to this, MockHost only track changes in TypeScript files. Now it\n   needs to create `ScriptInfo` for external templates as well.\n\nFor (1), in order to make sure we don't reload the template if it hasn't\nchanged, we need to keep track of its version. Since the complexity has\nincreased, the adapter is refactored into its own class.\n\nPR Close #39065",
    "sha": "63624a2d4630f5c724841aad649a7d4db13526e2",
    "files": [
        {
            "sha": "54efb64ece453a1a064c19b658274c5f1eb8a150",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 42,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=63624a2d4630f5c724841aad649a7d4db13526e2",
            "patch": "@@ -8,60 +8,74 @@\n \n import {CompilerOptions, createNgCompilerOptions} from '@angular/compiler-cli';\n import {NgCompiler} from '@angular/compiler-cli/src/ngtsc/core';\n-import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n-import {absoluteFrom, absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {absoluteFromSourceFile, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n import {PatchedProgramIncrementalBuildStrategy} from '@angular/compiler-cli/src/ngtsc/incremental';\n-import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n import {TypeCheckShimGenerator} from '@angular/compiler-cli/src/ngtsc/typecheck';\n import {OptimizeFor, TypeCheckingProgramStrategy} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {DefinitionBuilder} from './definitions';\n+import {isExternalTemplate, isTypeScriptFile, LanguageServiceAdapter} from './language_service_adapter';\n import {QuickInfoBuilder} from './quick_info';\n \n export class LanguageService {\n   private options: CompilerOptions;\n   private lastKnownProgram: ts.Program|null = null;\n   private readonly strategy: TypeCheckingProgramStrategy;\n-  private readonly adapter: NgCompilerAdapter;\n+  private readonly adapter: LanguageServiceAdapter;\n \n   constructor(project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n     this.options = parseNgCompilerOptions(project);\n     this.strategy = createTypeCheckingProgramStrategy(project);\n-    this.adapter = createNgCompilerAdapter(project);\n+    this.adapter = new LanguageServiceAdapter(project);\n     this.watchConfigFile(project);\n   }\n \n   getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n     const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program);\n-    if (fileName.endsWith('.ts')) {\n+    const compiler = this.createCompiler(program, fileName);\n+    const ttc = compiler.getTemplateTypeChecker();\n+    const diagnostics: ts.Diagnostic[] = [];\n+    if (isTypeScriptFile(fileName)) {\n       const sourceFile = program.getSourceFile(fileName);\n-      if (!sourceFile) {\n-        return [];\n+      if (sourceFile) {\n+        diagnostics.push(...ttc.getDiagnosticsForFile(sourceFile, OptimizeFor.SingleFile));\n+      }\n+    } else {\n+      const components = compiler.getComponentsWithTemplateFile(fileName);\n+      for (const component of components) {\n+        if (ts.isClassDeclaration(component)) {\n+          diagnostics.push(...ttc.getDiagnosticsForComponent(component));\n+        }\n       }\n-      const ttc = compiler.getTemplateTypeChecker();\n-      const diagnostics = ttc.getDiagnosticsForFile(sourceFile, OptimizeFor.SingleFile);\n-      this.lastKnownProgram = compiler.getNextProgram();\n-      return diagnostics;\n     }\n-    throw new Error('Ivy LS currently does not support external template');\n+    this.lastKnownProgram = compiler.getNextProgram();\n+    return diagnostics;\n   }\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n     const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program);\n+    const compiler = this.createCompiler(program, fileName);\n     return new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n   }\n \n   getQuickInfoAtPosition(fileName: string, position: number): ts.QuickInfo|undefined {\n     const program = this.strategy.getProgram();\n-    const compiler = this.createCompiler(program);\n+    const compiler = this.createCompiler(program, fileName);\n     return new QuickInfoBuilder(this.tsLS, compiler).get(fileName, position);\n   }\n \n-  private createCompiler(program: ts.Program): NgCompiler {\n+  /**\n+   * Create a new instance of Ivy compiler.\n+   * If the specified `fileName` refers to an external template, check if it has\n+   * changed since the last time it was read. If it has changed, signal the\n+   * compiler to reload the file via the adapter.\n+   */\n+  private createCompiler(program: ts.Program, fileName: string): NgCompiler {\n+    if (isExternalTemplate(fileName)) {\n+      this.adapter.registerTemplateUpdate(fileName);\n+    }\n     return new NgCompiler(\n         this.adapter,\n         this.options,\n@@ -107,31 +121,6 @@ export function parseNgCompilerOptions(project: ts.server.Project): CompilerOpti\n   return createNgCompilerOptions(basePath, config, project.getCompilationSettings());\n }\n \n-function createNgCompilerAdapter(project: ts.server.Project): NgCompilerAdapter {\n-  return {\n-    entryPoint: null,  // entry point is only needed if code is emitted\n-    constructionDiagnostics: [],\n-    ignoreForEmit: new Set(),\n-    factoryTracker: null,      // no .ngfactory shims\n-    unifiedModulesHost: null,  // only used in Bazel\n-    rootDirs: project.getCompilationSettings().rootDirs?.map(absoluteFrom) || [],\n-    isShim,\n-    fileExists(fileName: string): boolean {\n-      return project.fileExists(fileName);\n-    },\n-    readFile(fileName: string): string |\n-        undefined {\n-          return project.readFile(fileName);\n-        },\n-    getCurrentDirectory(): string {\n-      return project.getCurrentDirectory();\n-    },\n-    getCanonicalFileName(fileName: string): string {\n-      return project.projectService.toCanonicalFileName(fileName);\n-    },\n-  };\n-}\n-\n function createTypeCheckingProgramStrategy(project: ts.server.Project):\n     TypeCheckingProgramStrategy {\n   return {"
        },
        {
            "sha": "2b3eb77bd44e91134826dc5448706aad60b1ad3c",
            "filename": "packages/language-service/ivy/language_service_adapter.ts",
            "status": "added",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/angular/angular/blob/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "raw_url": "https://github.com/angular/angular/raw/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service_adapter.ts?ref=63624a2d4630f5c724841aad649a7d4db13526e2",
            "patch": "@@ -0,0 +1,111 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {NgCompilerAdapter} from '@angular/compiler-cli/src/ngtsc/core/api';\n+import {absoluteFrom, AbsoluteFsPath} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {isShim} from '@angular/compiler-cli/src/ngtsc/shims';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+export class LanguageServiceAdapter implements NgCompilerAdapter {\n+  readonly entryPoint = null;\n+  readonly constructionDiagnostics: ts.Diagnostic[] = [];\n+  readonly ignoreForEmit: Set<ts.SourceFile> = new Set();\n+  readonly factoryTracker = null;      // no .ngfactory shims\n+  readonly unifiedModulesHost = null;  // only used in Bazel\n+  readonly rootDirs: AbsoluteFsPath[];\n+  private readonly templateVersion = new Map<string, string>();\n+  private readonly modifiedTemplates = new Set<string>();\n+\n+  constructor(private readonly project: ts.server.Project) {\n+    this.rootDirs = project.getCompilationSettings().rootDirs?.map(absoluteFrom) || [];\n+  }\n+\n+  isShim(sf: ts.SourceFile): boolean {\n+    return isShim(sf);\n+  }\n+\n+  fileExists(fileName: string): boolean {\n+    return this.project.fileExists(fileName);\n+  }\n+\n+  readFile(fileName: string): string|undefined {\n+    return this.project.readFile(fileName);\n+  }\n+\n+  getCurrentDirectory(): string {\n+    return this.project.getCurrentDirectory();\n+  }\n+\n+  getCanonicalFileName(fileName: string): string {\n+    return this.project.projectService.toCanonicalFileName(fileName);\n+  }\n+\n+  /**\n+   * readResource() is an Angular-specific method for reading files that are not\n+   * managed by the TS compiler host, namely templates and stylesheets.\n+   * It is a method on ExtendedTsCompilerHost, see\n+   * packages/compiler-cli/src/ngtsc/core/api/src/interfaces.ts\n+   */\n+  readResource(fileName: string): string {\n+    if (isTypeScriptFile(fileName)) {\n+      throw new Error(`readResource() should not be called on TS file: ${fileName}`);\n+    }\n+    // Calling getScriptSnapshot() will actually create a ScriptInfo if it does\n+    // not exist! The same applies for getScriptVersion().\n+    // getScriptInfo() will not create one if it does not exist.\n+    // In this case, we *want* a script info to be created so that we could\n+    // keep track of its version.\n+    const snapshot = this.project.getScriptSnapshot(fileName);\n+    if (!snapshot) {\n+      // This would fail if the file does not exist, or readFile() fails for\n+      // whatever reasons.\n+      throw new Error(`Failed to get script snapshot while trying to read ${fileName}`);\n+    }\n+    const version = this.project.getScriptVersion(fileName);\n+    this.templateVersion.set(fileName, version);\n+    this.modifiedTemplates.delete(fileName);\n+    return snapshot.getText(0, snapshot.getLength());\n+  }\n+\n+  /**\n+   * getModifiedResourceFiles() is an Angular-specific method for notifying\n+   * the Angular compiler templates that have changed since it last read them.\n+   * It is a method on ExtendedTsCompilerHost, see\n+   * packages/compiler-cli/src/ngtsc/core/api/src/interfaces.ts\n+   */\n+  getModifiedResourceFiles(): Set<string> {\n+    return this.modifiedTemplates;\n+  }\n+\n+  /**\n+   * Check whether the specified `fileName` is newer than the last time it was\n+   * read. If it is newer, register it and return true, otherwise do nothing and\n+   * return false.\n+   * @param fileName path to external template\n+   */\n+  registerTemplateUpdate(fileName: string): boolean {\n+    if (!isExternalTemplate(fileName)) {\n+      return false;\n+    }\n+    const lastVersion = this.templateVersion.get(fileName);\n+    const latestVersion = this.project.getScriptVersion(fileName);\n+    if (lastVersion !== latestVersion) {\n+      this.modifiedTemplates.add(fileName);\n+      return true;\n+    }\n+    return false;\n+  }\n+}\n+\n+export function isTypeScriptFile(fileName: string): boolean {\n+  return fileName.endsWith('.ts');\n+}\n+\n+export function isExternalTemplate(fileName: string): boolean {\n+  return !isTypeScriptFile(fileName);\n+}"
        },
        {
            "sha": "20d37c835135143eed1849145c08b4bf5572ac91",
            "filename": "packages/language-service/ivy/test/diagnostic_spec.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 2,
            "changes": 35,
            "blob_url": "https://github.com/angular/angular/blob/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fdiagnostic_spec.ts?ref=63624a2d4630f5c724841aad649a7d4db13526e2",
            "patch": "@@ -10,9 +10,9 @@ import * as ts from 'typescript/lib/tsserverlibrary';\n \n import {LanguageService} from '../language_service';\n \n-import {APP_COMPONENT, setup} from './mock_host';\n+import {APP_COMPONENT, setup, TEST_TEMPLATE} from './mock_host';\n \n-describe('diagnostic', () => {\n+describe('getSemanticDiagnostics', () => {\n   const {project, service, tsLS} = setup();\n   const ngLS = new LanguageService(project, tsLS);\n \n@@ -35,4 +35,35 @@ describe('diagnostic', () => {\n     expect(text.substring(start!, start! + length!)).toBe('nope');\n     expect(messageText).toBe(`Property 'nope' does not exist on type 'AppComponent'.`);\n   });\n+\n+  it('should process external template', () => {\n+    const diags = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(diags).toEqual([]);\n+  });\n+\n+  it('should report member does not exist in external template', () => {\n+    const {text} = service.overwrite(TEST_TEMPLATE, `{{ nope }}`);\n+    const diags = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(diags.length).toBe(1);\n+    const {category, file, start, length, messageText} = diags[0];\n+    expect(category).toBe(ts.DiagnosticCategory.Error);\n+    expect(file?.fileName).toBe(TEST_TEMPLATE);\n+    expect(text.substring(start!, start! + length!)).toBe('nope');\n+    expect(messageText).toBe(`Property 'nope' does not exist on type 'TemplateReference'.`);\n+  });\n+\n+  it('should retrieve external template from latest snapshot', () => {\n+    // This test is to make sure we are reading from snapshot instead of disk\n+    // if content from snapshot is newer. It also makes sure the internal cache\n+    // of the resource loader is invalidated on content change.\n+    service.overwrite(TEST_TEMPLATE, `{{ foo }}`);\n+    const d1 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d1.length).toBe(1);\n+    expect(d1[0].messageText).toBe(`Property 'foo' does not exist on type 'TemplateReference'.`);\n+\n+    service.overwrite(TEST_TEMPLATE, `{{ bar }}`);\n+    const d2 = ngLS.getSemanticDiagnostics(TEST_TEMPLATE);\n+    expect(d2.length).toBe(1);\n+    expect(d2[0].messageText).toBe(`Property 'bar' does not exist on type 'TemplateReference'.`);\n+  });\n });"
        },
        {
            "sha": "81769c1202494675a1148e92f56b79bf7841188b",
            "filename": "packages/language-service/ivy/test/language_service_adapter_spec.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/angular/angular/blob/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_adapter_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_adapter_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Flanguage_service_adapter_spec.ts?ref=63624a2d4630f5c724841aad649a7d4db13526e2",
            "patch": "@@ -0,0 +1,49 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {LanguageServiceAdapter} from '../language_service_adapter';\n+import {setup, TEST_TEMPLATE} from './mock_host';\n+\n+const {project, service} = setup();\n+\n+describe('Language service adapter', () => {\n+  it('should register update if it has not seen the template before', () => {\n+    const adapter = new LanguageServiceAdapter(project);\n+    // Note that readResource() has never been called, so the adapter has no\n+    // knowledge of the template at all.\n+    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n+    expect(isRegistered).toBeTrue();\n+    expect(adapter.getModifiedResourceFiles().size).toBe(1);\n+  });\n+\n+  it('should not register update if template has not changed', () => {\n+    const adapter = new LanguageServiceAdapter(project);\n+    adapter.readResource(TEST_TEMPLATE);\n+    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n+    expect(isRegistered).toBeFalse();\n+    expect(adapter.getModifiedResourceFiles().size).toBe(0);\n+  });\n+\n+  it('should register update if template has changed', () => {\n+    const adapter = new LanguageServiceAdapter(project);\n+    adapter.readResource(TEST_TEMPLATE);\n+    service.overwrite(TEST_TEMPLATE, '<p>Hello World</p>');\n+    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n+    expect(isRegistered).toBe(true);\n+    expect(adapter.getModifiedResourceFiles().size).toBe(1);\n+  });\n+\n+  it('should clear template updates on read', () => {\n+    const adapter = new LanguageServiceAdapter(project);\n+    const isRegistered = adapter.registerTemplateUpdate(TEST_TEMPLATE);\n+    expect(isRegistered).toBeTrue();\n+    expect(adapter.getModifiedResourceFiles().size).toBe(1);\n+    adapter.readResource(TEST_TEMPLATE);\n+    expect(adapter.getModifiedResourceFiles().size).toBe(0);\n+  });\n+});"
        },
        {
            "sha": "134748489e07b6fd2965cbf3f2209cbd97e511c3",
            "filename": "packages/language-service/ivy/test/mock_host.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/63624a2d4630f5c724841aad649a7d4db13526e2/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts?ref=63624a2d4630f5c724841aad649a7d4db13526e2",
            "patch": "@@ -8,6 +8,7 @@\n \n import {join} from 'path';\n import * as ts from 'typescript/lib/tsserverlibrary';\n+import {isTypeScriptFile} from '../language_service_adapter';\n \n const logger: ts.server.Logger = {\n   close(): void{},\n@@ -161,10 +162,24 @@ class MockService {\n \n   getScriptInfo(fileName: string): ts.server.ScriptInfo {\n     const scriptInfo = this.ps.getScriptInfo(fileName);\n-    if (!scriptInfo) {\n+    if (scriptInfo) {\n+      return scriptInfo;\n+    }\n+    // There is no script info for external template, so create one.\n+    // But we need to make sure it's not a TS file.\n+    if (isTypeScriptFile(fileName)) {\n       throw new Error(`No existing script info for ${fileName}`);\n     }\n-    return scriptInfo;\n+    const newScriptInfo = this.ps.getOrCreateScriptInfoForNormalizedPath(\n+        ts.server.toNormalizedPath(fileName),\n+        true,                    // openedByClient\n+        '',                      // fileContent\n+        ts.ScriptKind.External,  // scriptKind\n+    );\n+    if (!newScriptInfo) {\n+      throw new Error(`Failed to create new script info for ${fileName}`);\n+    }\n+    return newScriptInfo;\n   }\n \n   /**"
        }
    ],
    "stats": {
        "total": 287,
        "additions": 241,
        "deletions": 46
    }
}