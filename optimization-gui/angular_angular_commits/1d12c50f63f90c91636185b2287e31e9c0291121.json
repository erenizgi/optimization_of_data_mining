{
    "author": "zarend",
    "message": "fix(compiler-cli): autocomplete literal types in templates. (#41456)\n\nThis adds string literals, number literals, `true`, `false`, `null` and\n`undefined` to autocomplete results in templates.\n\nFor example, when completing an input of union type.\n\nComponent: `@Input('input') input!: 'a'|'b'|null;`\nTemplate: `[input]=\"|\"`\n\nProvide `'a'`, `'b'`, and `null` as autocompletion entries.\n\nPreviously we did not include literal types because we only included\nresults from the component context (`ctx.`) and the template scope.\n\nPR Close #41456",
    "sha": "1d12c50f63f90c91636185b2287e31e9c0291121",
    "files": [
        {
            "sha": "d2b022f603532a3239ba684483143964c1224272",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/checker.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fchecker.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -105,8 +105,9 @@ export interface TemplateTypeChecker {\n    * include completions from the template's context component, as well as any local references or\n    * template variables which are in scope for that expression.\n    */\n-  getGlobalCompletions(context: TmplAstTemplate|null, component: ts.ClassDeclaration):\n-      GlobalCompletion|null;\n+  getGlobalCompletions(\n+      context: TmplAstTemplate|null, component: ts.ClassDeclaration,\n+      node: AST|TmplAstNode): GlobalCompletion|null;\n \n \n   /**"
        },
        {
            "sha": "47d09ddb2651c4b5eeba388cc10488a4892790ce",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/api/completion.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcompletion.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcompletion.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fapi%2Fcompletion.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -71,4 +71,10 @@ export interface GlobalCompletion {\n    * the same name (from the `componentContext` completions).\n    */\n   templateContext: Map<string, ReferenceCompletion|VariableCompletion>;\n+\n+  /**\n+   * A location within the type-checking shim where TypeScript's completion APIs can be used to\n+   * access completions for the AST node of the cursor position (primitive constants).\n+   */\n+  nodeContext: ShimLocation|null;\n }"
        },
        {
            "sha": "bcb5960ad30a5b45320a9993d1ddef89704b62f6",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/checker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fchecker.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -257,14 +257,15 @@ export class TemplateTypeCheckerImpl implements TemplateTypeChecker {\n     return this.getLatestComponentState(component).tcb;\n   }\n \n-  getGlobalCompletions(context: TmplAstTemplate|null, component: ts.ClassDeclaration):\n-      GlobalCompletion|null {\n+  getGlobalCompletions(\n+      context: TmplAstTemplate|null, component: ts.ClassDeclaration,\n+      node: AST|TmplAstNode): GlobalCompletion|null {\n     const engine = this.getOrCreateCompletionEngine(component);\n     if (engine === null) {\n       return null;\n     }\n     return this.perf.inPhase(\n-        PerfPhase.TtcAutocompletion, () => engine.getGlobalCompletions(context));\n+        PerfPhase.TtcAutocompletion, () => engine.getGlobalCompletions(context, node));\n   }\n \n   getExpressionCompletionLocation("
        },
        {
            "sha": "473e5b8a6d6f07445dffb462dffc0faf000525bd",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/src/completion.ts",
            "status": "modified",
            "additions": 82,
            "deletions": 38,
            "changes": 120,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcompletion.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcompletion.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Fsrc%2Fcompletion.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {TmplAstReference, TmplAstTemplate} from '@angular/compiler';\n-import {MethodCall, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead} from '@angular/compiler/src/compiler';\n+import {AST, EmptyExpr, MethodCall, PropertyRead, PropertyWrite, SafeMethodCall, SafePropertyRead, TmplAstNode} from '@angular/compiler/src/compiler';\n import * as ts from 'typescript';\n \n import {AbsoluteFsPath} from '../../file_system';\n@@ -23,65 +23,77 @@ import {TemplateData} from './context';\n  * surrounding TS program have changed.\n  */\n export class CompletionEngine {\n+  private componentContext: ShimLocation|null;\n+\n   /**\n-   * Cache of `GlobalCompletion`s for various levels of the template, including the root template\n-   * (`null`).\n+   * Cache of completions for various levels of the template, including the root template (`null`).\n+   * Memoizes `getTemplateContextCompletions`.\n    */\n-  private globalCompletionCache = new Map<TmplAstTemplate|null, GlobalCompletion>();\n+  private templateContextCache =\n+      new Map<TmplAstTemplate|null, Map<string, ReferenceCompletion|VariableCompletion>>();\n \n   private expressionCompletionCache =\n       new Map<PropertyRead|SafePropertyRead|MethodCall|SafeMethodCall, ShimLocation>();\n \n-  constructor(private tcb: ts.Node, private data: TemplateData, private shimPath: AbsoluteFsPath) {}\n-\n-  /**\n-   * Get global completions within the given template context - either a `TmplAstTemplate` embedded\n-   * view, or `null` for the root template context.\n-   */\n-  getGlobalCompletions(context: TmplAstTemplate|null): GlobalCompletion|null {\n-    if (this.globalCompletionCache.has(context)) {\n-      return this.globalCompletionCache.get(context)!;\n-    }\n \n+  constructor(private tcb: ts.Node, private data: TemplateData, private shimPath: AbsoluteFsPath) {\n     // Find the component completion expression within the TCB. This looks like: `ctx. /* ... */;`\n     const globalRead = findFirstMatchingNode(this.tcb, {\n       filter: ts.isPropertyAccessExpression,\n       withExpressionIdentifier: ExpressionIdentifier.COMPONENT_COMPLETION\n     });\n \n-    if (globalRead === null) {\n-      return null;\n-    }\n-\n-    const completion: GlobalCompletion = {\n-      componentContext: {\n+    if (globalRead !== null) {\n+      this.componentContext = {\n         shimPath: this.shimPath,\n         // `globalRead.name` is an empty `ts.Identifier`, so its start position immediately follows\n         // the `.` in `ctx.`. TS autocompletion APIs can then be used to access completion results\n         // for the component context.\n         positionInShimFile: globalRead.name.getStart(),\n-      },\n-      templateContext: new Map<string, ReferenceCompletion|VariableCompletion>(),\n-    };\n+      };\n+    } else {\n+      this.componentContext = null;\n+    }\n+  }\n \n-    // The bound template already has details about the references and variables in scope in the\n-    // `context` template - they just need to be converted to `Completion`s.\n-    for (const node of this.data.boundTarget.getEntitiesInTemplateScope(context)) {\n-      if (node instanceof TmplAstReference) {\n-        completion.templateContext.set(node.name, {\n-          kind: CompletionKind.Reference,\n-          node,\n-        });\n-      } else {\n-        completion.templateContext.set(node.name, {\n-          kind: CompletionKind.Variable,\n-          node,\n-        });\n+  /**\n+   * Get global completions within the given template context and AST node.\n+   *\n+   * @param context the given template context - either a `TmplAstTemplate` embedded view, or `null`\n+   *     for the root\n+   * template context.\n+   * @param node the given AST node\n+   */\n+  getGlobalCompletions(context: TmplAstTemplate|null, node: AST|TmplAstNode): GlobalCompletion\n+      |null {\n+    if (this.componentContext === null) {\n+      return null;\n+    }\n+\n+    const templateContext = this.getTemplateContextCompletions(context);\n+    if (templateContext === null) {\n+      return null;\n+    }\n+\n+    let nodeContext: ShimLocation|null = null;\n+    if (node instanceof EmptyExpr) {\n+      const nodeLocation = findFirstMatchingNode(this.tcb, {\n+        filter: ts.isIdentifier,\n+        withSpan: node.sourceSpan,\n+      });\n+      if (nodeLocation !== null) {\n+        nodeContext = {\n+          shimPath: this.shimPath,\n+          positionInShimFile: nodeLocation.getStart(),\n+        };\n       }\n     }\n \n-    this.globalCompletionCache.set(context, completion);\n-    return completion;\n+    return {\n+      componentContext: this.componentContext,\n+      templateContext,\n+      nodeContext,\n+    };\n   }\n \n   getExpressionCompletionLocation(expr: PropertyRead|PropertyWrite|MethodCall|\n@@ -131,4 +143,36 @@ export class CompletionEngine {\n     this.expressionCompletionCache.set(expr, res);\n     return res;\n   }\n+\n+  /**\n+   * Get global completions within the given template context - either a `TmplAstTemplate` embedded\n+   * view, or `null` for the root context.\n+   */\n+  private getTemplateContextCompletions(context: TmplAstTemplate|null):\n+      Map<string, ReferenceCompletion|VariableCompletion>|null {\n+    if (this.templateContextCache.has(context)) {\n+      return this.templateContextCache.get(context)!;\n+    }\n+\n+    const templateContext = new Map<string, ReferenceCompletion|VariableCompletion>();\n+\n+    // The bound template already has details about the references and variables in scope in the\n+    // `context` template - they just need to be converted to `Completion`s.\n+    for (const node of this.data.boundTarget.getEntitiesInTemplateScope(context)) {\n+      if (node instanceof TmplAstReference) {\n+        templateContext.set(node.name, {\n+          kind: CompletionKind.Reference,\n+          node,\n+        });\n+      } else {\n+        templateContext.set(node.name, {\n+          kind: CompletionKind.Variable,\n+          node,\n+        });\n+      }\n+    }\n+\n+    this.templateContextCache.set(context, templateContext);\n+    return templateContext;\n+  }\n }"
        },
        {
            "sha": "d86e0bc8ac477ca0fd56bfcc855a06d025f38b7b",
            "filename": "packages/compiler-cli/src/ngtsc/typecheck/test/type_checker__completion_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__completion_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__completion_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftypecheck%2Ftest%2Ftype_checker__completion_spec.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -141,7 +141,7 @@ function setupCompletions(\n     context = tmpl;\n   }\n \n-  const completions = templateTypeChecker.getGlobalCompletions(context, SomeCmp)!;\n+  const completions = templateTypeChecker.getGlobalCompletions(context, SomeCmp, null!)!;\n   expect(completions).toBeDefined();\n   return {\n     completions,"
        },
        {
            "sha": "84f89938f275d4ab1d120c42e966f619a9952198",
            "filename": "packages/language-service/ivy/completions.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 7,
            "changes": 51,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Flanguage-service%2Fivy%2Fcompletions.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompletions.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -216,21 +216,21 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       options: ts.GetCompletionsAtPositionOptions|\n       undefined): ts.WithMetadata<ts.CompletionInfo>|undefined {\n     const completions =\n-        this.templateTypeChecker.getGlobalCompletions(this.template, this.component);\n+        this.templateTypeChecker.getGlobalCompletions(this.template, this.component, this.node);\n     if (completions === null) {\n       return undefined;\n     }\n \n-    const {componentContext, templateContext} = completions;\n+    const {componentContext, templateContext, nodeContext: astContext} = completions;\n \n     const replacementSpan = makeReplacementSpanFromAst(this.node);\n \n     // Merge TS completion results with results from the template scope.\n     let entries: ts.CompletionEntry[] = [];\n-    const tsLsCompletions = this.tsLS.getCompletionsAtPosition(\n+    const componentCompletions = this.tsLS.getCompletionsAtPosition(\n         componentContext.shimPath, componentContext.positionInShimFile, options);\n-    if (tsLsCompletions !== undefined) {\n-      for (const tsCompletion of tsLsCompletions.entries) {\n+    if (componentCompletions !== undefined) {\n+      for (const tsCompletion of componentCompletions.entries) {\n         // Skip completions that are shadowed by a template entity definition.\n         if (templateContext.has(tsCompletion.name)) {\n           continue;\n@@ -244,6 +244,24 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       }\n     }\n \n+    // Merge TS completion results with results from the ast context.\n+    if (astContext !== null) {\n+      const nodeCompletions = this.tsLS.getCompletionsAtPosition(\n+          astContext.shimPath, astContext.positionInShimFile, options);\n+      if (nodeCompletions !== undefined) {\n+        for (const tsCompletion of nodeCompletions.entries) {\n+          if (this.isValidNodeContextCompletion(tsCompletion)) {\n+            entries.push({\n+              ...tsCompletion,\n+              // Substitute the TS completion's `replacementSpan` (which uses offsets within the\n+              // TCB) with the `replacementSpan` within the template source.\n+              replacementSpan,\n+            });\n+          }\n+        }\n+      }\n+    }\n+\n     for (const [name, entity] of templateContext) {\n       entries.push({\n         name,\n@@ -276,7 +294,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       formatOptions: ts.FormatCodeOptions|ts.FormatCodeSettings|undefined,\n       preferences: ts.UserPreferences|undefined): ts.CompletionEntryDetails|undefined {\n     const completions =\n-        this.templateTypeChecker.getGlobalCompletions(this.template, this.component);\n+        this.templateTypeChecker.getGlobalCompletions(this.template, this.component, this.node);\n     if (completions === null) {\n       return undefined;\n     }\n@@ -317,7 +335,7 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n   private getGlobalPropertyExpressionCompletionSymbol(\n       this: PropertyExpressionCompletionBuilder, entryName: string): ts.Symbol|undefined {\n     const completions =\n-        this.templateTypeChecker.getGlobalCompletions(this.template, this.component);\n+        this.templateTypeChecker.getGlobalCompletions(this.template, this.component, this.node);\n     if (completions === null) {\n       return undefined;\n     }\n@@ -638,6 +656,25 @@ export class CompletionBuilder<N extends TmplAstNode|AST> {\n       isNewIdentifierLocation: false,\n     };\n   }\n+\n+  /**\n+   * From the AST node of the cursor position, include completion of string literals, number\n+   * literals, `true`, `false`, `null`, and `undefined`.\n+   */\n+  private isValidNodeContextCompletion(completion: ts.CompletionEntry): boolean {\n+    if (completion.kind === ts.ScriptElementKind.string) {\n+      // 'string' kind includes both string literals and number literals\n+      return true;\n+    }\n+    if (completion.kind === ts.ScriptElementKind.keyword) {\n+      return completion.name === 'true' || completion.name === 'false' ||\n+          completion.name === 'null';\n+    }\n+    if (completion.kind === ts.ScriptElementKind.variableElement) {\n+      return completion.name === 'undefined';\n+    }\n+    return false;\n+  }\n }\n \n function makeReplacementSpanFromParseSourceSpan(span: ParseSourceSpan): ts.TextSpan {"
        },
        {
            "sha": "5fa39aa5c8e6765f02f7308ff04b3ee572699019",
            "filename": "packages/language-service/ivy/test/completions_spec.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d12c50f63f90c91636185b2287e31e9c0291121/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fcompletions_spec.ts?ref=1d12c50f63f90c91636185b2287e31e9c0291121",
            "patch": "@@ -24,6 +24,18 @@ const DIR_WITH_INPUT = {\n   `\n };\n \n+const DIR_WITH_UNION_TYPE_INPUT = {\n+  'Dir': `\n+    @Directive({\n+      selector: '[dir]',\n+      inputs: ['myInput']\n+    })\n+    export class Dir {\n+      myInput!: 'foo'|42|null|undefined\n+    }\n+  `\n+};\n+\n const DIR_WITH_OUTPUT = {\n   'Dir': `\n     @Directive({\n@@ -203,6 +215,18 @@ describe('completions', () => {\n       const completions = templateFile.getCompletionsAtPosition();\n       expectContain(completions, ts.ScriptElementKind.memberVariableElement, ['title']);\n     });\n+\n+    it('should return completions of string literals, number literals, `true`, `false`, `null` and `undefined`',\n+       () => {\n+         const {templateFile} = setup(`<input dir [myInput]=\"\">`, '', DIR_WITH_UNION_TYPE_INPUT);\n+         templateFile.moveCursorToText('dir [myInput]=\"Â¦\">');\n+\n+         const completions = templateFile.getCompletionsAtPosition();\n+         expectContain(completions, ts.ScriptElementKind.string, [`'foo'`, '42']);\n+         expectContain(completions, ts.ScriptElementKind.keyword, ['null']);\n+         expectContain(completions, ts.ScriptElementKind.variableElement, ['undefined']);\n+         expectDoesNotContain(completions, ts.ScriptElementKind.parameterElement, ['ctx']);\n+       });\n   });\n \n   describe('in an expression scope', () => {\n@@ -789,7 +813,7 @@ function setup(\n         export class AppCmp {\n           ${classContents}\n         }\n-        \n+\n         ${otherDirectiveClassDecls}\n \n         @NgModule({\n@@ -822,7 +846,7 @@ function setupInlineTemplate(\n         export class AppCmp {\n           ${classContents}\n         }\n-        \n+\n         ${otherDirectiveClassDecls}\n \n         @NgModule({"
        }
    ],
    "stats": {
        "total": 219,
        "additions": 166,
        "deletions": 53
    }
}