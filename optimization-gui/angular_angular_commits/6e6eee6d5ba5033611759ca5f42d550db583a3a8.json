{
    "author": "gkalpak",
    "message": "refactor(docs-infra): decouple deploying from other operations in `deploy-to-firebase.js` (#39853)\n\nPreviously, the `deploy()` function in `deploy-to-firebase.js` would\nalso perform other operations (beyond deploying), such as building the\napp, checking the generated payload size, testing the PWA score of the\ndeployed app.\n\nThis commit decouples these operations, so that deploying can be\nperformed independently.\n\nNOTE:\nIn a subsequent commit, this will be leveraged fix an issue with\n`rc.angular.io` redirects in the presence of a ServiceWorker by\ndeploying the same artifacts to multiple Firebase projects/sites.\nSee #39760 for more details.\n\nPR Close #39853",
    "sha": "6e6eee6d5ba5033611759ca5f42d550db583a3a8",
    "files": [
        {
            "sha": "f700b061d533ce437c0a90278e9e5cbebf44936d",
            "filename": "aio/scripts/deploy-to-firebase.js",
            "status": "modified",
            "additions": 56,
            "deletions": 22,
            "changes": 78,
            "blob_url": "https://github.com/angular/angular/blob/6e6eee6d5ba5033611759ca5f42d550db583a3a8/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "raw_url": "https://github.com/angular/angular/raw/6e6eee6d5ba5033611759ca5f42d550db583a3a8/aio%2Fscripts%2Fdeploy-to-firebase.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.js?ref=6e6eee6d5ba5033611759ca5f42d550db583a3a8",
            "patch": "@@ -30,13 +30,15 @@ if (require.main === module) {\n     console.log(deploymentInfo.reason);\n   } else {\n     console.log(\n-        `Git branch        : ${inputVars.currentBranch}\\n` +\n-        `Git commit        : ${inputVars.currentCommit}\\n` +\n-        `Build/deploy mode : ${deploymentInfo.deployEnv}\\n` +\n-        `Firebase project  : ${deploymentInfo.projectId}\\n` +\n-        `Firebase site     : ${deploymentInfo.siteId}\\n` +\n-        `Deployment URLs   : ${deploymentInfo.deployedUrl}\\n` +\n-        `                    https://${deploymentInfo.siteId}.web.app/`);\n+        `Git branch          : ${inputVars.currentBranch}\\n` +\n+        `Git commit          : ${inputVars.currentCommit}\\n` +\n+        `Build/deploy mode   : ${deploymentInfo.deployEnv}\\n` +\n+        `Firebase project    : ${deploymentInfo.projectId}\\n` +\n+        `Firebase site       : ${deploymentInfo.siteId}\\n` +\n+        `Pre-deploy actions  : ${serializeActions(deploymentInfo.preDeployActions)}\\n` +\n+        `Post-deploy actions : ${serializeActions(deploymentInfo.postDeployActions)}\\n` +\n+        `Deployment URLs     : ${deploymentInfo.deployedUrl}\\n` +\n+        `                      https://${deploymentInfo.siteId}.web.app/`);\n \n     if (!isDryRun) {\n       deploy({...inputVars, ...deploymentInfo});\n@@ -45,6 +47,22 @@ if (require.main === module) {\n }\n \n // Helpers\n+function build({deployedUrl, deployEnv}) {\n+  console.log('\\n\\n\\n==== Build the AIO app. ====\\n');\n+  yarn(`build --configuration=${deployEnv} --progress=false`);\n+\n+  console.log('\\n\\n\\n==== Add any mode-specific files into the AIO distribution. ====\\n');\n+  cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+\n+  console.log('\\n\\n\\n==== Update opensearch descriptor for AIO with `deployedUrl`. ====\\n');\n+  yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`);  // The URL must end with `/`.\n+}\n+\n+function checkPayloadSize() {\n+  console.log('\\n\\n\\n==== Check payload size and upload the numbers to Firebase DB. ====\\n');\n+  yarn('payload-size');\n+}\n+\n function computeDeploymentInfo(\n     {currentBranch, currentCommit, isPullRequest, repoName, repoOwner, stableBranch}) {\n   // Do not deploy if we are running in a fork.\n@@ -72,24 +90,32 @@ function computeDeploymentInfo(\n       projectId: 'angular-io',\n       siteId: 'next-angular-io-site',\n       deployedUrl: 'https://next.angular.io/',\n+      preDeployActions: [build, checkPayloadSize],\n+      postDeployActions: [testPwaScore],\n     },\n     rc: {\n       deployEnv: 'rc',\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n+      preDeployActions: [build, checkPayloadSize],\n+      postDeployActions: [testPwaScore],\n     },\n     stable: {\n       deployEnv: 'stable',\n       projectId: 'angular-io',\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: 'https://angular.io/',\n+      preDeployActions: [build, checkPayloadSize],\n+      postDeployActions: [testPwaScore],\n     },\n     archive: {\n       deployEnv: 'archive',\n       projectId: 'angular-io',\n       siteId: `v${currentBranchMajorVersion}-angular-io-site`,\n       deployedUrl: `https://v${currentBranchMajorVersion}.angular.io/`,\n+      preDeployActions: [build, checkPayloadSize],\n+      postDeployActions: [testPwaScore],\n     },\n   };\n \n@@ -160,21 +186,20 @@ function computeMajorVersion(branchName) {\n   return +branchName.split('.', 1)[0];\n }\n \n-function deploy(\n-    {currentCommit, deployedUrl, deployEnv, firebaseToken, minPwaScore, projectId, siteId}) {\n-  cd(`${__dirname}/..`);\n-\n-  console.log('\\n\\n\\n==== Build the AIO app. ====\\n');\n-  yarn(`build --configuration=${deployEnv} --progress=false`);\n-\n-  console.log('\\n\\n\\n==== Add any mode-specific files into the AIO distribution. ====\\n');\n-  cp('-rf', `src/extra-files/${deployEnv}/.`, 'dist/');\n+function deploy(data) {\n+  const {\n+    currentCommit,\n+    firebaseToken,\n+    postDeployActions,\n+    preDeployActions,\n+    projectId,\n+    siteId,\n+  } = data;\n \n-  console.log('\\n\\n\\n==== Update opensearch descriptor for AIO with `deployedUrl`. ====\\n');\n-  yarn(`set-opensearch-url ${deployedUrl.replace(/[^/]$/, '$&/')}`);  // The URL must end with `/`.\n+  cd(`${__dirname}/..`);\n \n-  console.log('\\n\\n\\n==== Check payload size and upload the numbers to Firebase DB. ====\\n');\n-  yarn('payload-size');\n+  console.log('\\n\\n\\n==== Run pre-deploy actions. ====\\n');\n+  preDeployActions.forEach(fn => fn(data));\n \n   console.log('\\n\\n\\n==== Deploy AIO to Firebase hosting. ====\\n');\n   yarn(`firebase use \"${projectId}\" --token \"${firebaseToken}\"`);\n@@ -183,8 +208,8 @@ function deploy(\n       `firebase deploy --only hosting:aio --message \"Commit: ${currentCommit}\" --non-interactive ` +\n       `--token \"${firebaseToken}\"`);\n \n-  console.log('\\n\\n\\n==== Run PWA-score tests. ====\\n');\n-  yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n+  console.log('\\n\\n\\n==== Run post-deploy actions. ====\\n');\n+  postDeployActions.forEach(fn => fn(data));\n }\n \n function getRemoteRefs(refOrPattern, remote = NG_REMOTE_URL) {\n@@ -195,10 +220,19 @@ function getLatestCommit(branchName, remote = undefined) {\n   return getRemoteRefs(branchName, remote)[0].slice(0, 40);\n }\n \n+function serializeActions(actions) {\n+  return actions.map(fn => fn.name).join(', ');\n+}\n+\n function skipDeployment(reason) {\n   return {reason, skipped: true};\n }\n \n+function testPwaScore({deployedUrl, minPwaScore}) {\n+  console.log('\\n\\n\\n==== Run PWA-score tests. ====\\n');\n+  yarn(`test-pwa-score \"${deployedUrl}\" \"${minPwaScore}\"`);\n+}\n+\n function yarn(cmd) {\n   // Using `--silent` to ensure no secret env variables are printed.\n   //"
        },
        {
            "sha": "b7523fcc6897ce399c76dc2281ba58b49ca7d535",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "modified",
            "additions": 63,
            "deletions": 41,
            "changes": 104,
            "blob_url": "https://github.com/angular/angular/blob/6e6eee6d5ba5033611759ca5f42d550db583a3a8/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/6e6eee6d5ba5033611759ca5f42d550db583a3a8/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=6e6eee6d5ba5033611759ca5f42d550db583a3a8",
            "patch": "@@ -6,60 +6,70 @@ const {computeDeploymentInfo, computeInputVars, getLatestCommit} = require('./de\n \n \n describe('deploy-to-firebase:', () => {\n+  // Helpers\n+  const jsonFunctionReplacer = (_key, val) =>\n+    (typeof val === 'function') ? `function:${val.name}` : val;\n+  const getDeploymentInfoFor = env => {\n+    const deploymentInfo = computeDeploymentInfo(computeInputVars(env));\n+    return JSON.parse(JSON.stringify(deploymentInfo, jsonFunctionReplacer));\n+  };\n+\n   it('master - skip deploy - not angular', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'notangular',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason: 'Skipping deploy because this is not angular/angular.',\n     });\n   });\n \n   it('master - skip deploy - angular fork', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'notangular',\n       CI_REPO_NAME: 'angular',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason: 'Skipping deploy because this is not angular/angular.',\n     });\n   });\n \n   it('master - skip deploy - pull request', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'true',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason: 'Skipping deploy because this is a PR build.',\n     });\n   });\n \n   it('master - deploy success', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n       CI_COMMIT: getLatestCommit('master'),\n-    }))).toEqual({\n+    })).toEqual({\n       deployEnv: 'next',\n       projectId: 'angular-io',\n       siteId: 'next-angular-io-site',\n       deployedUrl: 'https://next.angular.io/',\n+      preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+      postDeployActions: ['function:testPwaScore'],\n     });\n   });\n \n   it('master - skip deploy - commit not HEAD', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n@@ -68,30 +78,32 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('stable - deploy success', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: getLatestCommit('4.3.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       deployEnv: 'stable',\n       projectId: 'angular-io',\n       siteId: 'v4-angular-io-site',\n       deployedUrl: 'https://angular.io/',\n+      preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+      postDeployActions: ['function:testPwaScore'],\n     });\n   });\n \n   it('stable - skip deploy - commit not HEAD', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n@@ -100,48 +112,52 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('archive - deploy success', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: getLatestCommit('2.4.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       deployEnv: 'archive',\n       projectId: 'angular-io',\n       siteId: 'v2-angular-io-site',\n       deployedUrl: 'https://v2.angular.io/',\n+      preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+      postDeployActions: ['function:testPwaScore'],\n     });\n   });\n \n   // v9 used to be special-cased, because it was piloting the Firebase hosting \"multisites\" setup.\n   // See https://angular-team.atlassian.net/browse/DEV-125 for more info.\n   it('archive - deploy success (no special case for v9)', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '9.1.x',\n       CI_STABLE_BRANCH: '10.0.x',\n       CI_COMMIT: getLatestCommit('9.1.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       deployEnv: 'archive',\n       projectId: 'angular-io',\n       siteId: 'v9-angular-io-site',\n       deployedUrl: 'https://v9.angular.io/',\n+      preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+      postDeployActions: ['function:testPwaScore'],\n     });\n   });\n \n   it('archive - skip deploy - commit not HEAD', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n@@ -150,14 +166,14 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('archive - skip deploy - major same as stable, minor less than stable', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '2.2.x',\n       CI_COMMIT: getLatestCommit('2.1.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n@@ -166,14 +182,14 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('archive - skip deploy - major lower than stable, minor not latest', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '4.3.x',\n       CI_COMMIT: getLatestCommit('2.1.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n@@ -182,46 +198,50 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('rc - deploy success - major higher than stable', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n       CI_COMMIT: getLatestCommit('4.4.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       deployEnv: 'rc',\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n+      preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+      postDeployActions: ['function:testPwaScore'],\n     });\n   });\n \n   it('rc - deploy success - major same as stable, minor higher', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n       CI_COMMIT: getLatestCommit('2.4.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       deployEnv: 'rc',\n       projectId: 'angular-io',\n       siteId: 'rc-angular-io-site',\n       deployedUrl: 'https://rc.angular.io/',\n+      preDeployActions: ['function:build', 'function:checkPayloadSize'],\n+      postDeployActions: ['function:testPwaScore'],\n     });\n   });\n \n   it('rc - skip deploy - commit not HEAD', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n       CI_COMMIT: 'DUMMY_TEST_COMMIT',\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n@@ -230,14 +250,14 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('rc - skip deploy - major same as stable, minor not latest', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '2.0.x',\n       CI_COMMIT: getLatestCommit('2.1.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy of branch \"2.1.x\" to Firebase.\\n' +\n@@ -246,14 +266,14 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('rc - skip deploy - major higher than stable, minor not latest', () => {\n-    expect(computeDeploymentInfo(computeInputVars({\n+    expect(getDeploymentInfoFor({\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '2.4.x',\n       CI_COMMIT: getLatestCommit('4.3.x'),\n-    }))).toEqual({\n+    })).toEqual({\n       skipped: true,\n       reason:\n           'Skipping deploy of branch \"4.3.x\" to Firebase.\\n' +\n@@ -273,12 +293,14 @@ describe('deploy-to-firebase:', () => {\n     };\n     const result = execSync(cmd, {encoding: 'utf8', env}).trim();\n     expect(result).toBe(\n-        'Git branch        : master\\n' +\n-        `Git commit        : ${commit}\\n` +\n-        'Build/deploy mode : next\\n' +\n-        'Firebase project  : angular-io\\n' +\n-        'Firebase site     : next-angular-io-site\\n' +\n-        'Deployment URLs   : https://next.angular.io/\\n' +\n-        '                    https://next-angular-io-site.web.app/');\n+        'Git branch          : master\\n' +\n+        `Git commit          : ${commit}\\n` +\n+        'Build/deploy mode   : next\\n' +\n+        'Firebase project    : angular-io\\n' +\n+        'Firebase site       : next-angular-io-site\\n' +\n+        'Pre-deploy actions  : build, checkPayloadSize\\n' +\n+        'Post-deploy actions : testPwaScore\\n' +\n+        'Deployment URLs     : https://next.angular.io/\\n' +\n+        '                      https://next-angular-io-site.web.app/');\n   });\n });"
        }
    ],
    "stats": {
        "total": 182,
        "additions": 119,
        "deletions": 63
    }
}