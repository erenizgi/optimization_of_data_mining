{
    "author": "petebacondarwin",
    "message": "fix(ngcc): use aliased exported types correctly (#38666)\n\nIf a type has been renamed when it was exported, we need to\nreference the external public alias name rather than the internal\noriginal name for the type. Otherwise we will try to import the\ntype by its internal name, which is not publicly accessible.\n\nFixes #38238\n\nPR Close #38666",
    "sha": "7869de6136d7e830de53de598fb7f19c1e0789f5",
    "files": [
        {
            "sha": "343880920c4c98dd0b6af87ad40171da7fe47eda",
            "filename": "packages/compiler-cli/ngcc/src/host/esm2015_host.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 30,
            "changes": 55,
            "blob_url": "https://github.com/angular/angular/blob/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts?ref=7869de6136d7e830de53de598fb7f19c1e0789f5",
            "patch": "@@ -7,8 +7,8 @@\n  */\n \n import * as ts from 'typescript';\n-import {absoluteFromSourceFile} from '../../../src/ngtsc/file_system';\n \n+import {absoluteFromSourceFile} from '../../../src/ngtsc/file_system';\n import {Logger} from '../../../src/ngtsc/logging';\n import {ClassDeclaration, ClassMember, ClassMemberKind, CtorParameter, Declaration, Decorator, EnumMember, isDecoratorIdentifier, isNamedClassDeclaration, isNamedFunctionDeclaration, isNamedVariableDeclaration, KnownDeclaration, reflectObjectLiteral, SpecialDeclarationKind, TypeScriptReflectionHost, TypeValueReference, TypeValueReferenceKind, ValueUnavailableKind} from '../../../src/ngtsc/reflection';\n import {isWithinPackage} from '../analysis/util';\n@@ -1593,35 +1593,7 @@ export class Esm2015ReflectionHost extends TypeScriptReflectionHost implements N\n           constructorParamInfo[index] :\n           {decorators: null, typeExpression: null};\n       const nameNode = node.name;\n-\n-      let typeValueReference: TypeValueReference;\n-      if (typeExpression !== null) {\n-        // `typeExpression` is an expression in a \"type\" context. Resolve it to a declared value.\n-        // Either it's a reference to an imported type, or a type declared locally. Distinguish the\n-        // two cases with `getDeclarationOfExpression`.\n-        const decl = this.getDeclarationOfExpression(typeExpression);\n-        if (decl !== null && decl.node !== null && decl.viaModule !== null &&\n-            isNamedDeclaration(decl.node)) {\n-          typeValueReference = {\n-            kind: TypeValueReferenceKind.IMPORTED,\n-            valueDeclaration: decl.node,\n-            moduleName: decl.viaModule,\n-            importedName: decl.node.name.text,\n-            nestedPath: null,\n-          };\n-        } else {\n-          typeValueReference = {\n-            kind: TypeValueReferenceKind.LOCAL,\n-            expression: typeExpression,\n-            defaultImportStatement: null,\n-          };\n-        }\n-      } else {\n-        typeValueReference = {\n-          kind: TypeValueReferenceKind.UNAVAILABLE,\n-          reason: {kind: ValueUnavailableKind.MISSING_TYPE},\n-        };\n-      }\n+      const typeValueReference = this.typeToValue(typeExpression);\n \n       return {\n         name: getNameText(nameNode),\n@@ -1633,6 +1605,29 @@ export class Esm2015ReflectionHost extends TypeScriptReflectionHost implements N\n     });\n   }\n \n+  /**\n+   * Compute the `TypeValueReference` for the given `typeExpression`.\n+   *\n+   * In ngcc, all the `typeExpression` are guaranteed to be \"values\" because it is working in JS and\n+   * not TS. This means that the TS compiler is not going to remove the \"type\" import and so we can\n+   * always use a LOCAL `TypeValueReference` kind, rather than trying to force an additional import\n+   * for non-local expressions.\n+   */\n+  private typeToValue(typeExpression: ts.Expression|null): TypeValueReference {\n+    if (typeExpression === null) {\n+      return {\n+        kind: TypeValueReferenceKind.UNAVAILABLE,\n+        reason: {kind: ValueUnavailableKind.MISSING_TYPE},\n+      };\n+    }\n+\n+    return {\n+      kind: TypeValueReferenceKind.LOCAL,\n+      expression: typeExpression,\n+      defaultImportStatement: null,\n+    };\n+  }\n+\n   /**\n    * Get the parameter type and decorators for the constructor of a class,\n    * where the information is stored on a static property of the class."
        },
        {
            "sha": "c7d0f243b0c3eedc0c1ef35105a451c41f4b2586",
            "filename": "packages/compiler-cli/ngcc/test/host/commonjs_host_spec.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/angular/angular/blob/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fcommonjs_host_spec.ts?ref=7869de6136d7e830de53de598fb7f19c1e0789f5",
            "patch": "@@ -1211,6 +1211,69 @@ exports.MissingClass2 = MissingClass2;\n       });\n \n       describe('getConstructorParameters', () => {\n+        it('should always specify LOCAL type value references for decorated constructor parameter types',\n+           () => {\n+             const files = [\n+               {\n+                 name: _('/node_modules/shared-lib/foo.d.ts'),\n+                 contents: `\n+          declare class Foo {}\n+          export {Foo as Bar};\n+        `,\n+               },\n+               {\n+                 name: _('/node_modules/shared-lib/index.d.ts'),\n+                 contents: `\n+          export {Bar as Baz} from './foo';\n+        `,\n+               },\n+               {\n+                 name: _('/local.js'),\n+                 contents: `\n+          var Internal = (function() {\n+            function Internal() {\n+            }\n+            return Internal;\n+          }());\n+          exports.External = Internal;\n+           `\n+               },\n+               {\n+                 name: _('/main.js'),\n+                 contents: `\n+          var shared = require('shared-lib');\n+          var local = require('./local');\n+          var SameFile = (function() {\n+            function SameFile() {\n+            }\n+            return SameFile;\n+          }());\n+          exports.SameFile = SameFile;\n+\n+          var SomeClass = (function() {\n+            function SomeClass(arg1, arg2, arg3) {}\n+            return SomeClass;\n+          }());\n+          SomeClass.ctorParameters = function() { return [{ type: shared.Baz }, { type: local.External }, { type: SameFile }]; };\n+          exports.SomeClass = SomeClass;\n+        `,\n+               },\n+             ];\n+\n+             loadTestFiles(files);\n+             const bundle = makeTestBundleProgram(_('/main.js'));\n+             const host =\n+                 createHost(bundle, new CommonJsReflectionHost(new MockLogger(), false, bundle));\n+             const classNode = getDeclaration(\n+                 bundle.program, _('/main.js'), 'SomeClass', isNamedVariableDeclaration);\n+\n+             const parameters = host.getConstructorParameters(classNode)!;\n+\n+             expect(parameters.map(p => p.name)).toEqual(['arg1', 'arg2', 'arg3']);\n+             expectTypeValueReferencesForParameters(\n+                 parameters, ['shared.Baz', 'local.External', 'SameFile']);\n+           });\n+\n         it('should find the decorated constructor parameters', () => {\n           loadTestFiles([SOME_DIRECTIVE_FILE]);\n           const bundle = makeTestBundleProgram(SOME_DIRECTIVE_FILE.name);"
        },
        {
            "sha": "96182d3e4858c3c16bb1078e48b3356fc05fd917",
            "filename": "packages/compiler-cli/ngcc/test/host/esm2015_host_spec.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 1,
            "changes": 53,
            "blob_url": "https://github.com/angular/angular/blob/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm2015_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm2015_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm2015_host_spec.ts?ref=7869de6136d7e830de53de598fb7f19c1e0789f5",
            "patch": "@@ -1140,6 +1140,57 @@ runInEachFileSystem(() => {\n     });\n \n     describe('getConstructorParameters()', () => {\n+      it('should always specify LOCAL type value references for decorated constructor parameter types',\n+         () => {\n+           const files = [\n+             {\n+               name: _('/node_modules/shared-lib/foo.d.ts'),\n+               contents: `\n+                declare class Foo {}\n+                export {Foo as Bar};\n+              `,\n+             },\n+             {\n+               name: _('/node_modules/shared-lib/index.d.ts'),\n+               contents: `\n+                export {Bar as Baz} from './foo';\n+              `,\n+             },\n+             {\n+               name: _('/local.js'),\n+               contents: `\n+                 class Internal {}\n+                 export {Internal as External};\n+                 `\n+             },\n+             {\n+               name: _('/main.js'),\n+               contents: `\n+                import {Baz} from 'shared-lib';\n+                import {External} from './local';\n+                export class SameFile {}\n+\n+                export class SomeClass {\n+                  constructor(arg1, arg2, arg3) {}\n+                }\n+                SomeClass.ctorParameters = [{ type: Baz }, { type: External }, { type: SameFile }];\n+              `,\n+             },\n+           ];\n+\n+           loadTestFiles(files);\n+           const bundle = makeTestBundleProgram(_('/main.js'));\n+           const host =\n+               createHost(bundle, new Esm2015ReflectionHost(new MockLogger(), false, bundle));\n+           const classNode =\n+               getDeclaration(bundle.program, _('/main.js'), 'SomeClass', isNamedClassDeclaration);\n+\n+           const parameters = host.getConstructorParameters(classNode)!;\n+\n+           expect(parameters.map(p => p.name)).toEqual(['arg1', 'arg2', 'arg3']);\n+           expectTypeValueReferencesForParameters(parameters, ['Baz', 'External', 'SameFile']);\n+         });\n+\n       it('should find the decorated constructor parameters', () => {\n         loadFakeCore(getFileSystem());\n         loadTestFiles([SOME_DIRECTIVE_FILE]);\n@@ -1154,7 +1205,7 @@ runInEachFileSystem(() => {\n           '_viewContainer', '_template', 'injected'\n         ]);\n         expectTypeValueReferencesForParameters(\n-            parameters, ['ViewContainerRef', 'TemplateRef', null], '@angular/core');\n+            parameters, ['ViewContainerRef', 'TemplateRef', null]);\n       });\n \n       it('should accept `ctorParameters` as an array', () => {"
        },
        {
            "sha": "dafb07947d6a3f4568374ee876280cda53c3cf91",
            "filename": "packages/compiler-cli/ngcc/test/host/esm5_host_spec.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/angular/angular/blob/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm5_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm5_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fesm5_host_spec.ts?ref=7869de6136d7e830de53de598fb7f19c1e0789f5",
            "patch": "@@ -1252,6 +1252,67 @@ runInEachFileSystem(() => {\n     });\n \n     describe('getConstructorParameters()', () => {\n+      it('should always specify LOCAL type value references for decorated constructor parameter types',\n+         () => {\n+           const files = [\n+             {\n+               name: _('/node_modules/shared-lib/foo.d.ts'),\n+               contents: `\n+           declare class Foo {}\n+           export {Foo as Bar};\n+         `,\n+             },\n+             {\n+               name: _('/node_modules/shared-lib/index.d.ts'),\n+               contents: `\n+           export {Bar as Baz} from './foo';\n+         `,\n+             },\n+             {\n+               name: _('/local.js'),\n+               contents: `\n+           var Internal = (function() {\n+             function Internal() {\n+             }\n+             return Internal;\n+           }());\n+           export {Internal as External};\n+            `\n+             },\n+             {\n+               name: _('/main.js'),\n+               contents: `\n+           import {Baz} from 'shared-lib';\n+           import {External} from './local';\n+           var SameFile = (function() {\n+             function SameFile() {\n+             }\n+             return SameFile;\n+           }());\n+           export SameFile;\n+\n+           var SomeClass = (function() {\n+             function SomeClass(arg1, arg2, arg3) {}\n+             return SomeClass;\n+           }());\n+           SomeClass.ctorParameters = function() { return [{ type: Baz }, { type: External }, { type: SameFile }]; };\n+           export SomeClass;\n+         `,\n+             },\n+           ];\n+\n+           loadTestFiles(files);\n+           const bundle = makeTestBundleProgram(_('/main.js'));\n+           const host = createHost(bundle, new Esm5ReflectionHost(new MockLogger(), false, bundle));\n+           const classNode = getDeclaration(\n+               bundle.program, _('/main.js'), 'SomeClass', isNamedVariableDeclaration);\n+\n+           const parameters = host.getConstructorParameters(classNode)!;\n+\n+           expect(parameters.map(p => p.name)).toEqual(['arg1', 'arg2', 'arg3']);\n+           expectTypeValueReferencesForParameters(parameters, ['Baz', 'External', 'SameFile']);\n+         });\n+\n       it('should find the decorated constructor parameters', () => {\n         loadTestFiles([SOME_DIRECTIVE_FILE]);\n         const bundle = makeTestBundleProgram(SOME_DIRECTIVE_FILE.name);"
        },
        {
            "sha": "cf918fb43f533fe14132de827466ac049b2e72e2",
            "filename": "packages/compiler-cli/ngcc/test/host/umd_host_spec.ts",
            "status": "modified",
            "additions": 73,
            "deletions": 1,
            "changes": 74,
            "blob_url": "https://github.com/angular/angular/blob/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Fumd_host_spec.ts?ref=7869de6136d7e830de53de598fb7f19c1e0789f5",
            "patch": "@@ -1332,6 +1332,78 @@ runInEachFileSystem(() => {\n     });\n \n     describe('getConstructorParameters', () => {\n+      it('should always specify LOCAL type value references for decorated constructor parameter types',\n+         () => {\n+           const files = [\n+             {\n+               name: _('/node_modules/shared-lib/foo.d.ts'),\n+               contents: `\n+    declare class Foo {}\n+    export {Foo as Bar};\n+  `,\n+             },\n+             {\n+               name: _('/node_modules/shared-lib/index.d.ts'),\n+               contents: `\n+    export {Bar as Baz} from './foo';\n+  `,\n+             },\n+             {\n+               name: _('/local.js'),\n+               contents: `\n+  (function (global, factory) {\n+    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :\n+    typeof define === 'function' && define.amd ? define('local', ['exports'], factory) :\n+    (factory(global.local));\n+  }(this, (function (exports) { 'use strict';\n+    var Internal = (function() {\n+      function Internal() {\n+      }\n+      return Internal;\n+    }());\n+    exports.External = Internal;\n+  })));\n+     `\n+             },\n+             {\n+               name: _('/main.js'),\n+               contents: `\n+  (function (global, factory) {\n+    typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('shared-lib), require('./local')) :\n+    typeof define === 'function' && define.amd ? define('main', ['exports', 'shared-lib', './local'], factory) :\n+    (factory(global.main, global.shared, global.local));\n+  }(this, (function (exports, shared, local) { 'use strict';\n+    var SameFile = (function() {\n+      function SameFile() {\n+      }\n+      return SameFile;\n+    }());\n+    exports.SameFile = SameFile;\n+\n+    var SomeClass = (function() {\n+      function SomeClass(arg1, arg2, arg3) {}\n+      return SomeClass;\n+    }());\n+    SomeClass.ctorParameters = function() { return [{ type: shared.Baz }, { type: local.External }, { type: SameFile }]; };\n+    exports.SomeClass = SomeClass;\n+  })));\n+  `,\n+             },\n+           ];\n+\n+           loadTestFiles(files);\n+           const bundle = makeTestBundleProgram(_('/main.js'));\n+           const host = createHost(bundle, new UmdReflectionHost(new MockLogger(), false, bundle));\n+           const classNode = getDeclaration(\n+               bundle.program, _('/main.js'), 'SomeClass', isNamedVariableDeclaration);\n+\n+           const parameters = host.getConstructorParameters(classNode)!;\n+\n+           expect(parameters.map(p => p.name)).toEqual(['arg1', 'arg2', 'arg3']);\n+           expectTypeValueReferencesForParameters(\n+               parameters, ['shared.Baz', 'local.External', 'SameFile']);\n+         });\n+\n       it('should find the decorated constructor parameters', () => {\n         loadTestFiles([SOME_DIRECTIVE_FILE]);\n         const bundle = makeTestBundleProgram(SOME_DIRECTIVE_FILE.name);\n@@ -1591,7 +1663,7 @@ runInEachFileSystem(() => {\n             `;\n             break;\n           case 'inlined_with_suffix':\n-            fileHeaderWithUmd = `            \n+            fileHeaderWithUmd = `\n               (function (global, factory) {\n                 typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports)) :\n                 typeof define === 'function' && define.amd ? define('test', ['exports'], factory) :"
        },
        {
            "sha": "5767be4bf789f1a8260625f373cc31e9260b9771",
            "filename": "packages/compiler-cli/ngcc/test/host/util.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 10,
            "changes": 30,
            "blob_url": "https://github.com/angular/angular/blob/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/7869de6136d7e830de53de598fb7f19c1e0789f5/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fhost%2Futil.ts?ref=7869de6136d7e830de53de598fb7f19c1e0789f5",
            "patch": "@@ -13,26 +13,36 @@ import {CtorParameter, TypeValueReferenceKind} from '../../../src/ngtsc/reflecti\n  * names.\n  */\n export function expectTypeValueReferencesForParameters(\n-    parameters: CtorParameter[], expectedParams: (string|null)[], fromModule: string|null = null) {\n+    parameters: CtorParameter[], expectedParams: (string|null)[],\n+    fromModule: (string|null)[] = []) {\n   parameters!.forEach((param, idx) => {\n     const expected = expectedParams[idx];\n     if (expected !== null) {\n       if (param.typeValueReference.kind === TypeValueReferenceKind.UNAVAILABLE) {\n-        fail(`Incorrect typeValueReference generated, expected ${expected}`);\n+        fail(`Incorrect typeValueReference generated for ${param.name}, expected \"${\n+            expected}\" because \"${param.typeValueReference.reason}\"`);\n       } else if (\n-          param.typeValueReference.kind === TypeValueReferenceKind.LOCAL && fromModule !== null) {\n-        fail(`Incorrect typeValueReference generated, expected non-local`);\n+          param.typeValueReference.kind === TypeValueReferenceKind.LOCAL &&\n+          fromModule[idx] != null) {\n+        fail(`Incorrect typeValueReference generated for ${param.name}, expected non-LOCAL (from ${\n+            fromModule[idx]}) but was marked LOCAL`);\n       } else if (\n-          param.typeValueReference.kind !== TypeValueReferenceKind.LOCAL && fromModule === null) {\n-        fail(`Incorrect typeValueReference generated, expected local`);\n+          param.typeValueReference.kind !== TypeValueReferenceKind.LOCAL &&\n+          fromModule[idx] == null) {\n+        fail(`Incorrect typeValueReference generated for ${\n+            param.name}, expected LOCAL but was imported from ${\n+            param.typeValueReference.moduleName}`);\n       } else if (param.typeValueReference.kind === TypeValueReferenceKind.LOCAL) {\n-        if (!ts.isIdentifier(param.typeValueReference.expression)) {\n-          fail(`Incorrect typeValueReference generated, expected identifier`);\n+        if (!ts.isIdentifier(param.typeValueReference.expression) &&\n+            !ts.isPropertyAccessExpression(param.typeValueReference.expression)) {\n+          fail(`Incorrect typeValueReference generated for ${\n+              param.name}, expected an identifier but got \"${\n+              param.typeValueReference.expression.getText()}\"`);\n         } else {\n-          expect(param.typeValueReference.expression.text).toEqual(expected);\n+          expect(param.typeValueReference.expression.getText()).toEqual(expected);\n         }\n       } else if (param.typeValueReference.kind === TypeValueReferenceKind.IMPORTED) {\n-        expect(param.typeValueReference.moduleName).toBe(fromModule!);\n+        expect(param.typeValueReference.moduleName).toBe(fromModule[idx]!);\n         expect(param.typeValueReference.importedName).toBe(expected);\n       }\n     }"
        }
    ],
    "stats": {
        "total": 336,
        "additions": 294,
        "deletions": 42
    }
}