{
    "author": "JiaLiPassion",
    "message": "feat(zone.js): monkey patches queueMicrotask() (#38904)\n\nClose #38863\n\nMonkey patches `queueMicrotask()` API, so the callback runs in the zone\nwhen scheduled, and also the task is run as `microTask`.\n\n```\nZone.current.fork({\n  name: 'queueMicrotask',\n  onScheduleTask: (delegate: ZoneDelegate, curr: Zone, target: Zone, task: Task) => {\n    logs.push(task.type);\n    logs.push(task.source);\n    return delegate.scheduleTask(target, task);\n  }\n}).run(() => {\n    queueMicrotask(() => {\n      expect(logs).toEqual(['microTask', 'queueMicrotask']);\n      expect(Zone.current.name).toEqual('queueMicrotask');\n      done();\n  });\n});\n\n```\n\nPR Close #38904",
    "sha": "27358eb60ff0549106dc4e120ab47d4bde40970f",
    "files": [
        {
            "sha": "b46bef621a217bf4545153e55862930f9ab7d721",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/27358eb60ff0549106dc4e120ab47d4bde40970f/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/27358eb60ff0549106dc4e120ab47d4bde40970f/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=27358eb60ff0549106dc4e120ab47d4bde40970f",
            "patch": "@@ -4,7 +4,7 @@\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n         \"main-es2015\": 140899,\n-        \"polyfills-es2015\": 36571\n+        \"polyfills-es2015\": 36964\n       }\n     }\n   },\n@@ -22,7 +22,7 @@\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n         \"main-es2015\": 146698,\n-        \"polyfills-es2015\": 36571\n+        \"polyfills-es2015\": 36964\n       }\n     }\n   },\n@@ -31,7 +31,7 @@\n       \"uncompressed\": {\n         \"runtime-es2015\": 1485,\n         \"main-es2015\": 136062,\n-        \"polyfills-es2015\": 37392\n+        \"polyfills-es2015\": 37641\n       }\n     }\n   },"
        },
        {
            "sha": "a6190c42ef4abb3d546dd75a8c5942e5a4d21809",
            "filename": "packages/zone.js/lib/browser/browser.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts",
            "raw_url": "https://github.com/angular/angular/raw/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fbrowser%2Fbrowser.ts?ref=27358eb60ff0549106dc4e120ab47d4bde40970f",
            "patch": "@@ -25,6 +25,15 @@ Zone.__load_patch('legacy', (global: any) => {\n   }\n });\n \n+Zone.__load_patch('queueMicrotask', (global: any, Zone: ZoneType, api: _ZonePrivate) => {\n+  api.patchMethod(global, 'queueMicrotask', delegate => {\n+    return function(self: any, args: any[]) {\n+      Zone.current.scheduleMicroTask('queueMicrotask', args[0]);\n+    }\n+  });\n+});\n+\n+\n Zone.__load_patch('timers', (global: any) => {\n   const set = 'set';\n   const clear = 'clear';"
        },
        {
            "sha": "c45ae9bb2a94448ef59e3eb3ee88bbe7c8fd491d",
            "filename": "packages/zone.js/lib/zone.configurations.api.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Flib%2Fzone.configurations.api.ts",
            "raw_url": "https://github.com/angular/angular/raw/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Flib%2Fzone.configurations.api.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Flib%2Fzone.configurations.api.ts?ref=27358eb60ff0549106dc4e120ab47d4bde40970f",
            "patch": "@@ -294,6 +294,34 @@ interface ZoneGlobalConfigurations {\n    */\n   __Zone_disable_requestAnimationFrame?: boolean;\n \n+  /**\n+   *\n+   * Disable the monkey patching of the browser's `queueMicrotask()` API.\n+   *\n+   * By default, `zone.js` monkey patches the browser's `queueMicrotask()` API\n+   * to ensure that `queueMicrotask()` callback is invoked in the same zone as zone used to invoke\n+   * `queueMicrotask()`. And also the callback is running as `microTask` like\n+   * `Promise.prototype.then()`.\n+   *\n+   * Consider the following example:\n+   *\n+   * ```\n+   * const zone = Zone.current.fork({name: 'myZone'});\n+   * zone.run(() => {\n+   *   queueMicrotask(() => {\n+   *     console.log('queueMicrotask() callback is invoked in the zone', Zone.current.name);\n+   *     // Since `queueMicrotask()` was invoked in `myZone`, same zone is restored\n+   *     // when 'queueMicrotask() callback is invoked, resulting in `myZone` being console logged.\n+   *   });\n+   * });\n+   * ```\n+   *\n+   * If you set `__Zone_disable_queueMicrotask = true` before importing `zone.js`,\n+   * `zone.js` does not monkey patch the `queueMicrotask()` API and the above code\n+   * output will change to: 'queueMicrotask() callback is invoked in the zone <root>'.\n+   */\n+  __Zone_disable_queueMicrotask?: boolean;\n+\n   /**\n    *\n    * Disable the monkey patch of the browser blocking APIs(`alert()`/`prompt()`/`confirm()`)."
        },
        {
            "sha": "da8101a59a8fe23178dda6d363615e9918f38aec",
            "filename": "packages/zone.js/test/browser/queue-microtask.spec.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/angular/angular/blob/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Ftest%2Fbrowser%2Fqueue-microtask.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Ftest%2Fbrowser%2Fqueue-microtask.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fbrowser%2Fqueue-microtask.spec.ts?ref=27358eb60ff0549106dc4e120ab47d4bde40970f",
            "patch": "@@ -0,0 +1,33 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {ifEnvSupports} from '../test-util';\n+\n+describe(\n+    'queueMicrotask', ifEnvSupports('queueMicrotask', function() {\n+      it('callback in the queueMicrotask should be scheduled as microTask in the zone',\n+         (done: DoneFn) => {\n+           const logs: string[] = [];\n+           Zone.current\n+               .fork({\n+                 name: 'queueMicrotask',\n+                 onScheduleTask: (delegate: ZoneDelegate, curr: Zone, target: Zone, task: Task) => {\n+                   logs.push(task.type);\n+                   logs.push(task.source);\n+                   return delegate.scheduleTask(target, task);\n+                 }\n+               })\n+               .run(() => {\n+                 queueMicrotask(() => {\n+                   expect(logs).toEqual(['microTask', 'queueMicrotask']);\n+                   expect(Zone.current.name).toEqual('queueMicrotask');\n+                   done();\n+                 });\n+               });\n+         });\n+    }));"
        },
        {
            "sha": "3954d5e373a0c32947ce4390de6559d0fefb3bee",
            "filename": "packages/zone.js/test/browser_entry_point.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Ftest%2Fbrowser_entry_point.ts",
            "raw_url": "https://github.com/angular/angular/raw/27358eb60ff0549106dc4e120ab47d4bde40970f/packages%2Fzone.js%2Ftest%2Fbrowser_entry_point.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fzone.js%2Ftest%2Fbrowser_entry_point.ts?ref=27358eb60ff0549106dc4e120ab47d4bde40970f",
            "patch": "@@ -29,3 +29,4 @@ import './mocha-patch.spec';\n import './jasmine-patch.spec';\n import './browser/messageport.spec';\n import './extra/cordova.spec';\n+import './browser/queue-microtask.spec';"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 74,
        "deletions": 3
    }
}