{
    "author": "petebacondarwin",
    "message": "build(docs-infra): add path disambiguation (#41788)\n\nWhen two documents have the same `outputPath`, only differing by\nletter casing, there can be problems on case-insensitive file-systems:\nOnly one of each of the docs would end up being written.\n\nMoreover, the Webpack 5 bundler will error if it comes across files\nthat have this kind of ambiguous paths.\n\nThis commit adds a new docType: `disambiguator`, which will display\na list of the docs that match an ambiguous path. Each of the ambiguous\ndocs is then given a unique path and outputPath to ensure there are no\ncollisions.\n\nPR Close #41788",
    "sha": "538286df16390249784a98f9026098e2412db33d",
    "files": [
        {
            "sha": "cfe8540329fa9aa534056559aa7bab93a315180d",
            "filename": "aio/tools/transforms/angular-base-package/index.js",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "raw_url": "https://github.com/angular/angular/raw/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Findex.js?ref=538286df16390249784a98f9026098e2412db33d",
            "patch": "@@ -37,6 +37,7 @@ module.exports = new Package('angular-base', [\n   .processor(require('./processors/renderLinkInfo'))\n   .processor(require('./processors/checkContentRules'))\n   .processor(require('./processors/splitDescription'))\n+  .processor(require('./processors/disambiguateDocPaths'))\n \n   // overrides base packageInfo and returns the one for the 'angular/angular' repo.\n   .factory('packageInfo', function() { return require(path.resolve(PROJECT_ROOT, 'package.json')); })\n@@ -66,7 +67,7 @@ module.exports = new Package('angular-base', [\n     collectExamples.exampleFolders = [];\n \n     generateKeywordsProcessor.ignoreWords = require(path.resolve(__dirname, 'ignore-words'))['en'];\n-    generateKeywordsProcessor.docTypesToIgnore = [undefined, 'example-region', 'json-doc', 'api-list-data', 'api-list-data', 'contributors-json', 'navigation-json', 'announcements-json'];\n+    generateKeywordsProcessor.docTypesToIgnore = [undefined, 'example-region', 'json-doc', 'api-list-data', 'api-list-data', 'contributors-json', 'navigation-json', 'announcements-json', 'disambiguator'];\n     generateKeywordsProcessor.propertiesToIgnore = ['basePath', 'renderedContent', 'docType', 'searchTitle'];\n   })\n \n@@ -167,5 +168,5 @@ module.exports = new Package('angular-base', [\n   })\n \n   .config(function(convertToJsonProcessor) {\n-    convertToJsonProcessor.docTypes = [];\n+    convertToJsonProcessor.docTypes = ['disambiguator'];\n   });"
        },
        {
            "sha": "2f3d01b624202a138ba1c6fca3cbc1a8b05d7626",
            "filename": "aio/tools/transforms/angular-base-package/processors/disambiguateDocPaths.js",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.js",
            "raw_url": "https://github.com/angular/angular/raw/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.js?ref=538286df16390249784a98f9026098e2412db33d",
            "patch": "@@ -0,0 +1,68 @@\n+/**\n+ * @dgProcessor disambiguateDocPathsProcessor\n+ * @description\n+ *\n+ * Ensures that docs that have the same path, other than case changes,\n+ * are disambiguated.\n+ *\n+ * For example in Angular there is the `ROUTES` const and a `Routes` type.\n+ * In a case-sensitive file-system these would both be stored at the paths\n+ *\n+ * ```\n+ * aio/src/generated/router/Routes.json\n+ * aio/src/generated/router/ROUTES.json\n+ * ```\n+ *\n+ * but in a case-insensitive file-system these two paths point to the same file!\n+ */\n+module.exports = function disambiguateDocPathsProcessor(log) {\n+  return {\n+    $runAfter: ['paths-computed'],\n+    $runBefore: ['rendering-docs'],\n+    $process(docs) {\n+      // Collect all the ambiguous docs, whose outputPath is are only different by casing.\n+      const ambiguousDocMap = new Map();\n+      for (const doc of docs) {\n+        if (!doc.outputPath) {\n+          continue;\n+        }\n+        const outputPath = doc.outputPath.toLowerCase();\n+        if (!ambiguousDocMap.has(outputPath)) {\n+          ambiguousDocMap.set(outputPath, []);\n+        }\n+        const ambiguousDocs = ambiguousDocMap.get(outputPath);\n+        ambiguousDocs.push(doc);\n+      }\n+\n+      // Create a disambiguator doc for each set of such ambiguous docs,\n+      // and update the ambiguous docs to have unique `path` and `outputPath` properties.\n+      for (const [outputPath, ambiguousDocs] of ambiguousDocMap) {\n+        if (ambiguousDocs.length === 1) {\n+          continue;\n+        }\n+\n+        log.debug('Docs with ambiguous outputPath:' + ambiguousDocs.map((d, i) => `\\n - ${d.id}: \"${d.outputPath}\" replaced with \"${convertPath(d.outputPath, i)}\".`));\n+\n+        const doc = ambiguousDocs[0];\n+        const path = doc.path;\n+        const id = `${doc.id.toLowerCase()}-disambiguator`;\n+        const title = `${doc.id.toLowerCase()} (disambiguation)`;\n+        const aliases = [id];\n+        docs.push({ docType: 'disambiguator', id, title, aliases, path, outputPath, docs: ambiguousDocs });\n+\n+        // Update the paths\n+        let count = 0;\n+        for (const doc of ambiguousDocs) {\n+          doc.path = convertPath(doc.path, count);\n+          doc.outputPath = convertPath(doc.outputPath, count);\n+          count += 1;\n+        }\n+      }\n+    }\n+  };\n+};\n+\n+function convertPath(path, count) {\n+  // Add the counter before any extension\n+  return path.replace(/(\\.[^.]*)?$/, `-${count}$1`);\n+}"
        },
        {
            "sha": "6bcd5995bc6744ea2abff79b39edb23b3bc24ecb",
            "filename": "aio/tools/transforms/angular-base-package/processors/disambiguateDocPaths.spec.js",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Fangular-base-package%2Fprocessors%2FdisambiguateDocPaths.spec.js?ref=538286df16390249784a98f9026098e2412db33d",
            "patch": "@@ -0,0 +1,65 @@\n+const testPackage = require('../../helpers/test-package');\n+const Dgeni = require('dgeni');\n+\n+describe('disambiguateDocPaths processor', () => {\n+  let dgeni, injector, processor, docs;\n+\n+  beforeEach(() => {\n+    dgeni = new Dgeni([testPackage('angular-base-package')]);\n+    injector = dgeni.configureInjector();\n+    processor = injector.get('disambiguateDocPathsProcessor');\n+    docs = [\n+      {docType: 'test-doc', id: 'test-doc', path: 'test/doc', outputPath: 'test/doc.json'},\n+      {docType: 'test-doc', id: 'TEST-DOC', path: 'TEST/DOC', outputPath: 'TEST/DOC.json'},\n+      {docType: 'test-doc', id: 'test-Doc', path: 'test/Doc', outputPath: 'test/Doc.xml'},\n+      {docType: 'test-doc', id: 'unique-doc', path: 'unique/doc', outputPath: 'unique/doc.json'},\n+      {docType: 'test-doc', id: 'other-doc', path: 'other/doc', outputPath: 'other/doc.json'},\n+      {docType: 'test-doc', id: 'other-DOC', path: 'other/DOC', outputPath: 'other/DOC.json'},\n+    ];\n+  });\n+\n+  it('should be part of the dgeni package', () => {\n+    expect(processor).toBeDefined();\n+  });\n+\n+  it('should create `disambiguator` documents for docs that have ambiguous outputPaths', () => {\n+    const numDocs = docs.length;\n+    processor.$process(docs);\n+    expect(docs.length).toEqual(numDocs + 2);\n+    expect(docs[docs.length - 2]).toEqual({\n+      docType: 'disambiguator',\n+      id: 'test-doc-disambiguator',\n+      title: 'test-doc (disambiguation)',\n+      aliases: ['test-doc-disambiguator'],\n+      path: 'test/doc',\n+      outputPath: 'test/doc.json',\n+      docs: [docs[0], docs[1]],\n+    });\n+    expect(docs[docs.length - 1]).toEqual({\n+      docType: 'disambiguator',\n+      id: 'other-doc-disambiguator',\n+      title: 'other-doc (disambiguation)',\n+      aliases: ['other-doc-disambiguator'],\n+      path: 'other/doc',\n+      outputPath: 'other/doc.json',\n+      docs: [docs[4], docs[5]],\n+    });\n+  });\n+\n+  it('should update the path and outputPath properties of each ambiguous doc', () => {\n+    processor.$process(docs);\n+    expect(docs[0].path).toEqual('test/doc-0');\n+    expect(docs[0].outputPath).toEqual('test/doc-0.json');\n+    expect(docs[1].path).toEqual('TEST/DOC-1');\n+    expect(docs[1].outputPath).toEqual('TEST/DOC-1.json');\n+\n+    // The non-ambiguous docs are left alone\n+    expect(docs[2].outputPath).toEqual('test/Doc.xml');\n+    expect(docs[3].outputPath).toEqual('unique/doc.json');\n+\n+    expect(docs[4].path).toEqual('other/doc-0');\n+    expect(docs[4].outputPath).toEqual('other/doc-0.json');\n+    expect(docs[5].path).toEqual('other/DOC-1');\n+    expect(docs[5].outputPath).toEqual('other/DOC-1.json');\n+  });\n+});"
        },
        {
            "sha": "feab8f50709e6168221eac5e1bc4b0c67853522d",
            "filename": "aio/tools/transforms/templates/disambiguator.template.html",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Ftemplates%2Fdisambiguator.template.html",
            "raw_url": "https://github.com/angular/angular/raw/538286df16390249784a98f9026098e2412db33d/aio%2Ftools%2Ftransforms%2Ftemplates%2Fdisambiguator.template.html",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Ftransforms%2Ftemplates%2Fdisambiguator.template.html?ref=538286df16390249784a98f9026098e2412db33d",
            "patch": "@@ -0,0 +1,15 @@\n+{% marked %}\n+# {$ doc.title $}\n+{% endmarked %}\n+\n+{% block content %}\n+<div class=\"content\">\n+  There are multiple pages that match this path:\n+  <ul>\n+    {% for ambiguousDoc in doc.docs %}<li>\n+      <a href=\"{$ ambiguousDoc.path $}\">{$ ambiguousDoc.id $}</a>\n+      {$ ambiguousDoc.shortDescription | marked $}\n+    </li>{% endfor %}\n+  </ul>\n+</div>\n+{% endblock %}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 153,
        "additions": 151,
        "deletions": 2
    }
}