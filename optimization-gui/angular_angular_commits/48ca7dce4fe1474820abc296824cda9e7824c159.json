{
    "author": "crisbeto",
    "message": "fix(compiler-cli): interpret string concat calls (#44167)\n\nThese changes add support for interpreting `String.prototype.concat` calls. We need to support it, because in TypeScript 4.5 string template expressions are transpiled to `concat` calls, rather than string concatenations. See https://github.com/microsoft/TypeScript/pull/45304.\n\nPR Close #44167",
    "sha": "48ca7dce4fe1474820abc296824cda9e7824c159",
    "files": [
        {
            "sha": "ebd5e570f94994195429ba9bdd9f3a974e514b30",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/builtin.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 1,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/48ca7dce4fe1474820abc296824cda9e7824c159/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fbuiltin.ts",
            "raw_url": "https://github.com/angular/angular/raw/48ca7dce4fe1474820abc296824cda9e7824c159/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fbuiltin.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Fbuiltin.ts?ref=48ca7dce4fe1474820abc296824cda9e7824c159",
            "patch": "@@ -9,7 +9,7 @@\n import ts from 'typescript';\n \n import {DynamicValue} from './dynamic';\n-import {KnownFn, ResolvedValue, ResolvedValueArray} from './result';\n+import {EnumValue, KnownFn, ResolvedValue, ResolvedValueArray} from './result';\n \n export class ArraySliceBuiltinFn extends KnownFn {\n   constructor(private lhs: ResolvedValueArray) {\n@@ -45,6 +45,29 @@ export class ArrayConcatBuiltinFn extends KnownFn {\n   }\n }\n \n+export class StringConcatBuiltinFn extends KnownFn {\n+  constructor(private lhs: string) {\n+    super();\n+  }\n+\n+  override evaluate(node: ts.CallExpression, args: ResolvedValueArray): ResolvedValue {\n+    let result = this.lhs;\n+    for (const arg of args) {\n+      const resolved = arg instanceof EnumValue ? arg.resolved : arg;\n+\n+      if (typeof resolved === 'string' || typeof resolved === 'number' ||\n+          typeof resolved === 'boolean' || resolved == null) {\n+        // Cast to `any`, because `concat` will convert\n+        // anything to a string, but TS only allows strings.\n+        result = result.concat(resolved as any);\n+      } else {\n+        return DynamicValue.fromUnknown(node);\n+      }\n+    }\n+    return result;\n+  }\n+}\n+\n export class ObjectAssignBuiltinFn extends KnownFn {\n   override evaluate(node: ts.CallExpression, args: ResolvedValueArray): ResolvedValue {\n     if (args.length === 0) {"
        },
        {
            "sha": "f9e98509e8ff98e5b51370b8796c8921531d7a1c",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/src/interpreter.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/48ca7dce4fe1474820abc296824cda9e7824c159/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "raw_url": "https://github.com/angular/angular/raw/48ca7dce4fe1474820abc296824cda9e7824c159/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Fsrc%2Finterpreter.ts?ref=48ca7dce4fe1474820abc296824cda9e7824c159",
            "patch": "@@ -14,7 +14,7 @@ import {DependencyTracker} from '../../incremental/api';\n import {Declaration, DeclarationKind, DeclarationNode, EnumMember, FunctionDefinition, isConcreteDeclaration, ReflectionHost, SpecialDeclarationKind} from '../../reflection';\n import {isDeclaration} from '../../util/src/typescript';\n \n-import {ArrayConcatBuiltinFn, ArraySliceBuiltinFn} from './builtin';\n+import {ArrayConcatBuiltinFn, ArraySliceBuiltinFn, StringConcatBuiltinFn} from './builtin';\n import {DynamicValue} from './dynamic';\n import {ForeignFunctionResolver} from './interface';\n import {resolveKnownDeclaration} from './known_declaration';\n@@ -399,6 +399,8 @@ export class StaticInterpreter {\n         return DynamicValue.fromInvalidExpressionType(node, rhs);\n       }\n       return lhs[rhs];\n+    } else if (typeof lhs === 'string' && rhs === 'concat') {\n+      return new StringConcatBuiltinFn(lhs);\n     } else if (lhs instanceof Reference) {\n       const ref = lhs.node;\n       if (this.host.isClass(ref)) {"
        },
        {
            "sha": "83481e8e568b1149cae0e09396884200ccc6ed84",
            "filename": "packages/compiler-cli/src/ngtsc/partial_evaluator/test/evaluator_spec.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/48ca7dce4fe1474820abc296824cda9e7824c159/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/48ca7dce4fe1474820abc296824cda9e7824c159/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fpartial_evaluator%2Ftest%2Fevaluator_spec.ts?ref=48ca7dce4fe1474820abc296824cda9e7824c159",
            "patch": "@@ -533,6 +533,17 @@ runInEachFileSystem(() => {\n           .toBe('a.test.b');\n     });\n \n+    it('string `concat` function works', () => {\n+      expect(evaluate(`const a = '12', b = '34';`, 'a[\\'concat\\'](b)')).toBe('1234');\n+      expect(evaluate(`const a = '12', b = '3';`, 'a[\\'concat\\'](b)')).toBe('123');\n+      expect(evaluate(`const a = '12', b = '3', c = '45';`, 'a[\\'concat\\'](b,c)')).toBe('12345');\n+      expect(\n+          evaluate(`const a = '1', b = 2, c = '3', d = true, e = null;`, 'a[\\'concat\\'](b,c,d,e)'))\n+          .toBe('123truenull');\n+      expect(evaluate('enum Test { VALUE = \"test\" };', '\"a.\"[\\'concat\\'](Test.VALUE, \".b\")'))\n+          .toBe('a.test.b');\n+    });\n+\n     it('should resolve non-literals as dynamic string', () => {\n       const value = evaluate(`const a: any = [];`, '`a.${a}.b`');\n "
        }
    ],
    "stats": {
        "total": 40,
        "additions": 38,
        "deletions": 2
    }
}