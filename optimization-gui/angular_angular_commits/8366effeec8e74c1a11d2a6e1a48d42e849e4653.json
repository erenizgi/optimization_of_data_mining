{
    "author": "josephperrott",
    "message": "refactor(dev-infra): extract the commit message parsing function into its own file (#38429)\n\nExtracts the commit message parsing function into its own file.\n\nPR Close #38429",
    "sha": "8366effeec8e74c1a11d2a6e1a48d42e849e4653",
    "files": [
        {
            "sha": "333c62ba99488f116e0ce9e76511457724ff6d6a",
            "filename": "dev-infra/commit-message/BUILD.bazel",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2FBUILD.bazel?ref=8366effeec8e74c1a11d2a6e1a48d42e849e4653",
            "patch": "@@ -6,6 +6,7 @@ ts_library(\n     srcs = [\n         \"cli.ts\",\n         \"config.ts\",\n+        \"parse.ts\",\n         \"validate.ts\",\n         \"validate-file.ts\",\n         \"validate-range.ts\",\n@@ -23,9 +24,12 @@ ts_library(\n )\n \n ts_library(\n-    name = \"validate-test\",\n+    name = \"test_lib\",\n     testonly = True,\n-    srcs = [\"validate.spec.ts\"],\n+    srcs = [\n+        \"parse.spec.ts\",\n+        \"validate.spec.ts\",\n+    ],\n     deps = [\n         \":commit-message\",\n         \"//dev-infra/utils\",\n@@ -40,7 +44,6 @@ jasmine_node_test(\n     name = \"test\",\n     bootstrap = [\"//tools/testing:node_no_angular_es5\"],\n     deps = [\n-        \":commit-message\",\n-        \":validate-test\",\n+        \"test_lib\",\n     ],\n )"
        },
        {
            "sha": "71f4d6875b59654db0ab4bcacbf705c35cb060fc",
            "filename": "dev-infra/commit-message/parse.spec.ts",
            "status": "added",
            "additions": 85,
            "deletions": 0,
            "changes": 85,
            "blob_url": "https://github.com/angular/angular/blob/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fparse.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fparse.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fparse.spec.ts?ref=8366effeec8e74c1a11d2a6e1a48d42e849e4653",
            "patch": "@@ -0,0 +1,85 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {parseCommitMessage, ParsedCommitMessage} from './parse';\n+\n+\n+const commitValues = {\n+  prefix: '',\n+  type: 'fix',\n+  scope: 'changed-area',\n+  summary: 'This is a short summary of the change',\n+  body: 'This is a longer description of the change Closes #1',\n+};\n+\n+function buildCommitMessage(params = {}) {\n+  const {prefix, type, scope, summary, body} = {...commitValues, ...params};\n+  return `${prefix}${type}${scope ? '(' + scope + ')' : ''}: ${summary}\\n\\n${body}`;\n+}\n+\n+\n+describe('commit message parsing:', () => {\n+  it('parses the scope', () => {\n+    const message = buildCommitMessage();\n+    expect(parseCommitMessage(message).scope).toBe(commitValues.scope);\n+  });\n+\n+  it('parses the type', () => {\n+    const message = buildCommitMessage();\n+    expect(parseCommitMessage(message).type).toBe(commitValues.type);\n+  });\n+\n+  it('parses the header', () => {\n+    const message = buildCommitMessage();\n+    expect(parseCommitMessage(message).header)\n+        .toBe(`${commitValues.type}(${commitValues.scope}): ${commitValues.summary}`);\n+  });\n+\n+  it('parses the body', () => {\n+    const message = buildCommitMessage();\n+    expect(parseCommitMessage(message).body).toBe(commitValues.body);\n+  });\n+\n+  it('parses the body without Github linking', () => {\n+    const body = 'This has linking\\nCloses #1';\n+    const message = buildCommitMessage({body});\n+    expect(parseCommitMessage(message).bodyWithoutLinking).toBe('This has linking\\n');\n+  });\n+\n+  it('parses the subject', () => {\n+    const message = buildCommitMessage();\n+    expect(parseCommitMessage(message).subject).toBe(commitValues.summary);\n+  });\n+\n+  it('identifies if a commit is a fixup', () => {\n+    const message1 = buildCommitMessage();\n+    expect(parseCommitMessage(message1).isFixup).toBe(false);\n+\n+    const message2 = buildCommitMessage({prefix: 'fixup! '});\n+    expect(parseCommitMessage(message2).isFixup).toBe(true);\n+  });\n+\n+  it('identifies if a commit is a revert', () => {\n+    const message1 = buildCommitMessage();\n+    expect(parseCommitMessage(message1).isRevert).toBe(false);\n+\n+    const message2 = buildCommitMessage({prefix: 'revert: '});\n+    expect(parseCommitMessage(message2).isRevert).toBe(true);\n+\n+    const message3 = buildCommitMessage({prefix: 'revert '});\n+    expect(parseCommitMessage(message3).isRevert).toBe(true);\n+  });\n+\n+  it('identifies if a commit is a squash', () => {\n+    const message1 = buildCommitMessage();\n+    expect(parseCommitMessage(message1).isSquash).toBe(false);\n+\n+    const message2 = buildCommitMessage({prefix: 'squash! '});\n+    expect(parseCommitMessage(message2).isSquash).toBe(true);\n+  });\n+});"
        },
        {
            "sha": "f8acd0fb605315b05dcf3d13e9bcf231f4ae5004",
            "filename": "dev-infra/commit-message/parse.ts",
            "status": "added",
            "additions": 73,
            "deletions": 0,
            "changes": 73,
            "blob_url": "https://github.com/angular/angular/blob/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fparse.ts",
            "raw_url": "https://github.com/angular/angular/raw/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fparse.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fparse.ts?ref=8366effeec8e74c1a11d2a6e1a48d42e849e4653",
            "patch": "@@ -0,0 +1,73 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+/** A parsed commit message. */\n+export interface ParsedCommitMessage {\n+  header: string;\n+  body: string;\n+  bodyWithoutLinking: string;\n+  type: string;\n+  scope: string;\n+  subject: string;\n+  isFixup: boolean;\n+  isSquash: boolean;\n+  isRevert: boolean;\n+}\n+\n+/** Regex determining if a commit is a fixup. */\n+const FIXUP_PREFIX_RE = /^fixup! /i;\n+/** Regex finding all github keyword links. */\n+const GITHUB_LINKING_RE = /((closed?s?)|(fix(es)?(ed)?)|(resolved?s?))\\s\\#(\\d+)/ig;\n+/** Regex determining if a commit is a squash. */\n+const SQUASH_PREFIX_RE = /^squash! /i;\n+/** Regex determining if a commit is a revert. */\n+const REVERT_PREFIX_RE = /^revert:? /i;\n+/** Regex determining the scope of a commit if provided. */\n+const TYPE_SCOPE_RE = /^(\\w+)(?:\\(([^)]+)\\))?\\:\\s(.+)$/;\n+/** Regex determining the entire header line of the commit. */\n+const COMMIT_HEADER_RE = /^(.*)/i;\n+/** Regex determining the body of the commit. */\n+const COMMIT_BODY_RE = /^.*\\n\\n([\\s\\S]*)$/;\n+\n+/** Parse a full commit message into its composite parts. */\n+export function parseCommitMessage(commitMsg: string): ParsedCommitMessage {\n+  let header = '';\n+  let body = '';\n+  let bodyWithoutLinking = '';\n+  let type = '';\n+  let scope = '';\n+  let subject = '';\n+\n+  if (COMMIT_HEADER_RE.test(commitMsg)) {\n+    header = COMMIT_HEADER_RE.exec(commitMsg)![1]\n+                 .replace(FIXUP_PREFIX_RE, '')\n+                 .replace(SQUASH_PREFIX_RE, '');\n+  }\n+  if (COMMIT_BODY_RE.test(commitMsg)) {\n+    body = COMMIT_BODY_RE.exec(commitMsg)![1];\n+    bodyWithoutLinking = body.replace(GITHUB_LINKING_RE, '');\n+  }\n+\n+  if (TYPE_SCOPE_RE.test(header)) {\n+    const parsedCommitHeader = TYPE_SCOPE_RE.exec(header)!;\n+    type = parsedCommitHeader[1];\n+    scope = parsedCommitHeader[2];\n+    subject = parsedCommitHeader[3];\n+  }\n+  return {\n+    header,\n+    body,\n+    bodyWithoutLinking,\n+    type,\n+    scope,\n+    subject,\n+    isFixup: FIXUP_PREFIX_RE.test(commitMsg),\n+    isSquash: SQUASH_PREFIX_RE.test(commitMsg),\n+    isRevert: REVERT_PREFIX_RE.test(commitMsg),\n+  };\n+}"
        },
        {
            "sha": "2b29cf838224e5a45bd1619a4105ed79ad152208",
            "filename": "dev-infra/commit-message/validate-range.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fvalidate-range.ts",
            "raw_url": "https://github.com/angular/angular/raw/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fvalidate-range.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-range.ts?ref=8366effeec8e74c1a11d2a6e1a48d42e849e4653",
            "patch": "@@ -8,7 +8,8 @@\n import {info} from '../utils/console';\n import {exec} from '../utils/shelljs';\n \n-import {parseCommitMessage, validateCommitMessage, ValidateCommitMessageOptions} from './validate';\n+import {parseCommitMessage} from './parse';\n+import {validateCommitMessage, ValidateCommitMessageOptions} from './validate';\n \n // Whether the provided commit is a fixup commit.\n const isNonFixup = (m: string) => !parseCommitMessage(m).isFixup;"
        },
        {
            "sha": "fdc2f006c471a6b1b300b0d7744aacf4c8988d0d",
            "filename": "dev-infra/commit-message/validate.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 45,
            "changes": 47,
            "blob_url": "https://github.com/angular/angular/blob/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "raw_url": "https://github.com/angular/angular/raw/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate.ts?ref=8366effeec8e74c1a11d2a6e1a48d42e849e4653",
            "patch": "@@ -8,60 +8,17 @@\n import {error} from '../utils/console';\n \n import {getCommitMessageConfig} from './config';\n+import {parseCommitMessage} from './parse';\n \n /** Options for commit message validation. */\n export interface ValidateCommitMessageOptions {\n   disallowSquash?: boolean;\n   nonFixupCommitHeaders?: string[];\n }\n \n-const FIXUP_PREFIX_RE = /^fixup! /i;\n-const GITHUB_LINKING_RE = /((closed?s?)|(fix(es)?(ed)?)|(resolved?s?))\\s\\#(\\d+)/ig;\n-const SQUASH_PREFIX_RE = /^squash! /i;\n-const REVERT_PREFIX_RE = /^revert:? /i;\n-const TYPE_SCOPE_RE = /^(\\w+)(?:\\(([^)]+)\\))?\\:\\s(.+)$/;\n-const COMMIT_HEADER_RE = /^(.*)/i;\n-const COMMIT_BODY_RE = /^.*\\n\\n([\\s\\S]*)$/;\n+/** Regex matching a URL for an entire commit body line. */\n const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n \n-/** Parse a full commit message into its composite parts. */\n-export function parseCommitMessage(commitMsg: string) {\n-  let header = '';\n-  let body = '';\n-  let bodyWithoutLinking = '';\n-  let type = '';\n-  let scope = '';\n-  let subject = '';\n-\n-  if (COMMIT_HEADER_RE.test(commitMsg)) {\n-    header = COMMIT_HEADER_RE.exec(commitMsg)![1]\n-                 .replace(FIXUP_PREFIX_RE, '')\n-                 .replace(SQUASH_PREFIX_RE, '');\n-  }\n-  if (COMMIT_BODY_RE.test(commitMsg)) {\n-    body = COMMIT_BODY_RE.exec(commitMsg)![1];\n-    bodyWithoutLinking = body.replace(GITHUB_LINKING_RE, '');\n-  }\n-\n-  if (TYPE_SCOPE_RE.test(header)) {\n-    const parsedCommitHeader = TYPE_SCOPE_RE.exec(header)!;\n-    type = parsedCommitHeader[1];\n-    scope = parsedCommitHeader[2];\n-    subject = parsedCommitHeader[3];\n-  }\n-  return {\n-    header,\n-    body,\n-    bodyWithoutLinking,\n-    type,\n-    scope,\n-    subject,\n-    isFixup: FIXUP_PREFIX_RE.test(commitMsg),\n-    isSquash: SQUASH_PREFIX_RE.test(commitMsg),\n-    isRevert: REVERT_PREFIX_RE.test(commitMsg),\n-  };\n-}\n-\n /** Validate a commit message against using the local repo's config. */\n export function validateCommitMessage(\n     commitMsg: string, options: ValidateCommitMessageOptions = {}) {"
        },
        {
            "sha": "42afdd1c6fa2432d9ba660b869e26b28eb26a808",
            "filename": "dev-infra/pr/merge/strategies/api-merge.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts",
            "raw_url": "https://github.com/angular/angular/raw/8366effeec8e74c1a11d2a6e1a48d42e849e4653/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fpr%2Fmerge%2Fstrategies%2Fapi-merge.ts?ref=8366effeec8e74c1a11d2a6e1a48d42e849e4653",
            "patch": "@@ -9,7 +9,7 @@\n import {PullsListCommitsResponse, PullsMergeParams} from '@octokit/rest';\n import {prompt} from 'inquirer';\n \n-import {parseCommitMessage} from '../../../commit-message/validate';\n+import {parseCommitMessage} from '../../../commit-message/parse';\n import {GitClient} from '../../../utils/git';\n import {GithubApiMergeMethod} from '../config';\n import {PullRequestFailure} from '../failures';"
        }
    ],
    "stats": {
        "total": 221,
        "additions": 170,
        "deletions": 51
    }
}