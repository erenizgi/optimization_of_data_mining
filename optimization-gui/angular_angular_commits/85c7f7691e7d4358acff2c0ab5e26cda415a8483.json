{
    "author": "JoostK",
    "message": "fix(common): infer correct type when `trackBy` is used in `ngFor` (#41995)\n\nWhen a `trackBy` function is used that accepts a supertype of the iterated\narray's type, the loop variable would undesirably be inferred as the supertype\ninstead of the array's item type. This commit adds an inferred type parameter\nto `TrackByFunction` to allow an extra degree of freedom, enabling the\nloop value to be inferred as the most narrow type.\n\nFixes #40125\n\nPR Close #41995",
    "sha": "85c7f7691e7d4358acff2c0ab5e26cda415a8483",
    "files": [
        {
            "sha": "79aa358ef659b60319f2f94f92664a4a55f5f6ba",
            "filename": "goldens/public-api/core/core.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/85c7f7691e7d4358acff2c0ab5e26cda415a8483/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/85c7f7691e7d4358acff2c0ab5e26cda415a8483/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fpublic-api%2Fcore%2Fcore.d.ts?ref=85c7f7691e7d4358acff2c0ab5e26cda415a8483",
            "patch": "@@ -952,7 +952,7 @@ export declare class TestabilityRegistry {\n }\n \n export declare interface TrackByFunction<T> {\n-    (index: number, item: T): any;\n+    <U extends T>(index: number, item: U): any;\n }\n \n export declare const TRANSLATIONS: InjectionToken<string>;"
        },
        {
            "sha": "db86935d3d91a7898519ac359ac8d50a4d843473",
            "filename": "packages/compiler-cli/src/ngtsc/testing/fake_core/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/85c7f7691e7d4358acff2c0ab5e26cda415a8483/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Ffake_core%2Findex.ts",
            "raw_url": "https://github.com/angular/angular/raw/85c7f7691e7d4358acff2c0ab5e26cda415a8483/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Ffake_core%2Findex.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftesting%2Ffake_core%2Findex.ts?ref=85c7f7691e7d4358acff2c0ab5e26cda415a8483",
            "patch": "@@ -116,5 +116,5 @@ export interface OnDestroy {\n }\n \n export interface TrackByFunction<T> {\n-  (index: number, item: T): any;\n+  <U extends T>(index: number, item: U): any;\n }"
        },
        {
            "sha": "8a34d3e07b10fb0bc1ca9e13bb44521090e59f1b",
            "filename": "packages/compiler-cli/test/ngtsc/template_typecheck_spec.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/angular/angular/blob/85c7f7691e7d4358acff2c0ab5e26cda415a8483/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/85c7f7691e7d4358acff2c0ab5e26cda415a8483/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Ftest%2Fngtsc%2Ftemplate_typecheck_spec.ts?ref=85c7f7691e7d4358acff2c0ab5e26cda415a8483",
            "patch": "@@ -940,6 +940,43 @@ export declare class AnimationEvent {\n       env.driveMain();\n     });\n \n+    // https://github.com/angular/angular/issues/40125\n+    it('should accept NgFor iteration when trackBy is used with a wider type', () => {\n+      env.tsconfig({strictTemplates: true});\n+      env.write('test.ts', `\n+        import {CommonModule} from '@angular/common';\n+        import {Component, NgModule} from '@angular/core';\n+\n+        interface Base {\n+          id: string;\n+        }\n+\n+        interface Derived extends Base {\n+          name: string;\n+        }\n+\n+        @Component({\n+          selector: 'test',\n+          template: '<div *ngFor=\"let derived of derivedList; trackBy: trackByBase\">{{derived.name}}</div>',\n+        })\n+        class TestCmp {\n+          derivedList!: Derived[];\n+\n+          trackByBase(index: number, item: Base): string {\n+            return item.id;\n+          }\n+        }\n+\n+        @NgModule({\n+          declarations: [TestCmp],\n+          imports: [CommonModule],\n+        })\n+        class Module {}\n+    `);\n+\n+      env.driveMain();\n+    });\n+\n     it('should infer the context of NgFor', () => {\n       env.tsconfig({strictTemplates: true});\n       env.write('test.ts', `"
        },
        {
            "sha": "bd2c7543cff4da865124edab090beb0bc19d139a",
            "filename": "packages/core/src/change_detection/differs/iterable_differs.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/85c7f7691e7d4358acff2c0ab5e26cda415a8483/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts",
            "raw_url": "https://github.com/angular/angular/raw/85c7f7691e7d4358acff2c0ab5e26cda415a8483/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fchange_detection%2Fdiffers%2Fiterable_differs.ts?ref=85c7f7691e7d4358acff2c0ab5e26cda415a8483",
            "patch": "@@ -157,11 +157,17 @@ export interface IterableChangeRecord<V> {\n  * @publicApi\n  */\n export interface TrackByFunction<T> {\n+  // Note: the type parameter `U` enables more accurate template type checking in case a trackBy\n+  // function is declared using a base type of the iterated type. The `U` type gives TypeScript\n+  // additional freedom to infer a narrower type for the `item` parameter type, instead of imposing\n+  // the trackBy's declared item type as the inferred type for `T`.\n+  // See https://github.com/angular/angular/issues/40125\n+\n   /**\n    * @param index The index of the item within the iterable.\n    * @param item The item in the iterable.\n    */\n-  (index: number, item: T): any;\n+  <U extends T>(index: number, item: U): any;\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 46,
        "deletions": 3
    }
}