{
    "author": "atscott",
    "message": "Revert \"refactor(router): clean up internal hooks (#43804)\" (#43845)\n\nThis reverts commit 5cc51880db2f0905b456065f339fbc792ae2d03f.\n\nPR Close #43845",
    "sha": "892158f769143414be1370fde2b3cae71c478613",
    "files": [
        {
            "sha": "605a3035ab9302bea2f141c38404c7ece3cd4992",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/892158f769143414be1370fde2b3cae71c478613/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/892158f769143414be1370fde2b3cae71c478613/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=892158f769143414be1370fde2b3cae71c478613",
            "patch": "@@ -42,7 +42,7 @@\n     \"master\": {\n       \"uncompressed\": {\n         \"runtime\": 2843,\n-        \"main\": 237487,\n+        \"main\": 238453,\n         \"polyfills\": 37064,\n         \"src_app_lazy_lazy_module_ts\": 795\n       }\n@@ -68,4 +68,4 @@\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "06559de6d0e12229068c32cbd36206d4f3bdc0a2",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/892158f769143414be1370fde2b3cae71c478613/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/892158f769143414be1370fde2b3cae71c478613/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=892158f769143414be1370fde2b3cae71c478613",
            "patch": "@@ -1145,6 +1145,9 @@\n   {\n     \"name\": \"defaultMalformedUriErrorHandler\"\n   },\n+  {\n+    \"name\": \"defaultRouterHook\"\n+  },\n   {\n     \"name\": \"defaultScheduler\"\n   },"
        },
        {
            "sha": "20e5736e8c78b783f4888b652bf629ca20643511",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 3,
            "changes": 68,
            "blob_url": "https://github.com/angular/angular/blob/892158f769143414be1370fde2b3cae71c478613/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/892158f769143414be1370fde2b3cae71c478613/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=892158f769143414be1370fde2b3cae71c478613",
            "patch": "@@ -327,6 +327,30 @@ export interface NavigationTransition {\n   guardsResult: boolean|UrlTree|null;\n }\n \n+/**\n+ * @internal\n+ */\n+export type RouterHook = (snapshot: RouterStateSnapshot, runExtras: {\n+  appliedUrlTree: UrlTree,\n+  rawUrlTree: UrlTree,\n+  skipLocationChange: boolean,\n+  replaceUrl: boolean,\n+  navigationId: number\n+}) => Observable<void>;\n+\n+/**\n+ * @internal\n+ */\n+function defaultRouterHook(snapshot: RouterStateSnapshot, runExtras: {\n+  appliedUrlTree: UrlTree,\n+  rawUrlTree: UrlTree,\n+  skipLocationChange: boolean,\n+  replaceUrl: boolean,\n+  navigationId: number\n+}): Observable<void> {\n+  return of(null) as any;\n+}\n+\n /**\n  * The equivalent `IsActiveMatchOptions` options for `Router.isActive` is called with `true`\n  * (exact = true).\n@@ -463,12 +487,16 @@ export class Router {\n   private lastSuccessfulId: number = -1;\n \n   /**\n-   * Hook that enables you to pause navigation after the preactivation phase.\n+   * Hooks that enable you to pause navigation,\n+   * either before or after the preactivation phase.\n    * Used by `RouterModule`.\n    *\n    * @internal\n    */\n-  afterPreactivation: () => Observable<void> = () => of(void 0);\n+  hooks: {\n+    beforePreactivation: RouterHook,\n+    afterPreactivation: RouterHook\n+  } = {beforePreactivation: defaultRouterHook, afterPreactivation: defaultRouterHook};\n \n   /**\n    * A strategy for extracting and merging URLs.\n@@ -731,6 +759,24 @@ export class Router {\n                        }\n                      }),\n \n+                     // Before Preactivation\n+                     switchTap(t => {\n+                       const {\n+                         targetSnapshot,\n+                         id: navigationId,\n+                         extractedUrl: appliedUrlTree,\n+                         rawUrl: rawUrlTree,\n+                         extras: {skipLocationChange, replaceUrl}\n+                       } = t;\n+                       return this.hooks.beforePreactivation(targetSnapshot!, {\n+                         navigationId,\n+                         appliedUrlTree,\n+                         rawUrlTree,\n+                         skipLocationChange: !!skipLocationChange,\n+                         replaceUrl: !!replaceUrl,\n+                       });\n+                     }),\n+\n                      // --- GUARDS ---\n                      tap(t => {\n                        const guardsStart = new GuardsCheckStart(\n@@ -808,7 +854,23 @@ export class Router {\n                        return undefined;\n                      }),\n \n-                     switchTap(() => this.afterPreactivation()),\n+                     // --- AFTER PREACTIVATION ---\n+                     switchTap((t: NavigationTransition) => {\n+                       const {\n+                         targetSnapshot,\n+                         id: navigationId,\n+                         extractedUrl: appliedUrlTree,\n+                         rawUrl: rawUrlTree,\n+                         extras: {skipLocationChange, replaceUrl}\n+                       } = t;\n+                       return this.hooks.afterPreactivation(targetSnapshot!, {\n+                         navigationId,\n+                         appliedUrlTree,\n+                         rawUrlTree,\n+                         skipLocationChange: !!skipLocationChange,\n+                         replaceUrl: !!replaceUrl,\n+                       });\n+                     }),\n \n                      map((t: NavigationTransition) => {\n                        const targetRouterState = createRouterState("
        },
        {
            "sha": "6036a2efb49921683471d6bd81a0d55f2f39b1e5",
            "filename": "packages/router/src/router_module.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/892158f769143414be1370fde2b3cae71c478613/packages%2Frouter%2Fsrc%2Frouter_module.ts",
            "raw_url": "https://github.com/angular/angular/raw/892158f769143414be1370fde2b3cae71c478613/packages%2Frouter%2Fsrc%2Frouter_module.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter_module.ts?ref=892158f769143414be1370fde2b3cae71c478613",
            "patch": "@@ -527,7 +527,7 @@ export class RouterInitializer implements OnDestroy {\n       } else if (\n           // TODO: enabled is deprecated as of v11, can be removed in v13\n           opts.initialNavigation === 'enabled' || opts.initialNavigation === 'enabledBlocking') {\n-        router.afterPreactivation = () => {\n+        router.hooks.afterPreactivation = () => {\n           // only the initial navigation should be delayed\n           if (!this.initNavigation) {\n             this.initNavigation = true;\n@@ -536,7 +536,7 @@ export class RouterInitializer implements OnDestroy {\n \n             // subsequent navigations should not be delayed\n           } else {\n-            return of(void 0);\n+            return of(null) as any;\n           }\n         };\n         router.initialNavigation();\n@@ -567,7 +567,7 @@ export class RouterInitializer implements OnDestroy {\n     preloader.setUpPreloading();\n     routerScroller.init();\n     router.resetRootComponentType(ref.componentTypes[0]);\n-    this.resultOfPreactivationDone.next(void 0);\n+    this.resultOfPreactivationDone.next(null!);\n     this.resultOfPreactivationDone.complete();\n   }\n "
        },
        {
            "sha": "fbe0ad14e135764b0465bb3dd9e872e182c4701b",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 10,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/892158f769143414be1370fde2b3cae71c478613/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/892158f769143414be1370fde2b3cae71c478613/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=892158f769143414be1370fde2b3cae71c478613",
            "patch": "@@ -871,7 +871,7 @@ describe('Integration', () => {\n     });\n \n \n-    it('should eagerly update the URL with urlUpdateStrategy=\"eager\"',\n+    it('should eagerly update the URL with urlUpdateStrategy=\"eagar\"',\n        fakeAsync(inject([Router, Location], (router: Router, location: Location) => {\n          const fixture = TestBed.createComponent(RootCmp);\n          advance(fixture);\n@@ -885,21 +885,18 @@ describe('Integration', () => {\n          expect(fixture.nativeElement).toHaveText('team 22 [ , right:  ]');\n \n          router.urlUpdateStrategy = 'eager';\n-         router.events.subscribe(e => {\n-           if (!(e instanceof GuardsCheckStart)) {\n-             return;\n-           }\n+         (router as any).hooks.beforePreactivation = () => {\n            expect(location.path()).toEqual('/team/33');\n            expect(fixture.nativeElement).toHaveText('team 22 [ , right:  ]');\n            return of(null);\n-         });\n+         };\n          router.navigateByUrl('/team/33');\n \n          advance(fixture);\n          expect(fixture.nativeElement).toHaveText('team 33 [ , right:  ]');\n        })));\n \n-    it('should eagerly update the URL with urlUpdateStrategy=\"eager\"',\n+    it('should eagerly update the URL with urlUpdateStrategy=\"eagar\"',\n        fakeAsync(inject([Router, Location], (router: Router, location: Location) => {\n          const fixture = TestBed.createComponent(RootCmp);\n          advance(fixture);\n@@ -929,7 +926,7 @@ describe('Integration', () => {\n          expect(location.path()).toEqual('/login');\n        })));\n \n-    it('should set browserUrlTree with urlUpdateStrategy=\"eager\" and false `shouldProcessUrl`',\n+    it('should set browserUrlTree with urlUpdateStrategy=\"eagar\" and false `shouldProcessUrl`',\n        fakeAsync(inject([Router, Location], (router: Router, location: Location) => {\n          const fixture = TestBed.createComponent(RootCmp);\n          advance(fixture);\n@@ -956,7 +953,7 @@ describe('Integration', () => {\n          expect((router as any).browserUrlTree.toString()).toBe('/team/22');\n        })));\n \n-    it('should eagerly update URL after redirects are applied with urlUpdateStrategy=\"eager\"',\n+    it('should eagerly update URL after redirects are applied with urlUpdateStrategy=\"eagar\"',\n        fakeAsync(inject([Router, Location], (router: Router, location: Location) => {\n          const fixture = TestBed.createComponent(RootCmp);\n          advance(fixture);\n@@ -990,7 +987,7 @@ describe('Integration', () => {\n          expect(fixture.nativeElement).toHaveText('team 33 [ , right:  ]');\n        })));\n \n-    it('should set `state` with urlUpdateStrategy=\"eager\"',\n+    it('should set `state` with urlUpdateStrategy=\"eagar\"',\n        fakeAsync(inject([Router, Location], (router: Router, location: SpyLocation) => {\n          router.urlUpdateStrategy = 'eager';\n          router.resetConfig(["
        }
    ],
    "stats": {
        "total": 98,
        "additions": 80,
        "deletions": 18
    }
}