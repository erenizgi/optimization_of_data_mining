{
    "author": "mhevery",
    "message": "Revert \"fix(core): NgZone coaleascing options should trigger onStable correctly (#40540)\"\n\nThis reverts commit 22f9e454a46a8b017479d518bedd40efe1e7be2b.",
    "sha": "d754cc1ea56efc771867ac288e25a1968fd314fe",
    "files": [
        {
            "sha": "bb230c27f7fd77e3625bf3e628b9861d4bd488d4",
            "filename": "packages/core/src/zone/ng_zone.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 30,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/d754cc1ea56efc771867ac288e25a1968fd314fe/packages%2Fcore%2Fsrc%2Fzone%2Fng_zone.ts",
            "raw_url": "https://github.com/angular/angular/raw/d754cc1ea56efc771867ac288e25a1968fd314fe/packages%2Fcore%2Fsrc%2Fzone%2Fng_zone.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Fzone%2Fng_zone.ts?ref=d754cc1ea56efc771867ac288e25a1968fd314fe",
            "patch": "@@ -148,7 +148,6 @@ export class NgZone {\n         !shouldCoalesceRunChangeDetection && shouldCoalesceEventChangeDetection;\n     self.shouldCoalesceRunChangeDetection = shouldCoalesceRunChangeDetection;\n     self.lastRequestAnimationFrameId = -1;\n-    self.isCheckStableRunning = false;\n     self.nativeRequestAnimationFrame = getNativeRequestAnimationFrame().nativeRequestAnimationFrame;\n     forkInnerZoneWithAngularBehavior(self);\n   }\n@@ -244,17 +243,6 @@ interface NgZonePrivate extends NgZone {\n   hasPendingMacrotasks: boolean;\n   hasPendingMicrotasks: boolean;\n   lastRequestAnimationFrameId: number;\n-  /**\n-   * A flag to indicate if NgZone is currently inside\n-   * checkStable and to prevent re-entry. The flag is\n-   * needed because it is possible to invoke the change\n-   * detection from within change detection leading to\n-   * incorrect behavior.\n-   *\n-   * For detail, please refer here,\n-   * https://github.com/angular/angular/pull/40540\n-   */\n-  isCheckStableRunning: boolean;\n   isStable: boolean;\n   /**\n    * Optionally specify coalescing event change detections or not.\n@@ -303,9 +291,7 @@ interface NgZonePrivate extends NgZone {\n }\n \n function checkStable(zone: NgZonePrivate) {\n-  if (!zone.isCheckStableRunning && zone._nesting == 0 && !zone.hasPendingMicrotasks &&\n-      !zone.isStable) {\n-    zone.isCheckStableRunning = true;\n+  if (zone._nesting == 0 && !zone.hasPendingMicrotasks && !zone.isStable) {\n     try {\n       zone._nesting++;\n       zone.onMicrotaskEmpty.emit(null);\n@@ -318,26 +304,12 @@ function checkStable(zone: NgZonePrivate) {\n           zone.isStable = true;\n         }\n       }\n-      zone.isCheckStableRunning = false;\n     }\n   }\n }\n \n function delayChangeDetectionForEvents(zone: NgZonePrivate) {\n-  /**\n-   * We also need to check isCheckStableRunning here\n-   * Consider the following case with shouldCoalesceRunChangeDetection = true\n-   *\n-   * ngZone.run(() => {});\n-   * ngZone.run(() => {});\n-   *\n-   * We want the two `ngZone.run()` only trigger one change detection\n-   * when shouldCoalesceRunChangeDetection is true.\n-   * And because in this case, change detection run in async way(requestAnimationFrame),\n-   * so we also need to check the isCheckStableRunning here to prevent multiple\n-   * change detections.\n-   */\n-  if (zone.isCheckStableRunning || zone.lastRequestAnimationFrameId !== -1) {\n+  if (zone.lastRequestAnimationFrameId !== -1) {\n     return;\n   }\n   zone.lastRequestAnimationFrameId = zone.nativeRequestAnimationFrame.call(global, () => {"
        },
        {
            "sha": "3f11518a0e30485288fbe4b0be8c01405dffdb83",
            "filename": "packages/core/test/zone/ng_zone_spec.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 42,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/d754cc1ea56efc771867ac288e25a1968fd314fe/packages%2Fcore%2Ftest%2Fzone%2Fng_zone_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/d754cc1ea56efc771867ac288e25a1968fd314fe/packages%2Fcore%2Ftest%2Fzone%2Fng_zone_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fzone%2Fng_zone_spec.ts?ref=d754cc1ea56efc771867ac288e25a1968fd314fe",
            "patch": "@@ -982,7 +982,6 @@ function commonTests() {\n \n     describe('shouldCoalesceEventChangeDetection = true, shouldCoalesceRunChangeDetection = false', () => {\n       let nativeRequestAnimationFrame: (fn: FrameRequestCallback) => void;\n-      let nativeSetTimeout: any = (global as any)[Zone.__symbol__('setTimeout')];\n       if (!(global as any).requestAnimationFrame) {\n         nativeRequestAnimationFrame = function(fn: Function) {\n           (global as any)[Zone.__symbol__('setTimeout')](fn, 16);\n@@ -1043,32 +1042,6 @@ function commonTests() {\n            });\n          });\n \n-      it('should only emit onMicroTaskEmpty once within the same event loop for ngZone.run in onMicrotaskEmpty subscription',\n-         (done: DoneFn) => {\n-           const tasks: Task[] = [];\n-           coalesceZone.onMicrotaskEmpty.subscribe(() => {\n-             coalesceZone.run(() => {});\n-           });\n-           coalesceZone.run(() => {\n-             tasks.push(Zone.current.scheduleEventTask('myEvent', () => {\n-               logs.push('eventTask1');\n-             }, undefined, () => {}));\n-           });\n-           coalesceZone.run(() => {\n-             tasks.push(Zone.current.scheduleEventTask('myEvent', () => {\n-               logs.push('eventTask2');\n-             }, undefined, () => {}));\n-           });\n-           tasks.forEach(t => t.invoke());\n-           expect(logs).toEqual(['microTask empty', 'microTask empty', 'eventTask1', 'eventTask2']);\n-           nativeSetTimeout(() => {\n-             expect(logs).toEqual([\n-               'microTask empty', 'microTask empty', 'eventTask1', 'eventTask2', 'microTask empty'\n-             ]);\n-             done();\n-           }, 100);\n-         });\n-\n       it('should emit onMicroTaskEmpty once within the same event loop for not only event tasks, but event tasks are before other tasks',\n          (done: DoneFn) => {\n            const tasks: Task[] = [];\n@@ -1121,7 +1094,6 @@ function commonTests() {\n \n     describe('shouldCoalesceRunChangeDetection = true', () => {\n       let nativeRequestAnimationFrame: (fn: FrameRequestCallback) => void;\n-      let nativeSetTimeout: any = (global as any)[Zone.__symbol__('setTimeout')];\n       if (!(global as any).requestAnimationFrame) {\n         nativeRequestAnimationFrame = function(fn: Function) {\n           (global as any)[Zone.__symbol__('setTimeout')](fn, 16);\n@@ -1167,20 +1139,6 @@ function commonTests() {\n            });\n          });\n \n-      it('should only emit onMicroTaskEmpty once within the same event loop for ngZone.run in onMicrotaskEmpty subscription',\n-         (done: DoneFn) => {\n-           coalesceZone.onMicrotaskEmpty.subscribe(() => {\n-             coalesceZone.run(() => {});\n-           });\n-           coalesceZone.run(() => {});\n-           coalesceZone.run(() => {});\n-           expect(logs).toEqual([]);\n-           nativeSetTimeout(() => {\n-             expect(logs).toEqual(['microTask empty']);\n-             done();\n-           }, 100);\n-         });\n-\n       it('should only emit onMicroTaskEmpty once within the same event loop for multiple tasks',\n          (done: DoneFn) => {\n            const tasks: Task[] = [];"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 2,
        "deletions": 72
    }
}