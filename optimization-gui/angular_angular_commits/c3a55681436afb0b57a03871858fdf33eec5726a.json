{
    "author": "devversion",
    "message": "build: update symbol extractor to support IIFE bundles using arrow-functions (#44490)\n\nUpdates the symbol extractor to support IIFE bundles using\narrow-functions instead of function declarations. This is in preparation\nfor running symbol extraction tests with the overhauled optimization\npipeline for Angular v13, relying on ESBuild internally.\n\nAlso removes rollup-specific code that does not seem to be relevant\nanymore / rollup will be replaced anyway.\n\nPR Close #44490",
    "sha": "c3a55681436afb0b57a03871858fdf33eec5726a",
    "files": [
        {
            "sha": "37233e6959d66b8bceb4d4a4fb540bb837d13fbe",
            "filename": "tools/symbol-extractor/symbol_extractor.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 14,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/c3a55681436afb0b57a03871858fdf33eec5726a/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts",
            "raw_url": "https://github.com/angular/angular/raw/c3a55681436afb0b57a03871858fdf33eec5726a/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor.ts?ref=c3a55681436afb0b57a03871858fdf33eec5726a",
            "patch": "@@ -28,8 +28,10 @@ export class SymbolExtractor {\n       // Left for easier debugging.\n       // console.log('>>>', ts.SyntaxKind[child.kind]);\n       switch (child.kind) {\n+        case ts.SyntaxKind.ArrowFunction:\n         case ts.SyntaxKind.FunctionExpression:\n           fnRecurseDepth++;\n+          // Handles IIFE function/arrow expressions.\n           if (fnRecurseDepth <= 1) {\n             ts.forEachChild(child, visitor);\n           }\n@@ -53,9 +55,6 @@ export class SymbolExtractor {\n           if (fnRecurseDepth !== 0) {\n             symbols.push({name: stripSuffix(varDecl.name.getText())});\n           }\n-          if (fnRecurseDepth == 0 && isRollupExportSymbol(varDecl)) {\n-            ts.forEachChild(child, visitor);\n-          }\n           break;\n         case ts.SyntaxKind.FunctionDeclaration:\n           const funcDecl = child as ts.FunctionDeclaration;\n@@ -129,14 +128,3 @@ function stripSuffix(text: string): string {\n   const index = text.lastIndexOf('$');\n   return index > -1 ? text.substring(0, index) : text;\n }\n-\n-/**\n- * Detects if VariableDeclarationList is format `var ..., bundle = function(){}()`;\n- *\n- * Rollup produces this format when it wants to export symbols from a bundle.\n- * @param child\n- */\n-function isRollupExportSymbol(decl: ts.VariableDeclaration): boolean {\n-  return !!(decl.initializer && decl.initializer.kind == ts.SyntaxKind.CallExpression) &&\n-      ts.isIdentifier(decl.name) && decl.name.text === 'bundle';\n-}"
        },
        {
            "sha": "c88847b81142f0570f2fc50d17b6246f30192844",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/iife_arrow_function.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/c3a55681436afb0b57a03871858fdf33eec5726a/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_arrow_function.js",
            "raw_url": "https://github.com/angular/angular/raw/c3a55681436afb0b57a03871858fdf33eec5726a/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_arrow_function.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_arrow_function.js?ref=c3a55681436afb0b57a03871858fdf33eec5726a",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+(() => {\n+  var Class = function() {}, fn = function() {};\n+})();"
        },
        {
            "sha": "db891ec9cfe7d0f38ac256113bc209ab02e66361",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/iife_arrow_function.json",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/c3a55681436afb0b57a03871858fdf33eec5726a/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_arrow_function.json",
            "raw_url": "https://github.com/angular/angular/raw/c3a55681436afb0b57a03871858fdf33eec5726a/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_arrow_function.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_arrow_function.json?ref=c3a55681436afb0b57a03871858fdf33eec5726a",
            "patch": "@@ -0,0 +1,8 @@\n+[\n+  {\n+    \"name\": \"Class\"\n+  },\n+  {\n+    \"name\": \"fn\"\n+  }\n+]"
        },
        {
            "sha": "5a76350aec8fb46a67617d6b6c100f4da0ef8ff2",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/iife_with_export.js",
            "status": "removed",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/angular/angular/blob/02bc4582ba72edb54a08a540269505161be0916f/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_with_export.js",
            "raw_url": "https://github.com/angular/angular/raw/02bc4582ba72edb54a08a540269505161be0916f/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_with_export.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_with_export.js?ref=02bc4582ba72edb54a08a540269505161be0916f",
            "patch": "@@ -1,28 +0,0 @@\n-/**\n- * @license\n- * Copyright Google LLC All Rights Reserved.\n- *\n- * Use of this source code is governed by an MIT-style license that can be\n- * found in the LICENSE file at https://angular.io/license\n- */\n-\n-/**\n- * Rollup exports symbols in this particular way. This test demonstrates that we can correctly read\n- * symbols.\n- */\n-var bundle = function(exports) {\n-  'use strict';\n-  // tslint:disable-next-line:no-console\n-  console.log('Hello, Alice in Wonderland');\n-  var A = function() {\n-    function A() {}\n-    A.prototype.a = function() {\n-      return document.a;\n-    };\n-    return A;\n-  }();\n-  // tslint:disable-next-line:no-console\n-  console.error(new A().a());\n-  exports.A = A;\n-  return exports;\n-}({});"
        },
        {
            "sha": "c09db23487d85ad6f517fabc078aef72306fa144",
            "filename": "tools/symbol-extractor/symbol_extractor_spec/iife_with_export.json",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/02bc4582ba72edb54a08a540269505161be0916f/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_with_export.json",
            "raw_url": "https://github.com/angular/angular/raw/02bc4582ba72edb54a08a540269505161be0916f/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_with_export.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/tools%2Fsymbol-extractor%2Fsymbol_extractor_spec%2Fiife_with_export.json?ref=02bc4582ba72edb54a08a540269505161be0916f",
            "patch": "@@ -1,3 +0,0 @@\n-[\n-  \"A\"\n-]\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 21,
        "deletions": 45
    }
}