{
    "author": "gkalpak",
    "message": "test(docs-infra): avoid unnecessary re-computations in `deploy-to-firebase.spec.js` (#39853)\n\nPreviously, the latest commit for branch may be computed multiple times\nin the `deploy-to-firebase.js` tests.\n\nThis commit avoids the unnecessary re-computations by computing the\nlatest commits for the necessary branches at the beginning and using the\ncomputed values throughout the tests.\n\nPR Close #39853",
    "sha": "ab4e9e1d52479b1f587501419aa7328b6ba8a435",
    "files": [
        {
            "sha": "dbe87d69a7181005abfab3a1a8c8f602a1bc0453",
            "filename": "aio/scripts/deploy-to-firebase.spec.js",
            "status": "modified",
            "additions": 26,
            "deletions": 17,
            "changes": 43,
            "blob_url": "https://github.com/angular/angular/blob/ab4e9e1d52479b1f587501419aa7328b6ba8a435/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "raw_url": "https://github.com/angular/angular/raw/ab4e9e1d52479b1f587501419aa7328b6ba8a435/aio%2Fscripts%2Fdeploy-to-firebase.spec.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Fscripts%2Fdeploy-to-firebase.spec.js?ref=ab4e9e1d52479b1f587501419aa7328b6ba8a435",
            "patch": "@@ -6,6 +6,16 @@ const {computeDeploymentsInfo, computeInputVars, getLatestCommit} = require('./d\n \n \n describe('deploy-to-firebase:', () => {\n+  // Pre-computed latest commits to avoid unnecessary re-computations.\n+  const latestCommits = {\n+    master: getLatestCommit('master'),\n+    '2.1.x': getLatestCommit('2.1.x'),\n+    '2.4.x': getLatestCommit('2.4.x'),\n+    '4.3.x': getLatestCommit('4.3.x'),\n+    '4.4.x': getLatestCommit('4.4.x'),\n+    '9.1.x': getLatestCommit('9.1.x'),\n+  };\n+\n   // Helpers\n   const jsonFunctionReplacer = (_key, val) =>\n     (typeof val === 'function') ? `function:${val.name}` : val;\n@@ -57,7 +67,7 @@ describe('deploy-to-firebase:', () => {\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n-      CI_COMMIT: getLatestCommit('master'),\n+      CI_COMMIT: latestCommits.master,\n     })).toEqual([\n       {\n         deployEnv: 'next',\n@@ -82,7 +92,7 @@ describe('deploy-to-firebase:', () => {\n         skipped: true,\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-            `(${getLatestCommit('master')}).`,\n+            `(${latestCommits.master}).`,\n       },\n     ]);\n   });\n@@ -94,7 +104,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '4.3.x',\n-      CI_COMMIT: getLatestCommit('4.3.x'),\n+      CI_COMMIT: latestCommits['4.3.x'],\n     })).toEqual([\n       {\n         deployEnv: 'stable',\n@@ -120,7 +130,7 @@ describe('deploy-to-firebase:', () => {\n         skipped: true,\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-            `(${getLatestCommit('4.3.x')}).`,\n+            `(${latestCommits['4.3.x']}).`,\n       },\n     ]);\n   });\n@@ -132,7 +142,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '4.3.x',\n-      CI_COMMIT: getLatestCommit('2.4.x'),\n+      CI_COMMIT: latestCommits['2.4.x'],\n     })).toEqual([\n       {\n         deployEnv: 'archive',\n@@ -154,7 +164,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '9.1.x',\n       CI_STABLE_BRANCH: '10.0.x',\n-      CI_COMMIT: getLatestCommit('9.1.x'),\n+      CI_COMMIT: latestCommits['9.1.x'],\n     })).toEqual([\n       {\n         deployEnv: 'archive',\n@@ -180,7 +190,7 @@ describe('deploy-to-firebase:', () => {\n         skipped: true,\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-            `(${getLatestCommit('2.4.x')}).`,\n+            `(${latestCommits['2.4.x']}).`,\n       },\n     ]);\n   });\n@@ -192,7 +202,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '2.2.x',\n-      CI_COMMIT: getLatestCommit('2.1.x'),\n+      CI_COMMIT: latestCommits['2.1.x'],\n     })).toEqual([\n       {\n         skipped: true,\n@@ -210,7 +220,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '4.3.x',\n-      CI_COMMIT: getLatestCommit('2.1.x'),\n+      CI_COMMIT: latestCommits['2.1.x'],\n     })).toEqual([\n       {\n         skipped: true,\n@@ -228,7 +238,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n-      CI_COMMIT: getLatestCommit('4.4.x'),\n+      CI_COMMIT: latestCommits['4.4.x'],\n     })).toEqual([\n       {\n         deployEnv: 'rc',\n@@ -248,7 +258,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.4.x',\n       CI_STABLE_BRANCH: '2.2.x',\n-      CI_COMMIT: getLatestCommit('2.4.x'),\n+      CI_COMMIT: latestCommits['2.4.x'],\n     })).toEqual([\n       {\n         deployEnv: 'rc',\n@@ -274,7 +284,7 @@ describe('deploy-to-firebase:', () => {\n         skipped: true,\n         reason:\n             'Skipping deploy because DUMMY_TEST_COMMIT is not the latest commit ' +\n-            `(${getLatestCommit('2.4.x')}).`,\n+            `(${latestCommits['2.4.x']}).`,\n       },\n     ]);\n   });\n@@ -286,7 +296,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '2.1.x',\n       CI_STABLE_BRANCH: '2.0.x',\n-      CI_COMMIT: getLatestCommit('2.1.x'),\n+      CI_COMMIT: latestCommits['2.1.x'],\n     })).toEqual([\n       {\n         skipped: true,\n@@ -304,7 +314,7 @@ describe('deploy-to-firebase:', () => {\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: '4.3.x',\n       CI_STABLE_BRANCH: '2.4.x',\n-      CI_COMMIT: getLatestCommit('4.3.x'),\n+      CI_COMMIT: latestCommits['4.3.x'],\n     })).toEqual([\n       {\n         skipped: true,\n@@ -316,14 +326,13 @@ describe('deploy-to-firebase:', () => {\n   });\n \n   it('integration - should run the main script without error', () => {\n-    const commit = getLatestCommit('master');\n     const cmd = `\"${process.execPath}\" \"${__dirname}/deploy-to-firebase\" --dry-run`;\n     const env = {\n       CI_REPO_OWNER: 'angular',\n       CI_REPO_NAME: 'angular',\n       CI_PULL_REQUEST: 'false',\n       CI_BRANCH: 'master',\n-      CI_COMMIT: commit,\n+      CI_COMMIT: latestCommits.master,\n     };\n     const result = execSync(cmd, {encoding: 'utf8', env}).trim();\n     expect(result).toBe(\n@@ -334,7 +343,7 @@ describe('deploy-to-firebase:', () => {\n         'Deployment 1 of 1\\n' +\n         '-----------------\\n' +\n         'Git branch          : master\\n' +\n-        `Git commit          : ${commit}\\n` +\n+        `Git commit          : ${latestCommits.master}\\n` +\n         'Build/deploy mode   : next\\n' +\n         'Firebase project    : angular-io\\n' +\n         'Firebase site       : next-angular-io-site\\n' +"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 26,
        "deletions": 17
    }
}