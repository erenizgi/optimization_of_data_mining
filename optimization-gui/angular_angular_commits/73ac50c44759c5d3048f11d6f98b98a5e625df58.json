{
    "author": "devversion",
    "message": "feat(bazel): wire up partial compilation build setting in `ng_module` (#43431)\n\nWe created a build setting (bool flag) for controlling whether partial\ncompilation should be enabled or not. This commit wires up the build\nsetting so that all `ng_module` targets respect the flag.\n\nThis will later be useful when we apply the transition (which always\nsets the partial compilation flag to `True`).\n\nPR Close #43431",
    "sha": "73ac50c44759c5d3048f11d6f98b98a5e625df58",
    "files": [
        {
            "sha": "e7324f717bb51704136f5ce8de6dc463d60e82ee",
            "filename": "packages/bazel/src/ng_module/ng_module.bzl",
            "status": "modified",
            "additions": 36,
            "deletions": 6,
            "changes": 42,
            "blob_url": "https://github.com/angular/angular/blob/73ac50c44759c5d3048f11d6f98b98a5e625df58/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "raw_url": "https://github.com/angular/angular/raw/73ac50c44759c5d3048f11d6f98b98a5e625df58/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fbazel%2Fsrc%2Fng_module%2Fng_module.bzl?ref=73ac50c44759c5d3048f11d6f98b98a5e625df58",
            "patch": "@@ -5,6 +5,7 @@\n \"\"\"Run Angular's AOT template compiler\n \"\"\"\n \n+load(\"//packages/bazel/src/ng_module:partial_compilation.bzl\", \"NgPartialCompilationInfo\")\n load(\n     \"//packages/bazel/src:external.bzl\",\n     \"BuildSettingInfo\",\n@@ -39,6 +40,10 @@ def is_perf_requested(ctx):\n         fail(\"Angular View Engine does not support performance tracing\")\n     return enable_perf_logging\n \n+def _is_partial_compilation_enabled(ctx):\n+    \"\"\"Whether partial compilation is enabled for this target.\"\"\"\n+    return ctx.attr._partial_compilation_flag[NgPartialCompilationInfo].enabled\n+\n def is_ivy_enabled(ctx):\n     \"\"\"Determine if the ivy compiler should be used to by the ng_module.\n \n@@ -49,6 +54,10 @@ def is_ivy_enabled(ctx):\n       Boolean, Whether the ivy compiler should be used.\n     \"\"\"\n \n+    # If partial compilation is enabled through a build setting, always enable Ivy.\n+    if _is_partial_compilation_enabled(ctx):\n+        return True\n+\n     # Check the renderer flag to see if Ivy is enabled.\n     # This is intended to support a transition use case for google3 migration.\n     # The `_renderer` attribute will never be set externally, but will always be\n@@ -86,6 +95,10 @@ def _compiler_name(ctx):\n \n     return \"Ivy\" if is_ivy_enabled(ctx) else \"ViewEngine\"\n \n+def _get_ivy_compilation_mode(ctx):\n+    \"\"\"Gets the Ivy compilation mode based on the current build settings.\"\"\"\n+    return \"partial\" if _is_partial_compilation_enabled(ctx) else \"full\"\n+\n def _is_view_engine_enabled(ctx):\n     \"\"\"Determines whether Angular outputs will be produced by the current compilation strategy.\n \n@@ -319,6 +332,7 @@ def _generate_ve_shims(ctx):\n \n def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n     generate_ve_shims = _generate_ve_shims(ctx)\n+    compilation_mode = _get_ivy_compilation_mode(ctx)\n     outs = _expected_outs(ctx)\n     is_legacy_ngc = _is_view_engine_enabled(ctx)\n     if \"devmode_manifest\" in kwargs:\n@@ -354,6 +368,7 @@ def _ngc_tsconfig(ctx, files, srcs, **kwargs):\n         \"compilationMode\": ctx.attr.compilation_mode,\n         \"fullTemplateTypeCheck\": ctx.attr.type_check,\n         \"_extendedTemplateDiagnostics\": ctx.attr.experimental_extended_template_diagnostics,\n+        \"compilationMode\": compilation_mode,\n         # In Google3 we still want to use the symbol factory re-exports in order to\n         # not break existing apps inside Google. Unlike Bazel, Google3 does not only\n         # enforce strict dependencies of source files, but also for generated files\n@@ -440,7 +455,7 @@ def ngc_compile_action(\n         locale = None,\n         i18n_args = [],\n         dts_bundles_out = None,\n-        compile_mode = \"prodmode\"):\n+        target_flavor = \"prodmode\"):\n     \"\"\"Helper function to create the ngc action.\n \n     This is exposed for google3 to wire up i18n replay rules, and is not intended\n@@ -457,21 +472,31 @@ def ngc_compile_action(\n       locale: i18n locale, or None\n       i18n_args: additional command-line arguments to ngc\n       dts_bundles_out: produced flattened dts file\n+      target_flavor: Whether prodmode or devmode output is being built.\n \n     Returns:\n       the parameters of the compilation which will be used to replay the ngc action for i18N.\n     \"\"\"\n \n     is_legacy_ngc = _is_view_engine_enabled(ctx)\n \n+    if is_legacy_ngc:\n+        ngc_compilation_mode = target_flavor\n+    else:\n+        ngc_compilation_mode = \"%s %s\" % (_get_ivy_compilation_mode(ctx), target_flavor)\n+\n     mnemonic = \"AngularTemplateCompile\"\n-    progress_message = \"Compiling Angular templates (%s - %s) %s\" % (_compiler_name(ctx), compile_mode, label)\n+    progress_message = \"Compiling Angular templates (%s - %s) %s\" % (\n+        _compiler_name(ctx),\n+        ngc_compilation_mode,\n+        label,\n+    )\n \n     if locale:\n         mnemonic = \"AngularI18NMerging\"\n         supports_workers = \"0\"\n         progress_message = (\"Recompiling Angular templates (ngc - %s) %s for locale %s\" %\n-                            (compile_mode, label, locale))\n+                            (target_flavor, label, locale))\n     else:\n         supports_workers = str(int(ctx.attr._supports_workers))\n \n@@ -572,7 +597,7 @@ def _compile_action(\n         perf_out,\n         tsconfig_file,\n         node_opts,\n-        compile_mode):\n+        target_flavor):\n     # Give the Angular compiler all the user-listed assets\n     file_inputs = list(ctx.files.assets)\n \n@@ -610,7 +635,7 @@ def _compile_action(\n         ],\n     )\n \n-    return ngc_compile_action(ctx, ctx.label, action_inputs, outputs, messages_out, tsconfig_file, node_opts, None, [], dts_bundles_out, compile_mode)\n+    return ngc_compile_action(ctx, ctx.label, action_inputs, outputs, messages_out, tsconfig_file, node_opts, None, [], dts_bundle_out, target_flavor)\n \n def _prodmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n     outs = _expected_outs(ctx)\n@@ -619,7 +644,7 @@ def _prodmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n def _devmode_compile_action(ctx, inputs, outputs, tsconfig_file, node_opts):\n     outs = _expected_outs(ctx)\n     compile_action_outputs = outputs + outs.devmode_js + outs.declarations + outs.summaries + outs.metadata + outs.dev_perf_files\n-    _compile_action(ctx, inputs, compile_action_outputs, outs.dts_bundles, None, outs.dev_perf_files, tsconfig_file, node_opts, \"devmode\")\n+    _compile_action(ctx, inputs, compile_action_outputs, outs.dts_bundle, None, outs.dev_perf_files, tsconfig_file, node_opts, \"devmode\")\n \n def _ts_expected_outs(ctx, label, srcs_files = []):\n     # rules_typescript expects a function with two or more arguments, but our\n@@ -767,6 +792,11 @@ NG_MODULE_ATTRIBUTES = {\n         executable = True,\n         cfg = \"host\",\n     ),\n+    \"_partial_compilation_flag\": attr.label(\n+        default = \"//packages/bazel/src:partial_compilation\",\n+        providers = [NgPartialCompilationInfo],\n+        doc = \"Internal attribute which points to the partial compilation build setting.\",\n+    ),\n     # In the angular/angular monorepo, //tools:defaults.bzl wraps the ng_module rule in a macro\n     # which sets this attribute to the //packages/compiler-cli:ng_perf flag.\n     # This is done to avoid exposing the flag to user projects, which would require:"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 36,
        "deletions": 6
    }
}