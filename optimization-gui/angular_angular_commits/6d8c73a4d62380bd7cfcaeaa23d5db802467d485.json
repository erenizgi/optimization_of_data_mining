{
    "author": "mhevery",
    "message": "fix(core): Store the currently selected ICU in `LView` (#38345)\n\nThe currently selected ICU was incorrectly being stored it `TNode`\nrather than in `LView`.\n\nRemove: `TIcuContainerNode.activeCaseIndex`\nAdd: `LView[TIcu.currentCaseIndex]`\n\nPR Close #38345",
    "sha": "6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
    "files": [
        {
            "sha": "19530230df18f9cb568184e86586141027eab732",
            "filename": "goldens/size-tracking/integration-payloads.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/goldens%2Fsize-tracking%2Fintegration-payloads.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/goldens%2Fsize-tracking%2Fintegration-payloads.json?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -62,7 +62,7 @@\n         \"bundle\": \"TODO(i): we should define ngDevMode to false in Closure, but --define only works in the global scope.\",\n         \"bundle\": \"TODO(i): (FW-2164) TS 3.9 new class shape seems to have broken Closure in big ways. The size went from 169991 to 252338\",\n         \"bundle\": \"TODO(i): after removal of tsickle from ngc-wrapped / ng_package, we had to switch to SIMPLE optimizations which increased the size from 252338 to 1198917, see PR#37221 and PR#37317 for more info\",\n-        \"bundle\": 1213130\n+        \"bundle\": 1213769\n       }\n     }\n   }"
        },
        {
            "sha": "0968e054ad7dfcd6c17e85ff00ff1abefd409865",
            "filename": "packages/core/src/render3/bindings.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fbindings.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fbindings.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fbindings.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {devModeEqual} from '../change_detection/change_detection_util';\n-import {assertDataInRange, assertLessThan, assertNotSame} from '../util/assert';\n+import {assertIndexInRange, assertLessThan, assertNotSame} from '../util/assert';\n \n import {getExpressionChangedErrorDetails, throwErrorIfNoChangesMode} from './errors';\n import {LView} from './interfaces/view';\n@@ -24,7 +24,7 @@ export function updateBinding(lView: LView, bindingIndex: number, value: any): a\n \n /** Gets the current binding value. */\n export function getBinding(lView: LView, bindingIndex: number): any {\n-  ngDevMode && assertDataInRange(lView, bindingIndex);\n+  ngDevMode && assertIndexInRange(lView, bindingIndex);\n   ngDevMode &&\n       assertNotSame(lView[bindingIndex], NO_CHANGE, 'Stored value should never be NO_CHANGE.');\n   return lView[bindingIndex];"
        },
        {
            "sha": "0f411079a13f55ce05c550d29b17f444aec7d98a",
            "filename": "packages/core/src/render3/component.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fcomponent.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -11,7 +11,7 @@\n import {Type} from '../core';\n import {Injector} from '../di/injector';\n import {Sanitizer} from '../sanitization/sanitizer';\n-import {assertDataInRange} from '../util/assert';\n+import {assertIndexInRange} from '../util/assert';\n \n import {assertComponentType} from './assert';\n import {getComponentDef} from './definition';\n@@ -172,7 +172,7 @@ export function createRootComponentView(\n     rNode: RElement|null, def: ComponentDef<any>, rootView: LView,\n     rendererFactory: RendererFactory3, hostRenderer: Renderer3, sanitizer?: Sanitizer|null): LView {\n   const tView = rootView[TVIEW];\n-  ngDevMode && assertDataInRange(rootView, 0 + HEADER_OFFSET);\n+  ngDevMode && assertIndexInRange(rootView, 0 + HEADER_OFFSET);\n   rootView[0 + HEADER_OFFSET] = rNode;\n   const tNode: TElementNode = getOrCreateTNode(tView, null, 0, TNodeType.Element, null, null);\n   const mergedAttrs = tNode.mergedAttrs = def.hostAttrs;"
        },
        {
            "sha": "e7da73a2647a638fbc4df57f2ca2d09e2da03a85",
            "filename": "packages/core/src/render3/i18n.ts",
            "status": "modified",
            "additions": 127,
            "deletions": 67,
            "changes": 194,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fi18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fi18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fi18n.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -13,13 +13,13 @@ import {getTemplateContent, SRCSET_ATTRS, URI_ATTRS, VALID_ATTRS, VALID_ELEMENTS\n import {getInertBodyHelper} from '../sanitization/inert_body';\n import {_sanitizeUrl, sanitizeSrcset} from '../sanitization/url_sanitizer';\n import {addAllToArray} from '../util/array_utils';\n-import {assertDataInRange, assertDefined, assertEqual} from '../util/assert';\n+import {assertDefined, assertEqual, assertGreaterThan, assertIndexInRange} from '../util/assert';\n \n import {bindingUpdated} from './bindings';\n import {attachPatchData} from './context_discovery';\n import {i18nMutateOpCodesToString, i18nUpdateOpCodesToString} from './i18n_debug';\n import {setDelayProjection} from './instructions/all';\n-import {allocExpando, elementAttributeInternal, elementPropertyInternal, getOrCreateTNode, setInputsForProperty, setNgReflectProperties, textBindingInternal} from './instructions/shared';\n+import {allocExpando, elementAttributeInternal, elementPropertyInternal, getOrCreateTNode, setInputsForProperty, setNgReflectProperties, textBindingInternal as applyTextBinding} from './instructions/shared';\n import {LContainer, NATIVE} from './interfaces/container';\n import {getDocument} from './interfaces/document';\n import {COMMENT_MARKER, ELEMENT_MARKER, I18nMutateOpCode, I18nMutateOpCodes, I18nUpdateOpCode, I18nUpdateOpCodes, IcuType, TI18n, TIcu} from './interfaces/i18n';\n@@ -726,7 +726,7 @@ function i18nEndFirstPass(tView: TView, lView: LView) {\n   const lastCreatedNode = getPreviousOrParentTNode();\n \n   // Read the instructions to insert/move/remove DOM elements\n-  const visitedNodes = readCreateOpCodes(rootIndex, tI18n.create, tView, lView);\n+  const visitedNodes = applyCreateOpCodes(tView, rootIndex, tI18n.create, lView);\n \n   // Remove deleted nodes\n   let index = rootIndex + 1;\n@@ -756,7 +756,7 @@ function createDynamicNodeAtIndex(\n     tView: TView, lView: LView, index: number, type: TNodeType, native: RElement|RText|null,\n     name: string|null): TElementNode|TIcuContainerNode {\n   const previousOrParentTNode = getPreviousOrParentTNode();\n-  ngDevMode && assertDataInRange(lView, index + HEADER_OFFSET);\n+  ngDevMode && assertIndexInRange(lView, index + HEADER_OFFSET);\n   lView[index + HEADER_OFFSET] = native;\n   // FIXME(misko): Why does this create A TNode??? I would not expect this to be here.\n   const tNode = getOrCreateTNode(tView, lView[T_HOST], index, type as any, name, null);\n@@ -770,8 +770,16 @@ function createDynamicNodeAtIndex(\n   return tNode;\n }\n \n-function readCreateOpCodes(\n-    index: number, createOpCodes: I18nMutateOpCodes, tView: TView, lView: LView): number[] {\n+/**\n+ * Apply `I18nMutateOpCodes` OpCodes.\n+ *\n+ * @param tView Current `TView`\n+ * @param rootIndex Pointer to the root (parent) tNode for the i18n.\n+ * @param createOpCodes OpCodes to process\n+ * @param lView Current `LView`\n+ */\n+function applyCreateOpCodes(\n+    tView: TView, rootindex: number, createOpCodes: I18nMutateOpCodes, lView: LView): number[] {\n   const renderer = lView[RENDERER];\n   let currentTNode: TNode|null = null;\n   let previousTNode: TNode|null = null;\n@@ -792,7 +800,7 @@ function readCreateOpCodes(\n         case I18nMutateOpCode.AppendChild:\n           const destinationNodeIndex = opCode >>> I18nMutateOpCode.SHIFT_PARENT;\n           let destinationTNode: TNode;\n-          if (destinationNodeIndex === index) {\n+          if (destinationNodeIndex === rootindex) {\n             // If the destination node is `i18nStart`, we don't have a\n             // top-level node and we should use the host node instead\n             destinationTNode = lView[T_HOST]!;\n@@ -852,7 +860,6 @@ function readCreateOpCodes(\n               tView, lView, commentNodeIndex, TNodeType.IcuContainer, commentRNode, null);\n           visitedNodes.push(commentNodeIndex);\n           attachPatchData(commentRNode, lView);\n-          (currentTNode as TIcuContainerNode).activeCaseIndex = null;\n           // We will add the case nodes later, during the update phase\n           setIsNotParent();\n           break;\n@@ -881,16 +888,27 @@ function readCreateOpCodes(\n   return visitedNodes;\n }\n \n-function readUpdateOpCodes(\n-    updateOpCodes: I18nUpdateOpCodes, icus: TIcu[]|null, bindingsStartIndex: number,\n-    changeMask: number, tView: TView, lView: LView, bypassCheckBit: boolean) {\n+/**\n+ * Apply `I18nUpdateOpCodes` OpCodes\n+ *\n+ * @param tView Current `TView`\n+ * @param tIcus If ICUs present than this contains them.\n+ * @param lView Current `LView`\n+ * @param updateOpCodes OpCodes to process\n+ * @param bindingsStartIndex Location of the first `ɵɵi18nApply`\n+ * @param changeMask Each bit corresponds to a `ɵɵi18nExp` (Counting backwards from\n+ *     `bindingsStartIndex`)\n+ */\n+function applyUpdateOpCodes(\n+    tView: TView, tIcus: TIcu[]|null, lView: LView, updateOpCodes: I18nUpdateOpCodes,\n+    bindingsStartIndex: number, changeMask: number) {\n   let caseCreated = false;\n   for (let i = 0; i < updateOpCodes.length; i++) {\n     // bit code to check if we should apply the next update\n     const checkBit = updateOpCodes[i] as number;\n     // Number of opCodes to skip until next set of update codes\n     const skipCodes = updateOpCodes[++i] as number;\n-    if (bypassCheckBit || (checkBit & changeMask)) {\n+    if (checkBit & changeMask) {\n       // The value has been updated since last checked\n       let value = '';\n       for (let j = i + 1; j <= (i + skipCodes); j++) {\n@@ -912,16 +930,16 @@ function readUpdateOpCodes(\n                     sanitizeFn, false);\n                 break;\n               case I18nUpdateOpCode.Text:\n-                textBindingInternal(lView, nodeIndex, value);\n+                applyTextBinding(lView, nodeIndex, value);\n                 break;\n               case I18nUpdateOpCode.IcuSwitch:\n-                caseCreated = icuSwitchCase(\n-                    tView, updateOpCodes[++j] as number, nodeIndex, icus!, lView, value);\n+                caseCreated =\n+                    applyIcuSwitchCase(tView, tIcus!, updateOpCodes[++j] as number, lView, value);\n                 break;\n               case I18nUpdateOpCode.IcuUpdate:\n-                icuUpdateCase(\n-                    tView, lView, updateOpCodes[++j] as number, nodeIndex, bindingsStartIndex,\n-                    icus!, caseCreated);\n+                applyIcuUpdateCase(\n+                    tView, tIcus!, updateOpCodes[++j] as number, bindingsStartIndex, lView,\n+                    caseCreated);\n                 break;\n             }\n           }\n@@ -932,68 +950,100 @@ function readUpdateOpCodes(\n   }\n }\n \n-function icuUpdateCase(\n-    tView: TView, lView: LView, tIcuIndex: number, nodeIndex: number, bindingsStartIndex: number,\n-    tIcus: TIcu[], caseCreated: boolean) {\n+/**\n+ * Apply OpCodes associated with updating an existing ICU.\n+ *\n+ * @param tView Current `TView`\n+ * @param tIcus tIcus ICUs active at this location them.\n+ * @param tIcuIndex Index into `tIcus` to process.\n+ * @param bindingsStartIndex Location of the first `ɵɵi18nApply`\n+ * @param lView Current `LView`\n+ * @param changeMask Each bit corresponds to a `ɵɵi18nExp` (Counting backwards from\n+ *     `bindingsStartIndex`)\n+ */\n+function applyIcuUpdateCase(\n+    tView: TView, tIcus: TIcu[], tIcuIndex: number, bindingsStartIndex: number, lView: LView,\n+    caseCreated: boolean) {\n+  ngDevMode && assertIndexInRange(tIcus, tIcuIndex);\n   const tIcu = tIcus[tIcuIndex];\n-  const icuTNode = getTNode(tView, nodeIndex) as TIcuContainerNode;\n-  if (icuTNode.activeCaseIndex !== null) {\n-    readUpdateOpCodes(\n-        tIcu.update[icuTNode.activeCaseIndex], tIcus, bindingsStartIndex, changeMask, tView, lView,\n-        caseCreated);\n+  ngDevMode && assertIndexInRange(lView, tIcu.currentCaseLViewIndex);\n+  const activeCaseIndex = lView[tIcu.currentCaseLViewIndex];\n+  if (activeCaseIndex !== null) {\n+    const mask = caseCreated ?\n+        -1 :  // -1 is same as all bits on, which simulates creation since it marks all bits dirty\n+        changeMask;\n+    applyUpdateOpCodes(tView, tIcus, lView, tIcu.update[activeCaseIndex], bindingsStartIndex, mask);\n   }\n }\n \n-function icuSwitchCase(\n-    tView: TView, tIcuIndex: number, nodeIndex: number, tIcus: TIcu[], lView: LView,\n-    value: string): boolean {\n-  const tIcu = tIcus[tIcuIndex];\n-  const icuTNode = getTNode(tView, nodeIndex) as TIcuContainerNode;\n+/**\n+ * Apply OpCodes associated with switching a case on ICU.\n+ *\n+ * This involves tearing down existing case and than building up a new case.\n+ *\n+ * @param tView Current `TView`\n+ * @param tIcus ICUs active at this location.\n+ * @param tIcuIndex Index into `tIcus` to process.\n+ * @param lView Current `LView`\n+ * @param value Value of the case to update to.\n+ * @returns true if a new case was created (needed so that the update executes regardless of the\n+ *     bitmask)\n+ */\n+function applyIcuSwitchCase(\n+    tView: TView, tIcus: TIcu[], tIcuIndex: number, lView: LView, value: string): boolean {\n+  applyIcuSwitchCaseRemove(tView, tIcus, tIcuIndex, lView);\n+\n+  // Rebuild a new case for this ICU\n   let caseCreated = false;\n-  // If there is an active case, delete the old nodes\n-  if (icuTNode.activeCaseIndex !== null) {\n-    const removeCodes = tIcu.remove[icuTNode.activeCaseIndex];\n+  ngDevMode && assertIndexInRange(tIcus, tIcuIndex);\n+  const tIcu = tIcus[tIcuIndex];\n+  const caseIndex = getCaseIndex(tIcu, value);\n+  lView[tIcu.currentCaseLViewIndex] = caseIndex !== -1 ? caseIndex : null;\n+  if (caseIndex > -1) {\n+    // Add the nodes for the new case\n+    applyCreateOpCodes(\n+        tView, -1,  // -1 means we don't have parent node\n+        tIcu.create[caseIndex], lView);\n+    caseCreated = true;\n+  }\n+  return caseCreated;\n+}\n+\n+/**\n+ * Apply OpCodes associated with tearing down of DOM.\n+ *\n+ * This involves tearing down existing case and than building up a new case.\n+ *\n+ * @param tView Current `TView`\n+ * @param tIcus ICUs active at this location.\n+ * @param tIcuIndex Index into `tIcus` to process.\n+ * @param lView Current `LView`\n+ * @returns true if a new case was created (needed so that the update executes regardless of the\n+ *     bitmask)\n+ */\n+function applyIcuSwitchCaseRemove(tView: TView, tIcus: TIcu[], tIcuIndex: number, lView: LView) {\n+  ngDevMode && assertIndexInRange(tIcus, tIcuIndex);\n+  const tIcu = tIcus[tIcuIndex];\n+  const activeCaseIndex = lView[tIcu.currentCaseLViewIndex];\n+  if (activeCaseIndex !== null) {\n+    const removeCodes = tIcu.remove[activeCaseIndex];\n     for (let k = 0; k < removeCodes.length; k++) {\n       const removeOpCode = removeCodes[k] as number;\n       const nodeOrIcuIndex = removeOpCode >>> I18nMutateOpCode.SHIFT_REF;\n       switch (removeOpCode & I18nMutateOpCode.MASK_INSTRUCTION) {\n         case I18nMutateOpCode.Remove:\n+          // FIXME(misko): this comment is wrong!\n           // Remove DOM element, but do *not* mark TNode as detached, since we are\n           // just switching ICU cases (while keeping the same TNode), so a DOM element\n           // representing a new ICU case will be re-created.\n           removeNode(tView, lView, nodeOrIcuIndex, /* markAsDetached */ false);\n           break;\n         case I18nMutateOpCode.RemoveNestedIcu:\n-          removeNestedIcu(\n-              tView, tIcus, removeCodes, nodeOrIcuIndex,\n-              removeCodes[k + 1] as number >>> I18nMutateOpCode.SHIFT_REF);\n+          applyIcuSwitchCaseRemove(tView, tIcus, nodeOrIcuIndex, lView);\n           break;\n       }\n     }\n   }\n-\n-  // Update the active caseIndex\n-  const caseIndex = getCaseIndex(tIcu, value);\n-  icuTNode.activeCaseIndex = caseIndex !== -1 ? caseIndex : null;\n-  if (caseIndex > -1) {\n-    // Add the nodes for the new case\n-    readCreateOpCodes(\n-        -1 /* -1 means we don't have parent node */, tIcu.create[caseIndex], tView, lView);\n-    caseCreated = true;\n-  }\n-  return caseCreated;\n-}\n-\n-function removeNestedIcu(\n-    tView: TView, tIcus: TIcu[], removeCodes: I18nMutateOpCodes, nodeIndex: number,\n-    nestedIcuNodeIndex: number) {\n-  const nestedIcuTNode = getTNode(tView, nestedIcuNodeIndex) as TIcuContainerNode;\n-  const activeIndex = nestedIcuTNode.activeCaseIndex;\n-  if (activeIndex !== null) {\n-    const nestedTIcu = tIcus[nodeIndex];\n-    // FIXME(misko): the fact that we are adding items to parent list looks very suspect!\n-    addAllToArray(nestedTIcu.remove[activeIndex], removeCodes);\n-  }\n }\n \n function removeNode(tView: TView, lView: LView, index: number, markAsDetached: boolean) {\n@@ -1153,18 +1203,18 @@ export function ɵɵi18nApply(index: number) {\n   if (shiftsCounter) {\n     const tView = getTView();\n     ngDevMode && assertDefined(tView, `tView should be defined`);\n-    const tI18n = tView.data[index + HEADER_OFFSET];\n+    const tI18n = tView.data[index + HEADER_OFFSET] as TI18n | I18nUpdateOpCodes;\n     let updateOpCodes: I18nUpdateOpCodes;\n-    let icus: TIcu[]|null = null;\n+    let tIcus: TIcu[]|null = null;\n     if (Array.isArray(tI18n)) {\n       updateOpCodes = tI18n as I18nUpdateOpCodes;\n     } else {\n       updateOpCodes = (tI18n as TI18n).update;\n-      icus = (tI18n as TI18n).icus;\n+      tIcus = (tI18n as TI18n).icus;\n     }\n     const bindingsStartIndex = getBindingIndex() - shiftsCounter - 1;\n     const lView = getLView();\n-    readUpdateOpCodes(updateOpCodes, icus, bindingsStartIndex, changeMask, tView, lView, false);\n+    applyUpdateOpCodes(tView, tIcus, lView, updateOpCodes, bindingsStartIndex, changeMask);\n \n     // Reset changeMask & maskBit to default for the next update cycle\n     changeMask = 0b0;\n@@ -1215,9 +1265,10 @@ function icuStart(\n   const updateCodes: I18nUpdateOpCodes[] = [];\n   const vars = [];\n   const childIcus: number[][] = [];\n-  for (let i = 0; i < icuExpression.values.length; i++) {\n+  const values = icuExpression.values;\n+  for (let i = 0; i < values.length; i++) {\n     // Each value is an array of strings & other ICU expressions\n-    const valueArr = icuExpression.values[i];\n+    const valueArr = values[i];\n     const nestedIcus: IcuExpression[] = [];\n     for (let j = 0; j < valueArr.length; j++) {\n       const value = valueArr[j];\n@@ -1239,6 +1290,9 @@ function icuStart(\n   const tIcu: TIcu = {\n     type: icuExpression.type,\n     vars,\n+    currentCaseLViewIndex: HEADER_OFFSET +\n+        expandoStartIndex  // expandoStartIndex does not include the header so add it.\n+        + 1,               // The first item stored is the `<!--ICU #-->` anchor so skip it.\n     childIcus,\n     cases: icuExpression.cases,\n     create: createCodes,\n@@ -1269,7 +1323,13 @@ function parseIcuCase(\n     throw new Error('Unable to generate inert body element');\n   }\n   const wrapper = getTemplateContent(inertBodyElement!) as Element || inertBodyElement;\n-  const opCodes: IcuCase = {vars: 0, childIcus: [], create: [], remove: [], update: []};\n+  const opCodes: IcuCase = {\n+    vars: 1,  // allocate space for `TIcu.currentCaseLViewIndex`\n+    childIcus: [],\n+    create: [],\n+    remove: [],\n+    update: []\n+  };\n   if (ngDevMode) {\n     attachDebugGetter(opCodes.create, i18nMutateOpCodesToString);\n     attachDebugGetter(opCodes.remove, i18nMutateOpCodesToString);"
        },
        {
            "sha": "3eb585b93c6745797fe662e794534d494aa2cbe1",
            "filename": "packages/core/src/render3/instructions/advance.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fadvance.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fadvance.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fadvance.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {assertDataInRange, assertGreaterThan} from '../../util/assert';\n+import {assertGreaterThan, assertIndexInRange} from '../../util/assert';\n import {executeCheckHooks, executeInitAndCheckHooks} from '../hooks';\n import {FLAGS, HEADER_OFFSET, InitPhaseState, LView, LViewFlags, TView} from '../interfaces/view';\n import {getCheckNoChangesMode, getLView, getSelectedIndex, getTView, setSelectedIndex} from '../state';\n@@ -52,7 +52,7 @@ export function ɵɵselect(index: number): void {\n export function selectIndexInternal(\n     tView: TView, lView: LView, index: number, checkNoChangesMode: boolean) {\n   ngDevMode && assertGreaterThan(index, -1, 'Invalid index');\n-  ngDevMode && assertDataInRange(lView, index + HEADER_OFFSET);\n+  ngDevMode && assertIndexInRange(lView, index + HEADER_OFFSET);\n \n   // Flush the initial hooks for elements in the view that have been added up to this point.\n   // PERF WARNING: do NOT extract this to a separate function without running benchmarks"
        },
        {
            "sha": "aaa2f8e4feda9ff7120a8dd13ebd4e986d43dafb",
            "filename": "packages/core/src/render3/instructions/element.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {assertDataInRange, assertDefined, assertEqual} from '../../util/assert';\n+import {assertDefined, assertEqual, assertIndexInRange} from '../../util/assert';\n import {assertFirstCreatePass, assertHasParent} from '../assert';\n import {attachPatchData} from '../context_discovery';\n import {registerPostOrderHooks} from '../hooks';\n@@ -79,7 +79,7 @@ export function ɵɵelementStart(\n           getBindingIndex(), tView.bindingStartIndex,\n           'elements should be created before any bindings');\n   ngDevMode && ngDevMode.rendererCreateElement++;\n-  ngDevMode && assertDataInRange(lView, adjustedIndex);\n+  ngDevMode && assertIndexInRange(lView, adjustedIndex);\n \n   const renderer = lView[RENDERER];\n   const native = lView[adjustedIndex] = elementCreate(name, renderer, getNamespace());"
        },
        {
            "sha": "6a7a6ef7a434cac4903b70cbcd8268fe73a85f77",
            "filename": "packages/core/src/render3/instructions/element_container.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement_container.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement_container.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Felement_container.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -5,7 +5,7 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {assertDataInRange, assertEqual} from '../../util/assert';\n+import {assertEqual, assertIndexInRange} from '../../util/assert';\n import {assertHasParent} from '../assert';\n import {attachPatchData} from '../context_discovery';\n import {registerPostOrderHooks} from '../hooks';\n@@ -66,7 +66,7 @@ export function ɵɵelementContainerStart(\n   const tView = getTView();\n   const adjustedIndex = index + HEADER_OFFSET;\n \n-  ngDevMode && assertDataInRange(lView, adjustedIndex);\n+  ngDevMode && assertIndexInRange(lView, adjustedIndex);\n   ngDevMode &&\n       assertEqual(\n           getBindingIndex(), tView.bindingStartIndex,"
        },
        {
            "sha": "37b87667240c0f8556930ec474c361fe22f788b6",
            "filename": "packages/core/src/render3/instructions/listener.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flistener.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n \n-import {assertDataInRange} from '../../util/assert';\n+import {assertIndexInRange} from '../../util/assert';\n import {isObservable} from '../../util/lang';\n import {EMPTY_OBJ} from '../empty';\n import {PropertyAliasValue, TNode, TNodeFlags, TNodeType} from '../interfaces/node';\n@@ -204,7 +204,7 @@ function listenerInternal(\n     if (propsLength) {\n       for (let i = 0; i < propsLength; i += 2) {\n         const index = props[i] as number;\n-        ngDevMode && assertDataInRange(lView, index);\n+        ngDevMode && assertIndexInRange(lView, index);\n         const minifiedName = props[i + 1];\n         const directiveInstance = lView[index];\n         const output = directiveInstance[minifiedName];"
        },
        {
            "sha": "27bf8eeb9cfb5538f00a391103c2d044bb5d3412",
            "filename": "packages/core/src/render3/instructions/lview_debug.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 10,
            "changes": 25,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Flview_debug.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -362,19 +362,24 @@ export function toDebug(obj: any): any {\n  * (will not serialize child elements).\n  */\n function toHtml(value: any, includeChildren: boolean = false): string|null {\n-  const node: HTMLElement|null = unwrapRNode(value) as any;\n+  const node: Node|null = unwrapRNode(value) as any;\n   if (node) {\n-    const isTextNode = node.nodeType === Node.TEXT_NODE;\n-    const outerHTML = (isTextNode ? node.textContent : node.outerHTML) || '';\n-    if (includeChildren || isTextNode) {\n-      return outerHTML;\n-    } else {\n-      const innerHTML = '>' + node.innerHTML + '<';\n-      return (outerHTML.split(innerHTML)[0]) + '>';\n+    switch (node.nodeType) {\n+      case Node.TEXT_NODE:\n+        return node.textContent;\n+      case Node.COMMENT_NODE:\n+        return `<!--${(node as Comment).textContent}-->`;\n+      case Node.ELEMENT_NODE:\n+        const outerHTML = (node as Element).outerHTML;\n+        if (includeChildren) {\n+          return outerHTML;\n+        } else {\n+          const innerHTML = '>' + (node as Element).innerHTML + '<';\n+          return (outerHTML.split(innerHTML)[0]) + '>';\n+        }\n     }\n-  } else {\n-    return null;\n   }\n+  return null;\n }\n \n export class LViewDebug implements ILViewDebug {"
        },
        {
            "sha": "c707856b0f5e48f9f2c9cc1b84c679451d3e7964",
            "filename": "packages/core/src/render3/instructions/shared.ts",
            "status": "modified",
            "additions": 120,
            "deletions": 112,
            "changes": 232,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Fshared.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -12,7 +12,7 @@ import {CUSTOM_ELEMENTS_SCHEMA, NO_ERRORS_SCHEMA, SchemaMetadata} from '../../me\n import {ViewEncapsulation} from '../../metadata/view';\n import {validateAgainstEventAttributes, validateAgainstEventProperties} from '../../sanitization/sanitization';\n import {Sanitizer} from '../../sanitization/sanitizer';\n-import {assertDataInRange, assertDefined, assertDomNode, assertEqual, assertGreaterThan, assertLessThan, assertNotEqual, assertNotSame, assertSame} from '../../util/assert';\n+import {assertDefined, assertDomNode, assertEqual, assertGreaterThan, assertIndexInRange, assertLessThan, assertNotEqual, assertNotSame, assertSame} from '../../util/assert';\n import {createNamedArrayType} from '../../util/named_array_type';\n import {initNgDevMode} from '../../util/ng_dev_mode';\n import {normalizeDebugBindingName, normalizeDebugBindingValue} from '../../util/ng_reflect';\n@@ -236,13 +236,6 @@ export function getOrCreateTNode(\n   const tNode = tView.data[adjustedIndex] as TNode ||\n       createTNodeAtIndex(tView, tHostNode, adjustedIndex, type, name, attrs);\n   setPreviousOrParentTNode(tNode, true);\n-  if (ngDevMode) {\n-    // For performance reasons it is important that the tNode retains the same shape during runtime.\n-    // (To make sure that all of the code is monomorphic.) For this reason we seal the object to\n-    // prevent class transitions.\n-    // FIXME(misko): re-enable this once i18n code is compliant with this.\n-    // Object.seal(tNode);\n-  }\n   return tNode as TElementNode & TViewNode & TContainerNode & TElementContainerNode &\n       TProjectionNode & TIcuContainerNode;\n }\n@@ -665,44 +658,44 @@ export function createTView(\n   // that has a host binding, we will update the blueprint with that def's hostVars count.\n   const initialViewLength = bindingStartIndex + vars;\n   const blueprint = createViewBlueprint(bindingStartIndex, initialViewLength);\n-  return blueprint[TVIEW as any] = ngDevMode ?\n+  const tView = blueprint[TVIEW as any] = ngDevMode ?\n       new TViewConstructor(\n-             type,\n-             viewIndex,   // id: number,\n-             blueprint,   // blueprint: LView,\n-             templateFn,  // template: ComponentTemplate<{}>|null,\n-             null,        // queries: TQueries|null\n-             viewQuery,   // viewQuery: ViewQueriesFunction<{}>|null,\n-             null!,       // node: TViewNode|TElementNode|null,\n-             cloneToTViewData(blueprint).fill(null, bindingStartIndex),  // data: TData,\n-             bindingStartIndex,  // bindingStartIndex: number,\n-             initialViewLength,  // expandoStartIndex: number,\n-             null,               // expandoInstructions: ExpandoInstructions|null,\n-             true,               // firstCreatePass: boolean,\n-             true,               // firstUpdatePass: boolean,\n-             false,              // staticViewQueries: boolean,\n-             false,              // staticContentQueries: boolean,\n-             null,               // preOrderHooks: HookData|null,\n-             null,               // preOrderCheckHooks: HookData|null,\n-             null,               // contentHooks: HookData|null,\n-             null,               // contentCheckHooks: HookData|null,\n-             null,               // viewHooks: HookData|null,\n-             null,               // viewCheckHooks: HookData|null,\n-             null,               // destroyHooks: DestroyHookData|null,\n-             null,               // cleanup: any[]|null,\n-             null,               // contentQueries: number[]|null,\n-             null,               // components: number[]|null,\n-             typeof directives === 'function' ?\n-                 directives() :\n-                 directives,  // directiveRegistry: DirectiveDefList|null,\n-             typeof pipes === 'function' ? pipes() : pipes,  // pipeRegistry: PipeDefList|null,\n-             null,                                           // firstChild: TNode|null,\n-             schemas,                                        // schemas: SchemaMetadata[]|null,\n-             consts,                                         // consts: TConstants|null\n-             false,                                          // incompleteFirstPass: boolean\n-             decls,                                          // ngDevMode only: decls\n-             vars,                                           // ngDevMode only: vars\n-             ) :\n+          type,\n+          viewIndex,   // id: number,\n+          blueprint,   // blueprint: LView,\n+          templateFn,  // template: ComponentTemplate<{}>|null,\n+          null,        // queries: TQueries|null\n+          viewQuery,   // viewQuery: ViewQueriesFunction<{}>|null,\n+          null!,       // node: TViewNode|TElementNode|null,\n+          cloneToTViewData(blueprint).fill(null, bindingStartIndex),  // data: TData,\n+          bindingStartIndex,                                          // bindingStartIndex: number,\n+          initialViewLength,                                          // expandoStartIndex: number,\n+          null,   // expandoInstructions: ExpandoInstructions|null,\n+          true,   // firstCreatePass: boolean,\n+          true,   // firstUpdatePass: boolean,\n+          false,  // staticViewQueries: boolean,\n+          false,  // staticContentQueries: boolean,\n+          null,   // preOrderHooks: HookData|null,\n+          null,   // preOrderCheckHooks: HookData|null,\n+          null,   // contentHooks: HookData|null,\n+          null,   // contentCheckHooks: HookData|null,\n+          null,   // viewHooks: HookData|null,\n+          null,   // viewCheckHooks: HookData|null,\n+          null,   // destroyHooks: DestroyHookData|null,\n+          null,   // cleanup: any[]|null,\n+          null,   // contentQueries: number[]|null,\n+          null,   // components: number[]|null,\n+          typeof directives === 'function' ?\n+              directives() :\n+              directives,  // directiveRegistry: DirectiveDefList|null,\n+          typeof pipes === 'function' ? pipes() : pipes,  // pipeRegistry: PipeDefList|null,\n+          null,                                           // firstChild: TNode|null,\n+          schemas,                                        // schemas: SchemaMetadata[]|null,\n+          consts,                                         // consts: TConstants|null\n+          false,                                          // incompleteFirstPass: boolean\n+          decls,                                          // ngDevMode only: decls\n+          vars,                                           // ngDevMode only: vars\n+          ) :\n       {\n         type: type,\n         id: viewIndex,\n@@ -736,6 +729,13 @@ export function createTView(\n         consts: consts,\n         incompleteFirstPass: false\n       };\n+  if (ngDevMode) {\n+    // For performance reasons it is important that the tView retains the same shape during runtime.\n+    // (To make sure that all of the code is monomorphic.) For this reason we seal the object to\n+    // prevent class transitions.\n+    Object.seal(tView);\n+  }\n+  return tView;\n }\n \n function createViewBlueprint(bindingStartIndex: number, initialViewLength: number): LView {\n@@ -825,71 +825,79 @@ export function createTNode(\n     tagName: string|null, attrs: TAttributes|null): TNode {\n   ngDevMode && ngDevMode.tNode++;\n   let injectorIndex = tParent ? tParent.injectorIndex : -1;\n-  return ngDevMode ? new TNodeDebug(\n-                         tView,          // tView_: TView\n-                         type,           // type: TNodeType\n-                         adjustedIndex,  // index: number\n-                         injectorIndex,  // injectorIndex: number\n-                         -1,             // directiveStart: number\n-                         -1,             // directiveEnd: number\n-                         -1,             // directiveStylingLast: number\n-                         null,           // propertyBindings: number[]|null\n-                         0,              // flags: TNodeFlags\n-                         0,              // providerIndexes: TNodeProviderIndexes\n-                         tagName,        // tagName: string|null\n-                         attrs,  // attrs: (string|AttributeMarker|(string|SelectorFlags)[])[]|null\n-                         null,   // mergedAttrs\n-                         null,   // localNames: (string|number)[]|null\n-                         undefined,  // initialInputs: (string[]|null)[]|null|undefined\n-                         null,       // inputs: PropertyAliases|null\n-                         null,       // outputs: PropertyAliases|null\n-                         null,       // tViews: ITView|ITView[]|null\n-                         null,       // next: ITNode|null\n-                         null,       // projectionNext: ITNode|null\n-                         null,       // child: ITNode|null\n-                         tParent,    // parent: TElementNode|TContainerNode|null\n-                         null,       // projection: number|(ITNode|RNode[])[]|null\n-                         null,       // styles: string|null\n-                         null,       // stylesWithoutHost: string|null\n-                         undefined,  // residualStyles: string|null\n-                         null,       // classes: string|null\n-                         null,       // classesWithoutHost: string|null\n-                         undefined,  // residualClasses: string|null\n-                         0 as any,   // classBindings: TStylingRange;\n-                         0 as any,   // styleBindings: TStylingRange;\n-                         ) :\n-                     {\n-                       type: type,\n-                       index: adjustedIndex,\n-                       injectorIndex: injectorIndex,\n-                       directiveStart: -1,\n-                       directiveEnd: -1,\n-                       directiveStylingLast: -1,\n-                       propertyBindings: null,\n-                       flags: 0,\n-                       providerIndexes: 0,\n-                       tagName: tagName,\n-                       attrs: attrs,\n-                       mergedAttrs: null,\n-                       localNames: null,\n-                       initialInputs: undefined,\n-                       inputs: null,\n-                       outputs: null,\n-                       tViews: null,\n-                       next: null,\n-                       projectionNext: null,\n-                       child: null,\n-                       parent: tParent,\n-                       projection: null,\n-                       styles: null,\n-                       stylesWithoutHost: null,\n-                       residualStyles: undefined,\n-                       classes: null,\n-                       classesWithoutHost: null,\n-                       residualClasses: undefined,\n-                       classBindings: 0 as any,\n-                       styleBindings: 0 as any,\n-                     };\n+  const tNode = ngDevMode ?\n+      new TNodeDebug(\n+          tView,          // tView_: TView\n+          type,           // type: TNodeType\n+          adjustedIndex,  // index: number\n+          injectorIndex,  // injectorIndex: number\n+          -1,             // directiveStart: number\n+          -1,             // directiveEnd: number\n+          -1,             // directiveStylingLast: number\n+          null,           // propertyBindings: number[]|null\n+          0,              // flags: TNodeFlags\n+          0,              // providerIndexes: TNodeProviderIndexes\n+          tagName,        // tagName: string|null\n+          attrs,          // attrs: (string|AttributeMarker|(string|SelectorFlags)[])[]|null\n+          null,           // mergedAttrs\n+          null,           // localNames: (string|number)[]|null\n+          undefined,      // initialInputs: (string[]|null)[]|null|undefined\n+          null,           // inputs: PropertyAliases|null\n+          null,           // outputs: PropertyAliases|null\n+          null,           // tViews: ITView|ITView[]|null\n+          null,           // next: ITNode|null\n+          null,           // projectionNext: ITNode|null\n+          null,           // child: ITNode|null\n+          tParent,        // parent: TElementNode|TContainerNode|null\n+          null,           // projection: number|(ITNode|RNode[])[]|null\n+          null,           // styles: string|null\n+          null,           // stylesWithoutHost: string|null\n+          undefined,      // residualStyles: string|null\n+          null,           // classes: string|null\n+          null,           // classesWithoutHost: string|null\n+          undefined,      // residualClasses: string|null\n+          0 as any,       // classBindings: TStylingRange;\n+          0 as any,       // styleBindings: TStylingRange;\n+          ) :\n+      {\n+        type: type,\n+        index: adjustedIndex,\n+        injectorIndex: injectorIndex,\n+        directiveStart: -1,\n+        directiveEnd: -1,\n+        directiveStylingLast: -1,\n+        propertyBindings: null,\n+        flags: 0,\n+        providerIndexes: 0,\n+        tagName: tagName,\n+        attrs: attrs,\n+        mergedAttrs: null,\n+        localNames: null,\n+        initialInputs: undefined,\n+        inputs: null,\n+        outputs: null,\n+        tViews: null,\n+        next: null,\n+        projectionNext: null,\n+        child: null,\n+        parent: tParent,\n+        projection: null,\n+        styles: null,\n+        stylesWithoutHost: null,\n+        residualStyles: undefined,\n+        classes: null,\n+        classesWithoutHost: null,\n+        residualClasses: undefined,\n+        classBindings: 0 as any,\n+        styleBindings: 0 as any,\n+      };\n+  if (ngDevMode) {\n+    // For performance reasons it is important that the tNode retains the same shape during runtime.\n+    // (To make sure that all of the code is monomorphic.) For this reason we seal the object to\n+    // prevent class transitions.\n+    Object.seal(tNode);\n+  }\n+  return tNode;\n }\n \n \n@@ -2040,7 +2048,7 @@ export function setInputsForProperty(\n     const index = inputs[i++] as number;\n     const privateName = inputs[i++] as string;\n     const instance = lView[index];\n-    ngDevMode && assertDataInRange(lView, index);\n+    ngDevMode && assertIndexInRange(lView, index);\n     const def = tView.data[index] as DirectiveDef<any>;\n     if (def.setInput !== null) {\n       def.setInput!(instance, value, publicName, privateName);\n@@ -2055,7 +2063,7 @@ export function setInputsForProperty(\n  */\n export function textBindingInternal(lView: LView, index: number, value: string): void {\n   ngDevMode && assertNotSame(value, NO_CHANGE as any, 'value should not be NO_CHANGE');\n-  ngDevMode && assertDataInRange(lView, index + HEADER_OFFSET);\n+  ngDevMode && assertIndexInRange(lView, index + HEADER_OFFSET);\n   const element = getNativeByIndex(index, lView) as any as RText;\n   ngDevMode && assertDefined(element, 'native element should exist');\n   ngDevMode && ngDevMode.rendererSetText++;"
        },
        {
            "sha": "88a27e865673f462323bcb2337378141aeedbbca",
            "filename": "packages/core/src/render3/instructions/text.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Ftext.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Ftext.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finstructions%2Ftext.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -5,11 +5,12 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import {assertDataInRange, assertEqual} from '../../util/assert';\n+import {assertEqual, assertIndexInRange} from '../../util/assert';\n import {TElementNode, TNodeType} from '../interfaces/node';\n import {HEADER_OFFSET, RENDERER, T_HOST} from '../interfaces/view';\n import {appendChild, createTextNode} from '../node_manipulation';\n import {getBindingIndex, getLView, getTView, setPreviousOrParentTNode} from '../state';\n+\n import {getOrCreateTNode} from './shared';\n \n \n@@ -31,7 +32,7 @@ export function ɵɵtext(index: number, value: string = ''): void {\n       assertEqual(\n           getBindingIndex(), tView.bindingStartIndex,\n           'text nodes should be created before any bindings');\n-  ngDevMode && assertDataInRange(lView, adjustedIndex);\n+  ngDevMode && assertIndexInRange(lView, adjustedIndex);\n \n   const tNode = tView.firstCreatePass ?\n       getOrCreateTNode(tView, lView[T_HOST], index, TNodeType.Element, null, null) :"
        },
        {
            "sha": "7b85b495f5a21d0951acc3af457eabac071ecc46",
            "filename": "packages/core/src/render3/interfaces/i18n.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fi18n.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fi18n.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fi18n.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -346,6 +346,14 @@ export interface TIcu {\n    */\n   vars: number[];\n \n+  /**\n+   * Currently selected ICU case pointer.\n+   *\n+   * `lView[currentCaseLViewIndex]` stores the currently selected case. This is needed to know how\n+   * to clean up the current case when transitioning no the new case.\n+   */\n+  currentCaseLViewIndex: number;\n+\n   /**\n    * An optional array of child/sub ICUs.\n    *"
        },
        {
            "sha": "462105d2f47196e79cb0d22f96ac0ee9e6fa24e1",
            "filename": "packages/core/src/render3/interfaces/node.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Finterfaces%2Fnode.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -709,13 +709,6 @@ export interface TIcuContainerNode extends TNode {\n   parent: TElementNode|TElementContainerNode|null;\n   tViews: null;\n   projection: null;\n-  /**\n-   * Indicates the current active case for an ICU expression.\n-   * It is null when there is no active case.\n-   *\n-   */\n-  // FIXME(misko): This is at a wrong location as activeCase is `LView` (not `TView`) concern\n-  activeCaseIndex: number|null;\n }\n \n /** Static data for a view  */"
        },
        {
            "sha": "6db19df34d4bd3ed52bcdea2679e9dc4dce12f62",
            "filename": "packages/core/src/render3/pure_function.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fpure_function.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fpure_function.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fpure_function.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {assertDataInRange} from '../util/assert';\n+import {assertIndexInRange} from '../util/assert';\n import {bindingUpdated, bindingUpdated2, bindingUpdated3, bindingUpdated4, getBinding, updateBinding} from './bindings';\n import {LView} from './interfaces/view';\n import {getBindingRoot, getLView} from './state';\n@@ -287,7 +287,7 @@ export function ɵɵpureFunctionV(\n  * it to `undefined`.\n  */\n function getPureFunctionReturnValue(lView: LView, returnValueIndex: number) {\n-  ngDevMode && assertDataInRange(lView, returnValueIndex);\n+  ngDevMode && assertIndexInRange(lView, returnValueIndex);\n   const lastReturnValue = lView[returnValueIndex];\n   return lastReturnValue === NO_CHANGE ? undefined : lastReturnValue;\n }"
        },
        {
            "sha": "58e587703e405a4ef81241e52fc7fbfb67fa12f8",
            "filename": "packages/core/src/render3/query.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fquery.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -15,7 +15,7 @@ import {ElementRef as ViewEngine_ElementRef} from '../linker/element_ref';\n import {QueryList} from '../linker/query_list';\n import {TemplateRef as ViewEngine_TemplateRef} from '../linker/template_ref';\n import {ViewContainerRef} from '../linker/view_container_ref';\n-import {assertDataInRange, assertDefined, throwError} from '../util/assert';\n+import {assertDefined, assertIndexInRange, throwError} from '../util/assert';\n import {stringify} from '../util/stringify';\n \n import {assertFirstCreatePass, assertLContainer} from './assert';\n@@ -140,7 +140,7 @@ class TQueries_ implements TQueries {\n   }\n \n   getByIndex(index: number): TQuery {\n-    ngDevMode && assertDataInRange(this.queries, index);\n+    ngDevMode && assertIndexInRange(this.queries, index);\n     return this.queries[index];\n   }\n \n@@ -358,7 +358,7 @@ function materializeViewResults<T>(\n         // null as a placeholder\n         result.push(null);\n       } else {\n-        ngDevMode && assertDataInRange(tViewData, matchedNodeIdx);\n+        ngDevMode && assertIndexInRange(tViewData, matchedNodeIdx);\n         const tNode = tViewData[matchedNodeIdx] as TNode;\n         result.push(createResultForNode(lView, tNode, tQueryMatches[i + 1], tQuery.metadata.read));\n       }\n@@ -551,7 +551,7 @@ export function ɵɵloadQuery<T>(): QueryList<T> {\n function loadQueryInternal<T>(lView: LView, queryIndex: number): QueryList<T> {\n   ngDevMode &&\n       assertDefined(lView[QUERIES], 'LQueries should be defined when trying to load a query');\n-  ngDevMode && assertDataInRange(lView[QUERIES]!.queries, queryIndex);\n+  ngDevMode && assertIndexInRange(lView[QUERIES]!.queries, queryIndex);\n   return lView[QUERIES]!.queries[queryIndex].queryList;\n }\n "
        },
        {
            "sha": "d05bde5f93da63c8f88c71eae63c6ee29f43445f",
            "filename": "packages/core/src/render3/styling/style_binding_list.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fstyling%2Fstyle_binding_list.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Fstyling%2Fstyle_binding_list.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Fstyling%2Fstyle_binding_list.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -7,7 +7,7 @@\n  */\n \n import {KeyValueArray, keyValueArrayIndexOf} from '../../util/array_utils';\n-import {assertDataInRange, assertEqual, assertNotEqual} from '../../util/assert';\n+import {assertEqual, assertIndexInRange, assertNotEqual} from '../../util/assert';\n import {assertFirstUpdatePass} from '../assert';\n import {TNode} from '../interfaces/node';\n import {getTStylingRangeNext, getTStylingRangePrev, setTStylingRangeNext, setTStylingRangeNextDuplicate, setTStylingRangePrev, setTStylingRangePrevDuplicate, toTStylingRange, TStylingKey, TStylingKeyPrimitive, TStylingRange} from '../interfaces/styling';\n@@ -370,7 +370,7 @@ function markDuplicates(\n   // - we are a map in which case we have to continue searching even after we find what we were\n   //   looking for since we are a wild card and everything needs to be flipped to duplicate.\n   while (cursor !== 0 && (foundDuplicate === false || isMap)) {\n-    ngDevMode && assertDataInRange(tData, cursor);\n+    ngDevMode && assertIndexInRange(tData, cursor);\n     const tStylingValueAtCursor = tData[cursor] as TStylingKey;\n     const tStyleRangeAtCursor = tData[cursor + 1] as TStylingRange;\n     if (isStylingMatch(tStylingValueAtCursor, tStylingKey)) {"
        },
        {
            "sha": "4876a8a7d161cd473ef579435a9c1029631c266b",
            "filename": "packages/core/src/render3/util/view_utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fview_utils.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fview_utils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Frender3%2Futil%2Fview_utils.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import {assertDataInRange, assertDefined, assertDomNode, assertGreaterThan, assertLessThan} from '../../util/assert';\n+import {assertDefined, assertDomNode, assertGreaterThan, assertIndexInRange, assertLessThan} from '../../util/assert';\n import {assertTNodeForLView} from '../assert';\n import {LContainer, TYPE} from '../interfaces/container';\n import {LContext, MONKEY_PATCH_KEY_NAME} from '../interfaces/context';\n@@ -91,7 +91,7 @@ export function getNativeByIndex(index: number, lView: LView): RNode {\n  */\n export function getNativeByTNode(tNode: TNode, lView: LView): RNode {\n   ngDevMode && assertTNodeForLView(tNode, lView);\n-  ngDevMode && assertDataInRange(lView, tNode.index);\n+  ngDevMode && assertIndexInRange(lView, tNode.index);\n   const node: RNode = unwrapRNode(lView[tNode.index]);\n   ngDevMode && !isProceduralRenderer(lView[RENDERER]) && assertDomNode(node);\n   return node;\n@@ -125,13 +125,13 @@ export function getTNode(tView: TView, index: number): TNode {\n \n /** Retrieves a value from any `LView` or `TData`. */\n export function load<T>(view: LView|TData, index: number): T {\n-  ngDevMode && assertDataInRange(view, index + HEADER_OFFSET);\n+  ngDevMode && assertIndexInRange(view, index + HEADER_OFFSET);\n   return view[index + HEADER_OFFSET];\n }\n \n export function getComponentLViewByIndex(nodeIndex: number, hostView: LView): LView {\n   // Could be an LView or an LContainer. If LContainer, unwrap to find LView.\n-  ngDevMode && assertDataInRange(hostView, nodeIndex);\n+  ngDevMode && assertIndexInRange(hostView, nodeIndex);\n   const slotValue = hostView[nodeIndex];\n   const lView = isLView(slotValue) ? slotValue : slotValue[HOST];\n   return lView;"
        },
        {
            "sha": "1627149d561fb52de69bcbc8af32c00fb73b8913",
            "filename": "packages/core/src/util/assert.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Futil%2Fassert.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Fsrc%2Futil%2Fassert.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Fsrc%2Futil%2Fassert.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -110,7 +110,7 @@ export function assertDomNode(node: any): asserts node is Node {\n }\n \n \n-export function assertDataInRange(arr: any[], index: number) {\n+export function assertIndexInRange(arr: any[], index: number) {\n   const maxLen = arr ? arr.length : 0;\n   assertLessThan(index, maxLen, `Index expected to be less than ${maxLen} but got ${index}`);\n }"
        },
        {
            "sha": "ec106a8381de42d3d9c4730f9c89d36768d3d216",
            "filename": "packages/core/test/acceptance/i18n_spec.ts",
            "status": "modified",
            "additions": 269,
            "deletions": 6,
            "changes": 275,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Facceptance%2Fi18n_spec.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -14,7 +14,11 @@ import localeEs from '@angular/common/locales/es';\n import localeRo from '@angular/common/locales/ro';\n import {computeMsgId} from '@angular/compiler';\n import {Component, ContentChild, ContentChildren, Directive, ElementRef, HostBinding, Input, LOCALE_ID, NO_ERRORS_SCHEMA, Pipe, PipeTransform, QueryList, RendererFactory2, TemplateRef, Type, ViewChild, ViewContainerRef, ɵsetDocument} from '@angular/core';\n+import {getComponentDef} from '@angular/core/src/render3/definition';\n import {setDelayProjection} from '@angular/core/src/render3/instructions/projection';\n+import {TI18n, TIcu} from '@angular/core/src/render3/interfaces/i18n';\n+import {DebugNode, HEADER_OFFSET, TVIEW} from '@angular/core/src/render3/interfaces/view';\n+import {getComponentLView, loadLContext} from '@angular/core/src/render3/util/discovery_utils';\n import {TestBed} from '@angular/core/testing';\n import {clearTranslations, loadTranslations} from '@angular/localize';\n import {By, ɵDomRendererFactory2 as DomRendererFactory2} from '@angular/platform-browser';\n@@ -599,6 +603,217 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n     });\n   });\n \n+  describe('dynamic TNodes', () => {\n+    // When translation occurs the i18n system needs to create dynamic TNodes for the text\n+    // nodes so that they can be correctly processed by the `addRemoveViewFromContainer`.\n+\n+    function toTypeContent(n: DebugNode): string {\n+      return `${n.type}(${n.html})`;\n+    }\n+\n+    it('should not create dynamic TNode when no i18n', () => {\n+      const fixture = initWithTemplate(AppComp, `Hello <b>World</b>!`);\n+      const lView = getComponentLView(fixture.componentInstance);\n+      const hello_ = (fixture.nativeElement as Element).firstChild!;\n+      const b = hello_.nextSibling!;\n+      const world = b.firstChild!;\n+      const exclamation = b.nextSibling!;\n+      const lViewDebug = lView.debug!;\n+      expect(lViewDebug.nodes.map(toTypeContent)).toEqual([\n+        'Element(Hello )', 'Element(<b>)', 'Element(!)'\n+      ]);\n+      expect(lViewDebug.decls).toEqual({\n+        start: HEADER_OFFSET,\n+        end: HEADER_OFFSET + 4,\n+        length: 4,\n+        content: [\n+          jasmine.objectContaining({index: HEADER_OFFSET + 0, l: hello_}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 1, l: b}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 2, l: world}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 3, l: exclamation}),\n+        ]\n+      });\n+      expect(lViewDebug.i18n)\n+          .toEqual(\n+              {start: lViewDebug.vars.end, end: lViewDebug.expando.start, length: 0, content: []});\n+    });\n+\n+    it('should create dynamic TNode for text nodes', () => {\n+      const fixture =\n+          initWithTemplate(AppComp, `<ng-container i18n>Hello <b>World</b>!</ng-container>`);\n+      const lView = getComponentLView(fixture.componentInstance);\n+      const hello_ = (fixture.nativeElement as Element).firstChild!;\n+      const b = hello_.nextSibling!;\n+      const world = b.firstChild!;\n+      const exclamation = b.nextSibling!;\n+      const container = exclamation.nextSibling!;\n+      const lViewDebug = lView.debug!;\n+      expect(lViewDebug.nodes.map(toTypeContent)).toEqual([\n+        'ElementContainer(<!--ng-container-->)'\n+      ]);\n+      // This assertion shows that the translated nodes are correctly linked into the TNode tree.\n+      expect(lViewDebug.nodes[0].children.map(toTypeContent)).toEqual([\n+        'Element(Hello )', 'Element(<b>)', 'Element(!)'\n+      ]);\n+      // This assertion shows that the translated text is not part of decls\n+      expect(lViewDebug.decls).toEqual({\n+        start: HEADER_OFFSET,\n+        end: HEADER_OFFSET + 3,\n+        length: 3,\n+        content: [\n+          jasmine.objectContaining({index: HEADER_OFFSET + 0, l: container}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 1}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 2, l: b}),\n+        ]\n+      });\n+      // This assertion shows that the translated DOM elements (and corresponding TNode's are stored\n+      // in i18n section of LView)\n+      expect(lViewDebug.i18n).toEqual({\n+        start: lViewDebug.vars.end,\n+        end: lViewDebug.expando.start,\n+        length: 3,\n+        content: [\n+          jasmine.objectContaining({index: HEADER_OFFSET + 3, l: hello_}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 4, l: world}),\n+          jasmine.objectContaining({index: HEADER_OFFSET + 5, l: exclamation}),\n+        ]\n+      });\n+      // This assertion shows the DOM operations which the i18n subsystem performed to update the\n+      // DOM with translated text. The offsets in the debug text should match the offsets in the\n+      // above assertions.\n+      expect((lView[TVIEW]!.data[HEADER_OFFSET + 1]! as TI18n).create.debug).toEqual([\n+        'lView[3] = document.createTextNode(\"Hello \")',\n+        '(lView[0] as Element).appendChild(lView[3])',\n+        '(lView[0] as Element).appendChild(lView[2])',\n+        'lView[4] = document.createTextNode(\"World\")',\n+        '(lView[2] as Element).appendChild(lView[4])',\n+        'setPreviousOrParentTNode(tView.data[2] as TNode)',\n+        'lView[5] = document.createTextNode(\"!\")',\n+        '(lView[0] as Element).appendChild(lView[5])',\n+      ]);\n+    });\n+\n+    describe('ICU', () => {\n+      // In the case of ICUs we can't create TNodes for each ICU part, as different ICU instances\n+      // may have different selections active and hence have different shape. In such a case\n+      // a single `TIcuContainerNode` should be generated only.\n+      it('should create a single dynamic TNode for ICU', () => {\n+        const fixture = initWithTemplate(AppComp, `\n+          {count, plural, \n+            =0 {just now} \n+            =1 {one minute ago} \n+            other {{{count}} minutes ago}\n+          }\n+        `);\n+        const lView = getComponentLView(fixture.componentInstance);\n+        const lViewDebug = lView.debug!;\n+        expect((fixture.nativeElement as Element).textContent).toEqual('just now');\n+        const text_just_now = (fixture.nativeElement as Element).firstChild!;\n+        const icuComment = text_just_now.nextSibling!;\n+        expect(lViewDebug.nodes.map(toTypeContent)).toEqual(['IcuContainer(<!--ICU 3-->)']);\n+        // We want to ensure that the ICU container does not have any content!\n+        // This is because the content is instance dependent and therefore can't be shared\n+        // across `TNode`s.\n+        expect(lViewDebug.nodes[0].children.map(toTypeContent)).toEqual([\n+          'Element(just now)',  // FIXME(misko): This should not be here. The content of the ICU is\n+                                // instance specific and as such can't be encoded in the tNodes.\n+        ]);\n+        expect(lViewDebug.decls).toEqual({\n+          start: HEADER_OFFSET,\n+          end: HEADER_OFFSET + 1,\n+          length: 1,\n+          content: [\n+            jasmine.objectContaining({\n+              t: jasmine.objectContaining({\n+                vars: 3,  // one slot for: the `<!--ICU 3-->`\n+                          // one slot for: the last selected ICU case.\n+                          // one slot for: the actual text node to attach.\n+                create: jasmine.any(Object),\n+                update: jasmine.any(Object),\n+                icus: [jasmine.any(Object)],\n+              }),\n+              l: null\n+            }),\n+          ]\n+        });\n+        expect(((lViewDebug.decls.content[0].t as TI18n).create.debug)).toEqual([\n+          'lView[3] = document.createComment(\"ICU 3\")',\n+          '(lView[0] as Element).appendChild(lView[3])',\n+        ]);\n+        expect(((lViewDebug.decls.content[0].t as TI18n).update.debug)).toEqual([\n+          'if (mask & 0b1) { icuSwitchCase(lView[3] as Comment, 0, `${lView[1]}`); }',\n+          'if (mask & 0b11) { icuUpdateCase(lView[3] as Comment, 0); }',\n+        ]);\n+        const tIcu = (lViewDebug.decls.content[0].t as TI18n).icus![0];\n+        expect(tIcu.cases).toEqual(['0', '1', 'other']);\n+        // Case: '0'\n+        expect(tIcu.create[0].debug).toEqual([\n+          'lView[5] = document.createTextNode(\"just now\")',\n+          '(lView[3] as Element).appendChild(lView[5])',\n+        ]);\n+        expect(tIcu.remove[0].debug).toEqual(['(lView[0] as Element).remove(lView[5])']);\n+        expect(tIcu.update[0].debug).toEqual([]);\n+\n+        // Case: '1'\n+        expect(tIcu.create[1].debug).toEqual([\n+          'lView[5] = document.createTextNode(\"one minute ago\")',\n+          '(lView[3] as Element).appendChild(lView[5])',\n+        ]);\n+        expect(tIcu.remove[1].debug).toEqual(['(lView[0] as Element).remove(lView[5])']);\n+        expect(tIcu.update[1].debug).toEqual([]);\n+\n+        // Case: 'other'\n+        expect(tIcu.create[2].debug).toEqual([\n+          'lView[5] = document.createTextNode(\"\")',\n+          '(lView[3] as Element).appendChild(lView[5])',\n+        ]);\n+        expect(tIcu.remove[2].debug).toEqual(['(lView[0] as Element).remove(lView[5])']);\n+        expect(tIcu.update[2].debug).toEqual([\n+          'if (mask & 0b10) { (lView[5] as Text).textContent = `${lView[2]} minutes ago`; }'\n+        ]);\n+\n+        expect(lViewDebug.i18n).toEqual({\n+          start: lViewDebug.vars.end,\n+          end: lViewDebug.expando.start,\n+          length: 3,\n+          content: [\n+            // ICU anchor `<!--ICU 3-->`.\n+            jasmine.objectContaining({index: HEADER_OFFSET + 3, l: icuComment}),\n+            // ICU `TIcu.currentCaseLViewIndex` storage location\n+            jasmine.objectContaining({\n+              index: HEADER_OFFSET + 4,\n+              t: null,\n+              l: 0,  // The current ICU case\n+            }),\n+            jasmine.objectContaining({index: HEADER_OFFSET + 5, l: text_just_now}),\n+          ]\n+        });\n+      });\n+\n+      // FIXME(misko): re-enable and fix this use case.\n+      xit('should support multiple ICUs', () => {\n+        const fixture = initWithTemplate(AppComp, `\n+          {count, plural, \n+            =0 {just now} \n+            =1 {one minute ago} \n+            other {{{count}} minutes ago}\n+          }\n+          {count, plural, \n+            =0 {just now} \n+            =1 {one minute ago} \n+            other {{{count}} minutes ago}\n+          }\n+        `);\n+        const lView = getComponentLView(fixture.componentInstance);\n+        expect(lView.debug!.nodes.map(toTypeContent)).toEqual(['IcuContainer(<!--ICU 3-->)']);\n+        // We want to ensure that the ICU container does not have any content!\n+        // This is because the content is instance dependent and therefore can't be shared\n+        // across `TNode`s.\n+        expect(lView.debug!.nodes[0].children.map(toTypeContent)).toEqual([]);\n+      });\n+    });\n+  });\n+\n   describe('should support ICU expressions', () => {\n     it('with no root node', () => {\n       loadTranslations({\n@@ -690,19 +905,19 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n         other {({{name}})}\n       }</div>`);\n       expect(fixture.nativeElement.innerHTML)\n-          .toEqual(`<div>aucun <b>email</b>!<!--ICU 7--> - (Angular)<!--ICU 13--></div>`);\n+          .toEqual(`<div>aucun <b>email</b>!<!--ICU 7--> - (Angular)<!--ICU 14--></div>`);\n \n       fixture.componentRef.instance.count = 4;\n       fixture.detectChanges();\n       expect(fixture.nativeElement.innerHTML)\n           .toEqual(\n-              `<div>4 <span title=\"Angular\">emails</span><!--ICU 7--> - (Angular)<!--ICU 13--></div>`);\n+              `<div>4 <span title=\"Angular\">emails</span><!--ICU 7--> - (Angular)<!--ICU 14--></div>`);\n \n       fixture.componentRef.instance.count = 0;\n       fixture.componentRef.instance.name = 'John';\n       fixture.detectChanges();\n       expect(fixture.nativeElement.innerHTML)\n-          .toEqual(`<div>aucun <b>email</b>!<!--ICU 7--> - (John)<!--ICU 13--></div>`);\n+          .toEqual(`<div>aucun <b>email</b>!<!--ICU 7--> - (John)<!--ICU 14--></div>`);\n     });\n \n     it('with custom interpolation config', () => {\n@@ -740,20 +955,20 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n       }</span></div>`);\n       expect(fixture.nativeElement.innerHTML)\n           .toEqual(\n-              `<div><span>aucun <b>email</b>!<!--ICU 9--></span> - <span>(Angular)<!--ICU 15--></span></div>`);\n+              `<div><span>aucun <b>email</b>!<!--ICU 9--></span> - <span>(Angular)<!--ICU 16--></span></div>`);\n \n       fixture.componentRef.instance.count = 4;\n       fixture.detectChanges();\n       expect(fixture.nativeElement.innerHTML)\n           .toEqual(\n-              `<div><span>4 <span title=\"Angular\">emails</span><!--ICU 9--></span> - <span>(Angular)<!--ICU 15--></span></div>`);\n+              `<div><span>4 <span title=\"Angular\">emails</span><!--ICU 9--></span> - <span>(Angular)<!--ICU 16--></span></div>`);\n \n       fixture.componentRef.instance.count = 0;\n       fixture.componentRef.instance.name = 'John';\n       fixture.detectChanges();\n       expect(fixture.nativeElement.innerHTML)\n           .toEqual(\n-              `<div><span>aucun <b>email</b>!<!--ICU 9--></span> - <span>(John)<!--ICU 15--></span></div>`);\n+              `<div><span>aucun <b>email</b>!<!--ICU 9--></span> - <span>(John)<!--ICU 16--></span></div>`);\n     });\n \n     it('inside template directives', () => {\n@@ -1435,6 +1650,54 @@ onlyInIvy('Ivy i18n logic').describe('runtime i18n', () => {\n       // checking the second ICU case\n       expect(fixture.nativeElement.textContent.trim()).toBe('deux articles');\n     });\n+\n+    // FIXME(misko): re-enable and fix this use case. Root cause is that\n+    // `addRemoveViewFromContainer` needs to understand ICU\n+    xit('should handle select expressions without an `other` parameter inside a template', () => {\n+      const fixture = initWithTemplate(AppComp, `\n+        <ng-container *ngFor=\"let item of items\">{item.value, select, 0 {A} 1 {B} 2 {C}}</ng-container>\n+      `);\n+      fixture.componentInstance.items = [{value: 0}, {value: 1}, {value: 1337}];\n+      fixture.detectChanges();\n+      const p = fixture.nativeElement.querySelector('p');\n+      const lContext = loadLContext(p);\n+      const lView = lContext.lView;\n+      const nodeIndex = lContext.nodeIndex;\n+      const tView = lView[TVIEW];\n+      const i18n = tView.data[nodeIndex + 1] as unknown as TI18n;\n+      expect(fixture.nativeElement.textContent.trim()).toBe('AB');\n+\n+      fixture.componentInstance.items[0].value = 2;\n+      fixture.detectChanges();\n+      expect(fixture.nativeElement.textContent.trim()).toBe('CB');\n+      fail('testing');\n+    });\n+\n+    it('should render an element whose case did not match initially', () => {\n+      const fixture = initWithTemplate(AppComp, `\n+        <p *ngFor=\"let item of items\">{item.value, select, 0 {A} 1 {B} 2 {C}}</p>\n+      `);\n+      fixture.componentInstance.items = [{value: 0}, {value: 1}, {value: 1337}];\n+      fixture.detectChanges();\n+      expect(fixture.nativeElement.textContent.trim()).toBe('AB');\n+\n+      fixture.componentInstance.items[2].value = 2;\n+      fixture.detectChanges();\n+      expect(fixture.nativeElement.textContent.trim()).toBe('ABC');\n+    });\n+\n+    it('should remove an element whose case matched initially, but does not anymore', () => {\n+      const fixture = initWithTemplate(AppComp, `\n+        <p *ngFor=\"let item of items\">{item.value, select, 0 {A} 1 {B} 2 {C}}</p>\n+      `);\n+      fixture.componentInstance.items = [{value: 0}, {value: 1}];\n+      fixture.detectChanges();\n+      expect(fixture.nativeElement.textContent.trim()).toBe('AB');\n+\n+      fixture.componentInstance.items[0].value = 1337;\n+      fixture.detectChanges();\n+      expect(fixture.nativeElement.textContent.trim()).toBe('B');\n+    });\n   });\n \n   describe('should support attributes', () => {"
        },
        {
            "sha": "20f2df327223cea3f27aedcdcd6640637de09ee3",
            "filename": "packages/core/test/render3/i18n_spec.ts",
            "status": "modified",
            "additions": 56,
            "deletions": 53,
            "changes": 109,
            "blob_url": "https://github.com/angular/angular/blob/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Ftest%2Frender3%2Fi18n_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6d8c73a4d62380bd7cfcaeaa23d5db802467d485/packages%2Fcore%2Ftest%2Frender3%2Fi18n_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Frender3%2Fi18n_spec.ts?ref=6d8c73a4d62380bd7cfcaeaa23d5db802467d485",
            "patch": "@@ -261,7 +261,7 @@ describe('Runtime i18n', () => {\n                       }, null, nbConsts, index) as TI18n;\n \n       expect(opCodes).toEqual({\n-        vars: 5,\n+        vars: 6,\n         update: debugMatch([\n           'if (mask & 0b1) { icuSwitchCase(lView[1] as Comment, 0, `${lView[1]}`); }',\n           'if (mask & 0b11) { icuUpdateCase(lView[1] as Comment, 0); }',\n@@ -272,60 +272,61 @@ describe('Runtime i18n', () => {\n         ]),\n         icus: [<TIcu>{\n           type: 1,\n-          vars: [4, 3, 3],\n+          currentCaseLViewIndex: 22,\n+          vars: [5, 4, 4],\n           childIcus: [[], [], []],\n           cases: ['0', '1', 'other'],\n           create: [\n             debugMatch([\n-              'lView[2] = document.createTextNode(\"no \")',\n-              '(lView[1] as Element).appendChild(lView[2])',\n-              'lView[3] = document.createElement(\"b\")',\n+              'lView[3] = document.createTextNode(\"no \")',\n               '(lView[1] as Element).appendChild(lView[3])',\n-              '(lView[3] as Element).setAttribute(\"title\", \"none\")',\n-              'lView[4] = document.createTextNode(\"emails\")',\n-              '(lView[3] as Element).appendChild(lView[4])',\n-              'lView[5] = document.createTextNode(\"!\")',\n-              '(lView[1] as Element).appendChild(lView[5])'\n+              'lView[4] = document.createElement(\"b\")',\n+              '(lView[1] as Element).appendChild(lView[4])',\n+              '(lView[4] as Element).setAttribute(\"title\", \"none\")',\n+              'lView[5] = document.createTextNode(\"emails\")',\n+              '(lView[4] as Element).appendChild(lView[5])',\n+              'lView[6] = document.createTextNode(\"!\")',\n+              '(lView[1] as Element).appendChild(lView[6])',\n             ]),\n             debugMatch([\n-              'lView[2] = document.createTextNode(\"one \")',\n-              '(lView[1] as Element).appendChild(lView[2])',\n-              'lView[3] = document.createElement(\"i\")',\n+              'lView[3] = document.createTextNode(\"one \")',\n               '(lView[1] as Element).appendChild(lView[3])',\n-              'lView[4] = document.createTextNode(\"email\")',\n-              '(lView[3] as Element).appendChild(lView[4])'\n+              'lView[4] = document.createElement(\"i\")',\n+              '(lView[1] as Element).appendChild(lView[4])',\n+              'lView[5] = document.createTextNode(\"email\")',\n+              '(lView[4] as Element).appendChild(lView[5])',\n             ]),\n             debugMatch([\n-              'lView[2] = document.createTextNode(\"\")',\n-              '(lView[1] as Element).appendChild(lView[2])',\n-              'lView[3] = document.createElement(\"span\")',\n+              'lView[3] = document.createTextNode(\"\")',\n               '(lView[1] as Element).appendChild(lView[3])',\n-              'lView[4] = document.createTextNode(\"emails\")',\n-              '(lView[3] as Element).appendChild(lView[4])'\n+              'lView[4] = document.createElement(\"span\")',\n+              '(lView[1] as Element).appendChild(lView[4])',\n+              'lView[5] = document.createTextNode(\"emails\")',\n+              '(lView[4] as Element).appendChild(lView[5])',\n             ])\n           ],\n           remove: [\n             debugMatch([\n-              '(lView[0] as Element).remove(lView[2])',\n-              '(lView[0] as Element).remove(lView[4])',\n               '(lView[0] as Element).remove(lView[3])',\n               '(lView[0] as Element).remove(lView[5])',\n+              '(lView[0] as Element).remove(lView[4])',\n+              '(lView[0] as Element).remove(lView[6])',\n             ]),\n             debugMatch([\n-              '(lView[0] as Element).remove(lView[2])',\n-              '(lView[0] as Element).remove(lView[4])',\n               '(lView[0] as Element).remove(lView[3])',\n+              '(lView[0] as Element).remove(lView[5])',\n+              '(lView[0] as Element).remove(lView[4])',\n             ]),\n             debugMatch([\n-              '(lView[0] as Element).remove(lView[2])',\n-              '(lView[0] as Element).remove(lView[4])',\n               '(lView[0] as Element).remove(lView[3])',\n+              '(lView[0] as Element).remove(lView[5])',\n+              '(lView[0] as Element).remove(lView[4])',\n             ])\n           ],\n           update: [\n             debugMatch([]), debugMatch([]), debugMatch([\n-              'if (mask & 0b1) { (lView[2] as Text).textContent = `${lView[1]} `; }',\n-              'if (mask & 0b10) { (lView[3] as Element).setAttribute(\\'title\\', `${lView[2]}`); }'\n+              'if (mask & 0b1) { (lView[3] as Text).textContent = `${lView[1]} `; }',\n+              'if (mask & 0b10) { (lView[4] as Element).setAttribute(\\'title\\', `${lView[2]}`); }'\n             ])\n           ]\n         }]\n@@ -355,7 +356,7 @@ describe('Runtime i18n', () => {\n       const nestedTIcuIndex = 0;\n \n       expect(opCodes).toEqual({\n-        vars: 6,\n+        vars: 9,\n         create: debugMatch([\n           'lView[1] = document.createComment(\"ICU 1\")',\n           '(lView[0] as Element).appendChild(lView[1])'\n@@ -367,27 +368,28 @@ describe('Runtime i18n', () => {\n         icus: [\n           {\n             type: 0,\n-            vars: [1, 1, 1],\n+            vars: [2, 2, 2],\n+            currentCaseLViewIndex: 26,\n             childIcus: [[], [], []],\n             cases: ['cat', 'dog', 'other'],\n             create: [\n               debugMatch([\n-                'lView[5] = document.createTextNode(\"cats\")',\n-                '(lView[3] as Element).appendChild(lView[5])'\n+                'lView[7] = document.createTextNode(\"cats\")',\n+                '(lView[4] as Element).appendChild(lView[7])'\n               ]),\n               debugMatch([\n-                'lView[5] = document.createTextNode(\"dogs\")',\n-                '(lView[3] as Element).appendChild(lView[5])'\n+                'lView[7] = document.createTextNode(\"dogs\")',\n+                '(lView[4] as Element).appendChild(lView[7])'\n               ]),\n               debugMatch([\n-                'lView[5] = document.createTextNode(\"animals\")',\n-                '(lView[3] as Element).appendChild(lView[5])'\n+                'lView[7] = document.createTextNode(\"animals\")',\n+                '(lView[4] as Element).appendChild(lView[7])'\n               ]),\n             ],\n             remove: [\n-              debugMatch(['(lView[0] as Element).remove(lView[5])']),\n-              debugMatch(['(lView[0] as Element).remove(lView[5])']),\n-              debugMatch(['(lView[0] as Element).remove(lView[5])'])\n+              debugMatch(['(lView[0] as Element).remove(lView[7])']),\n+              debugMatch(['(lView[0] as Element).remove(lView[7])']),\n+              debugMatch(['(lView[0] as Element).remove(lView[7])'])\n             ],\n             update: [\n               debugMatch([]),\n@@ -397,36 +399,37 @@ describe('Runtime i18n', () => {\n           },\n           {\n             type: 1,\n-            vars: [1, 4],\n+            vars: [2, 6],\n             childIcus: [[], [0]],\n+            currentCaseLViewIndex: 22,\n             cases: ['0', 'other'],\n             create: [\n               debugMatch([\n-                'lView[2] = document.createTextNode(\"zero\")',\n-                '(lView[1] as Element).appendChild(lView[2])'\n+                'lView[3] = document.createTextNode(\"zero\")',\n+                '(lView[1] as Element).appendChild(lView[3])'\n               ]),\n               debugMatch([\n-                'lView[2] = document.createTextNode(\"\")',\n-                '(lView[1] as Element).appendChild(lView[2])',\n-                'lView[3] = document.createComment(\"nested ICU 0\")',\n+                'lView[3] = document.createTextNode(\"\")',\n                 '(lView[1] as Element).appendChild(lView[3])',\n-                'lView[4] = document.createTextNode(\"!\")',\n-                '(lView[1] as Element).appendChild(lView[4])'\n+                'lView[4] = document.createComment(\"nested ICU 0\")',\n+                '(lView[1] as Element).appendChild(lView[4])',\n+                'lView[5] = document.createTextNode(\"!\")',\n+                '(lView[1] as Element).appendChild(lView[5])'\n               ]),\n             ],\n             remove: [\n-              debugMatch(['(lView[0] as Element).remove(lView[2])']),\n+              debugMatch(['(lView[0] as Element).remove(lView[3])']),\n               debugMatch([\n-                '(lView[0] as Element).remove(lView[2])', '(lView[0] as Element).remove(lView[4])',\n-                'removeNestedICU(0)', '(lView[0] as Element).remove(lView[3])'\n+                '(lView[0] as Element).remove(lView[3])', '(lView[0] as Element).remove(lView[5])',\n+                'removeNestedICU(0)', '(lView[0] as Element).remove(lView[4])'\n               ]),\n             ],\n             update: [\n               debugMatch([]),\n               debugMatch([\n-                'if (mask & 0b1) { (lView[2] as Text).textContent = `${lView[1]} `; }',\n-                'if (mask & 0b10) { icuSwitchCase(lView[3] as Comment, 0, `${lView[2]}`); }',\n-                'if (mask & 0b10) { icuUpdateCase(lView[3] as Comment, 0); }'\n+                'if (mask & 0b1) { (lView[3] as Text).textContent = `${lView[1]} `; }',\n+                'if (mask & 0b10) { icuSwitchCase(lView[4] as Comment, 0, `${lView[2]}`); }',\n+                'if (mask & 0b10) { icuUpdateCase(lView[4] as Comment, 0); }'\n               ]),\n             ]\n           }"
        }
    ],
    "stats": {
        "total": 907,
        "additions": 624,
        "deletions": 283
    }
}