{
    "author": "gkalpak",
    "message": "build: make the build scripts for the various packages consistent (#41429)\n\nThis commit makes the build scripts for the various packages (framework,\n`@angular/dev-infra-private`, `angular-in-memory-web-api`, `zone.js`)\nconsistent. This makes it easier to maintain them (e.g. make similar\nchanges across all build scripts).\n\nPR Close #41429",
    "sha": "3c48037d244df2531480e480f44c11abb1f00e12",
    "files": [
        {
            "sha": "fadf9248b54267f7f35f79b668fec0b75634b4ed",
            "filename": "scripts/build/angular-in-memory-web-api.js",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fangular-in-memory-web-api.js",
            "raw_url": "https://github.com/angular/angular/raw/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fangular-in-memory-web-api.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fangular-in-memory-web-api.js?ref=3c48037d244df2531480e480f44c11abb1f00e12",
            "patch": "@@ -8,29 +8,42 @@\n \n 'use strict';\n \n-const {chmod, cp, mkdir, rm} = require('shelljs');\n+const {resolve} = require('path');\n+const {chmod, cp, mkdir, rm, test} = require('shelljs');\n const {baseDir, bazelBin, bazelCmd, exec, scriptPath} = require('./package-builder');\n \n+\n+module.exports = {\n+  buildAngularInMemoryWebApiPackage,\n+};\n+\n /**\n- * Build the `angular-in-memory-web-api` npm package and copy it to `dist/packages-dist/misc`.\n+ * Build the `angular-in-memory-web-api` npm package and copy it to `destDir` for other\n+ * scripts/tests to use.\n+ *\n+ * @param {string} destDir Path to the output directory into which we copy the npm package.\n+ *     This path should either be absolute or relative to the project root.\n  */\n-function buildAngularInMemoryWebAPIPackage() {\n+function buildAngularInMemoryWebApiPackage(destDir) {\n   console.info('##############################');\n   console.info(`${scriptPath}:`);\n   console.info('  Building angular-in-memory-web-api npm package');\n   console.info('##############################');\n   exec(`${bazelCmd} build //packages/misc/angular-in-memory-web-api:npm_package`);\n \n+  // Create the output directory.\n+  const absDestDir = resolve(baseDir, destDir);\n+  if (!test('-d', absDestDir)) {\n+    mkdir('-p', absDestDir);\n+  }\n+\n   const buildOutputDir = `${bazelBin}/packages/misc/angular-in-memory-web-api/npm_package`;\n-  const distTargetDir = `${baseDir}/dist/packages-dist/misc/angular-in-memory-web-api`;\n+  const distTargetDir = `${absDestDir}/angular-in-memory-web-api`;\n \n   console.info(`# Copy artifacts to ${distTargetDir}`);\n-  mkdir('-p', distTargetDir);\n   rm('-rf', distTargetDir);\n   cp('-R', buildOutputDir, distTargetDir);\n   chmod('-R', 'u+w', distTargetDir);\n \n   console.info('');\n }\n-\n-module.exports = {buildAngularInMemoryWebAPIPackage};"
        },
        {
            "sha": "517050abd51d5e6b5f20a48d8905f5331658bb29",
            "filename": "scripts/build/build-packages-dist.js",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/angular/angular/blob/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fbuild-packages-dist.js",
            "raw_url": "https://github.com/angular/angular/raw/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fbuild-packages-dist.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fbuild-packages-dist.js?ref=3c48037d244df2531480e480f44c11abb1f00e12",
            "patch": "@@ -9,22 +9,22 @@\n \n 'use strict';\n \n-const {buildZoneJsPackage} = require('./zone-js-builder');\n+const {buildAngularInMemoryWebApiPackage} = require('./angular-in-memory-web-api');\n const {buildDevInfraPackage} = require('./dev-infra-builder');\n const {buildTargetPackages} = require('./package-builder');\n-const {buildAngularInMemoryWebAPIPackage} = require('./angular-in-memory-web-api');\n+const {buildZoneJsPackage} = require('./zone-js-builder');\n \n \n // Build the legacy (view engine) npm packages into `dist/packages-dist/`.\n buildTargetPackages('dist/packages-dist', false, 'Production');\n \n+// Build the `angular-dev-infra` npm package into `dist/packages-dist/`.\n+buildDevInfraPackage('dist/packages-dist');\n+\n+// Build the `angular-in-memory-web-api` npm package into `dist/packages-dist/misc/`, because it\n+// might be needed by other scripts/targets.\n+buildAngularInMemoryWebApiPackage('dist/packages-dist/misc');\n+\n // Build the `zone.js` npm package into `dist/zone.js-dist/`, because it might be needed by other\n // scripts/tests.\n buildZoneJsPackage('dist/zone.js-dist');\n-\n-// Build the `angular-dev-infra` npm package into `dist/packages-dist/@angular/dev-infra-private`\n-buildDevInfraPackage();\n-\n-// Build the `angular-in-memory-web-api` npm package into\n-// `dist/packages-dist/misc/angular-in-memory-web-api`\n-buildAngularInMemoryWebAPIPackage();"
        },
        {
            "sha": "b83877dcf8af610985b600bf9c5b81a94eff7444",
            "filename": "scripts/build/dev-infra-builder.js",
            "status": "modified",
            "additions": 19,
            "deletions": 7,
            "changes": 26,
            "blob_url": "https://github.com/angular/angular/blob/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fdev-infra-builder.js",
            "raw_url": "https://github.com/angular/angular/raw/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fdev-infra-builder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fdev-infra-builder.js?ref=3c48037d244df2531480e480f44c11abb1f00e12",
            "patch": "@@ -8,29 +8,41 @@\n \n 'use strict';\n \n-const {chmod, cp, mkdir, rm} = require('shelljs');\n+const {resolve} = require('path');\n+const {chmod, cp, mkdir, rm, test} = require('shelljs');\n const {baseDir, bazelBin, bazelCmd, exec, scriptPath} = require('./package-builder');\n \n+\n+module.exports = {\n+  buildDevInfraPackage,\n+};\n+\n /**\n- * Build the `@angular/dev-infra-private` npm package and copies it to `dist/packages-dist`.\n+ * Build the `@angular/dev-infra-private` npm package into `destDir`.\n+ *\n+ * @param {string} destDir Path to the output directory into which we copy the npm package.\n+ *     This path should either be absolute or relative to the project root.\n  */\n-function buildDevInfraPackage() {\n+function buildDevInfraPackage(destDir) {\n   console.info('##############################');\n   console.info(`${scriptPath}:`);\n   console.info('  Building @angular/dev-infra-private npm package');\n   console.info('##############################');\n   exec(`${bazelCmd} build //dev-infra:npm_package`);\n \n+  // Create the output directory.\n+  const absDestDir = resolve(baseDir, destDir);\n+  if (!test('-d', absDestDir)) {\n+    mkdir('-p', absDestDir);\n+  }\n+\n   const buildOutputDir = `${bazelBin}/dev-infra/npm_package`;\n-  const distTargetDir = `${baseDir}/dist/packages-dist/dev-infra-private`;\n+  const distTargetDir = `${absDestDir}/dev-infra-private`;\n \n   console.info(`# Copy artifacts to ${distTargetDir}`);\n-  mkdir('-p', distTargetDir);\n   rm('-rf', distTargetDir);\n   cp('-R', buildOutputDir, distTargetDir);\n   chmod('-R', 'u+w', distTargetDir);\n \n   console.info('');\n }\n-\n-module.exports = {buildDevInfraPackage};"
        },
        {
            "sha": "6c735a3cf0c265bdecad8d87fb2088f3b73a7847",
            "filename": "scripts/build/package-builder.js",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fpackage-builder.js",
            "raw_url": "https://github.com/angular/angular/raw/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fpackage-builder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fpackage-builder.js?ref=3c48037d244df2531480e480f44c11abb1f00e12",
            "patch": "@@ -58,14 +58,14 @@ module.exports = {\n /**\n  * Build the Angular packages.\n  *\n- * @param {string} destPath Path to the output directory into which we copy the npm packages.\n+ * @param {string} destDir Path to the output directory into which we copy the npm packages.\n  * This path should either be absolute or relative to the project root.\n  * @param {boolean} enableIvy True, if Ivy should be used.\n  * @param {string} description Human-readable description of the build.\n  * @param {boolean?} isRelease True, if the build should be stamped for a release.\n  * @returns {Array<{name: string, outputPath: string}} A list of packages built.\n  */\n-function buildTargetPackages(destPath, enableIvy, description, isRelease = false) {\n+function buildTargetPackages(destDir, enableIvy, description, isRelease = false) {\n   console.info('##################################');\n   console.info(`${scriptPath}:`);\n   console.info('  Building @angular/* npm packages');\n@@ -87,15 +87,17 @@ function buildTargetPackages(destPath, enableIvy, description, isRelease = false\n       enableIvy ? 'ivy' : 'view-engine'} ${targets.join(' ')}`);\n \n   // Create the output directory.\n-  const absDestPath = resolve(baseDir, destPath);\n-  if (!test('-d', absDestPath)) mkdir('-p', absDestPath);\n+  const absDestDir = resolve(baseDir, destDir);\n+  if (!test('-d', absDestDir)) {\n+    mkdir('-p', absDestDir);\n+  }\n \n   targets.forEach(target => {\n     const pkg = target.replace(/\\/\\/packages\\/(.*):npm_package/, '$1');\n \n     // Skip any that don't have an \"npm_package\" target.\n     const srcDir = `${bazelBin}/packages/${pkg}/npm_package`;\n-    const destDir = `${absDestPath}/${pkg}`;\n+    const destDir = `${absDestDir}/${pkg}`;\n \n     if (test('-d', srcDir)) {\n       console.info(`# Copy artifacts to ${destDir}`);"
        },
        {
            "sha": "604b2eb7b0d11f47fe2a0189bf78f18d6570dd05",
            "filename": "scripts/build/zone-js-builder.js",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fzone-js-builder.js",
            "raw_url": "https://github.com/angular/angular/raw/3c48037d244df2531480e480f44c11abb1f00e12/scripts%2Fbuild%2Fzone-js-builder.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/scripts%2Fbuild%2Fzone-js-builder.js?ref=3c48037d244df2531480e480f44c11abb1f00e12",
            "patch": "@@ -20,40 +20,42 @@ module.exports = {\n \n /**\n  * Build the `zone.js` npm package into `dist/bin/packages/zone.js/npm_package/` and copy it to\n- * `destPath` for other scripts/tests to use.\n+ * `destDir` for other scripts/tests to use.\n  *\n  * NOTE: The `zone.js` package is not built as part of `package-builder`'s `buildTargetPackages()`\n  *       nor is it copied into the same directory as the Angular packages (e.g.\n  *       `dist/packages-dist/`) despite its source's being inside `packages/`, because it is not\n  *       published to npm under the `@angular` scope (as happens for the rest of the packages).\n  *\n- * @param {string} destPath Path to the output directory into which we copy the npm package.\n+ * @param {string} destDir Path to the output directory into which we copy the npm package.\n  *     This path should either be absolute or relative to the project root.\n  */\n-function buildZoneJsPackage(destPath) {\n+function buildZoneJsPackage(destDir) {\n   console.info('##############################');\n   console.info(`${scriptPath}:`);\n   console.info('  Building zone.js npm package');\n   console.info('##############################');\n   exec(`${bazelCmd} run //packages/zone.js:npm_package.pack`);\n \n   // Create the output directory.\n-  const absDestPath = resolve(baseDir, destPath);\n-  if (!test('-d', absDestPath)) mkdir('-p', absDestPath);\n+  const absDestDir = resolve(baseDir, destDir);\n+  if (!test('-d', absDestDir)) {\n+    mkdir('-p', absDestDir);\n+  }\n \n-  // Copy artifacts to `destPath`, so they can be easier persisted on CI and used by non-bazel\n+  // Copy artifacts to `destDir`, so they can be easier persisted on CI and used by non-bazel\n   // scripts/tests.\n   const buildOutputDir = `${bazelBin}/packages/zone.js/npm_package`;\n-  const distTargetDir = `${absDestPath}/zone.js`;\n+  const distTargetDir = `${absDestDir}/zone.js`;\n \n   console.info(`# Copy npm_package artifacts to ${distTargetDir}`);\n   rm('-rf', distTargetDir);\n   cp('-R', buildOutputDir, distTargetDir);\n   chmod('-R', 'u+w', distTargetDir);\n \n-  // Copy `zone.js.tgz` to `destPath`, so we can test\n+  // Copy `zone.js.tgz` to `destDir`, so we can test\n   // the archive generated by the `npm_package.pack` rule.\n-  const distArchiveTargetDir = `${absDestPath}/archive`;\n+  const distArchiveTargetDir = `${absDestDir}/archive`;\n   console.info(`# Copy npm_package archive file to ${distArchiveTargetDir}`);\n   rm('-rf', distArchiveTargetDir);\n   mkdir('-p', distArchiveTargetDir);"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 66,
        "deletions": 37
    }
}