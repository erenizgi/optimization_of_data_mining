{
    "author": "josephperrott",
    "message": "refactor(dev-infra): extract the parsing of a range of commits into a util function (#39726)\n\nA utility function to parse a range of commits allows for other tooling to assess\na range of commits.\n\nPR Close #39726",
    "sha": "7261e393f154dcfc4d2a828b9570200b6635425c",
    "files": [
        {
            "sha": "17c75c293597a69f918545804ff71a4f57b8c487",
            "filename": "dev-infra/commit-message/utils.ts",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/angular/angular/blob/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fcommit-message%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fcommit-message%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Futils.ts?ref=7261e393f154dcfc4d2a828b9570200b6635425c",
            "patch": "@@ -0,0 +1,38 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {exec} from '../utils/shelljs';\n+\n+import {parseCommitMessage, ParsedCommitMessage} from './parse';\n+\n+/** Retrieve and parse each commit message in a provide range. */\n+export function parseCommitMessagesForRange(range: string): ParsedCommitMessage[] {\n+  /** A random number used as a split point in the git log result. */\n+  const randomValueSeparator = `${Math.random()}`;\n+  /**\n+   * Custom git log format that provides the commit header and body, separated as expected with the\n+   * custom separator as the trailing value.\n+   */\n+  const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n+\n+  // Retrieve the commits in the provided range.\n+  const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n+  if (result.code) {\n+    throw new Error(`Failed to get all commits in the range:\\n  ${result.stderr}`);\n+  }\n+\n+  return result\n+      // Separate the commits from a single string into individual commits.\n+      .split(randomValueSeparator)\n+      // Remove extra space before and after each commit message.\n+      .map(l => l.trim())\n+      // Remove any superfluous lines which remain from the split.\n+      .filter(line => !!line)\n+      // Parse each commit message.\n+      .map(commit => parseCommitMessage(commit));\n+}"
        },
        {
            "sha": "bf609139b8eec6e3a660e602c638c0bf5e6339b9",
            "filename": "dev-infra/commit-message/validate-range/validate-range.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 32,
            "changes": 46,
            "blob_url": "https://github.com/angular/angular/blob/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fcommit-message%2Fvalidate-range%2Fvalidate-range.ts",
            "raw_url": "https://github.com/angular/angular/raw/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fcommit-message%2Fvalidate-range%2Fvalidate-range.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate-range%2Fvalidate-range.ts?ref=7261e393f154dcfc4d2a828b9570200b6635425c",
            "patch": "@@ -6,55 +6,37 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import {error, info} from '../../utils/console';\n-import {exec} from '../../utils/shelljs';\n \n-import {parseCommitMessage} from '../parse';\n+import {ParsedCommitMessage} from '../parse';\n+import {parseCommitMessagesForRange} from '../utils';\n import {printValidationErrors, validateCommitMessage, ValidateCommitMessageOptions} from '../validate';\n \n // Whether the provided commit is a fixup commit.\n-const isNonFixup = (m: string) => !parseCommitMessage(m).isFixup;\n+const isNonFixup = (commit: ParsedCommitMessage) => !commit.isFixup;\n \n // Extracts commit header (first line of commit message).\n-const extractCommitHeader = (m: string) => parseCommitMessage(m).header;\n+const extractCommitHeader = (commit: ParsedCommitMessage) => commit.header;\n \n /** Validate all commits in a provided git commit range. */\n export function validateCommitRange(range: string) {\n-  /**\n-   * A random value is used as a string to allow for a definite split point in the git log result.\n-   */\n-  const randomValueSeparator = `${Math.random()}`;\n-  /**\n-   * Custom git log format that provides the commit header and body, separated as expected with the\n-   * custom separator as the trailing value.\n-   */\n-  const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n-  /**\n-   * A list of tuples containing a commit header string and the list of error messages for the\n-   * commit.\n-   */\n+  /** A list of tuples of the commit header string and a list of error messages for the commit. */\n   const errors: [commitHeader: string, errors: string[]][] = [];\n-\n-  // Retrieve the commits in the provided range.\n-  const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n-  if (result.code) {\n-    throw new Error(`Failed to get all commits in the range: \\n  ${result.stderr}`);\n-  }\n-\n-  // Separate the commits from a single string into individual commits\n-  const commits = result.split(randomValueSeparator).map(l => l.trim()).filter(line => !!line);\n-\n+  /** A list of parsed commit messages from the range. */\n+  const commits = parseCommitMessagesForRange(range);\n   info(`Examining ${commits.length} commit(s) in the provided range: ${range}`);\n \n-  // Check each commit in the commit range.  Commits are allowed to be fixup commits for other\n-  // commits in the provided commit range.\n-  const allCommitsInRangeValid = commits.every((m, i) => {\n+  /**\n+   * Whether all commits in the range are valid, commits are allowed to be fixup commits for other\n+   * commits in the provided commit range.\n+   */\n+  const allCommitsInRangeValid = commits.every((commit, i) => {\n     const options: ValidateCommitMessageOptions = {\n       disallowSquash: true,\n-      nonFixupCommitHeaders: isNonFixup(m) ?\n+      nonFixupCommitHeaders: isNonFixup(commit) ?\n           undefined :\n           commits.slice(0, i).filter(isNonFixup).map(extractCommitHeader)\n     };\n-    const {valid, errors: localErrors, commit} = validateCommitMessage(m, options);\n+    const {valid, errors: localErrors} = validateCommitMessage(commit, options);\n     if (localErrors.length) {\n       errors.push([commit.header, localErrors]);\n     }"
        },
        {
            "sha": "578f5999738a8c0c45e0c5c3f77797d1df29ab67",
            "filename": "dev-infra/commit-message/validate.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "raw_url": "https://github.com/angular/angular/raw/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate.ts?ref=7261e393f154dcfc4d2a828b9570200b6635425c",
            "patch": "@@ -28,9 +28,10 @@ const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n \n /** Validate a commit message against using the local repo's config. */\n export function validateCommitMessage(\n-    commitMsg: string, options: ValidateCommitMessageOptions = {}): ValidateCommitMessageResult {\n+    commitMsg: string|ParsedCommitMessage,\n+    options: ValidateCommitMessageOptions = {}): ValidateCommitMessageResult {\n   const config = getCommitMessageConfig().commitMessage;\n-  const commit = parseCommitMessage(commitMsg);\n+  const commit = typeof commitMsg === 'string' ? parseCommitMessage(commitMsg) : commitMsg;\n   const errors: string[] = [];\n \n   /** Perform the validation checks against the parsed commit. */"
        },
        {
            "sha": "134affcbf7265ac1a3d0d294a7bac8ccee90fdc0",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 41,
            "deletions": 24,
            "changes": 65,
            "blob_url": "https://github.com/angular/angular/blob/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/7261e393f154dcfc4d2a828b9570200b6635425c/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=7261e393f154dcfc4d2a828b9570200b6635425c",
            "patch": "@@ -1783,7 +1783,7 @@ const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n /** Validate a commit message against using the local repo's config. */\n function validateCommitMessage(commitMsg, options = {}) {\n     const config = getCommitMessageConfig().commitMessage;\n-    const commit = parseCommitMessage(commitMsg);\n+    const commit = typeof commitMsg === 'string' ? parseCommitMessage(commitMsg) : commitMsg;\n     const errors = [];\n     /** Perform the validation checks against the parsed commit. */\n     function validateCommitAndCollectErrors() {\n@@ -1978,44 +1978,61 @@ const ValidateFileModule = {\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-// Whether the provided commit is a fixup commit.\n-const isNonFixup = (m) => !parseCommitMessage(m).isFixup;\n-// Extracts commit header (first line of commit message).\n-const extractCommitHeader = (m) => parseCommitMessage(m).header;\n-/** Validate all commits in a provided git commit range. */\n-function validateCommitRange(range) {\n-    /**\n-     * A random value is used as a string to allow for a definite split point in the git log result.\n-     */\n+/** Retrieve and parse each commit message in a provide range. */\n+function parseCommitMessagesForRange(range) {\n+    /** A random number used as a split point in the git log result. */\n     const randomValueSeparator = `${Math.random()}`;\n     /**\n      * Custom git log format that provides the commit header and body, separated as expected with the\n      * custom separator as the trailing value.\n      */\n     const gitLogFormat = `%s%n%n%b${randomValueSeparator}`;\n-    /**\n-     * A list of tuples containing a commit header string and the list of error messages for the\n-     * commit.\n-     */\n-    const errors = [];\n     // Retrieve the commits in the provided range.\n     const result = exec(`git log --reverse --format=${gitLogFormat} ${range}`);\n     if (result.code) {\n-        throw new Error(`Failed to get all commits in the range: \\n  ${result.stderr}`);\n-    }\n-    // Separate the commits from a single string into individual commits\n-    const commits = result.split(randomValueSeparator).map(l => l.trim()).filter(line => !!line);\n+        throw new Error(`Failed to get all commits in the range:\\n  ${result.stderr}`);\n+    }\n+    return result\n+        // Separate the commits from a single string into individual commits.\n+        .split(randomValueSeparator)\n+        // Remove extra space before and after each commit message.\n+        .map(l => l.trim())\n+        // Remove any superfluous lines which remain from the split.\n+        .filter(line => !!line)\n+        // Parse each commit message.\n+        .map(commit => parseCommitMessage(commit));\n+}\n+\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+// Whether the provided commit is a fixup commit.\n+const isNonFixup = (commit) => !commit.isFixup;\n+// Extracts commit header (first line of commit message).\n+const extractCommitHeader = (commit) => commit.header;\n+/** Validate all commits in a provided git commit range. */\n+function validateCommitRange(range) {\n+    /** A list of tuples of the commit header string and a list of error messages for the commit. */\n+    const errors = [];\n+    /** A list of parsed commit messages from the range. */\n+    const commits = parseCommitMessagesForRange(range);\n     info(`Examining ${commits.length} commit(s) in the provided range: ${range}`);\n-    // Check each commit in the commit range.  Commits are allowed to be fixup commits for other\n-    // commits in the provided commit range.\n-    const allCommitsInRangeValid = commits.every((m, i) => {\n+    /**\n+     * Whether all commits in the range are valid, commits are allowed to be fixup commits for other\n+     * commits in the provided commit range.\n+     */\n+    const allCommitsInRangeValid = commits.every((commit, i) => {\n         const options = {\n             disallowSquash: true,\n-            nonFixupCommitHeaders: isNonFixup(m) ?\n+            nonFixupCommitHeaders: isNonFixup(commit) ?\n                 undefined :\n                 commits.slice(0, i).filter(isNonFixup).map(extractCommitHeader)\n         };\n-        const { valid, errors: localErrors, commit } = validateCommitMessage(m, options);\n+        const { valid, errors: localErrors } = validateCommitMessage(commit, options);\n         if (localErrors.length) {\n             errors.push([commit.header, localErrors]);\n         }"
        }
    ],
    "stats": {
        "total": 154,
        "additions": 96,
        "deletions": 58
    }
}