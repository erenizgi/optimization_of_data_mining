{
    "author": "JoostK",
    "message": "perf(compiler-cli): ensure module resolution cache is reused for type-check program (#39693)\n\nThe Angular compiler creates two `ts.Program`s; one for emit and one for\ntemplate type-checking. The creation of the type-check program could\nbenefit from reusing the `ts.ModuleResolutionCache` that was primed\nduring the creation of the emit program. This requires that the compiler\nhost implements `resolveModuleNames`, as otherwise TypeScript will setup\na `ts.ModuleResolutionHost` of its own for both programs.\n\nThis commit ensures that `resolveModuleNames` is always implemented,\neven if the originally provided compiler host does not. This is\nbeneficial for the `ngc` binary.\n\nPR Close #39693",
    "sha": "b50d88073e7642df7d7b932fe4d388fcea2990d6",
    "files": [
        {
            "sha": "1dfeba4f1875bb55cad4d9eed3054de186d5099c",
            "filename": "packages/compiler-cli/src/ngtsc/core/src/host.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/angular/angular/blob/b50d88073e7642df7d7b932fe4d388fcea2990d6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fhost.ts",
            "raw_url": "https://github.com/angular/angular/raw/b50d88073e7642df7d7b932fe4d388fcea2990d6/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fhost.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fcore%2Fsrc%2Fhost.ts?ref=b50d88073e7642df7d7b932fe4d388fcea2990d6",
            "patch": "@@ -101,6 +101,12 @@ export class NgCompilerHost extends DelegatingCompilerHost implements\n     this.constructionDiagnostics = diagnostics;\n     this.inputFiles = [...inputFiles, ...shimAdapter.extraInputFiles];\n     this.rootDirs = rootDirs;\n+\n+    if (this.resolveModuleNames === undefined) {\n+      // In order to reuse the module resolution cache during the creation of the type-check\n+      // program, we'll need to provide `resolveModuleNames` if the delegate did not provide one.\n+      this.resolveModuleNames = this.createCachedResolveModuleNamesFunction();\n+    }\n   }\n \n   /**\n@@ -263,4 +269,17 @@ export class NgCompilerHost extends DelegatingCompilerHost implements\n   get unifiedModulesHost(): UnifiedModulesHost|null {\n     return this.fileNameToModuleName !== undefined ? this as UnifiedModulesHost : null;\n   }\n+\n+  private createCachedResolveModuleNamesFunction(): ts.CompilerHost['resolveModuleNames'] {\n+    const moduleResolutionCache = ts.createModuleResolutionCache(\n+        this.getCurrentDirectory(), this.getCanonicalFileName.bind(this));\n+\n+    return (moduleNames, containingFile, reusedNames, redirectedReference, options) => {\n+      return moduleNames.map(moduleName => {\n+        const module = ts.resolveModuleName(\n+            moduleName, containingFile, options, this, moduleResolutionCache, redirectedReference);\n+        return module.resolvedModule;\n+      });\n+    };\n+  }\n }"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 19,
        "deletions": 0
    }
}