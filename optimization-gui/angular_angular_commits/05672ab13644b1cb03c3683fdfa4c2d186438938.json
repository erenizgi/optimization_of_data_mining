{
    "author": "petebacondarwin",
    "message": "refactor(compiler-cli): `attachComments()` now expects a defined `leadingComments` array (#39076)\n\nPreviously the value passed to `AstFactory.attachComments()` could be\n`undefined` which is counterintuitive, since why attach something that\ndoesn't exist? Now it expects there to be a defined array. Further it no\nlonger returns a statement. Both these aspects of the interface were designed\nto make the usage simpler but has the result of complicating the implemenation.\n\nThe `ExpressionTranslatorVisitor` now has a helper function (`attachComments()`)\nto handle `leadingComments` being undefined and also returning the statement.\nThis keeps the usage in the translator simple, while ensuring that the `AstFactory`\nAPI is not influenced by how it is used.\n\nPR Close #39076",
    "sha": "05672ab13644b1cb03c3683fdfa4c2d186438938",
    "files": [
        {
            "sha": "afefce4c1fcc96cd4798a68a5375078c584b31ff",
            "filename": "packages/compiler-cli/linker/src/ast/babel/babel_ast_factory.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Fbabel%2Fbabel_ast_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Fbabel%2Fbabel_ast_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Flinker%2Fsrc%2Fast%2Fbabel%2Fbabel_ast_factory.ts?ref=05672ab13644b1cb03c3683fdfa4c2d186438938",
            "patch": "@@ -10,17 +10,16 @@ import * as t from '@babel/types';\n import {AstFactory, BinaryOperator, LeadingComment, ObjectLiteralProperty, SourceMapRange, TemplateLiteral, VariableDeclarationType} from '../../../../src/ngtsc/translator';\n import {assert} from '../utils';\n \n+/**\n+ * A Babel flavored implementation of the AstFactory.\n+ */\n export class BabelAstFactory implements AstFactory<t.Statement, t.Expression> {\n-  attachComments(statement: t.Statement, leadingComments: LeadingComment[]|undefined): t.Statement {\n-    if (leadingComments === undefined) {\n-      return statement;\n-    }\n+  attachComments(statement: t.Statement, leadingComments: LeadingComment[]): void {\n     // We must process the comments in reverse because `t.addComment()` will add new ones in front.\n     for (let i = leadingComments.length - 1; i >= 0; i--) {\n       const comment = leadingComments[i];\n       t.addComment(statement, 'leading', comment.toString(), !comment.multiline);\n     }\n-    return statement;\n   }\n \n   createArrayLiteral = t.arrayExpression;"
        },
        {
            "sha": "4a5890756d0f1aead74a44e4ab20e7a8a8c52686",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/api/ast_factory.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Fapi%2Fast_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Fapi%2Fast_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Fapi%2Fast_factory.ts?ref=05672ab13644b1cb03c3683fdfa4c2d186438938",
            "patch": "@@ -17,11 +17,10 @@ export interface AstFactory<TStatement, TExpression> {\n   /**\n    * Attach the `leadingComments` to the given `statement` node.\n    *\n-   * @param statement the statement where the comment is to be attached.\n+   * @param statement the statement where the comments are to be attached.\n    * @param leadingComments the comments to attach.\n-   * @returns the node passed in as `statement` with the comments attached.\n    */\n-  attachComments(statement: TStatement, leadingComments: LeadingComment[]|undefined): TStatement;\n+  attachComments(statement: TStatement, leadingComments: LeadingComment[]): void;\n \n   /**\n    * Create a literal array expresion (e.g. `[expr1, expr2]`)."
        },
        {
            "sha": "2a2da50088715b18699b1b3e3e5ba0d588cd0911",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/translator.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/angular/angular/blob/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts",
            "raw_url": "https://github.com/angular/angular/raw/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftranslator.ts?ref=05672ab13644b1cb03c3683fdfa4c2d186438938",
            "patch": "@@ -61,14 +61,14 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n     const varType = this.downlevelVariableDeclarations ?\n         'var' :\n         stmt.hasModifier(o.StmtModifier.Final) ? 'const' : 'let';\n-    return this.factory.attachComments(\n+    return this.attachComments(\n         this.factory.createVariableDeclaration(\n             stmt.name, stmt.value?.visitExpression(this, context.withExpressionMode), varType),\n         stmt.leadingComments);\n   }\n \n   visitDeclareFunctionStmt(stmt: o.DeclareFunctionStmt, context: Context): TStatement {\n-    return this.factory.attachComments(\n+    return this.attachComments(\n         this.factory.createFunctionDeclaration(\n             stmt.name, stmt.params.map(param => param.name),\n             this.factory.createBlock(\n@@ -77,14 +77,14 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n   }\n \n   visitExpressionStmt(stmt: o.ExpressionStatement, context: Context): TStatement {\n-    return this.factory.attachComments(\n+    return this.attachComments(\n         this.factory.createExpressionStatement(\n             stmt.expr.visitExpression(this, context.withStatementMode)),\n         stmt.leadingComments);\n   }\n \n   visitReturnStmt(stmt: o.ReturnStatement, context: Context): TStatement {\n-    return this.factory.attachComments(\n+    return this.attachComments(\n         this.factory.createReturnStatement(\n             stmt.value.visitExpression(this, context.withExpressionMode)),\n         stmt.leadingComments);\n@@ -95,7 +95,7 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n   }\n \n   visitIfStmt(stmt: o.IfStmt, context: Context): TStatement {\n-    return this.factory.attachComments(\n+    return this.attachComments(\n         this.factory.createIfStatement(\n             stmt.condition.visitExpression(this, context),\n             this.factory.createBlock(\n@@ -111,7 +111,7 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n   }\n \n   visitThrowStmt(stmt: o.ThrowStmt, context: Context): TStatement {\n-    return this.factory.attachComments(\n+    return this.attachComments(\n         this.factory.createThrowStatement(\n             stmt.error.visitExpression(this, context.withExpressionMode)),\n         stmt.leadingComments);\n@@ -387,6 +387,14 @@ export class ExpressionTranslatorVisitor<TStatement, TExpression> implements o.E\n       T {\n     return this.factory.setSourceMapRange(ast, createRange(span));\n   }\n+\n+  private attachComments(statement: TStatement, leadingComments: o.LeadingComment[]|undefined):\n+      TStatement {\n+    if (leadingComments !== undefined) {\n+      this.factory.attachComments(statement, leadingComments);\n+    }\n+    return statement;\n+  }\n }\n \n /**"
        },
        {
            "sha": "a75c03c324fa64f7287906bdb240dc344595198e",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/typescript_ast_factory.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftypescript_ast_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftypescript_ast_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftypescript_ast_factory.ts?ref=05672ab13644b1cb03c3683fdfa4c2d186438938",
            "patch": "@@ -234,12 +234,7 @@ export function createTemplateTail(cooked: string, raw: string): ts.TemplateTail\n  * @param statement The statement that will have comments attached.\n  * @param leadingComments The comments to attach to the statement.\n  */\n-export function attachComments<T extends ts.Statement>(\n-    statement: T, leadingComments: LeadingComment[]|undefined): T {\n-  if (leadingComments === undefined) {\n-    return statement;\n-  }\n-\n+export function attachComments(statement: ts.Statement, leadingComments: LeadingComment[]): void {\n   for (const comment of leadingComments) {\n     const commentKind = comment.multiline ? ts.SyntaxKind.MultiLineCommentTrivia :\n                                             ts.SyntaxKind.SingleLineCommentTrivia;\n@@ -252,5 +247,4 @@ export function attachComments<T extends ts.Statement>(\n       }\n     }\n   }\n-  return statement;\n }"
        },
        {
            "sha": "6a27f1798bf3603d826384bdc6e53f556a41b2f9",
            "filename": "packages/compiler-cli/src/transformers/node_emitter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fnode_emitter.ts",
            "raw_url": "https://github.com/angular/angular/raw/05672ab13644b1cb03c3683fdfa4c2d186438938/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fnode_emitter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fnode_emitter.ts?ref=05672ab13644b1cb03c3683fdfa4c2d186438938",
            "patch": "@@ -287,7 +287,7 @@ export class NodeEmitterVisitor implements StatementVisitor, ExpressionVisitor {\n     if (tsNode && !this._nodeMap.has(tsNode)) {\n       this._nodeMap.set(tsNode, ngNode);\n     }\n-    if (tsNode !== null && ngNode instanceof Statement) {\n+    if (tsNode !== null && ngNode instanceof Statement && ngNode.leadingComments !== undefined) {\n       attachComments(tsNode as unknown as ts.Statement, ngNode.leadingComments);\n     }\n     return tsNode as RecordedNode<T>;"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 22,
        "deletions": 22
    }
}