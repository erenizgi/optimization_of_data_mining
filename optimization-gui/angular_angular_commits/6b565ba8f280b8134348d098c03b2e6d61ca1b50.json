{
    "author": "JoostK",
    "message": "refactor(ngcc): let `isWithinPackage` operate on paths instead of source files (#37596)\n\nChanges `isWithinPackage` to take an `AbsoluteFsPath` instead of `ts.SourceFile`,\nto allow for an upcoming change to use it when no `ts.SourceFile` is available,\nbut just a path.\n\nPR Close #37596",
    "sha": "6b565ba8f280b8134348d098c03b2e6d61ca1b50",
    "files": [
        {
            "sha": "399c3abeb229e0447e34e7ca2e7d5486faac67ed",
            "filename": "packages/compiler-cli/ngcc/src/analysis/decoration_analyzer.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fdecoration_analyzer.ts?ref=6b565ba8f280b8134348d098c03b2e6d61ca1b50",
            "patch": "@@ -12,7 +12,7 @@ import {ParsedConfiguration} from '../../..';\n import {ComponentDecoratorHandler, DirectiveDecoratorHandler, InjectableDecoratorHandler, NgModuleDecoratorHandler, PipeDecoratorHandler, ReferencesRegistry, ResourceLoader} from '../../../src/ngtsc/annotations';\n import {CycleAnalyzer, ImportGraph} from '../../../src/ngtsc/cycles';\n import {isFatalDiagnosticError} from '../../../src/ngtsc/diagnostics';\n-import {absoluteFrom, dirname, FileSystem, LogicalFileSystem, resolve} from '../../../src/ngtsc/file_system';\n+import {absoluteFrom, absoluteFromSourceFile, dirname, FileSystem, LogicalFileSystem, resolve} from '../../../src/ngtsc/file_system';\n import {AbsoluteModuleStrategy, LocalIdentifierStrategy, LogicalProjectStrategy, ModuleResolver, NOOP_DEFAULT_IMPORT_RECORDER, PrivateExportAliasingHost, Reexport, ReferenceEmitter} from '../../../src/ngtsc/imports';\n import {CompoundMetadataReader, CompoundMetadataRegistry, DtsMetadataReader, InjectableClassRegistry, LocalMetadataRegistry} from '../../../src/ngtsc/metadata';\n import {PartialEvaluator} from '../../../src/ngtsc/partial_evaluator';\n@@ -148,7 +148,8 @@ export class DecorationAnalyzer {\n    */\n   analyzeProgram(): DecorationAnalyses {\n     for (const sourceFile of this.program.getSourceFiles()) {\n-      if (!sourceFile.isDeclarationFile && isWithinPackage(this.packagePath, sourceFile)) {\n+      if (!sourceFile.isDeclarationFile &&\n+          isWithinPackage(this.packagePath, absoluteFromSourceFile(sourceFile))) {\n         this.compiler.analyzeFile(sourceFile);\n       }\n     }"
        },
        {
            "sha": "e1e486e54a853ee41a40533215a9e4cda1ed4ce1",
            "filename": "packages/compiler-cli/ngcc/src/analysis/migration_host.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fmigration_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fmigration_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fmigration_host.ts?ref=6b565ba8f280b8134348d098c03b2e6d61ca1b50",
            "patch": "@@ -7,7 +7,7 @@\n  */\n import * as ts from 'typescript';\n \n-import {AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n+import {absoluteFromSourceFile, AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n import {MetadataReader} from '../../../src/ngtsc/metadata';\n import {PartialEvaluator} from '../../../src/ngtsc/partial_evaluator';\n import {ClassDeclaration, Decorator} from '../../../src/ngtsc/reflection';\n@@ -44,7 +44,7 @@ export class DefaultMigrationHost implements MigrationHost {\n   }\n \n   isInScope(clazz: ClassDeclaration): boolean {\n-    return isWithinPackage(this.entryPointPath, clazz.getSourceFile());\n+    return isWithinPackage(this.entryPointPath, absoluteFromSourceFile(clazz.getSourceFile()));\n   }\n }\n "
        },
        {
            "sha": "7ec044ebe3483eaea844ffe4480782da6f2bd7e1",
            "filename": "packages/compiler-cli/ngcc/src/analysis/switch_marker_analyzer.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fswitch_marker_analyzer.ts",
            "raw_url": "https://github.com/angular/angular/raw/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fswitch_marker_analyzer.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Fswitch_marker_analyzer.ts?ref=6b565ba8f280b8134348d098c03b2e6d61ca1b50",
            "patch": "@@ -6,7 +6,7 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n import * as ts from 'typescript';\n-import {AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n+import {absoluteFromSourceFile, AbsoluteFsPath} from '../../../src/ngtsc/file_system';\n import {NgccReflectionHost, SwitchableVariableDeclaration} from '../host/ngcc_host';\n import {isWithinPackage} from './util';\n \n@@ -35,7 +35,7 @@ export class SwitchMarkerAnalyzer {\n   analyzeProgram(program: ts.Program): SwitchMarkerAnalyses {\n     const analyzedFiles = new SwitchMarkerAnalyses();\n     program.getSourceFiles()\n-        .filter(sourceFile => isWithinPackage(this.packagePath, sourceFile))\n+        .filter(sourceFile => isWithinPackage(this.packagePath, absoluteFromSourceFile(sourceFile)))\n         .forEach(sourceFile => {\n           const declarations = this.host.getSwitchableDeclarations(sourceFile);\n           if (declarations.length) {"
        },
        {
            "sha": "07f69a2c66ddb15cfd698dd22676d2f743164e57",
            "filename": "packages/compiler-cli/ngcc/src/analysis/util.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/angular/angular/blob/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fanalysis%2Futil.ts?ref=6b565ba8f280b8134348d098c03b2e6d61ca1b50",
            "patch": "@@ -5,13 +5,11 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import * as ts from 'typescript';\n-\n-import {absoluteFromSourceFile, AbsoluteFsPath, relative} from '../../../src/ngtsc/file_system';\n+import {AbsoluteFsPath, relative} from '../../../src/ngtsc/file_system';\n import {DependencyTracker} from '../../../src/ngtsc/incremental/api';\n \n-export function isWithinPackage(packagePath: AbsoluteFsPath, sourceFile: ts.SourceFile): boolean {\n-  const relativePath = relative(packagePath, absoluteFromSourceFile(sourceFile));\n+export function isWithinPackage(packagePath: AbsoluteFsPath, filePath: AbsoluteFsPath): boolean {\n+  const relativePath = relative(packagePath, filePath);\n   return !relativePath.startsWith('..') && !relativePath.startsWith('node_modules/');\n }\n "
        },
        {
            "sha": "95898188700749530324866acc038e1f8a272ba1",
            "filename": "packages/compiler-cli/ngcc/src/host/esm2015_host.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts?ref=6b565ba8f280b8134348d098c03b2e6d61ca1b50",
            "patch": "@@ -7,6 +7,7 @@\n  */\n \n import * as ts from 'typescript';\n+import {absoluteFromSourceFile} from '../../../src/ngtsc/file_system';\n \n import {Logger} from '../../../src/ngtsc/logging';\n import {ClassDeclaration, ClassMember, ClassMemberKind, CtorParameter, Declaration, Decorator, EnumMember, isDecoratorIdentifier, isNamedClassDeclaration, isNamedFunctionDeclaration, isNamedVariableDeclaration, KnownDeclaration, reflectObjectLiteral, SpecialDeclarationKind, TypeScriptReflectionHost, TypeValueReference} from '../../../src/ngtsc/reflection';\n@@ -2525,7 +2526,7 @@ function getRootFileOrFail(bundle: BundleProgram): ts.SourceFile {\n function getNonRootPackageFiles(bundle: BundleProgram): ts.SourceFile[] {\n   const rootFile = bundle.program.getSourceFile(bundle.path);\n   return bundle.program.getSourceFiles().filter(\n-      f => (f !== rootFile) && isWithinPackage(bundle.package, f));\n+      f => (f !== rootFile) && isWithinPackage(bundle.package, absoluteFromSourceFile(f)));\n }\n \n function isTopLevel(node: ts.Node): boolean {"
        },
        {
            "sha": "91287c5b9c10c707c82613af2cd3d04ea93c9693",
            "filename": "packages/compiler-cli/ngcc/test/analysis/util_spec.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/angular/angular/blob/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Futil_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/6b565ba8f280b8134348d098c03b2e6d61ca1b50/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Futil_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Ftest%2Fanalysis%2Futil_spec.ts?ref=6b565ba8f280b8134348d098c03b2e6d61ca1b50",
            "patch": "@@ -5,7 +5,6 @@\n  * Use of this source code is governed by an MIT-style license that can be\n  * found in the LICENSE file at https://angular.io/license\n  */\n-import * as ts from 'typescript';\n import {absoluteFrom} from '../../../src/ngtsc/file_system';\n import {runInEachFileSystem} from '../../../src/ngtsc/file_system/testing';\n import {isWithinPackage} from '../../src/analysis/util';\n@@ -18,29 +17,25 @@ runInEachFileSystem(() => {\n \n     it('should return true if the source-file is contained in the package', () => {\n       const packagePath = _('/node_modules/test');\n-      const file =\n-          ts.createSourceFile(_('/node_modules/test/src/index.js'), '', ts.ScriptTarget.ES2015);\n+      const file = _('/node_modules/test/src/index.js');\n       expect(isWithinPackage(packagePath, file)).toBe(true);\n     });\n \n     it('should return false if the source-file is not contained in the package', () => {\n       const packagePath = _('/node_modules/test');\n-      const file =\n-          ts.createSourceFile(_('/node_modules/other/src/index.js'), '', ts.ScriptTarget.ES2015);\n+      const file = _('/node_modules/other/src/index.js');\n       expect(isWithinPackage(packagePath, file)).toBe(false);\n     });\n \n     it('should return false if the source-file is inside the package\\'s `node_modules/`', () => {\n       const packagePath = _('/node_modules/test');\n \n       // An external file inside the package's `node_modules/`.\n-      const file1 = ts.createSourceFile(\n-          _('/node_modules/test/node_modules/other/src/index.js'), '', ts.ScriptTarget.ES2015);\n+      const file1 = _('/node_modules/test/node_modules/other/src/index.js');\n       expect(isWithinPackage(packagePath, file1)).toBe(false);\n \n       // An internal file starting with `node_modules`.\n-      const file2 = ts.createSourceFile(\n-          _('/node_modules/test/node_modules_optimizer.js'), '', ts.ScriptTarget.ES2015);\n+      const file2 = _('/node_modules/test/node_modules_optimizer.js');\n       expect(isWithinPackage(packagePath, file2)).toBe(true);\n     });\n   });"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 16,
        "deletions": 21
    }
}