{
    "author": "gkalpak",
    "message": "test(docs-infra): improve debugging when docs example tests fail without exiting (#43683)\n\nWhen the docs examples tests run with `--cliSpecsConcurrency` greater\nthan 1 (as happens on CI), the output of each process is [buffered][1]\n(to avoid interleaved output from multiple, parallel processes) and is\nonly printed out once the process exits (either successfully or with an\nerror). However, in cases where a process did not exit, the buffered\noutput would be never printed out, thus making debugging the failure\nharder. This is the case, for example, if a build error happens during\n`ng e2e`. This can be seen in action in [this CI job][2], where the job\nfails due to no output, but the error (which is an incompatible TS\nversion) is never printed out.\n\nTo make debugging such situations easier in the future, this commit\nupdates the `spawnExt()` helper to reject (causing the buffered output\nto be printed out) if there is no output from the spawned process for\nmore than 5 minutes.\n\n[1]: https://github.com/angular/angular/blob/c721135e370b34c840756bcfb22c8119b4c8c452/aio/tools/examples/run-example-e2e.mjs#L293\n[2]: https://circleci.com/gh/angular/angular/1061751\n\nPR Close #43683",
    "sha": "ef090d13471b22a26e5e6409637bd425c489e830",
    "files": [
        {
            "sha": "9b38b2e3f3bc851f203c53db8947b080f72d26f4",
            "filename": "aio/tools/examples/run-example-e2e.mjs",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/angular/angular/blob/ef090d13471b22a26e5e6409637bd425c489e830/aio%2Ftools%2Fexamples%2Frun-example-e2e.mjs",
            "raw_url": "https://github.com/angular/angular/raw/ef090d13471b22a26e5e6409637bd425c489e830/aio%2Ftools%2Fexamples%2Frun-example-e2e.mjs",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/aio%2Ftools%2Fexamples%2Frun-example-e2e.mjs?ref=ef090d13471b22a26e5e6409637bd425c489e830",
            "patch": "@@ -25,6 +25,7 @@ const CLI_SPEC_FILENAME = 'e2e/src/app.e2e-spec.ts';\n const EXAMPLE_CONFIG_FILENAME = 'example-config.json';\n const DEFAULT_CLI_EXAMPLE_PORT = 4200;\n const DEFAULT_CLI_SPECS_CONCURRENCY = 1;\n+const MAX_NO_OUTPUT_TIMEOUT = 1000 * 60 * 5;  // 5 minutes\n const IGNORED_EXAMPLES = [\n   // All of these `@angular/upgrade` related examples are relying on the SystemJS boilerplate.\n   // As of v13, Angular packages no longer include UMD bundles so these examples are no longer\n@@ -346,9 +347,28 @@ function reportStatus(status, outputFile) {\n \n // Returns both a promise and the spawned process so that it can be killed if needed.\n function spawnExt(\n-    command, args, options, ignoreClose = false, printMessage = msg => process.stdout.write(msg)) {\n+    command, args, options, ignoreClose = false, printMessageFn = msg => process.stdout.write(msg)) {\n   let proc = null;\n-  const promise = new Promise((resolve, reject) => {\n+  const promise = new Promise((resolveFn, rejectFn) => {\n+    let noOutputTimeoutId;\n+    const failDueToNoOutput = () => {\n+      treeKill(proc.id);\n+      reject(`No output after ${MAX_NO_OUTPUT_TIMEOUT}ms.`);\n+    };\n+    const printMessage = msg => {\n+      clearTimeout(noOutputTimeoutId);\n+      noOutputTimeoutId = setTimeout(failDueToNoOutput, MAX_NO_OUTPUT_TIMEOUT);\n+      return printMessageFn(msg);\n+    };\n+    const resolve = val => {\n+      clearTimeout(noOutputTimeoutId);\n+      resolveFn(val);\n+    };\n+    const reject = err => {\n+      clearTimeout(noOutputTimeoutId);\n+      rejectFn(err);\n+    };\n+\n     let descr = command + ' ' + args.join(' ');\n     printMessage(`running: ${descr}\\n`);\n     try {"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
    }
}