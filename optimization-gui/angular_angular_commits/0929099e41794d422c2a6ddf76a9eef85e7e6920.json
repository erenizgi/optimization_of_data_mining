{
    "author": "alan-agius4",
    "message": "refactor(compiler-cli): remove TypeScript 3.9 workarounds (#39586)\n\nWith this change we remove code which was used to support both TypeScript 3.9 and TypeScript 4.0\n\nThis code is now no longer needed because G3 is on TypeScript 4.0\n\nPR Close #39586",
    "sha": "0929099e41794d422c2a6ddf76a9eef85e7e6920",
    "files": [
        {
            "sha": "0c312a6f596e28a13bd8a6cec29e99acc9fe4702",
            "filename": "packages/compiler-cli/src/metadata/evaluator.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/angular/angular/blob/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fmetadata%2Fevaluator.ts",
            "raw_url": "https://github.com/angular/angular/raw/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fmetadata%2Fevaluator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fmetadata%2Fevaluator.ts?ref=0929099e41794d422c2a6ddf76a9eef85e7e6920",
            "patch": "@@ -477,13 +477,10 @@ export class Evaluator {\n       case ts.SyntaxKind.UnionType:\n         const unionType = <ts.UnionTypeNode>node;\n         // Remove null and undefined from the list of unions.\n-        // TODO(alan-agius4): remove `n.kind !== ts.SyntaxKind.NullKeyword` when\n-        // TS 3.9 support is dropped. In TS 4.0 NullKeyword is a child of LiteralType.\n         const references =\n             unionType.types\n                 .filter(\n-                    n => n.kind !== ts.SyntaxKind.NullKeyword &&\n-                        n.kind !== ts.SyntaxKind.UndefinedKeyword &&\n+                    n => n.kind !== ts.SyntaxKind.UndefinedKeyword &&\n                         !(ts.isLiteralTypeNode(n) && n.literal.kind === ts.SyntaxKind.NullKeyword))\n                 .map(n => this.evaluateNode(n));\n "
        },
        {
            "sha": "857543712704652863e05e629252119f80989fdc",
            "filename": "packages/compiler-cli/src/ngtsc/metadata/src/util.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 28,
            "changes": 50,
            "blob_url": "https://github.com/angular/angular/blob/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Futil.ts",
            "raw_url": "https://github.com/angular/angular/raw/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Futil.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Fmetadata%2Fsrc%2Futil.ts?ref=0929099e41794d422c2a6ddf76a9eef85e7e6920",
            "patch": "@@ -22,25 +22,22 @@ export function extractReferencesFromType(\n     return [];\n   }\n \n-  // TODO(alan-agius4): remove `def.elementTypes` and casts when TS 3.9 support is dropped and G3 is\n-  // using TS 4.0.\n-  return (((def as any).elements || (def as any).elementTypes) as ts.NodeArray<ts.TypeNode>)\n-      .map(element => {\n-        if (!ts.isTypeQueryNode(element)) {\n-          throw new Error(`Expected TypeQueryNode: ${nodeDebugInfo(element)}`);\n-        }\n-        const type = element.exprName;\n-        const {node, from} = reflectTypeEntityToDeclaration(type, checker);\n-        if (!isNamedClassDeclaration(node)) {\n-          throw new Error(`Expected named ClassDeclaration: ${nodeDebugInfo(node)}`);\n-        }\n-        const specifier = (from !== null && !from.startsWith('.') ? from : ngModuleImportedFrom);\n-        if (specifier !== null) {\n-          return new Reference(node, {specifier, resolutionContext});\n-        } else {\n-          return new Reference(node);\n-        }\n-      });\n+  return def.elements.map(element => {\n+    if (!ts.isTypeQueryNode(element)) {\n+      throw new Error(`Expected TypeQueryNode: ${nodeDebugInfo(element)}`);\n+    }\n+    const type = element.exprName;\n+    const {node, from} = reflectTypeEntityToDeclaration(type, checker);\n+    if (!isNamedClassDeclaration(node)) {\n+      throw new Error(`Expected named ClassDeclaration: ${nodeDebugInfo(node)}`);\n+    }\n+    const specifier = (from !== null && !from.startsWith('.') ? from : ngModuleImportedFrom);\n+    if (specifier !== null) {\n+      return new Reference(node, {specifier, resolutionContext});\n+    } else {\n+      return new Reference(node);\n+    }\n+  });\n }\n \n export function readStringType(type: ts.TypeNode): string|null {\n@@ -74,15 +71,12 @@ export function readStringArrayType(type: ts.TypeNode): string[] {\n     return [];\n   }\n   const res: string[] = [];\n-  // TODO(alan-agius4): remove `def.elementTypes` and casts when TS 3.9 support is dropped and G3 is\n-  // using TS 4.0.\n-  (((type as any).elements || (type as any).elementTypes) as ts.NodeArray<ts.TypeNode>)\n-      .forEach(el => {\n-        if (!ts.isLiteralTypeNode(el) || !ts.isStringLiteral(el.literal)) {\n-          return;\n-        }\n-        res.push(el.literal.text);\n-      });\n+  type.elements.forEach(el => {\n+    if (!ts.isLiteralTypeNode(el) || !ts.isStringLiteral(el.literal)) {\n+      return;\n+    }\n+    res.push(el.literal.text);\n+  });\n   return res;\n }\n "
        },
        {
            "sha": "263a31d53479f317012eeb8821e48144487480db",
            "filename": "packages/compiler-cli/src/ngtsc/reflection/src/typescript.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftypescript.ts",
            "raw_url": "https://github.com/angular/angular/raw/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftypescript.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Freflection%2Fsrc%2Ftypescript.ts?ref=0929099e41794d422c2a6ddf76a9eef85e7e6920",
            "patch": "@@ -64,9 +64,7 @@ export class TypeScriptReflectionHost implements ReflectionHost {\n       // optional tokes that don't have providers.\n       if (typeNode && ts.isUnionTypeNode(typeNode)) {\n         let childTypeNodes = typeNode.types.filter(\n-            // TODO(alan-agius4): remove `childTypeNode.kind !== ts.SyntaxKind.NullKeyword` when\n-            // TS 3.9 support is dropped. In TS 4.0 NullKeyword is a child of LiteralType.\n-            childTypeNode => childTypeNode.kind !== ts.SyntaxKind.NullKeyword &&\n+            childTypeNode =>\n                 !(ts.isLiteralTypeNode(childTypeNode) &&\n                   childTypeNode.literal.kind === ts.SyntaxKind.NullKeyword));\n "
        },
        {
            "sha": "f5f3c26e5a77d67642876cc31e73b58841076ad1",
            "filename": "packages/compiler-cli/src/ngtsc/transform/src/declaration.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 27,
            "changes": 27,
            "blob_url": "https://github.com/angular/angular/blob/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fdeclaration.ts",
            "raw_url": "https://github.com/angular/angular/raw/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fdeclaration.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftransform%2Fsrc%2Fdeclaration.ts?ref=0929099e41794d422c2a6ddf76a9eef85e7e6920",
            "patch": "@@ -239,33 +239,6 @@ export class ReturnTypeTransform implements DtsTransform {\n   }\n \n   transformClassElement(element: ts.ClassElement, imports: ImportManager): ts.ClassElement {\n-    // // TODO(alan-agius4): Remove when we no longer support TS 3.9\n-    // TS <= 3.9\n-    if (ts.isMethodSignature(element)) {\n-      const original = ts.getOriginalNode(element) as ts.MethodDeclaration;\n-      if (!this.typeReplacements.has(original)) {\n-        return element;\n-      }\n-      const returnType = this.typeReplacements.get(original)!;\n-      const tsReturnType = translateType(returnType, imports);\n-      const methodSignature = ts.updateMethodSignature(\n-          /* node */ element,\n-          /* typeParameters */ element.typeParameters,\n-          /* parameters */ element.parameters,\n-          /* type */ tsReturnType,\n-          /* name */ element.name,\n-          /* questionToken */ element.questionToken);\n-\n-      // Copy over any modifiers, these cannot be set during the `ts.updateMethodSignature` call.\n-      (methodSignature.modifiers as ts.ModifiersArray | undefined) = element.modifiers;\n-\n-      // A bug in the TypeScript declaration causes `ts.MethodSignature` not to be assignable to\n-      // `ts.ClassElement`. Since `element` was a `ts.MethodSignature` already, transforming it into\n-      // this type is actually correct.\n-      return methodSignature as unknown as ts.ClassElement;\n-    }\n-\n-    // TS 4.0 +\n     if (ts.isMethodDeclaration(element)) {\n       const original = ts.getOriginalNode(element, ts.isMethodDeclaration);\n       if (!this.typeReplacements.has(original)) {"
        },
        {
            "sha": "180d221f7a01081a379319ff978c49f5f366f892",
            "filename": "packages/compiler-cli/src/ngtsc/translator/src/type_translator.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts",
            "raw_url": "https://github.com/angular/angular/raw/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Fngtsc%2Ftranslator%2Fsrc%2Ftype_translator.ts?ref=0929099e41794d422c2a6ddf76a9eef85e7e6920",
            "patch": "@@ -104,11 +104,7 @@ export class TypeTranslatorVisitor implements o.ExpressionVisitor, o.TypeVisitor\n \n   visitLiteralExpr(ast: o.LiteralExpr, context: Context): ts.TypeNode {\n     if (ast.value === null) {\n-      // TODO(alan-agius4): Remove when we no longer support TS 3.9\n-      // Use: return ts.createLiteralTypeNode(ts.createNull()) directly.\n-      return ts.versionMajorMinor.charAt(0) === '4' ?\n-          ts.createLiteralTypeNode(ts.createNull() as any) :\n-          ts.createKeywordTypeNode(ts.SyntaxKind.NullKeyword as any);\n+      return ts.createLiteralTypeNode(ts.createNull());\n     } else if (ast.value === undefined) {\n       return ts.createKeywordTypeNode(ts.SyntaxKind.UndefinedKeyword);\n     } else if (typeof ast.value === 'boolean') {"
        },
        {
            "sha": "1e27e784fa620885274c04e922a256a30f43d9d1",
            "filename": "packages/compiler-cli/src/transformers/downlevel_decorators_transform.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts",
            "raw_url": "https://github.com/angular/angular/raw/0929099e41794d422c2a6ddf76a9eef85e7e6920/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fsrc%2Ftransformers%2Fdownlevel_decorators_transform.ts?ref=0929099e41794d422c2a6ddf76a9eef85e7e6920",
            "patch": "@@ -141,14 +141,9 @@ function createCtorParametersClassPropertyType(): ts.TypeNode {\n       ])),\n       undefined));\n \n-  // TODO(alan-agius4): Remove when we no longer support TS 3.9\n-  const nullLiteral = ts.createNull() as any;\n-  const nullType = ts.versionMajorMinor.charAt(0) === '4' ?\n-      ts.createLiteralTypeNode(nullLiteral as any) :\n-      nullLiteral;\n   return ts.createFunctionTypeNode(undefined, [], ts.createArrayTypeNode(ts.createUnionTypeNode([\n     ts.createTypeLiteralNode(typeElements),\n-    nullType,\n+    ts.createLiteralTypeNode(ts.createNull()),\n   ])));\n }\n \n@@ -293,13 +288,10 @@ function typeReferenceToExpression(\n       // Ignore any generic types, just return the base type.\n       return entityNameToExpression(typeRef.typeName);\n     case ts.SyntaxKind.UnionType:\n-      // TODO(alan-agius4): remove `t.kind !== ts.SyntaxKind.NullKeyword` when\n-      // TS 3.9 support is dropped. In TS 4.0 NullKeyword is a child of LiteralType.\n       const childTypeNodes =\n           (node as ts.UnionTypeNode)\n               .types.filter(\n-                  t => t.kind !== ts.SyntaxKind.NullKeyword &&\n-                      !(ts.isLiteralTypeNode(t) && t.literal.kind === ts.SyntaxKind.NullKeyword));\n+                  t => !(ts.isLiteralTypeNode(t) && t.literal.kind === ts.SyntaxKind.NullKeyword));\n       return childTypeNodes.length === 1 ?\n           typeReferenceToExpression(entityNameToExpression, childTypeNodes[0]) :\n           undefined;"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 27,
        "deletions": 77
    }
}