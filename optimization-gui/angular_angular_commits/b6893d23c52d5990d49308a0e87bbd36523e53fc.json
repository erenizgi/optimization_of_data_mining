{
    "author": "alxhub",
    "message": "test(language-service): introduce new virtual testing environment (#39594)\n\nThis commit adds new language service testing infrastructure which allows\nfor in-memory testing. It solves a number of issues with the previous\ntesting infrastructure that relied on a single integration project across\nall of the tests, and also provides for much faster builds by using\nthe compiler-cli's mock versions of @angular/core and @angular/common.\n\nA new `LanguageServiceTestEnvironment` class (conceptually mirroring the\ncompiler-cli `NgtscTestEnvironment`) controls setup and execution of tests.\nThe `FileSystem` abstraction is used to drive a `ts.server.ServerHost`,\nwhich backs the language service infrastructure.\n\nSince many language service tests revolve around the template, the API is\ncurrently optimized to spin up a \"skeleton\" project and then override its\ntemplate for each test.\n\nThe existing Quick Info tests (quick_info_spec.ts) were ported to the new\ninfrastructure for validation. The tests were cleaned up a bit to remove\nunnecessary initializations as well as correct legitimate template errors\nwhich did not affect the test outcome, but caused additional validation of\ntest correctness to fail. They still utilize a shared project with all\nfields required for each individual unit test, which is an anti-pattern, but\nnew tests can now easily be written independently without relying on the\nshared project, which was extremely difficult previously. Future cleanup\nwork might refactor these tests to be more independent.\n\nPR Close #39594",
    "sha": "b6893d23c52d5990d49308a0e87bbd36523e53fc",
    "files": [
        {
            "sha": "df0f26c2433287f51b16cbb861dfddacd707d8ed",
            "filename": "packages/language-service/ivy/compiler_factory.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 12,
            "changes": 39,
            "blob_url": "https://github.com/angular/angular/blob/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "raw_url": "https://github.com/angular/angular/raw/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Fcompiler_factory.ts?ref=b6893d23c52d5990d49308a0e87bbd36523e53fc",
            "patch": "@@ -15,6 +15,15 @@ import * as ts from 'typescript/lib/tsserverlibrary';\n import {LanguageServiceAdapter} from './language_service_adapter';\n import {isExternalTemplate} from './utils';\n \n+/**\n+ * Manages the `NgCompiler` instance which backs the language service, updating or replacing it as\n+ * needed to produce an up-to-date understanding of the current program.\n+ *\n+ * TODO(alxhub): currently the options used for the compiler are specified at `CompilerFactory`\n+ * construction, and are not changable. In a real project, users can update `tsconfig.json`. We need\n+ * to properly handle a change in the compiler options, either by having an API to update the\n+ * `CompilerFactory` to use new options, or by replacing it entirely.\n+ */\n export class CompilerFactory {\n   private readonly incrementalStrategy = new TrackedIncrementalBuildStrategy();\n   private compiler: NgCompiler|null = null;\n@@ -23,21 +32,15 @@ export class CompilerFactory {\n   constructor(\n       private readonly adapter: LanguageServiceAdapter,\n       private readonly programStrategy: TypeCheckingProgramStrategy,\n+      private readonly options: NgCompilerOptions,\n   ) {}\n \n-  /**\n-   * Create a new instance of the Ivy compiler if the program has changed since\n-   * the last time the compiler was instantiated. If the program has not changed,\n-   * return the existing instance.\n-   * @param fileName override the template if this is an external template file\n-   * @param options angular compiler options\n-   */\n-  getOrCreateWithChangedFile(fileName: string, options: NgCompilerOptions): NgCompiler {\n+  getOrCreate(): NgCompiler {\n     const program = this.programStrategy.getProgram();\n-    if (!this.compiler || program !== this.lastKnownProgram) {\n+    if (this.compiler === null || program !== this.lastKnownProgram) {\n       this.compiler = new NgCompiler(\n           this.adapter,  // like compiler host\n-          options,       // angular compiler options\n+          this.options,  // angular compiler options\n           program,\n           this.programStrategy,\n           this.incrementalStrategy,\n@@ -47,10 +50,22 @@ export class CompilerFactory {\n       );\n       this.lastKnownProgram = program;\n     }\n+    return this.compiler;\n+  }\n+\n+  /**\n+   * Create a new instance of the Ivy compiler if the program has changed since\n+   * the last time the compiler was instantiated. If the program has not changed,\n+   * return the existing instance.\n+   * @param fileName override the template if this is an external template file\n+   * @param options angular compiler options\n+   */\n+  getOrCreateWithChangedFile(fileName: string): NgCompiler {\n+    const compiler = this.getOrCreate();\n     if (isExternalTemplate(fileName)) {\n-      this.overrideTemplate(fileName, this.compiler);\n+      this.overrideTemplate(fileName, compiler);\n     }\n-    return this.compiler;\n+    return compiler;\n   }\n \n   private overrideTemplate(fileName: string, compiler: NgCompiler) {"
        },
        {
            "sha": "62d1e3dbb320a6688c6467786c85ec007816f4e3",
            "filename": "packages/language-service/ivy/language_service.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "raw_url": "https://github.com/angular/angular/raw/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Flanguage_service.ts?ref=b6893d23c52d5990d49308a0e87bbd36523e53fc",
            "patch": "@@ -21,20 +21,20 @@ import {getTemplateInfoAtPosition, isTypeScriptFile} from './utils';\n \n export class LanguageService {\n   private options: CompilerOptions;\n-  private readonly compilerFactory: CompilerFactory;\n+  readonly compilerFactory: CompilerFactory;\n   private readonly strategy: TypeCheckingProgramStrategy;\n   private readonly adapter: LanguageServiceAdapter;\n \n   constructor(project: ts.server.Project, private readonly tsLS: ts.LanguageService) {\n     this.options = parseNgCompilerOptions(project);\n     this.strategy = createTypeCheckingProgramStrategy(project);\n     this.adapter = new LanguageServiceAdapter(project);\n-    this.compilerFactory = new CompilerFactory(this.adapter, this.strategy);\n+    this.compilerFactory = new CompilerFactory(this.adapter, this.strategy, this.options);\n     this.watchConfigFile(project);\n   }\n \n   getSemanticDiagnostics(fileName: string): ts.Diagnostic[] {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n     const ttc = compiler.getTemplateTypeChecker();\n     const diagnostics: ts.Diagnostic[] = [];\n     if (isTypeScriptFile(fileName)) {\n@@ -57,7 +57,7 @@ export class LanguageService {\n \n   getDefinitionAndBoundSpan(fileName: string, position: number): ts.DefinitionInfoAndBoundSpan\n       |undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n     const results =\n         new DefinitionBuilder(this.tsLS, compiler).getDefinitionAndBoundSpan(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n@@ -66,7 +66,7 @@ export class LanguageService {\n \n   getTypeDefinitionAtPosition(fileName: string, position: number):\n       readonly ts.DefinitionInfo[]|undefined {\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n     const results =\n         new DefinitionBuilder(this.tsLS, compiler).getTypeDefinitionsAtPosition(fileName, position);\n     this.compilerFactory.registerLastKnownProgram();\n@@ -75,7 +75,7 @@ export class LanguageService {\n \n   getQuickInfoAtPosition(fileName: string, position: number): ts.QuickInfo|undefined {\n     const program = this.strategy.getProgram();\n-    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName, this.options);\n+    const compiler = this.compilerFactory.getOrCreateWithChangedFile(fileName);\n     const templateInfo = getTemplateInfoAtPosition(fileName, position, compiler);\n     if (templateInfo === undefined) {\n       return undefined;"
        },
        {
            "sha": "5a23ac2fdf66419114d6088f792c749ecd8927dc",
            "filename": "packages/language-service/ivy/test/BUILD.bazel",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/angular/angular/blob/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2FBUILD.bazel?ref=b6893d23c52d5990d49308a0e87bbd36523e53fc",
            "patch": "@@ -0,0 +1,31 @@\n+load(\"//tools:defaults.bzl\", \"jasmine_node_test\", \"ts_library\")\n+\n+ts_library(\n+    name = \"test_lib\",\n+    testonly = True,\n+    srcs = glob([\"*.ts\"]),\n+    deps = [\n+        \"//packages/compiler\",\n+        \"//packages/compiler-cli/src/ngtsc/core:api\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system\",\n+        \"//packages/compiler-cli/src/ngtsc/file_system/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/testing\",\n+        \"//packages/compiler-cli/src/ngtsc/typecheck/api\",\n+        \"//packages/language-service/ivy\",\n+        \"@npm//typescript\",\n+    ],\n+)\n+\n+jasmine_node_test(\n+    name = \"test\",\n+    data = [\n+        \"//packages/compiler-cli/src/ngtsc/testing/fake_common:npm_package\",\n+        \"//packages/compiler-cli/src/ngtsc/testing/fake_core:npm_package\",\n+    ],\n+    tags = [\n+        \"ivy-only\",\n+    ],\n+    deps = [\n+        \":test_lib\",\n+    ],\n+)"
        },
        {
            "sha": "53512751628afe4b5bdb7624062c4bc022bd3ce8",
            "filename": "packages/language-service/ivy/test/env.ts",
            "status": "added",
            "additions": 219,
            "deletions": 0,
            "changes": 219,
            "blob_url": "https://github.com/angular/angular/blob/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "raw_url": "https://github.com/angular/angular/raw/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fenv.ts?ref=b6893d23c52d5990d49308a0e87bbd36523e53fc",
            "patch": "@@ -0,0 +1,219 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {TmplAstNode} from '@angular/compiler';\n+import {StrictTemplateOptions} from '@angular/compiler-cli/src/ngtsc/core/api';\n+import {absoluteFrom, AbsoluteFsPath, FileSystem, getFileSystem, getSourceFileOrError} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {MockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+import {loadStandardTestFiles} from '@angular/compiler-cli/src/ngtsc/testing';\n+import {TemplateTypeChecker} from '@angular/compiler-cli/src/ngtsc/typecheck/api';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+import {LanguageService} from '../language_service';\n+\n+import {MockServerHost} from './mock_host';\n+\n+function writeTsconfig(\n+    fs: FileSystem, entryFiles: AbsoluteFsPath[], options: TestableOptions): void {\n+  fs.writeFile(\n+      absoluteFrom('/tsconfig.json'),\n+\n+      JSON.stringify(\n+          {\n+            compilerOptions: {\n+              strict: true,\n+              experimentalDecorators: true,\n+              moduleResolution: 'node',\n+              target: 'es2015',\n+              lib: [\n+                'dom',\n+                'es2015',\n+              ],\n+            },\n+            files: entryFiles,\n+            angularCompilerOptions: {\n+              strictTemplates: true,\n+              ...options,\n+            }\n+          },\n+          null, 2));\n+}\n+\n+export type TestableOptions = StrictTemplateOptions;\n+\n+export class LanguageServiceTestEnvironment {\n+  private constructor(private tsLS: ts.LanguageService, readonly ngLS: LanguageService) {}\n+\n+  static setup(files: TestFile[], options: TestableOptions = {}): LanguageServiceTestEnvironment {\n+    const fs = getFileSystem();\n+    if (!(fs instanceof MockFileSystem)) {\n+      throw new Error(`LanguageServiceTestEnvironment only works with a mock filesystem`);\n+    }\n+    fs.init(loadStandardTestFiles({\n+      fakeCommon: true,\n+    }));\n+\n+    const host = new MockServerHost(fs);\n+    const tsconfigPath = absoluteFrom('/tsconfig.json');\n+\n+    const entryFiles: AbsoluteFsPath[] = [];\n+    for (const {name, contents, isRoot} of files) {\n+      fs.writeFile(name, contents);\n+      if (isRoot === true) {\n+        entryFiles.push(name);\n+      }\n+    }\n+\n+    if (entryFiles.length === 0) {\n+      throw new Error(`Expected at least one root TestFile.`);\n+    }\n+\n+    writeTsconfig(fs, files.filter(file => file.isRoot === true).map(file => file.name), options);\n+\n+    const projectService = new ts.server.ProjectService({\n+      host,\n+      logger,\n+      cancellationToken: ts.server.nullCancellationToken,\n+      useSingleInferredProject: true,\n+      useInferredProjectPerProjectRoot: true,\n+      typingsInstaller: ts.server.nullTypingsInstaller,\n+    });\n+\n+    // Open all root files.\n+    for (const entryFile of entryFiles) {\n+      projectService.openClientFile(entryFile);\n+    }\n+\n+    const project = projectService.findProject(tsconfigPath);\n+    if (project === undefined) {\n+      throw new Error(`Failed to create project for ${tsconfigPath}`);\n+    }\n+    // The following operation forces a ts.Program to be created.\n+    const tsLS = project.getLanguageService();\n+\n+    const ngLS = new LanguageService(project, tsLS);\n+    return new LanguageServiceTestEnvironment(tsLS, ngLS);\n+  }\n+\n+  getClass(fileName: AbsoluteFsPath, className: string): ts.ClassDeclaration {\n+    const program = this.tsLS.getProgram();\n+    if (program === undefined) {\n+      throw new Error(`Expected to get a ts.Program`);\n+    }\n+    const sf = getSourceFileOrError(program, fileName);\n+    return getClassOrError(sf, className);\n+  }\n+\n+  overrideTemplateWithCursor(fileName: AbsoluteFsPath, className: string, contents: string):\n+      {cursor: number, nodes: TmplAstNode[], component: ts.ClassDeclaration, text: string} {\n+    const program = this.tsLS.getProgram();\n+    if (program === undefined) {\n+      throw new Error(`Expected to get a ts.Program`);\n+    }\n+    const sf = getSourceFileOrError(program, fileName);\n+    const component = getClassOrError(sf, className);\n+\n+    const ngCompiler = this.ngLS.compilerFactory.getOrCreate();\n+    const templateTypeChecker = ngCompiler.getTemplateTypeChecker();\n+\n+    const {cursor, text} = extractCursorInfo(contents);\n+\n+    const {nodes} = templateTypeChecker.overrideComponentTemplate(component, text);\n+    return {cursor, nodes, component, text};\n+  }\n+\n+  expectNoSourceDiagnostics(): void {\n+    const program = this.tsLS.getProgram();\n+    if (program === undefined) {\n+      throw new Error(`Expected to get a ts.Program`);\n+    }\n+\n+    const ngCompiler = this.ngLS.compilerFactory.getOrCreate();\n+\n+    for (const sf of program.getSourceFiles()) {\n+      if (sf.isDeclarationFile || sf.fileName.endsWith('.ngtypecheck.ts')) {\n+        continue;\n+      }\n+\n+      const syntactic = program.getSyntacticDiagnostics(sf);\n+      expect(syntactic.map(diag => diag.messageText)).toEqual([]);\n+      if (syntactic.length > 0) {\n+        continue;\n+      }\n+\n+      const semantic = program.getSemanticDiagnostics(sf);\n+      expect(semantic.map(diag => diag.messageText)).toEqual([]);\n+      if (semantic.length > 0) {\n+        continue;\n+      }\n+\n+      const ngDiagnostics = ngCompiler.getDiagnostics(sf);\n+      expect(ngDiagnostics.map(diag => diag.messageText)).toEqual([]);\n+    }\n+\n+    this.ngLS.compilerFactory.registerLastKnownProgram();\n+  }\n+\n+  expectNoTemplateDiagnostics(fileName: AbsoluteFsPath, className: string): void {\n+    const program = this.tsLS.getProgram();\n+    if (program === undefined) {\n+      throw new Error(`Expected to get a ts.Program`);\n+    }\n+    const sf = getSourceFileOrError(program, fileName);\n+    const component = getClassOrError(sf, className);\n+\n+    const diags = this.getTemplateTypeChecker().getDiagnosticsForComponent(component);\n+    this.ngLS.compilerFactory.registerLastKnownProgram();\n+    expect(diags.map(diag => diag.messageText)).toEqual([]);\n+  }\n+\n+  getTemplateTypeChecker(): TemplateTypeChecker {\n+    return this.ngLS.compilerFactory.getOrCreate().getTemplateTypeChecker();\n+  }\n+}\n+\n+const logger: ts.server.Logger = {\n+  close(): void{},\n+  hasLevel(level: ts.server.LogLevel): boolean {\n+    return false;\n+  },\n+  loggingEnabled(): boolean {\n+    return false;\n+  },\n+  perftrc(s: string): void{},\n+  info(s: string): void{},\n+  startGroup(): void{},\n+  endGroup(): void{},\n+  msg(s: string, type?: ts.server.Msg): void{},\n+  getLogFileName(): string |\n+      undefined {\n+        return;\n+      },\n+};\n+\n+\n+function getClassOrError(sf: ts.SourceFile, name: string): ts.ClassDeclaration {\n+  for (const stmt of sf.statements) {\n+    if (ts.isClassDeclaration(stmt) && stmt.name !== undefined && stmt.name.text === name) {\n+      return stmt;\n+    }\n+  }\n+  throw new Error(`Class ${name} not found in file: ${sf.fileName}: ${sf.text}`);\n+}\n+\n+function extractCursorInfo(textWithCursor: string): {cursor: number, text: string} {\n+  const cursor = textWithCursor.indexOf('¦');\n+  if (cursor === -1) {\n+    throw new Error(`Expected to find cursor symbol '¦'`);\n+  }\n+\n+  return {\n+    cursor,\n+    text: textWithCursor.substr(0, cursor) + textWithCursor.substr(cursor + 1),\n+  };\n+}"
        },
        {
            "sha": "6f99cf1aa5bfacc7e55aace2bc6a54c88b7610ed",
            "filename": "packages/language-service/ivy/test/mock_host.ts",
            "status": "added",
            "additions": 121,
            "deletions": 0,
            "changes": 121,
            "blob_url": "https://github.com/angular/angular/blob/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fmock_host.ts?ref=b6893d23c52d5990d49308a0e87bbd36523e53fc",
            "patch": "@@ -0,0 +1,121 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {MockFileSystem} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n+\n+import * as ts from 'typescript/lib/tsserverlibrary';\n+\n+const NOOP_FILE_WATCHER: ts.FileWatcher = {\n+  close() {}\n+};\n+\n+/**\n+ * Adapts from the `ts.server.ServerHost` API to an in-memory filesystem.\n+ */\n+export class MockServerHost implements ts.server.ServerHost {\n+  constructor(private fs: MockFileSystem) {}\n+\n+  get newLine(): string {\n+    return '\\n';\n+  }\n+\n+  get useCaseSensitiveFileNames(): boolean {\n+    return this.fs.isCaseSensitive();\n+  }\n+\n+  readFile(path: string, encoding?: string): string|undefined {\n+    return this.fs.readFile(absoluteFrom(path));\n+  }\n+\n+  resolvePath(path: string): string {\n+    return this.fs.resolve(path);\n+  }\n+\n+  fileExists(path: string): boolean {\n+    const absPath = absoluteFrom(path);\n+    return this.fs.exists(absPath) && this.fs.lstat(absPath).isFile();\n+  }\n+\n+  directoryExists(path: string): boolean {\n+    const absPath = absoluteFrom(path);\n+    return this.fs.exists(absPath) && this.fs.lstat(absPath).isDirectory();\n+  }\n+\n+  createDirectory(path: string): void {\n+    this.fs.ensureDir(absoluteFrom(path));\n+  }\n+\n+  getExecutingFilePath(): string {\n+    // This is load-bearing, as TypeScript uses the result of this call to locate the directory in\n+    // which it expects to find .d.ts files for the \"standard libraries\" - DOM, ES2015, etc.\n+    return '/node_modules/typescript/lib/tsserver.js';\n+  }\n+\n+  getCurrentDirectory(): string {\n+    return '/';\n+  }\n+\n+  createHash(data: string): string {\n+    return ts.sys.createHash!(data);\n+  }\n+\n+  get args(): string[] {\n+    throw new Error('Property not implemented.');\n+  }\n+\n+  watchFile(\n+      path: string, callback: ts.FileWatcherCallback, pollingInterval?: number,\n+      options?: ts.WatchOptions): ts.FileWatcher {\n+    return NOOP_FILE_WATCHER;\n+  }\n+\n+  watchDirectory(\n+      path: string, callback: ts.DirectoryWatcherCallback, recursive?: boolean,\n+      options?: ts.WatchOptions): ts.FileWatcher {\n+    return NOOP_FILE_WATCHER;\n+  }\n+\n+  setTimeout(callback: (...args: any[]) => void, ms: number, ...args: any[]) {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  clearTimeout(timeoutId: any): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  setImmediate(callback: (...args: any[]) => void, ...args: any[]) {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  clearImmediate(timeoutId: any): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  write(s: string): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  writeFile(path: string, data: string, writeByteOrderMark?: boolean): void {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  getDirectories(path: string): string[] {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  readDirectory(\n+      path: string, extensions?: readonly string[], exclude?: readonly string[],\n+      include?: readonly string[], depth?: number): string[] {\n+    throw new Error('Method not implemented.');\n+  }\n+\n+  exit(exitCode?: number): void {\n+    throw new Error('Method not implemented.');\n+  }\n+}"
        },
        {
            "sha": "404b43531aabb19938173af7a3c6b0b0d5f54386",
            "filename": "packages/language-service/ivy/test/quick_info_spec.ts",
            "status": "renamed",
            "additions": 124,
            "deletions": 48,
            "changes": 172,
            "blob_url": "https://github.com/angular/angular/blob/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/b6893d23c52d5990d49308a0e87bbd36523e53fc/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Flanguage-service%2Fivy%2Ftest%2Fquick_info_spec.ts?ref=b6893d23c52d5990d49308a0e87bbd36523e53fc",
            "patch": "@@ -6,24 +6,107 @@\n  * found in the LICENSE file at https://angular.io/license\n  */\n \n-import * as ts from 'typescript/lib/tsserverlibrary';\n+import {absoluteFrom} from '@angular/compiler-cli/src/ngtsc/file_system';\n+import {initMockFileSystem, TestFile} from '@angular/compiler-cli/src/ngtsc/file_system/testing';\n \n-import {LanguageService} from '../../language_service';\n+import * as ts from 'typescript/lib/tsserverlibrary';\n \n-import {APP_COMPONENT, MockService, setup, TEST_TEMPLATE} from './mock_host';\n+import {LanguageServiceTestEnvironment} from './env';\n+\n+function quickInfoSkeleton(): TestFile[] {\n+  return [\n+    {\n+      name: absoluteFrom('/app.ts'),\n+      contents: `\n+        import {Component, Directive, EventEmitter, Input, NgModule, Output, Pipe, PipeTransform} from '@angular/core';\n+        import {CommonModule} from '@angular/common';\n+\n+        export interface Address {\n+          streetName: string;\n+        }\n+\n+        /** The most heroic being. */\n+        export interface Hero {\n+          id: number;\n+          name: string;\n+          address?: Address;\n+        }\n+\n+        /**\n+         * This Component provides the \\`test-comp\\` selector.\n+         */\n+        /*BeginTestComponent*/ @Component({\n+          selector: 'test-comp',\n+          template: '<div>Testing: {{name}}</div>',\n+        })\n+        export class TestComponent {\n+          @Input('tcName') name!: string;\n+          @Output('test') testEvent!: EventEmitter<string>;\n+        } /*EndTestComponent*/\n+\n+        @Component({\n+          selector: 'app-cmp',\n+          templateUrl: './app.html',\n+        })\n+        export class AppCmp {\n+          hero!: Hero;\n+          heroes!: Hero[];\n+          readonlyHeroes!: ReadonlyArray<Readonly<Hero>>;\n+          /**\n+           * This is the title of the \\`AppCmp\\` Component.\n+           */\n+          title!: string;\n+          constNames!: [{readonly name: 'name'}];\n+          birthday!: Date;\n+          anyValue!: any;\n+          myClick(event: any) {}\n+          setTitle(newTitle: string) {}\n+          trackByFn!: any;\n+          name!: any;\n+        }\n+\n+        @Directive({\n+          selector: '[string-model]',\n+          exportAs: 'stringModel',\n+        })\n+        export class StringModel {\n+          @Input() model!: string;\n+          @Output() modelChange!: EventEmitter<string>;\n+        }\n+\n+        @Directive({selector: 'button[custom-button][compound]'})\n+        export class CompoundCustomButtonDirective {\n+          @Input() config?: {color?: string};\n+        }\n+\n+        @NgModule({\n+          declarations: [\n+            AppCmp,\n+            CompoundCustomButtonDirective,\n+            StringModel,\n+            TestComponent,\n+          ],\n+          imports: [\n+            CommonModule,\n+          ],\n+        })\n+        export class AppModule {}\n+      `,\n+      isRoot: true,\n+    },\n+    {\n+      name: absoluteFrom('/app.html'),\n+      contents: `Will be overridden`,\n+    }\n+  ];\n+}\n \n describe('quick info', () => {\n-  let service: MockService;\n-  let ngLS: LanguageService;\n-\n-  beforeAll(() => {\n-    const {project, service: _service, tsLS} = setup();\n-    service = _service;\n-    ngLS = new LanguageService(project, tsLS);\n-  });\n+  let env: LanguageServiceTestEnvironment;\n \n   beforeEach(() => {\n-    service.reset();\n+    initMockFileSystem('Native');\n+    env = LanguageServiceTestEnvironment.setup(quickInfoSkeleton());\n   });\n \n   describe('elements', () => {\n@@ -78,24 +161,23 @@ describe('quick info', () => {\n       const {documentation} = expectQuickInfo({\n         templateOverride: `<div *¦ngFor=\"let item of heroes\"></div>`,\n         expectedSpanText: 'ngFor',\n-        expectedDisplayString: '(directive) NgForOf<Hero, Array<Hero>>'\n+        expectedDisplayString: '(directive) NgForOf<Hero, Hero[]>'\n       });\n-      expect(toText(documentation))\n-          .toContain('A [structural directive](guide/structural-directives) that renders');\n+      expect(toText(documentation)).toContain('A fake version of the NgFor directive.');\n     });\n \n     it('should work for directives with compound selectors, some of which are bindings', () => {\n       expectQuickInfo({\n-        templateOverride: `<ng-template ngF¦or let-hero [ngForOf]=\"heroes\">{{item}}</ng-template>`,\n+        templateOverride: `<ng-template ngF¦or let-hero [ngForOf]=\"heroes\">{{hero}}</ng-template>`,\n         expectedSpanText: 'ngFor',\n-        expectedDisplayString: '(directive) NgForOf<Hero, Array<Hero>>'\n+        expectedDisplayString: '(directive) NgForOf<Hero, Hero[]>'\n       });\n     });\n \n     it('should work for data-let- syntax', () => {\n       expectQuickInfo({\n         templateOverride:\n-            `<ng-template ngFor data-let-he¦ro [ngForOf]=\"heroes\">{{item}}</ng-template>`,\n+            `<ng-template ngFor data-let-he¦ro [ngForOf]=\"heroes\">{{hero}}</ng-template>`,\n         expectedSpanText: 'hero',\n         expectedDisplayString: '(variable) hero: Hero'\n       });\n@@ -127,7 +209,7 @@ describe('quick info', () => {\n \n       it('should work for structural directive inputs ngForTrackBy', () => {\n         expectQuickInfo({\n-          templateOverride: `<div *ngFor=\"let item of heroes; tr¦ackBy: test;\"></div>`,\n+          templateOverride: `<div *ngFor=\"let item of heroes; tr¦ackBy: trackByFn;\"></div>`,\n           expectedSpanText: 'trackBy',\n           expectedDisplayString:\n               '(property) NgForOf<Hero, Hero[]>.ngForTrackBy: TrackByFunction<Hero>'\n@@ -136,7 +218,7 @@ describe('quick info', () => {\n \n       it('should work for structural directive inputs ngForOf', () => {\n         expectQuickInfo({\n-          templateOverride: `<div *ngFor=\"let item o¦f heroes; trackBy: test;\"></div>`,\n+          templateOverride: `<div *ngFor=\"let item o¦f heroes; trackBy: trackByFn;\"></div>`,\n           expectedSpanText: 'of',\n           expectedDisplayString:\n               '(property) NgForOf<Hero, Hero[]>.ngForOf: Hero[] | (Hero[] & Iterable<Hero>) | null | undefined'\n@@ -157,20 +239,20 @@ describe('quick info', () => {\n         expectQuickInfo({\n           templateOverride: `<test-comp (te¦st)=\"myClick($event)\"></test-comp>`,\n           expectedSpanText: 'test',\n-          expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<any>'\n+          expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<string>'\n         });\n       });\n \n       it('should work for on- syntax binding', () => {\n         expectQuickInfo({\n           templateOverride: `<test-comp on-te¦st=\"myClick($event)\"></test-comp>`,\n           expectedSpanText: 'test',\n-          expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<any>'\n+          expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<string>'\n         });\n         expectQuickInfo({\n           templateOverride: `<test-comp data-on-te¦st=\"myClick($event)\"></test-comp>`,\n           expectedSpanText: 'test',\n-          expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<any>'\n+          expectedDisplayString: '(event) TestComponent.testEvent: EventEmitter<string>'\n         });\n       });\n \n@@ -272,7 +354,7 @@ describe('quick info', () => {\n       expectQuickInfo({\n         templateOverride: `<div>{{ tit¦le }}</div>`,\n         expectedSpanText: 'title',\n-        expectedDisplayString: '(property) AppComponent.title: string'\n+        expectedDisplayString: '(property) AppCmp.title: string'\n       });\n     });\n \n@@ -288,15 +370,15 @@ describe('quick info', () => {\n       expectQuickInfo({\n         templateOverride: `<div string-model model=\"{{tit¦le}}\"></div>`,\n         expectedSpanText: 'title',\n-        expectedDisplayString: '(property) AppComponent.title: string'\n+        expectedDisplayString: '(property) AppCmp.title: string'\n       });\n     });\n \n     it('should find members of input binding', () => {\n       expectQuickInfo({\n         templateOverride: `<test-comp [tcName]=\"ti¦tle\"></test-comp>`,\n         expectedSpanText: 'title',\n-        expectedDisplayString: '(property) AppComponent.title: string'\n+        expectedDisplayString: '(property) AppCmp.title: string'\n       });\n     });\n \n@@ -312,15 +394,15 @@ describe('quick info', () => {\n       expectQuickInfo({\n         templateOverride: `<test-comp (test)=\"ti¦tle=$event\"></test-comp>`,\n         expectedSpanText: 'title',\n-        expectedDisplayString: '(property) AppComponent.title: string'\n+        expectedDisplayString: '(property) AppCmp.title: string'\n       });\n     });\n \n     it('should work for method calls', () => {\n       expectQuickInfo({\n         templateOverride: `<div (click)=\"setT¦itle('title')\"></div>`,\n         expectedSpanText: 'setTitle',\n-        expectedDisplayString: '(method) AppComponent.setTitle(newTitle: string): void'\n+        expectedDisplayString: '(method) AppCmp.setTitle(newTitle: string): void'\n       });\n     });\n \n@@ -342,25 +424,25 @@ describe('quick info', () => {\n \n     it('should find members of two-way binding', () => {\n       expectQuickInfo({\n-        templateOverride: `<input [(ngModel)]=\"ti¦tle\" />`,\n+        templateOverride: `<input string-model [(model)]=\"ti¦tle\" />`,\n         expectedSpanText: 'title',\n-        expectedDisplayString: '(property) AppComponent.title: string'\n+        expectedDisplayString: '(property) AppCmp.title: string'\n       });\n     });\n \n     it('should find members in a structural directive', () => {\n       expectQuickInfo({\n         templateOverride: `<div *ngIf=\"anyV¦alue\"></div>`,\n         expectedSpanText: 'anyValue',\n-        expectedDisplayString: '(property) AppComponent.anyValue: any'\n+        expectedDisplayString: '(property) AppCmp.anyValue: any'\n       });\n     });\n \n     it('should work for members in structural directives', () => {\n       expectQuickInfo({\n-        templateOverride: `<div *ngFor=\"let item of her¦oes; trackBy: test;\"></div>`,\n+        templateOverride: `<div *ngFor=\"let item of her¦oes; trackBy: trackByFn;\"></div>`,\n         expectedSpanText: 'heroes',\n-        expectedDisplayString: '(property) AppComponent.heroes: Hero[]'\n+        expectedDisplayString: '(property) AppCmp.heroes: Hero[]'\n       });\n     });\n \n@@ -373,29 +455,23 @@ describe('quick info', () => {\n     });\n \n     it('should provide documentation', () => {\n-      const {position} = service.overwriteInlineTemplate(APP_COMPONENT, `<div>{{¦title}}</div>`);\n-      const quickInfo = ngLS.getQuickInfoAtPosition(APP_COMPONENT, position);\n+      const {cursor} = env.overrideTemplateWithCursor(\n+          absoluteFrom('/app.ts'), 'AppCmp', `<div>{{¦title}}</div>`);\n+      const quickInfo = env.ngLS.getQuickInfoAtPosition(absoluteFrom('/app.html'), cursor);\n       const documentation = toText(quickInfo!.documentation);\n-      expect(documentation).toBe('This is the title of the `AppComponent` Component.');\n-    });\n-\n-    it('works with external template', () => {\n-      const {position, text} = service.overwrite(TEST_TEMPLATE, '<butt¦on></button>');\n-      const quickInfo = ngLS.getQuickInfoAtPosition(TEST_TEMPLATE, position);\n-      expect(quickInfo).toBeTruthy();\n-      const {textSpan, displayParts} = quickInfo!;\n-      expect(text.substring(textSpan.start, textSpan.start + textSpan.length))\n-          .toEqual('<button></button>');\n-      expect(toText(displayParts)).toEqual('(element) button: HTMLButtonElement');\n+      expect(documentation).toBe('This is the title of the `AppCmp` Component.');\n     });\n   });\n \n   function expectQuickInfo(\n       {templateOverride, expectedSpanText, expectedDisplayString}:\n           {templateOverride: string, expectedSpanText: string, expectedDisplayString: string}):\n       ts.QuickInfo {\n-    const {position, text} = service.overwriteInlineTemplate(APP_COMPONENT, templateOverride);\n-    const quickInfo = ngLS.getQuickInfoAtPosition(APP_COMPONENT, position);\n+    const {cursor, text} =\n+        env.overrideTemplateWithCursor(absoluteFrom('/app.ts'), 'AppCmp', templateOverride);\n+    env.expectNoSourceDiagnostics();\n+    env.expectNoTemplateDiagnostics(absoluteFrom('/app.ts'), 'AppCmp');\n+    const quickInfo = env.ngLS.getQuickInfoAtPosition(absoluteFrom('/app.html'), cursor);\n     expect(quickInfo).toBeTruthy();\n     const {textSpan, displayParts} = quickInfo!;\n     expect(text.substring(textSpan.start, textSpan.start + textSpan.length))",
            "previous_filename": "packages/language-service/ivy/test/legacy/quick_info_spec.ts"
        }
    ],
    "stats": {
        "total": 594,
        "additions": 528,
        "deletions": 66
    }
}