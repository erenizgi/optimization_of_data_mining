{
    "author": "atscott",
    "message": "fix(router): eagerly update internal state on browser-triggered navigations (#43102)\n\nThe management of `browserUrlTree` currently has several problems with\ncorrectly tracking the actual state of the browser.\n\nThis change makes the Router eagerly update the `browserUrlTree` when\nhandling navigations triggered by browser events (i.e., not 'imperative'). This\nis because with those types of navigations, the browser URL bar is\n_already_ updated. If we do not update the internal tracking of the\n`browserUrlTree`, we will be out of sync with the real URL if the\nnavigation is rejected.\n\nIt would be best if we could remove `browserUrlTree` completely, but doing that\nwould require a lot more investigation and is blocked by #27059 because\nthe SpyLocation used in tests does not emulate real browser behavior.\n\nfixes #43101\n\nPR Close #43102",
    "sha": "286b2807de61dcd6e24ced5c142fbc6eda9dfbec",
    "files": [
        {
            "sha": "dec8ec5a667b3d35250ffb13db4783c3f2d3562d",
            "filename": "packages/core/test/bundling/router/bundle.golden_symbols.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/angular/angular/blob/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "raw_url": "https://github.com/angular/angular/raw/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcore%2Ftest%2Fbundling%2Frouter%2Fbundle.golden_symbols.json?ref=286b2807de61dcd6e24ced5c142fbc6eda9dfbec",
            "patch": "@@ -1526,6 +1526,9 @@\n   {\n     \"name\": \"isArrayLike\"\n   },\n+  {\n+    \"name\": \"isBrowserTriggeredNavigation\"\n+  },\n   {\n     \"name\": \"isCommandWithOutlets\"\n   },"
        },
        {
            "sha": "f1641ac8588c56383ba65b64af90fdff6aa9eb63",
            "filename": "packages/router/src/router.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/angular/angular/blob/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Frouter%2Fsrc%2Frouter.ts",
            "raw_url": "https://github.com/angular/angular/raw/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Frouter%2Fsrc%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Fsrc%2Frouter.ts?ref=286b2807de61dcd6e24ced5c142fbc6eda9dfbec",
            "patch": "@@ -636,6 +636,12 @@ export class Router {\n                            (this.onSameUrlNavigation === 'reload' ? true : urlTransition) &&\n                            this.urlHandlingStrategy.shouldProcessUrl(t.rawUrl);\n \n+                       // If the source of the navigation is from a browser event, the URL is\n+                       // already updated. We already need to sync the internal state.\n+                       if (isBrowserTriggeredNavigation(t.source)) {\n+                         this.browserUrlTree = t.rawUrl;\n+                       }\n+\n                        if (processCurrentUrl) {\n                          return of(t).pipe(\n                              // Fire NavigationStart event\n@@ -954,7 +960,12 @@ export class Router {\n                                  this.urlHandlingStrategy.merge(e.url, this.rawUrlTree);\n                              const extras = {\n                                skipLocationChange: t.extras.skipLocationChange,\n-                               replaceUrl: this.urlUpdateStrategy === 'eager'\n+                               // The URL is already updated at this point if we have 'eager' URL\n+                               // updates or if the navigation was triggered by the browser (back\n+                               // button, URL bar, etc). We want to replace that item in history if\n+                               // the navigation is rejected.\n+                               replaceUrl: this.urlUpdateStrategy === 'eager' ||\n+                                   isBrowserTriggeredNavigation(t.source)\n                              };\n \n                              this.scheduleNavigation(\n@@ -1385,8 +1396,8 @@ export class Router {\n     const lastNavigation = this.getTransition();\n     // We don't want to skip duplicate successful navs if they're imperative because\n     // onSameUrlNavigation could be 'reload' (so the duplicate is intended).\n-    const browserNavPrecededByRouterNav =\n-        source !== 'imperative' && lastNavigation?.source === 'imperative';\n+    const browserNavPrecededByRouterNav = isBrowserTriggeredNavigation(source) && lastNavigation &&\n+        !isBrowserTriggeredNavigation(lastNavigation.source);\n     const lastNavigationSucceeded = this.lastSuccessfulId === lastNavigation.id;\n     // If the last navigation succeeded or is in flight, we can use the rawUrl as the comparison.\n     // However, if it failed, we should compare to the final result (urlAfterRedirects).\n@@ -1549,3 +1560,7 @@ function validateCommands(commands: string[]): void {\n     }\n   }\n }\n+\n+function isBrowserTriggeredNavigation(source: 'imperative'|'popstate'|'hashchange') {\n+  return source !== 'imperative';\n+}"
        },
        {
            "sha": "3e9210b418af1b98805f596bc2b1d8f18996d566",
            "filename": "packages/router/test/integration.spec.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/angular/angular/blob/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Frouter%2Ftest%2Fintegration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fintegration.spec.ts?ref=286b2807de61dcd6e24ced5c142fbc6eda9dfbec",
            "patch": "@@ -1230,7 +1230,11 @@ describe('Integration', () => {\n          location.simulateHashChange('/blocked');\n \n          advance(fixture);\n-         expectEvents(recordedEvents, [[NavigationStart, '/blocked']]);\n+         expectEvents(recordedEvents, [\n+           [NavigationStart, '/blocked'],\n+           [NavigationStart, '/simple'],\n+           [NavigationEnd, '/simple'],\n+         ]);\n        }));\n   });\n "
        },
        {
            "sha": "9df54ddeae11ab62a8854e1c7d7570c868b5b02b",
            "filename": "packages/router/test/regression_integration.spec.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/angular/angular/blob/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/286b2807de61dcd6e24ced5c142fbc6eda9dfbec/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Frouter%2Ftest%2Fregression_integration.spec.ts?ref=286b2807de61dcd6e24ced5c142fbc6eda9dfbec",
            "patch": "@@ -266,14 +266,9 @@ describe('Integration', () => {\n          location.simulateHashChange('/one');\n          advance(fixture);\n \n-         const BASE_ERROR_MESSAGE =\n-             'This asserts current behavior, which is incorrect. When #28561 is fixed, it should be: ';\n-\n-         expect(location.path()).toEqual('/one', BASE_ERROR_MESSAGE + '/');\n-         const urlChanges = ['replace: /', 'hash: /one'];\n-         expect(location.urlChanges)\n-             .toEqual(\n-                 urlChanges, BASE_ERROR_MESSAGE + JSON.stringify(urlChanges.concat('replace: /')));\n+         expect(location.path()).toEqual('/');\n+         const urlChanges = ['replace: /', 'hash: /one', 'replace: /'];\n+         expect(location.urlChanges).toEqual(urlChanges);\n        }));\n   });\n });"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 29,
        "deletions": 12
    }
}