{
    "author": "gkalpak",
    "message": "test(service-worker): better align mock event implementations with actual implementations (#42736)\n\nThis commit better aligns the mock event implementations used in\nServiceWorker tests (and the associated typings) with the actual\nimplementations (and the official TypeScript typings). This allows\nverifying the ServiceWorker behavior in a slightly more realistic\nenvironment.\n\nThis is in preparation of switching from our custom typings to the\nofficial TypeScript typings (`lib.webworker.d.ts`).\n\nPR Close #42736",
    "sha": "22a81231f2dae4eb4766c213be46a52fe98b1b8b",
    "files": [
        {
            "sha": "f01adabfe6d9fb0267a86e9b1265d7d3cdf291ac",
            "filename": "packages/service-worker/worker/src/service-worker.d.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 17,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "raw_url": "https://github.com/angular/angular/raw/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Fsrc%2Fservice-worker.d.ts?ref=22a81231f2dae4eb4766c213be46a52fe98b1b8b",
            "patch": "@@ -64,29 +64,24 @@ type WindowClientState = 'hidden'|'visible'|'prerender'|'unloaded';\n // Fetch API\n \n interface FetchEvent extends ExtendableEvent {\n-  request: Request;\n-  clientId?: string;\n-  resultingClientId?: string;\n-  respondWith(response: Promise<Response>|Response): Promise<Response>;\n+  readonly clientId: string;\n+  readonly preloadResponse: Promise<any>;\n+  readonly request: Request;\n+  readonly resultingClientId: string;\n+  respondWith(r: Response|Promise<Response>): void;\n }\n \n-interface InstallEvent extends ExtendableEvent {\n-  activeWorker: ServiceWorker;\n-}\n-\n-interface ActivateEvent extends ExtendableEvent {}\n-\n // Notification API\n \n interface NotificationEvent extends ExtendableEvent {\n-  action: string;\n-  notification: Notification;\n+  readonly action: string;\n+  readonly notification: Notification;\n }\n \n // Push API\n \n interface PushEvent extends ExtendableEvent {\n-  data: PushMessageData;\n+  readonly data: PushMessageData|null;\n }\n \n interface PushMessageData {\n@@ -99,13 +94,16 @@ interface PushMessageData {\n // Sync API\n \n interface SyncEvent extends ExtendableEvent {\n-  lastChance: boolean;\n-  tag: string;\n+  readonly lastChance: boolean;\n+  readonly tag: string;\n }\n \n interface ExtendableMessageEvent extends ExtendableEvent {\n-  data: any;\n-  source: Client|Object;\n+  readonly data: any;\n+  readonly lastEventId: string;\n+  readonly origin: string;\n+  readonly ports: ReadonlyArray<MessagePort>;\n+  readonly source: Client|ServiceWorker|MessagePort|null;\n }\n \n // ServiceWorkerGlobalScope"
        },
        {
            "sha": "fafff3990b8a0502fd3ebc3888fb56b961002fcb",
            "filename": "packages/service-worker/worker/test/happy_spec.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftest%2Fhappy_spec.ts?ref=22a81231f2dae4eb4766c213be46a52fe98b1b8b",
            "patch": "@@ -783,7 +783,7 @@ describe('Driver', () => {\n       const message: any = scope.clients.getMock('default')!.messages[0];\n \n       expect(message.type).toEqual('NOTIFICATION_CLICK');\n-      expect(message.data.action).toBeUndefined();\n+      expect(message.data.action).toBe('');\n       expect(message.data.notification.title).toEqual('This is a test without action');\n       expect(message.data.notification.body).toEqual('Test body without action');\n     });"
        },
        {
            "sha": "bedd3a7ce1787a0c47824772ab5db824aeef9785",
            "filename": "packages/service-worker/worker/testing/events.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 14,
            "changes": 34,
            "blob_url": "https://github.com/angular/angular/blob/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Ftesting%2Fevents.ts",
            "raw_url": "https://github.com/angular/angular/raw/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Ftesting%2Fevents.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fevents.ts?ref=22a81231f2dae4eb4766c213be46a52fe98b1b8b",
            "patch": "@@ -49,7 +49,7 @@ export class MockEvent implements Event {\n }\n \n export class MockExtendableEvent extends MockEvent implements ExtendableEvent {\n-  private queue: Promise<void>[] = [];\n+  private queue: Promise<unknown>[] = [];\n \n   get ready(): Promise<void> {\n     return (async () => {\n@@ -59,7 +59,7 @@ export class MockExtendableEvent extends MockEvent implements ExtendableEvent {\n     })();\n   }\n \n-  waitUntil(promise: Promise<void>): void {\n+  waitUntil(promise: Promise<unknown>): void {\n     this.queue.push(promise);\n   }\n }\n@@ -70,17 +70,17 @@ export class MockActivateEvent extends MockExtendableEvent {\n   }\n }\n \n-export class MockFetchEvent extends MockExtendableEvent {\n+export class MockFetchEvent extends MockExtendableEvent implements FetchEvent {\n+  readonly preloadResponse = Promise.resolve();\n   response: Promise<Response|undefined> = Promise.resolve(undefined);\n \n   constructor(\n       readonly request: Request, readonly clientId: string, readonly resultingClientId: string) {\n     super('fetch');\n   }\n \n-  respondWith(promise: Promise<Response>): Promise<Response> {\n-    this.response = promise;\n-    return promise;\n+  respondWith(r: Response|Promise<Response>): void {\n+    this.response = Promise.resolve(r);\n   }\n }\n \n@@ -90,27 +90,33 @@ export class MockInstallEvent extends MockExtendableEvent {\n   }\n }\n \n-export class MockMessageEvent extends MockExtendableEvent {\n-  constructor(readonly data: Object, readonly source: MockClient|null) {\n+export class MockExtendableMessageEvent extends MockExtendableEvent implements\n+    ExtendableMessageEvent {\n+  readonly lastEventId = '';\n+  readonly origin = '';\n+  readonly ports: ReadonlyArray<MessagePort> = [];\n+\n+  constructor(readonly data: any, readonly source: Client|MessagePort|ServiceWorker|null) {\n     super('message');\n   }\n }\n \n-export class MockNotificationEvent extends MockExtendableEvent {\n+export class MockNotificationEvent extends MockExtendableEvent implements NotificationEvent {\n   readonly notification = {\n     ...this._notification,\n     close: () => undefined,\n-  };\n+  } as Notification;\n \n-  constructor(private _notification: any, readonly action?: string) {\n+  constructor(private _notification: Partial<Notification>, readonly action = '') {\n     super('notification');\n   }\n }\n \n-export class MockPushEvent extends MockExtendableEvent {\n-  data = {\n+export class MockPushEvent extends MockExtendableEvent implements PushEvent {\n+  readonly data = {\n     json: () => this._data,\n-  };\n+    text: () => JSON.stringify(this._data),\n+  } as PushMessageData;\n \n   constructor(private _data: object) {\n     super('push');"
        },
        {
            "sha": "3dd0dcac5b5f89e166b17ea98af3ba2a1e80364d",
            "filename": "packages/service-worker/worker/testing/scope.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/angular/angular/blob/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "raw_url": "https://github.com/angular/angular/raw/22a81231f2dae4eb4766c213be46a52fe98b1b8b/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fservice-worker%2Fworker%2Ftesting%2Fscope.ts?ref=22a81231f2dae4eb4766c213be46a52fe98b1b8b",
            "patch": "@@ -13,7 +13,7 @@ import {AssetGroupConfig, Manifest} from '../src/manifest';\n import {sha1} from '../src/sha1';\n \n import {MockCacheStorage} from './cache';\n-import {MockActivateEvent, MockFetchEvent, MockInstallEvent, MockMessageEvent, MockNotificationEvent, MockPushEvent} from './events';\n+import {MockActivateEvent, MockExtendableMessageEvent, MockFetchEvent, MockInstallEvent, MockNotificationEvent, MockPushEvent} from './events';\n import {MockHeaders, MockRequest, MockResponse} from './fetch';\n import {MockServerState, MockServerStateBuilder} from './mock';\n import {normalizeUrl, parseUrl} from './utils';\n@@ -244,12 +244,13 @@ export class SwTestHarness extends Adapter<MockCacheStorage> implements ServiceW\n     if (!this.eventHandlers.has('message')) {\n       throw new Error('No message handler registered');\n     }\n-    let event: MockMessageEvent;\n+    let event: MockExtendableMessageEvent;\n     if (clientId === null) {\n-      event = new MockMessageEvent(data, null);\n+      event = new MockExtendableMessageEvent(data, null);\n     } else {\n       this.clients.add(clientId);\n-      event = new MockMessageEvent(data, this.clients.getMock(clientId) || null);\n+      event = new MockExtendableMessageEvent(\n+          data, this.clients.getMock(clientId) as unknown as Client || null);\n     }\n     this.eventHandlers.get('message')!.call(this, event);\n     return event.ready;"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 41,
        "deletions": 36
    }
}