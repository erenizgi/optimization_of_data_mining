{
    "author": "alan-agius4",
    "message": "feat(dev-infra): validate breaking changes commit messages (#41274)\n\nWith this change we valid breaking changes descriptions as per our contribution guidelines\n\nSee: https://github.com/angular/angular/blob/88fbc066775ab1a2f6a8c75f933375b46d8fa9a4/CONTRIBUTING.md#commit-message-footer\n\nPR Close #41274",
    "sha": "e8cae22d666f0be50db666b250f92bc02bfe9a06",
    "files": [
        {
            "sha": "92632ed74a5e332a790978b4f8ecf757325d62fb",
            "filename": "dev-infra/commit-message/validate.spec.ts",
            "status": "modified",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/angular/angular/blob/e8cae22d666f0be50db666b250f92bc02bfe9a06/dev-infra%2Fcommit-message%2Fvalidate.spec.ts",
            "raw_url": "https://github.com/angular/angular/raw/e8cae22d666f0be50db666b250f92bc02bfe9a06/dev-infra%2Fcommit-message%2Fvalidate.spec.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate.spec.ts?ref=e8cae22d666f0be50db666b250f92bc02bfe9a06",
            "patch": "@@ -263,5 +263,72 @@ describe('validate-commit-message.js', () => {\n                VALID);\n          });\n     });\n+\n+    describe('breaking change', () => {\n+      it('should allow valid breaking change commit descriptions', () => {\n+        const msgWithSummary = 'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE: This is a summary of a breaking change.';\n+        expectValidationResult(validateCommitMessage(msgWithSummary), VALID);\n+\n+        const msgWithDescription = 'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE:\\n\\n' +\n+            'This is a full description of the breaking change.';\n+        expectValidationResult(validateCommitMessage(msgWithDescription), VALID);\n+\n+        const msgWithSummaryAndDescription =\n+            'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE: This is a summary of a breaking change.\\n\\n' +\n+            'This is a full description of the breaking change.';\n+        expectValidationResult(validateCommitMessage(msgWithSummaryAndDescription), VALID);\n+\n+        const msgWithNonBreaking = 'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is not a\\n' +\n+            'breaking change commit.';\n+        expectValidationResult(validateCommitMessage(msgWithNonBreaking), VALID);\n+      });\n+\n+      it('should fail for non-valid breaking change commit descriptions', () => {\n+        const msgWithSummary = 'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE This is a summary of a breaking change.';\n+        expectValidationResult(\n+            validateCommitMessage(msgWithSummary), INVALID,\n+            [`The commit message body contains an invalid breaking change description.`]);\n+\n+        const msgWithPlural = 'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGES: This is a summary of a breaking change.';\n+        expectValidationResult(\n+            validateCommitMessage(msgWithPlural), INVALID,\n+            [`The commit message body contains an invalid breaking change description.`]);\n+\n+        const msgWithDescription = 'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE:\\n' +\n+            'This is a full description of the breaking change.';\n+        expectValidationResult(\n+            validateCommitMessage(msgWithDescription), INVALID,\n+            [`The commit message body contains an invalid breaking change description.`]);\n+\n+        const msgWithSummaryAndDescription =\n+            'feat(compiler): this is just an usual commit message tile\\n\\n' +\n+            'This is a normal commit message body which does not exceed the max length\\n' +\n+            'limit. For more details see the following super long URL:\\n\\n' +\n+            'BREAKING CHANGE\\n\\n' +\n+            'This is a full description of the breaking change.';\n+        expectValidationResult(\n+            validateCommitMessage(msgWithSummaryAndDescription), INVALID,\n+            [`The commit message body contains an invalid breaking change description.`]);\n+      });\n+    });\n   });\n });"
        },
        {
            "sha": "3fa93c23fb2925e454fa227ebd79451d598e532e",
            "filename": "dev-infra/commit-message/validate.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 2,
            "changes": 32,
            "blob_url": "https://github.com/angular/angular/blob/e8cae22d666f0be50db666b250f92bc02bfe9a06/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "raw_url": "https://github.com/angular/angular/raw/e8cae22d666f0be50db666b250f92bc02bfe9a06/dev-infra%2Fcommit-message%2Fvalidate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcommit-message%2Fvalidate.ts?ref=e8cae22d666f0be50db666b250f92bc02bfe9a06",
            "patch": "@@ -25,6 +25,16 @@ export interface ValidateCommitMessageResult {\n \n /** Regex matching a URL for an entire commit body line. */\n const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n+/**\n+ * Regex matching a breaking change.\n+ *\n+ * - Starts with BREAKING CHANGE\n+ * - Followed by a colon\n+ * - Followed by a single space or two consecutive new lines\n+ *\n+ * NB: Anything after `BREAKING CHANGE` is optional to facilitate the validation.\n+ */\n+const COMMIT_BODY_BREAKING_CHANGE_RE = /^BREAKING CHANGE(:( |\\n{2}))?/m;\n \n /** Validate a commit message against using the local repo's config. */\n export function validateCommitMessage(\n@@ -137,11 +147,24 @@ export function validateCommitMessage(\n     });\n \n     if (lineExceedsMaxLength) {\n-      errors.push(\n-          `The commit message body contains lines greater than ${config.maxLineLength} characters`);\n+      errors.push(`The commit message body contains lines greater than ${\n+          config.maxLineLength} characters.`);\n       return false;\n     }\n \n+    // Breaking change\n+    // Check if the commit message contains a valid break change description.\n+    // https://github.com/angular/angular/blob/88fbc066775ab1a2f6a8c75f933375b46d8fa9a4/CONTRIBUTING.md#commit-message-footer\n+    const hasBreakingChange = COMMIT_BODY_BREAKING_CHANGE_RE.exec(commit.body);\n+    if (hasBreakingChange !== null) {\n+      const [, breakingChangeDescription] = hasBreakingChange;\n+      if (!breakingChangeDescription) {\n+        // Not followed by :, space or two consecutive new lines,\n+        errors.push(`The commit message body contains an invalid breaking change description.`);\n+        return false;\n+      }\n+    }\n+\n     return true;\n   }\n \n@@ -160,4 +183,9 @@ export function printValidationErrors(errors: string[], print = error) {\n   print();\n   print('<body>');\n   print();\n+  print(`BREAKING CHANGE: <breaking change summary>`);\n+  print();\n+  print(`<breaking change description>`);\n+  print();\n+  print();\n }"
        },
        {
            "sha": "d3be1df1875cdcdd26feaac59a2c3680dadcc63a",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 28,
            "deletions": 1,
            "changes": 29,
            "blob_url": "https://github.com/angular/angular/blob/e8cae22d666f0be50db666b250f92bc02bfe9a06/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/e8cae22d666f0be50db666b250f92bc02bfe9a06/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=e8cae22d666f0be50db666b250f92bc02bfe9a06",
            "patch": "@@ -1817,6 +1817,16 @@ function parseCommitMessagesForRange(range) {\n  */\n /** Regex matching a URL for an entire commit body line. */\n const COMMIT_BODY_URL_LINE_RE = /^https?:\\/\\/.*$/;\n+/**\n+ * Regex matching a breaking change.\n+ *\n+ * - Starts with BREAKING CHANGE\n+ * - Followed by a colon\n+ * - Followed by a single space or two consecutive new lines\n+ *\n+ * NB: Anything after `BREAKING CHANGE` is optional to facilitate the validation.\n+ */\n+const COMMIT_BODY_BREAKING_CHANGE_RE = /^BREAKING CHANGE(:( |\\n{2}))?/m;\n /** Validate a commit message against using the local repo's config. */\n function validateCommitMessage(commitMsg, options = {}) {\n     const config = getCommitMessageConfig().commitMessage;\n@@ -1903,9 +1913,21 @@ function validateCommitMessage(commitMsg, options = {}) {\n             return line.length > config.maxLineLength && !COMMIT_BODY_URL_LINE_RE.test(line);\n         });\n         if (lineExceedsMaxLength) {\n-            errors.push(`The commit message body contains lines greater than ${config.maxLineLength} characters`);\n+            errors.push(`The commit message body contains lines greater than ${config.maxLineLength} characters.`);\n             return false;\n         }\n+        // Breaking change\n+        // Check if the commit message contains a valid break change description.\n+        // https://github.com/angular/angular/blob/88fbc066775ab1a2f6a8c75f933375b46d8fa9a4/CONTRIBUTING.md#commit-message-footer\n+        const hasBreakingChange = COMMIT_BODY_BREAKING_CHANGE_RE.exec(commit.body);\n+        if (hasBreakingChange !== null) {\n+            const [, breakingChangeDescription] = hasBreakingChange;\n+            if (!breakingChangeDescription) {\n+                // Not followed by :, space or two consecutive new lines,\n+                errors.push(`The commit message body contains an invalid breaking change description.`);\n+                return false;\n+            }\n+        }\n         return true;\n     }\n     return { valid: validateCommitAndCollectErrors(), errors, commit };\n@@ -1921,6 +1943,11 @@ function printValidationErrors(errors, print = error) {\n     print();\n     print('<body>');\n     print();\n+    print(`BREAKING CHANGE: <breaking change summary>`);\n+    print();\n+    print(`<breaking change description>`);\n+    print();\n+    print();\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 125,
        "deletions": 3
    }
}