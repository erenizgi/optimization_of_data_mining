{
    "author": "bjarkler",
    "message": "feat(compiler): support error reporting in I18nMetaVisitor (#39554)\n\nMake it possible to report errors from the I18nMetaVisitor parser.\n\nPR Close #39554",
    "sha": "bb70a9bda42e34b5d75be55b672b13b1e578cddf",
    "files": [
        {
            "sha": "6c93cbebf33a0cf9ab4f3f4513ac0546529e1328",
            "filename": "packages/compiler/src/render3/view/i18n/meta.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/bb70a9bda42e34b5d75be55b672b13b1e578cddf/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb70a9bda42e34b5d75be55b672b13b1e578cddf/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Fi18n%2Fmeta.ts?ref=bb70a9bda42e34b5d75be55b672b13b1e578cddf",
            "patch": "@@ -9,8 +9,10 @@\n import {computeDecimalDigest, computeDigest, decimalDigest} from '../../../i18n/digest';\n import * as i18n from '../../../i18n/i18n_ast';\n import {createI18nMessageFactory, VisitNodeFn} from '../../../i18n/i18n_parser';\n+import {I18nError} from '../../../i18n/parse_util';\n import * as html from '../../../ml_parser/ast';\n import {DEFAULT_INTERPOLATION_CONFIG, InterpolationConfig} from '../../../ml_parser/interpolation_config';\n+import {ParseTreeResult} from '../../../ml_parser/parser';\n import * as o from '../../../output/output_ast';\n \n import {hasI18nAttrs, I18N_ATTR, I18N_ATTR_PREFIX, icuFromI18nMessage} from './util';\n@@ -46,6 +48,7 @@ const setI18nRefs: VisitNodeFn = (htmlNode, i18nNode) => {\n export class I18nMetaVisitor implements html.Visitor {\n   // whether visited nodes contain i18n information\n   public hasI18nMeta: boolean = false;\n+  private _errors: I18nError[] = [];\n \n   // i18n message generation factory\n   private _createI18nMessage = createI18nMessageFactory(this.interpolationConfig);\n@@ -64,6 +67,11 @@ export class I18nMetaVisitor implements html.Visitor {\n     return message;\n   }\n \n+  visitAllWithErrors(nodes: html.Node[]): ParseTreeResult {\n+    const result = nodes.map(node => node.visit(this, null));\n+    return new ParseTreeResult(result, this._errors);\n+  }\n+\n   visitElement(element: html.Element): any {\n     if (hasI18nAttrs(element)) {\n       this.hasI18nMeta = true;\n@@ -193,6 +201,10 @@ export class I18nMetaVisitor implements html.Visitor {\n       message.legacyIds = previousMessage ? previousMessage.legacyIds : [];\n     }\n   }\n+\n+  private _reportError(node: html.Node, msg: string): void {\n+    this._errors.push(new I18nError(node.sourceSpan, msg));\n+  }\n }\n \n /** I18n separators for metadata **/"
        },
        {
            "sha": "22b69343fb5047cc3df878483e9e3b599aaec404",
            "filename": "packages/compiler/src/render3/view/template.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/angular/angular/blob/bb70a9bda42e34b5d75be55b672b13b1e578cddf/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "raw_url": "https://github.com/angular/angular/raw/bb70a9bda42e34b5d75be55b672b13b1e578cddf/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler%2Fsrc%2Frender3%2Fview%2Ftemplate.ts?ref=bb70a9bda42e34b5d75be55b672b13b1e578cddf",
            "patch": "@@ -2073,7 +2073,22 @@ export function parseTemplate(\n   const i18nMetaVisitor = new I18nMetaVisitor(\n       interpolationConfig, /* keepI18nAttrs */ !preserveWhitespaces,\n       enableI18nLegacyMessageIdFormat);\n-  rootNodes = html.visitAll(i18nMetaVisitor, rootNodes);\n+  const i18nMetaResult = i18nMetaVisitor.visitAllWithErrors(rootNodes);\n+\n+  if (i18nMetaResult.errors && i18nMetaResult.errors.length > 0) {\n+    return {\n+      interpolationConfig,\n+      preserveWhitespaces,\n+      template,\n+      errors: i18nMetaResult.errors,\n+      nodes: [],\n+      styleUrls: [],\n+      styles: [],\n+      ngContentSelectors: []\n+    };\n+  }\n+\n+  rootNodes = i18nMetaResult.rootNodes;\n \n   if (!preserveWhitespaces) {\n     rootNodes = html.visitAll(new WhitespaceVisitor(), rootNodes);"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 28,
        "deletions": 1
    }
}