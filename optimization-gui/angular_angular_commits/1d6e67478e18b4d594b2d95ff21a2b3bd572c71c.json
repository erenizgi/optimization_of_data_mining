{
    "author": "petebacondarwin",
    "message": "refactor(ngcc): simplify and rename `getClassDeclarationFromInnerDeclaration()` (#38959)\n\nThe new function does not try to restrict the kind of AST node that it\nfinds, leaving that to the caller. This will make it more resuable in the\nUMD reflection host.\n\nPR Close #38959",
    "sha": "1d6e67478e18b4d594b2d95ff21a2b3bd572c71c",
    "files": [
        {
            "sha": "8054083462fbf7d97a0031ccfd975896af2d7f6c",
            "filename": "packages/compiler-cli/ngcc/src/host/esm2015_host.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 36,
            "changes": 75,
            "blob_url": "https://github.com/angular/angular/blob/1d6e67478e18b4d594b2d95ff21a2b3bd572c71c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d6e67478e18b4d594b2d95ff21a2b3bd572c71c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm2015_host.ts?ref=1d6e67478e18b4d594b2d95ff21a2b3bd572c71c",
            "patch": "@@ -302,6 +302,7 @@ export class Esm2015ReflectionHost extends TypeScriptReflectionHost implements N\n     if (superDeclaration.known !== null || superDeclaration.identity !== null) {\n       return superDeclaration;\n     }\n+\n     let declarationNode: ts.Node = superDeclaration.node;\n     if (isNamedVariableDeclaration(superDeclaration.node) && !isTopLevel(superDeclaration.node)) {\n       const variableValue = this.getVariableValue(superDeclaration.node);\n@@ -310,9 +311,9 @@ export class Esm2015ReflectionHost extends TypeScriptReflectionHost implements N\n       }\n     }\n \n-    const outerClassNode = getClassDeclarationFromInnerDeclaration(declarationNode);\n-    const declaration = outerClassNode !== null ?\n-        this.getDeclarationOfIdentifier(outerClassNode.name) :\n+    const outerNode = getOuterNodeFromInnerDeclaration(declarationNode);\n+    const declaration = outerNode !== null && isNamedVariableDeclaration(outerNode) ?\n+        this.getDeclarationOfIdentifier(outerNode.name) :\n         superDeclaration;\n     if (declaration === null || declaration.node === null || declaration.known !== null) {\n       return declaration;\n@@ -2569,51 +2570,53 @@ function isTopLevel(node: ts.Node): boolean {\n }\n \n /**\n- * Get the actual (outer) declaration of a class.\n+ * Get a node that represents the actual (outer) declaration of a class from its implementation.\n  *\n  * Sometimes, the implementation of a class is an expression that is hidden inside an IIFE and\n- * returned to be assigned to a variable outside the IIFE, which is what the rest of the program\n- * interacts with.\n+ * assigned to a variable outside the IIFE, which is what the rest of the program interacts with.\n+ * For example,\n  *\n- * Given the inner declaration, we want to get to the declaration of the outer variable that\n- * represents the class.\n+ * ```\n+ * OuterNode = Alias = (function() { function InnerNode() {} return InnerNode; })();\n+ * ```\n  *\n- * @param node a node that could be the inner declaration inside an IIFE.\n- * @returns the outer variable declaration or `null` if it is not a \"class\".\n+ * @param node a node that could be the implementation inside an IIFE.\n+ * @returns a node that represents the outer declaration, or `null` if it is does not match the IIFE\n+ *     format shown above.\n  */\n-export function getClassDeclarationFromInnerDeclaration(node: ts.Node):\n-    ClassDeclaration<ts.VariableDeclaration>|null {\n-  if (ts.isFunctionDeclaration(node) || ts.isClassDeclaration(node) ||\n-      ts.isVariableStatement(node)) {\n-    // It might be the function expression inside the IIFE. We need to go 5 levels up...\n+export function getOuterNodeFromInnerDeclaration(node: ts.Node): ts.Node|null {\n+  if (!ts.isFunctionDeclaration(node) && !ts.isClassDeclaration(node) &&\n+      !ts.isVariableStatement(node)) {\n+    return null;\n+  }\n \n-    // - IIFE body.\n-    let outerNode = node.parent;\n-    if (!outerNode || !ts.isBlock(outerNode)) return null;\n+  // It might be the function expression inside the IIFE. We need to go 5 levels up...\n \n-    // - IIFE function expression.\n-    outerNode = outerNode.parent;\n-    if (!outerNode || (!ts.isFunctionExpression(outerNode) && !ts.isArrowFunction(outerNode))) {\n-      return null;\n-    }\n-    outerNode = outerNode.parent;\n+  // - IIFE body.\n+  let outerNode = node.parent;\n+  if (!outerNode || !ts.isBlock(outerNode)) return null;\n \n-    // - Parenthesis inside IIFE.\n-    if (outerNode && ts.isParenthesizedExpression(outerNode)) outerNode = outerNode.parent;\n+  // - IIFE function expression.\n+  outerNode = outerNode.parent;\n+  if (!outerNode || (!ts.isFunctionExpression(outerNode) && !ts.isArrowFunction(outerNode))) {\n+    return null;\n+  }\n+  outerNode = outerNode.parent;\n \n-    // - IIFE call expression.\n-    if (!outerNode || !ts.isCallExpression(outerNode)) return null;\n-    outerNode = outerNode.parent;\n+  // - Parenthesis inside IIFE.\n+  if (outerNode && ts.isParenthesizedExpression(outerNode)) outerNode = outerNode.parent;\n \n-    // - Parenthesis around IIFE.\n-    if (outerNode && ts.isParenthesizedExpression(outerNode)) outerNode = outerNode.parent;\n+  // - IIFE call expression.\n+  if (!outerNode || !ts.isCallExpression(outerNode)) return null;\n+  outerNode = outerNode.parent;\n \n-    // - Outer variable declaration.\n-    if (!outerNode || !ts.isVariableDeclaration(outerNode)) return null;\n+  // - Parenthesis around IIFE.\n+  if (outerNode && ts.isParenthesizedExpression(outerNode)) outerNode = outerNode.parent;\n \n-    // Finally, ensure that the variable declaration has a `name` identifier.\n-    return hasNameIdentifier(outerNode) ? outerNode : null;\n+  // - Skip any aliases between the IIFE and the far left hand side of any assignments.\n+  while (isAssignment(outerNode.parent)) {\n+    outerNode = outerNode.parent;\n   }\n \n-  return null;\n+  return outerNode;\n }"
        },
        {
            "sha": "89decab6945616513e5238a91a1597beb18be116",
            "filename": "packages/compiler-cli/ngcc/src/host/esm5_host.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/angular/angular/blob/1d6e67478e18b4d594b2d95ff21a2b3bd572c71c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm5_host.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d6e67478e18b4d594b2d95ff21a2b3bd572c71c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm5_host.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Fhost%2Fesm5_host.ts?ref=1d6e67478e18b4d594b2d95ff21a2b3bd572c71c",
            "patch": "@@ -8,10 +8,10 @@\n \n import * as ts from 'typescript';\n \n-import {ClassDeclaration, ClassMember, ClassMemberKind, Declaration, Decorator, FunctionDefinition, KnownDeclaration, Parameter, reflectObjectLiteral} from '../../../src/ngtsc/reflection';\n+import {ClassDeclaration, ClassMember, ClassMemberKind, Declaration, Decorator, FunctionDefinition, isNamedFunctionDeclaration, KnownDeclaration, Parameter, reflectObjectLiteral} from '../../../src/ngtsc/reflection';\n import {getTsHelperFnFromDeclaration, getTsHelperFnFromIdentifier, hasNameIdentifier} from '../utils';\n \n-import {Esm2015ReflectionHost, getClassDeclarationFromInnerDeclaration, getPropertyValueFromSymbol, isAssignmentStatement, ParamInfo} from './esm2015_host';\n+import {Esm2015ReflectionHost, getOuterNodeFromInnerDeclaration, getPropertyValueFromSymbol, isAssignmentStatement, ParamInfo} from './esm2015_host';\n import {NgccClassSymbol} from './ngcc_host';\n \n \n@@ -186,16 +186,16 @@ export class Esm5ReflectionHost extends Esm2015ReflectionHost {\n       return classSymbol;\n     }\n \n-    if (!ts.isFunctionDeclaration(declaration) || !hasNameIdentifier(declaration)) {\n+    if (!isNamedFunctionDeclaration(declaration)) {\n       return undefined;\n     }\n \n-    const outerDeclaration = getClassDeclarationFromInnerDeclaration(declaration);\n-    if (outerDeclaration === null || !hasNameIdentifier(outerDeclaration)) {\n+    const outerNode = getOuterNodeFromInnerDeclaration(declaration);\n+    if (outerNode === null || !hasNameIdentifier(outerNode)) {\n       return undefined;\n     }\n \n-    return this.createClassSymbol(outerDeclaration, declaration);\n+    return this.createClassSymbol(outerNode.name, declaration);\n   }\n \n   /**"
        },
        {
            "sha": "7a67e5049b1c284d35c224d39e4ebc01677ba7c2",
            "filename": "packages/compiler-cli/ngcc/src/utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/angular/angular/blob/1d6e67478e18b4d594b2d95ff21a2b3bd572c71c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Futils.ts",
            "raw_url": "https://github.com/angular/angular/raw/1d6e67478e18b4d594b2d95ff21a2b3bd572c71c/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Futils.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/packages%2Fcompiler-cli%2Fngcc%2Fsrc%2Futils.ts?ref=1d6e67478e18b4d594b2d95ff21a2b3bd572c71c",
            "patch": "@@ -71,9 +71,9 @@ export function findAll<T>(node: ts.Node, test: (node: ts.Node) => node is ts.No\n  * @param declaration The declaration to test.\n  * @returns true if the declaration has an identifier for a name.\n  */\n-export function hasNameIdentifier(declaration: ts.Declaration): declaration is ts.Declaration&\n+export function hasNameIdentifier(declaration: ts.Node): declaration is ts.Declaration&\n     {name: ts.Identifier} {\n-  const namedDeclaration: ts.Declaration&{name?: ts.Node} = declaration;\n+  const namedDeclaration: ts.Node&{name?: ts.Node} = declaration;\n   return namedDeclaration.name !== undefined && ts.isIdentifier(namedDeclaration.name);\n }\n "
        }
    ],
    "stats": {
        "total": 91,
        "additions": 47,
        "deletions": 44
    }
}