{
    "author": "josephperrott",
    "message": "feat(dev-infra): add `ng-dev build-and-link` command (#42319)\n\nAdd a command to build the release output without stamping for release\nand link via `yarn link` the generated builds to a project provided.\n\nPR Close #42319",
    "sha": "4afad03312772d3f29e87b46701ee8adbdba6c3a",
    "files": [
        {
            "sha": "5cd5d2c63f548b88f7cbda4383ebb8ba32a1bd31",
            "filename": "dev-infra/BUILD.bazel",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/angular/angular/blob/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2FBUILD.bazel?ref=4afad03312772d3f29e87b46701ee8adbdba6c3a",
            "patch": "@@ -12,6 +12,7 @@ ts_library(\n         \"//dev-infra/caretaker\",\n         \"//dev-infra/commit-message\",\n         \"//dev-infra/format\",\n+        \"//dev-infra/misc\",\n         \"//dev-infra/ngbot\",\n         \"//dev-infra/pr\",\n         \"//dev-infra/pullapprove\","
        },
        {
            "sha": "6bfd94274ef248d63c74b6007b3cede24ed41b2a",
            "filename": "dev-infra/cli.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/angular/angular/blob/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fcli.ts?ref=4afad03312772d3f29e87b46701ee8adbdba6c3a",
            "patch": "@@ -17,6 +17,7 @@ import {buildPullapproveParser} from './pullapprove/cli';\n import {buildReleaseParser} from './release/cli';\n import {tsCircularDependenciesBuilder} from './ts-circular-dependencies/index';\n import {captureLogOutputForCommand} from './utils/console';\n+import {buildMiscParser} from './misc/cli';\n \n yargs.scriptName('ng-dev')\n     .middleware(captureLogOutputForCommand)\n@@ -29,6 +30,7 @@ yargs.scriptName('ng-dev')\n     .command('release <command>', '', buildReleaseParser)\n     .command('ts-circular-deps <command>', '', tsCircularDependenciesBuilder)\n     .command('caretaker <command>', '', buildCaretakerParser)\n+    .command('misc <command>', '', buildMiscParser)\n     .command('ngbot <command>', false, buildNgbotParser)\n     .wrap(120)\n     .strict()"
        },
        {
            "sha": "5e538b23f292a10141170797fc89feb5c390f973",
            "filename": "dev-infra/misc/BUILD.bazel",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/angular/angular/blob/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fmisc%2FBUILD.bazel",
            "raw_url": "https://github.com/angular/angular/raw/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fmisc%2FBUILD.bazel",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fmisc%2FBUILD.bazel?ref=4afad03312772d3f29e87b46701ee8adbdba6c3a",
            "patch": "@@ -0,0 +1,16 @@\n+load(\"@npm//@bazel/typescript:index.bzl\", \"ts_library\")\n+\n+ts_library(\n+    name = \"misc\",\n+    srcs = glob([\"**/*.ts\"]),\n+    module_name = \"@angular/dev-infra-private/misc/\",\n+    visibility = [\"//dev-infra:__subpackages__\"],\n+    deps = [\n+        \"//dev-infra/release/build\",\n+        \"//dev-infra/release/config\",\n+        \"//dev-infra/utils\",\n+        \"@npm//@types/node\",\n+        \"@npm//@types/yargs\",\n+        \"@npm//chalk\",\n+    ],\n+)"
        },
        {
            "sha": "d32fd4a02116ecd669ad9f788b1226293a975d57",
            "filename": "dev-infra/misc/build-and-link/cli.ts",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/angular/angular/blob/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fmisc%2Fbuild-and-link%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fmisc%2Fbuild-and-link%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fmisc%2Fbuild-and-link%2Fcli.ts?ref=4afad03312772d3f29e87b46701ee8adbdba6c3a",
            "patch": "@@ -0,0 +1,69 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+\n+import {green} from 'chalk';\n+import {lstatSync, stat, Stats} from 'fs';\n+import {isAbsolute, join, resolve} from 'path';\n+import {Arguments, Argv, CommandModule} from 'yargs';\n+\n+import {buildReleaseOutput} from '../../release/build/index';\n+import {error, info, red} from '../../utils/console';\n+import {exec} from '../../utils/shelljs';\n+\n+\n+/** Command line options. */\n+export interface BuildAndLinkOptions {\n+  projectRoot: string;\n+}\n+\n+/** Yargs command builder for the command. */\n+function builder(argv: Argv): Argv<BuildAndLinkOptions> {\n+  return argv.positional('projectRoot', {\n+    type: 'string',\n+    normalize: true,\n+    coerce: (path: string) => resolve(path),\n+    demandOption: true,\n+  });\n+}\n+\n+/** Yargs command handler for the command. */\n+async function handler({projectRoot}: Arguments<BuildAndLinkOptions>) {\n+  try {\n+    if (!lstatSync(projectRoot).isDirectory()) {\n+      error(red(`  ✘   The 'projectRoot' must be a directory: ${projectRoot}`));\n+      process.exit(1);\n+    }\n+  } catch {\n+    error(red(`  ✘   Could not find the 'projectRoot' provided: ${projectRoot}`));\n+    process.exit(1);\n+  }\n+\n+  const releaseOutputs = await buildReleaseOutput(false);\n+\n+  if (releaseOutputs === null) {\n+    error(red(`  ✘   Could not build release output. Please check output above.`));\n+    process.exit(1);\n+  }\n+  info(green(` ✓  Built release output.`));\n+\n+  for (const {outputPath, name} of releaseOutputs) {\n+    exec(`yarn link --cwd ${outputPath}`);\n+    exec(`yarn link --cwd ${projectRoot} ${name}`);\n+  }\n+\n+  info(green(` ✓  Linked release packages in provided project.`));\n+}\n+\n+/** CLI command module. */\n+export const BuildAndLinkCommandModule: CommandModule<{}, BuildAndLinkOptions> = {\n+  builder,\n+  handler,\n+  command: 'build-and-link <projectRoot>',\n+  describe:\n+      'Builds the release output, registers the outputs as linked, and links via yarn to the provided project',\n+};"
        },
        {
            "sha": "64b2b785a4f61216a564cf2f44ea9b0dafd58d9f",
            "filename": "dev-infra/misc/cli.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/angular/angular/blob/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fmisc%2Fcli.ts",
            "raw_url": "https://github.com/angular/angular/raw/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fmisc%2Fcli.ts",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fmisc%2Fcli.ts?ref=4afad03312772d3f29e87b46701ee8adbdba6c3a",
            "patch": "@@ -0,0 +1,15 @@\n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+import * as yargs from 'yargs';\n+\n+import {BuildAndLinkCommandModule} from './build-and-link/cli';\n+\n+/** Build the parser for the misc commands. */\n+export function buildMiscParser(localYargs: yargs.Argv) {\n+  return localYargs.help().strict().command(BuildAndLinkCommandModule);\n+}"
        },
        {
            "sha": "ecab957b60b37b6cb87fc89b82ba828837971c46",
            "filename": "dev-infra/ng-dev.js",
            "status": "modified",
            "additions": 66,
            "deletions": 4,
            "changes": 70,
            "blob_url": "https://github.com/angular/angular/blob/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fng-dev.js",
            "raw_url": "https://github.com/angular/angular/raw/4afad03312772d3f29e87b46701ee8adbdba6c3a/dev-infra%2Fng-dev.js",
            "contents_url": "https://api.github.com/repos/angular/angular/contents/dev-infra%2Fng-dev.js?ref=4afad03312772d3f29e87b46701ee8adbdba6c3a",
            "patch": "@@ -5152,10 +5152,10 @@ function getReleaseConfig(config = getConfig()) {\n  * pollute the stdout in such cases, we launch a child process for building the release packages\n  * and redirect all stdout output to the stderr channel (which can be read in the terminal).\n  */\n-function buildReleaseOutput() {\n+function buildReleaseOutput(stampForRelease = false) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         return new Promise(resolve => {\n-            const buildProcess = child_process.fork(require.resolve('./build-worker'), [], {\n+            const buildProcess = child_process.fork(require.resolve('./build-worker'), [`${stampForRelease}`], {\n                 // The stdio option is set to redirect any \"stdout\" output directly to the \"stderr\" file\n                 // descriptor. An additional \"ipc\" file descriptor is created to support communication with\n                 // the build process. https://nodejs.org/api/child_process.html#child_process_options_stdio.\n@@ -5180,17 +5180,23 @@ function buildReleaseOutput() {\n  */\n /** Yargs command builder for configuring the `ng-dev release build` command. */\n function builder$7(argv) {\n-    return argv.option('json', {\n+    return argv\n+        .option('json', {\n         type: 'boolean',\n         description: 'Whether the built packages should be printed to stdout as JSON.',\n         default: false,\n+    })\n+        .option('stampForRelease', {\n+        type: 'boolean',\n+        description: 'Whether the built packages should be stamped for release.',\n+        default: false,\n     });\n }\n /** Yargs command handler for building a release. */\n function handler$7(args) {\n     return tslib.__awaiter(this, void 0, void 0, function* () {\n         const { npmPackages } = getReleaseConfig();\n-        let builtPackages = yield buildReleaseOutput();\n+        let builtPackages = yield buildReleaseOutput(args.stampForRelease);\n         // If package building failed, print an error and exit with an error code.\n         if (builtPackages === null) {\n             error(red(`  ✘   Could not build release output. Please check output above.`));\n@@ -7888,6 +7894,61 @@ function convertReferenceChainToString(chain) {\n     return chain.join(' → ');\n }\n \n+/**\n+ * @license\n+ * Copyright Google LLC All Rights Reserved.\n+ *\n+ * Use of this source code is governed by an MIT-style license that can be\n+ * found in the LICENSE file at https://angular.io/license\n+ */\n+/** Yargs command builder for the command. */\n+function builder$c(argv) {\n+    return argv.positional('projectRoot', {\n+        type: 'string',\n+        normalize: true,\n+        coerce: (path$1) => path.resolve(path$1),\n+        demandOption: true,\n+    });\n+}\n+/** Yargs command handler for the command. */\n+function handler$c({ projectRoot }) {\n+    return tslib.__awaiter(this, void 0, void 0, function* () {\n+        try {\n+            if (!fs.lstatSync(projectRoot).isDirectory()) {\n+                error(red(`  ✘   The 'projectRoot' must be a directory: ${projectRoot}`));\n+                process.exit(1);\n+            }\n+        }\n+        catch (_a) {\n+            error(red(`  ✘   Could not find the 'projectRoot' provided: ${projectRoot}`));\n+            process.exit(1);\n+        }\n+        const releaseOutputs = yield buildReleaseOutput(false);\n+        if (releaseOutputs === null) {\n+            error(red(`  ✘   Could not build release output. Please check output above.`));\n+            process.exit(1);\n+        }\n+        info(chalk.green(` ✓  Built release output.`));\n+        for (const { outputPath, name } of releaseOutputs) {\n+            exec(`yarn link --cwd ${outputPath}`);\n+            exec(`yarn link --cwd ${projectRoot} ${name}`);\n+        }\n+        info(chalk.green(` ✓  Linked release packages in provided project.`));\n+    });\n+}\n+/** CLI command module. */\n+const BuildAndLinkCommandModule = {\n+    builder: builder$c,\n+    handler: handler$c,\n+    command: 'build-and-link <projectRoot>',\n+    describe: 'Builds the release output, registers the outputs as linked, and links via yarn to the provided project',\n+};\n+\n+/** Build the parser for the misc commands. */\n+function buildMiscParser(localYargs) {\n+    return localYargs.help().strict().command(BuildAndLinkCommandModule);\n+}\n+\n yargs.scriptName('ng-dev')\n     .middleware(captureLogOutputForCommand)\n     .demandCommand()\n@@ -7899,6 +7960,7 @@ yargs.scriptName('ng-dev')\n     .command('release <command>', '', buildReleaseParser)\n     .command('ts-circular-deps <command>', '', tsCircularDependenciesBuilder)\n     .command('caretaker <command>', '', buildCaretakerParser)\n+    .command('misc <command>', '', buildMiscParser)\n     .command('ngbot <command>', false, buildNgbotParser)\n     .wrap(120)\n     .strict()"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 169,
        "deletions": 4
    }
}